mstrDECalculationImplScript=true;mstrDECalculationImpl.prototype=new mstrBoneImpl();mstrDECalculationImpl.prototype.srcShoppingCart=null;mstrDECalculationImpl.prototype.desShoppingCart=null;mstrDECalculationImpl.prototype.src=null;mstrDECalculationImpl.prototype.srcElmt=null;mstrDECalculationImpl.prototype.srcGroup=null;mstrDECalculationImpl.prototype.srcConstant=null;mstrDECalculationImpl.prototype.buttonAdd=null;mstrDECalculationImpl.prototype.buttonAddAll=null;mstrDECalculationImpl.prototype.buttonRemove=null;mstrDECalculationImpl.prototype.buttonRemoveAll=null;mstrDECalculationImpl.prototype.buttonUp=null;mstrDECalculationImpl.prototype.buttonDown=null;mstrDECalculationImpl.prototype.operator=null;mstrDECalculationImpl.prototype.srcTypePicker=null;mstrDECalculationImpl.prototype.previewContent=null;mstrDECalculationImpl.prototype.constantOperandsCount=false;mstrDECalculationImpl.SRC_ElEMENTS_SHOPPING_CART_ID="deElementSrc";mstrDECalculationImpl.SRC_GROUPS_SHOPPING_CART_ID="deGroupSrc";mstrDECalculationImpl.DES_SHOPPING_CART_ID="elementKeys";mstrDECalculationImpl.BUTTON_ADD_ID="de_tbAdd";mstrDECalculationImpl.BUTTON_ADDALL_ID="de_tbAddAll";mstrDECalculationImpl.BUTTON_REMOVE_ID="de_tbRemove";mstrDECalculationImpl.BUTTON_REMOVEALL_ID="de_tbRemoveAll";mstrDECalculationImpl.BUTTON_UP_ID="de_tbUp";mstrDECalculationImpl.BUTTON_DOWN_ID="de_tbDown";mstrDECalculationImpl.CONSTANT_FIELD_ID="de_cf";mstrDECalculationImpl.OPERATOR="operator";mstrDECalculationImpl.SRC_TYPE_ID="srcType";mstrDECalculationImpl.PREVIEW_CONTENT_ID="dePreviewContent";mstrDECalculationImpl.CONSTANT_OID="-1";mstrDECalculationImpl.SEPARATOR="~";mstrDECalculationImpl.prototype.currentOpType=null;mstrDECalculationImpl.ATTR_OPERATOR_TYPE="ty";mstrDECalculationImpl.OPERATOR_TYPE_BINARY="bi";mstrDECalculationImpl.OPERATOR_TYPE_FUNCTION="func";mstrDECalculationImpl.OPERATOR_TYPE_UNARY="unary";mstrDECalculationImpl.TYPE_CONSTANT="-1";mstrDECalculationImpl.TYPE_ELMT="1048576";mstrDECalculationImpl.TYPE_GROUP="48";mstrDECalculationImpl.TYPE_MAPPING={"1":mstrDECalculationImpl.TYPE_ELMT,"2":mstrDECalculationImpl.TYPE_GROUP,"-1":mstrDECalculationImpl.TYPE_CONSTANT};mstrDECalculationImpl.prototype.onpostload=function(e){try{this.initialized=false;var outerEditor=microstrategy.findAncestorWithAtt(this.elem,microstrategy.HTMLATTR_OBJTYPE,"dialog");this.editor=outerEditor&&microstrategy.findBone(outerEditor);this.initGuiComponents();this.initialized=true;mstrBoneImpl.prototype.onpostload.call(this,e);if(this.editor){this.parentBone=this.editor;this.editor.dElt_pane=this;if(this.editor.observer){this.editor.observer.register(this.id);}}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.initGuiComponents=function(){try{if(!this.tks){this.initOperator(microstrategy.findChildWithAtt(this.elem,"select","id",mstrDECalculationImpl.OPERATOR),(this.getSrcType()==mstrDECalculationImpl.TYPE_CONSTANT),(this.constantOperandsCount>0));if(!this.operator){return ;}}this.srcTypePicker=new deSrcTypePicker(microstrategy.findChildWithAtt(this.elem,"div","id",mstrDECalculationImpl.SRC_TYPE_ID));this.initSrc();if(this.tks){this.initTokenEditBox();}else{this.initDesShoppingCart(this,microstrategy.findChildWithAtt(this.elem,"select","id",mstrDECalculationImpl.DES_SHOPPING_CART_ID),this.operator.getCurrentOperatorType());}var buttonImages=this.elem.getElementsByTagName("img");var addButtonElem=null;var removeButtonElem=null;var cfButtonElem=null;var addAllButtonElem=null;var removeAllButtonElem=null;for(var i=0;i<buttonImages.length;i++){buttonImages[i].setAttribute("ondragstart","return false");if(buttonImages[i].className.indexOf("Right")>0){addButtonElem=buttonImages[i].parentNode;this.buttonAdd=new deButton(addButtonElem,deButton.TYPE_ADD,mstrDECalculationImpl.BUTTON_ADD_ID,this.src,this.desShoppingCart,new Function("e","return microstrategy.bone('"+this.id+"').onAddButtonClick(e);"));}else{if(buttonImages[i].className.indexOf("Left")>0){removeButtonElem=buttonImages[i].parentNode;this.buttonRemove=new deButton(removeButtonElem,deButton.TYPE_REMOVE,mstrDECalculationImpl.BUTTON_REMOVE_ID,this.src,this.desShoppingCart,new Function("e","return microstrategy.bone('"+this.id+"').onRemoveButtonClick(e);"));}else{if(buttonImages[i].className.indexOf("AddAll")>0){addAllButtonElem=buttonImages[i].parentNode;this.buttonAddAll=new deButton(addAllButtonElem,deButton.TYPE_ADD_ALL,mstrDECalculationImpl.BUTTON_ADDALL_ID,this.src,this.desShoppingCart,new Function("e","return microstrategy.bone('"+this.id+"').onAddAllButtonClick(e);"));}else{if(buttonImages[i].className.indexOf("RemoveAll")>0){removeAllButtonElem=buttonImages[i].parentNode;this.buttonRemoveAll=new deButton(removeAllButtonElem,deButton.TYPE_REMOVE_ALL,mstrDECalculationImpl.BUTTON_REMOVEALL_ID,this.src,this.desShoppingCart,new Function("e","return microstrategy.bone('"+this.id+"').onRemoveAllButtonClick(e);"));}else{if(buttonImages[i].className.indexOf("ArrowUp")){this.buttonUp=new deButton(document.getElementById("de_tbUp"),deButton.TYPE_UP,mstrDECalculationImpl.BUTTON_UP_ID,this.src,this.desShoppingCart,new Function("e","return microstrategy.bone('"+this.id+"').onUpButtonClick(e);"));}else{if(buttonImages[i].className.indexOf("ArrowDown")){this.buttonDown=new deButton(document.getElementById("de_tbDown"),deButton.TYPE_DOWN,mstrDECalculationImpl.BUTTON_DOWN_ID,this.src,this.desShoppingCart,new Function("e","return microstrategy.bone('"+this.id+"').onDownButtonClick(e);"));}}}}}}}if(this.tks){return ;}this.previewContent=new dePreviewContent(this,microstrategy.findChildWithAtt(this.elem,"span","id",mstrDECalculationImpl.PREVIEW_CONTENT_ID));this.previewContent.onChange();if(this.operator&&this.operator.observer){this.operator.observer.register(mstrDECalculationImpl.DES_SHOPPING_CART_ID,this.desShoppingCart);this.operator.observer.register(mstrDECalculationImpl.SRC_TYPE_ID,this.srcTypePicker);this.operator.observer.register(mstrDECalculationImpl.PREVIEW_CONTENT_ID,this.previewContent);}if(this.src&&this.src.observer){this.src.observer.register(mstrDECalculationImpl.BUTTON_ADD_ID,this.buttonAdd);this.src.observer.register(mstrDECalculationImpl.BUTTON_ADDALL_ID,this.buttonAddAll);}if(this.desShoppingCart&&this.desShoppingCart.observer){this.desShoppingCart.observer.register(mstrDECalculationImpl.BUTTON_ADD_ID,this.buttonAdd);this.desShoppingCart.observer.register(mstrDECalculationImpl.BUTTON_ADDALL_ID,this.buttonAddAll);this.desShoppingCart.observer.register(mstrDECalculationImpl.BUTTON_REMOVE_ID,this.buttonRemove);this.desShoppingCart.observer.register(mstrDECalculationImpl.BUTTON_REMOVEALL_ID,this.buttonRemoveAll);this.desShoppingCart.observer.register(mstrDECalculationImpl.PREVIEW_CONTENT_ID,this.previewContent);this.desShoppingCart.observer.register(mstrDECalculationImpl.OPERATOR,this.operator);}if(this.srcTypePicker&&this.srcTypePicker.observer){this.srcTypePicker.observer.register(mstrDECalculationImpl.OPERATOR,this.operator);}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.initTokenEditBox=function initTokenEditBox(){try{var des=new deTokenInputBox(this,microstrategy.findChildWithAtt(this.elem,"div","id",mstrDECalculationImpl.DES_SHOPPING_CART_ID));this.desShoppingCart=des;des.deSrcMode=this.editor.deSrcMode;des.tks=this.tks;if(this.peId){des.passThroughParent={did:this.peId,n:this.peName};}des.init();var srcSelect=this.srcElmt.elem,fOnchange=srcSelect.onchange;srcSelect.onchange=function(event){des.onSrcEltSelectionChange(event);if(fOnchange){fOnchange.call(srcSelect,event);}};}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.handleFunctionWizardSelect=function(funcInfo){this.desShoppingCart.addFunctionToken(funcInfo);};mstrDECalculationImpl.prototype.onselectionchange=function onselectionchange(e){try{if(!e){return ;}var des=this.desShoppingCart;if(!des.passThrough){return ;}var tks=des.tks,items=tks&&tks.items;if(items.length==0){tks.handleSwitching=true;des.notify();}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.initDesShoppingCart=function(parent,elem,operatorType){try{var firstOption=elem.options[0];if(firstOption&&firstOption.value=="-none-"){elem.remove(0);}this.desShoppingCart=new deDesCart(parent,elem);this.desShoppingCart.setCartLimit(operatorType);elem.ondblclick=new Function("e","return microstrategy.bone('"+this.id+"').onRemoveButtonClick(e);");}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.initOperator=function(elem,isSrcTypeConstant,hasConstantOperands){try{if(!elem){this.operator=null;return ;}this.operator=new deOperator(elem,isSrcTypeConstant,hasConstantOperands);this.operator.update();this.operator.elem.onchange=new Function("e","return microstrategy.bone('"+this.id+"').changeOperator();");}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.onUpButtonClick=function(e){try{MoveItemInSelectedList("elementKeys","Up","elementList");BuildFilterSelections("elementList","elementKeys");this.desShoppingCart.observer.notifyAll("ondeschange");}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.onDownButtonClick=function(e){try{MoveItemInSelectedList("elementKeys","Down","elementList");BuildFilterSelections("elementList","elementKeys");this.desShoppingCart.observer.notifyAll("ondeschange");}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.onAddButtonClick=function(e){try{if(this.tks){var deTokenInputBox=this.desShoppingCart;var item=this.src.remove();if(item!=null&&(item.tagName.toLowerCase()=="option")){deTokenInputBox.addElementToken(item,true);}return ;}if(this.desShoppingCart.cartLimit!=deCart.CART_NO_LIMIT&&this.desShoppingCart.getSize()>=this.desShoppingCart.cartLimit){return ;}var editor=this.editor,srcType=this.getSrcType();if(srcType==mstrDECalculationImpl.TYPE_CONSTANT){if(!editor.validateSingleInput(this.srcConstant.elem)){return true;}}var item=this.src.remove();if(item!=null){this.desShoppingCart.add(item,true);}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.onAddAllButtonClick=function(e){try{var srcSize=(this.src&&this.src.getSize()>0&&this.src.elem.options)?this.src.getSize():0;if(this.desShoppingCart.cartLimit!=deCart.CART_NO_LIMIT){return ;}var item,moved=false;for(var i=0;i<srcSize;i++){item=this.src.remove(i);if(!this.isRA){i--;srcSize--;}if(item){this.desShoppingCart.add(item,false);moved=true;}}if(moved){this.desShoppingCart.notify();}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.addItemToSrc=function(item,skipIfElement){try{var itemType=this.srcElmt.getItemType(item);if(itemType==mstrDECalculationImpl.TYPE_CONSTANT){return ;}if(itemType==mstrDECalculationImpl.TYPE_ELMT){if(!skipIfElement){this.srcElmt.add(item,true);}}else{if(itemType==mstrDECalculationImpl.TYPE_GROUP){this.srcGroup.add(item,true);}}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.onRemoveButtonClick=function(e){try{var selectedItem=this.desShoppingCart.remove();this.addItemToSrc(selectedItem);}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.onRemoveAllButtonClick=function(e){try{var isRA=this.isRA;while(this.desShoppingCart&&this.desShoppingCart.getSize()>0){var selectedItem=this.desShoppingCart.remove();this.addItemToSrc(selectedItem,isRA);}if(isRA){this.srcElmt.disableAll(false);}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.changeOperator=function(){try{var oldType=this.currentOpType;this.currentOpType=this.operator.getCurrentOperatorType();this.operator.observer.notifyAll("onOperatorChange","'"+this.currentOpType+"', '"+oldType+"'");if(oldType!=this.currentOpType){if((this.currentOpType==mstrDECalculationImpl.OPERATOR_TYPE_BINARY&&this.desShoppingCart.getSize()>2)||(this.currentOpType==mstrDECalculationImpl.OPERATOR_TYPE_UNARY&&this.desShoppingCart.getSize()>1)){this.onRemoveAllButtonClick();}}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.getSrcType=function(){try{if(this.srcType){return mstrDECalculationImpl.TYPE_MAPPING[this.srcType];}return null;}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.getOperator=function(){try{return(this.operator)?this.operator.getOperatorAsString():null;}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.getOperand=function(index){try{return(this.desShoppingCart)?this.desShoppingCart.getItemAsString(index):"";}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.getFuncArgs=function(){try{return(this.desShoppingCart)?this.desShoppingCart.getAllItemNames():null;}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.initSrc=function(){try{var cartElem=microstrategy.findChildWithAtt(this.elem,"select","id",mstrDECalculationImpl.SRC_ElEMENTS_SHOPPING_CART_ID);cartElem.ondblclick=new Function("e","return microstrategy.bone('"+this.id+"').onAddButtonClick(e);");cartElem.selectedIndex=0;this.srcElmt=new deSrcElmtCart(this,cartElem);var cartGroup=microstrategy.findChildWithAtt(this.elem,"select","id",mstrDECalculationImpl.SRC_GROUPS_SHOPPING_CART_ID);cartGroup.ondblclick=new Function("e","return microstrategy.bone('"+this.id+"').onAddButtonClick(e);");this.srcGroup=new deSrcGroupCart(this,cartGroup);this.srcConstant=new deConstantField(microstrategy.findChildWithAtt(this.elem,"input","id",mstrDECalculationImpl.CONSTANT_FIELD_ID));this.srcConstant.elem.onkeyup=new Function("e","return microstrategy.bone('"+this.id+"').onConstantChange(e);");this.srcConstant.elem.setAttribute(mstrHTMLAttributes.ATTR_DTY,"2");this.srcConstant.elem.setAttribute(mstrHTMLAttributes.ATTR_FLD,microstrategy.descriptors.getDescriptor("1012"));switch(this.getSrcType()){case mstrDECalculationImpl.TYPE_ELMT:this.isRA=this.editor.isRA;this.src=this.srcElmt;break;case mstrDECalculationImpl.TYPE_GROUP:this.src=this.srcGroup;break;case mstrDECalculationImpl.TYPE_CONSTANT:this.src=this.srcConstant;break;}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.onConstantChange=function(){try{if(this.src&&this.src.onfieldchange){this.src.onfieldchange();}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.changeSrcType=function(srcType){try{if(srcType==this.srcType){return false;}var oldSrcType=this.srcType;this.srcType=srcType;this.isRA=false;this.srcTypePicker.update(oldSrcType,this.srcType);var otype=this.getSrcType();this.hideAll();switch(otype){case mstrDECalculationImpl.TYPE_ELMT:displayObj(document.getElementById("desearch"));displayObj(document.getElementById("deElmt"));break;case mstrDECalculationImpl.TYPE_GROUP:displayObj(this.srcGroup.elem);break;case mstrDECalculationImpl.TYPE_CONSTANT:displayObj(this.srcConstant.elem);break;}if(this.src&&this.src.observer){this.src.observer.unregisterAll();switch(mstrDECalculationImpl.TYPE_MAPPING[srcType]){case mstrDECalculationImpl.TYPE_ELMT:this.isRA=this.editor.isRA;this.src=this.srcElmt;this.buttonAdd.srcCart=this.src;if(!this.tks){this.buttonAddAll.srcCart=this.src;this.buttonRemove.srcCart=this.src;this.buttonRemoveAll.srcCart=this.src;}break;case mstrDECalculationImpl.TYPE_GROUP:this.src=this.srcGroup;this.buttonAdd.srcCart=this.src;if(!this.tks){this.buttonAddAll.srcCart=this.src;this.buttonRemove.srcCart=this.src;this.buttonRemoveAll.srcCart=this.src;}break;case mstrDECalculationImpl.TYPE_CONSTANT:this.src=this.srcConstant;this.buttonAdd.srcCart=this.src;break;}this.src.observer.register(mstrDECalculationImpl.BUTTON_ADD_ID,this.buttonAdd);if(!this.tks){this.src.observer.register(mstrDECalculationImpl.BUTTON_ADDALL_ID,this.buttonAddAll);}if(this.src&&this.src.observer){this.src.observer.notifyAll("onsrcchange",this.src.getSize());}}}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.hideAll=function(){try{var desearch=document.getElementById("desearch");if(desearch){removeObj(desearch);}var deElmtSrc=document.getElementById("deElmt");if(deElmtSrc){removeObj(deElmtSrc);}removeObj(this.srcGroup.elem);removeObj(this.srcConstant.elem);}catch(err){microstrategy.errors.log(err);return false;}};mstrDECalculationImpl.prototype.updateOperator=function(){if(this.operator){this.operator.update((this.getSrcType()==mstrDECalculationImpl.TYPE_CONSTANT),this.constantOperandsCount>0);}};mstrDECalculationImpl.prototype.isValid=function(){var elementList=microstrategy.findChildWithAtt(this.elem.parentNode,"input","id","elementList");return !elementList||!mstr.utils.String.isEmpty(elementList.value);};function mstrDECalculationImpl(id){this.inherits=mstrBoneImpl;this.inherits(id);delete this.inherits;return this;}deCart.prototype=new Object();deCart.prototype.observer=null;deCart.prototype.cartLimit=-1;deCart.CART_NO_LIMIT=-1;deCart.prototype.getItemType=function(item){var itemTypeInfo=item.value;var itemType=null;if(itemTypeInfo!=null&&itemTypeInfo.length>0){var infos=itemTypeInfo.split("~");itemType=infos[1];}return itemType;};deCart.prototype.getItemAsString=function(index){if(this.elem&&this.elem.options&&this.elem.options.length>0&&this.elem.options[index]){return this.elem.options[index].text;}return"";};deCart.prototype.getAllItemNames=function(){if(this.elem&&this.elem.options&&this.elem.options.length>0){var oNames=new Array();var options=this.elem.options;for(var i=0;i<options.length;i++){oNames.push(options[i].text);}return oNames;}return null;};deCart.prototype.getSize=function(){return(this.elem.options)?this.elem.options.length:0;};deCart.prototype.addOperandsPlaceHolder=function(){if(this.placeholders==null){this.placeholders=new Array();for(var i=0;i<2;i++){var option=new Option("*Add Value "+(i+1),"",false,false);this.placeholders.push(option);}}if(this.type==deCart.CART_TYPE_DES){for(var j=0;j<this.placeholders.length;j++){this.elem.options.add(this.placeholders[j]);}}this.elem.className="emptyBinary";};deCart.prototype.removeOperandsPlaceHolder=function(){this.elem.className="";if(this.placeholders==null||(this.elem.options==null||this.elem.options.length==0)){return ;}if(this.type==deCart.CART_TYPE_DES){for(var j=0;j<this.placeholders.length;j++){this.elem.removeChild(this.placeholders[j]);}}};deCart.prototype.remove=function(itemIndex){if(typeof (itemIndex)==="undefined"){itemIndex=this.elem.selectedIndex;}var availableOptions=this.elem.options;if(!availableOptions||availableOptions.length==0||itemIndex===-1){return null;}var isRA=this.parentBone.isRA,item=availableOptions[itemIndex];if(isRA&&item.disabled){return null;}item.selected=false;if(availableOptions.length>1){var nextIndex=(itemIndex<availableOptions.length-1)?(itemIndex+1):0,nextItem=availableOptions[nextIndex];if(!nextItem.disabled){nextItem.selected=true;}}if(!this.parentBone.tks){if(isRA){item.disabled=true;}else{this.elem.remove(itemIndex);}}if(this.observer){this.observer.notifyAll("onsrcchange",availableOptions.length);}if(isRA){var text=item.text,level=item.getAttribute("lvl");if(level>0){text=text.substring(2*level);}var newItem=new Option(text,item.value,false,true);newItem.title=item.title;return newItem;}else{return item;}};function deCart(parent,elem){if(elem){this.elemDiv=elem.parentNode;}this.elem=elem;this.observer=new mstrDeObserverImpl();this.parentBone=parent;return this;}mstrDeObserverImpl.prototype=new mstrObserverImpl();mstrDeObserverImpl.prototype.register=function(id,obj){if(typeof (this.items[id])=="undefined"){this.items[id]=obj;}return true;};mstrDeObserverImpl.prototype.unregisterAll=function(){for(var id in this.items){this.unregister(id);}return true;};mstrDeObserverImpl.prototype.notifyAll=function(eventName,arga){try{for(var member in this.items){var obj=this.items[member];if(eval("obj."+eventName)){eval("obj."+eventName+"("+arga+")");}}return true;}catch(err){microstrategy.errors.log(err);return false;}};function mstrDeObserverImpl(){this.items=new Object();return this;}deButton.prototype=new Object();deButton.prototype.onclickevent=null;deButton.TYPE_ADD="add";deButton.TYPE_ADD_ALL="addall";deButton.TYPE_REMOVE="remove";deButton.TYPE_REMOVE_ALL="removeall";deButton.TYPE_UP="up";deButton.TYPE_DOWN="down";deButton.prototype.disableButton=function(){if(this.onclickevent==null){this.onclickevent=this.elem.onclick;}this.elem.onclick=null;var newClassName=this.elem.firstChild.className;if(newClassName&&newClassName.indexOf("Disabled")<0){this.elem.firstChild.className=newClassName+"Disabled";}};deButton.prototype.enableButton=function(){if(this.onclickevent){this.elem.onclick=this.onclickevent;}var newClassName=this.elem.firstChild.className;if(newClassName&&newClassName.indexOf("Disabled")>=0){this.elem.firstChild.className=newClassName.substring(0,newClassName.indexOf("Disabled"));}};deButton.prototype.updateButtonState=function(){switch(this.type){case deButton.TYPE_ADD:if(this.srcCart.getSize()>0&&(this.desCart.getSize()<this.desCart.cartLimit||this.desCart.cartLimit==-1)){this.enableButton();}else{this.disableButton();}break;case deButton.TYPE_ADD_ALL:if(this.srcCart.getSize()>0&&this.desCart.cartLimit==-1){this.enableButton();}else{this.disableButton();}break;case deButton.TYPE_REMOVE:case deButton.TYPE_REMOVE_ALL:if(this.desCart.getSize()<=0){this.disableButton();}else{this.enableButton();}break;}};deButton.prototype.onsrcchange=function(cartOptionLength){this.updateButtonState();};deButton.prototype.onDesCartLimitchange=function(cartOptionLength,desLimit){this.updateButtonState();};deButton.prototype.ondeschange=function(cartOptionLength){this.updateButtonState();};function deButton(elem,type,id,srcCart,desCart,onclickEvent){this.elem=elem;this.type=type;this.srcCart=srcCart;this.desCart=desCart;if(id){this.elem.setAttribute("id",id);}this.onclickevent=onclickEvent;this.ondeschange();}deOperator.prototype=new Object();deOperator.prototype.observer=null;deOperator.prototype.isSrcTypeConstant=false;deOperator.prototype.hasConstantOperand=false;deOperator.prototype.getCurrentOperatorType=function(){var selectedOption=this.elem.options[this.elem.selectedIndex];if(selectedOption){return selectedOption.getAttribute(mstrDECalculationImpl.ATTR_OPERATOR_TYPE);}return null;};deOperator.prototype.getOperatorAsString=function(i){var selectedOption=this.elem.options[this.elem.selectedIndex];if(selectedOption){return selectedOption.text;}return null;};deOperator.prototype.displayOptions=function(optionType,show){return ;var allOptions=this.elem.options;for(var i=0;i<allOptions.length;i++){if(allOptions[i]){var otype=allOptions[i].getAttribute("ty");if(otype==optionType||optionType=="all"){allOptions[i].style.display=(show)?"":"none";}}}};deOperator.prototype.update=function(){return ;};deOperator.prototype.onSrcTypeChange=function(isSrcTypeConstant){this.isSrcTypeConstant=isSrcTypeConstant;this.update();};deOperator.prototype.ondesoperandchange=function(hasConstantOperand){this.hasConstantOperand=hasConstantOperand;this.update();};function deOperator(elem,isSrcTypeConstant,hasConstantOperand){this.elem=elem;this.observer=new mstrDeObserverImpl();this.isSrcTypeConstant=isSrcTypeConstant;this.hasConstantOperand=hasConstantOperand;return this;}deSrcTypePicker.prototype=new Object();deSrcTypePicker.TYPE_ELEMENT="1";deSrcTypePicker.TYPE_GROUP="2";deSrcTypePicker.TYPE_CONSTANT="-1";deSrcTypePicker.TYPE_MAPPING={"1":mstrDECalculationImpl.TYPE_ELMT,"2":mstrDECalculationImpl.TYPE_GROUP,"-1":mstrDECalculationImpl.TYPE_CONSTANT};deSrcTypePicker.prototype.displayLink=function(srcType,on){var olink=microstrategy.findChildWithAtt(this.elem,"span","type",srcType);if(olink){olink.style.visibility=(on)?"visible":"hidden";}};deSrcTypePicker.prototype.onOperatorChange=function(operatorType){return ;};deSrcTypePicker.prototype.update=function(prevSrcType,srcType){var selectedLink=microstrategy.findChildWithAtt(this.elem,"span","type",srcType);if(selectedLink){selectedLink.className="selected";}var prevLink=microstrategy.findChildWithAtt(this.elem,"span","type",prevSrcType);if(prevLink){prevLink.className="";}if(this.observer){this.observer.notifyAll("onSrcTypeChange",(srcType==mstrDECalculationImpl.TYPE_CONSTANT));}};function deSrcTypePicker(elem){this.elem=elem;this.observer=new mstrDeObserverImpl();return this;}dePreviewContent.prototype=new Object();dePreviewContent.prototype.operator="";dePreviewContent.prototype.operand1="";dePreviewContent.prototype.operand2="";dePreviewContent.prototype.funcArgs=null;dePreviewContent.prototype.parentBone=null;dePreviewContent.BINARY_OPERATORS="+,-,*,/";dePreviewContent.prototype.onChange=function(){this.operator=this.parentBone.getOperator();if(dePreviewContent.BINARY_OPERATORS.indexOf(this.operator)>=0){this.operand1=this.parentBone.getOperand(0);this.operand2=this.parentBone.getOperand(1);}else{this.funcArgs=this.parentBone.getFuncArgs();}this.buildPreview();};dePreviewContent.prototype.buildPreview=function(){var fmr="";if(dePreviewContent.BINARY_OPERATORS.indexOf(this.operator)>=0){fmr=this.operand1+" "+this.operator+" "+this.operand2;}else{var args=(this.funcArgs&&this.funcArgs.length>0)?this.funcArgs.join(",  "):"";fmr=this.operator+" ("+args+")";}this.elem.innerHTML=fmr;};dePreviewContent.prototype.onOperatorChange=function(){this.onChange();};dePreviewContent.prototype.ondeschange=function(){this.onChange();};function dePreviewContent(parent,elem){this.elem=elem;this.parentBone=parent;}deSrcElmtCart.prototype=new deCart;deSrcElmtCart.prototype.add=function(item,notify){if(item.tagName.toLowerCase()=="option"){if(item&&item.value=="-none-"){return ;}var options=this.elem.options;if(this.parentBone.isRA){var i,iSize=options.length,itemId=item.value.split("~")[0],srcItem,srcId;for(i=0;i<iSize;i++){srcItem=options[i];srcId=srcItem.value.split("~")[0];if(srcId===itemId){srcItem.disabled=false;break;}}}else{options.add(item);}if(notify){this.notify();}}};deSrcElmtCart.prototype.disableAll=function(value){var options=this.elem.options,i,iSize=options.length;for(i=0;i<iSize;i++){options[i].disabled=value;}this.notify();};deSrcElmtCart.prototype.notify=function(){if(this.observer){this.observer.notifyAll("onsrcchange",this.elem.options.length);}};function deSrcElmtCart(parent,elem){this.inherits=deCart;this.inherits(parent,elem);delete this.inherits;this.orgSrcCart=this.elemDiv.innerHTML;return this;}deSrcGroupCart.prototype=new deCart;deSrcGroupCart.prototype.remove=function(){var item=deCart.prototype.remove.call(this);if(item){this.orgSrcCart=this.elemDiv.innerHTML;}return item;};deSrcGroupCart.prototype.add=function(item,notify){if(item.tagName.toLowerCase()=="option"){if(item&&item.value=="-none-"){return ;}for(var i=0;i<this.elem.options.length;i++){if(this.elem.options[i].text==item.text){return ;}}this.elem.options.add(item);if(notify){this.notify();}this.orgSrcCart=this.elemDiv.innerHTML;}};deSrcGroupCart.prototype.notify=function(){if(this.observer){this.observer.notifyAll("onsrcchange",this.elem.options.length);}};function deSrcGroupCart(parent,elem){this.inherits=deCart;this.inherits(parent,elem);delete this.inherits;return this;}deConstantField.prototype=new Object();deConstantField.prototype.observer=null;deConstantField.prototype.getValue=function(){return this.elem.value;};deConstantField.prototype.clear=function(){this.elem.value="";};deConstantField.prototype.show=function(){this.elem.parentNode.style.visibility="visible";};deConstantField.prototype.hide=function(){this.elem.parentNode.style.visibility="hidden";};deConstantField.prototype.getSize=function(){return(isNaN(parseFloat(this.getValue())))?0:1;};deConstantField.prototype.ondesremove=function(){};deConstantField.prototype.remove=function(){if(!this.getValue()){return null;}var oValue=mstrDECalculationImpl.CONSTANT_OID+mstrDECalculationImpl.SEPARATOR+mstrDECalculationImpl.TYPE_CONSTANT+mstrDECalculationImpl.SEPARATOR+this.getValue();var oOption=new Option(this.getValue(),oValue,false,false);this.clear();return oOption;};deConstantField.prototype.onfieldchange=function(){if(this.observer){this.observer.notifyAll("onsrcchange",this.getSize());}};function deConstantField(elem){this.elem=elem;this.observer=new mstrDeObserverImpl();return this;}deDesCart.prototype=new deCart;deDesCart.prototype.onOperatorChange=function(operatorType,prevOpType){if(operatorType!=prevOpType){this.setCartLimit(operatorType);}};deDesCart.prototype.add=function(item,notify){if(item.tagName.toLowerCase()=="option"){if(item&&item.value=="-none-"){return ;}this.elem.options.add(item);if(this.getItemType(item)==mstrDECalculationImpl.TYPE_CONSTANT){this.parentBone.constantOperandsCount++;}if(notify){this.notify();}}};deDesCart.prototype.notify=function(){if(this.observer){this.observer.notifyAll("ondeschange",this.elem.options.length);this.observer.notifyAll("ondesoperandchange",(this.parentBone.constantOperandsCount>0));}BuildFilterSelections("elementList","elementKeys");};deDesCart.prototype.remove=function(){var item=null;var availableOptions=this.elem.options;if(availableOptions&&availableOptions.length>0){var itemIndex=(this.elem.selectedIndex>-1)?this.elem.selectedIndex:0;item=availableOptions[itemIndex];if(this.getItemType(item)==mstrDECalculationImpl.TYPE_CONSTANT){this.parentBone.constantOperandsCount--;}var nextIndex=(itemIndex<availableOptions.length-1)?(itemIndex+1):0;if(availableOptions.length>1){availableOptions[nextIndex].selected=true;}item.selected=false;this.elem.remove(itemIndex);if(this.observer){this.observer.notifyAll("ondeschange",availableOptions.length);this.observer.notifyAll("ondesoperandchange",(this.parentBone.constantOperandsCount>0));}BuildFilterSelections("elementList","elementKeys");}return item;};deDesCart.prototype.setCartLimit=function(operatorType){switch(operatorType){case mstrDECalculationImpl.OPERATOR_TYPE_BINARY:this.changeCartLimit(2);break;case mstrDECalculationImpl.OPERATOR_TYPE_FUNCTION:this.changeCartLimit(deCart.CART_NO_LIMIT);break;case mstrDECalculationImpl.OPERATOR_TYPE_UNARY:this.changeCartLimit(1);break;default:break;}};deDesCart.prototype.changeCartLimit=function(limit){this.cartLimit=limit;if(this.observer){this.observer.notifyAll("onDesCartLimitchange",this.elem.options.length+","+limit);}};function deDesCart(parent,elem){this.inherits=deCart;this.inherits(parent,elem);delete this.inherits;return this;}(function(){var _S=mstr.utils.String;var TKS={_preprocessTokenStream:function(tks,passThrough){var its=tks.items,last=its[its.length-1];if(last&&last.tp===-1){its.pop();}if(passThrough){its.pop();its.pop();its.pop();}if(its[0]&&its[0].tp===63||its[0]&&its[0].tp===37){its.splice(0,1);}if(passThrough){its.splice(0,2);var v=its[0].v;v=v.substring(1,v.length-1);if(v==deTokenInputBox.FAKE_TOKEN.v){tks.items=[];}}},_postprocessTokenStream:function(tks,passThrough){var its=tks.items,len=its.length,last=its[its.length-1],i,it,newItems=[],newV="";if(len===0){if(tks.handleSwitching){its=[mstr.$H.clone(deTokenInputBox.FAKE_TOKEN)];}else{return{items:[]};}}if(its[0]&&its[0].tp!==63){newItems.push({v:"?",tp:63,lv:4,sta:2});}if(passThrough){newItems.push({oi:{did:"8107C340DD9911D3B98100C04F2233EA",t:11,n:"ApplySimple"},v:"ApplySimple",tp:279,sta:1,isNew:true});newItems.push({v:"(",tp:40,sta:1,isNew:true});var it=its[0],v=it&&it.v||"";v=v.replace(/"/g,'""');it.v='"'+v+'"';newItems.push(it);newItems.push({v:mstr.Settings.Locale.LISTSEP,tp:2,sta:1,isNew:true});newItems.push({v:"0",tp:2,sta:1,isNew:true});newItems.push({v:")",tp:41,sta:1,isNew:true});}else{for(i=0,len=its.length;i<len;i++){it=its[i];if(it.isNew&&!it.oi){newV+=it.v;}else{if(!_S.isEmpty(newV)){newItems.push({v:newV,tp:2,lv:1});newV="";}newItems.push(it);}}if(!_S.isEmpty(newV)){newItems.push({v:newV,tp:2,lv:1});newV="";}}if(last&&last.tp!==-1){newItems.push({v:"",tp:-1,lv:4,sta:2});}return{items:newItems};},buildTokenStreamXML:function(tks,passThrough){var e4h=mstr.utils.String.escape4HTMLText;tks=this._postprocessTokenStream(tks,passThrough);var items=tks.items;if(items.length===0){return"";}var tknstrm="<tknstrm><items>";mstr.$A.forEach(items,function(tkn){var v=tkn.v.replace("&amp;","&");var tknItem='<tkn v="'+e4h(v)+'" tp="'+(tkn.tp||deTokenInputBox.DEFAULT_TOKEN_TYPE)+'" lv="'+(tkn.lv||1)+'">';if(tkn.oi){var oi=tkn.oi;tknItem+='<oi did="'+e4h(oi.did)+'" t="'+oi.t+'" n="'+e4h(oi.n)+'"/>';}tknItem+="</tkn>";tknstrm+=tknItem;});tknstrm+="</items></tknstrm>";return tknstrm;},checkItem:function checkItem(itm){itm.sta=1;itm.lv=1;itm.tp=2;itm.isNew=true;return itm;}};deTokenInputBox.prototype=new deCart;deTokenInputBox.OPERATOR_TYPES={OPERATOR:1,FUNCTION:2,USER:-1};deTokenInputBox.DEFAULT_TOKEN_TYPE=2;deTokenInputBox.KEYS={BACKSPACE:8,TAB:9,ENTER:13,CTRL:17,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46};deTokenInputBox.PARENT_ELEMENT_ACTIONS={SET:1,CLEAR:2};deTokenInputBox.FAKE_TOKEN={v:"00",tp:2};deTokenInputBox.prototype.deSrcMode=1;deTokenInputBox.prototype.passThrough=false;deTokenInputBox.prototype.passThrough=false;deTokenInputBox.prototype.init=function tib_init(props){try{var me=this,elTib=this.elem;elTib.contentEditable=true;elTib.spellcheck=false;elTib.className="de-token-box";elTib.onclick=function(e){me.onclick(e);};elTib.onmouseup=function(e){me.onmouseup(e);};elTib.onkeydown=function(e){me.onkeydown(e);};elTib.onkeypress=function(e){me.onkeypress(e);};elTib.onkeyup=function(e){me.onkeyup(e);};elTib.oncontextmenu=function(){return false;};elTib.onblur=function(e){me.onblur(e);};elTib.ondragenter=function(e){e=e||window.event;if(!e.data){return false;}};this.editNode=elTib;if(this.tks){this.tks=eval("("+this.tks+")");if(this.tks.items.length>0){var tkn=this.tks.items[1];if(tkn.tp===279&&tkn.oi.did==="8107C340DD9911D3B98100C04F2233EA"){this.passThrough=true;}TKS._preprocessTokenStream(this.tks,this.passThrough);this.items=this.tks.items;this.renderTokenItems();this.tksXML=document.getElementById("elementList").value;var tksDirtyNode=document.getElementById("tokenstreamDirty");if(tksDirtyNode){tksDirtyNode.value=0;}mstr.$R.collapseOnNode(this.editNode,false);this._delaySetCaretPos(this.editNode.lastChild,false);this._saveRangeInfo=mstr.$R.getRangeInfo();}}this.buildToolbar(elTib);this.toggleDETab();this.renderPassThroughParentNode();}catch(err){microstrategy.errors.log(err);return false;}};deTokenInputBox.prototype.widgetHandleDelete=function widgetHandleDelete(rInfo){if(rInfo.collapsed){var edge,ew,idx,so=rInfo.startOffset,itws=this.editNode.childNodes;if(!mstr.$D.containsElement(this.editNode,rInfo.startContainer,false)){mstr.$R.collapseOnNode(this.editNode,false);return ;}edge=mstr.$R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);ew=this.findToken(rInfo.startContainer);idx=ew.idx;var EDGE=mstr.$R.EDGE;if(edge===EDGE.EDGE_END){idx++;ew=itws[idx];so=0;}if(!ew){mstr.$R.collapseOnNode(this.editNode,false);return ;}var data=this.items[idx].v;if(ew.isEditable&&data.length===1||!ew.isEditable){this.items=mstr.$A.remove(this.items,[idx]);this.renderTokenItems();ew=itws[idx];if(ew){mstr.$R.collapseOnNode(ew,true);this._delaySetCaretPos(ew,true);}else{mstr.$R.collapseOnNode(this.editNode,false);}this.checkMergeTwoTokens(idx-1,idx);}else{this.ew=ew;this.spliceContent(so,1);this.renderTokenItems();ew=itws[idx];mstr.$R.collapseOnTextNode(ew,so);this._delaySetTextCaretPos(ew,so);}}else{this.widgetDeleteTokens(rInfo);}};deTokenInputBox.prototype.widgetHandleBackspace=function widgetHandleBackspace(rInfo){var _R=mstr.$R,_D=mstr.$D;if(rInfo.collapsed){var edge,ew,idx,so=rInfo.startOffset,itws=this.editNode.childNodes;if(!_D.containsElement(this.editNode,rInfo.startContainer,false)){if(rInfo.startOffset>0&&mstr.utils.ISFF){ew=itws[this.items.length-1];_R.collapseOnNode(ew,false);rInfo=_R.getRangeInfo();edge=_R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);}else{_R.collapseOnNode(this.editNode,true);return ;}}edge=_R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);ew=this.findToken(rInfo.startContainer);idx=ew.idx;var EDGE=_R.EDGE;if(edge===EDGE.EDGE_BEGIN){idx--;ew=itws[idx];so=ew.length();}if(!ew){_R.collapseOnNode(this.editNode,true);return ;}var data=this.items[idx].v;if(data.length===1||!ew.isEditable){this.items=mstr.$A.remove(this.items,[idx]);this.renderTokenItems();ew=itws[idx-1];if(ew){_R.collapseOnNode(ew,false);this._saveRangeInfo=mstr.$R.getRangeInfo();this.checkMergeTwoTokens(idx-1,idx);ew=itws[idx-1];}else{_R.collapseOnNode(this.editNode,true);}}else{this.ew=ew;this.spliceContent(so-1,1);this.renderTokenItems();ew=itws[idx];_R.collapseOnTextNode(ew,so-1);this._delaySetTextCaretPos(ew,so-1);}}else{this.widgetDeleteTokens(rInfo);}};deTokenInputBox.prototype.widgetDeleteTokens=function widgetDeleteTokens(rInfo){var _R=mstr.$R,_D=mstr.$D;var EDGE=_R.EDGE;var itws=this.editNode.childNodes;var so=rInfo.startOffset,eo=rInfo.endOffset,sw=this.findToken(rInfo.startContainer),ew=this.findToken(rInfo.endContainer),si=sw.idx,ei=ew.idx,arr=[],sEdge=_R.getEdgeInfo(rInfo.startContainer,so),eEdge=_R.getEdgeInfo(rInfo.endContainer,eo),dStart=(sEdge===EDGE.EDGE_BEGIN?si:si+1),dEnd=(eEdge===EDGE.EDGE_END?ei:ei-1),i;if(sw===ew){if((sEdge===EDGE.EDGE_BEGIN)&&(eEdge===EDGE.EDGE_END)){this.items=mstr.$A.remove(this.items,[si]);this.renderTokenItems();ew=itws[si-1];if(ew){_R.collapseOnNode(ew,false);}else{_R.collapseOnNode(this.editNode,true);}}else{sw.spliceContent(so,eo-so);this.renderTokenItems();_R.collapseOnTextNode(ew,so);}}else{if(sEdge===EDGE.EDGE_MIDDLE){this.ew=sw;this.spliceContent(so);}if(eEdge===EDGE.EDGE_MIDDLE){this.ew=ew;this.spliceContent(0,eo);}this.items=mstr.$A.removeRange(this.items,dStart,dEnd-dStart+1);this.renderTokenItems();if(sEdge===EDGE.EDGE_BEGIN){sw=itws[si-1];}if(sw){_R.collapseOnNode(sw,false);}else{_R.collapseOnNode(this.editNode,true);}si=(sEdge===EDGE.EDGE_BEGIN)?si-1:si;this.checkMergeTwoTokens(si,si+1);}this.editNode.focus();};deTokenInputBox.prototype.onkeydown=function onkeydown(e){if(this.passThrough){var me=this;window.setTimeout(function(){me.updatePassThroughTks();me._saveRangeInfo=mstr.$R.getRangeInfo();},10);return true;}e=e||window.event;var k=e.keyCode||e.charCode,noDefault=false,rInfo=this._saveRangeInfo=mstr.$R.getRangeInfo();var KEYS=deTokenInputBox.KEYS;switch(k){case KEYS.DELETE:try{this.widgetHandleDelete(rInfo);}catch(ex1){}noDefault=true;break;case KEYS.BACKSPACE:try{this.widgetHandleBackspace(rInfo);}catch(ex2){}noDefault=true;break;default:}if(noDefault){stopEventBubbling(e||window.event);cancelEvent(e||window.event);return false;}else{return true;}};deTokenInputBox.prototype.onkeyup=function onkeyup(e){e=e||window.event;var k=e.keyCode||e.charCode;var KEYS=deTokenInputBox.KEYS;if(k===KEYS.LEFT_ARROW||k===KEYS.RIGHT_ARROW){this._saveRangeInfo=mstr.$R.getRangeInfo();}};deTokenInputBox.prototype.onkeypress=function onkeypress(e){var me=this;if(this.passThrough){var me=this;window.setTimeout(function(){me.updatePassThroughTks();me._saveRangeInfo=mstr.$R.getRangeInfo();},10);return true;}e=e||window.event;var tgt=getEventTarget(e||window.event);function getCharacter(e){var k=(mstr.utils.ISIE8&&!mstr.utils.ISIE9)?e.keyCode:e.charCode;return(k>0)?String.fromCharCode(k):null;}var c=getCharacter(e),k=e.keyCode||e.charCode,noDefault=false;if((k>=48&&k<=57||(k>=65&&k<=90)||(k>=97&&k<=122)||c==","||c=="."||c=="("||c==")"||c=="<"||c==">"||c=="="||c=="+"||c=="-"||c=="*"||c=="/")||'"'||"'"){var rInfo=(me._saveRangeInfo=mstr.$R.getRangeInfo()),sc=rInfo.startContainer;if(!rInfo.collapsed){this.widgetDeleteTokens(rInfo);rInfo=mstr.$R.getRangeInfo();}var itws=this.editNode.childNodes;if(!mstr.$D.containsElement(this.editNode,rInfo.startContainer,false)){this.items=mstr.$A.insert(this.items,[TKS.checkItem({v:c,tp:deTokenInputBox.DEFAULT_TOKEN_TYPE,isDelimiter:this.isDelimiter(c),isEditable:true})],0);this.renderTokenItems();mstr.$R.collapseOnTextNode(itws[0],1);this._delaySetCaretPos(itws[0],false);stopEventBubbling(e||window.event);cancelEvent(e||window.event);return false;}var edge=mstr.$R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset),ew=this.findToken(rInfo.startContainer),idx=ew.idx;var EDGE=mstr.$R.EDGE;var so=rInfo.startOffset;if(!ew.isEditable){if(edge!==EDGE.EDGE_MIDDLE){var aw=itws[idx+1];if((edge===EDGE.EDGE_END)&&aw&&aw.isEditable){idx=idx+1;var itm=this.items[idx];itm.v=(c||"")+itm.v;itm.sta=1;this.renderTokenItems();mstr.$R.collapseOnTextNode(itws[idx],1);this._delaySetTextCaretPos(itws[idx],1);}else{idx=(edge===EDGE.EDGE_BEGIN)?idx:idx+1;this.items=mstr.$A.insert(this.items,[TKS.checkItem({v:c,tp:deTokenInputBox.DEFAULT_TOKEN_TYPE,isNew:true,isEditable:true})],idx);this.renderTokenItems();ew=itws[idx];mstr.$R.collapseOnNode(ew,false);this._delaySetCaretPos(ew,false);}}noDefault=true;}else{window.setTimeout(function(){sc=rInfo.startContainer;var tkn=me.findToken(sc),idx=tkn.idx;tkn.normalize();me.items[idx].v=(sc.firstChild||sc).data;me._saveRangeInfo=mstr.$R.getRangeInfo();},10);}}else{noDefault=true;}if(noDefault){stopEventBubbling(e||window.event);cancelEvent(e||window.event);return false;}return true;};deTokenInputBox.prototype.onblur=function onblur(e){this.updatePassThroughTks();};deTokenInputBox.prototype.updatePassThroughTks=function updatePassThroughTks(){if(this.passThrough){var v=this.editNode.innerText||this.editNode.textContent;this.tks.items=v.length>0?[{v:v,tp:261,sta:1,lv:1,isNew:true}]:[];this.notify();}};deTokenInputBox.prototype.checkMergeTwoTokens=function checkMergeTwoTokens(idx1,idx2){var itws=this.editNode.childNodes,w1=itws[idx1],w2=itws[idx2],itm1=this.items[idx1],itm2=this.items[idx2];if((w1&&w1.isEditable)&&(w2&&w2.isEditable)){var merge=function(item1,item2){var d1=item1.v,d2=item2.v,d=d1+d2;return TKS.checkItem({v:d,tp:deTokenInputBox.DEFAULT_TOKEN_TYPE,isNew:true,isEditable:true});};var newItem=merge(itm1,itm2),offset=itm1.v.length;this.items=mstr.$A.remove(this.items,[idx1,idx2]);this.items=mstr.$A.insert(this.items,[newItem],idx1);mstr.$R.collapseOnTextNode(itws[idx1],offset);}};deTokenInputBox.prototype.spliceContent=function spliceContent(offset,length,istChar){var ew=this.ew,d=this.items[ew.idx],s=d&&d.v,sb=s.substring(0,offset);length=(length===null||length===undefined)?(s.length-offset):length;var sa=s.substring(offset+length),ns=sb+(istChar||"")+sa;d.v=ns;d.isNew=true;d.sta=1;delete d.oi;};deTokenInputBox.prototype.findToken=function findToken(el){while(el){var tkn=el.isTkn;if(tkn!==null&&tkn!==undefined){return el;}el=el.parentNode;}return null;};deTokenInputBox.prototype.isDelimiter=function isDelimiter(c){return c==",";};deTokenInputBox.prototype.renderTokenItems=function renderTokenItems(){var me=this;me.elem.focus();me.elem.innerHTML="";var tkn,focusTkn,items=this.items;if(this.passThrough){var v="";mstr.$A.forEach(items,function(item,idx){v+=item.v;});v=v.substring(1,v.length-1);v=v.replace(/""/g,'"');me.elem.innerHTML=v;me.updatePassThroughTks();return ;}mstr.$A.forEach(items,function(item,idx){item.idx=idx;tkn=me.buildToken(item);me.elem.appendChild(tkn);if(me._lastIdx==idx){focusTkn=tkn;}me._lastTkn=tkn;});this.tks.items=this.items;this.notify();};deTokenInputBox.prototype.buildToolbar=function buildToolbar(elTib){var me=this;var OPERATOR_TYPES=deTokenInputBox.OPERATOR_TYPES;this.tbItems=[{v:"(",t:1,tp:40},{v:")",t:1,tp:41},{v:"+",t:1,tp:43},{v:"-",t:1,tp:45},{v:"*",t:1,tp:42},{v:"/",t:1,tp:47},{v:"fx",t:-1,tp:-3,cls:"de-functions-pulldown"},{v:microstrategy.descriptors.getDescriptor("2827"),t:-1,tp:-1}];if(this.deSrcMode!=1){this.tbItems.push({v:microstrategy.descriptors.getDescriptor("11897"),t:-1,tp:-2});}if(this.deSrcMode==0){this.tbItems.push({v:microstrategy.descriptors.getDescriptor("13355"),t:-1,tp:-4});}else{if(this.deSrcMode==1){this.passThrough=true;}}var items=this.tbItems;var buildItemNode=function(item,idx){var cls=(item.t===1?"de-operator ":"de-btn ")+(item.cls||"");if(item.tp==-3||item.tp==-2){cls+=me.passThrough?" dsbled":"";}else{if(item.tp==-4){cls+=" pass"+(me.passThrough?" on":"");}}return'<span class="'+cls+'" idx="'+idx+'" v="'+item.v+'" t="'+item.t+'">'+item.v+"</span>";};var toolbarHTML='<div class="de-toolbar">',operatorsHTML='<div class="de-operators-list">',functionsHTML='<div class="de-functions-pulldown"><div class="de-functions-items">',utilsHTML='<div class="de-utils-list">';for(var i=0,len=items.length;i<len;i++){var item=items[i],itemHTML=buildItemNode(item,i);switch(item.t){case OPERATOR_TYPES.FUNCTION:functionsHTML+=itemHTML;break;case OPERATOR_TYPES.OPERATOR:operatorsHTML+=itemHTML;break;case OPERATOR_TYPES.USER:utilsHTML+=itemHTML;}}operatorsHTML+="</div>";functionsHTML+="</div></div>";utilsHTML+="</div>";toolbarHTML+=operatorsHTML+utilsHTML+"</div>";var span=document.createElement("span");span.innerHTML=toolbarHTML;var toolbarNode=span.firstChild;toolbarNode.onclick=function(e){me.handleToolbarAction(e);};elTib.parentNode.insertBefore(toolbarNode,elTib);this.toolbarNode=toolbarNode;delete span;};deTokenInputBox.prototype.handleToolbarAction=function(e){if(document.activeElement!=this.editNode){this.editNode.focus();}e=e||window.event;var OPERATOR_TYPES=deTokenInputBox.OPERATOR_TYPES;var tgt=getEventTarget(e),idx=tgt.getAttribute("idx"),items=this.tbItems,item=items[idx],tkn;if(!item){return ;}var _R=mstr.$R,rInfo=this._saveRangeInfo||_R.getRangeInfo();switch(item.t){case OPERATOR_TYPES.FUNCTION:tgt.parentNode.style.height="0";window.setTimeout(function(){tgt.parentNode.style.height="";},10);this.insertTokens([mstr.$H.clone(item),mstr.$H.clone(this.tbItems[0]),mstr.$H.clone(this.tbItems[1])]);this._delaySetCaretPos(this._lastTkn.previousSibling,false);break;case OPERATOR_TYPES.OPERATOR:if(this.passThrough){this.insertText(item.v);return ;}if(!rInfo.collapsed){this.widgetDeleteTokens(rInfo);rInfo=_R.getRangeInfo();}this.insertTokens([mstr.$H.clone(item)]);break;case OPERATOR_TYPES.USER:if(item.tp===-1){this.clearTokens();}else{if(item.tp===-2){if(this.passThrough){return ;}this.validate();}else{if(item.tp===-3){if(this.passThrough){return ;}toggleShowBean("functionWizard",true,"targetBoneId="+this.parentBone.id+"&formulaMode=2&fctExcludeMode=1");}else{if(item.tp==-4){this.passThrough=!this.passThrough;tgt.className=tgt.className.replace(/ on/,"")+(this.passThrough?" on":"");this.parentBone.elem.className=this.parentBone.elem.className.replace(" pass-through","")+(this.passThrough?" pass-through":"");var clsDisabled=" dsbled";var fxNode=this.toolbarNode.childNodes[1].childNodes[0];fxNode.className=fxNode.className.replace(clsDisabled,"")+(this.passThrough?clsDisabled:"");var validteNode=this.toolbarNode.childNodes[1].childNodes[2];validteNode.className=validteNode.className.replace(clsDisabled,"")+(this.passThrough?clsDisabled:"");this.toggleDETab();this.renderPassThroughParentNode();this.handleSetPassThroughParent();this.clearTokens();}}}}}};deTokenInputBox.prototype.toggleDETab=function(){var deTab=microstrategy.findChildWithAtt(document.getElementById("srcType"),"span","type","2");if(deTab){deTab.style.display=this.passThrough?"none":"";}};deTokenInputBox.prototype.renderPassThroughParentNode=function(){var me=this,passThroughParentNode=this.passThroughParentNode;if(!passThroughParentNode){passThroughParentNode=document.createElement("div");passThroughParentNode.id="dePassThroughParent";passThroughParentNode.className="dePassThroughParent";passThroughParentNode.innerHTML='<span class="dePassThroughParent-set mstrButton" act="'+deTokenInputBox.PARENT_ELEMENT_ACTIONS.SET+'">'+microstrategy.descriptors.getDescriptor("13356")+'</span><span class="dePassThroughParent-text"></span><span class="dePassThroughParent-clear mstrIcon-btnClose" act="'+deTokenInputBox.PARENT_ELEMENT_ACTIONS.CLEAR+'"></span>';passThroughParentNode.onclick=function(e){me.handleSetPassThroughParent(e);};this.editNode.parentNode.appendChild(passThroughParentNode);this.passThroughParentNode=passThroughParentNode;}passThroughParentNode.style.display=this.passThrough?"":"none";this.updatePassThroughParentNode();this.onSrcEltSelectionChange();};deTokenInputBox.prototype.onSrcEltSelectionChange=function onSrcEltSelectionChange(){var btn=this.passThroughParentNode.childNodes[0],srcElem=this.parentBone.srcElmt.elem,selItem=srcElem.options[srcElem.selectedIndex],hcd=selItem&&selItem.getAttribute("hcd");btn.className=btn.className.replace(" disabled","")+(hcd?"":" disabled");};deTokenInputBox.prototype.handleSetPassThroughParent=function handleSetPassThroughParent(e){var tgt=getEventTarget(e||window.event),act=tgt.getAttribute("act");if(act==deTokenInputBox.PARENT_ELEMENT_ACTIONS.SET){var srcElem=this.parentBone.srcElmt.elem,selItem=srcElem.options[srcElem.selectedIndex];if(selItem&&selItem.getAttribute("hcd")){var vals=selItem.value.split("~");this.passThroughParent={did:vals[0],n:vals[2]};}}else{this.passThroughParent=null;}this.updatePassThroughParentNode();};deTokenInputBox.prototype.updatePassThroughParentNode=function updatePassThroughParentNode(){var passThroughParentNode=this.passThroughParentNode,textNode=passThroughParentNode.childNodes[1],clearNode=passThroughParentNode.childNodes[2],item=this.passThroughParent;textNode.innerHTML=item?item.n:"";clearNode.style.display=item?"":"none";this.updateParentElementId2EvtArgInput();};deTokenInputBox.prototype.validate=function(){iframe.showWaitPage();var me=this;me.valid=true;mstr.$XHR.request(mstrApp.taskURL||mstrConfig.taskURL,{taskId:"validateMetric",tokenStreamXML:TKS.buildTokenStreamXML(this.tks,this.passThrough),outputFlags:65536,sessionState:mstrApp.sessionState,msgID:mstrApp.oi.mid,objectType:48},{success:function(res){if(res&&res.tks){var tks=res.tks;TKS._preprocessTokenStream(tks,me.passThrough);me.tks=tks;me.items=me.tks.items;me.renderTokenItems();me._delaySetCaretPos(me.editNode.lastChild,false);var errNode=me.editNode.nextSibling;if(tks.rjec){me.valid=false;if(errNode){errNode.innerHTML="<span>"+tks.rjed+"</span>";}}errNode.style.display=tks.rjec?"block":"none";}},failure:function(res){alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},false);iframe.hideWaitPage();return me.valid;};deTokenInputBox.prototype.updateTokenStreamXML2EvtArgInput=function(){var argNode=document.getElementById("elementList");argNode.value=TKS.buildTokenStreamXML(this.tks,this.passThrough);var tksDirtyNode=document.getElementById("tokenstreamDirty");if(!tksDirtyNode){tksDirtyNode=document.createElement("input");tksDirtyNode.type="hidden";tksDirtyNode.id="tokenstreamDirty";tksDirtyNode.name="tokenstreamDirty";argNode.parentNode.appendChild(tksDirtyNode);}tksDirtyNode.value=this.tksXML!=argNode.value?-1:0;};deTokenInputBox.prototype.updateParentElementId2EvtArgInput=function(){var argNode=document.getElementById("parentElementId");if(argNode){argNode.value=this.passThroughParent?this.passThroughParent.did+"~"+this.passThroughParent.n:"";}};deTokenInputBox.prototype.clearTokens=function clearTokens(){this.editNode.innerHTML="";this.items=[];this.tks.items=[];this._delaySetCaretPos(this.editNode,false);var errNode=this.editNode.nextSibling;errNode.style.display="none";this.notify();};deTokenInputBox.prototype.insertTokens=function insertTokens(tokens){var itws=this.editNode.childNodes;var rInfo=this._saveRangeInfo;if(!rInfo||!mstr.$D.containsElement(this.editNode,rInfo.startContainer,false)){this.items=mstr.$A.insert(this.items,tokens,0);this.renderTokenItems();this._lastTkn=itws[tokens.length-1];this._delaySetCaretPos(this._lastTkn,false);return ;}var EDGE=mstr.$R.EDGE;var edge=mstr.$R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset),ew=this.findToken(rInfo.startContainer),idx=ew.idx;if(edge===EDGE.EDGE_MIDDLE){return ;}else{idx=(edge===EDGE.EDGE_BEGIN?idx:idx+1);this.items=mstr.$A.insert(this.items,tokens,idx);}this.renderTokenItems();idx=idx+tokens.length-1;ew=itws[idx];this._lastTkn=ew;this._delaySetCaretPos(ew,false);this.notify();};deTokenInputBox.prototype._delaySetCaretPos=function _delaySetCaretPos(dn,toStart){if(!dn){return ;}var me=this,en=this.editNode,f=function(){en.focus();en.focus();mstr.$R.collapseOnNode(dn,toStart);me._saveRangeInfo=mstr.$R.getRangeInfo();};window.setTimeout(f,0);};deTokenInputBox.prototype._delaySetTextCaretPos=function _delaySetTextCaretPos(dn,offset){var me=this,en=this.editNode,f=function(){en.focus();en.focus();mstr.$R.collapseOnTextNode(dn,offset);me._saveRangeInfo=mstr.$R.getRangeInfo();};window.setTimeout(f,0);};deTokenInputBox.prototype.onclick=function(e){var _R=mstr.$R;var EDGE=_R.EDGE;var me=this,rInfo=mstr.$R.getRangeInfo(),sc=rInfo.startContainer,so=rInfo.startOffset,edge=_R.getEdgeInfo(sc,so),ew=this.findToken(rInfo.startContainer);if(ew&&!ew.isEditable&&rInfo.collapsed&&edge!=EDGE.EDGE_END&&edge!=EDGE.EDGE_BEGIN){mstr.$R.selectSingleNode(ew);}window.setTimeout(function(){me._saveRangeInfo=mstr.$R.getRangeInfo();},10);};deTokenInputBox.prototype.onmouseup=function(e){if(document.activeElement!=this.elem){return false;}this.extendSelection();this._saveRangeInfo=mstr.$R.getRangeInfo();};deTokenInputBox.prototype.extendSelection=function(){var _R=mstr.$R;var EDGE=_R.EDGE;var itws=this.editNode.childNodes;var rInfo=mstr.$R.getRangeInfo();if(!rInfo.collapsed){var sc=rInfo.startContainer,ec=rInfo.endContainer,so=rInfo.startOffset,eo=rInfo.endOffset,sw=this.findToken(sc),ew=this.findToken(ec),ei=ew.idx,si=sw.idx,sEdge=_R.getEdgeInfo(sc,so),eEdge=_R.getEdgeInfo(ec,eo);if(!sw.isEditable&&sEdge!=EDGE.EDGE_END){so=0;}if(!ew.isEditable&&eEdge!=EDGE.EDGE_BEGIN){eo=this.items[ei].v.length;}mstr.$R.selectMultipleNodes(sc,so,ec,eo);this._saveRangeInfo=mstr.$R.getRangeInfo();}};deTokenInputBox.prototype.insertText=function insertText(text){if(this.passThrough){var ri=this._saveRangeInfo||mstr.$R.getRangeInfo(),range=ri.range||mstr.$R.getRange();if(range.insertNode){range.insertNode(document.createTextNode(text));}else{range.text=text;}this.editNode.normalize();this._delaySetTextCaretPos(this.editNode,ri.startOffset+text.length);this.updatePassThroughTks();}};deTokenInputBox.prototype.addElementToken=function addElementToken(option,notify){if(document.activeElement!=this.editNode){this.editNode.focus();}var ei=option.value,vals=ei.split("~"),tkn;if(this.passThrough){this.insertText(vals[0].split(":")[1]);}else{var et={1048576:1,48:48}[vals[1]]||vals[1],tp={1:311,48:312}[et],tkn={oi:{did:vals[0],t:et,n:vals[2]},v:"{"+this.parentBone.attName+"="+vals[2]+"}",tp:tp,sta:1,isNew:true};this.insertTokens([tkn]);}};deTokenInputBox.prototype.addFunctionToken=function addFunctionToken(funcInfo){this.insertTokens([{oi:{did:funcInfo.id,t:11,n:funcInfo.n},v:funcInfo.n,tp:279,sta:1,isNew:true},mstr.$H.clone(this.tbItems[0]),mstr.$H.clone(this.tbItems[1])]);this._delaySetCaretPos(this._lastTkn.previousSibling,false);};deTokenInputBox.prototype.notify=function(){if(this.observer){}this.updateTokenStreamXML2EvtArgInput();this.updateParentElementId2EvtArgInput();};deTokenInputBox.prototype.buildToken=function(item){var isEditable=function(item){var tp=item.tp;return tp==2||tp==262||tp==263||mstr.$A.find([279,311,312,14,48,40,41,42,43,44,45,47],tp)==-1||item.isEditable;};var v=item.v,oi=item.oi;var span=document.createElement("span");span.v=v;span.idx=item.idx;span.oi=oi;span.tp=item.tp;span.t=item.t;span.isEditable=isEditable(item);span.isTkn="tkn";span.setAttribute("isTkn","tkn");span.innerHTML=span.v;span.className="deToken"+(isEditable(item)?" editable":"")+(item.sta===-1?" err":"");return span;};}());function deTokenInputBox(parent,elem){this.inherits=deCart;this.inherits(parent,elem);delete this.inherits;return this;}(function(){function prevTextNode(node,include,stopNode){if(node.nodeType===3&&include){return node;}else{var ns=(include&&node.nodeType===1&&node.lastChild)?node.lastChild:prevSib(node,stopNode);return ns?prevTextNodeIncluding(ns,stopNode):null;}}function prevSib(node,stopNode){return(node===stopNode)?null:(node.previousSibling||prevSib(node.parentNode,stopNode));}function prevTextNodeIncluding(node,stopNode){if(node===stopNode){return null;}if(node.nodeType===3&&getTextContent(node)){return node;}else{if(node.nodeType===1&&node.lastChild){return prevTextNodeIncluding(node.lastChild);}else{return prevTextNodeIncluding(prevSib(node,stopNode));}}}function getTextContent(node){return node.textContent||node.nodeValue||node.innerText;}function nextTextNode(node,include,stopNode){if(node.nodeType===3&&include){return node;}else{var ns=(include&&node.nodeType===1&&node.firstChild)?node.firstChild:nextSib(node,stopNode);return ns?nextTextNodeIncluding(ns,stopNode):null;}}function nextSib(node,stopNode){return(node===stopNode)?null:(node.nextSibling||nextSib(node.parentNode,stopNode));}function nextTextNodeIncluding(node,stopNode){if(node===stopNode){return null;}if(node.nodeType===3&&getTextContent(node)){return node;}else{if(node.nodeType===1&&node.firstChild){return nextTextNodeIncluding(node.firstChild);}else{return nextTextNodeIncluding(nextSib(node,stopNode));}}}mstr.utils.range={EDGE:{EDGE_BEGIN:1,EDGE_END:2,EDGE_MIDDLE:-1},getEdgeInfo:function getEdgeInfo(node,offset){var l=0,range;if(node.nodeType===1){if(window.getSelection){range=document.createRange();range.selectNode(node);l=range.toString().length;}else{range=document.body.createTextRange();range.moveToElementText(node);l=range.text.length;}}else{l=getTextContent(node).length;}return offset===l?this.EDGE.EDGE_END:(offset===0?this.EDGE.EDGE_BEGIN:this.EDGE.EDGE_MIDDLE);},collapseOnNode:function collapseOnNode(node,toStart){if(!node.offsetParent){return ;}var selection=this.getSelection(),range=this.getRange();if(window.getSelection){range.selectNodeContents(node);range.collapse(toStart);selection.removeAllRanges();selection.addRange(range);}else{range.moveToElementText(node);range.collapse(toStart);range.select();}},collapseOnTextNode:function collapseOnTextNode(node,offset){var selection=this.getSelection(),range=this.getRange();if(window.getSelection){var tn=nextTextNode(node,true);range.setStart(tn,offset);range.collapse(true);selection.removeAllRanges();selection.addRange(range);}else{range.moveToElementText(node);range.collapse(true);range.move("character",offset);range.select();}},getRangeInfo:function getRangeInfo(){var rInfo=null,selection,range=this.getRange(),range2;if(window.getSelection){var gos=function(r,c,start){var r2=r.cloneRange();r2.collapse(start);r2.setStartBefore(c);return r2.toString().length;},sc=range.startContainer,so=range.startOffset;if(sc.nodeType===1){so=gos(range,sc,true);}rInfo={collapsed:range.collapsed,startContainer:sc,startOffset:so};if(!range.collapsed){var ec=range.endContainer,eo=range.endOffset;if(ec.nodeType===1){eo=gos(range,ec,false);}rInfo.endContainer=ec;rInfo.endOffset=eo;}rInfo.range=range;}else{var pe,range3,fo=function(r,start){var r2=r.duplicate(),range2=document.body.createTextRange(),pe;r2.collapse(start);pe=r2.parentElement();range2.moveToElementText(pe);range2.setEndPoint("EndToStart",r2);return{container:pe,offset:range2.text.length};},si=fo(range,true),ei;rInfo={collapsed:(range.compareEndPoints("StartToEnd",range)===0),startContainer:si.container,startOffset:si.offset};if(!rInfo.collapsed){ei=fo(range,false);rInfo.endContainer=ei.container;rInfo.endOffset=ei.offset;}}return rInfo;},collapse:function collapse(toStart){if(window.getSelection){var selection=this.getSelection();if(toStart){selection.collapseToStart();}else{selection.collapseToEnd();}}else{var range=this.getRange();range.collapse(toStart);range.select();}},selectSingleNode:function selectSingleNode(node){var selection=this.getSelection(),range=this.getRange();if(window.getSelection){range.selectNodeContents(node);selection.removeAllRanges();selection.addRange(range);}else{range.moveToElementText(node);range.select();}},selectMultipleNodes:function selectMultipleNodes(startContainer,startOffset,endContainer,endOffset){var selection=this.getSelection(),range=this.getRange();if(window.getSelection){range.setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset);selection.removeAllRanges();selection.addRange(range);}else{startContainer=(startContainer.nodeType===3)?startContainer.parentNode:startContainer;range.moveToElementText(startContainer);range.move("character",startOffset);endContainer=(endContainer.nodeType===3)?endContainer.parentNode:endContainer;var range2=document.body.createTextRange();range2.moveToElementText(endContainer);range2.move("character",endOffset);range.setEndPoint("EndToStart",range2);range.select();}},getSelection:function getSelection(){if(window.getSelection){return window.getSelection();}else{return document.selection;}},getRange:function getRange(){if(window.getSelection){selection=window.getSelection();if(selection.rangeCount>0){return selection.getRangeAt(0);}else{return document.createRange();}}else{return document.selection.createRange();}}};mstr.$R=mstr.utils.range;}());