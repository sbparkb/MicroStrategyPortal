mstrGridSelectionsImpl.prototype=new mstrSelectionsImpl();mstrGridSelectionsImpl.prototype.path="";mstrGridSelectionsImpl.prototype.verifiedPath="";mstrGridSelectionsImpl.prototype.selectedUnits=null;mstrGridSelectionsImpl.prototype.hilitedItems=null;mstrGridSelectionsImpl.prototype.clipboardUnits=undefined;mstrGridSelectionsImpl.prototype.drillingElementsList="";mstrGridSelectionsImpl.prototype.prevSelectionObj=null;mstrGridSelectionsImpl.prototype.x=0;mstrGridSelectionsImpl.prototype.y=0;mstrGridSelectionsImpl.prototype.onload=function(e){try{this.verifiedPath=microstrategy.getEventHandlerString(this.path);return true;}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.singleAttributeElementsAreSelected=function(){try{if(this.getSelectedUnitsCount()==1){for(var i in this.selectedUnits){var oUnit=this.selectedUnits[i];if(oUnit&&oUnit.countLevel()==1){return(oUnit.hasLevel(microstrategy.GRIDCELLTYPE_UNIT_VALUE));}}}return false;}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.anyAttributeElementSelected=function(){try{for(var i in this.selectedUnits){var oUnit=this.selectedUnits[i];if(oUnit&&oUnit.hasLevel(microstrategy.GRIDCELLTYPE_UNIT_VALUE)){return true;}}return false;}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.getSelectedItemCount=function(){try{var selectedItems=this.getItems();return(selectedItems)?selectedItems.length:0;}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.repopulateSelections=function(){try{this.clearUnits();var pb=this.parentBone,gridSelections=pb.gridSelections;if(gridSelections==null||typeof (gridSelections)=="undefined"||gridSelections.length==0){return ;}this.prevSelectionObj=eval("("+gridSelections+")");if(this.prevSelectionObj==null||typeof (this.prevSelectionObj)=="undefined"){return ;}if(this.prevSelectionObj!=null){var currentpage=this.parentBone.currentPageX+","+this.parentBone.currentPageY;var reselectItems=(this.prevSelectionObj.items!=null);var reselectUnits=(this.prevSelectionObj.page==currentpage&&this.prevSelectionObj.units!=null);var selectionActive=(reselectItems||reselectUnits)&&this.hasHilitedCells();if(selectionActive&&microstrategy.EXECUTION_SCOPE==microstrategy.RWD_EXECUTION){this.parentBone.switchToCellSelectionMode();}if(reselectItems){var isFetchingColumns=pb.currentPageX!=pb.previousPageX,items=this.prevSelectionObj.items,cItems=items[currentpage],cnt;if(isFetchingColumns){cnt=pb.chc;for(var idx in cItems){if(idx.substring(0,idx.indexOf(","))>=cnt){delete cItems[idx];}}}else{cnt=pb.rhc;for(var idx in cItems){if(idx.substring(idx.indexOf(","),idx.length-1)>=cnt){delete cItems[idx];}}}for(var page in items){if(items[page]!=null){this.reselectItems(items[page]);}}}if(reselectUnits){for(var i in this.prevSelectionObj.units){var value=this.prevSelectionObj.units[i];if(value!=null){var temps=value.split("|");if(temps!=null){var uIndex=temps[0];var uLevel=temps[1];var uTemps=uIndex.split(",");if(uTemps){var uAxis=uTemps[0];var uDepth=uTemps[1];var unit=this.parentBone.gridStructureInfo.getUnit(uAxis,uDepth);if(unit!=null){if(unit.isVisible&&(this.selectedUnits[uIndex]==null||(!this.selectedUnits[uIndex].hasLevel(uLevel))||(this.selectedUnits[uIndex].levelObjs&&!(this.selectedUnits[uIndex].levelObjs[uLevel]).hasSelectedCells()))){this.addToSelectedUnits(null,unit.src,uLevel,true);}this.resolveParentSelectionInfo(unit,uLevel);}}}}}}}}catch(err){return false;}};mstrGridSelectionsImpl.prototype.checkForSpannedCell=function(table,attrValue,attr){try{var cell=table.rows[0].cells[0];if(cell&&cell.getAttribute(attr)!=null&&cell.getAttribute(attr)==attrValue){return cell;}return null;}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.reselectItems=function(items){try{var table=this.parentBone.elem.getElementsByTagName("table")[0];if(table==null){return ;}var found=false;for(var i in items){if(items[i]==null||items[i]=="null"||typeof (items[i])=="undefined"){continue;}var is=i.split(",");var rowIndex=is[0];var colIndex=is[1];var cell=util_findCell(table,rowIndex,colIndex,items[i],"d1");if(cell==null){cell=this.checkForSpannedCell(table,items[i],"d1");}if(cell==null){var row=table.rows[rowIndex];if(row!=null){var gridInfo=this.parentBone.gridStructureInfo.getGridCellProps(row.cells[colIndex]);var value=gridInfo&&gridInfo.getCellDrillElement(row.cells[colIndex]);if(value&&(value.toLowerCase()==items[i].toLowerCase())){cell=row.cells[colIndex];cell.setAttribute("d1",value);}}}if(cell!=null){this.add(cell,false);found=true;}}return found;}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.add=function(cellSrc,shiftSelect){try{if(microstrategy.EXECUTION_SCOPE==microstrategy.RWD_EXECUTION&&this.parentBone!=null&&!this.parentBone.isGridInCellSelectionMode()){this.parentBone.switchToCellSelectionMode();}if(cellSrc.nodeName.toLowerCase()!="td"){return null;}var cellType=this.getCellLevel(cellSrc);this.selectUnitsItems(cellSrc,cellType,shiftSelect);}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.isCellSingleSelectable=function(cellSrc,cellType){try{var _result=false;var gridUnit=this.parentBone.gridStructureInfo.getGridCellProps(cellSrc);var value=cellSrc.getAttribute("D1");if(!value){value=gridUnit&&gridUnit.getCellDrillElement(cellSrc);if(value){cellSrc.setAttribute("D1",value);}}var _result=(value!=null&&value.length>0);if(!_result){_result=cellSrc.getAttribute("peix")!=null;}if(cellType==microstrategy.GRIDCELLTYPE_UNIT_VALUE&&_result){var cx=cellSrc.getAttribute("CX");if(!cx){cx=gridUnit&&gridUnit.getCellCx();if(cx){cellSrc.setAttribute("CX",cx);}}_result=(cx!=null&&cx.length>0);}if(!_result&&gridUnit){_result=gridUnit.getGridUnitInfo().src.getAttribute("cde");}var isHeaderTitle=(cellType==microstrategy.GRIDCELLTYPE_UNIT_HEADER);return(_result||isHeaderTitle);}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.findTemplateUnit=function(cellSrc,cellType){if(cellType==microstrategy.GRIDCELLTYPE_UNIT_HEADER){return cellSrc;}var o=this.findTemplateUnitObj(cellSrc,cellType);return o&&o.src;};mstrGridSelectionsImpl.prototype.findTemplateUnitObj=function(cellSrc,cellType){try{var unit;switch(cellType){case microstrategy.GRIDCELLTYPE_UNIT_HEADER:unit=cellSrc;break;case microstrategy.GRIDCELLTYPE_SUBTOTAL_HEADER:case microstrategy.GRIDCELLTYPE_SUBTOTAL_VALUE:case microstrategy.GRIDCELLTYPE_UNIT_VALUE:case microstrategy.GRIDCELLTYPE_METRIC_DATA:var unitPos=cellSrc.getAttribute(microstrategy.HTMLATTR_GRID_UNIT_POS);if(unitPos!=null&&unitPos.length>0){var ps=unitPos.split(",");var gridUnit=this.parentBone.gridStructureInfo.getUnit(ps[0],ps[1]);if(gridUnit!=null){unit=gridUnit;}}else{var nodeName=cellSrc.nodeName.toLowerCase();if((nodeName!="td")){cellSrc=microstrategy.findParentWithTag(cellSrc,"td");}var gridUnit=this.parentBone.gridStructureInfo.getGridCellProps(cellSrc)&&this.parentBone.gridStructureInfo.getGridCellProps(cellSrc).getGridUnitInfo();if(gridUnit!=null){unit=gridUnit;}}break;}return unit;}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.getAttrFormUnits=function(cell,unit){try{var result=new Array;var subAxis=unit.getSubAxis();var index;if(this.parentBone.gridStructureInfo!=null&&this.parentBone.gridStructureInfo.showAttForms&&subAxis!=null){for(var i in subAxis.units){result.push(subAxis.units[i].src);}}else{result.push(cell);}return result;}catch(err){microstrategy.errors.log(err);}return null;};mstrGridSelectionsImpl.prototype.getAttrFormValueCells=function(cell,unit){try{var result=new Array;var subAxis=unit.getSubAxis();var index;var gis=this.parentBone.gridStructureInfo;if(gis!=null&&gis.showAttForms&&subAxis!=null){if(unit.axis==microstrategy.GRIDCELL_AXIS_ROWS){index=cell.parentNode.rowIndex;var rowCells=cell.parentNode.cells;var unitIndex=unit.axis+","+unit.depth;for(var i=0;i<rowCells.length;i++){var upt=rowCells[i].getAttribute(microstrategy.HTMLATTR_GRID_UNIT_POS);if(!upt){upt=gis.getGridCellProps(rowCells[i])&&gis.getGridCellProps(rowCells[i]).getCellUpt();if(upt){rowCells[i].setAttribute(microstrategy.HTMLATTR_GRID_UNIT_POS,upt);}}if(upt==unitIndex){result.push(rowCells[i]);}}}else{if(unit.axis==microstrategy.GRIDCELL_AXIS_COLUMNS){index=cell.cellIndex;result.push(cell);}}}else{result.push(cell);}return result;}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.selectUnitsItems=function(cellSrc,cellType,shiftSelect){try{var isMultiSelect=true;if(this.isCellSingleSelectable(cellSrc,cellType)){isMultiSelect=false;if(!shiftSelect){this.lastSelection=cellSrc;}}var unit=this.findTemplateUnitObj(cellSrc,cellType);if(unit.subtype==microstrategy.SUBOBJTYPE_METRIC||cellType==microstrategy.GRIDCELLTYPE_SUBTOTAL_VALUE){isMultiSelect=false;}if(unit&&unit.src){unit=unit.src;}if(unit!=null){this.addToSelectedUnits(cellSrc,unit,cellType,isMultiSelect);this.parentBone.setGraphSelected(false);if(!shiftSelect){this.parentBone.notifySelectionChange("ongridselectionschange");}}}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.isEmpty=function(){try{var unitCount=this.getSelectedUnitsCount();return(unitCount<=0);}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.getSelectedCellsWithAttr=function(attrName,attrValue){try{var _result=new Array;for(var i in this.selectedUnits){var objs=this.selectedUnits[i];objs=objs&&objs.levelObjs;if(objs){for(var j in objs){for(var m in objs[j].selectedItems){var val=objs[j].selectedItems[m].getAttribute(attrName);if(val!=null&&val.length>0&&val.toLowerCase()==attrValue){_result.push(objs[j].selectedItems[m]);}}}}}return _result;}catch(err){microstrategy.errors.log(err);return null;}};mstrGridSelectionsImpl.prototype.addToHilitedItemsCollection=function(cellSrc){try{var index=this.getIndexFromCell(cellSrc);this.hilitedItems[index]=cellSrc;this.hiliteSelected(cellSrc);}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.addToSelectedUnits=function(cellSrc,unitSrc,level,isMultiSelect){try{var selectedCells=new Array();var hilitedCells=new Array();var hilitedMetricCells=new Array();var updateLevel=false;var dssId=unitSrc.getAttribute?unitSrc.getAttribute(microstrategy.HTMLATTR_DSS_ID):unitSrc.dssId;var unit=this.parentBone.gridStructureInfo.findUnit(dssId);if(unit==null){return ;}var index=unit.axis+","+unit.depth;if(this.selectedUnits[index]==null){this.selectedUnits[index]=new mstrUnitObjImpl(this);}this.selectedUnits[index].unit=unit;var gridTarget="";var isMetric=false;switch(unit.subtype){case microstrategy.SUBOBJTYPE_ATTRIBUTE:case microstrategy.SUBOBJTYPE_ATTRIBUTE_FORM:if(unit.isMetricTemplateUnit){gridTarget="0,-999,6";}else{gridTarget=unit.axis+","+unit.depth+",1";}break;case microstrategy.SUBOBJTYPE_METRIC:gridTarget=(unit.depth-1)+",-1,2";isMetric=true;break;}this.selectedUnits[index].gridTarget=gridTarget;this.selectedUnits[index].isMetric=isMetric;if(this.selectedUnits[index].levelObjs[level]==null){this.selectedUnits[index].levelObjs[level]=new mstrUnitLevelObjImpl(this.selectedUnits[index]);}if(isMultiSelect){if(level==microstrategy.GRIDCELLTYPE_UNIT_HEADER){if(isMultiSelect&&this.parentBone.gridStructureInfo.showAttForms&&unit.hasAttForms()){hilitedCells=this.getAttrFormUnits(unitSrc,unit);}else{hilitedCells.push(unitSrc);}}else{hilitedCells=this.parentBone.findAllCells(unit,level);}}else{if(level!=microstrategy.GRIDCELLTYPE_UNIT_HEADER){selectedCells=this.getAttrFormValueCells(cellSrc,unit);if(unit.axis==microstrategy.GRIDCELL_AXIS_ROWS&&unit.depth==this.parentBone.gridStructureInfo.getMaxAxisPosition(unit.axis)-1){var table=this.parentBone.elem.getElementsByTagName("table")[0];if(this.parentBone.commands.queryState("checkMergeRowHeader")){hilitedMetricCells=util_getAllCellsInRowFromThisCell(cellSrc,table);}else{hilitedMetricCells=table.rows[cellSrc.parentNode.rowIndex].cells;}}}else{selectedCells.push(cellSrc);}}for(var k=0;hilitedMetricCells!=null&&k<hilitedMetricCells.length;k++){if(hilitedMetricCells[k]==cellSrc){continue;}var mcellType=this.getCellLevel(hilitedMetricCells[k]);var munitSrc=this.findTemplateUnit(hilitedMetricCells[k],mcellType);if(munitSrc==null){continue;}var mdssId=munitSrc.getAttribute(microstrategy.HTMLATTR_DSS_ID);var munit=this.parentBone.gridStructureInfo.findUnit(mdssId);var mindex=munit.axis+","+munit.depth;if(this.selectedUnits[mindex]==null){this.selectedUnits[mindex]=new mstrUnitObjImpl(this);}this.selectedUnits[mindex].unit=munit;if(this.selectedUnits[mindex].levelObjs[mcellType]==null){this.selectedUnits[mindex].levelObjs[mcellType]=new mstrUnitLevelObjImpl(this.selectedUnits[mindex]);}var metricLevelObj=this.selectedUnits[mindex].levelObjs[mcellType];metricLevelObj.addToHilitedItems(hilitedMetricCells[k]);}var unitLevelObj=this.selectedUnits[index].levelObjs[level];for(var i in hilitedCells){unitLevelObj.addToHilitedItems(hilitedCells[i]);}for(var i in selectedCells){unitLevelObj.addToHilitedItems(selectedCells[i]);unitLevelObj.addToSelectedItems(selectedCells[i]);}if(this.selectedUnits[index].levels.toString().indexOf(level)<0){this.selectedUnits[index].levels.push(level);updateLevel=true;}if(cellSrc!=null){this.parentBone.resetSelections();}return updateLevel;}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.getSelectedGridTarget=function(){try{var count=this.getSelectedUnitsCount();if(count==0){return microstrategy.GRID_TARGET_NONE;}else{if(count==1){for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null&&this.selectedUnits[i].gridTarget!=null&&this.selectedUnits[i].gridTarget.length>0){return this.selectedUnits[i].gridTarget;}}}else{return microstrategy.GRID_TARGET_MULTIPLE;}}}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.getSelectedGridLevel=function(){try{var gridTarget=this.getSelectedGridTarget();switch(gridTarget){case microstrategy.GRID_TARGET_NONE:return microstrategy.GRIDCELLTYPE_LEVEL_NONE;case microstrategy.GRID_TARGET_MULTIPLE:return microstrategy.GRIDCELLTYPE_LEVEL_MULTIPLE;default:for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null&&this.selectedUnits[i].levels.length>0){var levels=this.selectedUnits[i].levels;var size=this.getLevelsCount(levels);if(size<=0){return microstrategy.GRIDCELLTYPE_LEVEL_NONE;}else{if(size==1){return levels[0];}else{return microstrategy.GRIDCELLTYPE_LEVEL_MULTIPLE;}}}}}}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.addToSelections=function(e,src,isDeferredAdd){try{var cellType=this.getCellLevel(src);if(cellType==null||cellType.length<=0){return false;}var unitSrc=this.findTemplateUnitObj(src,cellType);if(!unitSrc){if(microstrategy.EXECUTION_SCOPE==microstrategy.RWD_EXECUTION&&this.parentBone){var ds=this.parentBone.getDocSelections();ds&&ds.addToSelection(e.ctrlKey,findTarget(this.parentBone.elem,microstrategy.HTMLATTR_OBJTYPE));}return false;}unitSrc=unitSrc.src||unitSrc;var dssId=unitSrc.getAttribute?unitSrc.getAttribute(microstrategy.HTMLATTR_DSS_ID):unitSrc.dssId;var unit=this.parentBone.gridStructureInfo.findUnit(dssId);if(e.button==2){if(!this.isSelected(src,unit,cellType)){if(!e.ctrlKey){this.clearCurrentPage(true);}this.resolveParentSelectionInfo(unit,cellType);this.add(src);}}else{if((e.ctrlKey||isMac&&e.metaKey)&&!e.shiftKey){var cnt=this.getSelectedUnitsCount();if(this.isSelected(src,unit,cellType)){if(cnt==2){var item=null;for(var u in this.selectedUnits){if(this.selectedUnits[u]&&this.selectedUnits[u].unit!=unit){item=this.selectedUnits[u];}}if(item){this.resolveParentSelectionInfo(item.unit,item.resolveLevelsValue());}}else{if(cnt==1){this.updateParentSelectionInfo(microstrategy.GRID_UNIT_CONTAINER,1);}}this.remove(src);}else{this.selectStartFunc=this.parentBone.elem.onselectstart;this.restoreSelectStartFunc=true;this.parentBone.elem.onselectstart=new Function("return false;");if(this.lastSelectionIsFromToolbar()){this.clearCurrentPage(true);}if(cnt>0){this.updateParentSelectionInfo(-1,-1);}if(this.isCellSingleSelectable(src,cellType)){this.add(src);}else{if(this.isCellHilited(src)){this.remove(src);}else{this.add(src);}}}}else{if(e.shiftKey&&this.isCellShiftSelectable(src,cellType)){this.selectStartFunc=this.parentBone.elem.onselectstart;this.restoreSelectStartFunc=true;this.parentBone.elem.onselectstart=new Function("return false;");if(!e.ctrlKey){this.clearCurrentPage(true);}this.updateParentSelectionInfo(-1,-1);this.shiftSelect(unit,src,cellType);}else{if(!isDeferredAdd){if(this.isSelected(src,unit,cellType)&&(cellType==microstrategy.GRIDCELLTYPE_UNIT_HEADER)){this.deferredSrc=src;return false;}else{this.deferredSrc=null;}}if(cellType==microstrategy.GRIDCELLTYPE_UNIT_HEADER){this.clearAll(true);}else{this.clearCurrentPage(true);}this.resolveParentSelectionInfo(unit,cellType);this.add(src);}}}this.handleCopySelections(src,unit,e);}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.isCellShiftSelectable=function(cellSrc,cellType){return(cellType==microstrategy.GRIDCELLTYPE_UNIT_VALUE)&&cellSrc.nodeName.toLowerCase()=="td"&&this.lastSelection&&this.lastSelection!=cellSrc&&this.lastSelection.getAttribute(microstrategy.HTMLATTR_GRIDCELL_ID)===cellSrc.getAttribute(microstrategy.HTMLATTR_GRIDCELL_ID);};mstrGridSelectionsImpl.prototype.shiftSelect=function(unit,cellSrc,cellType){try{var cellId=((unit.axis==-1)?0:unit.axis)+"A"+unit.depth;var cells=this.parentBone.getCellsWithAttr(microstrategy.HTMLATTR_GRIDCELL_ID,cellId);var inRange=false;var start=-1,end=-1;for(var i=0;i<cells.length;i++){var cell=cells[i];if(cell===cellSrc||cell===this.lastSelection){inRange=!inRange;if(!inRange){this.add(cell,true);break;}}if(inRange){this.add(cell,true);}}this.parentBone.notifySelectionChange("ongridselectionschange");}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.resolveParentSelectionInfo=function(unit,lvl){try{if(unit!=null){var unitValue=(unit.isMetricTemplateUnit)?mstrGridReport.METRIC_UNITS:this.parentBone.resolveGridUnitId(unit.axis,unit.depth);this.updateParentSelectionInfo(unitValue,lvl);}}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.updateParentSelectionInfo=function(unit,lvl){try{this.parentBone.gridUnitFormat=unit;this.parentBone.gridValueFormat=lvl;}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.clearDeferredSrc=function(){this.deferredSrc=null;};mstrGridSelectionsImpl.prototype.onmouseup=function(e){if(this.restoreSelectStartFunc){this.parentBone.elem.onselectstart=this.selectStartFunc;}this.selectStartFunc=null;this.restoreSelectStartFunc=false;if(this.deferredSrc){this.addToSelections(e,this.deferredSrc,true);}};mstrGridSelectionsImpl.prototype.lastSelectionIsFromToolbar=function(){try{return(this.parentBone.selectedAxis!=null||this.parentBone.selectedLevel!=null||this.parentBone.selectedPosition!=null||this.parentBone.selectedUnit!=null);}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.isCellHilited=function(cellSrc){try{var isHilited=false;for(var i in this.selectedUnits){var unitObj=this.selectedUnits[i];if(unitObj!=null&&unitObj.levelObjs!=null){var unitLevel=unitObj.levelObjs;for(var j in unitLevel){if(unitLevel[j]!=null){isHilited=unitLevel[j].hasHilitedCell(cellSrc);if(isHilited){return isHilited;}}}}}return isHilited;}catch(err){microstrategy.errors.log(err);return null;}};mstrGridSelectionsImpl.prototype.isCellSelected=function(src){try{var cellType=this.getCellLevel(src);if(cellType==null||cellType.length<=0){return false;}var unitSrc=this.findTemplateUnit(src,cellType);if(unitSrc==null){return false;}var dssId=unitSrc.getAttribute(microstrategy.HTMLATTR_DSS_ID);var unit=this.parentBone.gridStructureInfo.findUnit(dssId);return this.isSelected(src,unit,cellType);}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.isSelected=function(obj,unit,level){try{if(this.selectedUnits!=null&&unit!=null){var index=unit.axis+","+unit.depth;var unitObj=this.selectedUnits[index];if(unitObj!=null&&unitObj.levelObjs!=null&&unitObj.levelObjs[level]!=null){return unitObj.levelObjs[level].hasSelectedCell(obj);}}return false;}catch(err){microstrategy.errors.log(err);return null;}};mstrGridSelectionsImpl.prototype.hasSelectedCells=function(){try{var result=false;if(this.selectedUnits!=null){for(var index in this.selectedUnits){var unitObj=this.selectedUnits[index];if(unitObj!=null&&unitObj.levelObjs!=null){var unitLevelObjs=unitObj.levelObjs;for(var level in unitLevelObjs){result=unitLevelObjs[level].hasSelectedCells();if(result){return result;}}}}}return result;}catch(err){microstrategy.errors.log(err);return null;}};mstrGridSelectionsImpl.prototype.hasHilitedCells=function(){try{var result=false;if(this.selectedUnits!=null){for(var index in this.selectedUnits){var unitObj=this.selectedUnits[index];if(unitObj!=null&&unitObj.levelObjs!=null){var unitLevelObjs=unitObj.levelObjs;for(var level in unitLevelObjs){result=unitLevelObjs[level].hasHilitedCells();if(result){return result;}}}}}return result;}catch(err){microstrategy.errors.log(err);return null;}};mstrGridSelectionsImpl.prototype.remove=function(cellSrc){try{if(cellSrc.nodeName.toLowerCase()!="td"){return false;}var cellType=this.getCellLevel(cellSrc);this.removeUnitsItems(cellSrc,cellType);}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.removeUnitsItems=function(cellSrc,cellType){try{var isMultiDeSelect=true;if(this.isCellSingleSelectable(cellSrc,cellType)){isMultiDeSelect=false;}var unit=this.findTemplateUnit(cellSrc,cellType);if(unit!=null){this.removeFromSelectedUnits(cellSrc,unit,cellType,isMultiDeSelect);this.parentBone.notifySelectionChange("ongridselectionschange");}}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.removeFromSelectedUnits=function(cellSrc,unitSrc,level,isMultiDeSelect){try{var updateLevel=false;var removedCells=new Array();var deHilitedCells=new Array;var deSelectedCells=new Array;var deHilitedMetricCells=new Array;var dssId=unitSrc.getAttribute(microstrategy.HTMLATTR_DSS_ID);var unit=this.parentBone.gridStructureInfo.findUnit(dssId);var index=unit.axis+","+unit.depth;var unitLevelObj=this.selectedUnits[index].levelObjs[level];if(isMultiDeSelect){unitLevelObj.clearSelectedItems();unitLevelObj.clearHilitedItems();}else{if(level!=microstrategy.RIDCELLTYPE_UNIT_HEADER){deSelectedCells=this.getAttrFormValueCells(cellSrc,unit);if(unit.axis==microstrategy.GRIDCELL_AXIS_ROWS&&unit.depth==this.parentBone.gridStructureInfo.getMaxAxisPosition(unit.axis)-1){var table=this.parentBone.elem.getElementsByTagName("table")[0];if(this.parentBone.commands.queryState("checkMergeRowHeader")){deHilitedMetricCells=util_getAllCellsInRowFromThisCell(cellSrc,table);}else{deHilitedMetricCells=table.rows[cellSrc.parentNode.rowIndex].cells;}}}else{deSelectedCells.push(cellSrc);}}for(var k=0;deHilitedMetricCells!=null&&k<deHilitedMetricCells.length;k++){if(deHilitedMetricCells[k]==cellSrc){continue;}var mcellType=this.getCellLevel(deHilitedMetricCells[k]);var munitSrc=this.findTemplateUnit(deHilitedMetricCells[k],mcellType);if(munitSrc==null){return false;}var mdssId=munitSrc.getAttribute(microstrategy.HTMLATTR_DSS_ID);var munit=this.parentBone.gridStructureInfo.findUnit(mdssId);var mindex=munit.axis+","+munit.depth;if(this.selectedUnits[mindex]==null){this.selectedUnits[mindex]=new mstrUnitObjImpl(this);}this.selectedUnits[mindex].unit=munit;if(this.selectedUnits[mindex].levelObjs[mcellType]==null){this.selectedUnits[mindex].levelObjs[mcellType]=new mstrUnitLevelObjImpl(this.selectedUnits[mindex]);}var metricLevelObj=this.selectedUnits[mindex].levelObjs[mcellType];metricLevelObj.removeHilitedItems(deHilitedMetricCells[k]);}for(var i in deSelectedCells){unitLevelObj.removeSelectedItems(deSelectedCells[i]);unitLevelObj.removeHilitedItems(deSelectedCells[i]);}if(unitLevelObj.selectedItemsLength==0){updateLevel=true;this.selectedUnits[index].removeLevel(level);}if(this.selectedUnits[index].countLevel()<=0){this.selectedUnits[index]=null;}return updateLevel;}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.getIndexFromCell=function(obj){try{if(obj==null||typeof (obj)=="undefined"||obj.nodeName==null||typeof (obj.nodeName)=="undefined"||obj.nodeName.toLowerCase()!="td"){return null;}return(obj.parentNode.rowIndex+","+obj.cellIndex);}catch(err){microstrategy.errors.log(err);}return null;};mstrGridSelectionsImpl.prototype.hiliteSelected=function(obj){try{if(obj.nodeName.toLowerCase()=="td"){this.hiliteObj(obj,"50");}}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.hiliteObj=function(obj,opacity){try{if(obj.nodeName.toLowerCase()=="td"&&bIsIE8){var div,oldChild;if(opacity!="100"){if(obj.firstChild&&obj.firstChild.nodeName.toLowerCase()=="div"&&obj.firstChild.getAttribute("f")=="1"){div=obj.firstChild;}else{div=document.createElement("div");div.setAttribute("f","1");while(obj.firstChild){oldChild=obj.removeChild(obj.firstChild);div.appendChild(oldChild);}obj.appendChild(div);}setFilter(div,"Alpha",{opacity:"50"});return ;}else{if(obj.firstChild&&obj.firstChild.nodeName.toLowerCase()=="div"&&obj.firstChild.getAttribute("f")=="1"){div=obj.firstChild;while(div.firstChild){oldChild=div.removeChild(div.firstChild);obj.appendChild(oldChild);}obj.removeChild(div);return ;}}}setFilter(obj,"Alpha",{opacity:opacity});}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.clear=function(){try{this.clearAll(true);}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.clearAll=function(notNotify){try{if(this.hasHilitedCells()){this.clearCurrentPage(notNotify);this.clearSelectionsFromOtherPages();this.clearClipboardItems();var _tmp=this.parentBone&&this.parentBone.switchToContainerSelectionMode&&this.parentBone.switchToContainerSelectionMode();}}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.clearCurrentPage=function(notNotify){try{this.removeAllHilites();this.clearSelectedItemsOnCurrentPage();this.clearUnits();if(notNotify){return ;}this.parentBone.notifySelectionChange("ongridselectionschange");}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.clearUnits=function(){try{this.selectedUnits=new Array;}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.clearSelectedItemsOnCurrentPage=function(){try{for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null&&this.selectedUnits[i].levelObjs!=null){for(var j in this.selectedUnits[i].levelObjs){this.selectedUnits[i].levelObjs[j].clearSelectedItems();}}}}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.removeAllHilites=function(){try{for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null&&this.selectedUnits[i].levelObjs!=null){for(var j in this.selectedUnits[i].levelObjs){this.selectedUnits[i].levelObjs[j].clearHilitedItems();}}}return false;}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.removeHilites=function(obj){try{if(obj.nodeName.toLowerCase()=="td"){if(!this.parentBone.restoreHiliteIfCurrent(obj)){this.hiliteObj(obj,"100");}}}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.removeFromHilitedItems=function(obj){try{var index=this.getIndexFromCell(Obj);delete this.hilitedItems[index];}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.getSelectionsFromOtherPages=function(){try{return this.parentBone.gridSelections;}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.clearSelectionsFromOtherPages=function(){try{this.parentBone.gridSelections="";}catch(err){microstrategy.errors.log(err);}return false;};mstrGridSelectionsImpl.prototype.getSelectedUnitsCount=function(){try{var counter=0;for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null){var levels=this.selectedUnits[i].levels;if(levels!=null&&this.getLevelsCount(levels)>0){counter++;}}}return counter;}catch(err){microstrategy.errors.log(err);return 0;}};mstrGridSelectionsImpl.prototype.getLevelsCount=function(levels){try{var counter=0;for(var i in levels){if(levels[i]!=null&&typeof (levels[i])!="undefined"){counter++;}}return counter;}catch(err){microstrategy.errors.log(err);return 0;}};mstrGridSelectionsImpl.prototype.getSelectedGridTargetGridLevel=function(){try{var selections=new Array();if(this.parentBone.selectedAxis!=null&&this.parentBone.selectedPosition!=null&&this.parentBone.selectedUnit!=null&&this.parentBone.selectedLevel!=null){selections.push(this.parentBone.selectedAxis+","+this.parentBone.selectedPosition+","+this.parentBone.selectedUnit+","+this.parentBone.selectedLevel);}else{if(this.selectedUnits.length==0&&this.parentBone.gridUnitFormat==microstrategy.GRID_BORDERS){selections=["0,-99,2,6"];}else{for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null){var levels=this.selectedUnits[i].levels;var axis;var position;var unit;var temps=this.selectedUnits[i].gridTarget.split(",");if(this.selectedUnits[i].isMetric){axis="0";position=temps[0];}else{axis=temps[0];position=temps[1];}unit=temps[2];for(var l in levels){selections.push(axis+","+position+","+unit+","+levels[l]);}}}}}return selections;}catch(err){microstrategy.errors.log(err);return 0;}};mstrGridSelectionsImpl.prototype.getCellLevel=function(cellSrc){try{var subtype=cellSrc.getAttribute(microstrategy.HTMLATTR_SUBOBJTYPE);var _result="";switch(subtype){case microstrategy.SUBOBJTYPE_ATTRIBUTE:case microstrategy.SUBOBJTYPE_ATTRIBUTE_FORM:case microstrategy.SUBOBJTYPE_METRIC:_result=microstrategy.GRIDCELLTYPE_UNIT_HEADER;break;}if(_result==""){var celltype=this.parentBone.gridStructureInfo.getCellType(cellSrc);switch(celltype){case microstrategy.GRIDCELLTYPE_SUBTOTAL_HEADER:case microstrategy.GRIDCELLTYPE_SUBTOTAL_VALUE:case microstrategy.GRIDCELLTYPE_UNIT_VALUE:_result=celltype;break;}}return _result;}catch(err){microstrategy.errors.log(err);return null;}};mstrGridSelectionsImpl.prototype.getSelections=function(){try{var _result="";var selectedItems="";var currentPageSelections="'"+this.parentBone.currentPageX+","+this.parentBone.currentPageY+"':{"+this.getItemSelections(this.getItemsAsAssociativeArray())+"}";selectedItems+="'items':{"+currentPageSelections+"}";var unitsIndex=this.parentBone.gridSelections.indexOf("'units'");if(unitsIndex>-1){this.parentBone.gridSelections=this.parentBone.gridSelections.substring(0,unitsIndex-1)+"}";}if(microstrategy.EXECUTION_SCOPE==microstrategy.RWD_EXECUTION||this.parentBone.gridSelections.length<=0){_result="{"+selectedItems+"}";}else{var re=new RegExp("'"+this.parentBone.currentPageX+","+this.parentBone.currentPageY+"':\\{(('\\d+,\\d+':'(\\w,*)*'),*)*\\}","g");if(this.parentBone.gridSelections.match(re)!=null){_result=this.parentBone.gridSelections.replace(re,currentPageSelections);}else{_result=this.parentBone.gridSelections.substring(0,this.parentBone.gridSelections.length-2)+","+currentPageSelections+"}}";}}var selectedUnits=this.getUnitSelections(this.selectedUnits);if(selectedUnits!=""){selectedUnits="'units':{"+selectedUnits+"}";}else{selectedUnits="'units':null";}var currentPage="'page':'"+this.parentBone.currentPageX+","+this.parentBone.currentPageY+"'";_result=_result.substring(0,_result.length-2)+"},"+selectedUnits+","+currentPage+"}";return _result;}catch(err){microstrategy.errors.log(err);}return null;};mstrGridSelectionsImpl.prototype.getItemSelections=function(items){try{var found=false;var selectedItems="";if(items!=null){for(var i in items){var drillId=items[i].getAttribute("d1");selectedItems+="'"+i+"':'"+drillId+"',";found=true;}if(found){selectedItems=selectedItems.substring(0,selectedItems.length-1);}}return selectedItems;}catch(err){microstrategy.errors.log(err);return"";}};mstrGridSelectionsImpl.prototype.getItemsAsAssociativeArray=function(){try{var _result=new Object;var hasSelectedItems=false;for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null){var objs=this.selectedUnits[i].levelObjs;for(var j in objs){for(var m in objs[j].selectedItems){_result[m]=objs[j].selectedItems[m];hasSelectedItems=true;}}}}return(hasSelectedItems)?_result:null;}catch(err){microstrategy.errors.log(err);return"";}};mstrGridSelectionsImpl.prototype.getItems=function(){try{var _result=new Array;for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null){var objs=this.selectedUnits[i].levelObjs;for(var j in objs){for(var m in objs[j].selectedItems){_result.push(objs[j].selectedItems[m]);}}}}return _result;}catch(err){microstrategy.errors.log(err);return"";}};mstrGridSelectionsImpl.prototype.allOnOneAxis=function(){try{var items=this.getSelectedUnitHeaders();if(items.length==0){return true;}items.sort(function(a,b){return(parseInt(a.getAttribute(microstrategy.HTMLATTR_GRIDCELL_AXIS))-parseInt(b.getAttribute(microstrategy.HTMLATTR_GRIDCELL_AXIS)));});return(items[0].getAttribute(microstrategy.HTMLATTR_GRIDCELL_AXIS)==items[items.length-1].getAttribute(microstrategy.HTMLATTR_GRIDCELL_AXIS));}catch(err){microstrategy.errors.log(err);return"";}};mstrGridSelectionsImpl.prototype.getFullLevelSelectedUnits=function(units){try{var found=false;var selectedUnits="";var j=0;if(units!=null){for(var i in units){for(var l in units[i].levels){var unitLevelObj=units[i].levelObjs[l];selectedUnits+="'"+(j++)+"':'"+i+","+units[i].levels[l]+"',";found=true;}}if(found){selectedUnits=selectedUnits.substring(0,selectedUnits.length-1);}}return selectedUnits;}catch(err){microstrategy.errors.log(err);return"";}};mstrGridSelectionsImpl.prototype.getUnitSelections=function(units){try{var found=false;var selectedUnits="";var j=0;if(units!=null){for(var i in units){if(units[i]!=null){for(var l in units[i].levels){selectedUnits+="'"+(j++)+"':'"+i+"|"+units[i].levels[l]+"',";found=true;}}}if(found){selectedUnits=selectedUnits.substring(0,selectedUnits.length-1);}}return selectedUnits;}catch(err){microstrategy.errors.log(err);return"";}};mstrGridSelectionsImpl.prototype.getSelectedUnitHeaders=function(){try{var _result=new Array;if(this.selectedUnits!=null){for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null){var levelObjs=this.selectedUnits[i].levelObjs;if(levelObjs[microstrategy.GRIDCELLTYPE_UNIT_HEADER]!=null){for(var m in levelObjs[microstrategy.GRIDCELLTYPE_UNIT_HEADER].selectedItems){var cell=levelObjs[microstrategy.GRIDCELLTYPE_UNIT_HEADER].selectedItems[m];if(cell!=null){_result.push(cell);}}}}}}return _result;}catch(err){microstrategy.errors.log(err);return"";}};mstrGridSelectionsImpl.prototype.hasMetricsSelected=function(){try{if(this.selectedUnits!=null){for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null){if(this.selectedUnits[i].isMetric){return true;}}}}return false;}catch(err){microstrategy.errors.log(err);return"";}};mstrGridSelectionsImpl.prototype.getSelectedDrillElements=function(){try{var result="";var items=this.getItems();for(var i in items){var drillId=items[i].getAttribute("d1");if(drillId!=null&&drillId!="null"){result+=drillId+",";}}if(this.prevSelectionObj!=null){for(var page in this.prevSelectionObj.items){var pages=page.split(",");var x=pages[0];var y=pages[1];if(x!=this.parentBone.currentPageX||y!=this.parentBone.currentPageY){var prevItems=this.prevSelectionObj.items[page];for(var i in prevItems){var drillId=prevItems[i];if(drillId!=null&&drillId!="null"){result+=drillId+",";}}}}}result=result+(this.parentBone.hiddenDrillValues||"");if(result.length>0){result=result.substring(0,result.length-1);}return result;}catch(err){microstrategy.errors.log(err);}return null;};mstrGridSelectionsImpl.prototype.getSelectedDrillElementsCount=function(){try{var result=0;var items=this.getItems();var drillMap={};for(var i in items){var drillId=items[i].getAttribute("d1");if(drillId!=null&&drillId!="null"&&!drillMap[drillId]){drillMap[drillId]=true;result++;}}if(this.prevSelectionObj!=null){for(var page in this.prevSelectionObj.items){var pages=page.split(",");var x=pages[0];var y=pages[1];if(x!=this.parentBone.currentPageX||y!=this.parentBone.currentPageY){var prevItems=this.prevSelectionObj.items[page];for(var i in prevItems){var drillId=prevItems[i];if(drillId!=null&&drillId!="null"&&!drillMap[drillId]){drillMap[drillId]=true;result++;}}}}}return result;}catch(err){microstrategy.errors.log(err);}return null;};mstrGridSelectionsImpl.prototype.getSelectedElementsOrdinals=function(itemNames){try{var _result=new Array();var selectedGridTarget=this.getSelectedGridTarget();if(selectedGridTarget!=null){var values=selectedGridTarget.split(",");var selectedUnit=this.parentBone.gridStructureInfo.getUnit(values[0],values[1],1);if(selectedUnit!=null){var unitSrc=selectedUnit.src;var unitIndex=this.getIndexFromCell(unitSrc);for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null){var objs=this.selectedUnits[i].levelObjs;for(var j in objs){for(var index in objs[j].selectedItems){var cellsrc=objs[j].selectedItems[index];var elemInfo=cellsrc.getAttribute("D1");if(elemInfo&&elemInfo.length>0){var oinfos=elemInfo.split("A");if(oinfos&&oinfos.length==3){_result.push(parseInt(oinfos[2]));}}itemNames.push(trim(decode(cellsrc.innerHTML,false)));}}}}}}return _result;}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.containsDerivedElements=function(){try{var selectedGridTarget=this.getSelectedGridTarget();if(selectedGridTarget!=null){var values=selectedGridTarget.split(",");var selectedUnit=this.parentBone.gridStructureInfo.getUnit(values[0],values[1],1);if(selectedUnit!=null){for(var i in this.selectedUnits){if(this.selectedUnits[i]!=null){var objs=this.selectedUnits[i].levelObjs;for(var j in objs){for(var index in objs[j].selectedItems){var cellsrc=objs[j].selectedItems[index];var isDe=cellsrc.getAttribute("ide");if(isDe){return true;}}}}}}}return false;}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.ondocumentclick=function(e){try{var srcId="";var srcBoneId="";var shouldClear=false;var isAnchor=false;if(!e){e=window.event;}getMouse(e);var src=getEventTarget(e),srcTable=microstrategy.findAncestorWithAtt(src,"tagName","table");var isInDoc=false;if(this.hasHilitedCells()==false){if(srcTable==null||(srcTable.getAttribute("id")!="table_"+this.parentBone.id)){this.clearClipboardItems();}return ;}if(mstrGridStatic.isMouseOverScrollBar(src,lMouseX,lMouseY)){return ;}if(microstrategy.EXECUTION_SCOPE==microstrategy.RWD_EXECUTION){isInDoc=!!microstrategy.findAncestorWithAtt(src,"id","rwb_viewer");}else{var isBottomSpace=(src.className&&src.className=="repLayoutRight");var classAttName=(bIsW3C)?"class":"className";var reportLayout=microstrategy.findAncestorWithAtt(src,classAttName,"mstrVerticalDocks");var fetchLink=microstrategy.findAncestorWithAtt(src,microstrategy.HTMLATTR_OBJTYPE,"if");if(fetchLink==null){var drillEditorPane=microstrategy.findAncestorWithAtt(src,microstrategy.HTMLATTR_ID,"drillEditor_pane");if(drillEditorPane==null){var incrementalRight=microstrategy.findAncestorWithAtt(src,classAttName,"report-right");if(incrementalRight==null){var incrementalLeft=microstrategy.findAncestorWithAtt(src,classAttName,"report-left");if(incrementalLeft!=null){isAnchor=true;}}else{isAnchor=true;}}else{isAnchor=true;}}else{isAnchor=true;}if(reportLayout!=null||isBottomSpace){isInDoc=true;}}shouldClear=(isInDoc&&!isAnchor&&(srcTable==null||(srcTable.getAttribute("id")!="table_"+this.parentBone.id)));if(shouldClear){this.clearAll();}}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.handleCopySelections=function(src,unit,e){if(e.button==2){return ;}var STATES={ADD:0,REMOVE:1,RANGE_ADD:2},units=this.clipboardUnits||{},cellType=this.getCellLevel(src),unitSrc=this.findTemplateUnit(src,cellType),srcIdx=this.getCellIndexInTable(src),cells=this.findAllAssociatedCells(unit,src,cellType),isCtrlKey=(e.ctrlKey||isMac&&e.metaKey),isShiftKey=e.shiftKey,saveLastSrc=!isShiftKey,state=STATES.ADD,reset=false,i;if(isCtrlKey&&!isShiftKey){state=units[srcIdx]?STATES.REMOVE:STATES.ADD;}else{if(isShiftKey){state=STATES.RANGE_ADD;reset=!isCtrlKey;}else{reset=true;}}if(reset){units={};this.clearClipboardItems();}var isSingleSelectedCell=reset;switch(state){case STATES.ADD:var relatedCells=[],cell;if(cellType==microstrategy.GRIDCELLTYPE_UNIT_HEADER||cellType==microstrategy.GRIDCELLTYPE_SUBTOTAL_HEADER){relatedCells=cells;}else{if(unit.axis==microstrategy.GRIDCELL_AXIS_ROWS&&unit.depth==this.parentBone.gridStructureInfo.getMaxAxisPosition(unit.axis)-1){var table=this.parentBone.elem.getElementsByTagName("table")[0];var row=src.parentNode;var nodeName=row.nodeName.toLowerCase();if((nodeName!="tr")){row=microstrategy.findParentWithTag(row,"tr");}relatedCells=(this.parentBone.commands.queryState("checkMergeRowHeader")?util_getAllCellsInRowFromThisCell(src,table):table.rows[row.rowIndex].cells)||[];isSingleSelectedCell=false;}}for(i=0;i<relatedCells.length;i++){cell=relatedCells[i];units[this.getCellIndexInTable(cell)]=cell;}units[srcIdx]=src;break;case STATES.REMOVE:this.clearClipboardItems();delete units[srcIdx];break;case STATES.RANGE_ADD:var cellId=src.getAttribute(microstrategy.HTMLATTR_GRIDCELL_ID),inRange=false,start=-1,end=-1,cell;for(i=0;i<cells.length;i++){cell=cells[i];if(cell===src||cell===this.lastCopySelection){inRange=!inRange;if(!inRange){units[this.getCellIndexInTable(cell)]=cell;break;}}if(inRange){units[this.getCellIndexInTable(cell)]=cell;}}if(inRange){units={};units[srcIdx]=src;saveLastSrc=true;}break;}if(saveLastSrc){this.lastCopySelection=src;}this.clipboardUnits=units;this.copyToClipboard(false,isSingleSelectedCell);};mstrGridSelectionsImpl.prototype.handleSelectAll=function(){try{microstrategy.showWait();var units={},$this=this,gridBone=this.parentBone,gridElem=gridBone.elem,table=gridElem.getElementsByTagName("table")[0],trs=table.rows,i,j,cells;gridBone.commands.exec("tbGridUnitSelector",mstrGridReport.ALL_UNITS);gridBone.commands.exec("tbGridValueSelector",mstrGridReport.ALL_FORMAT_VALUES);addCssClass(gridElem,["cbSel"]);window.setTimeout(function(){for(i=0;i<trs.length;i++){cells=trs[i].cells;for(j=0;j<cells.length;j++){units[$this.getCellIndexInTable(cells[j])]=cells[j];}}$this.clipboardUnits=units;$this.copyToClipboard(true,true);},0);}catch(err){microstrategy.errors.log(err);}};mstrGridSelectionsImpl.prototype.getCellIndexInTable=function(cell){var lookup=this.tableLookup;if(!lookup){var data=[],table=this.parentBone.elem.getElementsByTagName("table")[0],trs=table.rows,dataRow,cells,i,i,j,k,l;lookup={};for(i=0;i<trs.length;i++){cells=trs[i].cells;var rowIndex=trs[i].rowIndex;for(j=0;j<cells.length;j++){var c=cells[j],rowSpan=c.rowSpan||1,colSpan=c.colSpan||1,firstAvailCol;dataRow=data[rowIndex]=data[rowIndex]||[];for(k=0;k<dataRow.length+1;k++){if(!dataRow[k]){firstAvailCol=k;break;}}lookup[this.getIndexFromCell(c)]=firstAvailCol;for(k=rowIndex;k<rowIndex+rowSpan;k++){dataRow=data[k]=data[k]||[];for(l=firstAvailCol;l<firstAvailCol+colSpan;l++){dataRow[l]=[rowIndex,firstAvailCol];}}}}this.tableLookup=lookup;this.tableReference=data;}return(cell.parentNode.rowIndex+","+lookup[this.getIndexFromCell(cell)]);};mstrGridSelectionsImpl.prototype.findAllAssociatedCells=function(gridUnit,src){try{if(!gridUnit){return[];}var $M=microstrategy,cells=[],result=[],l=this.getCellLevel(src),isMetric=(gridUnit.subtype==$M.SUBOBJTYPE_METRIC),i;if(l==$M.GRIDCELLTYPE_UNIT_HEADER){l=$M.GRIDCELLTYPE_UNIT_VALUE;}else{if(l==$M.GRIDCELLTYPE_SUBTOTAL_HEADER){l=$M.GRIDCELLTYPE_SUBTOTAL_VALUE;}}cells=cells.concat(this.parentBone.findAllCells(gridUnit,l,true));if(isMetric){cells=cells.concat(this.parentBone.getCellsWithAttr($M.HTMLATTR_GRID_CELL_TYPE,$M.GRIDCELLTYPE_SUBTOTAL_VALUE));}for(i in cells){if(this.isAlignedHeader(cells[i],src)){result.push(cells[i]);}}return result;}catch(err){microstrategy.errors.log(err);return false;}};mstrGridSelectionsImpl.prototype.isAlignedHeader=function(cellSrc,headerSrc){var allow=false,span=[headerSrc.rowSpan,headerSrc.colSpan],idx=this.getCellIndexInTable(cellSrc).split(","),unitIdx=this.getCellIndexInTable(headerSrc).split(","),i;for(i=0;i<2;i++){allow=allow||((parseInt(unitIdx[i],10)<=parseInt(idx[i],10))&&((parseInt(unitIdx[i],10)+span[i])>parseInt(idx[i],10)));}return allow;};mstrGridSelectionsImpl.prototype.getHeaderSourceList=function(cellSrc){var $M=microstrategy,header=[],cellType=this.getCellLevel(cellSrc),unit=this.findTemplateUnitObj(cellSrc,cellType);if(unit){var isMetric=(unit.subtype==$M.SUBOBJTYPE_METRIC),prop=microstrategy.HTMLATTR_DSS_ID,value=unit.dssId;switch(cellType){case $M.GRIDCELLTYPE_SUBTOTAL_VALUE:header.push(this.parentBone.findAllCells(unit,$M.GRIDCELLTYPE_SUBTOTAL_HEADER,true)[0]);isMetric=true;prop=$M.HTMLATTR_SUBOBJTYPE;value="MV";case $M.GRIDCELLTYPE_UNIT_VALUE:case $M.GRIDCELLTYPE_METRIC_DATA:if(isMetric){var cells=this.parentBone.getCellsWithAttr(prop,value);i;for(i=0;i<cells.length;i++){if(this.isAlignedHeader(cellSrc,cells[i])){header.push(cells[i]);}}}else{header.push(this.findTemplateUnit(cellSrc,cellType));}break;default:header.push(cellSrc);}}return header;};mstrGridSelectionsImpl.prototype.copyToClipboard=function(ignoreSelections,ignoreHeaders){var data=[],items=this.clipboardUnits,j,i,headers,addCellToData=function(src,idx,data){var r,c,coords,text,img;coords=idx.split(",");r=coords[0];c=coords[1];data[r]=data[r]||[];text=(src.innerText||src.textContent||"").replace("\n","");if(!trimString(text)){img=src.getElementsByTagName("img");if(img&&img[0]){text=img[0].title;}}data[r][c]=text;};for(i in items){addCellToData(items[i],i,data);if(!ignoreHeaders){headers=this.getHeaderSourceList(items[i]);for(j=0;j<headers.length;j++){var h=headers[j];if(h){var hIdx=this.getCellIndexInTable(h);addCellToData(h,hIdx,data);items[hIdx]=h;}}}}var str="",v,cc=-1,empty=true,maxLength=-1;for(v in data){maxLength=Math.max(data[v].length,maxLength);}i=0;while(i<maxLength){for(v in data){if(data[v][i]!=undefined){i++;empty=false;break;}}if(empty){for(v in data){data[v]=data[v].slice(0,i).concat(data[v].slice(i+1));}maxLength--;}else{empty=true;}}for(v in data){if(data[v].length){str=str+data[v].join("\t")+"\n";}}var pn=document.getElementById("mstrWeb_content")||document.body,cb=document.getElementById("clipboardTextArea")||pn.appendChild(document.createElement("textarea"));if(cb){cb.setAttribute("id","clipboardTextArea");cb.value=str;var cbs=cb.style;cbs.left=document.documentElement.scrollLeft+"px";cbs.top=document.documentElement.scrollTop+"px";window.setTimeout(function(){cb.select();cb.focus();microstrategy.showWait(false);},50);var $this=this;cb.onkeyup=function clipboardTextAreaKeyup(e){e=e||window.event;switch(e.keyCode){case 65:if(e.ctrlKey){var gridBone=$this.parentBone;if(!(gridBone.delegateSelectAll&&gridBone.delegateSelectAll())){$this.handleSelectAll();}else{$this.clearClipboardItems();}}break;}return true;};}};mstrGridSelectionsImpl.prototype.clearClipboardItems=function(){if(!this.clipboardUnits){return ;}removeCssClass(this.parentBone.elem,["cbSel"]);delete this.clipboardUnits;var cb=document.getElementById("clipboardTextArea");if(cb){cb.value="";cb.blur();}};function mstrGridSelectionsImpl(){this.selectedUnits=new Array();this.hilitedItems=new Array();return this;}mstrUnitObjImpl.prototype=new Object();mstrUnitObjImpl.prototype.levels=null;mstrUnitObjImpl.prototype.gridTarget="";mstrUnitObjImpl.prototype.isMetric=false;mstrUnitObjImpl.prototype.levelObjs=null;mstrUnitObjImpl.prototype.removeLevel=function(level){try{for(var i in this.levels){if(this.levels[i]==level){delete this.levels[i];}}}catch(err){microstrategy.errors.log(err);}};mstrUnitObjImpl.prototype.hasLevel=function(level){try{for(var i in this.levels){if(this.levels[i]==level){return true;}}return false;}catch(err){microstrategy.errors.log(err);}};mstrUnitObjImpl.prototype.countLevel=function(){try{var count=0;for(var i in this.levels){if(this.levels[i]!=null&&this.levels[i].length>0){count++;}}return count;}catch(err){microstrategy.errors.log(err);}};mstrUnitObjImpl.prototype.resolveLevelsValue=function(){try{if(!this.levels||this.levels.length==0){return 0;}switch(this.levels.length){case 1:return this.levels[0];case 4:return 5;default:return -1;}}catch(err){microstrategy.errors.log(err);return 2;}};function mstrUnitObjImpl(selections){this.parentBone=selections;this.levels=new Array;this.levelObjs=new Array;this.isMetric=false;this.gridTarget="";return this;}mstrUnitLevelObjImpl.prototype=new Object();mstrUnitLevelObjImpl.prototype.selectedItems=null;mstrUnitLevelObjImpl.prototype.selectedItemsLength=0;mstrUnitLevelObjImpl.prototype.hilitedItems=null;mstrUnitLevelObjImpl.prototype.hilitedItemsLength=0;mstrUnitLevelObjImpl.prototype.addToSelectedItems=function(cellSrc){try{var index=this.gridSelections.getIndexFromCell(cellSrc);this.selectedItems[index]=cellSrc;this.selectedItemsLength++;}catch(err){microstrategy.errors.log(err);}};mstrUnitLevelObjImpl.prototype.removeSelectedItems=function(cellSrc){try{var index=this.gridSelections.getIndexFromCell(cellSrc);delete this.selectedItems[index];this.selectedItemsLength--;}catch(err){microstrategy.errors.log(err);}};mstrUnitLevelObjImpl.prototype.clearSelectedItems=function(){try{this.selectedItems=new Array;this.selectedItemsLength=0;}catch(err){microstrategy.errors.log(err);}};mstrUnitLevelObjImpl.prototype.addToHilitedItems=function(cellSrc){try{var index=this.gridSelections.getIndexFromCell(cellSrc);this.hilitedItems[index]=cellSrc;this.hilitedItemsLength++;var tables=this.gridSelections.parentBone.elem.getElementsByTagName("table");if(tables!=null&&tables.length&&tables.length>1){var cellIndex=cellSrc.cellIndex;var rowIndex=cellSrc.parentNode.rowIndex;for(i=0,len=tables.length;i<len;++i){var table=tables[i];if(table&&table.rows){if(rowIndex<table.rows.length){var row=table.rows[rowIndex];if(row&&row.cells&&(cellIndex<row.cells.length)){var cell=row.cells[cellIndex];if(cell){this.gridSelections.hiliteSelected(cell);}}}}}}else{this.gridSelections.hiliteSelected(cellSrc);}}catch(err){microstrategy.errors.log(err);}};mstrUnitLevelObjImpl.prototype.removeHilitedItems=function(cellSrc){try{var index=this.gridSelections.getIndexFromCell(cellSrc);delete this.hilitedItems[index];this.hilitedItemsLength--;this.gridSelections.removeHilites(cellSrc);}catch(err){microstrategy.errors.log(err);}};mstrUnitLevelObjImpl.prototype.clearHilitedItems=function(){try{var tables=this.gridSelections.parentBone.elem.getElementsByTagName("table"),len,t;if(tables!=null&&tables.length&&tables.length>1){for(t=0,len=tables.length;t<len;++t){var table=tables[t],ix,cellIndex,rowIndex,row,cell,i;if(table&&table.rows){for(i in this.hilitedItems){if(typeof i==="string"){ix=i.split(",");rowIndex=ix[0];if(rowIndex<table.rows.length){row=table.rows[rowIndex];cellIndex=ix[1];if(row&&row.cells&&(cellIndex<row.cells.length)){cell=row.cells[cellIndex];if(cell){this.gridSelections.removeHilites(cell);}}}}}}}}else{for(i in this.hilitedItems){this.gridSelections.removeHilites(this.hilitedItems[i]);}}this.hilitedItems=new Array;this.hilitedItemsLength=0;}catch(err){microstrategy.errors.log(err);}};mstrUnitLevelObjImpl.prototype.hasSelectedCell=function(cellSrc){try{var index=this.gridSelections.getIndexFromCell(cellSrc);return(typeof (this.selectedItems[index])!="undefined"&&this.selectedItems[index]!=null);}catch(err){microstrategy.errors.log(err);return false;}};mstrUnitLevelObjImpl.prototype.hasSelectedCells=function(){try{return(this.selectedItems&&this.selectedItemsLength>0);}catch(err){microstrategy.errors.log(err);return false;}};mstrUnitLevelObjImpl.prototype.hasHilitedCells=function(){try{return(this.hilitedItems&&this.hilitedItemsLength>0);}catch(err){microstrategy.errors.log(err);return false;}};mstrUnitLevelObjImpl.prototype.hasHilitedCell=function(cellSrc){try{var index=this.gridSelections.getIndexFromCell(cellSrc);return(typeof (this.hilitedItems[index])!="undefined"&&this.hilitedItems[index]!=null);}catch(err){microstrategy.errors.log(err);return false;}};function mstrUnitLevelObjImpl(unitObj){this.parentBone=unitObj;this.gridSelections=this.parentBone.parentBone;this.selectedItems=new Array;this.hilitedItems=new Array;return this;}