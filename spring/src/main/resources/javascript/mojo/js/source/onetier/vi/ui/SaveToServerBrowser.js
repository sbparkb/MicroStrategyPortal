(function(){mstrmojo.requiresCls("mstrmojo.onetier.vi.ui.VIProjectBrowser","mstrmojo.onetier.vi.ui.UploadResultEditor","mstrmojo.ui.editors.RenameEditor","mstrmojo.onetier.vi.acl.UserDataService","mstrmojo.onetier.vi.ui.FilteredLoginProjectBox");var getSaveAsCallBack=function(objInfo,cbAfterSave){var originalCallBack=mstrmojo.hash.clone(cbAfterSave),getACLUserDataService=function(){var r=mstrmojo.onetier.vi.acl.UserDataService;r.oneTierConnectivity=this.oneTierConnectivity;return mstrmojo.onetier.vi.acl.UserDataService;};cbAfterSave.success=function(res){if(res&&res.messageID){if(res.isConflict){var replaceFn=function(){this.saveCallback({messageID:res.messageID,resume:"true",sessionState:this.sessionState},getSaveAsCallBack.call(this,objInfo,originalCallBack));}.bind(this),saveAsFn=function(){var renameEditor=new mstrmojo.ui.editors.RenameEditor({renameText:res.n,title:mstrmojo.desc(13052,"Upload"),zIndex:1002,onRename:function(newName){if(mstrmojo.string.isEmpty(newName)){mstrmojo.alert("Please enter a valid name",null,null,1004);return false;}else{this.saveCallback({messageID:res.messageID,resume:"true",dashboardName:newName,sessionState:this.sessionState},getSaveAsCallBack.call(this,objInfo,originalCallBack));var conflictDialog=mstrmojo.all.ImportNameConflictDialog;if(conflictDialog){conflictDialog.destroy();}}}.bind(this)});renameEditor.open();return false;}.bind(this),closeFn=function(){originalCallBack.success();};mstrmojo.confirm(mstrmojo.desc(8134,"The Dashboard ## already exists. Do you want to replace the existing Dashboard?").replace("##",("<strong>"+res.n+"</strong>")),null,{id:"ImportNameConflictDialog",title:mstrmojo.desc(13052,"Upload"),allowHTML:true,buttons:[mstrmojo.Button.newWebButton(mstrmojo.desc(219,"Yes"),replaceFn,true),mstrmojo.Button.newWebButton(mstrmojo.desc(3167,"Save As"),saveAsFn,true),mstrmojo.Button.newWebButton(mstrmojo.desc(3416,"Cancel"),closeFn)],onPreClose:function(){closeFn();return true;}});}else{this.saveCallback({messageID:res.messageID,sessionState:this.sessionState},getSaveAsCallBack.call(this,objInfo,originalCallBack));}}else{originalCallBack.success();var me=this,objectId=res.did,objectType=55,openShareEditor=function(acls){var editorId="sharingEditor",sharingEditor=mstrmojo.all[editorId],buildHref=function(){var pi=me.loginToProjectBox.currentProject,conn=pi.webServer.connection,iServer=pi.iServer,server=iServer.name,project=encodeURI(pi.project.name),port=iServer.port;return[conn.conntp,"//",conn.wsn,conn.wsport?(":"+conn.wsport):"","/",conn.wspath,conn.wsfolderpath,"/",conn.wsservlet,"?evt=3140&src="+conn.wsservlet+".3140","&documentID="+res.did,"&server="+server,"&Project="+project,"&port="+port].join("");},oi={did:objectId,t:objectType,st:14081,n:res.n,acls:acls,acg:32};hasGuestMode=false;if(me.loginToProjectBox&&me.loginToProjectBox.loginBox){if((me.loginToProjectBox.loginBox.enabledAuthModes&mstrmojo.onetier.vi.ui.LoginBox.AUTH_MODES.authAnonymous.v)===mstrmojo.onetier.vi.ui.LoginBox.AUTH_MODES.authAnonymous.v){hasGuestMode=true;}}if(!sharingEditor){sharingEditor=mstrmojo.insert({scriptClass:"mstrmojo.SharingEditor",guestModeEnabled:hasGuestMode,mid:-1,id:editorId,oi:oi,href:buildHref(),isLinkDirty:undefined,viewMode:undefined,lastState:undefined,showLinkOnOpen:true,saveButtonText:mstrmojo.desc(118,"Save"),closeEditorAfterSave:false,oneTierConnectivity:{connectivityProxy:me.connectivityProxy,sessionState:me.sessionState,connectionId:me.connectionId},getACLUserDataService:getACLUserDataService});}else{sharingEditor.set("oi",oi);sharingEditor.href=buildHref();sharingEditor.set("guestModeEnabled",hasGuestMode);sharingEditor.mid=-1;sharingEditor.isLinkDirty=undefined;sharingEditor.viewMode=undefined;sharingEditor.lastState=undefined;sharingEditor.showLinkOnOpen=true;sharingEditor.oneTierConnectivity={connectivityProxy:me.connectivityProxy,sessionState:me.sessionState,connectionId:me.connectionId};sharingEditor.getACLUserDataService=getACLUserDataService;}sharingEditor.open();},shareDashboardFn=function(){me.connectivityProxy.getObjectInfo({objectIDs:objectId,objectTypes:objectType,includeACL:"true",sessionState:me.sessionState,connectionId:me.connectionId},{success:function(res){openShareEditor(res.objects[0].acls);},failure:function(res){mstrmojo.onetier.vi.prefs.handleErrorMessage(res);}});},uploadResultEditor=new mstrmojo.onetier.vi.ui.UploadResultEditor({folderName:(objInfo.folderName||"My Reports"),dashboardName:res.n,shareDashboardFn:shareDashboardFn,okFn:function(){this.close();}});uploadResultEditor.open();}}.bind(this);return cbAfterSave;};mstrmojo.onetier.vi.ui.SaveToServerBrowser=mstrmojo.declare(mstrmojo.onetier.vi.ui.VIProjectBrowser,null,{scriptClass:"mstrmojo.onetier.vi.ui.SaveToServerBrowser",title:mstrmojo.desc(13559,"Upload to Server"),cssClass:"mstrmojo-SaveAsEditor mstrmojo-ViProjectBrowser server saveTo",help:"pending.htm",getLoginProjectBoxClass:function(){return"mstrmojo.onetier.vi.ui.FilteredLoginProjectBox";},getValidatesConnectedServer:function(){return false;},init:function init(props){this._super(props);this.buttonBox.ok.set("enabled",false);this.contPanel.name.onvalueChange=function(){this.validate();}.bind(this);this.contPanel.name.set("value",this.docModel.n);var ob=this.ob;ob.extraDDItems=[{cssClass:"extra separator",n:""},{n:mstrmojo.desc(14078,"New Folder..."),cssClass:"extra",onmousedown:function(){var e=mstrmojo.findAncestor(this,"scriptClass","mstrmojo.onetier.vi.ui.SaveToServerBrowser");if(e){e.openPopup("newFolder",{zIndex:e.zIndex+10,navigateAfter:true,fId:e.ob.currentFolder.did,dp:e.ob.dataProvider,okFn:function(res,navigateAfter){e.ob.refreshContent();if(navigateAfter){e.ob.browseFolder(res.fid,e.newFolder);}}});}}}];},validate:function validate(){this.buttonBox.ok.set("enabled",!!this.contPanel.name.value);},saveCallback:function saveCallback(params,callback){var ed=this;ed.toggleNativeMenus(false);this.connectivityProxy.saveToServer(params,{success:function(res){ed.toggleNativeMenus(true);callback.success(res);},failure:function(res){ed.toggleNativeMenus(true);callback.failure(res);}});},afterLogin:function afterLogin(res){this._super(res);this.toggleFields("loading");this.initBrowser("ready");},saveAsCallback:function saveAs(params,cbAfterSave){var pms={sessionState:this.sessionState,dashboardName:params.name,dashboardDescription:params.description};if(params.folderId&&params.folderId!==-1){pms.folderId=params.folderId;}this.saveCallback(pms,getSaveAsCallBack.call(this,params,cbAfterSave));},saveAs:function saveAs(){this.toggleFields.call(this,"loading");if(this.saveAsCallback){this.saveAsCallback({sessionState:this.sessionState,folderId:this.selectedFolder?this.selectedFolder.did:-1,folderName:this.ob&&this.ob.currentFolder?this.ob.currentFolder.n:"",name:this.contPanel.name.value,description:this.contPanel.desc.value,connectionId:this.connectionId},{success:function(){this.cacheCurrentFolder();this.close();}.bind(this),failure:function(res){this.toggleFields.call(this,"browsing");this.onError(res);}.bind(this)});}else{this.onError("no save callback has been provided for VIProject Browser");}}});}());