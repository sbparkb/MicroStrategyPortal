(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.expr","mstrmojo._HasPopup","mstrmojo.Label","mstrmojo.HTMLButton","mstrmojo.ObjectBrowser","mstrmojo.DataGrid","mstrmojo.Editor","mstrmojo.ME._MetricEditorHelper","mstrmojo.ME.ObjectInputBox","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.ME.MetricDataService","mstrmojo.ME._HasLevel","mstrmojo.ME._HasSortBy","mstrmojo.ME.FunctionInfo");mstrmojo.requiresDescs(629,2148,3377,9582,12173,12179,12852);var _H=mstrmojo.hash,ARR=mstrmojo.array,E=mstrmojo.expr,MEH=mstrmojo.ME._MetricEditorHelper,MDS=mstrmojo.ME.MetricDataService,TP=mstrmojo.mstr.EnumDSSXMLObjectTypes,DYNAMIC_DIMTY=mstrmojo.ME.Enum.DYNAMIC_DIMTY,UI_OBJECT_TYPE=mstrmojo.ME.Enum.UI_OBJECT_TYPE;var ID,EDITOR;var _setDirty=function(w){if(w.onmetricModify){w.onmetricModify();}},updateScrollBars=function(){if(EDITOR.updateScrollbars){EDITOR.updateScrollbars();}};var _brackets=mstrmojo.ME.MetricToken.brackets,quotes=mstrmojo.ME.MetricToken.quotes,unquotes=mstrmojo.ME.MetricToken.unquotes;var skipFunction=function(){var functions2skip={"9C374236DD9F11D3B98100C04F2233EA":"Forecast","9C374233DD9F11D3B98100C04F2233EA":"Growth","9C374233DD9F11D3B98100C04F2233EA":"Trend","677E93B2786B11D4B82F00C04F356781":"Case",C41C34F0786B11D4B82F00C04F356781:"CaseV",B2C0FA4420C711D6AD1400C04F0423DE:"IF","8107C324DD9911D3B98100C04F2233EA":"Not"};return functions2skip.hasOwnProperty(this.fctOi.did);};var getNamePrefix=function(n){var str=n.split(",")[0],prefix=str.replace(/\d$/,""),startAt=str.replace(prefix,"");return{prefix:prefix,startAt:parseInt(startAt,10)};};var getParamInputWidget=function(d){var updateLabels=function(){if(d.isRepeated){var labelWidget=this.parent.dataGrid.ctxtBuilder.itemWidgets[this.parent.idx].labelWidget;if(labelWidget){labelWidget.set("count",this.getSelectedObjects().length);}}};var ots=EDITOR.getParamObjectTypes();var w={scriptClass:"mstrmojo.Table",cssClass:"funcParam",layout:[{cells:[{cssText:"width: 338px"},{}]}],children:[{scriptClass:"mstrmojo.ME.ObjectInputBox",alias:"paramInput",slot:"0,0",cssClass:"mstrmojo-ME-param",dtp:d.dtp,isDME:EDITOR.isDME,hideEditButton:function(d){return true;},hideDelButton:function(d){return this.isFull;},hidePulldownButton:function(){return this.parent.dataGrid.parent.tbBrowsable;},hideItemWidgetBrowseButton:function(){return !this.parent.dataGrid.parent.tbBrowsable;},browsableTypes:ots.concat([E.TP.FOLDER]).join(","),folderLinksContextId:17,emptyText:mstrmojo.desc(12179,"Search for #").replace("#",mstrmojo.desc(3377,"Object").toLowerCase()),getCandidatesThroughTaskCall:function getCandidatesThroughTaskCall(params,callbacks){params.objectType=ots.join(",");params.rootFolderType=39;params.blockCount=this.blockCount;mstrmojo.ME.MetricDataService.getMetricComponents(params,callbacks);},postCreate:function(refresh){var grid=this.parent.dataGrid,fw=grid&&grid.parent;this.noCache=fw.noCache;if(!this.noCache){this.candidates=fw.getCandidates(function(item){return mstrmojo.array.indexOf(ots,item.t)>-1;});var items=this.candidates.items||[];if(EDITOR.isDME){items=EDITOR.replaceAttributeWithForms(ARR.filter(items,function(item){return ARR.indexOf(ots,item.t)>-1&&item.st!==E.STP.NDE;}));}for(var i=0,cnt=(d.items||[]).length;i<cnt;i++){var oi=d.items[i];if(oi&&oi.t===mstrmojo.ME.Enum.UI_OBJECT_TYPE.Sub_Expression){items.push(oi);}}this.candidates.items=items;if(!refresh){grid.candidatesListener.push(this.id);}}if(!refresh){this.set("items",d.items);}},onitemchange:function(){_setDirty(this.parent.dataGrid.parent);},onadd:function onadd(){updateLabels.call(this);},onremove:function onremove(){updateLabels.call(this);},obCfg:{folderLinksContextId:17,browsableTypes:ots.concat([E.TP.FOLDER]).join(",")}}],getTokens:function(){var its=this.paramInput.getSelectedObjects(),it,len=its.length,i,tks=[],tk;if(len>0){for(i=0;i<len;i++){it=its[i];if(it.state===mstrmojo.Enum_OIB_States.VALID&&it.did){if(it.t===UI_OBJECT_TYPE.Sub_Expression){tks=tks.concat(it.tks);}else{tk={v:_brackets(it.n)};if(it.t===21){tk.oi=it.oi;tk.exv=it.fmdid||it.exv;tk.extp=8;tk.v=it.fnm?_brackets(it.oi.n)+"@"+_brackets(it.fnm):tk.v;}else{tk.oi=it;}tks.push(tk);}}else{tk={v:quotes(d.dtp,it.n)};tks.push(tk);}tks.push({v:mstrmojo.ME.MetricToken.argDelimiter,isDelimiter:true});}tks.pop();}return tks;}};var piw=w.children&&w.children[0];if(!d.isRepeated){piw.cssClass="mstrmojo-ME-ObjectInputBox-param singleObject noVerify";piw.maxObjectCount=1;}else{piw.cssClass="mstrmojo-ME-ObjectInputBox-param noVerify";}return w;};var _DTPBuilder=function(d){var editor=mstrmojo.all[ID];var w=null;if(d.isParam){w=editor.getParamWidget(d);}else{switch(d&&d.dtp){case 11:w={scriptClass:"mstrmojo.Pulldown",cssClass:"bool mstrmojo-ME-Pulldown",popupCssClass:"mstrmojo-ME-Pulldown-Popup",items:[{n:"False",did:"0"},{n:"True",did:"-1"}],popupToBody:true,itemIdField:"did",postCreate:function(props){var d=this.data;this.value=!!d.v?(d.v==="False"?0:-1):(d.dfv||0);},getTokens:function(){var d=this.data;if(this.value!==d.dfv){return[{v:d.n},{v:"=",isDelimiter:true},{v:this.value=="-1"?"True":"False"}];}return[];},onvalueChange:function(){_setDirty(this.parent.dataGrid.parent);}};break;case -2:w=editor.getBreakByWidget(d);break;case -1:w=editor.getSortByWidget(d);break;default:w=editor.getTextWidget(d);break;}}w.alias="inputWidget";return w;};var _PROPFunction=function(d,idx,dataGrid){var labelList={scriptClass:"mstrmojo.ui.List",alias:"labelWidget",cssClass:"mstrmojo-FunctionWidzard-labels",count:d.items&&d.items.length||0,buildItems:function(){var items=[],cnt=this.count,suffix=(d.isParam?"*":"")+":",np=d.np;if(np){for(var i=0;i<=cnt;i++){items.push({n:np.n+(np.startAt+i)+suffix,title:d.desc||""});}}else{items.push({n:(d.dn||d.n)+suffix,title:d.desc||""});}this.set("items",items);},postCreate:function(){this.buildItems();},oncountChange:function(){this.buildItems();}};return labelList;};var _getBreakByWidget=function(d){var editor=mstrmojo.all[ID];return{scriptClass:"mstrmojo.ME.ObjectInputBox",alias:"breakByInput",cssClass:"mstrmojo-ME-breakby",isDME:editor.isDME,dtp:d.dtp,emptyText:mstrmojo.desc(12179,"Search for #").replace("#",mstrmojo.desc(2148,"Attribute").toLowerCase()),folderLinksContextId:16,browsableTypes:[E.TP.FOLDER,E.TP.ATTR].join(","),getCandidatesThroughTaskCall:function getCandidatesThroughTaskCall(params,callbacks){params.rootFolderType=39;params.blockCount=params.blockCount||this.blockCount;mstrmojo.ME.MetricDataService.getAttributes(params,callbacks);},obCfg:{folderLinksContextId:16,browsableTypes:[E.TP.ATTR,E.TP.FOLDER].join(",")},postCreate:function(refresh){var grid=this.parent.dataGrid,fw=grid&&grid.parent;this.noCache=fw.noCache;if(!this.noCache){this.candidates=fw.getCandidates(function(item){return item.t===TP.Attribute||item.t===TP.Consolidation;});if(this.isDME){this.candidates.items=DYNAMIC_DIMTY.getItems("breakby").concat(this.candidates.items);}if(!refresh){grid.candidatesListener.push(this.id);}}if(!refresh){var itms=d.items||[],tks=editor.oi.tks,isNewDef=!tks.met||tks.items&&(tks.items.length===0);if(isNewDef&&this.isDME){itms.push(DYNAMIC_DIMTY.getAutomaticDimtyObject());}this.set("items",itms);}},onitemchange:function(){_setDirty(this.parent.dataGrid.parent);},onadd:function onadd(){updateScrollBars();},onremove:function onremove(){updateScrollBars();},hidePulldownButton:function(){return this.parent.dataGrid.parent.tbBrowsable;},hideItemWidgetBrowseButton:function(){return !this.parent.dataGrid.parent.tbBrowsable;},getTokens:function(){var its=this.getSelectedObjects(),len=its.length,i,tks=[];if(len>0){tks.push({v:"BreakBy"});tks.push({v:"=",isDelimiter:true});tks.push({v:"{",isDelimiter:true});for(i=0;i<len;i++){var it=its[i],tk;if(MEH.isDimty(it.n)){tk={v:it.n};}else{if(/^@/.test(it.did)){tk={v:it.did};}else{tk={v:_brackets(it.n),oi:it};}}tks.push(tk);if(i!==(len-1)){tks.push({v:",",isDelimiter:true});}}tks.push({v:"}",isDelimiter:true});}return tks;}};};var _findFunctionDef=function(allFuncsList,funcName){var len=allFuncsList.length,idx;for(idx=0;idx<len;idx++){var fidx=mstrmojo.array.find(allFuncsList[idx].fns,"n",funcName);if(fidx>-1){return _H.clone(allFuncsList[idx].fns[fidx]);}}return null;};var _assignFunctionParsValues=function(pars,parItems){var i,len=parItems.length,parCnt=pars&&pars.length;if(parCnt>0){for(i=0;i<parCnt-1;i++){pars[i].items=[parItems[i]];pars[i].dynamicVerify=true;}pars[parCnt-1].items=[];for(i=parCnt-1;i<len;i++){pars[parCnt-1].items.push(parItems[i]);pars[parCnt-1].dynamicVerify=true;}}return pars;};var _getBreakbySortby=function(i,tks,tp){var o={items:[]},endChar={301:"}",302:")"}[tp],tk=tks[++i];while(tk){if(tk.oi){if(tp==302){tk.oi.selFrm=tk.exv;tk.oi.asc=tk.asc;}o.items.push(tk.oi);}if((tk=tks[++i]).v===endChar){break;}}return o;};mstrmojo.ME.FunctionWizard=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.ME._MetricEditorHelper,mstrmojo.ME._HasLevel,mstrmojo.ME._HasSortBy],{scriptClass:"mstrmojo.ME.FunctionWizard",cssClass:"mstrmojo-Editor-me mstrmojo-FunctionWidzard",title:mstrmojo.desc(9582,"Function Editor: "),help:"Function_Arguments_dialog_box.htm",fctOi:null,fctArgs:null,fctArgsDataGridCssClass:"functionArgs",fctSyntax:"",fctDesc:"",hiddenPs:[],bindings:{candidates:"this.opener.candidates"},getParamObjectTypes:function getParamObjectTypes(){var ots=[E.TP.METRIC,E.TP.FACT];if(this.isAgg(this.fctOi)){ots.push(E.TP.ATTR);}return ots;},getCandidates:function getCandidates(f){var cs=this.candidates,its;if(cs){its=mstrmojo.array.filter(cs.items,f);return{items:its,isComplete:cs.isComplete};}return{};},_set_candidates:function(n,v){this.candidates=v;if(this.hasRendered&&this.visible){var grid=this.argsGrid,listeners=grid.candidatesListener,len=listeners.length,i;for(i=0;i<len;i++){if(mstrmojo.all[listeners[i]]){mstrmojo.all[listeners[i]].postCreate(true);}}}if(this._super){this._super(n,v);}return true;},postProcessParamsFromToken:function(res){if(this.refOi&&this.candidates){var refid=this.refOi.did;this.refOi=mstrmojo.array.filterOne(this.candidates.items,function(itm){return itm.did===refid;});}var ps=[],p,i,pars=res.pars,len=(pars&&pars.length)||0;for(i=0;i<len;i++){p=_H.copy(pars[i]);p.isParam=true;if(i===0&&this.refOi){p.items=[this.refOi];this.refOi=null;}ps.push(p);}if(res.rpc>0&&!skipFunction.call(this)){p.isRepeated=true;var NP=getNamePrefix(p.n);p.np={n:NP.prefix,startAt:NP.startAt||1};}return ps;},postProcessProsFromToken:function(res){var ps=[],i,len=(res.pros&&res.pros.length)||0,handleNonExposables=function(pro){if(ARR.indexOf(mstrmojo.ME.Enum.NonExposableParams,pro.n)>-1){pro.itemCss="hidden";}return pro;};for(i=0;i<len;i++){ps.push(handleNonExposables(_H.copy(res.pros[i])));}return ps;},buildSyntax:function(fct){var syntax=[],i,len;syntax.push(fct.n);syntax.push("(");len=(fct.pars&&fct.pars.length)||0;for(i=0;i<len;i++){syntax.push(fct.pars[i].n);if(i!==(len-1)){syntax.push(", ");}}syntax.push(")");return syntax;},onOpen:function(){ID=this.id;this._setupCandidatesCache();var args=this.getArgsFromTokens();var me=this,res=args||this.fctOi;var syntax=this.buildSyntax(res),ps=this.postProcessParamsFromToken(res);ps=ps.concat(this.postProcessProsFromToken(res));if(res.sqt===5){ps.push({n:"BreakBy",dn:mstrmojo.desc(12173,"Break By"),dtp:-2,desc:"Break By is a parameter representing the break by levels for this function.",items:res.bb&&res.bb.items});}if(res.ios){ps.push({n:"SortBy",dn:mstrmojo.desc(12852,"Sort By"),dtp:-1,desc:"Sort By is a parameter representing the sort by levels for this function.",items:res.sb&&res.sb.items});}ps=ps.concat(this.hiddenPs||[]);me.set("fctArgs",ps);me.set("fctSyntax",syntax.join(""));me.set("fctDesc",mstrmojo.ME.FunctionInfo.getDescAndExample(this.fctOi).desc+"  "+mstrmojo.ME.MetricDataService.getFunctionHelpTopic(res.h));me.set("title",this.insertMode?res.n:mstrmojo.desc(9582,"Function Editor: ")+" "+this.oi.n);me.set("fctName",res.n);this.raiseEvent({name:"fctDidChange",did:this.fctOi.did});this.set("isAggFunction",this.isAgg());this.set("ios",res.ios);if(this._super){this._super();}if(this.isAggFunction){var itws=this.argsGrid.ctxtBuilder.itemWidgets;if(itws&&itws.length>0){this.metricLCT.set("labelWidth",itws[0].labelWidget&&itws[0].labelWidget.domNode.clientWidth+"px");}}},getArgsFromTokens:function getArgsFromTokens(){if(!this.oi||this.oi.tks.items.length===0){return null;}var args={},tks=this.oi.tks.items,len=tks.length,pars=[],pros=[],proCnt=0,parItems=[],i;for(i=0;i<len;i++){var tk=tks[i],tp=tk.tp,sctt=tk.sctt;if(mstrmojo.ME.MetricToken.isDelimiter(tk.v)&&(tk.v!=="("&&tk.v!==")")||tk.v==="&gt;"||tk.v==="&lt;"){continue;}switch(sctt){case 65536:args.n=tk.oi?tk.oi.n:tk.v;var func=this.fctOi=_findFunctionDef(this.functions,args.n);pars=func.pars||[];pros=func.pros||[];args.rpc=func.rpc;args.sqt=func.sqt;args.ios=func.ios;break;case 196608:var expTkss=[],expTks=[],tLen,j,k;tk=tks[++i];while(tk&&(tk.sctt===196608||tk.sctt===196609)){if(tk.sctt===196608){expTks.push(tk);}else{expTkss.push(expTks);expTks=[];}tk=tks[++i];}expTkss.push(expTks);expTkss[expTkss.length-1].pop();for(k=0;k<expTkss.length;k++){expTks=expTkss[k];var argOI={n:""};tLen=expTks.length;if(tLen===1){tk=expTks[0];if(tk.extp){argOI={n:tk.v,did:tk.oi.did+"@"+tk.exv,exv:tk.exv,extp:tk.extp,oi:tk.oi,t:21,tk:tk};}else{var parIdx=Math.min(pars.length-1,parItems.length),unquoted=unquotes(tk,tk.v,pars[parIdx].dtp);argOI=tk.oi||{n:unquoted,v:unquoted};}}else{for(j=0;j<tLen;j++){argOI.n+=expTks[j].v;}argOI.v=argOI.n;argOI.did=argOI.n;argOI.t=UI_OBJECT_TYPE.Sub_Expression;argOI.tks=expTks;}parItems.push(argOI);}break;case 131072:if(tp==301){var bb={};tk=tks[++i];while(tk){if(tk.tp!=282){if(tk.oi){bb.items=bb.items||[];bb.items.push(tk.oi);}else{if(tk.tp===64){bb.items=bb.items||[];var dimtyCode=tk.v+tks[++i].v;tk=tks[i+1];if(tk.tp===43||tk.tp===45){dimtyCode+=tks[++i].v;dimtyCode+=tks[++i].v;}bb.items.push(DYNAMIC_DIMTY.getDimtyObject(dimtyCode,this.isDME));}}}if((tk=tks[++i])["v"]==="}"){break;}}args.bb=bb;}else{if(tp==302){args.sb={};}else{if(tp==259){mstrmojo.array.forEach(pros,function(pro){if(pro.n===tks[i].v){i=i+2;var _tk=tks[i],_tkv=[];do{_tkv.push(tks[i++].v);if(tks[i].sctt===131072&&tks[i].tp===62||tks[i].sctt===131073){break;}}while(true);_tkv=_tkv.join("");_tkv=unquotes(_tk,_tkv,pro.dtp);pro.v=_tkv;return false;}});}}}break;}}args.pars=_assignFunctionParsValues(pars,parItems);args.pros=pros;return args;},getTokens:function getTokens(){var rs=this.argsGrid.ctxtBuilder.itemWidgets,len=rs.length,i,w,props=[],params=[],tks=[],a,j,l,anyProp,oi=this.fctOi;for(i=0;i<len;i++){w=rs[i].inputWidget;if(w.data.isParam){params.push(w.getTokens());}else{props.push(w.getTokens());}}tks.push({v:oi.n,oi:oi});len=props.length;if(len>0){anyProp=false;tks.push({v:"<",isDelimiter:true});for(i=0;i<len;i++){a=props[i];l=a.length;if(l===0){continue;}anyProp=true;for(j=0;j<l;j++){tks.push(a[j]);}tks.push({v:",",isDelimiter:true});}tks.pop();if(anyProp){tks.push({v:">",isDelimiter:true});}}len=params.length;tks.push({v:"(",isDelimiter:true});anyProp=false;for(i=0;i<len;i++){a=params[i];l=a.length;if(l===0){continue;}anyProp=true;for(j=0;j<l;j++){tks.push(a[j]);}tks.push({v:mstrmojo.ME.MetricToken.argDelimiter,isDelimiter:true});}if(anyProp){tks.pop();}tks.push({v:")",isDelimiter:true});for(i=0,len=tks.length;i<len;i++){tks[i].isNew=true;}return tks;},getMetricDefAsTokens:function getMetricDefAsTokens(){var tks=this.getTokens();if(this.getLCTDefAsTokens){tks=tks.concat(this.getLCTDefAsTokens());}return tks;},handleValidation:function handleValidation(r){if(r&&!r.rjec){return ;}var isAmbiguity=r&&r.rjec==="-2147214846";if(isAmbiguity){var its=r.items,ei=mstrmojo.array.find(its,"sta",-1),ambiguousName=its[ei].v;mstrmojo.alert('More than one object with the name "#" found. Browse to select the object or retype to select it from the search autocomplete list.'.replace("#",ambiguousName));}else{mstrmojo.alert(r&&r.rjed);}},getPROPBuilder:function getPROPBuilder(){return _PROPFunction;},getDTPBuilder:function getDTPBuilder(){return _DTPBuilder;},getParamWidget:function getParamWidget(data){return getParamInputWidget(data);},getBreakByWidget:function getBreakByWidget(data){return _getBreakByWidget(data);},getSortByWidget:function getSortByWidget(data){return this._super();},getTextWidget:function getTextWidget(data){return{scriptClass:"mstrmojo.TextBox",cssClass:"mstrmojo-functionArgs-textInput",postCreate:function(props){var d=this.data;this.value=d.v||((d.dfv||d.dfv===0)?d.dfv:"");},getTokens:function(){var d=this.data;if(!mstrmojo.string.isEmpty(this.value)&&this.value!==d.dfv){return[{v:d.n},{v:"=",isDelimiter:true},{v:quotes(d.dtp,this.value)}];}return[];},onvalueChange:function(){_setDirty(this.parent.dataGrid.parent);}};},getDataGridRef:function getDataGridRef(){return{scriptClass:"mstrmojo.DataGrid",alias:"argsGrid",cssClass:this.fctArgsDataGridCssClass,makeObservable:true,banding:false,columns:[{headerText:"Property Name",dataWidgetBuilder:this.getPROPBuilder(),colCss:"name"},{headerText:"Property Type",dataWidgetBuilder:this.getDTPBuilder(),colCss:"dtp"}],postCreate:function(){this.candidatesListener=[];},bindings:{items:"this.parent.fctArgs"},onadd:function(){updateScrollBars();}};},init:function init(props){this.children=this.getChildren();this._super(props);ID=this.id;EDITOR=this;},isAgg:function isAgg(fctOi){return(fctOi||this.fctOi||{}).sqt===1;},getChildren:function getChildren(){return[mstrmojo.ME._MetricEditorHelper.formatAndOptionsBarRef,mstrmojo.ME._MetricEditorHelper.nameEditBoxRef,mstrmojo.ME._MetricEditorHelper.functionNameRef,this.getDataGridRef(),this.getLCTComponent(),{scriptClass:"mstrmojo.Label",slot:"buttonNode",cssClass:"mstrmojo-FE-functionSyntax",bindings:{visible:"this.parent.insertMode",text:function(){return this.parent.fctSyntax;}}},{scriptClass:"mstrmojo.Label",slot:"buttonNode",cssClass:"mstrmojo-FE-functionDesc",allowHTML:true,bindings:{visible:"this.parent.insertMode || this.parent.simplex",text:function(){return this.parent.fctDesc;}}},mstrmojo.ME._MetricEditorHelper.switchRef,mstrmojo.ME._MetricEditorHelper.buttonBarRef];}});}());