(function(){mstrmojo.requiresCls("mstrmojo.Table","mstrmojo.Label","mstrmojo.Box","mstrmojo.List","mstrmojo.ui.Pulldown","mstrmojo.array","mstrmojo.ui.CheckList");mstrmojo.requiresDescs(2057,7674,7675,7676,7677,7696,7697,9924,12375,12696,12919,12948,12973,13521,13522,13523,13524);var _C=mstrmojo.css,_A=mstrmojo.array;var _GEOROLE={NONE:0,CITY:1,STATE:2,COUNTRY:3,LOCATION:4,LATITUDE:5,LONGTITUDE:6,OTHER:7,ZIPCODE:8,COUNTY:9,AREACODE:10};var GEOROLE_COUNTRY_DID=268435456,GEOROLE_STATE_DID=536870912,GEOROLE_CITY_DID=1073741824;var DERIVED_ATTRIBUTE_STATE=268435456,DERIVED_ATTRIBUTE_CITY=805306368,DERIVED_ATTRIBUTE_COUNTRY=805306368,DERIVED_ATTRIBUTE_ZIPCODE=1879048192;var _data=[{n:mstrmojo.desc(2057,"None"),v:_GEOROLE.NONE,geo:true},{n:mstrmojo.desc(7674,"Country"),v:_GEOROLE.COUNTRY,geo:true},{n:mstrmojo.desc(7676,"State"),v:_GEOROLE.STATE,geo:true,items:[{n:mstrmojo.desc(7674,"Country"),did:GEOROLE_COUNTRY_DID}]},{n:mstrmojo.desc(12919,"County"),v:_GEOROLE.COUNTY,geo:true,items:[{n:mstrmojo.desc(7674,"Country"),did:GEOROLE_COUNTRY_DID},{n:mstrmojo.desc(7676,"State"),did:GEOROLE_STATE_DID}]},{n:mstrmojo.desc(7675,"City"),v:_GEOROLE.CITY,geo:true,items:[{n:mstrmojo.desc(7674,"Country"),did:GEOROLE_COUNTRY_DID},{n:mstrmojo.desc(7676,"State"),did:GEOROLE_STATE_DID}]},{n:mstrmojo.desc(7677,"Zip Code"),v:_GEOROLE.ZIPCODE,geo:true,items:[{n:mstrmojo.desc(7674,"Country"),did:GEOROLE_COUNTRY_DID},{n:mstrmojo.desc(7676,"State"),did:GEOROLE_STATE_DID},{n:mstrmojo.desc(7675,"City"),did:GEOROLE_CITY_DID}]},{n:mstrmojo.desc(7696,"Latitude"),v:_GEOROLE.LATITUDE,geo:true},{n:mstrmojo.desc(7697,"Longtitude"),v:_GEOROLE.LONGTITUDE,geo:true},{n:mstrmojo.desc(12948,"City, State"),v:_GEOROLE.LOCATION,geo:true},{n:mstrmojo.desc(12973,"Area Code"),v:_GEOROLE.AREACODE,geo:true},{n:mstrmojo.desc(13521,"Custom"),v:_GEOROLE.OTHER,geo:true}];var _data_number=[{n:mstrmojo.desc(2057,"None"),v:_GEOROLE.NONE,geo:true},{n:mstrmojo.desc(7677,"Zip Code"),v:_GEOROLE.ZIPCODE,geo:true,items:[{n:mstrmojo.desc(7674,"Country"),did:GEOROLE_COUNTRY_DID},{n:mstrmojo.desc(7676,"State"),did:GEOROLE_STATE_DID},{n:mstrmojo.desc(7675,"City"),did:GEOROLE_CITY_DID}]},{n:mstrmojo.desc(7696,"Latitude"),v:_GEOROLE.LATITUDE,geo:true},{n:mstrmojo.desc(7697,"Longtitude"),v:_GEOROLE.LONGTITUDE,geo:true},{n:mstrmojo.desc(12973,"Area Code"),v:_GEOROLE.AREACODE,geo:true}];mstrmojo.DI.DIGeoRole=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.DI.DIGeoRole",markupString:'<div id="{@id}"  class="{@cssClass}" style="top:{@top};left:{@left};"><div style="z-index:{@zIndex};{@cssText}" mstrAttach:mousedown,click><div class="mstrmojo-qb-mapping-title"></div><div class="mstrmojo-qb-mapping-georole"></div><div class="mstrmojo-di-mapping-driveAttribute"></div></div></div>',markupSlots:{contentNode:function(){return this.domNode.firstChild.childNodes[1];},formNode:function(){return this.domNode.firstChild.childNodes[0];},derivedAttributeNode:function(){return this.domNode.firstChild.childNodes[2];}},markupMethods:{onvisibleChange:function(){if(this.data.isSharedMultiForm){this.formNode.style.display="block";}else{this.formNode.style.display="none";}}},top:"0px",left:"0px",georole:0,shapeKeys:[],der:0,geoFormIndex:0,init:function init(props){this._super(props);this.raiseEvent({name:"shapeKeysChange"});this.raiseEvent({name:"dataChange"});this.multiFormList.attachEventListener("formChange",this.id,"updateGeoListSelection");this.geolist.attachEventListener("showDerivedAttribute",this.id,"showDerivedAttribute");},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.updateGeoListSelection();},onshapeKeysChange:function onshapeKeysChange(){var filterData=[];if(mstrApp.isCloud){_data.splice(-1);}var data=this.data;if(data.isSharedMultiForm){var index=this.multiFormList.selectedIndex||this.multiFormList.idx;var selectColumn=this.data.mergeSubColumns[index];var dataType=selectColumn.dtp;var pulldownList;if(dataType===2){pulldownList=_data_number;}else{if(dataType===1||dataType===8||dataType===9){pulldownList=[{n:mstrmojo.desc(2057,"None"),v:_GEOROLE.NONE,geo:true}];}else{pulldownList=_data;}}mstrmojo.array.forEach(pulldownList,function(item){if(item.n!=="Latitude"&&item.n!=="Longitude"){filterData.push(item);}});this.geolist.set("items",filterData);this.geolist.refresh();}else{if(data.dtp===2){this.geolist.set("items",_data_number);}else{this.geolist.set("items",_data);}}},ondataChange:function ondataChange(){var data=this.data;if(data.isSharedMultiForm){var subCols=data.mergeSubColumns;var options=[];var geoIndex=0,der;mstrmojo.array.forEach(subCols,function(subCol,i){options.push({n:subCol.fmn,v:i});if(subCol.georole&&subCol.georole!==0){geoIndex=i;}});this.multiFormList.set("items",options);this.geoFormIndex=geoIndex;der=subCols[this.geoFormIndex].der;this.multiFormList.set("selectedIndex",this.geoFormIndex);if(der){this.der=der;}}},updateGeoListSelection:function updateGeoListSelection(){var data=this.data,index;if(data.isSharedMultiForm){var idx=this.multiFormList.selectedIndex||0;data=this.data.mergeSubColumns[idx];}index=_A.find(this.geolist.items,"v",data.georole);this.geolist.set("selectedIndex",index);},_close:function(){var parent=this.parent;if(parent&&parent._cmSource){parent._cmSource.closeMenuTree();}},onOK:function(){var geo,derivedAttrFlag,data,index;if(this.data.isSharedMultiForm){index=this.multiFormList.selectedIndex;data=this.data.mergeSubColumns[index];}else{data=this.data;}var geolist=this.geolist;var selectedItem=geolist.items[geolist.selectedIndex];if(selectedItem.geo){geo=selectedItem.v;if(geo===undefined){geo=geolist.selected;}derivedAttrFlag={2:DERIVED_ATTRIBUTE_STATE,1:DERIVED_ATTRIBUTE_CITY,9:DERIVED_ATTRIBUTE_COUNTRY,8:DERIVED_ATTRIBUTE_ZIPCODE}[geo]||0;data.georole=geo;data.der=this.der=this.der&derivedAttrFlag;}else{data.georole=7;data.shapeKey=this.geolist.selectedItem.did;}if(this.data.isSharedMultiForm){index=this.multiFormList.selectedIndex;if(index!==this.geoFormIndex){var selectColumn=this.data.mergeSubColumns[index];var originalColumn=this.data.mergeSubColumns[this.geoFormIndex];if((selectColumn.georole!==_GEOROLE.LATITUDE)&&(selectColumn.georole!==_GEOROLE.LONGTITUDE)){var i,subColumns=this.data.mergeSubColumns;for(i=0;i<subColumns.length;i++){if(i===index){if(subColumns[i].fmn==="ID"){this.data.georole=subColumns[i].georole;}continue;}this.data.mergeSubColumns[i].georole=0;}}else{if((originalColumn.georole!==_GEOROLE.LONGTITUDE)&&(originalColumn.georole!==_GEOROLE.LATITUDE)){this.data.mergeSubColumns[originalColumn].georole=0;}}}}mstrApp.getRootController().setGeoRoles(this.data);this._close();},onCancel:function(){this._close();},showDerivedAttribute:function(evt){var data=this.data;if(data.isSharedMultiForm){var idx=this.multiFormList.selectedIndex;data=this.data.mergeSubColumns[idx];}var der=data.der;var items=evt.items;this.derivedAttrList.set("items",items);var idxs=[];if(der){_A.forEach(items,function(item,i){if(der&item.did){idxs.push(i);}});this.derivedAttrList.addSelect(idxs);}this.derivedAttributeNode.style.display="block";},children:[{scriptClass:"mstrmojo.Label",slot:"formNode",alias:"title",text:mstrmojo.desc(13522,"Select Attribute Form:")},{scriptClass:"mstrmojo.ui.Pulldown",slot:"formNode",alias:"multiFormList",idx:0,onitemSelected:function onitemSelected(){this.parent.raiseEvent({name:"shapeKeysChange"});this.raiseEvent({name:"formChange",idx:this.selectedIndex});}},{scriptClass:"mstrmojo.Label",slot:"contentNode",text:mstrmojo.desc(13523,"Select Geographic Type:")},{scriptClass:"mstrmojo.ui.Pulldown",slot:"contentNode",alias:"geolist",cssClass:"mstrmojo-qb-geolist",itemIdField:"did",cssClassItem:"",onitemSelected:function(){var selOption=this.items[this.selectedIndex];if(selOption.items){this.raiseEvent({name:"showDerivedAttribute",items:selOption.items});}else{this.parent.derivedAttributeNode.style.display="none";}},expandShapeKeyNode:function expandShapeKeyNode(){},itemMarkupFunction:function(item,index,widget){var content=[],parent=widget.parent,i,len,itemArr,action;if(item.items){itemArr=item.items;action="onclick=\"mstrmojo.dom.captureDomEvent('"+widget.id+"','click', self, event)\"";content.push('<div class="mstrmojo-qb-georole-attribute-box"><span>');content.push(mstrmojo.desc(9924,"Create attributes for:"));content.push("</span>");for(i=0,len=itemArr.length;i<len;i++){content.push('<div class="mstrmojo-qb-georole-attribute '+((parent.der&itemArr[i].did)?"selected":"")+'" did="'+itemArr[i].did+'"'+action+'><img class="mstrmojo-qb-georole-checkbox" src="../images/1ptrans.gif"><span style="padding-left:5px;">');content.push(itemArr[i].n);content.push("</span></div>");}content.push("</div>");}return'<div class="mstrmojo-qb-georole '+((item.did===_GEOROLE.OTHER)?"other":"")+(item.geo?"":"shapeKey ")+widget.cssClassItem+'" idx="'+index+'" did="'+item.did+'"><div class="mstrmojo-qb-georole-itemtext"><img class="mstrmojo-qb-georole-img" src="../images/1ptrans.gif"><span class="mstrmojo-qb-georole-text">'+item.n+'</span></div><div class="mstrmojo-qb-georole-itemcontent">'+content.join("")+"</div></div>";}},{scriptClass:"mstrmojo.Label",slot:"derivedAttributeNode",alias:"derivedAttrTitle",text:mstrmojo.desc(13524,"(Optional) Create Additional Attributes:")},{scriptClass:"mstrmojo.ui.CheckList",slot:"derivedAttributeNode",alias:"derivedAttrList",onchange:function(evt){var evtItem=evt.removed&&evt.removed.length>0?evt.removed:evt.added;var item=this.items[evtItem[0]];var derivedAttrFlag=item.did;var i,manipulateClassFunc,elements;elements=[];manipulateClassFunc=(this.parent.der&derivedAttrFlag)?_C.removeClass:_C.addClass;for(i=0;i<elements.length;i++){manipulateClassFunc(elements[i],"selected");}if(evt.added&&evt.added.length>0){this.parent.der=this.parent.der|derivedAttrFlag;}else{this.parent.der=this.parent.der^derivedAttrFlag;}}}]});}());