(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.hash","mstrmojo.onetier.vi.prefs.model.PreferencesServerDeltaUtils","mstrmojo.onetier.vi.prefs.model.PreferencesGeneralDeltaUtils","mstrmojo.onetier.vi.prefs.model.PreferencesNetworkDeltaUtils");var $HASH=mstrmojo.hash;var TP_JSP="j2ee",TP_ASP="asp";var PREFERENCES_GROUP_GENERAL="general",PREFERENCES_GROUP_NETWORK="network",PREFERENCES_GROUP_SERVER="server";function generateRandomID(){function rand4(num){return Math.floor((1+Math.random()+(num||0))*65536).toString(16).substring(1);}return rand4()+"-"+rand4()+"-"+rand4()+"-"+rand4(mstrmojo.now());}function raisePreferencesEditedEvent(){if(Object.keys(this.delta).length>0||this.deletedConnections.length>0){this.raiseEvent({name:"preferencesEdited"});}}mstrmojo.onetier.vi.prefs.model.PreferencesModel=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.onetier.vi.prefs.model.PreferencesModel",data:undefined,delta:undefined,connectivityProxy:undefined,init:function init(props){this._super(props);this.delta={};var deltaUtils=this.deltaUtils={};deltaUtils[PREFERENCES_GROUP_GENERAL]=new mstrmojo.onetier.vi.prefs.model.PreferencesGeneralDeltaUtils();deltaUtils[PREFERENCES_GROUP_NETWORK]=new mstrmojo.onetier.vi.prefs.model.PreferencesNetworkDeltaUtils();deltaUtils[PREFERENCES_GROUP_SERVER]=new mstrmojo.onetier.vi.prefs.model.PreferencesServerDeltaUtils();this.addDisposable(Object.keys(deltaUtils).map(function(key){return deltaUtils[key];}));},savePreferences:function savePreferences(onlyServerChanges){if(onlyServerChanges===true){var delta=$HASH.copy(this.delta);this.delta={server:delta.server};}this.connectivityProxy.savePreferences(this.delta);var deletedConnections=this.deletedConnections;if(deletedConnections){this.connectivityProxy.deleteServerConnections(deletedConnections);}},getPreferences:function getPreferences(type){var data=this.data,delta=this.delta;return((data&&data[type])||(delta&&delta[type])||this.deltaUtils[type].getNewDeltaObject()[type]);},addPreferenceToDelta:function addPreferenceToDelta(type,value){var delta=this.delta;if(!delta[type]){$HASH.copy((this.deltaUtils[type]).getNewDeltaObject(),delta);}if(value!==undefined){($HASH.copy(value,delta[type]));}raisePreferencesEditedEvent.call(this);},checkForDesktopUpdates:function checkForUpdates(){this.connectivityProxy.checkForDesktopUpdates();},showProxyEditor:function showProxyEditor(){this.connectivityProxy.showProxyEditor();},getServerConnections:function getServerConnections(){var result=[],data=this.data,delta=this.delta,deletedConnections=this.deletedConnections||[],fnRemoveDeletedConnections=function(connObj){return deletedConnections.indexOf(connObj.id)===-1;};if(data&&data.server){result=data.server.conn.filter(fnRemoveDeletedConnections);}if(delta&&delta.server){result=result.concat((delta.server.conn||[]).filter(fnRemoveDeletedConnections));}return result;},testServerConnection:function testServerConnection(url,fnTestSuccessful){var fnShowNotificationEditor=function(){return mstrmojo.notify(mstrmojo.desc(13689,"Testing Connection"),null,{buttonText:mstrmojo.desc(221,"Cancel"),forceClose:true});},notificationEditor=fnShowNotificationEditor();var serverConnectionCB={success:function success(res){notificationEditor.close();notificationEditor.destroy();this.connectivityProxy.httpStatusCodeHandler(res.code,fnTestSuccessful,{authenticateCredentials:function authenticateCredentials(userName,password){notificationEditor=fnShowNotificationEditor();this.connectivityProxy.testServerConnection({url:url,userName:userName,password:password},serverConnectionCB);}.bind(this)});}.bind(this)};this.connectivityProxy.testServerConnection({url:url},serverConnectionCB);},addServerConnectionDelta:function addServerConnectionDelta(connectionInfo){this.addPreferenceToDelta(PREFERENCES_GROUP_SERVER);var serverDelta=this.delta.server,serverConnections=serverDelta.conn;connectionInfo.id=connectionInfo.id||generateRandomID();serverConnections.push(connectionInfo);return connectionInfo;},editServerConnection:function editServerConnection(connectionInfo){var delta=this.delta;if(delta.server){var serverConnections=delta.server.conn,connectionDeltaIndex=serverConnections.map(function(connectionData){return connectionData.id;}).indexOf(connectionInfo.id);if(connectionDeltaIndex>-1){serverConnections[connectionDeltaIndex]=connectionInfo;return ;}}this.addServerConnectionDelta(connectionInfo);},deleteServerConnection:function deleteServerConnection(connectionId){(this.deletedConnections=this.deletedConnections||[]).push(connectionId);raisePreferencesEditedEvent.call(this);},serverConnectionNameEdited:function serverConnectionNameEdited(connectionInfo){this.editServerConnection(connectionInfo);raisePreferencesEditedEvent.call(this);},parseServerURL:function parseServerURL(url){return this.connectivityProxy.parseServerURL(url);},buildServerURLFromInfo:function buildServerURLFromInfo(connectionObj){var isJSP=connectionObj.wstp===TP_JSP,defaultFolderPath=isJSP?"/servlet":"/asp",defaultServlet=isJSP?"mstrWeb":"Main.aspx",webServerPort=connectionObj.wsport;if(!(connectionObj.wsn&&connectionObj.wspath)){return"";}connectionObj.wsport=(webServerPort===undefined||webServerPort==="")?80:webServerPort;return connectionObj.conntp+"//"+connectionObj.wsn+":"+(webServerPort||this.getDefaultPort(connectionObj.conntp))+"/"+connectionObj.wspath+(connectionObj.wsfolderpath||defaultFolderPath)+"/"+(connectionObj.wsservlet||defaultServlet);},getDefaultPort:function getDefaultPort(connectionType){return connectionType==="https:"?443:80;}});mstrmojo.onetier.vi.prefs.model.PreferencesModel.PREFERENCES_GROUP={GENERAL:PREFERENCES_GROUP_GENERAL,NETWORK:PREFERENCES_GROUP_NETWORK,SERVER:PREFERENCES_GROUP_SERVER};mstrmojo.onetier.vi.prefs.model.PreferencesModel.PreferenceDataType=null;mstrmojo.onetier.vi.prefs.model.PreferencesModel.ConnectionDataType=null;}());