(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.VisEnum","mstrmojo.VisUtility");var $MOJO=mstrmojo,$ARR=$MOJO.array,$VIS_ENUM=$MOJO.VisEnum,$U=$MOJO.VisUtility,LAYOUT_NAME=$VIS_ENUM.NETWORK_LAYOUT.FORCE_DIRECTED,FORCE_DIRECTED_LAYOUT_EDGE_CURVATURE=$VIS_ENUM.NETWORK_FORCE_DIRECTED_LAYOUT_EDGE_CURVATURE,ceil=Math.ceil,sqrt=Math.sqrt,abs=Math.abs,MIN_SQUARED_DISTANCE=0.1,MIN_MARGINAL_DISTANCE=sqrt(MIN_SQUARED_DISTANCE/2),isNearZero=$U.isNearZero,isDebugging=(window.env||{}).isDebugging;function log(msg){if(isDebugging){$U.visPrint(msg);}}mstrmojo.netviz._ForceDirectedLayout=mstrmojo.provide("mstrmojo.netviz._ForceDirectedLayout",{_mixinName:"mstrmojo.netviz._ForceDirectedLayout",init:function(e){if(this._super){this._super(e);}if(this.layouts===undefined){this.layouts={};}this.layouts[LAYOUT_NAME]=layout;}});function layout(abstractedModel,stage){function debugLayout(){var iteratingIndex=0,timer;applyPosition(circles);tensesEdges(abstractedModel.edges);stage.setScene();stage.draw();timer=setInterval(function(){if(t>0){tick(circles,edges,t,k,kk);t-=dt;applyPosition(circles);tensesEdges(abstractedModel.edges);stage.setScene();stage.draw(false,true);log("iteration: "+iteratingIndex++);}else{clearInterval(timer);}},17);}var circles=[],edges=[],w=100,h=100;stage.currentLayout=LAYOUT_NAME;initialize(abstractedModel,circles,edges,w,h);var n=200,nc=circles.length,k=sqrt(w*h/nc),kk=k*k,t=w/(2*sqrt(nc)),dt=t/n,i;if(isDebugging){debugLayout();}else{for(i=0;i<n;i++){tick(circles,edges,t,k,kk);t-=dt;}applyPosition(circles,abstractedModel.nodesIdHash);tensesEdges(abstractedModel.edges);}}function initialize(abstractedModel,circles,edges,w,h){function putInSquare(circles){var len=circles.length,n=ceil(sqrt(len)),dw=w/n,dh=h/n,i,j;for(i=0;i<n;i++){for(j=0;j<n;j++){var index=i*n+j;if(index<len){var c=circles[index];c.px=i*dw-w/2;c.py=j*dh-h/2;}}}}$ARR.forEach(abstractedModel.nodes,function(node){if(!node.isExcluded){var m=node.getSize();var circle={m:m*m,px:0,py:0,ax:0,ay:0,nodeId:node.id};node._shadowSprite=circle;circles.push(circle);}});$ARR.forEach(abstractedModel.edges,function(edge){if(!edge.isExcluded){edges.push({from:edge.from._shadowSprite,to:edge.to._shadowSprite});}});putInSquare(circles);}function attract(from,to,k){var x=to.px-from.px,y=to.py-from.py,d,aft,aftx,afty;if(!isNearZero(x)&&!isNearZero(y)){d=sqrt(x*x+y*y);aft=d*d/k;aftx=x/d*aft;afty=y/d*aft;from.ax+=aftx;from.ay+=afty;to.ax-=aftx;to.ay-=afty;}}function repulse(from,to,kk){var ftx=to.px-from.px,fty=to.py-from.py,sqd=ftx*ftx+fty*fty,aft,aftx,afty;if(sqd<MIN_SQUARED_DISTANCE){sqd=MIN_SQUARED_DISTANCE;ftx=(ftx>=0?1:-1)*MIN_MARGINAL_DISTANCE;fty=(fty>=0?1:-1)*MIN_MARGINAL_DISTANCE;}aft=kk/sqd;aftx=-ftx*aft;afty=-fty*aft;from.ax+=aftx;from.ay+=afty;to.ax-=aftx;to.ay-=afty;}function tick(circles,edges,t,k,kk){$ARR.forEach(circles,function(c){c.ax=0;c.ay=0;});var i,len=circles.length,j,ci;for(i=0;i<len;i++){ci=circles[i];for(j=i+1;j<len;j++){repulse(ci,circles[j],kk);}}$ARR.forEach(edges,function(e){attract(e.from,e.to,k);});for(i=0;i<len;i++){var c=circles[i];c.ax+=-c.px;c.ay+=-c.py;}$ARR.forEach(circles,function(c){if(abs(c.ax)>t){c.ax=(c.ax>=0?1:-1)*t;}if(abs(c.ay)>t){c.ay=(c.ay>=0?1:-1)*t;}c.px=c.px+c.ax;c.py=c.py+c.ay;});}function applyPosition(shadowCircles,allNodes){var node;$ARR.forEach(shadowCircles,function(circle){node=allNodes[circle.nodeId];node.sprite.setGeometry({x:circle.px,y:circle.py});delete node._shadowSprite;});}function tensesEdges(edges){$ARR.forEach(edges,function(e){e=e.sprite;var from=e.from,to=e.to,gf=from.getGeometry(),gt=to.getGeometry(),curvature=FORCE_DIRECTED_LAYOUT_EDGE_CURVATURE[(e.unit.reversedEdge?1:0)];e.setGeometry({x:(gf.x+gt.x)/2+(gf.y-gt.y)*curvature,y:(gf.y+gt.y)/2+(gt.x-gf.x)*curvature,type:"bezier"});});}}());