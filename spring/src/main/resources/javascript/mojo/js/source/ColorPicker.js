(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.List","mstrmojo.Button","mstrmojo.color","mstrmojo.Model","mstrmojo.Table","mstrmojo._CanValidate","mstrmojo.ValidationTextBox");var $COLOR=mstrmojo.color,$HASH=mstrmojo.hash;function slideProp(show,target,prop,start,stop,onEnd,ease,extraProps){var props={target:target,onEnd:function(){if(onEnd){onEnd();}},props:{}};props.props[prop]={ease:ease,start:parseInt(start,10),stop:parseInt(stop,10),suffix:"px"};props=$HASH.copy(extraProps,props);var fx=new mstrmojo.fx.AnimateProp(props);fx.play();}var updateUserPalette=function(newcolor){if(newcolor===null){return ;}var userPalette=mstrmojo.locales.color.userPalette,len=userPalette.length;if(len===8){userPalette.remove(len-1,1);}userPalette.add([{n:newcolor,v:newcolor}],0);var colors="",i;for(i=0;i<8;i++){if(userPalette[i]&&userPalette[i].v){colors+=userPalette[i].v+",";}}colors=colors.replace(/,$/,"");mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(res){},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{taskId:"setPreference",prefs:"userPalette\u001E"+colors});};var createLabel=function(label,css,slot){return{scriptClass:"mstrmojo.Label",text:label+":",cssClass:css,slot:slot};};var createInputBoxWithLabel=function(label,slot,n,props){return $HASH.copy(props||{},{scriptClass:"mstrmojo.ValidationTextBox",cssDisplay:"block",cssText:"padding: "+(mstrmojo.dom.isIE7?"0":"1px"),bindings:{value:function(){return this.parent.parent.colorModel[n]||"0";}},onValid:function(){this.parent.parent.colorModel.set(n,this.value);},min:0,max:255,constraints:{trigger:mstrmojo.validation.TRIGGER.ONKEYUP,validator:function(v){var min=this.min,max=this.max;v=parseInt(v,10);if(v>=min&&v<=max){return{code:mstrmojo.validation.STATUSCODE.VALID};}return{code:mstrmojo.validation.STATUSCODE.INVALID,msg:mstrmojo.desc(7883,"Please enter an integer between ## and ###").replace("##",min).replace("###",max)};}},slot:slot});};var createSlider=function(n){return $HASH.copy({scriptClass:"mstrmojo.Slider",alias:n+"Slider",cssClass:"sc "+n,isHoriz:true,width:130,cssBkBW:0,items:[],getItemTooltip:function(){return this.items[this.min].n;},postCreate:function(){var i;for(i=0;i<{r:256,g:256,b:256,s:101,v:101,h:360}[n];i++){this.items.push({n:i,v:i});}},bindings:{selectedIndex:function(){return this.parent.parent.colorModel[n]||"0";}},onselectedIndexChange:function(){this.parent.parent.colorModel.set(n,this.selectedIndex);if(this.domNode){this.min=this.max=this.selectedIndex;this.typeHelper.updateThumb();}},select:function(sel){this.set("selectedIndex",sel);},slot:"1,3"});};var colorItemRender=function(item,idx,widget){return'<div mstridx="'+idx+'" class="mstrmojo-ColorPicker-item '+widget.itemCssClas+'" style="background-color:'+item.v+';" type="button" title="'+item.n+'"></div>';};var listMapper=$HASH.copy({findIndex:function(w,p,node){return node.getAttribute("mstridx")||-1;}},$HASH.copy(mstrmojo.ListMapper));var createColorList=function(editor,ps){return $HASH.copy(ps,{scriptClass:"mstrmojo.List",cssClass:"mstrmojo-ColorPicker-list",itemMarkupFunction:colorItemRender,listMapper:listMapper,onchange:null,_onchange:function(){this.set("selectedColor",this.selectedItem.v);editor.set("selectedColor",this.selectedItem.v);if((editor.isSimple||!editor.expanded)&&editor.onChange){editor.onChange();}},onselectedColorChange:function(){editor.colorModel.set("hex",this.selectedColor);}});};mstrmojo.ColorPicker=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.ColorPicker",markupString:'<div id={@id} class="mstrmojo-ColorPicker {@cssClass} {@shadowCssClass}" style="height:{@height}; width:{@width};{@cssText}"><div class="mstrmojo-ColorPicker-box"></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";},onexpandedChange:function(){this.domNode.className=this.domNode.className.replace(/ expanded/,"")+(this.expanded?" expanded":"");}},useAnimate:true,useShadow:true,isSimple:false,showNoColor:true,showMoreColors:true,showGradients:true,showUserPalette:true,height:"168px",fullHeight:"326px",width:"158px",fullWidth:"366x",expanded:false,onexpandedChange:function(evt){var domNode=this.domNode,height=parseInt(this.height,10),width=parseInt(this.width,10),fullHeight=parseInt(this.fullHeight,10),fullWidth=Math.max(parseInt(this.fullWidth,10),domNode.scrollWidth);if(this.useAnimate!==false){if(evt.value){slideProp(true,domNode,"width",width,fullWidth);slideProp(true,domNode,"height",height,fullHeight);}else{slideProp(true,domNode,"width",fullWidth,width);slideProp(true,domNode,"height",fullHeight,height);}}else{if(evt.value){domNode.style.width=fullWidth+"px";domNode.style.height=fullHeight+"px";}else{domNode.style.width=width+"px";domNode.style.height=height+"px";}}},selectedColor:null,onChange:null,_updateSelection:function(color){var cp=(this.isSimple)?this:this.layout.cp;if(color){var idx=mstrmojo.array.find(cp.basicColors.items,"v",color);if(idx>-1){cp.basicColors.set("selectedIndex",idx);}else{idx=mstrmojo.array.find(cp.userPalette.items,"v",color);if(idx>-1){cp.userPalette.set("selectedIndex",idx);}}}},visible:false,onvisibleChange:function(){if(this.visible){this.selectedColor=(this.selectedColor&&this.selectedColor.replace(/transparent/,"#FFFFFF"))||"#FFFFFF";this.colorModel.set("hex",this.selectedColor);this._updateSelection(this.selectedColor);}},onselectedColorChange:function(){this._updateSelection(this.selectedColor);},init:function(props){var me=this;this.colorModel=new mstrmojo.Model({h:0,s:0,v:100,_hsvChange:function(){this.hex="#"+$COLOR.hsv2hex(this.h,this.s,this.v);var rgb=$COLOR.hsv2rgb(this.h,this.s,this.v);this.r=rgb[0];this.g=rgb[1];this.b=rgb[2];me.set("colorModel",$HASH.copy(this,{}));},_rgbChange:function(){this.hex="#"+$COLOR.rgb2hex(this.r,this.g,this.b);var hsv=$COLOR.rgb2hsv(this.r,this.g,this.b);this.h=hsv[0];this.s=hsv[1];this.v=hsv[2];me.set("colorModel",$HASH.copy(this,{}));},onhChange:function(){this._hsvChange();},onsChange:function(){this._hsvChange();},onvChange:function(){this._hsvChange();},onrChange:function(){this._rgbChange();},ongChange:function(){this._rgbChange();},onbChange:function(){this._rgbChange();},onhexChange:function(){var rgb=$COLOR.hex2rgb(this.hex);this.r=rgb[0];this.g=rgb[1];this.b=rgb[2];var hsv=$COLOR.hex2hsv(this.hex);this.h=hsv[0];this.s=hsv[1];this.v=hsv[2];me.set("colorModel",$HASH.copy(this,{}));}});this._super(props);},postBuildRendering:function(){if(this._super){this._super();}this.colorModel.set("hex",this.selectedColor||"#FFFFFF");this.colorModel.set("s",50);},preBuildRendering:function(){if(this._super){this._super();}var h=this.isSimple?100:124;if(this.showNoColor){h+=20;}if(this.showUserPalette){h+=25;}this.height=h+"px";if(this.isSimple){this.width="155px";}this.shadowCssClass=this.useShadow?"shadow":"";var me=this,noColor={scriptClass:"mstrmojo.Button",cssClass:"nocolor",text:mstrmojo.desc(959,"Default"),visible:this.showNoColor,onclick:function(){me.set("selectedColor","transparent");if(me.onChange){me.onChange();}}},basicColors=createColorList(this,{alias:"basicColors",items:mstrmojo.locales.color.colors,onchange:function(){if(this.selectedIndex>-1){this.parent.userPalette.set("selectedIndex",-1);this._onchange();}}}),userPalette=createColorList(this,{alias:"userPalette",cssClass:"mstrmojo-ColorPicker-list userPalette",makeObservable:true,visible:this.showUserPalette,bindings:{items:function(){return me.showUserPalette!==false?mstrmojo.locales.color.userPalette:[];}},onchange:function(){if(me.visible){if(this.selectedIndex>-1){this.parent.basicColors.set("selectedIndex",-1);this._onchange();}}},onadd:function(){this.refresh();if(me.visible){this.parent.basicColors.set("selectedIndex",-1);this.set("selectedIndex",0);}}});if(this.isSimple){if(this.showNoColor){this.addChildren(noColor,0);}this.addChildren(basicColors);this.addChildren(userPalette);return ;}var advancedColorPickerLayout={scriptClass:"mstrmojo.Table",alias:"layout",rows:2,cols:5,layout:[{cells:[{colSpan:2},{colSpan:2},{}]},{cells:[{},{},{},{},{}]}],children:[{scriptClass:"mstrmojo.VBox",cssClass:"mstrmojo-ColorPicker-palette shadow",alias:"cp",children:[noColor,basicColors,userPalette],slot:"0,0"},{scriptClass:"mstrmojo.Container",cssClass:"sbSlider",markupString:'<div class="{@cssClass}" style="position:relative; {@cssText}" mstrAttach:click,mouseover,mousemove,mousedown,mouseup,mouseout><div class="sbThumb"></div></div>',markupSlots:{containerNode:function(){return this.domNode;},thumbNode:function(){return this.domNode.firstChild;}},markupMethods:{onbgColorChange:function(){this.domNode.style.backgroundColor=this.bgColor;}},hex:null,bindings:{hex:"this.parent.parent.colorModel.hex",bgColor:function(){return"#"+$COLOR.hsv2hex(this.parent.parent.colorModel.h,100,100);}},onhexChange:function(){if(this.domNode){this.thumbNode.style.left=this.parent.parent.colorModel.s/100*160-3+"px";this.thumbNode.style.top=(1-this.parent.parent.colorModel.v/100)*160-3+"px";}},onmousedown:function(){var rect=this.domNode.getBoundingClientRect();this.mouseX0=rect.left;this.mouseY0=rect.top;this.onmousemove=this._update;var me=this;this.onmouseup=function(){me.onmousemove=null;mstrmojo.dom.detachEvent(document.body,"mouseup",me.onmouseup);};mstrmojo.dom.attachEvent(document.body,"mouseup",this.onmouseup);},onclick:function(evt){this._update(evt);},_update:function(evt){var mp={x:evt.e.clientX,y:evt.e.clientY},thumbX=Math.min(Math.max(0,mp.x-this.mouseX0),160),thumbY=Math.min(Math.max(0,mp.y-this.mouseY0),160);this.thumbNode.style.left=(thumbX-3)+"px";this.thumbNode.style.top=(thumbY-3)+"px";this.parent.parent.colorModel.s=Math.floor(100*thumbX/160);this.parent.parent.colorModel.set("v",Math.floor(100*(1-thumbY/160)));},slot:"0,1"},{scriptClass:"mstrmojo.Container",cssClass:"hueSlider",markupString:'<div class="{@cssClass}" style="position:relative; {@cssText}" mstrAttach:click,mouseover,mousedown,mouseup,mousemove,mouseout><div class="hThumb"></div></div>',markupSlots:{containerNode:function(){return this.domNode;},thumbNode:function(){return this.domNode.firstChild;}},bindings:{hex:"this.parent.parent.colorModel.hex",h:"this.parent.parent.colorModel.h"},onhexChange:function(){this._moveThumb();},onhChange:function(){this._moveThumb();},_moveThumb:function(){if(this.thumbNode){this.thumbNode.style.top=(1-this.parent.parent.colorModel.h/360)*160-1+"px";}},onmousedown:function(){this.mouseY0=this.domNode.getBoundingClientRect().top;this.onmousemove=this._update;var me=this;this.onmouseup=function(){me.onmousemove=null;mstrmojo.dom.detachEvent(document.body,"mouseup",me.onmouseup);};mstrmojo.dom.attachEvent(document.body,"mouseup",me.onmouseup);},onclick:function(evt){this._update(evt);},_update:function(evt){var mp={x:evt.e.clientX,y:evt.e.clientY},thumbY=Math.min(Math.max(0,mp.y-this.mouseY0),160);this.thumbNode.style.top=(thumbY-1)+"px";this.parent.parent.colorModel.set("h",Math.max(0,Math.floor(360*(1-thumbY/160))));},slot:"0,2"},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-ColorPicker-preview",markupMethods:{onbgColorChange:function(){this.domNode.style.backgroundColor=this.bgColor;}},bindings:{bgColor:"this.parent.parent.colorModel.hex"},onclick:function(){if(me.showUserPalette){updateUserPalette(this.bgColor);}},slot:"1,0"},createLabel(mstrmojo.desc(7848,"Hex"),"Hex","1,0"),createInputBoxWithLabel(mstrmojo.desc(7848,"Hex"),"1,0","hex",{cssClass:"hex",cssDisplay:"block",inputNodeCssClass:"hex",dtp:25,constraints:{trigger:mstrmojo.validation.TRIGGER.ONKEYUP,validator:function(v){if(/^#[0-9a-fA-F]{6}$/.test(v)){return{code:mstrmojo.validation.STATUSCODE.VALID};}return{code:mstrmojo.validation.STATUSCODE.INVALID,msg:mstrmojo.desc(7882,"Please enter a 6-digit HEX color value in format: #xxxxxx")};}}}),createLabel(mstrmojo.desc(3604,"Red"),"Red","1,1"),createLabel(mstrmojo.desc(3606,"Green"),"Green","1,1"),createLabel(mstrmojo.desc(3608,"Blue"),"Blue","1,1"),createLabel(mstrmojo.desc(3605,"Hue"),"Hue","1,1"),createLabel(mstrmojo.desc(3607,"Saturation"),"Saturation","1,1"),createLabel(mstrmojo.desc(3609,"Brightness"),"Brightness","1,1"),createInputBoxWithLabel(mstrmojo.desc(3604,"Red"),"1,2","r"),createSlider("r"),createInputBoxWithLabel(mstrmojo.desc(3606,"Green"),"1,2","g"),createSlider("g"),createInputBoxWithLabel(mstrmojo.desc(3608,"Blue"),"1,2","b"),createSlider("b"),createInputBoxWithLabel(mstrmojo.desc(3695,"Hue"),"1,2","h",{cssClass:"h",max:360}),createSlider("h"),createInputBoxWithLabel(mstrmojo.desc(3607,"Saturation"),"1,2","s",{max:100}),createSlider("s"),createInputBoxWithLabel(mstrmojo.desc(3609,"Brightness"),"1,2","v",{max:100}),createSlider("v")]};if(this.showMoreColors){advancedColorPickerLayout.children.push({scriptClass:"mstrmojo.Button",cssClass:"more",alias:"more",title:mstrmojo.desc(7833,"More >>>"),onclick:function(){var editor=this.parent.parent;editor.set("expanded",!editor.expanded);this.domNode.setAttribute("title",editor.expanded?mstrmojo.desc(7834,"Less Colors"):mstrmojo.desc(7833,"More Colors"));this.domNode.className=editor.expanded?"less":"more";},slot:"0,0"});}if(this.showGradients){advancedColorPickerLayout.children.push({scriptClass:"mstrmojo.Button",alias:"showGradients",cssClass:"ge",text:mstrmojo.desc(4786,"Gradients..."),title:mstrmojo.desc(7970,"Open Graident Editor"),onclick:function(){var editor=this.parent.parent;editor.set("show",false);editor.parent.ge.set("show",true);},slot:"0,0"});}this.addChildren(advancedColorPickerLayout);this.addChildren({scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-ColorPicker-buttonBar",children:[mstrmojo.Button.newInteractiveButton(mstrmojo.desc(1442,"Ok"),function(){var editor=this.parent.parent;if(!editor.useAnimate){editor.set("visible",false);}var hex=editor.colorModel.hex;if(editor.showUserPalette){updateUserPalette(hex);}editor.set("selectedColor",hex);if(editor.onOK){editor.onOK();}},"#999",{alias:"ok",cssClass:"mstrmojo-Editor-button"}),mstrmojo.Button.newInteractiveButton(mstrmojo.desc(221,"Cancel"),function(){var editor=this.parent.parent;if(!editor.useAnimate){editor.set("visible",false);}if(editor.onCancel){editor.onCancel();}},"#999",{alias:"cancel",cssClass:"mstrmojo-Editor-button"})]});}});var colorPickerPopupJson={scriptClass:"mstrmojo.Popup",slot:"popupNode",contentNodeCssClass:"mstrmojo-ColorPicker-popup-content",autoCloses:false,locksHover:true,colorPicker:null,onOpen:function(){this.colorPicker.set("selectedColor",this.opener.fillColor);var me=this;var onOpen=function(){me.lastOpener=me.lastOpener||me.opener;if(me.opener!==me.lastOpener){me.opener.popupNode.appendChild(me.lastOpener.popupRef.domNode);me.lastOpener=me.opener;}me.colorPicker.set("show",true);};window.setTimeout(function(){onOpen();},100);},onClose:function(){this.colorPicker.set("show",false);if(this.ge){this.ge.set("show",false);}},postCreate:function(){this.markupMethods=$HASH.copy(this.markupMethods);this.markupMethods.onvisibleChange=null;},preBuildRendering:function(){if(this.showGradients||this.colorPicker.showGradients){this.addChildren(this.gradientRef);}},gradientRef:{scriptClass:"mstrmojo.GradientEditor",alias:"ge",cssText:"height:0; display:none; position:absolute; z-index: 4;",left:"0px",top:"0px",visible:false,showTitle:false,height:245,_resizeHandler:function(){},onOK:function(){this.parent.opener.set("gradient",this.gradient);this.parent.opener.set("gradientCss",this.gradient.css);this.set("show",false);},onCancel:function(){this.set("show",false);},onshowChange:function(evt){var show=evt.value,height=parseInt(this.height,10);var target=this.domNode.firstChild;if(show){this.set("model",this.parent.opener.gradient);target.style.display="block";}if(this.useAnimate!==false){var start=show?0:height,stop=height-start,me=this;target.style.overflow="hidden";if(show){target.style.display="block";}slideProp(show,target,"height",start,stop,function(){if(!show){target.style.display="none";var opener=me.parent.opener;if(opener){opener.closePopup();}}else{target.style.overflow="visible";}});}else{target.style.height=show?height+"px":0;target.style.display=show?"block":"none";}},postCreate:function(){this.bindings={useAnimate:"this.parent.opener.useAnimate"};}},children:[{scriptClass:"mstrmojo.ColorPicker",alias:"colorPicker",onChange:function(){if(!this.parent.opener){return ;}this.parent.opener.set("fillColor",this.selectedColor);this.set("show",false);this.parent.opener.closePopup();},onOK:function(){this.onApply();this._closePopup();},onApply:function(){this.parent.opener.set("fillColor",this.selectedColor);},onCancel:function(){this._closePopup();},_closePopup:function(){this.set("show",false);if(!this.showGradients||!this.parent.ge||(this.parent.ge&&!this.parent.ge.show)){this.parent.opener.closePopup();}},show:false,onEnd:function(){this.set("visible",this.show);},onshowChange:function(){var height=parseInt(this.expanded?this.fullHeight:this.height,10);if(this.useAnimate!==false){var start=this.show?0:height,stop=height-start,me=this,onEnd=(!this.show?function(){me.onEnd();}:null);if(this.show){this.set("visible",true);}slideProp(this.show,this.domNode,"height",start,stop,onEnd);}else{this.set("visible",this.show);this.domNode.style.height=height+"px";}},postCreate:function(){this.showGradients=this.parent.showGradients;this.bindings={showUserPalette:function(){return this.parent.opener?this.parent.opener.showUserPalette:this.showUserPalette;},useAnimate:function(){return this.parent.opener?this.parent.opener.useAnimate:this.useAnimate;},isSimple:function(){return this.parent.opener?this.parent.opener.isSimple:this.isSimple;},showNoColor:function(){return this.parent.opener?this.parent.opener.showNoColor:this.showNoColor;}};}}]};mstrmojo.colorPickerPopupRef=mstrmojo.insert(colorPickerPopupJson);mstrmojo.simpleColorPickerPopupRef=mstrmojo.insert($HASH.copy({isSimple:true},$HASH.copy(colorPickerPopupJson)));mstrmojo.gradientColorPickerPopupRef=mstrmojo.insert($HASH.copy({showGradients:true},$HASH.copy(colorPickerPopupJson)));mstrmojo.ColorPicker.createDropDown=function cdd(ps,layoutConfig){ps=ps||{};var popupRef=mstrmojo.colorPickerPopupRef;if(layoutConfig){if(layoutConfig.isSimple){popupRef=mstrmojo.simpleColorPickerPopupRef;ps.isSimple=layoutConfig.isSimple;}else{if(layoutConfig.showGradients){popupRef=mstrmojo.gradientColorPickerPopupRef;ps.showGradients=layoutConfig.showGradients;}}}else{if(ps){if(ps.isSimple){popupRef=mstrmojo.simpleColorPickerPopupRef;}else{if(ps.showGradients){popupRef=mstrmojo.gradientColorPickerPopupRef;}}}}return $HASH.copy(ps,{scriptClass:"mstrmojo.DropDownButton",cssClass:"mstrmojo-ColorPicker-DropDownButton",markupMethods:{onfillColorChange:function(){if(this.boxNode&&this.fillColor){this.boxNode.style.cssText="background-color: "+this.fillColor;this.gradient=null;this.gradientCss=null;}},ongradientCssChange:function(){if(this.boxNode&&this.gradientCss){this.boxNode.style.cssText=this.gradientCss;this.fillColor=null;}}},popupRef:popupRef,showUserPalette:true,useAnimate:true,showGradients:false,isSimple:false,fillColor:undefined});};}());