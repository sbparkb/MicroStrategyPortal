(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.dom","mstrmojo.expr","mstrmojo.range","mstrmojo.array","mstrmojo.WidgetListMapper","mstrmojo._HasSuggestion","mstrmojo.qb.FFsqlToken","mstrmojo.warehouse.EnumDataChangeEvents");var $DOM=mstrmojo.dom,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,KEYS=mstrmojo.Enum_Keys,$RANGE=mstrmojo.range,$STR=mstrmojo.string,EDGE=$RANGE.EDGE,isDelimiter=mstrmojo.qb.FFsqlToken.isDelimiter,C_KEY=67,V_KEY=86,X_KEY=88,Z_KEY=90,LF_CHAR="\n",TAB_CHAR="\t",SPACE_CHAR=" ",C_CHAR="c",V_CHAR="v",X_CHAR="x",Z_CHAR="z",A_CHAR="a",SEMICOLON_CHAR=";",PERIOD_CHAR=".",LEFT_SQUARE_BRACKET_CHAR="[",RIGHT_SQUARE_BRACKET_CHAR="]",DRAG_ACTION_ADD_TABLE="addTable",DRAG_ACTION_ADD_COLUMN="addColumn",COMPOSITION_START_EVENT="compositionstart",COMPOSITION_UPDATE_EVENT="compositionupdate",COMPOSITION_END_EVENT="compositionend",DOM_CHAR_MODIFIED_EVENT="DOMCharacterDataModified",PASTE_EVENT="paste",$ENUM_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents;function getCharacter(evt){var charCode=($DOM.isIE&&!$DOM.isIE9)?evt.keyCode:evt.charCode;return(charCode>0)?String.fromCharCode(charCode):null;}var SQL_TOKENS,SQL_TOKEN_TYPE=100,SQL_SPACING={" ":true,"\t":true,"\n":true},SQL_KEYWORD_ACTION=["select","update","insert","delete","create","drop","alter","set","exec"],SQL_KEYWORD=SQL_KEYWORD_ACTION.concat(["from","where","having","in","group","by","order","into","on","values","table","case","then","else","join","as"]),currentDBTableHash={};SQL_KEYWORD=SQL_KEYWORD.concat(["left","right","full","outer"]);function getSQLTokens(){if(!SQL_TOKENS){SQL_TOKENS=[];$ARR.forEach(SQL_KEYWORD,function(keyword){SQL_TOKENS.push({n:keyword,sta:SQL_TOKEN_TYPE,t:SQL_TOKEN_TYPE});});}return SQL_TOKENS;}mstrmojo.qb.FFsqlInput=mstrmojo.declare(mstrmojo.ME.TokenInputBox,null,{scriptClass:"mstrmojo.qb.FFsqlInput",renderBlockSize:50000,renderOnScroll:false,init:function init(props){this._super(props);var evtConfig={},me=this,listConfig=evtConfig[this.id]={};listConfig.sqlTokensAdded=this.onsqlTokensAdded;listConfig[$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED]=function toggleButton(){mstrApp.getRootController().enableButton(me.getSQLstmt());};listConfig[$ENUM_DATA_CHANGE_EVENTS.DBTABLES_ENABLED]=function(evt){if(this.parent.visible){this.editNode.contentEditable=evt.value?"true":"false";}};mstrApp.getRootController().attachDataChangeListeners(evtConfig);this.autoSelect=false;this.openPopup("suggestionPopup");this.suggestionPopup.close();this.autoSelect=true;},itemFunction:function itemFunction(item,idx,widget){return new mstrmojo.qb.FFsqlToken({data:item});},item2textCss:function item2textCss(data){return" mstrmojo-qb-SuggestIcon t"+data.t;},itemIdField:"did",itemCount:0,ostack:[],sqlTokens:getSQLTokens(),browseItemVisible:false,customFunctionVisible:false,raiseChangeEvent:function(params){var statement=$STR.trim(this.getSQLstmt()),controller=mstrApp.getRootController();params.name="tokensModify";this.raiseEvent(params);controller.enableButton(statement);if(!statement&&controller.canAddTableSQL(true,statement)){controller.enableAvailableTables();}},getSQLstmt:function(){if(!this.items){return"";}var strArr=[];$ARR.forEach(this.items,function(item,i){strArr[i]=item.v;});return strArr.join("");},onsqlTokensAdded:function onsqlTokensAdded(evt){var tokens=evt.value,count=this.itemCount,items=this.items;if(count>0&&items[count-1]!==LF_CHAR){items.push({isNew:true,v:LF_CHAR,isDelimiter:true,did:count++});}$ARR.forEach(tokens,function(token){token=$HASH.copy({isNew:true,did:count++},token);});items=items.concat(tokens);this.itemCount=count;this.set("items",items);this.parent.updatepasses();},postBuildRendering:function postBuildRendering(){var editNode=this.editNode;if(this._super){this._super();}$DOM.detachEvent(editNode,COMPOSITION_START_EVENT,this.oncompositionstart);$DOM.detachEvent(editNode,COMPOSITION_UPDATE_EVENT,this.oncompositionupdate);$DOM.detachEvent(editNode,COMPOSITION_END_EVENT,this.oncompositionend);if($DOM.isIE9||$DOM.isIE10||$DOM.isIEW3C){$DOM.detachEvent(editNode,DOM_CHAR_MODIFIED_EVENT,this.ondomcharmodifed);}$DOM.attachEvent(editNode,COMPOSITION_START_EVENT,this.oncompositionstart);$DOM.attachEvent(editNode,COMPOSITION_UPDATE_EVENT,this.oncompositionupdate);$DOM.attachEvent(editNode,COMPOSITION_END_EVENT,this.oncompositionend);if($DOM.isIE9||$DOM.isIE10||$DOM.isIEW3C){$DOM.attachEvent(editNode,DOM_CHAR_MODIFIED_EVENT,this.ondomcharmodifed);}$DOM.detachEvent(editNode,PASTE_EVENT,this.onpaste);$DOM.attachEvent(editNode,PASTE_EVENT,this.onpaste);mstrApp.getRootController().attachEventListener("failureLabel",this.id,function(evt){this.markFailureLabel(evt.value);});},handlekeydown:function handlekeydown(evt){var me=this,charCode=evt.keyCode||evt.charCode;if(this.editNode.contentEditable==="false"){return true;}if(this._inComposition){return true;}if(me._inHandleImeInputTimeout&&charCode===KEYS.ENTER){window.setTimeout(function(){me.handlekeydown(evt);},0);$DOM.stopPropogation(window,evt);$DOM.preventDefault(window,evt);return false;}evt=evt||window.event;var selectedItem,noDefault=false,rInfo=$RANGE.getRangeInfo(),sc=rInfo.range.startContainer,so=rInfo.range.startOffset;switch(charCode){case KEYS.DELETE:if(!this.doubleByte){try{this.widgetHandleDelete(rInfo);this.startTokenSuggestion();this.raiseChangeEvent({type:"delete"});this.parent.updatepasses();}catch(ex1){}noDefault=true;}break;case KEYS.BACKSPACE:if(!this.doubleByte){try{this.widgetHandleBackspace(rInfo);this.raiseChangeEvent({type:"backspace"});this.startTokenSuggestion();}catch(ex2){}noDefault=true;}break;case KEYS.ENTER:if(this.suggestionShown){selectedItem=this.getSelected();if(selectedItem){this.handleSuggestionItemSelect(selectedItem);if(this.candidates.isCol){this.set("candidates",{items:mstrApp.getRootController().getFFsqlComp(),isComplete:true});}}this.hideSuggestion();}else{var edge,widget,idx,itws=this.ctxtBuilder.itemWidgets,isEnter,newLineToken={v:LF_CHAR,isDelimiter:true,isNew:true,did:this.itemCount++},spaceToken={v:SPACE_CHAR,isDelimiter:true,isNew:true,did:this.itemCount++},oldScrollTop=null;widget=$DOM.findWidget(sc);if(widget.data!==undefined){edge=$RANGE.getEdgeInfo(sc,so);idx=this.itemIndex(widget.data);isEnter=itws[idx].data.v===LF_CHAR;}else{edge=EDGE.EDGE_END;idx=-1;isEnter=false;}if($DOM.isFF){oldScrollTop=this.itemsContainerNode.scrollTop;}if(edge===EDGE.EDGE_MIDDLE){var tokens=widget.split2Tokens(rInfo.startOffset,this.itemCount++);this.remove(idx);this.add([tokens[0],newLineToken,tokens[1]],idx);idx=idx+1;}else{if(edge===EDGE.EDGE_BEGIN){this.add([newLineToken],idx);}else{idx=idx+1;if(($DOM.isFF||$DOM.isIE||$DOM.isIEW3C)&&isEnter){this.add([spaceToken,newLineToken],idx);}else{this.add([newLineToken,spaceToken],idx);}}}if($DOM.isFF||$DOM.isIE||$DOM.isIEW3C){idx=isEnter?idx:idx+1;widget=itws[idx];this._delaySetCaretPos(widget.domNode,true);}else{widget=itws[idx];this._delaySetCaretPos(widget.domNode,false);}this.delayedScrollToItem(idx,oldScrollTop);this.parent.updatepasses();}noDefault=true;break;case KEYS.TAB:if(this.suggestionShown){selectedItem=this.getSelected();if(selectedItem){this.handleSuggestionItemSelect(selectedItem);if(this.candidates.isCol){this.set("candidates",{items:mstrApp.getRootController().getFFsqlComp(),isComplete:true});}}}else{this.startTokenSuggestion();}noDefault=true;break;case KEYS.ESCAPE:this.endTokenSuggestion();noDefault=true;break;case C_KEY:if(evt.ctrlKey||evt.metaKey){this.ctrx=false;noDefault=false;}break;case V_KEY:if(evt.ctrlKey||evt.metaKey){this._saveRangeInfo=$RANGE.getRangeInfo();if(!this._saveRangeInfo.collapsed){this.widgetDeleteTokens(this._saveRangeInfo);this._saveRangeInfo=$RANGE.getRangeInfo();}if(this.ctrx){this.handlepaste(this.cutstr);noDefault=true;}else{this.clipboardNode.focus();noDefault=false;}this.parent.updatepasses();}break;case X_KEY:if(evt.ctrlKey||evt.metaKey){try{var wrap=document.createElement("div");wrap.appendChild(rInfo.range.cloneContents());wrap.innerHTML=wrap.innerHTML.replace(/<br\>/gi,"\n");this.cutstr=wrap.textContent.replace(/\u00A0/gi," ");this.widgetHandleDelete(rInfo);this.startTokenSuggestion();this.ctrx=true;this.raiseChangeEvent({type:"cut"});}catch(ex3){}noDefault=true;}break;case Z_KEY:if(evt.ctrlKey||evt.metaKey){try{var stack=this.ostack,len=stack.length;if(len>1){stack.pop();this.set("items",stack[len-2].its);this.parent.updatepasses();this.focus();this.raiseChangeEvent({type:"undo"});}}catch(ex4){}noDefault=true;}break;case KEYS.LEFT_ARROW:case KEYS.RIGHT_ARROW:this.endTokenSuggestion(true);break;case 229:if(!this.doubleByte){this.doubleByte=true;this.prev_rInfo=rInfo;this.prev_items=this.items;}break;}if(noDefault){$DOM.stopPropogation(window,evt);$DOM.preventDefault(window,evt);return false;}return true;},handlekeypress:function handlekeypress(evt){if(this.editNode.contentEditable==="false"){return true;}if(this._inComposition){return true;}evt=evt||window.event;var character=getCharacter(evt),noDefault=false,me=this,widget;function commitHandleInput(){try{this.widgetHandleInput($RANGE.getRangeInfo(),character);this.raiseChangeEvent({type:"input",characeter:character});var sat=this._saveActiveToken;if(!isDelimiter(character)){if(!sat){widget=this.findObjectToken();if(widget&&!widget.isDelimiter()){this._saveActiveToken=sat=widget;}}if(sat&&character===PERIOD_CHAR){var dbtable=currentDBTableHash[sat.data.v.toLowerCase().slice(0,-1)];if(dbtable){if(dbtable.columns){this.startTokenSuggestion();}else{var me=this;mstrApp.getRootController().getColumnsForDBTable({data:dbtable},{success:function success(res){var its=res.items,columns=[],prefix=sat.data.v;dbtable.columns=its;$ARR.forEach(its,function(item){columns.push({n:prefix+item.n,sta:2,t:26});});me.set("candidates",{items:me.candidates.items.concat(columns),isComplete:true});me.startTokenSuggestion();}});}}else{sat.isCol=false;sat.col=null;this.startTokenSuggestion();}}else{this.startTokenSuggestion();}}else{this.endTokenSuggestion(true);}}catch(ex){}}if(character&&!((character===C_CHAR||character===X_CHAR||character===V_CHAR||character===Z_CHAR||character===A_CHAR)&&evt.ctrlKey)){if(me._inHandleImeInputTimeout||($DOM.isIE||$DOM.isIEW3C)){if(me._inHandleImeInputTimeout&&($DOM.isIE9||$DOM.isIE10||$DOM.isIEW3C)&&character===" "){}else{window.setTimeout(function(){commitHandleInput.call(me);},1);}}else{commitHandleInput.call(me);}noDefault=true;}if(noDefault){$DOM.stopPropogation(window,evt);$DOM.preventDefault(window,evt);return false;}return true;},handlekeyup:function handlekeyup(e){var pr,r,data;if(this.doubleByte&&!this._inComposition){pr=this.prev_rInfo;r=$RANGE.getRangeInfo();data=r.startContainer.data.slice(pr.startOffset,r.startOffset);if(data){this.widgetHandleImeInput(pr,data);}this.doubleByte=false;}else{if(this._super){this._super(e);}}},oncompositionstart:function oncompositionstart(evt){var ffsql=$DOM.findWidget(this);ffsql._inComposition=true;ffsql.doubleByte=true;ffsql._savedCompositionData=null;if(!ffsql._compositionDataArr){ffsql.prev_rInfo=$RANGE.getRangeInfo();ffsql.prev_items=ffsql.items;ffsql._compositionDataArr=[];ffsql._savedCompositionData=null;ffsql._beforeCompositionDOMChars=null;ffsql._hasBeforeCompositionDOMChars=false;ffsql._compositionDOMChars=null;}},oncompositionupdate:function oncompositionupdate(evt){var ffsql=$DOM.findWidget(this);if(ffsql._inComposition){ffsql._savedCompositionData=evt.data;}},ondomcharmodifed:function ondomcharmodifed(evt){var ffsql=$DOM.findWidget(this),nValue=evt.newValue,pValue=evt.prevValue,v;if(ffsql._inComposition){if(ffsql._savedCompositionData===null){ffsql._beforeCompositionDOMChars=pValue;ffsql._hasBeforeCompositionDOMChars=true;}else{ffsql._compositionDOMChars=nValue;}if($DOM.isIEW3C&&!ffsql._hasBeforeCompositionDOMChars){v=nValue.length<=pValue.length?nValue:pValue;ffsql._beforeCompositionDOMChars=v;ffsql._hasBeforeCompositionDOMChars=true;}}},oncompositionend:function oncompositionend(evt){var ffsql=$DOM.findWidget(this),prevInfo=ffsql.prev_rInfo,so=prevInfo.range.startOffset,inputChars,data;ffsql._inComposition=false;ffsql.doubleByte=false;data=evt.data||ffsql._savedCompositionData;if(data!==null&&data!==undefined){ffsql._compositionDataArr.push(data);}if($DOM.isIE9||$DOM.isIE10||$DOM.isIEW3C){if(ffsql._compositionDOMChars&&ffsql._compositionDOMChars.length){if(ffsql._beforeCompositionDOMChars!==null){inputChars=ffsql._compositionDOMChars.substr(Math.min(so,ffsql._beforeCompositionDOMChars.length),ffsql._compositionDOMChars.length-ffsql._beforeCompositionDOMChars.length);}else{inputChars=ffsql._compositionDOMChars;}if(inputChars.length){ffsql._compositionDataArr=inputChars.split("");}}}if(ffsql._compositionDataArr.length){ffsql._inHandleImeInputTimeout=true;window.setTimeout(function(){ffsql._inHandleImeInputTimeout=false;if(!ffsql._inComposition&&ffsql._compositionDataArr){if($DOM.findWidget(prevInfo.startContainer.parentNode?prevInfo.startContainer:prevInfo.range.startContainer)){data=ffsql._compositionDataArr.join("");ffsql._compositionDataArr=null;ffsql.widgetHandleImeInput(prevInfo,data);ffsql.raiseChangeEvent({type:"insert"});}}},0);}},markFailureLabel:function markFailureLabel(failPassNumber){this.pnum=failPassNumber;this.parent.updatepasses();},getPassLabelYCoords:function getPassLabelYCoords(){var yCoordinates=[],its=this.ctxtBuilder.itemWidgets,isNewPass=true,baseHeight=$DOM.position(this.domNode).y,data,value;$ARR.forEach(its,function(item){data=item.data;value=data.v;if(isNewPass&&!SQL_SPACING[value]){if(value&&$ARR.indexOf(SQL_KEYWORD_ACTION,value.toString().toLowerCase())>-1){yCoordinates.push($DOM.position(item.domNode).y-baseHeight);}isNewPass=false;}else{if(value===SEMICOLON_CHAR){isNewPass=true;}}});if(yCoordinates.length===1){yCoordinates=[];}return yCoordinates;},widgetHandleBackspace:function widgetHandleBackspace(rInfo){if(rInfo.collapsed){var sat=this._saveActiveToken,selectedItem,tokenValue;if(sat&&sat.data){tokenValue=sat.data.v;if(tokenValue&&tokenValue[tokenValue.length-1]===PERIOD_CHAR&&sat.isCol){this.set("candidates",{items:mstrApp.getRootController().getFFsqlComp(),isComplete:true});sat.isCol=false;sat.col=null;}}var edge,widget,idx,startOffset=rInfo.startOffset,itws=this.ctxtBuilder.itemWidgets;if(!$DOM.contains(this.editNode,rInfo.startContainer,false,document.body)){if(rInfo.startOffset>0&&$DOM.isFF){widget=itws[this.items.length-1];$RANGE.collapseOnNode(widget.domNode,false);rInfo=$RANGE.getRangeInfo();edge=$RANGE.getEdgeInfo(rInfo.range.startContainer,rInfo.range.startOffset);}else{$RANGE.collapseOnNode(this.editNode,true);return ;}}edge=$RANGE.getEdgeInfo(rInfo.range.startContainer,rInfo.range.startOffset);widget=$DOM.findWidget(rInfo.range.startContainer);idx=this.itemIndex(widget.data);if(edge===EDGE.EDGE_BEGIN){idx--;widget=itws[idx];startOffset=widget.length();}if(!widget){$RANGE.collapseOnNode(this.editNode,true);return ;}if(widget.length()<=1){this.remove(idx);if(widget.data.v===SEMICOLON_CHAR||widget.data.v===LF_CHAR){this.parent.updatepasses();}widget=itws[idx-1];if(widget){$RANGE.collapseOnNode(widget.domNode,false);this.checkMergeTwoTokens(idx-1,idx);widget=itws[idx-1];}else{$RANGE.collapseOnNode(this.editNode,true);}}else{widget.spliceContent(startOffset-1,1);if(widget.isCol){this.set("candidates",{items:widget.col,isComplete:true,isCol:true});}$RANGE.collapseOnTextNode(widget.domNode,startOffset-1);}}else{this.widgetDeleteTokens(rInfo);this.parent.updatepasses();}},onpaste:function onpaste(evt){var ffsqlInput=$DOM.findWidget(this),data,processedData;if(!ffsqlInput){return ;}if(evt&&evt.clipboardData&&evt.clipboardData.getData){data=evt.clipboardData.getData("text/plain");}else{if(window.clipboardData&&window.clipboardData.getData){data=window.clipboardData.getData("Text");}}if(typeof data!=="string"){return ;}processedData=data.replace(/\r/g,"");if(processedData===""){return ;}ffsqlInput.handlepaste(processedData);$DOM.stopPropogation(window,evt);$DOM.preventDefault(window,evt);return false;},handlepaste:function handlepaste(pasteStr){var pasteValue;if(typeof pasteStr!=="string"){pasteValue=this.clipboardNode.value;}else{pasteValue=pasteStr;}this.clipboardNode.value="";var tokens=[],len=pasteValue&&pasteValue.length,i,tokenValue="",character;if(len>0){for(i=0;i<len;i++){character=pasteValue.charAt(i);if(isDelimiter(character)){if(!$STR.isEmpty(tokenValue)){tokens.push({v:tokenValue,isNew:true,did:this.itemCount++});tokenValue="";}tokens.push({v:character,isDelimiter:true,isNew:true,did:this.itemCount++});}else{tokenValue=tokenValue+character;}}if(!$STR.isEmpty(tokenValue)){tokens.push({v:tokenValue,isNew:true,did:this.itemCount++});}this.insertTokens(tokens);}},insertTokens:function insertTokens(tokens){var rInfo=this._saveRangeInfo,its,widget,edge,idx;if(!rInfo||!$DOM.contains(this.editNode,rInfo.startContainer,false,document.body)){this.add(tokens);its=this.ctxtBuilder.itemWidgets;idx=its.length-1;widget=its[idx];this._delaySetCaretPos(widget.domNode,false);this.delayedScrollToItem(idx);this.raiseChangeEvent({type:"insert"});return ;}edge=$RANGE.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);widget=$DOM.findWidget(rInfo.startContainer);idx=this.itemIndex(widget.data);if(edge===EDGE.EDGE_MIDDLE){var splitTokens=widget.split2Tokens(rInfo.startOffset,this.itemCount++);this.remove(idx);tokens.unshift(splitTokens[0]);tokens.push(splitTokens[1]);this.add(tokens,idx);}else{idx=(edge===EDGE.EDGE_BEGIN?idx:idx+1);this.add(tokens,idx);}idx=idx+tokens.length-1;widget=this.ctxtBuilder.itemWidgets[idx];this._delaySetCaretPos(widget.domNode,false);this.delayedScrollToItem(idx);this.raiseChangeEvent({type:"insert"});},widgetHandleInput:function widgetHandleInput(rInfo,character){if(!rInfo.collapsed){this.widgetDeleteTokens(rInfo);rInfo=$RANGE.getRangeInfo();}var edge,widget,idx,token,neighborWidget,startOffset,itws=this.ctxtBuilder.itemWidgets,me=this,sc=rInfo.startContainer,so=rInfo.startOffset,data;if(!$DOM.contains(this.editNode,sc,false,document.body)||!itws||itws.length===0){this.add([{v:character,isDelimiter:isDelimiter(character),isNew:true,did:this.itemCount++}],0);widget=itws[0];$RANGE.collapseOnTextNode(widget.domNode,1);this.delayedScrollToItem(0);return ;}edge=$RANGE.getEdgeInfo(sc,so);widget=$DOM.findWidget(sc);idx=this.itemIndex(widget.data);if(isDelimiter(character)){if(this.candidates.isCol){this.set("candidates",{items:mstrApp.getRootController().getFFsqlComp(),isComplete:true});}token={v:character,isDelimiter:true,isNew:true,did:this.itemCount++};if(edge===EDGE.EDGE_MIDDLE){var ts=widget.split2Tokens(so,this.itemCount++);this.remove(idx);this.add([ts[0],token,ts[1]],idx);idx=idx+1;}else{idx=(edge===EDGE.EDGE_BEGIN)?idx:idx+1;this.add([token],idx);}widget=itws[idx];$RANGE.collapseOnNode(widget.domNode,false);this._delaySetCaretPos(widget.domNode,false);if(character===SEMICOLON_CHAR){this.parent.updatepasses();}}else{startOffset=so;if(widget.isDelimiter()){neighborWidget=itws[(edge===EDGE.EDGE_BEGIN)?idx-1:idx+1];if(neighborWidget&&!neighborWidget.isDelimiter()){widget=neighborWidget;startOffset=(edge===EDGE.EDGE_BEGIN)?widget.length():0;}idx=(edge===EDGE.EDGE_BEGIN)?idx:idx+1;this.add([{v:character,isNew:true,did:this.itemCount++}],idx);widget=itws[idx];$RANGE.collapseOnNode(widget.domNode,false);this.parent.updatepasses();}else{data=widget.data.v;rInfo=$RANGE.getRangeInfo();widget.spliceContent(startOffset,0,character);if($DOM.isIE||$DOM.isIEW3C){$RANGE.collapseOnTextNodeIE(widget.domNode,startOffset+1);window.setTimeout(function(){me.editNode.focus();me.editNode.focus();$RANGE.collapseOnTextNodeIE(widget.domNode,startOffset+1);},0);}else{$RANGE.collapseOnTextNode(widget.domNode,startOffset+1);this._delaySetTextCaretPos(widget.domNode,startOffset+1);}}}this.delayedScrollToItem(idx);},widgetHandleImeInput:function widgetHandleImeInput(rInfo,imeStr){if(!rInfo.collapsed){this.widgetDeleteTokens(rInfo);rInfo=$RANGE.getRangeInfo();}var edge,widget,idx,neighborWidget,startOffset,itws=this.ctxtBuilder.itemWidgets,me=this,neighborIdx,sc=rInfo.range.startContainer,so=rInfo.range.startOffset,oldScrollTop=this.itemsContainerNode.scrollTop;if(!$DOM.contains(this.editNode,sc,false,document.body)||!itws||itws.length===0){this.clearTokens();this.add([{v:imeStr,isDelimiter:this.isDelimiter(imeStr),isNew:true,did:this.itemCount++,isIME:true}],0);itws=this.ctxtBuilder.itemWidgets;widget=itws[0];$RANGE.collapseOnTextNode(widget.domNode,widget.data.v.length||1);this._delaySetCaretPos(widget.domNode,false);this.delayedScrollToItem(0,oldScrollTop);return ;}edge=$RANGE.getEdgeInfo(sc,so);widget=$DOM.findWidget(sc);idx=this.itemIndex(widget.data);startOffset=so;if(widget.isDelimiter()){this.clearTokens();this.set("items",this.prev_items);itws=this.ctxtBuilder.itemWidgets;neighborIdx=(edge===EDGE.EDGE_BEGIN)?idx-1:idx+1;neighborWidget=itws[neighborIdx];if(neighborWidget&&!neighborWidget.isDelimiter()){widget=neighborWidget;startOffset=(edge===EDGE.EDGE_BEGIN)?widget.length():0;idx=neighborIdx;}}if(!widget.isDelimiter()){widget.spliceContent(startOffset,0,imeStr);if($DOM.isIE||$DOM.isIEW3C){$RANGE.collapseOnTextNodeIE(widget.domNode,startOffset+imeStr.length);window.setTimeout(function(){me.editNode.focus();me.editNode.focus();$RANGE.collapseOnTextNodeIE(widget.domNode,startOffset+imeStr.length);},0);}else{$RANGE.collapseOnTextNode(widget.domNode,startOffset+imeStr.length);this._delaySetTextCaretPos(widget.domNode,startOffset+imeStr.length);}}else{idx=(edge===EDGE.EDGE_BEGIN)?idx:idx+1;this.add([{v:imeStr,isNew:true,did:this.itemCount++}],idx);widget=itws[idx];$RANGE.collapseOnNode(widget.domNode,false);this._delaySetCaretPos(widget.domNode,false);}this.delayedScrollToItem(idx,oldScrollTop);this.startTokenSuggestion();return widget;},getSearchPattern:function getSearchPattern(){var activeToken=this._saveActiveToken,pattern,len;if(activeToken.isCol){var tokenValue=activeToken.data.v;pattern=tokenValue.slice(tokenValue.lastIndexOf(PERIOD_CHAR)+1,tokenValue.length);}else{pattern=activeToken&&activeToken.data.v;}len=pattern&&pattern.length;if(len>2){if(pattern.charAt(0)===LEFT_SQUARE_BRACKET_CHAR){pattern=pattern.substring(1);}if(pattern.charAt(pattern.length-1)===RIGHT_SQUARE_BRACKET_CHAR){pattern=pattern.substring(0,pattern.length-1);}}return pattern;},getSuggestionPos:function getSuggestionPos(){var activeToken=this._saveActiveToken,suggestionPos=null,activeTokenPos,offsetWidth=0;if(activeToken&&activeToken.isCol){offsetWidth=activeToken.domNode.offsetWidth;}if(activeToken){activeTokenPos=$DOM.position(activeToken.domNode,true);var activeTokenBottom=Math.round(activeTokenPos.y+activeTokenPos.h),suggestionHeight=this.suggestionItems.length*19,rootView=mstrmojo.all.QBuilderPage,pageHeight=parseInt(rootView.height,10),containerPos=$DOM.position(rootView.domNode,true),suggestionTop=(pageHeight>activeTokenBottom-40-containerPos.y+suggestionHeight)?activeTokenBottom:activeTokenPos.y-suggestionHeight;suggestionPos={left:Math.round(activeTokenPos.x)+offsetWidth+"px",top:suggestionTop+"px",zIndex:100};}return suggestionPos;},onSuggestionItemSelect:function onSuggestionItemSelect(itemInfo){var activeToken=this._saveActiveToken,items,me=this;this.endTokenSuggestion();if(itemInfo.t===-98){items=this.items;this.clearTokens();$ARR.forEach(items,function(item){item.did=me.itemCount++;});this.customFunctionMode=true;items=[{v:"{",isDelimiter:true,sta:1,isNew:true,did:this.itemCount++}].concat(items).concat([{v:"}",isDelimiter:true,sta:1,isNew:true,did:this.itemCount++}]);this.set("items",items);var idx=this.itemIndex({did:this.itemCount-1}),widget=this.ctxtBuilder.itemWidgets[idx-1];this._delaySetCaretPos(widget.domNode,false);}else{if(activeToken){if(activeToken.isCol){var tokenValue=activeToken.data.v,newItemInfo={};$HASH.copy(itemInfo,newItemInfo);newItemInfo.n=tokenValue.slice(0,tokenValue.lastIndexOf(PERIOD_CHAR)+1)+itemInfo.n;activeToken.setItemInfo(newItemInfo);}else{activeToken.setItemInfo(itemInfo);}this._delaySetCaretPos(activeToken.domNode,false);}}},ontokensModify:function(evt){this.ostack.push({its:$HASH.cloneArray(this.items)});this.pnum=-1;this.parent.updatepasses();},dropZone:true,allowDrop:function allowDrop(context){return(context.action===DRAG_ACTION_ADD_TABLE||context.action===DRAG_ACTION_ADD_COLUMN);},getAvatarIconClass:function getAvatarIconClass(context){return"enabled";},ondragenter:function ondragenter(context){var srcWidget=context.src.widget;if(srcWidget&&srcWidget.toggleAvatarClass&&this.allowDrop(context)){srcWidget.toggleAvatarClass(this.getAvatarIconClass(context),true);}},ondragleave:function ondragleave(context){var srcWidget=context.src.widget;if(srcWidget&&srcWidget.toggleAvatarClass&&this.allowDrop(context)){srcWidget.toggleAvatarClass(this.getAvatarIconClass(context),false);}},ondragover:function ondragover(ctxt){var widget=ctxt.tgt.widget,tgtX=ctxt.tgt.pos.x,tgtY=ctxt.tgt.pos.y;var itemWidgets=widget.ctxtBuilder.itemWidgets,len=itemWidgets.length;if(len===0){return ;}var lastDomNode=itemWidgets[len-1].domNode,lastDomNodePos=$DOM.position(lastDomNode),i;if(tgtY>lastDomNodePos.y+lastDomNode.clientHeight){widget._delaySetCaretPos(lastDomNode,false);}else{for(i=len-1;i>-1;i--){if(itemWidgets[i].data.v===LF_CHAR||itemWidgets[i].data.v===TAB_CHAR){continue;}var curDomNode=itemWidgets[i].domNode,curDomNodeY=$DOM.position(curDomNode).y;if(curDomNodeY<tgtY&&!(curDomNodeY+14<tgtY)){widget._delaySetCaretPos(curDomNode,false);break;}}}},ondrop:function(context){var dragEvent=context.action,contextSrc=context.src,controller=mstrApp.getRootController(),me=this;if(contextSrc&&contextSrc.data){var dragData=contextSrc.data;if(dragEvent===DRAG_ACTION_ADD_TABLE){var dataHelper=contextSrc.widget.dataHelper;if(!controller.canAddTableSQL()){return ;}$ARR.forEach(dragData,function(tableObj){dataHelper.fetch(tableObj,{success:function success(res){controller.addTableSQL(tableObj,res.items);controller.enableButton(me.getSQLstmt());}});});}else{if(dragEvent===DRAG_ACTION_ADD_COLUMN){if(!controller.canAddTableSQL()){return ;}var tableData=contextSrc.widget.items[parseInt(dragData._renderIdx.split(":")[0],10)];controller.addTableSQL(tableData,[dragData]);controller.enableButton(me.getSQLstmt());}}}},onscroll:function(evt){if($DOM.isIE8){editNode=evt.srcElement;}if(this.parentNode){mstrmojo.all[this.parentNode.id].parent.updatepasses();}},onRender:function onR(){if(this.hasRendered){$DOM.attachEvent(this.editNode,"scroll",this.onscroll);this.itemsContainerNode.style.height="100%";}},addCandidateTables:function addCandidateTables(evt){var items=[],name,tables=evt.value;currentDBTableHash={};$ARR.forEach(tables,function(table){name=table.ns?table.ns+PERIOD_CHAR+table.n:table.n;items.push({n:name,sta:2,t:15});currentDBTableHash[name.toLowerCase()]=table;});this.set("candidates",{items:this.sqlTokens.concat(items).concat(mstrApp.getRootController().getSuggestionItems(true)),isComplete:true});},scrollToItem:function scrollToItem(toItemIndex,oldScrollTop){var containerNode=this.itemsContainerNode,toItemNode=containerNode.childNodes[toItemIndex],offset,newScrollTop,containerHeight=containerNode.clientHeight,itemHeight;if(typeof oldScrollTop!=="number"){oldScrollTop=containerNode.scrollTop;}newScrollTop=oldScrollTop;if(!toItemNode){return ;}itemHeight=toItemNode.offsetHeight;offset=toItemNode.offsetTop;if(offset<oldScrollTop){newScrollTop=offset;}else{if(oldScrollTop+containerHeight<offset+itemHeight){newScrollTop=Math.min(offset,offset+itemHeight-containerHeight);}}containerNode.scrollTop=newScrollTop;},delayedScrollToItem:function delayedScrollToItem(toItemIndex,oldScrollTop){var me=this;if(typeof oldScrollTop!=="number"){oldScrollTop=this.itemsContainerNode.scrollTop;}window.setTimeout(function(){me.scrollToItem(toItemIndex,oldScrollTop);},0);}});}());