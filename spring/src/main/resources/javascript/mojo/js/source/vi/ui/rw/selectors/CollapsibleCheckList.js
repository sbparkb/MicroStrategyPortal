(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.rw.selectors.CheckList","mstrmojo.vi.ui.rw.selectors.SearchableCheckList","mstrmojo.vi.ui.rw.selectors.CollapsibleCheckListHelper","mstrmojo.ui.SearchBox","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.ui.menus.MenuConfig","mstrmojo.string","mstrmojo.css","mstrmojo.hash","mstrmojo.dom");var $CSS=mstrmojo.css,$HASH=mstrmojo.hash,$DOM=mstrmojo.dom,CSS_HIDDEN="hidden",CSS_EXPANDED="expanded",CSS_COLLAPSED="collapsed";function doBranchSelect(item,evt){var idx=item._renderIdx,pos=item._positionIdx,methodName=this.helper.isBranchSelected(idx)?"remove":"add",idxs=this.helper.getBranchIndices(idx);this[methodName+"Select"](idxs,false,pos);}function doLevelSelect(levelNumber){var levelIndices=this.helper.getLevelIndices(levelNumber),methodName=this.helper.isLevelSelected(levelNumber,levelIndices)?"remove":"add";this[methodName+"Select"](levelIndices,false);}function getMaxLevelButtonCount(){return Math.floor((parseInt(this.width.match(/\d*/))-16)/22);}function updateLevelButtonsControlBar(){if(!this.isShowAllItems){return ;}var levelButtonsContainerNode,btnsMarkup,levelCount=this.helper.getLevelCount(),maxLvlBtnCount=getMaxLevelButtonCount.call(this),i;levelButtonsContainerNode=document.createElement("div");levelButtonsContainerNode.className="btnsBar lv";btnsMarkup='<div class="btn all'+(this.helper.isAllItemsSelected()?" selected":"")+'">All</div>';if(levelCount<=maxLvlBtnCount){for(i=0;i<levelCount;i++){btnsMarkup+='<div class="btn lv'+(this.helper.isLevelSelected(i)?" selected":"")+'" idx = "'+i+'">'+(i+1)+"</div>";}}else{for(i=0;i<maxLvlBtnCount-1;i++){btnsMarkup+='<div class="btn lv'+(this.helper.isLevelSelected(i)?" selected":"")+'" idx = "'+i+'">'+(i+1)+"</div>";}btnsMarkup+='<div class="btn more" idx = "">...</div>';}levelButtonsContainerNode.innerHTML=btnsMarkup;if(this.levelButtonsContainerNode){this.domNode.replaceChild(levelButtonsContainerNode,this.levelButtonsContainerNode);}else{this.domNode.insertBefore(levelButtonsContainerNode,this.scrollboxNode);}this.levelButtonsContainerNode=levelButtonsContainerNode;}function updateLevelButtonCssClass(idx){if(!this.isShowAllItems){return ;}var btnNode=getButtonNode.call(this,idx);if(btnNode){var b=isNaN(idx)?this.helper.isAllItemsSelected():this.helper.isLevelSelected(idx);$CSS.toggleClass(btnNode,"selected",b);}}function updateAllLevelButtonCssClass(){var i,levelCount=this.helper.getLevelCount(),maxLvlBtnCount=getMaxLevelButtonCount.call(this),max;updateLevelButtonCssClass.call(this);if(levelCount<=maxLvlBtnCount){max=levelCount;}else{max=maxLvlBtnCount-1;}for(i=0;i<max;i++){updateLevelButtonCssClass.call(this,i);}}function getButtonNode(idx){if(!this.isShowAllItems){return ;}var btnContainer=this.levelButtonsContainerNode,btnNode;if(isNaN(idx)){btnNode=btnContainer.childNodes[0];}else{btnNode=btnContainer.childNodes[idx+1];if(btnNode&&parseInt(btnNode.getAttribute("idx"),10)!==idx){btnNode=undefined;}}return btnNode;}function openMenu(evt){var menuCfg=new mstrmojo.ui.menus.MenuConfig(),levelCount=this.helper.getLevelCount(),maxLvlBtnCount=getMaxLevelButtonCount.call(this),nMenuItems=levelCount-maxLvlBtnCount+1,i,checkList=this;if(nMenuItems>0){for(i=0;i<nMenuItems;i++){menuCfg.addMenuItem("Level "+(i+maxLvlBtnCount),this.helper.isLevelSelected(i+maxLvlBtnCount-1)?"on":"",function onLevelMenuItemClick(){doLevelSelect.call(checkList,maxLvlBtnCount-1+this._renderIdx);});}menuCfg.hostId=this.id;menuCfg.isHostedWithin=false;menuCfg.hostElement=evt.getTarget();this.openPopup(menuCfg.newInstance());}}function onLevelButtonClick(evt){var target=evt.getTarget(),item,nLvl;if(this.hasClass(target,"all")){item=this.items[0];this.doItemSelect(item,evt||{});}else{if(this.hasClass(target,"lv")){nLvl=target&&parseInt(target.getAttribute("idx"),10);doLevelSelect.call(this,nLvl);}else{if(this.hasClass(target,"more")){openMenu.call(this,evt);}}}}function updateSelectedDescendantsCountStatisticInfo(){var i,nItems=this.items.length,oldSelectedDescendants=[],helper=this.helper;if(this.isCollapsibleDisplay()){for(i=0;i<nItems;i++){oldSelectedDescendants[i]=this.items[i].nSelectedDescendants;}}helper.updateCachedSelectedDescendantsCount();if(this.isCollapsibleDisplay()){var nSelectedDescendants;for(i=0;i<nItems;i++){nSelectedDescendants=this.items[i].nSelectedDescendants;if(nSelectedDescendants!==oldSelectedDescendants[i]){var itemStatNode=this._getItemNode(i).getElementsByClassName("statistic");if(itemStatNode.length===1){itemStatNode=itemStatNode[0];itemStatNode[itemStatNode.innerText!==undefined?"innerText":"textContent"]="("+helper.getAndCacheSelectedDescendantsCount(i,true)+"/"+helper.getAndCacheDescendantsCount(i)+")";}}}}}mstrmojo.vi.ui.rw.selectors.CollapsibleCheckList=mstrmojo.declare(mstrmojo.vi.ui.rw.selectors.SearchableCheckList,[mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.vi.ui.rw.selectors.CollapsibleCheckList",markupString:'<div id="{@id}" class="mstrmojo-ui-CheckList {@cssClass}" style="{@cssText}" mstrAttach:click,contextmenu><table class="btnBar"><tbody><tr><td class="btn availItems">{@availItemsText}</td><td class="btn selItems">{@selectedItemsText}</td></tr></tbody></table><div class="scroll-container"><div class="{@icnCss}" style="{@icnCssText}">{@itemsHtml}</div></div></div>',markupSlots:{availItemsBtnNode:function btnBarNode(){return this.domNode.firstChild.firstChild.firstChild.firstChild;},selectedItemsBtnNode:function btnBarNode(){return this.domNode.firstChild.firstChild.firstChild.children[1];},btnBarNode:function btnBarNode(){return this.domNode.firstChild;},scrollboxNode:function scrollboxNode(){return this.domNode.children[1];},itemsContainerNode:function itemsContainerNode(){return this.domNode.children[1].firstChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,onheightChange:mstrmojo.Widget.heightMarkupMethod,onwidthChange:mstrmojo.Widget.widthMarkupMethod,onisShowAllItemsChange:function(){var isShowAllItems=this.isShowAllItems;$CSS.toggleClass(this.domNode,"showSelectedItems",!isShowAllItems);$CSS.toggleClass(this.availItemsBtnNode,"selected",isShowAllItems);$CSS.toggleClass(this.selectedItemsBtnNode,"selected",!isShowAllItems);this.refresh();}},isShowOnly:false,isShowAllItems:true,renderOnScroll:false,init:function init(props){this._super(props);$CSS.addWidgetCssClass(this,"collapsible");},updateHelper:function updateHelper(){var Cls=$HASH.walk("vi.ui.rw.selectors.CollapsibleCheckListHelper",mstrmojo);this.helper=new Cls({checkList:this});},preBuildRendering:function preBuildRendering(){this.updateHelper();this.availItemsText=mstrmojo.desc(14671,"Available Items");this.selectedItemsText=mstrmojo.desc(14672,"Selected Items");this._super();},buildRendering:function buildRendering(){this._super();this.levelButtonsContainerNode=undefined;updateLevelButtonsControlBar.apply(this);},_buildItemsMarkup:function _buildItemsMarkup(start,end,markupPrefix,markupSuffix,itemPrefix,itemSuffix){var markup=[],count=0;markup[count++]=markupPrefix||"";var ir=this.itemRenderer,fn=ir&&ir.render;if(fn&&typeof fn==="function"){var items=this.items,rootIndices=this.rootIndices,rootIdx,rootLen=rootIndices.length,mapOriToDisp=this.mapOriToDisp=[],idxDisp=0;var buildItemMarkup=function(itemIdx){var item=items[itemIdx],nChildren=item.childrenIndices.length,i;mapOriToDisp[itemIdx]=idxDisp++;markup[count++]=itemPrefix||"";markup[count++]=fn(item,itemIdx,this);markup[count++]=itemSuffix||"";for(i=0;i<nChildren;i++){buildItemMarkup.call(this,items[itemIdx].childrenIndices[i]);}};for(rootIdx=0;rootIdx<rootLen;rootIdx++){buildItemMarkup.call(this,rootIndices[rootIdx]);}}markup[count+1]=markupSuffix||"";return markup;},getItemMarkup:function getItemMarkup(item,idx){var markup;if(this.isCollapsibleDisplay()){markup='<{@tag} class="item-ra {@hidden} {@epd}" idx="{@idx}"><div class="lv" style="width: {@lv-width}px;"></div><div class="icn"></div><{@tag} class="item {@cls}" idx="{@idx}" style="{@style}" title="{@title}"title="{@tt}"><span class="icon"></span><span class="branch"></span><span class="text">{@html}<span class="statistic">{@stat}</span></span></{@tag}></{@tag}>';}else{markup=this._super(item,idx);}return markup;},getItemProps:function getItemProp(item,idx){var prop=this._super(item,idx),itemLevel=item.lv,hasChild=item.hcd,isExpanded=item.epd,isCollapsedHidden=item.isCollapsedHidden;if(itemLevel!==undefined){prop["lv-width"]=itemLevel*10;}if(!hasChild){prop.epd="";}else{if(isExpanded){prop.epd=CSS_EXPANDED;}else{prop.epd=CSS_COLLAPSED;}}if(isCollapsedHidden){prop.hidden=CSS_HIDDEN;}if(hasChild){prop.stat="("+this.helper.getAndCacheSelectedDescendantsCount(idx,true)+"/"+this.helper.getAndCacheDescendantsCount(idx)+")";}return prop;},getItemNode:function getItemNode(idx){var mapOriToDisp=this.mapOriToDisp,idxDisp,itemsNode;if(!mapOriToDisp){return ;}idxDisp=mapOriToDisp[idx];itemsNode=this.itemsContainerNode;return(itemsNode&&itemsNode.childNodes[idxDisp])||null;},_getItemNode:function _getItemNode(idx){var itemNode,childNodes,nChildNodes,i;itemNode=this.getItemNode(idx);if(itemNode&&this.hasClass(itemNode,"item-ra")){childNodes=itemNode.childNodes;nChildNodes=childNodes&&childNodes.length;for(i=0;i<nChildNodes;i++){if(this.hasClass(childNodes[i],"item")){itemNode=childNodes[i];break;}}}return itemNode;},onclick:function onclick(evt){var target=evt.getTarget(),item=this.getItemFromTarget(target);if(this.hasClass(target,"icn")&&(this.hasClass(target.parentNode,CSS_EXPANDED)||this.hasClass(target.parentNode,CSS_COLLAPSED))){this.doCollapseExpand(item,evt);this.updateScrollbars();}else{if(this.hasClass(target,"btn")){if(target.parentNode&&this.hasClass(target.parentNode,"btnsBar")&&this.hasClass(target.parentNode,"lv")){onLevelButtonClick.call(this,evt);}else{this.set("isShowAllItems",this.hasClass(target,"availItems"));}}else{if(this.hasClass(target,"branch")){if(item){doBranchSelect.call(this,item,evt);}}else{this._super(evt);}}}},selectionAdded:function selectionAdded(evt){updateSelectedDescendantsCountStatisticInfo.call(this);if(this.helper.isAllItemsSelected()){this.selectedIndices[0]=true;}else{delete this.selectedIndices[0];}updateAllLevelButtonCssClass.call(this);},selectionRemoved:function selectionRemoved(evt){updateSelectedDescendantsCountStatisticInfo.call(this);if(this.helper.isAllItemsSelected()){this.selectedIndices[0]=true;}else{delete this.selectedIndices[0];}updateAllLevelButtonCssClass.call(this);},doCollapseExpand:function doCollapseExpand(item,evt){var target=evt.getTarget(),isDoCollapse=item.epd;this.collapseExpandDescends(item._renderIdx,isDoCollapse);item.epd=!item.epd;$CSS.toggleClass(target.parentNode,CSS_COLLAPSED,isDoCollapse);$CSS.toggleClass(target.parentNode,CSS_EXPANDED,!isDoCollapse);},collapseExpandDescends:function collapseExpandDescends(idx,isDoCollapse){var items=this.items,childrenIndices=items[idx].childrenIndices,nChildren=childrenIndices.length,i,childIndex,childItem,childItemNode;for(i=0;i<nChildren;i++){childIndex=childrenIndices[i];childItem=items[childIndex];childItemNode=this.getItemNode(childIndex);childItem.isCollapsedHidden=isDoCollapse;$CSS.toggleClass(childItemNode,CSS_HIDDEN,isDoCollapse);if(isDoCollapse||(!isDoCollapse&&childItem.epd)){this.collapseExpandDescends(childIndex,isDoCollapse);}}},onwidthChange:function onwidthChange(evt){this._super(evt);if(this.levelButtonsContainerNode){updateLevelButtonsControlBar.call(this);}},getScrollboxHeight:function getScrollboxHeight(){var height=this._super();return height-$DOM.position(this.btnBarNode).h-$DOM.position(this.levelButtonsContainerNode).h;},isCollapsibleDisplay:function isCollapsibleDisplay(){var searchInput=this.searchInput;return this.isShowAllItems&&(!searchInput||searchInput.isClear());},hasClass:function hasClass(node,className){var names=node.className.split(/\s+/),i;for(i=0;i<names.length;i++){if(names[i]===className){return true;}}return false;}});}());