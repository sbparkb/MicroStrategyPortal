(function(){mstrmojo.requiresCls("mstrmojo.hash");var reCHAIN_THIS=/this\.([\w\.\[\]\'\"\-]+)/m,reCHAIN_THIS_TEST=/this\./m,reCHAIN_ALL_BRACKET=/mstrmojo\.all\[[\'\"]([\w]+)[\'\"]\]\.([\w\.\[\]\'\"\-]+)/m,reCHAIN_ALL_BRACKET_TEST=/mstrmojo\.all\[/m,reCHAIN_ALL_DOT=/mstrmojo\.all\.([\w]+)\.([\w\.\[\]\'\"\-]+)/m,reCHAIN_ALL_DOT_TEST=/mstrmojo\.all\./m,reCvtIdxs=/\[(\d+)\]/g,reCvtSingleQts=/\[\'([\w\-]+)\'\]/g,reCvtDblQts=/\[\"([\w\-]+)\"\]/g,reTruncBrkts=/([\[\]].*)/;mstrmojo.Binding=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.Binding",parent:null,source:null,destination:null,enabled:false,setter:"set",executing:0,init:function init(props){mstrmojo.hash.copy(props,this);mstrmojo.registry.add(this);},destroy:function dest(){mstrmojo.publisher.clearSubscriptions(this.id);mstrmojo.registry.remove(this);},exec:function exec(){this.executing++;var fn=this._sourceFn;if(!fn){var s=this.source;if(s!=null){if(typeof (s)=="string"){if(!(s.match("return "))&&!(s.match(/\;\s*\S/))){s="return "+s;}fn=new Function(s);}else{if(typeof (s)=="function"){fn=s;}}this._sourceFn=fn;}}var v,p=this.parent;if(fn){try{v=fn.apply(p,[]);}catch(ex){}}var st=this.setter,d=this.destination;if(st==null){p[d]=v;}else{if(typeof (st)=="string"){p[st](d,v);}else{if(typeof (st)=="function"){st.apply(p,[d,v]);}}}this.executing--;},enable:function en(){if(!this.enabled){this.exec();var chs=this._chains;if(!chs){this._parseChains();chs=this._chains;}for(var k in chs){this._attachChain(chs[k]);}this.enabled=true;}},disable:function dis(){if(this.enabled){var chs=this._chains;if(chs){for(var k in chs){this._detachChain(chs[k]);}}this.enabled=false;}},_chains:null,_parseChains:function(){this._chains={};var chains=this._chains;var s=this.source;if(s&&(typeof (s)=="function")){s=s.toString&&s.toString();}if(!s){return ;}function _findMatches(str,re,hostIdx,partsIdx){var sTemp=str,match;while(match=sTemp.match(re)){var key=match[0],len=key.length,add=true;key=key.replace(reCvtIdxs,".$1").replace(reCvtSingleQts,".$1").replace(reCvtDblQts,".$1").replace(reTruncBrkts,"");for(var k in chains){if(k.substr(0,len)===key){add=false;break;}else{if(key.indexOf(k)===0){delete chains[k];}}}if(add){chains[key]={host:(hostIdx==null)?null:match[hostIdx],parts:match[partsIdx].replace(reCvtIdxs,".$1").replace(reCvtSingleQts,".$1").replace(reCvtDblQts,".$1").replace(reTruncBrkts,"").split(".")};}sTemp=sTemp.substr(match.index+len);}}if(reCHAIN_THIS_TEST.test(s)){_findMatches(s,reCHAIN_THIS,null,1);}if(reCHAIN_ALL_BRACKET_TEST.test(s)){_findMatches(s,reCHAIN_ALL_BRACKET,1,2);}if(reCHAIN_ALL_DOT_TEST.test(s)){_findMatches(s,reCHAIN_ALL_DOT,1,2);}},_attachChain:function attCh(ch,start){if(!ch.evt2idx){ch.evt2idx={};}if(!ch.idx2evt){ch.idx2evt=[];}var evt2idx=ch.evt2idx,idx2evt=ch.idx2evt,parts=ch.parts;var idx=(start>=0)?start:0,bId=this.id,reg=mstrmojo.all,ctxt=(start>0)?reg[idx2evt[idx-1].context][parts[idx-1]]:(ch.host?reg[ch.host]:this.parent),prop=parts[idx];var A=mstrmojo.array;while(ctxt&&prop){if(ctxt.attachEventListener){var evts=ctxt[prop+"_bindEvents"]||(prop+"Change");if(typeof (evts)=="string"){evts=[evts];}var subs=[];for(var i=0,iLen=evts.length;i<iLen;i++){subs[i]=ctxt.attachEventListener(evts[i],bId,"_callback");}for(var i=0;i<evts.length;i++){evt2idx[ctxt.id+"_"+evts[i]]=idx;}idx2evt[idx]={context:ctxt.id,evts:evts,subs:subs};}ctxt=ctxt[prop];prop=ch.parts[++idx];}},_detachChain:function detCh(ch,start){var reg=mstrmojo.all,idx2evt=ch.idx2evt,evt2idx=ch.evt2idx,bId=this.id;var i=(start>-1)?start:0,len=idx2evt.length;if(i<len){for(;i<len;i++){var atts=idx2evt[i];if(!atts){break;}var ctxtid=atts.context,ctxt=reg[ctxtid],evts=atts.evts;if(ctxt&&ctxt.detachEventListener){var s=atts.subs;for(var t=0,tLen=s.length;t<tLen;t++){ctxt.detachEventListener(s[t]);}}idx2evt[i]=null;for(var j=0,jLen=evts.length;j<jLen;j++){delete evt2idx[ctxtid+"_"+evts[j]];}}}},_callback:function clbk(evt){this.exec();if(!evt||!evt.name||!evt.src){return ;}var k=evt.src.id+"_"+evt.name,chains=this._chains;for(var c in chains){var ch=chains[c],idx=ch.evt2idx[k];if(idx!=null){this._detachChain(ch,idx+1);this._attachChain(ch,idx+1);}}}});})();