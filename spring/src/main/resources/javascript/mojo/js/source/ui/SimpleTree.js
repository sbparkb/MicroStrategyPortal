(function(){mstrmojo.requiresCls("mstrmojo._HasScrollbox","mstrmojo.array","mstrmojo.css","mstrmojo.dom","mstrmojo.string","mstrmojo.Widget");var $MOJO=mstrmojo,$ARR=$MOJO.array,$CSS=$MOJO.css,$DOM=$MOJO.dom,$H=$MOJO.hash,$STR=$MOJO.string,CLASS_SELECTED="selected",CLASS_OPEN="open",CLASS_LEAF="leaf",CLASS_LOADING="loading",INDEX_ATTR_DELIMITER=":",ITEM_TAG="li",ITEM_CONTAINER_TAG="ul",INDEX_ATTR="idx",LEVEL_ATTR="level";function buildTreeItemMarkup(item,level,index,childMarkup){var offset=this.renderIndex*this.renderBlockSize,indexArr=index.split(":"),idx=parseInt(indexArr[0],10)+offset,isSelected=!!this.selectedIndices[idx],isExpanded=!!this.expandedIndices[idx],isLeaf=(item.isLeaf||(!this.dataHelper&&!(item.items&&item.items.length)));indexArr[0]=idx;return $STR.apply('<{@tag} class="{@cls}" level="{@level}" idx="{@idx}">{@itemMkp}{@childMkp}</{@tag}>',{tag:ITEM_TAG,cls:(isSelected?CLASS_SELECTED:"")+(isExpanded?" "+CLASS_OPEN:"")+(isLeaf?" "+CLASS_LEAF:""),level:level,idx:indexArr.join(":"),itemMkp:this.itemRenderer.render(item,level,index,this),childMkp:childMarkup||""});}function buildMarkup(items,level,index){var markup=[],count=0,itemRenderer=this.itemRenderer,renderFn=itemRenderer&&itemRenderer.render,itemCount=items&&items.length,currentIndex,serializedIdx,item,i;markup[count++]="<"+ITEM_CONTAINER_TAG+">";if(renderFn&&typeof renderFn==="function"&&itemCount){for(i=0;i<items.length;i++){item=items[i];currentIndex=index.concat([i]);serializedIdx=currentIndex.join(INDEX_ATTR_DELIMITER);markup[count++]=buildTreeItemMarkup.call(this,item,level,serializedIdx,buildMarkup.call(this,item.items,level+1,currentIndex));}}markup[count]="</"+ITEM_CONTAINER_TAG+">";return markup.join("");}function getTreeItemHelper(newItems,indexStack){var firstIndex=indexStack[0];if(indexStack&&indexStack.length===1){return newItems[firstIndex];}return getTreeItemHelper(newItems[firstIndex].items,indexStack.slice(1));}function delegateSelect(mthName,el,item,level,idx,widget){var hook=widget.treeHooks[mthName];if(hook&&hook.call(widget,el,item,level,idx)){return ;}$CSS.toggleClass(el,CLASS_SELECTED,mthName==="select");}function delegateExpand(mthName,el,item,level,idx,widget){var hook=widget.treeHooks[mthName],children=item.items,hasNoItems=(!children||children.length===0),isActionExpand=mthName==="expand",dataHelper=widget.dataHelper;if(hook&&hook.call(widget,el,item,level,idx)){return ;}if(isActionExpand&&!dataHelper&&hasNoItems){$CSS.addClass(el,CLASS_LEAF);return ;}if(isActionExpand&&dataHelper){if(hasNoItems){if(item.tp==="search"){$CSS.toggleClass(el,CLASS_OPEN,isActionExpand);return ;}$CSS.toggleClass(el,CLASS_LOADING,true);dataHelper.fetch(item,{success:function success(res){var newItems=item.items=res.items;if(newItems&&newItems.length>0){el.innerHTML+=buildMarkup.call(widget,newItems,(parseInt(level,10)+1),item._renderIdx.split(INDEX_ATTR_DELIMITER));}else{$CSS.addClass(el,CLASS_LEAF);}},complete:function complete(){$CSS.toggleClass(el,CLASS_LOADING,false);}});}}$CSS.toggleClass(el,CLASS_OPEN,isActionExpand);}mstrmojo.ui.SimpleTree=mstrmojo.declare(mstrmojo.Widget,[mstrmojo._HasScrollbox],{scriptClass:"mstrmojo.ui.SimpleTree",markupString:'<div id="{@id}" class="mstrmojo-SimpleTree {@cssClass}" mstrAttach:click>{@itemsHTML}</div>',markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,onheightChange:mstrmojo.Widget.heightMarkupMethod,onwidthChange:mstrmojo.Widget.widthMarkupMethod},markupSlots:{scrollboxNode:function scrollboxNode(){return this.domNode;}},items:undefined,dataHelper:undefined,treeHooks:{},init:function init(props){this._super(props);this.expandedIndices={};this.selectedIndices={};},buildRendering:function buildRendering(){var items=this.items,length;if(this.renderOnScroll&&this.items){this.renderIndex=0;items=this.items.slice(this.renderIndex,this.renderBlockSize);}length=items&&items.length;this.itemsHTML=length?buildMarkup.call(this,items,0,[]):"";this._super();delete this.itemsHTML;},renderOnScroll:false,_cb_scroll:undefined,renderBlockSize:50,renderIndex:0,onscroll:function onscroll(){if(this.renderOnScroll){var n=this.domNode,h=parseInt(n.style.height,10),max=(this.renderIndex+1)*this.renderBlockSize;if(max>=this.items.length){return ;}if(Math.ceil(h+n.scrollTop)>=n.scrollHeight){this.renderIndex++;var items=this.items.slice(max,max+this.renderBlockSize);this.domNode.innerHTML+=buildMarkup.call(this,items,0,[]);}}},postBuildRendering:function postBuildRendering(){if(!this._cb_scroll){var id=this.id;this._cb_scroll=function scrollCB(){var me=mstrmojo.all[id];me.onscroll();};}mstrmojo.dom.attachEvent(this.scrollboxNode,"scroll",this._cb_scroll);if(this._super){this._super();}},getItemMarkup:function(){return'<{@tag} class="{@cls}" style="{@style}">{@n}</{@tag}>';},getItemProps:function getItemProps(item,level,index){return{tag:"div",cls:"item ",n:item.n||"",style:"",idx:index};},itemRenderer:{render:function(item,level,idx,widget){item._renderIdx=idx;item._renderLvl=level;return $STR.apply(widget.getItemMarkup(item,level,idx),widget.getItemProps(item,level,idx));},select:function select(el,item,level,idx,widget){delegateSelect("select",el,item,level,idx,widget);},unselect:function unselect(el,item,level,idx,widget){delegateSelect("unselect",el,item,level,idx,widget);},expand:function expand(el,item,level,idx,widget){delegateExpand("expand",el,item,level,idx,widget);},collapse:function collapse(el,item,level,idx,widget){delegateExpand("collapse",el,item,level,idx,widget);}},_set_items:function stitems(propName,propValue){var oldItems=this.items;this.items=propValue;if(oldItems!==propValue){var hasRendered=this.hasRendered;if(hasRendered){this.unrender(false);}if(hasRendered){this.render();}return true;}return false;},getTreeItem:function getTreeItem(index){if(index!==null){return getTreeItemHelper(this.items,index.split(INDEX_ATTR_DELIMITER));}},getLeafNode:function getLeafNode(index){var nodes=this.domNode.children[0].children;if((index>=0)&&(index<nodes.length)){return nodes[index];}},addChild:function addChild(index,items){var $this=this,parentItems=$this.getTreeItem(index).items,indexArray=index.split(INDEX_ATTR_DELIMITER);indexArray.push(parentItems.length);if(this.hasRendered){var treeNodes=this.domNode.getElementsByTagName(ITEM_TAG);$ARR.forEach(treeNodes,function(treeNode){if(treeNode.getAttribute(INDEX_ATTR)===index){var currentItem=items[0];var div=document.createElement("div");div.innerHTML=buildTreeItemMarkup.call($this,currentItem,parseInt(treeNode.getAttribute(LEVEL_ATTR),10)+1,indexArray.join(INDEX_ATTR_DELIMITER),buildMarkup.call($this,currentItem.items,parseInt(treeNode.getAttribute(LEVEL_ATTR),10)+2,indexArray));treeNode.lastChild.appendChild(div.firstChild);parentItems.push(currentItem);return false;}return true;});}},updateChild:function updateChild(index,nodeData){var $this=this;$H.copy(nodeData,$this.getTreeItem(index));if(this.hasRendered){var treeNodes=this.domNode.getElementsByTagName(ITEM_TAG);$ARR.forEach(treeNodes,function(treeNode){if(treeNode.getAttribute(INDEX_ATTR)===index){var level=parseInt(treeNode.getAttribute(LEVEL_ATTR),10);treeNode.innerHTML=$this.itemRenderer.render(nodeData,level,index,$this)+buildMarkup.call($this,nodeData.items,level+1,index.split(INDEX_ATTR_DELIMITER));return false;}return true;});}},toggleChildSelection:function toggleChildSelection(index,select){var treeNodes=this.domNode.getElementsByTagName(ITEM_TAG);$ARR.forEach(treeNodes,function(treeNode){if(treeNode.getAttribute(INDEX_ATTR)===index){$CSS.toggleClass(treeNode,CLASS_SELECTED,select);this.selectedIndices[index]=select;return false;}return true;},this);},removeChild:function removeChild(index){var indexArray=index.split(INDEX_ATTR_DELIMITER),level=indexArray.length,lastIndex=indexArray[level-1],parentItem=this;if(level>1){indexArray=indexArray.splice(0,level-1);parentItem=this.getTreeItem(indexArray.join(INDEX_ATTR_DELIMITER));parentItem.items.splice(lastIndex,1);this.updateChild(parentItem._renderIdx,parentItem);}else{this.items.splice(lastIndex,1);this.refresh();}},getItemWithPropName:function getItemWithPropName(newItems,propName,propValue){var index=$ARR.find(newItems,propName,propValue);var i,returnVal=[];if(index!==-1){returnVal.push(newItems[index]);}for(i=0;i<newItems.length;i++){var currentItems=newItems[i].items;if(currentItems&&currentItems.length){var childItems=this.getItemWithPropName(currentItems,propName,propValue);if(childItems&&childItems.length){returnVal=returnVal.concat(childItems);}}}return returnVal;},onclick:function onclick(evt){try{var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),targetTag=target.tagName.toLowerCase(),item=$DOM.findAncestorByAttr(target,INDEX_ATTR,true,this.domNode),level=item&&item.node.getAttribute(LEVEL_ATTR),idx=item&&item.value;if(targetTag===ITEM_CONTAINER_TAG){return ;}if(idx!==null&&!isNaN(parseInt(level,10))){var config={sel:{indicesName:"selected",enabledFn:"select",disabledFn:"unselect"},ex:{indicesName:"expanded",enabledFn:"expand",disabledFn:"collapse"}}[(targetTag!==ITEM_TAG)?"sel":"ex"];var indices=this[config.indicesName+"Indices"],isActionEnabled=indices[idx];if(isActionEnabled){delete indices[idx];}else{indices[idx]=true;}this.itemRenderer[isActionEnabled?config.disabledFn:config.enabledFn](item.node,this.getTreeItem(idx),level,idx,this);}}catch(ex){mstrApp.onerror(ex);}}});}());