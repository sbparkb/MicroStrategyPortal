(function(){mstrmojo.requiresCls("mstrmojo.maps.jsmap.AndroidMap","mstrmojo.maps.jsmap.AndroidDocMapInfoWindow","mstrmojo.Overlay","mstrmojo.hash","mstrmojo.array","mstrmojo.dom");var $DOM=mstrmojo.dom;mstrmojo.maps.jsmap.AndroidDocMap=mstrmojo.declare(mstrmojo.maps.jsmap.AndroidMap,[mstrmojo._Formattable],{scriptClass:"mstrmojo.maps.jsmap.AndroidDocMap",cssClass:"mstr-googleMapView",formatHandlers:{domNode:["left","top","z-index","height","width","border","border-color","border-style","border-width"]},sc:null,getMapModel:function getMapModel(){var d=this.doc,m=d.model,pid=mstrApp.getCurrentProjectId(),sessions=mstrApp.serverProxy.getSessions();return{pid:pid,sessions:sessions,model:this.model,docData:{did:d.did,ttl:d.ttl,st:d.st,mid:m.mid,bs:m.bs,data:m.data,defn:m.defn},cfg:mstrApp.getConfiguration().getConfiguration()};},postBuildRendering:function postBuildRendering(){this._touchListener=mstrmojo.touchManager.attachEventListener("touchesBegin",this.id,function(evt){var openInfoWindow=this.openedInfoWindow;if(openInfoWindow){if(!$DOM.contains(this.domNode,evt.touch.target,true,document.body)&&!mstrApp.isDialogUp()){openInfoWindow.close();}}});return this._super();},destroy:function destroy(ignoreDom){var listener=this._touchListener;if(listener){mstrmojo.touchManager.detachEventListener(listener);delete this._touchListener;}this._super(ignoreDom);},setModel:function setModel(d){this.doc=d.controller.view;this._super(d);},initFromVisProps:function initFromVisProps(vp){this._super(vp);if(!vp){return ;}this.iwDocLayout=(parseInt(vp.dl,10)===1);if(vp.lyt){this.iwLayoutKey=vp.lyt;}},findSelectorTarget:function findSelectorTarget(sc){if(sc&&sc.tks){var dm=this.model.docModel,targets=sc.tks.split("\u001E"),i=0,len=targets.length;for(i=0;i<len;++i){var d=dm.getTargetDefn(targets[i]);if(d[targets[i]].ifw){return targets[i];}}}},showInfoWindow:function showInfoWindow(mp,mkr,w){this.openedInfoWindow=w;w.open(mp,mkr);},getInfoWindow:function getInfoWindow(map,marker){var gd=this.gridData;if(this.iwDocLayout){this.getInfoWindowFromLayout(gd,map,marker,this.showInfoWindow);}else{var sc=this.getInfoWindowSelectorControl(gd),firstInfoWinKey=this.findSelectorTarget(sc);if(!(!!sc&&firstInfoWinKey)){return this.getDefaultInfoWindow(gd,marker);}}},getInfoWindowFromLayout:function getInfoWindowFromLayout(d,map,marker,callback){var ths=this,doc=this.doc,layouts=doc.getLayouts(),lyt=this.iwLayoutKey,layout=layouts[mstrmojo.array.find(layouts,"k",lyt)],sep="\x1F",dssXmlTypeAttribute="12",gbIDs=marker.attrid+sep+dssXmlTypeAttribute+sep+marker.eid;var taskParams={layoutKey:lyt,groupByIDs:gbIDs};doc.selectLayout(layout,(lyt!==doc.model.currlaykey),{complete:function(){layout.defn.loaded=false;doc.getNewLayout(taskParams,layouts,false,{complete:function(){mstrApp.hideMessage();},submisson:function(){mstrApp.showMessage();},success:function(res){var node=res.node,overlay,content=document.createElement("div"),contentStyle=content.style,w=node.defn.fmts.width,h=node.defn.fmts.height||node.data.mh;overlay=new mstrmojo.Overlay({children:[res]});overlay.set("width",w);overlay.set("height",h);var cn=document.createElement("div");overlay.placeholder=cn;overlay.render();contentStyle.overflow="hidden";content.appendChild(overlay.domNode);var win=new google.maps.InfoWindow({content:content});ths.openedInfoWindow=win;win.open(map,marker);var INTERVAL=300,t=0,ti=window.setInterval(function(){var n=content.parentNode;if(n){var ow=n.offsetWidth,oh=n.offsetHeight;if(ow!==parseInt(w,10)||oh!==parseInt(h,10)){overlay.setDimensions(oh+"px",ow+"px");window.clearTimeout(ti);}}t+=INTERVAL;if(t>10*INTERVAL){window.clearTimeout(ti);}},INTERVAL);}},true);}});},getInfoWindowSelectorControl:function getInfoWindowSelectorControl(d){if(!this.sc){this.sc=d.gts.row[0].sc;}return this.sc;},postHandleMarkerClick:function postHandleMarkerClick(map,marker){var d=this.gridData,sc=this.getInfoWindowSelectorControl(d);if(sc&&sc.tks){var ths=this,dataCacheUpdate=null,dm=ths.model.docModel,dataService=dm.getDataService(),action=dataService.getSelectorElementsAction({ck:sc.ck,eid:marker.eid,ctlKey:sc.ckey,include:sc.include});dataService.submitUpdates(action,{success:function(res){var tgtDefs=dm.getTargetDefn(sc.tks);if(res.pukeys){tgtDefs=dm.getTargetDefn(res.pukeys);}dataCacheUpdate=dm.updateDataCache(res.data,tgtDefs);var firstInfoWinKey=ths.findSelectorTarget(sc);if(firstInfoWinKey){var targetDef=dm.getTargetDefn(firstInfoWinKey),psId="*l"+res.currlaykey+"*k"+firstInfoWinKey+"*x1*t"+dm.buildTime,id=psId+"_ifw",widget=mstrmojo.all[id];if(widget){widget.destroy();}var ifw=new mstrmojo.maps.jsmap.AndroidDocMapInfoWindow({id:id,parent:ths,builder:ths.builder,model:dm,psKey:firstInfoWinKey,psId:psId});var fmts=targetDef[firstInfoWinKey].fmts,content=document.createElement("div"),contentStyle=content.style,w=fmts.width,h=fmts.height;ifw.set("width",w);ifw.set("height",h);var cn=document.createElement("div");ifw.placeholder=cn;ifw.render();contentStyle.height=h;contentStyle.width=w;contentStyle.overflow="hidden";content.appendChild(ifw.domNode);var iw=new google.maps.InfoWindow({content:content});var fnClose=iw.close;iw.close=function(){fnClose.call(iw);ifw.destroy();delete ths.openedInfoWindow;};ths.openedInfoWindow=iw;iw.open(map,marker);var INTERVAL=300,t=0,ti=window.setInterval(function(){var n=content.parentNode;if(n){var ow=n.offsetWidth,oh=n.offsetHeight;if(ow!==parseInt(w,10)||oh!==parseInt(h,10)){ifw.setDimensions(oh+"px",ow+"px");window.clearTimeout(ti);}}t+=INTERVAL;if(t>10*INTERVAL){window.clearTimeout(ti);}},INTERVAL);}var ue={name:"partialUpdate",tree:res.data,ids:dataCacheUpdate};if(!mstrmojo.hash.isEmpty(ue.ids.ifws)){delete ue.ids.ifws[firstInfoWinKey];}dm.raiseEvent(ue);}},{config:mstrmojo.DocDataService.PROGRESS_CONFIG,params:{onAndroid:true}});}}});}());