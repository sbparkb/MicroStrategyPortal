(function(){mstrmojo.requiresCls("mstrmojo.VisChart");var DEFAULT_DARK_THEME=1;var DEFAULT_LIGHT_THEME=2;var CUSTOM_DARK_THEME=3;var CUSTOM_LIGHT_THEME=4;mstrmojo.VisMicroChartLine=mstrmojo.declare(mstrmojo.VisChart,null,{scriptClass:"mstrmojo.VisMicroChartLine",isDrawAxis:false,margin:{t:5,r:2,b:1,l:2},showHighlightLine:false,themeColor:"#FFFFFF",isDrawRefArea:true,noBackground:true,isAnimateLines:false,toolTipMain:null,mainWidth:0,mainLeftPos:0,reDrawChart:function reDrwchart(){var context=this.context,canvas=this.canvas,wd=canvas.width,ht=canvas.height;context.clearRect(0,0,wd,ht);this.data.processLinearData(this);this.windowSize=this.model.series[0].rv.length;this.utils.fillBackground(this);if(this.windowSize<=1){return ;}this.drawChart();},setColorByTheme:function setColorByTheme(){var lineProps=this.config;if(this.theme===DEFAULT_DARK_THEME||this.theme===DEFAULT_LIGHT_THEME){this.startPointColor="#50B5D8";this.endPointColor="#50B5D8";this.otherPointColor="#50B5D8";this.isDrawRefArea=false;this.sparkLineColor="#50B5D8";this.refLineColor="#FF781D";}else{this.startPointColor="#000000";this.endPointColor="#FF0000";this.otherPointColor="#663300";this.isDrawRefArea=lineProps.mbRefArea;this.sparkLineColor=lineProps.mwSeriesLineCol||"#333333";this.refLineColor=lineProps.mwRefLineCol||"#0066ff";}var dpi=mstrMobileApp.getDeviceDPI();this.sparkLineWidth=dpi>160?2:1;this.refLineWidth=1;this.startEndPointRadius=dpi>=320?4:dpi>=240?3:2;},drawChart:function drwchrt(){this.setColorByTheme();var lineProps=this.config;var context=this.context;var model=this.model;var values=model.series;var mvalues=model.mvalues;var margin=this.margin;var height=this.getHeight();var width=this.getWidth();var utils=this.utils;var maxVR=mvalues[mvalues.length-1];var minVR=mvalues[0];var maxYValue=mvalues[mvalues.length-1];var minYValue=mvalues[0];this.drawRefLine=false;if(this.refv&&this.refv.length>1&&lineProps.mbRefLine){var refValue=parseFloat(this.refv[1].rv);if(isNaN(refValue)){this.drawRefLine=false;}else{this.drawRefLine=true;if(refValue>maxVR){maxVR=refValue;if(mvalues.length===1){mvalues[1]=maxVR;}else{mvalues[mvalues.length-1]=maxVR;}}if(refValue<minVR){minVR=refValue;if(mvalues.length===1){mvalues[1]=mvalues[0];mvalues[0]=maxVR;}else{mvalues[0]=minVR;}}}}this.themeColor=lineProps.mwRefAreaCol||"#dedede";this.isDrawStartEndPoints=lineProps.mbAllPoints?7:(lineProps.mbEndPoints?3:0);if(this.isDrawStartEndPoints&1&&margin.l<this.startEndPointRadius){margin.l=this.startEndPointRadius;}if(this.isDrawStartEndPoints&2&&margin.r<this.startEndPointRadius){margin.r=this.startEndPointRadius-1;}if(model.err){return ;}if(!values){return ;}if(maxVR!==minVR){this.RTY=(height-margin.t-margin.b-4)/(maxVR-minVR);}else{this.RTY=0;}if(this.windowSize!==1){this.RTX=(width-margin.l-margin.r-1)/(this.windowSize-1);}else{this.RTX=0;}var lines=[];for(var i=0;i<this.windowSize;i++){var val=parseFloat(values[0].rv[i]);if(isNaN(val)){lines[i]=null;continue;}var x=(i*this.RTX)+margin.l;var y=utils.getYValue(this,val);lines[i]={x:x,y:y};}if(lines.length===0){return ;}maxYValue=utils.getYValue(this,maxYValue);minYValue=utils.getYValue(this,minYValue);if(maxYValue===undefined||minYValue===undefined){maxYValue=height-4-margin.b;minYValue=margin.t;}if(this.isDrawRefArea){context.fillStyle=this.themeColor;context.fillRect(margin.l,minYValue,width-margin.r-margin.l,(maxYValue-minYValue));}context.lineCap="round";context.lineWidth=this.sparkLineWidth;context.lineJoin="round";context.strokeStyle=this.sparkLineColor;utils.drawLineSet(this,lines,false,context);if(this.isDrawStartEndPoints){utils.drawStartEndPoints(this,lines,context,this.isDrawStartEndPoints);}if(this.drawRefLine){var y=this.utils.getYValue(this,refValue);if(context.lineWidth%2===1){y=Math.round(y+0.5)-0.5;}context.beginPath();context.moveTo(margin.l,y);context.lineTo(width-margin.r,y);context.lineWidth=this.refLineWidth;context.strokeStyle=this.refLineColor;context.stroke();}},highlightPoint:function hghlghtpnt(x,touchY){var me=this,ctx=me.highlightContext,height=me.getHeight(),width=me.getWidth(),margin=me.margin,model=me.model,utils=me.utils;ctx.clearRect(0,0,width,height);if(x<0){return ;}var xcoord=(x*me.RTX)+margin.l;ctx.globalAlpha=1;ctx.strokeStyle=this.sparkLineColor;ctx.fillStyle=ctx.strokeStyle;var y=utils.getYValue(me,model.series[0].rv[x]);if(xcoord<5){xcoord=5;}if(xcoord>width-5){xcoord=width-5;}if(y<5){y=5;}if(y>height-5){y=height-5;}ctx.strokeStyle="FFFFFF";ctx.fillStyle=ctx.strokeStyle;ctx.globalAlpha=0.8;utils.drawArc(this,xcoord,y,5,0,Math.PI*2,true,true,ctx);ctx.strokeStyle=this.sparkLineColor;ctx.fillStyle=ctx.strokeStyle;ctx.globalAlpha=1;utils.drawArc(me,xcoord,y,5,0,Math.PI*2,true,false,ctx);utils.drawArc(me,xcoord,y,2.5,0,Math.PI*2,true,true,ctx);this.highlightCanvas.id="highLightCav"+this.widget.domNode.id;},renderTooltip:function rndrttp(valIndex,touchX,touchY){ttp=this.widget._tooltip;if(valIndex<0){ttp.toggle(false);return ;}var highLightCav=document.getElementById("highLightCav"+this.widget.domNode.id);if(highLightCav){var highlightCt=highLightCav.getContext("2d");highLightCav.id="";highlightCt.clearRect(0,0,1000,1000);}var me=this,m=this.model,s=m.series,series=s[0],utils=this.utils,l=s.length,si=this.seriesIndex,ch=m.colHeaders,rh=this.baseModel.rowHeaders,margin=this.margin,metrics=m.mtrcs.items;if(isNaN(this.kpiOffset)){this.kpiOffset=0;}var displayInfos=[];displayInfos.push({n:m.categories.tn,v:m.categories.items[valIndex]});if(this.widget.sparklineProps.mstrAssMetric){displayInfos.push({n:this.widget.sparklineProps.mstrAssMetric,v:series.v[valIndex]});}else{displayInfos.push({n:metrics[this.kpiOffset],v:series.v[valIndex]});}if(this.refv&&this.refv.length>1&&this.config.mbRefLine){displayInfos.push({n:metrics[this.kpiOffset+1],v:this.refv[1].v});}ttp.displayInfo(displayInfos);ttp.toggle(true);ttp.setBorderColor(this.sparkLineColor);ttp.domNode.style.visibility="hidden";var posWdt=mstrmojo.dom.position(this.widget.domNode,true),zf=this.utils.getScreenZoomFactor(),offset=Math.round(45*zf);utils.positionTooltip(ttp.domNode,{x:touchX-posWdt.x,y:touchY-posWdt.y},this.widget.domNode,offset);ttp.domNode.style.visibility="visible";},isTouchPointInGraphRange:function tpInGR(touchX,touchY){var margin=this.margin;if(touchX<margin.l||touchY<margin.t||touchY>this.canvas.height-margin.b){return false;}return true;},showTooltip:function handleTouchMove(touchX,touchY){if(!this.config.mbShowTooltip){return false;}var me=this,m=me.model;if(m.series[0].rv.length<=1){return false;}var pos=mstrmojo.dom.position(this.domNode,true),touchXInChart=touchX-pos.x,touchYInChart=touchY-pos.y;if(!this.isTouchPointInGraphRange(touchXInChart,touchYInChart)){return false;}var touchVal=me.getTouchValue(touchXInChart,touchYInChart);var margin=this.margin;if(touchVal!==null){var x=(touchVal*me.RTX)+margin.l;if(me.widget.enableSmoothScroll){if(this.domNode.offsetLeft+x<this.widget._scroller.origin.x){return false;}}var rns=(m.rne-m.rns>1)?m.rns:m.rns-1;if(me.seriesIndex===-1||me.switchSeriesOnTouch){me.seriesIndex=me.utils.getSeriesIndexAndYValue(me,rns+touchVal,touchYInChart).si;}if(m.series[me.seriesIndex].rv[rns+touchVal]===""){return false;}me.prevHighlight=me.currentHighlight;me.currentHighlight=touchVal;if(!me.widget.tooltipShow||me.prevHighlight!=me.currentHighlight){me.renderTooltip(touchVal,touchX,touchY);me.highlightPoint(touchVal,touchY);}return true;}}});})();