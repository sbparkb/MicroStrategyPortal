(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.rw.UnitContainer","mstrmojo.vi.ui.rw.selectors._HasFilterContextMenu","mstrmojo.vi.ui.TargetSelector","mstrmojo.Label","mstrmojo.dom","mstrmojo.css","mstrmojo.func","mstrmojo.tooltip","mstrmojo.vi.ui._CanDropFromSchema","mstrmojo.vi.models.EnumDragSources","mstrmojo.models.FormatModel","mstrmojo.EnumRWUnitType");var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$FUNC=mstrmojo.func,ITEM_SEPARATOR="\u001E",$RW_UNIT_TYPES=mstrmojo.EnumRWUnitType,$FORMAT_MODEL=mstrmojo.models.FormatModel,$GET_FORMAT_OBJ=$FORMAT_MODEL.getFormatUpdate,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$STYLES=mstrmojo.DocSelector.STYLES;function isNotDimensional(item){return item&&item.did!=="-1"&&item.t!==14;}function getDragItem(context){var dragData=context.getCtxtDragData();return(dragData.items||[]).filter(isNotDimensional)[0];}function isValidDragSource(context){var dragData=context.getCtxtDragData();return dragData.src&&(dragData.items||[]).some(isNotDimensional);}function selectorHasSource(){return !!this.boxContent.defn.srcid;}function getSelectorSourceUnit(){var srcid=this.boxContent.defn.srcid,units=this.model.getDatasetUnits(["att","mx"],function(unit){return unit.did===srcid;});return(units.length&&units[0])||null;}function showTargetSelector(isSelectMode){var targetSelector=this.targetSelector=new mstrmojo.vi.ui.TargetSelector({alias:"targetSelector",orientation:this.orientation,hostId:this.id});this.showControlOverlay([targetSelector]);if(isSelectMode){targetSelector.enterSelectMode();}else{targetSelector.enterPreSelectMode();}}function updateTargetSelector(){if(selectorHasSource.call(this)){if(!this.targetSelector){this.targetSelector=new mstrmojo.vi.ui.TargetSelector({alias:"targetSelector",orientation:this.orientation,hostId:this.id});}var targetSelector=this.targetSelector;if(this.getTargetKeys().length>0){targetSelector.enterOffMode();this.hideControlOverlay();}else{this.showControlOverlay([targetSelector]);targetSelector.enterPreSelectMode();}}}function canAutoChangeOrientation(){return !this.defn.ob;}function toggleTooltip(show){this.domNode.setAttribute("title",show?this.getDisplayName():"");this.set("useRichTooltip",show);}function toggleOrientationClass(){$CSS.toggleClass(this.domNode,"horizontal",!!this.defn.horiz);}mstrmojo.vi.ui.rw.FilterBox=mstrmojo.declare(mstrmojo.vi.ui.rw.UnitContainer,[mstrmojo.vi.ui.rw.selectors._HasFilterContextMenu,mstrmojo.vi.ui._CanDropFromSchema],{scriptClass:"mstrmojo.vi.ui.rw.FilterBox",init:function init(props){this._super(props);$CSS.addWidgetCssClass(this,"mstrmojo-FilterBox");},targetSelector:null,useRichTooltip:true,isDynamicTooltip:true,onclick:function onclick(evt){var isPrimary=$DOM.isPrimaryMouseBtn(evt.e),hasSource=selectorHasSource.call(this),clickedContainer=$DOM.contains(this.containerNode,evt.getTarget(),true,this.domNode),selectFilterOption;if(isPrimary&&hasSource){if(clickedContainer){selectFilterOption=true;evt.e.ptvSelected=true;}else{if(!$DOM.contains(this.titlebarNode,evt.getTarget(),true,this.domNode)){evt.e.ptvSelected=true;}}}this._super(evt);if(selectFilterOption){this.getEditorModel().selectTargetByValue(mstrmojo.vi.models.editors.FilterEditorModel.SELECTOR_VALUE);}},moveTooltip:function moveTooltip(evt,win){this.domNode.removeAttribute("title");var targetWidget=$DOM.findWidget(evt.target);if(targetWidget.id!==this.boxContent.id){return ;}this.richTooltip={posType:mstrmojo.tooltip.POS_TOPLEFT,cssClass:"vi-regular vi-tooltip-A",content:this.getDisplayName(),top:evt.clientY+15,left:evt.clientX-15};this._super(evt,win);},postBuildRendering:function postBuildRendering(){toggleOrientationClass.call(this);this._super();this.generateToolbar();if(!selectorHasSource.call(this)){this.boxContent.set("visible",false);this.showControlOverlay([{scriptClass:"mstrmojo.Label",cssClass:"dropMsg",text:mstrmojo.desc(13258,"Drag object here.")}]);}else{if(!this.getTargetKeys().length){showTargetSelector.call(this);}}if(!this.showTitleBar){var src=getSelectorSourceUnit.call(this);this.set("title",(src&&src.n)||"");}if(this.model){$CSS.toggleClass(this.domNode,"items-fit-content",this.model.itemsFitContent);}},onRender:function onRender(){toggleTooltip.call(this,!this.showTitleBar);},orientationHasChanged:function orientationHasChanged(){if(canAutoChangeOrientation.call(this)){var orientation=this.orientation,isHorizontal=orientation==="h",filter=this.boxContent.content;filter.isHoriz=isHorizontal;filter.set("orientation",orientation);this.defn.horiz=isHorizontal;toggleOrientationClass.call(this);}},addFormatProps:function addFormatProps(action,skipPartialRetrieval){action=this._super(action,skipPartialRetrieval);var orientation=this.orientation;if(this.boxContent.content.orientation!==orientation&&canAutoChangeOrientation.call(this)){action=action||this.model.getUnitFormatAction(this,NaN,null,skipPartialRetrieval);mstrmojo.models.FormatModel.getFormatUpdate(mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES.CONTROL_ORIENTATION,orientation==="v"?0:1,action.format);this.defn.horiz=orientation==="h";if(!skipPartialRetrieval){window.setTimeout(function(){this.parent.rebuildChild(this);}.bind(this),0);}}return action;},createDeleteUpdate:function createDeleteUpdate(){var model=this.model;update=model.getRemoveControlUpdate(this.k,this.parent.k,this.defn.tks||"");if(this.defn.tks&&this.boxContent.isSelectAll&&!this.boxContent.isSelectAll()){update.setTreesToRender(3);}update.addUpdate(model.associatedNodesUpdate(this.parent.children));return update;},updateToolbar:function updateToolbar(cfg){var docSelector=this.boxContent,targetSelector=this.targetSelector;updateTargetSelector.call(this);if(this.canShowDesignMenuItems()&&docSelector&&selectorHasSource.call(this)){this.addModeMenuItems(cfg,docSelector);cfg.addSeparator();this.addClearFilterMenuItem(cfg,docSelector);cfg.addSeparator();this.addQualMenuItems(cfg,docSelector);this.addFilterStyleMenuItem(cfg,docSelector);this.addMultiSelectMenuItem(cfg,docSelector);cfg.addSeparator();this.addMenuItemIfSelectTargetsValid(cfg,docSelector,mstrmojo.desc(12288,"Target the following visualizations or filters:"));cfg.addSeparator();this.addToggleTitleMenuItem(cfg);}return this._super(cfg);},showControlOverlay:function showControlOverlay(controls,cssClass){this._super(controls,cssClass);$CSS.addClass(this.domNode,"overlay");},hideControlOverlay:function hideControlOverlay(){this._super();$CSS.removeClass(this.domNode,"overlay");},addContextMenuItems:function addContextMenuItems(menuCfg,evt){this._super(menuCfg,evt);if(selectorHasSource.call(this)){this.addMenuItemIfSelectTargetsValid(menuCfg,this.boxContent,mstrmojo.desc(12288,"Target the following visualizations or filters:"),false);}return menuCfg;},getFormatMenuItemTarget:function getFormatMenuItemTarget(formatData){if(!formatData||!$DOM.contains(this.titlebarNode,formatData.getTarget(),true,this.domNode)){return mstrmojo.vi.models.editors.FilterEditorModel.SELECTOR_VALUE;}return this._super(formatData);},getTargetInfo:function getTargetInfo(){var parent=this.parent,types=[$RW_UNIT_TYPES.GRID,$RW_UNIT_TYPES.GRAPH,$RW_UNIT_TYPES.MOJOVISUALIZATION].concat(this.model.isFromSolrCube(this.boxContent.defn.srcid)?[]:[$RW_UNIT_TYPES.SELECTOR]),targetItems=parent.getTargetKeysByType(types).map(function(key){var unit=parent.getUnitByKey(key);return{n:unit.getDisplayName(),id:key,st:unit.defn.style};}).filter(function(item){return(item.id!==this.k&&item.st!==$STYLES.ATTR_QUAL);},this);return{keys:this.getTargetKeys(),items:targetItems};},toggleTitleBar:function toggleTitleBar(isVisible){this._super(isVisible);toggleTooltip.call(this,!isVisible);},getDisplayName:function getDisplayName(){return this._super()||mstrmojo.desc(6189,"Filter");},updateDisplayName:function updateDisplayName(displayText,oldDisplayText){this._super(displayText,oldDisplayText,true);},getAvatarCls:function getAvatarCls(){return this._super().concat(["filterAvatar"]);},allowDropFromDataset:function allowDropFromDataset(context){return !selectorHasSource.call(this)&&isValidDragSource(context)&&mstrApp.allowWebDashboardDesign();},dropFromDataSource:function dropFromDataSource(context){var item=getDragItem.call(this,context),id=this.id,ctrlStyle,heightMove,height;if(item){var model=this.getDocModel(),dataService=model.getDataService(),definition=this.defn,targetKeys=this.getTargetKeys(),updateKeys=[this.k].concat(targetKeys),docSelector=this.boxContent,ctrlHasNoSource=!selectorHasSource.call(this),actions=(context.actions||[]).concat([dataService.getSetCtrlSourceAction(definition.ck,item.did,item.t)]),callback=$FUNC.wrapMethods(context.callback,{success:function(res){var filterBox=mstrmojo.all[id];model.partialUpdate(res.data,model.getTargetDefn(updateKeys.join(ITEM_SEPARATOR)),res.defn,[docSelector.defn.ckey]);filterBox=filterBox.parent.rebuildChild(filterBox);if(ctrlHasNoSource){filterBox.hideControlOverlay();delete filterBox.targetSelector;}filterBox.boxContent.set("visible",true);filterBox.generateToolbar();if(!targetKeys.length){showTargetSelector.call(filterBox);}}});ctrlStyle=model.getCtrlStyleFromDatasetUnit(item);actions=actions.concat(model.getCtrlActionsByStyle(item,docSelector.ck,ctrlStyle,this.orientation==="v"?0:1,parseInt(this.height,10),parseInt(this.width,10)));height=this.height;heightMove=0;if(item.t===4){actions.push(model.getUnitFormatAction(this,5,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.SHOW_TITLE_BAR,true)));if(height==="40px"){heightMove=20;}}if(this.orientation==="h"){var filterPanel=this.parent,boxCfg=filterPanel.boxLayoutConfig,box=boxCfg.box,filterBox=box&&box.children&&box.children[boxCfg.getBoxPath(this)];heightMove=heightMove+model.getICSCtrlMoveHeightByStyle(ctrlStyle);if(filterBox&&filterBox.f){filterBox.l=filterBox.l+heightMove;actions=actions.concat(filterPanel.getChildPositionActions(true));actions=actions.concat(filterPanel.getBoxLayoutActions(true));}}model.submitDataDefnUpdate(actions,callback);}},dropFromDataset:function dropFromDataset(context){this.dropFromDataSource(context);},dropFromAllObjects:function dropFromAllObjects(context){this.augmentDropContextForSchema(context,this.getDocModel());this.dropFromDataSource(context);},setTargets:function setTargets(keys){this.getDocModel().changeFilterTargets(this,this.getTargetKeys(),keys,true,true);},getTargetKeys:function getTargetKeys(){var keys=this.defn.tks;return(keys&&keys.split(ITEM_SEPARATOR))||[];},getTitleBarCfg:function getTitleBarCfg(){var cfg=this._super();cfg.titleEdited=function titleEdited(titleText,textChanged,oldText){var box=this.parent,callback={success:function success(appliedTitle){box.defn.ttl=appliedTitle;box.set("title",appliedTitle);},failure:function failure(err){mstrApp.onerror(err);box.titleBar.set("title",oldText);}};if(textChanged){var model=box.getDocModel();model.updateTitle(titleText,this.title,box.k,model.currlaykey,"ttl",callback);}};return cfg;},applyCSSFormatToNode:function applyCSSFormatToNode(slotName,formats){var boxContent=this.boxContent;if(boxContent&&boxContent.content&&boxContent.content.hasRendered){var oldValue=boxContent._inSyncPhase;boxContent._inSyncPhase=true;boxContent.content.refresh();boxContent._inSyncPhase=oldValue;}this._super(slotName,formats);},getBoxConfiguration:function getBoxConfiguration(){var boxConfig=this._super();if(this.showTitleBar){boxConfig=mstrmojo.hash.clone(boxConfig);boxConfig.f.v+=20;}return boxConfig;}});mstrmojo.vi.ui.rw.FilterBox.boxConfiguration={f:{h:150,v:42},o:"v"};}());