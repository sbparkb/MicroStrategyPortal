(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo._HasOwnAvatar","mstrmojo.css","mstrmojo.dom");var $CSS=mstrmojo.css,$DOM=mstrmojo.dom;function getTargetRow(context){var node=context.src.node,rows=this.children.filter(function(thresholdRow){return $DOM.contains(thresholdRow.domNode,node,true,this.domNode);});return rows[0];}function getIndexByMousePosition(context){var tgt=context.tgt,rows=this.children,mousePos=$DOM.getMousePosition(tgt.e,tgt.hWin),insertRowPos,insertRowIdx,row,insertRowY,insertRowH,midY,mouseY=mousePos.y;for(var i=rows.length-1;i>=0;i--){row=rows[i];insertRowPos=$DOM.position(row.domNode);insertRowH=insertRowPos.h;insertRowY=insertRowPos.y;midY=insertRowY+insertRowH/2;if(midY<mouseY&&(i===rows.length-1||mouseY<=insertRowY+insertRowH)){insertRowIdx=i;break;}else{if((i===0||insertRowY<mouseY)&&mouseY<=midY){insertRowIdx=i-1;break;}}}return insertRowIdx;}function getCSSClassByIndex(idx){return idx===-1?"top":"bottom";}mstrmojo.threshold.ThresholdRowPanel=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasOwnAvatar],{scriptClass:"mstrmojo.threshold.ThresholdRowPanel",dropZone:true,draggable:true,restrictedToAxis:"y",avatarCssClass:"threshold-drag-avatar",getDragData:function getDragData(context){return{row:getTargetRow.call(this,context)};},createAvatar:function createAvatar(node,context){var avatar=context.src.data.row.domNode.cloneNode(true);avatar.style.left=$DOM.position(this.domNode).x+"px";return avatar;},isDragValid:function isDragValid(context){var targetRow=context.getCtxtDragData().row;return !(this.children.length===1||!targetRow||targetRow.draggableNode!==context.src.node)||this._super(context);},ondragstart:function(context){this._super(context);this.removeChildren(context.getCtxtDragData().row);},ondragmove:function ondragmove(context){var dragData=context.getCtxtDragData(),rows=this.children,insertRowIdx=getIndexByMousePosition.call(this,context);var lastRowIdx=dragData.lastRowIdx;if(lastRowIdx!==insertRowIdx){if(lastRowIdx!==undefined){$CSS.removeClass(rows[Math.max(lastRowIdx,0)].domNode,getCSSClassByIndex(lastRowIdx));}$CSS.addClass(rows[Math.max(insertRowIdx,0)].domNode,getCSSClassByIndex(insertRowIdx));dragData.lastRowIdx=insertRowIdx;}this._super(context);},ondragend:function ondragend(context){var dragData=context.src.data,i=dragData.lastRowIdx;if(i!==undefined){$CSS.removeClass(this.children[Math.max(i,0)].domNode,getCSSClassByIndex(i));}this._super(context);this.parent.parent.model.moveThreshold(context.getCtxtDragData().row.idx,i+1);}});}());