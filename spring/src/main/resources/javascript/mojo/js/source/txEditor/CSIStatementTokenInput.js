(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.dom","mstrmojo.string","mstrmojo.css","mstrmojo.WidgetList","mstrmojo.WidgetListMapper","mstrmojo.range","mstrmojo.txEditor.CSIStatementToken","mstrmojo.txEditor.CommonComponent");mstrmojo.requiresDescs(1442);var $H=mstrmojo.hash,$D=mstrmojo.dom,$R=mstrmojo.range,$S=mstrmojo.string,$C=mstrmojo.css,EDGE=$R.EDGE,KEYS=mstrmojo.Enum_Keys,isDelimiter=mstrmojo.txEditor.CSIStatementToken.isDelimiter,isMstrObj=mstrmojo.txEditor.CSIStatementToken.isMstrObj,mstrObj2Token=mstrmojo.txEditor.CSIStatementToken.mstrObj2Token;mstrmojo.txEditor.SpanListMapper=mstrmojo.provide("mstrmojo.txEditor.SpanListMapper",mstrmojo.mixin({itemWrapperPrefix:function(w){return'<span class="'+this.getWrapperCss(w)+'">';},itemWrapperPrefill:"&nbsp;",itemWrapperSuffix:"</span>",createWrapperNode:function createWrapperNode(p){var d=p.ownerDocument;return d.createElement("span");}},$H.copy(mstrmojo.WidgetListMapper)));function _isNotSelectedOnItems(rInfo){return !$D.contains(this.editNode,rInfo.startContainer,false,document.body);}function getCharacter(e){var k=($D.isIE&&!$D.isIE9)?e.keyCode:e.charCode;return(k>0)?String.fromCharCode(k):null;}function disableIMES(){var me=this,editNode=me.editNode,items=$H.clone(this.items);editNode.contentEditable=false;this.set("items",items);mstrmojo.warn(mstrmojo.desc(13728,"We do not support IME in local transaction editor."),null,{buttons:[{scriptClass:"mstrmojo.Button",text:mstrmojo.desc(1442),onclick:function(){editNode.contentEditable=true;}}],cssClass:"mstrmojo-TransactionEditor-Alert"});}mstrmojo.txEditor.CSIStatementTokenInput=mstrmojo.declare(mstrmojo.WidgetList,null,{scriptClass:"mstrmojo.txEditor.CSIStatementTokenInput",makeObservable:true,dropZone:true,cssClass:"mstrmojo-TransactionEditor-CSIStatementTokenInput",markupString:'<div id={@id} class="mstrmojo-TokenInputBox {@cssClass}" style="{@cssText}"><div class="mstrmojo-TokenInputBox-edit disabled" contenteditable="false" tabindex="1" spellcheck="false" mstrAttach:dragstart,focus,mouseup,keydown,keypress,keyup,contextmenu>{@itemsHtml}</div><textarea class = "mstrmojo-TokenInputBox-clipboard" onkeyup = "return mstrmojo.all.{@id}.handlepaste(event);"></textarea></div>',markupSlots:{editNode:function(){return this.domNode.firstChild;},itemsContainerNode:function(){return this.domNode.firstChild;},clipboardNode:function(){return this.domNode.lastChild;}},markupMethods:$H.copy({onheightChange:function(){if(this.height){this.domNode.style.height=this.height+"px";}},onactiveChange:function(){this.editNode.contentEditable=(this.active?"true":"false");this.enabled=!!this.active;$C.toggleClass(this.editNode,"disabled",!this.active);if(!this.active&&this.items&&this.items.length&&this.hasRendered){this.clearTokens();}}},$H.copy(mstrmojo.WidgetList.prototype.markupMethods)),bindings:{active:"!!mstrmojo.all.offModel.tgtDs.did"},items:null,itemFunction:function itemFunction(item,idx,w){if(item.did){item.isMstrObj=true;}return new mstrmojo.txEditor.CSIStatementToken({data:item});},listMapper:mstrmojo.txEditor.SpanListMapper,isDelimiter:isDelimiter,isMstrObj:isMstrObj,isRecognizedToken:function(itw){return itw.isDelimiter()||itw.isMstrObj();},allowDrop:function(){return this.isActive();},isActive:function(){return this.active;},postBuildRendering:function postBuildRendering(){this._super&&this._super();if($D.isFF){document.body.spellcheck=false;var me=this,compositeStartCallback=function(){disableIMES.call(me);};$D.attachEvent(me.domNode,"compositionstart",compositeStartCallback,true);}},oncontextmenu:function oncontextmenu(evt){var e=evt.e;if(e){$D.stopPropogation(window,e);$D.preventDefault(window,e);}return false;},onfocus:function onfocus(){mstrmojo.all.offModel.setReciever(this);},_delaySetCaretPos:function _delaySetCaretPos(dn,toStart){var en=this.editNode,me=this,f=function(){try{en.focus();en.focus();$R.collapseOnNode(dn,toStart);me._saveRangeInfo=$R.getRangeInfo();}catch(ex){}};window.setTimeout(f,0);},checkMergeTwoTokens:function checkMergeTwoTokens(idx1,idx2){if(idx1===idx2){return ;}if(idx1>idx2){idx1=[idx2,idx2=idx1][0];}var itws=this.ctxtBuilder.itemWidgets,w1=itws[idx1],w2=itws[idx2];if((w1&&!this.isRecognizedToken(w1))&&(w2&&!this.isRecognizedToken(w2))){this.remove([idx1,idx2]);this.add([w1.mergeTo(w2)],idx1);$R.collapseOnTextNode(itws[idx1].domNode,w1.length());}},widgetHandleDelete:function widgetHandleDelete(rInfo){if(rInfo.collapsed){var edge,ew,idx,so=rInfo.startOffset,itws=this.ctxtBuilder.itemWidgets;if(_isNotSelectedOnItems.call(this,rInfo)){$R.collapseOnNode(this.editNode,false);return ;}edge=$R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);ew=$D.findWidget(rInfo.startContainer);idx=this.itemIndex(ew.data);if(edge===EDGE.EDGE_END){idx++;ew=itws[idx];so=0;}if(!ew){$R.collapseOnNode(this.editNode,false);return ;}if(ew.length()===1){this.remove(idx);ew=itws[idx];if(ew){$R.collapseOnNode(ew.domNode,true);this.checkMergeTwoTokens(idx-1,idx);}else{$R.collapseOnNode(this.editNode,false);}}else{ew.spliceContent(so,1);$R.collapseOnTextNode(ew.domNode,so);}}else{this.widgetDeleteTokens(rInfo);}},widgetHandleBackspace:function widgetHandleBackspace(rInfo){if(rInfo.collapsed){var edge,ew,idx,so=rInfo.startOffset,itws=this.ctxtBuilder.itemWidgets;if(_isNotSelectedOnItems.call(this,rInfo)){if(so>0&&$D.isFF){ew=itws[this.items.length-1];$R.collapseOnNode(ew.domNode,false);rInfo=$R.getRangeInfo();}else{$R.collapseOnNode(this.editNode,true);return ;}}edge=$R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);ew=$D.findWidget(rInfo.startContainer);idx=this.itemIndex(ew.data);if(edge===EDGE.EDGE_BEGIN){idx--;ew=itws[idx];so=ew&&ew.length();}if(!ew){$R.collapseOnNode(this.editNode,true);return ;}if(ew.length()===1){this.remove(idx);ew=itws[idx-1];if(ew){$R.collapseOnNode(ew.domNode,false);this.checkMergeTwoTokens(idx-1,idx);}else{$R.collapseOnNode(this.editNode,true);}}else{ew.spliceContent(so-1,1);$R.collapseOnTextNode(ew.domNode,so-1);this.checkMergeTwoTokens(idx,idx+1);this.checkMergeTwoTokens(idx-1,idx);}}else{this.widgetDeleteTokens(rInfo);}},widgetDeleteTokens:function widgetDeleteTokens(rInfo){var getTextChildNode=function(dom){var el=dom;do{if(el.nodeType===3){return el;}}while(el=el.firstChild);return dom;},so=rInfo.startOffset,eo=rInfo.endOffset,sw=$D.findWidget($D.isIE?getTextChildNode(rInfo.startContainer):rInfo.startContainer),ew=$D.findWidget($D.isIE?getTextChildNode(rInfo.endContainer):rInfo.endContainer),si=this.itemIndex(sw.data),ei=this.itemIndex(ew.data),sEdge=$R.getEdgeInfo(rInfo.startContainer,so),eEdge=$R.getEdgeInfo(rInfo.endContainer,eo);if(sw===ew){if((sEdge===EDGE.EDGE_BEGIN)&&(eEdge===EDGE.EDGE_END)){this.remove(si);ew=this.ctxtBuilder.itemWidgets[si-1];if(ew){$R.collapseOnNode(ew.domNode,false);}else{$R.collapseOnNode(this.editNode,true);}}else{sw.spliceContent(so,eo-so);$R.collapseOnNode(ew.domNode,so);}}else{var dStart=(sEdge===EDGE.EDGE_BEGIN?si:si+1),dEnd=(eEdge===EDGE.EDGE_END?ei:ei-1),arr=[],i;for(i=dStart;i<=dEnd;++i){arr.push(i);}this.remove(arr);if(sEdge===EDGE.EDGE_MIDDLE){sw.spliceContent(so);}if(eEdge===EDGE.EDGE_MIDDLE){ew.spliceContent(0,eo);}if(sEdge===EDGE.EDGE_BEGIN){si=si-1;sw=this.ctxtBuilder.itemWidgets[si];}$R.collapseOnNode(sw?sw.domNode:this.editNode,false);this.checkMergeTwoTokens(si,si+1);}this.editNode.focus();},widgetHandleInput:function widgetHandleInput(rInfo,c){if(!rInfo.collapsed){this.widgetDeleteTokens(rInfo);rInfo=$R.getRangeInfo();}var itws=this.ctxtBuilder.itemWidgets;if(_isNotSelectedOnItems.call(this,rInfo)){this.add([{v:c,isDelimiter:this.isDelimiter(c)}],0);ew=itws[0];$R.collapseOnNode(ew.domNode,false);return ;}var edge=$R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset),ew=$D.findWidget(rInfo.startContainer),idx=this.itemIndex(ew.data),t={v:c,isDelimiter:this.isDelimiter(c)},so,aw;if(this.isDelimiter(c)||this.isMstrObj(t)){if(edge===EDGE.EDGE_MIDDLE){var ts=ew.split2Tokens(rInfo.startOffset);this.remove(idx);this.add([ts[0],t,ts[1]],idx);this.checkMergeTwoTokens(idx-1,idx);this.checkMergeTwoTokens(idx+2,idx+3);++idx;}else{idx=(edge===EDGE.EDGE_BEGIN)?idx:idx+1;this.add([t],idx);}ew=itws[idx];$R.collapseOnNode(ew.domNode,false);}else{so=rInfo.startOffset;if(this.isRecognizedToken(ew)&&edge!==EDGE.EDGE_MIDDLE){aw=itws[(edge===EDGE.EDGE_BEGIN)?idx-1:idx+1];if(aw&&!this.isRecognizedToken(aw)){ew=aw;so=(edge===EDGE.EDGE_BEGIN)?ew.length():0;}}if(!this.isRecognizedToken(ew)||edge===EDGE.EDGE_MIDDLE){ew.spliceContent(so,0,c);$R.collapseOnTextNode(ew.domNode,so+1);}else{this.add([t],(edge===EDGE.EDGE_BEGIN)?idx:idx+1);ew=itws[(edge===EDGE.EDGE_BEGIN)?idx:idx+1];$R.collapseOnNode(ew.domNode,false);}}},insertTokens:function insertTokens(tokens){var rInfo=this._saveRangeInfo||$R.getRangeInfo();if(!rInfo||_isNotSelectedOnItems.call(this,rInfo)){this.add(tokens);var iws=this.ctxtBuilder.itemWidgets,len=iws.length;this._delaySetCaretPos(len>0?iws[len-1].domNode:this.editNode,false);}else{if(!rInfo.collapsed){this.widgetDeleteTokens(rInfo);rInfo=$R.getRangeInfo();}var edge=$R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset),ew=$D.findWidget(rInfo.startContainer),idx=this.itemIndex(ew.data);if(edge===EDGE.EDGE_MIDDLE){var ts=ew.split2Tokens(rInfo.startOffset);this.remove(idx);tokens.unshift(ts[0]);tokens.push(ts[1]);this.add(tokens,idx);}else{idx=(edge===EDGE.EDGE_BEGIN?idx:idx+1);this.add(tokens,idx);}if(edge===EDGE.EDGE_MIDDLE){idx+=1;}ew=this.ctxtBuilder.itemWidgets[idx];this._delaySetCaretPos(ew.domNode,false);}this.raiseChangeEvent({type:"insert"});var me=this;window.setTimeout(function(){me._saveRangeInfo=$R.getRangeInfo();},50);},clearTokens:function clearTokens(empty){this.set("items",empty||[]);this._saveRangeInfo=null;this._delaySetCaretPos(this.editNode,false);this.raiseChangeEvent({type:"clear"});},onkeydown:function onkeydown(evt){var e=evt.e||window.event,k=e.keyCode||e.charCode,noDefault=false,rInfo=$R.getRangeInfo();switch(k){case KEYS.DELETE:try{this.widgetHandleDelete(rInfo);this.raiseChangeEvent({type:"delete"});}catch(ex){}noDefault=true;break;case KEYS.BACKSPACE:try{this.widgetHandleBackspace(rInfo);this.raiseChangeEvent({type:"backspace"});}catch(ex){}noDefault=true;break;case 86:if(e.ctrlKey){this._saveRangeInfo=$R.getRangeInfo();if(!this._saveRangeInfo.collapsed){this.widgetHandleDelete(this._saveRangeInfo);this._saveRangeInfo=$R.getRangeInfo(this.editNode,this._saveRangeInfo);}this.clipboardNode.focus();noDefault=false;}break;case 229:disableIMES.call(this);noDefault=true;break;default:}$D.stopPropogation(window,e);if(noDefault){$D.preventDefault(window,e);return false;}else{return true;}},onkeyup:function onkeyup(evt){this._saveRangeInfo=$R.getRangeInfo();},onkeypress:function onkeypress(evt){var e=evt.e||window.event,c=getCharacter(e);if(c&&!(c==="c"&&e.ctrlKey)){try{this.widgetHandleInput($R.getRangeInfo(),c);this.raiseChangeEvent({type:"input"});}catch(ex){}$D.stopPropogation(window,e);$D.preventDefault(window,e);return false;}return true;},handlepaste:function handlepaste(e){var v=this.clipboardNode.value;this.clipboardNode.value="";var ts=[],me=this,len=v&&v.length,i,t="",c,checkInsertMstrObj=function(force){if(!$S.isEmpty(t)){if(force){ts.push({v:t});t="";}else{var data={v:t};if(me.isMstrObj(data)){ts.push(data);t="";}}}};if(len>0){for(i=0;i<len;++i){c=v.charAt(i);if(this.isDelimiter(c)){checkInsertMstrObj(true);ts.push({v:c,isDelimiter:true});}else{t=t+c;checkInsertMstrObj(false);}}checkInsertMstrObj(true);this.insertTokens(ts);}},onmouseup:function onemouseup(evt){var rInfo=$R.getRangeInfo();if(!_isNotSelectedOnItems.call(this,rInfo)){this._saveRangeInfo=rInfo;}},ondragstart:function ondragstart(evt){var e=evt.e;if(e){$D.stopPropogation(window,e);$D.preventDefault(window,e);}return false;},ondragenter:mstrmojo.emptyFn,ondragover:mstrmojo.emptyFn,insertMstrToken:function insertMstrToken(tk){if(tk){var token=mstrObj2Token(tk);this.insertTokens([token]);}},ondrop:function ondrop(context){var item=context.src.data&&context.src.data.item;this.insertMstrToken(item);},sendData:function sendData(data){var item=data&&data.item;this.insertMstrToken(item);},raiseChangeEvent:function(params){params.name="clauseModify";mstrmojo.all.offModel.set("isDirty",true);this.raiseEvent(params);}});}());