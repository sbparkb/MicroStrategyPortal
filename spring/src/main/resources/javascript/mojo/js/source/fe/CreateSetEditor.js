(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.css","mstrmojo.expr","mstrmojo.hash","mstrmojo.Box","mstrmojo.Button","mstrmojo.Editor","mstrmojo.FilterExpr","mstrmojo.Label","mstrmojo.Obj","mstrmojo.ui.Checkbox","mstrmojo.ui.CheckList","mstrmojo.warehouse.EnumObjectTypes");var _E=mstrmojo.expr,_ET=_E.ET,_A=mstrmojo.array,_S=mstrmojo.string,_ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,_DMT=mstrmojo.mstr.EnumNodeDimty;mstrmojo.fe.CreateSetEditor=mstrmojo.declare(mstrmojo.Editor,null,{onOpen:function(){var model=this.model,ndData=this.condition.data,showRelation=!ndData.m,attrsList=this.attrsBox.attrsList,relPd=this.relBox.relPd,relItems=[{n:mstrmojo.desc(12037,"System Default"),t:-1,did:"default"}].concat(model.metrics),appQual=this.appQual;attrsList.set("items",model.attrs);mstrmojo.array.forEach(["relBox","appQual"],function(item){this[item].set("visible",showRelation);},this);if(ndData.dmt===4&&ndData.dmy.uts){var setSelIndices={};_A.forEach(ndData.dmy.uts,function(ut){var idx=_A.find(model.attrs,"did",ut.utgt.did);if(idx>=0){setSelIndices[idx]=true;}});attrsList.set("selectedIndices",setSelIndices);}if(showRelation){relPd.set("items",relItems);if(ndData.relation&&ndData.relation.guide){var guide=ndData.relation.guide,idx=_A.find(relItems,"did",guide.did);relPd.set("selectedIndex",idx>=0?idx:0);}else{relPd.set("selectedIndex",0);}appQual.set("checked",!!ndData.applySubExpr);}},onOK:function(){var model=this.model,cond=this.condition,ndData=this.condition.data,attrsList=this.attrsBox.attrsList,relPd=this.relBox.relPd,appQual=this.appQual;var selAttrs=attrsList.getSelectedItems(),newUts=[];_A.forEach(selAttrs,function(attr){newUts.push({utgt:{n:attr.n,did:attr.did},utp:_E.DMY_TP.ATTR,agg:1,flt:2,gb:true,rps:0,n:attr.n});});var newGd;if(relPd.selectedIndex>0){var relUd=relPd.items[relPd.selectedIndex];newGd={n:relUd.n,did:relUd.did,t:_ENUM_OT.METRIC,st:1024};}var relation;if(ndData.et===15){ndData.dmt=_DMT.NodeDimtyOutputLevel;ndData.dmy=ndData.dmy||{};ndData.dmy.uts=newUts;relation=ndData.relation=ndData.relation||{};if(newGd){relation.guide=newGd;ndData.useSchema=false;}else{delete relation.guide;delete relation.rsTp;delete relation.joTp;delete relation.paTp;delete relation.erTp;ndData.useSchema=true;}ndData.applySubExpr=appQual.checked;cond.set("data",ndData);}else{var rsQual={et:15};rsQual.dmt=_DMT.NodeDimtyOutputLevel;rsQual.dmy={};rsQual.dmy.uts=newUts;relation=rsQual.relation={};if(newGd){relation.guide=newGd;}else{rsQual.useSchema=true;}rsQual.applySubExpr=appQual.checked;var nd=cond,cfg={rq:rsQual,cq:ndData},idxs=[cond.childIndex()];if(ndData.et===_ET.ANDOR){if(ndData.nds&&ndData.nds.length>2){var ci=model.childIdx;idxs=[ci,ci-1];}else{nd=cond.parent;}}else{nd=cond.parent;cfg.isMetric=!!ndData.m;}nd.createSet(idxs,cfg);}},children:[{scriptClass:"mstrmojo.Box",alias:"attrsBox",cssClass:"Attributes-Box",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(14613,"Select attributes to create the set"),cssClass:"Label"},{scriptClass:"mstrmojo.ui.CheckList",alias:"attrsList",cssClass:"CheckList"}]},{scriptClass:"mstrmojo.Box",alias:"relBox",cssClass:"RelatedBy-Box",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(12036,"Related by"),cssClass:"Label",cssDisplay:"inline-block"},{scriptClass:"mstrmojo.ui.Pulldown",alias:"relPd",cssClass:"Pulldown",cssDisplay:"inline-block",onitemSelected:function onitemSelected(item){}}]},{scriptClass:"mstrmojo.ui.Checkbox",alias:"appQual",cssClass:"AppQual-CheckBox",postBuildRendering:function(){this.domNode.innerHTML=_S.encodeHtmlString(mstrmojo.desc(12038,"Apply this qualification independently of the relationship filter"));}},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",cssText:"float: right; border-collapse: separate; display: table;",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton hot",text:mstrmojo.desc(2397,"OK"),onclick:function(){var editor=this.editor;editor.onOK();editor.close();},bindings:{enabled:function(){var attrList=this.parent.parent.attrsBox.attrsList,selectedIndices=this.parent.parent.attrsBox.attrsList.selectedIndices;return attrList.getSelectedItems().length>0;},editor:"this.parent.parent"}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){this.editor.close();},bindings:{editor:"this.parent.parent"}}]}]});})();