(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.color","mstrmojo.array","mstrmojo.css");var $CSS=mstrmojo.css,fadeCls="fadeIn";var browserSupportsHtml5=true;function handleTouchEnd(widget){widget.tooltipOn=false;widget.highlightContext.clearRect(0,0,widget.getWidth(),widget.getHeight());$CSS.removeClass(widget.tooltip,fadeCls);widget.currentHighlight=null;}function handleTouchMove(widget,touchX,touchY){if(!widget.tooltipOn||!browserSupportsHtml5){return ;}touchX=touchX-widget.offsetLeft;touchY=touchY-widget.offsetTop;var touchVal=widget.getTouchValue(touchX,touchY);var hdrIndex=widget.getHeaderIndex(touchVal);if(!touchVal||!widget.model.gvs.items[hdrIndex]){handleTouchEnd(widget);}else{if(touchVal!==widget.currentHighlight){widget.currentHighlight=touchVal;widget.highlightPoint(touchVal);widget.renderTooltip(touchVal,touchX,touchY,hdrIndex);}}}function handleTouchBegin(widget,touchX,touchY){widget.tooltipOn=true;if(!browserSupportsHtml5){return ;}handleTouchMove(widget,touchX,touchY);}function getLighterColor(c){var rgb=mstrmojo.color.hex2rgb(c);mstrmojo.array.forEach(rgb,function(v,idx){rgb[idx]=Math.floor(v*0.75);});return"rgb("+rgb.join(",")+")";}function postitionTooltip(tooltip,touchX,touchY){var tooltipStyle=tooltip.style,translateValue="translate("+touchX+"px, "+touchY+"px)",translateValue3d=translateValue.replace("late(","late3d(").replace("px)","px, 0)");tooltipStyle.webkitTransform=translateValue3d;tooltipStyle.transform=translateValue3d;tooltipStyle.MozTransform=translateValue;tooltipStyle.msTransform=translateValue;}function inPoly(poly,px,py){var npoints=poly.length,inside=false,xnew,ynew,xold,yold,x1,y1,x2,y2,i;if(npoints/2<3){return false;}xold=poly[npoints-2];yold=poly[npoints-1];for(i=0;i<npoints;i=i+2){xnew=poly[i];ynew=poly[i+1];if(xnew>xold){x1=xold;x2=xnew;y1=yold;y2=ynew;}else{x1=xnew;x2=xold;y1=ynew;y2=yold;}if((xnew<px)===(px<=xold)&&((py-y1)*(x2-x1)<(y2-y1)*(px-x1))){inside=!inside;}xold=xnew;yold=ynew;}return inside;}function drawPoly(ctx,coordsArray,clr,lclr){try{var i,j;for(i=0;i<coordsArray.length;i++){var pointsArray=coordsArray[i],minX=pointsArray[0],minY=pointsArray[1],maxY=pointsArray[1];ctx.beginPath();ctx.moveTo(pointsArray[0],pointsArray[1]);for(j=2;j<pointsArray.length-1;j=j+2){var x=pointsArray[j],y=pointsArray[j+1];ctx.lineTo(x,y);maxY=Math.max(y,maxY);minY=Math.min(y,minY);minX=Math.min(x,minX);}var fillStyle=clr;if(lclr){var grd=ctx.createLinearGradient(minX,minY,minX,maxY);grd.addColorStop(0,clr);grd.addColorStop(0.5,lclr);fillStyle=grd;}ctx.fillStyle=fillStyle;ctx.stroke();ctx.fill();}}catch(e){}}var canvasHTML='<canvas style="position:absolute;left:0;top:0" width="{@width}" height="{@height}"></canvas>';mstrmojo.VisMap=mstrmojo.declare(mstrmojo.Vis,null,{scriptClass:"mstrmojo.VisMap",model:null,width:700,height:500,context:null,browserSupportsHtml5:true,markupString:'<div id="{@id}" class="mstrmojo-Chart {@cssClass}" style="width:{@width};height:{@height};top:{@top};left:{@left};position:absolute;{@cssText};overflow:auto;"  mstrAttach:mouseover,mousemove ><canvas width="{@width}" height="{@height}"></canvas>'+canvasHTML+canvasHTML+'<div id="{@id}-tooltip" class="mstrmojo-Map-tooltip"></div></div>',markupSlots:{canvas:function(){return this.domNode.firstChild;},highlightCanvas:function(){return this.domNode.childNodes[1];},animationCanvas:function(){return this.domNode.childNodes[2];},tooltip:function(){return this.domNode.childNodes[3];}},postBuildRendering:function postBuildRendering(){this._super();var canvas=this.canvas;browserSupportsHtml5=canvas.getContext;if(!browserSupportsHtml5){this.renderErrorMessage(mstrmojo.desc(8126,"Your browser does not support HTML5"));return ;}this.context=canvas.getContext("2d");this.highlightContext=this.animationContext=this.highlightCanvas.getContext("2d");this.drawMap();},drawMap:function drawMap(){var context=this.context;context.lineWidth=2;context.strokeStyle="#AAAAAA";var m=this.model,coords=m.coords,elem,i,j,k;if(m&&m.th){for(i in m.th){m.th[i].l=getLighterColor(m.th[i].n);}}var maxX=0,maxY=0,rgn,c;for(i in coords){rgn=coords[i];for(j in rgn){c=rgn[j];for(k=0;k<c.length;k++){if(c[k]>maxX){maxX=c[k];}k++;if(c[k]>maxY){maxY=c[k];}}}}var xRatio=maxX/this.getWidth(),yRatio=maxY/this.getHeight();if(xRatio>1||yRatio>1||xRatio<0.8||yRatio<0.8){var ratio=Math.max(yRatio,xRatio)*1.05;for(i in coords){rgn=coords[i];for(j in rgn){c=rgn[j];for(k=0;k<c.length;k++){c[k]=parseInt(c[k]/ratio,10);}}}}var defClr="#AAAAAA";if(m.vp&&m.vp.npc){defClr="#"+m.vp.npc;}var deflClr=getLighterColor(defClr);for(elem in coords){var hdrIndex=this.getHeaderIndex(elem);var clr=defClr,lclr=deflClr;if(hdrIndex>=0){var mv=m.gvs.items[hdrIndex].items[0];if(mv&&parseInt(mv.ty,10)===2){var ti=mv.ti;if(typeof ti!=="undefined"){var thld=m.th[ti];clr=thld.n;lclr=thld.l;}}}drawPoly(context,coords[elem],clr,lclr);}},getHeaderIndex:function getHeaderIndex(headerName){var hdrIndex=-1,hdrs=this.model.gts.row[0].es,i;if(headerName){headerName=headerName.toLowerCase();for(i=0;i<hdrs.length;i++){var name=hdrs[i].n;if(name&&name.toLowerCase()===headerName){hdrIndex=i;break;}}}return hdrIndex;},highlightPoint:function highlightPoint(x){var ctx=this.animationContext;ctx.clearRect(0,0,this.getWidth(),this.getHeight());ctx.strokeStyle="#FFFFFF";drawPoly(ctx,this.model.coords[x],"rgba(255, 255, 255, 0.5)");},getTouchValue:function getTouchValue(x,y){var coords=this.model.coords,elem,i;for(elem in coords){var coordsArray=coords[elem],l=coordsArray.length;for(i=0;i<l;i++){if(inPoly(coordsArray[i],x,y)){return elem;}}}return null;},renderTooltip:function renderTooltip(touchVal,touchX,touchY,hdrIndex){var tooltip=this.tooltip,model=this.model;postitionTooltip(tooltip,0,0);if(hdrIndex>=0){var gts=this.model.gts,gtsCol=gts.col,html=gts.row[0].n+": "+touchVal,i;if(gtsCol){var units=gtsCol[0].es,values=model.gvs.items[hdrIndex].items;for(i=0;i<units.length;i++){var mv=values[i],v=mv.v;if(parseInt(mv.ty,10)===4){v='<img src="'+v+'" >';}html+="<br>"+units[i].n+": "+v;}}this.tooltip.innerHTML=html;}touchX=Math.min(touchX,this.getWidth()-tooltip.offsetWidth);touchY=Math.min(touchY,this.getHeight()-tooltip.offsetHeight);postitionTooltip(tooltip,touchX,touchY);$CSS.addClass(tooltip,fadeCls);},onmouseover:function onmouseover(evt){var e=evt.e;handleTouchBegin(this,e.pageX,e.pageY);},onmousemove:function onmousemove(evt){var e=evt.e;handleTouchBegin(this,e.pageX,e.pageY);}});}());