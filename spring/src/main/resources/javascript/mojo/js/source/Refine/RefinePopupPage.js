(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.string","mstrmojo._FillsBrowser","mstrmojo.Refine.RefineSampleButton");var _D=mstrmojo.dom,DIConstants=mstrmojo.DI.DIConstants,$CSS=mstrmojo.css;function showSampleButton(source){if(source.type===DIConstants.sourceType.file&&(source.subtype===DIConstants.sourceSubtype.localFile||source.subtype===DIConstants.sourceSubtype.url||source.subtype===DIConstants.sourceSubtype.samplefile)){return true;}else{if(source.type===DIConstants.sourceType.querybuilder&&source.subtype===DIConstants.sourceSubtype.querybuilder){return true;}}return false;}mstrmojo.requiresDescs(1143,221,12314,1442,14705);mstrmojo.Refine.RefinePopupPage=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._IsPopup,mstrmojo._FillsBrowser],{scriptClass:"mstrmojo.Refine.RefinePopupPage",alias:"RefinePopupPage",markupString:'<div id="{@id}" class="refine-popup-page mojo-theme-light" mstrAttach:mousedown,mousemove><div class="refine-popup-page-header"></div><div class="refine-popup-page-content"></div><div class="refine-popup-page-footer"><div class="refine-popup-page-cancel"></div><div class="refine-popup-page-apply"></div></div><div class="refine-popup-page-overlay"></div></div>',markupSlots:{editorNode:function(){return this.domNode;},headerNode:function(){return this.domNode.children[0];},refinePanelNode:function(){return this.domNode.children[1];},buttonNode:function(){return this.domNode.children[2];},cancelNode:function(){return this.domNode.children[2].children[0];},applyNode:function(){return this.domNode.children[2].children[1];},overlayNode:function(){return this.domNode.children[3];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";},onzIndexChange:function(){this.domNode.style.zIndex=this.zIndex;}},onmousedown:function(evt){var e=evt.e,t=_D.eventTarget(evt.hWin,e);if(!this.controller.refineApp.rootController.isClickedInDatePreview&&t.className.indexOf("mstrmojo-scrollbar")===-1){this.refinePanel.controller.model.raiseEvent({name:"columnUnSelected"});if(window.getSelection){window.getSelection().removeAllRanges();}else{document.selection.empty();}}this.controller.refineApp.rootController.isClickedInDatePreview=false;},preBuildRendering:function preBuildRendering(){if(!this.slot&&!this.placeholder){this.placeholder=document.body.appendChild(document.createElement("div"));}var rCtrl=mstrApp.getRootController(),tableID=rCtrl.refineApp.rootController.tableID,source=rCtrl.model.importSources[tableID];if(!showSampleButton(source)){Array.prototype.splice.call(this.children[0].children,1,1);}return this._super();},postBuildRendering:function postBuildRendering(){this.setDimensions();if(this._super){this._super();}},setDimensions:function setDimensions(){var broswerSize=this.getBrowserDimensions();var height=Math.ceil(parseInt(broswerSize.h,10)*0.95);var width=Math.ceil(parseInt(broswerSize.w,10)*0.95);if(isNaN(height)||isNaN(width)){return ;}if(!this.layoutConfig){this.layoutConfig={h:{},w:{}};}this.layoutConfig.h.refinePanelNode=(height-41-47-2)+"px";this.layoutConfig.w.refinePanelNode=(width-36)+"px";if(this._super){this._super(height+"px",width+"px");}if(this.domNode){mstrmojo.dom.center(this.domNode);}},children:[{scriptClass:"mstrmojo.Box",slot:"headerNode",alias:"header",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-refine-title",alias:"title",text:mstrmojo.desc(12314,"Wrangle Your Data")},{scriptClass:"mstrmojo.Refine.RefineSampleButton",cssClass:"mstrmojo-WebHoverButton mstrmojo-refine-sample-button",alias:"sampleButton",useRichTooltip:false,updateTooltipConfig:function(){this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-C",refNode:this.domNode,posType:mstrmojo.tooltip.POS_TOPLEFT,left:(parseInt(this.domNode.offsetWidth,10)+6).toString()+"px",content:mstrmojo.desc(14705,"All data from the source has <br>been added in the data <br>wrangler preview.")});},postBuildRendering:function(){var ctrl=mstrApp.getRootController(),refineCtrl=ctrl.refineApp.rootController;this.m=refineCtrl.model;this.listener=this.m.attachEventListener("dataChange",this.id,this.disableSetSampleButtonhandler);this.attachEventListener("renderComplete",this.id,this.onuseRichTooltipChange);},disableSetSampleButtonhandler:function(evt){var dataNumInitial=parseInt(evt.value.totalInitial,10);if(dataNumInitial<1000){this.set("useRichTooltip",true);this.set("enabled",false);$CSS.addClass(this.textNode,"_disable-Button");}this.m.detachEventListener(this.listener);}},{scriptClass:"mstrmojo.Button",iconClass:"mstrmojo-refine-close",onclick:function(){this.parent.parent.cancel.onclick();}},{scriptClass:"mstrmojo.Button",iconClass:"mstrmojo-refine-help",title:mstrmojo.desc(1143,"Help"),onclick:function(){var helpTopic="Data_Wrangler.htm";mstrApp.showHelpTopic(helpTopic);}}]},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",alias:"next",slot:"applyNode",text:mstrmojo.desc(1442,"OK"),onclick:function(){var projectID,refineDetails,model;var controller=mstrApp.getRootController();var diModel=controller.model;var source=diModel.importSources[this.parent.tableID];model=this.parent.refinePanel.controller.model;projectID=model.projectID;var entries=JSON.parse(JSON.stringify(model.operations.entries));var json=[],i;if(entries.length===0){controller.cancelRefineStage(this.parent.tableID);}else{for(i=0;i<entries.length;i++){json.push(entries[i].operation);}refineDetails='<rss rpid="'+projectID+'" rfmt=""><rpo></rpo><rjsops>'+mstrmojo.string.encodeXMLAttribute(JSON.stringify(json))+"</rjsops></rss>";controller.startRefineStage(this.parent.tableID,3,refineDetails);}var facetPanel=this.parent.refinePanel.bottomPanal.splitter.facetPanel;facetPanel.removeAllFacets();model.engine=JSON.stringify(facetPanel.getJSON());source.inRefine=false;this.parent.destroy();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),slot:"cancelNode",alias:"cancel",onclick:function(){var json=[],i,entries;var model=this.parent.refinePanel.controller.model;var controller=mstrApp.getRootController();var diModel=controller.model;var source=diModel.importSources[this.parent.tableID];if(source.RefineOperations.length===0){controller.cancelRefineStage(this.parent.tableID);}else{if(!mstrmojo.hash.equals(source.RefineOperations,model.operations.entries)){var refineController=controller.refineApp.rootController;entries=source.RefineOperations;for(i=0;i<entries.length;i++){json.push(entries[i].operation);}refineController.rollBackOperations({operations:JSON.stringify(json),engine:JSON.stringify({facets:[],mode:"row-based"})});}}var facetPanel=this.parent.refinePanel.bottomPanal.splitter.facetPanel;facetPanel.removeAllFacets();model.engine=JSON.stringify(facetPanel.getJSON());source.inRefine=false;this.parent.destroy();}}]});}());