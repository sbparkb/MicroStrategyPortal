(function(){mstrmojo.requiresCls("mstrmojo.gm.GMEnums","mstrmojo.hash","mstrmojo.DocDataService","mstrmojo.VisEnum.GMLegendFormatingPropertyTag","mstrmojo.VisUtility");var TRF_MANIPULATIONS=mstrmojo.gm.EnumTRFManipulations;var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$WRAP=mstrmojo.func.wrapMethods,$COMPOS=mstrmojo.func.composite,LEGEND_FORMATTING_TYPE=mstrmojo.VisEnum.GMLegendFormatingPropertyTag;var EMPTY_CLIENT_UNDO_REDO_CONFIG={silent:false,undo:mstrmojo.emptyFn,redo:mstrmojo.emptyFn};function cmdMgr(me){return me.model.controller.cmdMgr;}function hGetDocModel(){return(this.getDocModel&&this.getDocModel())||this.model.docModel;}function getToolbarUpdateCallback(){return{success:function success(){this.raiseEvent({name:"regenerateToolbar"});}.bind(this)};}function getSlicingAction(objsInfo,keepOnly){var docModel,dataService,sliceAction,callbacks,params={};params.tks=this.k;params.selectorObjects=objsInfo;params.keepOnly=!!keepOnly;params.isDocVis=true;docModel=hGetDocModel.call(this);dataService=docModel.getDataService();sliceAction=dataService.getGMViewFilterAction(params);callbacks=docModel.getSliceCallback(params);return{action:sliceAction,callbacks:callbacks};}function submitUpdatesAndPersistWidgetXMLIfNecessary(action,callbacks){var docModel,persistXMLAction,dataService;docModel=hGetDocModel.call(this);dataService=docModel.getDataService();if(!this.isXMLDirty()){dataService.submitUpdates(action,callbacks);}else{persistXMLAction=this.getPersistAction();dataService.submitUpdates([action,persistXMLAction],callbacks);this.resetXMLDirtyFlag();}}function getSetPropertiesAction(){var modelData=this.modelData||this.model.data,nodeKey=modelData.k,key,prs="FormattingWidget",properties,xmlDom,xmlString,encodedXML,action,actions=[],extraActions=[],editorModel=this.edtModel;if(!modelData){console.log("warning: modelData is missing");return null;}var convertJSONToXML=function(object,tagName){var ret=xmlDom.createElement(tagName),key;if(object instanceof Object){for(key in object){if(object.hasOwnProperty(key)){var child=convertJSONToXML(object[key],key);if(child){ret.appendChild(child);}}}}else{ret.setAttribute("value",object);}return ret;};var encodeXMLString=function(xmlString){return xmlString.replace(/</g,"&lt;").replace(/"/g,"&quot;");};extraActions=!!editorModel&&!!editorModel.getActionsWithUpdateProperty?editorModel.getActionsWithUpdateProperty():[];xmlString=this.createWidgetPropsXML?this.createWidgetPropsXML():null;if(!xmlString||xmlString.length===0){properties=this.getProperties();if(this.useCompatibleXML){xmlDom=(new DOMParser()).parseFromString("<widgetProps></widgetProps>","text/xml");xmlDom.firstChild.appendChild(convertJSONToXML(properties,"fmt"));}else{xmlDom=(new DOMParser()).parseFromString("<props><widgetProps></widgetProps></props>","text/xml");xmlDom.firstChild.firstChild.appendChild(convertJSONToXML(properties,"fmt"));}xmlString=(new XMLSerializer()).serializeToString(xmlDom);}encodedXML=encodeXMLString(xmlString);action={act:"setProperty",nodeKey:nodeKey,prs:prs,pri:4,v:encodedXML};actions.push(action);if(!!extraActions){actions=actions.concat(extraActions);}return actions;}function getClientUndoRedoConfig(propertyName,newVal,oldVal,update){if(!(update instanceof Function)){return EMPTY_CLIENT_UNDO_REDO_CONFIG;}var widgetId=this.id;function getCallback(val){return function(){var me=mstrmojo.all[widgetId],properties=me.getProperties();properties[propertyName]=val;update.call(me,val,true);me.getDocModel().selectVIUnit(me.parent.id,true);};}return{silent:true,undo:getCallback(oldVal),redo:getCallback(newVal)};}mstrmojo._VizSelectionHelper=mstrmojo.provide("mstrmojo._VizSelectionHelper",{postBuilderingCalled:false,listenToUpdateColorMap:function(refreshCallBack){if(mstrmojo.VisUtility.isOnExpressMode()){return ;}var me=this,panel,docModel=(me.getDocModel&&me.getDocModel())||me.model.docModel;if(docModel){return docModel.attachEventListener("colorMapChanged",me.id,function(evt){panel=me.parent&&me.parent.parent;if(me.forceUpdateColorMap||(panel&&panel.isPanelDisplaying())){refreshCallBack.call(me);}else{var panelDisplayLister=panel.attachEventListener("panelDisplaying",me.id,function(evt){if(me.postBuilderingCalled){refreshCallBack.call(me);}panel.detachEventListener(panelDisplayLister);});}});}},detachUpdateColorMapListener:function(sub){if(!sub){return ;}var docModel=(this.getDocModel&&this.getDocModel())||this.model.docModel;docModel.detachEventListener(sub);},updateTargets:function(objsInfo){var params={},me=this,docModel=hGetDocModel.call(this);params.fromGM=true;params.type=1;params.src=this.k;params.selectorObjects=objsInfo;function getSelectionContext(prop){var modelData=me.modelData||me.model.data,sc=modelData.sc;if(sc!==undefined){return sc[prop];}return undefined;}params.keepOnly=true;params.ck=getSelectionContext.call(this,"ck");params.keyContext=params.ck;params.tks=getSelectionContext.call(this,"tks");params.ckey=getSelectionContext.call(this,"ckey");params.isDocVis=true;params.include=true;params.showall=getSelectionContext.call(this,"showall");docModel.slice(params);},updateAfterViewFilter:function(objsInfo,keepOnly){var docModel,dataService,action,action_callback,callbacks,undoActions,controller;docModel=hGetDocModel.call(this);dataService=docModel.getDataService();action_callback=getSlicingAction.call(this,objsInfo,keepOnly);action=action_callback.action;callbacks=action_callback.callbacks;controller=this.model.controller||docModel.controller;if(this.currKeepOnlyAction){undoActions=[$HASH.clone(this.currKeepOnlyAction)];}else{undoActions=getSlicingAction.call(this,[],false).action;}this.currKeepOnlyAction=action;controller.submitUndoRedoUpdates([action],undoActions,callbacks);},updateAfterKeepOnly:function(isKeepOnly){var docModel=hGetDocModel.call(this),controller=this.model.controller||docModel.controller,callback=$WRAP(controller._getXtabCallback(this),getToolbarUpdateCallback.call(this));controller.applyKeepOnly(this,callback,{keepOnly:isKeepOnly,data:this.getSelections()},isKeepOnly?-2:undefined);},updateAfterDrill:function(drillActions,actionCallback){var me=this,docModel=hGetDocModel.call(this),dataService=docModel.getDataService(),update=dataService.newUpdate(),selections=this.getSelections(),selectorData=this.model.getSelectorDataFromViewFilter(me.model.data.vfexpr).concat({keepOnly:true,data:selections}),sliceAction=docModel.getKeepOnlyOrExcludeAction(me.k,selectorData),controller=me.model.controller||docModel.controller,undoRedoCallback=controller._getXtabCallback(me);update.add(drillActions,$WRAP(actionCallback,undoRedoCallback));update.add(sliceAction,getToolbarUpdateCallback.call(me));cmdMgr(me).execute({execute:function execute(){this.submitUpdate(update);},urInfo:{callback:update.callback}});},updateAfterSort:function(sortActions){var me=this,docModel=hGetDocModel.call(this),dataService=docModel.getDataService(),callback=docModel.getSliceCallback({tks:me.k});cmdMgr(me).execute({execute:function execute(){var update=dataService.newUpdate(this,undefined),action={act:"sortGM",nodeKey:me.k,subActions:sortActions};update.add(action,callback,undefined);if(me.isXMLDirty()){update.addActions(me.getPersistAction());}this.submitUpdate(update,undefined);},urInfo:{callback:callback}});},updateAfterAction:function(actions,secondaryCallback,suppressData,rqstDefn,clientUndoRedoCfg){if(!actions){return ;}var me=this,id=me.parent&&me.parent.id,docModel=me.model.docModel,controller=me.model.controller||docModel.controller,callback,undoredoCallback,extra={},execute,clientCfg=clientUndoRedoCfg||EMPTY_CLIENT_UNDO_REDO_CONFIG;if(suppressData){callback=mstrmojo.emptyFn;execute=function(){this.submitSilent(actions);};}else{callback=docModel.getSliceCallback({tks:this.k});callback.success=$COMPOS([callback.success,function(){docModel.selectVIUnit(id,true);}]);execute=function(){this.submit(actions,callback,extra);};}undoredoCallback=controller._getXtabCallback(me);if(secondaryCallback){callback=$WRAP(callback,secondaryCallback);undoredoCallback=$WRAP(undoredoCallback,secondaryCallback);}undoredoCallback.success=$COMPOS([undoredoCallback.success,function(){docModel.selectVIUnit(id,true);}]);if(suppressData){$HASH.copy(mstrmojo.DocDataService.SUPPRESS_DATA,extra);}if(rqstDefn){$HASH.copy(mstrmojo.DocDataService.REQUEST_DEFN_DATA,extra);}cmdMgr(this).execute({execute:execute,urInfo:{silent:clientCfg.silent,callback:undoredoCallback,redo:clientCfg.redo,undo:clientCfg.undo}});},getProperties:mstrmojo.emptyFn,getSetPropertiesAction:getSetPropertiesAction,updateAfterPropertiesChange:function(secondaryCallback,supressData,rqstDefn,clientUndoRedoCfg){this.updateAfterAction(getSetPropertiesAction.call(this),secondaryCallback,supressData,rqstDefn,clientUndoRedoCfg);},setProperty:function(propertyName,newValue,config){var secondaryCallback=config.callback,suppressData=!!config.suppressData,rqstDefn=config.requestDefinition,urCallback=config.clientUndoRedoCallback,properties=this.getProperties(),oldValue=properties[propertyName],urConfig;if(propertyName===LEGEND_FORMATTING_TYPE.COLOR_SQUARE_COLOR){if(this.colorSqureIdentity){this.updateColorMap(this.colorSqureIdentity.comb,newValue);}}else{if(properties&&(properties[propertyName]===undefined||properties[propertyName].toString()!==newValue.toString())){properties[propertyName]=newValue;urConfig=getClientUndoRedoConfig.call(this,propertyName,newValue,oldValue,urCallback);this.updateAfterPropertiesChange(secondaryCallback,suppressData,rqstDefn,urConfig);}}},showData:function(objsInfo){if(!this.gridData){this.gridData=this.model.data;}mstrmojo.vi.ui.ViewDataDialog.open(this.parent,true);}});}());