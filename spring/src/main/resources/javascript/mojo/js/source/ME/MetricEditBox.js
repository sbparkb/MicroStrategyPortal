(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.ME.TokenInputBox");mstrmojo.requiresDescs(13542,13543);var ARR=mstrmojo.array;var _VSTATUS={VALID:0,UNKNOWN:1,VALIDATING:2,ERROR:3,AMBIGUITY:4},_VSTATUSCSS={0:"valid",1:"unknown",2:"validating",3:"error",4:"ambiguity"},_VSTATUSDESC={0:mstrmojo.desc(9565,"Valid Metric Formula."),1:mstrmojo.desc(9106,"Require Validation?"),2:mstrmojo.desc(9566,"Validation in Progress..."),3:mstrmojo.desc(9567,"Validation Failed with Syntax Error!"),4:mstrmojo.desc(9568,"Validation Failed with Object Ambiguity!")};function _mapErrorCode(code){if(!code){return _VSTATUS.VALID;}return{"-2147214845":_VSTATUS.ERROR,"-2147214846":_VSTATUS.AMBIGUITY}[code]||_VSTATUS.ERROR;}mstrmojo.ME.MetricEditBox=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.MetricEditBox",vStatus:_VSTATUS.VALID,iStatus:"",showStatus:true,browseItemVisible:true,absorbAmbiguity:true,isObjectVisible:function(itm){return true;},markupString:'<div id="{@id}" class="mstrmojo-MEBox {@cssClass}" style="{@cssText}"><div class="mstrmojo-MEBox-edit"></div><div class="mstrmojo-MEBox-status {@statusCssClass}"><div class="mstrmojo-MEBox-vStatus"></div><div class="mstrmojo-MEBox-iStatus"></div></div></div>',markupSlots:{editNode:function(){return this.domNode.firstChild;},iStatusNode:function(){return this.domNode.lastChild.lastChild;},vStatusNode:function(){return this.domNode.lastChild.firstChild;}},markupMethods:{onvStatusChange:function(){var s=this.vStatus,vn=this.vStatusNode;vn.className="mstrmojo-MEBox-vStatus "+_VSTATUSCSS[s];vn.innerHTML=(this.getStatusDesc&&this.getStatusDesc(s))||_VSTATUSDESC[s]||"";},oniStatusChange:function(){this.iStatusNode.innerHTML=this.iStatus;this.iStatusNode.title=this.iStatus;}},children:[{scriptClass:"mstrmojo.ME.TokenInputBox",alias:"inputBox",slot:"editNode",renderOnScroll:false,renderBlockSize:0,bindings:{browseItemVisible:"this.parent.browseItemVisible",candidates:"this.parent.candidates"}}],init:function init(props){if(this._super){this._super(props);}this.statusCssClass=this.showStatus?"":"hidden";},getSearchPattern:function getSearchPattern(){return this.inputBox.getSearchPattern();},getHighlightedText:function getHighlightedText(p,t){return this.inputBox.getHighlightedText(p,t);},item2textCss:function item2textCss(data){return{4:"m",7:"am",11:"fx",12:"a",13:"fc",43:"tr",47:"cs"}[data.t]||"";},handleSuggestionItemSelect:function handleSuggestionItemSelect(it){var p=this.abiguityDialog;if(it){p.onItemSelect(it);}p.close();},showDesc:true,showPath:true,abiguityDialog:{scriptClass:"mstrmojo.Editor",cssClass:"mstrmojo-ME-ambiguityDialog",onOpen:function(){this.set("title",mstrmojo.desc(13542,"Object Ambiguity - ##").replace("##",this.ambiguousName));this.list.clearSelect();this.list.set("items",this.items);this.list.singleSelect(0);this.label.set("text",mstrmojo.desc(13543,"More than one object with the name '##' were found.").replace("##",this.ambiguousName));},children:[{scriptClass:"mstrmojo.Label",alias:"label",text:""},{scriptClass:"mstrmojo.ui.ScrollableSuggestionList",alias:"list",cssClass:"mstrmojo-ME-ambiguityList",bindings:{items:"this.parent.opener.suggestionItems"},onclick:function(evt){mstrmojo._IsList.onclick.call(this,evt);}}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton hot",text:mstrmojo.desc(547,"Select"),onclick:function(){var dlg=this.parent.parent;dlg.opener.handleSuggestionItemSelect(dlg.list.selectedItem);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){this.parent.parent.close();}}]},defaultOnTokensModify:function(){this.set("vStatus",_VSTATUS.UNKNOWN);this.set("iStatus","");},postBuildRendering:function postBuildRendering(){this._super();this.inputBox.attachEventListener("tokensModify",this.id,"defaultOnTokensModify");this.inputBox.attachEventListener("tokensModify",this.id,"ontokensModify");},updateInputBoxItems:function updateInputBoxItems(r){this.inputBox.set("items",r.items);},replaceErrorToken:function replaceErrorToken(oi){this.inputBox.replaceErrorToken(oi);},handleValidation:function handleValidation(r){if(!r){this.set("vStatus",_VSTATUS.ERROR);return ;}r.vs=_mapErrorCode(r.rjec);this.set("vStatus",r.vs);this.set("iStatus",r.rjed||"");this.updateInputBoxItems(r);this.inputBox.focus();if(r.vs===_VSTATUS.AMBIGUITY){var me=this,its=r.items,ei=ARR.find(its,"sta",-1),ambiguousName=its[ei].v,f=function(oi){me.replaceErrorToken(oi);me.set("iStatus","");me.set("vStatus",_VSTATUS.UNKNOWN);if(me.continueValidataion){me.continueValidataion();}};var ambiguityItems=ARR.filter(r.srfd.items,this.isObjectVisible);var c=this.parent.candidates,citms=c&&c.items;if(citms){ARR.forEach(ambiguityItems,function(item){var idx=ARR.find(citms,"did",item.did);if(idx===-1){if(this.absorbAmbiguity){citms.push(item);}}else{item.path=citms[idx].path;}});}if(ambiguityItems.length===1){f(ambiguityItems[0]);return ;}this.openPopup("abiguityDialog",{zIndex:100,items:ambiguityItems,ambiguousName:ambiguousName,onItemSelect:f});}else{if(this.postHandleValidation){this.postHandleValidation();}}}});mstrmojo.ME.MetricEditBox.VALIDATION_STATUS=_VSTATUS;}());