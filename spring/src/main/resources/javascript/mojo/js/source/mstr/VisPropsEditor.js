(function(){mstrmojo.requiresCls("mstrmojo.EnumRWUnitType","mstrmojo.OIVMViewFactory","mstrmojo.vi.ui.BoxPanel","mstrmojo.vi.ui.DocBuilder","mstrmojo.vi.models.DocModel","mstrmojo.vi.controllers.DocumentController","mstrmojo.vi.controllers.UICmdMgr","mstrmojo.mstr.VisPropsEditorPanel");var $ARR=mstrmojo.array;var $HASH=mstrmojo.hash;var $UNIT_TYPES=mstrmojo.EnumRWUnitType;var MARGIN=11;var MOE_ID="mstrmojo-more-options-editor";var SIMPLE_THRESHOLD_ID="mstrmojo-simple-threshold-editor";var VIS_NAMES={gm:"GraphMatrixVisualizationStyle",heatmap:"VIHeatMapVisualizationStyle",network:"NetworkVisualizationStyle"};function findDataNode(object,nodeKey){var node=null;if(object!==null&&typeof object==="object"){if(object.k===nodeKey&&object.vis&&object.vis.we){return object;}$HASH.forEach($HASH.keyarray(object),function(key){if(object.hasOwnProperty(key)){node=findDataNode(object[key],nodeKey);}if(node){return false;}});}return node;}function findDefnNode(model,nodeKey){var node=null;$ARR.forEach(model.defn.layouts,function(layoutDefn){$ARR.forEach($HASH.keyarray(layoutDefn.units),function(k){var units=layoutDefn.units,unitDefn=units[k],t=(unitDefn&&unitDefn.t);if(!unitDefn||unitDefn._isDeleted||k!==nodeKey){return ;}if([$UNIT_TYPES.GRID,$UNIT_TYPES.GRAPH,$UNIT_TYPES.GRIDGRAPH].indexOf(t)>-1){node=unitDefn;return false;}});if(node){return false;}});return node;}var apis2remove=[];mstrmojo.mstr.VisPropsEditor=mstrmojo.declare(mstrmojo.Editor,[],{scriptClass:"mstrmojo.mstr.VisPropsEditor",title:"Visualization Properties Editor",width:"220px",nodeKey:null,init:function init(props){this._super(props);mstrmojo.css.addWidgetCssClass(this,"mstrmojo-VisPropsEditor rw");if(!mstrApp.onerror){mstrApp.onerror=function(err){window.console.log(err);};apis2remove.push("onerror");}if(!mstrApp.isInteractive){mstrApp.isInteractive=function(){return false;};apis2remove.push("isInteractive");}},start:function start(){this.loadDocModelData();},close:function close(){this._super();mstrmojo.array.forEach(apis2remove,function(api){delete mstrApp[api];});if(mstrmojo.all[MOE_ID]){mstrmojo.all[MOE_ID].destroy();}if(mstrmojo.all[SIMPLE_THRESHOLD_ID]){mstrmojo.all[SIMPLE_THRESHOLD_ID].destroy();}},children:[{scriptClass:"mstrmojo.HBox",alias:"buttonBarx",slot:"buttonNode",cssClass:"mstrmojo-VPE-buttonBox",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button mstrmojo-WebButton hot",alias:"btnOK",text:"OK",bindings:{enabled:function(){return(this.parent.parent.actions||[]).length>0;}},onclick:function(){var editor=this.parent.parent;editor.saveProps(editor.actions);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button mstrmojo-WebButton",text:"Cancel",onclick:function(){var editor=this.parent.parent;editor.close();}}]}],preparePropsPanelRendering:function preparePropsPanelRendering(docModelData){var me=this;this.model=new mstrmojo.vi.models.DocModel(docModelData);this.model.getDocBuilder=null;this.builder=new mstrmojo.vi.ui.DocBuilder({parent:this,model:this.model});mstrApp.viewFactory=new mstrmojo.OIVMViewFactory();this.controller=new mstrmojo.vi.controllers.DocumentController({model:this.model,submitUndoRedoUpdates:function(actions){var editor=me;actions=mstrmojo.array.ensureArray(actions);var action=actions[0],newActions=editor.mergeActions(action.actions?[{act:action.act,keyContext:action.keyContext||me.nodeKey,actions:action.actions}]:actions);editor.saveProps(newActions);}});this.model.controller=this.controller;this.controller.cmdMgr=new mstrmojo.vi.controllers.UICmdMgr({controller:this.controller,model:this.model,dataService:this.model.getDataService()});},isVizValid:function(){var node=this.getVisNode();if(this.visName===VIS_NAMES.gm){if(mstrmojo.gm.GMUtility.isInvalidTemplate(node.data)){this.close();mstrmojo.alert(mstrmojo.gm.GMUtility.getInvalidTemplateErrMsg());return false;}}return true;},renderPropsPanel:function renderPropsPanel(docModelData){this.preparePropsPanelRendering(docModelData);if(!this.isVizValid()){return ;}this.addChildren([{scriptClass:"mstrmojo.mstr.VisPropsEditorPanel",alias:"propsPanel",width:parseInt(this.width)-2*MARGIN+"px",height:parseInt(this.height)-2*MARGIN+"px",edtModel:this.getEditorModel()}]);this.render();},getEditorModel:function getEditorModel(){return this.getVisInstance().edtModel;},getVisNode:function getVisNode(){this.node={defn:findDefnNode(this.model,this.nodeKey),data:findDataNode(this.model.data,this.nodeKey)};var visName=this.visName=this.builder.getMojoVisName(this.node);if(visName){this.node.data.visName=visName;}return this.node;},getVisInstance:function getVisInstance(){var me=this,model=this.model,node=this.node=this.getVisNode();var mojoViz=this.builder.newMojoVisualization(model,node);mojoViz.defn=node.defn;mojoViz.k=this.nodeKey;mojoViz.updateAfterAction=function(actions){me.set("actions",me.mergeActions(actions));};if(this.visName===VIS_NAMES.gm||this.visName===VIS_NAMES.heatmap){mojoViz.submitUpdatesAndPersistXML=function(actions){actions=actions||[];if(this.isXMLDirty&&this.isXMLDirty()){actions.push(this.getPersistAction());}if(actions.length===0){return ;}me.set("actions",me.mergeActions(actions));};}mojoViz.parent=this;this.getTitleBarVisibility=function(){return true;};mojoViz.showTitleAndContainerFormats=false;if(mojoViz.zonesModel){mojoViz.zonesModel.checkAndWarnLargeItemsForAddUnits=function(allowItems,callback){callback();};mojoViz.zonesModel.getUpdateCallback=function(){return{success:function(){var contents=me.propsPanel&&me.propsPanel.contents;if(contents){contents.removeChildren();me.propsPanel.raiseEvent({name:"edtModelChanged"});}}};};}mojoViz.skipPaintedCheck=true;mojoViz.forceUpdateColorMap=true;mojoViz.skipSuppressDataCheck=true;mojoViz.update(node);this.renderViz(mojoViz);return mojoViz;},renderViz:function renderViz(viz){var needRender=[VIS_NAMES.heatmap,VIS_NAMES.gm,VIS_NAMES.network].indexOf(this.visName)>-1;if(needRender){mstrApp.getThemeClassName=function(){return"mojo-theme-light";};viz.placeholder=document.createElement("span");viz.width="0px";viz.height="0px";viz.render();}if(this.visName===VIS_NAMES.network){viz.refresh=function(){};}if(this.visName===VIS_NAMES.heatmap){viz.reRender=function(){};}},mergeActions:function mergeActions(actions){return(this.actions||[]).concat(actions);},saveProps:function saveProps(actions,closeAfterSave){var editor=this,fnCloseEditor=function(){if(closeAfterSave!==false){editor.close();}};if(actions.length>0){this.submitPropsChange(actions,function cbSuccess(){if(editor.onOK){editor.onOK();}fnCloseEditor();});}else{fnCloseEditor();}},submitPropsChange:function submitPropsChange(actions,cbSuccess){var params={actions:actions,style:{name:"RWIVEMojoStyle",params:{treesToRender:0}}};var request={taskId:"mojoRWManipulation",rwb:this.rwb,messageID:this.messageID,stateID:-1,params:JSON.stringify(params),suppressData:true};var callback={success:function(res){cbSuccess(res);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mstrmojo.xhr.request("POST",mstrConfig.taskURL,callback,request);},loadDocModelData:function loadDocModelData(){var me=this,iveStyleName="ServerJsonRWDStyle";this.retrieveServerJson({host:this,nodes:[this.nodeKey]},{success:function(res){me.renderPropsPanel(res);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{style:{name:iveStyleName,params:{treesToRender:3}},params:{styleName:iveStyleName}});},retrieveServerJson:function retrieveServerJson(params,callback,extras){var requestParams={},style,extraParams;var partialRetrieval=params.nodes;if(partialRetrieval){requestParams.partialRetrieval=partialRetrieval;}var slices=params.slices;if(slices){requestParams.slices=slices;}if(extras){style=extras.style;extraParams=extras.params;}var request={taskId:"getServerJSONResults",styleName:"ServerJsonRWDStyle",compress:1,rwb:this.rwb,messageID:this.messageID,stateID:-1,params:JSON.stringify(requestParams)};if(this.executionMode){request.executionMode=this.executionMode;}mstrmojo.hash.copy(extraParams,request);mstrmojo.xhr.request("POST",mstrConfig.taskURL,callback,request);}});}());