(function(){mstrmojo.requiresCls("mstrmojo.Base");mstrmojo.requiresClsP("mstrmojo.chart","FormatFont");var $C=mstrmojo.chart;mstrmojo.chart.SubTextHolder=mstrmojo.declare(mstrmojo.Base,null,{scriptClass:"mstrmojo.chart.SubTextHolder",mVecStr:null,mInitVecPartition:null,mVecPartition:null,mVecSize:null,mSpaceWidth:0,mMaxWordWidth:0,init:function init(props){this._super(props);this.mVecStr=[];this.mInitVecPartition=[];this.mVecPartition=[];this.mVecSize=[];},Clear:function Clear(){this.mVecStr.splice(0,this.mVecStr.length);},ParseText:function ParseText(irText,iSeparator,iWordLengthLimit){var initVecPartition=this.mInitVecPartition,vecStr,vecSize,partitionPosition,i,j,vecWord=[],vecWordSize;vecStr=irText.split("\n");initVecPartition.splice(0,this.mInitVecPartition.length);initVecPartition.push(0);partitionPosition=0;vecSize=vecStr.length;for(i=0;i<vecSize;++i){vecWord=vecStr[i].split(iSeparator);partitionPosition+=vecWord.length;initVecPartition.push(partitionPosition);vecWordSize=vecWord.length;for(j=0;j<vecWordSize;++j){this.mVecStr.push(this.TruncateWord(vecWord[j],iWordLengthLimit));}}this.mVecPartition=initVecPartition.concat();},TruncateWord:function TruncateWord(irString,iWordLengthLimit){if(iWordLengthLimit<4||iWordLengthLimit>irString.length){return irString;}var text=irString.substr(0,iWordLengthLimit-3);text+="...";return text;},UpdateText:function UpdateText(iChartContextPtr,ipDeviceFont){var fontPtr,maxWordWidth,len,i,textExtent,resultVal;this.mVecSize.splice(0,this.mVecSize.length);fontPtr=ipDeviceFont;maxWordWidth=0;len=this.mVecStr.length;for(i=0;i<len;i++){textExtent={width:0,mX_bearing:0,mX_advance:0};if(this.mVecStr[i]===""){this.mVecSize.push(textExtent);}else{resultVal=fontPtr.GetStringExtent(this.mVecStr[i]);textExtent.width=textExtent.mX_advance=resultVal.Width;this.mVecSize.push(textExtent);if(resultVal.Width>maxWordWidth){maxWordWidth=resultVal.Width;}}}this.mMaxWordWidth=maxWordWidth;resultVal=fontPtr.GetStringExtent(" ");this.mSpaceWidth=resultVal.Width;},GetMaxWidth:function GetMaxWidth(){var maxWidth,len,i,width;maxWidth=0;len=this.mVecPartition.length;for(i=0;i+1<len;++i){width=this.GetOneLineWidth(i);if(width>maxWidth){maxWidth=width;}}return Math.floor(maxWidth+0.5);},GetOneLineWidth:function GetOneLineWidth(iLineIndex){var vecPartition=this.mVecPartition,vecSize=this.mVecSize,width,i;width=0;for(i=vecPartition[iLineIndex];i<vecPartition[iLineIndex+1];i++){if(i===vecPartition[iLineIndex]&&i===vecPartition[iLineIndex+1]-1){width+=vecSize[i].width;}else{if(i===vecPartition[iLineIndex]&&i!==vecPartition[iLineIndex+1]-1){width+=vecSize[i].mX_advance-vecSize[i].mX_bearing;}else{if(i!==vecPartition[iLineIndex]&&i===vecPartition[iLineIndex+1]-1){width+=vecSize[i].width+vecSize[i].mX_bearing;}else{width+=vecSize[i].mX_advance;}}}if(i!==vecPartition[iLineIndex]){width+=this.mSpaceWidth;}}return width;},GetOneWordWidth:function GetOneWordWidth(idx){return this.mVecSize[idx].width;},GetStringWidth:function GetStringWidth(str,formatFont){var lRetValue=formatFont.GetStringExtent(str);return lRetValue.Width;},GetSpaceWidth:function GetSpaceWidth(){return this.mSpaceWidth;},GetSpaceWidthEx:function GetSpaceWidthEx(formatFont){var value=formatFont.GetStringExtent(" ");return value.Width;},GetLineCount:function GetLineCount(){return this.mVecPartition.length-1;},SetLineCount:function SetLineCount(lineCount,maxLineLength){if(lineCount<1){return ;}if(maxLineLength!==0){maxLineLength=maxLineLength||-1;}var vecPartition=this.mVecPartition;if(lineCount===1){vecPartition.splice(0,vecPartition.length);vecPartition.push(0);vecPartition.push(this.mVecSize.length);}else{if(this.GetLineCount()<=lineCount){if(maxLineLength===-1){return ;}if(this.GetMaxWidth()<=maxLineLength){return ;}this.PartitionBy(maxLineLength,true);if(this.GetLineCount()>lineCount){vecPartition.length=lineCount+1;vecPartition[vecPartition.length-1]=this.mVecSize.length;}}else{vecPartition.length=lineCount+1;vecPartition[vecPartition.length-1]=this.mVecSize.length;}}},PartitionBy:function PartitionBy(iDestWidth,iIsStrigent){var vecPartition=this.mVecPartition,initVecPartition=this.mInitVecPartition,lVecPartitionSize,i,j,sumWidth,dividedPosition;iIsStrigent=(iIsStrigent!==undefined)?iIsStrigent:true;if(!iIsStrigent&&iDestWidth<this.mMaxWordWidth){iDestWidth=Math.floor(this.mMaxWordWidth+0.5);}vecPartition.splice(0,vecPartition.length);lVecPartitionSize=initVecPartition.length;for(i=0;i+1<lVecPartitionSize;++i){vecPartition.push(initVecPartition[i]);sumWidth=0;dividedPosition=initVecPartition[i];for(j=initVecPartition[i];j<initVecPartition[i+1];j++){sumWidth+=this.mVecSize[j].mX_advance;if(j!==initVecPartition[i+1]-1){sumWidth+=this.mSpaceWidth;}if(sumWidth>iDestWidth&&j!==dividedPosition){sumWidth=0;dividedPosition=j;vecPartition.push(j--);}}}if(lVecPartitionSize>0){vecPartition.push(initVecPartition[lVecPartitionSize-1]);}},GetOneLineString:function GetOneLineString(iLineIndex){var vecPartition=this.mVecPartition,lString="",i;for(i=vecPartition[iLineIndex];i<vecPartition[iLineIndex+1];i++){lString=lString.concat(this.mVecStr[i]);if(i!==vecPartition[iLineIndex+1]-1){lString=lString.concat(" ");}}return lString;},GetOneLineWords:function GetOneLineWords(iLineIndex){var vecPartition=this.mVecPartition,i,indexArray=[];for(i=vecPartition[iLineIndex];i<vecPartition[iLineIndex+1];i++){indexArray.push(i);}return indexArray;},GetOneLineXBearing:function GetOneLineXBearing(iLineIndex){return this.mVecSize[this.mVecPartition[iLineIndex]].mX_bearing;}});}());