(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.dom","mstrmojo.form");var DOM=mstrmojo.dom;var FORM=mstrmojo.form;function findChildWithAtt(el,tagName,att,value){var nodes=el.getElementsByTagName(tagName);var found=mstrmojo.array.filter(nodes,function(node){return node.getAttribute(att)===value;});return found[0];}function uploadDashboardFile(formId){var form=document.getElementById(formId),myFileInput=findChildWithAtt(form,"input","name","myFile"),file=myFileInput.value,resetFileInput=function(){if(DOM.isIE){var fm=document.createElement("form");myFileInput.parentNode.insertBefore(fm,myFileInput);fm.appendChild(myFileInput);fm.reset();fm.removeNode(false);}};if(file===""){return ;}else{if(/\.mstr$/.test(file.toLowerCase())){mstrApp.showWait(true);FORM.addURLAsHiddenInputsToForm(form,mstrmojo.addCSRFTokenToURL(mstrApp.name+"="+encodeURIComponent(mstrApp.servletState)));if(mstrApp.currentFolderId){var folderIDInput=document.getElementById("import_folderID");folderIDInput.value=mstrApp.currentFolderId;}if(!findChildWithAtt(form,"input","name","formId")){var formInput=document.createElement("input");formInput.type="hidden";formInput.name="formId";formInput.value=form.id;form.appendChild(formInput);}form.submit();form.reset();}else{mstrmojo.alert(mstrmojo.desc(11227),null,mstrmojo.desc(11226));}}resetFileInput();}function uploadCallback(res){var success=res.status===200,resContent=res.content,sn=mstrApp.name,updateAndSubmitForm=function(params){mstrApp.showWait();var form=document.getElementById(resContent.formId||"import_form"),newInputsAdded=[],i=0,formInput;mstrmojo.hash.forEach(params,function(value,key){if(key==="folderId"){if(DOM.isIE8){var folder_id=document.getElementById("import_folderID");if(folder_id){folder_id.value=value;}}}else{formInput=document.createElement("input");formInput.type="hidden";formInput.name=key;formInput.value=value;form.appendChild(formInput);newInputsAdded[i++]=formInput;}});window.setTimeout(function(){form.submit();for(var i=0;i<newInputsAdded.length;i++){form.removeChild(newInputsAdded[i]);}},0);};if(resContent&&resContent.messageID){var folderId=(resContent.fdid?resContent.fdid:"");if(resContent.isConflict){var replaceFn=function(){updateAndSubmitForm({messageID:resContent.messageID,resume:true});},saveAsFn=function(){var renameEditor=mstrmojo.insert({scriptClass:"mstrmojo.ui.editors.RenameEditor",renameText:resContent.n,title:mstrmojo.desc(13052,"Upload"),zIndex:1002,onRename:function(newName){if(mstrmojo.string.isEmpty(newName)){mstrmojo.alert("Please enter a valid name",null,null,1004);return false;}else{updateAndSubmitForm({messageID:resContent.messageID,resume:true,dashboardName:newName});var conflictDialog=mstrmojo.all.ImportNameConflictDialog;if(conflictDialog){conflictDialog.destroy();}}}});renameEditor.open();return false;},closeFn=function(){mstrApp.hideWait();};closeFn();mstrmojo.confirm(mstrmojo.desc(8134,"The Dashboard ## already exists. Do you want to replace the existing Dashboard?").replace("##",("<strong>"+resContent.n+"</strong>")),null,{id:"ImportNameConflictDialog",title:mstrmojo.desc(13052,"Upload"),allowHTML:true,buttons:[mstrmojo.Button.newWebButton(mstrmojo.desc(219,"Yes"),replaceFn,true),mstrmojo.Button.newWebButton(mstrmojo.desc(3167,"Save As"),saveAsFn,true),mstrmojo.Button.newWebButton(mstrmojo.desc(3416,"Cancel"),closeFn)],onPreClose:function(){closeFn();return true;}});}else{updateAndSubmitForm({messageID:resContent.messageID,folderId:folderId});}}else{if(success){var okUrl=mstrmojo.addCSRFTokenToURL(sn+"?evt=2001&src="+sn+".2001"+((resContent&&resContent.fdid)?("&folderID="+resContent.fdid):"&systemFolder=20")),dashboarUrl=getExecuteDashboardUrl(resContent.did),closeAndLoadUrl=function(url){if(this.parent===null&&this.close){this.close();}else{this.parent.parent.close();}if(url){eval(url);}},viewDashboardFn=mstrmojo.emptyFn,shareDashboardFn=function(){mstrmojo.mstr._ObjectActions.openSharingEditor(resContent.servletPath+dashboarUrl,{objectName:resContent.n,objId:resContent.did,objType:"55",mid:-1},false,{showLinkOnOpen:true});};if(!mstrmojo.resolveFeature("flashvi")&&(DOM.isIE8)){viewDashboardFn=function(){closeAndLoadUrl.call(this);mstrmojo.alert(mstrmojo.desc(12187));};}else{viewDashboardFn=function(){closeAndLoadUrl.call(this,"location.href = '"+dashboarUrl+"'");};}var currentFolderName=mstrApp.currentFolderName&&mstrApp.currentFolderName();var uploadResultEditor=mstrmojo.insert({scriptClass:"mstrmojo.onetier.vi.ui.UploadResultEditor",folderName:currentFolderName||"My Reports",dashboardName:resContent.n,okFn:function(){closeAndLoadUrl.call(this,currentFolderName&&"location.href = '"+okUrl+"'");},viewDashboardFn:viewDashboardFn,shareDashboardFn:shareDashboardFn});uploadResultEditor.open();}else{mstrmojo.error({longDesc:res.errorMsg});}mstrApp.hideWait(true);}}function getExecuteDashboardUrl(documentId){var servletName=mstrApp.name,eventId,params;if(mstrmojo.resolveFeature("flashvi")){eventId=2048001;params={visMode:0};}else{eventId=3140;params={};}params.documentID=documentId;params.evt=eventId;params.src=servletName+"."+eventId;var paramArray=[];for(var k in params){if(!params.hasOwnProperty(k)){continue;}paramArray.push(encodeURIComponent(k)+"="+encodeURIComponent(params[k]));}return mstrmojo.addCSRFTokenToURL(servletName+"?"+paramArray.join("&"));}mstrmojo.mstr.ui.MstrFileUploadHelper={uploadDashboardFile:uploadDashboardFile,uploadCallback:uploadCallback};}());