(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.css","mstrmojo.expr","mstrmojo.ValidationTextBox","mstrmojo.HBox","mstrmojo.ui.menus.EditorConfig","mstrmojo.mstr.EnumFunction","mstrmojo.DropDownList","mstrmojo.ui.Pulldown","mstrmojo.SearchablePulldown","mstrmojo.ButtonList","mstrmojo.Box","mstrmojo.Label","mstrmojo.RadioList","mstrmojo.CheckList","mstrmojo.EditableLabel","mstrmojo.CheckBox","mstrmojo.fe.FilterEditor","mstrmojo._FormatDefinition","mstrmojo.num","mstrmojo.locales","mstrmojo.vi.models.VIComponentMap","mstrmojo.func","mstrmojo.dom","mstrmojo.ME.AttributeEditBox","mstrmojo.string","mstrmojo.dom","mstrmojo.models.datasets.DataInterface","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.vi.ui.editors.ObjectPicker","mstrmojo.vi.ui.editors.AttributeLinkEditor","mstrmojo.vi.ui.NumberFormatter");mstrmojo.requiresDescs(1442,1885,1886,2022,2122,2123,2124,2125,2126,2127,2128,2129,2130,2131,2132,3993,4564,11494,11495,11496,11497,14612);var $EF=mstrmojo.mstr.EnumFunction,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$EXPR_TYPES=mstrmojo.expr.ET,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$NWB=mstrmojo.Button.newWebButton,$BKTS=mstrmojo.ME.MetricToken.brackets,$FD=mstrmojo._FormatDefinition,$DATASET_INTERFACE=mstrmojo.models.datasets.DataInterface,$VI_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,$DSSOBJ_TYPES=mstrmojo.chart.model.enums.EnumDSSObjectType;var FN={SUM:mstrmojo.desc(2131,"Sum"),ADD:mstrmojo.desc(6017,"Add"),AVG:mstrmojo.desc(2122,"Average"),MAX:mstrmojo.desc(2125,"Maximum"),GST:mstrmojo.desc(5869,"Greatest"),MIN:mstrmojo.desc(2127,"Minimum"),LST:mstrmojo.desc(5868,"Least"),CNT:mstrmojo.desc(2123,"Count"),MTP:mstrmojo.desc(5418,"Multiply"),STD:mstrmojo.desc(2130,"Standard Deviation"),PTD:mstrmojo.desc(11494,"Population Standard Deviation")},FE={SUM:{n:FN.SUM,t:$EF.FunctionSum},ADD:{n:FN.ADD,t:$EF.FunctionPlus},AVG:{n:FN.AVG,t:$EF.FunctionAvg},MAX:{n:FN.MAX,t:$EF.FunctionMax},GST:{n:FN.GST,t:$EF.FunctionGreatest},MIN:{n:FN.MIN,t:$EF.FunctionMin},LST:{n:FN.LST,t:$EF.FunctionLeast},TMS:{n:FN.MTP,t:$EF.FunctionTimes},CNT:{n:FN.CNT,t:$EF.FunctionCount},GEM:{n:mstrmojo.desc(2124,"Geometric Mean"),t:$EF.FunctionGeomean},MED:{n:mstrmojo.desc(2126,"Median"),t:$EF.FunctionMedian},MOD:{n:mstrmojo.desc(2128,"Mode"),t:$EF.FunctionMode},PDT:{n:mstrmojo.desc(2129,"Product"),t:$EF.FunctionProduct},STD:{n:mstrmojo.desc(2130,"Standard Deviation"),t:$EF.FunctionStdev},VAR:{n:mstrmojo.desc(2132,"Variance"),t:$EF.FunctionVar}},RTF=[{n:FN.SUM,t:$EF.FunctionOLAPSum},{n:FN.AVG,t:$EF.FunctionOLAPAvg},{n:FN.MIN,t:$EF.FunctionOLAPMin},{n:FN.MAX,t:$EF.FunctionOLAPMax},{n:FN.CNT,t:$EF.FunctionOLAPCount}],MTF=[{n:FN.SUM,t:$EF.FunctionOLAPSum},{n:FN.AVG,t:$EF.FunctionOLAPAvg},{n:FN.MIN,t:$EF.FunctionOLAPMin},{n:FN.MAX,t:$EF.FunctionOLAPMax},{n:FN.CNT,t:$EF.FunctionOLAPCount}],REL=[{n:mstrmojo.desc(1058,"Previous"),t:$EF.FunctionLag},{n:mstrmojo.desc(1059,"Next"),t:$EF.FunctionLead},{n:mstrmojo.desc(4046,"First"),t:$EF.FunctionFirst},{n:mstrmojo.desc(4049,"Last"),t:$EF.FunctionLast}];function getDropDownListCfg(items,defaultIndex,propName,getSelectedValue){return{scriptClass:"mstrmojo.ui.Pulldown",items:items,selectedIndex:defaultIndex,onitemSelected:function onitemSelected(item){var dataParent=this.parent;while(!dataParent.data||!dataParent.data[propName]){dataParent=dataParent.parent;}dataParent.data.set(propName,getSelectedValue?getSelectedValue(item):item.v);}};}function getBreakByPullDownCfg(breakByUnits,defaultBreakByIndex){return{scriptClass:"mstrmojo.Box",cssClass:"breakByBox",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13903,"Break by:")},getDropDownListCfg(breakByUnits,defaultBreakByIndex,"breakBy",function(selectedItem){return{id:selectedItem.did,type:selectedItem.t,dmy:selectedItem.dmy};})]};}function getCalculationPulldownCfg(config){var metrics=config.metrics,propName=config.propName,idField=config.optionValueField||"id",selIdx=$ARR.find(metrics,idField,config.value),setDataFn=function setDataFn(selectedItem){var menuEditor=this.parent;while(!menuEditor.data||!menuEditor.data.hasOwnProperty(propName)){menuEditor=menuEditor.parent;}menuEditor.data.set(propName,selectedItem?{id:selectedItem[idField],type:4}:{cst:this.text});};return{scriptClass:"mstrmojo.ui.SearchablePulldown",items:metrics,selectedIndex:selIdx,useRichTooltip:true,bindings:config.bindings,valid:true,allowCustomText:true,allowEmptyText:true,onvalidChange:function onvalidChange(){mstrmojo.css.toggleClass(this.domNode,"invalid",!this.valid);if(this.hasRendered){this.hideTooltip();this.showTooltip();}},updateTooltipConfig:function(){if(this.valid){this.richTooltip=null;return ;}this.richTooltip={posType:mstrmojo.tooltip.POS_BOTTOMLEFT,cssClass:"vi-warning vi-tooltip-C vi-calculation-warning",left:this.domNode.offsetWidth+12,top:this.domNode.offsetHeight+5,refNode:this.domNode,content:mstrmojo.desc(13819,"Invalid input")};},onitemSelected:setDataFn,onTextEditComplete:function(){setDataFn.call(this,this.items[this.selectedIndex]);},onPopupWidgetOpened:function(){this.set("valid",true);},postkeyup:config.postkeyup};}function findEmmaAttribute(data,tableId,attrid){if(data&&data.datap){var tb=$ARR.filterOne(data.datap,function(it){return it.tbid===tableId;}),amps=tb&&tb.maps.amps;return $ARR.filterOne(amps,function(it){return attrid===it.aimp.atid;});}return null;}function findEmmaMappingColumn(attrdata,formid){var fd=$ARR.filterOne(attrdata&&attrdata.afmps,function(it){return it.fmid===formid;}),oi=fd&&(fd.sqc?fd:fd.col.oi),col;if(oi&&oi.sqc){col={did:oi.sqc.id,n:mstrmojo.string.decodeHtmlString(oi.cln),coldtp:oi.sqc.dt.tp,georole:oi.geo,timerole:oi.tim,der:oi.sqc.der};}else{if(oi){col={did:oi.did,n:mstrmojo.string.decodeHtmlString(oi.def.cln),coldtp:oi.def.dt.tp,georole:fd.geo,timerole:oi.def.dicl.time,der:oi.def.dicl.der};}}return col;}function requestEmmaCubeModel(msgid,datasetid,callback){var afterDup={success:function(res){if(res&&res.msgid){mstrApp.serverRequest({taskId:"qBuilder.GetReportXDADefinition",msgid:res.msgid,bindingflag:2,previewflag:261,browsetype:5},callback);}},failure:function(err){mstrApp.onerror(err);}};mstrApp.serverRequest({taskId:"duplicateReportInstance",datasetID:datasetid,messageID:msgid},afterDup);}function linkEmmaAttribute(params,model,onOK){var srctbid=params.srcTableId,tgttbid=params.tgtTableId,src,tgt,getLinkAction=function(tbid,acts){var mapxml="<mpcs><mpc ",act,val;for(act in acts){val=acts[act];mapxml+='$ACT="$VAL" '.replace("$ACT",act).replace("$VAL",val);}mapxml+="/></mpcs>";return{act:"changeEMMAMapping",tbid:tbid,dsid:params.dsid,mapping:mapxml};},validateFn=function(res){var valcb={success:function(){lnk();}},srccol,valact;src=findEmmaAttribute(res,srctbid,params.srcId);tgt=findEmmaAttribute(res,tgttbid,params.tgtId);srccol=findEmmaMappingColumn(src,src.afmps[0].fmid);valact=[getLinkAction(srctbid,{did:srccol.did,oid:tgt.aimp.atid,fg:1})];model.getDataService().submitUpdates(valact,valcb);},lnk=function(){var acts=[],actObjs={},srccol,tgtcol;if(!src||!tgt){return ;}actObjs[srctbid]={};actObjs[tgttbid]={};$ARR.forEach(src.afmps,function(fm){var idx=$ARR.find(tgt.afmps,"fmid",fm.fmid),actid,actval,acttbid;if(idx>=0){srccol=findEmmaMappingColumn(src,fm.fmid);tgtcol=findEmmaMappingColumn(tgt,fm.fmid);if(srccol.georole!==tgtcol.georole){acttbid=(srccol.georole===0)?srctbid:tgttbid;actid=(srccol.georole===0)?srccol.did:tgtcol.did;actval=srccol.georole||tgtcol.georole;actObjs[acttbid][actid]=$HASH.copy({did:actid,georole:actval},actObjs[acttbid][actid]);}if(srccol.timerole!==tgtcol.timerole){acttbid=(srccol.timerole===0)?srctbid:tgttbid;actid=(srccol.timerole===0)?srccol.did:tgtcol.did;actval=srccol.timerole||tgtcol.timerole;actObjs[acttbid][actid]=$HASH.copy({did:actid,timerole:actval},actObjs[acttbid][actid]);}if(srccol.der!==tgtcol.der){actval=srccol.der|tgtcol.der;actObjs[srctbid][srccol.did]=$HASH.copy({did:srccol.did,drvflg:actval},actObjs[srctbid][srccol.did]);actObjs[tgttbid][tgtcol.did]=$HASH.copy({did:tgtcol.did,drvflg:actval},actObjs[tgttbid][tgtcol.did]);}}});$HASH.forEach(actObjs,function(tbacts,tbid){$HASH.forEach(tbacts,function(actobj){acts.push(getLinkAction(tbid,actobj));});});srccol=findEmmaMappingColumn(src,src.afmps[0].fmid);acts.push(getLinkAction(srctbid,{did:srccol.did,oid:tgt.aimp.atid}));if(onOK){onOK(acts);}};requestEmmaCubeModel(model.mid,params.dsid,{success:validateFn});}function loadObjectDefn(msgID,daid,fms,callback){var idx=0,pfms=[],itfn=function(res){var fm=fms[idx-1];if(res&&res.tks&&fm){pfms.push({fid:fm.fid,fnm:fm.fnm,ftk:res.tks.items});}if(idx===fms.length){callback(pfms);return ;}fm=fms[idx++];mstrmojo.ME.MetricDataService.validateMetric({metricId:daid,formID:fm.fid,objectType:12,tokenStreamXML:"",metricXML:"",msgID:msgID},{success:itfn});};itfn();}function getFormToken(attr,fm){return{v:$BKTS(attr.n)+"@"+$BKTS(fm.fnm),tp:275,lv:1,exv:fm.fid,extp:8,oi:{did:attr.did,t:attr.t,n:attr.n}};}mstrmojo.vi.ui.DatasetUnitMenuUtils=mstrmojo.provide("mstrmojo.vi.ui.DatasetUnitMenuUtils",{getAvailableShortcutMetricFunctionsGroup:function getAvailableShortcutMetricFunctionsGroup(item){return{"12":[[FE.AVG,FE.CNT,FE.MAX,FE.MIN,FE.STD,FE.SUM,FE.VAR]],"4":[[FE.SUM,FE.AVG,FE.MIN,FE.MAX,FE.CNT],[FE.GEM,FE.MED,FE.MOD,FE.PDT,FE.STD,FE.VAR]]}[item.t];},isAmongFunctions:function isAmongFunctions(funcType,functionsGroup){return functionsGroup.some(function(functions){return functions.some(function(func){return func.t===funcType;});});},getMultiSelectionShortcutMetricFunctions:function getMultiSelectionShortcutMetricFunctions(items){var mx=true;$ARR.forEach(items,function(item){if(4!==item.t){mx=false;return false;}return true;});return mx?[FE.ADD,FE.AVG,FE.GST,FE.LST,FE.TMS]:[];},getRelativeReferenceMenu:function getRelativeReferenceMenu(item,refLabelText,breakByUnits,onOk){var defaultRelativeRefIndex=0,relativeRef=REL[defaultRelativeRefIndex],defaultBreakByIndex=0,breakBy=breakByUnits&&breakByUnits[defaultBreakByIndex];return new mstrmojo.ui.menus.EditorConfig({data:{item:item,relativeRef:relativeRef,breakBy:breakBy},cssClass:"RelativeReference-MenuEditor",contents:[{scriptClass:"mstrmojo.Box",cssClass:"funcBox",children:[{scriptClass:"mstrmojo.Label",visible:refLabelText&&refLabelText.length,text:refLabelText},getDropDownListCfg(REL,defaultRelativeRefIndex,"relativeRef",function(selectedItem){return selectedItem.t;})]},getBreakByPullDownCfg(breakByUnits,defaultBreakByIndex)],fnOk:function(data){return onOk(data.item,data.relativeRef,[data.breakBy]);}});},getMovingTotalMenu:function getMovingTotalMenu(item,breakByUnits,onOk){var defaultFuncIndex=1,funcType=MTF[defaultFuncIndex].t,windowSize=1,windowSizeDesc=mstrmojo.desc(13289,"Starting previous##rows").split("##"),defaultBreakByIndex=0,breakBy=breakByUnits&&breakByUnits[defaultBreakByIndex];return new mstrmojo.ui.menus.EditorConfig({cssClass:"MovingTotal-MenuEditor",data:{item:item,funcType:funcType,windowSize:windowSize,breakBy:breakBy},contents:[getDropDownListCfg(MTF,defaultFuncIndex,"funcType",function(selectedItem){return selectedItem.t;}),{alias:"winSzBox",scriptClass:"mstrmojo.HBox",children:[{scriptClass:"mstrmojo.Label",cssClass:"WinSzPrefix",text:windowSizeDesc[0]},{alias:"winSz",scriptClass:"mstrmojo.ValidationTextBox",required:true,dtp:mstrmojo.expr.DTP.INTEGER,constraints:{trigger:mstrmojo.validation.TRIGGER.ALL,min:1},postCreate:function postCreate(){this.set("value",windowSize);},_ontooltipover:function(){var vtb=mstrmojo.all[this.id];vtb._hovered=true;vtb.showTooltip();},_ontooltipout:function(){var vtb=mstrmojo.all[this.id];vtb._hovered=false;vtb.hideTooltip();},useRichTooltip:true,tooltipOpenDelay:0,onInvalid:function(){var errorMsg=this.validationStatus.msg,tooltipChanged=!(this.richTooltip&&errorMsg===this.richTooltip.content);this.richTooltip={posType:mstrmojo.tooltip.POS_BOTTOMLEFT,cssClass:"vi-warning vi-tooltip-V",top:-5,refNode:this.domNode,content:errorMsg};if(this._hovered&&tooltipChanged){this.hideTooltip();this.showTooltip();}},onValid:function(){this.richTooltip=null;this.hideTooltip();},postvalueChange:function postvalueChange(){var valid=this.isValid();this.parent.parent.popupConfig.data.set("windowSize",valid?parseInt(this.value,10):0);}},{scriptClass:"mstrmojo.Label",cssClass:"WinSzSuffix",text:windowSizeDesc[1]}]},getBreakByPullDownCfg(breakByUnits,defaultBreakByIndex)],bindings:{okEnabled:function(){return !!this.data.windowSize;}},fnOk:function fnOk(data){if(onOk){onOk(item,data.funcType,data.windowSize,[data.breakBy]);}}});},getRunningTotalMenu:function getRunningTotalMenu(item,breakByUnits,onOk){var defaultFuncIndex=0,defaultFunc=RTF[defaultFuncIndex].t,defaultBreakByIndex=0,breakBy=breakByUnits&&breakByUnits[defaultBreakByIndex];return new mstrmojo.ui.menus.EditorConfig({data:{item:item,func:defaultFunc,breakBy:breakBy},cssClass:"RunningTotal-MenuEditor",contents:[getDropDownListCfg(RTF,defaultFuncIndex,"func",function(selectedItem){return selectedItem.t;}),getBreakByPullDownCfg(breakByUnits,defaultBreakByIndex)],fnOk:function(data){return onOk(data.item,data.func,[data.breakBy]);}});},getRankMetricEditor:function getRankMetricEditor(item,breakByUnits,onOk){var order=[{n:mstrmojo.desc(1886,"Descending"),v:"0"},{n:mstrmojo.desc(1885,"Ascending"),v:"-1"}],defaultOrderIndex=0,asc=order[defaultOrderIndex].v,defaultBreakByIndex=0,breakBy=breakByUnits&&breakByUnits[defaultBreakByIndex];return new mstrmojo.ui.menus.EditorConfig({data:{item:item,order:asc,breakBy:breakBy},cssClass:"NewRankMetric-MenuEditor",contents:[{scriptClass:"mstrmojo.Box",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(14612,"Sort:")},getDropDownListCfg(order,defaultOrderIndex,"order")]},getBreakByPullDownCfg(breakByUnits,defaultBreakByIndex)],fnOk:function(data){return onOk(data.item,data.order,[data.breakBy]);}});},insertAddUnitToFilterMenu:function insertAddUnitToFilterMenu(menuCfg,model,units){var me=this,afText=mstrmojo.desc(2022,"Add to Filter"),validUnits=$ARR.ensureArray(units).filter(function(u){return me.isValidAddToFP(model,u);});if(validUnits.length>0){menuCfg.addMenuItem(afText,"",function(){model.addFilterStackSelectors(validUnits);});}else{menuCfg.addDisabledMenuItem(afText,"");}},isValidAddToFP:function isValidAddToFP(model,unit){var builder=model.controller.view.builder,filterStack=builder.getLayoutVIMap(model.getCurrentLayoutKey()).getComponent($VI_TYPES.FILTER_STACK),isValid;isValid=(!filterStack||$ARR.find(filterStack.getFilterDefinitions(),"srcid",unit.did)===-1);if(isValid&&unit.lock){var fs=unit.fs||[],i;isValid=false;for(i=0;i<fs.length;i++){if(fs[i].iidx){isValid=true;break;}}}return isValid;},renameItem:function renameItem(itemDom,item,onItemRenameComplete,params){var mojoId=itemDom.mstrmojoId,parent=mstrmojo.dom.findWidget(itemDom);params=params||{};if(!mojoId){var lbl=mstrmojo.insert({scriptClass:"mstrmojo.EditableLabel",editOnClick:false,text:item.n,title:item.dsc||"",allowEmptyText:params.allowEmptyText,cssClass:params.cssClass||"",placeholder:itemDom,onTextEditComplete:function onTextEditComplete(changed){if(changed){return onItemRenameComplete(this);}},onmousedown:function onmousedown(e){if(this.isEditing){e.cancel();}}});if(parent&&parent.draggable){lbl.parent=parent;}lbl.render();mojoId=lbl.id;}mstrmojo.all[mojoId].set("isEditing",true);return mstrmojo.all[mojoId];},getMultipleMetricsCalculationMenus:function getMultipleMetricsCalculationMenus(items,dsid,onOk){var cfg=new mstrmojo.ui.menus.MenuConfig(),fns=mstrmojo.vi.ui.DatasetUnitMenuUtils.getMultiSelectionShortcutMetricFunctions(items),getData=function(items,func,func2){return{dsid:dsid,funcType:func,funcType2:func2,items:items};};cfg.useTooltip=true;fns.forEach(function(entry){cfg.addMenuItem(entry.n,"",function(){onOk(getData(items,entry.t));});});if(items.length===2){var $FE=mstrmojo.mstr.EnumFunction,divide=$FE.FunctionDivide,minus=$FE.FunctionMinus,mx1=items[0],mx2=items[1],addMenuItem=function(n,m1,m2,fn1,fn2){cfg.addMenuItem(n,"",function(){onOk(getData([m1,m2],fn1,fn2));});},menus=[{n:function(m1,m2){return m1.n+"/"+m2.n;},fn:divide},{n:function(m1,m2){return m1.n+"-"+m2.n;},fn:minus},{n:function(m1,m2){return"("+m1.n+"-"+m2.n+")/"+m2.n;},fn:minus,fn2:divide}];menus.forEach(function(menu){cfg.addSeparator();addMenuItem(menu.n(mx1,mx2),mx1,mx2,menu.fn,menu.fn2);addMenuItem(menu.n(mx2,mx1),mx2,mx1,menu.fn,menu.fn2);});}return cfg;},getCalculationMetricEditor:function getCalculationMetricEditor(mx,item,onOk){var operators=[{n:"",css:"operator-plus",funcType:$EF.FunctionPlus},{n:"",css:"operator-minus",funcType:$EF.FunctionMinus},{n:"",css:"operator-multiply",funcType:$EF.FunctionTimes},{n:"",css:"operator-divide",funcType:$EF.FunctionDivide},{n:"%",css:"operator-percent-diff",funcType:$EF.FunctionMinus,funcType2:$EF.FunctionDivide}],data={m1:item.did,m2:mx[0].did,operator:$EF.FunctionPlus,u1:{id:item.did,type:4},u2:null},isConstant=function(item){return{}.hasOwnProperty.call(item,"cst");},isConstantValid=function(cst){return typeof cst==="string"&&!!cst.length&&!isNaN(Number(cst));};var pulldownValidBinding="this.parent.popupConfig.valid || this.selectedIndex !== -1 || (!!this.selectedNode && this.selectedNode.innerHTML.length === 0)",postkeyup=function postkeyup(){var config=this.parent.popupConfig;if(config){config.set("okEnabled",this[this.editableSlot].innerHTML.length!==0);}};return new mstrmojo.ui.menus.EditorConfig({cssClass:"Calculation-MenuEditor",contents:[getCalculationPulldownCfg({metrics:mx,value:data.m1,propName:"u1",optionValueField:"did",bindings:{valid:pulldownValidBinding},postkeyup:postkeyup}),{scriptClass:"mstrmojo.ButtonListHoriz",items:operators,selectedIndex:0,postselectionChange:function postselectionChange(){this.parent.data.set("operator",this.selectedItem.funcType);this.parent.data.set("operator2",this.selectedItem.funcType2);}},getCalculationPulldownCfg({metrics:mx,value:null,propName:"u2",optionValueField:"did",bindings:{valid:pulldownValidBinding},postkeyup:postkeyup})],data:data,okEnabled:false,bindings:{valid:function(){var u1=this.data.u1,u2=this.data.u2,op=this.data.operator;if(!u1||!u2||!op){return false;}var retval=!(isConstant(u1)&&isConstant(u2))&&(!isConstant(u1)||isConstantValid(u1.cst))&&(!isConstant(u2)||isConstantValid(u2.cst));this.set("okEnabled",retval);return retval;}},fnOk:function(data){return onOk(data.u1,data.u2,data.operator,data.operator2);}});},getFilterEditor:function getFilterEditor(config){var editorId="dfe",editor,targetMap={},filter=config.datasetFilter;function isExpressionSupported(expr){if(!expr.et){return false;}if(expr.et===$EXPR_TYPES.RLS){return false;}if(expr.p){return false;}if(expr.cs&&expr.cs.some(function(c){return !!c.p;})){return false;}return !expr.nds||expr.nds.every(isExpressionSupported);}function showEditor(){$ARR.forEach(config.att,function(unit){if(unit.t!==12||unit.da){return ;}targetMap[unit.did]={did:unit.did,n:unit.n,t:unit.t,fs:unit.fs};});$ARR.forEach(config.mx,function(unit){if(unit.um){return ;}targetMap[unit.did]={did:unit.did,n:unit.n,t:unit.t};});if(filter){mstrmojo.expr.findTargets(filter,"did",targetMap);}var filterModel={expr:$HASH.clone(filter),targets:$HASH.valarray(targetMap)};editor=editorId&&window.mstrmojo&&mstrmojo.all[editorId];if(!editor){editor=mstrmojo.insert({id:editorId,scriptClass:"mstrmojo.fe.ReportFilterEditor",showLimits:false,objectBrowsingEnabled:true});}if(config.zIndex){editor.set("zIndex",config.zIndex);}editor.set("title",mstrmojo.desc(12138,"Dataset Filter #").replace("#",config.datasetName));editor.set("onSave",config.fnOk);editor.set("model",filterModel);editor.onUpdateBrowseElementsParams=config.browseParam;editor.open();}if(filter&&!isExpressionSupported(filter)){mstrmojo.warn(mstrmojo.desc(13527,"The filter contains an advanced condition that cannot be edited."),{confirmBtn:{t:mstrmojo.desc(13528,"Clear existing filter"),fn:function(){filter=null;showEditor();}}},{title:mstrmojo.desc(11812,"Notification")});}else{showEditor();}},getCfgForAddUnitFromAllObject:function(items,datasets){var srcDatasetId=null,dataset=null,actions=[],existsInDataset=function(item,ds){if(!ds){return false;}return $ARR.find((ds.att||[]).concat(ds.mx||[]),"did",item.did)>-1;};$HASH.forEach(datasets,function(v,k){if(v.idd){srcDatasetId=k;dataset=v;return false;}return true;});if(!srcDatasetId){srcDatasetId="$GUID_141";actions.push({act:"createDataset",mgo:true,prm:true,name:mstrApp.projectName,idd:true,newObjectIds:[srcDatasetId]});}$ARR.forEach(items,function(item){if(!existsInDataset(item,dataset)){actions.push({act:"addUnitToDataset",dsid:srcDatasetId,unitId:item.did,unitType:item.t});}});return{actions:actions,dsid:srcDatasetId};},getAggregateByMenu:function getAggregateByMenu(item,onOk){var cfg=new mstrmojo.ui.menus.MenuConfig(),getBaseUnit=function(item,isEditing){var baseUnitId,baseUnitType;if(isEditing){var arg=item.mexp.args[0];baseUnitId=arg.did;baseUnitType=arg.t;}else{baseUnitId=item.did;baseUnitType=item.t;}return{did:baseUnitId,t:baseUnitType};},aggregateByFuncs=this.getAvailableShortcutMetricFunctionsGroup(item),functionType=item.mexp?item.mexp.ft:null,isEditingAgg=item.mexp&&this.isAmongFunctions(functionType,aggregateByFuncs);aggregateByFuncs.forEach(function(funcGroup,groupIdx){if(groupIdx!==0){cfg.addSeparator();}funcGroup.forEach(function(func){cfg.addMenuItem(func.n,"",function(){onOk(getBaseUnit(item,isEditingAgg),func.t);});});});return cfg;},showObjectPicker:function showObjectPicker(OKFn,oTypes){var id="object_picker";return function(){var editor=mstrmojo.all[id];if(!editor){editor=new mstrmojo.vi.ui.editors.ObjectPicker({id:id});if(oTypes){editor.supportedTypes=$ARR.hash(oTypes);editor.ob.browsableTypes="8,"+oTypes.join(",");}editor.render();}else{if(oTypes){editor.supportedTypes=$ARR.hash(oTypes);editor.ob.browsableTypes="8,"+oTypes.join(",");}editor.browse();}editor.OKFn=OKFn||mstrmojo.emptyFn;editor.open();};},generateNumberFormat:function generateNumberFormat(formatValues){var defaultValue=$FD.DefaultFormat.FormattingNumber,CATEGORY=$FD.NumberFormatCategory,serverValues=formatValues||{},nct=serverValues.nct,isUnassigned=nct===CATEGORY.General&&serverValues.nfs==="General";return{category:(nct===undefined||isUnassigned)?CATEGORY.Automatic:nct,decimalPlaces:serverValues.ndp===undefined?2:serverValues.ndp,thousandSeparator:serverValues.nth?-1:0,currencySymbol:serverValues.ncs||defaultValue.CurrencySymbol,currencyPosition:serverValues.ncp||defaultValue.CurrencyPosition,format:serverValues.nfs||"",negativeNumbers:serverValues.nnn||defaultValue.NegativeNumbers};},getNumberFormatEditor:function getNumberFormatEditor(item,serverValues,onOk){var formatValue=this.generateNumberFormat(serverValues),myData=$HASH.clone(formatValue),oldData=$HASH.clone(formatValue);return new mstrmojo.ui.menus.EditorConfig({data:myData,bindings:{okEnabled:function(){return !(this.data.category===oldData.category&&this.data.format===oldData.format);}},cssClass:"NumberFormat-MenuEditor",contents:[{scriptClass:"mstrmojo.vi.ui.NumberFormatter",formatValue:formatValue,myData:myData,oldData:oldData,adjustAfterCategoryChange:function(){this.parent.adjustCornersForPopupOverflow();}}],fnOk:function fnOk(data){if(!(data.category===oldData.category&&data.format===oldData.format)){return onOk(data,oldData);}}});},getHighlightElementHandler:function(isOpen,element,cls){return function(){$CSS.toggleClass(element,cls||"open",isOpen);};},getConfDataTypeMenuCfg:function getConfDataTypeMenuCfg(docModel,item,dsid,onOk){var FUNC_STRING="ToString",FUNC_NUMBER="ToNumber",FUNC_DATE="ToDateTime",FUNC_KEEP_ORIGINAL="keepOriginal",PATTERN_DEFAULT="Default",FUNC2BFT={ToString:3,ToNumber:2,ToDateTime:8},FUNC_DID={ToString:"D1ED29645DEC4DBF99E8E09ED939074B",ToNumber:"399C3EC1041643F1ACE8F2A92B1C1F2F",ToDateTime:"0A558C7295DE42DAA8C5594F1724563F"},PATTERN_POSTFIX="_pattern",FUNC_POSTFIX="_func",BFT_POSTFIX="_bft",STATE_POSTFIX="_state",FORM_STATE={UNCHANGED:0,TO_CREATE:1,TO_UPDATE:2},DEFAULT_ITEM={n:"Default",v:"Default"},DATE_PATTERN_LIST=[{n:"MM-DD-Year",v:"MM-DD-Year"},{n:"MM/DD/Year",v:"MM/DD/Year"},{n:"DD-MM-Year",v:"DD-MM-Year"},{n:"DD/mm/Year",v:"DD/mm/Year"},DEFAULT_ITEM],FUNC_LIST=[{n:mstrmojo.desc(13772,"Keep Original"),v:FUNC_KEEP_ORIGINAL},{n:mstrmojo.desc(12276,"String"),v:FUNC_STRING},{n:mstrmojo.desc(2052,"Date"),v:FUNC_DATE},{n:mstrmojo.desc(3434,"Number"),v:FUNC_NUMBER}],FUNC_LIST_WITHOUT_ORIGINAL=$HASH.clone(FUNC_LIST).slice(1),fs=item.fs.filter(function(fm){return item.da||fm.obf;}),isMultiForms=fs.length>1,hasScroller=fs.length>5,isAdvanced=false,isLinked=false,formList=[],contents=[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13773,"Select Data Type for New Attribute:")}],data={okEnabled:false},isOkEnabled=function(){var enabled=false;fs.forEach(function(fm){enabled=enabled||(data[fm.fnm+FUNC_POSTFIX+STATE_POSTFIX]!==FORM_STATE.UNCHANGED)||(data[fm.fnm+PATTERN_POSTFIX+STATE_POSTFIX]!==FORM_STATE.UNCHANGED);});return enabled;},getCurFuncIndex=function(item,fm){var index=0;if(item.da){$ARR.forEach([FUNC_STRING,FUNC_DATE,FUNC_NUMBER],function(func,i){var r=new RegExp("^\\s*"+func+"\\s*(<.*>)?\\s*\\((.+)\\)\\s*$","i").exec(fm.f);if(r&&r[2]){index=i+1;return false;}});}return index;},getPattern=function(fm,func){var pattern=PATTERN_DEFAULT;if(item.da){var r=new RegExp("^\\s*"+func+'\\s*<\\s*Pattern\\s*=\\s*"(.+)"\\s*>.*$',"i").exec(fm.f);if(!mstrmojo.string.isEmpty(r&&r[1])){pattern=r[1];}}return pattern;},getEditor=function(){return hasScroller?this.parent.parent.parent:(isMultiForms?this.parent.parent:this.parent);},updateScrollbar=function(editor){if(hasScroller){editor.formList.updateScrollbars();}},setPatternInputProp=function(editor,fm,reset){var fnm=fm.fnm,widget=hasScroller?editor.formList[fm.fnm+PATTERN_POSTFIX]:editor[fm.fnm+PATTERN_POSTFIX],patternInput=isMultiForms?widget.children[1]:widget,selectedFunc=data[fnm+FUNC_POSTFIX],visible=isAdvanced&&(selectedFunc===FUNC_DATE||selectedFunc===FUNC_STRING),isVisibleChange=widget.visible!==visible;if(isVisibleChange){widget.set("visible",visible);if(visible){updateScrollbar(editor);}else{patternInput.hideTooltip();}}if(reset){patternInput.set("text",getPattern(fm,selectedFunc));patternInput.set("items",selectedFunc===FUNC_DATE?DATE_PATTERN_LIST:[DEFAULT_ITEM]);}},setAdvancedLabelVisible=function(editor){var visible=false;fs.forEach(function(fm){if(data[fm.fnm+FUNC_POSTFIX]===FUNC_DATE||data[fm.fnm+FUNC_POSTFIX]===FUNC_STRING){visible=true;return false;}});editor.advancedLabel.set("visible",visible);},getPullDownCfg=function(items,selectedIndex,fm,isMultiForms){return{scriptClass:"mstrmojo.ui.Pulldown",items:items,alias:fm.fnm+FUNC_POSTFIX,selectedIndex:selectedIndex,onPopupWidgetOpened:function(){updateScrollbar(getEditor.call(this));},onitemSelected:function onitemSelected(item,index){var editor=getEditor.call(this),data=editor.data,fnm=fm.fnm,v=item.v,getState=function(isChanged){if(isChanged){return(items.length===3?FORM_STATE.TO_UPDATE:FORM_STATE.TO_CREATE);}return FORM_STATE.UNCHANGED;};data.set(fnm+FUNC_POSTFIX,v);data.set(fnm+PATTERN_POSTFIX,getPattern(fm,v));data.set(fnm+BFT_POSTFIX,v===FUNC_KEEP_ORIGINAL?fm.bftp:FUNC2BFT[v]);data.set(fnm+FUNC_POSTFIX+STATE_POSTFIX,getState(index!==selectedIndex));data.set("okEnabled",isOkEnabled());setPatternInputProp(editor,fm,true);setAdvancedLabelVisible(editor);}};},getTextBoxCfg=function(fm,oPattern,isMultiForms){return{scriptClass:"mstrmojo.ui.SearchablePulldown",alias:fm.fnm+PATTERN_POSTFIX,useRichTooltip:true,visible:isMultiForms,allowCustomText:true,allowEmptyText:true,onPopupWidgetOpened:function(){updateScrollbar(getEditor.call(this));},customizeSearchResult:function(result){if($ARR.find(result,"v","Default")===-1&&this.items.length>0){result.push(DEFAULT_ITEM);}},onclick:function(evt){mstrmojo.ui.SearchablePulldown.prototype.onclick.call(this,evt);this.set("isEditing",true);},updateData:function(newText){var editor=getEditor.call(this),data=editor.data,fnm=fm.fnm;data.set(fnm+PATTERN_POSTFIX,newText);data.set(fnm+PATTERN_POSTFIX+STATE_POSTFIX,oPattern!==newText?FORM_STATE.TO_UPDATE:FORM_STATE.UNCHANGED);data.set("okEnabled",isOkEnabled());},onitemSelected:function onitemSelected(item,index){if(item){this.updateData(item.v);}},onkeyup:function(evt){mstrmojo.ui.SearchablePulldown.prototype.onkeyup.call(this,evt);var editableNode=this[this.editableSlot],newText=editableNode.innerText||editableNode.textContent;this.updateData(newText);},updateTooltipConfig:function(e){this.tooltipOpenDelay=e?500:0;var position=$DOM.position(this.domNode);this.richTooltip={content:mstrmojo.desc(14114,'Pattern determines the formatting for the resulting string of characters. You can use the custom numeric, date, and time formatting symbols. <br/> Example: if pattern is defined as "0,000.00" for "1001", it returns the string "1,001.00"'),posType:mstrmojo.tooltip.POS_TOPLEFT,cssClass:"vi-regular vi-tooltip-C",top:position.y-2,left:position.x+position.w+10};}};},populateEditorContents=function(item,fm,contents,data,isMultiForms){var index=getCurFuncIndex(item,fm),pattern=getPattern(fm,FUNC_LIST[index].v),propName=fm.fnm,items=FUNC_LIST;if(index>0){items=FUNC_LIST_WITHOUT_ORIGINAL;index--;}data[propName+PATTERN_POSTFIX]="";data[propName+FUNC_POSTFIX]="";data[propName+BFT_POSTFIX]="";data[propName+FUNC_POSTFIX+STATE_POSTFIX]=data[propName+PATTERN_POSTFIX+STATE_POSTFIX]=FORM_STATE.UNCHANGED;if(isMultiForms){contents.push({scriptClass:"mstrmojo.HBox",cssClass:"func-input",alias:propName+FUNC_POSTFIX,children:[{scriptClass:"mstrmojo.Label",text:propName,useRichTooltip:true,updateTooltipConfig:function(e){this.tooltipOpenDelay=e?500:0;var node=this.domNode;var position=$DOM.position(node);if(node.scrollWidth>node.offsetWidth){this.richTooltip={content:node.innerText,posType:mstrmojo.tooltip.POS_TOPLEFT,cssClass:"vi-regular vi-tooltip-V",top:position.y-position.h-10,left:position.x-10};}}},getPullDownCfg(items,index,fm,true)]});contents.push({scriptClass:"mstrmojo.HBox",cssClass:"pattern-input",alias:propName+PATTERN_POSTFIX,children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(12078,"Pattern")},getTextBoxCfg(fm,pattern,true)]});}else{contents.push(getPullDownCfg(items,index,fm,false));contents.push(getTextBoxCfg(fm,pattern,false));}};$ARR.forEach(item.fs,function(fm){if(docModel.als&&docModel.als.links[item.did+" "+fm.fid]){isLinked=true;return false;}});if(isMultiForms){fs.forEach(function(fm){populateEditorContents(item,fm,hasScroller?formList:contents,data,true);});}else{populateEditorContents(item,fs[0],contents,data,false);}if(hasScroller){contents.push({scriptClass:"mstrmojo.ui.ScrollableContainer",alias:"formList",cssClass:"formList",children:formList});}contents.push({scriptClass:"mstrmojo.Label",cssClass:"advancedLabel",alias:"advancedLabel",allowHTML:true,text:"<span>"+mstrmojo.desc(702,"Advanced")+"</span>",onclick:function(){var editor=this.parent,widget,patternInput,first=true;isAdvanced=!isAdvanced;$CSS.toggleClass(this.domNode,"expanded",isAdvanced);fs.forEach(function(fm){setPatternInputProp(editor,fm,false);widget=hasScroller?editor.formList[fm.fnm+PATTERN_POSTFIX]:editor[fm.fnm+PATTERN_POSTFIX];patternInput=isMultiForms?widget.children[1]:widget;if(widget.visible&&first&&!hasScroller){first=false;patternInput.showTooltip();}});}});return new mstrmojo.ui.menus.EditorConfig({data:data,cssClass:"ConfDataType-MenuEditor",contents:contents,onOpen:function(){updateScrollbar(this);},bindings:{okEnabled:"this.data.okEnabled"},fnOk:function fnOk(data){var forms=[],formsToUpdate=[],toCreate=false,getTokenStreamXML=function(func,pattern,fm){var tks=[],handleParamTokens=function(fm){var param=fm.ftk&&fm.ftk.slice(2,-2);if(!param){return null;}while((param.shift()).v!=="("){}return param;},paramTokens=handleParamTokens(fm)||[getFormToken(item,fm)];tks.push({v:"!",tp:33,lv:4});if(func!==FUNC_KEEP_ORIGINAL){tks.push({v:func,oi:{did:FUNC_DID[func],t:11,st:2816,n:func}});if(!mstrmojo.string.isEmpty(pattern)&&pattern!==PATTERN_DEFAULT&&(func===FUNC_DATE||func===FUNC_STRING)){tks.push({v:'<Pattern="'+pattern+'">(',tp:"2",lv:1});}else{tks.push({v:"(",tp:"2",lv:1});}tks=tks.concat(paramTokens);tks.push({v:")",tp:"2",lv:1});}else{tks=tks.concat(paramTokens);}tks.push({v:"",tp:-1,lv:4});return mstrmojo.ME.AttributeEditBox.getTokenStreamXML({items:tks});};if(isLinked){toCreate=true;}else{fs.forEach(function(fm){if(data[fm.fnm+FUNC_POSTFIX+STATE_POSTFIX]===FORM_STATE.TO_CREATE){toCreate=true;return false;}else{if(data[fm.fnm+FUNC_POSTFIX+STATE_POSTFIX]===FORM_STATE.TO_UPDATE||(data[fm.fnm+PATTERN_POSTFIX+STATE_POSTFIX]===FORM_STATE.TO_UPDATE&&(data[fm.fnm+FUNC_POSTFIX]===FUNC_DATE||data[fm.fnm+FUNC_POSTFIX]===FUNC_STRING))){formsToUpdate.push(fm);}}});}if(toCreate){fs.forEach(function(fm){forms.push({n:fm.fnm,formula:getTokenStreamXML(data[fm.fnm+FUNC_POSTFIX],data[fm.fnm+PATTERN_POSTFIX],fm),bft:data[fm.fnm+BFT_POSTFIX]});});onOk(toCreate,forms);}else{if(item.da){loadObjectDefn(docModel.mid,item.did,formsToUpdate,function(pfms){pfms.forEach(function(fm){forms.push({did:fm.fid,formula:getTokenStreamXML(data[fm.fnm+FUNC_POSTFIX],data[fm.fnm+PATTERN_POSTFIX],fm),bft:data[fm.fnm+BFT_POSTFIX]});});onOk(toCreate,forms);});}}}});},getCreateTimeDAEditorCfg:function getCreateTimeDAEditorCfg(item,onOk){var getTimeForm=function(item){var BFT_DATE=8,BFT_DATETIME=1,timefs=$ARR.filter(item.fs,function(f){return(item.da||f.obf)&&(f.bftp===BFT_DATE||f.bftp===BFT_DATETIME);}),idfIdx=$ARR.find(timefs,"idf",true);return timefs[idfIdx>=0?idfIdx:0];},timef=getTimeForm(item);if(!timef){return null;}return new mstrmojo.ui.menus.EditorConfig({data:{okEnabled:false},cssClass:"CreateTimeAttribute-MenuEditor",contents:[{scriptClass:"mstrmojo.ui.CheckList",alias:"time_type",items:[{n:mstrmojo.desc(873,"Year"),v:"Year"},{n:mstrmojo.desc(10051,"Quarter of Year"),v:"QuarterOfYear"},{n:mstrmojo.desc(10050,"Quarter"),v:"Quarter"},{n:mstrmojo.desc(10049,"Month of Year"),v:"MonthOfYear"},{n:mstrmojo.desc(871,"Month"),v:"Month"},{n:mstrmojo.desc(10047,"Week of Year"),v:"WeekOfYear"},{n:mstrmojo.desc(10048,"Week"),v:"Week"},{n:mstrmojo.desc(11608,"Day of Year"),v:"DayOfYear"},{n:mstrmojo.desc(10046,"Day of Month"),v:"DayOfMonth"},{n:mstrmojo.desc(10045,"Day of Week"),v:"DayOfWeek"}],onchange:function onchange(){var enabled=false;$HASH.forEach(this.selectedIndices,function(v){if(v){enabled=true;return false;}});this.parent.data.set("okEnabled",enabled);}}],bindings:{okEnabled:function(){return this.data.okEnabled;}},fnOk:function fnOk(data,editor){var time_type=editor.time_type,indices=time_type.selectedIndices,items=time_type.items,actions=[],forms=[],FORM_TOKEN="@form",FUNC_DID={Year:"6F7DF5F8449111D5BEA300B0D01A55EF",Quarter:"6F7DF5F7449111D5BEA300B0D01A55EF",Concat:"6F7DF5FF449111D5BEA300B0D01A55EF",QuarterStartDate:"59E10CE2ADDD4A6DAC2416A72999A9ED",Month:"6F7DF5F6449111D5BEA300B0D01A55EF",ToString:"D1ED29645DEC4DBF99E8E09ED939074B",MonthStartDate:"7C63D4E70B2741C3A5B54A2EFD40961B",Week:"6F7DF5F5449111D5BEA300B0D01A55EF",WeekStartDate:"44681336D0DB4E43AC333FFB3CC4400D",DayOfMonth:"6F7DF5F2449111D5BEA300B0D01A55EF",DayOfWeek:"6F7DF5F3449111D5BEA300B0D01A55EF",DayOfYear:"6F7DF5F4449111D5BEA300B0D01A55EF"},getDAForms=function(type){switch(type){case"Year":return{ID:["Year","(",FORM_TOKEN,")"]};case"Quarter":return{ID:["Year","(",FORM_TOKEN,") * 10 + ","Quarter","(",FORM_TOKEN,")"],DESC:["Concat",'("Q", ',"Quarter","(",FORM_TOKEN,")",', ", ", ',"Year","(",FORM_TOKEN,"))"],DATE:["QuarterStartDate","(",FORM_TOKEN,")"]};case"QuarterOfYear":return{ID:["Quarter","(",FORM_TOKEN,")"],DESC:["Concat",'("Q", This@ID)']};case"Month":return{ID:["Year","(",FORM_TOKEN,") * 100 + ","Month","(",FORM_TOKEN,")"],DESC:["ToString",'<Pattern="mmm yyyy">(',FORM_TOKEN,")"],DATE:["MonthStartDate","(",FORM_TOKEN,")"]};case"MonthOfYear":return{ID:["Month","(",FORM_TOKEN,")"],DESC:["ToString",'<Pattern="mmmm">(',FORM_TOKEN,")"]};case"Week":return{ID:["Year","(",FORM_TOKEN,") * 100 + ","Week","(",FORM_TOKEN,")"],DESC:["Concat",'("W", ',"Week","(",FORM_TOKEN,'), ", ", ',"Year","(",FORM_TOKEN,"))"],DATE:["WeekStartDate","(",FORM_TOKEN,")"]};case"WeekOfYear":return{ID:["Week","(",FORM_TOKEN,")"]};case"DayOfMonth":return{ID:["DayOfMonth","(",FORM_TOKEN,")"]};case"DayOfWeek":return{ID:["DayOfWeek","(",FORM_TOKEN,")"],DESC:["ToString",'<Pattern="ddd">(',FORM_TOKEN,")"]};case"DayOfYear":return{ID:["DayOfYear","(",FORM_TOKEN,")"]};}},getTokenStreamXML=function(attr,fm,formula){var tks=[{v:"!",tp:33,lv:4}],func;formula.forEach(function(fToken,i){if(fToken===FORM_TOKEN){tks.push(getFormToken(attr,fm));}else{func=FUNC_DID[fToken];if(func){tks.push({v:func,oi:{did:func,t:11,st:2816,n:func}});}else{tks.push({v:fToken,tp:"2",lv:1});}}});tks.push({v:"",tp:-1,lv:4});return mstrmojo.ME.AttributeEditBox.getTokenStreamXML({items:tks});};$HASH.forEach(indices,function(v,key){if(v){forms=[];$HASH.forEach(getDAForms(items[key].v),function(v,key){forms.push({n:key,formula:getTokenStreamXML(item,timef,v),bft:(key==="DATE"?8:0)});});actions.push({isTokenStream:true,forms:forms,name:item.n+" ("+items[key].n+")"});}});return onOk(actions);}});},RefreshAndCloseAllObjectBrowserCallback:function(actions,docModel){return mstrmojo.func.wrapMethods(docModel.getDatasetsUpdateCallback(),{success:function(){if($ARR.find(actions,"act","createDataset")!==-1){docModel.controller.datasetsPanel.set("allObjectBrowserOpened",false);}}});},getUnitFromDataset:function getUnitFromDataset(datasets,did,t){var item=null;$HASH.forEach(datasets,function(ds){var targets=ds.att||[];if(t===4){targets=ds.mx||[];}$ARR.forEach(targets,function(target){if(target.did===did){item=target;return false;}});if(item){return false;}});return item;},getDatasetFromId:function getDatasetFromId(datasets,datasetId){var dataset=null;$HASH.forEach(datasets,function(ds){if(ds.did===datasetId){dataset=ds;return false;}});return dataset;},getDatasetFromAttributeId:function getDatasetFromId(datasets,attrId){var dataset=null;$HASH.forEach(datasets,function(ds){if($ARR.find(ds.att,"did",attrId)>=0){dataset=ds;return false;}});return dataset;},getSortedDatasetUnits:function sortDatasetUnits(units){var getPriority=function getPriority(unit){return unit.t===$DSSOBJ_TYPES.DssTypeMetric?2:1;};units=units.concat();units.sort(function(a,b){var typeCmpResult=getPriority(a)-getPriority(b),upperA=a.n.toUpperCase(),upperB=b.n.toUpperCase();return typeCmpResult!==0?typeCmpResult:(upperA!==upperB?upperA.localeCompare(upperB):a.n.localeCompare(b.n));});return units;},getUnitCssClass:function(item){var unitType=item.t;if(item.fs&&item.fs.length&&item.fs.some(function(f){return f.fgr>0;})){unitType+="g";}else{if((item.dm||item.um)||item.da){unitType+="d";}else{if(item.de){unitType+="de";}}}if((item.t===47&&item.st===12033)||(item.t===12&&item.st&&item.st===3076)){unitType+=(" st"+item.st);}return"ic"+unitType;},hasMultiForms:function hasMultiForms(attrID,datasets){return $DATASET_INTERFACE.getFormsByAttrId(attrID,datasets).length>1;},getDisplayFormsMenu:function getDisplayFormsMenu(item,viz,datasets,onOk){var all=[],displayForms=[],selectedIndices=[],formNameOptions=[{n:mstrmojo.desc(2411,"Off"),v:0},{n:mstrmojo.desc(2410,"On"),v:1},{n:mstrmojo.desc(8504,"Form Name Only"),v:2},{n:mstrmojo.desc(8505,"Show Attribute Name Once"),v:3},{n:mstrmojo.desc(4531,"Automatic"),v:4}];var data=viz.model.data,gts=data.gts,fs;$ARR.forEach((gts.row||[]).concat(gts.col||[]),function(obj){if(obj.id===item.did){displayForms=displayForms.concat(obj.fs);}});fs=$DATASET_INTERFACE.getFormsByAttrId(item.did,datasets);$ARR.forEach(fs||[],function(f){var fid=f.fid;if($ARR.find(all,"id",fid)<0){all.push({id:fid,n:f.fnm});var sel=$ARR.find(displayForms,"id",fid);if(sel>-1){selectedIndices[all.length-1]=true;}}});return new mstrmojo.ui.menus.EditorConfig({data:{item:item,oldSelected:$HASH.copy(selectedIndices,{})},contents:[{alias:"fs",scriptClass:"mstrmojo.ui.CheckList",minimumSelectCnt:1,items:all,selectedIndices:selectedIndices},{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(11918,"Display attribute form names:")},{alias:"longNames",scriptClass:"mstrmojo.ui.Pulldown",items:formNameOptions,selectedIndex:$ARR.find(formNameOptions,"v",data.lnm||0),onitemSelected:function onitemSelected(selectedItem){this.v=String(selectedItem.v);}}],okBtnText:mstrmojo.desc(1442,"Ok"),fnOk:function fnOk(data,editor){var formList=editor.fs,selected=formList.selectedIndices,fs=formList.items,addFormActions=[],removeFormActions=[],displayNameActions=[];if(!formList.getSelectedItems().length){mstrmojo.alert("Please select at least one form!");return ;}var oldSelection=data.oldSelected,newSelection=selected,i,removed={},added={};for(i=0;i<fs.length;i++){if(oldSelection[i]&&!newSelection[i]){removed[i]=true;}else{if(!oldSelection[i]&&newSelection[i]){added[i]=true;}}}$HASH.forEach(removed,function(v,n){if(v){removeFormActions.push({act:"removeForm",unitId:item.did,attFormId:fs[n].id});}});var gts=viz.model.data.gts;(gts.row||[]).concat(gts.col||[]).forEach(function(obj){if(obj.id===item.did){(obj.fs||[]).forEach(function(f){if($ARR.find(all,"id",f.id)<0){removeFormActions.push({act:"removeForm",unitId:item.did,attFormId:f.id});}});}});$HASH.forEach(added,function(v,n){if(v){addFormActions.push({act:"addForm",unitId:item.did,attFormId:fs[n].id,unitPos:0});}});displayNameActions.push({act:"putProperties",prs:"Template Formatting",pr:"LongNames",v:editor.longNames.v});if(onOk){onOk([{act:"updateTemplate",keyContext:viz.k,partialRetrieval:{nodes:[viz.k]},actions:removeFormActions.concat(addFormActions).concat(displayNameActions)}]);}}});},getAttributeLinkMenu:function getAttributeLinkMenu(menuCfg,item,datasetId,docModel,onOK){var DssDataImportColumnDeriveFlagIsDerived=-2147483648,datasets=docModel.datasets,dataset=datasets[datasetId],tables=dataset.tables||[],canLink={},srcTableIds=[],srcIdForm=(item.fs&&item.fs[0])||{},units=[],DssXmlSubTypeReportEmmaCube=779,isCompoundID=item.art>1,showInDocLinkMenu=!isCompoundID&&$HASH.keyarray(datasets).length>1,addInDocAttributeLink=function(){mstrmojo.vi.ui.editors.AttributeLinkEditor.open({attribute:item,docModel:docModel,datasetId:datasetId});};if((dataset.st!==DssXmlSubTypeReportEmmaCube)||tables.length<=1||item.da){if(showInDocLinkMenu){menuCfg.addMenuItem(mstrmojo.desc(11941,"Link to Other Dataset..."),"",addInDocAttributeLink);}return ;}$ARR.forEach(dataset.att,function(unit){var canTgt=true,tgtTbid=null,tgtIdForm=(unit.fs&&unit.fs[0])||{};if(unit.da){return ;}if(srcIdForm.der===DssDataImportColumnDeriveFlagIsDerived||tgtIdForm.der===DssDataImportColumnDeriveFlagIsDerived||srcIdForm.fgr===-1||tgtIdForm.fgr===-1||srcIdForm.ftr===-1||tgtIdForm.ftr===-1){return ;}if(srcIdForm.fgr&&tgtIdForm.fgr&&srcIdForm.fgr!==tgtIdForm.fgr){return ;}if(srcIdForm.ftr&&tgtIdForm.ftr&&srcIdForm.ftr!==tgtIdForm.ftr){return ;}$ARR.forEach(tables,function(tb){var srcIdx=$ARR.find(tb.attRefs,"did",item.did),tgtIdx=$ARR.find(tb.attRefs,"did",unit.did);if(srcIdx>=0&&$ARR.indexOf(srcTableIds,tb.did)<0){srcTableIds.push(tb.did);}if(tgtIdx>=0){tgtTbid=tb.did;}if(srcIdx>=0&&tgtIdx>=0){canTgt=false;}});if(canTgt&&!unit.hide){canLink[unit.did]=tgtTbid;units.push(unit);}});if(units.length>0&&dataset.hcs!==true){menuCfg.addEditorMenuItem(mstrmojo.desc(13172,"Map Attributes"),"",function(){return new mstrmojo.ui.menus.EditorConfig({data:{},cssClass:"mapAttribute",okVisible:false,cancelVisible:false,contents:[{scriptClass:"mstrmojo.ui.ScrollableContainer",children:[{scriptClass:"mstrmojo.vi.ui.InteractiveUnitList",draggable:false,CLS_HAS_MENU:"",items:units,listHooks:{select:function select(el,unit){docModel.warnForEditStandaloneDS(dataset,function(){$ARR.forEach(srcTableIds,function(srcTbId){linkEmmaAttribute({dsid:datasetId,srcId:item.did,srcTableId:srcTbId,tgtId:unit.did,tgtTableId:canLink[unit.did]},docModel,onOK);});});}}}]}]});});}if(showInDocLinkMenu){menuCfg.addMenuItem(mstrmojo.desc(11941,"Link to Other Dataset..."),"",addInDocAttributeLink);}},isDocumentLevelItem:function isDocumentLevelItem(item){return item&&(item.um||item.da||(item.t===47&&item.st===12033));},isLegalObjectName:function isLegalObjectName(name){var regex=/["\[\]\\]/g;if(name.match(regex)){return false;}return true;},validateName:function validateName(name,okFunc,cancelFunc){if(this.isLegalObjectName(name)){okFunc();}else{mstrmojo.alert(mstrmojo.desc(8622,"The # cannot contain the reserved characters ##.").replace("##","'[', ']', '\"' and '\\'").replace("#",mstrmojo.desc(945,"Name")),cancelFunc,mstrmojo.desc(1388,"Rename"));}},hasCGorCon:function hasCGorCon(dataset){return dataset.att.some(function(unit){var isCGorConsolidation=(unit.t===1||unit.t===47),isOldDE=(unit.t===12&&unit.de),isNDE=(unit.t===47&&unit.st===12033);return(isCGorConsolidation&&!isNDE||isOldDE);});},hasOldDEOverDatasets:function(did,datasets){var _result=false,index;$HASH.forEach(datasets,function(ds){index=$ARR.find((ds.att||[]),"did",did);if(index!==-1&&ds.att[index].de){_result=true;return false;}});return _result;},getMarkGeoRoleEditorCfg:function getMarkGeoRoleEditorCfg(docModel,att,dsid,mngd,tables,submitGeoChange){var GEOROLE_COUNTRY_DID=268435456,GEOROLE_STATE_DID=536870912,GEOROLE_CITY_DID=1073741824,DERIVED_ATTRIBUTE_STATE=268435456,DERIVED_ATTRIBUTE_CITY=805306368,DERIVED_ATTRIBUTE_COUNTY=805306368,DERIVED_ATTRIBUTE_ZIPCODE=1879048192,DssDataImportColumnDeriveFlagIsDerived=-2147483648,NONE=0,CITY=1,STATE=2,COUNTRY=3,LOCATION=4,LATITUDE=5,LONGTITUDE=6,OTHER=7,ZIPCODE=8,COUNTY=9,AREACODE=10,NUMERIC_TYPE=2,STRING_TYPE=3,NONE_OPTION={v:NONE,n:mstrmojo.desc(2057,"None")},COUNTRY_OPTION={v:COUNTRY,n:mstrmojo.desc(7674,"Country"),der:GEOROLE_COUNTRY_DID},STATE_OPTION={v:STATE,n:mstrmojo.desc(7676,"State"),parents:[COUNTRY_OPTION],der:GEOROLE_STATE_DID},COUNTY_OPTION={v:COUNTY,n:mstrmojo.desc(12919,"County"),parents:[COUNTRY_OPTION,STATE_OPTION]},CITY_OPTION={v:CITY,n:mstrmojo.desc(7675,"City"),parents:[COUNTRY_OPTION,STATE_OPTION],der:GEOROLE_CITY_DID},ZIPCODE_OPTION={v:ZIPCODE,n:mstrmojo.desc(7677,"Zip Code"),parents:[COUNTRY_OPTION,STATE_OPTION,CITY_OPTION]},LATITUDE_OPTION={v:LATITUDE,n:mstrmojo.desc(7696,"Latitude")},LONGITUDE_OPTION={v:LONGTITUDE,n:mstrmojo.desc(7697,"Longitude")},LOCATION_OPTION={v:LOCATION,n:mstrmojo.desc(7675,"City")+", "+mstrmojo.desc(7676,"State")},AREACODE_OPTION={v:AREACODE,n:mstrmojo.desc(12973,"Area Code")},OTHER_OPTION={v:OTHER,n:mstrmojo.desc(2056,"Custom")},geoOptionsMap={ID:[NONE_OPTION,COUNTRY_OPTION,STATE_OPTION,COUNTY_OPTION,CITY_OPTION,ZIPCODE_OPTION,LATITUDE_OPTION,LONGITUDE_OPTION,LOCATION_OPTION,AREACODE_OPTION,OTHER_OPTION],ID_NUMERIC:[NONE_OPTION,ZIPCODE_OPTION,AREACODE_OPTION,LATITUDE_OPTION,LONGITUDE_OPTION],NON_ID:[NONE_OPTION,COUNTRY_OPTION,STATE_OPTION,COUNTY_OPTION,CITY_OPTION,ZIPCODE_OPTION,LOCATION_OPTION,AREACODE_OPTION,OTHER_OPTION],NON_ID_NUMERIC:[NONE_OPTION,ZIPCODE_OPTION,AREACODE_OPTION]},fs=$ARR.filter(att.fs,function(f){return(f.bftp===NUMERIC_TYPE||f.bftp===STRING_TYPE)&&f.der!==DssDataImportColumnDeriveFlagIsDerived;});var isMultiForm=(fs.length>1),idFormIndex=$ARR.find(fs,"idf",true),geoFormIndex=(idFormIndex===-1?0:idFormIndex),geoForm=fs[geoFormIndex],geoFormId,geoRoleIndex,geoRole,formOptions=[],getGeoOptions=function(form){var n=(form.idf?"ID":"NON_ID")+(form.bftp===NUMERIC_TYPE?"_NUMERIC":"");return geoOptionsMap[n];},getGeoRoleIndex=function(geoRole,form){return $ARR.find(getGeoOptions(form),"v",geoRole);};if(fs.length===0||$ARR.find(att.fs,"fgr",-1)!==-1||geoForm.der===DssDataImportColumnDeriveFlagIsDerived){return null;}$ARR.forEach(fs,function(f,i){var fm=$HASH.clone(f);fm.n=fm.fnm;formOptions.push(fm);if(f.fgr){geoForm=fm;geoFormIndex=i;}});geoFormId=geoForm.fid;geoRole=geoForm.fgr||0;geoRoleIndex=getGeoRoleIndex(geoRole,geoForm);return new mstrmojo.ui.menus.EditorConfig({data:{item:att,geoForm:geoForm,geoRole:geoRole},cssClass:"MarkGeoRole-MenuEditor",contents:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13522,"Select Attribute Form:"),visible:isMultiForm},{scriptClass:"mstrmojo.ui.Pulldown",items:formOptions,selectedIndex:geoFormIndex,alias:"formList",visible:isMultiForm,onitemSelected:function onitemSelected(item){var parentData=this.parent.data,geoRoleList=this.parent.geoRoleList;if(parentData.geoForm.fid!==item.fid){parentData.set("geoForm",item);parentData.set("geoRole",item.fgr);geoRoleList.set("items",getGeoOptions(item));geoRoleList.set("selectedIndex",getGeoRoleIndex(item.fgr,item));}}},{scriptClass:"mstrmojo.ToolSeparator",visible:isMultiForm,markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod}},{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13523,"Select Geographic Type:")},{scriptClass:"mstrmojo.ui.Pulldown",items:getGeoOptions(geoForm),selectedIndex:geoRoleIndex,alias:"geoRoleList",onitemSelected:function onitemSelected(item){var editor=this.parent,parentData=editor.data,geoDrvList=editor.geoDrvList;var drvOptions=[],selectedIndices=[],drvflg=geoForm.der,option;parentData.set("geoRole",item.v);$ARR.forEach(item.parents,function(v,i){option=v;drvOptions.push({n:option.n,der:option.der});if((drvflg&option.der)!==0){selectedIndices[i]=true;}});geoDrvList.set("items",drvOptions);geoDrvList.set("selectedIndices",selectedIndices);$ARR.forEach(["geoDrvSeparator","geoDrvLabel","geoDrvList"],function(w){editor[w].set("visible",drvOptions.length>0);});}},{scriptClass:"mstrmojo.ToolSeparator",markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod},alias:"geoDrvSeparator"},{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13524,"(Optional) Create Additional Attributes:"),alias:"geoDrvLabel"},{scriptClass:"mstrmojo.ui.CheckList",alias:"geoDrvList"}],fnOk:function(data,editor){var cbFn=function(res){var getMappingXML=function(mdata){var mxml="<mpcs>";$ARR.forEach(mdata,function(data){mxml+='<mpc did="'+data.did+'" n="'+data.n+'" georole="'+data.georole+'" drvflg="'+data.drvflg+'" />';});mxml+="</mpcs>";return mxml;},populateMappingData=function(mdata,fm,georole,drvflg){var getColumnDid=function(tbid,attid,fmid){var attInfo=findEmmaAttribute(res,tbid,attid),colInfo=findEmmaMappingColumn(attInfo,fmid);return colInfo&&colInfo.did;};tables.forEach(function(tb,i){var cid=getColumnDid(tb.did,att.did,fm.fid);if(cid){mdata[i]=mdata[i]||[];mdata[i].push({did:cid,n:fm.fnm,georole:georole,drvflg:drvflg});}});},actions=[],mdata=[],geoDrvList=editor.geoDrvList,newDrvflg=0,deleteDrvGeoAtt=false,derivedAttrFlag={2:DERIVED_ATTRIBUTE_STATE,1:DERIVED_ATTRIBUTE_CITY,9:DERIVED_ATTRIBUTE_COUNTY,8:DERIVED_ATTRIBUTE_ZIPCODE}[data.geoRole]||0;$HASH.forEach(geoDrvList.selectedIndices,function(checked,i){if(checked){newDrvflg|=geoDrvList.items[i].der;}});newDrvflg&=derivedAttrFlag;if(geoForm.fgr!==data.geoRole||geoForm.fid!==data.geoForm.fid||geoForm.der!==newDrvflg){if(isMultiForm&&geoForm.fid!==data.geoForm.fid){if(geoForm.fgr!==NONE){populateMappingData(mdata,geoForm,NONE,0);if(geoForm.der>0){deleteDrvGeoAtt=true;}}}if(data.geoForm.fgr!==data.geoRole||data.geoForm.der!==newDrvflg){populateMappingData(mdata,data.geoForm,data.geoRole,newDrvflg);if((newDrvflg&data.geoForm.der)!==data.geoForm.der){deleteDrvGeoAtt=true;}}if(mdata.length>0){mdata.forEach(function(data,i){actions.push({act:"changeEMMAMapping",dsid:dsid,tbid:tables[i].did,mapping:getMappingXML(data)});});submitGeoChange(actions,deleteDrvGeoAtt);}}},onSubmitGeoChange=function(){requestEmmaCubeModel(docModel.mid,dsid,{success:cbFn});};if(!mngd){mstrmojo.warn(mstrmojo.desc(13525,"Modifications to this dataset will affect other reports, documents, and dashboards that share the dataset. Do you want to continue?"),{},{buttons:[$NWB(mstrmojo.desc(219,"Yes"),function(){onSubmitGeoChange();},true,{width:"60px"}),$NWB(mstrmojo.desc(221,"Cancel"),function(){})]});}else{onSubmitGeoChange();}}});}});}());