(function(){mstrmojo.requiresCls("mstrmojo.Table","mstrmojo.Label","mstrmojo.Box","mstrmojo.List");mstrmojo.requiresDescs(2057,7674,7675,7676,7677,7696,7697,9923,9924,12375,12919,12948);var _D=mstrmojo.dom,_C=mstrmojo.css,$DESC=mstrmojo.desc;var _GEOROLE={NONE:0,CITY:1,STATE:2,COUNTRY:3,LOCATION:4,LATITUDE:5,LONGTITUDE:6,OTHER:7,ZIPCODE:8,COUNTY:9};var GEOROLE_COUNTRY_DID=268435456,GEOROLE_STATE_DID=536870912,GEOROLE_CITY_DID=1073741824;var DERIVED_ATTRIBUTE_STATE=268435456,DERIVED_ATTRIBUTE_CITY=805306368,DERIVED_ATTRIBUTE_COUNTRY=805306368,DERIVED_ATTRIBUTE_ZIPCODE=1879048192;var _data=[{n:mstrmojo.desc(2057,"None"),did:_GEOROLE.NONE,geo:true},{n:mstrmojo.desc(7674,"Country"),did:_GEOROLE.COUNTRY,geo:true},{n:mstrmojo.desc(7676,"State"),did:_GEOROLE.STATE,geo:true,items:[{n:mstrmojo.desc(7674,"Country"),did:GEOROLE_COUNTRY_DID}]},{n:mstrmojo.desc(12919,"County"),did:_GEOROLE.COUNTY,geo:true,items:[{n:mstrmojo.desc(7674,"Country"),did:GEOROLE_COUNTRY_DID},{n:mstrmojo.desc(7676,"State"),did:GEOROLE_STATE_DID}]},{n:mstrmojo.desc(7675,"City"),did:_GEOROLE.CITY,geo:true,items:[{n:mstrmojo.desc(7674,"Country"),did:GEOROLE_COUNTRY_DID},{n:mstrmojo.desc(7676,"State"),did:GEOROLE_STATE_DID}]},{n:mstrmojo.desc(7677,"Zip Code"),did:_GEOROLE.ZIPCODE,geo:true,items:[{n:mstrmojo.desc(7674,"Country"),did:GEOROLE_COUNTRY_DID},{n:mstrmojo.desc(7676,"State"),did:GEOROLE_STATE_DID},{n:mstrmojo.desc(7675,"City"),did:GEOROLE_CITY_DID}]},{n:mstrmojo.desc(7696,"Latitude"),did:_GEOROLE.LATITUDE,geo:true},{n:mstrmojo.desc(7697,"Longtitude"),did:_GEOROLE.LONGTITUDE,geo:true},{n:mstrmojo.desc(12948,"City, State"),did:_GEOROLE.LOCATION,geo:true},{n:mstrmojo.desc(9923,"Others..."),did:_GEOROLE.OTHER,geo:true}];mstrmojo.qb.GeoRole=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.qb.GeoRole",markupString:'<div id="{@id}"  class="{@cssClass}" style="top:{@top};left:{@left};width:155px;height:{@height};"><div style="z-index:{@zIndex};{@cssText}" mstrAttach:mousedown,click><div class="mstrmojo-qb-mapping-title">{@title}</div><div class="mstrmojo-qb-mapping-georole"></div></div></div>',markupSlots:{contentNode:function(){return this.domNode.firstChild.childNodes[1];},titleNode:function(){return this.domNode.firstChild.childNodes[0];}},top:"0px",left:"0px",height:"320px",title:$DESC(12375,"Please select a geography role for this attribute and any additional attributes that you want to create."),georole:0,shapeKeys:[],der:0,init:function init(props){this._super(props);this.raiseEvent({name:"shapeKeysChange"});},onshapeKeysChange:function onshapeKeysChange(){var shapeKeys=this.shapeKeys;if(mstrApp.isCloud){_data.splice(-1);}this.geolist.set("items",shapeKeys?_data.concat(this.shapeKeys):_data);},_close:function(){var parent=this.parent;if(parent&&parent._cmSource){parent._cmSource.closeMenuTree();}},onOK:function(){var geo,derivedAttrFlag;this.data.geo=true;if(this.geolist.selectedItem.geo){geo=this.geolist.selectedItem.did;this.data.georole=geo;derivedAttrFlag={2:DERIVED_ATTRIBUTE_STATE,1:DERIVED_ATTRIBUTE_CITY,9:DERIVED_ATTRIBUTE_COUNTRY,8:DERIVED_ATTRIBUTE_ZIPCODE}[geo]||0;this.data.der=this.der=this.der&derivedAttrFlag;}else{this.data.georole=7;this.data.shapeKey=this.geolist.selectedItem.did;}mstrApp.getRootController().setGeoRoles(this.data);this._close();},onCancel:function(){this._close();},children:[{scriptClass:"mstrmojo.List",slot:"contentNode",alias:"geolist",cssClass:"mstrmojo-qb-geolist",itemIdField:"did",cssClassItem:"",onclick:function(evt){var target=_D.eventTarget(evt.hWin,evt.e).parentNode,i,manipulateClassFunc,derivedAttrFlag,elements,maxIndex,mapping,item,georoleItemNodeArr;function getGeoroleAttributeNode(georoleItemNode,childIndex){return georoleItemNode.children[0].children[1].children[0].children[childIndex];}if(target.className.indexOf("mstrmojo-qb-georole-attribute")>-1){derivedAttrFlag=parseInt(target.getAttribute("did"),10);elements=[];georoleItemNodeArr=this.domNode.children[0].children;maxIndex=5;mapping={};mapping[GEOROLE_COUNTRY_DID]={minIndex:2,childIndex:1};mapping[GEOROLE_STATE_DID]={minIndex:3,childIndex:2};mapping[GEOROLE_CITY_DID]={minIndex:5,childIndex:3};item=mapping[derivedAttrFlag];if(item){for(i=maxIndex;i>=item.minIndex;i--){elements.push(getGeoroleAttributeNode(georoleItemNodeArr[i],item.childIndex));}}manipulateClassFunc=(this.parent.der&derivedAttrFlag)?_C.removeClass:_C.addClass;for(i=0;i<elements.length;i++){manipulateClassFunc(elements[i],"selected");}this.parent.der=this.parent.der^derivedAttrFlag;}},adjustMenu:function adjustMenu(){var menu=this.parent.parent;if(menu){menu=menu.parent.parent;if(menu&&menu.adjustMenuPosition){menu.adjustMenuPosition();}}},expandShapeKeyNode:function expandShapeKeyNode(){_C.addClass(this.domNode,"showShapeKey");this.adjustMenu();},onmouseup:function onmouseup(e){switch(this.selectedItem.did){case _GEOROLE.OTHER:this.expandShapeKeyNode();this.set("selectedItem",{did:this.parent.shapeKey});break;}},onchange:function onchange(evt){var added=evt.added;if(added){switch(this.selectedItem.did){case _GEOROLE.COUNTY:case _GEOROLE.CITY:case _GEOROLE.STATE:case _GEOROLE.ZIPCODE:this.adjustMenu();break;case _GEOROLE.OTHER:var prev=evt.removed;if(prev&&prev.length){this.set("selectedIndex",prev[0]);this.expandShapeKeyNode();}break;}}},itemMarkupFunction:function(item,index,widget){var content=[],parent=widget.parent,i,len,itemArr,action;if(item.items){itemArr=item.items;action="onclick=\"mstrmojo.dom.captureDomEvent('"+widget.id+"','click', self, event)\"";content.push('<div class="mstrmojo-qb-georole-attribute-box"><span>');content.push(mstrmojo.desc(9924,"Create attributes for:"));content.push("</span>");for(i=0,len=itemArr.length;i<len;i++){content.push('<div class="mstrmojo-qb-georole-attribute '+((parent.der&itemArr[i].did)?"selected":"")+'" did="'+itemArr[i].did+'"'+action+'><img class="mstrmojo-qb-georole-checkbox" src="../images/1ptrans.gif"><span style="padding-left:5px;">');content.push(itemArr[i].n);content.push("</span></div>");}content.push("</div>");}return'<div class="mstrmojo-qb-georole '+((item.did==_GEOROLE.OTHER)?"other":"")+(item.geo?"":"shapeKey ")+widget.cssClassItem+'" idx="'+index+'" did="'+item.did+'"><div class="mstrmojo-qb-georole-itemtext"><img class="mstrmojo-qb-georole-img" src="../images/1ptrans.gif"><span class="mstrmojo-qb-georole-text">'+item.n+'</span></div><div class="mstrmojo-qb-georole-itemcontent">'+content.join("")+"</div></div>";},onRender:function(){this.set("selectedItem",{did:this.parent.georole});}}]});}());