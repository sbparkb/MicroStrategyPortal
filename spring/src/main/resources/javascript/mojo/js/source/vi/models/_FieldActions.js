(function(){mstrmojo.requiresCls("mstrmojo.EnumRWUnitType","mstrmojo.func","mstrmojo.DocDataService","mstrmojo.vi.models.EnumFieldTypes");mstrmojo.requiresDescs(1013,2922,4538);var $FUNC=mstrmojo.func,$RW_UNIT_TYPES=mstrmojo.EnumRWUnitType,$FORMAT_MODEL=mstrmojo.models.FormatModel,$GET_FORMAT_OBJ=$FORMAT_MODEL.getFormatUpdate,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$DELIMITER="\u001E",UNIT_NAMES={106:{id:"1013",desc:"Text"},102:{id:"2922",desc:"Image"},107:{id:"4538",desc:"HTML Container"}},$ENUM_FIELD_TYPES=mstrmojo.vi.models.EnumFieldTypes;function editFieldValue(w,newV,oldV,ft){if(newV!==oldV){return{act:"editField",fieldKey:w.k,fieldType:ft,fieldValue:newV,nodeKey:w.nk,treeType:1,fieldName:w.defn&&w.defn.n||w.k,partialRetrieval:{nodes:[w.k,w.nk]}};}return undefined;}function defaultFieldName(nodeType){switch(nodeType){case $RW_UNIT_TYPES.TEXTFIELD:case $RW_UNIT_TYPES.IMAGE:case $RW_UNIT_TYPES.HTMLCONTAINER:return mstrmojo.desc(UNIT_NAMES[nodeType].id,UNIT_NAMES[nodeType].desc)+this.updateTypeCounter(nodeType);default:return null;}}function getHtmlFormatAction(htmlBox,htmlType,value){var type=$RW_UNIT_TYPES.HTMLCONTAINER,nk=htmlBox.nk,k=htmlBox.k,action={act:"format",unitType:type,formatType:1,nodeKey:nk,fieldKey:k,keyContext:type+$DELIMITER+nk+$DELIMITER+k,format:{FormattingHTML:{HTMLType:htmlType}},partialRetrieval:{nodes:[k,nk]}};action.format.FormattingHTML[htmlType===1?"HTMLText":"URL"]=value;return action;}mstrmojo.vi.models._FieldActions=mstrmojo.provide("mstrmojo.vi.models._FieldActions",{_mixinName:"mstrmojo.vi.models._FieldActions",insertNewField:function insertNewField(fieldInfo){var model=this,vizContentPanel=model.getVizContentPanel(),fieldType=fieldInfo.t,fieldGroupKey,id=this.id,fieldName=defaultFieldName.call(this,fieldType),panelKey=model.getVizContentPanel().k,nodeKey=model.getNextKey(),oldNodeKey=vizContentPanel.nk,oldFieldGroupKey=vizContentPanel.defn.fgk,ctrlKey;this.execute({execute:function(){var dataService=model.getDataService(),update=dataService.newUpdate(this,{extras:mstrmojo.DocDataService.REQUEST_DEFN_DATA});var node=model.createNewUnitNode(function(data){data.v=fieldInfo.v;return data;},function(defn){defn.t=fieldType;defn.n=fieldName||nodeKey;return defn;},function(node){fieldGroupKey=vizContentPanel.defn.fgk||vizContentPanel.nk;node.nk=nodeKey=fieldGroupKey||mstrmojo.all[id].getNextKey();return node;});var unit=model.createUnit(node,panelKey);ctrlKey=unit.k;unit.nk=vizContentPanel.nk=nodeKey;var fnGetAction=function(action){action.fieldKey=ctrlKey;action.fieldType=fieldInfo.ft;action.nodeKey=nodeKey;action.treeType=1;action.fieldName=fieldName||nodeKey;action.partialRetrieval={nodes:[nodeKey]};return action;};update.addActions([fnGetAction({act:"addField",createNode:!fieldGroupKey,nodeKeyParent:vizContentPanel.k}),fnGetAction({act:"editField",fieldValue:fieldInfo.v})]);if(fieldInfo.getAdditionalActions){update.addActions(fieldInfo.getAdditionalActions(unit)||[]);}model.deferredInsertUnit(update,unit,panelKey);this.submitUpdate(update);},urInfo:{treesToRender:3,undo:function(){var vizContentPanel=model.getVizContentPanel();vizContentPanel.nk=oldNodeKey;vizContentPanel.defn.fgk=oldFieldGroupKey;var unitContainer=vizContentPanel.getUnitByKey(ctrlKey);unitContainer.defn._isDeleted=true;unitContainer.undoInsert();delete this.callback;return true;},redo:function(){var node=model.createNewUnitNode(function(data){data.v=fieldInfo.v;return data;},function(defn){defn.t=fieldType;defn.n=fieldName||nodeKey;return defn;},function(node){node.nk=nodeKey;return node;},ctrlKey);var unit=model.createUnit(node,panelKey);unit.nk=model.getVizContentPanel().nk=nodeKey;var dataService=model.getDataService(),update=dataService.newUpdate(this,{extras:mstrmojo.DocDataService.REQUEST_DEFN_DATA});model.deferredInsertUnit(update,unit,panelKey);if(this.urInfo){this.urInfo.callback=update.callback;}this.callback=update.callback;return false;}}});},insertNewText:function insertNewText(){var TEXTFIELD=$RW_UNIT_TYPES.TEXTFIELD;this.insertNewField({v:"",t:TEXTFIELD,ft:$ENUM_FIELD_TYPES.TEXT,getAdditionalActions:function getAdditionalActions(unit){var unitKey=unit.k,nodeKey=unit.nk;return[{act:"format",unitKey:unitKey,unitType:TEXTFIELD,formatType:1,fieldKey:unitKey,nodeKey:nodeKey,keyContext:TEXTFIELD+$DELIMITER+nodeKey+$DELIMITER+unitKey,format:{FormattingSize:{TextOverflow:1}}}];}});},editField:function editField(w,ft,callback,newURL,oldURL,extraInfo){var me=this,actions=(extraInfo&&extraInfo.actions)||[],extraCallBack=extraInfo&&extraInfo.callback,action,extras=extraInfo&&extraInfo.extras,unitKey=w.k;action=editFieldValue.call(me,w,newURL,oldURL,ft);if(action){actions.push(action);}this.execute({execute:function(){this.submit(actions,$FUNC.wrapMethods(extraCallBack,{success:function(res){if(ft===$ENUM_FIELD_TYPES.IMAGE&&w.defn.oid){delete w.defn.oid;}me.partialUpdate(res.data,me.getTargetDefn(w.k),res.defn,[unitKey]);me.selectVIUnit(w.id);if(callback&&callback.success){callback.success(res);}},failure:function(){if(callback&&callback.fail){callback.fail();}}}),extras);}});},getRemoveFieldUpdate:function getRemoveFieldUpdate(field){return this.getDataService().newUpdate(null,{actions:[{act:"removeField",treeType:"1",nodeKey:field.nk,fieldKey:field.k}]});},editLink:function editImage(w,ft,xml,callback){var action=this.getUnitFormatAction(w,1,{FormattingNavigation:{Hyperlinks:xml}});var dataService=this.getDataService();this.execute({execute:function(){var cmd=this,update=dataService.newUpdate(cmd,{actions:[action],callback:callback});update.submit();},urInfo:{silent:true,undo:callback.undo,redo:callback.redo}});},editHtmlContainer:function editHtmlContainer(htmlBox,htmlType,value,callback){var id=this.id,$DS=mstrmojo.DocDataService,urInfo={callback:mstrmojo.DocDataService.EMPTY_CALLBACK,undo:callback.undo,redo:callback.redo};if(htmlType!==1){urInfo.extras=$DS.SUPPRESS_DATA;}this.execute({execute:function(){var model=mstrmojo.all[id],dataService=model.getDataService(),extras=(htmlType!==1?{extras:$DS.SUPPRESS_DATA}:null),update=dataService.newUpdate(this,extras),k=htmlBox.k;update.addActions([getHtmlFormatAction(htmlBox,htmlType,value)]);update.addCallbacks($FUNC.wrapMethods(callback,{success:function(res){model.partialUpdate(res.data,model.getTargetDefn(k),res.defn);}}));this.submitUpdate(update);},urInfo:urInfo});},insertNewImage:function insertNewImage(){this.insertNewField({v:"",t:$RW_UNIT_TYPES.IMAGE,ft:$ENUM_FIELD_TYPES.IMAGE,getAdditionalActions:function getAdditionalActions(unit){var getUnitFormatAction=unit.model.getUnitFormatAction;return[getUnitFormatAction(unit,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.IMAGE_HEIGHT,0),true),getUnitFormatAction(unit,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.IMAGE_WIDTH,0),true)];}});},insertNewHtmlContainer:function insertNewHtmlContainer(){this.insertNewField({v:"",t:$RW_UNIT_TYPES.HTMLCONTAINER,ft:$ENUM_FIELD_TYPES.HTML_CONTAINER});}});}());