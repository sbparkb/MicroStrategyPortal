(function(){var cachedCalls=[];function cacheCall(func,args){cachedCalls.push({n:func,args:args});}function checkLoadingStatus(geo,func,args){var ok=false;switch(geo._loadingStatus){case 0:if(google&&google.maps&&google.maps.Geocoder){geo._loadingStatus=2;ok=true;}else{cacheCall(func,args);geo._loadScript();}break;case 1:cacheCall(func,args);break;case 2:ok=true;break;}return ok;}mstrmojo.GeoLocation=mstrmojo.provide("mstrmojo.GeoLocation",{_altitude:null,_latitude:null,_longitude:null,_callbacks:[],_getPos:function(){if(mstrMobileApp&&mstrMobileApp.getGeoLocation){mstrmojo.GeoLocation._getPos=function(){mstrMobileApp.getGeoLocation("mstrmojo.GeoLocation.updateLocation");};}else{if(navigator&&navigator.geolocation){mstrmojo.GeoLocation._getPos=function(){navigator.geolocation.getCurrentPosition(function(position){mstrmojo.GeoLocation.updateLocation(position);},function(error){switch(error.code){case error.TIMEOUT:alert("Retrieve Geo Position: Timeout, please try it again ");break;case error.PERMISSION_DENIED:alert("Retrieve Geo Position: Permission to use location service has been denied ");break;case error.POSITION_UNAVAILABLE:alert("Retrieve Geo Position: Position unavaiable ");break;}mstrmojo.GeoLocation.updateLocation(error);},{maximumAge:10000,timeout:10000});};}else{mstrmojo.GeoLocation._getPos=function(){alert("no available Geo Location service");};}}mstrmojo.GeoLocation._getPos();},getCurrentLocation:function(callbacks){this._callbacks.push(callbacks);if(!this._pending){this._pending=true;this._getPos();}},updateLocation:function(info){var me=mstrmojo.GeoLocation;var i,cbs;var p=info&&info.coords;var e=info&&info.err;if(p){me._latitude=p.latitude;me._longitude=p.longitude;cbs=me._callbacks;for(i=0;i<cbs.length;i++){cbs[i].success(p.latitude,p.longitude);}}else{if(e){cbs=me._callbacks;for(i=0;i<cbs.length;i++){cbs[i].failure("Error in updating geo location information."+e);}}else{cbs=me._callbacks;for(i=0;i<cbs.length;i++){cbs[i].failure("Error in updating geo location information.");}}}me._callbacks=[];me._pending=false;},getCurrentAddress:function(callbacks){this.getCurrentLocation({success:function(la,lo,al){mstrmojo.GeoLocation.findAddress({lat:la,lng:lo},{success:callbacks.success&&callbacks.success||mstrmojo.emptyFn,failure:callbacks.failure&&callbacks.failure||mstrmojo.emptyFn});},failure:callbacks.failure&&callbacks.failure||mstrmojo.emptyFn});},count:null,cbs:null,getUniqId:function getUniqId(){var c;if(!this.count){c=this.count=1;}else{c=this.count++;}return"fa"+c;},findAddress:function findAddress(latlng,callbacks){if(!mstrMobileApp||!mstrMobileApp.useNativeMap||!mstrMobileApp.useNativeMap()){this.findAddressUsingJsAPI(latlng,callbacks);}else{this.findAddressUsingNativeAPI(latlng,callbacks);}},findAddressUsingJsAPI:function findAddressUsingJsAPI(latlng,callbacks){if(checkLoadingStatus(this,"findAddress",[latlng,callbacks])){var geocoder=new google.maps.Geocoder();geocoder.geocode({location:new google.maps.LatLng(latlng.lat,latlng.lng)},function(results,status){if(status==google.maps.GeocoderStatus.OK&&results[0]){callbacks.success(results);}else{callbacks.failure(results,status);}});}},findAddressUsingNativeAPI:function findAddressUsingNativeAPI(latlng,callbacks){var id=this.getUniqId();if(this.cbs==null){this.cbs={};}this.cbs[id]=function(result){if(result.status=="OK"){callbacks.success(result.results);}else{callbacks.failure(result.results,result.status);}};mstrMobileApp.findAddress(latlng.lat,latlng.lng,"mstrmojo.GeoLocation.findAddressCallback",id);},findAddressCallback:function findAddressCallback(res,status,id){this.cbs[id].apply(mstrmojo.GeoLocation,[res]);},_loadingStatus:0,_loadScriptCallBack:function _loadScriptCallBack(){this._loadingStatus=2;for(var i=0;i<cachedCalls.length;i++){var c=cachedCalls[i];mstrmojo.GeoLocation[c.n].apply(mstrmojo.GeoLocation,c.args);}},_loadScript:function _loadScript(){this._loadingStatus=1;var script=document.createElement("script");script.type="text/javascript";script.src="http://maps.google.com/maps/api/js?sensor=false&callback=mstrmojo.GeoLocation._loadScriptCallBack";document.body.appendChild(script);}});})();