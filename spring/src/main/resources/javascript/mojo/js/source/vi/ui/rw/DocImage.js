(function(){mstrmojo.requiresCls("mstrmojo.DocImage","mstrmojo.HBox","mstrmojo.Label","mstrmojo.TextBox","mstrmojo.Button","mstrmojo._HasDocLink","mstrmojo.css","mstrmojo.dom","mstrmojo.DocDataService","mstrmojo.vi.models.EnumFieldTypes");var $DOM=mstrmojo.dom;var MODE_DEFAULT=-1,MODE_ORIGINAL=0,MODE_FIXED=1,MODE_FIT_TO_CONTAINER=2,MODE_FILL_CONTAINER=3,MODE_STRETCH=4,$PX2INCHES=mstrmojo.boxmodel.px2Inches,$FORMAT_MODEL=mstrmojo.models.FormatModel,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$ENUM_FIELD_TYPES=mstrmojo.vi.models.EnumFieldTypes,updateLinkCss=function updateLinkCss(){var domNode=this.domNode;if(!domNode){return ;}mstrmojo.css.toggleClass(domNode,"hasLink",this.hasActiveLink());},updateDimension=function updateDimension(){var imageNode=this.imgNode.firstChild;this.originalImgDim={w:imageNode.naturalWidth,h:imageNode.naturalHeight};var imgDim=this.getCalculatedImageDimensions();this.defn.ih=this.imgNode.style.height=imgDim.h+"px";this.defn.iw=this.imgNode.style.width=imgDim.w+"px";if(imgDim.ml){this.imgNode.style.marginLeft=imgDim.ml+"px";}if(imgDim.mt){this.imgNode.style.marginTop=imgDim.mt+"px";}};function onImageReady(){if(this._isNewUrl){setUrlAndDimensions.call(this);delete this._isNewUrl;}else{if(this._isNewEmbeddedImg){setDimensions.call(this);delete this._isNewEmbeddedImg;}}updateDimension.call(this);}function setUrlAndDimensionsHelper(newUrl,oldUrl){var imgBox=this.parent,imageNode=this.imgNode.firstChild,zoomProps=this.model.getZoomProps(),formatObj={},getFormatUpdate=$FORMAT_MODEL.getFormatUpdate,naturalHeight=imageNode.naturalHeight,naturalWidth=imageNode.naturalWidth,imgHeight,imgWidth;if(naturalHeight===0||naturalWidth===0){imgHeight="30";imgWidth="30";}else{imgHeight=naturalHeight;imgWidth=naturalWidth;}getFormatUpdate($ENUM_FORMAT_PROPERTIES.IMAGE_HEIGHT,$PX2INCHES(zoomProps,parseFloat(imgHeight)),formatObj);getFormatUpdate($ENUM_FORMAT_PROPERTIES.IMAGE_WIDTH,$PX2INCHES(zoomProps,parseFloat(imgWidth)),formatObj);imgBox.model.editField(imgBox,$ENUM_FIELD_TYPES.IMAGE,{success:function(){imgBox.selectVIUnit(true);}.bind(this)},newUrl,oldUrl,{actions:[this.model.getUnitFormatAction(this,1,formatObj,true)],extras:mstrmojo.DocDataService.REQUEST_DEFN_DATA});}function setDimensions(){setUrlAndDimensionsHelper.call(this,"","");}function setUrlAndDimensions(){setUrlAndDimensionsHelper.call(this,this.v,null);}mstrmojo.vi.ui.rw.DocImage=mstrmojo.declare(mstrmojo.DocImage,[mstrmojo._HasDocLink],{scriptClass:"mstrmojo.vi.ui.rw.DocImage",markupString:'<div id="{@id}" class="mstrmojo-DocImage {@imgStateClass}" style="{@domNodeCssText}"><div class="img-cntr"><img src="{@v}" mstrAttach:load,error><div mstrAttach:click></div></div>{@buttonNodeMarkup}</div>',markupMethods:{onheightChange:function onheightChange(){this.domNode.style.height=this.height;},onwidthChange:function onwidthChange(){this.domNode.style.width=this.width;},onvisibleChange:mstrmojo.Widget.visibleMarkupMethod},formatHandlers:{domNode:["BG"]},originalImgDim:undefined,model:undefined,onload:function onload(){onImageReady.call(this);},onerror:function onerror(){onImageReady.call(this);},update:function update(node){var me=this;var cacheSuper=this._super;var rwUpdate=function(){cacheSuper.call(this,node);var parent=this.parent;if(parent){parent.updateOverlay();}updateLinkCss.call(this);}.bind(this);if(node&&node.defn&&node.defn.oid){var fmts=node.defn.fmts,imgName=fmts&&fmts["img-name"];if(this.parent&&imgName){this.parent.embeddedImageName=decodeURIComponent(imgName);}if(mstrApp.isSingleTier){var para={taskId:"getRWEmbeddedImage",fieldKey:node.k};var callback={success:function(res){if(res&&res.imageData){node.data.v=res.imageData;}rwUpdate();me.refresh();}};mstrApp.serverRequest(para,callback);}else{var ds=this.model.getDataService();node.data.v=mstrConfig.taskURL+"?taskId=getRWEmbeddedImage&amp;msgID="+ds.msgId+"&amp;oid="+node.defn.oid;}}rwUpdate();},postBuildRendering:function postBuildRendering(){this._super();updateLinkCss.call(this);updateDimension.call(this);},unrender:function unrender(ignoreDom){this.clearCache();this._super(ignoreDom);},isAspectRatioLocked:function isAspectRatioLocked(){return this.defn.lock;},getSizeMode:function getSizeMode(){return this.defn.ism;},getImageWidth:function getImageWidth(){return this.defn.iw;},getImageHeight:function getImageHeight(){return this.defn.ih;},updateDimensionsFromFormats:mstrmojo.emptyFn,getCalculatedImageDimensions:function getCalculatedImageDimensions(config){config=config||{mode:this.getSizeMode(),iw:parseFloat(this.getImageWidth()),ih:parseFloat(this.getImageHeight()),lock:this.isAspectRatioLocked()};var result={},containerWidget=this.parent,originalImgDim=this.originalImgDim,mode=config.mode;if(!originalImgDim||!containerWidget.width){return result;}var containerDim={w:parseFloat(containerWidget.width),h:parseFloat(containerWidget.height)};var imgWHRatio=(originalImgDim.h!==0)?originalImgDim.w/originalImgDim.h:1,containerWH=containerDim.w/containerDim.h;switch(mode){case MODE_DEFAULT:case MODE_FIXED:var fixedWidth=config.iw,fixedHeight=config.ih;if(config.lock&&(fixedWidth!==undefined||fixedHeight!==undefined)&&(originalImgDim.h!==0&&originalImgDim.w!==0)){var isLockedToWidth=fixedHeight===undefined;if(isLockedToWidth){result.w=fixedWidth;result.h=(fixedWidth/imgWHRatio).toFixed(0);}else{result.h=fixedHeight;result.w=(fixedHeight*imgWHRatio).toFixed(0);}}else{result.w=fixedWidth;result.h=fixedHeight;}break;case MODE_FIT_TO_CONTAINER:case MODE_FILL_CONTAINER:var fixHeightDimension=((mode===MODE_FILL_CONTAINER&&(imgWHRatio>containerWH))||(mode===MODE_FIT_TO_CONTAINER&&(imgWHRatio<containerWH))),isFirefox=$DOM.isFF;if(fixHeightDimension){result.h=containerDim.h;result.w=parseInt(containerDim.h*imgWHRatio);if(isFirefox){result.ml=parseFloat((containerDim.w-result.w)/2);}}else{result.w=containerDim.w;result.h=parseInt(containerDim.w/imgWHRatio);if(isFirefox){result.mt=parseFloat((containerDim.h-result.h)/2);}}break;case MODE_STRETCH:case MODE_ORIGINAL:var dimObj=mode===MODE_STRETCH?containerDim:originalImgDim;result.w=dimObj.w;result.h=dimObj.h;break;default:break;}return result;}});mstrmojo.vi.ui.rw.DocImage.EnumSizeModes={ORIGINAL:MODE_ORIGINAL,FIT_TO_CONTAINER:MODE_FIT_TO_CONTAINER,FILL_CONTAINER:MODE_FILL_CONTAINER,STRETCH:MODE_STRETCH,FIXED:MODE_FIXED};mstrmojo.vi.ui.rw.DocImage.ImgDimConfigType=null;}());