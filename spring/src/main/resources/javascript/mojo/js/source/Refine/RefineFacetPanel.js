(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Refine.ListFacet","mstrmojo.Refine.RangeFacet","mstrmojo.Refine.TimeRangeFacet","mstrmojo.Refine.TextSearchFacet");var _D=mstrmojo.dom;mstrmojo.Refine.RefineFacetPanel=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.Refine.RefineFacetPanel",facets:[],markupString:'<div class="refine-facet-panel"><div class="browsing-panel-header"><div class="browsing-panel-indicator"><img src="../javascript/mojo/css/images/Refine/small-spinner.gif"> Refreshing facets...</div><div class="browsing-panel-controls"  mstrAttach:click><div class="browsing-panel-controls-refresh"><a class="button" title="Update all facets">Refresh</a></div><a class="button button-pill-left" title="Clear selection in all facets">Reset All</a><a class="button button-pill-right" title="Remove all facets">Remove All</a></div></div><ul class="facets-container ui-sortable"></ul></div>',markupSlots:{ulNode:function(){return this.domNode.children[1];},indicatornNode:function(){return this.domNode.children[0].children[0];},controlsNode:function(){return this.domNode.children[0].children[1];},refreshNode:function(){return this.domNode.children[0].children[1].children[0].children[0];},resetNode:function(){return this.domNode.children[0].children[1].children[1];},removeNode:function(){return this.domNode.children[0].children[1].children[2];},headerNode:function(){return this.domNode.children[0];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},onclick:function(evt){var e=evt.e,i,t=_D.eventTarget(evt.hWin,e);if(t===this.refreshNode){this.updateEngine(true);}else{if(t===this.resetNode){this.resetAllFacets();this.updateEngine(true);}else{if(t===this.removeNode){this.removeAllFacets();this.updateEngine(true);}}}},resetAllFacets:function(){var i;for(i=0;i<this.facets.length;i++){var facet=this.facets[i];facet.reset();}},removeAllFacets:function(){var i;while(this.facets.length){var facetRecord=this.facets[0];this.facets.splice(0,1);this.removeChildren(facetRecord);facetRecord.destroy();}for(i=0;i<this.facets.length;i++){if(typeof this.facets[i].update==="function"){this.facets[i].update();}}},hasSelection:function(){var i;for(i=0;i<this.facets.length;i++){var facet=this.facets[i];if(facet.hasSelection()){return true;}}return false;},getRequirementDiscription:function(){var i,res="";var selectedFacets=[],facet;for(i=0;i<this.facets.length;i++){facet=this.facets[i];if(facet.hasSelection()){selectedFacets.push(facet);}}for(i=0;i<selectedFacets.length;i++){facet=selectedFacets[i];res+=facet.getRequirementDiscription();if(i!==selectedFacets.length-1){res+=" & ";}}return res;},getJSON:function(keepUnrestrictedFacets){var i;var a={facets:[],mode:"row-based"};for(i=0;i<this.facets.length;i++){var facet=this.facets[i];if(keepUnrestrictedFacets||facet.hasSelection()){a.facets.push(facet.getJSON());}}return a;},updateEngine:function(update){var controller=this.parent.parent.parent.controller;var model=controller.model;if(update){this.parent.toggleSecondItemVisibility(true);this.controlsNode.style.visibility="hidden";this.indicatornNode.style.visibility="visible";model.engine=JSON.stringify(this.getJSON());model.start=0;controller.loadData();}else{model.engine=JSON.stringify(this.getJSON());}},addFacets:function(type,config){var facet;switch(type){case"range":facet=new mstrmojo.Refine.RangeFacet({slot:"ulNode",type:type,config:config,options:{}});break;case"timerange":facet=new mstrmojo.Refine.TimeRangeFacet({slot:"ulNode",type:type,config:config,options:{}});break;case"text":facet=new mstrmojo.Refine.TextSearchFacet({slot:"ulNode",type:type,config:config,options:{}});break;default:facet=new mstrmojo.Refine.ListFacet({slot:"ulNode",type:type,config:config,options:{sort:"name"}});}this.addChildren([facet]);this.facets.push(facet);this.updateEngine(true);},removeFacet:function(facet){var i;var update=facet.hasSelection();for(i=this.facets.length-1;i>=0;i--){var facetRecord=this.facets[i];if(facetRecord===facet){this.facets.splice(i,1);this.removeChildren(facetRecord);facetRecord.destroy();break;}}for(i=0;i<this.facets.length;i++){if(typeof this.facets[i].update==="function"){this.facets[i].update();}}if(update){this.updateEngine(true);}else{this.updateEngine(false);if(this.facets.length===0){this.parent.toggleSecondItemVisibility(false);}}},handleFacetsFetched:function(data){var facetData=data.facets,i;for(i=0;i<facetData.length;i++){this.facets[i].updateState(facetData[i]);}this.indicatornNode.style.visibility="hidden";if(this.facets.length>0){this.controlsNode.style.visibility="visible";}else{this.parent.toggleSecondItemVisibility(false);}this.updateEngine(false);},children:[],setDimensions:function setDimensions(h,w){var height=parseInt(h,10);var width=parseInt(w,10);if(isNaN(height)||isNaN(width)){return ;}if(!this.layoutConfig){this.layoutConfig={h:{},w:{}};}if(height<2){height=2;}this.layoutConfig.h.ulNode=(height-2)+"px";this.layoutConfig.w.ulNode=(width-2)+"px";if(this._super){this._super((height-2)+"px",(width-2)+"px");}}});}());