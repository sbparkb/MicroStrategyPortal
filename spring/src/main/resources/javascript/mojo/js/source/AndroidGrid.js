(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo.color","mstrmojo.css","mstrmojo.AndroidGridBase");var $C=mstrmojo.css,$CLR=mstrmojo.color;function findContainerByMethodName(w,func){var anc=w&&w.parent;while(anc&&anc.scriptClass.indexOf("DocPanelStack")===-1){if(func in anc){return anc;}anc=anc.parent;}return null;}function repaint(node){var img=document.createElement("img");node.appendChild(img);node.removeChild(img);}function getTableRowCells(ri,grid){var page=Math.floor(ri/grid.rowsPerPage),row=ri%grid.rowsPerPage,tbl=grid.tableNode.tBodies[page];r=tbl.rows[row].cells;return r;}function renderingCleanUp(){var timer=this._renderTimer;if(timer){self.clearInterval(timer);delete this._renderTimer;this.renderingRows=false;}}mstrmojo.AndroidGrid=mstrmojo.declare(mstrmojo.AndroidGridBase,null,{scriptClass:"mstrmojo.AndroidGrid",rowsPerPage:0,effectiveRh:0,numPagesRendered:0,totalPages:0,pageStatus:null,_defaultPageHeight:0,renderPause:10,rhMin:15,defaultRowsPerPage:100,minRowsPerPage:50,init:function init_Grid(props){this._super(props);this.forceFixedSizes=true;},initPageSettings:function intiPageSettings(){var p=this.parent,rpp=this.defaultRowsPerPage;this.effectiveRh=this.rh||this.rhMin||1;if(p&&p.numRowFixed){rpp=this.cp.getAvailableRowsCount();}else{if(p&&p.scrollboxHeightFixed){rpp=Math.ceil(p.scrollboxHeight/this.effectiveRh);rpp=Math.max(rpp,this.minRowsPerPage);}}this.pageStatus=[];this.rowsPerPage=rpp;this.initPageStatus(this.pageStatus);this._defaultPageHeight=this.rowsPerPage*this.effectiveRh;},initPageStatus:function initPageStatus(pageStatus){var rpp=this.rowsPerPage;this.totalPages=rpp&&Math.ceil(this.cp.rc/rpp)||0;pageStatus=pageStatus||this.pageStatus;for(var i=0;i<this.totalPages;++i){var startIndex=i*rpp,endIndex=startIndex+rpp-1,dataAvailable=this.cp.isDataAvailable(startIndex,endIndex);if(!pageStatus[i]){pageStatus[i]={};}pageStatus[i].onDemand=!dataAvailable;}},buildRendering:function buildRendering(tcn){if(this.renderMode=="vscroll"){this.initPageSettings();var ps0=this.pageStatus[0],isOnDemand=ps0&&ps0.onDemand;this.start=0;this.end=-1;if(!isOnDemand){this.end=Math.min(this.cp.rc,this.rowsPerPage)-1;}this.preRenderPages();this.preRenderPage(0,!isOnDemand);}this._super();if(this.renderMode=="vscroll"){var p=this.parent,me=this,setMinHeight=function(){me.gridContainerNode.style[mstrmojo.css.MINHEIGHT]=(me.cp.rc*me.effectiveRh)+"px";};if(mstrmojo.dom.isIE7){this.gridContainerNode.style.zoom="1";window.setTimeout(setMinHeight,10);}else{setMinHeight();}if(!this.connectedScrollbox){if(p&&p.connectScrollbox){p.connectScrollbox(this);this.connectedScrollbox=true;}}this.postRenderPage(0,!isOnDemand);this.postRenderPages();var afc=p&&!p.scrollboxHeightFixed&&!p.numRowFixed;if(afc&&this.numPagesRendered>=this.totalPages&&!isOnDemand){this.postRenderingCleanup();}else{if(isOnDemand||afc){this.onscroll();}}}else{this.configureActions();}},preRenderPages:function prePages(){},postRenderPages:function postPages(){this.configureActions();},configureActions:function configureActions(){var p=this.parent;if(p&&p.configureActions){p.configureActions();}},preRenderPage:function prePage(idx,bFillCells){this.pageNum=idx;},postRenderPage:function postPage(idx,bFillCells,el){if(idx+1>this.numPagesRendered){this.numPagesRendered=idx+1;}var arr=this.pageStatus,status=arr[idx];if(!status){status=arr[idx]={};}if(bFillCells){status.filled=true;status.dirty=false;}var cnStyle=this.gridContainerNode.style;if(idx==this.totalPages-1&&cnStyle){cnStyle[mstrmojo.css.MINHEIGHT]="";}},invalidAllPages:function(){for(var i=0;i<this.totalPages;++i){var ps=this.pageStatus[i];if(ps.filled){ps.dirty=true;}ps.onDemand=true;ps.filled=false;ps.isDownloading=false;}this.thPosMap=[];this.posMap=[];},_startPageRenderThread:function startRndrThd(){var id=this.id;this.renderingRows=true;this._renderTimer=self.setInterval(function(){try{var grid=mstrmojo.all[id];if(!grid){return ;}var pages=grid.getPagesToRender();if(pages.length>0){grid.preRenderPages();grid.renderPages(pages);grid.postRenderPages();grid._postPagesClearup=true;}else{if(grid._postPagesClearup){grid.postRenderPagesCleanup();grid._postPagesClearup=false;}renderingCleanUp.call(grid);if(grid.isRenderingComplete()){grid.postRenderingCleanup();}}}catch(ex){renderingCleanUp.call(mstrmojo.all[id]);throw ex;}},this.renderPause);},onscroll:function onscroll(setMask){if(!this.renderingRows){if(setMask===true){var p=this.parent;if(p&&p.maskNode){$C.addClass(p.maskNode,"wait");}}this._startPageRenderThread();}},isRenderingComplete:function isRdrComplete(){if(this.end>=this.cp.rc-1){for(var arr=this.pageStatus,i=this.totalPages-1;i>-1;i--){if(!arr[i]||!arr[i].filled){return false;}}return true;}return false;},renderPages:function renderPages(pages){for(var i=0,len=pages.length;i<len;++i){this.renderPage(pages[i].idx,pages[i].fill);}},renderPage:function renderPage(idx,bFillCells){var arrStatus=this.pageStatus,alreadyRendered=(this.numPagesRendered>=idx+1);if(alreadyRendered){if(!bFillCells||(arrStatus[idx]&&arrStatus[idx].filled)){return ;}}var rpp=this.rowsPerPage,dn=this.domNode;this.start=idx*rpp;this.end=Math.min(this.start+rpp,this.cp.rc)-1;this.preRenderPage(idx,bFillCells);var tempTable=this.tempTable;if(!tempTable){tempTable=this.tempTable=dn.ownerDocument.createElement("div");}var tInnerHTML=bFillCells?this.buildTableRowsMarkup(this.start,this.end,'<table><tbody n="'+this.pageNum+'">',"</tbody></table>").join(""):'<table><tbody n="'+this.pageNum+'"><tr><td style="height:'+(this.effectiveRh*(this.end-this.start+1))+'px">&nbsp;</td></tr></tbody></table>';tempTable.innerHTML=tInnerHTML;var tbody=tempTable.firstChild.tBodies[0],tn=this.tableNode;if(!alreadyRendered){tn.appendChild(tbody);}else{tn.replaceChild(tbody,tn.tBodies[idx]);}this.postRenderPage(idx,bFillCells,tbody);},getPagesToRender:function getPagesToRender(){var pages=[],p=this.parent,pageSize=this._defaultPageHeight,tBodies=null,stats=this.pageStatus,me=this;function pageHeight(idx){var stat=stats[idx];if(stat&&(stat.filled||stat.dirty)){if(!stat.height){if(!tBodies){tBodies=me.tableNode.tBodies;}stat.height=tBodies[idx].offsetHeight;}return stat.height;}else{return pageSize;}}var y=0,topPageIdx=null,bottomPageIdx=null,scrollTop=p.scrollboxTop;for(var i=0,len=this.totalPages,arr=this.pageStatus;i<len;i++){y+=pageHeight(i);if(y>=scrollTop){topPageIdx=i;break;}}if(topPageIdx===null){topPageIdx=bottomPageIdx=len-1;}else{var scrollBottom=p.scrollboxBottom;if(isNaN(scrollBottom)&&p.numRowFixed){scrollBottom=scrollTop;}for(var j=topPageIdx+1;j<len;j++){if(y>scrollBottom){bottomPageIdx=j-1;break;}y+=pageHeight(j);}}if(bottomPageIdx===null){bottomPageIdx=len-1;}for(var n=this.numPagesRendered;n<topPageIdx;++n){pages.push({idx:n,fill:false});}var arrStats=this.pageStatus,numRowsToDownload=0,rpp=this.rowsPerPage,showStatus=false;for(var m=topPageIdx;m<=bottomPageIdx;++m){var stat=stats[m];if(!stat||!stat.filled){if(stat&&stat.onDemand){showStatus=true;if(!stat.isDownloading&&!this.isDownloading){numRowsToDownload+=rpp;stat.isDownloading=true;this.isDownloading=true;var startIndex=m*rpp,endIndex=startIndex+rpp-1;this.cp.download(startIndex,endIndex);}pages.push({idx:m,fill:false});}else{pages.push({idx:m,fill:true});}}}if(showStatus){this.parent.showDownloadStatus(numRowsToDownload);}else{if(this.parent.closeDownloadStatus){this.parent.closeDownloadStatus();}}return pages;},addHilitePosition:function(key,row,cell){var hm=this.hiliteCellsMap[key];if(!hm){this.hiliteCellsMap[key]={pos:[],nodes:[]};}var r=row-(this.pageNum||0)*this.rowsPerPage;this.hiliteCellsMap[key].pos.push({row:r,cell:cell,page:this.pageNum});},setHilites:function(key,node){var ei=node.getAttribute("ei"),pos=this.eiMap[ei],arr=this.getNodesByPositions(pos);if(!arr.length){this._super(key,node);return ;}for(var i=0,iLens=arr.length;i<iLens;i++){this._super(key,arr[i]);}},addExtraInfoMap:function(ei,row,cell){if(!this.eiMap[ei]){this.eiMap[ei]=[];}this.eiMap[ei].push(this.getPosObj(row,cell));},addPositionMap:function(ei,row,cell){if(!this.posMap[ei]){this.posMap[ei]=this.getPosObj(row,cell);}},addTitleHeaderPositionMap:function(row,cell,o){var pos=this.getPosObj(row,cell);pos.obj=o;this.thPosMap.push(pos);},getPosObj:function(r,c){return{row:r-this.pageNum*this.rowsPerPage,cell:c,page:this.pageNum};},getNodeByPosition:function(pos){return this.tableNode.tBodies[pos.page].rows[pos.row].cells[pos.cell];},getRowIdxByCell:function(cell){var pos=this.posMap[cell._ei];return pos.page*this.rowsPerPage+pos.row;},getNodesByPositions:function(pos){var arr=[];for(var i in pos){var v=pos[i],p=(v&&v.page)||0,r=v&&v.row,c=v&&v.cell;arr.push(this.tableNode.tBodies[p].rows[r].cells[c]);}return arr;},getPageHeight:function getPageHeight(idx){var tbd=this.tableNode.tBodies;return(tbd&&tbd[idx]&&tbd[idx].offsetHeight)||0;},getTargetCell:function(x,y){var h=0,i=0;for(var len=this.totalPages;i<len;i++){h+=this.getPageHeight(i);if(y<=h){break;}}var tbody=this.tableNode.tBodies[i];if(tbody){for(var i=0,len=tbody.rows.length;i<len;i++){var row=tbody.rows[i];for(var j=0,jLen=row.cells.length;j<jLen;j++){var cell=row.cells[j];if(cell.offsetTop+cell.offsetHeight>=y){if(x>=cell.offsetLeft&&x<=cell.offsetLeft+cell.offsetWidth){return cell;}}else{break;}}}}},postRenderPagesCleanup:function _postRenderPagesCleanup(){var p=this.parent;if(p&&p.gridData&&p.gridData.afc){var tb=this.tableNode;if(tb&&(this.lastWidth!=tb.offsetWidth)){if(p.onGridWidthChanged){p.onGridWidthChanged();}mstrmojo.array.forEach(this.pageStatus,function(s){delete s.height;});this.lastWidth=tb.offsetWidth;}var w=findContainerByMethodName(p,"adjustAutoWidth");if(w){w.adjustAutoWidth(p);}}if(p.gridPagesRendered){p.gridPagesRendered();}if(mstrmojo.dom.isIE&&!mstrmojo.dom.isIE8){repaint(this.domNode);}if(p&&p.maskNode){$C.removeClass(p.maskNode,"wait");}this.hightLightChangedCells();},hightLightChangedCells:function hightLightChangedCells(){var ucs=this.cp.getUpdatedRows(),me=this,cells,r,rcells,ci,i,c,ri,doms=[];if(ucs){mstrmojo.hash.forEach(ucs,function(v,k){ri=parseInt(k,10);cells=me.cp.getRowCells(ri);r=getTableRowCells(ri,me);rcells=r.length;ci=cells.length-1;if(ci>=0){for(i=rcells-1;i>=0;i--){c=r[i];if(ci<0){break;}if(cells[i]._d){var bgColor=c.style.backgroundColor,ftColor=c.style.color;doms.push({dom:c,bgcolor:bgColor,ftcolor:ftColor});c.style.backgroundColor=$CLR.getHighlightColor($CLR.rgbStr2rgb(mstrmojo.css.getStyleValue(c,"backgroundColor"),true));c.style.color=$CLR.getContrastingColor($CLR.rgbStr2hex(mstrmojo.css.getStyleValue(c,"backgroundColor")),["#ffffff","#000000"]);delete cells[i]._d;}ci--;}}});if(doms.length>0){window.setTimeout(function(){mstrmojo.array.forEach(doms,function(domCell){domCell.dom.style.backgroundColor=domCell.bgcolor;domCell.dom.style.color=domCell.ftcolor;});},300);}}},getRowInfoByPosition:function(y){return this.cp.getRowCellInfo(y);},postRenderingCleanup:function _postRenderingCleanup(){var p=this.parent;if(p&&this.connectedScrollbox){p.disconnectScrollbox(this);}this.connectedScrollbox=false;if(p&&!p.scrollboxHeightFixed){var c=findContainerByMethodName(p,"performCanGrowCanShrink");if(c){c.performCanGrowCanShrink([p],true);}}},unrender:function unrender(ignoreDom){renderingCleanUp.call(this);if(this.connectedScrollbox){this.parent.disconnectScrollbox(this);this.connectedScrollbox=false;}this.numPagesRendered=0;this.lastWidth=0;this.isDownloading=false;this._super(ignoreDom);},dataDownloaded:function dataDownloaded(){this.isDownloading=false;this.initPageStatus();this.onscroll();}});})();