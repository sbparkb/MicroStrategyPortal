(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.HBox","mstrmojo.VBox","mstrmojo.RadioList","mstrmojo.TextBox","mstrmojo.Button","mstrmojo.Refine.RefineConstants","mstrmojo.Refine.RefineHelpers","mstrmojo.ui.Pulldown");mstrmojo.requiresDescs(13574,134,3434,1013,2052,14533);var constants=mstrmojo.Refine.RefineConstants,RefineHelpers=mstrmojo.Refine.RefineHelpers;function escapeSpecial(str){str=str.replace(/\n/g,"\\n");str=str.replace(/\t/g,"\\t");return str;}function replaceDollar(str){return str.replace(/\$/g,"$$$$").replace(/[\\"']/g,"\\$&");}function applyOperations(){var operations=[],operation,transformation,columns,index,columnName,transformationList,idx,cellIndex;transformation=this.parent;columns=transformation.columns;index=columns.selectedIndex;cellIndex=columns.items[columns.selectedIndex].cellIndex;if(index===undefined){return ;}columnName=(columns.items[index]).name;transformationList=transformation.transformationList;idx=transformationList.subType%10;switch(idx){case 0:operation=JSON.parse(JSON.stringify(this.operations.titlecase));break;case 1:operation=JSON.parse(JSON.stringify(this.operations.uppercase));break;case 2:operation=JSON.parse(JSON.stringify(this.operations.lowercase));break;case 3:operation=JSON.parse(JSON.stringify(this.operations.unescape));break;case 4:switch(this.optionsBox.datatype.type.selectedIndex){case 0:operation=JSON.parse(JSON.stringify(this.operations.number));break;case 1:operation=JSON.parse(JSON.stringify(this.operations.text));var cell=this.parentBox.controller.model.data.rows[0].cells[cellIndex];if(cell.t){if(cell.v.indexOf("T")!==-1){operation.expression="toString(value, 'yyyy-MM-dd HH:mm:ss')";}else{operation.expression="toString(value, 'yyyy-MM-dd')";}}break;case 2:if(!this.optionsBox.datatype.format.value){mstrmojo.alert(mstrmojo.desc(13574,"Please fill out all fields before apply."));return ;}operation=JSON.parse(JSON.stringify(this.operations.date));operation.description=operation.description.replace("[format]","'"+this.optionsBox.datatype.format.value+"'");operation.expression=operation.expression.replace("[format]","'"+this.optionsBox.datatype.format.value+"'");break;}break;case 5:operation=JSON.parse(JSON.stringify(this.operations.fillDown));break;case 6:operation=JSON.parse(JSON.stringify(this.operations.blankDown));break;case 7:operation=JSON.parse(JSON.stringify(this.operations.padBefore));operation.description=operation.description.replace("[string]","'"+escapeSpecial(replaceDollar(this.optionsBox.padString.value))+"'");operation.expression=operation.expression.replace("[string]","'"+replaceDollar(this.optionsBox.padString.value)+"'");break;case 8:operation=JSON.parse(JSON.stringify(this.operations.padAfter));operation.description=operation.description.replace("[string]","'"+escapeSpecial(replaceDollar(this.optionsBox.padString.value))+"'");operation.expression=operation.expression.replace("[string]","'"+replaceDollar(this.optionsBox.padString.value)+"'");break;}operation.columnName=columnName;operation.description=operation.description.replace("[column name]",columnName);operation.engineConfig=JSON.parse(this.controller.model.engine);operations.push(operation);this.controller.applyOperations({operations:JSON.stringify(operations),engine:JSON.stringify({facets:[],mode:"row-based"})});this.optionsBox.datatype.format.set("value","");this.optionsBox.padString.set("value","");}mstrmojo.Refine.RefineControlTransformCell=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.Refine.RefineControlTransformCell",markupString:'<div id="{@id}" class="refine-controls"><div></div></div>',markupSlots:{optionsNode:function(){return this.domNode.children[0];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";},onsubTypeChange:function(){if(this.subType===10||this.subType===11||this.subType===12||this.subType===13||this.subType===15||this.subType===16){this.optionsBox.apply.onclick();}}},operations:null,bindings:{visible:function(){return(this.parentBox.transformationList.type===constants.transformationType.TransformCell);},subType:function(){return((this.parentBox.transformationList.type===constants.transformationType.TransformCell)?this.parentBox.transformationList.subType:-1);}},children:[{scriptClass:"mstrmojo.HBox",slot:"optionsNode",alias:"optionsBox",children:[{scriptClass:"mstrmojo.HBox",alias:"datatype",children:[{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"refine-pulldown",alias:"type",items:[{n:mstrmojo.desc(3434,"Number")},{n:mstrmojo.desc(1013,"Text")},{n:mstrmojo.desc(2052,"Date")}],selectedIndex:0},{scriptClass:"mstrmojo.TextBox",alias:"format",visible:false,cssClass:"Date",emptyText:mstrmojo.desc(14533,"Input Date Format"),bindings:{visible:function(){return(this.parent.type.selectedIndex===2);}}},{scriptClass:"mstrmojo.Button",iconClass:"mstrmojo-refine-help",title:mstrmojo.desc(1143,"Help"),onclick:function(){var helpTopic="data_wrangle_date_time.htm";mstrApp.showHelpTopic(helpTopic);},bindings:{visible:function(){return(this.parent.type.selectedIndex===2);}}}],bindings:{visible:function(){return(this.parent.parent.parentBox.transformationList.subType%10===4);}}},{scriptClass:"mstrmojo.TextBox",alias:"padString",bindings:{visible:function(){return(this.parent.parent.parentBox.transformationList.subType%10===7||this.parent.parent.parentBox.transformationList.subType%10===8);}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton hot",text:mstrmojo.desc(134,"Apply"),alias:"apply",onclick:function(){var control=this.parent.parent,model=control.controller.model,subType=control.subType,subTypeEnum=constants.transformationSubType;if((subType===subTypeEnum.FillDown||subType===subTypeEnum.BlankDown)&&model.hasAddSample()){RefineHelpers.confirmFilldownOrBlankdown(function(){applyOperations.call(control);});}else{applyOperations.call(control);}},bindings:{visible:function(){return(this.parent.parent.parentBox.transformationList.subType%10===4||this.parent.parent.parentBox.transformationList.subType%10===7||this.parent.parent.parentBox.transformationList.subType%10===8);}}}]}]});}());