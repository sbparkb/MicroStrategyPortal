(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.array","mstrmojo.hash","mstrmojo.StringBuffer");var $DOM=mstrmojo.dom,$HASH=mstrmojo.hash,$ARR=mstrmojo.array;function destroyInfoWindows(){$HASH.forEach(this.ifwMap,function(infoWindow){infoWindow.destroy();});this.ifwMap={};}function recordInfoWins(){var ifwrds=[],sellyt=null,docScroll=null;$HASH.forEach(this.ifwMap,function(ifw){if(ifw.visible){ifwrds.push({psId:ifw.psId,psKey:ifw.psKey,autoCloseLocks:ifw.autoCloseLocks,lockInfoWinId:ifw.lockIW?ifw.lockIW.id:false,anchorPos:ifw.anchorPosition||$DOM.position(ifw.anchor,true),anchorOrn:ifw.anchorOrientation});}});if(ifwrds.length>0){sellyt=this.getSelectedLayoutWidget();docScroll=sellyt&&sellyt.getScrollPos();}return{ifwRecords:ifwrds,docScrollRecord:docScroll};}function restoreInfoWins(rd){var ifwrds=(rd&&rd.ifwRecords)||[],docScroll=rd&&rd.docScrollRecord,sellyt=this.getSelectedLayoutWidget(),me=this,fakeAnchor={};if(ifwrds.length>0){if(docScroll&&sellyt){sellyt.scrollTo(docScroll);}$ARR.forEach(ifwrds,function(rd){if(rd.lockInfoWinId){fakeAnchor.lockInfoWinId=rd.lockInfoWinId;}me.showInfoWindow(rd.psId,rd.psKey,fakeAnchor,null,rd.anchorOrn,rd.anchorPos,rd.autoCloseLocks);});}}function destroyPopups(){if(mstrmojo.DICPopup&&mstrmojo.DICPopup.cancel){mstrmojo.DICPopup.cancel();}}function clearXtabStyleSheet(){$ARR.forEach(this.xtabStyleSheets,function(sheet){var parentNode=sheet.parentNode;if(parentNode){parentNode.removeChild(sheet);}});}function updateDocGroupBy(layoutKey,gbys){var layout=this.getLayout(layoutKey),docGB=layout.docGroupBy,ctrl=this.controller;if(docGB){docGB.set("data",gbys.groupbys);layout.gb=gbys;}if(ctrl.getPageByTree){ctrl.getPageByTree(true);}}mstrmojo._IsRwDocument=mstrmojo.provide("mstrmojo._IsRwDocument",{_mixinName:"mstrmojo._IsRwDocument",updateXtabStyles:function updateXtabStyles(layoutKey,newStyles){var styleSheet=this.xtabStyleSheets&&this.xtabStyleSheets[0],styleList=this.styleList||{},fnAddStyles=function(tgt,src){var srcKey;for(srcKey in src){var newCss=src[srcKey].css||"";if(src[srcKey].app){newCss=(tgt[srcKey]||"")+newCss;}tgt[srcKey]=newCss;}return tgt;},doc=document;if(!styleList[layoutKey]){styleList[layoutKey]=fnAddStyles({},this.model.getSelectedXtabStyles(layoutKey));}fnAddStyles(styleList[layoutKey],newStyles);if(!this.xtabStyleSheets){this.xtabStyleSheets=[];styleSheet=this.xtabStyleSheets[0]=doc.getElementsByTagName("head")[0].appendChild(doc.createElement("style"));}var cssBuilder=new mstrmojo.StringBuffer(),tgt,css;for(tgt in styleList){for(css in styleList[tgt]){cssBuilder.append(styleList[tgt][css]);}cssBuilder.append("\n");}var cssText=cssBuilder.toString();if(styleSheet&&cssText){styleSheet=styleSheet.styleSheet||styleSheet;if($DOM.isWK){var firstChild=styleSheet.firstChild;if(firstChild){firstChild.nodeValue=cssText;}else{styleSheet.appendChild(doc.createTextNode(cssText));}}else{if($DOM.isIE){styleSheet.cssText=cssText;var count,lastRule,selectorText,index;for(count=1;styleSheet.rules.length===4095&&doc.styleSheets.length<31;count++){lastRule=styleSheet.rules[4094];selectorText=new RegExp(lastRule.selectorText,"i");index=cssText.search(selectorText);if(index===-1){break;}index=cssText.indexOf("}",index+1);cssText=cssText.slice(index+1);if(!this.xtabStyleSheets[count]){this.xtabStyleSheets[count]=doc.getElementsByTagName("head")[0].appendChild(doc.createElement("style"));}styleSheet=this.xtabStyleSheets[count].styleSheet;styleSheet.cssText=cssText;}}else{styleSheet.innerHTML=cssText;}}}this.styleList=styleList;},postBuildRendering:function postBuildRendering(){var head=document.getElementsByTagName("head")[0];$ARR.forEach(this.xtabStyleSheets,function(sheet){head.appendChild(sheet);});return this._super();},buildChildren:function buildChildren(noAddChildren){var rtn;try{var m=this.model;if(m){var subs=this.buildSubs||{},s=m.id+"-partialUpdate",r=m.id+"-rebuildLayout",u=m.id+"-updateStyles",ifw=m.id+"-showInfoWin",id=this.id;var me=this,unloadLayoutCache=function(){$ARR.forEach(me.getLayouts(),function(l){if(l.k!==m.currlaykey){l.defn.loaded=false;}});};if(subs[s]===undefined){var fnUpdate=function updateDescendants(evt){var m=this.model,dataCache=m&&m.getLayoutDataCache(m.getCurrentLayoutKey()),ids=evt&&evt.ids;if($HASH.isEmpty(dataCache)||!ids){return ;}$ARR.forEach(evt.tree.layouts,function(l){if(l.k===m.currlaykey){this.updateXtabStyles(l.k,l.xtabStyles);if(l.gbys){updateDocGroupBy.call(this,l.k,l.gbys);}return false;}return true;},this);var $FE=$HASH.forEach,shouldNotifyScrollListeners=false,ups={update:ids.upd,refresh:ids.tgts,adjustSectionSize:ids.secs};$FE(ids.ifws,function(psId,psKey){var infoWindow=mstrmojo.all[psId+"_ifw"];if(infoWindow&&infoWindow.visible){this.updateInfoWindowPS(psId,psKey);}},this);$FE(ups,function(col,meth){$FE(col,function(v,id){var w=mstrmojo.all[id],rtn;if(w&&w[meth]!==undefined){var newNode=dataCache[id],arg=(meth==="update"?newNode:null),targetMeth=meth;if(meth==="update"){if(w.updateForPU){targetMeth="updateForPU";}else{w.node=newNode;}}else{if(meth==="refresh"&&w.refreshForPU){targetMeth="refreshForPU";}}rtn=w[targetMeth](arg);if(meth==="adjustSectionSize"&&rtn){shouldNotifyScrollListeners=shouldNotifyScrollListeners||(!!rtn.heightReduced);}}},this);},this);var selectedLayout=this.getSelectedLayoutWidget();if(shouldNotifyScrollListeners){selectedLayout.notifyScrollListeners();}var docLayout=selectedLayout.docLayout;if(docLayout){docLayout.resizeOrReposition();}if(evt&&evt.unloadCache){unloadLayoutCache();}};subs[s]=m.attachEventListener("partialUpdate",id,fnUpdate);}subs[r]=subs[r]||m.attachEventListener("rebuildLayout",id,function(evt){var restoreIW=evt&&evt.restoreIW,ifwRecords;if(restoreIW){ifwRecords=recordInfoWins.call(this);this.model.aws=null;}this.onLayoutRebuilt(this.rebuildLayout(evt.src.currlaykey,this.getLayouts()));if(evt&&evt.unloadCache){unloadLayoutCache();}if(restoreIW){restoreInfoWins.call(this,ifwRecords);}});subs[u]=subs[u]||m.attachEventListener("updateStyles",id,function(evt){this.updateXtabStyles(evt.key,evt.updatedStyles);});subs[ifw]=subs[ifw]||m.attachEventListener("showInfoWin",id,function(evt){this.showInfoWindow(evt.psId,evt.psKey,evt.anchor,evt.invalidate,evt.anchorOrientation,evt.anchorPosition);});this.updateXtabStyles(m.getCurrentLayoutKey());m.attachEventListener("refresh",this.id,function(){this.refresh();});}rtn=this._super(noAddChildren);}catch(ex){mstrmojo.err(ex);}return rtn;},updateInfoWindowPS:mstrmojo.emptyFn,showInfoWindow:function showInfoWindow(psId,psKey,anchor,invalidate,anchorOrientation,anchorPosition,autoCloseLocks){var model=this.model,dataCache=model.getLayoutDataCache(model.getCurrentLayoutKey()),builder=this.builder,ifwDefn=dataCache[psId]&&dataCache[psId].defn,infoPlacement=ifwDefn&&ifwDefn.iwpl,id=psId+"_ifw",infoWindow=mstrmojo.all[id],domNode=this.domNode,ENUM_FIXED_PLACEMENT=mstrmojo.DocInfoWindow.PLACEMENT.FIXED,updatePopupPosition=function(infoWindowObj,parentDomNode,layoutNode,left,top){if(infoPlacement===ENUM_FIXED_PLACEMENT){if(parentDomNode){var parentPosition=$DOM.delta(parentDomNode,domNode);infoWindowObj.popPosition={left:(parentPosition&&parentPosition.x)?left+parentPosition.x:left,top:(parentPosition&&parentPosition.y)?top+parentPosition.y:top};}else{if(layoutNode){infoWindowObj.popPosition={left:(layoutNode.scrollboxLeft)?left-layoutNode.scrollboxLeft:left,top:(layoutNode.scrollboxTop)?top-layoutNode.scrollboxTop:top};}else{infoWindowObj.popPosition={left:left,top:top};}}}};var layoutNode=this.getLayout(model.getCurrentLayoutKey());if(infoWindow){if(invalidate){infoWindow.refresh();}infoWindow.anchorOrientation=anchorOrientation;infoWindow.anchorPosition=anchorPosition;if(infoPlacement===ENUM_FIXED_PLACEMENT&&infoWindow._ifwpdn.style.display==="none"){infoWindow._ifwpdn=document.getElementById(infoWindow._ifwpdn.id);}updatePopupPosition(infoWindow,infoWindow._ifwpdn,layoutNode,infoWindow._ifwfl,infoWindow._ifwft);infoWindow.open(this,{anchor:anchor,boundary:domNode});}else{var cfg={opener:this,anchor:anchor,anchorOrientation:anchorOrientation,boundary:domNode,parent:this,builder:builder,model:this.model,psKey:psKey,psId:psId,id:id,autoCloses:true,locksHover:true,closeOnClick:false,autoCloseLocks:autoCloseLocks,anchorPosition:anchorPosition};if(infoPlacement){infoPlacement=parseInt(infoPlacement,10);cfg.placement=infoPlacement;if(infoPlacement===ENUM_FIXED_PLACEMENT){var formats=ifwDefn.fmts,left=cfg._ifwfl=formats&&formats.left&&parseInt(formats.left.replace("px",""),10),top=cfg._ifwft=formats&&formats.top&&parseInt(formats.top.replace("px",""),10),infoWindowParent=dataCache[psId]&&dataCache[psId].p,parentObject=infoWindowParent&&model.getUnitInstance(infoWindowParent.k,infoWindowParent.wid),parentDomNode=cfg._ifwpdn=parentObject&&parentObject.domNode;updatePopupPosition(cfg,parentDomNode,layoutNode,left,top);}}infoWindow=builder.newInfoWindow(cfg);this.renderInfoWindow(infoWindow);var infoMap=this.ifwMap=(this.ifwMap||{});infoMap[psId]=infoWindow;}},renderInfoWindow:function renderInfoWindow(infoWindow){infoWindow.render();},_lockInfoWinContainer:function lockInfoWinContainer(config){var ifwm=this.ifwMap,fnGetOnClose=function(ifw,xtab){return function(){ifw.releaseLock(xtab);};},k;for(k in ifwm){var ifw=ifwm[k],xtab=config.xtab;if(ifw&&xtab&&$DOM.contains(ifw.infoNode,xtab.domNode,true,document.body)){ifw.registerLock(xtab);config.onClose=fnGetOnClose(ifw,xtab);break;}}},unrender:function unrender(ignoreDom){destroyInfoWindows.call(this);this._super(ignoreDom);clearXtabStyleSheet.call(this);},getLayouts:function getLayouts(){return this._layouts;},getLayout:function getLayout(key){key=key||this.model.getCurrentLayoutKey();var layouts=this.getLayouts();return layouts[$ARR.find(layouts,"k",key)];},getSelectedLayoutWidget:mstrmojo.emptyFn,needLoadLayout:function needLoadLayout(layout,params){return layout.defn&&(params&&params.reload||layout.defn.loaded===false||(this.model.zt&&(window.mstrMobileApp!==undefined)&&(layout.defn.lastOrientation!==mstrMobileApp.getOrientation())));},getNewLayout:function getNewLayout(params,layouts,isSelected,callback,update){var me=this,model=me.model,key=params.layoutKey,layout=layouts[$ARR.find(layouts,"k",key)];if(this.needLoadLayout(layout,params)){var fnSuccess=callback.success;callback.success=function(res){model.replaceLayout(key,res,false);model.currlaykey=key;if(isSelected){me.selectLayout(layout,false,null,update);}var newLayout=me.rebuildLayout(key,layouts);if(me.controller.getPageByTree){me.controller.getPageByTree(true);}fnSuccess(newLayout);};this.loadDocLayout(params,callback,update);}else{if(isSelected){this.selectLayout(layout,true,{success:function(res){$HASH.copyProps(["bs"],res,model);}},update);}if(!layout.hasRendered){layout=this.rebuildLayout(key,layouts);if(me.controller.getPageByTree){me.controller.getPageByTree(true);}}callback.success(layout);}},selectLayout:function selectLayout(layout,updateServer,callback,update){var model=this.model,key=layout.k,isNewKey=(key!==model.currlaykey);model.currlaykey=key;if(this.controller){this.controller.updateZoom();}this.restoreLayoutState(layout);if(updateServer&&isNewKey){this.setCurrentDocLayout(key,callback,update);}else{if(callback&&callback.complete){callback.complete();}}return layout;},rebuildLayout:function rebuildLayout(k,layouts){var model=this.model,findLayout=$ARR.find,oldLayout=layouts[findLayout(layouts,"k",k)],nodes=model.getChildren(this.node,false);var newLayout=nodes[findLayout(nodes,"k",k)];if(window.mstrMobileApp!==undefined){newLayout.defn.lastOrientation=mstrMobileApp.getOrientation();}var c=this.replaceLayout(oldLayout,newLayout);this.updateXtabStyles(k,model.getSelectedXtabStyles(k));destroyInfoWindows.call(this);destroyPopups();return c;},destroy:function destroy(){destroyInfoWindows.call(this);if(this._super){this._super();}clearXtabStyleSheet.call(this);},replaceLayout:mstrmojo.emptyFn,restoreLayoutState:mstrmojo.emptyFn,onLayoutRebuilt:mstrmojo.emptyFn,unloadGbLayuts:function unloadGbLayuts(groupbyKey){var layouts=this.getLayouts(),curLayoutKey=this.model.getCurrentLayoutKey(),layout,i,gb,groupbys,k,gbDssId;layout=this.getLayout();groupbys=layout.gb&&layout.gb.groupbys;for(k=0;k<groupbys.length;k++){gb=groupbys[k];if(gb.k===groupbyKey){gbDssId=gb.unit.target.did;break;}}for(i=0;i<layouts.length;i++){layout=layouts[i];if(layout.k===curLayoutKey){continue;}groupbys=layout.gb&&layout.gb.groupbys;if(groupbys&&groupbys.length){for(k=0;k<groupbys.length;k++){gb=groupbys[k];if(gb.unit.target.did===gbDssId){layout.defn.loaded=false;break;}}}}},loadDocLayout:function loadDocLayout(params,callback,update){this.model.getDataService().loadDocLayout(params,callback,update);},setCurrentDocLayout:function setCurrentDocLayout(key,callback,update){this.model.getDataService().setCurrentDocLayout(key,callback,update);}});}());