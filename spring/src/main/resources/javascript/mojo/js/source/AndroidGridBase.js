(function(){var AUTO_TR="<tr>";var TBL_MKP_START=['<table cellspacing="0" cellpadding="0" style="table-layout:',null,";width:",null,';mstr-tablestyle-slot" ',null,">",null,"<tbody>"];var NBSP="&nbsp;";var STITCH_TOP_CSS="fsbp_1 ";var STITCH_MIDDLE_CSS="fsbp_2 ";var STITCH_BOTTOM_CSS="fsbp_3 ";var STACK_TOP=1,STACK_MIDDLE=2,STACK_BOTTOM=3,STACK_BOTTOM_LAST=4,NO_STACK=5,FULL_STACK=6,STACK_CSS={1:" stack-top",2:" stack-middle",3:" stack-bottom",4:" stack-bottom-last",5:" no-stack",6:" stack-full"},TOP_PADDING_STACKED=1,BOTTOM_PADDING_STACKED=2,HALF_INNER_PADDING_STACKED=3,TOP_PADDING_NO_STACK=4,BOTTOM_PADDING_NO_STACK=5;var $CSS=mstrmojo.css;var BASEFORM_PICTURE=4;function stitchBottomCells(cells,tbody){for(var i=0,iLen=cells.length;i<iLen;i++){var c=cells[i];var d=tbody.rows[c.rows].cells[c.cells];if(d){mstrmojo.css.addClass(d,STITCH_TOP_CSS);}}}function resolveImagePath(value){var startIndex=value.indexOf('src="');if(startIndex<0){return value;}var str=value.substring(startIndex+5),endIndex=str.indexOf('"'),imgUrl;str=str.substring(0,endIndex);imgUrl=str;var ds=this.parent&&this.parent.controller&&this.parent.controller.model&&this.parent.controller.model.dataService;if(ds&&ds.getImage){imgUrl=ds.getImage(str);}return value.replace(str,imgUrl);}mstrmojo.requiresCls("mstrmojo.Widget");mstrmojo.AndroidGridBase=mstrmojo.declare(mstrmojo.Widget,null,{scriptClass:"mstrmojo.AndroidGridBase",markupString:'<span id="{@id}" class="mstrmojo-Grid {@cssClass}" style="{@cssText}"></span>',markupSlots:{gridContainerNode:function(){return this.domNode;}},autoFitWindow:false,tableLayout:null,numAutoHeightRows:0,cp:null,rc:0,cc:0,cws:null,rh:null,totalColWidth:0,start:0,end:0,forceFixedSizes:true,hiliteCellsMap:null,eiMap:null,init:function init_Grid(props){this._super(props);},numColumnCanMerge:0,preBuildRendering:function preBuildRendering(res){var cp=this.cp;if(!cp){return ;}cp.initContent();this.rc=cp.rc||0;this.cws=cp.colWidths||[];this.cc=this.cws.length;this.tdWidths=cp.tdWidths||[];this.tdCnt=this.tdWidths?this.tdWidths.length:0;this.start=0;this.end=this.rc-1;this.numAutoHeightRows=cp.getNumAutoHeightRows&&cp.getNumAutoHeightRows()||0;this.hiliteCellsMap={};this.eiMap={};this.posMap=[];this.thPosMap=[];this.totalColWidth=0;},buildRendering:function buildRendering(res){var ret=this._super(res);this.renderGrid();return ret;},renderGrid:function renderGrid(append){var containerNode=this.getGridContainer();this.preBuildGridTable();this.buildGridTable(containerNode,append);this.postBuildGridTable();},getGridContainer:function getGridContainer(){return this.gridContainerNode;},buildGridTable:function buildGridTable(gridContainer,append){var tms=this.getTableStartMarkup();var tme=this.getTableEndMarkup();if(append){this.mergeHdrsAcrossBlks=true;}var tInnerHTML=this.buildTableRowsMarkup(this.start,this.end,tms,tme).join("");if(append){var creationContainer=document.createElement("div");creationContainer.innerHTML=tInnerHTML;var cn=gridContainer.firstChild,tBodies=cn&&cn.tBodies,ntBody=creationContainer.firstChild.tBodies[0],mh=this.matchedHdrsAcrossBlks;cn.appendChild(ntBody);if(mh&&mh.length>0){stitchBottomCells(mh,tBodies[tBodies.length-2]);}}else{gridContainer.innerHTML=tInnerHTML;}},getTableStartMarkup:function _bldTableSMkp(){var gw=this._getGridWidths(),mkp=TBL_MKP_START;mkp[1]=gw.tableLayout;mkp[3]=gw.totalColWidths;mkp[5]=this.tableCssClass?"class="+this.tableCssClass:"";mkp[7]="<colgroup>"+gw.colgroup+"</colgroup>";if(this.tbodyStyle){mkp[8]='<tbody style="'+this.tbodyStyle+'">';}return mkp.join("");},getTableEndMarkup:function _bldTableEMkp(){return"</tbody></table>";},_getGridWidths:function _initGridWidths(){var gw={};var totalColWidths="",colgroup=[],tl="fixed",cws=this.cws,cols=cws.length;if(cols){totalColWidths=0;colgroup=[];for(var i=0;i<cols;i++){if(cws[i].w!==""){totalColWidths+=parseInt(cws[i].w,10);}}for(i=0;i<cols;i++){var width=cws[i];if(width.w!==""){var w=parseInt(width.w,10);if(mstrmojo.dom.isIE7){if(w===0){colgroup.push('<col style="width:0%;display:none"></col>');}else{colgroup.push('<col style="width:'+(w/totalColWidths*100)+'%"></col>');}}else{if(mstrmojo.dom.isWK&&w===0){colgroup.push('<col style="width:-1px"></col>');}else{colgroup.push('<col style="width:'+width.w+'"></col>');}}}else{colgroup.push("<col />");tl="auto";}}this.totalColWidth=totalColWidths;}gw.colgroup=colgroup.join("");tl=this.tableLayout||tl;if(this.autoFitWindow){tl=this.tableLayout||tl||"fixed";totalColWidths="100%";}else{if(tl=="fixed"){totalColWidths+="px";}else{totalColWidths="auto";}}gw.totalColWidths=totalColWidths;gw.tableLayout=tl;return gw;},_CELL_MARKUP:['<td rowSpan="',null,'" colSpan="',null,'" class="',null,'" ei="',null,'" style="',null,'" r="',null,'">',null,"</td>"],buildTableRowsMarkup:function _buildRowsMarkup(start,end,markupPrefix,markupSuffix){var markup=[],i=0;markup[i++]=markupPrefix||"<table><tbody>";var cp=this.cp,rh=cp.getRowHeight(),TD=this._CELL_MARKUP,TR=rh?'<tr style="height:'+(rh?rh+"px":"")+'">':AUTO_TR;var firstRow=true,lastMatched=true,nlr=[],rhi;this.matchedHdrsAcrossBlks=[];for(var r=start;r<=end;r++){rhi=i++;markup[rhi]=r<this.numAutoHeightRows?AUTO_TR:TR;var cells=cp.getRowCells(r);var maxRowspan=end+1-r;var umCellsLen=0;if(!this.mergeHdrsAcrossBlks){if(firstRow&&start>0&&cells.length<cp.colWidths.length){var umCells=cp.getUnmergedCells(start);if(umCells){umCellsLen=umCells.length;}for(var j in umCells){var p=umCells[j];if(p.rs>maxRowspan){TD[1]=maxRowspan;TD[5]=STITCH_MIDDLE_CSS+p.css;}else{TD[1]=p.rs||1;TD[5]=STITCH_BOTTOM_CSS+p.css;}if(p.cet){TD[5]+=" mstrmojo-selected-cell";this.addHilitePosition(p.cet,r,j);}if(p._ei){this.addExtraInfoMap(p._ei,r,j);TD[5]+=" pt";}TD[9]="";TD[13]=NBSP;TD[3]=p.cs;TD[7]=p._ei!==undefined?p._ei:"";markup[i++]=TD.join("");}firstRow=false;}}for(var c=0,len=cells.length;c<len;c++){var cell=cells[c],rt;if(cell.rs&&cell.rs>maxRowspan){TD[1]=maxRowspan;TD[5]=STITCH_TOP_CSS+cell.css;if(cell._ei){this.addExtraInfoMap(cell._ei,r,c);}}else{TD[1]=cell.rs||1;TD[5]=cell.css;}if(cell.rowType!==STACK_TOP){TD[5]+=" xtab-td ";}if(cell.cet){TD[5]+="sc_"+this.parent.k;this.addHilitePosition(cell.cet,r,c);}rt=cell.rowType;if(rt){TD[5]+=STACK_CSS[rt]||"";var srh=cp.getRowHeight(rt);if(srh){markup[rhi]='<tr style="height:'+(srh?srh+"px":"")+'">';}}TD[3]=cell.cs||1;TD[7]=cell._ei!==undefined?cell._ei:"";if(cell.fs||cell._e){this.addTitleHeaderPositionMap(r,c+umCellsLen,cell);}if(cell._ei!=null){this.addPositionMap(cell._ei,r,c+umCellsLen);}TD[11]=r;if(cell.ts===BASEFORM_PICTURE){var imgUrl=cell.v;if(this.imgCacheMap){var m=this.imgCacheMap,v=imgUrl&&imgUrl.replace(/\\/g,"/");if(m.cachedImg[v]){cell.v=imgUrl=m.baseURL+m.cachedImg[v];}else{if(v&&!m.unCachedImg[v]){m.unCachedImg[v]=v;}}}else{var ds=this.parent&&this.parent.controller&&this.parent.controller.model&&this.parent.controller.model.dataService;if(ds&&ds.getImage){imgUrl=ds.getImage(imgUrl);}}if(cell.rowType){var height=(cp.getRowHeight(cell.rowType)||cp.rh||rh),fsHeight=height,cws=this.tdWidths,colIdx=cell.colIdx,colWidth=0,maxHeight=0;var topPadding=cp.getPadding(TOP_PADDING_STACKED),bottomPadding=cp.getPadding(BOTTOM_PADDING_STACKED),halfInnerPadding=cp.getPadding(HALF_INNER_PADDING_STACKED);if(cell.rowType===STACK_TOP||cell.rowType===STACK_BOTTOM_LAST){maxHeight=height>(topPadding+halfInnerPadding)?(height-topPadding-halfInnerPadding):0;}else{if(cell.rowType===STACK_MIDDLE||cell.rowType===STACK_BOTTOM){maxHeight=height>2*halfInnerPadding?(height-2*halfInnerPadding):0;}else{if(cell.rowType===NO_STACK){maxHeight=height>(halfInnerPadding*2)?(height-halfInnerPadding*2):0;}}}if(colIdx!=="undefined"&&colIdx>-1&&cws&&cws.length>colIdx){var cw=cws[colIdx]&&cws[colIdx].w;if(cw!=="undefined"){colWidth=parseInt(cw,10);}}var maxWidth=colWidth>30?(colWidth-30):0;TD[13]='<div><div style="top:'+(-parseInt(fsHeight/2,10))+"px;height:"+(height-1)+"px;line-height:"+(height-1)+'px !important;">&nbsp;<img style="max-height:'+maxHeight+"px; max-width: "+maxWidth+'px;" src="'+imgUrl+'"></img></div></div>';}else{if(this.parent.gridData.lhv){TD[9]="background-image:url('"+imgUrl+"');background-repeat:no-repeat;background-position:center "+(cell.rs>1?"top":"center")+";";TD[13]=NBSP;}else{TD[9]="";TD[13]='<img src="'+imgUrl+'"></img>';if(cell.css&&cell.css.indexOf("hl")>-1){TD[13]="<span>"+TD[13]+"</span>";}}}}else{TD[9]="";if(mstrApp.useBinaryFormat&&cell.v&&cell.v.indexOf("img")>=0){cell.v=resolveImagePath.call(this,cell.v);}TD[13]=cell.v||cell.n||NBSP;if(cell.css&&cell.css.indexOf("hl")>-1){TD[13]="<span>"+TD[13]+"</span>";}}if(c<this.numColumnCanMerge){if(r===start&&this.mergeHdrsAcrossBlks){var lr=this.rowHdsAcrossBlks;if(lastMatched&&cell.v&&lr&&lr[c]){if(cell.v===lr[c].v){TD[1]=cell.rs||1;TD[5]=STITCH_BOTTOM_CSS+cell.css;TD[13]="";this.matchedHdrsAcrossBlks.push(lr[c]);}else{lastMatched=false;}}}if(TD[1]>=maxRowspan&&cell.v){nlr.push({rows:r-start,cells:c,v:cell.v});}}markup[i++]=TD.join("");}markup[i++]="</tr>";}markup[i++]=markupSuffix||"</tbody></table>";this.rowHdsAcrossBlks=nlr;return markup;},addHilitePosition:function(key,row,cell){var hm=this.hiliteCellsMap[key];if(!hm){this.hiliteCellsMap[key]={pos:[],nodes:[]};}this.hiliteCellsMap[key].pos.push({row:row,cell:cell,page:0});},addExtraInfoMap:function(ei,r,c){if(!this.eiMap[ei]){this.eiMap[ei]=[];}this.eiMap[ei].push({row:r,cell:c,page:0});},addPositionMap:function(ei,r,c){if(!this.posMap[ei]){this.posMap[ei]={row:r,cell:c,page:0};}},addTitleHeaderPositionMap:function(r,c,o){this.thPosMap.push({row:r,cell:c,page:0,obj:o});},clearHilites:function(key){var hc=this.hiliteCellsMap[key],ns=hc&&hc.nodes,parent=this.parent;if(ns){if(ns.length==0&&hc.pos){ns=this.getNodesByPositions(hc.pos);}for(var i=0,iLen=ns.length;i<iLen;i++){var nd=ns[i],cn=nd.className,cell=parent.getCellForNode(nd);if(cell){delete cell.cet;}$CSS.removeClass(nd,"sc_"+parent.k);}this.hiliteCellsMap[key].nodes=[];}},setHilites:function(key,node){$CSS.addClass(node,"sc_"+this.parent.k);if(!this.hiliteCellsMap[key]){this.hiliteCellsMap[key]={pos:[],nodes:[]};}this.hiliteCellsMap[key].nodes.push(node);var cell=this.parent.getCellForNode(node);if(cell){cell.cet=key;}},getNodesByPositions:function(pos){var tbl=this.tableNode,arr=[];for(var i in pos){var v=pos[i];arr.push(tbl.tBodies[0].rows[v.row].cells[v.cell]);}return arr;},preBuildGridTable:function preBuildGridTable(){},postBuildGridTable:function postBuildGridTable(){this.addSlots({tableNode:this.gridContainerNode&&this.gridContainerNode.firstChild});}});})();