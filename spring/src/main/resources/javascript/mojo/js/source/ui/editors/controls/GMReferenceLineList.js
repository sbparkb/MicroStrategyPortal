(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.ListBase","mstrmojo._IsList","mstrmojo.ui._HasScroller","mstrmojo.ui.menus.MenuConfig","mstrmojo.ui.menus.EditorConfig","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.gm.GMEnums");var $WIDGET=mstrmojo.Widget,$CSS=mstrmojo.css,$ARR=mstrmojo.array,$NUM=mstrmojo.num,$HASH=mstrmojo.hash,$DTP=mstrmojo.expr.DTP,$REF_LINE_TYPES=mstrmojo.gm.EnumRefLineModelType,$ENUM_XML_TAG=mstrmojo.gm.WidgetPropertyTag;var itemMarkup;var TYPE_DESCS=["Reserved",mstrmojo.desc(2125,"Maximum"),mstrmojo.desc(2127,"Minimum"),mstrmojo.desc(2122,"Average"),mstrmojo.desc(2126,"Median"),mstrmojo.desc(4046,"First"),mstrmojo.desc(4049,"Last"),mstrmojo.desc(7194,"Constant")];function mouseOverItem(evt,item,isOut){var pos=mstrmojo.dom.position(item),left=pos.x,right=pos.x+pos.w,top=pos.y,bottom=pos.y+pos.h,ex=evt.pageX,ey=evt.pageY;if(isOut){left+=1;right-=1;top+=1;bottom-=1;}return ex>=left&&ex<=right&&ey>=top&&ey<=bottom;}mstrmojo.ui.editors.controls.GMReferenceLineItemContainer=mstrmojo.declare(mstrmojo.ListBase,[mstrmojo._IsList,mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.ui.editors.controls.GMReferenceLineItemContainer",cssClass:"GMReferenceLineItemContainer",icnCss:"GMReferenceLineItemContainer-container",setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.itemsContainerNode;},getItemMarkup:function getItemMarkup(item){if(!itemMarkup){itemMarkup=this._super(item).replace(">{@en@n}<",'><span class="txt" title="{@en@n}">{@en@n}</span><span class="rmv hidden" rmv></span><');}return itemMarkup;},onclick:function onclick(evt){try{var target=evt.getTarget(),item=this.getItemFromTarget(target);if(item){evt.cancel();if(target.hasAttribute("rmv")){this.doItemRemove(item);}else{this.doItemSelect(item,evt||{});}}}catch(ex){mstrApp.onerror(ex);}},onmouseover:function onmouseover(evt){try{var target=evt.getTarget(),name=target.className;if(name==="txt"||name==="rmv"){target=target.parentNode;}if(mouseOverItem(evt.e,target,false)){$CSS.removeClass(target.children[1],"hidden");}}catch(ex){mstrApp.onerror(ex);}},onmouseout:function onmouseout(evt){try{var target=evt.getTarget(),name=target.className;if(name==="txt"||name==="rmv"){target=target.parentNode;}if(!mouseOverItem(evt.e,target,true)){$CSS.addClass(target.children[1],"hidden");}}catch(ex){mstrApp.onerror(ex);}},doItemRemove:function doItemDelete(toRemove){var newItems=this.items.slice();$ARR.removeItem(newItems,toRemove);this.set("items",newItems);this.onremoveItem(toRemove);},onremoveItem:function onremoveItem(removed){}});function getRefLineCapsuleContainerCfg(){return{scriptClass:"mstrmojo.ui.editors.controls.GMReferenceLineItemContainer",items:[],alias:"refLnList",getItemDisplayName:function(item){var dn=TYPE_DESCS[item.refType]||"";if(item.refType===$REF_LINE_TYPES.CONST){if(!!item.lin){dn=item.lin;}else{if(item.c!==undefined){dn+=(" "+$NUM.toLocaleString(item.c));}}}return dn;},postselectionChange:function(){this.parent.onselectRefLine(this.selectedItem);},ondblclick:function(evt){var me=this,dom=evt.getTarget(),refLine=me.selectedItem;if(refLine.refType===$REF_LINE_TYPES.CONST){dom.contentEditable=true;dom.onkeydown=function(e){if(e.keyCode===13){this.contentEditable=false;if(this.title!==this.textContent){this.title=this.textContent;refLine[$ENUM_XML_TAG.REF_LINE_NAME]=this.title;me.parent.onrenameRefLine(refLine);}return false;}};dom.onblur=function(e){if(this.contentEditable&&this.title!==this.textContent){this.contentEditable=false;this.title=this.textContent;refLine[$ENUM_XML_TAG.REF_LINE_NAME]=this.title;me.parent.onrenameRefLine(refLine);}};}},onremoveItem:function(removed){this.parent.onremoveRefLine(removed);}};}function openRefLinePicker(){function canAdd(refType){var existing=this.refLnList.items;return(this.restrictedTypes||[]).indexOf(refType)===-1&&(refType===$REF_LINE_TYPES.CONST||$ARR.find(existing,"refType",refType)===-1);}function addNewRefLine(refType,constaVal){var toAdd=this.generateNewRefLineItem(refType,constaVal);this.refLnList.addItems(toAdd);this.onaddRefLine(toAdd);}var MENU_CSS_CLS="propEditor-Menu",theme=mstrApp.getThemeClassName(),me=this,menuCfg=new mstrmojo.ui.menus.MenuConfig({menuCssClass:MENU_CSS_CLS,hostId:me.id,hostElement:me.containerNode,isHostedWithin:false});var allTypes=$HASH.valarray($REF_LINE_TYPES);(allTypes.slice(0,-1)).forEach(function(ty){if(!canAdd.call(me,ty)){return ;}menuCfg.addMenuItem(TYPE_DESCS[ty],"",function(){if(me.manager&&me.manager.host){me.manager.host.checkCustomScaleNotificationForReferenceLine(me.metricOpt.key);}addNewRefLine.call(me,ty);});});menuCfg.addPopupMenuItem(TYPE_DESCS[7],me.id,function(){return new mstrmojo.ui.menus.EditorConfig({cssClass:MENU_CSS_CLS+" "+theme,data:{constantValid:false},contents:[{scriptClass:"mstrmojo.ValidationTextBox",alias:"constVal",cssClass:"reference-line-constant",dtp:$DTP.FLOAT,required:true,valueChangeDelay:1000,constraints:{trigger:mstrmojo.validation.TRIGGER.NONE},onEnter:function(){this.blur();},onvalueChange:function(){this.validate();},onValid:function(){this.parent.data.set("constantValid",true);},onInvalid:function(){this.parent.data.set("constantValid",false);}}],bindings:{okEnabled:"this.data.constantValid"},fnOk:function(data,editor){var txtWgt=editor.constVal;if(txtWgt.isValid()){if(me.manager&&me.manager.host){me.manager.host.checkCustomScaleNotificationForReferenceLine(me.metricOpt.key);}addNewRefLine.call(me,$REF_LINE_TYPES.CONST,txtWgt.value);}}});},"",me);me.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:menuCfg,themeClassName:theme}));}function getAddBtnCfg(){return{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(531,"Add"),alias:"addBtn",cssClass:"link-btn",onclick:function(){openRefLinePicker.call(this.parent);}};}mstrmojo.ui.editors.controls.GMReferenceLineList=mstrmojo.declare(mstrmojo.Container,[mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.ui.editors.controls.GMReferenceLineList",markupString:'<div id="{@id}" class="mstrmojo-ui-GMReferenceLineList {@cssClass}" style="{@cssText}"></div>',markupSlots:{containerNode:function(){return this.domNode;}},markupMethods:{onvisibleChange:$WIDGET.visibleMarkupMethod,onenabledChange:mstrmojo.Container.enabledMarkupMethod,onheightChange:$WIDGET.heightMarkupMethod,onwidthChange:$WIDGET.widthMarkupMethod},restrictedTypes:undefined,items:undefined,shouldPropagateEnabled:true,children:[getRefLineCapsuleContainerCfg(),getAddBtnCfg()],init:function init(props){this._super($HASH.copy(props,{items:[],restrictedTypes:[]}));this.onitemsChange();},onitemsChange:function onitemsChange(){this.refLnList.set("items",this.items);},generateNewRefLineItem:function generateNewRefLineItem(refType,constVal){},getSelectedItem:function getSelectedItem(){return this.refLnList.selectedItem;},selectItemByField:function selectItemByField(fieldName,fieldValue){this.refLnList.singleSelect($ARR.find(this.refLnList.items,fieldName,fieldValue));},onselectRefLine:function onselectRefLine(refLine){},onaddRefLine:function onaddRefLine(refLine){},onremoveRefLine:function onremoveRefLine(refLine){},onrenameRefLine:function onrenameRefLine(refline){}});mstrmojo.ui.editors.controls.GMReferenceLineList.ItemType=null;}());