(function(){mstrmojo.requiresCls("mstrmojo.ListBox");mstrmojo.MultiColumnListBox=mstrmojo.declare(mstrmojo.ListBox,null,{scriptClass:"mstrmojo.MultiColumnListBox",cssClass:"",tableCssClass:"mstrmojo-MultiColumnListBox-table",cellCssClass:"",cssText:"",width:"200px",height:"200px",autoColWidth:true,minColWidth:10,tableWidth:"100%",colCount:0,colGroups:null,colWidths:null,sortIndex:null,sortDirection:true,titleIcon:"",titleText:"",titleCssText:"",showEmptyTitlebar:false,banding:true,hideEmptyIconNode:true,cp:null,columns:null,items:null,sortable:true,resizable:true,_markupPrefix:function(){var ir=this.itemRenderer;return(ir&&ir.markupPrefix)||('<table class="'+this.tableCssClass+'" style="'+this.tableCssText+'" cellspacing="0" cellpadding="0"><tbody>');},_markupSuffix:function(){var ir=this.itemRenderer;return(ir&&ir.markupSuffix)||"</tbody></table>";},_itemGroupPrefix:function(idx){var ir=this.itemRenderer,s=this.rowCssText?'style="'+this.rowCssText+'"':"",c=this.rowCssClass+(idx%2===1?" even":"");c=c?'class="'+c+'"':"";return(ir&&ir.itemGroupPrefix)||("<tr "+c+s+">");},_itemGroupSuffix:function(){var ir=this.itemRenderer;return(ir&&ir.itemGroupSuffix)||"</tr>";},_itemPrefix:function(){var ir=this.itemRenderer,c=this.cellCssClass?'class="'+this.cellCssClass+'"':"",s=this.cellCssText?'style="'+this.cellCssText+'"':"";return(ir&&ir.itemPrefix)||("<td "+c+" "+s+">");},_itemSuffix:function(){var ir=this.itemRenderer;return(ir&&ir.itemSuffix)||"</td>";},_getItemNode:function(idx){var t=this.itemsNode,rs=t&&t.rows,r=rs&&rs[idx/rs.length-1];return r&&r.cells[idx%rs.length-1].firstChild;},itemRenderer:{icon:function(item,idx,widget){if(widget.hideEmptyIconNode){item.icon=item.icon||"none";}return'<div><div class="mstrmojo-MultiColumnListBox-icon '+item.icon+'" title="'+item.v+'"/></div>';},text:function(item,idx,widget){return'<div class="mstrmojo-MultiColumnListBox-text" edt="1">'+item.v+"</div>";},icon_text:function(item,idx,widget){if(widget.hideEmptyIconNode){item.icon=item.icon||"none";}return'<div class="mstrmojo-MultiColumnListBox-iconText"><span class="mstrmojo-MultiColumnListBox-icon '+item.icon+'" title="'+mstrmojo.string.encodeHtmlString(item.v)+'" ></span><span edt="1">'+mstrmojo.string.encodeHtmlString(item.v)+"</span></div>";},checkbox:function(item,idx,widget){return'<div><input class="mstrmojo-MultiColumnListBox-checkbox" type="checkbox"  '+item.v+"/></div>";},link:function(item,idx,widget){return'<div class="mstrmojo-MultiColumnListBox-link"><a target="'+item.target+'" href="'+item.url+'" class="mstrmojo-MultiColumnListBox-link"><span>'+item.v+"</span></a></div>";},rowHeight:20},markupString:'<div id="{@id}" class="mstrmojo-MultiColumnListBox {@cssClass}" style="{@cssText}; xxwidth:{@width}; left:{@left}; top:{@top};"><div class="mstrmojo-MultiColumnListBox-titlebar" style="width:{@width}; {@titleCssText};"><span class="mstrmojo-MultiColumnListBox-icon {@titleIcon}"></span><span class="mstrmojo-MultiColumnListBox-title">{@titleText}</span></div><div id="{@id}-MultiColumnListBox-container" class="mstrmojo-MultiColumnListBox-container" style="width:{@width};"><div id="{@id}-headersScrollBox" class="mstrmojo-MultiColumnListBox-headersScrollBox" style="xxwidth:{@width};"><div id="{@id}-headersContainer" class="mstrmojo-MultiColumnListBox-headersContainer" style="xxwidth:{@width};" onclick="mstrmojo.all[\'{@id}\'].captureDomEvent(\'sort\', self, arguments[0]);" onmousedown="mstrmojo.all[\'{@id}\'].captureDomEvent(\'mousedown\', self, arguments[0]);" >{@headersHtml}</div></div><div id="{@id}-itemsScrollBox" class="mstrmojo-MultiColumnListBox-itemsScrollBox" style="max-height:{@height}; xxwidth:{@width};" ><div id="{@id}-itemsContainer" class="mstrmojo-MultiColumnListBox-itemsContainer" style="xxwidth:{@width};" onclick="mstrmojo.all[\'{@id}\'].captureDomEvent(\'edit\', self, arguments[0]);" >{@itemsHtml}</div></div></div></div>',markupSlots:{headersContainerNode:function(){return this.domNode.lastChild.firstChild.firstChild;},itemsContainerNode:function(){return this.domNode.lastChild.lastChild.firstChild;},scrollboxNode:function(){return this.domNode.lastChild.lastChild;}},_headersHtml:null,_buildItemsMarkup:function(start,end,markupPrefix,markupSuffix,itemPrefix,itemSuffix,data){var markup=[],count=0,itemGroupSuffix=this._itemGroupSuffix&&this._itemGroupSuffix();markup[count++]=markupPrefix;var i;for(i=start;i<=end;i++){markup[count++]=(this._itemGroupPrefix&&this._itemGroupPrefix(i))||"<tr "+((i%2===1)?'class="even"':"")+">";var j,cnt;for(j=0,cnt=this.colCount;j<cnt;j++){markup[count++]=itemPrefix||"<td>";markup[count++]=this.columns[j].render((data&&data[j])||this.items[i][j],i*j,this);markup[count++]=itemSuffix||"</td>";}markup[count++]=itemGroupSuffix||"</tr>";}markup[count++]=markupSuffix;return markup;},_buildColWidths:function(){this.colWidths=this.colWidths||[];var cws=this.colWidths;if(cws.length===0){var i;for(i=this.colCount-1;i>-1;i--){cws[i]=this.headersNode.rows[0].cells[i].offsetWidth;}}var w=0,j;for(j=cws.length-1;j>-1;j--){w+=cws[j];}this.itemsNode.style.width=this.headersNode.style.width=w+"px";},_buildColGroup:function _buildColGroup(){this._buildColWidths();var ci=this.resizingIndex,cws=this.colWidths,cgs=this.colGroups;if(cgs&&cgs.length===2&&cgs[0].childNodes.length===parseInt(this.colCount,10)){if(ci!==null&&ci>=0){cgs[0].childNodes[ci].style.width=cws[ci]+"px";cgs[1].childNodes[ci].style.width=cws[ci]+"px";}}else{var cg=document.createElement("colgroup"),i,cnt;for(i=0,cnt=this.colCount;i<cnt;i++){var col=document.createElement("col");col.style.width=cws[i]+"px";cg.appendChild(col);}var fnCG=function(w,cg){w[(w.firstChild.tagName.toLowerCase()!=="colgroup")?"insertBefore":"replaceChild"](cg,w.firstChild);};fnCG(this.headersNode,cg);var cg2=cg.cloneNode(true);fnCG(this.itemsNode,cg2);this.colGroups=[cg,cg2];this._webKit_repaint();}},_webKit_repaint:function(){if(mstrmojo.dom.isWK){var ns=[this.headersNode,this.itemsNode];var fnTL=function(tl){var n;for(n in ns){if(ns[n]){ns[n].style.tableLayout=tl||"fixed";}}};fnTL("auto");self.setTimeout(fnTL,1);}},init:function(props){this._super(props);this.scrollboxHeight=parseInt(this.height,10)||200;this.cp=this.cp||new mstrmojo.MCListBoxCP();},preBuildRendering:function preBuildRendering(){if(this._super){this._super();}var cp=this.cp;if(cp.items===null&&cp.columns===null&&cp.ds&&cp.ds.length>0){cp.fetch();}else{cp.dataLoaded=true;}if(this.resizable){this.cssClass+=" resizable ";}},buildRendering:function(){var me=this,cp=this.cp;if(cp&&cp.dataLoaded&&(cp.columns||cp.items)){this.columns=cp.columns;this.items=cp.items;this.colCount=cp.columns.length;this.titleIcon=cp.titlebar.icon;this.titleText=cp.titlebar.v;this.itemRenderer=cp.itemRenderer||this.itemRenderer;if(!this.titleIcon&&!this.titleText&&!this.showEmptyTitlebar){this.titleCssText="display:none";}var clms=this.columns,ir=this.itemRenderer;var i;for(i=this.colCount-1;i>=0;i--){clms[i].render=ir[clms[i].type];}var cws=this.colWidths;if(!this.autoColWidth&&(!cws||cws.length===0)){cws=[];for(i=this.colCount-1;i>-1;i--){cws[i]=parseInt(clms[i].width,10)||this.minColWidth;}this.colWidths=cws;}this.headersHtml=this.headersHtml||this._buildItemsMarkup(0,0,this._markupPrefix&&this._markupPrefix(),this._markupSuffix&&this._markupSuffix(),this._itemPrefix&&this._itemPrefix(),this._itemSuffix&&this._itemSuffix(),clms).join("");this._super();if(!this.headerNode){this.addSlots({headersNode:this.headersContainerNode.firstChild});}var bc=this.itemsContainerNode;if(bc.firstChild.offsetHeight>bc.parentNode.clientHeight){bc.style.width=(bc.offsetWidth-17)+"px";this.headersContainerNode.style.width=bc.style.width;}this._buildColGroup();mstrmojo.dom.attachEvent(this.scrollboxNode,"scroll",function(e){me.headersContainerNode.scrollLeft=mstrmojo.dom.eventTarget(window,e).scrollLeft;});this.hasRendered=!!this.domNode;}else{window.setTimeout(function(){me.buildRendering();},100);}return true;},onsort:function(evt){if(!this.sortable){return false;}var hWin=evt.hWin,e=evt.e;var tgt=mstrmojo.dom.eventTarget(hWin,e);if(tgt){var tgtTD=mstrmojo.dom.findAncestorByName(tgt,"td",false,this.domNode);if(tgtTD){this.sortIndex=tgtTD.cellIndex;if(this.columns[tgtTD.cellIndex].sortable){this.sortDirection=!this.sortDirection;this.items=mstrmojo.array.deepSortArr(this.items,"v",this.sortIndex,this.sortDirection);this.refresh();}}}},refresh:function(){this.editor=null;this.resizeHandle=null;var sl=this.headersContainerNode.scrollLeft;this._super();var i;for(i in [0,1]){var tbl=[this.headersNode,this.itemsNode][i];if(tbl&&tbl.firstChild.tagName.toLowerCase()!=="colgroup"){tbl.insertBefore(this.colGroups[i],tbl.firstChild);}}if(this.headersContainerNode&&this.scrollboxNode){this.headersContainerNode.scrollLeft=sl;this.scrollboxNode.scrollLeft=sl;}this._webKit_repaint();},reRender:function(){this.cp.columns=null;this.cp.items=null;this.cp.dataLoaded=false;this.colWidths=null;this.colGroups=null;this.headersHtml=null;this.refresh();},onedit:function(evt){var hWin=evt.hWin,e=evt.e;var tgt=mstrmojo.dom.eventTarget(hWin,e);var tgtTD=mstrmojo.dom.findAncestorByName(tgt,"td",true);if(tgtTD&&tgt&&this.columns[tgtTD.cellIndex].editable){this.rowIndex=tgtTD.parentNode.rowIndex;this.cellIndex=tgtTD.cellIndex;switch(tgt.tagName.toLowerCase()){case"div":case"span":if(tgt.getAttribute("edt")){var edi=this.editor||new mstrmojo.InlineEditor();if(!edi.editor){edi.render();edi.attachEventListener("targetChange",this.id,function(hWin,e){this.items[this.rowIndex][this.cellIndex].v=this.editor.editor.value;});this.editor=edi;this.itemsContainerNode.appendChild(edi.editor);}edi.setTarget(tgt);edi.show({value:tgt.innerText||tgt.textContent,style:{top:tgtTD.offsetTop+"px",left:tgtTD.offsetLeft+"px",width:(tgtTD.clientWidth-5)+"px"}});}break;case"input":this.items[this.rowIndex][this.cellIndex].v=tgt.checked?"checked":"";break;}}},onmousedown:function(evt){if(!this.resizable){return false;}var hWin=evt.hWin,e=evt.e;var tgt=mstrmojo.dom.eventTarget(hWin,e);if(tgt&&tgt.tagName.toLowerCase()==="td"){if(this.columns[tgt.cellIndex].resizable!==false){var pos=tgt.offsetLeft+tgt.offsetWidth-this.itemsContainerNode.parentNode.scrollLeft;this.resizingIndex=tgt.cellIndex;this.startx=mstrmojo.dom.getMousePosition(e).x;var buildRszHandle=function(x){var h=document.createElement("div");h.className="mstrmojo-MultiColumnListBox-rzHandle";h.style.left=x+"px";return h;};var rh=this.resizeHandle||buildRszHandle(pos);if(!this.resizeHandle||!mstrmojo.dom.contains(this.domNode,rh)){this.resizeHandle=rh;this.scrollboxNode.parentNode.appendChild(rh);}else{rh.style.left=pos+"px";}rh.style.display="block";var me=this;var mousemove=function(e){rh.style.left=Math.max(0,pos+mstrmojo.dom.getMousePosition(e).x-me.startx)+"px";};var mouseup=function(e){if(rh){rh.style.display="none";mstrmojo.dom.detachEvent(document,"mousemove",mousemove);mstrmojo.dom.detachEvent(document,"mouseup",mouseup);}var ri=me.resizingIndex;if(ri>=0){me.colWidths[ri]=Math.max(me.minColWidth,me.colWidths[ri]+mstrmojo.dom.getMousePosition(e).x-me.startx);me._buildColGroup();me.resizingIndex=null;if(mstrmojo.dom.isIE){var h=me.itemsContainerNode.clientHeight,sb=me.scrollboxNode;sb.style.height=h+"px";if(sb.scrollWidth>sb.clientWidth){sb.style.height=h+17+"px";}}}};mstrmojo.dom.attachEvent(document,"mousemove",mousemove);mstrmojo.dom.attachEvent(document,"mouseup",mouseup);}}}});}());(function(){mstrmojo.requiresCls("mstrmojo.Widget");mstrmojo.MCListBoxCP=mstrmojo.declare(mstrmojo.Widget,null,{scriptClass:"mstrmojo.MCListBoxCP",ds:null,titlebar:{icon:"",text:""},itemRenderer:null,columns:null,items:null,fetch:function fetch(){this.dataLoaded=false;var me=this,xhr=new mstrmojo.SimpleXHR(),callback={success:function(dm){var p;for(p in dm){me[p]=dm[p];}me.dataLoaded=true;},failure:function(){alert("Data request failed!");}};xhr.request("POST",this.ds,callback,{});}});}());(function(){mstrmojo.requiresCls("mstrmojo.Widget");mstrmojo.InlineEditor=mstrmojo.declare(mstrmojo.Widget,null,{scriptClass:"mstrmojo.InlineEditor",target:null,visible:false,markupString:"<input id={@id} class=\"mstrmojo-InlineEditor {@cssClass}\"onblur=\"mstrmojo.all['{@id}'].captureDomEvent('blur', self, arguments[0]);\" onkeyup=\"mstrmojo.all['{@id}'].captureDomEvent('keyup', self, arguments[0]);\"/>",markupSlots:{editor:function(){return this.domNode;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},onvisibleChange:function(evt){if(mstrmojo.dom.isFF){var me=this;this.md=this.md||function md(e){if(me.target){var elTarget=mstrmojo.dom.eventTarget(self,e);if(!/InlineEditor/.test(elTarget.className)){me.onblur();}}};if(this.visible){mstrmojo.dom.attachEvent(document,"mousedown",this.md);}else{mstrmojo.dom.detachEvent(document,"mousedown",this.md);}}},setTarget:function(tgt){this.target=tgt;},show:function(props){var tgt=this.target,editor=this.editor;if(!props){props={value:tgt.innerText||tgt.textContent,style:{top:tgt.offsetTop+"px",left:tgt.offsetLeft+"px",width:tgt.offsetWidth+"px"}};}var prop;for(prop in props){var o=props[prop];if(o instanceof Object){var p;for(p in o){editor[prop][p]=o[p];}}else{editor[prop]=o;}}this.set("visible",true);editor.focus();},onblur:function(){var t=this.target;if(t){t[t.innerText?"innerText":"textContent"]=this.editor.value;this.set("visible",false);this.set("target",null);}},onkeyup:function(evt){var hWin=evt.hWin,e=evt.e;e=e||window.event;if((e.keyCode||e.charCode)===13){this.editor.onblur(e);}}});}());(function(){mstrmojo.requiresCls("mstrmojo.dom");var _attr="rszc";mstrmojo.resizableCorner={_MIN_WIDTH:10,_MIN_HEIGHT:10,_target:[],add:function(el){var t=mstrmojo.resizableCorner._target;if(el&&mstrmojo.array.indexOf(t,el)===-1){var rc=document.createElement("div");rc.className="rsz-corner";rc.id=_attr+mstrmojo.resizableCorner._target.length;rc.setAttribute(_attr,1);mstrmojo.dom.attachEvent(rc,"mousedown",this.onstart);el.appendChild(rc);el.setAttribute(_attr,1);t.push(el);}},remove:function(el){var t=mstrmojo.resizableCorner._target;var rc=el.lastChild;if(!rc.hasAttribute(_attr)){rc=document.getElementById(_attr+mstrmojo.array.indexOf(t,el));}el.removeChild(rc);mstrmojo.array.removeItem(t,el);},onstart:function(e){var rc=mstrmojo.dom.eventTarget(window,e);if(rc&&rc.tagName.toLowerCase()==="div"&&rc.hasAttribute(_attr)&&rc.getAttribute(_attr)==="1"){rc.ownerDocument.onselectstart=function(){return false;};var el=mstrmojo.resizableCorner._target[parseInt(rc.id.replace(new RegExp(_attr),""),10)],doc=el&&el.ownerDocument;if(el.hasAttribute(_attr)&&el.getAttribute(_attr)==="1"){var w0=el.clientWidth,h0=el.clientHeight,pos0=mstrmojo.dom.getMousePosition(e);var onresize=function(e){var pos1=mstrmojo.dom.getMousePosition(e);el.style.width=Math.max(10,w0+pos1.x-pos0.x)+"px";el.style.height=Math.max(10,h0+pos1.y-pos0.y)+"px";};var onend=function(e){mstrmojo.dom.detachEvent(doc,"mousemove",onresize);mstrmojo.dom.detachEvent(doc,"mouseup",onend);};mstrmojo.dom.attachEvent(doc,"mousemove",onresize);mstrmojo.dom.attachEvent(doc,"mouseup",onend);}}}};}());