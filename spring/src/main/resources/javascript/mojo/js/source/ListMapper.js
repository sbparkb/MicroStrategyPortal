(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.dom","mstrmojo.css");var RENDERED=1,CSS="mstrmojo-itemwrap",INNER="&nbsp;",$ARR=mstrmojo.array;function _pageSize(w){if(!w.pageSize||w.pageSize<=0){var c=w.scrollboxNode;w.pageSize=c&&c.clientHeight||0;}return w.pageSize;}function _initPages(w,me){if(w.usePaging){w.totalPages=1;var c=w.itemsContainerNode,ph=_pageSize(w);if(w.usePaging&&c&&ph){w.totalPages=Math.ceil((c.clientHeight-parseInt(c.style&&c.style.paddingBottom||0,10))/ph);}if(c){w.itemsContainerNode.style.paddingBottom=ph+"px";}}}mstrmojo.ListMapper=mstrmojo.provide("mstrmojo.ListMapper",{markupPrefix:"",markupSuffix:"",itemWrapperPrefix:function(w){return'<div class="'+this.getWrapperCss(w)+'">';},itemWrapperSuffix:"</div>",itemWrapperPrefill:"&nbsp",wrapperNodes:function wrapperNodes(p){return p.childNodes;},wrapperParentNode:function wrapperParentNode(p){return p;},createWrapperNode:function createWrapperNode(p){var d=p.ownerDocument,n=d.createElement("div");return n;},findScrollRange:function y2idx(p,count,top,h,left,w,offX,offY){if(!count){return{start:0,end:0};}var ch=this.wrapperNodes(p),idx=parseInt(count/2,10),loops=parseInt(Math.log(count)/Math.log(2),10),start=0,end=count-1,bot=top+h,yFirst=ch[0].offsetTop,y;for(var i=1;i<=loops;i++){y=ch[idx].offsetTop-yFirst+offY;if(y<top){start=idx;}else{if(y>bot){end=idx;}}var inc=Math.round(count/Math.pow(2,i+1));idx+=(y>top)?-inc:inc;idx=Math.min(Math.max(0,idx),count-1);}return{start:start,end:end};},findWrapper:function fdwp(p,idx){var ch=this.wrapperNodes(p);return ch&&ch[idx];},findIndex:function nd2idx(w,p,node){var iw=this._nd2iw(w,p,node);return iw?this._iw2idx(w,p,iw):-1;},itemOffsetTop:function iofft(w,p,idx,node){if(!node){var ch=this.wrapperNodes(p);node=ch&&ch[idx];if(!node){return 0;}}var f=p.firstChild;if(!f||(f===node)){return 0;}else{return node.offsetTop-f.offsetTop;}},whereDrop:function whdp(w,p,node,pos,off){var iw=this._nd2iw(w,p,node),idx,idxActual,t;if(iw){idxActual=this._iw2idx(w,p,iw);idx=idxActual;t=this.itemOffsetTop(w,p,null,iw);var h=iw.offsetHeight;if(pos.y>off.top+t+h/2){idx++;t+=h;}}else{return w.dropCuePos;}return{left:0,top:t,idx:idx,idxActual:idxActual};},getWrapperCss:function(w){return CSS;},postBuildRendering:function(p,items,builder,w,ctxt){_initPages(w,this);},buildItemWrappers:function biws(items,builder,w,ctxt,first,last){var PRE=this.itemWrapperPrefix(w),POST=this.itemWrapperSuffix,S=PRE+this.itemWrapperPrefill+POST,out=[this.markupPrefix],k=1,sel=w.selectedIndices||{},fill=function fll(a,b){for(var i=a;i<b;i++){out[k++]=PRE;var s=builder.build(w,ctxt,items[i],i);if(sel[i]){s=s.replace(/class\=\"([^\"]*)\"/,'class="$1 selected"');}out[k++]=s;out[k++]=POST;}};var len=(items&&items.length)||0;first=first&&builder?Math.min(first,len):0;if(first){fill(0,first);}last=last&&builder?Math.min(last,len-first):0;var stop=len-last;for(var j=first;j<stop;j++){out[k++]=S;}if(last){fill(stop,len);}out.push(this.markupSuffix);return out;},fillItemWrappers:function fi(p,items,builder,w,ctxt,start,end,max){var len=(items&&items.length)||0,ns=this.wrapperNodes(p),st=ctxt.itemStatus,C=mstrmojo.css,sel=w.selectedIndices||{};for(var i=start,stop=Math.min(end+1,len),k=0;i<stop;i++){if(st[i]!==RENDERED){ns[i].innerHTML=builder.build(w,ctxt,items[i],i);if(sel[i]){var el=ns[i].firstChild;if(el){C.addClass(el,["selected"]);}}k++;if(k===max){break;}}}return k;},onadd:function oa(w,p,ctxt,evt){if(p&&evt){var c=evt.value.length,ns=this.wrapperNodes(p),bef=ns[evt.index],css=this.getWrapperCss(w);for(var i=0;i<c;i++){var el=this.createWrapperNode(p);el.className=css;el.innerHTML=INNER;if(bef){this.wrapperParentNode(p).insertBefore(el,bef);}else{this.wrapperParentNode(p).appendChild(el);}}_initPages(w,this);}},onremove:function orm(w,p,ctxt,evt){if(p&&evt){var ns=this.wrapperNodes(p);if(ns){var c=evt.value.length;for(var i=evt.index+c-1,end=evt.index;i>=end;i--){this.wrapperParentNode(p).removeChild(ns[i]);}}_initPages(w,this);}},onchange:function ocg(w,p,ctxt,evt){if(p&&evt){var ns=this.wrapperNodes(p);if(ns){var C=mstrmojo.css,st=ctxt.itemStatus,idx;for(var i=0,r=evt.removed,rlen=r&&r.length;i<rlen;i++){idx=r[i];if(st[idx]){C.removeClass(ns[idx].firstChild,["selected"]);}}for(var j=0,a=evt.added,alen=a&&a.length;j<alen;j++){idx=a[j];if(st[idx]){C.addClass(ns[idx].firstChild,["selected"]);}}}}},_nd2iw:function _nd2iw(w,p,node){p=this.wrapperParentNode(p);if(p&&node&&p!==node){var dn=w.domNode,pn=node.parentNode;while(pn){if(pn===p){return node;}if(pn===dn){break;}node=pn;pn=node.parentNode;}}return null;},_iw2idx:function _iw2idx(w,p,node){var len=w.items&&w.items.length,wns=this.wrapperNodes(p),idx=$ARR.findBin(wns,node,"offsetTop",len);for(var i=idx;i<len;i++){if(wns[i].offsetHeight){return i;}}return -1;},toPage:function(w,pg){var scl=w.scrollboxNode;if(w.usePaging&&scl){scl.scrollTop=pg*_pageSize(w);}else{mstrmojo.alert("paging is not setup, can not perform paging.");}},whichPage:function(w){var scl=w.scrollboxNode,ph=_pageSize(w);return Math.round((scl&&ph&&scl.scrollTop/ph)||0);},toItem:function(w,idx){var c=w&&w.itemsContainerNode,s=w.scrollboxNode,off=this.itemOffsetTop(w,c,idx),ih=this.wrapperNodes(c)[idx].clientHeight,sh=s.clientHeight,st=s.scrollTop,to=st;if(off<st){to=off;}else{if(st+sh-ih<off){to=Math.min(off,off-sh+ih);}}s.scrollTop=to;}});})();