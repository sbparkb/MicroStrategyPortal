(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo.color","mstrmojo.array","mstrmojo.css","mstrmojo.url");var BG_COLORS={4:"#F00",5:"#008000"};var $DOM=mstrmojo.dom;var browserSupportsHtml5=true;function getTime(){var a=new Date();var y=a.getYear()+"-";var m=a.getMonth()+"-";var d=a.getDay()+"-";var h=a.getHours()+"-";var x=a.getMinutes()+"-";var s=a.getSeconds()+"-";var ms=a.getMilliseconds();return(y+m+d+h+x+s+ms);}function isOwnEmpty(obj){var name;for(name in obj){if(obj.hasOwnProperty(name)){return false;}}return true;}function getLighterColor(c){var rgb=mstrmojo.color.hex2rgb(c);mstrmojo.array.forEach(rgb,function(v,idx){rgb[idx]=Math.floor(v*0.75);});return"rgb("+rgb.join(",")+")";}function positionTooltip(tooltip,touchX,touchY){var tooltipStyle=tooltip.style,translateValue="translate("+touchX+"px, "+touchY+"px)",translateValue3d=translateValue.replace("late(","late3d(").replace("px)","px, 0)");tooltipStyle.MozTransform=translateValue;tooltipStyle.msTransform=translateValue;tooltipStyle.webkitTransform=translateValue3d;tooltipStyle.transform=translateValue3d;}function inPoly(poly,px,py){var npoints=poly.length,inside=false,xnew,ynew,xold,yold,x1,y1,x2,y2,i;if(npoints/2<3){return false;}if(npoints%2===1){npoints-=1;}xold=poly[npoints-2];yold=poly[npoints-1];for(i=0;i<npoints;i=i+2){xnew=poly[i];ynew=poly[i+1];if(xnew>xold){x1=xold;x2=xnew;y1=yold;y2=ynew;}else{x1=xnew;x2=xold;y1=ynew;y2=yold;}if((xnew<px)===(px<=xold)&&((py-y1)*(x2-x1)<(y2-y1)*(px-x1))){inside=!inside;}xold=xnew;yold=ynew;}return inside;}function drawPoly(ctx,coordsArray,offset,strokeColor,strokeWidth,fillColor){try{var offsetX=offset?offset.x:0,offsetY=offset?offset.y:0;var getPointAt=function(j){var offset=j%2?offsetY:offsetX;return pointsArray[j]+offset;};var i,j;for(i=0;i<coordsArray.length;i++){var pointsArray=coordsArray[i];ctx.beginPath();ctx.moveTo(getPointAt(0),getPointAt(1));for(j=2;j<pointsArray.length-1;j=j+2){var xx=getPointAt(j),yy=getPointAt(j+1);ctx.lineTo(xx,yy);}var x=getPointAt(0),y=getPointAt(1),fillStyle=fillColor;ctx.lineTo(x,y);ctx.fillStyle=fillStyle;ctx.fill();ctx.strokeStyle=strokeColor;ctx.lineWidth=strokeWidth;ctx.stroke();}}catch(e){}}function drawBubble(context,pt,offset,color,radius){context.fillStyle=color;context.beginPath();context.arc(pt[0]+offset.x,pt[1]+offset.y,radius,0,Math.PI*2,true);context.closePath();context.fill();}function drawStroke(context,pt,offset,color,radius,strokeWidth){context.strokeStyle=color;context.lineWidth=strokeWidth;context.beginPath();context.arc(pt[0]+offset.x,pt[1]+offset.y,radius,0,Math.PI*2,true);context.closePath();context.stroke();}function getPolygonCenter(pointsArr){var sumX=0,sumY=0,i;for(i=0;i<pointsArr.length;i++){sumX=sumX+pointsArr[i];i++;sumY=sumY+pointsArr[i];}var centerX=sumX/(pointsArr.length*2),centerY=sumY/(pointsArr.length*2),center1=[centerX,centerY],center2=[];center2.push(center1);return center2;}function getCentroidOfPolygon(points){if(points===null||points.length<4){return null;}var area=0,len=points.length,i,px,py,p2x,p2y;for(i=0;i<len-2;i+=2){px=points[i];py=points[i+1];p2x=points[i+2];p2y=points[i+3];area+=(px*p2y-p2x*py);}px=points[len-2];py=points[len-1];p2x=points[0];p2y=points[1];area+=(px*p2y-p2x*py);area=Math.abs(area/2);if(area<=0){return null;}var centroid=[0,0];for(i=0;i<len-2;i+=2){px=points[i];py=points[i+1];p2x=points[i+2];p2y=points[i+3];centroid[0]+=((px+p2x)*(px*p2y-p2x*py));centroid[1]+=((py+p2y)*(px*p2y-p2x*py));}px=points[len-2];py=points[len-1];p2x=points[0];p2y=points[1];centroid[0]+=((px+p2x)*(px*p2y-p2x*py));centroid[1]+=((py+p2y)*(px*p2y-p2x*py));centroid=[Math.abs(centroid[0]/(area*6)),Math.abs(centroid[1]/(area*6))];var two_dim_centroid=[];two_dim_centroid.push(centroid);return two_dim_centroid;}function getOpacityColor(color,opacity){var opacityColor,i;var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(color){var colorNew;if(/^(rgba|RGBA)/.test(color)){var tempColor=color.replace(/rgba\(|RGBA\(/,"");tempColor=tempColor.replace(")","");colorNew=tempColor.split(",");opacityColor="RGBA("+colorNew[0]+","+colorNew[1]+","+colorNew[2]+","+opacity+")";}else{if(/^(rgb|RGB)/.test(color)){colorNew=color.replace(/rgb\(|RGB\(/,"");colorNew=colorNew.replace(")","");opacityColor="RGBA("+colorNew+","+opacity+")";}else{if(reg.test(color)){if(color.length===4){colorNew="#";for(i=1;i<4;i++){colorNew+=color.slice(i,i+1).concat(color.slice(i,i+1));}color=colorNew;}var colorChange=[];for(i=1;i<7;i+=2){colorChange.push(parseInt("0x"+color.slice(i,i+2)));}colorChange.push(opacity);opacityColor="RGBA("+colorChange.join(",")+")";}else{opacityColor=color;}}}}else{opacityColor=null;}return opacityColor;}function drawWhiteRectCorner(hlContext,xOffset,yOffset,width,height){hlContext.strokeStyle="#FFF";hlContext.lineWidth=2;hlContext.beginPath();hlContext.moveTo(xOffset+width*0.25,yOffset);hlContext.lineTo(xOffset,yOffset);hlContext.lineTo(xOffset,yOffset+height*0.25);hlContext.moveTo(xOffset,yOffset+height*0.75);hlContext.lineTo(xOffset,yOffset+height);hlContext.lineTo(xOffset+width*0.25,yOffset+height);hlContext.moveTo(xOffset+width*0.75,yOffset+height);hlContext.lineTo(xOffset+width,yOffset+height);hlContext.lineTo(xOffset+width,yOffset+height*0.75);hlContext.moveTo(xOffset+width,yOffset+height*0.25);hlContext.lineTo(xOffset+width,yOffset);hlContext.lineTo(xOffset+width*0.75,yOffset);hlContext.stroke();hlContext.closePath();}function getWebServerUrl(isTablet){var webServerUrl=null;if(isTablet){if(typeof mstrApp!=="undefined"&&mstrApp.getConfiguration){webServerUrl=mstrApp.getConfiguration().getCurrentProjectWebServerUrl();}}else{var href=document.location&&document.location.href;if(href){var hrefLowerCase=href.toLowerCase();var servletReg="/servlet/",aspReg="/asp/";var servletIndex=hrefLowerCase.indexOf(servletReg),aspIndex=hrefLowerCase.indexOf(aspReg);if(servletIndex>=0){if(aspIndex<0){webServerUrl=href.substr(0,servletIndex+1);}else{if(aspIndex>=0){var index=(servletIndex>aspIndex)?aspIndex:servletIndex;webServerUrl=href.substr(0,index+1);}}}else{if(servletIndex<0){if(aspIndex>=0){webServerUrl=href.substr(0,aspIndex+1);}else{if(aspIndex<0){}}}}}}return webServerUrl;}mstrmojo.AndroidBaseImageLayoutPrototype=mstrmojo.declare(mstrmojo.Widget,[],{scriptClass:"mstrmojo.AndroidBaseImageLayoutPrototype",model:null,controller:null,xtabModel:null,mapScaleFactor:1,width:700,height:500,top:0,left:0,totalWidget:null,mapFileIndex:-1,areaBubbleAttrElems:null,startLine:-1,endLine:-1,browserSupportsHtml5:true,hasDrawnMap:undefined,markupString:'<div id="{@id}" class="mstrmojo-Chart {@cssClass}" style="position:absolute;width:{@width}px;height:{@height}px;top:{@top}px;left:{@left}px;overflow:hidden;"  ><div id="{@id}-scroll-element" style="position:absolute;left:0;top:0;width:{@width};height={@height}"><canvas id="{@id}-highlightCanvas" style="position:absolute;left:0;top:0;z-index:1" width="{@width}" height="{@height}"></canvas><canvas id="{@id}-animationCanvas" style="position:absolute;left:0;top:0" width="{@width}" height="{@height}"></canvas></div><div id="{@id}-tooltip" style="z-index:2" class="mstrmojo-BaseImageLayout-tooltip" clk="clk"><table style="margin:5px 7px"></table></div><div id="{@id}-infowindow-anchor" style="position:absolute;width:18px;height:18px;display:block;z-index:-1;"></div><div id="{@id}-css" style="display:none"></div><div id="{@id}-errMsg" align="center" style="position:absolute; top:35%; word-wrap:break-word;"></div></div>',markupSlots:{scrollableCanvasDiv:function(){return this.domNode.childNodes[0];},highlightCanvas:function(){return this.domNode.childNodes[0].firstChild;},animationCanvas:function(){return this.domNode.childNodes[0].lastChild;},tooltip:function(){return this.domNode.childNodes[1];},infowinAnchor:function(){return this.domNode.childNodes[2];},cssDiv:function(){return this.domNode.childNodes[3];},errorMessage:function(){return this.domNode.childNodes[4];}},init:function init(props){this.areaBubbleAttrElems={};if(this._super){this._super(props);}},preBuildRendering:function(){this.start=new Date();this.renderTime=0;if(this._super){this._super();}},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}var me=this;browserSupportsHtml5=me.highlightCanvas.getContext;if(!browserSupportsHtml5){var localeString=window.getLocaleString?window.getLocaleString("YOUR_BROWSER_NOT_SUPPORT_HTML5","Your browser does not support HTML5"):mstrmojo.desc(8126,"Your browser does not support HTML5");me.renderErrorMessage(localeString);return ;}me.newRenderFlag=true;me.prepareAreaBubbleAttrElems();me.highlightContext=me.highlightCanvas.getContext("2d");me.animationContext=me.animationCanvas.getContext("2d");this.end=new Date();this.renderTime=this.end-this.start;this.hasDrawnMap=false;},getMapAndDraw:function(){var me=this;if(!me.coords){if(me.CONSTANTS.DEBUG.LOG){console.log("\ndownload new coords");}if(me.CONSTANTS.DEBUG.PERFORMANCE){var beforeSvRqt=new Date();}if(typeof mstrApp!=="undefined"&&mstrApp.serverRequest){var xhrCfg={submission:function(){me.totalWidget.showLoadingIndicator();},complete:function(){},success:function(res){me.totalWidget.hideLoadingIndicator();if(!me.hasRendered){return ;}if(me.CONSTANTS.DEBUG.TOUCH_WHILE_LOADING){console.log("mapFileIndex: "+me.mapFileIndex+" receive success Time: "+getTime());}me.isMapLoadFailed=false;if(!res){return ;}if(me.CONSTANTS.DEBUG.PERFORMANCE){var afterSvRqt=new Date();console.log("\nSvRqt time: "+(afterSvRqt-beforeSvRqt));}var coords=res.coords;if(coords){me.totalWidget.prepareCoordsName(coords);me.totalWidget.mapFilePool[me.mapFileName]=coords;me.coords=coords;me.initDrawMapWithCoords();}else{me.isMapLoadFailed=true;var errorMessage="The Image Map / Shape file cannot be found.";var localeString=window.getLocaleString?window.getLocaleString("IMAGELAYOUT_HTML_FILE_NOT_FOUNDED","The Image Map / Shape file cannot be found."):mstrmojo.desc(9854,errorMessage);me.renderErrorMessage(localeString);}},failure:function(res){me.totalWidget.hideLoadingIndicator();if(!me.hasRendered){return ;}if(me.CONSTANTS.DEBUG.TOUCH_WHILE_LOADING){console.log("mapFileIndex: "+me.mapFileIndex+" receive failure Time: "+getTime());}me.isMapLoadFailed=true;var errorMessage="The Image Map / Shape file cannot be found.";var localeString=window.getLocaleString?window.getLocaleString("IMAGELAYOUT_HTML_FILE_NOT_FOUNDED","The Image Map / Shape file cannot be found."):mstrmojo.desc(9854,errorMessage);me.renderErrorMessage(localeString);}};var params={taskId:"getMapCoordinates"};var vp=me.model.vp;if(me.totalWidget&&me.totalWidget.hasMultiAttr){params.coordinatesFile=me.totalWidget.getMapFilePath(me.mapFileIndex);}else{if(vp&&vp.mf){params.coordinatesFile=vp.mf;}}if(!!params.coordinatesFile&&params.coordinatesFile.charAt(0)!="/"){params.coordinatesFile="/"+params.coordinatesFile;}me.mapFileName=params.coordinatesFile;console.log("mapFileIndex: "+me.mapFileIndex+"  mapFileName: "+me.mapFileName);var config={src:"postBuildRendering",noErrorMessage:true,showProgress:true,hideProgress:true,progressStateText:["Loading Map File for Sub-ImageLayout"],silent:true};if(me.CONSTANTS.DEBUG.TOUCH_WHILE_LOADING){console.log("mapFileIndex: "+me.mapFileIndex+" send Request Time: "+getTime());}me.requestSend=new Date();var mapFileName=me.mapFileName,mapFilePool=me.totalWidget.mapFilePool,coords=mapFileName&&mapFilePool.hasOwnProperty(mapFileName);if(coords){me.coords=mapFilePool[mapFileName];me.initDrawMapWithCoords();}else{if(me.mapFileIndex>=me.totalWidget.firstSuccessLoadedMapFileIndex){mstrApp.serverRequest(params,xhrCfg,config);}else{me.isMapLoadFailed=true;var errorMessage="The Image Map / Shape file cannot be found.";var localeString=window.getLocaleString?window.getLocaleString("IMAGELAYOUT_HTML_FILE_NOT_FOUNDED","The Image Map / Shape file cannot be found."):mstrmojo.desc(9854,errorMessage);me.renderErrorMessage(localeString);}}}}else{console.log("mapFileIndex: "+me.mapFileIndex+"  mapFileName: "+me.mapFileName);me.drawMap();me.highlightPoint();}this.hasDrawnMap=true;},initDrawMapWithCoords:function(){var me=this;me.totalWidget.adjustOffsets();window.setTimeout(function(){me.drawMap();if(!me.mapDataScreenshotTaken&&me.isTablet){me.mapDataScreenshotTaken=true;me.localTakeScreenshot(me.CONSTANTS.RENDERING_TIME);}},0);},getFullPath:function getFullPath(path){var fullPath="";var reg=/^[A-z]:\/\//;if(reg.test(path)){fullPath=path;}else{var tempReg1=/^(..\/|..\\)/;var tempReg2=/^(.\/|.\\)/;var tempReg3=/^(\/|\\)/;path=path.replace(tempReg1,"");path=path.replace(tempReg2,"");path=path.replace(tempReg3,"");if(typeof mstrApp!=="undefined"&&mstrApp.getConfiguration){fullPath=mstrmojo.url.getAbsoluteURL(path,getWebServerUrl(this.isTablet));}}return fullPath;},prepareAreaBubbleAttrElems:function prepareAreaBubbleAttrElems(){var me=this,mapFileIndex=me.mapFileIndex,totalWidget=me.totalWidget,mapLineScopes=totalWidget.mapLineScopes,layoutAttrIndex=totalWidget.layoutAttrIndex,areaBubbleAttrIndex=totalWidget.areaBubbleAttrIndex;if(layoutAttrIndex>-1&&areaBubbleAttrIndex>-1){if(mapLineScopes.length>mapFileIndex){var mapLineScope=mapLineScopes[mapFileIndex];me.startLine=mapLineScope.startLine;me.endLine=mapLineScope.endLine;me.areaBubbleAttrElems=mapLineScope.areaBubbleAttrElems;}}else{if(layoutAttrIndex===-1&&areaBubbleAttrIndex>-1){var mapFileIndex=0;if(mapLineScopes.length>mapFileIndex){var mapLineScope=mapLineScopes[mapFileIndex];me.startLine=mapLineScope.startLine;me.endLine=mapLineScope.endLine;me.areaBubbleAttrElems=mapLineScope.areaBubbleAttrElems;}}}},getWidth:function getWidth(){return parseInt(this.width,10);},getHeight:function getHeight(){return parseInt(this.height,10);},touchSwipeBegin_mouseDown:function touchSwipeBegin_mouseDown(touch){this.hideTooltip();},getLastHighlightPoint:function gtLstHighlightPnt(){return this.totalWidget.currHoverObj||null;},getTouchedObj:function getTouchedObj(isTap,touchX,touchY){var me=this,touchedObj=null;if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.AREA){touchedObj=this.getAreaOrNearestBubble(isTap,touchX,touchY);}else{if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE){touchedObj=this.getLastHighlightPoint();var touchPointInHighlightArea=false,tx=0,ty=0;if(touchedObj){tx=touchedObj.point.x;ty=touchedObj.point.y;touchPointInHighlightArea=this.totalWidget.tooltipOn&&(tx-touchX)*(tx-touchX)+(ty-touchY)*(ty-touchY)<=this.totalWidget.bias*this.totalWidget.bias;}if(touchPointInHighlightArea){me.hideTooltip();touchedObj=this.getLastHighlightPoint();}else{touchedObj=this.getAreaOrNearestBubble(isTap,touchX,touchY);}}}return touchedObj;},localTakeScreenshot:function localTakeScreenshot(_time){var me=this;window.setTimeout(function(){var ctrlID=me.controller.id;var ctrl=mstrmojo.all[ctrlID];if(ctrl&&ctrl.rootCtrl.getCurrent()===ctrl){ctrl.takeScreenShot();}},_time);},renderErrorMessage:function renderErrorMessage(errorMessage){var me=this,msgDiv=me.errorMessage,newErrorMessage=errorMessage.replace(/-/g,"<br />-");msgDiv.innerHTML=newErrorMessage;msgDiv.style.width=me.getWidth()+"px";msgDiv.style.fontSize=me.totalWidget.errMsgFontSize+"px";msgDiv.style.fontFamily="Tahoma";msgDiv.style.color=me.CONSTANTS.ERROR_MSG_FONT_COLOR.DARK_THEME;msgDiv.style.backgroundColor="RGBA(0,0,0,0)";me.themeMode=me.totalWidget?me.totalWidget.themeMode:me.CONSTANTS.THEME.DARK;if(me.themeMode===me.CONSTANTS.THEME.LIGHT){msgDiv.style.color=me.CONSTANTS.ERROR_MSG_FONT_COLOR.LIGHT_THEME;}},getLineIndexFromTouchValue:function getLineIndexFromTouchValue(touchValue){var lineIndex=-1,areaBubbleAttrElems=this.areaBubbleAttrElems;if(touchValue&&areaBubbleAttrElems){touchValue=touchValue.toLowerCase();if(areaBubbleAttrElems.hasOwnProperty(touchValue)){lineIndex=areaBubbleAttrElems[touchValue].lineIndex;}}return lineIndex;},drawMap:function drawMap(){var me=this;me.animationCanvas.width=me.animationCanvas.width;me.highlightCanvas.width=me.highlightCanvas.width;if(!me.hasOwnProperty("displayMode")){me.displayMode=me.CONSTANTS.DISPLAY_MODE.AUTOMATIC;}if(!me.hasOwnProperty("markerType")){me.markerType=me.CONSTANTS.MARKER_TYPE.UNDEFINED;}if(!me.hasOwnProperty("shapeFileType")){me.shapeFileType=me.CONSTANTS.SHAPE_FILE_TYPE.UNDEFINED;}if(!me.hasOwnProperty("colorByIndex")){me.colorByIndex=-1;}if(!me.hasOwnProperty("sizeByIndex")){me.sizeByIndex=-1;}if(!me.hasOwnProperty("drawBgImageFlag")){me.drawBgImageFlag=false;}if(!me.hasOwnProperty("thresholdType")){me.thresholdType=me.CONSTANTS.THRESHOLD_TYPE.UNDEFINED;}if(!me.hasOwnProperty("curPolygonOpacity")){me.curPolygonOpacity=me.CONSTANTS.POLYGON_OPACITY.NORMAL;}if(!me.hasOwnProperty("touchSelectWithIfw")){me.touchSelectWithIfw=false;}if(me.totalWidget){me.themeMode=me.totalWidget.themeMode;me.bgColor=me.totalWidget.bgColor;}else{me.themeMode=me.CONSTANTS.THEME.DARK;me.bgColor=me.CONSTANTS.DEFAULT_BG_COLOR;}if(me.totalWidget.isVI){me.setDisplayParasForVI();}else{me.setDisplayParas();}if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.AREA){me.drawAreaMap();}else{if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE){me.drawBubbleMap();}}},getIndexById:function getIndexById(id){var me=this,model=me.model,gtsCol=model.gts&&model.gts.col,gtsColEle=null,i;if(gtsCol&&gtsCol.length>0&&gtsCol[0].hasOwnProperty("es")){gtsColEle=gtsCol[0].es;for(i=0;i<gtsColEle.length;i++){if(gtsColEle[i].oid===id){return i;}}}return -1;},setDisplayParasForVI:function setDisplayParasForVI(){var me=this,model=me.model;if(!me.hasOwnProperty("setDisplayParasFlag")){me.setDisplayParasFlag=true;}else{return ;}me.shapeFileType=me.getShapeFileType(me.coords);me.displayMode=model.vp.mt||me.CONSTANTS.DISPLAY_MODE.AUTOMATIC;if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.AREA){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){me.colorByIndex=me.totalWidget.getAreaColorByIndexForVI();me.thresholdType=me.totalWidget.getThresholdType(me.colorByIndex);}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){me.setBubbleModeParasWithDataForVI();}}}else{if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE){me.setBubbleModeParasWithDataForVI();}else{if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.AUTOMATIC){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){me.displayMode=me.CONSTANTS.DISPLAY_MODE.AREA;me.colorByIndex=me.totalWidget.getAreaColorByIndexForVI();me.thresholdType=me.totalWidget.getThresholdType(me.colorByIndex);}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){me.displayMode=me.CONSTANTS.DISPLAY_MODE.BUBBLE;me.setBubbleModeParasWithDataForVI();}}}}}},setDisplayParas:function setDisplayParas(){var me=this,model=me.model;if(!me.hasOwnProperty("setDisplayParasFlag")){me.setDisplayParasFlag=true;}else{return ;}me.shapeFileType=me.getShapeFileType(me.coords);var colCount=me.totalWidget.getColCount();me.displayMode=model.vp.mt||me.CONSTANTS.DISPLAY_MODE.AUTOMATIC;if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.AREA){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(colCount>0){me.colorByIndex=me.totalWidget.getAreaColorByIndex();me.thresholdType=me.totalWidget.getThresholdType(me.colorByIndex);}else{}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){me.displayMode=me.CONSTANTS.DISPLAY_MODE.BUBBLE;}}}if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE){if(colCount>0){me.setBubbleModeParasWithData(colCount);}else{me.markerType=me.CONSTANTS.MARKER_TYPE.BUBBLE;}}else{if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.AUTOMATIC){if(colCount>0){me.displayMode=me.CONSTANTS.DISPLAY_MODE.BUBBLE;me.setBubbleModeParasWithData(colCount);}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){me.displayMode=me.CONSTANTS.DISPLAY_MODE.AREA;}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){me.displayMode=me.CONSTANTS.DISPLAY_MODE.BUBBLE;me.markerType=me.CONSTANTS.MARKER_TYPE.BUBBLE;}}}}}},getShapeFileType:function getShapeFileType(coords){var me=this,shapeFileType=me.CONSTANTS.SHAPE_FILE_TYPE.UNDEFINED;if(coords){var elem;for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}if(coords[elem][0]){if(coords[elem][0].length===2){shapeFileType=me.CONSTANTS.SHAPE_FILE_TYPE.POINT;}else{if(coords[elem][0].length>2){shapeFileType=me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON;}}}}}}return shapeFileType;},setBubbleModeParasWithDataForVI:function setBubbleModeParasWithDataForVI(){var me=this,model=me.model,totalWidget=me.totalWidget;me.sizeByIndex=me.totalWidget.getSizeByIndexForVI();me.colorByIndex=this.totalWidget.getAreaColorByIndexForVI();me.thresholdType=totalWidget.getThresholdType(me.colorByIndex);if(me.sizeByIndex>-1){me.markerType=me.CONSTANTS.MARKER_TYPE.BUBBLE;}else{if(me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.IMAGE){me.markerType=me.CONSTANTS.MARKER_TYPE.IMAGE;}else{me.markerType=me.CONSTANTS.MARKER_TYPE.BUBBLE;}}},setBubbleModeParasWithData:function setBubbleModeParasWithData(colCount){var me=this,model=me.model,totalWidget=me.totalWidget;me.sizeByIndex=me.totalWidget.getSizeByIndex();if(model.vp.hasOwnProperty("ColorBy")){me.colorByIndex=this.getIndexById(model.vp.ColorBy);if(me.colorByIndex<0){me.colorByIndex=0;}me.thresholdType=totalWidget.getThresholdType(me.colorByIndex);if(me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.IMAGE){me.markerType=me.CONSTANTS.MARKER_TYPE.IMAGE;}else{me.markerType=me.CONSTANTS.MARKER_TYPE.BUBBLE;}}else{if(colCount===1){me.colorByIndex=0;me.thresholdType=totalWidget.getThresholdType(0);if(me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.IMAGE){me.markerType=me.CONSTANTS.MARKER_TYPE.IMAGE;}else{me.markerType=me.CONSTANTS.MARKER_TYPE.BUBBLE;}}else{if(colCount>1){var firstThresholdType=totalWidget.getThresholdType(0);if(firstThresholdType===me.CONSTANTS.THRESHOLD_TYPE.IMAGE){me.colorByIndex=0;me.thresholdType=firstThresholdType;me.markerType=me.CONSTANTS.MARKER_TYPE.IMAGE;}else{me.colorByIndex=1;me.thresholdType=totalWidget.getThresholdType(1);if(me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.IMAGE){me.markerType=me.CONSTANTS.MARKER_TYPE.IMAGE;}else{me.markerType=me.CONSTANTS.MARKER_TYPE.BUBBLE;}}}}}},scalePolygonCoords:function scalePolygonCoords(){var me=this,coords=me.coords,oriCoords=me.oriCoords;var maxX=0,maxY=0,rgn,oriRgn,c,oriC,i,j,k;for(i in oriCoords){if(oriCoords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=oriCoords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];for(k=0;k<c.length;k++){if(c[k]>maxX){maxX=c[k];}k++;if(c[k]>maxY){maxY=c[k];}}}}}}var xRatio=maxX/(this.getWidth()-10),yRatio=maxY/(this.getHeight()-10),ratio=Math.max(yRatio,xRatio);this.topOffset=(this.getHeight()-maxY/ratio)/2;this.leftOffset=(this.getWidth()-maxX/ratio)/2;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=coords[i];oriRgn=oriCoords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];oriC=oriRgn[j];for(k=0;k<c.length;k++){c[k]=parseInt(oriC[k]/ratio,10);}}}}}},getBubbleColorFromName:function getBubbleColorFromName(elem){var me=this,model=me.model,allBubblesColor=model.allBubblesColor,lineIndex=me.getLineIndexFromTouchValue(elem);if(lineIndex>-1&&allBubblesColor&&allBubblesColor.hasOwnProperty(lineIndex)){return allBubblesColor[lineIndex];}else{return null;}},drawPolygonInMap:function drawPolygonInMap(opacity){var me=this,model=me.model,coords=me.coords,context=this.animationContext,elem,lineIndex=-1;me.animationCanvas.width=me.animationCanvas.width;if(me.drawBgImageFlag&&me.bgImg){var xRatio=me.oriBgImageWidth/(me.getWidth()-me.totalWidget.borderSpace*2),yRatio=me.oriBgImageHeight/(me.getHeight()-me.totalWidget.borderSpace*2),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()-me.oriBgImageWidth/ratio)/2;context.drawImage(me.bgImg,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);}me.curPolygonOpacity=opacity;var noAltColor=me.CONSTANTS.POLYGON_COLOR.NO_ALT_DARK_THEME,noColorByColor=me.CONSTANTS.POLYGON_COLOR.NO_COLORBY_DARK_THEME,strokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_DARK_THEME;if(me.themeMode===me.CONSTANTS.THEME.LIGHT){noAltColor=me.CONSTANTS.POLYGON_COLOR.NO_ALT_LIGHT_THEME;noColorByColor=me.CONSTANTS.POLYGON_COLOR.NO_COLORBY_LIGHT_THEME;strokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_LIGHT_THEME;}if(model.vp&&model.vp.npc){noAltColor=getOpacityColor("#"+model.vp.npc,me.CONSTANTS.POLYGON_OPACITY.NORMAL);}for(elem in coords){if(me.CONSTANTS.DEBUG.PERFORMANCE){var begin=new Date();}if(!coords.hasOwnProperty(elem)){continue;}var clr=noAltColor;if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}clr=noAltColor;if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.AREA){if(me.CONSTANTS.DEBUG.PERFORMANCE){var beforeGHI=new Date();}var hdrIndex=this.getHeaderIndexFromTouchValue(elem);if(me.CONSTANTS.DEBUG.PERFORMANCE){var afterGHI=new Date();}if(hdrIndex>=0){if(me.colorByIndex>=0){lineIndex=me.getLineIndexFromTouchValue(elem);var mv=lineIndex>-1?model.gvs.items[lineIndex].items[me.colorByIndex]:null;clr=me.totalWidget.getBgColorFromCss(mv,me.colorByIndex);if(!clr){clr=noColorByColor;}if(me.drawBgImageFlag){clr=getOpacityColor(clr,me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG);}else{clr=getOpacityColor(clr,me.CONSTANTS.POLYGON_OPACITY.NORMAL);}}else{clr=noColorByColor;}}else{clr=noAltColor;}if(me.CONSTANTS.DEBUG.PERFORMANCE){var afterGC=new Date();}}else{if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE){clr=noAltColor;}}}clr=getOpacityColor(clr,opacity);if(me.CONSTANTS.DEBUG.PERFORMANCE){var afterGO=new Date();}drawPoly(context,coords[elem],{x:this.leftOffset,y:this.topOffset},strokeColor,me.totalWidget.polygonStrokeWidth,clr);if(me.CONSTANTS.DEBUG.PERFORMANCE){var afterDP=new Date();console.log("\ndrawPolygonInMap time: "+(afterDP-begin)+"\n\tgetHeaderIndexFromTouchValue time: "+(afterGHI-beforeGHI)+"\n\tget polygon color time: "+(afterGC-afterGHI)+"\n\tdrawPoly time: "+(afterDP-afterGC));}}},getRadiusFromName:function getRadiusFromName(name){var me=this;if(me.coords.hasOwnProperty(name)){bubbleSizeParas=me.totalWidget.getBubbleSizeParas();maxRadius=bubbleSizeParas?bubbleSizeParas.maxRadius:0;if(me.hasOwnProperty("oriBubbleSize")){oriBubbleSize=me.oriBubbleSize;var lineIndex=me.getLineIndexFromTouchValue(name);return(oriBubbleSize.hasOwnProperty(lineIndex)?oriBubbleSize[lineIndex]:maxRadius)*me.mapScaleFactor;}else{if(me.hasOwnProperty("maxRadius")){return maxRadius*me.mapScaleFactor;}else{return 2;}}}else{return -1;}},shouldDrawThisBubble:function(bubbleNodeName){var me=this,totalWidget=me.totalWidget,isDftSltObj=false;var lineIndex=me.getLineIndexFromTouchValue(bubbleNodeName);isDftSltObj=me.totalWidget.shouldHighlightDefaultSelectedNodes&&totalWidget.defaultSelectedObjs.hasOwnProperty(lineIndex);return bubbleNodeName!=="bgImage"&&(bubbleNodeName!==(totalWidget.currHoverObj&&totalWidget.currHoverObj.touchVal)||totalWidget.currHoverObjMiniChart!==me)&&(bubbleNodeName!==(totalWidget.currSelectedObj&&totalWidget.currSelectedObj.touchVal)||totalWidget.currSelectedObjMiniChart!==me)&&(bubbleNodeName!==(totalWidget.currLinkObj&&totalWidget.currLinkObj.touchVal)||totalWidget.currLinkObjMiniChart!==me)&&(!isDftSltObj);},getImageIconHeight:function(height){return height>this.CONSTANTS.MAX_IMAGE_ICON_SIZE.HEIGHT?this.CONSTANTS.MAX_IMAGE_ICON_SIZE.HEIGHT:height;},getImageIconWidth:function(width){return width>this.CONSTANTS.MAX_IMAGE_ICON_SIZE.WIDTH?this.CONSTANTS.MAX_IMAGE_ICON_SIZE.WIDTH:width;},drawBubblesInMap:function drawBubblesInMap(){var me=this,model=me.model,coords=me.coords,elem,hdrIndex,lineIndex=-1;if(me.hasOwnProperty("polygonCenters")){coords=me.polygonCenters;}me.highlightCanvas.width=me.highlightCanvas.width;var defBubbleColor=me.CONSTANTS.BUBBLE_COLOR.NO_COLORBY_DARK_THEME,strokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_DARK_THEME;if(me.themeMode===me.CONSTANTS.THEME.LIGHT){defBubbleColor=me.CONSTANTS.BUBBLE_COLOR.NO_COLORBY_LIGHT_THEME;strokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_LIGHT_THEME;}var defRadius=Math.max(2,Math.min(12,me.CONSTANTS.MAX_SIZE_DEFAULT_RATIO.SCATTER*0.15*Math.min(me.getWidth(),me.getHeight())));defRadius=defRadius*me.mapScaleFactor;var th=model.th&&model.th[me.colorByIndex];if(me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){var notFoundImageIconPath=me.getFullPath("images/image_not_found.jpg"),defaultImageIconPath=me.getFullPath("images/roundedpp.png");for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}hdrIndex=me.getHeaderIndexFromTouchValue(elem);var propName="imageIcon_"+elem;if(me.hasOwnProperty(propName)){if(hdrIndex>-1){var _image=me[propName];if(_image&&_image.width&&_image.height&&me.getImageIconWidth(_image.width)<me.getWidth()&&me.getImageIconHeight(_image.height)<me.getHeight()){var xOffset=coords[elem][0][0]-me.getImageIconWidth(_image.width)/2+me.leftOffset,yOffset=coords[elem][0][1]-me.getImageIconHeight(_image.height)/2+me.topOffset;me.animationContext.drawImage(_image,xOffset,yOffset,me.getImageIconWidth(_image.width),me.getImageIconHeight(_image.height));}continue;}else{delete me[propName];}}if(th&&hdrIndex>=0&&me.colorByIndex>=0&&me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.IMAGE){lineIndex=me.getLineIndexFromTouchValue(elem);var cellData=lineIndex>-1?model.gvs.items[lineIndex].items[me.colorByIndex]:null;if(cellData.hasOwnProperty("ty")&&parseInt(cellData.ty,10)===4){var iconPath=th.length>cellData.ti&&th[cellData.ti].n;if(iconPath){var fullIconPath=me.getFullPath(iconPath);me[propName]=new Image();me[propName].id=elem;me[propName].onload=function(){if(me.getImageIconWidth(this.width)<me.getWidth()&&me.getImageIconHeight(this.height)<me.getHeight()){var xOffset=coords[this.id][0][0]-me.getImageIconWidth(this.width)/2+me.leftOffset,yOffset=coords[this.id][0][1]-me.getImageIconHeight(this.height)/2+me.topOffset;me.animationContext.drawImage(this,xOffset,yOffset,me.getImageIconWidth(this.width),me.getImageIconHeight(this.height));if(me.totalWidget.shouldHighlightDefaultSelectedNodes&&me.totalWidget.defaultSelectedObjs.hasOwnProperty(me.getLineIndexFromTouchValue(this.id))){me.highlightCanvas.width=me.highlightCanvas.width;var dftSltObjLineIndex,dftSltObjs=me.totalWidget.defaultSelectedObjs;for(dftSltObjLineIndex in dftSltObjs){if(dftSltObjs.hasOwnProperty(dftSltObjLineIndex)){if(me.inThisWidget(dftSltObjLineIndex)){me.highlightImageIcon(me.highlightContext,coords,dftSltObjs[dftSltObjLineIndex].nodeName,0);}}}}}};me[propName].onerror=function(){var meIcon=this;window.setTimeout(function(){me["imageIcon_"+meIcon.id].src=notFoundImageIconPath;},0);};me[propName].src=fullIconPath;}}else{me[propName]=new Image();me[propName].id=elem;me[propName].onload=function(){if(me.getImageIconWidth(this.width)<me.getWidth()&&me.getImageIconHeight(this.height)<me.getHeight()){var xOffset=coords[this.id][0][0]-me.getImageIconWidth(this.width)/2+me.leftOffset,yOffset=coords[this.id][0][1]-me.getImageIconHeight(this.height)/2+me.topOffset;me.animationContext.drawImage(this,xOffset,yOffset,me.getImageIconWidth(this.width),me.getImageIconHeight(this.height));if(me.totalWidget.shouldHighlightDefaultSelectedNodes&&me.totalWidget.defaultSelectedObjs.hasOwnProperty(me.getLineIndexFromTouchValue(this.id))){me.highlightImageIcon(me.highlightContext,coords,this.id,0);}}};me[propName].onerror=function(){var meIcon=this;window.setTimeout(function(){me["imageIcon_"+meIcon.id].src=notFoundImageIconPath;},0);};me[propName].src=defaultImageIconPath;}}else{delete coords[elem];}}}if(!me.imageIconScreenshotTaken&&me.isTablet){me.imageIconScreenshotTaken=true;me.localTakeScreenshot(me.CONSTANTS.RENDERING_TIME);}}else{if(me.markerType===me.CONSTANTS.MARKER_TYPE.BUBBLE){for(elem in coords){if(!coords.hasOwnProperty(elem)){continue;}if(!me.shouldDrawThisBubble(elem)){continue;}var bubbleColor=defBubbleColor,bubbleRadius=defRadius;hdrIndex=me.getHeaderIndexFromTouchValue(elem);if(hdrIndex>=0){if(me.sizeByIndex>=0){bubbleRadius=me.getRadiusFromName(elem);}if(me.colorByIndex>=0&&me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.COLOR){bubbleColor=me.getBubbleColorFromName(elem);if(!bubbleColor){bubbleColor=defBubbleColor;}else{bubbleColor=getOpacityColor(bubbleColor,me.CONSTANTS.BUBBLE_OPACITY.NORMAL);}}var offset={x:me.leftOffset,y:me.topOffset};drawBubble(me.highlightContext,coords[elem][0],offset,bubbleColor,bubbleRadius);drawStroke(me.highlightContext,coords[elem][0],offset,strokeColor,bubbleRadius,me.totalWidget.bubbleStrokeWidth);}else{delete coords[elem];}}}}},inThisWidget:function inThisWidget(lineIndex){return lineIndex>=this.startLine&&lineIndex<=this.endLine;},getOriPolygonCoords:function getOriPolygonCoords(){var me=this,coords=me.coords,oriPolygonCoords={},i,j,k,rgn,c;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){oriPolygonCoords[i]=coords[i];continue;}var arr2=[];rgn=coords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];var arr1=[];for(k=0;k<c.length;k++){arr1.push(c[k]);}arr2.push(arr1);}}oriPolygonCoords[i]=arr2;}}return oriPolygonCoords;},getOriPointCoords:function getOriPointCoords(){var coords=this.coords,oriPointCoords={},point,newPoint,elem;for(elem in coords){if(elem==="bgImage"){oriPointCoords[elem]=coords[elem];continue;}if(coords.hasOwnProperty(elem)){point=coords[elem][0];newPoint=[point[0],point[1]];oriPointCoords[elem]=[newPoint];}}return oriPointCoords;},saveOriCoords:function saveOriCoords(){var me=this;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(!me.hasOwnProperty("oriCoords")||me.oriCoords===undefined){me.oriCoords=me.getOriPolygonCoords();}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){if(!me.hasOwnProperty("oriCoords")||me.oriCoords===undefined){me.oriCoords=me.getOriPointCoords();}}}var mapFileName=this.mapFileName,mapFilePool=this.totalWidget.mapFilePool;if(mapFileName&&mapFilePool.hasOwnProperty(mapFileName)){mapFilePool[mapFileName]=me.oriCoords;}},getOriBubbleSize:function getOriBubbleSize(){var me=this,model=me.model,gvs=model.gvs,gts=model.gts,i,sizeByIndex=me.sizeByIndex;if(me.markerType!==me.CONSTANTS.MARKER_TYPE.BUBBLE){return ;}var bubbleSizeParas=me.totalWidget.getBubbleSizeParas(),maxRadius=bubbleSizeParas.maxRadius,maxValue=bubbleSizeParas.maxValue,minValue=bubbleSizeParas.minValue;var oriBubbleSize={};if(sizeByIndex>=0){var startLine=me.startLine,endLine=me.endLine;if(maxValue>minValue){var minRadius=maxRadius*minValue/maxValue;if(minRadius<2){minRadius=2;}var step=(maxRadius-minRadius)/(maxValue-minValue),radius;for(i=startLine;i<endLine+1;i++){if(i>-1){radius=(Math.abs(parseFloat(gvs.items[i].items[sizeByIndex].rv))-minValue)*step+minRadius;oriBubbleSize[i]=radius;}else{continue;}}}else{for(i=startLine;i<endLine;i++){if(i>-1){oriBubbleSize[i]=maxRadius;}else{continue;}}}}me.oriBubbleSize=oriBubbleSize;},drawBubbleMap:function drawBubbleMap(){var me=this,context=me.animationContext,coords=me.coords,i,pt,oriCoords;me.totalWidget.getAllBubblesColor(me.colorByIndex);me.getOriBubbleSize();if(me.CONSTANTS.DEBUG.LOG){if(me.hasOwnProperty("bgImg")){console.log("\nbgImg exists.");if(me.bgImg.hasOwnProperty("src")){console.log("\nbgImg src: "+me.bgImg.src);}else{console.log("\nbgImg src not exists.");}}else{console.log("\nbgImg not exists.");}}if(me.isBgImgDownloaded){if(me.CONSTANTS.DEBUG.LOG){console.log("\nusing existing bg image.");}me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=me.bgImg.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=me.bgImg.height;}var xRatio=me.bgImg.width/(me.getWidth()-me.totalWidget.borderSpace*2),yRatio=me.bgImg.height/(me.getHeight()-me.totalWidget.borderSpace*2),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()-me.oriBgImageWidth/ratio)/2;context.drawImage(me.bgImg,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);me.saveOriCoords();oriCoords=me.oriCoords;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){var polygonCenters={};for(i in oriCoords){if(oriCoords.hasOwnProperty(i)){if(i==="bgImage"){continue;}polygonCenters[i]=getCentroidOfPolygon(oriCoords[i][0]);polygonCenters[i][0][0]/=ratio;polygonCenters[i][0][1]/=ratio;}}me.polygonCenters=polygonCenters;}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}pt=coords[i][0];pt[0]=parseInt(oriCoords[i][0][0]/ratio,10);pt[1]=parseInt(oriCoords[i][0][1]/ratio,10);}}}}if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE&&me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){me.drawBubblesInMap();}me.highlightPoint();}else{if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(me.isBgImgDownloaded!==undefined&&me.isBgImgDownloaded===false&&me.bgImg&&me.bgImg.onerror){me.bgImg.onerror();}else{if(me.isBgImgDownloaded===undefined){if(me.CONSTANTS.DEBUG.LOG){console.log("\ndownloading new bg image.");}me.bgImg=new Image();me.bgImg.onerror=function(){me.isBgImgDownloaded=false;var errorMessage="The backgrond Image cannot be found.";var localeString=window.getLocaleString?window.getLocaleString("IMAGELAYOUT_HTML_FILE_NOT_FOUNDED","The Image Map / Shape file cannot be found."):mstrmojo.desc(9854,errorMessage);me.renderErrorMessage(localeString);};me.bgImg.onload=function(){me.isBgImgDownloaded=true;if(me.CONSTANTS.DEBUG.PERFORMANCE){var bgImgLoaded=new Date();console.log("\nbgImg load time: "+(bgImgLoaded-bgImgBegin));}me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=this.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=this.height;}var xRatio=this.width/(me.getWidth()-me.totalWidget.borderSpace*2),yRatio=this.height/(me.getHeight()-me.totalWidget.borderSpace*2),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()-me.oriBgImageWidth/ratio)/2;me.animationCanvas.width=me.animationCanvas.width;context.drawImage(this,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);me.saveOriCoords();oriCoords=me.oriCoords;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){var polygonCenters={};for(i in oriCoords){if(oriCoords.hasOwnProperty(i)){if(i==="bgImage"){continue;}polygonCenters[i]=getCentroidOfPolygon(oriCoords[i][0]);polygonCenters[i][0][0]/=ratio;polygonCenters[i][0][1]/=ratio;}}me.polygonCenters=polygonCenters;}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}pt=coords[i][0];pt[0]=parseInt(oriCoords[i][0][0]/ratio,10);pt[1]=parseInt(oriCoords[i][0][1]/ratio,10);}}}}if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE&&me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){me.drawBubblesInMap();}me.highlightPoint();if(!me.bgImageScreenshotTaken&&me.isTablet){me.bgImageScreenshotTaken=true;me.localTakeScreenshot(me.CONSTANTS.RENDERING_TIME);}if(me.CONSTANTS.DEBUG.PERFORMANCE){var drawOver=new Date();console.log("\ndraw BG and bubble time: "+(drawOver-bgImgLoaded));}};}}}}if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(me.isBgImgDownloaded===undefined){if(me.CONSTANTS.DEBUG.PERFORMANCE){var bgImgBegin=new Date();}me.bgImg.src=me.getFullPath(coords.bgImage);if(me.CONSTANTS.DEBUG.LOG){console.log("\nresetting the src of me.bgImg.");}}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){me.drawBgImageFlag=false;me.saveOriCoords();me.scalePolygonCoords();me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.UNDER_BUBBLE);var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}polygonCenters[i]=getCentroidOfPolygon(coords[i][0]);}}me.polygonCenters=polygonCenters;if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE&&me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){me.drawBubblesInMap();}me.highlightPoint();}}},drawAreaMap:function drawAreaMap(){var me=this;if(me.CONSTANTS.DEBUG.PERFORMANCE){var drawBegin=new Date();}var context=me.animationContext,coords=me.coords,i,j,k,rgn,c,oriC;me.saveOriCoords();var oriCoords=me.oriCoords;context.save();context.lineWidth=2;context.strokeStyle="#AAAAAA";if(me.isBgImgDownloaded){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){me.drawBgImageFlag=false;}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=me.bgImg.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=me.bgImg.height;}var xRatio=me.bgImg.width/(me.getWidth()-me.totalWidget.borderSpace*2),yRatio=me.bgImg.height/(me.getHeight()-me.totalWidget.borderSpace*2),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()-me.oriBgImageWidth/ratio)/2;context.drawImage(me.bgImg,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);var oriRgn;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=coords[i];oriRgn=oriCoords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];oriC=oriRgn[j];for(k=0;k<c.length;k++){c[k]=parseInt(oriC[k]/ratio,10);}}}}}var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}polygonCenters[i]=getCentroidOfPolygon(coords[i][0]);}}me.polygonCenters=polygonCenters;me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG);me.highlightPoint();}}}else{if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(me.isBgImgDownloaded!==undefined&&me.isBgImgDownloaded===false&&me.bgImg&&me.bgImg.onerror){me.bgImg.onerror();}else{if(me.isBgImgDownloaded===undefined){me.bgImg=new Image();me.bgImg.onerror=function(){me.isBgImgDownloaded=false;var errorMessage="The backgrond Image cannot be found.";var localeString=window.getLocaleString?window.getLocaleString("IMAGELAYOUT_HTML_FILE_NOT_FOUNDED","The Image Map / Shape file cannot be found."):mstrmojo.desc(9854,errorMessage);me.renderErrorMessage(localeString);};me.bgImg.onload=function(){me.isBgImgDownloaded=true;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){me.drawBgImageFlag=false;}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=this.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=this.height;}var xRatio=this.width/(me.getWidth()-me.totalWidget.borderSpace*2),yRatio=this.height/(me.getHeight()-me.totalWidget.borderSpace*2),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()-me.oriBgImageWidth/ratio)/2;context.drawImage(this,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);var oriRgn;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=coords[i];oriRgn=oriCoords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];oriC=oriRgn[j];for(k=0;k<c.length;k++){c[k]=parseInt(oriC[k]/ratio,10);}}}}}var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}polygonCenters[i]=getCentroidOfPolygon(coords[i][0]);}}me.polygonCenters=polygonCenters;me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG);me.highlightPoint();}}if(!me.bgImageScreenshotTaken&&me.isTablet){me.bgImageScreenshotTaken=true;me.localTakeScreenshot(me.CONSTANTS.RENDERING_TIME);}};}}}}if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(me.isBgImgDownloaded===undefined){if(me.CONSTANTS.DEBUG.PERFORMANCE){var bgImgBegin=new Date();console.log("\nbeforeBgImgLoad: "+(bgImgBegin-drawBegin));}me.bgImg.src=me.getFullPath(coords.bgImage);}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(me.CONSTANTS.DEBUG.PERFORMANCE){var drawPolyBegin=new Date();}me.drawBgImageFlag=false;this.scalePolygonCoords();if(me.CONSTANTS.DEBUG.PERFORMANCE){var scalePolyEnd=new Date();}var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}polygonCenters[i]=getCentroidOfPolygon(coords[i][0]);}}me.polygonCenters=polygonCenters;if(me.CONSTANTS.DEBUG.PERFORMANCE){var polyCenterEnd=new Date();}this.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.NORMAL);this.highlightPoint();if(me.CONSTANTS.DEBUG.PERFORMANCE){var drawPolyEnd=new Date();console.log("\ndrawAreaMap time: "+(drawPolyEnd-drawBegin)+"\n\tscale time: "+(scalePolyEnd-drawBegin)+"\n\tget center time: "+(polyCenterEnd-scalePolyEnd)+"\n\tdraw poly time: "+(drawPolyEnd-polyCenterEnd));}}}context.restore();},getHeaderIndexFromTouchValue:function getHeaderIndexFromTouchValue(touchValue){var hdrIndex=-1,areaBubbleAttrElems=this.areaBubbleAttrElems;if(touchValue&&areaBubbleAttrElems){touchValue=touchValue.toLowerCase();if(areaBubbleAttrElems.hasOwnProperty(touchValue)){hdrIndex=areaBubbleAttrElems[touchValue].headerIndex;}}return hdrIndex;},getNewColorForOpacityChange:function getNewColorForOpacityChange(bgColor,haveBgImage,curColor,curOpacity,destOpacity){var newColor=curColor;if(curOpacity>1||curOpacity<0||destOpacity>1||destOpacity<0){newColor=curColor;}var eps=0.0001,newBgColor=bgColor;if(!bgColor||haveBgImage){newBgColor="#FFFFFF";}if(destOpacity>=curOpacity){if(curOpacity+eps>1){return curColor;}else{newColor=getOpacityColor(curColor,(destOpacity-curOpacity)/(1-curOpacity));}}else{if(destOpacity<curOpacity){if(curOpacity-eps<0){newColor=getOpacityColor(curColor,0);}else{newColor=getOpacityColor(newBgColor,(curOpacity-destOpacity)/curOpacity);}}}return newColor;},drawPartOpacityBG:function drawPartOpacityBG(ctx,coordsArray,bgOpacity){ctx.save();var me=this,offsetX=me.leftOffset||0,offsetY=me.topOffset||0;var getPointAt=function(j){var offset=j%2?offsetY:offsetX;return pointsArray[j]+offset;};ctx.beginPath();var i,j;for(i=0;i<coordsArray.length;i++){var pointsArray=coordsArray[i],minX=getPointAt(0),minY=getPointAt(1),maxY=getPointAt(1),x,y;ctx.moveTo(getPointAt(0),getPointAt(1));for(j=2;j<pointsArray.length-1;j=j+2){x=getPointAt(j);y=getPointAt(j+1);ctx.lineTo(x,y);maxY=Math.max(y,maxY);minY=Math.min(y,minY);minX=Math.min(x,minX);}x=getPointAt(0);y=getPointAt(1);ctx.lineTo(x,y);}ctx.clip();ctx.globalAlpha=bgOpacity;var xRatio=me.oriBgImageWidth/(me.getWidth()-me.totalWidget.borderSpace*2),yRatio=me.oriBgImageHeight/(me.getHeight()-me.totalWidget.borderSpace*2),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()-me.oriBgImageWidth/ratio)/2;ctx.drawImage(me.bgImg,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);ctx.restore();},highlightImageIcon:function highlightImageIcon(hlContext,coords,touchVal,radiusLarger){var me=this,fillColor="RGBA(255,255,255,0.5)",iconName="imageIcon_"+touchVal;if(me.hasOwnProperty(iconName)){var imgIcon=me[iconName],width=me.getImageIconWidth(imgIcon.width)+radiusLarger*2,height=me.getImageIconHeight(imgIcon.height)+radiusLarger*2,xOffset=coords[touchVal][0][0]-width/2+me.leftOffset,yOffset=coords[touchVal][0][1]-height/2+me.topOffset;hlContext.fillStyle=fillColor;hlContext.fillRect(xOffset,yOffset,width,height);drawWhiteRectCorner(hlContext,xOffset,yOffset,width,height);}},shouldHighlightSelector:function(){var totalWidget=this.totalWidget,currSelectedObj=totalWidget.currSelectedObj,currSelectedObjMiniChart=totalWidget.currSelectedObjMiniChart;return totalWidget.hasSelectedObj()&&(currSelectedObjMiniChart===this||(currSelectedObjMiniChart===null&&this.getHeaderIndexFromTouchValue(currSelectedObj.touchVal)>-1))&&(!totalWidget.hasHoverObj()||totalWidget.currHoverObj.touchVal!==currSelectedObj.touchVal||totalWidget.currHoverObjMiniChart!==currSelectedObjMiniChart);},highlightPoint:function highlightPoint(){var me=this,model=me.model,hlContext=me.highlightContext,hdrIndex,fillColor,lineIndex=-1,colorByCellData=null,shouldHighlightDefaultSelectedNodes=me.totalWidget.shouldHighlightDefaultSelectedNodes;me.highlightCanvas.width=me.highlightCanvas.width;if(me.totalWidget.currSelectedObj===null&&!shouldHighlightDefaultSelectedNodes&&me.displayMode===me.CONSTANTS.DISPLAY_MODE.AREA){if(me.drawBgImageFlag){if(me.curPolygonOpacity!==me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG){me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG);}}else{if(me.curPolygonOpacity!==me.CONSTANTS.POLYGON_OPACITY.NORMAL){me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.NORMAL);}}}if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.AREA){var bgColor=me.bgColor,selectedStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_SELECTED_DARK_THEME,hoverStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_HOVER_DARK_THEME,selectedHoverStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_SELECTED_HOVER_DARK_THEME,noAltColor=me.CONSTANTS.POLYGON_COLOR.NO_ALT_DARK_THEME,noColorByColor=me.CONSTANTS.POLYGON_COLOR.NO_COLORBY_DARK_THEME;if(me.themeMode===me.CONSTANTS.THEME.LIGHT){selectedStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_SELECTED_LIGHT_THEME;hoverStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_HOVER_LIGHT_THEME;selectedHoverStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_SELECTED_HOVER_LIGHT_THEME;noAltColor=me.CONSTANTS.POLYGON_COLOR.NO_ALT_LIGHT_THEME;noColorByColor=me.CONSTANTS.POLYGON_COLOR.NO_COLORBY_LIGHT_THEME;}if(model.vp&&model.vp.npc){noAltColor=getOpacityColor("#"+model.vp.npc,me.CONSTANTS.POLYGON_OPACITY.NORMAL);}fillColor=noAltColor;var dftSltObjs=me.totalWidget.defaultSelectedObjs;if(shouldHighlightDefaultSelectedNodes){if(me.curPolygonOpacity!==me.CONSTANTS.POLYGON_OPACITY.UNSELECTED){me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.UNSELECTED);}var i;for(i in dftSltObjs){if(dftSltObjs.hasOwnProperty(i)&&me.inThisWidget(i)){if(me.totalWidget.hasHoverObj()&&me.totalWidget.currHoverObj.lineIndex==i){continue;}else{var hIndex=dftSltObjs[i].headerIndex;if(hIndex>=0){if(me.colorByIndex>=0){if(me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.COLOR){lineIndex=i;colorByCellData=lineIndex>-1?model.gvs.items[lineIndex].items[me.colorByIndex]:null;fillColor=me.totalWidget.getBgColorFromCss(colorByCellData,me.colorByIndex);if(!fillColor){fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.UNSELECTED,me.CONSTANTS.POLYGON_OPACITY.SELECTED_WITH_BG);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.UNSELECTED,me.CONSTANTS.POLYGON_OPACITY.SELECTED_WITHOUT_BG);}drawPoly(hlContext,me.coords[dftSltObjs[i].nodeName],{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}}}fillColor=noAltColor;}else{if(me.totalWidget.hasSelectedObj()){if(me.curPolygonOpacity!==me.CONSTANTS.POLYGON_OPACITY.UNSELECTED){me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.UNSELECTED);}if(me.shouldHighlightSelector()){hdrIndex=me.getHeaderIndexFromTouchValue(me.totalWidget.currSelectedObj.touchVal);if(me.colorByIndex>=0){lineIndex=me.getLineIndexFromTouchValue(me.totalWidget.currSelectedObj.touchVal);colorByCellData=lineIndex>-1?model.gvs.items[lineIndex].items[me.colorByIndex]:null;fillColor=me.totalWidget.getBgColorFromCss(colorByCellData,me.colorByIndex);if(!fillColor){fillColor=noColorByColor;}}else{fillColor=noColorByColor;}if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.UNSELECTED,me.CONSTANTS.POLYGON_OPACITY.SELECTED_WITH_BG);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.UNSELECTED,me.CONSTANTS.POLYGON_OPACITY.SELECTED_WITHOUT_BG);}drawPoly(hlContext,me.coords[me.totalWidget.currSelectedObj.touchVal],{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}}else{if(me.totalWidget.hasLinkObj()&&me.totalWidget.currLinkObjMiniChart===me){if(me.totalWidget.currLinkObj.hasOwnProperty("hdrIndex")){hdrIndex=me.totalWidget.currLinkObj.hdrIndex;}else{hdrIndex=me.getHeaderIndexFromTouchValue(me.totalWidget.currLinkObj.touchVal);}if(hdrIndex>=0){if(me.colorByIndex>=0){if(me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.COLOR){lineIndex=me.getLineIndexFromTouchValue(me.totalWidget.currLinkObj.touchVal);colorByCellData=lineIndex>-1?model.gvs.items[lineIndex].items[me.colorByIndex]:null;fillColor=me.totalWidget.getBgColorFromCss(colorByCellData,me.colorByIndex);if(!fillColor){fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG,me.CONSTANTS.POLYGON_OPACITY.LINKDRILL);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.NORMAL,me.CONSTANTS.POLYGON_OPACITY.LINKDRILL);}drawPoly(hlContext,me.coords[me.totalWidget.currLinkObj.touchVal],{x:me.leftOffset,y:me.topOffset},hoverStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}}}if(me.totalWidget.hasHoverObj()&&me.totalWidget.currHoverObjMiniChart===me){var hvObj=me.totalWidget.currHoverObj;if(hvObj.hasOwnProperty("hdrIndex")){hdrIndex=hvObj.hdrIndex;}else{hdrIndex=me.getHeaderIndexFromTouchValue(hvObj.touchVal);}if(hdrIndex>=0){if(me.colorByIndex>=0){if(me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.COLOR){lineIndex=me.getLineIndexFromTouchValue(hvObj.touchVal);colorByCellData=lineIndex>-1?model.gvs.items[lineIndex].items[me.colorByIndex]:null;fillColor=me.totalWidget.getBgColorFromCss(colorByCellData,me.colorByIndex);if(!fillColor){fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.totalWidget.currSelectedObj!==null||shouldHighlightDefaultSelectedNodes){if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.UNSELECTED,me.CONSTANTS.POLYGON_OPACITY.SELECTED_HOVER_WITH_BG);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.UNSELECTED,me.CONSTANTS.POLYGON_OPACITY.SELECTED_HOVER_WITHOUT_BG);}drawPoly(hlContext,me.coords[me.totalWidget.currHoverObj.touchVal],{x:me.leftOffset,y:me.topOffset},selectedHoverStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}else{if(me.drawBgImageFlag){var bgOpacity=(me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG-me.CONSTANTS.POLYGON_OPACITY.HOVER)/me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG;this.drawPartOpacityBG(hlContext,me.coords[me.totalWidget.currHoverObj.touchVal],bgOpacity);fillColor="RGBA(0,0,0,0)";drawPoly(hlContext,me.coords[me.totalWidget.currHoverObj.touchVal],{x:me.leftOffset,y:me.topOffset},hoverStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.NORMAL,me.CONSTANTS.POLYGON_OPACITY.HOVER);drawPoly(hlContext,me.coords[me.totalWidget.currHoverObj.touchVal],{x:me.leftOffset,y:me.topOffset},hoverStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}}if(me.newRenderFlag){me.newRenderFlag=false;var polygonCenter=me.polygonCenters&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal]&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal][0];if(polygonCenter){var xOnWidget=polygonCenter[0]+me.leftOffset;var yOnWidget=polygonCenter[1]+me.topOffset;me.renderTooltip(this.totalWidget.currHoverObj.touchVal,xOnWidget,yOnWidget,this.totalWidget.currHoverObj.hdrIndex);}}else{me.renderTooltip(this.totalWidget.currHoverObj.touchVal,this.totalWidget.currHoverObj.point.x,this.totalWidget.currHoverObj.point.y,this.totalWidget.currHoverObj.hdrIndex);}}}else{if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE){var selectedStrokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_SELECTED_DARK_THEME,hoverStrokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_HOVER_DARK_THEME,linkdrillStrokColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_LINKDRILL_DARK_THEME,highlightStrokeColor=me.CONSTANTS.BUBBLE_COLOR.HIGHLIGHT_STROKE_COLOR_DARK_THEME,noColorByColor=me.CONSTANTS.BUBBLE_COLOR.NO_COLORBY_DARK_THEME;if(me.themeMode===me.CONSTANTS.THEME.LIGHT){selectedStrokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_SELECTED_LIGHT_THEME;hoverStrokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_HOVER_LIGHT_THEME;linkdrillStrokColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_LINKDRILL_LIGHT_THEME;highlightStrokeColor=me.CONSTANTS.BUBBLE_COLOR.HIGHLIGHT_STROKE_COLOR_LIGHT_THEME;noColorByColor=me.CONSTANTS.BUBBLE_COLOR.NO_COLORBY_LIGHT_THEME;}if(me.markerType===me.CONSTANTS.MARKER_TYPE.BUBBLE){me.drawBubblesInMap();var dftSltObjs=me.totalWidget.defaultSelectedObjs;if(shouldHighlightDefaultSelectedNodes){var i;for(i in dftSltObjs){if(dftSltObjs.hasOwnProperty(i)&&me.inThisWidget(i)){var nodeName=dftSltObjs[i].nodeName;var sltBubbleRadius=me.getRadiusFromName(nodeName);fillColor=me.getBubbleColorFromName(nodeName);if(!fillColor){continue;}fillColor=getOpacityColor(fillColor,me.CONSTANTS.BUBBLE_OPACITY.SELECTED);if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(me.hasOwnProperty("polygonCenters")){sltCoord=me.polygonCenters[nodeName][0];}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){sltCoord=me.coords[nodeName][0];}}drawBubble(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},fillColor,sltBubbleRadius);drawStroke(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,sltBubbleRadius,me.totalWidget.bubbleStrokeWidth);}}fillColor=noColorByColor;}else{if(me.shouldHighlightSelector()){var sltCoord,sltBubbleRadius;sltBubbleRadius=me.getRadiusFromName(me.totalWidget.currSelectedObj.touchVal);fillColor=me.getBubbleColorFromName(me.totalWidget.currSelectedObj.touchVal);if(!fillColor){fillColor=noColorByColor;}fillColor=getOpacityColor(fillColor,me.CONSTANTS.BUBBLE_OPACITY.SELECTED);if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(me.hasOwnProperty("polygonCenters")){sltCoord=me.polygonCenters[me.totalWidget.currSelectedObj.touchVal][0];}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){sltCoord=me.coords[me.totalWidget.currSelectedObj.touchVal][0];}}drawBubble(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},fillColor,sltBubbleRadius);drawStroke(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,sltBubbleRadius,me.totalWidget.bubbleStrokeWidth);}else{if(me.totalWidget.hasLinkObj()&&me.totalWidget.currLinkObjMiniChart===me){var linkCoord,linkBubbleRadius;linkBubbleRadius=me.getRadiusFromName(me.totalWidget.currLinkObj.touchVal);fillColor=me.getBubbleColorFromName(me.totalWidget.currLinkObj.touchVal);if(!fillColor){fillColor=noColorByColor;}fillColor=getOpacityColor(fillColor,me.CONSTANTS.BUBBLE_OPACITY.LINKDRILL);if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(me.hasOwnProperty("polygonCenters")){linkCoord=me.polygonCenters[me.totalWidget.currLinkObj.touchVal][0];}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){linkCoord=me.coords[me.totalWidget.currLinkObj.touchVal][0];}}drawBubble(hlContext,linkCoord,{x:me.leftOffset,y:me.topOffset},fillColor,linkBubbleRadius);drawStroke(hlContext,linkCoord,{x:me.leftOffset,y:me.topOffset},linkdrillStrokColor,linkBubbleRadius,me.totalWidget.bubbleStrokeWidth);drawStroke(hlContext,linkCoord,{x:me.leftOffset,y:me.topOffset},highlightStrokeColor,linkBubbleRadius+me.totalWidget.hoverBubbleRadiusLarger,me.totalWidget.bubbleStrokeWidth);}}}if(me.totalWidget.hasHoverObj()&&me.totalWidget.currHoverObjMiniChart===me){var hoverCoord,hoverBubbleRadius,hoverTouchVal=me.totalWidget.currHoverObj.touchVal;hoverBubbleRadius=me.getRadiusFromName(hoverTouchVal);fillColor=me.getBubbleColorFromName(hoverTouchVal);if(!fillColor){fillColor=noColorByColor;}var nodeStrokeColor=hoverStrokeColor;if((me.totalWidget.currSelectedObj&&me.totalWidget.currSelectedObj.touchVal===hoverTouchVal&&me.totalWidget.currSelectedObjMiniChart===me.totalWidget.currHoverObjMiniChart)||(shouldHighlightDefaultSelectedNodes&&me.totalWidget.defaultSelectedObjs.hasOwnProperty(me.getLineIndexFromTouchValue(hoverTouchVal)))){fillColor=getOpacityColor(fillColor,me.CONSTANTS.BUBBLE_OPACITY.SELECTED);nodeStrokeColor=selectedStrokeColor;}else{fillColor=getOpacityColor(fillColor,me.CONSTANTS.BUBBLE_OPACITY.HOVER);}if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(me.hasOwnProperty("polygonCenters")){hoverCoord=me.polygonCenters[me.totalWidget.currHoverObj.touchVal][0];}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){hoverCoord=me.coords[me.totalWidget.currHoverObj.touchVal][0];}}drawBubble(hlContext,hoverCoord,{x:me.leftOffset,y:me.topOffset},fillColor,hoverBubbleRadius);drawStroke(hlContext,hoverCoord,{x:me.leftOffset,y:me.topOffset},nodeStrokeColor,hoverBubbleRadius,me.totalWidget.bubbleStrokeWidth);drawStroke(hlContext,hoverCoord,{x:me.leftOffset,y:me.topOffset},highlightStrokeColor,hoverBubbleRadius+me.totalWidget.hoverBubbleRadiusLarger,me.totalWidget.bubbleStrokeWidth);if(me.newRenderFlag){me.newRenderFlag=false;var _center;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){_center=me.polygonCenters&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal]&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal][0];}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){_center=me.coords&&me.coords[me.totalWidget.currHoverObj.touchVal]&&me.coords[me.totalWidget.currHoverObj.touchVal][0];}}if(_center){var xOnWidget=_center[0]+me.leftOffset;var yOnWidget=_center[1]+me.topOffset;me.renderTooltip(this.totalWidget.currHoverObj.touchVal,xOnWidget,yOnWidget,this.totalWidget.currHoverObj.hdrIndex);}}else{me.renderTooltip(this.totalWidget.currHoverObj.touchVal,this.totalWidget.currHoverObj.point.x,this.totalWidget.currHoverObj.point.y,this.totalWidget.currHoverObj.hdrIndex);}}}else{if(me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){var coords=me.coords;if(me.hasOwnProperty("polygonCenters")){coords=me.polygonCenters;}var dftSltObjs=me.totalWidget.defaultSelectedObjs;if(shouldHighlightDefaultSelectedNodes){var i;for(i in dftSltObjs){if(dftSltObjs.hasOwnProperty(i)&&me.inThisWidget(i)){me.highlightImageIcon(hlContext,coords,dftSltObjs[i].nodeName,0);}}}else{if(me.shouldHighlightSelector()){var touchVal=me.totalWidget.currSelectedObj.touchVal;me.highlightImageIcon(hlContext,coords,touchVal,0);}else{if(me.totalWidget.hasLinkObj()&&me.totalWidget.currLinkObjMiniChart===me){var touchVal=me.totalWidget.currLinkObj.touchVal;me.highlightImageIcon(hlContext,coords,touchVal,me.totalWidget.hoverBubbleRadiusLarger);}}}if(me.totalWidget.hasHoverObj()&&me.totalWidget.currHoverObjMiniChart===me){var touchVal=me.totalWidget.currHoverObj.touchVal,fillColor="RGBA(255,255,255,0.5)";var iconName="imageIcon_"+touchVal;if(me.hasOwnProperty(iconName)){var imgIcon=me[iconName],width=me.getImageIconWidth(imgIcon.width)+me.totalWidget.hoverBubbleRadiusLarger*2,height=me.getImageIconHeight(imgIcon.height)+me.totalWidget.hoverBubbleRadiusLarger*2,xOffset=coords[touchVal][0][0]-width/2+me.leftOffset,yOffset=coords[touchVal][0][1]-height/2+me.topOffset;hlContext.fillStyle=fillColor;hlContext.fillRect(xOffset,yOffset,width,height);var sltObj=me.totalWidget.currSelectedObj,hvTouchVal=me.totalWidget.currHoverObj.touchVal;if((sltObj!==null&&sltObj.hasOwnProperty("hdrIndex")&&sltObj.hdrIndex>=0&&sltObj.touchVal===hvTouchVal)||(shouldHighlightDefaultSelectedNodes&&me.totalWidget.defaultSelectedObjs.hasOwnProperty(me.getLineIndexFromTouchValue(hvTouchVal)))){}else{drawWhiteRectCorner(hlContext,xOffset,yOffset,width,height);}}if(me.newRenderFlag){me.newRenderFlag=false;var _center;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){_center=me.polygonCenters&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal]&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal][0];}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){_center=me.coords&&me.coords[me.totalWidget.currHoverObj.touchVal]&&me.coords[me.totalWidget.currHoverObj.touchVal][0];}}if(_center){var xOnWidget=_center[0]+me.leftOffset;var yOnWidget=_center[1]+me.topOffset;me.renderTooltip(this.totalWidget.currHoverObj.touchVal,xOnWidget,yOnWidget,this.totalWidget.currHoverObj.hdrIndex);}}else{me.renderTooltip(this.totalWidget.currHoverObj.touchVal,this.totalWidget.currHoverObj.point.x,this.totalWidget.currHoverObj.point.y,this.totalWidget.currHoverObj.hdrIndex);}}}}}}},getTouchValue:function getTouchValue(x,y){var me=this,coords=me.coords,elem,i;if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.AREA){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}var coordsArray=coords[elem],l=coordsArray.length;for(i=0;i<l;i++){if(inPoly(coordsArray[i],x,y)){return elem;}}}}}}else{if(me.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON&&me.hasOwnProperty("polygonCenters")){coords=me.polygonCenters;}var minDistance=Number.MAX_VALUE,touchName="";for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}var coord=coords[elem][0],distance=Math.sqrt((x-coord[0])*(x-coord[0])+(y-coord[1])*(y-coord[1]));if(distance<minDistance){minDistance=distance;touchName=elem;}}}if(minDistance<this.totalWidget.bias){return touchName;}}}return null;},getAreaOrNearestBubble:function(isTap,touchX,touchY){var me=this,coords=me.coords;if(me.CONSTANTS.DEBUG.LOG){console.log("oritouchX:"+touchX+"  oritouchY:"+touchY);}var x=touchX-me.leftOffset,y=touchY-me.topOffset,touchVal;if(isTap&&me.totalWidget.tooltipOn&&me.totalWidget.currHoverObj!==null){var crHP=null;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){crHP=me.polygonCenters&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal]&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal][0];}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){crHP=coords[me.totalWidget.currHoverObj.touchVal]&&coords[me.totalWidget.currHoverObj.touchVal][0];}}if(crHP){var dis=Math.sqrt((x-crHP[0])*(x-crHP[0])+(y-crHP[1])*(y-crHP[1]));if(dis<me.totalWidget.bias){touchVal=me.totalWidget.currHoverObj.touchVal;}else{touchVal=me.getTouchValue(x,y);}}else{touchVal=me.getTouchValue(x,y);}}else{touchVal=me.getTouchValue(x,y);}if(!touchVal){return null;}var hdrIndex=me.getHeaderIndexFromTouchValue(touchVal);var lineIndex=me.getLineIndexFromTouchValue(touchVal);return{touchVal:touchVal,hdrIndex:hdrIndex,lineIndex:lineIndex,point:{x:touchX,y:touchY}};},renderTooltip:function renderTooltip(touchVal,touchX,touchY,hdrIndex){var me=this,model=me.model,tooltipIndex=0,totalWidget=me.totalWidget,tooltip,table,i,j,tr;if(totalWidget.currHoverObjMiniChart!==this){return ;}var lineIndex=me.getLineIndexFromTouchValue(touchVal);tooltip=totalWidget&&totalWidget.imageLayoutTable&&totalWidget.imageLayoutTable.tooltip;table=tooltip&&tooltip.childNodes[0];if(table){table.style.display="none";for(i=0;i<table.childNodes.length;i++){tr=table.childNodes[i];if(tr){tr.style.display="none";tr.childNodes[0].innerHTML="";tr.childNodes[1].innerHTML="";}}}tooltip.style.visibility="visible";if(!me.totalWidget.tooltipOn){me.totalWidget.tooltipOn=true;}var gts=model.gts,leftHtml,rightHtml;if(hdrIndex>=0){var gtsRows=gts.row,ghsRhsItems=model.ghs&&model.ghs.rhs&&model.ghs.rhs.items,attrFormIndices=totalWidget?totalWidget.attrFormIndices:[],afiLength=attrFormIndices.length,idx;for(i=0;i<gtsRows.length;i++){tr=(tooltipIndex<table.childNodes.length)?table.childNodes[tooltipIndex++]:null;if(tr){if(tooltipIndex===1){tr.childNodes[0].style.display="table-cell";tr.childNodes[1].style.textAlign="left";}if(totalWidget&&totalWidget.layoutAttrFormCount===1&&totalWidget.layoutAttrIndex===i){continue;}tr.childNodes[0].style.paddingRight="5px";leftHtml=gtsRows[i].n+":";tr.childNodes[0].innerHTML=leftHtml;rightHtml="";var _indices=i<afiLength?attrFormIndices[i]:null;if(_indices){for(j=0;j<_indices.length;j++){if(totalWidget&&totalWidget.hasMultiAttr&&i===totalWidget.layoutAttrIndex&&j===totalWidget.shapeFileFormIndex){continue;}idx=ghsRhsItems[lineIndex].items[_indices[j]].idx;rightHtml+=gtsRows[i].es[idx].n;if(j!==_indices.length-1){rightHtml+=" ";}}}tr.childNodes[1].innerHTML=rightHtml;tr.style.display="table-row";}}var gtsCol=gts.col;if(gtsCol&&gtsCol.length>0){var units=gtsCol[0].es,values=model.gvs.items[lineIndex].items;for(i=0;i<units.length;i++){tr=(tooltipIndex<table.childNodes.length)?table.childNodes[tooltipIndex++]:null;if(tr){tr.childNodes[0].style.paddingRight="5px";var mv=values[i],v=mv.v;leftHtml=units[i].n+":";tr.childNodes[0].innerHTML=leftHtml;rightHtml=""+v;tr.childNodes[1].innerHTML=rightHtml;tr.style.display="table-row";}}}else{}}else{if(hdrIndex<0){rightHtml=touchVal;tr=(table.childNodes.length>0)?table.childNodes[0]:null;if(tr){tr.childNodes[1].innerHTML=rightHtml;tr.childNodes[0].style.display="none";tr.childNodes[1].style.textAlign="center";tr.style.display="table-row";}}}if(table){table.style.display="table";}if(totalWidget){var subPosition=$DOM.position(this.domNode),totalPosition=$DOM.position(totalWidget.domNode);if(subPosition&&totalPosition){touchX=touchX+(subPosition.x-totalPosition.x);touchY=touchY+(subPosition.y-totalPosition.y);}me.utils.positionTooltip(tooltip,{x:touchX,y:touchY},totalWidget.domNode,totalPosition.bias);}},hideTooltip:function hideTooltip(){this.totalWidget.hideTooltip();},reRender:function reRender(){this.unrender();this.render();},deleteListners:function deleteListners(){var me=this;},unrender:function unrender(ignoreDom){var me=this;me.hasDrawnMap=undefined;if(this._super){this._super(ignoreDom);}me.deleteListners();if(me.highlightContext){delete me.highlightContext;}if(me.animationContext){delete me.animationContext;}if(me._tn){delete me._tn;}},destroy:function destroy(){this.deleteListners();if(this._super){this._super();}}});}());