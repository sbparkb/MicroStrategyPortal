googleMapScript=true;if(typeof (mstrmap)==="undefined"){mstrmap={};}if(typeof (mstrApp)==="undefined"){mstrApp={};}if(typeof (mstrmojo.gmaps)==="undefined"){mstrmojo.gmaps={};}if(!window.console){console={log:function(){}};}(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo.Button","mstrmojo.HBox","mstrmojo.VBox","mstrmojo.SelectBox","mstrmojo.form","mstrmojo.array","mstrmojo.css","mstrmojo.Model","mstrmojo._HasPopup","mstrmojo._CanLoadMapExternalScript","mstrmojo.gmaps.GoogleMapViewer","mstrmojo.Box","mstrmojo.gmaps._CanShowMapToolbar","mstrmojo._VizSelectionHelper","mstrmojo.VisMapBase","mstrmojo._CanDrawHeatMap","mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl","mstrmojo.gmaps._HasContextMenu","mstrmojo._LoadsScript","mstrmojo.gmaps.ObservableModel","mstrmojo.gmaps._CanExportPDF","mstrmojo.gmaps.MapEnums");mstrmojo.requiresDescs(11140,11186,1158);var PRIMARY_DATA_PROVIDER=0;var $EnumMarkerType=mstrmojo.gmaps.EnumMapType,$EnumZoomBehavior=mstrmojo.gmaps.EnumZoomBehavior;var EnumAreaSelectionType={RECTANGLE:1,CIRCLE:2,POLYGON:3};var $CSS=mstrmojo.css,$D=mstrmojo.dom,$A=mstrmojo.array;function createObservableModel(){if(!!this.observableModel&&!this.observableModel.destroyed){this.observableModel.destroy();}var me=this,props=this.getProperties(),om=new mstrmojo.gmaps.ObservableModel({host:me,widgetProps:props});return om;}mstrmojo.gmaps.GoogleMap=mstrmojo.declare(mstrmojo.VisMapBase,[mstrmojo._HasPopup,mstrmojo._CanLoadMapExternalScript,mstrmojo.gmaps._CanShowMapToolbar,mstrmojo._Formattable,mstrmojo._VizSelectionHelper,mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl,mstrmojo.gmaps._CanExportPDF,mstrmojo.gmaps._HasContextMenu],{scriptClass:"mstrmojo.gmaps.GoogleMap",iconClass:"",map:null,googleDiv:null,tempGoogleDiv:null,mapEventListeners:null,docModelListener:null,polygonEventListeners:null,_affinityGlow:false,affinityEnabled:true,affinityLineColors:["#FF0000","#F98435","#EA0F87","#06CCC2"],bolAfterMouseDown:false,bounds:null,curpolygon:null,curpolygonList:null,curpolygonListBounds:null,curpolygonEventListeners:null,loadingCount:0,defaultZoom:null,refitContent:false,path:null,polyline:null,dragStart:false,freeFormPolylineList:null,freeFormPolygonList:null,freeFormEventListeners:null,circleList:null,circleEventListeners:null,enableClickMap:false,enableClickSelect:true,enableZoom:false,fitBoundsTimer:null,min_longitude:180,max_longitude:-180,swlatLng:null,nelatLng:null,MAP_MIN_ZOOM_LEVEL:1,zoomRectangle:null,rectangleLengthLabel:null,rectangleHeightLabel:null,toolBarActive:false,drillable:true,enableDebug:true,enablePopup:true,enableRectangleSelect:false,enableFreeFormSelect:false,enableCircleSelect:false,formatHandlers:{domNode:["left","top","z-index","height","width"]},gridBone:null,gridDataViewer:null,gridKeysMap:null,gridNamesSelectorItems:null,gridParams:null,mstProp:null,grids:null,infoTabDiv:null,infoWindowVisible:true,isCtrl:false,zoomOut:false,startZoom:false,maxBubbleRadius:0,mapMouseDownHandler:null,mouseDownHandler:null,mouseMoveHandler:null,mouseUpHandler:null,nextAffinityLineColorIndex:0,NO_OF_POINTS:20,overlay:null,params:{},_primaryGridIndex:0,registeredSDPKeys:null,secondaryDPFirstAttrColIndex:-1,secondaryDPSecondAttrColIndex:-1,searchBounds:null,startLatLng:null,sdpDataCache:null,title:"",totalLayersRendered:0,widgetProps:null,width:"auto",height:"auto",toolbarId:null,mapTypeData:null,mapStylesCache:null,currentMapStyleId:null,previousMapStyleId:null,mapStyleIds:null,vpNameMappings:{ga:"ga",lat:"flat",lng:"flong"},formatHandlers:{domNode:["RW","T"]},markupString:'<div id="{@id}" title="{@title}" sty="gmap" style="{@domNodeCssText};position:relative;overflow:hidden" mstrAttach:click,mousedown,mouseup,drawEnd><div id="{@id}-toolbar" style="height:30px"></div><div id="{@id}-map" style="height:{@height}px;width:{@width}px;"></div><div id="{@id}-merticSelectDiv"></div><div id="{@id}-clearAllPopupDiv"></div><div id="{@id}-singleSelectPopupDiv"></div><div id="{@id}-legend"></div></div>',markupSlots:{mapDiv:function(){return this.domNode.childNodes[1];},toolBarDiv:function(){return this.domNode.firstChild;},merticSelectDiv:function(){return this.domNode.childNodes[2];},clearAllPopupDiv:function(){return this.domNode.childNodes[3];},singleSelectPopupDiv:function(){return this.domNode.childNodes[4];},legendPlaceholder:function(){return this.domNode.childNodes[5];}},init:function init(props){this._super&&this._super(props);this.mapEventListeners=[];this.polygonEventListeners=[];this.curpolygonList=[];this.curpolygonListBounds=[];this.curpolygonEventListeners=[];this.path=[];this.freeFormPolylineList=[];this.freeFormPolygonList=[];this.freeFormEventListeners=[];this.circleList=[];this.circleEventListeners=[];if($D.isIE9){this.isClientExport=false;}},handleSingleSelection:function handleSingleSelection(apply){for(var i in this.gridDataViewer){if(!!this.gridDataViewer[i].previousState){var viewer=this.gridDataViewer[i];var columnIndex=viewer.previousState.columnIndex;if(apply){viewer.command.applySelection(viewer.savedSliceInfo);viewer.endSelections();}else{viewer.currentSelections[columnIndex]=viewer.previousState.currentSelections;viewer.selectedRowIndices[columnIndex]=viewer.previousState.selectedRowIndices;viewer.highlightedGraphics[columnIndex]=viewer.previousState.highlightedGraphics;var selectedObjList=viewer.previousState.mapObjectsState.selectedObj;var unselectedObjList=viewer.previousState.mapObjectsState.unselectedObj;for(var j in selectedObjList){var mapObj=selectedObjList[j];if(mapObj.onisSelectedChange){mapObj.set("isSelected",true);}else{mapObj.isSelected=true;}if(typeof (mapObj.hili)!=="undefined"){mapObj.setIcon(mapObj.hili);}viewer.addVisSelection(mapObj.attributes.rowIndex);}for(var k in unselectedObjList){var mapObj=unselectedObjList[k];if(mapObj.onisSelectedChange){mapObj.set("isSelected",false);}else{mapObj.isSelected=false;}if(typeof (mapObj.image)!="undefined"){mapObj.setIcon(mapObj.image);}viewer.removeVisSelection(mapObj.attributes.rowIndex);}}viewer.previousState=null;viewer.savedSliceInfo=[];}}this.set("markerSelected",!this.noMarkerSelected());},addGridLayer:function addGridLayer(layerIndex){this.gridDataViewer[layerIndex].render(true,this.refitContent,function(){this.doAreaSearchOnGridLayer(layerIndex);});},arrangeGridLayersVerticalOrderingOnMap:function arrangeGridLayersVerticalOrderingOnMap(){var tempGrid=[],primaryGridIndex;this.grids[0].isPrimary=true;for(var i=this.grids.length-1;i>=0;i--){if(this.grids[i].widgetProps.mtp===$EnumMarkerType.Bubble){tempGrid.unshift(this.grids.splice(i,1)[0]);}else{if(this.grids[i].widgetProps.mtp===$EnumMarkerType.Marker){tempGrid.push(this.grids.splice(i,1)[0]);}}}for(var i=this.grids.length-1;i>=0;i--){if(this.grids[i].widgetProps.mtp===$EnumMarkerType.Density&&this.isCanvasSupported()){tempGrid.unshift(this.grids.splice(i,1)[0]);}else{tempGrid.push(this.grids.splice(i,1)[0]);}}for(var i=0;i<tempGrid.length;i++){if(tempGrid[i].isPrimary&&tempGrid[i].isPrimary==true){primaryGridIndex=i;}}this.grids=tempGrid.slice();return primaryGridIndex;},compareBounds:function compareBounds(bound1,bound2){if(!!bound1&&!!bound2){var ne1=bound1.getNorthEast();var sw1=bound1.getSouthWest();var ne2=bound2.getNorthEast();var sw2=bound2.getSouthWest();if(sw1.lat()==sw2.lat()&&sw1.lng()==sw2.lng()&&ne1.lat()==ne2.lat()&&ne1.lng()==ne2.lng()){return true;}else{return false;}}else{return false;}},lastBounds:null,mstrFitBounds:function mstrFitBounds(bounds){var ne=bounds.getNorthEast(),sw=bounds.getSouthWest(),e=ne.lng(),w=sw.lng(),map=this.map,nw,se,z,myBounds;if(e<0&&w<0&&w<e){myBounds=new google.maps.LatLngBounds();nw=new google.maps.LatLng(ne.lat(),w);se=new google.maps.LatLng(sw.lat(),e);myBounds.extend(nw);myBounds.extend(se);z=map.getZoom();this.map.fitBounds(myBounds);if(map.getZoom()<z){map.setZoom(z);}}else{map.fitBounds(bounds);}},lastZoom:null,targetZoom:null,zooming:false,mstrSyncrhonizedSetZoom:function mstrSyncrhonizedSetZoom(zoom){if(zoom===this.lastZoom){return ;}if(this.zooming){targetZoom=zoom;}else{var me=this;var zoomListener=google.maps.event.addListenerOnce(me.map,"zoom_changed",function(){if(!!me.targetZoom){var newZoomLevel=me.targetZoom;me.mstrSyncrhonizedSetZoom(newZoomLevel);me.targetZoom=null;}else{me.zooming=false;me.lastZoom=null;}});this.map.setZoom(zoom);}},centerMap:function centerMap(){var map=this.map,me=this;if(!this.bounds){return ;}if(!this.lastBounds||this.refitContent===true){this.mstrFitBounds(this.bounds);this.lastBounds=this.bounds;}else{if(this.compareBounds(this.lastBounds,this.bounds)){google.maps.event.trigger(map,"resize");return ;}else{map.setCenter(this.defaultCenter);map.setZoom(this.defaultZoom);this.lastBounds=this.bounds;}}if(this.refitContent){me.zoomChangeBoundsListener=google.maps.event.addListenerOnce(this.map,"bounds_changed",function(){var bounds=me.map.getBounds(),projection=me.overlay.getProjection(),sw,ne,scaleDown,zoom;if(!bounds||!projection){return ;}sw=projection.fromLatLngToContainerPixel(me.swlatLng);ne=projection.fromLatLngToContainerPixel(me.nelatLng);if(sw.x>ne.x&&me.map.getZoom()>me.MAP_MIN_ZOOM_LEVEL){me.map.setCenter(me.bounds.getCenter());me.mstrSyncrhonizedSetZoom(me.MAP_MIN_ZOOM_LEVEL);}else{if(ne.x>parseInt(me.width,10)){scaleDown=Math.max(1,Math.ceil(Math.log(Math.abs(Math.ceil((ne.x-sw.x)/parseInt(me.width,10))))/Math.LN2));zoom=Math.max(me.map.getZoom()-scaleDown,me.MAP_MIN_ZOOM_LEVEL);me.map.setCenter(me.bounds.getCenter());me.mstrSyncrhonizedSetZoom(zoom);me.map.panBy(1,0);}}});}},cleanMap:function cleanMap(){this.hideInfoWindow(null);},clearAllLayerSelections:function clearAllLayerSelections(){for(var i=0;i<this.gridDataViewer.length;i++){var currentGridDataViewer=this.gridDataViewer[i],selectedRowIndices=currentGridDataViewer.getSelectedRowIndices(currentGridDataViewer.getGeoColumnIndex());currentGridDataViewer.clearAllHighlight();currentGridDataViewer.currentSelections={};if(currentGridDataViewer.highlightedGraphics){currentGridDataViewer.highlightedGraphics={};}if(selectedRowIndices&&selectedRowIndices.length>0){currentGridDataViewer.selectedRowIndices={};currentGridDataViewer.clearSelections();currentGridDataViewer.endSelections();var columnIndex;if(currentGridDataViewer._useLatlng){columnIndex=currentGridDataViewer.latColumnIndex;}else{columnIndex=currentGridDataViewer.pointColumnIndex;}var sliceInfo={pos:[columnIndex],elementIndex:[],setViewDataFlag:false,applyControl:true,beanPath:this.beanPath};currentGridDataViewer.command.applySelection(sliceInfo);}}},noMarkerSelected:function noMarkerSelected(){for(var i in this.gridDataViewer){var selections=this.gridDataViewer[i].currentSelections;if(!!selections){for(var j in selections){if(selections[j]&&selections[j].length>0){return false;}}}}return true;},noPolygonsPresentOnMap:function noPolygonsPresentOnMap(){var i,rectangleCount=this.curpolygonList?this.curpolygonList.length:0,freeformLineCount=this.freeFormPolylineList?this.freeFormPolylineList.length:0,circleCount=this.circleList?this.circleList.length:0,polygonVisible=false;if(rectangleCount>0){for(i=0;i<rectangleCount;i++){polygonVisible=this.curpolygonList[i].getMap&&this.curpolygonList[i].getMap();if(polygonVisible){break;}}}if(freeformLineCount>0){for(i=0;i<freeformLineCount;i++){polygonVisible=this.freeFormPolylineList[i].getMap&&this.freeFormPolylineList[i].getMap();if(polygonVisible){break;}}}if(circleCount>0){for(i=0;i<circleCount;i++){polygonVisible=this.circleList[i].getMap&&this.circleList[i].getMap();if(polygonVisible){break;}}}return !polygonVisible;},createClusterBounds:function createClusterBounds(latlng,width,height){var mapBounds=this.map.getBounds();var mapNorthEast=mapBounds.getNorthEast();var mapSouthWest=mapBounds.getSouthWest();var mapEast=mapNorthEast.lng();var mapNorth=mapNorthEast.lat();var mapSouth=mapSouthWest.lat();var mapWest=mapSouthWest.lng();var latDistance=(mapEast>mapWest)?mapEast-mapWest:360+mapEast-mapWest;var pixelPerLng=this.width/latDistance;var pixelPerLat=this.height/(mapNorth-mapSouth);var south=latlng.lat()-height/pixelPerLat;var north=latlng.lat()+height/pixelPerLat;var east=latlng.lng()+width/pixelPerLng;var west=latlng.lng()-width/pixelPerLng;return new google.maps.LatLngBounds(new google.maps.LatLng(south,west),new google.maps.LatLng(north,east));},clearMap:function clearMap(){},createOldFormatWidgetPropsXML:function createOldFormatWidgetPropsXML(){var widgetPropsXml="<widgetProps><fmt>";var k;for(k in this.widgetProps){widgetPropsXml+="<"+k+' value="'+this.encode(this.encode(this.widgetProps[k]))+'" />';}var wps=this.gridDataViewer[this._primaryGridIndex].getWidgetProps();for(k in wps){widgetPropsXml+="<"+k+' value="'+this.encode(this.encode(wps[k]))+'" />';}widgetPropsXml+="</fmt></widgetProps>";return widgetPropsXml;},createSearchBounds:function createSearchBounds(startlatlng,endlatlng){var startlat=startlatlng.lat();var startlng=startlatlng.lng();var endlat=endlatlng.lat();var endlng=endlatlng.lng();var north,south,east,west;if(startlat>endlat){north=startlat;south=endlat;}else{north=endlat;south=startlat;}var projection=this.map.getProjection();var startPoint=projection.fromLatLngToPoint(startlatlng);var endPoint=projection.fromLatLngToPoint(endlatlng);if(startPoint.x<endPoint.x){west=startlng;east=endlng;}else{west=endlng;east=startlng;}return new google.maps.LatLngBounds(new google.maps.LatLng(south,west),new google.maps.LatLng(north,east));},debug:function debug(s){if(this.enableDebug){}},destroy:function destroy(ignoreDom){var dm=this.getDocModel();if(dm&&this.registeredSDPKeys){for(var key in this.registeredSDPKeys){dm.removeSDP(key);}}if(!!this.overlay){this.overlay.draw=function(){};delete this.overlay;}delete this.map;delete this.zonesModel;delete this.edtModel;delete this.mixinParentMapObj;if(mstrmojo._LoadsScript.esScritsContext===this){delete mstrmojo._LoadsScript.esScritsContext;}if(!!this.observableModel){delete this.observableModel.host;this.observableModel.destroy();}this._super(ignoreDom);},doClearRectangle:function doClearRectangle(forceClear){if(!forceClear&&!this.enableRectangleSelect){return ;}var i;this.removeEventListeners(this.polygonEventListeners);this.polygonEventListeners.length=0;for(i=0;i<this.freeFormEventListeners.length;i++){google.maps.event.removeListener(this.freeFormEventListeners[i]);}this.freeFormEventListeners.length=0;for(i=0;i<this.circleEventListeners.length;i++){google.maps.event.removeListener(this.circleEventListeners[i]);}this.circleEventListeners.length=0;if(this.curpolygonList){for(i=0;i<this.curpolygonList.length;i++){this.curpolygonList[i].setMap(null);this.curpolygonListBounds[i]=null;}this.curpolygonList.length=0;}if(this.curpolygonListBounds){this.curpolygonListBounds.length=0;}for(i=0;i<this.freeFormPolylineList.length;i++){this.freeFormPolylineList[i].setMap(null);}this.freeFormPolylineList.length=0;for(i=0;i<this.freeFormPolygonList.length;i++){this.freeFormPolygonList[i].setMap(null);}this.freeFormPolygonList.length=0;for(i=0;i<this.circleList.length;i++){this.circleList[i].setMap(null);}this.circleList.length=0;},drawRectangleEnd:function drawRectangleEnd(event){if(!this.enableRectangleSelect&&!this.enableZoom){return ;}var startlatlng=this.startLatLng,endlatlng;if(event.latLng){endlatlng=event.latLng;}else{endlatlng=this.getLatLngFromPoint(event.clientX,event.clientY);}var path=[new google.maps.LatLng(startlatlng.lat(),startlatlng.lng()),new google.maps.LatLng(endlatlng.lat(),startlatlng.lng()),new google.maps.LatLng(endlatlng.lat(),endlatlng.lng()),new google.maps.LatLng(startlatlng.lat(),endlatlng.lng()),new google.maps.LatLng(startlatlng.lat(),startlatlng.lng())];if(this.enableZoom){this.zoomRectangle.setPath(path);this.zoomRectangle._bounds.extend(endlatlng);var z=this.map.getZoom(),newCenter=this.zoomRectangle._bounds.getCenter();if(!this.zoomOut){if(endlatlng.lat()!=startlatlng.lat()||endlatlng.lng()!=startlatlng.lng()){this.map.fitBounds(this.zoomRectangle._bounds);if(this.map.getZoom()<z){this.map.setZoom(z);}}}else{var newZoom=Math.max(z-1,0);this.map.setCenter(newCenter);this.map.setZoom(newZoom);}var ne=new google.maps.LatLng(startlatlng.lat(),endlatlng.lng());var nw=new google.maps.LatLng(startlatlng.lat(),startlatlng.lng());var sw=new google.maps.LatLng(endlatlng.lat(),startlatlng.lng());var se=new google.maps.LatLng(endlatlng.lat(),endlatlng.lng());var path=[nw,sw,se,ne,nw];this.zoomRectangle.setPath(path);this.positionRectangleLengthLabel(nw,ne);this.positionRectangleHeightLabel(sw,nw);var me=this;var timer=window.setTimeout(function(){me.rectangleLengthLabel.style.display="none";me.rectangleHeightLabel.style.display="none";me.zoomRectangle.setMap(null);me.zoomRectangle=null;},0);}},drawRectangleStart:function drawRectangleStart(event){var startlatlng;if(event.latLng){startlatlng=event.latLng;}else{startlatlng=this.getLatLngFromPoint(event.clientX,event.clientY);}var path=[new google.maps.LatLng(startlatlng.lat(),startlatlng.lng()),new google.maps.LatLng(startlatlng.lat(),startlatlng.lng()),new google.maps.LatLng(startlatlng.lat(),startlatlng.lng()),new google.maps.LatLng(startlatlng.lat(),startlatlng.lng()),new google.maps.LatLng(startlatlng.lat(),startlatlng.lng())];var polygonOptions;if(this.enableZoom){polygonOptions={paths:path,strokeColor:"#68228B",strokeWeight:2,strokeOpacity:1,fillColor:"#696969",fillOpacity:0.3};}var polygon=new google.maps.Polygon(polygonOptions);var that=this;this.polygonEventListeners.push(google.maps.event.addListener(polygon,"mousedown",function(event){that.onMouseDown(event);}));this.polygonEventListeners.push(google.maps.event.addListener(polygon,"mousemove",function(event){that.onMouseMove(event);}));this.polygonEventListeners.push(google.maps.event.addListener(polygon,"mouseup",function(event){that.onMouseUp(event);}));this.startLatLng=startlatlng;if(this.enableZoom){this.zoomRectangle=polygon;this.zoomRectangle._bounds=new google.maps.LatLngBounds();this.zoomRectangle._bounds.extend(startlatlng);this.zoomRectangle.setMap(this.map);if(this.rectangleLengthLabel===null&&this.rectangleHeightLabel===null){this.rectangleLengthLabel=document.createElement("div");this.rectangleHeightLabel=document.createElement("div");this.rectangleHeightLabel.id="rectangleHeightLabel";this.mapDiv.appendChild(this.rectangleLengthLabel);this.mapDiv.appendChild(this.rectangleHeightLabel);$CSS.addClass(this.rectangleLengthLabel,"dimensionLabel");$CSS.addClass(this.rectangleHeightLabel,"dimensionLabel");}this.rectangleLengthLabel.style.display="none";this.rectangleHeightLabel.style.display="none";var lengthLabelMoveListener=google.maps.event.addDomListener(this.rectangleLengthLabel,"mousemove",function(event){that.onMouseMove(event);});var heightLabelMoveListener=google.maps.event.addDomListener(this.rectangleHeightLabel,"mousemove",function(event){that.onMouseMove(event);});var lengthLabelListener=google.maps.event.addDomListener(this.rectangleLengthLabel,"mouseup",function(event){that.onMouseUp(event);google.maps.event.removeListener(lengthLabelListener);google.maps.event.removeListener(lengthLabelMoveListener);google.maps.event.removeListener(heightLabelListener);google.maps.event.removeListener(heightLabelMoveListener);});var heightLabelListener=google.maps.event.addDomListener(this.rectangleHeightLabel,"mouseup",function(event){that.onMouseUp(event);google.maps.event.removeListener(heightLabelListener);google.maps.event.removeListener(heightLabelMoveListener);google.maps.event.removeListener(heightLabelListener);google.maps.event.removeListener(heightLabelMoveListener);});}},encode:function encode(oldStr,toServer){var sb=oldStr;if(toServer==null){toServer=false;}if((oldStr!=null)&&(oldStr.length>0)){sb="";for(var i=0,len=oldStr.length;i<len;i++){switch(oldStr.charAt(i)){case"&":if((oldStr.length!=(i+1))&&(oldStr.charAt(i+1)=="#")){sb+="&";}else{sb+="&amp;";}break;case"<":sb+="&lt;";break;case">":sb+="&gt;";break;case"'":sb+="&#039;";break;case"\n":if(!toServer){sb+="<br />";}else{sb+=oldStr.charAt(i);}break;case'"':sb+="&quot;";break;case" ":if(i==0||(i<oldStr.length-1&&oldStr.charAt(i+1)==" ")){sb+="&nbsp;";}else{sb+=oldStr.charAt(i);}break;default:sb+=oldStr.charAt(i);break;}}}return sb;},findPointsOnArc:function findPointsOnArc(from,to){var nPoints=this.NO_OF_POINTS;var coords=[];var radToDeg=180/Math.PI;var lat1=from.lat()/radToDeg;var lng1=from.lng()/radToDeg;var lat2=to.lat()/radToDeg;var lng2=to.lng()/radToDeg;var degree=2*Math.asin(Math.sqrt(Math.pow((Math.sin(lat1-lat2)/2),2)+Math.cos(lat1)*Math.cos(lat2)*Math.pow((Math.sin(lng1-lng2)/2),2)));var i;for(i=0;i<=this.NO_OF_POINTS;i++){var f=Number(i/nPoints);var a=Math.sin((1-f)*degree)/Math.sin(degree);var b=Math.sin(f*degree)/Math.sin(degree);var x=a*Math.cos(lat1)*Math.cos(lng1)+b*Math.cos(lat2)*Math.cos(lng2);var y=a*Math.cos(lat1)*Math.sin(lng1)+b*Math.cos(lat2)*Math.sin(lng2);var z=a*Math.sin(lat1)+b*Math.sin(lat2);var rLat=Math.atan2(z,Math.sqrt(Math.pow(x,2)+Math.pow(y,2)));var rLng=Math.atan2(y,x);coords[i]=new google.maps.LatLng(rLat*radToDeg,rLng*radToDeg);}return coords;},findPointsOnLine:function findPointsOnLine(from,to){var m=Infinity;var c;var pts=[];var interval;var lat;var lng;var i;if(to.lng()-from.lng()!=0){m=(to.lat()-from.lat())/(to.lng()-from.lng());c=from.lat()-m*from.lng();interval=(to.lng()-from.lng())/this.NO_OF_POINTS;}else{interval=(to.lat()-from.lat())/this.NO_OF_POINTS;}for(i=0;i<=this.NO_OF_POINTS;i++){if(m===Infinity){lng=from.lng();lat=from.lat()+interval*i;}else{lng=from.lng()+interval*i;lat=m*lng+c;}pts[i]=new google.maps.LatLng(lat,lng);}return pts;},findWrapperDom:function findWrapperDom(){return this.domNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode;},fnGetWidget:function(_key){for(var i in mstrmojo.all){if(mstrmojo.all[i].k===_key){return mstrmojo.all[i];}}return null;},getBeanPath:function getBeanPath(){var beanPath=this.gridParams.beanPath;if(this.gridParams.isRW&&(typeof (microstrategy)!="undefined")){this.gridBone=microstrategy.bone(this.gridParams.boneId);if(!!this.gridBone){beanPath=this.gridBone.getDocViewer().beanPath;}}return beanPath;},getGeoIndex:function getGeoIndex(){return this.shapePosition;},getLatLngFromPoint:function getLatLngFromPoint(x,y){var position=mstrmojo.dom.position(this.domNode,true),xCord=x-position.x,yCord=y-position.y;var point=this.overlay.getProjection().fromContainerPixelToLatLng(new google.maps.Point(xCord,yCord));return point;},getNextDefaultAffinityLineColor:function getNextDefaultAffinityLineColor(){var colorIndex=this.nextAffinityLineColorIndex++;return this.affinityLineColors[colorIndex%(this.affinityLineColors.length-1)];},getPrimaryGridViewer:function getPrimaryGridViewer(){return this.gridDataViewer[this._primaryGridIndex];},getProperties:function getProperties(key){return this.getVisProps(key);},handleAffinityAnimationKeyUp:function handleAffinityAnimationKeyUp(){for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].handleAffinityAnimationKeyUp();}},hideInfoWindow:function hideInfoWindow(evt){if(this.infowindow){this.infowindow.close();}},initMultipleDataProviders:function initMultipleDataProviders(gridParams){this.loadWidgetPropsAndGridData();this._primaryGridIndex=this.arrangeGridLayersVerticalOrderingOnMap();if(!this.grids){return ;}this.gridDataViewer=[];this.gridNamesSelectorItems=[];this.registeredSDPKeys=[];var key,xtab,dm=this.getDocModel();this.gridKeysMap={};for(i=0;i<this.grids.length;i++){key=this.grids[i]["grid1"].k;xtab=this.fnGetWidget(key);this.gridDataViewer[i]=new mstrmojo.gmaps.GoogleMapViewer({parent:this,grids:this.grids[i],data:this.grids[i].grid1,defn:xtab&&xtab.defn,widgetProps:this.grids[i].widgetProps,k:key,gridParams:gridParams,isPrimary:(i==this._primaryGridIndex)?true:false,model:xtab&&xtab.model,map:this.map,layerIndex:i,dropZones:this.getDropZones(key)});this.gridKeysMap[key]=i;this.gridNamesSelectorItems.push({v:i,n:this.grids[i]["grid1"].n,id:key});if(this.grids[i]["grid2"]){if(dm){dm.addSDP(this.grids[i]["grid2"].k,{k:this.grids[this._primaryGridIndex]["grid1"].k,visName:this.grids[this._primaryGridIndex]["grid1"].visName});this.registeredSDPKeys.push(this.grids[i]["grid2"].k);}}if(!this.gridDataViewer[i].isPrimary){if(dm){dm.addSDP(key,{k:this.grids[this._primaryGridIndex]["grid1"].k,visName:this.grids[this._primaryGridIndex]["grid1"].visName});this.registeredSDPKeys.push(key);}}this.addDisposable(this.gridDataViewer[i]);}this.prepareDivs();},isAsp:function isAsp(){return(microstrategy.servletName.indexOf("aspx")!=-1);},isCanvasSupported:function isCanvasSupported(){var elem=document.createElement("canvas");return !!(elem.getContext&&elem.getContext("2d"));},isToolbarPositionFixed:function isToolbarPositionFixed(){return false;},isDHTMLinIE:function(){var appVer=window.navigator.appVersion;var isIE=(appVer.indexOf("MSIE")!==-1||appVer.indexOf("Trident/")>0)?true:false;if(this.gridParams.isRW&&(typeof (microstrategy)!="undefined")&&isIE){return true;}return false;},setPosition:function setPosition(){},loadGoogleMap:function loadGoogleMap(mapping){var model=this.getData(),mapTypeIdsCustomized=[google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.TERRAIN,google.maps.MapTypeId.HYBRID];if(this.isOIVM()){this.setPosition();}for(var i in model.mstProp){mapTypeIdsCustomized.push(i);}this.mapStyleIds=mapTypeIdsCustomized;var isDHTMLinIE=this.isDHTMLinIE();if(isDHTMLinIE||!this.map){if(isDHTMLinIE&&!!this.map){this.doClearRectangle(true);this.unrenderGridViewer();}this.bounds=new google.maps.LatLngBounds(null);var latlng=new google.maps.LatLng(31,-97);var myOptions={center:latlng,minZoom:2,maxZoom:16,zoom:4,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:false,panControl:false,streetViewControl:false};var controlOptions=null;this.mapStylesCache=[];this.mapStylesCache.push({n:"Road Map",id:google.maps.MapTypeId.ROADMAP});this.mapStylesCache.push({n:"Satellite",id:google.maps.MapTypeId.SATELLITE});this.mapStylesCache.push({n:"Terrain",id:google.maps.MapTypeId.TERRAIN});this.mapStylesCache.push({n:"Hybrid",id:google.maps.MapTypeId.HYBRID});if(model.vp!==undefined&&model.vp.mvo!=="0"){controlOptions={style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,mapTypeIds:mapTypeIdsCustomized};myOptions.mapTypeControlOptions=controlOptions;}if(model.vp!==undefined&&model.vp.zb==="0"){myOptions.zoomControl=false;}this.googleDiv=document.createElement("div");this.tempGoogleDiv=document.createElement("div");this.googleDiv.style.height=parseInt(this.height)+"px";this.googleDiv.style.width=parseInt(this.width)+"px";this.map=new google.maps.Map(this.googleDiv,myOptions);this.googleDiv.style.position="absolute";this.googleDiv.style.top="0px";this.googleDiv.style.left="0px";this.overlay=new google.maps.OverlayView();this.overlay.draw=function(){};this.overlay.setMap(this.map);this.loadMapTheme();this.infowindow=new google.maps.InfoWindow({content:"",hasShadow:false,maxWidth:400});this._isInitial=true;}else{this.doClearRectangle(true);this.unrenderGridViewer();var previousWidth=this.googleDiv.style.width,previousHeight=this.googleDiv.style.height;this.googleDiv.style.width=parseInt(this.width)+"px";this.googleDiv.style.height=parseInt(this.height)+"px";this.googleDiv.style.position="absolute";this.googleDiv.style.top="0px";this.googleDiv.style.left="0px";this._isInitial=false;}this.refitContent=model.vp.rosa===$EnumZoomBehavior.Automatic?true:false;var mapStyleIdx,mapStyleId;if(model.vp.dv!==undefined){mapStyleIdx=parseInt(model.vp.dv);if(isNaN(mapStyleIdx)){mapStyleIdx=0;}mapStyleId=mapTypeIdsCustomized[mapStyleIdx]||null;if(mapStyleId!==this.previousMapStyleId){this.map.setMapTypeId(mapStyleId);this.currentMapStyleId=null;}else{if(!!this.currentMapStyleId&&!!this.mapStylesCache){this.map.setMapTypeId(this.currentMapStyleId);}else{this.map.setMapTypeId(mapStyleId);}}}else{if(!!this.currentMapStyleId&&!!this.mapStylesCache){this.map.setMapTypeId(this.currentMapStyleId);}else{this.map.setMapTypeId(google.maps.MapTypeId.ROADMAP);}}this.previousMapStyleId=mapStyleId;this.mapDiv.appendChild(this.googleDiv);this.initMultipleDataProviders(this.gridParams);this.updatePropertiesEditor();this.getDataLabelMetricConfig();for(var i=0,len=this.gridDataViewer.length;i<len;i++){try{var viewer=this.gridDataViewer[i];viewer.render(false,true);if(viewer.postBuildRendering){viewer.postBuildRendering();}}catch(e){mstrmojo.alert(e);}}var that=this;this.mapEventListeners.push(google.maps.event.addListener(this.map,"bounds_changed",function(event){var map=that.map,bounds=map.getBounds();if(!that._isInitial&&that.lastBounds&&that.lastBounds.equals(bounds)){map.setZoom(that.defaultZoom);}that.bounds=bounds;that.defaultCenter=map.getCenter();that.defaultZoom=map.getZoom();}));mstrApp.docModel&&mstrApp.docModel.attachEventListener("secondaryDataSliced",this.id,function(evt){that.onSecondaryDataSliced(evt.key,evt.data);});this.mapEventListeners.push(google.maps.event.addListener(this.map,"mouseup",function(event){that.hideInfoWindow(event);for(var i=0,len=that.gridDataViewer.length;i<len;i++){that.gridDataViewer[i].handleMapOnMouseUp();}}));this.mapEventListeners.push(google.maps.event.addListener(this.map,"click",function(event){var clearAllIsDisabled=that.isClearAllDisabled();if(!that.enableClickMap&&!clearAllIsDisabled){that.clearAllLayerSelections();}else{that.enableClickMap=false;}}));this.mapEventListeners.push(google.maps.event.addDomListener(this.mapDiv,"mousedown",function(event){that.isCtrlClick=event.ctrlKey;}));this.mapEventListeners.push(google.maps.event.addListener(this.map,"rightclick",function(event){that.onRightClick(event);}));this.mapEventListeners.push(google.maps.event.addListener(this.overlay,"projection_changed",function(event){for(var i=0,len=that.gridDataViewer.length;i<len;i++){that.gridDataViewer[i].doPostMapRendering();}}));this.mapEventListeners.push(google.maps.event.addListener(this.map,"zoom_changed",function(event){for(var i=0,len=that.gridDataViewer.length;i<len;i++){that.gridDataViewer[i].doPostMapRendering();}that.defaultZoom=that.map.getZoom();}));this.mapEventListeners.push(google.maps.event.addListener(this.map,"idle",function(event){for(var i=0,len=that.gridDataViewer.length;i<len;i++){that.gridDataViewer[i].reBuildDataLebels();}var mapCenter=that.map.getCenter();google.maps.event.trigger(that.map,"resize");that.map.setCenter(mapCenter);}));},loadMapTheme:function loadMapTheme(){var mstProp=this.getData().mstProp;var nameList={4:"Desert",5:"Blank",6:"Ice",7:"Dark",8:"Nature",9:"Arctic"};var orderList=["4","5","6","8","9","7"];var mapTypeList={};for(var i in mstProp){mapTypeList[i]=new google.maps.StyledMapType(eval("("+mstProp[i]+")"),{name:nameList[i]});}for(var i in orderList){var id=orderList[i];this.map.mapTypes.set(id,mapTypeList[id]);this.map.setMapTypeId(id);this.mapStylesCache.push({n:mapTypeList[id].name,id:id,v:id+""});}},loadWidgetPropsAndGridData:function loadWidgetPropsAndGridData(){var M=this.getData(),sdpKey,i;if(!this.sdpDataCache&&!!M.sdp){this.sdpDataCache=M.sdp;}else{if(!!M.vp.sgProps&&!M.sdp){if(!!this.sdpDataCache){M.sdp=this.sdpDataCache;}}}this.grids=[];this.widgetProps=this.getProperties();this.parseDataLabelProperties();this.grids[0]={grid1:M,grid2:null,widgetProps:this.widgetProps};sdpKey=M.vp.ag;if(sdpKey&&M.sdp&&M.sdp[sdpKey]){this.grids[0].grid2=M.sdp[sdpKey];}i=1;if(M.vp.sgProps){for(var key in M.vp.sgProps){if(M.sdp&&M.sdp[key]){this.grids[i]={grid1:M.sdp[key],grid2:null,widgetProps:this.getProperties(key)};sdpKey=this.grids[i].grid1.ag;if(sdpKey&&M.sdp[sdpKey]){this.grids[i].grid2=M.sdp[sdpKey];}i++;}}}},onAffinityAnimationModeChange:function onAffinityAnimationModeChange(){for(var ind=0;ind<this.gridDataViewer.length;ind++){this.gridDataViewer[ind].onAffinityAnimationModeChange();}},onenablePopupChange:function onenablePopupChange(){this.hideInfoWindow(null);},onenableRectangleSelectChange:function onenableRectangleSelectChange(){if(this.enableRectangleSelect){this.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.RECTANGLE,drawingControl:false,drawingControlOptions:{drawingModes:[google.maps.drawing.OverlayType.RECTANGLE]},rectangleOptions:{editable:false,strokeColor:"#5aa3c0",strokeWeight:2,fillColor:"#53D4FC",fillOpacity:0.6}});this.drawingManager.setMap(this.map);var that=this;this.overlaycompleteHandler=google.maps.event.addListener(this.drawingManager,"rectanglecomplete",function(rect){that.curpolygonList.push(rect);var rectMouseRightClickListener=google.maps.event.addListener(rect,"rightclick",function(evt){var targetConfig={type:that.EnumContextMenuTargetType.SelectionArea,object:null};that.onRightClick(evt,targetConfig);});that.curpolygonEventListeners.push(rectMouseRightClickListener);var selectionType=EnumAreaSelectionType.RECTANGLE;for(var i=0,len=that.gridDataViewer.length;i<len;i++){that.gridDataViewer[i].drawRectangleEnd(rect,selectionType);}if(!that.canShowSelectionArea()){rect.setMap(null);}that.set("markerSelected",!that.noMarkerSelected());that.setToolbarState(0);});}else{google.maps.event.removeListener(this.overlaycompleteHandler);this.drawingManager.setDrawingMode(null);this.drawingManager=null;}},onenableZoomChange:function onenableZoomChange(){if(this.enableZoom){this.attachMouseListeners();}else{this.detachMouseListeners();this.startZoom=false;}},onenableFreeFormSelectChange:function onenableFreeFormSelectChange(){if(this.enableFreeFormSelect){$CSS.addClass(this.mapDiv,"cursorDrawingArea");this.attachMouseListeners();}else{$CSS.removeClass(this.mapDiv,"cursorDrawingArea");this.detachMouseListeners();}},attachMouseListeners:function attachMouseListeners(){this.toggleDragging(false);var that=this;this.mouseDownHandler=google.maps.event.addListener(this.map,"mousedown",function(evt){that.onMouseDown(evt);});this.mouseMoveHandler=google.maps.event.addListener(this.map,"mousemove",function(evt){that.onMouseMove(evt);});this.mouseUpHandler=google.maps.event.addListener(this.map,"mouseup",function(evt){that.onMouseUp(evt);});},detachMouseListeners:function detachMouseListeners(){this.toggleDragging(true);if(this.mouseDownHandler){google.maps.event.removeListener(this.mouseDownHandler);this.mouseDownHandler=null;}if(this.mouseMoveHandler){google.maps.event.removeListener(this.mouseMoveHandler);this.mouseMoveHandler=null;}if(this.mouseUpHandler){google.maps.event.removeListener(this.mouseUpHandler);this.mouseUpHandler=null;}},onenableCircleSelectChange:function onenableCircleSelectChange(){if(this.enableCircleSelect){this.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.CIRCLE,drawingControl:false,drawingControlOptions:{drawingModes:[google.maps.drawing.OverlayType.CIRCLE]},circleOptions:{editable:false,strokeColor:"#5aa3c0",strokeWeight:2,fillColor:"#53D4FC",fillOpacity:0.6}});this.drawingManager.setMap(this.map);var that=this;this.overlaycompleteHandler=google.maps.event.addListener(this.drawingManager,"circlecomplete",function(circle){that.circleList.push(circle);var circleMouseRightClickListener=google.maps.event.addListener(circle,"rightclick",function(evt){var targetConfig={type:that.EnumContextMenuTargetType.SelectionArea,object:null};that.onRightClick(evt,targetConfig);});that.circleEventListeners.push(circleMouseRightClickListener);var selectionType=EnumAreaSelectionType.CIRCLE;for(var i=0,len=that.gridDataViewer.length;i<len;i++){that.gridDataViewer[i].drawRectangleEnd(circle,selectionType);}if(!that.canShowSelectionArea()){circle.setMap(null);}that.set("markerSelected",!that.noMarkerSelected());that.setToolbarState(0);});}else{google.maps.event.removeListener(this.overlaycompleteHandler);this.drawingManager.setDrawingMode(null);this.drawingManager=null;}},onMouseDown:function onMouseDown(event){if(this.toolbarStateChanged){return ;}if(this.enableRectangleSelect||this.enableZoom){if(this.enableZoom&&(event.latLng==undefined&&event.button==2||event.Sa!=undefined&&event.Sa.button==2)){return ;}if(this.enableZoom){this.startZoom=true;this.zoomOut=this.isCtrl;}this.bolAfterMouseDown=true;this.drawRectangleStart(event);}else{if(this.enableFreeFormSelect){this.path=[];this.path.push(event.latLng);this.polyline=new google.maps.Polyline({paths:this.path,strokeColor:"#5aa3c0",strokeWeight:2,strokeOpacity:1});this.freeFormPolylineList.push(this.polyline);this.polyline.setMap(this.map);this.dragStart=true;var that=this;var freeFormMouseupListener=google.maps.event.addListener(this.polyline,"mouseup",function(evt){that.onMouseUp(evt);});var freeFormMouseMoveListener=google.maps.event.addListener(this.polyline,"mousemove",function(evt){that.onMouseMove(evt);});this.freeFormEventListeners.push(freeFormMouseupListener,freeFormMouseMoveListener);this.enableClickMap=true;}else{return ;}}},onMouseMove:function onMouseMove(event){if(this.enableRectangleSelect||this.enableZoom){var startlatlng=this.startLatLng;var currentLatLng;if(event.latLng){currentLatLng=event.latLng;}else{currentLatLng=this.getLatLngFromPoint(event.clientX,event.clientY);}if(this.bolAfterMouseDown){var nw=new google.maps.LatLng(startlatlng.lat(),startlatlng.lng()),sw=new google.maps.LatLng(currentLatLng.lat(),startlatlng.lng()),se=new google.maps.LatLng(currentLatLng.lat(),currentLatLng.lng()),ne=new google.maps.LatLng(startlatlng.lat(),currentLatLng.lng()),path=[nw,sw,se,ne,nw];if(this.enableZoom){this.zoomRectangle.setPath(path);var area=Math.round(google.maps.geometry.spherical.computeLength([nw,ne])/1500);this.positionRectangleLengthLabel(nw,ne);this.rectangleLengthLabel.innerHTML=area+" "+mstrmojo.desc(11140,"Miles");area=Math.round(google.maps.geometry.spherical.computeLength([nw,sw])/1500);this.positionRectangleHeightLabel(sw,nw);this.rectangleHeightLabel.innerHTML=area+" "+mstrmojo.desc(11140,"Miles");if(this.rectangleLengthLabel.style.display==="none"&&this.rectangleHeightLabel.style.display==="none"){this.rectangleLengthLabel.style.display="inline-block";this.rectangleHeightLabel.style.display="inline-block";}}}}else{if(this.enableFreeFormSelect){if(this.dragStart){this.path.push(event.latLng);this.polyline.setPath(this.path);}}else{return ;}}},onMouseUp:function onMouseUp(event){if(this.toolbarStateChanged){return ;}if(this.enableRectangleSelect||this.enableZoom){if(this.enableZoom&&(event.latLng==undefined&&event.button==2||event.Sa!=undefined&&event.Sa.button==2)){return ;}this.bolAfterMouseDown=false;this.drawRectangleEnd(event);if(!this.enableClickSelect){this.setToolbarState(0);}if(this.enableZoom){this.set("enableZoom",false);}}else{if(this.enableFreeFormSelect){if(this.dragStart){this.path.push(event.latLng);this.polyline.setPath(this.path);var polygon=new google.maps.Polygon({paths:this.path,strokeColor:"#5aa3c0",strokeWeight:2,strokeOpacity:1,fillColor:"#53D4FC",fillOpacity:0.6});this.freeFormPolygonList.push(polygon);var selectionType=EnumAreaSelectionType.POLYGON;for(var i=0,len=this.gridDataViewer.length;i<len;i++){this.gridDataViewer[i].drawRectangleEnd(polygon,selectionType);}polygon.setMap(this.map);var that=this;var freeFormMouseRightClickListener=google.maps.event.addListener(polygon,"rightclick",function(evt){var targetConfig={type:that.EnumContextMenuTargetType.SelectionArea,object:null};that.onRightClick(evt,targetConfig);});this.freeFormEventListeners.push(freeFormMouseRightClickListener);this.dragStart=false;if(!this.canShowSelectionArea()){polygon.setMap(null);this.polyline.setMap(null);}this.set("markerSelected",!this.noMarkerSelected());}this.setToolbarState(0);}else{return ;}}},onRightClick:function onRightClick(event,targetConfig){var i,layer,layerCount=this.gridDataViewer?this.gridDataViewer.length:0,densityLayer=null;if(this.toolbarStateChanged){return ;}if(!targetConfig||targetConfig.type===this.EnumContextMenuTargetType.BlankSpace){for(i=0;i<layerCount;i++){layer=this.gridDataViewer[i];if(layer.densityLayer){densityLayer=layer.densityLayer;break;}}if(densityLayer){var latlng=event.latLng;var overlayProjection=this.overlay.getProjection();if(!latlng||!overlayProjection){return ;}var pixLL=overlayProjection.fromLatLngToDivPixel(latlng);var cluster=densityLayer.getAttrsFromLocationMapRange(Math.ceil(pixLL.x),Math.ceil(pixLL.y),5);if(cluster.length>0){targetConfig={type:this.EnumContextMenuTargetType.DensityGraphic,object:cluster};}}}if(!targetConfig){targetConfig={type:this.EnumContextMenuTargetType.BlankSpace,object:null};}this.showMenu(event,targetConfig);},getMousePositionFromEvent:function getMousePositionFromEvent(event){var propName,prop,position=null;if((event.clientX!==undefined)&&(event.clientY!==undefined)){position={x:event.clientX,y:event.clientY};}else{for(propName in event){prop=event[propName];if(!!prop&&(prop.clientX!==undefined)&&(prop.clientY!==undefined)){position={x:prop.clientX,y:prop.clientY};break;}}}if(!position&&event.latLng){var point=this.overlay.getProjection().fromLatLngToContainerPixel(event.latLng);var mapLocation=mstrmojo.dom.position(this.mapDiv);position={x:mapLocation.x+point.x,y:mapLocation.y+point.y};}return position;},positionRectangleLengthLabel:function positionRectangleLengthLabel(nw,ne){var nePos=this.overlay.getProjection().fromLatLngToContainerPixel(ne);var nwPos=this.overlay.getProjection().fromLatLngToContainerPixel(nw);var xPos=Math.abs(nwPos.x+(nePos.x-nwPos.x)/2);var lengthLabelCssObject=$CSS.getComputedStyle(this.rectangleLengthLabel),lengthLabelHeight=Math.abs(this.getPropertyValue(lengthLabelCssObject,"height")),lengthLabelWidth=Math.abs(this.getPropertyValue(lengthLabelCssObject,"width")),lengthLabelPadding=Math.abs(this.getPropertyValue(lengthLabelCssObject,"padding")),lengthLabelBorder=Math.abs(this.getPropertyValue(lengthLabelCssObject,"border"));if(Math.abs(nePos.x-nwPos.x)<2*lengthLabelWidth){this.rectangleLengthLabel.style.left=nwPos.x+"px";}else{this.rectangleLengthLabel.style.left=xPos+"px";}this.rectangleLengthLabel.style.top=nePos.y-(lengthLabelHeight+2*lengthLabelPadding+2*lengthLabelBorder)+"px";},positionRectangleHeightLabel:function positionRectangleHeightLabel(sw,nw){var swPos=this.overlay.getProjection().fromLatLngToContainerPixel(sw);var nwPos=this.overlay.getProjection().fromLatLngToContainerPixel(nw);var yPos=Math.abs(nwPos.y+(swPos.y-nwPos.y)/2),ROTATE_BIAS=28;var heightLabelCssObject=$CSS.getComputedStyle(this.rectangleHeightLabel),heightLabelHeight=Math.abs(this.getPropertyValue(heightLabelCssObject,"height")),heightLabelWidth=Math.abs(this.getPropertyValue(heightLabelCssObject,"width")),heightLabelPadding=Math.abs(this.getPropertyValue(heightLabelCssObject,"padding")),heightLabelBorder=Math.abs(this.getPropertyValue(heightLabelCssObject,"border"));if(Math.abs(swPos.y-nwPos.y)<2*heightLabelWidth){this.rectangleHeightLabel.style.top=nwPos.y+ROTATE_BIAS+"px";}else{this.rectangleHeightLabel.style.top=yPos+ROTATE_BIAS+"px";}this.rectangleHeightLabel.style.left=(nwPos.x-(heightLabelHeight+2*heightLabelPadding+2*heightLabelBorder)-ROTATE_BIAS)+"px";},onSecondaryDataSliced:function onSecondaryDataSliced(key,data){var ind=-1,sdp=this.getDocModel().sdp;if(!!this.gridKeysMap[key]){ind=this.gridKeysMap[key];}if(ind!=-1){this.gridDataViewer[ind].resetModel(data);}if(sdp&&sdp[key]){var model=this.getData();if(model.sdp&&model.sdp[key]){model.sdp[key]=data;}ind=this.gridKeysMap[sdp[key].k];this.gridDataViewer[ind].resetAffinityLinesData(data);}},onselectedMetricIndexChange:function onselectedMetricIndexChange(gridIndex,metricIndex,metricId){this.debug("selected metric Index Changed");this.gridDataViewer[gridIndex].selectedMetricIndexChange(metricIndex,metricId);},onShow:function onShow(){if(!this.hasShown){this.hasShown=true;return ;}if(this.map){this.updateMapExtent();}},onStartLoadGoogleMap:function onStartLoadGoogleMap(){var that=this;document.onkeydown=function(evt){that.processMapKeydown(evt);};document.onkeyup=function(evt){that.processMapKeyup(evt);};if(typeof (microstrategy)!="undefined"){this.gridBone=microstrategy.bone(this.gridParams.boneId);}this.resetGoogleMap();this.loadGoogleMap(null);mstrmojo.gmaps.GoogleMap.newMapViewer(this);var toolbar=this.getToolbar();this.toolbarId=toolbar&&toolbar.id;if(mstrApp&&mstrApp.isVI){this.renderLegend();}},doAreaSearchOnGridLayer:function doAreaSearchOnGridLayer(layerIndex){if(this.curpolygonListBounds&&this.curpolygonListBounds.length>0){this.searchMarkersOnGridLayer(this.curpolygonListBounds,EnumAreaSelectionType.RECTANGLE,layerIndex);}if(this.circleList&&this.circleList.length>0){this.searchMarkersOnGridLayer(this.circleList,EnumAreaSelectionType.CIRCLE,layerIndex);}if(this.freeFormPolygonList&&this.freeFormPolygonList.length>0){this.searchMarkersOnGridLayer(this.freeFormPolygonList,EnumAreaSelectionType.POLYGON,layerIndex);}this.set("markerSelected",!this.noMarkerSelected());},searchMarkersOnGridLayer:function searchMarkersOnGridLayer(boundsList,selectionType,layerIndex){for(var i=0;i<boundsList.length;i++){this.gridDataViewer[layerIndex].drawRectangleEnd(boundsList[i],selectionType);}},persistWidgetProps:function persistWidgetProps(){if(this.widgetProps){var widgetPropsXml=this.createWidgetPropsXML();var ac=[];this.gridBone.setVisualizationSettings(null,null,null,null,ac,widgetPropsXml);this.gridBone.um.add(ac);this.gridBone.um.flushAndSubmitChanges();}},isEmpty:function isEmpty(){return false;},getVisEmptyMsgControls:function getVisEmptyMsgControls(){return[];},update:function update(node){var continueUpdate=this._super(node);if(continueUpdate!==false){this.observableModel=createObservableModel.call(this);if(this.getData()&&this.getData().eg){return continueUpdate;}var model=this.getData(),vp=model.vp,secondaryProperties=vp.sgProps,secondaryKey,secondaryVp;this.upgradeWidgetProperties(vp);if(!!secondaryProperties){for(secondaryKey in secondaryProperties){secondaryVp=secondaryProperties[secondaryKey];this.upgradeWidgetProperties(secondaryVp);}}}return continueUpdate;},upgradeWidgetProperties:function upgradeWidgetProperties(vp){if(!vp){return ;}if(vp.mtp==$EnumMarkerType.Bubble){if(!vp.separateColorSize&&!!vp.cmt&&!vp.smt){vp.smt=vp.cmt;}}vp.separateColorSize="1";},postBuildRendering:function postBuildRendering(){var me=this,model;if(this.waitingForData){return ;}this._super();model=this.getData();mstrApp.docModel&&mstrApp.docModel.attachEventListener("panelSelected",this.id,function(evt){var isChildOfPanel=false,panelDom=document.getElementById(evt.panelId);if(panelDom){isChildOfPanel=panelDom.contains(me.domNode);if(isChildOfPanel&&evt.panelVisible){me.onShow();}}});if(this.isLoadingExtraConfig){return ;}if(mstrApp&&mstrApp.googleConfig){if(mstrApp.googleConfig.gridParams){this.gridParams=mstrApp.googleConfig.gridParams;}if(mstrApp.googleConfig.mstProp){this.mstProp=mstrApp.googleConfig.mstProp;}}if(!this.gridParams){var splitParams={taskId:"getGoogleExtraConfig",key:model.k,taskEnv:"xhr",taskContentType:"json"};var callback={success:function(res){delete me.isLoadingExtraConfig;if(res){me.processData(res);me.buildGoogleMap();}else{this.gridParamDownloadListener=null;}},failure:function(res){delete me.isLoadingExtraConfig;this.gridParamDownloadListener=null;mstrmojo.alert("Error loading Configuration: "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};this.isLoadingExtraConfig=true;mstrApp.serverRequest(splitParams,callback);}else{this.buildGoogleMap();}this.lastZoom=null;this.mapMouseDownHandler=function(evt){var e=evt||window.event,isRightClick=(e.which)?(e.which===3):(w.button===2),toolbar=me.getToolbar(),isSelectionState=toolbar&&toolbar.isSelectionState();if(isRightClick&&isSelectionState){me.setToolbarState(0);me.toolbarStateChanged=true;$D.stopPropogation(window,e);$D.preventDefault(window,e);}else{me.toolbarStateChanged=false;}};$D.attachEvent(this.domNode,"mousedown",this.mapMouseDownHandler,true);},renderESRIGeoSearchWidget:function renderESRIGeoSearchWidget(searchBarNode){},processData:function processData(res){var extraProps=res.extProps;this.gridParams={};mstrmojo.hash.copy(extraProps.gridParams,this.gridParams);this.mstProp=res.mstProp;this.model.data.mstProp=this.mstProp;if(mstrApp){if(!mstrApp.googleConfig){mstrApp.googleConfig={};}mstrApp.googleConfig.gridParams=this.gridParams;mstrApp.googleConfig.mstProp=this.mstProp;}},buildGoogleMap:function buildGoogleMap(){if(!this.gridParams.clientId&&!this.gridParams.trialKey){this.mapDiv.innerHTML='<div class="map-err-message" style = "font-size:15px;height:100%;width:100%;background-color:white;color:black">'+mstrmojo.desc(11186,"The Google map requires a valid key")+"</div>";return ;}this.loadingCount++;if(!!this.mstProp){var m=this.getData();m.mstProp=this.mstProp;}if(!!this.gridParams.clientId){this.setPremiere(true);this.setPremiereKey(this.gridParams.clientId);}else{this.setTrialKey(this.gridParams.trialKey);}this.setLocaleLang(this.gridParams.lang);this.setLocaleRegion(this.gridParams.region);if(!!this.gridParams.channel){this.setChannel(this.gridParams.channel);}this.min_longitude=180;this.max_longitude=-180;if(mstrmojo.googleMapLib===undefined){mstrmojo.googleMapLib={};mstrmojo.gmaps.loadScriptListeners=[];this.loadExternalScript(this.onStartLoadGoogleMap,this);}else{var me=this;var callback=this.onStartLoadGoogleMap;if(typeof (mstrmojo.googleMapLibLoaded)!=="undefined"&&mstrmojo.googleMapLibLoaded==true){this.onStartLoadGoogleMap();}else{mstrmojo.gmaps.loadScriptListeners.push({caller:me,method:callback});}}},prepareDivs:function prepareDivs(){if(!!this.infoTabDiv){return ;}this.infoTabDiv=document.createElement("div");this.infoTabDiv.id="infoDiv";this.infoTabDiv.style.padding="2px 0 0 1px";this.infoTabDiv.style.overflow="auto";this.infoTabDiv.style.maxWidth="350px";this.infoTabDiv.style.maxHeight="200px";var table=document.createElement("table"),tableHead=document.createElement("tHead"),tableBody=document.createElement("tBody"),cssString,isIE=(navigator.appVersion.indexOf("MSIE")!=-1)?true:false;table.setAttribute("cellspacing","0");table.setAttribute("cellpadding","2");table.appendChild(tableHead);table.appendChild(tableBody);this.infoTabDiv.appendChild(table);cssString=this.gridDataViewer[this._primaryGridIndex].getMapModel(PRIMARY_DATA_PROVIDER).getCSSString();if(cssString!==undefined){var cssStyle=document.createElement("style");cssStyle.type="text/css";var node=cssStyle.styleSheet||cssStyle;if(mstrmojo.dom.isWK){if(node.firstChild){node.firstChild.nodeValue=cssString;}else{node.appendChild(document.createTextNode(cssString));}}else{node[mstrmojo.dom.isIE?"cssText":"innerHTML"]=cssString;}this.infoTabDiv.appendChild(cssStyle);}},processMapKeydown:function processMapKeydown(_event_){var winObj;if(window.event){winObj=window.event;}else{winObj=_event_;}if(winObj.ctrlKey){this.isCtrl=true;}if(winObj.shiftKey){this.set("enableZoom",true);}},processMapKeyup:function processMapKeyup(_event_){var winObj;if(window.event){winObj=window.event;}else{winObj=_event_;}var intCtrlKey=winObj.ctrlKey;if(!intCtrlKey){this.handleAffinityAnimationKeyUp();this.isCtrl=false;}if(!winObj.shiftKey&&!this.startZoom){this.set("enableZoom",false);}},getAssociatedNodes:function getAssociatedNodes(){var gt=this.defn.an;return gt&&gt.length>0?gt:[];},refresh:function refresh(){if(this.tempGoogleDiv&&this.googleDiv){this.tempGoogleDiv.appendChild(this.googleDiv);}this._super();},removeGridLayer:function removeGridLayer(layerIndex){this.gridDataViewer[layerIndex].unrender();if(this.gridDataViewer[layerIndex].currentSelections){this.gridDataViewer[layerIndex].currentSelections={};}if(this.gridDataViewer[layerIndex].selectedRowIndices){this.gridDataViewer[layerIndex].selectedRowIndices={};}if(this.gridDataViewer[layerIndex].highlightedGraphics){this.gridDataViewer[layerIndex].highlightedGraphics={};}},resetGoogleMap:function resetGoogleMap(){this.bounds=new google.maps.LatLngBounds();},saveCustomInfo:function saveCustomInfo(){this.persistWidgetProps();this.closePopup();},isDrillable:function isDrillable(){for(var i=0;i<this.gridDataViewer.length;i++){if(this.gridDataViewer[i].primaryModel.getTotalRows()>0&&this.gridDataViewer[i].getDrillStatus()){return true;}}return false;},initMapTypeData:function initMapTypeData(){this.mapTypeData=[];var i,size=this.mapStylesCache.length,mapStyle;for(i=0;i<size;i++){mapStyle=this.mapStylesCache[i];this.mapTypeData.push({id:mapStyle.id,n:mapStyle.n,v:mapStyle.v?mapStyle.v:i+"",type:"_GOOGLE_"});}},setMapType:function setMapType(value){var me=this,mapStyleIdx=parseInt(value);if(isNaN(mapStyleIdx)){mapStyleIdx=0;}me.currentMapStyleId=this.mapStyleIds[mapStyleIdx]||null;me.map.setMapTypeId(me.currentMapStyleId);},isSelectedDensity:function isSelectedDensity(layerChosen){if(!this.gridDataViewer){return false;}for(var i in layerChosen){var gridViewer=this.gridDataViewer[layerChosen[i]];if(gridViewer.wpMarkerType!=$EnumMarkerType.Density){return false;}}return true;},shapeDrill:function shapeDrill(){this.doDrill(this.shapePosition);},toggleDragging:function toggleDragging(bolEnableDrag){var opts={draggable:bolEnableDrag};this.map.setOptions(opts);},unrender:function unrender(){if(this.isOIVM()||(mstrApp&&mstrApp.isVI)){this.clearCache();}this.rectangleHeightLabel=null;this.rectangleLengthLabel=null;$D.detachEvent(this.domNode,"mousedown",this.mapMouseDownHandler,true);this.mapMouseDownHandler=null;this.removeEventListeners(this.mapEventListeners);this.mapEventListeners=[];this.removeEventListeners(this.polygonEventListeners);this.polygonEventListeners=[];if(this.docModelListener){mstrApp.docModel.detachEventListener(this.docModelListener);this.docModelListener=null;}document.onkeydown=document.onkeyup=null;this.destroyGridViewer();delete this.gridDataViewer;this.hideInfoWindow();this._super();},unrenderGridViewer:function unrenderGridViewer(){if(!this.gridDataViewer){return ;}for(var i=0,il=this.gridDataViewer.length;i<il;i++){this.gridDataViewer[i].unrender();}},destroyGridViewer:function destroyGridViewer(){if(!this.gridDataViewer){return ;}for(var i=0,il=this.gridDataViewer.length;i<il;i++){this.gridDataViewer[i].destroy(true);}},updateMapExtent:function updateMapExtent(loadByGridChange){var model=this.model,gridDataViewer=this.gridDataViewer,i,il;if(!model||!model.data||!model.data.vp){return ;}this.refitContent=model.data.vp.rosa===$EnumZoomBehavior.Automatic?true:false;if(!loadByGridChange){this.totalLayersRendered++;if(this.totalLayersRendered!=gridDataViewer.length){return ;}this.totalLayersRendered=0;}this.bounds=new google.maps.LatLngBounds();if(this.refitContent===true&&loadByGridChange===true){this.bounds=this.layerChosen.length==0?this.bounds:new google.maps.LatLngBounds();for(var i in this.layerChosen){this.bounds.union(gridDataViewer[this.layerChosen[i]].getBounds());}}else{for(i=0,il=gridDataViewer.length;i<il;i++){this.bounds.union(gridDataViewer[i].getBounds());}}if(!this.defaultZoom){this.defaultZoom=this.map.getZoom();this.defaultCenter=this.map.getCenter();}this.centerMap();},updateMinMaxLatLng:function updateMinMaxLatLng(latlng){if(this.min_longitude>latlng.lng()){this.min_longitude=latlng.lng();this.swlatLng=latlng;}if(this.max_longitude<latlng.lng()){this.max_longitude=latlng.lng();this.nelatLng=latlng;}},updateMaxBubbleRadius:function updateMaxBubbleRadius(radius){if(radius>this.maxBubbleRadius){this.maxBubbleRadius=radius;}},addGridParameterDownloadListener:function addGridParameterDownloadListener(listener,callback){this.gridParamDownloadListener=this.gridParamDownloadListener||[];this.gridParamDownloadListener.push({listener:listener,callback:callback});},getSelections:function getSelections(){for(var i=0;i<this.gridDataViewer.length;i++){var grid=this.gridDataViewer[i];if(this.k==grid.k){return grid.getSelections();}}return null;},clearVizHighlights:function clearVizHighlights(){var gridDataViewers=this.gridDataViewer,count,i,viewer;if(!!gridDataViewers){count=gridDataViewers.length;for(i=0;i<count;i++){viewer=gridDataViewers[i];if(viewer.clearHighlights){viewer.clearHighlights();}}}},stripNumberFormat:function stripNumberFormat(numString){var newString=numString.replace(this.gridParams.currencySymbol,"");var oldString;do{oldString=newString;newString=newString.replace(this.gridParams.groupingSeparator,"");}while(oldString!=newString);var resultString=newString.replace(this.gridParams.decimalSeparator,".");return resultString;},getGridDataViewers:function getGridDataViewer(){return this.gridDataViewer;},canShowSelectionArea:function canShowSelectionArea(){var hasDensityLayer=false,gridDataViewers=this.gridDataViewer,viewerCount=gridDataViewers?gridDataViewers.length:0;for(var i=0;i<viewerCount;i++){if(gridDataViewers[i].densityLayer){hasDensityLayer=true;}}return hasDensityLayer;},backupToolBarSelections:function backupToolBarSelections(){if(!this.selectionBackUp){this.selectionBackUp={};this.selectionBackUp.toolbarState=this.toolbar.state;this.selectionBackUp.isMarkerSelected=this.markerSelected;}},restoreToolbarSelectionEffects:function restoreToolbarSelectionEffects(){this.set("markerSelected",this.selectionBackUp.isMarkerSelected);this.toolbar.set("state",this.selectionBackUp.toolbarState);},backupSelectionAreas:function backupSelectionAreas(){this.selectionBackUp.curpolygonList=[].concat(this.curpolygonList);this.selectionBackUp.curpolygonListBounds=[].concat(this.curpolygonListBounds);this.selectionBackUp.freeFormPolylineList=[].concat(this.freeFormPolylineList);this.selectionBackUp.freeFormPolygonList=[].concat(this.freeFormPolygonList);this.selectionBackUp.circleList=[].concat(this.circleList);},restoreSelectionAreas:function restoreSelectionAreas(){var size,i,that=this,currentArea,targetConfig={type:this.EnumContextMenuTargetType.SelectionArea,object:null};if(this.canShowSelectionArea()){size=this.curpolygonList?this.curpolygonList.length:0;for(i=0;i<size;i++){currentArea=this.curpolygonList[i];currentArea.setMap(this.map);this.polygonEventListeners.push(google.maps.event.addListener(currentArea,"rightclick",function(event){that.onRightClick(event,targetConfig);}));}size=this.freeFormPolylineList?this.freeFormPolylineList.length:0;for(i=0;i<size;i++){this.freeFormPolylineList[i].setMap(this.map);}size=this.freeFormPolygonList?this.freeFormPolygonList.length:0;for(i=0;i<size;i++){currentArea=this.freeFormPolygonList[i];this.freeFormPolygonList[i].setMap(this.map);this.freeFormEventListeners.push(google.maps.event.addListener(currentArea,"rightclick",function(event){that.onRightClick(event,targetConfig);}));}size=this.circleList?this.circleList.length:0;for(i=0;i<size;i++){currentArea=this.circleList[i];this.circleList[i].setMap(this.map);this.circleEventListeners.push(google.maps.event.addListener(currentArea,"rightclick",function(event){that.onRightClick(event,targetConfig);}));}}},restoreMapSelectionDataOnly:function restoreMapSelectionDataOnly(){this.curpolygonList=this.selectionBackUp.curpolygonList;this.curpolygonListBounds=this.selectionBackUp.curpolygonListBounds;this.freeFormPolylineList=this.selectionBackUp.freeFormPolylineList;this.freeFormPolygonList=this.selectionBackUp.freeFormPolygonList;this.circleList=this.selectionBackUp.circleList;},getLegendBoundaryNode:function(){return this.mapDiv;},preExportHook:function(callbackFn){var me=this;me.substituteStyles(me.getRootDivForPDF());if($D.isIE9||$D.isIE10){this.replaceMapTiles(callbackFn);}else{if(callbackFn){callbackFn();}}},getCssTransform:function(){return"transform";},postExportHook:function(){this.reviveStyles(this.getRootDivForPDF());this.reviveImages();},hideMapTools:function(){this._zoomControl=this.map.zoomControl;this._panControl=this.map.panControl;if(this._zoomControl){this.map.setOptions({zoomControl:false});}if(this._panControl){this.map.setOptions({panControl:false});}},showMapTools:function(){if(this._zoomControl){this.map.setOptions({zoomControl:true});}if(this._panControl){this.map.setOptions({panControl:true});}},drawMarkerLayers:function drawMarkerLayers(){if(!this.gridDataViewer){return ;}for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].unrender(true);}for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].loadWidgetProps();this.gridDataViewer[i].render(false,true);}}});mstrmojo.gmaps.GoogleMap.newMapViewer=function newMapViewer(map,scriptClass){var url=unescape(map.gridParams.params),scriptClass=scriptClass?scriptClass:"mstrmojo.gmaps.GoogleMap";mstrApp.localeId=map.gridParams.localeId;map.gridParams.includeOptimizedDrillPathSetting="true";mstrmojo.gmaps.GoogleMap.initMapViewer(map,scriptClass);};mstrmojo.gmaps.GoogleMap.initMapViewer=function initMapViewer(googlemap){var placeholder=googlemap.toolBarDiv.id,merticSelectPlaceholder=googlemap.merticSelectDiv.id,clearAllPopupPlaceholder=googlemap.clearAllPopupDiv.id,singleSelectPopupPlaceholder=googlemap.singleSelectPopupDiv.id,gridParams=googlemap.gridParams,metricData=[],metricsString=mstrmojo.desc(1158,"Metrics");for(var ind=0;ind<googlemap.gridDataViewer.length;ind++){if(googlemap.gridDataViewer[ind].getMapModel(PRIMARY_DATA_PROVIDER).getTotalRows()==0){continue;}cols=googlemap.gridDataViewer[ind].getMapModel(PRIMARY_DATA_PROVIDER).getColTitles();metricData[ind]={metrics:[],gridName:googlemap.gridDataViewer[ind].getLayerGridName()};for(var i=0;i<cols.size();i++){col=cols.getTitle(i);if(col.getName()==metricsString){var es=col.getHeaderValues();for(j=0;j<es.length;j++){var o={v:j,n:es[j].n,id:es[j].id,gIdx:ind};metricData[ind].metrics.push(o);}break;}}}googlemap.mapDiv.style.height=parseInt(googlemap.height,10)+"px";if(googlemap.model.data.vp!=undefined&&googlemap.model.data.vp.mt!=="0"){var toolbarButtonsFlag=googlemap.EnumToolbarButtonType.RECTANGLE_SELECT|googlemap.EnumToolbarButtonType.CLEAR_ALL|googlemap.EnumToolbarButtonType.FREE_SELECT|googlemap.EnumToolbarButtonType.CIRCLE_SELECT|googlemap.EnumToolbarButtonType.ZOOM|googlemap.EnumToolbarButtonType.GRIDS_SELECT|googlemap.EnumToolbarButtonType.MAP_TYPE;if(mstrApp&&mstrApp.isVI){toolbarButtonsFlag^=googlemap.EnumToolbarButtonType.GRIDS_SELECT;}googlemap.initMapTypeData();googlemap.initMapToolbar(googlemap,metricData,toolbarButtonsFlag,placeholder,merticSelectPlaceholder,clearAllPopupPlaceholder,singleSelectPopupPlaceholder,googlemap.mapTypeData);googlemap.renderToolbar();}};})();