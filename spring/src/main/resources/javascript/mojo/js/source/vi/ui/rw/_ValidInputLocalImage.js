(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.rw.selectors._HasWarningMessage","mstrmojo.dom","mstrmojo.hash","mstrmojo.imageUtils");mstrmojo.requiresDescs(1212);var $P=mstrmojo.vi.ui.rw.selectors.EnumWarningPosition,$DOM=mstrmojo.dom,$IMGUTIL=mstrmojo.imageUtils,$H=mstrmojo.hash,BTYES_IN_ONE_MB=1<<20,EMBEDDED_IMG_MAX_SIZE=3,ORIGINAL_IMG_MAX_SIZE_IN_BTYES=10*BTYES_IN_ONE_MB;var VALIDATION_STATUS={SUCCESS:0,OVER_SIZE:1,INVALID_FILE_TYPE:2,OVER_SIZE_NO_COMPRESSION:3};mstrmojo.vi.ui.rw._ValidInputLocalImage=mstrmojo.provide("mstrmojo.vi.ui.rw._ValidInputLocalImage",{_mixinName:"mstrmojo.vi.ui.rw._ValidInputLocalImage",imageBox:undefined,validationStatus:undefined,fileSizeAfterCompressedInMB:undefined,VALID_MIME_TYPES:["image/png","image/jpeg","image/bmp","image/gif"],validationFailed:function(){mstrApp.hideWait();},validationSuccess:function(processedFileStruct){mstrApp.hideWait();if(this.imageBox){this.imageBox.localImageAdded(processedFileStruct);}},getValidationObj:function(){var validationStatus=this.validationStatus,validation={},template={refNode:this.domNode,invalid:true,position:$P.BOTTOM,closeOnClick:true,lasting:12000,highlight:false};validation[VALIDATION_STATUS.OVER_SIZE]={errorCode:"imageSizeExceedLimitVIWarning",args:[EMBEDDED_IMG_MAX_SIZE,this.fileSizeAfterCompressedInMB||EMBEDDED_IMG_MAX_SIZE]};validation[VALIDATION_STATUS.OVER_SIZE_NO_COMPRESSION]={errorCode:"imageOverSizeNoCompessionVIWarning",args:[EMBEDDED_IMG_MAX_SIZE]};validation[VALIDATION_STATUS.INVALID_FILE_TYPE]={errorCode:"imageFileTypeNotSupportedVIWarning",args:[]};return validation[validationStatus]?$H.copy(template,validation[validationStatus]):undefined;},fileSelected:function(file){var me=this;var image=new Image(),reader=new FileReader();var mFile=(mstrApp.isSingleTier&&file.fileBlob)?file.fileBlob:file;image.mime_type=mFile.type;var embeddImageFile={file:mFile,imageName:file.name};if(this.VALID_MIME_TYPES.indexOf(image.mime_type)===-1){me.validationStatus=VALIDATION_STATUS.INVALID_FILE_TYPE;me.validationFailed();return ;}mstrApp.showWait({message:mstrmojo.desc(1212,"Processing...")});if(mFile.size>=ORIGINAL_IMG_MAX_SIZE_IN_BTYES){me.validationStatus=VALIDATION_STATUS.OVER_SIZE_NO_COMPRESSION;me.validationFailed();return ;}reader.onload=function(event){image.src=event.target.result;image.onload=function(){var MAX_FILE_SIZE=EMBEDDED_IMG_MAX_SIZE*BTYES_IN_ONE_MB,originalSize=embeddImageFile.file.size;if(originalSize<MAX_FILE_SIZE){embeddImageFile.base64Str=image.src;embeddImageFile.imageData=$IMGUTIL.dataURLToBlob(image.src);embeddImageFile.imageSize=embeddImageFile.imageData.size;}else{if(image.mime_type==="image/gif"){me.validationStatus=VALIDATION_STATUS.OVER_SIZE_NO_COMPRESSION;me.validationFailed();return ;}else{var ratio=75;if(image.naturalWidth>=1920&&image.naturalHeight>=1080){ratio=45;}var outputType="jpg";if(image.mime_type==="image/png"){outputType="png";}var compressedImg=$IMGUTIL.compress(image,ratio,outputType);embeddImageFile.base64Str=compressedImg.src;embeddImageFile.imageData=$IMGUTIL.dataURLToBlob(compressedImg.src);embeddImageFile.imageSize=embeddImageFile.imageData.size;}}var embeddImageSize=embeddImageFile.imageSize;me.fileSizeAfterCompressedInMB=Math.min(embeddImageSize,embeddImageFile.file.size)/BTYES_IN_ONE_MB;me.fileSizeAfterCompressedInMB=me.fileSizeAfterCompressedInMB.toFixed(1);if(embeddImageSize>MAX_FILE_SIZE){me.validationStatus=embeddImageSize>=originalSize?VALIDATION_STATUS.OVER_SIZE_NO_COMPRESSION:VALIDATION_STATUS.OVER_SIZE;me.validationFailed();return ;}me.validationSuccess(embeddImageFile);};image.onerror=function(){me.validationStatus=VALIDATION_STATUS.INVALID_FILE_TYPE;me.validationFailed();};};reader.onerror=function(){me.validationStatus=VALIDATION_STATUS.INVALID_FILE_TYPE;me.validationFailed();};reader.readAsDataURL(mFile);}});}());