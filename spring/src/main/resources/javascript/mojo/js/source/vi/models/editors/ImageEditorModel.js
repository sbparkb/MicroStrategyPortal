(function(){mstrmojo.requiresCls("mstrmojo.boxmodel","mstrmojo.dom","mstrmojo.num","mstrmojo.Button","mstrmojo.TextBox","mstrmojo.Label","mstrmojo.models.FormatModel","mstrmojo.vi.ui.rw.DocImage","mstrmojo.ui.editors.controls.LinkGroup","mstrmojo.vi.models.editors.EditorModel","mstrmojo.ui.editors.controls.TwoColumnContainer","mstrmojo.ui.editors.controls.CharacterGroup","mstrmojo.vi.ui.ImageEditorPanelImagePicker");mstrmojo.requiresDescs(12057,13580,12059,12060,14552);var $ENUM_SIZE_MODES=mstrmojo.vi.ui.rw.DocImage.EnumSizeModes,MODE_FIXED=$ENUM_SIZE_MODES.FIXED,MODE_FIT_TO_CONTAINER=$ENUM_SIZE_MODES.FIT_TO_CONTAINER,MODE_FILL_CONTAINER=$ENUM_SIZE_MODES.FILL_CONTAINER,MODE_STRETCH=$ENUM_SIZE_MODES.STRETCH,$DOM=mstrmojo.dom,$PX2INCHES=mstrmojo.boxmodel.px2Inches,$FORMAT_MODEL=mstrmojo.models.FormatModel,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$NUM=mstrmojo.num;var MODE_PULLDOWN_ITEMS=[{n:mstrmojo.desc(12057,"Fixed to"),v:MODE_FIXED},{n:mstrmojo.desc(13580,"Fit to container"),v:MODE_FIT_TO_CONTAINER},{n:mstrmojo.desc(12059,"Fill container"),v:MODE_FILL_CONTAINER},{n:mstrmojo.desc(12060,"Stretch"),v:MODE_STRETCH}];function updateUnitFormats(hostDocImage,formatInfo){var docModel=hostDocImage.model,zoomProps=docModel.getZoomProps(),formats=[].concat(formatInfo),findFormat=function(pn,key){var i,len;for(i=0,len=formats.length;i<len;i++){if(formats[i].propertyName===pn){return formats[i][key];}}},inches2px=function(v){if(v!==undefined){v=typeof v==="number"?v:$NUM.parseNumeric(v);return(v*zoomProps.zf*zoomProps.dpi).toFixed();}return NaN;},setValue=function(key){return{ih:inches2px(findFormat("ih",key)),iw:inches2px(findFormat("iw",key)),ism:findFormat("ism",key),lock:findFormat("lockAspectRatio",key)};},oldValue=setValue("oldValue"),newValue=setValue("newValue"),unit=hostDocImage.parent,panelKey=unit.parent.k,unitKey=unit.k,fnChangeFmtValue=function(value){var layoutKey=docModel.getCurrentLayoutKey(),modelNode=docModel.getLayoutUnitDefn(unitKey,layoutKey),panel=docModel.getPanel(panelKey,layoutKey);if(!modelNode){return ;}if(value.ih!==undefined){modelNode.ih=value.ih+"px";}if(value.iw!==undefined){modelNode.iw=value.iw+"px";}if(value.ism!==undefined){modelNode.ism=value.ism;}if(value.lock!==undefined){modelNode.lock=value.lock;}panel.selectVIUnit(panel.rebuildChild(panel.getUnitByKey(unitKey)),true);};docModel.saveUnitFormatProperty(unit,formats,{success:fnChangeFmtValue.bind(this,newValue)},mstrmojo.DocDataService.SUPPRESS_DATA,{undo:fnChangeFmtValue.bind(this,oldValue),redo:fnChangeFmtValue.bind(this,newValue)});}function getDimensionFormatInfo(hostDocImage,modeConfig){var zoomProps=hostDocImage.model.getZoomProps(),formatWidth=hostDocImage.getImageWidth(),formatHeight=hostDocImage.getImageHeight(),check=function(name){if(typeof modeConfig[name]!=="undefined"&&isNaN(modeConfig[name])){modeConfig[name]=(name==="iw")?parseInt(formatWidth):parseInt(formatHeight);}};check("iw");check("ih");var imageDimensions=hostDocImage.getCalculatedImageDimensions(modeConfig),calculatedHeight=imageDimensions.h,calculatedWidth=imageDimensions.w,mode=modeConfig.mode,props=[{formatType:1,propertyName:$ENUM_FORMAT_PROPERTIES.IMAGE_HEIGHT,newValue:$PX2INCHES(zoomProps,calculatedHeight===undefined?formatHeight:calculatedHeight),oldValue:$PX2INCHES(zoomProps,formatHeight)},{formatType:1,propertyName:$ENUM_FORMAT_PROPERTIES.IMAGE_WIDTH,newValue:$PX2INCHES(zoomProps,calculatedWidth===undefined?formatWidth:calculatedWidth),oldValue:$PX2INCHES(zoomProps,formatWidth)}];if(mode!==MODE_FIXED){var oldValue=hostDocImage.defn.lock,newValue=mode!==MODE_STRETCH;if(newValue!==oldValue){props=props.concat({formatType:1,propertyName:$ENUM_FORMAT_PROPERTIES.LOCK_ASPECT_RATIO,newValue:newValue,oldValue:oldValue});}}return props;}function getOriginalSizeAction(hostDocImage){return getDimensionFormatInfo(hostDocImage,{mode:$ENUM_SIZE_MODES.ORIGINAL});}function getTextBox(value,fn){return new mstrmojo.TextBox({value:value,valueChangeDelay:3000,onvalueChange:fn,onkeydown:function(eventWrapper){if(eventWrapper.e.keyCode===13){this.blur();}}});}function getURLTextBox(){var hostDocImage=this.getHost();var urlStr=hostDocImage.v;if(hostDocImage.parent.isEmbedded){urlStr=hostDocImage.parent.embeddedImageName;}return getTextBox(urlStr,function onvalueChange(){var urlValue=this.value;if(urlValue!==urlStr){hostDocImage.parent.urlEdited(urlValue);}});}function getURLTextBoxAndButtonsEditorGroup(){var hostDocImage=this.getHost();var urlStr=hostDocImage.v;if(hostDocImage.parent.isEmbedded){urlStr=hostDocImage.parent.embeddedImageName;}var imagePicker=new mstrmojo.vi.ui.ImageEditorPanelImagePicker();imagePicker.slot="col1Node";imagePicker.imageBox=hostDocImage.parent;var okButton=mstrmojo.Button.newActionButton(mstrmojo.desc(1442,"OK"),function(){hostDocImage.parent.urlEdited(textBox.value);},{alias:"okBtn",slot:"col2Node",enabled:false});var buttons=new mstrmojo.ui.editors.controls.TwoColumnContainer({col1Width:"50%",col2Width:"50%",children:[imagePicker,okButton]});var textBox=new mstrmojo.TextBox({value:urlStr,hint:mstrmojo.desc(14552,"Enter an image URL or choose a file."),onvalueChange:function(){var urlValue=this.value;var okBtnEnable=!mstrmojo.string.isEmpty(urlValue)&&(urlValue!==urlStr);buttons.okBtn.set("enabled",okBtnEnable);buttons.okBtn.set("iconClass",okBtnEnable?"hot":"");},onkeydown:function(eventWrapper){if(eventWrapper.e.keyCode===13){if(buttons.okBtn.enabled===true){buttons.okBtn.onclick();}else{this.blur();}}}});return this.getEditorGroup([textBox,buttons]);}function getModePulldown(){var hostDocImage=this.getHost(),originalMode=hostDocImage.getSizeMode(),selectedIndex=Math.max(MODE_PULLDOWN_ITEMS.map(function(item){return item.v;}).indexOf(originalMode),0);return this.getLabelAndControl(mstrmojo.desc(9735,"Size:"),this.getPulldown(MODE_PULLDOWN_ITEMS,function(newValue,oldValue){var modeConfig={mode:newValue,lock:hostDocImage.isAspectRatioLocked()};updateUnitFormats(hostDocImage,getDimensionFormatInfo(hostDocImage,modeConfig).concat({formatType:1,propertyName:$ENUM_FORMAT_PROPERTIES.IMAGE_SIZE_MODE,newValue:newValue,oldValue:oldValue}));},selectedIndex));}function getDimensionContainer(){var hostDocImage=this.getHost(),updateFixedDimensions=function updateFixedDimensions(prop,newValue){var modeConfig={mode:hostDocImage.getSizeMode(),lock:hostDocImage.isAspectRatioLocked()};modeConfig[prop]=parseFloat(newValue);updateUnitFormats(hostDocImage,getDimensionFormatInfo(hostDocImage,modeConfig));},xInput=this.getLabelAndControl("X:",getTextBox(hostDocImage.getImageWidth(),function(evt){updateFixedDimensions($ENUM_FORMAT_PROPERTIES.IMAGE_WIDTH,evt.value);}),"20%","70%"),yInput=this.getLabelAndControl("Y:",getTextBox(hostDocImage.getImageHeight(),function(evt){updateFixedDimensions($ENUM_FORMAT_PROPERTIES.IMAGE_HEIGHT,evt.value);}),"30%","70%");xInput.slot="col1Node";yInput.slot="col2Node";xInput.cssClass=yInput.cssClass="dim-input";yInput.cssClass+=" y";return new mstrmojo.ui.editors.controls.TwoColumnContainer({col1Width:"50%",col2Width:"50%",children:[xInput,yInput],visible:hostDocImage.getSizeMode()===MODE_FIXED});}function getAspectRatioCheckbox(){var hostDocImage=this.getHost(),originalMode=hostDocImage.getSizeMode(),isLockRatio=originalMode===MODE_FIT_TO_CONTAINER||originalMode===MODE_FILL_CONTAINER,isStretch=originalMode===MODE_STRETCH,isChecked=isLockRatio?true:(isStretch?false:hostDocImage.isAspectRatioLocked()),control=this.getCheckboxAndLabel(isChecked,mstrmojo.desc(13639,"Lock aspect ratio"),function(newValue){var formatActions=[{formatType:1,propertyName:$ENUM_FORMAT_PROPERTIES.LOCK_ASPECT_RATIO,newValue:newValue,oldValue:!newValue}];formatActions=formatActions.concat(getDimensionFormatInfo(hostDocImage,{lock:newValue}));updateUnitFormats(hostDocImage,formatActions);});control.enabled=!isLockRatio&&!isStretch;return control;}mstrmojo.vi.models.editors.ImageEditorModel=mstrmojo.declare(mstrmojo.vi.models.editors.EditorModel,null,{scriptClass:"mstrmojo.vi.models.ImageEditorModel",help:"Dashboard_Editor_Image_Properties.htm",getChangeFormatPropertyFn:function(propertyName,formatType){var id=this.id;return function(newValue,oldValue){var editor=mstrmojo.all[id],model=editor.docModel,unit=editor.getHost().parent,panel=unit.parent,unitKey=unit.k,fmtNodeName="domNode",formats=[{formatType:formatType||1,propertyName:propertyName,newValue:newValue,oldValue:oldValue}],fnChangeFmtValue=function(res){var newUnit,fmts;model.partialUpdate(res.data,model.getTargetDefn(unitKey),res.defn,[unitKey]);newUnit=panel.rebuildChild(panel.getUnitByKey(unitKey));fmts=newUnit.defn.fmts;panel.selectVIUnit(newUnit,true);newUnit.clearCache();newUnit.clearSlotBackgroundCSS(fmtNodeName);newUnit.applyCSSFormatToNode(fmtNodeName,fmts);};model.saveUnitFormatProperty(unit,formats,{success:fnChangeFmtValue.bind(unit)},mstrmojo.DocDataService.REQUEST_ONLY_DEFINITION);};},getEditorContents:function getEditorContents(){var hostDocImage=this.getHost(),hostFormats=hostDocImage.getFormats(),restoreButton=mstrmojo.Button.newWebButton(mstrmojo.desc(12061,"Restore to Original Size"),function(){updateUnitFormats(hostDocImage,hostDocImage.getSizeMode()===MODE_FIXED?getOriginalSizeAction(hostDocImage):getOriginalSizeAction(hostDocImage).concat({formatType:1,propertyName:$ENUM_FORMAT_PROPERTIES.IMAGE_SIZE_MODE,newValue:MODE_FIXED,oldValue:hostDocImage.getSizeMode()}));}),linkGroup=new mstrmojo.ui.editors.controls.LinkGroup({docModel:this.docModel,hostId:this.hostId,hostType:2}),fnGroupHandler=this.getChangeGroupPropertyFn(),hasImageUrl=!!hostDocImage.v||!!hostDocImage.oid,commonProps={showDivider:false,enabled:hasImageUrl,shouldPropagateEnabled:true};if(!mstrApp.allowWebDashboardDesign()){return[];}var enableEmbeddedImg=!!mstrApp.enableEmbeddedImages&&!$DOM.isIE9;var editorContents=enableEmbeddedImg?[getURLTextBoxAndButtonsEditorGroup.call(this)]:[this.getEditorGroup([getURLTextBox.call(this)])];return editorContents.concat([this.getEditorGroup([getModePulldown.call(this)],{showDivider:enableEmbeddedImg,enabled:hasImageUrl,shouldPropagateEnabled:true}),this.getEditorGroup([getDimensionContainer.call(this)],commonProps),this.getEditorGroup([getAspectRatioCheckbox.call(this)],commonProps),this.getEditorGroup([restoreButton],commonProps),this.getEditorGroup([this.getContainerGroup(hostFormats,function(){hostDocImage.parent.clearCache();fnGroupHandler.apply(null,arguments);},NaN,{showBackgroundNoFill:false,showBorderNoFill:false})]),this.getEditorGroup([linkGroup])]);}});}());