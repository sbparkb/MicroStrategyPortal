(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.dom","mstrmojo.func","mstrmojo.vi.controllers.UICmdMgr");var $F=mstrmojo.func,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$COMMAND_STATES=mstrmojo.vi.controllers.UICmd.STATES,FILTER_TYPE={SHARED:0,SEPARATE:1},OPERATOR={AND:19,OR:20},mergeAttributeValues=function mergeAttributeValues(obj1,obj2){var result={},mergeAtts=function(atts1,atts2){var res=[];if(!atts2){return atts1;}$ARR.forEach((atts2||[]),function(item){res.push(item);});$ARR.forEach((atts1||[]),function(item){var ix=$ARR.find(atts2,"id",item.id);if(!~ix){res.push(item);}});return res;};$HASH.forEach(obj2,function(selAtts,attId){result[attId]=selAtts;});$HASH.forEach(obj1,function(selAtts,attId){result[attId]=mergeAtts(selAtts,obj2[attId]);});return result;},metricValuesSelCells=function metricValuesSelCells(datas){var selCells=[];$HASH.forEach(datas,function(data){selCells.push({ft:OPERATOR.AND,d:data});});return selCells;},attValueSelCells=function(datas){var finalData={},getInfo=function(data){var id=$HASH.keyarray(data)[0];return{id:id,d:data[id][0]};};$HASH.forEach(datas,function(data){var tmpData={},attInfo=getInfo(data),attSelection=tmpData[attInfo.id];if(attInfo.id){if(!attSelection){tmpData[attInfo.id]=attSelection=[];}attSelection.push(attInfo.d);}finalData=mergeAttributeValues(finalData,tmpData);},this);return[{ft:OPERATOR.OR,d:finalData}];},getSelectionDataTree=function getSelectionDataTree(data){var model=this.model,selectionData,selections=[],st=this.getSelectionType(),$ST=mstrmojo.vi.ui.rw.SelectionType,noSelection=true,hasElements=false;if(!$HASH.isEmpty(data)){if(st===$ST.METRICS){selectionData=metricValuesSelCells.call(this,data);}else{selectionData=attValueSelCells.call(this,data);}}$HASH.forEach(selectionData,function(v){noSelection=false;var node=[];$HASH.forEach(v.d,function(w,id){if(model.supportsViewFilterActions(id)){hasElements=true;var elems=[],item={id:id,elems:elems},oi=model.getObjectInfo(id);if(oi){item.t=oi.t;item.st=oi.st;if(oi.st===12033){item.attId=oi.attId;}}$ARR.forEach((w||[]),function(e){elems.push(e.id);});node.push(item);}});if(node.length){selections.push({ft:v.ft,d:node});}});selections.hasElements=hasElements;selections.clearSelections=noSelection;return selections;},handleMUSelection=function handleMUSelection(selectionData){var sc=this.selectorControl,controller,select,that=this;if(sc){if(selectionData.clearSelections||selectionData.hasElements){controller=this.controller;sc.exp=null;if(controller.onGridSelector){select=function(){controller.onGridSelector(that,{type:mstrmojo.EnumRWUnitType.GRID,ck:sc.ck,tks:sc.tks,ctlKey:sc.ckey,sliceId:this.sid,isUConDS:sc.isUConDS,ct:sc.ct,selections:selectionData});};if(this.multiUnitCtrlInterval){window.clearInterval(this.multiUnitCtrlInterval);this.multiUnitCtrlInterval=null;}if(controller.cmdMgr.state===$COMMAND_STATES.BUSY){this.multiUnitCtrlInterval=window.setInterval(function(){if(controller.cmdMgr.state!==$COMMAND_STATES.BUSY){window.clearInterval(that.multiUnitCtrlInterval);if(!that.destroyed){that.multiUnitCtrlInterval=null;select();}}},1000);}else{select();}}}}},getSelectorDataFromExpression=function getSelectorDataFromExpression(exp){var res={type:mstrmojo.vi.ui.rw.SelectionType.ATTS,data:exp},lookupType=function(nd,prevTy){if(parseInt(nd.fn,10)===22&&parseInt(prevTy,10)===19){res.type=mstrmojo.vi.ui.rw.SelectionType.METRICS;}$ARR.forEach((nd.nds||[]),function(i){lookupType(i,nd.fn);});};lookupType(exp,null);return res;},getCGBMap=function getCGBMap(){return this.parent.model.getCurrentLayoutDef().cgbMap;},getSourceCGBs=function getSourceCGBs(){var cgbMap=getCGBMap.call(this),res=[];$HASH.forEach(cgbMap,function(v,k){if(this.k===v){res.push(k);}},this);return res;},shouldClearSelectionAfterUpdate=function shouldClearSelectionAfterUpdate(){var cmdMgr=this.controller&&this.controller.cmdMgr;if(cmdMgr&&cmdMgr.isUndoRedo()){return true;}return false;};mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl=mstrmojo.provide("mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl",{_mixinName:"mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl",selectorControl:null,multiUnitCtrlInterval:null,postBuildRendering:function postBuildRendering(){this._super&&this._super();var sc=this.findSelectorControl();if(shouldClearSelectionAfterUpdate.call(this)){this.clearSelections();}if(sc&&!$HASH.isEmpty(sc.exp)&&this.addSelectionsFromExpression){this.addSelectionsFromExpression(getSelectorDataFromExpression(sc.exp));if(this.highlight){this.highlight(this.getSelectionType(),this.getSelectionHash(),true);}}},findSelectorControl:function findSelectorControl(){if(this._super){return this._super();}else{this.throwAbstractMethodError("findSelectorControl");}},handlesMultiSelection:function handlesMultiSelection(evt){return(this._super&&this._super(evt))||!!this.selectorControl;},onSelectionChange:function onSelectionChange(data){var cgbs=(this.model.getSelectorControlMapInfo?this.model.getSelectorControlMapInfo():[]),handled=false;if(this._super){handled=this._super(data);}if(cgbs.length>0){this.singleUnitSelect();handled=true;}else{if(!!this.selectorControl){var selectionData=getSelectionDataTree.call(this,data);handleMUSelection.call(this,selectionData);return true;}}return handled;},singleUnitSelect:function singleUnitSelect(){if(this._super){this._super();}},clearAllSelections:function clearAllSelections(){return this.selectorControl&&this.selectorControl.showall;},onClearBrushing:function onClearBrushing(evt){if(this.selectorControl){return true;}if(this._super){return this._super(evt);}return false;},getFilterType:function getFilterType(){return this.defn.ins||FILTER_TYPE.SHARED;},switchFilterType:function switchFilterType(type){var that=this,sourceCGBs,currentType=that.getFilterType(),model=that.parent.model,controlInfos,update={actions:[]},cgbKey,CGBMap=getCGBMap.call(that),nk,filtersModified=false;if(currentType!==type){sourceCGBs=getSourceCGBs.call(that);if(sourceCGBs.length>0&&currentType===FILTER_TYPE.SHARED){cgbKey=sourceCGBs[0];controlInfos=model.getSourceControls(that.parent,cgbKey);$ARR.forEach(controlInfos,function(controlInfo,c){if(c!==0){nk=model.getNextKey();CGBMap[nk]=that.k;update.actions.push(model.redoFilterAssociations(true,controlInfo.control.ckey,controlInfo.sourceKey,that.k,cgbKey,nk));filtersModified=true;}}.bind(that));}else{var firstCGBKey;$ARR.forEach(sourceCGBs,function(cgbKey,c){controlInfos=model.getSourceControls(that.parent,cgbKey);if(c===0){firstCGBKey=cgbKey;}else{delete CGBMap[cgbKey];update.actions.push(model.redoFilterAssociations(false,controlInfos[0].control.ckey,controlInfos[0].sourceKey,that.k,cgbKey,firstCGBKey));filtersModified=true;}}.bind(that));}update.actions.push(model.getUnitFormatAction(that,1,{FormattingSelector:{IndependentNodeSelector:type}},true));var useCurrent=false;update.callback=({success:function(){that.defn.ins=useCurrent?currentType:type;useCurrent=!useCurrent;}});if(filtersModified){update.callback=$F.wrapMethods(update.callback,model.getRebuildCallback());}}update.extras={style:{params:{treesToRender:3}}};return update;}});}());