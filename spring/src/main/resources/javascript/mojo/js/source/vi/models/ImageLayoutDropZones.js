(function(){mstrmojo.requiresCls("mstrmojo.vi.models.DropZonesModel","mstrmojo.vi.models.EnumDragSources","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.func","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.models._DropZoneCommon");var $ARR=mstrmojo.array,$FUNC=mstrmojo.func,$TARGET_POS=mstrmojo.vi.models.DropZonesModel.ENUM_TARGET_POSITION,$EDS=mstrmojo.vi.models.EnumDragSources,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$DZ=mstrmojo.vi.viz.EnumDSSDropZones,GEO=$DZ.GeoAttribute,SIZE_BY=$DZ.SizeBy,COLOR_BY=$DZ.ColorBy,LAYOUT=$DZ.Layout,TOOLTIP=$DZ.AdditionalMetrics,$THRESHOLD_UTILS=mstrmojo.vi.util.ThresholdUtils,IMAGELAYOUT_THRESHOLD_COLORS=["#65D22B","#FFC561","#FF9547","#FF5824","#CC1D1D"],IMAGELAYOUT_THRESHOLD_BANDS=[0.2,0.4,0.6,0.8],$PROPERTIES_TYPE=mstrmojo.VisEnum.IMAGELAYOUT_PROPERTIES;var DISPLAY_MODE_AUTOMATIC="0",DISPLAY_MODE_AREA="1",DISPLAY_MODE_BUBBLE="2";mstrmojo.vi.models.ImageLayoutDropZones=mstrmojo.declare(mstrmojo.vi.models.DropZonesModel,[mstrmojo.vi.models._DropZoneCommon],{getHostModel:function getHostModel(){return this.getHost().model.data;},getDisplayMode:function gtDisplayMode(){var propertyManager=this.getHost().propertyManager;return propertyManager.getFormatPropertyValue($PROPERTIES_TYPE.DISPLAY_MODE);},isZoneAvalaible:function isZoneAvalaible(zoneId){if(zoneId===SIZE_BY){return this.getDisplayMode()!==DISPLAY_MODE_AREA;}return true;},getDropZones:function getDropZones(){var dzf=this.getDZFlatStruct(),singleUnit={allowSingle:true},zones=[this.getZone(mstrmojo.desc(11661,"Geo Attribute"),GEO,dzf.GeoAttribute||dzf.Geo,false,singleUnit),this.getZone(mstrmojo.desc(11662,"Color By"),COLOR_BY,dzf.ColorBy,false,singleUnit),this.getZone(mstrmojo.desc(11663,"Size By"),SIZE_BY,dzf.SizeBy,this.getDisplayMode()===DISPLAY_MODE_AREA,singleUnit),this.getZone(mstrmojo.desc(2962,"Tooltip"),TOOLTIP,dzf.AdditionalMetrics),this.getZone(mstrmojo.desc(14473,"Path To Map"),LAYOUT,dzf.Layout||dzf.layout,false,singleUnit)];this.dropZones=zones;return{n:this.getHost().defn.ttl,zones:zones};},getUnitMenuItems:function getUnitMenuItems(cfg,zone,item,editableLabelNode){var me=this,dzid=this.id,isMetric=this.isMetric(item),items=zone.items,cnt=items.length,itemContext={zone:zone,idx:$ARR.find(items,"id",item.id),cnt:cnt,item:item,useDropzone:true},dataset=$DU.getDatasetFromAttributeId(this.docModel.datasets,item.did);if(isMetric){if(item.um){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedMetric(itemContext,"edit");},itemContext);cfg.addSeparator();}if(this.docModel.findDatasetIdFromUnit(item.did)&&!this.docModel.isFromSolrCube(item.did)&&!this.docModel.isFromMDXCube(item.did)){cfg.addSubMenuItem(mstrmojo.desc(11806,"Aggregate By"),"",dzid,me.getAggregateByMetricSubMenu,itemContext);cfg.addSeparator();}cfg.addEditorMenuItem(mstrmojo.desc(5188,"Calculation"),dzid,me.getCalculationEditorCfg,itemContext);cfg.addMenuItem(mstrmojo.desc(13624,"Create Metric..."),"",function(){me.newDerivedMetric(itemContext);},itemContext);}else{if(!dataset||!this.docModel.isMDXDataset(dataset)){if(item.da){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedAttribute(itemContext);},itemContext);cfg.addSeparator();}if(!this.isDynamicLink(item)){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){me.newDerivedAttribute(itemContext,!me.allowInsertNewAttribute(zone));},itemContext);}}}cfg.addSeparator();if(this.shouldShowDisplayFormsMenu(item)){cfg.addEditorMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),this.id,function(){return me.getDisplayFormsMenu(item);});}if(this.showNumberFormat(item)){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),dzid,this.getNumberFormatEditorCfg,itemContext);}if(isMetric){if(zone.id===COLOR_BY){this.buildThresholdMenuOptions(cfg,itemContext,true);}}cfg.addSeparator();cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"",function(){me.renameItem(editableLabelNode,item);});cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){me.deleteItem(zone,me.getUnitIndexInZone(zone,item));});},getAllowDropInfo:function getAllowDropInfo(zone,dragItems,idx,edge,context){var me=this,baseInfo=this._super(zone,dragItems,idx,edge,context),candidates=baseInfo.allowedItems,dragData=context.src.data,fzid=dragData.src===$EDS.VIZ_EDITOR?dragData.srcZoneId:null,isReplacing=edge===$TARGET_POS.ON,wantMetric=true,allowOnlyOne=true,cbItems=this.getZoneModelByZoneId(COLOR_BY).items,sbItems=this.getZoneModelByZoneId(SIZE_BY).items;switch(zone.id){case GEO:case LAYOUT:wantMetric=false;break;case TOOLTIP:allowOnlyOne=false;break;}return mstrmojo.hash.copy({allowedItems:(allowOnlyOne&&!(zone.items.length===0||isReplacing))?[]:$ARR.filter(candidates,function(item){var isMetric=me.isMetric(item);return wantMetric?isMetric:!isMetric;},allowOnlyOne?{max:1}:null),removeReplaced:isReplacing&&(allowOnlyOne||$ARR.find(dragItems,"did",zone.items[idx].did)===-1)},baseInfo);},getAddDropZoneUnitsActions:function getAddDropZoneUnitsActions(zone,items,idx,extras){var zoneID=zone.id,actions;actions=this._super(zone,items,idx,extras);if(zoneID===COLOR_BY){this.checkAndAddThresholdAction(COLOR_BY,items[0],actions);}return actions;},unitsDropped:function unitsDropped(zone,context,dropInfo){var dragData=context.src.data,cxActions=context.actions||[],actions=[],idx=dropInfo.idx,edge=dropInfo.edge,allowedItems=dropInfo.allowedItems,zoneID=zone.id,me=this,removeDuplicateInZone=function(zid){var otherZone=me.getZoneModelByZoneId(zid),dupItems=$ARR.intersection(otherZone.items,allowedItems,"did");dupItems.forEach(function(item){actions.push(me.getRemoveDropZoneUnitAction(otherZone,item,1));});};switch(zoneID){case SIZE_BY:removeDuplicateInZone(TOOLTIP);break;case COLOR_BY:removeDuplicateInZone(TOOLTIP);break;case TOOLTIP:removeDuplicateInZone(SIZE_BY);removeDuplicateInZone(COLOR_BY);break;}if(edge===$TARGET_POS.ON&&dropInfo.removeReplaced){actions.push(this.getRemoveDropZoneUnitAction(zone,zone.items[idx]));}$ARR.insert(actions,null,this.getAddDropZoneUnitsActions(zone,allowedItems,this.getDropTargetIndex(zone,dropInfo),{datasetId:dragData.dsid}));this.submitDropZoneUpdates(cxActions.concat(this.getUpdateTemplateAction(actions)),$FUNC.wrapMethods(context.callback,this.getHost().model.docModel.controller._getXtabCallback(this.getHost())));},checkAndAddThresholdAction:function checkAndAddThresholdAction(zoneID,item,actions){var host=this.getHost();if(zoneID===COLOR_BY&&this.isMetric(item)){$THRESHOLD_UTILS.addThresholds(host.model,host,host.node,item,actions,IMAGELAYOUT_THRESHOLD_COLORS,IMAGELAYOUT_THRESHOLD_BANDS,false);return true;}return false;},deleteItem:function deleteItem(zone,idx){this.submitDropZoneTemplateUpdates([this.getRemoveDropZoneUnitAction(zone,zone.items[idx])]);}});}());