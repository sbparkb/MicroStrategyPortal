(function(){mstrmojo.requiresCls("mstrmojo.gm.GMLegend","mstrmojo.dom","mstrmojo.css","mstrmojo.gm.GMEnums");var EMPTY_FUNC=mstrmojo.emptyFn,$DOM=mstrmojo.dom,$CSS=mstrmojo.css,$GM=mstrmojo.gm,$MAP=mstrmojo.gmaps,PRP_LEGEND_SLOT=mstrmojo.gm.EnumLegendSlot,DOCK_POSITION=$GM.EnumDockPosition,GM_LEGEND_SPACING=5;function getPositionInBoundary(pos,boundaryPosition){return{x:pos.x-boundaryPosition.x,y:pos.y-boundaryPosition.y};}function getInitalRenderPos(){var pWidth=this.widget.getWidth(),pHeight=this.widget.getHeight(),width=this.getWidth(),height=this.getHeight(),pos={};pos.x=pWidth-width;pos.y=Math.max(GM_LEGEND_SPACING,(pHeight-height)>>1);return pos;}mstrmojo.gmaps.MapLegend=mstrmojo.declare(mstrmojo.gm.GMLegend,null,{scriptClass:"mstrmojo.gmaps.MapLegend",cssClass:"gm-legend vis-map-legend",draggableNodeName:"domNode",calculateDockedPositions:EMPTY_FUNC,getSplitterDockPos:function(){return this.curSplitterDockPos||DOCK_POSITION.LEFT;},getSplitterInfo:function(splitter){if(!splitter){return{};}var splitterDockPos=this.getSplitterDockPos(),pos=getPositionInBoundary($DOM.position(this.domNode),this.boundaryPosition),currentW=this.width,pWidth=this.GMW,minLegendW=50,maxLegendW=Math.floor(pWidth/3),rtn={};rtn.dockPosition=splitterDockPos;if(splitterDockPos===DOCK_POSITION.LEFT){rtn.min=Math.min(0,Math.max(-pos.x,currentW-maxLegendW));rtn.max=Math.max(0,currentW-minLegendW);}else{if(splitterDockPos===DOCK_POSITION.RIGHT){rtn.min=minLegendW;rtn.max=Math.min(maxLegendW,pWidth-pos.x);}}return rtn;},splitterMoved:function(position,info){if(position!=0&&info.dockPosition===DOCK_POSITION.LEFT){var pos=getPositionInBoundary($DOM.position(this.domNode),this.boundaryPosition);this.dropZoneNode.style.left=(pos.x+position)+"px";}this._super&&this._super(position,info);},adjustColorPickerPos:EMPTY_FUNC,updateDropZoneNode:function(context){return true;},onmouseover:function(evt){this._super&&this._super(evt);var pos=getPositionInBoundary($DOM.getMousePosition(evt.e),$DOM.position(this.domNode)),splitterDockPos=this.curSplitterDockPos,isRight=pos.x>(this.getWidth()>>1);if(isRight&&(splitterDockPos!==DOCK_POSITION.RIGHT)){this.curSplitterDockPos=DOCK_POSITION.RIGHT;this.updateSplitter();}else{if(!isRight&&(pos.x<=splitterDockPos!==DOCK_POSITION.LEFT)){this.curSplitterDockPos=DOCK_POSITION.LEFT;this.updateSplitter();}}},updateSplitter:function(){this.dockPos=this.getSplitterDockPos();this._super();},postBuildRendering:function(){this._super();var dropZoneStyle=this.dropZoneNode.style,pos=getInitalRenderPos.call(this);dropZoneStyle.left=pos.x+"px";dropZoneStyle.top=pos.y+"px";this.parentNode=this.domNode.parentNode;this.boundaryNode=this.widget.getLegendBoundaryNode();this.boundaryPosition=$DOM.position(this.boundaryNode,true);},getDockedPosition:function(){var pos=getPositionInBoundary($DOM.position(this.domNode),this.boundaryPosition),pWidth=this.widget.getWidth();if(pos.x<=(pWidth>>1)){pos.pos=PRP_LEGEND_SLOT.RIGHT;}else{pos.pos=PRP_LEGEND_SLOT.LEFT;}return pos;},ondrop:function(context){var me=this,domNode=me.domNode,boundaryPosition=me.boundaryPosition,adjustPositionInBoundary=function(pos){if(pos.x<boundaryPosition.x){pos.x=boundaryPosition.x;}else{pos.x=Math.min(pos.x,boundaryPosition.x+boundaryPosition.w-me.getWidth());}if(pos.y<boundaryPosition.y){pos.y=boundaryPosition.y;}else{pos.y=Math.min(pos.y,boundaryPosition.y+boundaryPosition.h-me.getHeight());}return pos;},pos=getPositionInBoundary(adjustPositionInBoundary(context.tgt.pos),this.boundaryPosition),legendStyle=domNode.style;$CSS.removeClass(domNode,this.avatarCssClass);legendStyle.left=pos.x+"px";legendStyle.top=pos.y+"px";this.parentNode.appendChild(domNode);if(this.widget.onLegendDropped){var dockedPosition=this.getDockedPosition();this.widget.onLegendDropped(dockedPosition&&dockedPosition.pos);}context.dropSuccessful=true;}});$MAP.MapLegend.applyHTML5Props=$GM.GMLegend.applyHTML5Props;$MAP.MapLegend.getLegendSize4MinMode=$GM.GMLegend.getLegendSize4MinMode;$MAP.MapLegend.getLegendSize=$GM.GMLegend.getLegendSize;}());