(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.dom","mstrmojo.css","mstrmojo._HasOwnAvatar","mstrmojo.architect.menu.AttributeMenu","mstrmojo.warehouse._CanToggleAvatarClass","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.architect.EnumDragActions","mstrmojo.warehouse.EnumObjectTypes","mstrmojo.architect.ui.editors.LogicalSizeEditor","mstrmojo.Editor");var $D=mstrmojo.dom,$CSS=mstrmojo.css,$WIDGET=mstrmojo.Widget,$PX="px",ENUM_DROP_ZONE_CHILD=1,ENUM_DROP_ZONE_PARENT=2,$ATTRIBUTE_LABEL,$ENUM_DRAG_ACTIONS=mstrmojo.architect.EnumDragActions;function setDropZonesVisible(parentVisiblity,childVisibility){$CSS.toggleClass(this.parentdropZone,["on"],!!parentVisiblity);$CSS.toggleClass(this.childdropZone,["on"],!!childVisibility);}mstrmojo.architect.ui.AttributeLabel=mstrmojo.declare(mstrmojo.Widget,[mstrmojo._HasOwnAvatar,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.warehouse._CanToggleAvatarClass],{scriptClass:"mstrmojo.architect.ui.AttributeLabel",name:"",addAsParent:mstrmojo.desc(11453,"add as parent"),addAsChild:mstrmojo.desc(11454,"add as child"),markupString:'<div id="{@id}" class="mstrmojo-ar-AttributeLabel {@cssClass}" title="{@name}" style="position:absolute;left:{@left};top:{@top}" mstrAttach:click,mouseout><div class="mstrmojo-ar-al-parentdz">{@addAsParent}</div><div class="mstrmojo-ar-al-content"><span class="close-icon"></span><span class="space-icon"></span><span class="al-icon"></span><span class="al-name">{@name}</span><span class="space-icon"></span><span class="entry-icon"></span><span class="filter-icon"></span><span class="lock-icon"></span></div><div class="mstrmojo-ar-al-childdz">{@addAsChild}</div></div>',markupMethods:{onleftChange:$WIDGET.leftMarkupMethod,ontopChange:$WIDGET.topMarkupMethod,onnameChange:function onnameChange(){var $this=this,rootController=mstrApp.getRootController(),isSystemDimensionView=rootController.isTargetSystemDimensionView();$this.nameNode.innerHTML=this.name||"";$this.domNode.title=this.name||"";$CSS.toggleClass(this.containerNode,"sysDim",isSystemDimensionView);$CSS.toggleClass(this.closeNode,"sysDim",isSystemDimensionView);}},markupSlots:{parentdropZone:function parentdropZone(){return this.domNode.firstChild;},containerNode:function containerNode(){return this.domNode.children[1];},childdropZone:function childdropZone(){return this.domNode.children[2];},nameNode:function dragNode(){return this.domNode.children[1].children[3];},menuNode:function menuNode(){return this.domNode.children[1].lastChild;},closeNode:function menuNode(){return this.domNode.children[1].children[0];},entryNode:function menuNode(){return this.domNode.children[1].children[5];},filterNode:function menuNode(){return this.domNode.children[1].children[6];},lockNode:function menuNode(){return this.domNode.children[1].children[7];}},parentdropZone:undefined,childdropZone:undefined,containerNode:undefined,draggable:true,dropZone:true,entryPoint:false,filtered:false,locked:false,size:0,systemDimension:true,postBuildRendering:function postBuildRendering(){this._super();this.updateIcons();},onclick:function onclick(evt){var $this=this,panelcontent=this.linker.parent,rootController=mstrApp.getRootController(),target=evt.getTarget();switch(target){case $this.closeNode:panelcontent.storeAttributePositions();rootController.removeFromHierarchy($this.attributeId);break;case $this.entryNode:if($this.entryPoint){$this.entryPoint=false;rootController.removeEntryPoint($this.attributeId);}else{$this.entryPoint=true;rootController.addEntryPoint($this.attributeId);}break;case $this.filterNode:var cB={success:function succes(res){$this.filtered=(res.length>0);$CSS.toggleClass($this.filterNode,"noFilter",!$this.filtered);}};rootController.editFilters(this.attributeId,this.name,cB);break;case $this.lockNode:var callBack={success:function succes(res){var lockType;$this.size=res.size;$this.locked=res.locked;if($this.size>0){lockType=3;}else{if($this.locked){lockType=2;}else{lockType=1;}}rootController.setHierarchyAttributeLockProperty($this.attributeId,lockType,$this.size,{success:function success(){$CSS.removeClass($this.lockNode,"limit");$CSS.removeClass($this.lockNode,"unlocked");if($this.size>0){$CSS.addClass($this.lockNode,"limit");}else{$this.size=0;if(!$this.locked){$CSS.addClass($this.lockNode,"unlocked");}else{$CSS.addClass($this.lockNode,"limit");}}}});}};$this.buildLogicalSizeEditor({locked:$this.locked,size:$this.size,popupNode:$this.lockNode,callBack:callBack});break;}mstrmojo.dom.stopPropogation(evt.hWin,evt.e);$this.updateIcons();},updateIcons:function updateIcons(){var $this=this;$CSS.removeClass($this.lockNode,"limit");$CSS.removeClass($this.lockNode,"unlocked");if($this.size>0){$CSS.addClass($this.lockNode,"limit");}else{$this.size=0;if(!$this.locked){$CSS.addClass($this.lockNode,"unlocked");}else{$CSS.addClass($this.lockNode,"limit");}}$CSS.toggleClass(this.entryNode,"noEntry",!this.entryPoint);$CSS.toggleClass(this.filterNode,"noFilter",!this.filtered);},allowDrop:function allowDrop(context){var dragData=context.src.data,dragAction=context.action;return(dragData&&(dragData.scriptClass===this.scriptClass||(context.createRelations&&(dragAction===$ENUM_DRAG_ACTIONS.TABLE_VIEW_ATTR||dragAction===$ENUM_DRAG_ACTIONS.LINKER_ATTR))));},getDragData:function getDragData(){return this;},createAvatar:function createAvatar(){var node=this.containerNode.cloneNode(true);node.style.position="absolute";return node;},getDragAction:function getDragAction(){return $ENUM_DRAG_ACTIONS.LINKER_ATTR;},isDragValid:function isDragValid(){return true;},ondragover:function onDrg(context){var parentZone=this.parentdropZone,childZone=this.childdropZone,parentDZVisiblity=false,childDZVisibility=false,source=context.src,dragData=source&&source.data;if(dragData&&dragData!==this&&(dragData.did!==this.attributeId)){var domNode=this.domNode,nodePosition=$D.position(domNode),deltaY=context.tgt.pos.y-nodePosition.y,OFFSET=12;parentDZVisiblity=(deltaY<parentZone.clientHeight+OFFSET&&deltaY>=0);childDZVisibility=(deltaY>=domNode.clientHeight-childZone.clientHeight-OFFSET);if(parentDZVisiblity){dragData.type=ENUM_DROP_ZONE_PARENT;dragData.caid=this.attributeId;}else{if(childDZVisibility){dragData.type=ENUM_DROP_ZONE_CHILD;dragData.paid=this.attributeId;}}}setDropZonesVisible.call(this,parentDZVisiblity,childDZVisibility);},ondragend:function ondragmove(context){var target=context.tgt,parent=this.parent,dragData=context.src&&context.src.data,parentDomNode=parent.domNode;var parentPos=$D.position(parentDomNode),topDZNode=$D.position(this.parentdropZone),domNode=this.domNode,linker=this.linker,left=dragData.isDragWithin?parseInt(context.src.pos.x,10):(target.pos.x-parentPos.x),top=dragData.isDragWithin?parseInt(context.src.pos.y,10):(target.pos.y-parentPos.y-topDZNode.h);left=((left<0)?0:left)+$PX;top=((top<0)?0:top)+$PX;this.set("left",left);this.set("top",top);parent.updateAttributePositions(this.attributeId,{x:left,y:top});linker.drawLinks({MAX_DIMS:{x:parseInt(this.left,10)+domNode.clientWidth,y:parseInt(this.top,10)+domNode.clientHeight}});dragData.isDragWithin=false;if(this._super){this._super(context);}},ondrop:function ondrop(context){var $this=this,panelcontent=this.linker.parent,dragData=context.src&&context.src.data,dragDataType=dragData.type,elemBox=panelcontent.elemBox,attributePositions,posX,Y,posY,attributeId=dragData.attributeId||dragData.did;if(dragData&&(dragData!==this)&&(this.attributeId!==attributeId)){posX=context.tgt.widget.left;Y=parseInt(context.tgt.widget.top,10)+((dragDataType===ENUM_DROP_ZONE_CHILD)?90:(-90));if(Y<0){Y+=180;}posY=Y+"px";elemBox.recentDrop=context.src;elemBox.recentDrop.pos.x=posX;elemBox.recentDrop.pos.y=posY;setDropZonesVisible.call(this);attributePositions=panelcontent.getAttributePositions();attributePositions[attributeId]={x:posX,y:posY};dragData.isDragWithin=true;panelcontent.storeAttributePositions();this.raiseEvent({name:"attrRearranged",context:context});}else{setDropZonesVisible.call($this);}},ondragleave:function ondragleave(){setDropZonesVisible.call(this);},buildLogicalSizeEditor:function buildLogicalSizeEditor(data){var editor=new mstrmojo.Editor({nudge:function nudge(){var p=mstrmojo.dom.position(data.popupNode,true),s=this.editorNode.style;s.left=p.x+p.w+"px";s.top=p.y+p.h+"px";s.zIndex=1000;},cssClass:"mstrmojo-ar-al-logicalSizeEditor",children:[{scriptClass:"mstrmojo.architect.ui.editors.LogicalSizeEditor",isLocked:data.locked,logicalSize:data.size,unLockInactive:true,alias:"logicalSizeEditor",submitData:function submitData(){var logicalSizeEditor=this,data=logicalSizeEditor.data;if(data&&data.callBack&&data.callBack.success){data.callBack.success(logicalSizeEditor.getEditorData());}logicalSizeEditor.parent.close();},data:data},{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-MenuEditor-buttons",slot:"buttonNode",cssText:"margin:0px 0px 2px 2px",alias:"buttonBox",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Button",cssText:"line-height: 16px; padding:5px 10px;font-weight: bold;",text:mstrmojo.desc(1442,"OK"),alias:"okButton",onclick:function(){editor.children[0].submitData();}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Button",cssText:"line-height: 16px; padding:5px 10px;font-weight: bold;",text:mstrmojo.desc(221,"Cancel"),alias:"celButton",onclick:function(){editor.close();}}]}],showTitle:false,modal:true});editor.open();},toggleAvatarClass:function toggleAvatarClass(cls,isAdd){$CSS.toggleClass(this.avatar,cls,isAdd);}});$ATTRIBUTE_LABEL=mstrmojo.architect.ui.AttributeLabel;$ATTRIBUTE_LABEL.showPopupMenu=function showPopMenu(attrLabelWidget,itemInfo){var menuHelper=$ATTRIBUTE_LABEL.menuHelper=$ATTRIBUTE_LABEL.menuHelper||new mstrmojo.architect.menu.AttributeMenu();menuHelper.target=attrLabelWidget;menuHelper.data=itemInfo.data;var cfg=menuHelper.getMenuConfig();cfg.hostId=attrLabelWidget.id;cfg.hostElement=itemInfo.menuNode;attrLabelWidget.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));};$ATTRIBUTE_LABEL.ENUM_DROP_ZONE={CHILD:ENUM_DROP_ZONE_CHILD,PARENT:ENUM_DROP_ZONE_PARENT};}());