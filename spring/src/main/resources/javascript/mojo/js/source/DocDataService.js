(function(){mstrmojo.requiresCls("mstrmojo.StringBuffer","mstrmojo.hash","mstrmojo.array","mstrmojo.dom","mstrmojo._IsGraphDataService","mstrmojo.func","mstrmojo._ImageHelper","mstrmojo.rw.model.RetrievalKeysConfig","mstrmojo.rw.model.UpdateKeysConfig");var $HASH=mstrmojo.hash,$COPY=$HASH.copy,$ARR=mstrmojo.array,$DOM=mstrmojo.dom,$FUNC=mstrmojo.func,$PST=[mstrmojo.desc(8445,"Loading")],ensureArray=mstrmojo.array.ensureArray,updateNum=0;function preserveUndo(config){config=config||{};config.preserveUndo=true;return config;}function submitRequest(params,callback,config){if(this.blockRequests){throw ("The data service is currently ignoring all requests to the server.");}var updateId=updateNum++,updates=this.getTxUpdates(updateId);config=config||{};config.src=submitRequest.caller.name;if(!mstrmojo.string.isEmpty(updates)){params.updateChanges=updates;}params.zoomFactor=this.model.getZoomFactor();var cmdMgr=this.cmdMgr;if(!config.preserveUndo&&cmdMgr){cmdMgr.onSubmitUpdates();}mstrApp.serverRequest(params,this.wrapCallback(callback,updateId),config);}function addMacroCopyMoveCommonParams(action,node,destination){$HASH.copy({unitType:node.defn&&node.defn.t,unitKey:node.k},action);if(destination.layoutKey){$HASH.copy({toKey:destination.layoutKey,analysisSectionType:destination.analysisSectionType},action);}else{$HASH.copy({toKey:destination.parentKey},action);}return action;}function addContentSize(params){params=params||{};var availableDim=window.mstrMobileApp?this.model.controller.getContentDimensions():mstrApp.getContentDimensions();if(availableDim){params.styleName="RWDocumentMobileStyle";params.availableWidth=availableDim.w;params.availableHeight=availableDim.h;}else{params.innerWidth=mstrmojo.dom.windowDim().w;params.innerHeight=mstrmojo.dom.windowDim().h;}return params;}function getTreesToRender(extras){var style=extras&&extras.style,params=style&&style.params;return params&&params.treesToRender;}function getMoveAction(newParentKey,nodeType){return{act:"moveUnit",toKey:newParentKey,unitType:nodeType};}function getCtrlKeyFromContext(keyContext){return keyContext.split("\u001E")[2];}function ensureUndoSection(parentKey,update){if(parentKey!==mstrmojo.DocDataService.UNDO_KEY){return parentKey;}if(!this.undoSectionKey){var sectionKey=this.undoSectionKey=this.model.getNextKey(),fieldGroupKey=this.undoFGKey=this.model.getNextKey();update.addActions({act:"addUndoSection",cbKey:this.cbKey,nodeKey:sectionKey,fgKey:fieldGroupKey});var me=this;update.addCallbacks({failure:function failure(){delete me.undoSectionKey;}});}return this.undoSectionKey;}function getNewDerivedMetricAction(params,useGUID){var config={dsid:params.dsid,formula:params.tokenStreamXML,isTokenStream:!mstrmojo.string.isEmpty(params.tokenStreamXML),name:params.alias,afb:params.afb,sfb:params.sfb};if(useGUID){config.Ids=["$GUID_135"];}return this.getAddDerivedMetricToDatasetAction(config);}function getBaseCtrlAction(actionName,keyContext,targetKey,updateNodeKeys,disablePU,noTargetUpdate){var prNodes=[this.getNodeKeyFromKeyContext(keyContext)];if(!noTargetUpdate){prNodes=ensureArray(updateNodeKeys).concat(prNodes);}var action={act:actionName,keyContext:keyContext,tgtKey:targetKey,partialRetrieval:{nodes:prNodes}};if(!disablePU){action.partialUpdate={selectors:[getCtrlKeyFromContext(keyContext)]};}return action;}mstrmojo.DocDataService=mstrmojo.declare(mstrmojo.Obj,[mstrmojo._IsGraphDataService,mstrmojo._ImageHelper],{scriptClass:"mstrmojo.DocDataService",defaultStyle:{params:{treesToRender:2}},cmdMgr:null,stid:-1,blockRequests:false,init:function init(props){this._super(props);this.cmdMgr=this.model.controller.cmdMgr;},wrapCallback:function wrapCallback(callback,updateId){var me=this;return $FUNC.wrapMethods({success:function success(res){if(res){me.model.bs=me.rwb=res.bs||me.rwb;me.msgId=res.mid||me.msgId;me.cbKey=res.cbKey||me.cbKey;if(res.stid!==undefined){me.stid=res.stid;}}me.clearTxUpdates(updateId);},failure:function failure(){me.resetTxUpdates(updateId);}},callback);},getNodeKeyFromKeyContext:function getNodeKeyFromKeyContext(keyContext){return keyContext.split("\u001E")[1];},refresh:function refresh(params,callback){var isRefresh=!!params.useRefreshProgress,pst=isRefresh?[mstrmojo.desc(10078,"Refreshing data. Please wait.")]:$PST;delete params.useRefreshProgress;params=addContentSize(params);submitRequest.call(this,$COPY(params,{taskId:"docRefresh",rwb:this.rwb,rePrompt:false,fresh:false,regenerate:false}),callback,{showProgress:true,hideProgress:true,progressStateText:pst,useRefreshProgress:isRefresh});},saveRW:function saveRW(params,callback){submitRequest.call(this,$COPY(params,{taskId:"saveRW",msgID:this.msgId}),callback);},saveThresholds:function saveThresholds(params,callback,config){submitRequest.call(this,$COPY(params,{taskId:"saveThresholds"}),callback,config);},getThresholds:function getThresholds(params,callback,config){submitRequest.call(this,$COPY(params,{taskId:"getThresholds"}),callback,config);},browseElements:function browseElements(params,callback){submitRequest.call(this,$COPY(params,{taskId:"browseElements",styleName:"MojoAttributeStyle",blockBegin:1,blockCount:mstrApp.elementsBlockCount||30}),callback);},removeUnit:function removeUnit(params,callback){var action=$COPY(params,{act:"removeUnit"});this.submitTemplateUpdates(action.nodeKey,action,callback);},removeLayout:function removeLayout(key,isCurrent,callback){this.submitUpdates({act:"removeLayout",unitKey:key,isCurrent:isCurrent},callback);},moveLayout:function moveLayout(layout,rootKey,newIdx){this.submitUpdates(this.getMoveNodeAction(layout,rootKey,newIdx),mstrmojo.DocDataService.EMPTY_CALLBACK,mstrmojo.DocDataService.SUPPRESS_DATA);},getMacroCopyNodeAction:function getMacroCopyNodeAction(node,destination,newKey){var action={act:"macroCopyUnit",newKey:newKey,partialRetrieval:this.newRetrievalKeysConfig().addNode(newKey)};addMacroCopyMoveCommonParams(action,node,destination);return action;},getMacroMoveNodeAction:function getMacroMoveNodeAction(node,destination){var action={act:"macroMoveUnit",partialRetrieval:this.newRetrievalKeysConfig().addNode(node.k)};addMacroCopyMoveCommonParams(action,node,destination);return action;},getMoveNodeAction:function getMoveNodeAction(node,newParentKey,index){var defn=node.defn,t=defn?defn.t:mstrmojo.EnumRWUnitType.LAYOUT;var action=getMoveAction(newParentKey,t);action.unitKey=node.k;if(index!==undefined){action.index=index;}return action;},getMoveControlAction:function getMoveControlAction(keyContext,newParentKey,partialRetrievalKeys){var action=getMoveAction(newParentKey,mstrmojo.EnumRWUnitType.SELECTOR);action.keyContext=keyContext;if(partialRetrievalKeys){action.partialRetrieval={nodes:ensureArray(partialRetrievalKeys)};}return action;},addMoveControlAction:function addMoveControlAction(update,keyContext,newParentKey,partialRetrievalKeys){update.addActions(this.getMoveControlAction(keyContext,ensureUndoSection.call(this,newParentKey,update),partialRetrievalKeys));},getSetCtrlSourceAction:function getSetCtrlSourceAction(keyContext,unitId,unitType){return{act:"setControlSource",keyContext:keyContext,unitId:unitId,unitType:unitType,partialRetrieval:this.newRetrievalKeysConfig().addNode(this.getNodeKeyFromKeyContext(keyContext)),partialUpdate:{selectors:[getCtrlKeyFromContext(keyContext)]}};},getRemoveCtrlTargetAction:function getRemoveCtrlTargetAction(keyContext,targetKey,updateNodeKeys,disablePU){return getBaseCtrlAction.call(this,"removeControlTarget",keyContext,targetKey,updateNodeKeys,disablePU);},getClearCtrlTargetAction:function getClearCtrlTargetAction(keyContext){return{act:"clearControlTarget",keyContext:keyContext};},getAddCtrlTargetAction:function getAddCtrlTargetAction(keyContext,targetKey,updateNodeKeys,isGroupBySelector,disablePU,noTargetUpdate){var action=getBaseCtrlAction.call(this,"addControlTarget",keyContext,targetKey,updateNodeKeys,disablePU,noTargetUpdate);action.isUC=!isGroupBySelector;return action;},getAddCtrlTargetDatasetAction:function getAddCtrlTargetDatasetAction(keyContext,targetDid){return{act:"addControlTargetDataset",keyContext:keyContext,tgtDid:targetDid};},getRemoveCtrlTargetDatasetAction:function getRemoveCtrlTargetDatasetAction(keyContext,targetKey){return{act:"removeControlTargetDataset",keyContext:keyContext,tgtDid:targetKey};},getClearCtrlTargetDatasetAction:function getClearCtrlTargetDatasetAction(keyContext){return{act:"clearControlTargetDataset",keyContext:keyContext};},getChangeControlElementSource:function getChangeControlElementSource(keyContext,targetKey){return{act:"changeControlElementSource",keyContext:keyContext,ctlElementSrc:targetKey};},getSetAttributesJoinTypeAction:function getSetAttributesJoinTypeAction(nodeKey,value){return{act:"setAttributesJoinType",nodeKey:nodeKey,value:value,partialRetrieval:this.newRetrievalKeysConfig().addNode(nodeKey)};},getSetMetricJoinTypeAction:function getsetMetricJoinTypeAction(nodeKey,unitId,dataType,unitType,value){return{act:"setMetricJoinType",nodeKey:nodeKey,unitId:unitId,dataType:dataType,unitType:unitType,value:value,partialRetrieval:this.newRetrievalKeysConfig().addNode(nodeKey)};},getTxUpdates:function getTxUpdates(t){var m=this.model;return m&&m.getTransactionUpdates&&m.getTransactionUpdates(t);},clearTxUpdates:function clearTxUpdates(t){var m=this.model;if(m&&m.clearTransactionUpdates){m.clearTransactionUpdates(t);}},resetTxUpdates:function resetTxUpdates(t){var m=this.model;if(m&&m.resetTransactionUpdates){m.resetTransactionUpdates(t);}},loadDocLayout:function loadDocLayout(params,callback,update){var action={act:"setCurrentLayout",unitKey:params.layoutKey,disablePU:true},extras={style:{params:{treesToRender:3}},params:addContentSize.call(this)};if(update){update.add(action,callback,extras);}else{this.submitUpdates(action,callback,extras);}},checkMissingCredentials:function checkMissingCredentials(params,callback){submitRequest.call(this,$COPY(params,{taskId:"checkMissingCredentials"}),callback);},setCurrentDocLayout:function setCurrentDocLayout(key,callback,update){var action={act:"setCurrentLayout",unitKey:key},extras={config:{silent:(callback===null)}};callback=callback||null;if(update){update.add(action,callback,extras);}else{this.submitUpdates(action,callback,extras);}if(window.mstrMobileApp!==undefined){mstrMobileApp.clearWebViewCache(false);}},fetchDocPage:function fetchDocPage(position,callback){submitRequest.call(this,{taskId:"fetchDocPage",rwb:this.rwb,pos:position},callback);},requestPanelChangeDeferred:function requestPanelChangeDeferred(update,panelKey,dirtyKeys,requestDefinition,showProgress,callback){var action={act:"setCurrentPanel",unitKey:panelKey};if(dirtyKeys){action.partialRetrieval={nodes:dirtyKeys.split(",")};}update.add(action,callback,{config:{showProgress:showProgress,hideProgress:showProgress,progressStateText:$PST},style:{params:{treesToRender:requestDefinition?3:0}}});},getGraphSelectionAction:function getGraphSelectionAction(nodeKey,ctrlKey,sliceID,x,y,disablePU){var layout=this.model.getCurrentLayoutDef(),dzf=(layout&&layout.dzf)||1,action={act:"graphSelector",nodeKey:nodeKey,sliceID:sliceID,x:Math.round(x/dzf),y:Math.round(y/dzf)};if(disablePU){action.usePartialUpdate="0";}else{action.partialUpdate={selectors:ctrlKey.split("\u001E")};}return action;},getSelectorElementsAction:function getSelectorElementsAction(params){var action={act:"setSelectorElements",keyContext:params.ck,ctlKey:params.ctlKey,elemList:mstrmojo.string.decodeHtmlString(params.eid),isVisualization:!!params.isDocVis},include=params.include;if(include!==undefined){action.include=!!include;}if(params.tks){action.tks=params.tks;}if(params.disablePU){action.usePartialUpdate="0";}else{if(params.ignoreTargetData){action.partialRetrieval=this.newRetrievalKeysConfig().addNode(this.getNodeKeyFromKeyContext(params.ck));}else{action.partialUpdate={selectors:params.ctlKey.split("\u001F")};}}return action;},getUpdateTransactionAction:function getUpdateTransactionAction(params){var action={act:"updateTransaction"};if(params){if(params.ctlKey){action.partialUpdate={selectors:[params.ctlKey]};}}return action;},getSelectorFromGMAction:function getSelectorFromDICAction(params){var action={act:"setSelectorFromGM",keyContext:params.ck,ctlKey:params.ctlKey,keepOnly:!!params.keepOnly,selectorObjects:params.selectorObjects,isVisualization:!!params.isDocVis,include:!!params.include};if(params.tks){action.tks=params.tks;}if(params.disablePU){action.usePartialUpdate="0";}else{action.partialUpdate={selectors:[params.ctlKey]};}return action;},getGMViewFilterAction:function getGMViewFilterAction(params){var action={act:"keepOnlyGM",selectorObjects:params.selectorObjects,isVisualization:!!params.isDocVis,keepOnly:!!params.keepOnly};if(params.tks){action.tks=params.tks;}if(params.disablePU){action.usePartialUpdate="0";}else{action.partialUpdate={selectors:[params.ctlKey]};}return action;},setMultiDocSelectorElements:function setMultiDocSelectorElements(selectorObjects,multiSelect,callback){var params={taskId:"setMultiDocSelectorElements",rwb:this.rwb,multiSelect:multiSelect,selectorObjects:selectorObjects};submitRequest.call(this,params,callback,{showWait:true,hideWait:true,delay:true});},setDocSelectorTexts:function setDocSelectorTexts(selectorKeyContext,elemList,controlKey,includeClause,callback,zoomFactor,useAndroidTask,usePartialDisplay,treesToRender){var params={taskId:"setDocSelectorTexts",rwb:this.rwb,unitKeyContext:selectorKeyContext,ctlTexts:elemList,ctlKey:controlKey,zoomFactor:zoomFactor};if($DOM.isAndroid||useAndroidTask){params.taskId="androidSetDocSelectorElements";}if(includeClause!==null&&includeClause!==undefined){params.include=includeClause;}if(usePartialDisplay!==null&&usePartialDisplay!==undefined){params.usePartDisplay=usePartialDisplay;}if(treesToRender!==null&&treesToRender!==undefined){params.treesToRender=treesToRender;}submitRequest.call(this,params,callback);},getSelectorExpressionAction:function getSelectorExpressionAction(params){var action={act:"setSelectorExpression",keyContext:params.ck,ctlType:params.type,objId:params.srcid,objType:params.srct,expFunction:params.f,expFunctionType:params.ft,include:!!params.include,qt:params.qt,unset:!!params.unset};if(params.disablePU){action.usePartialUpdate="0";}else{action.partialUpdate={selectors:[params.ckey]};}if(params.changeQual){action.changeQual=params.changeQual;}var expressionConstants=params.cs;if(expressionConstants!==null&&expressionConstants!==undefined){action.expConstants=expressionConstants;action.dataType=params.dtp;}if(params.fid){action.fid=params.fid;}return action;},getMultiUnitSelectorAction:function getMultiUnitSelectorAction(params){return{act:"multiUnitSelection",keyContext:params.ck,sels:params.selections,partialUpdate:{selectors:[params.ctlKey]}};},getRemoveCtrlAction:function getRemoveCtrlAction(ctrlKey,updateNodeKeys){return{act:"removeControl",key:ctrlKey,partialUpdate:{selectors:[ctrlKey]},partialRetrieval:{nodes:ensureArray(updateNodeKeys)}};},getAddCtrlAction:function getAddCtrlAction(parentKey,nodeKey,ctrlKey,updateNodeKeys,isUC,srcType,srcId,targetKeys,ctlType){if(isNaN(ctlType)){ctlType=1;}var action={act:"addControl",parentKey:parentKey,nodeKey:nodeKey,ctlKey:ctrlKey,isUC:!!isUC,unitType:srcType||-1,unitId:srcId||"",targetKeys:ensureArray(targetKeys),ctlType:ctlType,gpType:ctlType,partialRetrieval:{nodes:ensureArray(updateNodeKeys)}};if(!action.isUC){action.partialUpdate={selectors:[ctrlKey]};}return action;},getSaveGraphPropertiesAction:function getSaveGraphPropertiesAction(nodeKey,props){return{act:"saveGraphProperties",nodeKey:nodeKey,properties:props};},getSelectorIncludeAction:function getSelectorIncludeAction(params){var ctrlKey=params.ckey;return{act:"setSelectorInclude",keyContext:params.ck,ctlKey:ctrlKey,ctlType:params.type,include:params.include,partialUpdate:{selectors:[ctrlKey]}};},getSelectorShowAllAction:function getSelectorShowAllAction(params){return{act:"setSelectorShowAll",keyContext:params.ck,ctlKey:params.ckey,ctlType:params.type,showAll:params.showAll,partialRetrieval:this.newRetrievalKeysConfig().addNode(this.getNodeKeyFromKeyContext(params.ck))};},getUnsetSelectorAction:function getUnsetSelectorAction(params){var ctrlKey=params.ckey,ck=params.ck,action={act:"unsetSelector",keyContext:ck,ctlKey:ctrlKey,ctlType:params.type};if(params.ignoreTargetData){action.partialRetrieval=this.newRetrievalKeysConfig().addNode(this.getNodeKeyFromKeyContext(ck));}else{action.partialUpdate={selectors:[ctrlKey]};}return action;},getChangeFilteringAction:function getChangeFilteringAction(nodeKey,filterMode,isUC,updateNodeKeys){return{act:"changeFiltering",nodeKey:nodeKey,filterMode:filterMode,isUC:isUC,partialRetrieval:{nodes:(updateNodeKeys?ensureArray(updateNodeKeys):[])}};},getAddDerivedMetricToDatasetAction:function getAddDerivedMetricToDatasetAction(params){return{act:"addDerivedMetricToDataset",dsid:params.dsid,formula:params.formula,isTokenStream:params.isTokenStream,name:params.name,newObjectIds:params.Ids,afb:params.afb,sfb:params.sfb};},getEditDocUnitPropAction:function getEditDocUnitPropAction(params){return{act:"editDocUnitProp",dsid:params.dsid,formId:params.formId,unitId:params.unitId,unitType:params.unitType,prop:params.prop,value:params.value};},getRWGraphImage:function getRWGraphImage(params,callback){var app=mstrApp,id=this.id,p={taskId:"getRWGraphImage",taskEnv:"xhr",imgType:4,messageID:this.msgId,nodeKey:params.k,sliceID:parseInt(params.sid,10),width:parseInt(params.w,10),height:parseInt(params.h,10)};if(app.onMobileDevice()&&app.useBinaryFormat){window.setTimeout(function(){submitRequest.call(mstrmojo.all[id],p,callback,preserveUndo());},0);}else{if(params.encodeImage){p.taskContentEncoding="base64";delete p.taskEnv;submitRequest.call(this,p,{success:function success(res){callback.success("data:image/png;base64,"+res);},failure:function failure(err){(callback.failure||app.onerror)(err);}},preserveUndo());}else{var cfg=app.getConfiguration(),projectId=app.getCurrentProjectId(),values=new mstrmojo.StringBuffer();p.__ts__=new Date().getTime();p.sessionState=app.getSessionState(projectId);$HASH.forEach(p,function(v,n){values.append(n+"="+encodeURIComponent(v));});callback.success(cfg.getTaskUrlByProject(projectId)+"?"+values.toString("&"));}}},getImage:function getImage(url){var app=mstrApp,config=app.getConfiguration();if(config&&url&&url.indexOf("://")===-1){url=config.getHostUrlByProject(app.getCurrentProjectId())+url;}return(mstrApp.useBinaryFormat)?String(mstrMobileApp.getImage(url)):url;},setGridDisplayMode:function setGridDisplayMode(unitKey,displayMode,callback,extras){$HASH.copy({params:{suppressData:true}},extras);this.submitUpdates({act:"setGridDisplayMode",unitKey:unitKey,displayMode:displayMode},callback,extras);},setDocZoom:function setDocZoom(params,callback){this.submitUpdates($COPY(params,{act:"setDocZoom",disablePU:true}),callback,{style:{params:{treesToRender:3}}});},sortGrid:function sortGrid(params,callback){this.submitTemplateUpdates(params.nodeKey,$COPY({act:"sort"},params),callback);},getAdvSortData:function advSort(params,callback){this.rwExecute($COPY(params,{styleName:"RWGridStyle"}),callback);},rwExecute:function rwExecute(params,callback){submitRequest.call(this,$COPY(params,{taskId:"RWExecute",rwb:this.rwb,messageID:this.msgId}),callback);},pivot:function pivot(params,callback){this.submitTemplateUpdates(params.nodeKey,{act:"pivot",unitId:params.unitId,unitType:params.unitType,attFormId:params.attFormId,axis:params.axis,unitPos:params.unitPos},callback);},resizeXtabColumn:function resizeXtabColumn(colResizeAction,callback){this.submitUpdates([this.getUpdateTemplateAction(colResizeAction.nodeKey,colResizeAction),{act:"format",unitType:52,unitKey:colResizeAction.nodeKey,formatType:1,format:{FormattingSize:{WidthMode:2}}}],callback);},showTotals:function showTotals(params,callback){this.submitTemplateUpdates(params.nodeKey,{act:"showTotals",unitId:params.unitId,unitType:params.unitType,subtotalType:params.subtotalType,clearSubtotalType:params.clearSubtotalType},callback);},drillGrid:function drillGrid(params,callback){this.submitUpdates(this.getDrillGridAction(params),callback,{config:{showProgress:true,hideProgress:true,progressStateText:$PST,delay:true}});},getDrillGridAction:function getDrillGridAction(params){var action={act:"gridDrillWithin",messageID:this.msgId,nodeKey:params.nodeKey,sliceId:params.sliceId,drillPathIndex:params.drillPathIndex,drillPathKey:params.drillPathKey,elementList:params.drillElements,retainParent:params.retainParent,partialUpdate:{nodes:[params.nodeKey]}};if(params.x){action.x=params.x;action.y=params.y;}return action;},changeDocGroupBy:function changeDocGroupBy(params,callback,config){var action={act:"changeDocGroupBy",disablePU:true};if(params.flags){action.flags=params.flags;}if(params.groupbyKey){action.gbKey=params.groupbyKey;action.elemId=params.elementId;}else{action.gbUnits=params.gbUnits;}this.submitUpdates(action,callback,{config:config,style:{params:{treesToRender:3}},params:addContentSize.call(this)});},retrieveServerJson:function retrieveServerJson(params,callback,extras){var model=this.model,controller=model.controller,requestParams={},style,config,extraParams;var partialRetrieval=params.nodes;if(partialRetrieval){requestParams.partialRetrieval=partialRetrieval;}var slices=params.slices;if(slices){requestParams.slices=slices;}if(extras){style=extras.style;config=extras.config;extraParams=extras.params;}if(!config){config={showProgress:true,hideProgress:true,progressStateText:$PST};}var st=params.style=$HASH.clone(this.defaultStyle);$COPY(style.params,st.params);var request={taskId:"getServerJSONResults",styleName:"ServerJsonRWDStyle",compress:1,rwb:this.rwb,messageID:this.msgId,stateID:-1,params:JSON.stringify(requestParams),treesToRender:st.params.treesToRender};$COPY(extraParams,request);config.preserveUndo=(extras&&extras.preserveUndo)||false;submitRequest.call(this,request,callback,config);},downloadGridData:function downloadGridData(params,callback){var actions={act:"gridIncrementalFetch",nodeKey:params.nodeKey,rowPosition:params.rowPosition,maxRows:params.maxRows,colPosition:params.colPosition,sliceId:params.sliceId,maxColumns:params.maxColumns,partialRetrieval:this.newRetrievalKeysConfig().addNode(params.nodeKey)};if(params.partialUpdate){actions.partialUpdate=params.partialUpdate;}this.submitUpdates(actions,callback,$HASH.copy(preserveUndo(),{noUpdate:true,config:{silent:true}}));},txMarkRows:function txMarkRows(params,callback){submitRequest.call(this,{taskId:"markRow",rwb:this.rwb,nodeKey:params.nodeKey,sliceId:params.sliceId,rowOrdinal:params.rowOrdinal,actionType:params.actionType},callback);},txChangeData:function txChangeData(params,callback){submitRequest.call(this,{taskId:"changeData",rwb:this.rwb,nodeKey:params.nodeKey,sliceId:params.sliceId,cells:params.cells,autoRefresh:params.autoRefresh},callback);},sendTransactionActions:function sntTxActs(params,callback){var request={taskId:"DocTransaction",rwb:this.rwb,keyContext:params.keyContext,actions:params.actions,messageID:this.msgId};if(params.txrcd){request.isPending=params.txrcd.pending;request.timestamp=params.txrcd.timestamp;}submitRequest.call(this,request,callback,{silent:!!callback});},newUpdate:function newUpdate(cmd,props){var updateObject=new mstrmojo.DocDataService.Update(props);updateObject.ds=this;updateObject.cmd=cmd;return updateObject;},newUpdateWithoutCmd:function newUpdateWithoutCmd(props){var updateObject=new mstrmojo.DocDataService.Update(props);updateObject.ds=this;return updateObject;},newRetrievalKeysConfig:function newRetrievalKeysConfig(){return new mstrmojo.rw.model.RetrievalKeysConfig();},newUpdateKeysConfig:function newUpdateKeysConfig(){return new mstrmojo.rw.model.UpdateKeysConfig();},submitCmd:function submitCmd(cmd,props){this.newUpdate(cmd,props).submit();},submitUpdates:function submitUpdates(actions,callback,extras){actions=ensureArray(actions);var params={actions:actions},style,config,extraParams,disablePU=false;$ARR.forEach(actions,function actionIterator(act){if(act.disablePU){disablePU=true;delete act.disablePU;}$ARR.forEach(act.actions,actionIterator);return !disablePU;});if(!disablePU){var retrievalKeysConfig=mstrmojo.rw.model.RetrievalKeysConfig.getConsolidatedConfig(actions),updateKeysConfig=mstrmojo.rw.model.UpdateKeysConfig.getConsolidatedConfig(actions);if(!$HASH.isEmpty(retrievalKeysConfig)){params.partialRetrieval=retrievalKeysConfig;}if(!$HASH.isEmpty(updateKeysConfig)){params.partialUpdate=updateKeysConfig;}}if(extras){style=extras.style;config=extras.config;extraParams=extras.params;}if(!config){config={showProgress:true,hideProgress:true,progressStateText:$PST};}if(!style){params.style=this.defaultStyle;}else{var st=params.style=$HASH.clone(this.defaultStyle);$COPY(style.params,st.params);}params.style.name=(style&&style.name)||mstrApp.styleName;var request={taskId:"mojoRWManipulation",rwb:this.rwb,messageID:this.msgId,stateID:-1,params:JSON.stringify(params)};$COPY(extraParams,request);config.preserveUndo=(extras&&extras.noUpdate)||false;var me=this,isComplete=true,cb=$FUNC.override({success:function(res,request){if(res.status===2){isComplete=false;me.submitUpdates([],callback,extras);}else{isComplete=true;return this._super(res,request);}},complete:function(){if(this._super&&isComplete){this._super();}}},$COPY(callback));if(!(extras&&extras.hideCancel)){config.waitBoxCfg=$HASH.copy({showCancel:true},config.waitBoxCfg);}if(extras&&extras.message){config.waitBoxCfg=$HASH.copy({message:extras.message},config.waitBoxCfg);}submitRequest.call(this,request,cb,config);},submitTemplateUpdates:function submitTemplateUpdates(key,actions,callback,extras){this.submitUpdates(this.getUpdateTemplateAction(key,actions),callback,extras);},getUpdateTemplateAction:function getUpdateTemplateAction(key,actions,filterObject){return{act:"updateTemplate",keyContext:key,partialRetrieval:this.newRetrievalKeysConfig().addNode(key,filterObject),actions:ensureArray(actions)};},addUpdateTemplateAction:function addUpdateTemplateAction(update,key,actions){update.addActions(this.getUpdateTemplateAction(key,actions));},applySegment:function applySegment(segId,nodekey,callback){submitRequest.call(this,{taskId:"applySegment",rwb:this.rwb,segmentID:segId,nodeKey:nodekey},callback);},getPageByTree:function getPageByTree(callback){mstrApp.serverRequest({taskId:"getPageByTree",msgID:this.msgId},callback);},getUserDICubeInfo:function getUserDICubeInfo(cubeIds,callback){submitRequest.call(this,{taskId:"getUserDICubeInfo",cubeIds:cubeIds.join(",")},callback);},applySorts:function applySorts(nodeKey,sortType,sortList,callback){submitRequest.call(this,{taskId:"applySorts",key:nodeKey,sortType:sortType,sortList:sortList},callback,mstrmojo.DocDataService.PROGRESS_CONFIG);},getAddNewDerivedMetricToDatasetSubmitFunc:function getAddNewDerivedMetricToDatasetSubmitFunc(params){var me=this;return function(meDef){var model=me.model,controller=model.controller,cfg=$HASH.copy(meDef,params),actions=[getNewDerivedMetricAction.call(me,cfg,false)],callback=model.getDatasetsUpdateCallback();controller.submitUndoRedoUpdates(actions,null,callback,{style:{params:{treesToRender:1}}});};},getAddNewDerivedMetricToXtabSubmitFunc:function getAddNewDerivedMetricToXtabSubmitFunc(params){var me=this;return function(meDef){var model=me.model,controller=model.controller,cfg=$HASH.copy(meDef,params),idx=cfg.idx,actions=[],callback=$FUNC.wrapMethods(model.getDatasetsUpdateCallback(),controller._getXtabCallback(cfg.host));actions.push(getNewDerivedMetricAction.call(me,cfg,true));if(cfg.replace){actions.push(me.getUpdateTemplateAction(cfg.nodeKey,[cfg.host.model.getRemoveTemplateUnitAction({did:cfg.replace.did,t:cfg.replace.t})]));}else{idx++;}var updateTemplateAction=me.getUpdateTemplateAction(cfg.nodeKey,[cfg.host.model.getAddTemplateUnitAction({did:"$GUID_135",t:4},cfg.dsid,cfg.zoneid,idx),{act:"renameUnit",id:"$GUID_135",type:4,name:cfg.alias,isDynamicAlias:true}]);actions.push(updateTemplateAction);controller.submitUndoRedoUpdates(actions,null,callback);};},getAddNewDerivedMetricToDropzoneSubmitFunc:function getAddNewDerivedMetricToDropzoneSubmitFunc(params){var me=this;return function(meDef){var model=me.model,controller=model.controller,cfg=$HASH.copy(meDef,params),dropzone=cfg.host.zonesModel,idx=cfg.idx,actions=[],templateActions=[],zone={id:cfg.zoneid},newItem={did:"$GUID_135",t:4},callback=$FUNC.wrapMethods(model.getDatasetsUpdateCallback(),controller._getXtabCallback(cfg.host));actions.push(getNewDerivedMetricAction.call(me,cfg,true));if(cfg.replace){var replaceItem={did:cfg.replace.did,t:cfg.replace.t};templateActions.push(dropzone.getRemoveDropZoneUnitAction(zone,replaceItem));}else{idx++;}templateActions.push(dropzone.getAddDropZoneUnitAction(zone,newItem,idx,{datasetId:cfg.dsid}));var zoneId=(params.zoneid===4)?1:2,action=dropzone.getAddMetricNameAction(params.host,zoneId);if(action){actions.push(action);}if(!cfg.replace&&dropzone.gmZones){action=dropzone.gmZones.getUpdateGroupInfoActionForNewMetric(params.zoneid,idx,true);if(action){actions.push(action);}}dropzone.checkAndAddThresholdAction(cfg.zoneid,newItem,templateActions);actions.push(me.getUpdateTemplateAction(cfg.nodeKey,templateActions));controller.submitUndoRedoUpdates(actions,null,callback);};},getEditDerivedMetricSubmitFunc:function getEditDerivedMetricSubmitFunc(params){var me=this;return function(meDef){var model=me.model,controller=model.controller,cfg=$HASH.copy(meDef,params),nodeKey=params.nodeKey,editDMAction={act:"editDM",formula:cfg.tokenStreamXML,isTokenStream:!mstrmojo.string.isEmpty(cfg.tokenStreamXML),afb:params.afb,sfb:params.sfb,dsid:cfg.dsid||"",did:cfg.did},actions=[model.addUpdateObjects(editDMAction,{id:cfg.did,type:4,flag:mstrmojo.DocDataService.PARTIAL_UPDATE_FLAGS.DATA_CHANGE})],callback=$FUNC.wrapMethods(model.getDatasetsUpdateCallback(),controller.getPartialUpdateCallback());if(nodeKey){actions.push(me.getUpdateTemplateAction(nodeKey,[{act:"renameUnit",id:cfg.did,type:4,name:cfg.alias,isDynamicAlias:true}]));}else{editDMAction.name=cfg.alias;}controller.submitUndoRedoUpdates(actions,null,callback);};},resetSelections:function resetSelections(unitKeyContext,disablePU,callback){submitRequest.call(this,{taskId:"resetSelections",rwb:this.rwb,unitKeyContext:unitKeyContext||"",usePartDisplay:disablePU?"0":"1",treesToRender:disablePU?3:2},callback);},setPreference:function setPreference(params,callback){submitRequest.call(this,{taskId:"setPreference",prefs:params},callback);},getObjectInfo:function getObjectInfo(params,callback){submitRequest.call(this,$COPY(params,{taskId:"getObjectInfo"}),callback,preserveUndo());},addSuppressData:function addSuppressData(extras){if(getTreesToRender(extras)===mstrmojo.DocDataService.EnumTreesToRender.NONE){$HASH.copy({params:{suppressData:true}},extras);}},uploadImageToServer:function(params,callback){var taskParams={taskId:"importImage",imageFieldName:"imageData",isEdit:1,fieldKey:params.fieldKey,fieldName:params.fieldName,imageName:encodeURIComponent(params.imageName),imageSize:params.imageSize,nodeKey:params.nodeKey,sectionKey:params.sectionKey};if(mstrApp.isSingleTier){var BASE64_MARKER=";base64,";taskParams.rwNodeKey=params.fieldGroupKey;taskParams.imageData=params.base64Str.split(BASE64_MARKER)[1]||params.base64Str;mstrApp.serverRequest(taskParams,callback);}else{taskParams.msgID=this.msgId;taskParams.imageData=params.imageData;mstrmojo.xhr.upload("POST",mstrConfig.taskURL,callback,taskParams);}}});mstrmojo.DocDataService.Update=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.DocDataService.Update",actions:null,callback:null,extras:null,init:function init(props){$COPY(props,this);this.actions=this.actions||[];this.callback=this.callback||{};this.extras=this.extras||{};},addActions:function addActions(actions){this.actions=this.actions.concat(ensureArray(actions));},addCallbacks:function addCallbacks(callback){this.callback=$FUNC.wrapMethods(this.callback,callback);},addExtras:function addExtras(extras){var newTrees=getTreesToRender(extras),oldTrees=getTreesToRender(this.extras);this.extras=$COPY(extras,this.extras);if(newTrees!==undefined&&oldTrees!==undefined){this.extras.style.params.treesToRender|=oldTrees;}},addUpdate:function addUpdate(update){this.add(update.actions,update.callback,update.extras);},setTreesToRender:function setTreesToRender(value){if(value){this.addExtras({style:{params:{treesToRender:value}}});}return this.extras.style.params.treesToRender;},add:function add(actions,callback,extras){if(actions){this.addActions(actions);}if(callback){this.addCallbacks(callback);}if(extras){this.addExtras(extras);}},submit:function submit(){var actions=this.actions,callback=this.callback,extras=this.extras;if(this.cmd){this.cmd.submit(actions,callback,extras);}else{this.ds.submitUpdates(actions,callback,extras);}}});mstrmojo.DocDataService.PUInfoType=null;mstrmojo.DocDataService.ExtrasType=null;mstrmojo.DocDataService.PROGRESS_CONFIG={showProgress:true,hideProgress:true,progressStateText:$PST,delay:true};mstrmojo.DocDataService.UNDO_KEY="undo";mstrmojo.DocDataService.REQUEST_DEFN_DATA={style:{params:{treesToRender:3}}};mstrmojo.DocDataService.REQUEST_ONLY_DEFINITION={style:{params:{treesToRender:1}}};mstrmojo.DocDataService.REQUEST_ONLY_DATASETS={style:{params:{treesToRender:0}}};mstrmojo.DocDataService.SUPPRESS_DATA={params:{suppressData:true}};mstrmojo.DocDataService.EMPTY_CALLBACK={success:mstrmojo.emptyFn};mstrmojo.DocDataService.CopyMoveDestinationType=null;mstrmojo.DocDataService.PARTIAL_UPDATE_FLAGS={FORMAT_CHANGE:1,DATA_CHANGE:2};mstrmojo.DocDataService.EnumTreesToRender={NONE:0,DEFN:1,DATA:2,BOTH:3};}());