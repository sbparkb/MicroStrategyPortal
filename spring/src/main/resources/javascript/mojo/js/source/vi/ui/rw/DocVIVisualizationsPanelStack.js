(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo._HasBuilder","mstrmojo._IsPanelStack","mstrmojo.string","mstrmojo.vi.ui.rw._IsPanelStack","mstrmojo._IsSelectorTarget","mstrmojo.vi.ui.rw.DockedPanelSelector","mstrmojo.vi.ui.rw._SavesChildPositions","mstrmojo.array");mstrmojo.requiresDescs(4780);var $ARR=mstrmojo.array,$STR=mstrmojo.string,OLD_LT_BG_CLR="#d6d6d6",DT_BG_CLR="#323335";function notifyPanelSelector(){this.selector.setPanels(this.panels,this.selectedIdx);this.doLayout();}function removePanel(panel){var panels=this.panels,deleteIdx=panels.indexOf(panel),deletedPanel=panels[deleteIdx],res;panels.splice(deleteIdx,1);res=this.removeChildren(deletedPanel);return res;}function changePanelPosition(panelToMove,from,to,childIdx,selectedIdx){var children=this.children,panels=this.panels;panels.splice(from,1);children.splice(childIdx,1);panels.splice(to,0,panelToMove);children.splice(childIdx+to-from,0,panelToMove);this.selectedIdx=selectedIdx;notifyPanelSelector.call(this);}mstrmojo.vi.ui.rw.DocVIVisualizationsPanelStack=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._HasBuilder,mstrmojo._IsPanelStack,mstrmojo.vi.ui.rw._IsPanelStack,mstrmojo._IsSelectorTarget,mstrmojo.vi.ui.rw._SavesChildPositions],{scriptClass:"mstrmojo.vi.ui.rw.DocVIVisualizationsPanelStack",markupString:'<div id="{@id}" class="mstrmojo-VIVizPanel {@cssClass}" style="{@cssText}"><div class="mstrmojo-VIVizPanel-content"></div><div class="mstrmojo-VIVizPanel-selector"></div><div class="mstrmojo-VIDND-mask"></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;},selectorNode:function(){return this.domNode.childNodes[1];},maskNode:function(){return this.domNode.lastChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod},layoutConfig:{h:{containerNode:"100%",selectorNode:"auto"},w:{containerNode:"100%",selectorNode:"100%"},xt:true},getLayoutOffsets:function getLayoutOffsets(){return{h:2,w:2};},panels:null,model:null,selector:null,children:[{scriptClass:"mstrmojo.vi.ui.rw.DockedPanelSelector",alias:"selector",slot:"selectorNode"}],postBuildRendering:function postBuildRendering(){this._super();var parent=this.parent,bgColor=parent&&parent.defn&&parent.defn.fmts&&parent.defn.fmts["background-color"];if(bgColor&&!(bgColor===OLD_LT_BG_CLR||bgColor===DT_BG_CLR)){this.domNode.style.backgroundColor=bgColor;}},addChildren:function addChildren(children,idx,silent,skipPanelSelector){var firstChild=children[0];if(firstChild&&firstChild.hasOwnProperty("k")){this.panels=(this.panels||[]).concat(children);if(!skipPanelSelector){notifyPanelSelector.call(this);}}return this._super(children,idx,silent);},removeChildren:function removeChildren(c,silent){if(c){var removedPanelKeys=[].concat(c).map(function(child){return child.k;});this.panels=(this.panels||[]).filter(function(panel){return removedPanelKeys.indexOf(panel.k)===-1;});}this._super(c,silent);},_set_children:function setCh(n,v,silent){if(v!==this.children){var selector=this.selector;if(selector){v.push(selector);}}return this._super(n,v,silent);},selectPanelDeferred:function(update,key,hasLoader,skipServerCall){if(key!==this.selectedKey){this._super(update,key,hasLoader,skipServerCall);}},onpanelSelected:function onpanelSelected(){notifyPanelSelector.call(this);this.getSelectedPanel().buildBoxLayout();},deletePanel:function deletePanel(panel){var stack=this,panels=this.panels,newSelectedPanel,deleteIdx=panels.indexOf(panel),selectedIdx=this.selectedIdx,toDelete,model=this.model,modelId=model.id,syncDefn=function(isDeleted){var model=mstrmojo.all[modelId],units=model.getCurrentLayoutDef().units||{},removeKeys=[panel.k];panel.children.forEach(function(child){var k=child.k;if(k){removeKeys.push(k);}});removeKeys.forEach(function(key){if(units[key]){if(isDeleted){units[key]._isDeleted=true;}else{delete units[key]._isDeleted;}}});},fnRemoveAndSelect=function(cmdMgr){if(stack.selectedIdx===stack.panels.length-1){stack.selectedIdx--;}toDelete=panel;removePanel.call(stack,panel);if(newSelectedPanel){var key=newSelectedPanel.k;if(!newSelectedPanel.defn.l&&cmdMgr){var update=stack.model.getDataService().newUpdateWithoutCmd();stack.selectPanelDeferred(update,key,false,true);update.cmd=cmdMgr.getInterimCmd();update.submit();}else{stack.selectPanel(key,false,true);if(cmdMgr){cmdMgr.getInterimCmd().completeSubmit();}}}syncDefn(true);};if(deleteIdx===selectedIdx){newSelectedPanel=panels[selectedIdx+(selectedIdx===panels.length-1?-1:1)];}var cmdMgr=model.cmdMgr(),actions=[model.getRemoveUnitAction(panel)];if(newSelectedPanel){actions.push(model.getSetCurrentPanelAction(newSelectedPanel));}model.execute({execute:function(){this.submitInterim(actions,{success:function(){fnRemoveAndSelect(cmdMgr);}},{params:{suppressData:true}});},urInfo:{silent:true,undo:function(){stack.addChildren([panel]);stack.selectPanel(panel.k,null,true);panels=stack.panels;changePanelPosition.call(stack,panel,panels.length-1,selectedIdx,stack.children.indexOf(panel),selectedIdx);toDelete=null;syncDefn(false);},redo:fnRemoveAndSelect},discard:function(){if(toDelete){toDelete.destroy();}}});},movePanel:function movePanel(fromIdx,toIdx){var panels=this.panels,panelToMove=panels[fromIdx],selectedIdx=this.selectedIdx,id=this.id;this.model.movePanel(panelToMove,toIdx,fromIdx,function(from,to){if(selectedIdx===from){selectedIdx=to;}else{if(from>selectedIdx&&to<=selectedIdx){selectedIdx++;}else{if(from<selectedIdx&&to>=selectedIdx){selectedIdx--;}}}var panelStack=mstrmojo.all[id];panelToMove=panelStack.children[$ARR.find(panelStack.children,"id",panelToMove.id)];changePanelPosition.call(panelStack,panelToMove,from,to,$ARR.find(panelStack.children,"k",panelToMove.k),selectedIdx);});},renamePanel:function renamePanel(panel,title){var id=this.id;this.model.renameRWUnitTitle(title,panel.title,panel.k,{success:function(newTitle){if(panel.destroyed===true){mstrmojo.all[id].panels.forEach(function(item){if(item.k===panel.k){panel=item;}});}panel.titleText=newTitle;panel.title=$STR.encodeHtmlString(newTitle);notifyPanelSelector.call(mstrmojo.all[id]);}});},addPanel:function addPanel(){var that=this,model=this.model,dataService=model.getDataService(),addedPanel,toDelete;this.controller.cmdMgr.execute({execute:function(){var update=dataService.newUpdate(this,null);addedPanel=model.addPanel(update,that);model.addVisualizationDeferred(update,addedPanel.k);model.selectNewPanel(update,addedPanel.k);update.submit();},urInfo:{disablePU:true,treesToRender:3},discard:function(){if(toDelete){toDelete.destroy();}}});},duplicatePanel:function duplicatePanel(panel){var stackId=this.id,panels,newPanel,toDelete;this.model.duplicatePanel(panel,this,this.builder,{undo:function(){var stack=mstrmojo.all[stackId];panels=stack.panels;newPanel=panels[panels.length-1];removePanel.call(stack,newPanel);toDelete=newPanel;stack.selectPanel(panel.k,false,true);},redo:function(){var stack=mstrmojo.all[stackId];stack.addChildren([newPanel]);stack.selectPanel(newPanel.k,null,true);toDelete=null;},discard:function(){if(toDelete){toDelete.destroy();}}});},getUIState:function getUIState(){var state={},panel=this.getSelectedPanel();state.pk=panel.k;state.boxState=panel.getBoxState();state.viUnitKey=this.model.getSelectedViUnit()&&this.model.getSelectedViUnit().k;return state;},restoreUIState:function restoreUIState(state){var panel=this.getSelectedPanel(),pk=state.pk;if(pk&&panel.k!==pk){this.selectPanel(pk,null,true);panel=this.getSelectedPanel();}var selectedUnitKey=state.viUnitKey;if(selectedUnitKey){var unit=panel.getUnitByKey(selectedUnitKey);if(unit){this.model.selectVIUnit(unit.id,true);}}var boxState=state.boxState;if(boxState!==panel.getBoxState()){panel.restoreBoxState(boxState);}}});}());