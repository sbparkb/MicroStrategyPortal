(function(){mstrmojo.requiresCls("mstrmojo.rw.DocController","mstrmojo.vi.ui.DocumentView","mstrmojo.vi.ui.VizGallery","mstrmojo.vi.models.DocModel","mstrmojo.ME.DerivedAttributeIDE","mstrmojo.hash","mstrmojo.func","mstrmojo.vi.ui.DatasetEditor","mstrmojo.vi.controllers.UICmdMgr","mstrmojo.vi.ui.editors.ConfirmSaveEditor","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.ui.editors.DerivedElementsEditor","mstrmojo.Label","mstrmojo.TextBox","mstrmojo.Button","mstrmojo.vi.models.DEConsolidation","mstrmojo.vi.ui.editors.RenameDEEditor","mstrmojo.expr","mstrmojo.models.FormatModel","mstrmojo.dom");mstrmojo.requiresClsP("mstrmojo.vi.factories","VisualizationTransitionFactory");mstrmojo.requiresDescs(221,1388,5414,5415,5421,5422,11812,13157,14719);var $VI=mstrmojo.vi,$FUNC=mstrmojo.func,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$DESC=mstrmojo.desc,$NWB=mstrmojo.Button.newWebButton,E=mstrmojo.expr,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$DOM=mstrmojo.dom;var EXP_PDF=3,EXP_EXCEL=4,SECOND_TO_MILLISECOND=1000;var SAVE_WAIT_BOX_CONFIG={config:{waitBoxCfg:{message:mstrmojo.desc(10492,"Saving...")}}};function openRenameDEEditor(w,view,action){var RENAME_DE_EDITOR_ID="mstrmojo-renameDerivedElement",editor=mstrmojo.all[RENAME_DE_EDITOR_ID]||mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.editors.RenameDEEditor",id:RENAME_DE_EDITOR_ID,title:(action.funcVal===-1)?$DESC(5414,"Create Group "):$DESC(5415,"Create Calculation")});editor.view=view;editor.action=action;editor.controller=w;editor.open();editor.set("title",(action.act.indexOf("edit")>=0)?$DESC(1388,"Rename"):(action.funcVal===-1)?$DESC(5187,"Group"):$DESC(5188,"Calculation"));editor.children[0].name.set("value",action.deName);}function saveBoxLayoutAndExecuteFn(fn,args,extra){var controllerId=this.id;this.view.layoutViewer.saveBoxLayout(undefined,undefined,{success:function success(){fn.apply(mstrmojo.all[controllerId],args);}.bind(this)},undefined,extra);}function unlinkBeforeEditingDA(model,srcAttrId,attrForms,cb){var me=this,srcForms=[],tgtAttributes=[],tgtForms=[],ITEM_SEPARATOR="\u001E",unlinkCb=$FUNC.wrapMethods({success:function(res){model.als=res.als;}},model.controller.getRefreshCallback());$ARR.forEach(attrForms,function(fm){var links=model.als&&model.als.links[srcAttrId+" "+fm.fid];$ARR.forEach(links,function(al){srcForms.push(fm.fid);var tgt=al.split(" ");tgtAttributes.push(tgt[0]);tgtForms.push(tgt[1]);});});if(srcForms.length>0){var tgtAttrId=tgtAttributes[0],tgtAttrName=null,srcAttrName=null;$HASH.forEach(model.datasets,function(ds){$ARR.forEach(ds.att,function(item){if(item.did===tgtAttrId){tgtAttrName=item.n;}else{if(item.did===srcAttrId){srcAttrName=item.n;}}if(tgtAttrName&&srcAttrName){return false;}});if(tgtAttrName&&srcAttrName){return false;}});new mstrmojo.Editor({params:null,cssClass:"mstrmojo-ConfirmEditLink-Editor",title:$DESC(11812,"Notification"),onPreClose:function onPreClose(){cb.canceled();this.hideTooltip();return true;},children:[{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Warning-Box",children:[{scriptClass:"mstrmojo.Box",cssClass:"icon"},{scriptClass:"mstrmojo.Label",text:$DESC(13157,"## and ### are linked. You need to unlink these attributes to make changes to ##.").replace("###",tgtAttrName).replace(/##/g,srcAttrName),cssClass:"message"}]},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",cssClass:"mstrmojo-Editor-buttonBar",children:[{scriptClass:"mstrmojo.Box"},$NWB(mstrmojo.desc(13156,"Unlink and Edit"),function(){var editor=this.parent.parent,act={act:"applyAttributeLinking",srcAttrId:srcAttrId,srcFormId:srcForms.join(ITEM_SEPARATOR),tgtAttrId:tgtAttributes.join(ITEM_SEPARATOR),tgtFormId:tgtForms.join(ITEM_SEPARATOR),unlink:true};me.cmdMgr.execute({execute:function(){this.submit(act,$FUNC.wrapMethods(unlinkCb,cb));},urInfo:{callback:unlinkCb}});editor.close();},true,{width:"100px"}),$NWB(mstrmojo.desc(221,"Cancel"),function(){cb.canceled();this.parent.parent.close();})]}]}).render();}else{cb.success();}}function newDSPanelForAttrEditor(docModel,ignoreMetric){var me=this,fnFilter=function(items){var act=me.daIDE.action,editId=act.did,hasCGorConsolidation=false;items=$ARR.filter(items,function(itm){var isCGorConsolidation=(itm.t===1||itm.t===47),isNDE=(itm.t===47&&itm.st===12033);hasCGorConsolidation|=(isCGorConsolidation&&!isNDE);return itm.did!==editId&&!itm.um&&!itm.rdm&&!itm.de&&!isCGorConsolidation&&!isNDE&&(!ignoreMetric||itm.t!==4);});if(hasCGorConsolidation||docModel.isMDXDataset(this.dataset.set)){items=$ARR.filter(items,function(itm){return itm.t!==4;});}return items;},dsFnFilter=function(datasets){var filteredDatasets={};$HASH.forEach(datasets,function(dataset,id){dataset.isMDX=docModel.isMDXDataset(dataset);dataset.isDDA=docModel.isDDADataset(dataset);if(!$DU.hasCGorCon(dataset)&&!(dataset.isMDX&&dataset.isDDA)){filteredDatasets[id]=dataset;}});return filteredDatasets;},filterNodeCfg=ignoreMetric?{att:false,mx:false}:undefined;return $HASH.copy({doubleClickItemHandler:function(item){me.daIDE.onObjectInsert(item);}},docModel.getDatasetsPanel("190px",fnFilter,dsFnFilter,filterNodeCfg));}function refreshDocument(docCtrl,callback){docCtrl.model.getDataService().refresh({styleName:"JsonRWDStyle"},$FUNC.wrapMethods(docCtrl.getRefreshCallback(),callback));}function hasDataSource(model){return !!Object.keys(model.datasets||{}).length;}function syncRequestForOneTier(){if(mstrApp.isSingleTier){var formWrapper=window.FormWrapper;if(formWrapper){formWrapper.serverRequest("syncRequests","","","");}}}mstrmojo.vi.controllers.DocumentController=mstrmojo.declare(mstrmojo.rw.DocController,null,{scriptClass:"mstrmojo.vi.controllers.DocumentController",model:null,datasetsPanel:null,rootCtrl:null,view:null,visTransitionFactory:null,cmdMgr:null,refStartTime:0,remTimeForRef:0,autoRefReqSent:false,autoRefReqId:undefined,start:function start(documentData){var model=new mstrmojo.vi.models.DocModel(documentData),rootCtrl=this.rootCtrl;model.lastSavedStid=model.stid||0;model.controller=this;var cmdMgr=this.cmdMgr=new mstrmojo.vi.controllers.UICmdMgr({controller:this,model:model});cmdMgr.dataService=model.getDataService();this.datasetsPanel=rootCtrl.setDatasetObjectsPanel(model.getDocDatasetsPanel());var visTransitionFactory=this.visTransitionFactory=new $VI.factories.VisualizationTransitionFactory(),layoutXml=documentData.defn.root.layoutXML,galleryOpen=layoutXml?!!layoutXml.go:true;var gallery=new $VI.ui.VizGallery({model:model,visible:galleryOpen&&mstrApp.allowWebDashboardDesign()});rootCtrl.setGalleryView(gallery);var layoutsCacheSize=parseInt(mstrApp.viLayoutsCacheSize);var view=this.view=new $VI.ui.DocumentView({controller:this,model:model,hasDataSource:hasDataSource(model),LAYOUTS_CACHE_SIZE:layoutsCacheSize>=0?layoutsCacheSize:10});this.set("model",model);rootCtrl.setDocumentView(view);if(mstrApp!==undefined&&window.mstrLocalStorage!==undefined){mstrLocalStorage.addScreenshot(mstrApp.getLastMsgRecoveryInfo(),view.domNode);}model.attachEventListener("updateDatasets",this.id,function(){view.set("hasDataSource",hasDataSource(model));});this.addDisposable([cmdMgr,visTransitionFactory,model,gallery,view]);if(mstrApp&&mstrApp.onDocReady){mstrApp.onDocReady();}},build:function build(){this.view.buildChildren();},submitUndoRedoTemplateUpdates:function submitUndoRedoTemplateUpdates(view,actions,callback,extras,urInfo){this.submitUndoRedoTemplateWithCallback(view,this.dataService().getUpdateTemplateAction(view.k,actions),callback,extras,urInfo);},submitUndoRedoTemplateWithCallback:function submitUndoRedoTemplateWithCallback(view,actions,callback,extras,urInfo){this.submitUndoRedoUpdates(actions,{},$FUNC.wrapMethods(this._getXtabCallback(view),callback),extras,urInfo);},submitUndoRedoUpdates:function submitUndoRedoUpdates(actions,undoActions,callback,extras,urInfo){this.cmdMgr.execute({execute:function(){this.submit(actions,callback,extras);},urInfo:$HASH.copy(urInfo,{callback:callback})});},convertToDoc:function convertToDoc(){saveBoxLayoutAndExecuteFn.call(this,this._super,[true]);},save:function save(params,target){syncRequestForOneTier();saveBoxLayoutAndExecuteFn.call(this,this._super,[].concat(params||{}).concat(target||[]),SAVE_WAIT_BOX_CONFIG);},printPDF:function prntPDF(gridKey){saveBoxLayoutAndExecuteFn.call(this,this._super,[gridKey]);},print:function print(gridKey){if($DOM.isChrome||($DOM.isSafari&&$DOM.isMac())){var me=this;this.rootCtrl.togglePrintPreview(true);var funcMatchMedia=window.matchMedia;if(funcMatchMedia){var mediaQueryList=funcMatchMedia("print");function handleAfterPrint(mql){var afterPrint=function(){me.rootCtrl.togglePrintPreview(false);mediaQueryList.removeListener(handleAfterPrint);};if(!mql.matches){afterPrint();}}mediaQueryList.addListener(handleAfterPrint);}window.setTimeout(function(){window.print();},1300);}else{this.printPDF(gridKey);}},exportVisualization:function exportVisualization(viz,mode){var EXPORT_WARNING_THRESHOLD=10000000;var rw=viz.node.data.rw,fnExport=function(){switch(mode){case EXP_PDF:this.printPDF(viz.k);break;case EXP_EXCEL:this.exportExcel(viz.k);break;}}.bind(this);if(rw&&(rw.col.tc*rw.row.tc>EXPORT_WARNING_THRESHOLD)){mstrmojo.warn(mstrmojo.desc(14017,"Exporting the dashboard may take a few minutes. Do you want to export anyway?"),undefined,{buttons:[$NWB(mstrmojo.desc(246,"Export"),fnExport),$NWB(mstrmojo.desc(221,"Cancel"),undefined,true)]});}else{fnExport();}},dSave:function dSave(saveCB){var docCtrl=this,_super=this._super,docModel=docCtrl.model,fnSave=function(){docModel.getDataService().submitUpdates({},{success:function(res){var NIB=function(text,hot,visible,fn){return mstrmojo.Button.newWebButton(text,fn,hot,{visible:visible,cssDisplay:"inline-block"});};if(res.objects[0]&&res.objects[0].dvm===2048){var allowOverwrite=docCtrl.rootCtrl.resolveFeature("warn-overwrite-flashVI");mstrmojo.warn(mstrmojo.desc(12188,""),null,{cssClass:"save-over",buttons:[NIB(mstrmojo.desc(12190,"Save Over"),false,!!allowOverwrite,function(){_super.call(docCtrl,saveCB);}),NIB(mstrmojo.desc(12191,"Save as New"),true,true,function(){docModel.saveAsRW();}),NIB(mstrmojo.desc(2223,"Cancel"),false,true)]});}else{_super.call(docCtrl,saveCB);}}},$HASH.copy(SAVE_WAIT_BOX_CONFIG,{params:{taskId:"getObjectInfo",objectIDs:docCtrl.model.oid,objectTypes:"55"}}));};syncRequestForOneTier();saveBoxLayoutAndExecuteFn.call(this,mstrApp.isSingleTier?this._super:fnSave,undefined,SAVE_WAIT_BOX_CONFIG);},openDME:function(opener,config,fnOk){var me=this,model=me.model,fnFilter=function filterDatasetsUnits(items){return mstrmojo.array.filter(items,function(item){return item.st!==E.STP.CONS&&item.st!==E.STP.CUSTOMGROUP&&item.did!==config.metricId;});},metricIDE=new mstrmojo.ME.DerivedMetricIDE({datasetsObjects:mstrmojo.hash.copy({visible:false},model.getDatasetsPanel("190px",fnFilter)),zIndex:5});config.onApplyMetricCallback=fnOk;config.datasets=model.datasets;metricIDE.open(opener,config);metricIDE.datasetsObjects.refresh();this.addDisposable([metricIDE]);},openDAE:function openDAE(view,config,fnWait,onAttribute){var m=this.model,derivedAttrIDE=this.daIDE=new mstrmojo.ME.DerivedAttributeIDE({datasetsObjects:newDSPanelForAttrEditor.call(this,m),zIndex:5}),me=this,submitAction=function(params,cb){var cfg=derivedAttrIDE.action,fnPreCreate=cfg.did?cfg.preupdate:cfg.precreate,callbacks=m.controller.getRefreshCallback();params=fnPreCreate?fnPreCreate(params):params;me.submitUndoRedoUpdates(params,null,$FUNC.wrapMethods(cb,callbacks),cfg.extras);};$HASH.copy({cmd:"editNew",fnWait:fnWait,msgID:m.mid,oncreate:submitAction,onupdate:submitAction},config);if(onAttribute){config.funccat=mstrmojo.ME.DerivedAttributeIDE.getDefaultFunctionCategory(onAttribute);var dfm=onAttribute.fs&&onAttribute.fs[0];if(dfm){config.refOi={n:onAttribute.n+"@"+dfm.fnm,did:onAttribute.did+"@"+dfm.fid};}}derivedAttrIDE.action=config;derivedAttrIDE.view=view;if(config.did){unlinkBeforeEditingDA.call(this,m,config.did,config.forms,{success:function success(){derivedAttrIDE.open(view,{editorId:config.id});},failure:function failure(){derivedAttrIDE.destroy();},canceled:function canceled(){derivedAttrIDE.destroy();}});}else{derivedAttrIDE.open(view,{editorId:config.id});}this.addDisposable([derivedAttrIDE]);},openDynamicLinkEditor:function openDynamicLinkEditor(view,config,fnWait,onAttribute){var m=this.model,dynamicLinkIDE=this.daIDE=new mstrmojo.ME.DerivedAttributeIDE({datasetsObjects:newDSPanelForAttrEditor.call(this,m,true),zIndex:5,hasFunctionBrowser:false,onObjectInsert:function(items){mstrmojo.all.mstrDLE.onObjectInsert(items);}}),me=this,submitAction=function(params,cb){var cfg=dynamicLinkIDE.action,fnPreCreate=cfg.did?cfg.preupdate:cfg.precreate,callbacks=m.controller.getRefreshCallback();params=fnPreCreate?fnPreCreate(params):params;me.submitUndoRedoUpdates(params,null,$FUNC.wrapMethods(cb,callbacks),cfg.extras);};$HASH.copy({cmd:"editNew",fnWait:fnWait,msgID:m.mid,oncreate:submitAction,onupdate:submitAction},config);if(onAttribute){config.refOi=onAttribute;config.n=onAttribute.n+mstrmojo.desc(14719,"(Link)");}dynamicLinkIDE.action=config;dynamicLinkIDE.view=view;if(config.did){unlinkBeforeEditingDA.call(this,m,config.did,config.forms,{success:function success(){dynamicLinkIDE.open(view,{editorId:"mstrDLE"});},failure:function failure(){dynamicLinkIDE.destroy();},canceled:function canceled(){dynamicLinkIDE.destroy();}});}else{dynamicLinkIDE.open(view,{editorId:"mstrDLE"});}this.addDisposable([dynamicLinkIDE]);},getReloadLayoutViewCallback:function getRepaintLayoutCallback(callback){var view=this.view;return $FUNC.wrapMethods({success:function(){view.showSelectedLayout();}},callback);},getRefreshCallback:function getRefreshCallback(){var m=this.model;return $FUNC.wrapMethods(m.getDatasetsUpdateCallback(),m.getReloadLayoutModelCallback(),this.getReloadLayoutViewCallback());},getUpdateLayoutViewCallback:function getUpdateLayoutViewCallback(callback){var view=this.view;return $FUNC.wrapMethods({success:function(res){view.updateLayouts(res);}},callback);},getUpdateLayoutsCallback:function getUpdateLayoutsCallback(){var m=this.model;return $FUNC.wrapMethods(m.getDatasetsUpdateCallback(),this.getUpdateLayoutViewCallback());},getPartialUpdateCallback:function getPartialUpdateCallback(callback){var targetDefinitions={},me=this,model=me.model,zonesModel=model.getSelectedViUnit().getZonesModel();return $FUNC.wrapMethods({success:function(res){var puKeys=res.pukeys&&res.pukeys.split("\u001E");if(puKeys&&puKeys.length>0){targetDefinitions=model.getUnitDefinitions(puKeys);}model.partialUpdate(res.data,targetDefinitions,res.defn,puKeys);}},model.getUpdateHiddenLayoutsCallback(),callback||zonesModel&&zonesModel.getUpdateCallback());},resumeVIPanelSelection:function resumeVIPanelSelection(callback){function getPanelContainer(layout){var panelContainers=mstrmojo.array.filter(layout.children,function(child){return child instanceof mstrmojo.vi.ui.BoxPanelContainer;});return panelContainers&&panelContainers[0];}function getTabList(controller){var curLayout=controller.view&&controller.view.getSelectedLayoutWidget(),panel=curLayout&&getPanelContainer(curLayout);return panel&&panel.tabList;}var me=this,tabList=getTabList(this),preSelection=tabList&&tabList.selectedIndex;return $FUNC.wrapMethods({success:function(){var tabList=getTabList(me);if(tabList){tabList.singleSelect(preSelection);}}},callback);},insertVisualization:function insertVisualization(){this.model.addVisualization();},insertFilter:function insertFilter(){this.model.insertNewFilter();},getViPanel:function getViPanel(type){return this.view.getViPanel(type);},openViPanel:function openViPanel(type,callback){this.view.openViPanel(type,callback);},selectViPanel:function selectViPanel(type){this.view.selectViPanel(type);},insertText:function insertText(){this.model.insertNewText();},insertHtml:function insertHtml(){this.model.insertNewHtmlContainer();},clearAllUnits:function clearAllUnits(){this.model.getSelectedViUnit().getZonesModel();},insertImage:function insertImage(){this.model.insertNewImage();},_getXtabCallback:function _getXtabCallback(xtab,callback,updateDefn){return $FUNC.wrapMethods(this._super(xtab,updateDefn),callback||(xtab.parent.getZonesModel&&xtab.parent.getZonesModel().getUpdateCallback()));},refresh:function refresh(){refreshDocument(this);},toggleAutoRefresh:function(){this[(!!this.isAutoRefreshStarted()?"stop":"start")+"AutoRefresh"]();},startAutoRefresh:function startAutoRefresh(){var model=this.model,rf=model.rf,me=this;if(rf>0){if(this.autoRefreshHandler){this.stopAutoRefresh();}this.refStartTime=new Date();this.autoRefreshHandler=setTimeout(function(){refreshDocument(me,{success:function success(){if(me.autoRefreshHandler){me.startAutoRefresh();}},submission:function submission(requestId){me.autoRefReqId=requestId;me.autoRefReqSent=true;},complete:function complete(){me.autoRefReqId=undefined;me.autoRefReqSent=false;me.remTimeForRef=0;}});},((this.remTimeForRef!==0)?this.remTimeForRef:rf)*SECOND_TO_MILLISECOND);}},pauseAutoRefresh:function pauseAutoRefresh(){if(this.autoRefreshHandler){clearTimeout(this.autoRefreshHandler);this.remTimeForRef=this.model.rf-(new Date().getTime()-this.refStartTime.getTime())/SECOND_TO_MILLISECOND;}},addDataset:function addDataset(){var controller=this,dataService=controller&&controller.datasetsPanel,showDatasetPicker=dataService&&dataService.getShowDatasetPicker();if(showDatasetPicker){showDatasetPicker();}},createDataset:function createDataset(){var controller=this,datasetPanel=controller&&controller.datasetsPanel;if(datasetPanel){datasetPanel.openDatasetEditor({title:mstrmojo.desc(13362,"Report Editor")+" - "+mstrmojo.desc(11636,"New Dataset"),okBtnText:mstrmojo.desc(4447,"Add"),docModel:controller.model});}},undo:function undo(){this.cmdMgr.undo();},redo:function redo(){this.cmdMgr.redo();},onCmdMgrChanged:function onCmdMgrChanged(){mstrApp.rootCtrl.generateToolbar();},importFile:function importFile(){var controller=this.model&&this.model.controller,model=this.model,dataService=controller&&controller.datasetsPanel,ds=[];$HASH.forEach(model.datasets,function(dataset){if(dataset.st===779&&model.hasPrivilegesForAllTables(dataset.tables)){ds.push(dataset);}});if(dataService&&dataService.showDataImport){dataService.showDataImport({isEdit:false,datasets:ds,AnalysisId:this.model.mid,needDefn:true});}},inputConnectionDetails:function inputConnectionDetails(existingConnection){var docController=this;if(existingConnection&&Object.keys(existingConnection).length>0){this.model.existingServerConnection=existingConnection;}else{existingConnection=this.model.existingServerConnection;}this.model.operation="inputConnectionDetails";var resumeDashboardExecution=function(){if(docController.model.operation==="inputConnectionDetails"){docController.model.operation="none";}mstrApp.serverRequest({taskId:"resumeDashboardExecution",checkCS:true},{success:function success(res){if(res&&res.statusOnly!==true){mstrApp.start(res);}}},{doNotHold:true});};var changeConnectionString=function(dataProvider){if(existingConnection&&dataProvider&&dataProvider.currentProject&&dataProvider.currentProject.project.id===existingConnection.datasets[0].connInfo.pid){mstrApp.serverRequest({taskId:"changeConnString",ws:dataProvider.currentProject.webServer.connection.id,isn:dataProvider.currentProject.iServer.name,isp:dataProvider.currentProject.iServer.port,pn:dataProvider.currentProject.project.name,pid:dataProvider.currentProject.project.id},{success:function success(res){resumeDashboardExecution();},failure:function failure(res){mstrmojo.error({shortDesc:mstrmojo.desc(14397,"Something went wrong when changing the connection string.")});}},{doNotHold:true});}else{if(existingConnection&&dataProvider&&dataProvider.currentProject.project.id!==existingConnection.datasets[0].connInfo.pid){mstrmojo.error({shortDesc:"We cannot find the dataset(s) in the logged in server. Please try a different server or edit the connection by going to preferences."});}else{}}};this.rootCtrl.loadDataProvider(changeConnectionString);},inputCredentials:function inputCredentials(documentModel){var controller=this.model&&this.model.controller,dataService=controller&&controller.datasetsPanel;if(dataService&&dataService.showDataImport){dataService.showDataImport({documentModel:documentModel,StatusCode:4,callback:function(){mstrApp.serverRequest({taskId:"resumeDashboardExecution"},{success:function success(res){if(res&&res.statusOnly!==true){mstrApp.start(res);}}},{doNotHold:true});}});}},isDocChanged:function isDocChanged(){var model=this.model,currentStateId=model.getDataService().stid||0,lastSavedStateId=model.lastSavedStid||0;return currentStateId>lastSavedStateId;},saveBeforeClosing:function saveBeforeClosing(saveCB,target){var me=this,m=me.model,isNew=m&&m.isnew,isRWReadonly=m&&m.isRWReadonly,fnDirectRun=function(){if(saveCB&&saveCB.success){saveCB.success();}if(saveCB&&saveCB.complete){saveCB.complete();}};if(this.isDocChanged()&&this.rootCtrl.resolveFeature("save-analysis")){var fnDestroy=function(){this.close();this.destroy();},cse=new mstrmojo.vi.ui.editors.ConfirmSaveEditor({onSave:function(){if(isNew||isRWReadonly){me.save(null,target);}else{me.dSave(saveCB);}fnDestroy.call(this);},onDonotSave:function(){fnDirectRun();fnDestroy.call(this);},onCancel:function(){fnDestroy.call(this);}});cse.open();}else{fnDirectRun();}},openDEEditor:function openDEEditor(grid,params){var me=this,DE_EDITOR_ID="mstrmojo-derivedElements",editor=mstrmojo.all[DE_EDITOR_ID]||mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.editors.DerivedElementsEditor",id:DE_EDITOR_ID}),deObj=params.deObj,fromDS=params.fromDatasetPanel,deModel,elemId;if(params.elemId){elemId=params.elemId;delete params.elemId;}deModel=new mstrmojo.vi.models.DEConsolidation(params);deModel.xtab=fromDS?null:grid;deModel.docModel=fromDS?grid.docModel:grid.model.docModel;deModel.controller=me;deModel.fromDS=fromDS;editor.browseConfig={attributeID:params.attId||deObj.attId,datasetID:(params&&params.dsId)||(deObj&&deObj.dsId),messageID:me.model.mid};editor.set("model",deModel);editor.open();if(elemId||!params.deObj){editor.editItem(elemId);}},onAddQuickDE:function onAddQuickDE(view,action){var me=this;openRenameDEEditor(me,view,action,"addQuickDE");},onEditQuickDEList:function editQuickDEList(view,action){var me=this;openRenameDEEditor(me,view,action,"editQuickDEList");},onEditQuickDECalculation:function onEditQuickDECalculation(view,action){var me=this;openRenameDEEditor(me,view,action,"editQuickDECalculation");},onSetDEHierachyOptions:function onToggleOthersDE(view,action){this.submitDEAction(view,action);},editQuickDECalculation:function editQuickDECalculation(view,action){this.submitDEAction(view,action);},editQuickDECalculationNumberFormat:function editQuickDECalculationNumberFormat(view,action){this.submitDEAction(view,action);},removeQuickDE:function removeQuickDE(view,action){this.submitDEAction(view,action);},submitDEAction:function submitDEAction(view,templateAction){this._addNodeKeyToAction(view,templateAction);var action=this.dataService().getUpdateTemplateAction(view.k,templateAction),model=this.model;model.addUpdateObjects(action,{id:templateAction.oId,type:47,flag:mstrmojo.DocDataService.PARTIAL_UPDATE_FLAGS.DATA_CHANGE});this.submitUndoRedoUpdates([action],{},$FUNC.wrapMethods(model.getRebuildCallback(),model.getDatasetsUpdateCallback()));},addDSFromDatabase:mstrmojo.emptyFn,addDSFromFreeform:mstrmojo.emptyFn,dataService:function dataService(){return this.model.getDataService();},close:function close(){var closeFn=this._super.bind(this);mstrApp.onNavigateOut(null,closeFn);},onKeepOnlyOrExcludeNodeAdded:function onKeepOnlyOrExclude(visModel,visData,submitFn){var filterExpression=visData.vfexpr,limitExpression=visData.vlexpr,existingSelectorData=visModel.getSelectorDataFromViewFilter(filterExpression);if(limitExpression||existingSelectorData===null){mstrmojo.warn(mstrmojo.desc(null,"This action will overwrite the advanced qualification set in the filter. Do you want to proceed?"),{confirmBtn:{fn:submitFn}});}else{submitFn();}},applyKeepOnly:function applyKeepOnly(visualization,callback,nodeToAdd,nodeIdxToRemove){var visModel=visualization.model,data=visualization.gridData||visualization.model.data||visualization.node.data,filterExpression=data.vfexpr,limitExpression=data.vlexpr,submitUpdates=function(selectorData){var info=visModel.getKeepOnlyActionsForAssociatedNodes(selectorData||[],callback);if(limitExpression){info.actions.push(this.dataService().getUpdateTemplateAction(visualization.k,visModel.getRemoveMetricLimitsAction(limitExpression)));}this.submitUndoRedoUpdates(info.actions,null,info.callback);}.bind(this),newSelectorData;if(nodeIdxToRemove===-1){newSelectorData=[];}else{newSelectorData=[].concat(visModel.getSelectorDataFromViewFilter(filterExpression));}if(nodeIdxToRemove===-2){newSelectorData=mstrmojo.array.filter(newSelectorData,function(e){return !e.keepOnly;});}else{if(nodeIdxToRemove>=0){newSelectorData.splice(nodeIdxToRemove,1);}}if(nodeToAdd){this.onKeepOnlyOrExcludeNodeAdded(visModel,data,function(){submitUpdates(newSelectorData.concat(nodeToAdd));});}else{submitUpdates(newSelectorData);}},openCubeBrowser:function openCubeBrowser(callback){mstrApp.rootCtrl.openCubeBrowser(callback);},browseObjectsOnServer:function(){var me=this.datasetsPanel;var controller=this;function callback(){if(mstrApp.browseAllObjects===false){mstrmojo.alert(mstrmojo.desc(14332,"You do not have the privileges to browse the objects in this project."));}else{me.set("allObjectBrowserOpened",true);}controller.model.operation="none";}this.model.operation="browseAllObjects";var dsPanel=mstrApp.rootCtrl.datasetsPanel;dsPanel.model.controller.rootCtrl.loadDataProvider(function(dataProvider){dsPanel.objectBrowser.set("dataProvider",dataProvider);callback();});},uploadImageToServer:function(params,callback){var dataService=this.dataService();dataService.uploadImageToServer(params,callback);}});}());