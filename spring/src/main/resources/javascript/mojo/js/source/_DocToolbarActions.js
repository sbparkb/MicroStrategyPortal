(function(){mstrmojo.requiresCls("mstrmojo.form","mstrmojo.hash","mstrmojo.date","mstrmojo.dom","mstrmojo.NumberFormat","mstrmojo.Button");var $DESC=mstrmojo.desc,$CSS=mstrmojo.css,$NWB=mstrmojo.Button.newWebButton,$D=mstrmojo.date,$FUNC=mstrmojo.func,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$NF=mstrmojo.NumberFormat.getInstance(mstrConfig.decimalSep,mstrConfig.thousandsSep),DSSID_FIT_WIDTH="1:Width",DSSID_FIT_PAGE="2:Page",TOOLBAR_HEIGHT=44,TAB_LAYOUT_HEIGHT=28,GROUPBY_BAR_HEIGHT=29,SCROLLBAR_SIZE=17,getDateTime=function(){return mstrmojo.locales.datetime;};function checkSessionAndSendForm(params,action,method,target){var sm=mstrApp.sessionManager;if(sm&&sm.sessionTimedout){sm.openLoginEditor({success:function(){if(target!=="_blank"&&target!=="mstrExportWindow"){mstrApp.showWait();}mstrmojo.form.send(params,action,method,target);}});}else{if(target!=="_blank"&&target!=="mstrExportWindow"){mstrApp.showWait();}mstrmojo.form.send(params,action,method,target);}}function toPage(params){checkSessionAndSendForm(params,null,"post");}function toMode(docCtrl,mode){var m=docCtrl.model;var conf={evt:2048001,messageID:m.mid,rwb:m.bs};if(mode<50||mode===2048){conf.visMode=0;conf.currentViewMedia=mode;}else{conf.visMode=mode;conf.currentViewMedia=1;}toPage(conf);}function getReturnHref(){var nb=mstrApp.pathInfo.nb,idx=mstrmojo.array.find(nb,"n","Return");return idx>-1?nb[idx].href:null;}function handleClose(me){var m=me.model,params={};var returnUrl=getReturnHref();if(m.isnew){if(parseInt(m.ecf,10)===32||(mstrApp.prevPageHref&&mstrApp.prevPageHref!=="#"&&!mstrApp.isHomePage)||mstrApp.isOIVM&&mstrApp.isOIVM()){params.evt=3124;params.relativePageNumber="-1";params.src=m.bp+".3124";params.rwb=m.bs;toPage(params);return ;}else{params.evt=mstrApp.preferences.startPage=="3187"?3060:3010;}}else{if(mstrApp.isVI&&returnUrl&&returnUrl!=="#"){mstrmojo.form.sendLinkAsForm(returnUrl);return ;}else{params.evt=2001;params.folderID=m.pfid;if(m.sysFolder){params.systemFolder=m.sysFolder;}}}toPage(params);}function reload(docCtrl,reprompt,refresh,regen){var m=docCtrl.model;toPage({evt:2048030,src:m.bp+".2048030",rePrompt:reprompt,fresh:refresh,regenerate:regen,rwb:m.bs});}function updateZoomValue(docCtrl,bSuppressEvt){var m=docCtrl.model,zt=(m&&m.zt)||0,zf,n,newid;switch(zt){case 1:zf="Width";newid=DSSID_FIT_WIDTH;n=$DESC(4809);break;case 2:zf="Page";newid=DSSID_FIT_PAGE;n=$DESC(4808);break;default:zf=(m&&m.getZoomFactor())||1;newid=zt+":"+$NF.format(zf);n=parseInt(zf*100,10)+"%";}var ops=docCtrl.zoomOptions,newv;if(ops){var idx=mstrmojo.array.find(ops,"dssid",newid);if(idx>-1){newv=ops[idx];}}if(!newv){newv={n:n,dssid:newid,f:zf,tp:zt};}if(bSuppressEvt===true){docCtrl.view.zoomValue=newv;}else{docCtrl.view.set("zoomValue",newv);}}function prompt2save(me,title,helpTopic,msg,fn,params,saveParam,promptNewOnly){var m=me.model,dty=m&&m.dty,isnew=m&&m.isnew;if(!promptNewOnly&&!dty||promptNewOnly&&!isnew){fn(params);return ;}mstrmojo.warn(msg,{confirmBtn:{t:mstrmojo.desc(118,"Save"),fn:function(){mstrmojo.requiresCls("mstrmojo.Serializer");me.save(saveParam);}},cancelBtn:{t:mstrmojo.desc(2140,"Cancel")}},{title:title||mstrmojo.desc(11812,"Notification"),help:helpTopic});}function forceSaveAs(me){var m=me.model;m.showDialogBeforeSave=false;m.getDataService().setPreference("askBeforeSaveChanges\u001E2",{success:mstrmojo.emptyFn,failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}});}var EXP_HTML=-1,EXP_PDF=3,EXP_EXCEL=4,EXP_FLASH=7,EXP_CSV=10,EXP_MSTR=18;mstrmojo._DocToolbarActions=mstrmojo.provide("mstrmojo._DocToolbarActions",{_mixinName:"mstrmojo._DocToolbarActions",staticViewMode:function svm(){toMode(this,1);},interactiveViewMode:function ivm(){toMode(this,2);},editableMode:function evm(){toMode(this,4);},flashViewMode:function fvm(){toMode(this,8);},IVEMode:function ive(){toMode(this,2048);},IVEHelp:function ive(){var helpUrl=(mstrApp.helpUrl||"../help/")+"WebUser/WebHelp/Lang_"+(mstrApp.helpLocaleId||mstrApp.localeId)+"/MicroStrategy_Web_Help.htm#";window.open(helpUrl+"about_interactive_visual_data_exploration.htm","_blank");return true;},remainExpressViewMode:function remainExpress(){},designViewMode:function dvm(evt,convertFromVI){toPage({evt:3104,rwDesignMode:1,convertFromVI:(convertFromVI===true)?1:0,messageID:this.model.mid,rwb:this.model.bs,jsonMode:false});},onmodelChange:function onmodelChange(){updateZoomValue(this,true);},convertToDoc:function ctd(convertFromVI){var me=this;if(me.model.hasMDXRADataset()){mstrmojo.alert(mstrmojo.desc(14692,'The "Convert to Document" option is currently not available for MDX cube with Hierarchical Attributes.'),null,mstrmojo.desc(3610,"MicroStrategy Web"));}else{mstrmojo.warn(mstrmojo.desc(13653,"Converting a dashboard to a document cannot be undone. Do you want to convert?"),{confirmBtn:{t:mstrmojo.desc(13654,"Convert"),fn:function(){me.designViewMode(undefined,convertFromVI);}},cancelBtn:{t:mstrmojo.desc(221,"Cancel")}},{title:mstrmojo.desc(5180,"Convert to Document")});}},saveAs:function(evt){this.save();},save:function save(param,target){if(mstrApp.isSingleTier){FormWrapper.saveas();return ;}this.model.saveAsRW(param,target);},dSave:function dSave(saveCB){var me=this,m=me.model,isNew=m&&m.isnew,isRWReadonly=m&&m.isRWReadonly,maxLen=60,truncateName=m.n;if(mstrApp.isSingleTier){FormWrapper.save();return ;}if(truncateName.length>maxLen){truncateName=truncateName.substr(0,maxLen-1)+"...";}if(isNew||isRWReadonly){this.save();}else{var _showDialogBeforeSave=mstrApp.features["ask-before-save-changes"];if(_showDialogBeforeSave){var id="dialogBeforeSave",fnDestroy=function(){mstrmojo.all.dialogBeforeSave.destroy();};mstrmojo.insert({scriptClass:"mstrmojo.Editor",id:id,title:$DESC(5728),cssClass:"mstrmojo-dta save",btnAlignment:"right",modal:true,visible:true,onClose:fnDestroy,buttons:[$NWB($DESC(1442),function(){var p=mstrmojo.all[id];if(p.t.ctrlChk.checked){me.setDontAskAgain();mstrApp.features["ask-before-save-changes"]=false;}me.directSave(saveCB);fnDestroy();},true),$NWB($DESC(218),function(){var p=mstrmojo.all[id];if(p.t.ctrlChk.checked){forceSaveAs(me);}me.save();fnDestroy();}),$NWB($DESC(2140),fnDestroy)],children:[{scriptClass:"mstrmojo.Table",alias:"t",rows:2,cols:1,children:[{scriptClass:"mstrmojo.Label",text:$DESC(11165,"Are you sure you want to overwrite the existing copy of ##?").replace(/##/,"<b>"+truncateName+"</b>"),visible:true,cssClass:"ucalert",slot:"0,0",allowHTML:true},{scriptClass:"mstrmojo.CheckBox",label:$DESC(211),alias:"ctrlChk",visible:true,checked:false,slot:"1,0"}]}]}).render();}else{me.directSave(saveCB);}}},setDontAskAgain:function setDontAskAgain(){var me=this,m=me.model;m.showDialogBeforeSave=false;m.getDataService().setPreference("askBeforeSaveChanges\u001E0",{success:mstrmojo.emptyFn,failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}});},directSave:function directSave(saveCB){saveCB=saveCB||{};var me=this,m=me.model,name=mstrmojo.string.decodeHtmlString(m.n),fnEmpty=mstrmojo.emptyFn,fnSuccess=saveCB.success||fnEmpty,fnFail=saveCB.failure||fnEmpty,fnComplete=saveCB.complete||fnEmpty;mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(res){var callback=function(){if(!saveCB.ignoreOrgSucc){mstrmojo.alert($DESC(3336).replace("##",m.n),null,null,null,null,{allowHTML:true});}me.cmdMgr.reset();};m.lastSavedStid=m.getDataService().stid;m.dty=false;fnSuccess(res);if(res.needToGetResults){m.getDataService().retrieveServerJson({},$FUNC.wrapMethods(m.controller.getRefreshCallback(),{success:callback}),{preserveUndo:true,style:{name:"ServerJsonRWDStyle",params:{treesToRender:3}},params:{styleName:"ServerJsonRWDStyle"}});}else{callback();}},failure:function(res){if(!saveCB.ignoreOrgFail){mstrmojo.alert($DESC(4107));}fnFail(res);},complete:function(res){fnComplete(res);}},{taskId:"saveRW",msgID:m.mid,folderID:m.sfid||m.pfid,objName:name,objDesc:m.dsc,saveAsFlags:3,taskEnv:"xhr",taskContentType:"json"});},quickSave:function quickSave(){this.model.saveRW();},browseParent:function pFldr(){var m=this.model,params={evt:3010};if(!m.pfh){params.evt=2001;params.folderID=m.pfid;if(m.sysFolder){params.systemFolder=m.sysFolder;}}toPage(params);},close:function cl(){handleClose(this);},openPage:function opPg(relativePageNumber){var model=this.model;toPage({evt:3124,src:mstrApp.name+"."+mstrApp.pageName+".3124",relativePageNumber:relativePageNumber,messageID:model.mid,rwb:model.bs});},saveToInbox:function inbox(){var me=this;mstrApp.serverRequest({taskId:"addDocToHistoryList",rwb:me.model.bs},{success:function(){var f=me.model.features;if(f){if(f.set){f.set("enable-add-history-list",false);}else{f["enable-add-history-list"]=false;}}mstrmojo.alert($DESC(8047));},failure:function failure(){mstrmojo.alert(mstrmojo.desc(13774,"Your history list is full. Please delete a few messages and try again."));}},{silent:true});},ShowSharingEditor:function ShowSharingEditor(){var $ID="sharingEditor",sharingEditor=mstrmojo.all[$ID],me=this,model=me.model,isNew=model.isnew,stid=model.getDataService().stid,openSharingEditor=function(oi){if(sharingEditor){sharingEditor.set("oi",oi);$HASH.copy({objectName:model.n,href:null,mid:model.mid,isLinkDirty:sharingEditor.lastState!==stid,lastState:stid},sharingEditor);}else{sharingEditor=new mstrmojo.SharingEditor({guestModeEnabled:mstrApp.guestModeEnabled,mid:model.mid,id:$ID,oi:oi,href:null,isLinkDirty:true,viewMode:1,lastState:stid});}sharingEditor.open();},cb={success:function(res){openSharingEditor(res.objects[0]);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};if(isNew){mstrmojo.alert(mstrmojo.desc(14122),null,mstrmojo.desc(8101));}else{model.getDataService().getObjectInfo({objectIDs:this.model.oid,objectTypes:55,includeACL:mstrApp.features?!!mstrApp.features["web-use-sharing-editor"]:false},cb);}},annotationMode:function annotationMode(){(mstrmojo.all.annotations||new mstrmojo.vi.ui.Annotations({})).displayAnnotations(this.rootCtrl.view);},createPersonalView:function ctPV(){var me=this,m=me.model,isnew=m&&m.isnew;if(isnew){mstrmojo.alert(mstrmojo.desc(13963,"You must save your dashboard before continuing."),null,mstrmojo.desc(9173));}else{var n=m.n,pvdid="mstrPVD",params={scriptClass:"mstrmojo.PersonalViewSaveAs",id:pvdid,objectType:55,objectSubType:14081},dlg=mstrmojo.all[pvdid]||mstrmojo.insert(params);if(n){var d=$D.getDateJson(new Date());n+=" "+$D.formatDateInfo(d,getDateTime().DATEOUTPUTFORMAT)+" "+$D.formatTimeInfo(d,getDateTime().TIMEOUTPUTFORMAT);dlg.set("name",n);}dlg.msgID=this.model.mid;dlg.open();}},reprompt:function rpmpt(){reload(this,true,false,false);},refresh:function rfsh(){reload(this,false,false,false);},rerun:function rerun(){reload(this,false,true,false);},toggleAutoRefresh:function(e){var widget=e.src,controller=this.model.controller,started=controller.isAutoRefreshStarted();controller[(started?"stop":"start")+"AutoRefresh"]();widget.set("iconClass",(started?"tbStart":"tbStop")+"AutoRefresh");widget.domNode.setAttribute("title",started?"*Resume Auto Refresh*":"*Pause Auto Refresh*");},docVisualizationModeAJAX:function vizAjax(){toMode(this,51);},docVisualizationModeFlash:function vizFlash(){toMode(this,50);},sendNow:function sendNow(){prompt2save(this,mstrmojo.desc(2331,"Send Now"),"Sending_an_analysis_in_an_email.htm",mstrmojo.desc(2513,"You must save the report/document before you can send it."),toPage,{evt:3037,objectType:55,objectSubType:14081,messageID:this.model.mid},{saveAsOrigin:2},true);},scheduleHL:function scHL(){prompt2save(this,$DESC(5017,"Subscribe to History List"),"",$DESC(13963,"You must save your dashboard before continuing."),toPage,{evt:3128,objectType:55,objectSubType:14081,messageID:this.model.mid},{saveAsOrigin:3});},scheduleEmail:function scheduleEmail(){prompt2save(this,$DESC(3282,"Schedule Delivery to E-mail"),"",$DESC(13963,"You must save your dashboard before continuing."),toPage,{evt:3036,objectType:55,objectSubType:14081,messageID:this.model.mid},{saveAsOrigin:3});},zoomValue:null,zoom:function zoom(dssid){var parts=(dssid!==null)?String(dssid).split(":"):[],zt=parseInt(parts[0],10),zfStr=parts[1],zf=$NF.parse(zfStr);if(isNaN(zt)||(!zt&&isNaN(zf))){return ;}var model=this.model;if(zt===1||zt===2){var lv=this.view.selected,l=(lv&&lv.docLayout)||null,d=l&&(l.containerNode||l.domNode),docEl=d&&d.ownerDocument.documentElement,currzf=(model&&model.getZoomFactor())||1;var fnGetLayoutHeight=function(h){h-=TOOLBAR_HEIGHT;if(model.multiLayout){h-=TAB_LAYOUT_HEIGHT;}if(model.hasGroupby){h-=GROUPBY_BAR_HEIGHT;}return h;};var fnFitDimension=function(dim){var x=d&&d["offset"+dim];if(!x){return currzf;}var xWin=Math.max(1,docEl["client"+dim]);if(dim==="Height"){xWin=fnGetLayoutHeight(xWin);}return Math.min(4,Math.max(0.1,Math.floor(currzf*xWin*100/x)/100));};var fnOptimizeZF=function(zf){var x=d&&d.offsetHeight;if(x){var w=Math.max(1,docEl.clientWidth),h=fnGetLayoutHeight(Math.max(1,docEl.clientHeight));if(x*zf/currzf>Math.max(1,h)){zf=Math.floor(zf*(w-SCROLLBAR_SIZE)*100/w)/100;}}return zf;};zf=fnFitDimension("Width");if(parseInt(zt,10)===1){zf=fnOptimizeZF(zf);}if(zt===2){zf=Math.min(zf,fnFitDimension("Height"));}zfStr=$NF.format(zf);}if(zt!==model.zt||zfStr!==$NF.format(model.getZoomFactor())){var me=this;model.getDataService().setDocZoom({zoomType:zt,zoomFactor:zfStr,rwb:me.model.bs,currLayoutKey:model.currlaykey},{success:function(res){if(zt!==0){var layouts=me.view.children,i;for(i in layouts){var layout=layouts[i];if(layout.k===me.model.currlaykey){continue;}if(layout.defn){layout.defn.loaded=false;}}}model.zt=res.zt;model.replaceLayout(res.currlaykey,res);model.raiseEvent({name:"rebuildLayout"});updateZoomValue(me,false);me=null;},failureName:"zoom.set"});}},syncZoom:function(){var m=this.model,zfStr=$NF.format(m.getZoomFactor());mstrApp.serverRequest({taskId:"setDocZoom",rwb:m.bs,styleName:"EmptyStyle",zoomFactor:zfStr,zoomType:m.zt,layoutKey:m.currlaykey},null);},exportCmd:function exportCmd(mode,gridKey,sliceId){gridKey=typeof gridKey!=="string"?undefined:gridKey;if(!mstrApp.isSingleTier){var m=this.model,view=this.view,exEvt=(parseInt(mode,10)===EXP_HTML)?3130:3132,exOptions=m.exopt,promptUC=m.huc&&mode===EXP_FLASH,promptUser=exOptions.s&&(mode===EXP_EXCEL||mode===EXP_PDF)&&!gridKey,bGbAll=false,bMulti=false;if(promptUser){if(!!(m.defn&&m.defn.layouts&&m.defn.layouts.length>1)){bMulti=true;}else{var lyt=view.selected,gb=lyt&&lyt.gb&&lyt.children[1];bGbAll=(!gb||gb.areUnitsSetToAll());if(bGbAll){promptUser=false;}}}var fnExport=function(){var params={evt:exEvt,src:mstrApp.name+"."+exEvt};if(exEvt===3132){params.executionMode=mode;if(gridKey!=null){params.gridKey=gridKey;}if(sliceId>0){params.sliceId=sliceId;}}if(!promptUser){params.rwb=m.bs;}else{var s=mstrmojo.Serializer;var evts=[[2048062,m.bp+".2048062","mode",exOptions.m,"range",exOptions.r],[]];$HASH.forEach(params,function(v,k){if(k==="executionMode"){evts[1]=evts[1].concat([k,v]);}else{evts[1].push(v);}});params.evt=1024001;params.src=m.bp+".1024001";params.events=s.serializeValueGroup(evts);params["1024001"]=1;params.messageId=m.mid;}params.name=Date.parse(new Date());var exFn=function(){checkSessionAndSendForm(params,null,"post",(exOptions.n)?"_blank":"mstrExportWindow");};if(!mstrmojo.dom.isIE||mode!==EXP_FLASH){exFn();}else{mstrmojo.alert($DESC(5873),exFn);}};var fnPrompt;if(promptUser||promptUC){fnPrompt=function(){var id="mojoExOpx9",fnDestroy=function(){mstrmojo.all.mojoExOpx9.destroy();};mstrmojo.insert({scriptClass:"mstrmojo.Editor",id:id,title:$DESC(971),cssClass:"mstrmojo-dta export",btnAlignment:"right",onClose:fnDestroy,draggable:false,buttons:[$NWB($DESC(1442),function(){mstrmojo.requiresCls("mstrmojo.Serializer");var p=mstrmojo.all[id];if(bMulti){exOptions.r=p.ctrlLyt.selectedIndex;}if(!bGbAll){exOptions.m=(p.ctrlChk.checked)?0:1;}fnDestroy();fnExport();},true),$NWB($DESC(2140),fnDestroy)],children:[{scriptClass:"mstrmojo.Label",cssClass:"ucalert",text:$DESC(7482),visible:promptUC},{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"exp_opts",cssDisplay:"block",alias:"ctrlLyt",visible:!!bMulti,selectedIndex:exOptions.r,items:[{n:$DESC(14583),v:0},{n:$DESC(14582),v:1}]},{scriptClass:"mstrmojo.CheckBox",label:$DESC(5165),cssDisplay:"block",alias:"ctrlChk",visible:!mstrApp.isVI&&!bGbAll&&promptUser,checked:(exOptions.m===0)}]}).render();};}if(mode===EXP_EXCEL&&$DESC(3809)!==undefined&&!gridKey){mstrmojo.confirm($DESC(3809),{confirmBtn:{fn:fnPrompt||fnExport,t:$DESC(1442)},cancelBtn:{t:$DESC(2140)}});}else{if(fnPrompt){fnPrompt();}else{fnExport();}}}else{if(gridKey!==undefined){var exportConfig={3:{mode:"2",version:""},4:{mode:"1",version:"4"},10:{mode:"5",version:""}};FormWrapper.doExport(exportConfig[mode].mode,exportConfig[mode].version,gridKey);}}},printPDF:function prntPDF(gridKey){this.exportCmd(EXP_PDF,gridKey);},exportExcel:function exportExcel(gridKey){this.exportCmd(EXP_EXCEL,gridKey);},exportCSV:function exportCSV(gridKey){this.exportCmd(EXP_CSV,gridKey);},exportHTML:function exportHTML(){this.exportCmd(EXP_HTML);},exportMSTR:function exportMSTR(){var me=this,fnExportCmd=function fnExportCmd(mode){me.exportCmd(mode);};prompt2save(this,null,"",$DESC(13963,"You must save your dashboard before continuing."),fnExportCmd,EXP_MSTR,{saveAsOrigin:14},true);},openHome:function openHome(me){toPage({evt:3010,src:mstrApp.name});},updateZoom:function updateZoom(){updateZoomValue(this,false);},resetSelections:function resetSelections(){var me=this,m=me.model,disablePU=!!m.hasGroupby;m.getDataService().resetSelections(null,disablePU,{success:function(res){var layouts=me.view.children,len=(layouts&&layouts.length)||0,curlaykey=m.getCurrentLayoutKey(),i;for(i=0;i<len;i++){var layout=layouts[i];if(layout.defn&&layout.defn.loaded&&curlaykey!==layout.k){layout.defn.loaded=false;}}if(disablePU){m.loadLayout(res);return ;}if(res.pukeys){var pu=m.partialUpdate(res.data,m.getUnitDefinitions(res.pukeys)),dc=m.getLayoutDataCache(m.getCurrentLayoutKey());$HASH.forEach(pu.upd,function(v,uid){var w=mstrmojo.all[uid];if(w&&w.defn&&w.defn.t===mstrmojo.EnumRWUnitType.PANELSTACK){var psd=dc&&dc[uid]&&dc[uid].data,selKey=psd&&psd.selKey;if(selKey&&w.selectedKey!==selKey){w.defn.set("selKey",selKey);}w.setDirtyChildren();}});}}});}});}());