(function(){mstrmojo.requiresCls("mstrmojo._IsWebApp","mstrmojo.vi.factories.ModelFactory","mstrmojo.vi.controllers.RootController","mstrmojo.hash","mstrmojo.css","mstrmojo.array","mstrmojo.color","mstrmojo.dom","mstrmojo.func","mstrmojo.form");mstrmojo.requiresDescs(6828,13159,13160,13162,13163,13353,13375,13376,13407,13345,13346,13347,13348,13349,13350,13351,13352,13472,13473,13339,13340,13341,13342,13343,13344,13538,13539,13988);var STATE_DEFAULT=0,STATE_PRESENTATION=1,STATE_SELECTOR_TARGETING=2,STATE_PRINT_PREVIEW=3,$DOM=mstrmojo.dom;window.mstrApp=null;window.mstrConfig=mstrConfig;mstrmojo.vi.VisualInsightApp=mstrmojo.declare(mstrmojo.Obj,[mstrmojo._IsWebApp],{scriptClass:"mstrmojo.vi.VisualInsightApp",isVI:true,isSingleTier:false,appState:STATE_DEFAULT,pageName:"",styleName:"RWIVEMojoStyle",rootCtrl:null,menubarModelData:null,tbModelData:null,enableWaitBox:true,customization:{},start:function start(docModelData){mstr_profile.log("App started");var placeholder=this.placeholder;if(this.rootCtrl){this.destroyDisposables();delete this.rootCtrl;var body=document.body,div=document.createElement("div");div.setAttribute("id",placeholder);body.insertBefore(div,body.childNodes[0]);}this.docModelData=docModelData;var modelFactory=this.modelFactory=new mstrmojo.vi.factories.ModelFactory(),rootCtrl=this.getRootController();this.addDisposable([modelFactory,rootCtrl]);rootCtrl.start({placeholder:placeholder,data:docModelData});this.startSessionManager();$DOM.attachEvent(document,"keydown",function(e){var doPrevent=e.keyCode===8;e=e||window.event;if(doPrevent){var d=e.srcElement||e.target,tagName=d.tagName.toUpperCase(),inputType=tagName==="INPUT"&&d.type.toUpperCase();if(tagName==="TEXTAREA"||d.isContentEditable||(inputType==="TEXT"||inputType==="PASSWORD"||inputType==="NUMBER"||inputType==="FILE"||inputType==="EMAIL"||inputType==="SEARCH"||inputType==="DATE")){doPrevent=d.readOnly||d.disabled;}if(doPrevent){$DOM.preventDefault(window,e);}}});},getRootController:function getRootController(){return(this.rootCtrl=this.rootCtrl||new mstrmojo.vi.controllers.RootController());},getPreferredColors:function(){return mstrmojo.array.map(this.rootCtrl.docCtrl.model.getCurrentPaletteColors(),function(encodedColor){return mstrmojo.color.decodeColor(encodedColor);});},serverRequest:function serverRequest(params,callback,config){try{var bs=this.docModelData.bs;this._super(params,mstrmojo.func.override({success:function(res,request){if(res.isPrompted){mstrmojo.form.send({evt:5005,src:mstrApp.name+"."+mstrApp.pageName+".5005",preventCancelPrompt:!(config&&config.canCancelPrompt),rwb:bs});}else{return this._super(res,request);}}},callback),config);}catch(ex){mstrmojo.err(ex);}},serverResponse:function serverResponse(id,methodName,requestID,status,responseJSON){var obj=mstrmojo.all[id];if(obj){obj[methodName](requestID,!!status,responseJSON);}},onerror:function onerror(res,callback){if(!res||res.handledError){return ;}var msg=[],map={title:"",message:mstrmojo.desc(6828,"Error:")+" ",sourceURL:"Source URL: ",fileName:"File: ",lineNumber:"Line: ",line:"Line: "};mstrmojo.hash.forEach(map,function(v,n){if(res[n]!==undefined){msg.push(v+res[n]);if(n==="title"){msg.push("");}}});if(res.getResponseHeader){msg.push("XHR: "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}var message=msg.join("\n");if(message.length){mstrmojo.error({longDesc:message},callback);res.handledError=true;mstrmojo.dbg(res.stack||message);}},showWait:function showWait(config){var waitBox=this._super(config),themeClassName=this.rootCtrl.view.themeClassName;if(themeClassName){waitBox.set("themeClassName",themeClassName);}},getWaitBoxPosition:function getWaitBoxPosition(){var view=this.rootCtrl.view;return{top:$DOM.position(view.pathbarNode).h+$DOM.position(view.menuToolbarNode).h+2};},showLinkedNotification:function showLinkedNotification(message,fnHandler,callback){var notify=mstrmojo.notify(message.replace(/\{/g,'<span class="dyn-link">').replace(/}/g,"</span>"),{allowHTML:true},{forceClose:true,buttonText:mstrmojo.desc(1442,"Ok"),callback:callback||mstrmojo.emptyFn});Array.prototype.slice.call(notify.domNode.getElementsByTagName("span")).forEach(function(span,idx){$DOM.attachOneTimeEvent(span,"click",function(idx){fnHandler(idx);notify.destroy();}.bind(span,idx));});},showHelpMenuNotification:function showHelpMenuNotification(callback){mstrApp.showLinkedNotification(mstrmojo.desc(13886,"Access {Getting Started} and {Quick Tips} from the Help menu."),function(idx){var rootCtrl=mstrApp.rootCtrl;if(!idx){if(mstrApp.isSingleTier){window.FormWrapper.showWelcomeScreen();}else{rootCtrl.showWelcome();}}else{rootCtrl.showTutorial();}},callback);},getShowVIWelcome:function getShowVIWelcome(){return false;},togglePanel:function togglePanel(menuItemId){this.rootCtrl.togglePanel(menuItemId);},executeCommand:function executeCommand(cmdId,cmdValue){if(typeof this[cmdId]==="function"){this[cmdId](cmdValue);}else{this.rootCtrl.executeCommand(cmdId,cmdValue);}},onNavigateOut:function onNavigateOut(item,execFn){var pathInfo=this.pathInfo,navigationButtons=pathInfo&&pathInfo.nb,backButton=navigationButtons&&navigationButtons[1],backHistoryItems=backButton&&backButton.items,historyItem=backHistoryItems[1],docCtrl=this.rootCtrl.docCtrl;item=item||historyItem;var href=item&&item.href;if(docCtrl&&docCtrl.saveBeforeClosing){docCtrl.saveBeforeClosing({success:execFn},href);return true;}else{return false;}},setDefaultAppState:function setDefaultAppState(){this.set("appState",STATE_DEFAULT);},isAppStatePresentation:function isAppStatePresentation(){return this.appState===STATE_PRESENTATION;},isAppStatePrintPreview:function isAppStatePrintPreview(){return this.appState===STATE_PRINT_PREVIEW;},allowWebDashboardDesign:function allowWebDashboardDesign(){var features=this.features;return !(features&&features["disable-dashboard-design"]);},setTheme:function setTheme(themeId){this.rootCtrl.setTheme(themeId);},getThemeClassName:function getThemeClassName(){return this.rootCtrl.view.themeClassName;},setPalette:function setPalette(paletteId){this.rootCtrl.setPalette(paletteId);},resetCmdMgr:function resetCmdMgr(){this.rootCtrl.resetCmdMgr();}});mstrmojo.vi.VisualInsightApp.APP_STATES={DEFAULT:STATE_DEFAULT,PRESENTATION:STATE_PRESENTATION,PRINT_PREVIEW:STATE_PRINT_PREVIEW,SELECTOR_TARGETING:STATE_SELECTOR_TARGETING};}());