(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.Container","mstrmojo.dom","mstrmojo.architect.EnumDataChangeEvents","mstrmojo.warehouse._CanToggleAvatarClass");var $A=mstrmojo.array,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$PX="px",$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,$ENUM_DRAG_ACTIONS=mstrmojo.architect.EnumDragActions,CSS_PREFIX="mstrmojo-ar-trns-",STR_DRAG_ATTR=mstrmojo.desc(12213,"Add an attribute by dragging it here"),STR_ATTR=mstrmojo.desc(518,"attribute"),STR_TABLE=mstrmojo.desc(7755,"table"),STR_EXPRESSION=mstrmojo.desc(4449,"Expression");function populateGrid(items){var hw,headerRow=[STR_ATTR,STR_TABLE,STR_EXPRESSION],dataGridWidget=this.gridbox.grid;dataGridWidget.columns=[];$A.forEach(headerRow,function(hr,i){var cssLabel="datarow label ",cssDel="datarow ";switch(i){case 0:cssLabel+="tp12";cssDel+="hidden";break;case 1:cssLabel+="tp15";cssDel+="hidden";break;case 2:cssLabel+="exp";cssDel+="delete";break;}hw={headerWidget:{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"dataRow-header",text:hr},colWidth:20,dataWidget:{scriptClass:"mstrmojo.Box",cssClass:CSS_PREFIX+"datarow",dataField:i,dropZone:true,ondragenter:function ondragenter(context){this.parent.dataGrid.ondragenter(context);},ondragleave:function ondragleave(context){this.parent.dataGrid.ondragleave(context);},ondragover:mstrmojo.emptyFn(),allowDrop:function allowDrop(context){return this.parent.dataGrid.allowDrop(context);},ondrop:function ondrop(context){this.parent.dataGrid.ondrop(context);},children:[{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+cssLabel,postCreate:function postCreate(){var data=this.parent.data;this.set("text",data[this.parent.dataField].n);if(data[0].isDropZone){this.set("cssClass",CSS_PREFIX+"datarow label dropArea");$CSS.toggleClass(this.parent.dataGrid.parent.domNode,"even",(this.parent.idx%2===0));}},onclick:function onclick(){var gridRow=this.parent.data,container=this.parent.dataGrid.parent.parent;if(!gridRow[0].isDropZone){mstrApp.rootController.selectTransformationElement(container.transformationId,gridRow[0],gridRow[1],gridRow[2].n,0);}}},{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+cssDel,postCreate:function postCreate(){var data=this.parent.data;if(data[0].isDropZone){this.set("cssClass",CSS_PREFIX+"datarow delete hidden");}},onclick:function onclick(){var gridRow=this.parent.data,container=this.parent.dataGrid.parent.parent;mstrApp.getRootController().removeTransformationElement(container.transformationId,gridRow[0].id);gridRow=this.parent.dataGrid.items[0];mstrApp.rootController.selectTransformationElement(container.transformationId,gridRow[0],gridRow[1],gridRow[2].n,0);}}]}};dataGridWidget.columns.push(hw);});dataGridWidget.items=items;dataGridWidget.selectedIndex=-1;}function addDropZoneItem(){return[{isDropZone:true},{n:STR_DRAG_ATTR},{}];}function update(evt){var items=evt.items,rootController=mstrApp.rootController,gridItem,attId=evt.attributeID,index=0,data=items.elements,dataGridWidget=this.gridbox.grid,gridData=[],gridRow,table,attribute;this.transformationId=evt.value.id;$A.forEach(data,function(row,idx){table=rootController.getTable(row.tableID);attribute=rootController.getAttribute(row.attributeID);gridItem=[{n:(attribute&&attribute.name)||row.attributeName,id:row.attributeID},{n:(table&&table.name)||row.tableName,id:row.tableID},{n:row.expression}];rootController.populateTableContents(row.tableID,{});if(attId===row.attributeID){index=idx;}gridData.push(gridItem);});gridData.push(addDropZoneItem());populateGrid.call(this,gridData);dataGridWidget.selectedIndex=Math.max(index,0);gridRow=dataGridWidget.items[dataGridWidget.selectedIndex];mstrApp.rootController.selectTransformationElement(this.transformationId,gridRow[0],gridRow[1],gridRow[2].n,0);}function updateTable(newAttribute){var dataGridWidget=this.gridbox.grid;dataGridWidget.items.pop();dataGridWidget.items.push([{n:newAttribute.n,id:newAttribute.attributeId},{n:"",id:""},{n:""}]);dataGridWidget.items.push(addDropZoneItem());populateGrid.call(this,dataGridWidget.items);dataGridWidget.render();}mstrmojo.architect.ui.TransformationContainer=mstrmojo.declare(mstrmojo.Box,[mstrmojo.warehouse._CanToggleAvatarClass],{scriptClass:"mstrmojo.architect.ui.TransformationContainer",init:function init(props){this._super(props);var rootController=mstrApp.getRootController(),evtConfig={},tableConfig=evtConfig[this.id]={};tableConfig[$ENUM_DATA_CHANGE_EVENTS.TRANSFORMATION_UPDATED]=update;rootController.attachDataChangeListeners(evtConfig);},transformationId:undefined,onheightChange:function onheightChange(evt){var grid=this.gridbox.grid,h=parseInt(evt.value,10)-2,scrh=((grid&&grid.headerContainerNode)?(h-$DOM.position(grid.headerContainerNode).h):0)+$PX,hpx=h+$PX;this.gridbox.set("height",hpx);grid.set("height",hpx);if(grid.hasRendered){grid.scrollboxNode.style.height=scrh;grid.itemsContainerNode.style.height=scrh;grid.domNode.style.height=hpx;}},onwidthChange:function onwidthChange(evt){this.gridbox.set("width",evt.value);},refresh:function refresh(){this._super();this.onheightChange({value:this.height});},children:[{scriptClass:"mstrmojo.Box",alias:"gridbox",cssClass:CSS_PREFIX+"gridbox",children:[{scriptClass:"mstrmojo.DataGrid",alias:"grid",cssClass:CSS_PREFIX+"dataGrid",columns:[],dropZone:true,minColWidth:180,ondragenter:function ondragenter(context){if(context.action!==$ENUM_DRAG_ACTIONS.LINKER_ATTR){return ;}mstrmojo.css.toggleClass(this.parent.domNode,"dropFeedback",true);mstrmojo.css.toggleClass(context.src.widget.avatar,"dropFeedback",true);},ondragleave:function ondragleave(context){if(context.action!==$ENUM_DRAG_ACTIONS.LINKER_ATTR){return ;}mstrmojo.css.toggleClass(this.parent.domNode,"dropFeedback",false);mstrmojo.css.toggleClass(context.src.widget.avatar,"dropFeedback",false);},ondragover:mstrmojo.emptyFn(),allowDrop:function allowDrop(context){if(context.action!==$ENUM_DRAG_ACTIONS.LINKER_ATTR){return false;}this.dropCueNode.style.display="none";return true;},ondrop:function ondrop(context){if(context.action!==$ENUM_DRAG_ACTIONS.LINKER_ATTR){return ;}var attributeId=context.src.data.attributeId,container=this.parent.parent,transformationId=container.transformationId,attributeName=context.src.data.n;updateTable.call(container,context.src.data);container.gridbox.grid.set("selectedIndex",(container.gridbox.grid.items.length-2));this.dropCueNode.style.display="none";mstrApp.getRootController().addTransformationElement(transformationId,attributeId,"","",attributeName,"",0);}}]}]});}());