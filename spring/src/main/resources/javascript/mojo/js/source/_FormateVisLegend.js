(function(){mstrmojo.requiresCls("mstrmojo.string","mstrmojo.dom","mstrmojo.array","mstrmojo.css","mstrmojo.hash","mstrmojo.VisEnum","mstrmojo.VisUtility","mstrmojo.gm.GMUtility","mstrmojo.color","mstrmojo.ui.menus.EditorConfig","mstrmojo.ui.menus.ToolbarEditorConfig","mstrmojo.vi.ui.editors.EditorGroup","mstrmojo.ui.editors.controls.LineConfigGroup","mstrmojo.ui.editors.controls.FillConfigGroup","mstrmojo.ui.editors.controls.ColorPickerButton","mstrmojo.ui.editors.controls.CharacterGroup","mstrmojo.ui.editors.controls.AdvancedColorPicker");var $MOJO=mstrmojo,$DOM=$MOJO.dom,$HASH=$MOJO.hash,$ARR=$MOJO.array,$CSS=$MOJO.css,CTRL_TYPE=$MOJO.VisEnum.ControlType,$GM=mstrmojo.gm,$COLOR=mstrmojo.color,$GMU=$GM.GMUtility,$VISUTIL=$MOJO.VisUtility,$ENUM_FORMAT_TAG=$GM.FormatingPropertyTag,$FORMAT_MODEL=mstrmojo.models.FormatModel,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$ENUM_FONT_STYLE_VALUE=mstrmojo.chart.enums.EnumFontStyle,LEGEND_FORMATTING_TYPE=mstrmojo.VisEnum.GMLegendFormatingPropertyTag,NETWORK_LEGEND_FORMATTING_CATEGORY=mstrmojo.VisEnum.NetworkLegendFormattingCategory,$ACP=mstrmojo.ui.editors.controls.AdvancedColorPicker,EnumControlScope={GLOBAL:"glb",FORMATTING:"fmt"},EnumFormatPropSubName={FONT_COMP:"FntCmp",FONT_FAMILY:"FntFml",FONT_STYLE:"FntStyle",FONT_SIZE:"FntSz",FONT_COLOR:"FntClr",LINE_COMP:"LnCmp",SHOW:"Shw",COLOR:"Clr",STYLE:"Style",THICKNESS:"Thk"};function showToolBar(pos,toolbarData){var widget=this.widget,ph=widget.domToolbarPH,_this=this;widget._lastOpened=null;ph.innerHTML="";document.body.appendChild(ph);$CSS.toggleClass(ph,mstrApp.getThemeClassName(),true);this.configureLegendPopup(toolbarData,ph);widget.toolEditor=toolbarData.newInstance({unrender:function(){}});widget.toolEditorClosefn=function(evt){var target=evt.target,toolbarRoot=widget.toolEditor.domNode;if(!$DOM.contains(toolbarRoot,target,true,toolbarRoot)&&!$VISUTIL.isHostedPopupNode(target,"class",true,document.body)){_this.hideToolbar();}};$DOM.attachEvent(document.body,"mousedown",widget.toolEditorClosefn,true);widget.openPopup(this.widget.toolEditor);$CSS.toggleClass(document.body,"hasToolbarPopup",true);}function getFormatPropertyValue(propName,scope){var rst;if(scope===EnumControlScope.GLOBAL){rst=this.readGlobalProperty(propName);}else{if(scope===EnumControlScope.FORMATTING){rst=this.widget.getPropertiesOfFormatable();}}if(propName.slice(-3)===EnumFormatPropSubName.COLOR){if(propName!==$ENUM_FORMAT_TAG.COLOR_SQUARE_COLOR||scope!==EnumControlScope.GLOBAL){rst=$GMU.decodeColor(rst);}}return rst;}function getChangeFormatPropertyFn(propName,scope){var _this=this;if(scope===EnumControlScope.GLOBAL){return function(newValue){var currentVal=getFormatPropertyValue.call(_this,propName,EnumControlScope.GLOBAL);if(propName===$ENUM_FORMAT_TAG.COLOR_SQUARE_COLOR){currentVal=currentVal.color;}if(!$HASH.equals(newValue,currentVal)){if(propName.indexOf(EnumFormatPropSubName.COLOR)!==-1){newValue=$GMU.encodeColor(newValue);}_this.writeGlobalProperty(propName,newValue);}};}return function(newValue,valueWas){var currentVal=getFormatPropertyValue.call(_this,propName,EnumControlScope.FORMATTING);if(newValue!==currentVal){if(propName.indexOf(EnumFormatPropSubName.COLOR)!==-1){newValue=$COLOR.encodeColor(newValue);}_this.widget.writeFormatableProperties(propName,newValue,valueWas);}};}function getRowContainer(children,rowContainerCSSClass){children=children||[];rowContainerCSSClass=rowContainerCSSClass||"";$ARR.forEach(children,function(child){child.cssDisplay="inline-block";});return{scriptClass:"mstrmojo.HBox",cssClass:rowContainerCSSClass,children:children};}function getLabelBox(children,labelcss){children=children||[];var labelBox=new mstrmojo.Box({children:children,cssText:labelcss});return labelBox;}function getLabelAndControlBox(labelText,control,rowContainerCSSClass){var labelcss="white-space: nowrap; width: 50px;";if(labelText===mstrmojo.desc(3905,"Background")||labelText===mstrmojo.desc(6242,"Color")){labelcss="white-space: nowrap;";}else{if(labelText===mstrmojo.desc(2885,"Fill")){labelcss="white-space: nowrap; margin-right: 9px;";}}var label=new mstrmojo.Label({text:labelText}),labelBox=getLabelBox(label,labelcss);return getRowContainer([labelBox,control],rowContainerCSSClass);}function getGroupCompProps(props,childrenNames,scope){var _this=this;props=props||{};if(props.propNames===undefined){props.propNames=childrenNames;}props.onGroupValueChange=function(propertyName,newValue,oldValue){if(newValue!==oldValue&&newValue!==undefined){(getChangeFormatPropertyFn.call(_this,propertyName,scope))(newValue,oldValue);}};return props;}function initPropValueToControl(control,childrenNames,scope){var _this=this;$ARR.forEach(childrenNames,function(childName){var val=getFormatPropertyValue.call(_this,childName,scope);if(val!==undefined){control.setChildValue(childName,val);}});}function getFillConfigComp(label,childrenNames,scope,props){props=getGroupCompProps.call(this,props,childrenNames,scope);$HASH.copy({width:"140px",height:"22px",colorPickerHostWithin:true},props);var control=new mstrmojo.ui.editors.controls.FillConfigGroup(props);if(control){control.iniChildrenComp(childrenNames);initPropValueToControl.call(this,control,childrenNames,scope);}if(typeof label==="string"){return getLabelAndControlBox(label,control,(props||[]).rowContainerCSSClass);}return control;}function getBackgroundFillEditor(fillChildrenNames,scope,props){return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-ToolBoxBackgroundFill",children:[getFillConfigComp.call(this,mstrmojo.desc(2885,"Fill"),fillChildrenNames,scope,$HASH.copy({rowContainerCSSClass:"mstrmojo-ui-rowContainer"},props))]}]});}function getColorPickerCfg(alias,label,childrenNames,scope,showGradient){var selectedValue=getFormatPropertyValue.call(this,childrenNames,scope),_this=this;var colorPicker=new mstrmojo.ui.editors.controls.ColorPickerButton({showGradient:!!showGradient,isHostedWithin:true,width:"40px",selectedValue:selectedValue,showNoFill:false,postselectedValueChange:function(evt){(getChangeFormatPropertyFn.call(_this,childrenNames,scope))(evt.value,evt.valueWas);}});if(alias){colorPicker.alias=alias;}if(typeof label==="string"){return getLabelAndControlBox(label,colorPicker);}return colorPicker;}function notifyColorByMapUpdated(widget){var sub;if(widget.listenToUpdateColorMap instanceof Function){sub=widget.listenToUpdateColorMap(function(){widget.raiseEvent({name:"colorByColorChange",type:"invalidateCache"});if(sub&&widget.detachUpdateColorMapListener instanceof Function){widget.detachUpdateColorMapListener(sub);}});}}function getColorpickerToolbar(childrenNames,scope){var selectedValue=getFormatPropertyValue.call(this,childrenNames,scope),_this=this;return new mstrmojo.ui.menus.ToolbarEditorConfig({cssClass:"cbsquare-colorpicker",contents:[new mstrmojo.ui.editors.controls.AdvancedColorPicker({showAutomatic:!selectedValue.isDefaultColor,color:selectedValue.color,colorChanged:function(color){color=(this.showAutomatic&&color===$ACP.VAL_AUTOMATIC)?"default":color;notifyColorByMapUpdated(_this.widget);(getChangeFormatPropertyFn.call(_this,childrenNames,scope))(color,selectedValue.color);_this.hideToolbar();},colorCanceled:function(){_this.hideToolbar();}})]});}function getCharacterGroupRefreshFn(control,prefixStr){var formats={},fontStyleVal=getFormatPropertyValue.call(this,prefixStr+EnumFormatPropSubName.FONT_STYLE,EnumControlScope.GLOBAL),fontColorVal=getFormatPropertyValue.call(this,prefixStr+EnumFormatPropSubName.FONT_COLOR,EnumControlScope.GLOBAL),fontFamilyVal=getFormatPropertyValue.call(this,prefixStr+EnumFormatPropSubName.FONT_FAMILY,EnumControlScope.GLOBAL),fontSizeVal=getFormatPropertyValue.call(this,prefixStr+EnumFormatPropSubName.FONT_SIZE,EnumControlScope.GLOBAL);if(fontStyleVal!==undefined){formats[$ENUM_FORMAT_PROPERTIES.FONT_WEIGHT]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_BOLD)>0));formats[$ENUM_FORMAT_PROPERTIES.FONT_STYLE]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_ITALIC)>0));formats[$ENUM_FORMAT_PROPERTIES.UNDERLINE]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_UNDERLINE)>0));formats[$ENUM_FORMAT_PROPERTIES.LINE_THROUGH]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_STRIKETHROUGH)>0));}if(fontColorVal!==undefined){formats[$ENUM_FORMAT_PROPERTIES.COLOR]=fontColorVal;}if(fontSizeVal!==undefined){formats[$ENUM_FORMAT_PROPERTIES.FONT_SIZE]=fontSizeVal;}if(fontFamilyVal!==undefined){formats[$ENUM_FORMAT_PROPERTIES.FONT_FAMILY]=fontFamilyVal;}control.setFormatSource(formats);}function getCharacterChildComp(control,propName){var rst=null;if(propName.indexOf(EnumFormatPropSubName.FONT_FAMILY)!==-1){rst=control.fontFamily;}else{if(propName.indexOf(EnumFormatPropSubName.FONT_STYLE)!==-1){rst=control.fontStyle;}else{if(propName.indexOf(EnumFormatPropSubName.FONT_SIZE)!==-1){rst=control.fontSize;}else{if(propName.indexOf(EnumFormatPropSubName.FONT_COLOR)!==-1){rst=control.fontColor;}}}}return rst;}function initCharacterGroupComp(control,childrenNames,scope){var fontStyleValueMap={bold:$ENUM_FONT_STYLE_VALUE.FS_BOLD,italic:$ENUM_FONT_STYLE_VALUE.FS_ITALIC,underline:$ENUM_FONT_STYLE_VALUE.FS_UNDERLINE,strikeout:$ENUM_FONT_STYLE_VALUE.FS_STRIKETHROUGH},_this=this;childrenNames.forEach(function(childName){var comp=getCharacterChildComp(control,childName);if(comp){comp.propName=childName;if(childName.indexOf(EnumFormatPropSubName.FONT_STYLE)!==-1){comp.postselectionChange=function(evt){var added=evt.added,item=comp.items[(added&&added[0]!==undefined)?added[0]:evt.removed[0]],isSelected=!!added,oldValue=getFormatPropertyValue.call(_this,childName,scope),newValue=(oldValue===undefined?0:oldValue);if(isSelected){newValue=newValue|fontStyleValueMap[item.css];}else{newValue=newValue&(~fontStyleValueMap[item.css]);}comp.parent.raiseFormatValueChange(childName,newValue,oldValue);};}else{if(childName.indexOf(EnumFormatPropSubName.FONT_FAMILY)!==-1){comp.postselectedIndexChange=function(evt){var newValue=evt.value,oldValue=evt.valueWas;if(newValue!==oldValue){var items=comp.items;comp.parent.raiseFormatValueChange(childName,items[newValue].id,items[oldValue]&&items[oldValue].id);}};}else{if(childName.indexOf(EnumFormatPropSubName.FONT_SIZE)!==-1){comp.postselectedValueChange=function(evt){var newValue=parseInt(evt.value,10)+"pt",oldValue=parseInt(evt.valueWas,10)+"pt";if(newValue!==oldValue){comp.parent.parent.raiseFormatValueChange(childName,newValue,oldValue);}};}else{comp.postselectedValueChange=function(evt){comp.parent.parent.raiseFormatValueChange(childName,evt.value,evt.valueWas);};}}}}});}function getCharacterConfigComp(porpNamePrefix,childrenNames,scope,props){var _this=this;props=props||{};if(props.propNames===undefined){props.propNames=childrenNames;}if(props.onGroupValueChange===undefined){props.onGroupValueChange=function(propertyName,newValue,oldValue){if(newValue!==oldValue&&newValue!==undefined){(getChangeFormatPropertyFn.call(_this,propertyName,EnumControlScope.GLOBAL))(newValue,oldValue);}};}var toolbarProps={cssClass:"mstrmojo-ui-ToolbarCharacter cf",layoutConfig:null,width:"381px",height:"22px"};props=$HASH.copy(toolbarProps,props);var control=new mstrmojo.ui.editors.controls.CharacterGroup(props),fontColorComp=getCharacterChildComp(control,$ENUM_FORMAT_TAG.LEGEND_FONT_COLOR);fontColorComp.showNoFill=false;initCharacterGroupComp.call(this,control,childrenNames,scope);getCharacterGroupRefreshFn.call(this,control,porpNamePrefix);return control;}function positionToolbarAndContextMenu(pos,toolBarContainer){var toolBar=toolBarContainer.firstChild,tbWidth=toolBar?toolBar.offsetWidth:0,tbHeight=toolBar?toolBar.offsetHeight:0,bodyWidth=document.body.offsetWidth,bodyHeight=document.body.offsetHeight,gap=10,upperPadding=5,bottomPadding=5;if(toolBar){toolBar.style.left="0";toolBar.style.right="auto";toolBar.style.top="0";toolBar.style.bottom="auto";}var outer={w:tbWidth,h:0};var hasToolbar=tbHeight>0;if(hasToolbar){outer.h=tbHeight;}else{return false;}if(hasToolbar){toolBarContainer.style.left=pos.x+"px";toolBarContainer.style.top=pos.y-tbHeight-gap/2+"px";}if(pos.x+outer.w>bodyWidth){toolBarContainer.style.left=pos.x-tbWidth+"px";}if(hasToolbar){var toolbarTop=0;if(pos.y-tbHeight-gap/2<upperPadding){toolbarTop=upperPadding;toolBarContainer.style.top=toolbarTop+"px";}else{if(pos.y+gap/2>bodyHeight){toolbarTop=Math.max(bodyHeight-gap-tbHeight,upperPadding);toolBarContainer.style.top=toolbarTop+"px";}}}}function getFontToolbar(porpNamePrefix,childrenNames,scope,props){return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.vi.ui.editors.EditorGroup",showDivider:false,children:[getCharacterConfigComp.call(this,porpNamePrefix,childrenNames,scope,props)]}]});}mstrmojo._FormateVisLegend=mstrmojo.provide("mstrmojo._FormateVisLegend",{_mixinName:"mstrmojo._FormateVisLegend",widget:null,readGlobalProperty:undefined,writeGlobalProperty:undefined,configureLegendPopup:undefined,init:function(props){this.widget=null;if(this._super){this._super(props);}if(this.widget&&!this.widget.domToolbarPH){var div;div=document.createElement("div");div.setAttribute("class","gm-menu-placeholder");this.widget.domToolbarPH=div;}},handleRMCOnLegend:function(evt){var target=evt.getTarget(),e=evt.e,pos={x:e.pageX,y:e.pageY},type=target.getAttribute("type"),tfg,identity,corners,_this=this,widget=this.widget;evt.cancel();evt.preventDefault();if(mstrApp.isAppStatePresentation()||!mstrApp.allowWebDashboardDesign()){return ;}var pulldownType,getRightClickHandler=function(type){switch(type){case CTRL_TYPE.LGD_COLORBOX_CTN:case CTRL_TYPE.LGD_COLORBOX:if(type===CTRL_TYPE.LGD_COLORBOX){target=target.parentNode;}identity=target.firstChild.identity;if(identity&&identity.comb){this.widget.colorSqureIdentity=identity;this.selectColorBox(target,this.fmtMode);tfg=getColorpickerToolbar.call(this,$ENUM_FORMAT_TAG.COLOR_SQUARE_COLOR,EnumControlScope.GLOBAL);pos=this.adjustColorPickerPos(target);if(!pos.alignLeft){corners=tfg.ENUM_CORNERS;tfg.setAlignment(corners.BOTTOM_LEFT,corners.TOP_RIGHT);}}break;case CTRL_TYPE.LGD_TITLE:case CTRL_TYPE.LGD_TEXT:this.selectText(true);var childrenNames=[$ENUM_FORMAT_TAG.LEGEND_FONT_SIZE,$ENUM_FORMAT_TAG.LEGEND_FONT_FAMILY,$ENUM_FORMAT_TAG.LEGEND_FONT_STYLE,$ENUM_FORMAT_TAG.LEGEND_FONT_COLOR];tfg=getFontToolbar.call(this,"lgd",childrenNames,EnumControlScope.GLOBAL);pulldownType="lgd";break;default:this.selectLegendBody();var fillChildrenNames=[$ENUM_FORMAT_TAG.LEGEND_BG_COLOR,$ENUM_FORMAT_TAG.LEGEND_BG_FILL_TRANSPARENCY];tfg=getBackgroundFillEditor.call(this,fillChildrenNames,EnumControlScope.GLOBAL);pulldownType="lgd";break;}if(tfg){showToolBar.call(this,pos,tfg);if(!!pulldownType){mstrApp.rootCtrl.docCtrl.selectViPanel("propertiesPanel");widget.parent.selectVIUnit();var targetPulldown=widget.edtModel._targetPulldown;if(targetPulldown){targetPulldown.selectItemByField("v",pulldownType);}}}};getRightClickHandler.call(this,type);positionToolbarAndContextMenu.call(this,pos,this.widget.domToolbarPH);},hideToolbar:function(){var widget=this.widget,ph=widget.domToolbarPH,phChild=ph.firstChild,phParent=ph.parentNode;if(phChild){ph.removeChild(phChild);}if(phParent){phParent.removeChild(ph);}var _this=widget.toolEditor;if(_this){_this.unrender=function(){_this._super();};_this.destroy();_this.unrender=function(){};delete widget.toolEditor;$CSS.toggleClass(document.body,"hasToolbarPopup",false);$CSS.toggleClass(ph,mstrApp.getThemeClassName(),false);}if(widget.toolEditorClosefn){$DOM.detachEvent(document.body,"mousedown",widget.toolEditorClosefn,true);delete widget.toolEditorClosefn;}},highlightText:function(flag){throw new Error("subclass need to implement highlightText function");}});}());