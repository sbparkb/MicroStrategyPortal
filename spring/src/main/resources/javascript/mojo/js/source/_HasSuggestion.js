(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.css","mstrmojo.string","mstrmojo._HasPopup","mstrmojo.ListBase","mstrmojo.Popup","mstrmojo.Editor","mstrmojo.SuggestionList");function stepSelect(isForward){var list=this.list,idx=list.selectedIndex,len=list.items.length,clearTarget=isForward?len-1:0;if(idx===clearTarget){list.clearSelect();return ;}if(idx===null||idx<0){idx=isForward?0:len-1;}else{idx+=isForward?1:-1;}list.singleSelect(idx);}mstrmojo._HasSuggestion=mstrmojo.provide("mstrmojo._HasSuggestion",mstrmojo.hash.copy(mstrmojo._HasPopup,{blockBegin:1,blockCount:-1,suggestCount:15,autoSelect:true,itemField:"n",candidates:null,suggestionShown:false,suggestionItems:null,_last_hit:null,_request_pattern:null,browseItemVisible:false,folderLinksContextId:25,browsableTypes:"1,8",REQUEST_THRESHOLD:20,noCache:false,disableClick:false,getCandidatesThroughTaskCall:mstrmojo.emptyFn,onSuggestionItemSelect:function onSuggestionItemSelect(item){this.hideSuggestion();},getSearchPattern:function getSearchPattern(){return"";},getSuggestionPos:function getSuggestionPos(){return{left:"100px",top:"100px"};},getSuggestionTarget:function getSuggestionTarget(){return this;},showSuggestion:function showSuggestion(pattern){var its=this.getSuggestion(pattern);if(!this.noCache&&its!==-1){this.updateSuggestion(its);}},hideSuggestion:function hideSuggestion(){this.suggestionShown=false;if(this.suggestionPopup.visible){this.suggestionPopup.close();}},getSelected:function getSelected(){return(this.suggestionShown)?this._lastOpened.getSelected():null;},nextHighlight:function nextHighlight(){if(this.suggestionShown){this._lastOpened.nextHighlight();}},preHighlight:function preHighlight(){if(this.suggestionShown){this._lastOpened.preHighlight();}},getSuggestion:function getSuggestion(t){var c=this.candidates,its=c&&c.items,ic=c&&c.isComplete,lh=this._last_hit;if(!this.noCache&&(c||lh)){var fcs=this.filterCandidates(its,t,this.REQUEST_THRESHOLD),len=fcs.length,sc=this.suggestCount,hit=false;if(!ic&&len<sc){var p=lh&&lh.pattern;if(lh&&p&&(t.indexOf(p)>-1)){hit=true;var lhc=this.filterCandidates(lh.items,t,this.REQUEST_THRESHOLD),llen=lhc&&lhc.length,A=mstrmojo.array,ifd=this.itemField,i;for(i=0;i<llen;i++){if(A.find(fcs,ifd,lhc[i][ifd])===-1){fcs.push(lhc[i]);}}len=fcs.length;}}if(!ic&&((t.length>2&&len<this.REQUEST_THRESHOLD)||(len<sc))){this.requestCandidates(t);return -1;}return(len<sc)?fcs:fcs.slice(0,sc);}this.requestCandidates(t);return -1;},requestCandidates:function requestCandidates(t){this._request_pattern=t;var me=this,targetWas=this.getSuggestionTarget(),callbacks={success:function(res){if(!res){return ;}var target=me.getSuggestionTarget();if(!target||(targetWas!==target)){return ;}var newPattern=target.getSearchPattern(),its=res.items;me._last_hit={items:its,pattern:t};me.sz=res.sz;if(!me.noCache&&its){var c=(me.candidates&&me.candidates.items)||[],_its=[].concat(its),len=its.length,i;for(i=0;i<len;i++){var it=_its[i];if(mstrmojo.array.indexOf(c,it)>-1){mstrmojo.array.removeItem(its,it);}}if(me.candidates){me.candidates.items=c.concat(its);}}if(newPattern&&newPattern.indexOf(t)>-1){var fcs=me.filterCandidates(its,newPattern);me.updateSuggestion(fcs);}},failure:function(res){if(res.getResponseHeader){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}}};this.getCandidatesThroughTaskCall({pattern:t,blockBegin:this.blockBegin,blockCount:this.blockCount,isSuggest:true},callbacks);},filterCandidates:function filterCandidates(its,t,max){max=max||this.suggestCount;t=mstrmojo.string.regEscape(t);var itf=this.itemField,fcs=mstrmojo.array.filter(its,function(it){return(new RegExp("\\s"+t+"|^"+t,"i")).test(it[itf]);},{max:max});return fcs;},getHighlightedText:function getHighlightedText(pattern,n){if(!this.highlightPattern||mstrmojo.string.isEmpty(pattern)){return n;}try{if(!this.nameWildcards||mstr.$A.find([2,32],parseInt(this.nameWildcards,10))>-1){n=n.replace(new RegExp("(^|\\s)("+pattern+")","gi"),"$1<b>$2</b>");}else{var words=pattern.split(" "),i,len;for(i=0,len=words.length;i<len;i++){if(words[i]!==""){n=n.replace(new RegExp("("+words[i]+")","gi"),"<b>$1</b>");}}}}catch(e){}return n;},updateSuggestion:function updateSuggestion(items){var len=items&&items.length,canBrowseItems=this.browseItemVisible;if(len||canBrowseItems){if(canBrowseItems){items=items||[];items.push({n:"Browse...",t:-99,cssClass:(len?"br":"bro")});}this.set("suggestionItems",items);if(this.suggestionShown){var popup=this._lastOpened;if(popup&&popup.nudge){popup.nudge();}if(this.autoSelect&&popup){popup.list.singleSelect(0);}}else{this.openPopup("suggestionPopup",this.getSuggestionPos());this.suggestionShown=true;}}else{this.hideSuggestion();}},ob:{scriptClass:"mstrmojo.Editor",title:mstrmojo.desc(5298,"Select an Object"),help:"Select_Objects_dialog_box_.htm",onClose:function(){var o=this.opener;if(o&&o.onBrowserClose){o.onBrowserClose();}},onOpen:function(){var o=this.opener;if(o&&o.onBrowserOpen){o.onBrowserOpen();}},children:[{scriptClass:"mstrmojo.ObjectBrowser",alias:"browser",fishEyeVisible:false,closeable:false,closeOnSelect:false}]},onBrowserClose:function onBrowserClose(){this.browserShown=false;},handleSuggestionItemSelect:function handleSuggestionItemSelect(it,obCfg){if(this.browseItemVisible&&it.t===-99){this.hideSuggestion();mstrmojo.requiresCls("mstrmojo.ObjectBrowser");var zIndex=this.zIndex;this.openPopup("ob",{zIndex:(zIndex&&(zIndex+10))||110});this.ob.browser.browse(mstrmojo.hash.copy(obCfg,{folderLinksContextId:this.folderLinksContextId,onSelectCB:[this,"onSuggestionItemSelect"],browsableTypes:this.browsableTypes}));this.browserShown=true;}else{this.onSuggestionItemSelect(it);}},highlightPattern:true,suggestionPopupCssClss:"",suggestionPopup:{scriptClass:"mstrmojo.Popup",cssClass:"mstrmojo-ObjectInputBox-suggest",autoClose:true,locksHover:true,nextHighlight:function(){stepSelect.call(this,true);},preHighlight:function(){stepSelect.call(this,false);},getSelected:function getSelected(){var list=this.list;return list.items[list.selectedIndex];},onOpen:function onOpen(){var opener=this.opener;if(opener){mstrmojo.css.addClass(this.domNode,opener.suggestionPopupCssClss||"");if(opener.autoSelect){this.list.singleSelect(0);}if(opener.nudge){opener.nudge(this);}}},onClose:function onClose(){this.list.clearSelect();var opener=this.opener;if(opener){opener.suggestionShown=false;mstrmojo.css.removeClass(this.domNode,opener.suggestionPopupCssClss||"");}}},suggestionListClass:"mstrmojo.SuggestionList",postApplyProperties:function postApplyProperties(){this.suggestionPopup.children=[{scriptClass:this.suggestionListClass,alias:"list",cssClass:"mstrmojo-suggest-list"}];}}));}());