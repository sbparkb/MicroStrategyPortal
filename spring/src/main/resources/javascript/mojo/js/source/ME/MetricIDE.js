(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.css","mstrmojo.Box","mstrmojo.Pulldown","mstrmojo.Label","mstrmojo.TextBoxWithLabel","mstrmojo.ME.MetricEditor","mstrmojo.ME._MetricEditorHelper","mstrmojo.ME.FunctionInfo");mstrmojo.requiresDescs(1952,2213,8950,9560);var $HASH=mstrmojo.hash,$CSS=mstrmojo.css,MEH=mstrmojo.ME._MetricEditorHelper,MDS=mstrmojo.ME.MetricDataService;var IDE=null;mstrmojo.ME.ENUM={METRIC_ACTIONS:{ADD:"add",EDIT:"edit",EIDT_NEW:"editNew"},EDITOR_IDS:{ADVANCED:"mstrME",FORMULA:"mstrME",WIZARD:"mstrFE",SIMPLE:"mstrSME",SELECOTR:"mstrFSE"},EDITOR_TYPES:{ADVANCED:"ADVANCED",FUNCTION:"FUNCTION",SIMPLE:"SIMPLE",SELECTOR:"SELECTOR"},METRIC_EDIT_TYPES:{ADVANCED:65536,SIMPLE:131072,FUNCTION:196608},METRIC_TYPES:{65536:"ADVANCED",131072:"SIMPLE",196608:"FUNCTION"},NEW_METRIC_DEFINITION:{did:"",n:mstrmojo.desc(2213,"New Metric"),tks:{items:[],vs:0,vm:""},mhfts:{},mvfts:{}},getNewDefinition:function(){return{did:"",n:mstrmojo.desc(2213,"New Metric"),tks:{items:[],vs:0,vm:""},mhfts:{},mvfts:{}};}};var makeEditorSticky=function(delta){delta=$HASH.copy(delta,{left:0,top:0});this.left=(parseInt(this.left||this.editorNode.style.left,10)||0)+delta.left+"px";this.top=(parseInt(this.top||this.editorNode.style.top,10)||0)+delta.top+"px";};var getEditorCommonProps=function(cfg){var me=this,isdme=me.isDME,editorId=cfg.id,editorKey=editorId.replace("_1",""),helpTopic=me.getEditorHelpTopic(editorKey);var c={scriptClass:me.getEditorScriptClass(editorKey),id:editorId,isDME:isdme,zIndex:me.zIndex++,oi:cfg.oi,bindings:{functions:me.funcsPath||"mstrmojo.all.mstrMetricIDE.functions",candidates:me.candidatesPath||"mstrmojo.all.mstrMetricIDE.candidates",dsUnits:"this.ide.dsUnits",attrCandidates:"this.ide.attrCandidates"},tbBrowsable:!isdme,tbFormatable:!isdme,ide:me};if(helpTopic){c.help=helpTopic;}$HASH.copy(cfg,c);return c;};var getEditorAsModal=function(cfg){var editorId=this.getEditorId(cfg),editor=mstrmojo.all[editorId];if(!editor){editor=mstrmojo.insert(getEditorCommonProps.call(this,cfg));editor.onvisibleChange=makeEditorSticky;editor.onPostClose=function(){this.destroy();};}$HASH.copy(cfg,editor);editor.candidates=null;editor.set("candidates",this.candidates);return editor;};var getEditorAsInline=function(cfg){var me=this,oi=cfg.oi;if(me.setExtraMetricTokens){me.setExtraMetricTokens(oi);}var editorId=this.getEditorId(cfg);var editor=mstrmojo.all[editorId];if(!editor){var c=mstrmojo.hash.copy({slot:"editorsContainerNode",left:"0px",top:"0px",modal:false,showTitle:false,postCreate:function(){$CSS.addWidgetCssClass(this,"mstrmojo-MetricIDE-editor inline");},onPostClose:function(){var curtain=me.curtain;if(curtain){curtain.set("visible",false);curtain.set("refNode",null);}me.editorConfig=null;me.set("editor",null);},onCancel:function(){me.close();},onSaved:function(){me.close();},switch2Editor:function(editorId,cfg){if(cfg){cfg.id=editorId;}me.set("editorConfig",{editorId:editorId,cfg:cfg});}},getEditorCommonProps.call(this,cfg));if(me.isExpEditor(editorId)){c.onvisibleChange=function(){var ide=IDE,ob=me.browsersContainer.ob,v=this.visible,IDE_Transition_time=250;if(v){ob.set("visible",v);var fb=me.browsersContainer.funcBrowser,funcList=fb.functionList,domNode=funcList.domNode,firstFuncNode=domNode.querySelector&&domNode.querySelector(".mstrmojo-suggest-text.fn[idx]");if(firstFuncNode){var tbFunc=firstFuncNode.lastChild;$CSS.addClass(tbFunc,"forceDisplay");window.setTimeout(function(){funcList.richTooltip=funcList.getEditBtnTooltip(tbFunc);mstrmojo.tooltip.open(funcList);window.setTimeout(function(){$CSS.removeClass(tbFunc,"forceDisplay");funcList.hideTooltip();},1000);},IDE_Transition_time);}}else{ob.set("visible",v);}$CSS.toggleClass(me.editorNode,"exp",v);$CSS.addClass(me.editorNode,"transition-left");mstrmojo.dom.center(ide.editorNode);window.setTimeout(function(){$CSS.removeClass(me.editorNode,"transition-left");makeEditorSticky.call(me);},IDE_Transition_time);};}if(me.configInlineEditor){me.configInlineEditor(c);}editor=mstrmojo.insert(c);editor.attachEventListener("fctDidChange",me.browsersContainer.funcBrowser.id,"onfctDidChange");me.addChildren([editor]);}else{editor.set("oi",oi);editor.candidates=null;editor.set("candidates",me.candidates);}if(cfg.useGUIDefault!==true){editor.useGUIDefault=false;}me.set("editor",editor);me.set("help",editor.help);return editor;};function loadCandidatesCache(){var me=this,INITIAL_COUNT=500,ms=function(res){var its=(res&&res.items)||[],cds=me.candidates||{items:[]};cds.items=cds.items.concat(its);cds.isComplete=cds.isComplete&&(res.bc===-1||(res.bb+res.bc>res.sz));if(me.functions){cds.items=cds.items.concat(MDS.sortFunctions(me.functions));}me.candidates=null;me.set("candidates",cds);},failure=function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));},success=function(res){if(res){var cds={items:res.items,isComplete:(res.bc===-1||(res.bb+res.bc>res.sz))};me.candidates=cds;}MDS.getMetrics({rootFolderType:MDS.rootFolderTypes.ALL,pattern:"*",blockBegin:1,blockCount:INITIAL_COUNT},{success:ms,failure:failure});};if(!this.noCache&&!this.candidates){MDS.getMetricComponents({rootFolderType:MDS.rootFolderTypes.ALL,pattern:"*",blockBegin:1,blockCount:INITIAL_COUNT},{success:success,failure:failure});}else{ms({bc:-1,mcComplete:true});}}var loadMetricDef4Editor=function(metricId,ide){var functions=null,openME=function(oi,timeStamp){if(!mstrmojo.all[ide.id]||mstrmojo.all[ide.id]._timeStamp!==timeStamp){return ;}if(oi&&oi.tks){MEH.preprocessTokenStram(oi.tks);MEH.checkEditorFallback(MDS.sortFunctions(ide.functions),oi);}ide.set("oi",oi);if(!ide.action.n){ide.set("title",mstrmojo.desc(11579,"Metric Editor")+" - "+oi.n);}if(ide.action.cmd!==mstrmojo.ME.ENUM.METRIC_ACTIONS.ADD){var isSimpleFE=ide.showAsSimpleIDE(oi);ide.set("showLeftPanel",!isSimpleFE);getEditorAsInline.call(ide,{id:ide.editorId,oi:oi,functions:functions,simple:isSimpleFE}).open(ide);}},failure=function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));},success=function(res){try{if(!mstrmojo.all[ide.id]){return ;}functions=ide.filterFunctions(res);ide.set("functions",functions);loadCandidatesCache.call(ide);ide.loadObjectDefn({success:function(res){openME(res,ide._timeStamp);},failure:failure});}catch(ex){}};MDS.getFunctions({success:success,failure:failure});};mstrmojo.ME.MetricIDE=mstrmojo.declare(mstrmojo.Editor,[],{scriptClass:"mstrmojo.ME.MetricIDE",cssClass:"mstrmojo-MetricIDE",id:"mstrMetricIDE",_timeStamp:0,title:mstrmojo.desc(11579,"Metric Editor"),help:" ",zIndex:4,noCache:true,editorId:null,editor:null,editorConfig:{editorId:null,cfg:{}},getEditorHelpTopic:function getEditorHelpTopic(editorId){switch(editorId){case"mstrME":return"metric_expression_editor_for_html5_dashboards.htm";}return"metric_function_editor_for_html5_dashboards.htm";},getEditorScriptClass:function getEditorScriptClass(editorId){return"mstrmojo.ME."+{mstrFE:"FunctionWizard",mstrSME:"SimpleMetricEditor",mstrME:"MetricEditor",mstrRFE:"RankEditor",mstrOFE:"OLAPEditor"}[editorId];},oneditorConfigChange:function oneditorConfigChange(){var editorConfig=this.editorConfig,cfg=editorConfig.cfg;if(this.editor){this.editor.close();}getEditorAsInline.call(this,cfg).open(this,cfg);},showLeftPanel:true,onshowLeftPanelChange:function onshowLeftPanelChange(){$CSS.toggleClass(this.editorNode,"simple",!this.showLeftPanel);if(this.editor){this.editor.set("simple",!this.showLeftPanel);this.browsersContainer.funcBrowser.set("showFullSyntax",this.isExpEditor(this.editor.id));}var w=this.getBrowsersContainer().domNode.offsetWith/2||120;this.set("left",(parseInt(this.left||this.editorNode.style.left,10)||0)+(this.showLeftPanel?-1:1)*w+"px");if(this.showLeftPanel){this.browsersContainer.funcBrowser.functionList.refresh();}},filterFunctions:function filterFunctions(fcts){return fcts;},isExpEmpty:function isExpEmpty(){var ME=mstrmojo.all.mstrME;return ME&&ME.getMetricDefAsTokens().length===0;},init:function init(props){if(this._super){this._super(props);}var app=mstrApp,useQuickSearch=app&&app.useQuickSearch&&app.useQuickSearch(),delay=useQuickSearch?((app&&app.searchAutoCompleteDelay&&app.searchAutoCompleteDelay())||0):0;this.suggestDelay=delay||200;this.noCache=this.noCache&&useQuickSearch&&!this.isDME;MDS.suggestDelay=this.suggestDelay;MDS.noCache=this.noCache;IDE=this;this._timeStamp=mstrmojo.now();},onClose:function onClose(){if(this.editor){this.editor.close();}this.browsersContainer.funcBrowser.cleanup();this.destroy();},onOpen:function onOpen(){makeEditorSticky.call(this);this.set("showLeftPanel",true);loadMetricDef4Editor(this.metricId||this.did,this);this.set("title",mstrmojo.desc(11579,"Metric Editor")+" - "+(this.action.n||mstrmojo.desc(2213,"New Metric")));IDE=this;},setExtraMetricTokens:mstrmojo.emptyFn,getTokenInputBox:function getTokenInputBox(){return mstrmojo.all.mstrME.metricEditBox.inputBox;},insertTokens:function(tks){return this.getTokenInputBox().insertTokens(tks);},onObjectInsert:function(items){mstrmojo.all.mstrME.onObjectInsert(items);},setRefOi:mstrmojo.emptyFn,children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-MetricIDE-browsers-container",alias:"browsersContainer",children:[{scriptClass:"mstrmojo.ME.FunctionSelector",cssClass:"mstrmojo-MetricIDE-editor inline",alias:"funcBrowser",left:"0px",top:"0px",modal:false,showTitle:false,bindings:{functions:function(){return this.parent.parent.functions;},oi:function(){return this.parent.parent.oi||mstrmojo.ME.ENUM.getNewDefinition();},isDME:function(){return this.parent.parent.isDME;},activeEditor:function(){var activeEditor=this.parent.parent.editor;this.buttonNode.style.visibility=this.parent.parent.editor?"hidden":"visible";if(activeEditor){this.set("showFullSyntax",IDE.isExpEditor(activeEditor.id));}}},onfctDidChange:function(evt){var idx=Math.max(0,MDS.getCategoryIndex(evt.did)),fcPulldown=this.fcHBox.fcPulldown,fcDid=fcPulldown.selectedItem.did;if(fcDid<0){return ;}fcPulldown.set("value",MDS.getFunctionCatList()[idx].did);var fl=this.functionList;window.setTimeout(function(){idx=mstrmojo.array.find(fl.items,"did",evt.did);fl.singleSelect(idx,false);},100);},switch2Editor:function(editorId,cfg){if(cfg){cfg.id=editorId;}IDE.set("editorConfig",{editorId:editorId,cfg:cfg});},handleCloseAction:function(){if(this.onPreClose()){IDE.close();}},handleSelectedFunction:function(isDblClick){var w=this;var activeEditor=IDE.editor;if(activeEditor&&IDE.isExpEditor(activeEditor.id)){if(isDblClick){IDE.insertTokens(w.getTokens());var isSCF=function(fdid){return !isNaN(fdid)&&fdid<0;};if(!isSCF(this.functionList.selectedItem.did)){IDE.getTokenInputBox().insertParenthesisTokens();}}}else{var fl=w.functionList;w.openWizard(fl.items[fl.selectedIndex]);}},openWizard:function(item,opener){IDE.help=IDE.getEditorHelpTopic("mstrFE");if(!item||item.did===-7){return ;}var me=IDE,cfg={zIndex:me.zIndex+1,candidates:me.candidates,oi:mstrmojo.ME.ENUM.getNewDefinition()};if(MDS.isBasicAggMap(item.did)||item.did<-1){cfg.did=item.did;cfg.id="mstrSME";cfg.useGUIDefault=true;}else{cfg.fctOi=item;cfg.id="mstrFE";cfg.paramItemsPath=me.feParamItemsPath;}me.setRefOi(cfg);me.set("editorConfig",{cfg:cfg,opener:opener});}}]},{scriptClass:"mstrmojo.Box",alias:"editorsContainer",cssClass:"mstrmojo-MetricIDE-editors-container",children:[{scriptClass:"mstrmojo.Label",cssText:"line-height:380px; text-align:center;",text:mstrmojo.desc(11567,"Select a function from left"),bindings:{visible:"!this.parent.parent.editor",editor:function(){return !this.parent.parent.editor;}}}]},{scriptClass:"mstrmojo.ME.FunctionInfo",slot:"buttonNode",alias:"funcSyntaxDesc",bindings:{foi:function(){return this.parent.browsersContainer.funcBrowser.functionList.selectedItem;},showFullSyntax:function(){return this.parent.browsersContainer.funcBrowser.showFullSyntax;}}}],getBrowsersContainer:function getBrowsersContainer(){return this.browsersContainer;},renderObjectsBrowser:function renderObjectsBrowser(){var me=this;var container=this.getBrowsersContainer();if(container){container.addChildren([{scriptClass:"mstrmojo.ObjectBrowser",cssClass:"mstrmojo-MetricIDE-ob",alias:"ob",fishEyeVisible:false,closeable:false,closeOnSelect:false,quickSearch:true,visible:false,bindings:{visible:function(){var editorRef=this.parent.parent.editorRef;return editorRef&&editorRef.id==="mstrME";}},onvisibleChange:function(){if(this.visible&&!this.loaded){this.browse({folderLinksContextId:23,onSelectCB:[me,"onObjectInsert"],useDblSelect:true,browsableTypes:""});this.loaded=true;}},postCreate:function(){this.children=[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(1952,"All objects"),cssClass:"mstrmojo-MetricIDE-obLabel"}].concat(this.children);}}]);}},postBuildRendering:function(){if(this._super){this._super();}this.addSlots({editorsContainerNode:this.editorsContainer.domNode});this.renderObjectsBrowser();this.set("help",this.getBrowsersContainer().funcBrowser.help);},loadObjectDefn:function loadObjectDefn(callback){var metricId=this.metricId||this.did;if(metricId){MDS.getMetricDefintion({id:metricId,msgID:this.isDME?mstrApp.getMsgID():null},callback);}else{var newoi=mstrmojo.ME.ENUM.getNewDefinition();callback.success(newoi);}},isExpEditor:function isExpEditor(editorID){return editorID==="mstrME";},getModalEditor:function getModalEditor(cfg){this.setRefOi(cfg);return getEditorAsModal.call(this,cfg);},getEditorId:function getEditorId(cfg){var oi=cfg.oi,met=oi&&oi.tks&&oi.tks.met;var editorId=cfg.id||{65536:"mstrME",131072:"mstrSME",196608:"mstrFE"}[met]||"mstrME";if(editorId==="mstrSME"||editorId==="mstrFE"||editorId==="mstrSME_1"||editorId==="mstrFE_1"){editorId=MEH.getSpecialFunctionEditorId(this.getRootFunction(cfg),cfg.modal)||editorId;}cfg.id=editorId;return editorId;},showAsSimpleIDE:function showAsSimpleIDE(oi){var simple=false;if(this.isDME&&oi.did&&oi.tks){simple=parseInt(oi.tks.met,10)!==mstrmojo.ME.ENUM.METRIC_EDIT_TYPES.ADVANCED&&!mstrmojo.string.isEmpty(MEH.getSpecialFunctionEditorId(oi.tks.items[0].oi));}return simple;},getRootFunction:function getRootFunction(cfg){var fct=cfg.fctOi;if(!fct){fct=MEH.getRootFunction(cfg.oi);}return fct;}});}());