(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.DI.DIConstants","mstrmojo.DI.DIHelpers");mstrmojo.requiresDescs(12604,12605,12607,12608,12893,12894,12895,12896,13302,13994);var constants=mstrmojo.DI.DIConstants,helpers=mstrmojo.DI.DIHelpers,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash;function updateSalesForceLogoutIframe(src){var ifmID="oAuthSourcelogout";var ifm=document.getElementById(ifmID);if(!ifm){ifm=document.createElement("IFRAME");ifm.id=ifmID;document.body.appendChild(ifm);ifm.style.display="none";}ifm.src=src;}function getPopupWindowOptions(){var wnd_settings={};var screenX=window.screenX||window.screenLeft||0,screenY=window.screenY||window.screenTop||0,wndW=800,wndH=600,wnd_options;if(document.body&&document.body.offsetWidth){wndW=document.body.offsetWidth;wndH=document.body.offsetHeight;}if(document.compatMode==="CSS1Compat"&&document.documentElement&&document.documentElement.offsetWidth){wndW=document.documentElement.offsetWidth;wndH=document.documentElement.offsetHeight;}if(window.innerWidth&&window.innerHeight){wndW=window.innerWidth;wndH=window.innerHeight;}if(window.outerWidth){wndW=window.outerWidth;}if(window.outerHeight){wndH=window.outerHeight;}wnd_settings.height=wndH*0.5;wnd_settings.width=wndW*0.8;if(wnd_settings.height<600||isNaN(wnd_settings.height)){wnd_settings.height=600;}if(wnd_settings.width<800||isNaN(wnd_settings.width)){wnd_settings.width=800;}wnd_settings.left=screenX+(wndW-wnd_settings.width)/2;wnd_settings.top=screenY+(wndH-wnd_settings.height)/8;wnd_options="width="+wnd_settings.width+",height="+wnd_settings.height;wnd_options+=",toolbar=0,scrollbars=1,status=1,resizable=1,location=1,menuBar=0";wnd_options+=",left="+wnd_settings.left+",top="+wnd_settings.top;return wnd_options;}function createOAuthPopupWindow(authURL){var wnd,wnd_options;wnd_options=getPopupWindowOptions();if(!authURL){authURL="";}wnd=window.open(authURL,"Authorization",wnd_options);return{wnd:wnd};}function openOAuthPopupWindow(wnd,authURL){var r;if(wnd&&!wnd.closed){wnd.location=authURL;wnd.focus();}else{r=createOAuthPopupWindow(authURL);wnd=r.wnd;if(wnd){wnd.focus();}}return wnd;}function sendOAuthResponse(response){var opener=window.opener,origin;if(opener){origin=window.location.origin;if(!origin){origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"");}try{if(helpers.isIE()&&opener.postMessagePassthrough){opener.postMessagePassthrough(response,origin);try{window.open("","_self","");window.close();}catch(e){window.close();}}else{origin=window.location.origin;opener.postMessage(response,origin);}}catch(ex){console.log("postMessage error: "+ex);}}}mstrmojo.DI.controller.DIOAuthController=mstrmojo.declare(mstrmojo.Obj,null,{popupWnd:null,responseHandler:null,beforeOAuth:function(){var r;if(!this.popupWnd||this.popupWnd.closed){r=createOAuthPopupWindow();this.popupWnd=r.wnd;}return !!this.popupWnd;},afterOAuth:function(){var that=this;window.setTimeout(function(){if(that.popupWnd&&!that.popupWnd.closed){that.popupWnd.close();}that.popupWnd=null;},0);},getExternalSourcesInfo:function getExternalSourcesInfo(){var controller=mstrApp.getRootController(),model=controller.getModel(),url=window.location.href.toLowerCase(),urlParams=helpers.getURLParameters(url);if(window.opener&&(url.indexOf("code=")>=0||url.indexOf("oauth_token")>=0||url.indexOf("accesstoken")>=0||url.indexOf("denied=")>=0||url.indexOf("access_denied")>=0||(urlParams.state&&urlParams.state.toUpperCase()==="OC"))){model.set("operationMode",constants.operationMode.oauth);sendOAuthResponse(window.location.href);}else{model.populateExternalSources();controller.restoreForLaunchingApp();}},oAuthSignOut:function oAuthSignOut(type){var controller=mstrApp.getRootController(),oAuthSource=controller.model.externalSources[type],params={},curSlot,slot,pageConfig,url,intType=parseInt(type,10);var callback={success:function(){var windowOptions;oAuthSource.reset();if(intType===constants.sourceType.facebook){windowOptions=getPopupWindowOptions();window.open("https://www.facebook.com","",windowOptions);return ;}slot=controller.navigationController.getPageSlot();if(pageConfig){slot.setConfig(pageConfig);}controller.getOAuthSourceReports(type,false,slot);}};if(!oAuthSource){controller.displayError(mstrmojo.desc(12608,"Could not log out. Please do so by manually going to the website"),false);}if(helpers.isIE7()&&intType===constants.sourceType.salesforce){window.location.href="https://embedexpress-dev-ed.my.salesforce.com/secur/logout.jsp";}else{switch(intType){case constants.sourceType.dropbox:updateSalesForceLogoutIframe("https://www.dropbox.com/logout");break;case constants.sourceType.googleDrive:updateSalesForceLogoutIframe("https://www.google.com/accounts/logout");break;case constants.sourceType.googleAnalytics:updateSalesForceLogoutIframe("https://www.google.com/accounts/logout");break;case constants.sourceType.salesforce:url="https://embedexpress-dev-ed.my.salesforce.com/secur/logout.jsp";if(oAuthSource.instanceUrl){url=oAuthSource.instanceUrl+"/secur/logout.jsp";}updateSalesForceLogoutIframe(url);break;case constants.sourceType.twitter:updateSalesForceLogoutIframe("https://twitter.com/logout");break;}if(controller.rootView.currentPage){curSlot=controller.navigationController.getPageSlot(controller.rootView.currentPage.pageSlotKey);pageConfig=curSlot.getConfig();}if(controller.rootView.currentPage&&controller.rootView.currentPage.tableID){controller.showPage(constants.pageType.emmaPreview);}else{controller.showPage(constants.pageType.dataSelection);}}params.dbRoleID=oAuthSource.dbRoleID;if(oAuthSource.sourceAccountID){params.sourceAccountID=oAuthSource.sourceAccountID;}controller.dataService.signOutOAuthSource(callback,params);},oneTierOAuth:function oneTierOAuth(sourceType,forceRefreshTokenFetch,slot){this.sourceType=sourceType;this.slot=slot;this.getWebServiceURL(sourceType,forceRefreshTokenFetch,slot);},getWebServiceURL:function getWebServiceURL(sourceType,forceRefreshTokenFetch,slot){var sourceTypeEnum=constants.sourceType;var controller=mstrApp.getRootController();var me=this;var externalSource=mstrApp.getRootController().model.externalSources[sourceType];var responseHandler=function OAuthResponseHandler(evt){var url,urlParams,msg=mstrmojo.desc(13302,"This app is blocked by admin in Salesforce.");if(mstrApp.originUrl.indexOf(evt.origin)>=0){me.afterOAuth();$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;if(sourceType===constants.sourceType.salesforce){url=evt&&evt.data;urlParams=helpers.getURLParameters(url);if(urlParams.error&&urlParams.error==="OAUTH_APP_BLOCKED"){mstrApp.getRootController().displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,msg);return ;}}me.getWebServiceCatalog(sourceType,evt.data,slot);}};var callback={success:function(res){var authURL;if(res.url){authURL=res.url;}else{authURL=res;}if(!authURL||authURL.length===0){$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;controller.displayError(mstrmojo.desc(12893,"Oops Unable to get the authorization URL for the given webservice. Please contact your administrator"));return ;}if(forceRefreshTokenFetch&&(sourceType===sourceTypeEnum.googleDrive||sourceType===sourceTypeEnum.googleAnalytics||sourceType===sourceTypeEnum.googleBigQuery)){if(authURL.indexOf("approval_prompt=force")<0){authURL+="&approval_prompt=force";}}if(mstrApp.isCloud){var location=window.location,protocol=location.protocol,shardHost=location.hostname,port=location.port,pathparams=location.pathname.split("/");var app=pathparams&&pathparams.length!==0&&pathparams[1],envString="ptc_"+protocol+"shrd_"+shardHost+":port_"+port+":app_"+app;authURL+=("&state="+envString);}if(mstrmojo.getCSRFToken()){authURL+=("&state=validateRandNum"+mstrmojo.getCSRFToken());}me.popupWnd=openOAuthPopupWindow(me.popupWnd,authURL);if(!me.popupWnd){$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;controller.displayError(mstrmojo.desc(12894,"Your browser has blocked the popup for this site. Please enable the popup for this site in order to continue and sign in."),false);return ;}},failure:function(res){$DOM.detachEvent(window,"message",me.responseHandler);this.responseHandler=null;me.afterOAuth();controller.displayError(mstrmojo.desc(12893,"Oops Unable to get the authorization URL for the given webservice. Please contact your administrator"),false,res.message);controller.showPage(constants.pageType.dataSelection);}};if(helpers.isIE()){window.postMessagePassthrough=function(response,origin){responseHandler({origin:origin,data:response});};}if(me.responseHandler){$DOM.detachEvent(window,"message",me.responseHandler);}$DOM.attachEvent(window,"message",responseHandler);this.responseHandler=responseHandler;var params={dbRoleID:externalSource.dbRoleID,scope:externalSource.scope,flags:4};controller.dataService.getWebServiceURL(callback,params);},oneTierOAuthHandler:function oneTierOAuthHandler(code){this.afterOAuth();if(code.search("access_denied")<0&&code.search("denied")<0){this.getWebServiceCatalog(this.sourceType,code,this.slot);}},getWebServiceCatalogCallback:function getWebServiceCatelogCallback(type,slot){var controller=mstrApp.getRootController();var oAuth=this;var oAuthSource=controller.model.externalSources[type],currentSourceType=type,model=controller.model,tableID,slotCfg,importSource,xdaType,dialog;return{success:function(res){if(!oAuthSource.sourceAccountID&&res.mi.sinf.said){oAuthSource.sourceAccountID=res.mi.sinf.said;}if(model.operationMode===constants.operationMode.subscribe){controller.readyForSubscription();}else{if(model.operationMode===constants.operationMode.enterCredentials){controller.model.updateDocumentCredentials(oAuth.tableIDs,true);}else{var sourceInfo=model.externalSources;switch(currentSourceType){case constants.sourceType.twitter:oAuthSource.populateReports(res);controller.showPage(constants.pageType.twitter,sourceInfo[currentSourceType],slot);break;case constants.sourceType.facebook:oAuthSource.populateReports(res);controller.showPage(constants.pageType.facebook,sourceInfo[currentSourceType],slot);break;case constants.sourceType.dropbox:case constants.sourceType.googleDrive:case constants.sourceType.salesforce:case constants.sourceType.googleAnalytics:controller.showPage(constants.pageType.sourceObjectsDnD,sourceInfo[currentSourceType],slot);oAuthSource.populateReports(res);break;case constants.sourceType.googleBigQuery:slotCfg=slot&&slot.getConfig&&slot.getConfig();tableID=slotCfg&&slotCfg.properties&&slotCfg.properties.tableID;importSource=tableID&&model.getImportSource(tableID);xdaType=(importSource&&importSource.xdaType)||mstrApp.bigQueryXdatype;oAuthSource.populateReports(res);window.setTimeout(function(){mstrApp.getRootController().showPage(constants.pageType.database,{sourceType:constants.sourceType.googleBigQuery,type:xdaType},slot);dialog=controller.rootView.parent;if(dialog&&dialog.editorNode){$DOM.center(dialog.editorNode);}},1);break;}}}},failure:function(res){var errorCode=parseInt(res.code||res.getResponseHeader("X-MSTR-TaskErrorCode"),10);controller.closePageDialog();if(model.operationMode===constants.operationMode.enterCredentials){controller.model.updateDocumentCredentials(this.tableIDs,false);}if(errorCode===constants.backendError.refreshTokenUnavailable){controller.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res.message);}else{if(errorCode===constants.backendError.noExternalSession){controller.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res.message);}else{if(errorCode===constants.backendError.noExternalSourceInfo&&currentSourceType===constants.sourceType.googleAnalytics){controller.displayError(mstrmojo.desc(12895,"Could not find a Google Analytics account for your account. Please sign in with a different account."),false);controller.oAuthSignOut(currentSourceType);}else{controller.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res.message);if(model.operationMode!==constants.operationMode.enterCredentials){controller.showPage(constants.pageType.dataSelection);}}}}}};},getWebServiceCatalog:function getWebServiceCatalog(type,code,slot){var controller=mstrApp.getRootController();var oAuthSource=controller.model.externalSources[type],params={dbRoleID:oAuthSource.dbRoleID,code:code};params.flags=constants.sourcesInfoFlags.getReports|constants.sourcesInfoFlags.getUserName;if(type===constants.sourceType.googleAnalytics){params.flags=params.flags|constants.sourcesInfoFlags.getGAnalyticsAccount;}if(type===constants.sourceType.googleBigQuery){params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount|constants.sourcesInfoFlags.getUserName;}if(type===constants.sourceType.salesforce){params.flags|=constants.sourcesInfoFlags.getTokensInfo;}if(this.tableIDs){params.tableIDs=this.tableIDs;}controller.dataService.getWebServiceCatalog(this.getWebServiceCatalogCallback(type,slot),params);},getAnalyticsWebProperties:function getAnalyticsWebProperties(accountID){var controller=mstrApp.getRootController();var oAuthSource=controller.model.externalSources[constants.sourceType.googleAnalytics];var params=oAuthSource.getSourceParams();params.gaAccountID=accountID;params.gaWebPropertyID="";params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount;if(oAuthSource.checkWebProperties(accountID,true)){controller.getAnalyticsProfiles(accountID,oAuthSource.getAccountById(accountID).webProperties[0].id);return ;}var callback={success:function(res){oAuthSource.onGetAnalyticsWebProperties[accountID]=false;oAuthSource.populateWebProperties(res,accountID);controller.getAnalyticsProfiles(accountID,oAuthSource.getAccountById(accountID).webProperties[0].id);},failure:function(){controller.displayError(mstrmojo.desc(12604,"Unable to fetch Analytics web properties."),false);}};if(!oAuthSource.onGetAnalyticsWebProperties[accountID]){oAuthSource.onGetAnalyticsWebProperties[accountID]=true;controller.dataService.getOAuthSourceReports(callback,params);}},getAnalyticsProfiles:function getAnalyticsProfiles(accountID,webPropertyID){var controller=mstrApp.getRootController();var oAuthSource=controller.model.externalSources[constants.sourceType.googleAnalytics];var params=oAuthSource.getSourceParams();params.gaAccountID=accountID;params.gaWebPropertyID=webPropertyID;params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount;if(oAuthSource.checkProfiles(accountID,webPropertyID,true)){return ;}var callback={success:function(res){oAuthSource.onGetAnalyticsProfiles[accountID+":"+webPropertyID]=false;oAuthSource.populateProfiles(res,accountID,webPropertyID);},failure:function(){controller.displayError(mstrmojo.desc(12605,"Unable to fetch Analytics profiles."),false);}};if(!oAuthSource.onGetAnalyticsProfiles[accountID+":"+webPropertyID]){oAuthSource.onGetAnalyticsProfiles[accountID+":"+webPropertyID]=true;controller.dataService.getOAuthSourceReports(callback,params);}},getOAuthSourceReports:function getOAuthSourceReports(type,sendOAuthDetails,slot,query,cb){var controller=mstrApp.getRootController();var oAuthSource=controller.model.externalSources[type],params={},currentSourceType=type,model=controller.model,tableID,slotCfg,footerConfig,importSource,xdaType,dialog;if(!oAuthSource){return ;}if(sendOAuthDetails){params=oAuthSource.getSourceParams();if(type===constants.sourceType.googleAnalytics){params.gaAccountID="";params.gaWebPropertyID="";params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount|constants.sourcesInfoFlags.getReports|constants.sourcesInfoFlags.getTokensInfo|constants.sourcesInfoFlags.getUserName;}}else{params.dbRoleID=oAuthSource.dbRoleID;if(oAuthSource.sourceAccountID){params.sourceAccountID=oAuthSource.sourceAccountID;}}if(type===constants.sourceType.googleAnalytics){params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount|constants.sourcesInfoFlags.getReports|constants.sourcesInfoFlags.getTokensInfo|constants.sourcesInfoFlags.getUserName;}if(type===constants.sourceType.googleBigQuery){params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount|constants.sourcesInfoFlags.getTokensInfo|constants.sourcesInfoFlags.getUserName;}if(type===constants.sourceType.facebook){if(query){params.fbPageSearchQuery=query;}}slotCfg=slot&&slot.getConfig&&slot.getConfig();footerConfig=slotCfg&&slotCfg.footerConfig;var callback=cb||{success:function(res){if(!oAuthSource.sourceAccountID&&res.mi.sinf.said){oAuthSource.sourceAccountID=res.mi.sinf.said;}if(model.operationMode===constants.operationMode.subscribe){controller.readyForSubscription();}else{var sourceInfo=model.externalSources;switch(currentSourceType){case constants.sourceType.twitter:oAuthSource.populateReports(res);controller.showPage(constants.pageType.twitter,sourceInfo[currentSourceType],slot,footerConfig);break;case constants.sourceType.facebook:oAuthSource.populateReports(res);controller.showPage(constants.pageType.facebook,sourceInfo[currentSourceType],slot,footerConfig);break;case constants.sourceType.dropbox:case constants.sourceType.googleDrive:case constants.sourceType.salesforce:case constants.sourceType.googleAnalytics:controller.showPage(constants.pageType.sourceObjectsDnD,sourceInfo[currentSourceType],slot,footerConfig);oAuthSource.populateReports(res);break;case constants.sourceType.googleBigQuery:tableID=slotCfg&&slotCfg.properties&&slotCfg.properties.tableID;importSource=tableID&&model.getImportSource(tableID);xdaType=(importSource&&importSource.xdaType)||mstrApp.bigQueryXdatype;oAuthSource.populateReports(res);window.setTimeout(function(){controller.showPage(constants.pageType.database,{sourceType:constants.sourceType.googleBigQuery,type:xdaType},slot,footerConfig);dialog=controller.rootView.parent;if(dialog&&dialog.editorNode){$DOM.center(dialog.editorNode);}},1);break;}}},failure:function(res){var errorCode=parseInt(res.code||(res.getResponseHeader&&res.res.getResponseHeader("X-MSTR-TaskErrorCode")),10);if(errorCode===constants.backendError.refreshTokenUnavailable){controller.gotoOAuthLogin(currentSourceType,true,slot);}else{if(errorCode===constants.backendError.noExternalSession&&(!sendOAuthDetails)){controller.gotoOAuthLogin(currentSourceType,false,slot);}else{if(errorCode===constants.backendError.noExternalSourceInfo&&currentSourceType===constants.sourceType.googleAnalytics){controller.displayError(mstrmojo.desc(12896,"Could not find a Google Analytics account for ####. Please sign in with a different account.").replace("####",oAuthSource.userDisplayName),false);controller.oAuthSignOut(currentSourceType);}else{controller.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res&&res.message);controller.showPage(constants.pageType.dataSelection);}}}}};controller.dataService.getOAuthSourceReports(callback,params);},getOAuthSourceFolderContents:function getOAuthSourceFolderContents(type,params,callback){var controller=mstrApp.getRootController();var oAuthSource=controller.model.externalSources[type];var baseParams=oAuthSource.getSourceParams();controller.dataService.getOAuthSourceReports(callback,$HASH.copy(params,baseParams));},oAuthSourceBrowserFunction:function(type,node,path,address){var controller=mstrApp.getRootController();var callback={success:function(res){var list=controller.parseOAuthSourceFolder(type,res);node.data.browser.set("fileList",list);if(path){var items=node.items,i;var folders=items,reports=items;var index=path.indexOf("/",1);if(index!==-1){var folderName=path.substring(1,index);for(i=0;i<folders.length;i++){if(folders[i].isFolder===true&&folders[i].n===folderName){node.data.browser.autoSelectNode(folders[i].node,path.substring(index),address);folders[i].fetched=true;folders[i].node.set("state",1);}}}else{var fileName=path.substring(1);for(i=0;i<reports.length;i++){if(reports[i].isFolder!==true&&reports[i].n===fileName){if(address){if(address===reports[i].address){reports[i].node.data.browser.autoSelectNode(reports[i].node);}}else{reports[i].node.data.browser.autoSelectNode(reports[i].node);}}}}}},failure:function(res){if(node&&node.data){node.set("state",0);node.data.set("fetched",false);}controller.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res&&res.message);}};this.getOAuthSourceFolderContents(type,{folderName:node.data.address},callback);},oAuthSourceFetchFunction:function oAuthSourceFetchFunction(type,params){var controller=mstrApp.getRootController();var callback={success:function(res){var oAuthSource=mstrApp.getRootController().getModel().externalSources[type];oAuthSource.populateReports(res);},failure:function(res){controller.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res&&res.message);}};this.getOAuthSourceFolderContents(type,params,callback);},parseOAuthSourceFolder:function parseOAuthSourceFolder(type,res){var oAuthSource=mstrApp.getRootController().getModel().externalSources[type];return oAuthSource.parseOAuthSourceFolder(res);}});}());