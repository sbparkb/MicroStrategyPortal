(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.array","mstrmojo.dom","mstrmojo._TouchGestures","mstrmojo.SmoothScroll","mstrmojo._HasTouchScroller");var PAD_STEP=16;var NODE_STATE_TEXT_MAP={0:"&#9654;",1:"&#9660;",2:"&nbsp;"};var NODE_STATE_CSS_MAP=["heatmap-tree-state-text collapsed","heatmap-tree-state-text expanded","heatmap-tree-state-text leaf"];var SELECTION_STATUS={NO:0,YES:1,PART:2};mstrmojo.VisHeatMapTreeItem=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.VisHeatMapTreeItem",isRoot:false,showRoot:false,rootText:"",idx:0,buttonNodeCss:"heatmap-tree-checkbox",buttonNodeWidget:null,markupString:'<div id="{@id}" class="heatmap-tree" style="{@cssText}"><div class="{@cssName}" idx="{@idx}"><div class="heatmap-tree-state"><div class="heatmap-tree-state space">&nbsp;</div><div class="heatmap-tree-state-text"></div></div><div class="heatmap-tree-text"></div><div class="{@buttonNodeCss}">&nbsp;</div></div><div class="heatmap-tree-container"></div></div>',markupSlots:{contentNode:function(){return this.domNode.firstChild;},stateNode:function(){return this.domNode.firstChild.firstChild;},stateSpaceNode:function(){return this.domNode.firstChild.firstChild.firstChild;},stateTextNode:function(){return this.domNode.firstChild.firstChild.lastChild;},textNode:function(){return this.domNode.firstChild.childNodes[1];},buttonNode:function(){return this.domNode.firstChild.childNodes[2];},containerNode:function(){return this.domNode.lastChild;}},markupMethods:{ontextChange:function(){this.textNode.innerHTML=this.text;},onstateChange:function(){this.stateTextNode.className=NODE_STATE_CSS_MAP[this.state];if(!this.isRoot){this.containerNode.style.display=(this.state===1)?"block":"none";if(this.state!=2){this.tree.resized();}}}},level:-1,tree:null,itemDisplayField:"n",itemChildrenField:"items",isSelectable:true,itemFunctionField:"itemFunction",itemIncludeFunction:function(){return true;},dataProvider:null,owner:null,cssName:"heatmap-tree-div",fillData:function(){var tree=this.tree||this;if(this.dataProvider){this.items=this.dataProvider[this.itemChildrenField];this.entity=this.dataProvider;this.entity.treeItem=this;}var items=this.items;if(this.items&&this.items.length){this.childTree=[];var childIndex=0;for(var i=0;i<items.length;i++){var item=items[i];if(this.itemIncludeFunction(item)){var text;if(tree.owner){text=item.label;}else{text=item[this.itemDisplayField];}var iw={idx:childIndex,isRoot:false,text:text,itemFunction:item[this.itemFunctionField],buttonNodeWidget:item.buttonNodeWidget,tree:tree,level:(this.level+1),itemDisplayField:this.itemDisplayField,itemChildrenField:this.itemChildrenField,parent:this,parentTree:this,state:0,owner:this.owner,isSelectable:this.isSelectable,itemIncludeFunction:this.itemIncludeFunction,buttonNodeCss:this.buttonNodeCss,fillData:this.fillData,buildTree:this.buildTree,setChildStatus:this.setChildStatus,updateSelection:this.updateSelection};if(this.dataProvider){iw.dataProvider=item;}else{iw.items=item[this.itemChildrenField];}this.childTree[childIndex]=iw;childIndex++;}}}},renderChildrenList:function(){if(!this.childTree){return ;}var len=this.childTree.length,insertIndex,cachedUnits;if(this.tree){cachedUnits=this.tree.cachedUnits;insertIndex=cachedUnits.indexOf(this.contentNode)+1;if(insertIndex==0){insertIndex=cachedUnits.length;}}if(this.isRoot&&this.showScrollbars){insertIndex=0;cachedUnits=this.cachedUnits;}for(var i=0;i<len;i++){if(this.childTree[i].domNode){this.tree.cachedUnits.splice(insertIndex,0,this.childTree[i].contentNode);insertIndex++;continue;}var div=document.createElement("div");this.containerNode.appendChild(div);this.childTree[i].placeholder=div;var treeItem=new mstrmojo.VisHeatMapTreeItem(this.childTree[i]);if(!treeItem){alert("new failed!");}treeItem.childTree=this.childTree[i].childTree;if(treeItem.childTree){var child=treeItem.childTree,clen=child.length;for(var j=0;j<clen;j++){child[j].parent=treeItem;child[j].parentTree=treeItem;}}this.childTree[i]=treeItem;this.childTree[i].render();if(!isNaN(insertIndex)){cachedUnits.splice(insertIndex,0,this.childTree[i].contentNode);insertIndex++;}}},postBuildRendering:function(){if(this._super){this._super();}this.domNode.style.display="none";var tree=this.tree||this;if(this.dataProvider){this.items=this.dataProvider[this.itemChildrenField];}if(this.isRoot){if(!this.showRoot){this.contentNode.style.display="none";}else{this.stateNode.style.display="none";this.textNode.innerHTML=this.rootText;}this.containerNode.className="heatmap-tree-container root";}else{if(this.buttonNodeWidget){this.buttonNodeWidget.placeholder=this.buttonNode;var buttonWidget=mstrmojo.insert(this.buttonNodeWidget);buttonWidget.render();this.buttonNode=buttonWidget.domNode;}this.textNode.innerHTML=this.text;var padLeft=(this.level+1)*PAD_STEP;this.stateSpaceNode.style.width=(padLeft>=0?padLeft:0)+"px";this.textNode.style.width=this.domNode.offsetWidth-this.stateNode.offsetWidth-this.buttonNode.offsetWidth-10+"px";}this.domNode.style.display="block";if(!(this.items&&this.items.length)){this.set("state",2);this.tree.sampleUnit=this.domNode;}else{if(this.entity&&this.entity.isExpanded){this.clickHandler({target:this.stateNode});}}},buildTree:function(){this.fillData();var len=this.childTree&&this.childTree.length||0;for(var i=0;i<len;i++){this.childTree[i].buildTree();}},clickHandler:function(evt){var target=evt.target;var e,eWS,ee;if(this.owner){if(!this.owner.entitiesWithStates){this.owner.entitiesWithStates={};}eWS=this.owner.entitiesWithStates;e=this.entity;}if(this.state!==2&&mstrmojo.dom.contains(this.stateNode,target,true,this.domNode)){this.set("state",this.state===0?1:0);if(this.state==1){this.renderChildrenList();this.updateChildrenSelection();}else{var deleteIndex=this.tree.cachedUnits.indexOf(this.contentNode);if(deleteIndex!=-1){deleteIndex++;var len=this.childTree.length;this.tree.cachedUnits.splice(deleteIndex,len);}}if(e&&eWS){if(!eWS.expendedEntities){eWS.expendedEntities=[];}ee=eWS.expendedEntities;if(this.state===0){delete e.isExpanded;var i=ee.indexOf(e);if(i!==-1){ee.splice(i,1);}}else{if(this.state===1){e.isExpanded=true;if(ee.indexOf(e)===-1){ee.push(e);}}}}this.tree.resized();this.tree.updateScroller();return ;}if(this.itemFunction){this.itemFunction(evt);}if(!this.isSelectable){return ;}mstrmojo.VisHeatMapAnimation.animate(this.contentNode,"background",{r:51,g:181,b:229,a:0.6},{r:255,g:255,b:255,a:0});if(this.selectionStatus===SELECTION_STATUS.YES){this.selectionStatus=SELECTION_STATUS.NO;}else{this.selectionStatus=SELECTION_STATUS.YES;}this.setChildStatus(this.selectionStatus);this.updateSelection(false,true);if(eWS&&e){if(!eWS.selectionStatusModifiedEntities){eWS.selectionStatusModifiedEntities=[];}ee=eWS.selectionStatusModifiedEntities;if(this.selectionStatus===SELECTION_STATUS.NO){e.isSelected=false;}else{if(this.selectionStatus===SELECTION_STATUS.YES){e.isSelected=true;}}ee.push(e);}},setChildStatus:function(status){if(this.childTree){for(var i=0;i<this.childTree.length;i++){var item=this.childTree[i];if(!item){continue;}item.selectionStatus=status;item.setChildStatus(status);item.updateSelection(false,false);}}},updateChildrenSelection:function(){if(!this.childTree){return ;}var len=this.childTree.length;for(var i=0;i<len;i++){if(this.childTree[i]){this.childTree[i].updateSelection(false,false);}}},updateSelection:function(checkChild,callParent){if(checkChild&&this.childTree){var allSelected=true;var noSelected=true;var partSelected=false;for(var i=0;i<this.childTree.length;i++){var item=this.childTree[i];if(allSelected&&item.selectionStatus!==SELECTION_STATUS.YES){allSelected=false;}if(noSelected&&item.selectionStatus!==SELECTION_STATUS.NO){noSelected=false;}if(!allSelected&&!noSelected){partSelected=true;break;}}this.selectionStatus=allSelected?SELECTION_STATUS.YES:(noSelected?SELECTION_STATUS.NO:SELECTION_STATUS.PART);}var cssClass="heatmap-tree-div";switch(this.selectionStatus){case SELECTION_STATUS.YES:cssClass+=" selected";break;case SELECTION_STATUS.PART:cssClass+=" partSelected";break;case SELECTION_STATUS.NO:default:break;}this.cssName=cssClass;if(this.contentNode){this.contentNode.className=cssClass;}if(callParent&&this.parentTree){this.parentTree.updateSelection(true,true);}if(this.isRoot){this.notifyAll();}},resized:function(){if(this.parent.resized){this.parent.resized(this.domNode.offsetHeight);}},selectionStatus:SELECTION_STATUS.NO});mstrmojo.VisHeatMapTree=mstrmojo.declare(mstrmojo.VisHeatMapTreeItem,[mstrmojo._TouchGestures,mstrmojo._HasTouchScroller],{scriptClass:"mstrmojo.VisHeatMapTree",isRoot:true,showRoot:false,rootText:"",heightLimit:0,defaultSelectionStatus:SELECTION_STATUS.NO,markupString:'<div id="{@id}" class="heatmap-tree root {@cssClass}" style="{@cssText} mstrAttach:mousedown,mousemove,mouseup,click"><div class="heatmap-tree-div" style="line-height:40px;" idx="{@idx}"><div class="heatmap-tree-state" style="display:none;"><div class="heatmap-tree-state space">&nbsp;</div><div class="heatmap-tree-state-text"></div></div><div class="heatmap-tree-text"></div><div class="{@buttonNodeCss}">&nbsp;</div></div><div style="overflow:hidden; position:relative"><div class="heatmap-tree-container"></div></div></div>',markupSlots:{contentNode:function(){return this.domNode.firstChild;},stateNode:function(){return this.domNode.firstChild.firstChild;},stateSpaceNode:function(){return this.domNode.firstChild.firstChild.firstChild;},stateTextNode:function(){return this.domNode.firstChild.firstChild.lastChild;},textNode:function(){return this.domNode.firstChild.childNodes[1];},buttonNode:function(){return this.domNode.firstChild.childNodes[2];},scrollboxNode:function(){return this.domNode.lastChild;},containerNode:function(){return this.domNode.lastChild.firstChild;}},initialized:false,dirty:false,showIndicators:false,showScrollbars:false,cachedUnits:[],init:function(config){this._super(config);this.observer=[];},register:function(widget){this.observer.push(widget);this.notifyAll();},notifyAll:function(){var enabled=false;if(this.childTree&&this.childTree.length>0){enabled=true;}if(enabled){mstrmojo.css.removeClass(this.contentNode,"disabled");}else{mstrmojo.css.addClass(this.contentNode,"disabled");}if(this.selectionStatus===SELECTION_STATUS.NO){enabled=false;}for(var index in this.observer){this.observer[index].notify(enabled);}},buildRendering:function(){if(this.isRoot){this.cachedParent=this.parent;delete this.parent;}if(this._super){this._super();}},postBuildRendering:function(){var t0=(new Date()).getTime();if(this.isRoot){this.scrollerConfig={bounces:false,showIndicators:this.showIndicators,showScrollbars:this.showScrollbars,useTranslate3d:true,vScroll:true,hScroll:false,offset:{y:{start:0,end:0},x:{start:0,end:0}},origin:{x:0,y:0},scrollEl:this.containerNode};}this.buildTree();this.applySelectionStatus();this._super();this.renderChildrenList();if(this.isRoot){this.parent=this.cachedParent;this.parent.containerNode.appendChild(this.domNode);}if(this.heightLimit>0){var limit=this.heightLimit-this.contentNode.offsetHeight-2;if(limit>=0){this.scrollboxNode.style.maxHeight=limit+"px";}}this.viewNode=this.scrollboxNode;this.notifyAll();this.resized();this.updateScroller();var _this=this;_this._scroller.scrollTo(0,_this.owner&&_this.owner.dialogScrollerPosition||0);},applySelectionStatus:function(){this.selectionStatus=this.defaultSelectionStatus;this.setChildStatus(this.selectionStatus);this.updateSelection(false,true);var es=this.owner&&this.owner.entitiesWithStates&&this.owner.entitiesWithStates.selectionStatusModifiedEntities||[],len=es.length,i;for(i=0;i<len;i++){var e=es[i],item=e.treeItem;if(item&&e.isSelected!==undefined){item.selectionStatus=e.isSelected?SELECTION_STATUS.YES:SELECTION_STATUS.NO;item.setChildStatus(item.selectionStatus);item.updateSelection(false,true);}delete e.treeItem;}},touchTap:function(event){var title=mstrmojo.dom.findAncestorByAttr(event.target,"id",true,this.domNode);if(!title){this.clickHandler(event);return ;}var item=mstrmojo.all[title.value];if(item&&item.clickHandler){item.clickHandler(event);}},resized:function(childHeight){var $P=mstrmojo.dom.position;if(!this.viewRect){this.viewRect=$P(this.scrollboxNode,true);}if(!(this.heightLimit>0)){return ;}if(!this._scroller.offset){return ;}childHeight=childHeight||this.containerNode.offsetHeight;if(childHeight>this.scrollboxNode.clientHeight){this._scroller.offset.y.end=childHeight-this.scrollboxNode.clientHeight;}else{this._scroller.offset.y.end=0;this._scroller.scrollTo(0,0,0);}},refresh:function(){if(this.needRefresh){this.containerNode.innerHTML="";this.postBuildRendering();this.resized();this.updateScroller();this.needRefresh=false;}},destroy:function(e){if(this.owner&&this._scroller&&this._scroller.origin){this.owner.dialogScrollerPosition=this._scroller.origin.y||0;}if(this._super){this._super(e);}}});}());