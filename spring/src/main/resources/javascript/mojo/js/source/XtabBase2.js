(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasScrollbox","mstrmojo.XtabZone","mstrmojo._ShowsStatus","mstrmojo.boxmodel","mstrmojo.dom");var ROW_AXIS=1,COL_AXIS=2,LOCK_OFF=0,LOCK_ROW=1,LOCK_COL=2,LOCK_BOTH=3;var CP_TITLE=1;var CP_COL_HEADERS=2;var CP_ROW_HEADERS=4;var CP_VALUES=8;var $D=mstrmojo.dom,UNSET;function onDemandCPAgg(cpList){var vCP=null;if(cpList&&cpList.length>1){vCP=new mstrmojo.XtabVACP();vCP.cps=cpList;}return vCP;}function repaint(node){var img=document.createElement("img");node.appendChild(img);node.removeChild(img);}function convertEmtoPx(dom,v){if($D.isIE){return mstrmojo.boxmodel.convert2px(dom,v);}return v;}function addOnDemandCPs(rw){if(!rw||this._onDemandCP){return null;}var blockCount=rw.bc,totalRows=rw.tc,rowsRemaining=totalRows-blockCount,numCPs=Math.ceil(rowsRemaining/blockCount),rhsCPList=[],valuesCPList=[],i;for(i=0;i<numCPs;++i){var rc=Math.min(rowsRemaining,blockCount);rhsCPList.push(this.createOnDemandCP(i+1,rc,CP_ROW_HEADERS));valuesCPList.push(this.createOnDemandCP(i+1,rc,CP_VALUES));rowsRemaining-=blockCount;}this._onDemandCP={rhs:rhsCPList,vls:valuesCPList};return this._onDemandCP;}mstrmojo.XtabBase2=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasScrollbox,mstrmojo._ShowsStatus],{scriptClass:"mstrmojo.XtabBase2",dataRenderMode:"vscroll",handleClicks:function handleClicks(){return true;},markupString:'<div id="{@id}" k="{@k}" class="mstrmojo-Xtab {@cssClass}" title="{@tooltip}" style="{@domNodeCssText}"><div style="display: none;{@msgNodeCssText}"><div>&nbsp;</div></div><div class="mstrmojo-Xtab-overlay"></div><div class="mstrmojo-Xtab-content {@cssDefault}" title="{@tooltip}" style="{@viewportCssText}" mstrAttach:click,selectstart><table cellspacing="0" cellpadding="0"><tr trType="title"><td style="vertical-align:top;padding:0px"></td><td class="xtab-tr" style="vertical-align:top;padding:0px;"></td></tr><tr trType="content"><td class="xtab-bl" style="vertical-align:top;padding:0px;"></td><td class="xtab-br" style="vertical-align:top;padding:0px"><div class="mstrmojo-progress" style="display:none"><div class="mstrmojo-progress-barbg"><div class="mstrmojo-progress-bar"></div></div><div class="mstrmojo-progress-text"></div></div><div id="{@id}_scrollbox" style="position:relative;{@scrollboxNodeCssText};{@scrollboxNodeOverflow}"></div></td></tr></table></div></div>',markupSlots:{overlayNode:function(){return this.domNode;},msgNode:function(){return this.domNode.firstChild;},maskNode:function(){return this.domNode.childNodes[1];},viewport:function(){return this.domNode.lastChild;},contentNode:function(){return this.domNode.lastChild.firstChild;},scrollboxNode:function(){return this.domNode.lastChild.firstChild.rows[1].cells[1].lastChild;},_TL:function(){return this.domNode.lastChild.firstChild.rows[0].cells[0];},_TR:function(){return this.domNode.lastChild.firstChild.rows[0].cells[1];},_BL:function(){return this.domNode.lastChild.firstChild.rows[1].cells[0];},_BR:function(){return this.domNode.lastChild.firstChild.rows[1].cells[1].lastChild;},_T_ROW:function(){return this.domNode.lastChild.firstChild.rows[0];},_B_ROW:function(){return this.domNode.lastChild.firstChild.rows[1];},_BR_CELL:function(){return this.domNode.lastChild.firstChild.rows[1].cells[1];},_STATUS:function(){return this.domNode.lastChild.firstChild.rows[1].cells[1].firstChild;},_STATUS_TXT:function(){return this.domNode.lastChild.firstChild.rows[1].cells[1].firstChild.lastChild;},_STATUS_BAR:function(){return this.domNode.lastChild.firstChild.rows[1].cells[1].firstChild.firstChild.firstChild;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=(this.visible)?"block":"none";}},zones:null,lockHeadersCase:LOCK_BOTH,interactiveCellsArray:null,titlesCP:null,chsCP:null,rhsCP:null,valuesCP:null,onDemandIF:true,numRowFixed:false,heightLimit:0,height:0,widthLimit:0,width:0,useTouchScrolling:false,scrollInterval:0,selections:null,dataBlocks:null,gridInfo:null,getCellUnitIndex:function getCellUnitIndex(cell){return(cell.o!==undefined)?cell.o:cell._ei;},getCellTitleId:function getCellTitleId(cell){var rtn="";if(cell.axis&&cell.ui!==undefined){rtn=cell.axis+"A"+(cell.ui+1);}else{if(cell.mix!==undefined){rtn="0A"+cell.mix;}}return rtn;},update:function update(node){this.set("gridData",node.data[0]||node.data);var defn=this.defn||node.defn;this.sid=this.gridData.sid;this.treeType=(defn&&defn.tt)||1;this.interactiveCellsArray=[];this.gridInfo=node.data.gsi;},initCP:function initCP(gd,interactiveCellsArray,tp,base,lkpBase,ax,cp){var props={gridData:gd,type:tp,interactiveCellsArray:interactiveCellsArray};props.base=base||props.base;props.lookupBase=lkpBase||props.lookupBase;props.axis=ax||props.axis;if(!cp){if(tp===CP_TITLE){cp=new mstrmojo.XtabTitlesCP(props);}else{cp=new mstrmojo.XtabCP(props);}}else{mstrmojo.hash.copy(props,cp);}return cp;},preBuildRendering:function preBuildRendering(){var gd=this.gridData;this.lockHeadersCase=gd.lhv||LOCK_OFF;this.selections={};this.cssDefault=(this.lockHeadersCase===LOCK_OFF||!this.k)?"":"r-cssDefault"+(this.k?"_"+this.k:"");this.numRowFixed=!!(!this.height&&gd.rw&&gd.rw.row&&(gd.rw.row.bc<gd.rw.row.tc));this.rw=gd.rw;this._onDemandCP=null;if(this.width){this.widthLimit=parseInt(this.width,10);}if(this.height){this.heightLimit=parseInt(this.height,10);}return(this._super)?this._super():true;},renderEmptyGrid:function renderEmptyGrid(){var gd=this.gridData,msgNode=this.msgNode,viewport=this.viewport;msgNode.firstChild.innerHTML=gd.eg;msgNode.style.display="block";msgNode.style.overflow="hidden";msgNode.className="mstrmojo-message";viewport.style.display="none";return(this._super)?this._super():true;},postBuildRendering:function postBldRndr(){var gd=this.gridData,bInitZones=!!this._BR&&gd,msgNode=this.msgNode,viewport=this.viewport,rtn;if(gd.eg===undefined){if(msgNode.style.display==="block"){msgNode.style.display="none";viewport.style.display="block";}}else{return this.renderEmptyGrid();}if(!this.interactiveCellsArray){this.interactiveCellsArray=[];}if(bInitZones){this._setupZones(gd);this._setupCPs(gd);var zs=this.zones,n;for(n in zs){var z=zs[n];if(z.parent!==this){this.addChildren(this.zones[n]);}}if(this.scrollboxNode){var h=this.heightLimit;this.scrollboxHeightFixed=!isNaN(h)&&(h>0);if(this.scrollboxHeightFixed){this.scrollboxHeight=h;}this.scrollboxLeft=this.scrollboxTop=0;if(this.lockHeadersCase){this.connectScrollbox(this);}}}this.renderChildren();rtn=this._super();if(this.numRowFixed){if(!this.height){this.heightLimit=this.zones._BR.getPageHeight(0)+(this._TR?this._TR.offsetHeight:0);this.height=this.heightLimit+"px";}else{this.heightLimit=parseInt(this.height,10);}}if((this.lockHeadersCase&&bInitZones&&this.scrollboxNode)||this.numRowFixed){this.resizeScrollBox($D.isIE);}this.onGridWidthChanged(true);if($D.isIE7&&!this.scrollboxHeightFixed&&this.scrollboxNode&&this.scrollboxNode.scrollWidth>this.scrollboxNode.offsetWidth){this.scrollboxNode.style.height=this.scrollboxNode.offsetHeight+17+"px";}return rtn;},onclick:function onclick(e,hWin){if(!this.interactiveCellsArray.length){return ;}e=e.e||e;var $D=mstrmojo.dom,target=$D.eventTarget(hWin,e),clickedCell=target&&$D.findAncestorByName(target,"td",true,this.viewport);if(clickedCell){var a=$D.findAncestorByName(target,"span",true,clickedCell);if(a&&!$D.shiftKey(hWin,e)&&!$D.ctrlKey(hWin,e)){this.defaultAction(clickedCell);}else{this.doSelection(e,hWin,clickedCell);$D.clearBrowserHighlights();}}},ontouchend:function ontouchend(e,hWin){this.onclick(e,hWin);},onselectstart:function onselectstart(){return false;},onscroll:function onscroll(){this._alignHeaders();},resizeScrollBox:function resizeScrollBox(bForceRepaint){var sb=this.scrollboxNode,ss=sb&&sb.style,br=this._B_ROW,brc=this._BR_CELL;if(!ss||!br||!brc){return ;}var width=this.widthLimit,height=this.heightLimit;if(!width||!height){if(!width){ss.width="auto";}if(!height){ss.height="auto";this.scrollboxHeightFixed=false;}}if(height){var top=(this.zones._TR&&this.zones._TR.cp.rc)?br.offsetTop:0,newHeight=height-top;if(newHeight>0){ss.height=newHeight+"px";this.scrollboxHeight=newHeight;this.scrollboxHeightFixed=true;if((this.lockHeadersCase!==LOCK_OFF)&&this.numRowFixed){this.viewport.style.height=this.overlayNode.style.height=(newHeight+top)+"px";}}}if(!this.useTouchScrolling){var left=(this.zones._BL&&this.zones._BL.cp.rc)?brc.offsetLeft:0;var adjustSum=0;if(this.lockHeadersCase!==LOCK_OFF){var vp=this.viewport,cs=mstrmojo.css.getComputedStyle(vp),metrics=["paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"];if(cs){mstrmojo.array.forEach(metrics,function(v){adjustSum+=parseFloat(convertEmtoPx(vp,cs[v]));});}if(this.width){this.viewport.style.width=(parseFloat(this.width)-(adjustSum||0))+"px";}}var newWidth=(this.widthLimit&&(this.widthLimit-left))||(mstrmojo.dom.isIE7?brc.scrollWidth+1:(brc.scrollWidth+(sb.offsetWidth-sb.clientWidth)));if(newWidth&&(newWidth>0)){newWidth-=adjustSum;ss.width=newWidth+"px";}this._alignHeaders(bForceRepaint);}var finalHeight=ss.height,finalWidth=ss.width;if(finalHeight||finalWidth){var container=mstrmojo.findAncestor(this,"fixedSizeCanGrowShrink",null,mstrmojo.DocSection);if(container){container.fixedSizeCanGrowShrink(this,finalHeight,finalWidth);}}},_resizeScrollBoxWidth:function _resizeScrollBoxWidth(){var sb=this.scrollboxNode,ss=sb&&sb.style,br=this._B_ROW,brc=this._BR_CELL;if(this.useTouchScrolling||!ss||!br||!brc){return ;}var width=this.widthLimit;if(!width){ss.width="auto";}var fnUpdatetWidth=function(){var newWidth=(mstrmojo.dom.isIE7?brc.scrollWidth+1:(brc.scrollWidth+(sb.offsetWidth-sb.clientWidth)));if((newWidth&&(newWidth>0))&&(!width||(width&&(newWidth<width)))&&(sb.firstChild.firstChild.offsetWidth>=sb.clientWidth)){ss.width=newWidth+"px";}};if(mstrmojo.dom.isIE7){window.setTimeout(function(){fnUpdatetWidth();},1);}else{fnUpdatetWidth();}},onGridWidthChanged:function onGridWidthChange(noScrollBoxChange){if(this.lockHeadersCase===LOCK_OFF&&!noScrollBoxChange){this._resizeScrollBoxWidth();}var container=mstrmojo.findAncestor(this,"fixedSizeCanGrowShrink",null,mstrmojo.DocSection),widthLimit=this.widthLimit;if(!widthLimit){this.width=UNSET;if(container){container.performCanGrowCanShrink([this],true);}}else{if(container){container.fixedSizeCanGrowShrink(this,null,widthLimit);}}},getGridDimension:function getGridDimension(dimension){var DIM_HEIGHT=1,dim=dimension===DIM_HEIGHT?"Height":"Width",dimLC=dim.toLowerCase(),limit=this[dimLC+"Limit"];if(!limit&&(this[dimLC]===UNSET||this[dimLC]===0)){limit=this.viewport["offset"+dim];this[dimLC]=limit+"px";return limit;}return limit||parseInt(this[dimLC],10);},_alignHeaders:function syncHeaders(bForceRepaint){if(this.lockHeadersCase===LOCK_OFF||this.useTouchScrolling){return ;}var left=this.scrollboxLeft,top=this.scrollboxTop,zs=this.zones,trz=zs._TR,blz=zs._BL;function set(zone,prop,v){var el=zone&&zone.domNode,s=el&&el.style;if(!s){return ;}s[prop]=-v+"px";}if(trz&&trz.rc){set(trz,"left",left);}if(blz&&blz.rc){set(blz,"top",top);}if(bForceRepaint){repaint(this._BL);}},defaultAction:function defaultAction(td,tCell){var cell=tCell||this.getCellForNode(td),isReselectingTD=td&&td.className.indexOf("sc_")>0,action=this.model.getAction(this.getActionCells(cell),td,isReselectingTD),handler=action&&action.h;this._currentSelectedTD=td;if(handler&&this.controller[handler]){this.controller[handler](this,action.a);return true;}return false;},createZone:function createZone(cfg){return new mstrmojo.XtabZone(cfg||{});},_setupZones:function _setupZones(gd){var oldsz=this.zones;this.zones={};var zs=this.zones,l=this.lockHeadersCase,zIndex="z-index:";var me=this;function newz(rm,style,slot,oldsz){var zone=(oldsz&&oldsz[slot])||me.createZone({renderMode:rm,cssText:style,slot:slot});zs[slot]=zone;zone.rh=gd.rh;}newz(this.dataRenderMode,zIndex+"1;","_BR",oldsz);if(l&LOCK_ROW){newz(this.dataRenderMode,zIndex+"3;","_BL",oldsz);}if(l&LOCK_COL){newz(null,zIndex+"3;","_TR",oldsz);}if(l===LOCK_BOTH){newz(null,zIndex+"4;","_TL",oldsz);}if(l===LOCK_OFF){this.zones._BR.autoFitWindow=!!gd.afw;this.zones._BR.tableCssClass="r-cssDefault"+(this.k?"_"+this.k:"");}if(mstrmojo.dom.isIE7){if(l&LOCK_ROW||l&LOCK_COL||l===LOCK_BOTH){this._T_ROW.style.display="block";}else{if(l===LOCK_OFF){this._T_ROW.style.display="none";}}}var bz=zs._BL||zs._BR;if(bz){bz.numColumnCanMerge=gd.gts.cws.length-1;}},getHACP:function getHACP(){return(this._super&&this._super())||new mstrmojo.XtabHACP();},_setupCPs:function _setupCPs(gd){var titlesCP=this.titlesCP=this.getTitleCP(gd),chsCP=this.chsCP=this.getColumnHeadersCP(gd),rhsCP=this.rhsCP=this.getRowHeadersCP(gd),valuesCP=this.valuesCP=this.getValuesCP(gd);titlesCP.forceAutoRowHeight=chsCP.forceAutoRowHeight=gd.rh;var zs=this.zones;switch(this.lockHeadersCase){case LOCK_OFF:var vacp=new mstrmojo.XtabVACP();var hacpTop=this.getHACP();hacpTop.cps=[titlesCP,chsCP];vacp.cps=[hacpTop];var hacpBottom=this.getHACP();hacpBottom.cps=[rhsCP,valuesCP];vacp.cps.push(hacpBottom);zs._BR.cp=vacp;break;case LOCK_ROW:var acpLeft=new mstrmojo.XtabVACP();var acpRight=new mstrmojo.XtabVACP();acpLeft.cps=[titlesCP,rhsCP];acpRight.cps=[chsCP,valuesCP];zs._BL.cp=acpLeft;zs._BR.cp=acpRight;break;case LOCK_COL:var acpTop=this.getHACP();var acpBottom=this.getHACP();acpTop.cps=[titlesCP,chsCP];acpBottom.cps=[rhsCP,valuesCP];zs._TR.cp=acpTop;zs._BR.cp=acpBottom;break;case LOCK_BOTH:zs._TL.cp=titlesCP;zs._TR.cp=chsCP;zs._BL.cp=rhsCP;zs._BR.cp=valuesCP;break;}},ongridDataChange:function ongridDataChange(){var m=this.model;if(m){m.set("data",this.gridData);if(!this.dataBlocks){this.dataBlocks=[];}this.dataBlocks[0]=this.gridData;}},gridPagesRendered:mstrmojo.emptyFn,getTitleCP:function getTitleCP(gd){return this.initCP(gd,this.interactiveCellsArray,CP_TITLE);},getColumnHeadersCP:function getColumnHeadersCP(gd){return this.initCP(gd,this.interactiveCellsArray,CP_COL_HEADERS,gd.ghs.chs,gd.gts.col,COL_AXIS);},getRowHeadersCP:function getRowHeadersCP(gd){var rhsCP=this.initCP(gd,this.interactiveCellsArray,CP_ROW_HEADERS,gd.ghs.rhs,gd.gts.row,ROW_AXIS);if(this.onDemandIF&&this.rw){if(!this._onDemandCP){addOnDemandCPs.call(this,this.rw&&this.rw.row);}this.rhsCPList=[rhsCP].concat(this._onDemandCP.rhs);return onDemandCPAgg(this.rhsCPList)||rhsCP;}return rhsCP;},getValuesCP:function getValuesCP(gd){var valuesCP=this.initCP(gd,this.interactiveCellsArray,CP_VALUES,gd.gvs);if(this.onDemandIF&&this.rw){if(!this._onDemandCP){addOnDemandCPs.call(this,this.rw&&this.rw.row);}this.valuesCPList=[valuesCP].concat(this._onDemandCP.vls);return onDemandCPAgg(this.valuesCPList)||valuesCP;}return valuesCP;},createOnDemandCP:function createOnDemandCP(blockNum,rc,zone){var cp=new mstrmojo.XtabOnDemandCP();cp.dataSource=this;cp.blockNum=blockNum;cp.rc=rc;return cp;},dataDownloaded:function dataDownloaded(node,memo){var idx=memo.blockNum,rhsCP=this.rhsCPList[idx],valuesCP=this.valuesCPList[idx],gd=node.data;gd._bidx=idx;this.dataBlocks[idx]=gd;if(!rhsCP||!valuesCP){return ;}this.initCP(gd,this.interactiveCellsArray,CP_ROW_HEADERS,gd.ghs.rhs,gd.gts.row,ROW_AXIS,rhsCP);this.initCP(gd,this.interactiveCellsArray,CP_VALUES,gd.gvs,null,null,valuesCP);rhsCP.initContent();valuesCP.initContent();this.numRowsDownloaded+=parseInt(rhsCP.rc,10);this.updateStatus(mstrmojo.desc(8301,"Retrieving Data ..."),this.numRowsDownloaded*100/this.numRowsToDownload);var zs=this.zones,bl=zs&&zs._BL,br=zs&&zs._BR;if(bl){bl.dataDownloaded();}if(br){br.dataDownloaded();}},showDownloadStatus:function shwRndrSts(numRowsToDownload){if(!numRowsToDownload){return ;}if(this.showingStatus){this.numRowsToDownload+=numRowsToDownload;}else{this.numRowsToDownload=numRowsToDownload;this.numRowsDownloaded=0;}if(this.showStatus){this.showStatus(true,mstrmojo.desc(8301,"Retrieving Data ..."),this.numRowsDownloaded*100/this.numRowsToDownload);}},closeDownloadStatus:function closeSts(){this.numRowsToDownload=0;if(this.showStatus){this.showStatus(false);}},download:function download(blockNum){var rw=this.gridData.rw,rwRow=rw.row,rwCol=rw.col,maxRows=rwRow.bc;this.rhsCPList[blockNum].isDownloading=this.valuesCPList[blockNum].isDownloading=true;if(maxRows){this.controller.onDownloadGridData(this,this.model.getDownloadAction(blockNum*maxRows+1,maxRows,rwCol.bb,rwCol.bc,this.id,{blockNum:blockNum}));}},unrender:function unrender(ignoreDom){this.width=this.widthLimit=this.height=this.heightLimit=0;this.disconnectScrollbox(this);this._super(ignoreDom);},getCellForNode:function getCellForNode(td){var idx=td&&td.getAttribute("ei");if(isNaN(idx)){return null;}return this.interactiveCellsArray[parseInt(idx,10)];},getActionCells:function getActionCells(cell){var cells=[],selections=this.selections;var titleId=cell.axis+"A"+(cell.ui+1),selTitle=selections[titleId],i;if(selTitle&&selTitle[cell.o]){for(i in selTitle){var sc=this.getCellForNode(selTitle[i][0]);cells.push(sc);}}else{cells.push(cell);}return cells;},setModel:function setModel(model){this.model=model;if(model.data){this.set("gridData",model.data);}},destroy:function destroy(){var model=this.model;if(model&&model.destroy){model.destroy();}this._super();}});}());