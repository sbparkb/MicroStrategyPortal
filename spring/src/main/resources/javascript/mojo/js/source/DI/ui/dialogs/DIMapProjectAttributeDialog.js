(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.DI.DIConstants","mstrmojo.List","mstrmojo._HasLayout","mstrmojo.Label","mstrmojo.TextArea","mstrmojo.Widget","mstrmojo.ui.Pulldown","mstrmojo.DI.DISearchablePulldown");mstrmojo.requiresDescs(221,641,1825,5369,13037,13242,13243,13244,13606,13642,13853,13989,14202,14203,14462,14463,14464,14465,14466);var $ARR=mstrmojo.array,$DOM=mstrmojo.dom,$H=mstrmojo.hash,$STR=mstrmojo.string,constants=mstrmojo.DI.DIConstants;function getAttributeForms(data,callback){var attributeID=data.did,attributeName=data.n;var taskCallback={success:function(res){var forms=[],ois;function addForm(oi,caf,cafi,cafl,items){if($ARR.find(forms,"did",oi.did)<0){var form={did:oi.did,n:oi.n,name:oi.fdt.content,idf:oi.fdt.id_form===1,aid:attributeID,an:attributeName};if(caf){form.caf={did:caf.id,n:caf.n,name:caf.fdt.content,items:items};form.cafi=cafi;form.cafl=cafl;}forms.push(form);}}if(!res||!res.mi){return ;}ois=res.mi["in"].oi;if(ois){ois=[].concat(ois);$ARR.forEach(ois,function(oi){var items;if(oi.tp!==21){return ;}if(oi.fdt.bfi!==-1){addForm(oi);}else{items=oi.item===undefined?[]:[].concat(oi.item);$ARR.forEach(items,function(id,i){var idx=$ARR.find(ois,"did",id);if(idx>=0){addForm(ois[idx],oi,i,items.length,items);}});}});if(callback&&callback.success){callback.success({forms:forms});}}},failure:function(res){mstrApp.getRootController().displayError(mstrmojo.desc(641,"Please try again. If the problem persists, contact the server Administrator."),false,res.message);}};mstrApp.getRootController().getDataService().getProjectAttributeInfo(taskCallback,{id:attributeID});}function updateProjectAttributeForm(dialog,projectAttribute,forms){dialog.set("projectAttribute",projectAttribute);dialog.set("projectFormMaps",forms);}function formMapItemPopupListConfigFn(){var cfg=mstrmojo.ui.Pulldown.prototype.getPopupListConfig.call(this),cls=" mstrmojo-di-mapProjectAttribute-formMapItem-popupList";cfg.getItemMarkup=function(item,idx){return'<{@tag} class="item {@cls}" idx="{@idx}" style="{@style}" title="{@title}">{@n}</{@tag}>';};cfg.cssClass=cfg.cssClass||"";cfg.cssClass+=cls;return cfg;}function getCAFSelectNum(selections,dids){var items=[];var projectFormMaps=$ARR.map(selections,function(item){return item.projectFormMap;});$ARR.forEach(dids,function(id){var idx=$ARR.find(projectFormMaps,"did",id);if(idx>=0){if(selections[idx].formMap){items.push(selections[idx].formMap);}}});return items;}function findMappableTables(selections){var model=mstrApp.getRootController().getModel(),results=[],idForms=[];$ARR.forEach(selections,function(select){var formMap=select.formMap,projectFormMap=select.projectFormMap,idx;if(!formMap||!projectFormMap){return ;}if(projectFormMap.idf){idx=$ARR.find(idForms,"did",formMap.did);if(idx<0){idForms.push(formMap.data);}}});$ARR.forEach(selections,function(select){var formMap=select.formMap,projectFormMap=select.projectFormMap,sources;if(!formMap||!projectFormMap){return ;}sources=model.findMappingSource(formMap.data);$ARR.forEach(sources,function(source){var add=true,idx;$ARR.forEach(idForms,function(form){var rets=model.findMappingItem(form,source.tableID);if(!rets||rets.length===0){add=false;return false;}});if(add){idx=$ARR.indexOf(results,source.tableID);if(idx<0){results.push(source.tableID);}}});});return results;}mstrmojo.DI.ui.dialogs.DIMapProjectAttributeDialog=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.ui.dialogs.DIMapProjectAttributeDialog",cssClass:"mstrmojo-di-mapProjectAttribute-dialog",title:mstrmojo.desc(13037,"Map to Project Attribute"),blockCount:50,found:false,attributes:null,formMapOptions:null,formMaps:null,projectAttribute:null,projectFormMaps:null,selections:null,help:"About_mapping_imported_data.htm",buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(5369,"Submit"),alias:"submit",enabled:false,onclick:function(){var editor=this.parent.parent;editor.updateMapping();editor.close();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var editor=this.parent.parent;editor.close();}}],children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-di-mapProjectAttribute-dialog-content",alias:"content",markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" style="{@cssText}"><div class="content-box top cf"></div><div class="content-box bottom cf"><div class="content-bottom-box left"></div><div class="content-bottom-box right"></div></div></div>',markupSlots:{containerNode:function(){return this.domNode;},topNode:function(){return this.domNode.children[0];},bottomNode:function(){return this.domNode.children[1];},bottomLeftNode:function(){return this.domNode.children[1].children[0];},bottomRightNode:function(){return this.domNode.children[1].children[1];}},children:[{slot:"topNode",alias:"searchPulldown",scriptClass:"mstrmojo.DI.DISearchablePulldown",cssClass:"mstrmojo-di-mapProjectAttribute-searchPulldown",blockCount:50,value:mstrmojo.desc(14203,"Type attribute name and press 'Enter' to search"),items:[],onitemSelected:function(item){var me=this;var callback={success:function(res){var proAttributeWidget=me.parent.parent;me.set("isEditing",false);updateProjectAttributeForm(proAttributeWidget,item,res.forms);}};getAttributeForms(this.getSelectedItem(),callback);}},{slot:"topNode",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton mstrmojo-di-mapProjectAttribute-browseButton",text:mstrmojo.desc(1825,"Browse"),onclick:function(){var me=this;var cfg={OKFn:function(item){var callback={success:function(res){var proAttributeWidget=me.parent.parent;updateProjectAttributeForm(proAttributeWidget,item,res.forms);proAttributeWidget.content.searchPulldown.set("items",[item]);proAttributeWidget.content.searchPulldown.set("selectedIndex",0);}};getAttributeForms(item,callback);},oTypes:[12]};mstrApp.getRootController().showDialog(constants.dialogType.objectPicker,cfg);}},{slot:"bottomLeftNode",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-mapProjectAttribute-label left",text:mstrmojo.desc(13242,"Imported Attribute")},{slot:"bottomLeftNode",scriptClass:"mstrmojo.WidgetList",alias:"formMapsList",cssClass:"mstrmojo-di-mapProjectAttribute-formMapsList",renderOnScroll:false,onitemsChange:function(){var me=this;if(!!navigator.userAgent.match(/Edge/)){window.setTimeout(function(){me.refresh();},0);}},itemFunction:function ifn(item,idx,w){var dialog=w.parent.parent,formMapOptions=dialog.formMapOptions,selectedIndex=-1,cls=["mstrmojo-di-mapProjectAttribute-formMapItem"];var none={n:"---",did:-1};var cfg={scriptClass:"mstrmojo.ui.Pulldown",getPopupListConfig:formMapItemPopupListConfigFn,isHostedWithin:false,data:item,enabled:item.enabled,value:item.enabled?mstrmojo.desc(14462,"Select attribute"):"---",parent:w};if(item.projectFormMap){if(item.projectFormMap.caf){cls.push("caf");}if(item.projectFormMap.cafi===0){cls.push("cafb");}if(item.projectFormMap.cafi===item.projectFormMap.cafl-1){cls.push("cafe");}}if(!item.projectFormMap||!item.projectFormMap.idf){formMapOptions=[none].concat($H.clone(formMapOptions));}else{formMapOptions=$H.clone(formMapOptions);}if(item.formMap&&item.enabled){selectedIndex=$ARR.find(formMapOptions,"did",item.formMap.did);if(selectedIndex<0){cfg.data.formMap=null;}}cfg.cssClass=cls.join(" ");return mstrmojo.ui.Pulldown.newPulldown(formMapOptions,function(newItem){this.data.formMap=newItem.did!==-1?newItem:null;this.parent.parent.parent.validateForms();},selectedIndex,cfg);}},{slot:"bottomRightNode",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-mapProjectAttribute-label right",text:mstrmojo.desc(14463,"Project Attribute: "),postBuildRendering:function(){var dialog=this.parent.parent;dialog.attachEventListener("projectAttributeChange",this.id,"update");},update:function(){var dialog=this.parent.parent;if(dialog.projectAttribute){this.set("text",mstrmojo.desc(14463,"Project Attribute: ")+dialog.projectAttribute.n);this.set("title",dialog.projectAttribute.n);}}},{slot:"bottomRightNode",alias:"projectFormMapsPlaceholder",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-mapProjectAttribute-placeholder",text:mstrmojo.desc(13244,"Search or browse Attribute above")},{slot:"bottomRightNode",scriptClass:"mstrmojo.WidgetList",alias:"projFormMapsList",cssClass:"mstrmojo-di-mapProjectAttribute-formMapsList",visible:false,renderOnScroll:false,onitemsChange:function(){var me=this;var v=this.items&&this.items.length;this.set("visible",v);this.parent.projectFormMapsPlaceholder.set("visible",!v);if(!!navigator.userAgent.match(/Edge/)){window.setTimeout(function(){me.refresh();},0);}},itemFunction:function ifn(item,idx,w){var cls=["mstrmojo-di-mapProjectAttribute-formMapItem","proj"];var cfg={parent:w,scriptClass:"mstrmojo.Box",markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" style="{@cssText}" tooltip="{@tooltip}"><div class="proj-item-text"><span class="icon"></span><span class="text">{@text}</span></div></div>',text:$STR.encodeHtmlString(item.name)};if(item.caf){cls.push("caf");if(item.cafi===0){cls.push("cafb");}if(item.cafi===item.cafl-1){cls.push("cafe");}cfg.tooltip=mstrmojo.desc(14464,"Compound Attribute");cfg.text=$STR.encodeHtmlString(item.caf.name)+"@"+$STR.encodeHtmlString(item.name);}cfg.cssClass=cls.join(" ");return new mstrmojo.Box(cfg);}}]}],showTooltip:function showTooltip(e,win){var me=this,t=$DOM.findAncestorByAttr($DOM.eventTarget(win,e),"tooltip",true,this.domNode),content=t&&t.value;if(content&&$DOM.contains(me.containerNode,t.node)){if(!me.hasOpenTooltip&&content){var position=$DOM.position(t.node);me.richTooltip={cssClass:"vi-regular vi-tooltip-C",content:content,top:Math.max(position.y+position.h+4,0),left:Math.max(position.x+position.w+8,0),posType:mstrmojo.tooltip.POS_BOTTOMLEFT};mstrmojo._HasTooltip.showTooltip.call(me,e,win);}}else{this._super(e,win);}},onOpen:function onOpen(){var model=mstrApp.getRootController().getModel(),me=this,attributes=me.attributes,tableId=me.tableId,formMaps=[],mfaCnt=0,maps;$ARR.forEach(attributes,function(map){var item,n='<span class="icon"></span><span class="text">'+mstrmojo.string.encodeHtmlString(map.alias)+"</span>",ipan='<span class="icon"></span><span class="text ipa">'+mstrmojo.string.encodeHtmlString(map.alias)+"</span>";if(!map.isMultiForm){item={n:map.ipa?ipan:n,alias:map.alias,did:map.did,oid:map.oid,id:map.id,tableId:map.tableId,isMultiForm:map.isMultiForm,ipa:map.ipa,aid:map.id,data:map};formMaps.push(item);}else{if(mfaCnt===0){$ARR.forEach(map.subColumns,function(col){item={did:col.did,oid:col.oid,id:col.id,tableId:map.tableId,isMultiForm:true,aid:map.id,data:map};if(map.ipa){item.n='<span class="icon form"></span><span class="text ipa">'+$STR.encodeHtmlString(map.alias)+"@"+$STR.encodeHtmlString(col.alias)+"</span>";}else{item.n='<span class="icon form"></span><span class="text ipa">'+$STR.encodeHtmlString(map.alias)+"@"+$STR.encodeHtmlString(col.alias)+"</span>";}formMaps.push(item);});mfaCnt++;}}});this.set("formMaps",formMaps);maps=[];$ARR.forEach(model.getImportSource(tableId).getCurrentMappings(function(map){return map.tp===12;}),function(map){var item,idx,n='<span class="icon"></span><span class="text">'+$STR.encodeHtmlString(map.alias)+"</span>",ipan='<span class="icon"></span><span class="text ipa">'+$STR.encodeHtmlString(map.alias)+"</span>";if(!map.isMultiForm){if(map.ipa!==1){item={n:map.ipa?ipan:n,alias:map.alias,did:map.did,oid:map.oid,id:map.id,tableId:map.tableId,isMultiForm:map.isMultiForm,ipa:map.ipa,aid:map.id,data:map};maps.push(item);}}else{idx=-1;if(idx>=0){$ARR.forEach(map.subColumns,function(col){item={did:col.did,oid:col.oid,id:col.id,tableId:map.tableId,isMultiForm:true,aid:map.id,data:map};if(map.ipa){item.n='<span class="icon form"></span><span class="text ipa">'+$STR.encodeHtmlString(map.alias)+"@"+$STR.encodeHtmlString(col.alias)+"</span>";}else{item.n='<span class="icon form"></span><span class="text">'+$STR.encodeHtmlString(map.alias)+"@"+$STR.encodeHtmlString(col.alias)+"</span>";}maps.push(item);});}}});this.set("formMapOptions",maps);this.set("projectFormMaps",[]);},onprojectFormMapsChange:function(){var formMaps=this.formMaps||[],projectFormMaps=this.projectFormMaps||[],len=Math.max(formMaps.length,projectFormMaps.length),items=[],item,i;this.content.projFormMapsList.set("items",projectFormMaps);for(i=0;i<len;i++){if(i<formMaps.length&&i<projectFormMaps.length){item={formMap:formMaps[i],projectFormMap:projectFormMaps[i],enabled:true};}else{if(i<formMaps.length){item={formMap:formMaps[i],projectFormMap:null,enabled:projectFormMaps.length===0};}else{item={formMap:null,projectFormMap:projectFormMaps[i],enabled:true};}}items.push(item);}this.set("selections",items);},onselectionsChange:function(){this.content.formMapsList.set("items",this.selections);this.validateForms();},updateMapping:function(){var controller=mstrApp.getRootController(),model=controller.getModel(),selections=this.selections,tables;if(!this.checkUpdateMapping()){return ;}tables=findMappableTables(selections);$ARR.forEach(selections,function(select){var formMap=select.formMap,projectFormMap=select.projectFormMap,cols;if(!formMap||!projectFormMap){return ;}if(!formMap.isMultiForm){cols=model.findMappingItem(formMap.data);$ARR.forEach(cols,function(col){if($ARR.indexOf(tables,col.tableId)>=0){col.ipa=1;col.tp=12;col.nochange=true;col.oid=projectFormMap.aid;col.fmid=projectFormMap.did;}});}else{cols=model.findMappingItem(formMap.data);$ARR.forEach(cols,function(col){if($ARR.indexOf(tables,col.tableId)>=0){$ARR.forEach(col.subColumns,function(subCol){if(subCol.did===formMap.did){col.ipa=1;col.tp=12;col.nochange=true;subCol.ipa=1;subCol.oid=projectFormMap.aid;subCol.fmid=projectFormMap.did;}});}});}});controller.changeEMMAMappings();},checkUpdateMapping:function(){var me=this,canSubmit=true,controller=mstrApp.getRootController(),model=controller.getModel(),selections=this.selections,projAttrName=me.projectAttribute.n,formMaps=[],msg;$ARR.forEach(selections,function(selection){var formMap=selection.formMap,projectFormMap=selection.projectFormMap;if(!formMap||!projectFormMap){return ;}formMaps.push(formMap);});if(canSubmit){$ARR.forEach(selections,function(selection){var formMap=selection.formMap,projectFormMap=selection.projectFormMap,cols;if(!formMap||!projectFormMap){return ;}if(!canSubmit){return false;}if(projectFormMap.idf){cols=model.findMappingItem(formMap.data);$ARR.forEach(cols,function(col){var tableId=col.tableId,maps,idx;maps=model.getImportSource(tableId).getCurrentMappings(function(map){return map.tp===12;});idx=$ARR.find(maps,"alias",projAttrName);if(idx>=0&&$ARR.find(formMaps,"id",maps[idx].id)<0){canSubmit=false;msg=mstrmojo.desc(13853,"The Attribute ## cannot be mapped to the Project Attribute ### since there is already an Attribute with the same name as the Project Attribute within the current dataset. Please rename the Attribute ### in the current dataset to something else.");msg=msg.replace(/###/g,projAttrName).replace("##",$STR.encodeHtmlString(formMap.data.alias));return false;}});}});}if(!canSubmit&&msg){controller.displayError(msg);}return canSubmit;},validateForms:function validateForms(){var selections=this.selections,valid=true,tooltip="",dids=[],cnt;if(!this.projectFormMaps||!this.projectFormMaps.length){valid=false;tooltip=mstrmojo.desc(13244,"Search or browse Attribute above");}if(valid){cnt=0;$ARR.forEach(selections,function(select){if(select.formMap&&select.projectFormMap){cnt++;if($ARR.indexOf(dids,select.formMap.did)<0){dids.push(select.formMap.did);}}});if(cnt===0){valid=false;tooltip=mstrmojo.desc(13244,"Search or browse Attribute above");}else{if(dids.length!==cnt){valid=false;tooltip=mstrmojo.desc(14465,"Cannot map two attributes to same form");}}}if(valid){$ARR.forEach(selections,function(select){var projectFormMap=select.projectFormMap,formMap=select.formMap,cafForms,len;if(projectFormMap){if(projectFormMap.idf&&!formMap){valid=false;return false;}if(projectFormMap.caf&&projectFormMap.caf.items){cafForms=getCAFSelectNum(selections,projectFormMap.caf.items);len=cafForms.length;if(len!==0&&len!==projectFormMap.caf.items.length){valid=false;tooltip=mstrmojo.desc(14466,"Compound attribute forms need to be mapped together");return false;}}}});}this.setSubmitBtn(valid,tooltip);},setSubmitBtn:function setSubmitBtn(enabled,tooltip){var submitButton=this.btnHbox.submit;submitButton.set("enabled",enabled);submitButton.textNode.setAttribute("tooltip",tooltip);},onClose:function(){var me=this;window.setTimeout(function(){me.destroy();},0);}});}());