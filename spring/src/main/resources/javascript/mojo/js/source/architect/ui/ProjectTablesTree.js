(function(){mstrmojo.requiresCls("mstrmojo.warehouse.ui.TablesTree","mstrmojo.architect.menu.ProjectTableMenu","mstrmojo.architect.EnumDataChangeEvents","mstrmojo.architect.EnumDragActions","mstrmojo.warehouse.EnumObjectTypes","mstrmojo.architect.ui._HasTreeDropZone","mstrmojo.array","mstrmojo.css","mstrmojo.string","mstrmojo.func");var $A=mstrmojo.array,$CSS=mstrmojo.css,$STR=mstrmojo.string,CSS_BOLD_CLASS="bld",$PROJECT_TABLE_TREE,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,EVENT_TABLES_CHANGED=$ENUM_DATA_CHANGE_EVENTS.TABLES_CHANGED,EVENT_RENAME=$ENUM_DATA_CHANGE_EVENTS.RENAME,EVENT_REMOVE=$ENUM_DATA_CHANGE_EVENTS.REMOVE,$ENUM_DRAG_ACTIONS=mstrmojo.architect.EnumDragActions,DRAG_ACTION_ADD_TABLE=$ENUM_DRAG_ACTIONS.ADD_TABLE,DRAG_ACTION_TABLE_ATTR=$ENUM_DRAG_ACTIONS.TABLE_VIEW_ATTR,DRAG_ACTION_TABLE_METRIC=$ENUM_DRAG_ACTIONS.TABLE_VIEW_METRIC,DRAG_ACTION_TABLE_COLUMN=$ENUM_DRAG_ACTIONS.PROJECT_TABLE_COLUMN,DRAG_ACTION_COMPOUND_FORM=$ENUM_DRAG_ACTIONS.COMPOUND_FORM,$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,ENUM_OT_TABLE=$ENUM_OT.TABLE,$ENUM_VIEW_TYPES=mstrmojo.architect.ui.EnumViewTypes,$WRAP=mstrmojo.func.wrapMethods,ITEM_ID="did",ITEM_TYPE="tp",ITEM_TAG="li",INDEX_ATTR="idx";function replaceItems(items){this.userSelections={};this.expandedIndices={};this.selectedIndices={};this.expandedIndices["0"]=true;this.set("items",items);}function forEachItemNode(fn){if(this.hasRendered){var treeNodes=this.domNode.getElementsByTagName(ITEM_TAG);$A.forEach(treeNodes,fn,this);}}function onTablesAdded(){this.parent.clearSearch(true);}function onTablesChanged(evt){var eventName=evt.name,itemId=evt.did||evt.item.did,updateIndex,updateItem;$A.forEach(this.getItemWithPropName(this.items,ITEM_ID,itemId),function(item){var itemIdx=item._renderIdx;if(eventName===EVENT_REMOVE){var indices={};indices[itemIdx]=true;this.clearUserSelections(indices);this.removeChild(itemIdx);if(item.tp===ENUM_OT_TABLE){var parentIndex=itemIdx.split(":")[0],parentItem=this.getTreeItem(parentIndex);if(parentItem.items.length===0){this.removeChild(parentIndex);}}}else{var newItem=evt.item,isTableChangedEvent=eventName===EVENT_TABLES_CHANGED;if(eventName===EVENT_RENAME){item.n=evt.value;}else{if(isTableChangedEvent){updateItem=newItem;item.multi=newItem.multi;}}this.updateChild(updateIndex||itemIdx,updateItem||item);}},this);this.refresh();}function onTablesSelected(evt){var items=this.items;if(!items||!items.length){return ;}var indices={};$A.forEach(evt.tableItems,function(tableData){$A.forEach(this.getItemWithPropName(items,ITEM_ID,tableData.did),function(treeItem){indices[treeItem._renderIdx]=true;});},this);this.clearUserSelections(indices);forEachItemNode.call(this,function(treeNode){var index=treeNode.getAttribute(INDEX_ATTR);if(indices[index]===true){$CSS.toggleClass(treeNode.firstChild,CSS_BOLD_CLASS,!!evt.toAdd);}});}function onLayerChanged(){var treeItems=this.items,items=this.searchMode?treeItems.concat(treeItems[0].items):treeItems;$A.forEach(items,function(dsnItem){$A.forEach(dsnItem.items,function(tableItem){if(tableItem.bold){delete tableItem.bold;this.updateChild(tableItem._renderIdx,tableItem);}},this);},this);}mstrmojo.architect.ui.ProjectTablesTree=mstrmojo.declare(mstrmojo.warehouse.ui.TablesTree,[mstrmojo.architect.ui._HasTreeDropZone],{scriptClass:"mstrmojo.architect.ui.ProjectTablesTree",cssClass:"mstrmojo-ar-ProjectsTablesTree",tablesTreeHooks:{addItem:function(el,item){var rootController=mstrApp.getRootController(),model=rootController.model;if(model.currentView===$ENUM_VIEW_TYPES.LAYER){rootController.addOrRemoveTables([].concat(item),true);}}},init:function init(props){this._super(props);this.items=this.items||[];var $this=this,evtConfig={},projectTreeConfig=evtConfig[this.id]={},rootController=mstrApp.getRootController();projectTreeConfig[$ENUM_DATA_CHANGE_EVENTS.TABLES_LOADED]=function tablesLoaded(evt){replaceItems.call($this,evt.items);};projectTreeConfig[$ENUM_DATA_CHANGE_EVENTS.TABLES_ADDED]=onTablesAdded;projectTreeConfig[EVENT_TABLES_CHANGED]=projectTreeConfig[EVENT_RENAME]=projectTreeConfig[EVENT_REMOVE]=onTablesChanged;projectTreeConfig[$ENUM_DATA_CHANGE_EVENTS.TABLES_SELECTED]=onTablesSelected;projectTreeConfig[$ENUM_DATA_CHANGE_EVENTS.LAYER_CHANGE]=onLayerChanged;rootController.attachDataChangeListeners(evtConfig);this.dataHelper={fetch:function fetch(item,callback){if(item.isSearch){rootController.loadSearchObjectContents(item,callback);}else{rootController.loadTableContents(item,$WRAP({success:function success(evt){evt.items=$this.getItemWithPropName(evt.items.items,ITEM_ID,item.did)[0].items;}},callback));}}};if(this.itemRenderer){this.itemRenderer.render=function(item,level,idx,widget){var preIdx=item._renderIdx;if($this.userSelections&&$this.userSelections[preIdx]!==undefined){$this.userSelections[idx]=$this.userSelections[preIdx];delete $this.userSelections[preIdx];}item._renderIdx=idx;item._renderLvl=level;return $STR.apply(widget.getItemMarkup(item,level,idx),widget.getItemProps(item,level,idx));};}},getItemProps:function getItemProps(item,level,index){var tp=item.icntp||item.tp,cssClasses=["item",(tp?("tp"+tp):""),(item.multi?"mso":""),(item.bold?CSS_BOLD_CLASS:""),(item.isError?"err":""),(item.unused?"uc":"")];return{tag:"div",cls:cssClasses.join(" "),n:$STR.encodeHtmlString(item.n||""),idx:index,ttp:$STR.encodeXMLAttribute(item.ttp||"")};},showMenu:function showMenu(itemInfo){var $this=this,menuHelper=this.getMenuHelper(),MENU_CONTEXT_LAYER=1,objId=itemInfo.data[ITEM_ID],objType=itemInfo.data[ITEM_TYPE],rootController=mstrApp.getRootController(),tableData,tableDataArray,items,callback={success:function(res){items=res.items;if(items){tableDataArray=items.items;if(tableDataArray&&tableDataArray.length===1){tableData=tableDataArray[0];itemInfo.data.size=tableData.size;itemInfo.data.isLocked=tableData.isLocked;}}}};rootController.setTableMenuContext(MENU_CONTEXT_LAYER);if(objType===$ENUM_OT.TABLE){rootController.populateTableContents(objId,callback);}menuHelper.target=$this;menuHelper.data=itemInfo.data;var cfg=menuHelper.getMenuConfig();cfg.hostId=$this.id;cfg.hostElement=itemInfo.menuNode;cfg.isHostedWithin=false;cfg.hostProxyCssClass="item-mn-proxy";$this.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));},getMenuHelper:function getMenuHelper(){$PROJECT_TABLE_TREE.menuHelper=$PROJECT_TABLE_TREE.menuHelper||new mstrmojo.architect.menu.ProjectTableMenu();return $PROJECT_TABLE_TREE.menuHelper;},getDragAction:function getDragAction(context){var nodeAttributes=this.getNodeAttributes(context.src.node),nodeData=nodeAttributes&&this.getTreeItem(nodeAttributes.index),nodeType=nodeData&&nodeData.tp,searchMode=this.searchMode;switch(nodeType){case ENUM_OT_TABLE:return $ENUM_DRAG_ACTIONS.PROJECT_TABLE;case $ENUM_OT.ATTRIBUTE:return !searchMode&&DRAG_ACTION_TABLE_ATTR;case $ENUM_OT.COLUMN:return !searchMode&&DRAG_ACTION_TABLE_COLUMN;case $ENUM_OT.FACT:return !searchMode&&DRAG_ACTION_TABLE_METRIC;case $ENUM_OT.FORM:return !searchMode&&DRAG_ACTION_COMPOUND_FORM;}},allowDrop:function allowDrop(context){return[DRAG_ACTION_ADD_TABLE,DRAG_ACTION_TABLE_ATTR,DRAG_ACTION_TABLE_METRIC,DRAG_ACTION_TABLE_COLUMN,DRAG_ACTION_COMPOUND_FORM].indexOf(context.action)!==-1;},ondrop:function ondrop(context){var dragAction=context.action,dragData=context.src.data,rootController=mstrApp.getRootController(),scrAttId,tgtAttId,tgtData,nodeAttributes=this.getNodeAttributes(context.tgt.node);if(dragData){if(dragAction===DRAG_ACTION_ADD_TABLE){rootController.addTables(dragData);}else{if(dragAction===DRAG_ACTION_COMPOUND_FORM){tgtData=this.getTreeItem(nodeAttributes.index);scrAttId=dragData.tp===21?dragData.sid:dragData.did;tgtAttId=tgtData.tp===21?tgtData.sid:tgtData.did;if(tgtAttId===scrAttId){if(dragData.bfIdx!==tgtData.bfIdx){rootController.groupForms([dragData],tgtData);}}}else{if([DRAG_ACTION_TABLE_COLUMN,DRAG_ACTION_TABLE_ATTR,DRAG_ACTION_TABLE_METRIC].indexOf(context.action)!==-1){rootController.addTableInfo(dragData,this.getTreeItem(nodeAttributes.index));}}}}if(this._super){this._super(context);}}});$PROJECT_TABLE_TREE=mstrmojo.architect.ui.ProjectTablesTree;}());