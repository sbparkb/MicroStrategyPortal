(function(){mstrmojo.requiresCls("mstrmojo.string","mstrmojo.dom","mstrmojo.array","mstrmojo.css","mstrmojo.hash","mstrmojo.num","mstrmojo.gm.GMEnums","mstrmojo.gm.GMUtility","mstrmojo.VisEnum","mstrmojo.VisUtility","mstrmojo.VisTooltip","mstrmojo.vi.models.EnumDragSources","mstrmojo.vi.models.DropZonesModel","mstrmojo.gm.DndReplaceNode","mstrmojo.gm.DndTooltip","mstrmojo.vi.ui._CanDropFromSchema","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.ui.menus.PopupConfig","mstrmojo.ui.editors.controls.AdvancedColorPicker","mstrmojo.vi.ui.rw._HasVisSelections","mstrmojo.color");mstrmojo.requiresClsP("mstrmojo.ui.menus","MenuConfig","EditorConfig","ToolbarEditorConfig");mstrmojo.requiresClsP("mstrmojo.ui.editors.controls","LineConfigGroup","FillConfigGroup","ColorPickerButton","MarkerColorPickerButton","CharacterGroup");var $MOJO=mstrmojo,$VISUTIL=$MOJO.VisUtility,$ACP=mstrmojo.ui.editors.controls.AdvancedColorPicker,$VI=$MOJO.vi,$S=$MOJO.string,$DOM=$MOJO.dom,$NUM=$MOJO.num,$ARR=$MOJO.array,$CSS=$MOJO.css,$HASH=$MOJO.hash,$COLOR=$MOJO.color,$DTP=mstrmojo.expr.DTP,SHAPE_TYPE=$MOJO.gm.EnumShape,CHART_TYPE=$MOJO.gm.EnumGraphType,CTRL_TYPE=$MOJO.VisEnum.ControlType,SEL_TYPE=$VI.ui.rw.SelectionType,$DU=$VI.ui.DatasetUnitMenuUtils,$GM=$MOJO.gm,GMUTIL=$GM.GMUtility,$ENUM_XML_TAG=$GM.WidgetPropertyTag,$ENUM_FORMAT_TAG=$GM.FormatingPropertyTag,$FORMAT_MODEL=$MOJO.models.FormatModel,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$ENUM_FONT_STYLE_VALUE=mstrmojo.chart.enums.EnumFontStyle,$ENUM_ABL_DIRECTION=$GM.EnumABLDirection,ENUM_SOURCE=$VI.models.EnumDragSources,ENUM_TARGET=$VI.models.DropZonesModel.ENUM_TARGET_POSITION,ENUM_DZID=$MOJO.vi.viz.EnumDSSDropZones,IDEN_TYPE=$GM.EnumIdentityType,TARGET_ABOVE=ENUM_TARGET.ABOVE,TARGET_ON=ENUM_TARGET.ON,TARGET_BELOW=ENUM_TARGET.BELOW,TARGET_MIDDLE=3,INVALID_METRIC_IDX=-20,ADD_HIGHLIGHT_WIDTH=14,ADD_HIGHLIGHT_HALF_WIDTH=7,ADD_POS_INDICATOR_HALF_WIDTH=6,ADD_POS_INDICATOR_HALF_HEIGHT=8,CANVAS_ADJUST=0,WHOLE_BOX=1,WHOLE_ZONE=2,VAL_CLEAR="default",CTRL_TYPE_HEADER_TITLE="hdtl",SHAPE_STAT={NORMAL:"normal",HOVER:"hover",SELECTED:"selected",SH:"sh"},SHAPE_STAT_TRANS={INVALID:-1,NORMAL2HOVER:0,NORMAL2SELECTED:1,HOVER2NORMAL:2,HOVER2SELECTED:3,SELECTED2NORMAL:4,SELECTED2HOVER:5,SH2SELECTED:6,SELECTED2SH:7,SH2NORMAL:8},STAT_MAP={"normal-hover":SHAPE_STAT_TRANS.NORMAL2HOVER,"normal-selected":SHAPE_STAT_TRANS.NORMAL2SELECTED,"hover-normal":SHAPE_STAT_TRANS.HOVER2NORMAL,"hover-selected":SHAPE_STAT_TRANS.HOVER2SELECTED,"selected-normal":SHAPE_STAT_TRANS.SELECTED2NORMAL,"selected-hover":SHAPE_STAT_TRANS.SELECTED2HOVER,"sh-selected":SHAPE_STAT_TRANS.SH2SELECTED,"selected-sh":SHAPE_STAT_TRANS.SELECTED2SH,"sh-normal":SHAPE_STAT_TRANS.SH2NORMAL},SHAPE_SUBTYPE={BAR:"bar",SBAR:"sbar",GBAR:"gbar",CIRCLE:"circle",SCIRCLE:"scircle",TICKER:"ticker",SQUARE:"square",PIE:"pie",RING:"ring"},EnumControlScope={GLOBAL:"glb",FORMATTING:"fmt"},EnumFormatPropSubName={FONT_COMP:"FntCmp",FONT_FAMILY:"FntFml",FONT_STYLE:"FntStyle",FONT_SIZE:"FntSz",FONT_COLOR:"FntClr",LINE_COMP:"LnCmp",SHOW:"Shw",COLOR:"Clr",STYLE:"Style",THICKNESS:"Thk"},ENUM_FMT_STATUS={NORMAL:0,PER_COLORBY:1,PER_SHAPE:2},TOOLTIP_WIN,REF_TYPE_DESCS=["Reserved",mstrmojo.desc(2125,"Maximum"),mstrmojo.desc(2127,"Minimum"),mstrmojo.desc(2122,"Average"),mstrmojo.desc(2126,"Median"),mstrmojo.desc(4046,"First"),mstrmojo.desc(4049,"Last"),mstrmojo.desc(7194,"Constant")];var IDENTITY_TYPE_TO_CTRL_TYPE_MAP={};IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.H_MATRIX_LINE]=[CTRL_TYPE.GM_H_MATRIX_LINE,CTRL_TYPE.GM_H_CHART_LINE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.V_MATRIX_LINE]=[CTRL_TYPE.GM_V_MATRIX_LINE,CTRL_TYPE.GM_V_CHART_LINE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.GRID_LINE]=[CTRL_TYPE.GM_H_GRID_LINE,CTRL_TYPE.GM_V_GRID_LINE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.MINOR_GRID_LINE]=[CTRL_TYPE.GM_H_MINOR_GRID_LINE,CTRL_TYPE.GM_V_MINOR_GRID_LINE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.ROW_TITLE]=[CTRL_TYPE.GM_ROW_HEADER_TITLE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.ROW_HEADER]=[CTRL_TYPE.GM_ROW_HEADER,CTRL_TYPE.GM_ROW_HEADER_EXTRA];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.COL_TITLE]=[CTRL_TYPE.GM_COL_HEADER_TITLE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.COL_HEADER]=[CTRL_TYPE.GM_COL_HEADER,CTRL_TYPE.GM_COL_HEADER_EXTRA];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.ROWS_BACKGROUND]=[];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.COLS_BACKGROUND]=[];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.X_AXIS]=[CTRL_TYPE.GM_XAXIS_LINE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.Y_AXIS]=[CTRL_TYPE.GM_YAXIS_LINE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.X2_AXIS]=[CTRL_TYPE.GM_XAXIS2_LINE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.Y2_AXIS]=[CTRL_TYPE.GM_YAXIS2_LINE];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.X_METRIC_AXIS_TITLE]=[CTRL_TYPE.GM_XLABEL];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.Y_METRIC_AXIS_TITLE]=[CTRL_TYPE.GM_YLABEL];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.X_NUMERIC]=[CTRL_TYPE.GM_X_NUMERIC];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.X_CATEGORY]=[CTRL_TYPE.GM_X_CATEGORY];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.Y_NUMERIC]=[CTRL_TYPE.GM_Y_NUMERIC];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.Y_CATEGORY]=[CTRL_TYPE.GM_Y_CATEGORY];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.X_AXIS_ORIGIN_LABEL]=[CTRL_TYPE.GM_ORIGIN_LABEL_V];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.Y_AXIS_ORIGIN_LABEL]=[CTRL_TYPE.GM_ORIGIN_LABEL_H];IDENTITY_TYPE_TO_CTRL_TYPE_MAP[IDEN_TYPE.AXIS_ORIGIN]=[CTRL_TYPE.GM_ORIGIN_LINE];var HEADER_TITLE_SELECT_STATE={NONE:0,ROW_VALUE:1,ROW_HEADER:2,COL_VALUE:4,COL_HEADER:8};var $PI=Math.PI,UNIT_RAD=$PI/180*1,EPS_RAD=UNIT_RAD*0.0001,SMALL_THRESHOLD=10;function getRowColumnSelectedState(selectedTargets){function getSelectedTargetTypes(){var _types=[];$ARR.forEach(selectedTargets||[],function(target){var realTarget=getRealTargetFMT(target);var type=realTarget.getAttribute("type");if(type){_types.push(type);}});return _types;}var types=getSelectedTargetTypes(),selectedState=0;var hasRowValue=types.indexOf(CTRL_TYPE.GM_ROW_HEADER)>-1||types.indexOf(CTRL_TYPE.GM_ROW_HEADER_EXTRA)>-1||types.indexOf(CTRL_TYPE.GM_ROW_HEADER_TEXT)>-1;var hasRowHeader=types.indexOf(CTRL_TYPE.GM_ROW_HEADER_TITLE)>-1||types.indexOf(CTRL_TYPE.GM_ROW_HEADER_TITLE_TEXT)>-1;var hasColValue=types.indexOf(CTRL_TYPE.GM_COL_HEADER)>-1||types.indexOf(CTRL_TYPE.GM_COL_HEADER_EXTRA)>-1||types.indexOf(CTRL_TYPE.GM_COL_HEADER_TEXT)>-1;var hasColHeader=types.indexOf(CTRL_TYPE.GM_COL_HEADER_TITLE)>-1||types.indexOf(CTRL_TYPE.GM_COL_HEADER_TITLE_TEXT)>-1;if(hasRowValue){selectedState=selectedState|HEADER_TITLE_SELECT_STATE.ROW_VALUE;}if(hasRowHeader){selectedState=selectedState|HEADER_TITLE_SELECT_STATE.ROW_HEADER;}if(hasColValue){selectedState=selectedState|HEADER_TITLE_SELECT_STATE.COL_VALUE;}if(hasColHeader){selectedState=selectedState|HEADER_TITLE_SELECT_STATE.COL_HEADER;}return selectedState;}function EnableDisableAllTrendLine(cfg){var visGM=this.widget,gmCtr=visGM.GMController,gmm=gmCtr.model,ldss=gmm.ldss&&gmm.ldss[0],srsCnt,chtInfo=gmCtr.getChartInfo(),me=this,mIdxArr=[],mIdsArr=[],metricsOnX=gmCtr.getMetricsOnXAxis(),metricsOnY=gmCtr.getMetricsOnYAxis(),metricShapes=visGM.readGlobalProperty($ENUM_XML_TAG.METRIC_SHAPES);var disabled=false,SB_TYPE=mstrmojo.gm.EnumSubtype,resultantSubtype=gmCtr.chartSubType,shape=chtInfo.shape;if(chtInfo.isABL&&resultantSubtype===SB_TYPE.PERCENT){disabled=true;}if(chtInfo.isBubbleOrScatter){mIdxArr=GMUTIL.filterInValidMetricIndex(metricsOnY);}else{if(chtInfo.isABL){if(chtInfo.dirc===$GM.EnumABLDirection.HORIZONTAL){mIdxArr=GMUTIL.filterInValidMetricIndex(metricsOnX);}else{mIdxArr=GMUTIL.filterInValidMetricIndex(metricsOnY);}if(ldss){srsCnt=ldss.srsCnt;if(srsCnt===undefined||srsCnt===null){srsCnt=ldss.getSeriesCount();}}if(resultantSubtype===SB_TYPE.STACKED){if(gmCtr.getBreakByAttrsID().length>0){disabled=true;}if(mIdxArr&&mIdxArr.length>1&&!gmCtr.splitPlottingMetrics){disabled=true;}}else{if(resultantSubtype===SB_TYPE.CLUSTERED){if(chtInfo.isCombo){mIdsArr=gmm.getMetricIDsFromIndex(mIdxArr);$ARR.forEach(mIdsArr,function(mid){var mShape=metricShapes.jsonObj[mid];if(mShape===SHAPE_TYPE.BAR){disabled=true;}});}else{if(shape===SHAPE_TYPE.BAR){if(gmCtr.getBreakByAttrsID().length>0){disabled=true;}}else{if(gmCtr.getBreakByAttrsID().length>0){disabled=true;}if(mIdxArr&&mIdxArr.length>1&&!gmCtr.splitPlottingMetrics){disabled=true;}}}}else{if(chtInfo.isCombo){mIdsArr=gmm.getMetricIDsFromIndex(mIdxArr);if(gmCtr.getBreakByAttrsID().length>0){$ARR.forEach(mIdsArr,function(mid){var mShape=metricShapes.jsonObj[mid];if(mShape===SHAPE_TYPE.BAR){disabled=true;}});}}}}}}disabled=disabled||!GMUTIL.isTrendLineAvailableForAnyMetric(visGM);if(!disabled&&mIdxArr&&mIdxArr.length>0){var options=[],opt,existingPV,enabledActions=[],disableActions=[];$ARR.forEach(mIdxArr,function(m){opt=GMUTIL.getOptionObjArr.call(gmCtr,[m]);options.push(opt);existingPV=visGM.readGlobalProperty($ENUM_XML_TAG.TREND_LINE_DEF,opt);if(!existingPV.jsonObj.trdEnabled){existingPV.setProperty("trdEnabled",true);visGM.getEnableTrendLineActions(existingPV.jsonObj,enabledActions,opt.key);}else{existingPV.setProperty("trdEnabled",false);visGM.getEnableTrendLineActions(existingPV.jsonObj,disableActions,opt.key);}});cfg.addToggleMenuItem(mstrmojo.desc(12160,"Enable trendline"),"xt",function(){if(enabledActions.length>0){$ARR.forEach(enabledActions,function(enabledAction){visGM.checkCustomScaleNotificationForTrendLine(enabledAction.metricId);});visGM.submitUpdatesAndPersistXML(enabledActions,visGM.getXTabRefreshCallBack(),undefined,false,false);}},function(){if(disableActions.length>0){visGM.submitUpdatesAndPersistXML(disableActions,visGM.getXTabRefreshCallBack(),undefined,false,false);}},me.id,enabledActions.length===0);if(enabledActions.length===0&&mstrApp.appState!==mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION){cfg.addMenuItem(mstrmojo.desc(12163,"Edit trendline..."),"xt",GMUTIL.getEditTrendLineHandler(visGM,options[0].key));}}}function hoverTrendLine(target){var hoverColor="#34ABEB";target.style.stroke=hoverColor;return ;}function deHoverTrendLine(target){var originColor=target.identity.lineModel.getLineColor();target.style.stroke=$COLOR.decodeColor(originColor)||"#000000";return ;}function selectTrendLine(target){var rectWidth=6,rectHeight=6,rectStrokeWidth=2,xOffset=rectWidth/2,yOffset=rectHeight/2,_MIN_X=1,_MIN_Y=1,_MAX_X=Number.MAX_VALUE,_MAX_Y=Number.MAX_VALUE;var getTrendLineHighlightPoints=function(target){var highlightPoints=[];var pointsString=target.getAttribute("highlightPoints"),pointsArray=pointsString?pointsString.split(";"):[];$ARR.forEach(pointsArray||[],function(pointString){var colonIndex=pointString.indexOf(":");if(colonIndex>-1){var xyString=pointString.substring(colonIndex+1);var xyArray=xyString.split(",");$ARR.forEach(xyArray||[],function(coordinateString,i){xyArray[i]=parseFloat(coordinateString,10);});highlightPoints.push(xyArray);}});return highlightPoints;};var getReferenceLineHighlightPoints=function(target){var highlightPoints=[];var pointsString=target.getAttribute("points");pointsString=pointsString.substring(0,pointsString.length-1);var pointsArray=pointsString.split(" ");$ARR.forEach(pointsArray||[],function(xyString,j){var xyArray=xyString.split(",");$ARR.forEach(xyArray||[],function(coordinateString,i){xyArray[i]=parseFloat(coordinateString,10);});if(j===0){highlightPoints[j]=xyArray;}else{if(j===1){highlightPoints[j+1]=xyArray;}}});if(highlightPoints[0]&&highlightPoints[2]){highlightPoints[1]=[(highlightPoints[0][0]+highlightPoints[2][0])/2,(highlightPoints[0][1]+highlightPoints[2][1])/2];}return highlightPoints;};var checkHighlightPoints=function(ps){var isGood=true;$ARR.forEach(ps||[],function(p){if(!p||p.length!==2){isGood=false;return false;}});if(isGood){if(!ps||ps.length!==3){isGood=false;}}return isGood;};var adjustCoordinate=function(coordinate,_offset,_min,_max,isRefLine){if(isRefLine){return Math.min(Math.max(coordinate-_offset,_min),_max);}else{return coordinate-_offset;}};var targetType=target.getAttribute("type"),highlightPoints;if(isTrendLIne(targetType)&&target.hasAttribute("highlightPoints")){highlightPoints=getTrendLineHighlightPoints(target);}else{if(isReferenceLine(targetType)||!target.hasAttribute("highlightPoints")){highlightPoints=getReferenceLineHighlightPoints(target);}else{highlightPoints=getTrendLineHighlightPoints(target);}}if(!checkHighlightPoints(highlightPoints)){return ;}var svgNode=target.parentNode&&target.parentNode.parentNode;if(svgNode){var svgWidth=svgNode.clientWidth,svgHeight=svgNode.clientHeight;_MAX_X=svgWidth-(rectStrokeWidth+rectWidth);_MAX_Y=svgHeight-(rectStrokeWidth+rectHeight);}var startPint=document.createElementNS("http://www.w3.org/2000/svg","rect"),endPoint=document.createElementNS("http://www.w3.org/2000/svg","rect");startPint.setAttribute("type",CTRL_TYPE.GM_TREND_LINE_SELECT);startPint.setAttribute("class","gm-trendline-select");startPint.setAttribute("x",adjustCoordinate(highlightPoints[0][0],xOffset,_MIN_X,_MAX_X,isReferenceLine(targetType)));startPint.setAttribute("y",adjustCoordinate(highlightPoints[0][1],yOffset,_MIN_Y,_MAX_Y,isReferenceLine(targetType)));startPint.setAttribute("width",rectWidth.toString());startPint.setAttribute("height",rectHeight.toString());endPoint.setAttribute("type",CTRL_TYPE.GM_TREND_LINE_SELECT);endPoint.setAttribute("class","gm-trendline-select");endPoint.setAttribute("x",adjustCoordinate(highlightPoints[2][0],xOffset,_MIN_X,_MAX_X,isReferenceLine(targetType)));endPoint.setAttribute("y",adjustCoordinate(highlightPoints[2][1],yOffset,_MIN_Y,_MAX_Y,isReferenceLine(targetType)));endPoint.setAttribute("width",rectWidth.toString());endPoint.setAttribute("height",rectHeight.toString());target.parentNode.appendChild(startPint);target.parentNode.appendChild(endPoint);var rectDom2=document.createElementNS("http://www.w3.org/2000/svg","rect");rectDom2.setAttribute("type",CTRL_TYPE.GM_TREND_LINE_SELECT);rectDom2.setAttribute("class","gm-trendline-select");if(isTrendLIne(targetType)){rectDom2.setAttribute("x",adjustCoordinate(highlightPoints[1][0],xOffset,_MIN_X,_MAX_X));rectDom2.setAttribute("y",adjustCoordinate(highlightPoints[1][1],yOffset,_MIN_Y,_MAX_Y));}else{if(isReferenceLine(targetType)){rectDom2.setAttribute("x",adjustCoordinate(highlightPoints[1][0],xOffset,_MIN_X,_MAX_X));rectDom2.setAttribute("y",adjustCoordinate(highlightPoints[1][1],yOffset,_MIN_Y,_MAX_Y));}}rectDom2.setAttribute("width",rectWidth.toString());rectDom2.setAttribute("height",rectHeight.toString());target.parentNode.appendChild(rectDom2);}function deSelectTrendLine(target){var selectDoms=findElementsByAttribute(target.parentNode,"type",CTRL_TYPE.GM_TREND_LINE_SELECT);$ARR.forEach(selectDoms||[],function(selectDom){if(selectDom.parentNode===target.parentNode){target.parentNode.removeChild(selectDom);}});}function getShapeCenter(shape){var xSum=0,ySum=0,point=[],j;if(shape.tagName==="circle"){point.push(parseInt(shape.getAttribute("cx"),10));point.push(parseInt(shape.getAttribute("cy"),10));}else{if(shape.tagName==="rect"){var x=parseFloat(shape.getAttribute("x")),y=parseFloat(shape.getAttribute("y")),w=parseFloat(shape.getAttribute("width")),h=parseFloat(shape.getAttribute("height"));point.push(x+w/2);point.push(y+h/2);}else{if(shape.tagName==="polygon"){var plgPointsStr=shape.getAttribute("points");plgPointsStr=plgPointsStr.substring(0,plgPointsStr.length-1);plgPointsStr=plgPointsStr.replace(/,/g," ");var plgPoints=plgPointsStr.split(" "),pointsLength=plgPoints.length;for(j=0;j<pointsLength;j++){if(j%2===0){xSum+=parseInt(plgPoints[j],10);}else{ySum+=parseInt(plgPoints[j],10);}}point.push(xSum/pointsLength*2);point.push(ySum/pointsLength*2);}}}return point;}function encodeIdentities(identities){if(identities.constructor!==Array){identities=[identities];}var encodedIdentities=[];$ARR.forEach(identities||[],function(identity){var identityCopy=$HASH.copy(identity);encodedIdentities.push(identityCopy);});$ARR.forEach(encodedIdentities||[],function(identity){if(identity.objType===IDEN_TYPE.Y2_AXIS){identity.objType=IDEN_TYPE.Y_AXIS;}else{if(identity.objType===IDEN_TYPE.X2_AXIS){identity.objType=IDEN_TYPE.X_AXIS;}else{if(identity.objType===IDEN_TYPE.X_AXIS_ORIGIN_LINE||identity.objType===IDEN_TYPE.Y_AXIS_ORIGIN_LINE){identity.objType=IDEN_TYPE.AXIS_ORIGIN;}else{if(identity.objType===IDEN_TYPE.X_AXIS_ORIGIN_LABEL){identity.objType=IDEN_TYPE.X_NUMERIC;}else{if(identity.objType===IDEN_TYPE.X_ATTRIBUTE_AXIS_TITLE){identity.objType=IDEN_TYPE.X_METRIC_AXIS_TITLE;}else{if(identity.objType===IDEN_TYPE.Y_AXIS_ORIGIN_LABEL){identity.objType=IDEN_TYPE.Y_NUMERIC;}else{if(identity.objType===IDEN_TYPE.Y_ATTRIBUTE_AXIS_TITLE){identity.objType=IDEN_TYPE.Y_METRIC_AXIS_TITLE;}else{if(identity.objType===IDEN_TYPE.ROW_HEADER_TEXT){identity.objType=IDEN_TYPE.ROW_HEADER;}else{if(identity.objType===IDEN_TYPE.ROW_TITLE_TEXT){identity.objType=IDEN_TYPE.ROW_TITLE;}else{if(identity.objType===IDEN_TYPE.COL_HEADER_TEXT){identity.objType=IDEN_TYPE.COL_HEADER;}else{if(identity.objType===IDEN_TYPE.COL_TITLE_TEXT){identity.objType=IDEN_TYPE.COL_TITLE;}}}}}}}}}}}});return encodedIdentities;}function decodeIdentities(identities){if(identities.constructor!==Array){identities=[identities];}var decodedIdentities=[];$ARR.forEach(identities||[],function(identityType){if(identityType===IDEN_TYPE.X_CATEGORY){decodedIdentities.push(IDEN_TYPE.X_CATEGORY);decodedIdentities.push(IDEN_TYPE.X_NUMERIC);decodedIdentities.push(IDEN_TYPE.X_AXIS_ORIGIN_LABEL);}else{if(identityType===IDEN_TYPE.Y_CATEGORY){decodedIdentities.push(IDEN_TYPE.Y_CATEGORY);decodedIdentities.push(IDEN_TYPE.Y_NUMERIC);decodedIdentities.push(IDEN_TYPE.Y_AXIS_ORIGIN_LABEL);}else{if(identityType===IDEN_TYPE.Y_AXIS){decodedIdentities.push(IDEN_TYPE.Y_AXIS);decodedIdentities.push(IDEN_TYPE.Y2_AXIS);}else{if(identityType===IDEN_TYPE.X_AXIS){decodedIdentities.push(IDEN_TYPE.X_AXIS);decodedIdentities.push(IDEN_TYPE.X2_AXIS);}else{if(identityType===IDEN_TYPE.Y_METRIC_AXIS_TITLE){decodedIdentities.push(IDEN_TYPE.Y_METRIC_AXIS_TITLE);decodedIdentities.push(IDEN_TYPE.Y_ATTRIBUTE_AXIS_TITLE);}else{if(identityType===IDEN_TYPE.X_METRIC_AXIS_TITLE){decodedIdentities.push(IDEN_TYPE.X_METRIC_AXIS_TITLE);decodedIdentities.push(IDEN_TYPE.X_ATTRIBUTE_AXIS_TITLE);}else{decodedIdentities.push(identityType);}}}}}}});return decodedIdentities;}function findElementsByAttribute(root,attribute,values,isPropertyInIdentity){isPropertyInIdentity=!!isPropertyInIdentity;var elements=[];if(values.constructor!==Array){values=[values];}var getType=function(_dom){if(isPropertyInIdentity){return _dom.identity&&_dom.identity.tlOpt&&_dom.identity.tlOpt[attribute];}else{return _dom.getAttribute(attribute);}};function htmlTree(dom){var type=getType(dom),nextdom;if(dom.hasChildNodes()){nextdom=dom.firstChild;while(nextdom){if(nextdom.nodeType===1){type=getType(nextdom);if(values.indexOf(type)!==-1){elements.push(nextdom);}else{htmlTree(nextdom);}}nextdom=nextdom.nextSibling;}}}htmlTree(root);return elements;}function checkIntersectionWithTwoArrays(arr1,arr2){arr2=arr2||[];var intersect=false;$ARR.forEach(arr1||[],function(elem1){if(arr2.indexOf(elem1)!==-1){intersect=true;}});return intersect;}function findDropZoneItem(gmDropZones,tid){var item,zoneArr=gmDropZones.dropZones;$ARR.forEach(zoneArr,function(zone){$ARR.forEach(zone.items,function(it){if(item===undefined&&it.did===tid){item=it;}});});return item;}function isEmptyDropZone(gmDropZones,dzid){var dropZones=gmDropZones.dropZones,idx=$ARR.find(dropZones,"id",dzid);return idx===-1?true:(dropZones[idx].items.length===0);}function getEssentialZoneModels(w){if(w.zonesModel&&w.zonesModel.gmZones){return w.zonesModel.gmZones;}return w.zonesModel;}function extractSelectionInfo(shapeIdentity){var i,item,rtn={},info=shapeIdentity.getSelectedObjectInfo(false),n=info.length;for(i=0;i<n;i++){item=info[i];if(item.tid!==-1){if(rtn[item.tid]===undefined){rtn[item.tid]=[{id:item.eid,n:item.v}];}else{rtn[item.tid][0].n+=(":"+item.v);}}}return rtn;}function addClass(el,s){if(!el){return ;}if(s.constructor!==Array){s=[s];}var cls=el.getAttribute("class")||"",start=" "+cls+" ",bAdded=false,len=s.length,i;for(i=0;i<len;i++){var c=s[i];if(!start.match(new RegExp("\\s"+c+"\\s"))){cls+=" "+c;bAdded=true;}}if(bAdded){el.setAttribute("class",$S.trim(cls));}}function removeClass(el,s){if(!el){return ;}if(s.constructor!==Array){s=[s];}var cls=" "+(el.getAttribute("class")||"")+" ",len=s.length,i;for(i=0;i<len;i++){cls=cls.replace(new RegExp("\\s"+s[i]+"\\s","g")," ");}el.setAttribute("class",$S.trim(cls));}function getStatusTransform(prevStatus,status){var rtn=STAT_MAP[prevStatus+"-"+status];if(rtn===undefined){return SHAPE_STAT_TRANS.INVALID;}return rtn;}function updateShapeClass(shape,trans){switch(trans){case SHAPE_STAT_TRANS.NORMAL2HOVER:addClass(shape,"hover");break;case SHAPE_STAT_TRANS.NORMAL2SELECTED:addClass(shape,"selected");break;case SHAPE_STAT_TRANS.HOVER2NORMAL:removeClass(shape,"hover");break;case SHAPE_STAT_TRANS.HOVER2SELECTED:removeClass(shape,"hover");addClass(shape,"selected");break;case SHAPE_STAT_TRANS.SELECTED2NORMAL:removeClass(shape,"selected");break;case SHAPE_STAT_TRANS.SELECTED2HOVER:removeClass(shape,"selected");addClass(shape,"hover");break;case SHAPE_STAT_TRANS.SH2SELECTED:removeClass(shape,"sh");addClass(shape,"selected");break;case SHAPE_STAT_TRANS.SELECTED2SH:removeClass(shape,"selected");addClass(shape,"sh");break;case SHAPE_STAT_TRANS.SH2NORMAL:removeClass(shape,"sh");addClass(shape,"normal");break;default:break;}}function hCalPoint(iX,iY,iR,iRadian){var lX=iX+iR*Math.cos(iRadian),lY=iY+iR*Math.sin(iRadian);return{x:lX,y:lY};}function hMoveTo(iX,iY){return"M "+iX+" "+iY;}function hLineTo(iX,iY){return"L "+iX+" "+iY;}function hArcTo(iR,iLargeArc,iClockwise,iX,iY){return"A "+iR+","+iR+" 0 "+(iLargeArc?"1":"0")+","+(iClockwise?"1 ":"0 ")+iX+","+iY;}function hClosePath(){return"Z";}function hRelMoveTo(iX,iY){return"m "+iX+" "+iY;}function hRelArcTo(iR,iLargeArc,iClockwise,iX,iY){return"a "+iR+","+iR+" 0 "+(iLargeArc?"1":"0")+","+(iClockwise?"1 ":"0 ")+iX+","+iY;}function getSingleRingPointString(shape,shrink){var iX=shape.sX,iY=shape.sY,iOutR=shape.sOutR,iInR=shape.sInR,lDStr="";if(isUndefined(iX,iY,iOutR,iInR)){return lDStr;}iOutR-=shrink;iInR+=shrink;var outCurveLeftP=hCalPoint(iX,iY,iOutR,$PI),outCurveRightP=hCalPoint(iX,iY,iOutR,0),inCurveLeftP=hCalPoint(iX,iY,iInR,$PI),inCurveRightP=hCalPoint(iX,iY,iInR,0);lDStr=hMoveTo(outCurveLeftP.x,outCurveLeftP.y);lDStr+=(" "+hArcTo(iOutR,true,true,outCurveRightP.x,outCurveRightP.y));lDStr+=(" "+hMoveTo(inCurveRightP.x,inCurveRightP.y));lDStr+=(" "+hArcTo(iInR,true,false,inCurveLeftP.x,inCurveLeftP.y));lDStr+=(" "+hArcTo(iInR,true,false,inCurveRightP.x,inCurveRightP.y));lDStr+=(" "+hMoveTo(outCurveRightP.x,outCurveRightP.y));lDStr+=(" "+hArcTo(iOutR,true,true,outCurveLeftP.x,outCurveLeftP.y));return lDStr;}function getPiePointString(shape,shrink){var iX=shape.sX,iY=shape.sY,isRingPie=(!shape.sR&&shape.sInR&&shape.sOutR),lDStr="";if(iX===undefined||iY===undefined){return lDStr;}if(isRingPie){lDStr=getSingleRingPointString(shape,shrink);}else{var iR=shape.sR-shrink*2,iStartRadian=shape.sRadStart,iEndRadian=shape.sRadEnd;lDStr=hMoveTo(iX,iY);var lCurveStartP=hCalPoint(iX,iY,iR,iStartRadian),lCurveEndP=hCalPoint(iX,iY,iR,iEndRadian),lLargeArc=(iEndRadian-iStartRadian)>$PI;lDStr+=(" "+hLineTo(lCurveStartP.x,lCurveStartP.y));lDStr+=(" "+hArcTo(iR,lLargeArc,true,lCurveEndP.x,lCurveEndP.y));lDStr+=(" "+hClosePath());}return lDStr;}function getLinePointString(shape,shrink){var iX=shape.sX,iY=shape.sY,iR=shape.sR,iStartRadian=shape.sRadStart,iEndRadian=shape.sRadEnd;if(iX===undefined||iY===undefined||iR===undefined||iStartRadian===undefined||iEndRadian===undefined){return"";}var iMidRadian=iStartRadian+(iEndRadian-iStartRadian)/2,newCenter=hCalPoint(iX,iY,shrink/Math.abs(Math.tan((iEndRadian-iStartRadian)/2)),iMidRadian);iX=newCenter.x;iY=newCenter.y;iR-=(shrink+shrink/Math.abs(Math.sin((iEndRadian-iStartRadian)/2)));if((iEndRadian-iStartRadian)>$PI){iR+=(shrink+1.5*shrink/Math.abs(Math.sin((iEndRadian-iStartRadian)/2)));}var lDStr=hMoveTo(iX,iY),lCurveStartP=hCalPoint(iX,iY,iR,iStartRadian),lCurveEndP=hCalPoint(iX,iY,iR,iEndRadian);lDStr+=(" "+hLineTo(lCurveStartP.x,lCurveStartP.y));lDStr+=hMoveTo(iX,iY);lDStr+=(" "+hLineTo(lCurveEndP.x,lCurveEndP.y));return lDStr;}function getRingPointString(sector,shrink){var iX=sector.sX,iY=sector.sY,iOutR=sector.sOutR,iInR=sector.sInR,iStartRadian=sector.sRadStart,iEndRadian=sector.sRadEnd;if(!iStartRadian&&!iEndRadian){return getSingleRingPointString(sector,shrink);}if(iX===undefined||iY===undefined||iOutR===undefined||iInR===undefined||iStartRadian===undefined||iEndRadian===undefined){return"";}iOutR-=shrink;iInR+=shrink;iStartRadian+=shrink*UNIT_RAD;iEndRadian-=shrink*UNIT_RAD;var outCurveStartP=hCalPoint(iX,iY,iOutR,iStartRadian),outCurveEndP=hCalPoint(iX,iY,iOutR,iEndRadian),inCurveStartP=hCalPoint(iX,iY,iInR,iStartRadian),inCurveEndP=hCalPoint(iX,iY,iInR,iEndRadian),largeArc=iEndRadian-iStartRadian>$PI,lDStr=hMoveTo(inCurveStartP.x,inCurveStartP.y);lDStr+=(" "+hArcTo(iInR,largeArc,true,inCurveEndP.x,inCurveEndP.y));lDStr+=(" "+hLineTo(outCurveEndP.x,outCurveEndP.y));lDStr+=(" "+hArcTo(iOutR,largeArc,false,outCurveStartP.x,outCurveStartP.y));lDStr+=(" "+hClosePath());return lDStr;}function getSVGParentNode(shape){var prt=shape.parentNode;while(prt){if(prt.tagName==="svg"){return prt;}prt=prt.parentNode;}return undefined;}function getSVGChildNode(div){if(div.tagName==="svg"){return div;}var i,node,children=div.childNodes,n=children.length;for(i=0;i<n;i++){node=getSVGChildNode(children[i]);if(node){return node;}}return null;}function mergeSlices(shapes){var res=[],len=shapes.length;if(len<1){return res;}shapes.sort(function(s1,s2){return s1.sRadStart-s2.sRadStart;});var cur={sRadStart:shapes[0].sRadStart,sRadEnd:shapes[0].sRadEnd};for(var i=1;i<len;i++){if(cur.sRadEnd>=shapes[i].sRadStart){cur.sRadEnd=Math.max(cur.sRadEnd,shapes[i].sRadEnd);}else{res.push(cur);cur={sRadStart:shapes[i].sRadStart,sRadEnd:shapes[i].sRadEnd};}}res.push(cur);if(res.length>1&&Math.abs(res[0].sRadStart+2*$PI-res[res.length-1].sRadEnd)<EPS_RAD){res[0].sRadStart=res[0].sRadEnd;res[0].sRadEnd=res[res.length-1].sRadStart;res[0].bSeepFlag=true;res.pop();}return res;}function isUndefined(){var args=[].slice.call(arguments);return args.some(function(arg){return typeof arg==="undefined";});}var svgops={createSVGElement:function(type){return document.createElementNS("http://www.w3.org/2000/svg",type);},getPiePointString:function(iX,iY,iR,iStartRadian,iEndRadian,bAnticlock,shrink){var lDStr="";if(isUndefined(iX,iY,iR)){return lDStr;}if(!isUndefined(shrink)){var newCenter,iCenterRadian=(iStartRadian+iEndRadian)/2;iR-=shrink;if(bAnticlock){newCenter=hCalPoint(iX,iY,2,iCenterRadian>Math.PI?iCenterRadian-Math.PI:iCenterRadian+Math.PI);iStartRadian-=shrink/iR;iEndRadian+=shrink/iR;}else{newCenter=hCalPoint(iX,iY,2,iCenterRadian);iStartRadian+=shrink/iR;iEndRadian-=shrink/iR;}lDStr=hMoveTo(newCenter.x,newCenter.y);}else{lDStr=hMoveTo(iX,iY);}var lCurveStartP=hCalPoint(iX,iY,iR,iStartRadian),lCurveEndP=hCalPoint(iX,iY,iR,iEndRadian),lLargeArc=(iEndRadian-iStartRadian)>Math.PI;if(bAnticlock){lLargeArc=!lLargeArc;}lDStr+=(" "+hLineTo(lCurveStartP.x,lCurveStartP.y));lDStr+=(" "+hArcTo(iR,lLargeArc,!bAnticlock,lCurveEndP.x,lCurveEndP.y));lDStr+=(" "+hClosePath());return lDStr;},getRingPointString:function(iX,iY,iInnerR,iOutterR,iStartRadian,iEndRadian,bAnticlock,shrink){var lDStr="",lLargeArc=true;if(isUndefined(iX,iY,iInnerR,iOutterR)){return lDStr;}if(!isUndefined(iStartRadian,iEndRadian)&&Math.abs(iEndRadian-iStartRadian-2*$PI)>EPS_RAD){var lCurveStartPOutter,lCurveEndPOutter,lCurveStartPInner,lCurveEndPInner;if(!isUndefined(shrink)){iOutterR-=shrink;iInnerR+=shrink;if(bAnticlock){iStartRadian-=shrink/iOutterR;iEndRadian+=shrink/iOutterR;}else{iStartRadian+=shrink/iOutterR;iEndRadian-=shrink/iOutterR;}lCurveStartPOutter=hCalPoint(iX,iY,iOutterR,iStartRadian);lCurveEndPOutter=hCalPoint(iX,iY,iOutterR,iEndRadian);lCurveStartPInner=hCalPoint(iX,iY,iInnerR,iStartRadian);lCurveEndPInner=hCalPoint(iX,iY,iInnerR,iEndRadian);}else{lCurveStartPOutter=hCalPoint(iX,iY,iOutterR,iStartRadian);lCurveEndPOutter=hCalPoint(iX,iY,iOutterR,iEndRadian);lCurveStartPInner=hCalPoint(iX,iY,iInnerR,iStartRadian);lCurveEndPInner=hCalPoint(iX,iY,iInnerR,iEndRadian);}lLargeArc=(iEndRadian-iStartRadian)>Math.PI;if(bAnticlock){lLargeArc=!lLargeArc;}lDStr+=(" "+hMoveTo(lCurveStartPInner.x,lCurveStartPInner.y));lDStr+=(" "+hLineTo(lCurveStartPOutter.x,lCurveStartPOutter.y));lDStr+=(" "+hArcTo(iOutterR,lLargeArc,!bAnticlock,lCurveEndPOutter.x,lCurveEndPOutter.y));lDStr+=(" "+hLineTo(lCurveEndPInner.x,lCurveEndPInner.y));lDStr+=(" "+hArcTo(iInnerR,lLargeArc,!!bAnticlock,lCurveStartPInner.x,lCurveStartPInner.y));lDStr+=(" "+hClosePath());}else{if(!isUndefined(shrink)){iOutterR-=shrink;iInnerR+=shrink;}lDStr+=(" "+hMoveTo(iX,iY));lDStr+=(" "+hRelMoveTo(-iOutterR,0));lDStr+=(" "+hRelArcTo(iOutterR,lLargeArc,true,iOutterR*2,0));lDStr+=(" "+hRelArcTo(iOutterR,lLargeArc,true,-iOutterR*2,0));lDStr+=(" "+hMoveTo(iX,iY));lDStr+=(" "+hRelMoveTo(-iInnerR,0));lDStr+=(" "+hRelArcTo(iInnerR,lLargeArc,true,iInnerR*2,0));lDStr+=(" "+hRelArcTo(iInnerR,lLargeArc,true,-iInnerR*2,0));}return lDStr;},getPieRingDecoratorPie:function(slice,centerX,centerY,radius,shrink){var decorator=null;if(isUndefined(slice.sRadStart,slice.sRadEnd)||Math.abs(slice.sRadStart+2*$PI-slice.sRadEnd)<EPS_RAD){decorator=svgops.createSVGElement("circle");decorator.setAttribute("cx",centerX);decorator.setAttribute("cy",centerY);decorator.setAttribute("r",shrink?radius-shrink:radius);}else{decorator=svgops.createSVGElement("path");decorator.setAttribute("d",svgops.getPiePointString(centerX,centerY,radius,slice.sRadStart,slice.sRadEnd,slice.bSeepFlag,shrink));}return decorator;},getPieRingDecoratorRing:function(slice,centerX,centerY,radiusInner,radiusOutter,shrink){var decorator=null;decorator=svgops.createSVGElement("path");decorator.setAttribute("d",svgops.getRingPointString(centerX,centerY,radiusInner,radiusOutter,slice.sRadStart,slice.sRadEnd,slice.bSeepFlag,shrink));return decorator;}};var fnGroupShapes=function(shapes){var i=0,len,result={pie:{},ring:{}},shape,id,subtype,arr=[];for(len=shapes.length;i<len;i++){shape=shapes[i];subtype=shape.getAttribute("subtype");if(subtype!==SHAPE_SUBTYPE.PIE&&subtype!==SHAPE_SUBTYPE.RING&&subtype!==SHAPE_SUBTYPE.CIRCLE){continue;}if(typeof shape.sR!==undefined&&isUndefined(shape.sInR,shape.sOutR)){id=""+shape.sX+"-"+shape.sY+"-"+shape.sR;arr=result.pie[id]||(result.pie[id]=[]);}else{id=""+shape.sX+"-"+shape.sY+"-"+shape.sInR+"-"+shape.sOutR;arr=result.ring[id]||(result.ring[id]=[]);}arr.push(shape);}return result;};function updatePieRingDecorator(svgNode,subtype){if(subtype!==SHAPE_SUBTYPE.PIE&&subtype!==SHAPE_SUBTYPE.RING&&subtype!==SHAPE_SUBTYPE.CIRCLE){return ;}var decorator=svgNode.decorator,selShapes=svgNode.selectedShapes;if(decorator){svgNode.removeChild(decorator);delete svgNode.decorator;}if(typeof selShapes==="undefined"||selShapes.length===0){return ;}decorator=svgNode.decorator=svgops.createSVGElement("g");decorator.setAttribute("type","gm-group-decorator");var classifiedRes=fnGroupShapes(selShapes),pies=Object.keys(classifiedRes.pie),rings=Object.keys(classifiedRes.ring);$ARR.forEach(pies,function(id){var shapes=classifiedRes.pie[id],centerX=shapes[0].sX,centerY=shapes[0].sY,radius=shapes[0].sR,isSmall=radius<SMALL_THRESHOLD;var mergedSlices=mergeSlices(shapes);for(var i=0,len=mergedSlices.length;i<len;i++){var slice=mergedSlices[i];var decoratorOutter=svgops.getPieRingDecoratorPie(slice,centerX,centerY,radius-1);decoratorOutter.setAttribute("class","gm-outter-decorator");decorator.appendChild(decoratorOutter);if(!isUndefined(slice.sRadEnd,slice.sRadStart)){var absRad=slice.sRadEnd-slice.sRadStart;if(slice.bSeepFlag){absRad=2*$PI-absRad;}if(absRad*radius<SMALL_THRESHOLD){isSmall=true;}}if(!isSmall){var decoratorInner=svgops.getPieRingDecoratorPie(slice,centerX,centerY,radius,3);decoratorInner.setAttribute("class","gm-inner-decorator");decorator.appendChild(decoratorInner);}}});$ARR.forEach(rings,function(id){var shapes=classifiedRes.ring[id],centerX=shapes[0].sX,centerY=shapes[0].sY,rInner=shapes[0].sInR,rOutter=shapes[0].sOutR,isSmall=(rOutter-rInner<SMALL_THRESHOLD);var mergedSlices=mergeSlices(shapes);for(var i=0,len=mergedSlices.length;i<len;i++){var slice=mergedSlices[i];var decoratorOutter=svgops.getPieRingDecoratorRing(slice,centerX,centerY,rInner+1,rOutter-1);decoratorOutter.setAttribute("class","gm-outter-decorator");decorator.appendChild(decoratorOutter);if(!isUndefined(slice.sRadEnd,slice.sRadStart)){var absRad=slice.sRadEnd-slice.sRadStart;if(slice.bSeepFlag){absRad=2*$PI-absRad;}if(absRad*(rOutter+rInner)<SMALL_THRESHOLD){isSmall=true;}}if(!isSmall){var decoratorInner=svgops.getPieRingDecoratorRing(slice,centerX,centerY,rInner,rOutter,3);decoratorInner.setAttribute("class","gm-inner-decorator");decorator.appendChild(decoratorInner);}}});svgNode.appendChild(decorator);}function isPointInBox(x,y,box){var x1=box.left,y1=box.top,x2=x1+box.width,y2=y1+box.height;return x>=x1&&x<x2&&y>=y1&&y<y2;}function getTargetRange(w){return Math.round(w*0.1);}function getTargetEdgeRange(tgtInfo,direction,sidebyside,widget){var range,box=tgtInfo.box;if(sidebyside){var gmCtl=widget.GMController,existingGroupInfo=gmCtl.hasGroupInfoStored(),groupInfo=existingGroupInfo.existing&&existingGroupInfo.gi,items=this.getZoneItems(widget.currEnteredDropZoneID,widget),itemRowCnt=existingGroupInfo.existing?groupInfo.length:items.length,axisIndex=tgtInfo.axisIndex;range=(direction==="H"?box.width:box.height);if(itemRowCnt===1){range=range/2;}else{if(itemRowCnt>1){if(axisIndex===0){range=range*0.67;}else{if(axisIndex===itemRowCnt-1){range=range*0.33;}else{range=range*0.5;}}}}}else{if(direction==="H"){range=3*getTargetRange(box.width);}else{range=3*getTargetRange(box.height);}}return range;}function getTargetEdge(x,y,tgtInfo,direction,sidebyside,widget){var range,pos,edge,box=tgtInfo.box,mainContainerPos=$DOM.position(widget.domMainContainer);x=x-mainContainerPos.x;y=y-mainContainerPos.y;if(sidebyside){pos=direction==="H"?x-box.left:y=y-box.top;range=getTargetEdgeRange.call(this,tgtInfo,direction,sidebyside,widget);edge=(pos<range)?TARGET_ABOVE:TARGET_BELOW;}else{if(direction==="H"){x=x-box.left;range=getTargetEdgeRange.call(this,tgtInfo,direction,sidebyside,widget);edge=(x<range)?TARGET_ABOVE:(x>box.width-range)?TARGET_BELOW:TARGET_MIDDLE;}else{y=y-box.top;range=getTargetEdgeRange.call(this,tgtInfo,direction,sidebyside,widget);edge=(y<range)?TARGET_ABOVE:(y>box.height-range)?TARGET_BELOW:TARGET_MIDDLE;}}return edge;}function inPoly(poly,px,py){var npoints=poly.length,inside=false,xnew,ynew,xold,yold,x1,y1,x2,y2,i;if(npoints/2<3){return false;}xold=poly[npoints-2];yold=poly[npoints-1];for(i=0;i<npoints;i=i+2){xnew=poly[i];ynew=poly[i+1];if(xnew>xold){x1=xold;x2=xnew;y1=yold;y2=ynew;}else{x1=xnew;x2=xold;y1=ynew;y2=yold;}if(xnew===xold&&ynew===yold){continue;}if((xnew<px)===(px<=xold)&&((py-y1)*(x2-x1)<(y2-y1)*(px-x1))){inside=!inside;}xold=xnew;yold=ynew;}return inside;}function batchSelectCharts(selections){var i,j,m,node,att,elements,n=selections.length,widget=this.widget,manager=widget.manager,headers,headerCount,headerIndex;this.selectedTargets=this.selectedTargets||[];for(i=0;i<n;i++){node=selections[i];if(node.byRow){manager.toggleClsByRows(node.start,node.end,node.depth,true,"selected");this.highlightedRows.push({start:node.start,end:node.end});headers=manager.filterRowHeaders(node.start,node.end,node.depth,CTRL_TYPE.GM_ROW_HEADER);headerCount=headers.length;for(headerIndex=0;headerIndex<headerCount;headerIndex++){this.selectedTargets.push(headers[headerIndex]);this.selectBorders(headers[headerIndex]);}}else{manager.toggleClsByCols(node.start,node.end,node.depth,true,"selected");this.highlightedCols.push({start:node.start,end:node.end});headers=manager.filterColHeaders(node.start,node.end,node.depth,CTRL_TYPE.GM_COL_HEADER);headerCount=headers.length;for(headerIndex=0;headerIndex<headerCount;headerIndex++){this.selectedTargets.push(headers[headerIndex]);this.selectBorders(headers[headerIndex]);}}att=node.att;elements=node.elements;if(att&&elements){for(j=0,m=elements.length;j<m;j++){widget.addAttributeSelection(att,elements[j].id,elements[j].n);}}}}function isShapeSelected(shape){return shape.getAttribute("status")===SHAPE_STAT.SELECTED;}function isShapeSH(shape){return shape.getAttribute("status")===SHAPE_STAT.SH;}function createRectDecorator(shape){if(shape.getAttribute("size")==="small"){if(shape.getAttribute("class")==="gm-shape-bar hover"){shape.setAttribute("class","gm-shape-bar small hover");}return undefined;}var decorator=document.createElementNS("http://www.w3.org/2000/svg","rect"),x=parseFloat(shape.getAttribute("x")),y=parseFloat(shape.getAttribute("y")),w=parseFloat(shape.getAttribute("width")),h=parseFloat(shape.getAttribute("height"));decorator.setAttribute("class",shape.getAttribute("subtype")===SHAPE_SUBTYPE.SQUARE?"gm-marker-square":"gm-marker-bar");decorator.setAttribute("type","marker");decorator.setAttribute("x",x+1.5);decorator.setAttribute("y",y+1.5);decorator.setAttribute("width",w-3);decorator.setAttribute("height",h-3);decorator.identity=shape.identity;return decorator;}function createSVGCircle(iX,iY,iR,shrink){var circle=document.createElementNS("http://www.w3.org/2000/svg","circle");circle.setAttribute("cx",iX);circle.setAttribute("cy",iY);circle.setAttribute("r",iR-shrink);return circle;}function createCircleDecorator(shape){if(shape.getAttribute("size")==="small"){return undefined;}var cx=parseFloat(shape.getAttribute("cx")),cy=parseFloat(shape.getAttribute("cy")),r=parseFloat(shape.getAttribute("r")),decorator=createSVGCircle(cx,cy,r,1.5);decorator.setAttribute("class","gm-marker-circle");decorator.setAttribute("type","marker");decorator.identity=shape.identity;return decorator;}function isCircle(shape){return shape.nodeName==="circle";}function createPieDecorator(shape){if(shape.getAttribute("size")==="small"){return undefined;}var decorator;if(isCircle(shape)){decorator=createSVGCircle(shape.sX,shape.sY,shape.sR,2);}else{decorator=document.createElementNS("http://www.w3.org/2000/svg","path");var pointStr=getPiePointString(shape,2);if(pointStr!==""){decorator.setAttribute("d",pointStr);}}decorator.setAttribute("class","gm-marker-pie");decorator.setAttribute("type","marker");decorator.identity=shape.identity;return decorator;}function createOuterLineDecorator(shape){if(shape.getAttribute("size")==="small"){return undefined;}var decorator=document.createElementNS("http://www.w3.org/2000/svg","path"),pointStr=getLinePointString(shape,0.5);decorator.setAttribute("class","gm-marker-outer-line");decorator.setAttribute("type","marker");if(pointStr!==""){decorator.setAttribute("d",pointStr);}decorator.identity=shape.identity;return decorator;}function createInnerLineDecorator(shape){if(shape.getAttribute("size")==="small"){return undefined;}var decorator=document.createElementNS("http://www.w3.org/2000/svg","path"),pointStr=getLinePointString(shape,2);decorator.setAttribute("class","gm-marker-inner-line");decorator.setAttribute("type","marker");if(pointStr!==""){decorator.setAttribute("d",pointStr);}decorator.identity=shape.identity;return decorator;}function createRingDecorator(shape){if(shape.getAttribute("size")==="small"){return undefined;}var decorator=document.createElementNS("http://www.w3.org/2000/svg","path"),pointStr=getRingPointString(shape,2);decorator.setAttribute("class","gm-marker-ring");decorator.setAttribute("type","marker");decorator.setAttribute("d",pointStr);decorator.identity=shape.identity;return decorator;}function createSCircleDecorator(shape){if(shape.getAttribute("size")==="small"){return undefined;}var decorator=document.createElementNS("http://www.w3.org/2000/svg","circle"),cx=parseFloat(shape.getAttribute("cx")),cy=parseFloat(shape.getAttribute("cy")),r=parseFloat(shape.getAttribute("r"));decorator.setAttribute("class","gm-marker-scircle");decorator.setAttribute("type","marker");decorator.setAttribute("cx",cx);decorator.setAttribute("cy",cy);decorator.setAttribute("r",r-2);decorator.identity=shape.identity;return decorator;}function hCreateGenericPolygon(iPoints){var i,polygon=svgops.createSVGElement("polygon"),numOfPoints=iPoints.length,pointsStr="";for(i=0;i<numOfPoints;++i){pointsStr+=(iPoints[i].x+","+iPoints[i].y+" ");}polygon.setAttribute("points",pointsStr);return polygon;}function Vec2d(x,y){this.x=x;this.y=y;}var proto=Vec2d.prototype;proto.dot=function(p){return this.x*p.x+this.y*p.y;};proto.add=function(p){return new Vec2d(this.x+p.x,this.y+p.y);};proto.diff=function(p){return new Vec2d(this.x-p.x,this.y-p.y);};proto.length=function(){return Math.sqrt(this.dot(this));};proto.normalize=function(){var len=this.length();this.x/=len;this.y/=len;return this;};proto.scale=function(lambda){return new Vec2d(this.x*lambda,this.y*lambda);};proto.isInPolygon=function(iPolygon){var nEdges=iPolygon.length,bResult=false,i,j;if(nEdges<3){return false;}for(i=0,j=nEdges-1;i<nEdges;j=i++){if(((iPolygon[i].y<=this.y&&this.y<iPolygon[j].y)||(iPolygon[j].y<=this.y&&this.y<iPolygon[i].y))&&this.x<=(iPolygon[j].x-iPolygon[i].x)*(this.y-iPolygon[i].y)/(iPolygon[j].y-iPolygon[i].y)+iPolygon[i].x){bResult=!bResult;}}return bResult;};function shrinkPolygon(points,shrink){shrink=shrink||2.5;var i=0,len=points.length,originVerticePos=[],newVerticePos=[],prev,cur,next,cosTheta,sinHalfTheta;for(i=0;i<len;i++){originVerticePos.push(new Vec2d(points[i].x,points[i].y));}for(i=0,len=originVerticePos.length;i<len;i++){cur=originVerticePos[i];prev=originVerticePos[i===0?len-1:i-1];next=originVerticePos[i===len-1?0:i+1];var V1=prev.diff(cur);var V2=next.diff(cur);V1.normalize();V2.normalize();cosTheta=V1.dot(V2);sinHalfTheta=Math.sqrt((1-cosTheta)/2);var scale=shrink/sinHalfTheta;var unitDir=V1.add(V2).normalize();var pos=cur.add(unitDir.scale(scale));if(!pos.isInPolygon(originVerticePos)){pos=cur.add(unitDir.scale(-1*scale));}newVerticePos.push(pos);}return newVerticePos;}function createSBarDecorator(shape){if(shape.tagName==="circle"){return createCircleDecorator(shape);}var decorator=svgops.createSVGElement("g"),points=shape.points;decorator.setAttribute("type","gm-group-decorator");var decoratorOutter=hCreateGenericPolygon(points);decoratorOutter.setAttribute("class","gm-outter-decorator");decorator.appendChild(decoratorOutter);if(shape.getAttribute("size")==="small"){return decorator;}points=shrinkPolygon(points,2.5);var decoratorInner=hCreateGenericPolygon(points);decoratorInner.setAttribute("class","gm-inner-decorator");decorator.appendChild(decoratorInner);return decorator;}function getDecorator(shape,subType){var decorator=shape.decorator;if(decorator){return decorator;}if(!subType){subType=shape.getAttribute("subtype");}switch(subType){case SHAPE_SUBTYPE.BAR:case SHAPE_SUBTYPE.GBAR:case SHAPE_SUBTYPE.SQUARE:decorator=createRectDecorator(shape);break;case SHAPE_SUBTYPE.SCIRCLE:decorator=createSCircleDecorator(shape);break;case SHAPE_SUBTYPE.CIRCLE:decorator=createCircleDecorator(shape);break;case SHAPE_SUBTYPE.PIE:decorator=createPieDecorator(shape);break;case SHAPE_SUBTYPE.RING:decorator=createRingDecorator(shape);break;case SHAPE_SUBTYPE.SBAR:decorator=createSBarDecorator(shape);break;case SHAPE_SUBTYPE.TICKER:break;}if(decorator){decorator.source=shape;shape.decorator=decorator;}return decorator;}function updateShapeBar(shape,trans){var x=parseFloat(shape.getAttribute("x")),y=parseFloat(shape.getAttribute("y")),w=parseFloat(shape.getAttribute("width")),h=parseFloat(shape.getAttribute("height")),sw=parseInt(shape.style.strokeWidth,10);if(shape.getAttribute("size")==="small"){switch(trans){case SHAPE_STAT_TRANS.NORMAL2HOVER:case SHAPE_STAT_TRANS.SELECTED2HOVER:shape.setAttribute("x",x-sw/2);shape.setAttribute("y",y-sw/2);shape.setAttribute("width",w+sw);shape.setAttribute("height",h+sw);break;case SHAPE_STAT_TRANS.HOVER2NORMAL:case SHAPE_STAT_TRANS.HOVER2SELECTED:shape.setAttribute("x",x+sw/2);shape.setAttribute("y",y+sw/2);shape.setAttribute("width",w-sw);shape.setAttribute("height",h-sw);break;default:break;}return ;}switch(trans){case SHAPE_STAT_TRANS.NORMAL2HOVER:case SHAPE_STAT_TRANS.NORMAL2SELECTED:shape.setAttribute("x",x+0.5);shape.setAttribute("y",y+0.5);shape.setAttribute("width",w-1);shape.setAttribute("height",h-1);shape.style.strokeWidth=sw+1;break;case SHAPE_STAT_TRANS.HOVER2NORMAL:case SHAPE_STAT_TRANS.SELECTED2NORMAL:shape.setAttribute("x",x-0.5);shape.setAttribute("y",y-0.5);shape.setAttribute("width",w+1);shape.setAttribute("height",h+1);shape.style.strokeWidth=sw-1;break;default:break;}}function updateShapeSCircle(shape,trans){var parent=shape.parentNode,decorator=getDecorator(shape);switch(trans){case SHAPE_STAT_TRANS.NORMAL2HOVER:case SHAPE_STAT_TRANS.NORMAL2SELECTED:if(parent&&decorator){parent.appendChild(decorator);}break;case SHAPE_STAT_TRANS.HOVER2NORMAL:case SHAPE_STAT_TRANS.SELECTED2NORMAL:if(parent&&decorator){parent.removeChild(decorator);}break;default:break;}}function updateDecorator(shape,trans){var parent=shape.parentNode,decorator=getDecorator(shape);if(shape.tagName==="polygon"&&shape.getAttribute("subtype")===SHAPE_SUBTYPE.SBAR){parent=parent.parentNode;if(!parent){return ;}switch(trans){case SHAPE_STAT_TRANS.NORMAL2SELECTED:case SHAPE_STAT_TRANS.NORMAL2HOVER:if(decorator&&parent){parent.appendChild(decorator);}break;case SHAPE_STAT_TRANS.SELECTED2NORMAL:case SHAPE_STAT_TRANS.HOVER2NORMAL:if(decorator){parent.removeChild(decorator);}break;}}else{if(!parent){return ;}switch(trans){case SHAPE_STAT_TRANS.NORMAL2SELECTED:case SHAPE_STAT_TRANS.HOVER2SELECTED:if(decorator){parent.appendChild(decorator);}break;case SHAPE_STAT_TRANS.SELECTED2NORMAL:case SHAPE_STAT_TRANS.SELECTED2HOVER:if(decorator){parent.removeChild(decorator);}break;}}}function updateShapePie(shape,trans){var sd=shape.sd,sD=shape.sD;switch(trans){case SHAPE_STAT_TRANS.NORMAL2SELECTED:case SHAPE_STAT_TRANS.HOVER2SELECTED:if(isCircle(shape)){shape.setAttribute("r",shape.sR-0.5);}else{if(!sd){sd=getPiePointString(shape,0.5);shape.sd=sd;}shape.setAttribute("d",sd);}shape.style.strokeWidth=2;break;case SHAPE_STAT_TRANS.SELECTED2NORMAL:case SHAPE_STAT_TRANS.SELECTED2HOVER:if(isCircle(shape)){shape.setAttribute("r",shape.sR);}else{if(!sD){sD=getPiePointString(shape,0);shape.sD=sD;}shape.setAttribute("d",sD);}shape.style.strokeWidth=1;break;default:break;}}function reorderShape(shape){var groupNode=shape.parentNode,svgNode=groupNode&&groupNode.parentNode,circleNodes=[],gmCtr=this.widget.GMController,chartInfo=gmCtr.getChartInfo(),needAdjustGroupPosition=chartInfo.isABL&&(chartInfo.shape===SHAPE_TYPE.CIRCLE||chartInfo.shape===SHAPE_TYPE.PIE||chartInfo.shape===SHAPE_TYPE.RING||chartInfo.shape===SHAPE_TYPE.SQUARE);var adjustGroupPosition=function(){svgNode.removeChild(groupNode);var len=svgNode.childNodes.length,lastNode=len>0&&svgNode.childNodes[len-1],hasTextNode=lastNode.childNodes.length>0&&lastNode.childNodes[0].nodeName==="text";if(hasTextNode){svgNode.insertBefore(groupNode,lastNode);}else{svgNode.appendChild(groupNode);}};if(!groupNode||!svgNode){return ;}switch(shape.getAttribute("subtype")){case SHAPE_SUBTYPE.SQUARE:case SHAPE_SUBTYPE.SCIRCLE:if(needAdjustGroupPosition){adjustGroupPosition();}break;case SHAPE_SUBTYPE.PIE:case SHAPE_SUBTYPE.RING:case SHAPE_SUBTYPE.CIRCLE:if(needAdjustGroupPosition){adjustGroupPosition();}[].slice.call(groupNode.childNodes).forEach(function(node){if(node.sX===shape.sX&&node.sY===shape.sY){circleNodes.push(node);}});circleNodes.forEach(function(node){groupNode.removeChild(node);});circleNodes.forEach(function(node){groupNode.appendChild(node);});break;}return ;}function setShapeStatus(shape,status){if(!shape){return ;}var prevStatus=shape.getAttribute("status")||SHAPE_STAT.NORMAL;if(status===prevStatus){return ;}var trans=getStatusTransform(prevStatus,status);updateShapeClass(shape,trans);switch(shape.getAttribute("subtype")){case SHAPE_SUBTYPE.BAR:updateShapeBar(shape,trans);updateDecorator(shape,trans);break;case SHAPE_SUBTYPE.SCIRCLE:updateShapeSCircle(shape,trans);break;case SHAPE_SUBTYPE.GBAR:case SHAPE_SUBTYPE.SQUARE:case SHAPE_SUBTYPE.SBAR:case SHAPE_SUBTYPE.TICKER:updateDecorator(shape,trans);break;default:break;}shape.setAttribute("status",status);}function hSetTargetStatus(target,status){if(!target){return ;}var prevStatus=target.getAttribute("status")||SHAPE_STAT.NORMAL;if(status===prevStatus){return ;}var trans=getStatusTransform(prevStatus,status);updateShapeClass(target,trans);target.setAttribute("status",status);}function showContextMenu(pos,menuData){var widget=this.widget,ph=this.domMenuPH,_this=this;ph.innerHTML="";document.body.appendChild(ph);widget.configurePopup(menuData,ph);widget.menuEditor=menuData.newInstance({locksHover:false,unrender:function(){}});widget.menuEditorClosefn=function(evt){var target=evt.target,menuRoot=widget.menuEditor.domNode;if(!$DOM.contains(menuRoot,target,true,menuRoot)&&!$VISUTIL.isHostedPopupNode(target,"class",true,document.body)){if(widget.toolEditor){var toolbarRoot=widget.toolEditor.domNode;if(!$DOM.contains(toolbarRoot,target,true,toolbarRoot)){_this.hideContextMenu();}}else{_this.hideContextMenu();}}};$DOM.attachEvent(document.body,"mousedown",widget.menuEditorClosefn,true);widget.openPopup(widget.menuEditor);}function showToolBar(pos,toolbarData){var widget=this.widget,ph=this.domToolbarPH,_this=this;widget._lastOpened=null;ph.innerHTML="";document.body.appendChild(ph);$CSS.toggleClass(ph,mstrApp.getThemeClassName(),true);widget.configurePopup(toolbarData,ph);widget.toolEditor=toolbarData.newInstance({unrender:function(){}});widget.toolEditorClosefn=function(evt){var target=evt.target,toolbarRoot=widget.toolEditor.domNode;if(!$DOM.contains(toolbarRoot,target,true,toolbarRoot)&&!$VISUTIL.isHostedPopupNode(target,"class",true,document.body)){if(widget.menuEditor){var menuRoot=widget.menuEditor.domNode;if(!$DOM.contains(menuRoot,target,true,menuRoot)){_this.hideToolbar();}}else{_this.hideToolbar();}}};$DOM.attachEvent(document.body,"mousedown",widget.toolEditorClosefn,true);widget.openPopup(widget.toolEditor);$CSS.toggleClass(document.body,"hasToolbarPopup",true);}function showToolbarByFormat(pos,toolbarData){var widget=this.widget,ph=this.domToolbarPH,_this=this;if(widget._lastOpened){widget.closePopup();}widget._lastOpened=null;ph.style.top=pos.y+"px";ph.style.left=pos.x+"px";ph.innerHTML="";document.body.appendChild(ph);$CSS.toggleClass(ph,mstrApp.getThemeClassName(),true);widget.configurePopup(toolbarData,ph);widget.toolEditor=toolbarData.newInstance({unrender:function(){}});widget.toolEditorClosefn=function(evt){var target=evt.target,toolbarRoot=widget.toolEditor.domNode;if(!$DOM.contains(toolbarRoot,target,true,toolbarRoot)&&!$VISUTIL.isHostedPopupNode(target,"class",true,document.body)){if(widget.menuEditor){var menuRoot=widget.menuEditor.domNode;if(!$DOM.contains(menuRoot,target,true,menuRoot)){_this.hideToolbar();}}else{_this.hideToolbar();}}};$DOM.attachEvent(document.body,"mousedown",widget.toolEditorClosefn,true);widget.openPopup(widget.toolEditor);$CSS.toggleClass(document.body,"hasToolbarPopup",true);}function getFormatPropertyValue(widget,propName,scope,levelSelection){var rst;if(levelSelection===undefined){if(scope===EnumControlScope.GLOBAL){if(propName===$ENUM_FORMAT_TAG.BG_COLOR){rst=widget.getFormats()["background-color"];}else{rst=widget.readGlobalProperty(propName);}}else{if(scope===EnumControlScope.FORMATTING){rst=widget.getPropertiesOfFormatable();}}}else{rst=widget.readGlobalProperty(levelSelection.realPropName,levelSelection.opt);}if(typeof rst==="object"&&rst.jsonObj){rst=rst.jsonObj[propName];}if(propName.slice(-3)===EnumFormatPropSubName.COLOR&&propName!==$ENUM_FORMAT_TAG.BG_COLOR){rst=GMUTIL.decodeColor(rst);}return rst;}function getChangeFormatPropertyFn(widget,propName,scope,levelSelection){if(levelSelection!==undefined){return function(newValue){var valueCollection=widget.readGlobalProperty(levelSelection.realPropName,levelSelection.opt),currentVal=valueCollection.jsonObj[propName];if(propName.indexOf(EnumFormatPropSubName.COLOR)!==-1){newValue=GMUTIL.encodeColor(newValue);}if(newValue!==currentVal){valueCollection.setProperty(propName,newValue);widget.writeGlobalProperty(levelSelection.realPropName,valueCollection,levelSelection.opt);}};}if(scope===EnumControlScope.GLOBAL){return function(newValue){var currentVal=getFormatPropertyValue(widget,propName,EnumControlScope.GLOBAL);if(newValue!==currentVal){if(propName.indexOf(EnumFormatPropSubName.COLOR)!==-1){newValue=GMUTIL.encodeColor(newValue);}widget.writeGlobalProperty(propName,newValue);}};}return function(newValue){var currentVal=getFormatPropertyValue(widget,propName,EnumControlScope.FORMATTING),firstEquality=GMUTIL.checkEquality(newValue,currentVal);if(!firstEquality){if(propName.indexOf(EnumFormatPropSubName.COLOR)!==-1){newValue=GMUTIL.encodeColor(newValue);}var propV=widget.getPropertiesOfFormatable();if(propV&&propV.jsonObj&&!GMUTIL.checkEquality(propV.jsonObj[propName],newValue)){propV.setProperty(propName,newValue);widget.writeFormatableProperties(propV);}}};}function getRowContainer(children,rowContainerCSSClass){children=children||[];rowContainerCSSClass=rowContainerCSSClass||"";$ARR.forEach(children,function(child){child.cssDisplay="inline-block";});return{scriptClass:"mstrmojo.HBox",cssClass:rowContainerCSSClass,children:children};}function getLabelBox(children,labelcss){return new mstrmojo.Box({children:children||[],cssText:labelcss});}function getLabelAndControlBox(labelText,control,reverseOrder,rowContainerCSSClass){var label=new mstrmojo.Label({text:labelText}),labelBox=getLabelBox(label,"white-space: nowrap; margin-right:9px;");var children=[labelBox,control];if(reverseOrder){children=[control,labelBox];}return getRowContainer(children,rowContainerCSSClass);}function getGroupCompProps(widget,props,childrenNames,scope,levelSelection){props=props||{};if(props.propNames===undefined){props.propNames=childrenNames;}if(props.onGroupValueChange===undefined){props.onGroupValueChange=function(propertyName,newValue,oldValue){if(newValue!==oldValue&&newValue!==undefined){if(propertyName===$ENUM_FORMAT_TAG.BG_COLOR){$VISUTIL.changeWidgetBackground(widget,newValue,oldValue);}else{getChangeFormatPropertyFn(widget,propertyName,scope,levelSelection).call(this,newValue,oldValue);}}};}return props;}function initPropValueToControl(widget,control,childrenNames,scope,levelSelection){$ARR.forEach(childrenNames,function(childName){var val=getFormatPropertyValue(widget,childName,scope,levelSelection);control.syncControls(function(){control.setChildValue(childName,val);});});}function getLineConfigComp(widget,label,childrenNames,scope,levelSelection,props){props=getGroupCompProps(widget,props,childrenNames,scope,levelSelection);$HASH.copy({cssClass:"mstrmojo-ui-ToolBarLineGroup",layoutConfig:null,width:props.width||"125px",showNoFillInColor:false},props);var control=new mstrmojo.ui.editors.controls.LineConfigGroup(props);if(control){control.height="22px;";control.iniChildrenComp(childrenNames);initPropValueToControl(widget,control,childrenNames,scope,levelSelection);}if(typeof label==="string"){return getLabelAndControlBox(label,control,false,(props||[]).rowContainerCSSClass);}return control;}function getFillConfigComp(widget,label,childrenNames,scope,props){props=getGroupCompProps(widget,props,childrenNames,scope);$HASH.copy({width:props.width||"140px",height:"22px",colorPickerHostWithin:true},props);var control=new mstrmojo.ui.editors.controls.FillConfigGroup(props);if(control){control.iniChildrenComp(childrenNames);initPropValueToControl(widget,control,childrenNames,scope);if(control.children[0]&&control.children[0].children[0]){GMUTIL.initColorPickerBtnWithGradientDir(control.children[0].children[0],widget);}}if(typeof label==="string"){return getLabelAndControlBox(label,control);}return control;}function getBorderAndFillEditor(widget,lineChildrenNames,fillChildrenNames,scope,shapeType){var colorByDropZone=widget.model.data.dz.ColorBy,lineConfig=getLineConfigComp(widget,mstrmojo.desc(9736,"Border"),lineChildrenNames,scope,undefined,{rowContainerCSSClass:"mstrmojo-ui-rowContainer",showNoneOption:false}),fillConfig=getFillConfigComp(widget,mstrmojo.desc(2885,"Fill"),fillChildrenNames,scope,{onGroupValueChange:function(propertyName,newValue,oldValue){if(newValue!==oldValue&&newValue!==undefined){var snColorNotSet="shpBdrClr_default",valueCollection=widget.getPropertiesOfFormatable(),isDefaultColor=valueCollection.jsonObj[snColorNotSet];if(colorByDropZone.TemplateUnit&&propertyName===$ENUM_FORMAT_TAG.SHAPE_FILL_COLOR&&isDefaultColor){lineConfig.children[1].syncControls(function(){this.setChildValue($ENUM_FORMAT_TAG.SHAPE_BORDER_COLOR,newValue);});}getChangeFormatPropertyFn(widget,propertyName,scope).call(this,newValue,oldValue);}},showGradient:widget.interactor.isShowGradientAllowed(shapeType)});return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-ToolbarBorderAndFill",children:[fillConfig,lineConfig]}]});}function getLineToolbar(widget,label,childrenNames,scope,levelSelection,props){return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.vi.ui.editors.EditorGroup",showDivider:false,children:[getLineConfigComp(widget,label,childrenNames,scope,levelSelection,props)]}]});}function getFillToolbar(widget,label,childrenNames,scope,props){return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.vi.ui.editors.EditorGroup",showDivider:false,children:[getFillConfigComp(widget,label,childrenNames,scope,props)]}]});}function getFillOpacityAndBorderStyleToolbar(widget){return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-FillOpacityAndBorderStyleToolbar",children:[getFillConfigComp(widget,mstrmojo.desc(13658,"Fill Opacity"),[$ENUM_FORMAT_TAG.SHAPE_FILL_TRANSPARENCY],EnumControlScope.FORMATTING,{width:"60px",visibleControls:mstrmojo.ui.editors.controls.FillConfigGroup.CTRL_FLAGS.FILL_TRANSPARENCY}),getLineConfigComp(widget,mstrmojo.desc(3538,"Border Style"),[$ENUM_FORMAT_TAG.SHAPE_BORDER_COMBINED_STYLE],EnumControlScope.FORMATTING,undefined,{width:"60px",hideColorControl:true,rowContainerCSSClass:"mstrmojo-ui-rowContainer"})]}]});}function getColorPicker(colorPickerType,widget,childrenNames,scope,props,showGradient){var selectedValue=getFormatPropertyValue(widget,childrenNames,scope),defaultProps={showGradient:!!showGradient,isHostedWithin:true,width:"40px",selectedValue:selectedValue,postselectedValueChange:function(evt){getChangeFormatPropertyFn(widget,childrenNames,scope).call(this,evt.value,evt.valueWas);}};colorPickerType=colorPickerType||"ColorPickerButton";props=$HASH.copy(defaultProps,props);return new mstrmojo.ui.editors.controls[colorPickerType](props);}function getMarkerColorPickerCfg(widget,shapeColor,checkboxLabel){var props={sourceColor:shapeColor,checkboxLabel:checkboxLabel},colorPicker=getColorPicker("MarkerColorPickerButton",widget,$ENUM_FORMAT_TAG.LINE_MARKER_COLOR,EnumControlScope.FORMATTING,props);return getLabelAndControlBox(mstrmojo.desc(6242,"Color"),colorPicker);}function getColorPickerCfg(widget,alias,label,childrenNames,scope,showGradient){var props={alias:alias},colorPicker=getColorPicker("ColorPickerButton",widget,childrenNames,scope,props,showGradient);if(typeof label==="string"){return getLabelAndControlBox(label,colorPicker);}return colorPicker;}function getColorpickerToolbar(widget,childrenNames,scope,colorPickerProps){var colorObj=widget.readGlobalProperty(childrenNames),currentColor=colorObj.color,_this=widget.interactor;return new mstrmojo.ui.menus.ToolbarEditorConfig({cssClass:"cbsquare-colorpicker",contents:[new mstrmojo.ui.editors.controls.AdvancedColorPicker($HASH.copy(colorPickerProps,{color:colorObj.isDefaultColor?$ACP.VAL_AUTOMATIC:currentColor,autoPreviewColor:colorObj.isDefaultColor?currentColor:null,colorChanged:function(color){color=(this.showAutomatic&&color===$ACP.VAL_AUTOMATIC)?VAL_CLEAR:color;getChangeFormatPropertyFn(widget,childrenNames,scope).call(this,color,currentColor);_this.hideToolbar();},colorCanceled:function(){_this.hideToolbar();},showPickerForCurrentMode:function showPickerForCurrentMode(){mstrmojo.ui.editors.controls.AdvancedColorPicker.prototype.showPickerForCurrentMode.call(this);if(this.pickerMode===2&&typeof this.color!=="object"){var gradientDir=this.gradientOrientation,isVerticalGraph=widget.getChartInfo().dirc===$GM.EnumABLDirection.VERTICAL;gradientDir.set("selectedIndex",$ARR.find(gradientDir.items,"id",isVerticalGraph?0:1));}}}))]});}function getColorByKey(colorByInfo,docModel){var levelIDs=[],elementIDs=[];$ARR.forEach(colorByInfo,function(item){levelIDs.push(item.tid);elementIDs.push(item.eid);});return docModel.getColorBy(levelIDs,elementIDs);}function getTrdRefColorPickerPopup(widget,propName,levelSelection,valueCollection,showNoFill){var currentVal=valueCollection.jsonObj[propName];return new mstrmojo.ui.menus.PopupConfig({contents:[new mstrmojo.ui.editors.controls.AdvancedColorPicker({color:GMUTIL.decodeColor(currentVal),showNoFill:showNoFill,colorChanged:function(color){var newColor=GMUTIL.encodeColor(color);if(newColor!==currentVal){valueCollection.setProperty(propName,newColor);valueCollection.opt=levelSelection.opt;widget.writeGlobalProperty(levelSelection.realPropName,valueCollection,levelSelection.opt);widget.raiseEventFormatableChanged();}this.parent.popupConfig.close();},colorCanceled:function(){this.parent.popupConfig.close();}})]});}function getColorPickerPopup(widget,target,colorByDropZone,colorPickerProps){var docModel,colorByInfo,selectedColor,isManualColor=false,updateColorBy;if(colorByDropZone.TemplateUnit||colorByDropZone.MetricNames!==undefined){updateColorBy=true;docModel=(widget.getDocModel&&widget.getDocModel())||widget.model.docModel;colorByInfo=target.identity.getSelectedObjectColorByInfo();var colorbyKey=getColorByKey(colorByInfo,docModel);selectedColor=colorbyKey.color;isManualColor=colorbyKey.isManual;}else{updateColorBy=false;selectedColor=widget.readGlobalProperty($ENUM_FORMAT_TAG.SHAPE_FILL_COLOR);}var decodedClr=GMUTIL.decodeColor(selectedColor);return new mstrmojo.ui.menus.PopupConfig({contents:[new mstrmojo.ui.editors.controls.AdvancedColorPicker($HASH.copy(colorPickerProps,{color:isManualColor?decodedClr:$ACP.VAL_AUTOMATIC,autoPreviewColor:isManualColor?null:decodedClr,colorChanged:function(color){var newColor=(this.showAutomatic&&color===$ACP.VAL_AUTOMATIC)?VAL_CLEAR:GMUTIL.encodeColor(color);if(newColor!==selectedColor){if(updateColorBy){widget.updateColorByMap([colorByInfo],newColor);}else{getChangeFormatPropertyFn(widget,$ENUM_FORMAT_TAG.SHAPE_FILL_COLOR,EnumControlScope.FORMATTING).call(this,color);}}this.parent.popupConfig.close();},colorCanceled:function(){this.parent.popupConfig.close();},showPickerForCurrentMode:function showPickerForCurrentMode(){mstrmojo.ui.editors.controls.AdvancedColorPicker.prototype.showPickerForCurrentMode.call(this);var popup=this.parent,fnUpdatePopupPos=function fnUpdatePopupPos(){popup.adjustCornersForPopupOverflow();};if(this.pickerMode===2){this.colorStyle.markupMethods=$HASH.copy({onselectedIndexChange:fnUpdatePopupPos},$HASH.copy(this.colorStyle.markupMethods));}if(this.pickerMode===2&&typeof this.color!=="object"){var gradientDir=this.gradientOrientation,isVerticalGraph=widget.getChartInfo().dirc===$GM.EnumABLDirection.VERTICAL;gradientDir.set("selectedIndex",$ARR.find(gradientDir.items,"id",isVerticalGraph?0:1));}fnUpdatePopupPos();}}))]});}function getCharacterGroupRefreshFn(control,prefixStr,widget){var formats={},fontStyleVal=getFormatPropertyValue(widget,prefixStr+EnumFormatPropSubName.FONT_STYLE,EnumControlScope.GLOBAL),fontColorVal=getFormatPropertyValue(widget,prefixStr+EnumFormatPropSubName.FONT_COLOR,EnumControlScope.GLOBAL),fontFamilyVal=getFormatPropertyValue(widget,prefixStr+EnumFormatPropSubName.FONT_FAMILY,EnumControlScope.GLOBAL),fontSizeVal=getFormatPropertyValue(widget,prefixStr+EnumFormatPropSubName.FONT_SIZE,EnumControlScope.GLOBAL);if(fontStyleVal!==undefined){formats[$ENUM_FORMAT_PROPERTIES.FONT_WEIGHT]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_BOLD)>0));formats[$ENUM_FORMAT_PROPERTIES.FONT_STYLE]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_ITALIC)>0));formats[$ENUM_FORMAT_PROPERTIES.UNDERLINE]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_UNDERLINE)>0));formats[$ENUM_FORMAT_PROPERTIES.LINE_THROUGH]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_STRIKETHROUGH)>0));}formats[$ENUM_FORMAT_PROPERTIES.COLOR]=fontColorVal!==undefined?fontColorVal:-1;formats[$ENUM_FORMAT_PROPERTIES.FONT_SIZE]=fontSizeVal!==undefined?fontSizeVal:-1;formats[$ENUM_FORMAT_PROPERTIES.FONT_FAMILY]=fontFamilyVal!==undefined?fontFamilyVal:-1;control.setFormatSource(formats);}function initCharacterGroupComp(widget,control,childrenNames,scope){var fontStyleValueMap={bold:$ENUM_FONT_STYLE_VALUE.FS_BOLD,italic:$ENUM_FONT_STYLE_VALUE.FS_ITALIC,underline:$ENUM_FONT_STYLE_VALUE.FS_UNDERLINE,strikeout:$ENUM_FONT_STYLE_VALUE.FS_STRIKETHROUGH};childrenNames.forEach(function(childName){var comp=null;if(childName.indexOf(EnumFormatPropSubName.FONT_STYLE)>-1){comp=control.fontStyle;comp.postselectionChange=function(evt){var added=evt.added,item=this.items[(added&&added[0]!==undefined)?added[0]:evt.removed[0]],isSelected=!!added,oldValue=getFormatPropertyValue(widget,childName,scope),newValue=(oldValue===undefined?0:oldValue);if(isSelected){newValue=newValue|fontStyleValueMap[item.css];}else{newValue=newValue&(~fontStyleValueMap[item.css]);}this.parent.raiseFormatValueChange(childName,newValue,oldValue);};}else{if(childName.indexOf(EnumFormatPropSubName.FONT_FAMILY)>-1){comp=control.fontFamily;comp.postselectedIndexChange=function(evt){var newValue=evt.value,oldValue=evt.valueWas;if(newValue!==oldValue){var items=this.items;this.parent.raiseFormatValueChange(childName,items[newValue].id,items[oldValue]&&items[oldValue].id);}};}else{if(childName.indexOf(EnumFormatPropSubName.FONT_SIZE)>-1){comp=control.fontSize;comp.postselectedValueChange=function(evt){var newValue=parseInt(evt.value,10)+"pt",oldValue=parseInt(evt.valueWas,10)+"pt";if(newValue!==oldValue){this.parent.parent.raiseFormatValueChange(childName,newValue,oldValue);}};comp.validateTextInput=function(text,oldText){var value=parseInt(text,10);if(isNaN(value)){return oldText;}return value.toString();};}else{if(childName.indexOf(EnumFormatPropSubName.FONT_COLOR)>-1){comp=control.fontColor;comp.postselectedValueChange=function(evt){this.parent.parent.raiseFormatValueChange(childName,evt.value,evt.valueWas);};}}}}if(comp){comp.propName=childName;}});}function getCharacterConfigComp(widget,porpNamePrefix,childrenNames,scope,props,showNoFill){if(props===undefined){props={};}if(showNoFill!==undefined){props.showNoFillInColor=showNoFill;}props=$HASH.copy(widget.getFontToolbarProps(),props);if(props.propNames===undefined){props.propNames=childrenNames;}if(props.onGroupValueChange===undefined){props.onGroupValueChange=function(propertyName,newValue,oldValue){if(newValue!==oldValue&&newValue!==undefined){getChangeFormatPropertyFn(widget,propertyName,EnumControlScope.GLOBAL).call(this,newValue,oldValue);}};}var control=new mstrmojo.ui.editors.controls.CharacterGroup(props);initCharacterGroupComp(widget,control,childrenNames,scope);getCharacterGroupRefreshFn(control,porpNamePrefix,widget);return control;}function getFontToolbar(widget,porpNamePrefix,childrenNames,scope,props,showNoFill){return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.vi.ui.editors.EditorGroup",showDivider:false,children:[getCharacterConfigComp(widget,porpNamePrefix,childrenNames,scope,props,showNoFill)]}]});}function getMarkerColorpicker(widget,shapeColor,checkboxLabel){return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.HBox",children:[getMarkerColorPickerCfg(widget,shapeColor,checkboxLabel)]}]});}function getSelectionHash(candidate){var attIds=$HASH.keyarray(candidate).sort(),hashes=[],attValIds;attIds.forEach(function(attId){attValIds=[];candidate[attId].forEach(function(attVal){attValIds.push(attVal.id);});hashes.push(attId+"-"+attValIds.sort().join("@"));});return hashes.join("#");}function getColorByOrLowestInfo(shape,isColorBy){var i,n,identity=shape.identity,cbInfo,rtn={};if(isColorBy){cbInfo=identity.getSelectedObjectColorByInfo();}else{cbInfo=identity.getSelectedObjectLowestLevel(true);}for(i=0,n=cbInfo.length;i<n;i++){var unit=rtn[cbInfo[i].tid];if(unit===undefined){rtn[cbInfo[i].tid]=[{id:cbInfo[i].eid}];}else{unit.push({id:cbInfo[i].eid});}}rtn.hashKey=getSelectionHash(rtn);return rtn;}function getColorByInfo(shape){return getColorByOrLowestInfo.call(this,shape,true);}function getBreakByInfo(shape){return getColorByOrLowestInfo.call(this,shape,false);}function indexColorByInfo(selections,cbInfo){var i,item,n=selections.length;for(i=0;i<n;i++){item=selections[i];if(item.hashKey===cbInfo.hashKey){return i;}}return -1;}function isShape(type){return type===CTRL_TYPE.GM_SHAPE||type===CTRL_TYPE.MARKER;}function isOnRow(type){return type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_ROW_HEADER_TITLE||type===CTRL_TYPE.GM_ROW_HEADER_EXTRA;}function isRowHeader(type){return type===CTRL_TYPE.GM_ROW_HEADER_TITLE;}function isRowValue(type){return type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_ROW_HEADER_EXTRA;}function isOnCol(type){return type===CTRL_TYPE.GM_COL_HEADER||type===CTRL_TYPE.GM_COL_HEADER_TITLE||type===CTRL_TYPE.GM_COL_HEADER_EXTRA;}function isColHeader(type){return type===CTRL_TYPE.GM_COL_HEADER_TITLE;}function isColValue(type){return type===CTRL_TYPE.GM_COL_HEADER||type===CTRL_TYPE.GM_COL_HEADER_EXTRA;}function isMatrixLine(type){return type===CTRL_TYPE.GM_H_MATRIX_LINE||type===CTRL_TYPE.GM_V_MATRIX_LINE||type===CTRL_TYPE.GM_H_CHART_LINE||type===CTRL_TYPE.GM_V_CHART_LINE;}function isVMatrixLine(type){return type===CTRL_TYPE.GM_V_MATRIX_LINE||type===CTRL_TYPE.GM_V_CHART_LINE;}function isHMatrixLine(type){return type===CTRL_TYPE.GM_H_MATRIX_LINE||type===CTRL_TYPE.GM_H_CHART_LINE;}function isAxisLine(type){return type===CTRL_TYPE.GM_YAXIS_LINE||type===CTRL_TYPE.GM_XAXIS_LINE||type===CTRL_TYPE.GM_YAXIS2_LINE||type===CTRL_TYPE.GM_XAXIS2_LINE;}function isAxisOriginLine(type){return type===CTRL_TYPE.GM_ORIGIN_LINE;}function isAxisOriginLabel(type){return type===CTRL_TYPE.GM_ORIGIN_LABEL_V||type===CTRL_TYPE.GM_ORIGIN_LABEL_H;}function isTrendLIne(type){return type===CTRL_TYPE.GM_TREND_LINE;}function isReferenceLine(type){return type===CTRL_TYPE.GM_REF_LINE;}function isXAxisLine(type){return type===CTRL_TYPE.GM_XAXIS_LINE||type===CTRL_TYPE.GM_XAXIS2_LINE;}function isYAxisLine(type){return type===CTRL_TYPE.GM_YAXIS_LINE||type===CTRL_TYPE.GM_YAXIS2_LINE;}function isAxisTitle(type){return type===CTRL_TYPE.GM_XLABEL||type===CTRL_TYPE.GM_YLABEL;}function isNumeric(type){return type===CTRL_TYPE.GM_X_NUMERIC||type===CTRL_TYPE.GM_Y_NUMERIC;}function isAxisLabel(type){return type===CTRL_TYPE.GM_X_NUMERIC||type===CTRL_TYPE.GM_X_CATEGORY||type===CTRL_TYPE.GM_Y_NUMERIC||type===CTRL_TYPE.GM_Y_CATEGORY;}function isGridLine(type){return type===CTRL_TYPE.GM_H_GRID_LINE||type===CTRL_TYPE.GM_V_GRID_LINE||type===CTRL_TYPE.GM_H_MINOR_GRID_LINE||type===CTRL_TYPE.GM_V_MINOR_GRID_LINE;}function isMajorGridLine(type){return type===CTRL_TYPE.GM_H_GRID_LINE||type===CTRL_TYPE.GM_V_GRID_LINE;}function isMinorGridLine(type){return type===CTRL_TYPE.GM_H_MINOR_GRID_LINE||type===CTRL_TYPE.GM_V_MINOR_GRID_LINE;}function isDataLabel(type){return type===CTRL_TYPE.GM_DATA_LABEL;}function hasTargetSelected(types){if(types.constructor!==Array){types=[types];}var selected=this.selectedTargets||[],hasTarget=false;selected.forEach(function(target){var _type=target.getAttribute("type");if(types.indexOf(_type)>-1){hasTarget=true;}});return hasTarget;}function getRealTarget(target){var container,containerType,element,type=target.getAttribute("type"),hoverCatcher,buddyElement,buddyHoverCatcher,useBuddyElement=false;if(type===null&&target.innerHTML==="|"&&target.className==="gm-text-body-nowrap"){type=CTRL_TYPE.GM_SVG_Y_NUMERIC;}if(type===null){target=target.parentNode;type=target.getAttribute("type");}if(type===CTRL_TYPE.LINE_CONTAINER){target=target.firstChild;type=target.getAttribute("type");}if(type===CTRL_TYPE.GM_AXIS_TEXT||type===CTRL_TYPE.GM_AXIS_WORD){target=getSVGParentNode(target);type=target&&target.getAttribute("type");}if(type===CTRL_TYPE.GM_TEXT_BODY){container=target.parentNode;containerType=container.getAttribute("type");switch(containerType){case CTRL_TYPE.GM_ROW_HEADER_TITLE:case CTRL_TYPE.GM_COL_HEADER_TITLE:case CTRL_TYPE.GM_COL_HEADER:case CTRL_TYPE.GM_ROW_HEADER:case CTRL_TYPE.GM_COL_HEADER_EXTRA:case CTRL_TYPE.GM_ROW_HEADER_EXTRA:case CTRL_TYPE.GM_YLABEL:case CTRL_TYPE.GM_XLABEL:element=container;break;}}else{switch(type){case CTRL_TYPE.GM_YLABEL:case CTRL_TYPE.GM_XLABEL:case CTRL_TYPE.GM_SVG_Y_NUMERIC:case CTRL_TYPE.GM_SVG_X_NUMERIC:case CTRL_TYPE.GM_SVG_X_CATEGORY:case CTRL_TYPE.GM_SVG_Y_CATEGORY:element=target.parentNode.parentNode;break;case CTRL_TYPE.GM_Y_NUMERIC:case CTRL_TYPE.GM_X_NUMERIC:case CTRL_TYPE.GM_X_CATEGORY:case CTRL_TYPE.GM_Y_CATEGORY:case CTRL_TYPE.GM_COL_HEADER:case CTRL_TYPE.GM_ROW_HEADER:case CTRL_TYPE.GM_SHAPE:case CTRL_TYPE.GM_SET_SHAPE:case CTRL_TYPE.LASSO_SELECTOR:case CTRL_TYPE.LASSO_RESIZER:case CTRL_TYPE.GM_SVG_CHART:element=target;break;case CTRL_TYPE.GM_TREND_LINE:case CTRL_TYPE.GM_REF_LINE:hoverCatcher=target.getAttribute("hover-catcher");if(hoverCatcher!==undefined&&hoverCatcher!==null&&hoverCatcher==="1"){buddyElement=target.previousElementSibling;if(buddyElement!==null){buddyHoverCatcher=buddyElement.getAttribute("hover-catcher");if(buddyHoverCatcher!==undefined&&buddyHoverCatcher!==null&&buddyHoverCatcher==="0"&&buddyElement.identity===target.identity){useBuddyElement=true;}}}if(useBuddyElement){element=buddyElement;}else{element=target;}break;case CTRL_TYPE.GM_MARKER:element=target.source;break;default:break;}}return element;}function getRealTargetFMT(target){var element,type=target.getAttribute("type"),hoverCatcher,buddyElement,buddyHoverCatcher,useBuddyElement=false;if(type===null||type===CTRL_TYPE.GM_TEXT_BODY){target=target.parentNode;type=target.getAttribute("type");}if(type===CTRL_TYPE.GM_DATA_LABEL||type===CTRL_TYPE.GM_ORIGIN_LABEL){target.identity=target.parentNode.identity;}if(type===CTRL_TYPE.LINE_CONTAINER){target=target.firstChild;type=target.getAttribute("type");}if(type===CTRL_TYPE.GM_AXIS_TEXT||type===CTRL_TYPE.GM_AXIS_WORD){target=getSVGParentNode(target);type=target.getAttribute("type");}switch(type){case CTRL_TYPE.GM_H_MATRIX_LINE:case CTRL_TYPE.GM_V_MATRIX_LINE:case CTRL_TYPE.GM_H_CHART_LINE:case CTRL_TYPE.GM_V_CHART_LINE:case CTRL_TYPE.GM_YAXIS_LINE:case CTRL_TYPE.GM_XAXIS_LINE:case CTRL_TYPE.GM_YAXIS2_LINE:case CTRL_TYPE.GM_XAXIS2_LINE:case CTRL_TYPE.GM_H_GRID_LINE:case CTRL_TYPE.GM_V_GRID_LINE:case CTRL_TYPE.GM_H_MINOR_GRID_LINE:case CTRL_TYPE.GM_V_MINOR_GRID_LINE:case CTRL_TYPE.GM_ROW_HEADER:case CTRL_TYPE.GM_COL_HEADER:case CTRL_TYPE.GM_COL_HEADER_EXTRA:case CTRL_TYPE.GM_ROW_HEADER_EXTRA:case CTRL_TYPE.GM_ROW_HEADER_TITLE:case CTRL_TYPE.GM_COL_HEADER_TITLE:case CTRL_TYPE.GM_Y_NUMERIC:case CTRL_TYPE.GM_X_NUMERIC:case CTRL_TYPE.GM_ORIGIN_LINE:case CTRL_TYPE.GM_ORIGIN_LABEL_H:case CTRL_TYPE.GM_ORIGIN_LABEL_V:case CTRL_TYPE.GM_DUMMY_A:case CTRL_TYPE.GM_DATA_LABEL:case CTRL_TYPE.GM_YLABEL:case CTRL_TYPE.GM_XLABEL:element=target;break;case CTRL_TYPE.GM_TREND_LINE:case CTRL_TYPE.GM_REF_LINE:hoverCatcher=target.getAttribute("hover-catcher");if(hoverCatcher!==undefined&&hoverCatcher!==null&&hoverCatcher==="1"){buddyElement=target.previousElementSibling;if(buddyElement!==null){buddyHoverCatcher=buddyElement.getAttribute("hover-catcher");if(buddyHoverCatcher!==undefined&&buddyHoverCatcher!==null&&buddyHoverCatcher==="0"&&buddyElement.identity===target.identity){useBuddyElement=true;}}}if(useBuddyElement){element=buddyElement;}else{element=target;}break;case CTRL_TYPE.GM_SHAPE:case CTRL_TYPE.GM_SET_SHAPE:case CTRL_TYPE.LASSO_SELECTOR:case CTRL_TYPE.GM_SVG_CHART:element=target;break;case CTRL_TYPE.GM_MARKER:element=target.source;break;case CTRL_TYPE.GM_SVG_Y_NUMERIC:case CTRL_TYPE.GM_SVG_X_NUMERIC:case CTRL_TYPE.GM_SVG_X_CATEGORY:case CTRL_TYPE.GM_SVG_Y_CATEGORY:element=target.parentNode.parentNode;break;default:break;}return element;}function updateRelevantRows(element,flag,cls,manager){var row=parseInt(element.getAttribute("row"),10),rowSpan=parseInt(element.getAttribute("rowSpan"),10),depth=parseInt(element.getAttribute("depth"),10);manager.toggleClsByRows(row,row+rowSpan-1,depth,flag,cls);}function updateRelevantCols(element,flag,cls,manager){var col=parseInt(element.getAttribute("col"),10),colSpan=parseInt(element.getAttribute("colSpan"),10),depth=parseInt(element.getAttribute("depth"),10);manager.toggleClsByCols(col,col+colSpan-1,depth,flag,cls);}function getRowOrColToolbarEditor(type){var ROW_TEXT_VALUE_NAMES=[$ENUM_FORMAT_TAG.ROW_VAVLUE_TEXT_FONT_COLOR,$ENUM_FORMAT_TAG.ROW_VAVLUE_TEXT_FONT_SIZE,$ENUM_FORMAT_TAG.ROW_VAVLUE_TEXT_FONT_FAMILY,$ENUM_FORMAT_TAG.ROW_VAVLUE_TEXT_FONT_STYLE],ROW_TITLE_VALUE_NAMES=[$ENUM_FORMAT_TAG.ROW_TEXT_TEXT_FONT_COLOR,$ENUM_FORMAT_TAG.ROW_TEXT_TEXT_FONT_SIZE,$ENUM_FORMAT_TAG.ROW_TEXT_TEXT_FONT_FAMILY,$ENUM_FORMAT_TAG.ROW_TEXT_TEXT_FONT_STYLE],ROW_HEADER_VALUE_NAMES=[$ENUM_FORMAT_TAG.ROW_HEADER_TEXT_FONT_COLOR,$ENUM_FORMAT_TAG.ROW_HEADER_TEXT_FONT_SIZE,$ENUM_FORMAT_TAG.ROW_HEADER_TEXT_FONT_FAMILY,$ENUM_FORMAT_TAG.ROW_HEADER_TEXT_FONT_STYLE],ROW_FILL_VALUE_NAMES=[$ENUM_FORMAT_TAG.ROW_HEADER_FILL_COLOR,$ENUM_FORMAT_TAG.ROW_HEADER_FILL_TRANSPARENCY],COL_TEXT_VALUE_NAMES=[$ENUM_FORMAT_TAG.COLUMN_VAVLUE_TEXT_FONT_COLOR,$ENUM_FORMAT_TAG.COLUMN_VAVLUE_TEXT_FONT_SIZE,$ENUM_FORMAT_TAG.COLUMN_VAVLUE_TEXT_FONT_FAMILY,$ENUM_FORMAT_TAG.COLUMN_VAVLUE_TEXT_FONT_STYLE],COL_TITLE_VALUE_NAMES=[$ENUM_FORMAT_TAG.COLUMN_TEXT_TEXT_FONT_COLOR,$ENUM_FORMAT_TAG.COLUMN_TEXT_TEXT_FONT_SIZE,$ENUM_FORMAT_TAG.COLUMN_TEXT_TEXT_FONT_FAMILY,$ENUM_FORMAT_TAG.COLUMN_TEXT_TEXT_FONT_STYLE],COL_HEADER_VALUE_NAMES=[$ENUM_FORMAT_TAG.COLUMN_HEADER_TEXT_FONT_COLOR,$ENUM_FORMAT_TAG.COLUMN_HEADER_TEXT_FONT_SIZE,$ENUM_FORMAT_TAG.COLUMN_HEADER_TEXT_FONT_FAMILY,$ENUM_FORMAT_TAG.COLUMN_HEADER_TEXT_FONT_STYLE],COL_FILL_VALUE_NAMES=[$ENUM_FORMAT_TAG.COLUMN_HEADER_FILL_COLOR,$ENUM_FORMAT_TAG.COLUMN_HEADER_FILL_TRANSPARENCY],ROW_TITLE_PREFIX="rwTxtTxt",ROW_VALUE_PREFIX="rwVlTxt",ROW_HEADER_PREFIX="rwHdrTxt",COL_TITLE_PREFIX="colTxtTxt",COL_VALUE_PREFIX="colVlTxt",COL_HEADER_PREFIX="colHdrTxt",isSelected,propNamePrefix,fontNames,fillNames,widget=this.widget,propertyName,hideFill=(widget.preClickType===mstrmojo.gm.EnumClickType.DOUBLE_CLICK);switch(type){case CTRL_TYPE.GM_ROW_HEADER_TITLE:propertyName=$ENUM_FORMAT_TAG.ROW_HEADER_SHOW;isSelected=hasTargetSelected.call(this,CTRL_TYPE.GM_ROW_HEADER);propNamePrefix=isSelected?ROW_TITLE_PREFIX:ROW_HEADER_PREFIX;fontNames=isSelected?ROW_TITLE_VALUE_NAMES:ROW_HEADER_VALUE_NAMES;fillNames=ROW_FILL_VALUE_NAMES;break;case CTRL_TYPE.GM_COL_HEADER_TITLE:propertyName=$ENUM_FORMAT_TAG.COLUMN_HEADER_SHOW;isSelected=hasTargetSelected.call(this,CTRL_TYPE.GM_COL_HEADER);propNamePrefix=isSelected?COL_TITLE_PREFIX:COL_HEADER_PREFIX;fontNames=isSelected?COL_TITLE_VALUE_NAMES:COL_HEADER_VALUE_NAMES;fillNames=COL_FILL_VALUE_NAMES;break;case CTRL_TYPE.GM_ROW_HEADER:case CTRL_TYPE.GM_ROW_HEADER_EXTRA:propertyName=$ENUM_FORMAT_TAG.ROW_VALUES_SHOW;isSelected=hasTargetSelected.call(this,CTRL_TYPE.GM_ROW_HEADER_TITLE);propNamePrefix=isSelected?ROW_TITLE_PREFIX:ROW_VALUE_PREFIX;fontNames=isSelected?ROW_TITLE_VALUE_NAMES:ROW_TEXT_VALUE_NAMES;fillNames=ROW_FILL_VALUE_NAMES;break;case CTRL_TYPE.GM_COL_HEADER:case CTRL_TYPE.GM_COL_HEADER_EXTRA:propertyName=$ENUM_FORMAT_TAG.COLUMN_VALUES_SHOW;isSelected=hasTargetSelected.call(this,CTRL_TYPE.GM_COL_HEADER_TITLE);propNamePrefix=isSelected?COL_TITLE_PREFIX:COL_VALUE_PREFIX;fontNames=isSelected?COL_TITLE_VALUE_NAMES:COL_TEXT_VALUE_NAMES;fillNames=COL_FILL_VALUE_NAMES;break;}if(hideFill){if(widget.readGlobalProperty(propertyName)){return getFontToolbar(this.widget,propNamePrefix,fontNames,EnumControlScope.GLOBAL);}return getFillToolbar(this.widget,mstrmojo.desc(2885,"Fill"),fillNames,EnumControlScope.GLOBAL);}return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-ToolBoxFontAndFill",children:[getLabelAndControlBox(mstrmojo.desc(3433,"Font"),getCharacterConfigComp(widget,propNamePrefix,fontNames,EnumControlScope.GLOBAL,undefined,false),false,"mstrmojo-ui-rowContainer"),getFillConfigComp(widget,mstrmojo.desc(2885,"Fill"),fillNames,EnumControlScope.GLOBAL)]}]});}function isShapeVisible(svgPos,shapePos){return(shapePos>=0)&&(shapePos<=svgPos);}function getInnerText(div){var text;if(div.textContent&&typeof (div.textContent)!==undefined){text=div.textContent;}else{text=div.innerText;}return text;}function getOuterHTML(node){return node.outerHTML||new XMLSerializer().serializeToString(node);}function isRMCOnAxisForMultiSelection(rmcTarget,rmcTargetType){var selected=this.selectedTargets,selectedType=this.selType;if(selected.length>1&&isAxisTitle(selectedType)&&isNumeric(rmcTargetType)){for(var i=0;i<selected.length;i++){if(selected[i].parentNode.parentNode===rmcTarget){return true;}}}return false;}function isClearNumericCSS(labelNode){var brotherNode=labelNode.parentNode.children||[],len=brotherNode.length,status;for(var i=0;i<len;i++){status=brotherNode[i].getAttribute("status");if(status===SHAPE_STAT.SELECTED){return false;}}return true;}function removeMetricRepeatSelection(target){var selected=this.selectedTargets||[],len=selected.length,targetInfo=target.selectionInfo,targetMid=targetInfo&&targetInfo.mid;for(var i=0;i<len;i++){var selectionInfo=selected[i].selectionInfo;if(selectionInfo&&selectionInfo.mid===targetMid){this.deselectTarget(selected[i]);$CSS.removeClass(selected[i],"like-normal");if(isClearNumericCSS(selected[i])){$CSS.removeClass(selected[i].parentNode.parentNode,"like-selected");this.clearSingleSelectedMarker(selected[i].parentNode.parentNode);}break;}}}function isAreaLine(shape){if(!shape){return ;}if(shape.tagName==="polyline"){var parentDiv=shape.parentNode,children=parentDiv&&parentDiv.children,childDiv,i,count=children?children.length:0;for(i=0;i<count;i++){childDiv=children[i];if(childDiv.tagName==="polygon"){return true;}}}return false;}function addDrillMenuItem(hasDrillPath,cfg,id,fnSubMenu){if(hasDrillPath){cfg.addSubMenuItem(mstrmojo.desc(145,"Drill"),"",id,fnSubMenu);}else{cfg.addNonInteractiveMenuItem(mstrmojo.desc(145,"Drill"),"",true);}}function getGroupAndCalculationCMForDP(visGM,selectedShapes){return $VISUTIL.getGroupAndCalculationContextMenuForDataPoints(visGM,{selection:selectedShapes,fnCellName:function(cell){return cell.innerText||cell.textContent;},fnUnique:function(selection){var uniqIdnts=[],gmCtr=visGM.GMController,rAttrs=gmCtr.dz.Rows.TemplateUnit||[],cAttrs=gmCtr.dz.Columns.TemplateUnit||[],rowAndColumnAttrs=rAttrs.concat(cAttrs);selection.forEach(function(shape){shape.identity.objectInfo.forEach(function(identity){if($ARR.find(rowAndColumnAttrs,"id",identity.tid)===-1){uniqIdnts=uniqIdnts.filter(function(idnt){return idnt.tid!==identity.tid||idnt.eid!==identity.eid;});uniqIdnts.push(identity);}});});return uniqIdnts;},fnMakeNode:function(indentity){return{identity:indentity,innerText:indentity.v};}});}function addRenameMenuItem(visGM,menuCfg,node,item){menuCfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"xt",function(){var editableLabel=$DU.renameItem(node,item,function(renameWidget){var DZ=visGM.zonesModel.gmZones,newName=renameWidget.text.trim(),getUpdateTemplateAction=function(viz,actions){return{act:"updateTemplate",keyContext:viz.k,partialRetrieval:{nodes:[viz.k]},actions:actions};};DZ.submitDropZoneUpdates(getUpdateTemplateAction(visGM,[{act:"renameUnit",id:item.did,type:item.t,name:newName,isDynamicAlias:item.t===4}]));},{allowEmptyText:true});visGM.addDisposable(editableLabel);});}mstrmojo.gm.GMInteractivity=mstrmojo.declare(mstrmojo.Obj,[mstrmojo.vi.ui._CanDropFromSchema],{scriptClass:"mstrmojo.gm.GMInteractivity",widget:null,highlightedRows:[],highlightedCols:[],selectedShapes:[],selectedTargets:[],selectedMarkerLines:[],selectedBorderLines:[],hoveredShape:undefined,hoveredSetShape:undefined,hoveredTargetArr:undefined,tooltipShape:undefined,domWidget:undefined,fmtState:ENUM_FMT_STATUS.NORMAL,init:function(props){this.widget=null;this.highlightedRows=[];this.highlightedCols=[];this.selectedShapes=[];this.selectedTargets=[];this.selectedMarkerLines=[];this.selectedBorderLines=[];this.hoveredShape=undefined;this.hoveredSetShape=undefined;this.hoveredTargetArr=[];this.tooltipShape=undefined;this.domWidget=undefined;this.colorByRules=[];this.colorByShapes=[];this.breakByRules=[];this.breakByShapes=[];this.fmtSelections={};if(this._super){this._super(props);}var div=document.createElement("div");div.setAttribute("type",CTRL_TYPE.GM_HIGHLIGHT_BOX);div.setAttribute("class","gm-highlight-box");this.domHLBox=div;div=document.createElement("div");div.setAttribute("class","gm-menu-placeholder");this.domMenuPH=div;div=document.createElement("div");div.setAttribute("class","gm-menu-placeholder");this.domToolbarPH=div;if(!TOOLTIP_WIN){TOOLTIP_WIN=new $MOJO.VisTooltip({placeholder:document.body.appendChild(document.createElement("div"))});TOOLTIP_WIN.render();TOOLTIP_WIN.toggle(false);}},destroy:function destroy(ignoreDOM){delete this.domWidget;this._super(ignoreDOM);},clearAll:function(){this.highlightedRows.length=0;this.highlightedCols.length=0;this.selectedShapes.length=0;this.selectedTargets.length=0;this.selectedMarkerLines.length=0;this.selectedBorderLines.length=0;this.hoveredTargetArr.length=0;this.hoveredShape=undefined;this.hoveredSetShape=undefined;this.hideTooltip();},getColorByIdentities:function(){var i,selected=this.colorByShapes,n=selected.length,rtn=[];for(i=0;i<n;i++){rtn.push(selected[i].identity);}return rtn;},getBreakByIdentities:function(){var i,selected=this.breakByShapes,n=selected.length,rtn=[];for(i=0;i<n;i++){rtn.push(selected[i].identity);}return rtn;},getIdentities:function(){var i,selected=this.selectedShapes,n=selected.length,rtn=[];for(i=0;i<n;i++){rtn.push(selected[i].identity);}return rtn;},hoverShape:function(shape){var markers=shape.parentNode.getElementsByClassName?shape.parentNode.getElementsByClassName("gm-marker-scircle"):document.getElementsByClassName("gm-marker-scircle");if(this.hoveredShape===shape||isShapeSelected(shape)){$ARR.forEach(markers,function(decorator){if(isShapeSelected(shape)&&decorator.getAttribute("cx")===shape.getAttribute("cx")&&decorator.getAttribute("cy")===shape.getAttribute("cy")){hSetTargetStatus(decorator,SHAPE_STAT.HOVER);}});return ;}$ARR.forEach(markers,function(decorator){hSetTargetStatus(decorator,SHAPE_STAT.NORMAL);});this.clearHoveredShape();setShapeStatus(shape,SHAPE_STAT.HOVER);this.hoveredShape=shape;},hoverOverSelectedShape:function(shape){if(isShapeSelected(shape)&&shape.getAttribute("subtype")===SHAPE_SUBTYPE.BAR&&shape.getAttribute("size")==="small"){this.clearHoveredShape();setShapeStatus(shape,SHAPE_STAT.HOVER);shape.sh=true;this.hoveredShape=shape;}},clearHoveredShape:function(){var shape=this.hoveredShape;if(shape&&shape.sh){setShapeStatus(shape,SHAPE_STAT.SELECTED);this.hoveredShape=undefined;delete shape.sh;}else{if(shape){setShapeStatus(shape,SHAPE_STAT.NORMAL);this.hoveredShape=undefined;}}},getTargetsWithSameTypeForDBL:function(target){var fmtMode=this.fmtMode,targets=[],type=target.getAttribute("type");if(fmtMode){var typeGroups=[[CTRL_TYPE.GM_XAXIS_LINE,CTRL_TYPE.GM_XAXIS2_LINE],[CTRL_TYPE.GM_YAXIS_LINE,CTRL_TYPE.GM_YAXIS2_LINE],[CTRL_TYPE.GM_X_NUMERIC,CTRL_TYPE.GM_X_CATEGORY,CTRL_TYPE.GM_ORIGIN_LABEL_V],[CTRL_TYPE.GM_Y_NUMERIC,CTRL_TYPE.GM_Y_CATEGORY,CTRL_TYPE.GM_ORIGIN_LABEL_H],[CTRL_TYPE.GM_H_CHART_LINE,CTRL_TYPE.GM_H_MATRIX_LINE],[CTRL_TYPE.GM_V_CHART_LINE,CTRL_TYPE.GM_V_MATRIX_LINE],[CTRL_TYPE.GM_H_GRID_LINE,CTRL_TYPE.GM_V_GRID_LINE],[CTRL_TYPE.GM_H_MINOR_GRID_LINE,CTRL_TYPE.GM_V_MINOR_GRID_LINE],[CTRL_TYPE.GM_ORIGIN_LINE],[CTRL_TYPE.GM_ROW_HEADER,CTRL_TYPE.GM_ROW_HEADER_EXTRA],[CTRL_TYPE.GM_ROW_HEADER_TITLE],[CTRL_TYPE.GM_COL_HEADER,CTRL_TYPE.GM_COL_HEADER_EXTRA],[CTRL_TYPE.GM_COL_HEADER_TITLE],[CTRL_TYPE.GM_TREND_LINE],[CTRL_TYPE.GM_REF_LINE]];$ARR.forEach(typeGroups,function(typeGroup){if(typeGroup.indexOf(type)!==-1){if(isTrendLIne(type)||isReferenceLine(type)){var trendRefKeyVarlues=[target.identity.tlOpt.key];targets=findElementsByAttribute(this.widget.domNode,"key",trendRefKeyVarlues,true);}else{targets=findElementsByAttribute(this.widget.domNode,"type",typeGroup);}return false;}},this);if(targets.length===0){targets=findElementsByAttribute(this.widget.domNode,"type",type);}}else{targets=findElementsByAttribute(this.widget.domNode,"type",type);}return targets;},getTargetsWithSameType:function(target,isHover){var fmtMode=this.fmtMode,targets=[],type=target.getAttribute("type");if(isTrendLIne(type)||isReferenceLine(type)){if(!isHover){var trendRefKeyVarlues=[target.identity.tlOpt.key];targets=findElementsByAttribute(this.widget.domNode,"key",trendRefKeyVarlues,true);if(targets.length===0){targets.push(target);}}else{targets.push(target);}}else{if(fmtMode){var typeGroups=[[CTRL_TYPE.GM_YAXIS_LINE,CTRL_TYPE.GM_YAXIS2_LINE],[CTRL_TYPE.GM_XAXIS_LINE,CTRL_TYPE.GM_XAXIS2_LINE],[CTRL_TYPE.GM_XLABEL],[CTRL_TYPE.GM_YLABEL],[CTRL_TYPE.GM_Y_NUMERIC,CTRL_TYPE.GM_Y_CATEGORY,CTRL_TYPE.GM_ORIGIN_LABEL_H],[CTRL_TYPE.GM_X_NUMERIC,CTRL_TYPE.GM_X_CATEGORY,CTRL_TYPE.GM_ORIGIN_LABEL_V],[CTRL_TYPE.GM_V_CHART_LINE,CTRL_TYPE.GM_H_CHART_LINE,CTRL_TYPE.GM_V_MATRIX_LINE,CTRL_TYPE.GM_H_MATRIX_LINE],[CTRL_TYPE.GM_H_GRID_LINE,CTRL_TYPE.GM_V_GRID_LINE,CTRL_TYPE.GM_H_MINOR_GRID_LINE,CTRL_TYPE.GM_V_MINOR_GRID_LINE],[CTRL_TYPE.GM_ROW_HEADER,CTRL_TYPE.GM_ROW_HEADER_TITLE,CTRL_TYPE.GM_ROW_HEADER_EXTRA,CTRL_TYPE.GM_DUMMY_A],[CTRL_TYPE.GM_COL_HEADER,CTRL_TYPE.GM_COL_HEADER_TITLE,CTRL_TYPE.GM_COL_HEADER_EXTRA],[CTRL_TYPE.GM_DATA_LABEL],[CTRL_TYPE.GM_ORIGIN_LINE]];$ARR.forEach(typeGroups,function(typeGroup){if(typeGroup.indexOf(type)!==-1){targets=findElementsByAttribute(this.widget.domNode,"type",typeGroup);return false;}},this);if(targets.length===0){targets.push(target);}}else{targets.push(target);}}return targets;},getMainContainer:function(target){var mainContainers=document.getElementsByClassName("gm-main-container"),mainContainer=mainContainers[0];$ARR.forEach(mainContainers,function(mc){if(target&&target.parentNode&&target.parentNode.parentNode&&target.parentNode.parentNode.parentNode&&target.parentNode.parentNode.parentNode.parentNode&&target.parentNode.parentNode.parentNode.parentNode.parentNode===mc){mainContainer=mc;return false;}});return mainContainer;},selectBorders:function(target){var fmtMode=this.fmtMode,type=target.getAttribute("type"),mc=this.getMainContainer(target),tgt_rect=$DOM.position(target),mc_rect=$DOM.position(mc),rect={},borderLine,borderLineArray=[];if(fmtMode){return ;}rect.x=tgt_rect.x-mc_rect.x;rect.y=tgt_rect.y-mc_rect.y;if(type===CTRL_TYPE.GM_ROW_HEADER){rect.h=tgt_rect.h;rect.w=mc_rect.w-rect.x;}else{if(type===CTRL_TYPE.GM_COL_HEADER){rect.w=tgt_rect.w;rect.h=mc_rect.h-rect.y;}}borderLine=this.getLineDiv("border-line",rect.x,rect.y,rect.w,1);mc.appendChild(borderLine);borderLineArray.push(borderLine);borderLine=this.getLineDiv("border-line",rect.x,rect.y,1,rect.h);mc.appendChild(borderLine);borderLineArray.push(borderLine);borderLine=this.getLineDiv("border-line",rect.x+rect.w,rect.y,1,rect.h);mc.appendChild(borderLine);borderLineArray.push(borderLine);borderLine=this.getLineDiv("border-line",rect.x,rect.y+rect.h,rect.w,1);mc.appendChild(borderLine);borderLineArray.push(borderLine);this.selectedBorderLines.push({target:target,borderLineArray:borderLineArray});},clearSelectedBorders:function(){$ARR.forEach(this.selectedBorderLines,function(targetAndBorderLineArray){$ARR.forEach(targetAndBorderLineArray.borderLineArray,function(borderLine){if(borderLine.parentNode){borderLine.parentNode.removeChild(borderLine);}});});this.selectedBorderLines=[];},deselectBorders:function(target){var i,tmp=[];var removeBorderLine=function(borderLine){borderLine.parentNode.removeChild(borderLine);};for(i=0;i<this.selectedBorderLines.length;i++){if(this.selectedBorderLines[i].target===target){$ARR.forEach(this.selectedBorderLines[i].borderLineArray,removeBorderLine);}else{tmp.push(this.selectedBorderLines[i]);}}this.selectedBorderLines=tmp;},updateSelectedBroders:function(){var me=this;this.clearSelectedBorders();$ARR.forEach(this.selectedTargets||[],function(target){var type=target.getAttribute("type");if(type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_COL_HEADER){me.selectBorders(target);}});},getLineDiv:function(cls,l,t,w,h){var div=document.createElement("div");div.setAttribute("class",cls);div.style.zIndex="1000";div.style.position="absolute";div.style.display="block";div.style.backgroundColor="#34abeb";div.style.left=l+"px";div.style.top=t+"px";div.style.width=w+"px";div.style.height=h+"px";return div;},selectMarkers:function(target){var type=target.getAttribute("type"),mc=this.getMainContainer(target),tgt_rect=$DOM.position(target),mc_rect=$DOM.position(mc),left,top,width,height,markerLine,mlKey,idx;if(type===CTRL_TYPE.GM_X_NUMERIC||type===CTRL_TYPE.GM_X_CATEGORY){left=tgt_rect.x-mc_rect.x;if(target.getAttribute("isPrimary")==="true"){top=tgt_rect.y-mc_rect.y-1;}else{top=tgt_rect.y-mc_rect.y+tgt_rect.h;}height=1;width=tgt_rect.w;}else{if(type===CTRL_TYPE.GM_Y_NUMERIC||type===CTRL_TYPE.GM_Y_CATEGORY){top=tgt_rect.y-mc_rect.y;if(target.getAttribute("isPrimary")==="true"){left=tgt_rect.x-mc_rect.x+tgt_rect.w;}else{left=tgt_rect.x-mc_rect.x-1;}height=tgt_rect.h;width=1;}}markerLine=this.getLineDiv("marker-line",left,top,width,height);mlKey=target.getAttribute("row")+"."+target.getAttribute("col");idx=$ARR.find(this.selectedMarkerLines,"key",mlKey);if(idx===-1){mc.appendChild(markerLine);this.selectedMarkerLines.push({key:mlKey,line:markerLine});}},clearSelectedMarkers:function(){$ARR.forEach(this.selectedMarkerLines,function(selectedMarkerLine){var markerLine=selectedMarkerLine.line;markerLine.parentNode.removeChild(markerLine);});this.selectedMarkerLines=[];},clearSingleSelectedMarker:function(target){var mlKey,markerLine,idx,type=target.getAttribute("type");if(isNumeric(type)){mlKey=target.getAttribute("row")+"."+target.getAttribute("col");idx=$ARR.find(this.selectedMarkerLines,"key",mlKey);if(idx!==-1){markerLine=this.selectedMarkerLines[idx].line;markerLine.parentNode.removeChild(markerLine);this.selectedMarkerLines.splice(idx,1);}}},selectTarget:function(targetArr){var me=this;this.clearSelectedShapes();this.selectedTargets=this.selectedTargets?this.selectedTargets:[];if(targetArr&&targetArr.length>0&&isShapeSelected(targetArr[0])){return ;}if(checkIntersectionWithTwoArrays(targetArr,this.hoveredTargetArr)){this.clearHoveredTarget();}$ARR.forEach(targetArr||[],function(target){this.selectedTargets.push(target);hSetTargetStatus(target,SHAPE_STAT.SELECTED);if(isTrendLIne(target.getAttribute("type"))||isReferenceLine(target.getAttribute("type"))){selectTrendLine.call(this.widget,target);}var type=target.getAttribute("type"),identity=target.identity,widget=this.widget,manager=widget.manager,fmtMode=this.fmtMode;if(fmtMode){var mainContainer=widget.domMainContainer;if(isVMatrixLine(type)){$CSS.addClass(mainContainer,"select-ml-v");}if(isHMatrixLine(type)){$CSS.addClass(mainContainer,"select-ml-h");}if(isXAxisLine(type)){$CSS.addClass(mainContainer,"select-al-x");}if(isYAxisLine(type)){$CSS.addClass(mainContainer,"select-al-y");}if(isMajorGridLine(type)){$CSS.addClass(mainContainer,"select-gl-major");}if(isMinorGridLine(type)){$CSS.addClass(mainContainer,"select-gl-minor");}if(isRowHeader(type)){$CSS.addClass(mainContainer,"select-rh-header");}if(isRowValue(type)||(type===CTRL_TYPE.GM_DUMMY_A)){$CSS.addClass(mainContainer,"select-rh-value");}if(isColHeader(type)){$CSS.addClass(mainContainer,"select-ch-header");}if(isColValue(type)){$CSS.addClass(mainContainer,"select-ch-value");}}else{if(type===CTRL_TYPE.GM_ROW_HEADER){updateRelevantRows(target,true,"selected",manager);me.selectBorders(target);widget.addAttributeSelection(identity.tid,identity.eid,identity.v);}if(type===CTRL_TYPE.GM_COL_HEADER){updateRelevantCols(target,true,"selected",manager);me.selectBorders(target);widget.addAttributeSelection(identity.tid,identity.eid,identity.v);}if(type===CTRL_TYPE.GM_YLABEL||type===CTRL_TYPE.GM_XLABEL){$CSS.addClass(target,"like-normal");$CSS.addClass(target.parentNode.parentNode,"like-selected");me.selectMarkers(target.parentNode.parentNode);}}if(type===CTRL_TYPE.GM_X_NUMERIC||type===CTRL_TYPE.GM_Y_NUMERIC||type===CTRL_TYPE.GM_X_CATEGORY||type===CTRL_TYPE.GM_Y_CATEGORY){$CSS.addClass(target,"with-text");me.selectMarkers(target);}},this);},clearSelectedTargets:function(){var widget=this.widget,manager=widget.manager,selected=this.selectedTargets||[],me=this;selected.forEach(function(target){hSetTargetStatus(target,SHAPE_STAT.NORMAL);if(isTrendLIne(target.getAttribute("type"))||isReferenceLine(target.getAttribute("type"))){deSelectTrendLine(target);}var identity=target.identity,type=target.getAttribute("type"),mainContainer=widget.domMainContainer;if(isVMatrixLine(type)){$CSS.removeClass(mainContainer,"select-ml-v");}if(isHMatrixLine(type)){$CSS.removeClass(mainContainer,"select-ml-h");}if(isXAxisLine(type)){$CSS.removeClass(mainContainer,"select-al-x");}if(isYAxisLine(type)){$CSS.removeClass(mainContainer,"select-al-y");}if(isMajorGridLine(type)){$CSS.removeClass(mainContainer,"select-gl-major");}if(isMinorGridLine(type)){$CSS.removeClass(mainContainer,"select-gl-minor");}if(isRowHeader(type)){$CSS.removeClass(mainContainer,"select-rh-header");}if(isRowValue(type)||(type===CTRL_TYPE.GM_DUMMY_A)){$CSS.removeClass(mainContainer,"select-rh-value");}if(isColHeader(type)){$CSS.removeClass(mainContainer,"select-ch-header");}if(isColValue(type)){$CSS.removeClass(mainContainer,"select-ch-value");}if(type===CTRL_TYPE.GM_ROW_HEADER){updateRelevantRows(target,false,"selected",manager);updateRelevantRows(target,false,"sh",manager);widget.removeAttributeSelection(identity.tid,identity.eid);}if(type===CTRL_TYPE.GM_COL_HEADER){updateRelevantCols(target,false,"selected",manager);updateRelevantCols(target,false,"sh",manager);widget.removeAttributeSelection(identity.tid,identity.eid);}if(type===CTRL_TYPE.GM_YLABEL||type===CTRL_TYPE.GM_XLABEL){$CSS.removeClass(target,"like-normal");$CSS.removeClass(target.parentNode.parentNode,"like-selected");me.clearSelectedMarkers();}if(type===CTRL_TYPE.GM_X_NUMERIC||type===CTRL_TYPE.GM_Y_NUMERIC||type===CTRL_TYPE.GM_X_CATEGORY||type===CTRL_TYPE.GM_Y_CATEGORY){$CSS.removeClass(target,"with-text");me.clearSelectedMarkers();}});me.clearSelectedBorders();this.selectedTargets=[];this.selType=undefined;},clearMetricSelectorHighlight:function(){},hoverTarget:function(targetArr){this.clearHoveredTarget();if(!targetArr||targetArr.length===0){return ;}this.hoveredTargetArr=targetArr;$ARR.forEach(targetArr||[],function(target){if(!isShapeSelected(target)){hSetTargetStatus(target,SHAPE_STAT.HOVER);if(isTrendLIne(target.getAttribute("type"))||isReferenceLine(target.getAttribute("type"))){hoverTrendLine(target);}var type=target.getAttribute("type"),widget=this.widget,manager=widget.manager,fmtMode=this.fmtMode;if(fmtMode){widget.toggleContainerCls(isMatrixLine(type),"hover-ml");widget.toggleContainerCls(isAxisLine(type),"hover-al");widget.toggleContainerCls(isGridLine(type),"hover-gl");widget.toggleContainerCls(isOnRow(type)||(type===CTRL_TYPE.GM_DUMMY_A),"hover-rh");widget.toggleContainerCls(isOnCol(type),"hover-ch");}else{if(type===CTRL_TYPE.GM_ROW_HEADER){updateRelevantRows(target,true,"hover",manager);}if(type===CTRL_TYPE.GM_COL_HEADER){updateRelevantCols(target,true,"hover",manager);}if(type===CTRL_TYPE.GM_YLABEL||type===CTRL_TYPE.GM_XLABEL){$CSS.addClass(target.parentNode.parentNode,"like-hover");}}}},this);},clearSHTargets:function(){var widget=this.widget,manager=widget.manager,selected=this.selectedTargets||[],fmtMode=this.fmtMode,me=this;(selected||[]).forEach(function(target){var type=target.getAttribute("type");if(!fmtMode&&!me.isToolbarShow()){if(type===CTRL_TYPE.GM_ROW_HEADER){updateRelevantRows(target,false,"sh",manager);updateRelevantRows(target,false,"hover",manager);updateRelevantRows(target,true,"selected",manager);hSetTargetStatus(target,SHAPE_STAT.SELECTED);}if(type===CTRL_TYPE.GM_COL_HEADER){updateRelevantCols(target,false,"sh",manager);updateRelevantCols(target,false,"hover",manager);updateRelevantCols(target,true,"selected",manager);hSetTargetStatus(target,SHAPE_STAT.SELECTED);}}});},hoverSelectedTarget:function(targetArr){if(targetArr&&targetArr.length>0&&(!isShapeSelected(targetArr[0])||(targetArr[0].getAttribute("type")!==CTRL_TYPE.GM_ROW_HEADER&&targetArr[0].getAttribute("type")!==CTRL_TYPE.GM_COL_HEADER))){this.clearSHTargets();return ;}this.clearSHTargets();$ARR.forEach(targetArr||[],function(target){var type=target.getAttribute("type"),widget=this.widget,manager=widget.manager,fmtMode=this.fmtMode;if(!fmtMode){if(type===CTRL_TYPE.GM_ROW_HEADER){updateRelevantRows(target,false,"selected",manager);updateRelevantRows(target,false,"hover",manager);updateRelevantRows(target,true,"sh",manager);hSetTargetStatus(target,SHAPE_STAT.SH);}if(type===CTRL_TYPE.GM_COL_HEADER){updateRelevantCols(target,false,"selected",manager);updateRelevantCols(target,false,"hover",manager);updateRelevantCols(target,true,"sh",manager);hSetTargetStatus(target,SHAPE_STAT.SH);}}},this);},clearHoveredTarget:function(){var targetArr=this.hoveredTargetArr;$ARR.forEach(targetArr||[],function(target){if(isTrendLIne(target.getAttribute("type"))||isReferenceLine(target.getAttribute("type"))){hSetTargetStatus(target,SHAPE_STAT.NORMAL);deHoverTrendLine(target);}},this);var selected=this.selectedTargets||[];$ARR.forEach(selected||[],function(sd){if(targetArr.indexOf(sd)!==-1){targetArr.splice(targetArr.indexOf(sd),1);}});$ARR.forEach(targetArr||[],function(target){hSetTargetStatus(target,SHAPE_STAT.NORMAL);var type=target.getAttribute("type"),widget=this.widget,manager=widget.manager,fmtMode=this.fmtMode;if(fmtMode){if(isMatrixLine(type)){widget.toggleContainerCls(false,"hover-ml");}if(isAxisLine(type)){widget.toggleContainerCls(false,"hover-al");}if(isGridLine(type)){widget.toggleContainerCls(false,"hover-gl");}if(isOnRow(type)||(type===CTRL_TYPE.GM_DUMMY_A)){widget.toggleContainerCls(false,"hover-rh");}if(isOnCol(type)){widget.toggleContainerCls(false,"hover-ch");}}else{if(type===CTRL_TYPE.GM_ROW_HEADER){updateRelevantRows(target,false,"hover",manager);}if(type===CTRL_TYPE.GM_COL_HEADER){updateRelevantCols(target,false,"hover",manager);}if(type===CTRL_TYPE.GM_YLABEL||type===CTRL_TYPE.GM_XLABEL){$CSS.removeClass(target.parentNode.parentNode,"like-hover");}}},this);this.hoveredTargetArr=[];},hoverSetShape:function(shape){var current=this.hoveredSetShape;if(current===shape){return ;}if(!isAreaLine(shape)){removeClass(current,"hover");addClass(shape,"hover");}this.hoveredSetShape=shape;},clearHoveredSetShape:function(){var shape=this.hoveredSetShape;if(shape){removeClass(shape,"hover");this.hoveredSetShape=undefined;}},selectShape:function(shape,noUpdate,updateIndex,noReorder){if(isShapeSelected(shape)){return ;}if(updateIndex){this.widget.toggleShapeSelectionIndex(shape.identity,true);}if(!noReorder){reorderShape.call(this,shape);}setShapeStatus(shape,SHAPE_STAT.SELECTED);this.selectedShapes.push(shape);if(shape===this.hoveredShape){this.hoveredShape=undefined;}var svgNode=getSVGParentNode(shape),sels=svgNode.selectedShapes?svgNode.selectedShapes:(svgNode.selectedShapes=[]);sels.push(shape);if(!noUpdate){updatePieRingDecorator(getSVGParentNode(shape),shape.getAttribute("subtype"));}},selectShapes:function(shapes,updateIndex){var i,candidate,n=shapes.length,widget=this.widget;var noReorderAfterShowData=widget.noReorderAfterShowData;for(i=0;i<n;i++){this.selectShape(shapes[i],true,updateIndex,noReorderAfterShowData);candidate=extractSelectionInfo.call(this,shapes[i].identity);widget.addMetricValueSelection(candidate);}var svgNodes=[],shape,svgNode;for(i=0,n=shapes.length;i<n;i++){shape=shapes[i];svgNode=getSVGParentNode(shape);var subtype=shape.getAttribute("subtype");if(subtype===SHAPE_SUBTYPE.PIE||subtype===SHAPE_SUBTYPE.RING||subtype===SHAPE_SUBTYPE.CIRCLE){if(svgNodes.indexOf(svgNode)>-1){continue;}else{svgNodes.push(svgNode);}}}for(i=0,n=svgNodes.length;i<n;i++){svgNode=svgNodes[i];updatePieRingDecorator(svgNode,"pie");}},deselectShape:function(shape,noUpdate){var i,selectedShapes=this.selectedShapes,n=selectedShapes.length;for(i=0;i<n;i++){if(selectedShapes[i]===shape){setShapeStatus(shape,SHAPE_STAT.NORMAL);selectedShapes.splice(i,1);}}this.widget.toggleShapeSelectionIndex(shape.identity,false);var svgNode=getSVGParentNode(shape),sels=svgNode.selectedShapes,index=sels.indexOf(shape);if(index>-1){sels.splice(sels.indexOf(shape),1);}else{$VISUTIL.visPrint("THIS SHOULD NEVER HAPPEN");}if(!noUpdate){updatePieRingDecorator(getSVGParentNode(shape),shape.getAttribute("subtype"));}},toggleSelectShape:function(shape){var widget=this.widget,candidate=extractSelectionInfo.call(this,shape.identity);if(isShapeSelected(shape)){this.deselectShape(shape);widget.removeMetricValueSelection(candidate);return false;}this.selectShape(shape,undefined,true);widget.addMetricValueSelection(candidate);return true;},clearSelectedShapes:function(){var i,shape,selected=this.selectedShapes,n=selected.length,svgNode,selectedNodes,subType,candidate;for(i=0;i<n;i++){shape=selected[i];setShapeStatus(shape,SHAPE_STAT.NORMAL);candidate=extractSelectionInfo.call(this,shape.identity);this.widget.removeMetricValueSelection(candidate);subType=shape.getAttribute("subtype");if(subType===SHAPE_SUBTYPE.PIE||subType===SHAPE_SUBTYPE.RING||subType===SHAPE_SUBTYPE.CIRCLE){svgNode=getSVGParentNode(shape);selectedNodes=svgNode&&svgNode.selectedShapes;if(svgNode&&selectedNodes&&selectedNodes.length>0){selectedNodes.length=0;updatePieRingDecorator(svgNode,subType);}}}selected.length=0;},clearSelectRules:function(){this.colorByRules.length=0;this.colorByShapes.length=0;this.breakByRules.length=0;this.breakByShapes.length=0;},getAreaPoint:function(setShape,chtInfo,x,y){var i,shape,p0,p1,attr,delta,min,nearestShape,direction=chtInfo.dirc,seriesID=parseInt(setShape.getAttribute("seriesID"),10),svgNode=getSVGParentNode(setShape),targetGroup=svgNode.childNodes[seriesID+1],targetShapes=targetGroup.childNodes,n=targetShapes.length,pos=$DOM.position(svgNode,true);if(direction===1){p0=y;attr="cy";min=pos.h;}else{p0=x;attr="cx";min=pos.w;}for(i=0;i<n;i++){shape=targetShapes[i];p1=parseFloat(shape.getAttribute(attr));delta=Math.abs(p1-p0);if(delta<min){min=delta;nearestShape=shape;}}return nearestShape;},mouseOnSetShape:function(target,chtInfo,x,y){var nearestShape,direction=chtInfo.dirc,svgNode=getSVGParentNode(target),pos=$DOM.position(svgNode,true),shapeCx,shapeCy;nearestShape=this.getAreaPoint(target,chtInfo,x,y);if(nearestShape&&nearestShape!==this.hoveredShape){shapeCx=parseFloat(nearestShape.getAttribute("cx"));shapeCy=parseFloat(nearestShape.getAttribute("cy"));if(!isShapeVisible.call(this,direction===1?pos.w:pos.h,direction===1?shapeCx:shapeCy)){this.hideTooltip();this.clearHoveredShape();return ;}if($DOM.isFF){pos.x=svgNode.parentNode.getBoundingClientRect().left;pos.y=svgNode.parentNode.getBoundingClientRect().top;}x=pos.x+shapeCx;y=pos.y+shapeCy;this.hoverShape(nearestShape);this.showTooltip(nearestShape,{x:x,y:y});}},clearSelectedCharts:function(){var i,index,rows=this.highlightedRows,cols=this.highlightedCols,nRows=rows.length,nCols=cols.length,manager=this.widget.manager;for(i=0;i<nRows;i++){index=rows[i];manager.toggleClsByRows(index.start,index.end,0,false,"selected");}for(i=0;i<nCols;i++){index=cols[i];manager.toggleClsByCols(index.start,index.end,0,false,"selected");}rows.length=0;cols.length=0;},showTooltip:function(shape,pos){TOOLTIP_WIN.toggle(true);if(shape===this.tooltipShape){TOOLTIP_WIN.moveTo(pos.x,pos.y);return ;}var info,identity=shape.identity;if(identity){info=identity.getTooltipContent();if(info){if(!TOOLTIP_WIN.domNode.parentNode){$CSS.addClass(TOOLTIP_WIN.domNode,["vis-tooltip-gm"]);document.body.appendChild(TOOLTIP_WIN.domNode);}TOOLTIP_WIN.displayInfo(info,pos);this.tooltipShape=shape;}}},hideTooltip:function(){var win=TOOLTIP_WIN.domNode;if(win&&win.parentNode){win.parentNode.removeChild(win);this.tooltipShape=undefined;}},getToolbarConfig:function(type,userInfo,fmtMode){var identity=userInfo?userInfo.identity:undefined,subType=userInfo.subType,tfg,gmCtr=this.widget&&this.widget.GMController;if(!fmtMode){return tfg;}switch(type){case CTRL_TYPE.GM_ROW_HEADER_TITLE:case CTRL_TYPE.GM_COL_HEADER_TITLE:case CTRL_TYPE.GM_ROW_HEADER:case CTRL_TYPE.GM_COL_HEADER:case CTRL_TYPE.GM_COL_HEADER_EXTRA:case CTRL_TYPE.GM_ROW_HEADER_EXTRA:tfg=getRowOrColToolbarEditor.call(this,type);break;case CTRL_TYPE.GM_SVG_X_CATEGORY:case CTRL_TYPE.GM_X_CATEGORY:var xCategoryChildren=[$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_COLOR,$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_FAMILY,$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_STYLE,$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_SIZE];tfg=getFontToolbar(this.widget,"xAxLb",xCategoryChildren,EnumControlScope.GLOBAL,undefined,false);break;case CTRL_TYPE.GM_SVG_Y_CATEGORY:case CTRL_TYPE.GM_Y_CATEGORY:var yCategoryChildren=[$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_COLOR,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_FAMILY,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_STYLE,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_SIZE];tfg=getFontToolbar(this.widget,"yAxLb",yCategoryChildren,EnumControlScope.GLOBAL,undefined,false);break;case CTRL_TYPE.LASSO_SELECTOR:tfg=null;break;case CTRL_TYPE.GM_SHAPE:var chartType=identity.getShape(),fillChildrenName=[$ENUM_FORMAT_TAG.SHAPE_FILL_COLOR,$ENUM_FORMAT_TAG.SHAPE_FILL_TRANSPARENCY],lineChildrenName=[$ENUM_FORMAT_TAG.SHAPE_LINE_COLOR,$ENUM_FORMAT_TAG.SHAPE_LINE_COMBINED_STYLE],borderChildrenName=[$ENUM_FORMAT_TAG.SHAPE_BORDER_COLOR,$ENUM_FORMAT_TAG.SHAPE_BORDER_COMBINED_STYLE],colorByDropZone=this.widget.model.data.dz.ColorBy;if(colorByDropZone.TemplateMetric&&!colorByDropZone.MetricNames){tfg=getFillOpacityAndBorderStyleToolbar(this.widget);break;}switch(chartType){case SHAPE_TYPE.TICK:tfg=getLineToolbar(this.widget,mstrmojo.desc(3546,"Line"),lineChildrenName,EnumControlScope.FORMATTING);break;case SHAPE_TYPE.LINE:if(subType===SHAPE_SUBTYPE.SCIRCLE||subType===SHAPE_SUBTYPE.SBAR){if(gmCtr.hasSizeBy()){tfg=getBorderAndFillEditor(this.widget,borderChildrenName,fillChildrenName,EnumControlScope.FORMATTING,chartType);}else{tfg=getLineToolbar(this.widget,mstrmojo.desc(3546,"Line"),lineChildrenName,EnumControlScope.FORMATTING);}}else{var lineColor=getFormatPropertyValue(this.widget,$ENUM_FORMAT_TAG.SHAPE_LINE_COLOR,EnumControlScope.FORMATTING);tfg=getMarkerColorpicker(this.widget,lineColor,mstrmojo.desc(11970,"same as line color"));}break;case SHAPE_TYPE.AREA:if(subType===SHAPE_SUBTYPE.SCIRCLE){tfg=getBorderAndFillEditor(this.widget,borderChildrenName,fillChildrenName,EnumControlScope.FORMATTING,chartType);}else{var fillColor=getFormatPropertyValue(this.widget,$ENUM_FORMAT_TAG.SHAPE_FILL_COLOR,EnumControlScope.FORMATTING);tfg=getMarkerColorpicker(this.widget,fillColor,mstrmojo.desc(11971,"same as area color"));}break;case SHAPE_TYPE.BAR:case SHAPE_TYPE.CIRCLE:case SHAPE_TYPE.SQUARE:case SHAPE_TYPE.PIE:case SHAPE_TYPE.RING:tfg=getBorderAndFillEditor(this.widget,borderChildrenName,fillChildrenName,EnumControlScope.FORMATTING,chartType);break;default:tfg=null;}break;case CTRL_TYPE.GM_DATA_LABEL:var dataLabelChildren=[$ENUM_FORMAT_TAG.DATA_LABELS_FONT_FAMILY,$ENUM_FORMAT_TAG.DATA_LABELS_FONT_SIZE,$ENUM_FORMAT_TAG.DATA_LABELS_FONT_STYLE,$ENUM_FORMAT_TAG.DATA_LABELS_FONT_COLOR];tfg=getFontToolbar(this.widget,"dl",dataLabelChildren,EnumControlScope.GLOBAL,undefined,false);break;case CTRL_TYPE.GM_SVG_X_NUMERIC:var xNumericChildren=[$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_COLOR,$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_FAMILY,$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_STYLE,$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_SIZE];tfg=getFontToolbar(this.widget,"xAxLb",xNumericChildren,EnumControlScope.GLOBAL);break;case CTRL_TYPE.GM_SVG_Y_NUMERIC:var yNumericChildren=[$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_COLOR,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_FAMILY,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_STYLE,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_SIZE];tfg=getFontToolbar(this.widget,"yAxLb",yNumericChildren,EnumControlScope.GLOBAL);break;case CTRL_TYPE.GM_XLABEL:var xLabelChildren=[$ENUM_FORMAT_TAG.X_AXIS_TITLE_FONT_COLOR,$ENUM_FORMAT_TAG.X_AXIS_TITLE_FONT_FAMILY,$ENUM_FORMAT_TAG.X_AXIS_TITLE_FONT_STYLE,$ENUM_FORMAT_TAG.X_AXIS_TITLE_FONT_SIZE];tfg=getFontToolbar(this.widget,"xAxTt",xLabelChildren,EnumControlScope.GLOBAL,undefined,false);break;case CTRL_TYPE.GM_YLABEL:var yLabelChildren=[$ENUM_FORMAT_TAG.Y_AXIS_TITLE_FONT_COLOR,$ENUM_FORMAT_TAG.Y_AXIS_TITLE_FONT_FAMILY,$ENUM_FORMAT_TAG.Y_AXIS_TITLE_FONT_STYLE,$ENUM_FORMAT_TAG.Y_AXIS_TITLE_FONT_SIZE];tfg=getFontToolbar(this.widget,"yAxTt",yLabelChildren,EnumControlScope.GLOBAL,undefined,false);break;case CTRL_TYPE.GM_SVG_CHART:tfg=getFillToolbar(this.widget,mstrmojo.desc(3905,"Background"),[$ENUM_FORMAT_TAG.BG_COLOR],EnumControlScope.GLOBAL,{width:"60px",visibleControls:mstrmojo.ui.editors.controls.FillConfigGroup.CTRL_FLAGS.FILL_COLOR,showNoFill:false});break;case CTRL_TYPE.GM_TREND_LINE:var trendLineChildren=[$ENUM_XML_TAG.TREND_REF_LINE_COLOR,$ENUM_XML_TAG.TREND_REF_LINE_COMBINED_STYLE];tfg=getLineToolbar(this.widget,mstrmojo.desc(3546,"Line"),trendLineChildren,EnumControlScope.GLOBAL,{realPropName:$ENUM_XML_TAG.TREND_LINE_DEF,opt:identity.tlOpt});break;case CTRL_TYPE.GM_REF_LINE:var refLineChildren=[$ENUM_XML_TAG.TREND_REF_LINE_COLOR,$ENUM_XML_TAG.TREND_REF_LINE_COMBINED_STYLE];tfg=getLineToolbar(this.widget,mstrmojo.desc(3546,"Line"),refLineChildren,EnumControlScope.GLOBAL,{realPropName:$ENUM_XML_TAG.REF_LINE_DEF,opt:identity.tlOpt});break;case CTRL_TYPE.GM_XAXIS_LINE:case CTRL_TYPE.GM_XAXIS2_LINE:var xAxisChildren=[$ENUM_FORMAT_TAG.X_AXIS_LINE_COLOR,$ENUM_FORMAT_TAG.X_AXIS_LINE_COMBINED_STYLE];tfg=getLineToolbar(this.widget,mstrmojo.desc(3546,"Line"),xAxisChildren,EnumControlScope.GLOBAL);break;case CTRL_TYPE.GM_YAXIS_LINE:case CTRL_TYPE.GM_YAXIS2_LINE:var yAxisChildren=[$ENUM_FORMAT_TAG.Y_AXIS_LINE_COLOR,$ENUM_FORMAT_TAG.Y_AXIS_LINE_COMBINED_STYLE];tfg=getLineToolbar(this.widget,mstrmojo.desc(3546,"Line"),yAxisChildren,EnumControlScope.GLOBAL);break;case CTRL_TYPE.GM_V_MATRIX_LINE:case CTRL_TYPE.GM_V_CHART_LINE:case CTRL_TYPE.GM_H_MATRIX_LINE:case CTRL_TYPE.GM_H_CHART_LINE:var allMatrixLineChildren=[$ENUM_FORMAT_TAG.ALL_MATRIX_LINES_COLOR,$ENUM_FORMAT_TAG.ALL_MATRIX_LINES_COMBINED_STYLE];tfg=getLineToolbar(this.widget,mstrmojo.desc(3546,"Line"),allMatrixLineChildren,EnumControlScope.GLOBAL);break;case CTRL_TYPE.GM_H_GRID_LINE:case CTRL_TYPE.GM_V_GRID_LINE:case CTRL_TYPE.GM_H_MINOR_GRID_LINE:case CTRL_TYPE.GM_V_MINOR_GRID_LINE:tfg=getLineToolbar(this.widget,mstrmojo.desc(11991,"Grid Lines"),[$ENUM_FORMAT_TAG.ALL_GRID_LINES_COLOR,$ENUM_FORMAT_TAG.ALL_GRID_LINES_COMBINED_STYLE],EnumControlScope.GLOBAL,undefined,{showNoneOption:false});break;case CTRL_TYPE.GM_ORIGIN_LINE:var originLineNames;originLineNames=[$ENUM_FORMAT_TAG.ALL_AXIS_ORIGIN_LINE_COLOR,$ENUM_FORMAT_TAG.ALL_AXIS_ORIGIN_LINE_COMBINED_STYLE];tfg=getLineToolbar(this.widget,mstrmojo.desc(3546,"Line"),originLineNames,EnumControlScope.GLOBAL,undefined,{showNoneOption:false});break;case CTRL_TYPE.GM_X_NUMERIC:var xNumericNames=[$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_COLOR,$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_SIZE,$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_FAMILY,$ENUM_FORMAT_TAG.X_AXIS_LABELS_FONT_STYLE,$ENUM_FORMAT_TAG.X_AXIS_LABELS_ROTATION];tfg=getFontToolbar(this.widget,"xAxLb",xNumericNames,EnumControlScope.GLOBAL,undefined,false);break;case CTRL_TYPE.GM_Y_NUMERIC:var yNumericNames=[$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_COLOR,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_SIZE,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_FAMILY,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_FONT_STYLE,$ENUM_FORMAT_TAG.Y_AXIS_LABELS_ROTATION];tfg=getFontToolbar(this.widget,"yAxLb",yNumericNames,EnumControlScope.GLOBAL,undefined,false);break;default:tfg=null;}return tfg;},getMenuConfig:function(type,drillTo,userInfo,fmtMode){var i,fmtOptIdx,metrics,subType,selectionInfos,me=this,selectionInfo=userInfo?userInfo.selectionInfo:undefined,identity=userInfo?userInfo.identity:undefined,visGM=userInfo.visGM,gmCtr=visGM.GMController,chtInfo=gmCtr.getChartInfo(),n=drillTo.length,cfg=new $MOJO.ui.menus.MenuConfig(),pstMode=(mstrApp.appState===mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION),addDrillTo=function(attrId,forLasso){var refineDrillTo=function(attrId){var allDrillPaths=(function(){var res;$ARR.forEach(visGM.model.data.gts.row.concat(visGM.model.data.gts.col),function(unit){if(unit.id&&unit.id===attrId){res=unit.dp;data=unit;}});return res;}()),datasets=visGM.model.docModel.datasets,fnShowInUnits=function(units,drillPath){var i=$ARR.find(units,"did",drillPath.id),unit=units[i];if(unit&&!unit.hide){drillPath.n=unit.n;return true;}return false;},paths=$ARR.filter(allDrillPaths,function(drillPath){var key;for(key in datasets){var ds=datasets[key];if(fnShowInUnits(ds.att,drillPath)){return true;}}return false;});if(paths){drillTo=$ARR.filter(drillTo,function(dt){for(var i in paths){if(paths[i].n===dt.n){return true;}}return false;});n=drillTo.length;}else{n=0;}return n;},getDrillSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig({supportsScroll:true,maxHeight:350});for(i=0;i<n;i++){if(forLasso){subMenu.addMenuItem(drillTo[i].n,"xt",visGM.getMenuHandler("selectionKeepOnlyAndShow"),{drillUnit:drillTo[i]});}else{subMenu.addMenuItem(drillTo[i].n,"xt",visGM.getMenuHandler("headerDrill"),{drillUnit:drillTo[i],fromUnit:{tid:identity.tid,isRowAttribute:identity.isRowAttribute}});}}return subMenu;},getDrillToMenuItem=function(){if(forLasso){cfg.addMenuItem(mstrmojo.desc(11698,"Drill to ##").replace("##",drillTo[0].n),"xt",visGM.getMenuHandler("selectionKeepOnlyAndShow"),{drillUnit:drillTo[0]});}else{cfg.addMenuItem(mstrmojo.desc(11698,"Drill to ##").replace("##",drillTo[0].n),"xt",visGM.getMenuHandler("headerDrill"),{drillUnit:drillTo[0],fromUnit:{tid:identity.tid,isRowAttribute:identity.isRowAttribute}});}};n=refineDrillTo(attrId);switch(n){case 0:cfg.addNonInteractiveMenuItem(mstrmojo.desc(145,"Drill"),"",true);break;case 1:getDrillToMenuItem();break;default:cfg.addSubMenuItem(mstrmojo.desc(145,"Drill"),"",me.id,getDrillSubMenu);}},getAttrListSubMenu=function(attrArr){var gmZones=me.widget.zonesModel.gmZones,subMenu=new $MOJO.ui.menus.MenuConfig();$ARR.forEach(attrArr,function(att){subMenu.addEditorMenuItem(att.n,gmZones.id,function(){return me.getDisplayFormsMenu(att);});});return subMenu;},addAttributeForm=function(){if(identity){var attrIdArr=identity.attrIdArr,gmZones=me.widget.zonesModel.gmZones,datasets=me.widget.zonesModel.docModel.datasets,multiFormsAttr=[],attrItems=[];if(attrIdArr&&attrIdArr.length>0){multiFormsAttr=$ARR.filter(attrIdArr,function(attrId){return $DU.hasMultiForms(attrId,datasets);});attrItems=multiFormsAttr.map(function(attId){return findDropZoneItem(gmZones,attId);});if(attrItems.length>0){cfg.addEditorMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),gmZones.id,function(){return getAttrListSubMenu(attrItems);});}}else{var tid=identity.tid,item=findDropZoneItem(gmZones,tid);if($DU.hasMultiForms(item.did,datasets)){cfg.addEditorMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),gmZones.id,function(){return me.getDisplayFormsMenu(item);});}}}},getReferenceLineSubMenuForChart=function(){var SUB_TYPE=mstrmojo.gm.EnumSubtype,resultantSubtype=gmCtr.chartSubType,scopeId=visGM.id;if(chtInfo.isABL&&resultantSubtype===SUB_TYPE.PERCENT){return ;}var metrics=GMUTIL.getAxisMetricsInfo(visGM),getAvaiableMetricIds=function(refType){var availableMetricIds=[];metrics.forEach(function(m){var availableRefTypes=visGM.getAvailableRefLineTypes(m.did);if(availableRefTypes.indexOf(refType)!==-1){availableMetricIds.push(m.did);}});return availableMetricIds;},doAddReferenceLine=function(availableMetricIds,refType,constVal){var metricOpt,refOpt,currentProp,axisKey,handleConfig,modix,enabled=true,enabledActions=[],puFiltersConfig=visGM.getPartialUpdateFilterConfigForRefLine(),uniqMap=[];availableMetricIds.forEach(function(mid){visGM.checkCustomScaleNotificationForReferenceLine(mid);metricOpt=visGM.getReferenceOptionForMetricId(mid);if(metricOpt===undefined){return true;}refOpt=visGM.getRealReferenceOptionFromAxisOption(metricOpt,refType,modix);currentProp=visGM.readGlobalProperty($ENUM_XML_TAG.REF_LINE_DEF,refOpt);if(refType===$GM.EnumRefLineModelType.CONST){currentProp.setProperty($ENUM_XML_TAG.REF_CONST_VALUE,$NUM.parseNumeric(constVal));}else{currentProp.setProperty($ENUM_XML_TAG.REF_ENABLED,enabled);}axisKey=refOpt.key.split(",")[0];if(uniqMap[axisKey]){return true;}else{uniqMap[axisKey]="record";}handleConfig=visGM.processReferenceLine($ENUM_XML_TAG.REF_LINE_DEF,currentProp,refOpt);enabledActions=enabledActions.concat(handleConfig.actions);});visGM.submitUpdatesAndPersistXML(enabledActions,visGM.getXTabRefreshCallBack(),undefined,false,false,puFiltersConfig);},getAddReferenceLineCfg=function(){var refLineCfg=[];Object.keys($GM.EnumRefLineModelType).forEach(function(refName){var refType=$GM.EnumRefLineModelType[refName],availableMetricIds;availableMetricIds=getAvaiableMetricIds(refType);if(availableMetricIds.length){refLineCfg.push({refType:refType,metricIds:availableMetricIds});}});return refLineCfg;},getAddReferenceLineSubMenuForAllMetric=function(itemContext){var refLineCfg=itemContext.refLineCfg,subMenu=new $MOJO.ui.menus.MenuConfig();refLineCfg.forEach(function(config){var refType=config.refType,availableMetricIds=config.metricIds;if(refType!==$GM.EnumRefLineModelType.CONST){subMenu.addMenuItem(REF_TYPE_DESCS[refType],"xt",function(){doAddReferenceLine(availableMetricIds,refType,0);});}else{subMenu.addEditorMenuItem(REF_TYPE_DESCS[refType],scopeId,function(){return new mstrmojo.ui.menus.EditorConfig({data:{},contents:[{scriptClass:"mstrmojo.ValidationTextBox",alias:"constVal",dtp:$DTP.FLOAT,constraints:{trigger:mstrmojo.validation.TRIGGER.ONBLUR},onEnter:function(){this.validate();}}],fnOk:function(data,editor){var txtWgt=editor.constVal;if(txtWgt.isValid()){doAddReferenceLine(availableMetricIds,refType,txtWgt.value);}}});});}});return subMenu;};var refLineCfg=getAddReferenceLineCfg();if(refLineCfg.length>0){cfg.addSubMenuItem(mstrmojo.desc(13021,"Add Reference Line"),"xt",scopeId,getAddReferenceLineSubMenuForAllMetric,{refLineCfg:refLineCfg});}},getMetricSubMenu=function(metricName,extraInfo){var subMenu=new $MOJO.ui.menus.MenuConfig();var combinedDZ=visGM.zonesModel,DZ=combinedDZ.gmZones,item=null,items=[],zone=(function(){var zones,i,j;zones=DZ.dropZones;for(i in zones){if(zones.hasOwnProperty(i)){items=zones[i].items;for(j in items){if(items.hasOwnProperty(j)){if(items[j].did===extraInfo.mid){item=items[j];return zones[i];}}}}}}()),itemContext={zone:zone,axis:zone&&zone.id,idx:$ARR.find(items,"id",item.id),cnt:items.length,item:item,useDropzone:true};if(item.um){subMenu.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){combinedDZ.editDerivedMetric(itemContext,"edit");},itemContext);subMenu.addSeparator();}if(chtInfo.isABL){subMenu.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortMetricTitle"),{isAsc:true,selInfo:extraInfo});subMenu.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortMetricTitle"),{isAsc:false,selInfo:extraInfo});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){subMenu.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}subMenu.addSeparator();}subMenu.addMenuItem(mstrmojo.desc(11700,"Axis Scale..."),"xt",GMUTIL.getEditAxisScaleHandler(visGM,extraInfo.mid));subMenu.addMenuItem(mstrmojo.desc(11987,"Log Scale"),"xt",GMUTIL.getEditLogScaleHandler(visGM,extraInfo.mid));subMenu.addMenuItem(mstrmojo.desc(11988,"Axis Origin"),"xt",GMUTIL.getEditAxisOriginHandler(visGM,extraInfo.mid));subMenu.addSeparator();if(DZ.docModel.findDatasetIdFromUnit(item.did)&&!DZ.docModel.isFromSolrCube(item.did)&&!DZ.docModel.isFromMDXCube(item.did)){subMenu.addSubMenuItem(mstrmojo.desc(11806,"Aggregate By"),"xt",combinedDZ.id,combinedDZ.getAggregateByMetricSubMenu,itemContext);subMenu.addSeparator();}subMenu.addEditorMenuItem(mstrmojo.desc(5188,"Calculation"),combinedDZ.id,combinedDZ.getCalculationEditorCfg,itemContext);subMenu.addSubMenuItem(mstrmojo.desc(12287,"Shortcut Metric"),"xt",combinedDZ.id,combinedDZ.getShortcutMetricSubMenu,itemContext);subMenu.addMenuItem(mstrmojo.desc(13624,"New Metric..."),"xt",function(){combinedDZ.newDerivedMetric(itemContext);},itemContext);subMenu.addSeparator();if(DZ.shouldShowCondensedMenu(zone,item)){var isOn=item.cds;var fnOn=DZ.getCondenseLableHandler(zone,itemContext,true),fnOff=DZ.getCondenseLableHandler(zone,itemContext,false);subMenu.addToggleMenuItem(mstrmojo.desc(13660,"Condense Label"),"",fnOn,fnOff,DZ.id,isOn);}if(DZ.showNumberFormat(item)){subMenu.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),DZ.id,DZ.getNumberFormatEditorCfg,itemContext);subMenu.addSeparator();}if(chtInfo.isABL&&!chtInfo.isPie){subMenu.addSeparator();GMUTIL.getSubMenu(visGM,subMenu,extraInfo.mid,extraInfo.midx);}subMenu.addSeparator();var metricIdxOnAxis=gmCtr.getMetricsOnXAxis().concat(gmCtr.getMetricsOnYAxis()),metricIdsOnAxis=gmCtr.model.getMetricIDsFromIndex(metricIdxOnAxis),isAxisMetric=false;if(extraInfo.mid){if(metricIdsOnAxis.indexOf(extraInfo.mid)>=0){isAxisMetric=true;}}var skipTrd=false;if(chtInfo.isBubbleOrScatter){var mtx=visGM.GMController.getMetricsOnXAxis();if(mtx.indexOf(extraInfo.midx)>=0){skipTrd=true;}}else{if(!isAxisMetric){skipTrd=true;}}skipTrd=skipTrd||!GMUTIL.isTrendLineAvailableForMetric(visGM,extraInfo.midx);if(!skipTrd){subMenu.addToggleMenuItem(mstrmojo.desc(12155,"Enable trendline for ##").replace("##",metricName),"xt",GMUTIL.getTrendLineToggleHandler(visGM,extraInfo.mid,true),GMUTIL.getTrendLineToggleHandler(visGM,extraInfo.mid,false),me.id,GMUTIL.getTrendLineToggleState(visGM,extraInfo.mid));var opt=GMUTIL.getOptionObjArr.call(gmCtr,[item.idx]),existingPV=visGM.readGlobalProperty($ENUM_XML_TAG.TREND_LINE_DEF,opt);if(existingPV.jsonObj.trdEnabled){subMenu.addMenuItem(mstrmojo.desc(12163,"Edit trendline..."),"xt",GMUTIL.getEditTrendLineHandler(visGM,extraInfo.mid));}}var skipRef=false;if(gmCtr.isStacked&&!gmCtr.splitPlottingMetrics){skipRef=true;}else{if(!isAxisMetric){skipRef=true;}}skipRef=skipRef||GMUTIL.isIgnoredMetric(visGM,extraInfo.midx);if(!skipRef){GMUTIL.getReferenceLineSubMenu(visGM,subMenu,chtInfo.isABL,extraInfo.mid);}subMenu.addSeparator();fmtOptIdx=subMenu.getMenuItems().length;if(DZ.hasReplaceCandidates(itemContext)){subMenu.addSubMenuItem(mstrmojo.desc(14003,"Replace With"),"",visGM.zonesModel.id,DZ.getReplaceSubMenu,itemContext);}if(extraInfo.elem&&extraInfo.elem.firstChild){addRenameMenuItem(visGM,subMenu,extraInfo.elem.firstChild,item);}subMenu.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){DZ.deleteItem(zone,itemContext.idx);});return subMenu;},getMarkerShowSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig();function getMarkerShowToggleMenu(){function markerDisplayChanged(){return function(newValue,oldValue){if(oldValue!==newValue){me.widget.writeGlobalProperty($ENUM_FORMAT_TAG.LINE_MARKER_SHOW,newValue);}};}return function(){var markerDisplayOptions=[];[{text:mstrmojo.desc(2969,"Show"),value:true},{text:mstrmojo.desc(2772,"Hide"),value:false}].forEach(function(opt){markerDisplayOptions.push(opt);});var rst=me.widget.readGlobalProperty($ENUM_FORMAT_TAG.LINE_MARKER_SHOW);subMenu.addRadioMenuGroup(rst,markerDisplayChanged(),markerDisplayOptions,"checkMark",undefined,true);return subMenu;};}(getMarkerShowToggleMenu())();return subMenu;},getDataLabelShowSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig(),assMetricDLID=identity.getAssMetricDataLabelID(),metricLvlDL=visGM.readGlobalProperty($ENUM_XML_TAG.METRIC_LEVEL_DATA_LABEL).jsonObj;function getChangeShapeRadioToggleMenu(visGM){function dataLabelStateChanged(){return function(newValue,oldValue){var postRaiseEventArr;if(newValue!==oldValue){if(newValue!==$GM.EnumDataLabels.HIDE){metricLvlDL[assMetricDLID]=true;var allMetricTrue=true,n;for(n in metricLvlDL){if(n!=="AllMetrics"&&metricLvlDL.hasOwnProperty(n)){if(metricLvlDL[n]===false){allMetricTrue=false;}}}if(metricLvlDL.AllMetrics!==undefined){metricLvlDL.AllMetrics=allMetricTrue;}visGM.setWidgetPropertyValue($ENUM_XML_TAG.METRIC_LEVEL_DATA_LABEL,metricLvlDL);postRaiseEventArr=[{value:true,name:$ENUM_XML_TAG.METRIC_LEVEL_DATA_LABEL,option:GMUTIL.getOptionObjArr.call(gmCtr,[gmCtr.getMetricIndexFromID(assMetricDLID)])}];}visGM.writeGlobalProperty($ENUM_XML_TAG.DATA_LABEL,newValue,undefined,undefined,postRaiseEventArr);}};}function getCurrentState(){var dlType=visGM.readGlobalProperty($ENUM_XML_TAG.DATA_LABEL);if(!metricLvlDL[assMetricDLID]){return $GM.EnumDataLabels.HIDE;}return dlType;}return function(){var availableOptions=[];if(gmCtr.textTypeDataLabelEnabled()){availableOptions.push({text:mstrmojo.desc(13663,"Only Text"),value:$GM.EnumDataLabels.SHOW_TEXT_ONLY});}if(gmCtr.valueTypeDataLabelEnabled()){availableOptions.push({text:mstrmojo.desc(13664,"Only Value"),value:$GM.EnumDataLabels.SHOW_VALUE_ONLY});}availableOptions.push({text:mstrmojo.desc(2057,"None"),value:$GM.EnumDataLabels.HIDE});subMenu.addRadioMenuGroup(getCurrentState(),dataLabelStateChanged(),availableOptions,"checkMark",undefined,true);return subMenu;};}(getChangeShapeRadioToggleMenu(visGM))();return subMenu;},getHeaderTitleMenuInFmtMode=function(){var me=this;var getRowAndColumnHeaderShowSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig();function rowAndColumnHeaderShowStateChangedCallback(newValue,oldValue){if(newValue!==oldValue){if(type===CTRL_TYPE.GM_ROW_HEADER_TITLE){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.ROW_HEADER_SHOW,newValue);}else{if(type===CTRL_TYPE.GM_COL_HEADER_TITLE){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.COLUMN_HEADER_SHOW,newValue);}}}}var headerShowStateOptions=[];[{text:mstrmojo.desc(2969,"Show"),value:true},{text:mstrmojo.desc(2772,"Hide"),value:false}].forEach(function(opt){headerShowStateOptions.push(opt);});if(type===CTRL_TYPE.GM_ROW_HEADER_TITLE){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.ROW_HEADER_SHOW),rowAndColumnHeaderShowStateChangedCallback,headerShowStateOptions,"checkMark",undefined,true);}else{if(type===CTRL_TYPE.GM_COL_HEADER_TITLE){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.COLUMN_HEADER_SHOW),rowAndColumnHeaderShowStateChangedCallback,headerShowStateOptions,"checkMark",undefined,true);}}return subMenu;};var showText="default text";if(type===CTRL_TYPE.GM_ROW_HEADER_TITLE){showText=mstrmojo.desc(12014,"Row Headers");}else{if(type===CTRL_TYPE.GM_COL_HEADER_TITLE){showText=mstrmojo.desc(12015,"Column Headers");}}cfg.addSubMenuItem(showText,"xt",me.id,getRowAndColumnHeaderShowSubMenu);},getHeaderValueMenuInFmtMode=function(){var getRowAndColumnValuesShowSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig();function rowAndColumnValuesShowStateChangedCallback(newValue,oldValue){if(newValue!==oldValue){if(type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_ROW_HEADER_EXTRA){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.ROW_VALUES_SHOW,newValue);if(hasTargetSelected.call(me,CTRL_TYPE.GM_ROW_HEADER_TITLE)){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.ROW_HEADER_SHOW,newValue);}}else{if(type===CTRL_TYPE.GM_COL_HEADER||type===CTRL_TYPE.GM_COL_HEADER_EXTRA){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.COLUMN_VALUES_SHOW,newValue);if(hasTargetSelected.call(me,CTRL_TYPE.GM_COL_HEADER_TITLE)){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.COLUMN_HEADER_SHOW,newValue);}}}}}var valuesShowStateOptions=[];[{text:mstrmojo.desc(2969,"Show"),value:true},{text:mstrmojo.desc(2772,"Hide"),value:false}].forEach(function(opt){valuesShowStateOptions.push(opt);});if(type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_ROW_HEADER_EXTRA){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.ROW_VALUES_SHOW),rowAndColumnValuesShowStateChangedCallback,valuesShowStateOptions,"checkMark",undefined,true);}else{if(type===CTRL_TYPE.GM_COL_HEADER||type===CTRL_TYPE.GM_COL_HEADER_EXTRA){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.COLUMN_VALUES_SHOW),rowAndColumnValuesShowStateChangedCallback,valuesShowStateOptions,"checkMark",undefined,true);}}return subMenu;};var showText="default text";if(type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_ROW_HEADER_EXTRA){if(hasTargetSelected.call(me,CTRL_TYPE.GM_ROW_HEADER_TITLE)){showText=mstrmojo.desc(13665,"Row Text");}else{showText=mstrmojo.desc(12016,"Row Values");}}else{if(type===CTRL_TYPE.GM_COL_HEADER||type===CTRL_TYPE.GM_COL_HEADER_EXTRA){if(hasTargetSelected.call(me,CTRL_TYPE.GM_COL_HEADER_TITLE)){showText=mstrmojo.desc(13666,"Column Text");}else{showText=mstrmojo.desc(12017,"Column Values");}}}cfg.addSubMenuItem(showText,"xt",this.id,getRowAndColumnValuesShowSubMenu);},getShowHideRowColOption=function(){var showText="no selection is made",hideFunction;var isRowHeaderShow=visGM.readGlobalProperty($ENUM_FORMAT_TAG.ROW_HEADER_SHOW),isRowValueShow=visGM.readGlobalProperty($ENUM_FORMAT_TAG.ROW_VALUES_SHOW),isColHeaderShow=visGM.readGlobalProperty($ENUM_FORMAT_TAG.COLUMN_HEADER_SHOW),isColValueShow=visGM.readGlobalProperty($ENUM_FORMAT_TAG.COLUMN_VALUES_SHOW);var selectedTypes=getRowColumnSelectedState(me.selectedTargets||[]);if(selectedTypes===HEADER_TITLE_SELECT_STATE.ROW_HEADER){showText=isRowHeaderShow?mstrmojo.desc(13667,"Hide row header"):mstrmojo.desc(13668,"Show row header");hideFunction=function(){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.ROW_HEADER_SHOW,!isRowHeaderShow);};}else{if(selectedTypes===HEADER_TITLE_SELECT_STATE.ROW_VALUE){showText=isRowValueShow?mstrmojo.desc(13669,"Hide row value"):mstrmojo.desc(13670,"Show row value");hideFunction=function(){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.ROW_VALUES_SHOW,!isRowValueShow);};}else{if(selectedTypes===HEADER_TITLE_SELECT_STATE.COL_HEADER){showText=isColHeaderShow?mstrmojo.desc(13671,"Hide column header"):mstrmojo.desc(13672,"Show column header");hideFunction=function(){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.COLUMN_HEADER_SHOW,!isColHeaderShow);};}else{if(selectedTypes===HEADER_TITLE_SELECT_STATE.COL_VALUE){showText=isColValueShow?mstrmojo.desc(13673,"Hide column value"):mstrmojo.desc(13674,"Show column value");hideFunction=function(){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.COLUMN_VALUES_SHOW,!isColValueShow);};}else{if(selectedTypes===(HEADER_TITLE_SELECT_STATE.ROW_VALUE|HEADER_TITLE_SELECT_STATE.ROW_HEADER)){showText=mstrmojo.desc(13675,"Hide row text");hideFunction=function(){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.ROW_TEXT_SHOW,false);};}else{if(selectedTypes===(HEADER_TITLE_SELECT_STATE.COL_VALUE|HEADER_TITLE_SELECT_STATE.COL_HEADER)){showText=mstrmojo.desc(13676,"Hide column text");hideFunction=function(){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.COLUMN_TEXT_SHOW,false);};}}}}}}cfg.addMenuItem(showText,"xt",hideFunction);},getGridLineShowSubMenu=function(menuConfig){var subMenu=menuConfig||new $MOJO.ui.menus.MenuConfig(),gridLineOptions=[{text:mstrmojo.desc(6019,"Automatic"),value:$GM.EnumGridLines.AUTO},{text:mstrmojo.desc(13677,"Show Major and Minor"),value:$GM.EnumGridLines.SHOW},{text:mstrmojo.desc(13678,"Show Major Only"),value:$GM.EnumGridLines.SHOW_MAJOR_ONLY},{text:mstrmojo.desc(2772,"Hide"),value:$GM.EnumGridLines.HIDE}];function gridLineStateChanged(){return function(newValue,oldValue){if(oldValue!==newValue){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.ALL_GRID_LINES_SHOW,newValue);}};}subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.ALL_GRID_LINES_SHOW),gridLineStateChanged(),gridLineOptions,"checkMark",undefined,true);return subMenu;},addMultiMetricSubMenu=function(selectionMetric){var combinedDZ=visGM.zonesModel,DZ=combinedDZ.gmZones,items,zone=(function(){var zones,i,j;zones=DZ.dropZones;for(i in zones){items=zones[i].items;for(j in items){if(items[j].did===selectionMetric.mid){return zones[i];}}}}()),selItems=[];$ARR.forEach(multiMetrics,function(metric){var mid=metric.mid,idx=$ARR.find(items,"did",mid);if(idx!==-1){selItems.push(items[idx]);}});cfg.addEditorMenuItem(mstrmojo.desc(5188,"Calculation"),combinedDZ.id,function(){return mstrmojo.all[combinedDZ.id].getMultipleMetricsCalcMenus(zone,selItems,true);});cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){DZ.deleteItems(selItems,true);});};if(selectionInfo){selectionInfo.elem=userInfo.elem;}var DZ,item,items,zone,itemContext,itemNotFromMDXCube,tid,attributeCPPool,selInfo,isMngdCG,EGTitle,result,getAxisLabelsShowSubMenu=mstrmojo.emptyFn,getAxisTitleShowSubMenu=mstrmojo.emptyFn,isDynamicLinkAttr;switch(type){case CTRL_TYPE.GM_ROW_HEADER_TITLE:case CTRL_TYPE.GM_COL_HEADER_TITLE:if(fmtMode){getShowHideRowColOption.call(this,me.widget.preClickType===mstrmojo.gm.EnumClickType.DOUBLE_CLICK);}else{if(pstMode){cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:true,identity:identity});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:false,identity:identity});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}cfg.addSeparator();addDrillTo(identity&&identity.tid);}else{if(identity.otp===47&&(identity.ost===12033||identity.ost===12032)){DZ=visGM.zonesModel.gmZones;zone=(function(){var zones,i,j;zones=DZ.dropZones;for(i in zones){items=zones[i].items;for(j in items){if(items[j].did===userInfo.identity.tid){item=items[j];return zones[i];}}}}());itemContext={zone:zone,axis:zone&&zone.id,idx:$ARR.find(items,"id",item.id),cnt:items.length,item:item,useDropzone:true};if(identity.ost===12033){cfg.addMenuItem(mstrmojo.desc(13296,"Edit Groups..."),"eg",DZ.getCreateOrEditElementGroupFunc(itemContext));cfg.addSeparator();}cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:true,identity:identity});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:false,identity:identity});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}cfg.addSeparator();}else{DZ=visGM.zonesModel.gmZones;zone=(function(){var zones,i,j;zones=DZ.dropZones;for(i in zones){items=zones[i].items;for(j in items){if(items[j].did===userInfo.identity.tid){item=items[j];return zones[i];}}}}());itemContext={zone:zone,axis:zone&&zone.id,idx:$ARR.find(items,"id",item.id),cnt:items.length,item:item,useDropzone:true};itemNotFromMDXCube=!DZ.docModel.isFromMDXCube(item.did);if(item.da&&itemNotFromMDXCube){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){DZ.editDerivedAttribute(itemContext);},itemContext);cfg.addSeparator();}cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:true,identity:identity});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:false,identity:identity});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}cfg.addSeparator();isDynamicLinkAttr=DZ.isDynamicLink(item);if(DZ.allowInsertNewAttribute(zone)&&!$VISUTIL.hasCGorCon(visGM,item)&&itemNotFromMDXCube&&!isDynamicLinkAttr){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){DZ.newDerivedAttribute(itemContext);},itemContext);}isMngdCG=item.t===47&&DZ.getUnitInfoInTemplate(item.did).unit.ost===12033;EGTitle=DZ.isAttribute(item)?mstrmojo.desc(13295,"Create Groups..."):(isMngdCG?mstrmojo.desc(13296,"Edit Groups..."):null);if(EGTitle!==null&&!isDynamicLinkAttr){cfg.addMenuItem(EGTitle,"eg",DZ.getCreateOrEditElementGroupFunc(itemContext));}cfg.addSeparator();if(DZ.showNumberFormat(item)){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),DZ.id,DZ.getNumberFormatEditorCfg,itemContext);}addDrillTo(identity&&identity.tid);if(!isDynamicLinkAttr){addAttributeForm();}cfg.addSeparator();}fmtOptIdx=cfg.getMenuItems().length;if(DZ.hasReplaceCandidates(itemContext)){cfg.addSubMenuItem(mstrmojo.desc(14003,"Replace With"),"",visGM.zonesModel.id,DZ.getReplaceSubMenu,itemContext);}if(userInfo.elem&&userInfo.elem.firstChild){addRenameMenuItem(visGM,cfg,userInfo.elem.firstChild,item);}cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){DZ.deleteItem(zone,itemContext.idx);});}}break;case CTRL_TYPE.GM_ROW_HEADER:case CTRL_TYPE.GM_COL_HEADER:if(fmtMode){getShowHideRowColOption.call(this,me.widget.preClickType===mstrmojo.gm.EnumClickType.DOUBLE_CLICK);}else{var supportViewFilter=true,supportViewFilterPool=gmCtr.supportViewFilterPool;if(!supportViewFilterPool[identity.tid]){supportViewFilter=false;}(this.selectedTargets||[]).forEach(function(selTarget){var iden=selTarget.identity;if(!supportViewFilterPool[iden.tid]){supportViewFilter=false;}});if(supportViewFilter){cfg.addMenuItem(mstrmojo.desc(11701,"Keep Only"),"xt",visGM.getMenuHandler("headerKeepOnly"),{selInfo:selectionInfo,identity:identity});cfg.addMenuItem(mstrmojo.desc(3946,"Exclude"),"xt",visGM.getMenuHandler("headerExclude"),{selInfo:selectionInfo,identity:identity});addDrillTo(identity&&identity.tid);cfg.addSeparator();}if(pstMode){if(supportViewFilter){cfg.addMenuItem(mstrmojo.desc(13537,"Show Data..."),"xt",visGM.getMenuHandler("selectionShowData"));}}else{var idt=me.selectedTargets[0].identity,data={at:idt.at,dei:idt.dei,dpt:idt.dpt,o:idt.o,n:idt.n,tui:idt.tui,ui:idt.tui,axis:idt.isRowAttribute?1:2,v:idt.v,tid:idt.tid};result=$VISUTIL.getGroupAndCalculationContextMenu(visGM,data,{selection:me.selectedTargets||[],fnCellName:function(cell){return cell.innerText||cell.textContent;}});["editGroup","editCalculation","createDe"].forEach(function(name){$VISUTIL.absorbMenuItems(cfg,result[name],true);});if(supportViewFilter){cfg.addMenuItem(mstrmojo.desc(13537,"Show Data..."),"xt",visGM.getMenuHandler("selectionShowData"));}if(result.renameDe.menus.length>0){cfg.addSeparator();}$VISUTIL.absorbMenuItems(cfg,result.renameDe);if(result.renameDe.menus.length>0){fmtOptIdx=cfg.getMenuItems().length-1;}}}break;case CTRL_TYPE.GM_X_CATEGORY:case CTRL_TYPE.GM_Y_CATEGORY:if(pstMode){tid=(userInfo.identity.tid||userInfo.identity.attrIdArr[0]);attributeCPPool=gmCtr.attributeSelectionInfo;selInfo=attributeCPPool[tid];cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:true,selInfo:selInfo});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:false,selInfo:selInfo});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}}else{if(fmtMode){getAxisLabelsShowSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig();function getChangeAxisLabelsShowRadioToggleMenu(visGM){function axisLabelsStateChanged(){return function(newValue,oldValue){if(newValue!==oldValue){if(type===CTRL_TYPE.GM_X_CATEGORY){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_LABELS_SHOW,newValue);}else{if(type===CTRL_TYPE.GM_Y_CATEGORY){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_LABELS_SHOW,newValue);}}}};}return function(){var axisLabelsStateOptions=[];[{text:mstrmojo.desc(2969,"Show"),value:true},{text:mstrmojo.desc(2772,"Hide"),value:false}].forEach(function(opt){axisLabelsStateOptions.push(opt);});if(type===CTRL_TYPE.GM_X_CATEGORY){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_LABELS_SHOW),axisLabelsStateChanged(),axisLabelsStateOptions,"checkMark",undefined,true);}else{if(type===CTRL_TYPE.GM_Y_CATEGORY){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_LABELS_SHOW),axisLabelsStateChanged(),axisLabelsStateOptions,"checkMark",undefined,true);}}return subMenu;};}(getChangeAxisLabelsShowRadioToggleMenu(visGM))();return subMenu;};cfg.addSubMenuItem(mstrmojo.desc(12003,"Axis Labels"),"xt",this.id,getAxisLabelsShowSubMenu);var getAxisLabelsRotationSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig();function getChangeAxisLabelsRotationRadioToggleMenu(visGM){function axisLabelsRotationStateChanged(){return function(newValue,oldValue){if(newValue!==oldValue){if(type===CTRL_TYPE.GM_X_CATEGORY){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_LABELS_ROTATION,newValue);}else{if(type===CTRL_TYPE.GM_Y_CATEGORY){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_LABELS_ROTATION,newValue);}}}};}return function(){var axisLabelsRotationStateOptions=[];[{text:mstrmojo.desc(12284,"Automatic"),value:$GM.EnumLabelRotation.AUTOMATIC},{text:mstrmojo.desc(12285,"Vertical"),value:$GM.EnumLabelRotation.VERTICAL},{text:mstrmojo.desc(12286,"Horizontal"),value:$GM.EnumLabelRotation.HORIZONTAL}].forEach(function(opt){axisLabelsRotationStateOptions.push(opt);});if(type===CTRL_TYPE.GM_X_CATEGORY){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_LABELS_ROTATION),axisLabelsRotationStateChanged(),axisLabelsRotationStateOptions,"checkMark",undefined,true);}else{if(type===CTRL_TYPE.GM_Y_CATEGORY){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_LABELS_ROTATION),axisLabelsRotationStateChanged(),axisLabelsRotationStateOptions,"checkMark",undefined,true);}}return subMenu;};}(getChangeAxisLabelsRotationRadioToggleMenu(visGM))();return subMenu;};if(me.widget.preClickType===mstrmojo.gm.EnumClickType.DOUBLE_CLICK&&type===CTRL_TYPE.GM_X_CATEGORY){cfg.addSubMenuItem(mstrmojo.desc(12283,"Rotation"),"xt",this.id,getAxisLabelsRotationSubMenu);}}else{tid=(userInfo.identity.tid||userInfo.identity.attrIdArr[0]);attributeCPPool=gmCtr.attributeSelectionInfo;selInfo=attributeCPPool[tid];cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:true,selInfo:selInfo});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:false,selInfo:selInfo});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}cfg.addSeparator();DZ=visGM.zonesModel.gmZones;zone=(function(){var zones,i,j;zones=DZ.dropZones;for(i in zones){items=zones[i].items;for(j in items){if(items[j].did===tid){item=items[j];return zones[i];}}}}());itemContext={zone:zone,axis:zone&&zone.id,idx:$ARR.find(items,"id",item.id),cnt:items.length,item:item,useDropzone:true};itemNotFromMDXCube=!DZ.docModel.isFromMDXCube(item.did);if(item.da&&itemNotFromMDXCube){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){DZ.editDerivedAttribute(itemContext);},itemContext);}isDynamicLinkAttr=DZ.isDynamicLink(item);if(DZ.allowInsertNewAttribute(zone)&&!$VISUTIL.hasCGorCon(visGM,item)&&itemNotFromMDXCube&&!isDynamicLinkAttr){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){DZ.newDerivedAttribute(itemContext);},itemContext);}isMngdCG=item.t===mstrmojo.chart.model.enums.EnumDSSObjectType.DssTypeConsolidation&&DZ.getUnitInfoInTemplate(item.did).unit.ost===12033;EGTitle=DZ.isAttribute(item)?mstrmojo.desc(13295,"Create Groups..."):(isMngdCG?mstrmojo.desc(13296,"Edit Groups..."):null);if(EGTitle!==null&&!isDynamicLinkAttr){cfg.addMenuItem(EGTitle,"eg",DZ.getCreateOrEditElementGroupFunc(itemContext));}cfg.addSeparator();if(!isDynamicLinkAttr){addAttributeForm();}cfg.addSeparator();if(DZ.showNumberFormat(item)){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),DZ.id,DZ.getNumberFormatEditorCfg,itemContext);cfg.addSeparator();}fmtOptIdx=cfg.getMenuItems().length;cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){DZ.deleteItem(zone,itemContext.idx);});}}break;case CTRL_TYPE.LASSO_SELECTOR:case CTRL_TYPE.GM_SHAPE:case CTRL_TYPE.GM_MARKER:var chartType=identity&&identity.getShape();subType=userInfo.subType;var colorByDropZone=this.widget.model.data.dz.ColorBy,attrId;if(gmCtr.supportViewFilter&&me.selectedShapes){var dz=visGM.model.data.dz,dzs=[dz.SliceBy,dz.BreakBy,dz.XAxis,dz.YAxis,dz.Rows,dz.Columns],uniqAttrIds=[];me.selectedShapes.forEach(function(shape){shape.identity.objectInfo.forEach(function(identity){uniqAttrIds=uniqAttrIds.filter(function(idnt){return idnt!==identity.tid;});uniqAttrIds.push(identity.tid);});});$ARR.forEach(dzs,function(dz){if(dz.TemplateUnit){for(var i=dz.TemplateUnit.length-1;i>=0;i--){if(uniqAttrIds.indexOf(dz.TemplateUnit[i].id)!==-1){attrId=dz.TemplateUnit[i].id;return false;}}}});if(attrId){cfg.addMenuItem(mstrmojo.desc(11701,"Keep Only"),"xt",visGM.getMenuHandler("selectionKeepOnly"));cfg.addMenuItem(mstrmojo.desc(3946,"Exclude"),"xt",visGM.getMenuHandler("selectionExclude"));addDrillTo(attrId,true);cfg.addSeparator();}}if(pstMode){if(attrId){cfg.addMenuItem(mstrmojo.desc(13537,"Show Data..."),"xt",visGM.getMenuHandler("selectionShowData"));cfg.addSeparator();}cfg.addSubMenuItem(mstrmojo.desc(11993,"Data Labels"),"",this.id,getDataLabelShowSubMenu);}else{if(!fmtMode){result=getGroupAndCalculationCMForDP(visGM,me.selectedShapes);["editGroup","editCalculation","createDe"].forEach(function(name){$VISUTIL.absorbMenuItems(cfg,result[name],true);});if(attrId){cfg.addMenuItem(mstrmojo.desc(13537,"Show Data..."),"xt",visGM.getMenuHandler("selectionShowData"));cfg.addSeparator();}cfg.addSubMenuItem(mstrmojo.desc(11993,"Data Labels"),"",this.id,getDataLabelShowSubMenu);if(subType){if(!colorByDropZone.TemplateMetric||colorByDropZone.MetricNames!==undefined){if((chartType===SHAPE_TYPE.LINE&&(subType===SHAPE_SUBTYPE.SCIRCLE||subType===SHAPE_SUBTYPE.SBAR))||subType==="ticker"){cfg.addPopupMenuItem(mstrmojo.desc(3523,"Line Color"),this.id,function(){return getColorPickerPopup(this.widget,userInfo.elem,colorByDropZone,{showNoFill:false,showAutomatic:true,showGradient:me.isShowGradientAllowed(chartType)});});}if((chartType===SHAPE_TYPE.AREA&&subType===SHAPE_SUBTYPE.SCIRCLE)||subType==="bar"||subType==="circle"||subType==="square"||subType==="gbar"||subType==="pie"||subType==="ring"){cfg.addPopupMenuItem(mstrmojo.desc(13619,"Shape Fill Color"),this.id,function(){return getColorPickerPopup(this.widget,userInfo.elem,colorByDropZone,{showNoFill:true,showAutomatic:true,showGradient:me.isShowGradientAllowed(chartType)});});}}}if(subType){if(this.isLineOrAreaPaint(chartType)&&(subType===SHAPE_SUBTYPE.SCIRCLE&&(chartType===SHAPE_TYPE.LINE||chartType===SHAPE_TYPE.AREA))||subType==="gmMarker"){cfg.addSubMenuItem(mstrmojo.desc(12159,"Marker"),"",this.id,getMarkerShowSubMenu);}}cfg.addSeparator();if(colorByDropZone.TemplateMetric&&!colorByDropZone.MetricNames){var metricsInColorByDropZone=$VISUTIL.getMetricsInDropZone(this.widget.zonesModel,mstrmojo.vi.viz.EnumDSSDropZones.ColorBy);cfg.addMenuItem(mstrmojo.desc(13174,"Select color ranges..."),"",function(){me.widget.model.openThresholdEditor(metricsInColorByDropZone[0],true,false);});}if(chtInfo.isABL&&!chtInfo.isPie){var res=identity&&identity.getSelectedObjectMetricInfo(),metricInfo=res&&res.length&&res[0],allMetrics=visGM.model.data.gts.col[visGM.model.data.gts.col.length-1].es,midx=0;if(metricInfo){$ARR.forEach(allMetrics,function(metric){if(metric.oid===metricInfo.eid){return false;}midx++;});cfg.addSeparator();GMUTIL.getSubMenu(visGM,cfg,metricInfo.eid,midx);}}else{if(chtInfo.isBubbleOrScatter){cfg.addSeparator();var chgShp=visGM.getMenuHandler("changeGlobalShape");if(chgShp){cfg.addSubMenuItem(mstrmojo.desc(11972,"Change Shape"),"",visGM.id,chgShp);}}}if(result.renameDe.menus.length>0){cfg.addSeparator();}$VISUTIL.absorbMenuItems(cfg,result.renameDe);if(result.renameDe.menus.length>0){fmtOptIdx=cfg.getMenuItems().length-1;}}}break;case CTRL_TYPE.GM_DATA_LABEL:cfg.addSubMenuItem(mstrmojo.desc(11993,"Data Labels"),"",this.id,getDataLabelShowSubMenu);break;case CTRL_TYPE.GM_X_NUMERIC:case CTRL_TYPE.GM_Y_NUMERIC:if(pstMode){selectionInfo=selectionInfo?selectionInfo:userInfo.selectionInfos[0];if(chtInfo.isABL&&userInfo.identity&&userInfo.identity.objType!==IDEN_TYPE.Y_ATTRIBUTE_AXIS_TITLE&&userInfo.identity.objType!==IDEN_TYPE.X_ATTRIBUTE_AXIS_TITLE){cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortMetricTitle"),{isAsc:true,selInfo:selectionInfo});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortMetricTitle"),{isAsc:false,selInfo:selectionInfo});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}}}else{if(fmtMode){getAxisLabelsShowSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig();function getChangeAxisLabelsShowRadioToggleMenu(visGM){function axisLabelsStateChanged(){return function(newValue,oldValue){if(newValue!==oldValue){if(type===CTRL_TYPE.GM_X_NUMERIC){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_LABELS_SHOW,newValue);}else{if(type===CTRL_TYPE.GM_Y_NUMERIC){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_LABELS_SHOW,newValue);}}}};}return function(){var axisLabelsStateOptions=[];[{text:mstrmojo.desc(2969,"Show"),value:true},{text:mstrmojo.desc(2772,"Hide"),value:false}].forEach(function(opt){axisLabelsStateOptions.push(opt);});if(type===CTRL_TYPE.GM_X_NUMERIC){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_LABELS_SHOW),axisLabelsStateChanged(),axisLabelsStateOptions,"checkMark",undefined,true);}else{if(type===CTRL_TYPE.GM_Y_NUMERIC){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_LABELS_SHOW),axisLabelsStateChanged(),axisLabelsStateOptions,"checkMark",undefined,true);}}return subMenu;};}(getChangeAxisLabelsShowRadioToggleMenu(visGM))();return subMenu;};cfg.addSubMenuItem(mstrmojo.desc(12003,"Axis Labels"),"xt",this.id,getAxisLabelsShowSubMenu);getAxisLabelsRotationSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig();function getChangeAxisLabelsRotationRadioToggleMenu(visGM){function axisLabelsRotationStateChanged(){return function(newValue,oldValue){if(newValue!==oldValue){if(type===CTRL_TYPE.GM_X_NUMERIC){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_LABELS_ROTATION,newValue);}else{if(type===CTRL_TYPE.GM_Y_NUMERIC){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_LABELS_ROTATION,newValue);}}}};}return function(){var axisLabelsRotationStateOptions=[];[{text:mstrmojo.desc(12284,"Automatic"),value:$GM.EnumLabelRotation.AUTOMATIC},{text:mstrmojo.desc(12285,"Vertical"),value:$GM.EnumLabelRotation.VERTICAL},{text:mstrmojo.desc(12286,"Horizontal"),value:$GM.EnumLabelRotation.HORIZONTAL}].forEach(function(opt){axisLabelsRotationStateOptions.push(opt);});if(type===CTRL_TYPE.GM_X_NUMERIC){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_LABELS_ROTATION),axisLabelsRotationStateChanged(),axisLabelsRotationStateOptions,"checkMark",undefined,true);}else{if(type===CTRL_TYPE.GM_Y_NUMERIC){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_LABELS_ROTATION),axisLabelsRotationStateChanged(),axisLabelsRotationStateOptions,"checkMark",undefined,true);}}return subMenu;};}(getChangeAxisLabelsRotationRadioToggleMenu(visGM))();return subMenu;};if(me.widget.preClickType===mstrmojo.gm.EnumClickType.DOUBLE_CLICK&&type===CTRL_TYPE.GM_X_NUMERIC){cfg.addSubMenuItem(mstrmojo.desc(12283,"Rotation"),"xt",this.id,getAxisLabelsRotationSubMenu);}}else{var multiMetrics=userInfo.multiMetrics;if(multiMetrics&&multiMetrics.length>1){addMultiMetricSubMenu(multiMetrics[0]);}else{metrics=userInfo.metrics;if(metrics){selectionInfos=userInfo.selectionInfos;n=metrics.length;if(n===1){if(selectionInfos[0]&&selectionInfos[0].elem){delete selectionInfos[0].elem;}$VISUTIL.absorbMenuItems(cfg,getMetricSubMenu(metrics[0],selectionInfos[0]));}else{$ARR.forEach(metrics,function(metric,idx){cfg.addSubMenuItem(metric,"",me.id,function(){if(selectionInfos[idx]&&selectionInfos[idx].elem){delete selectionInfos[idx].elem;}return getMetricSubMenu(metric,selectionInfos[idx]);});});if(gmCtr.isStacked&&!gmCtr.splitPlottingMetrics){cfg.addSeparator();GMUTIL.getReferenceLineSubMenu(visGM,cfg,chtInfo.isABL,selectionInfos[0].mid);}}break;}}}}break;case CTRL_TYPE.GM_XLABEL:case CTRL_TYPE.GM_YLABEL:if(fmtMode){getAxisTitleShowSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig();function getChangeAxisTitleShowRadioToggleMenu(visGM){function axisTitleStateChanged(){return function(newValue,oldValue){if(newValue!==oldValue){if(type===CTRL_TYPE.GM_XLABEL){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_TITLE_SHOW,newValue);}else{if(type===CTRL_TYPE.GM_YLABEL){visGM.writeGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_TITLE_SHOW,newValue);}}}};}return function(){var axisTitleStateOptions=[];[{text:mstrmojo.desc(2969,"Show"),value:true},{text:mstrmojo.desc(2772,"Hide"),value:false}].forEach(function(opt){axisTitleStateOptions.push(opt);});if(type===CTRL_TYPE.GM_XLABEL){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.X_AXIS_TITLE_SHOW),axisTitleStateChanged(),axisTitleStateOptions,"checkMark",undefined,true);}else{if(type===CTRL_TYPE.GM_YLABEL){subMenu.addRadioMenuGroup(visGM.readGlobalProperty($ENUM_FORMAT_TAG.Y_AXIS_TITLE_SHOW),axisTitleStateChanged(),axisTitleStateOptions,"checkMark",undefined,true);}}return subMenu;};}(getChangeAxisTitleShowRadioToggleMenu(visGM))();return subMenu;};cfg.addSubMenuItem(mstrmojo.desc(13679,"Axis Title"),"xt",this.id,getAxisTitleShowSubMenu);}else{if(pstMode){if(chtInfo.isABL&&userInfo.identity&&userInfo.identity.objType!==IDEN_TYPE.Y_ATTRIBUTE_AXIS_TITLE&&userInfo.identity.objType!==IDEN_TYPE.X_ATTRIBUTE_AXIS_TITLE){cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortMetricTitle"),{isAsc:true,selInfo:selectionInfo});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortMetricTitle"),{isAsc:false,selInfo:selectionInfo});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}}}else{if(userInfo.identity){if(userInfo.identity.objType!==IDEN_TYPE.Y_ATTRIBUTE_AXIS_TITLE&&userInfo.identity.objType!==IDEN_TYPE.X_ATTRIBUTE_AXIS_TITLE){var multiMetrics=userInfo.multiMetrics;if(multiMetrics&&multiMetrics.length>1){addMultiMetricSubMenu(selectionInfo);}else{$VISUTIL.absorbMenuItems(cfg,getMetricSubMenu(userInfo.metric,selectionInfo));}}else{DZ=visGM.zonesModel.gmZones;zone=(function(){var zones,i,j;zones=DZ.dropZones;for(i in zones){items=zones[i].items;for(j in items){if(items[j].did===userInfo.identity.tid){item=items[j];return zones[i];}}}}());itemContext={zone:zone,axis:zone&&zone.id,idx:$ARR.find(items,"id",item.id),cnt:items.length,item:item,useDropzone:true};itemNotFromMDXCube=!DZ.docModel.isFromMDXCube(item.did);if((item.t===47&&(item.st===12033||item.st===12032))||(identity.otp===47&&(identity.ost===12033||identity.ost===12032))){if(identity.ost===12033){cfg.addMenuItem(mstrmojo.desc(13296,"Edit Groups..."),"eg",DZ.getCreateOrEditElementGroupFunc(itemContext));cfg.addSeparator();}cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:true,identity:identity});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:false,identity:identity});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}cfg.addSeparator();}else{if(item.da&&itemNotFromMDXCube){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){DZ.editDerivedAttribute(itemContext);},itemContext);cfg.addSeparator();}cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:true,identity:identity});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",visGM.getMenuHandler("sortAttributeTitle"),{isAsc:false,identity:identity});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",visGM.getMenuHandler("clearSort"));}cfg.addSeparator();isDynamicLinkAttr=DZ.isDynamicLink(item);if(DZ.allowInsertNewAttribute(zone)&&!$VISUTIL.hasCGorCon(visGM,item)&&itemNotFromMDXCube&&!isDynamicLinkAttr){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){DZ.newDerivedAttribute(itemContext);},itemContext);}isMngdCG=item.t===47&&DZ.getUnitInfoInTemplate(item.did).unit.ost===12033;EGTitle=DZ.isAttribute(item)?mstrmojo.desc(13295,"Create Groups..."):(isMngdCG?mstrmojo.desc(13296,"Edit Groups..."):null);if(EGTitle!==null&&!isDynamicLinkAttr){cfg.addMenuItem(EGTitle,"eg",DZ.getCreateOrEditElementGroupFunc(itemContext));}cfg.addSeparator();if(DZ.showNumberFormat(item)){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),DZ.id,DZ.getNumberFormatEditorCfg,itemContext);}addDrillTo(identity&&identity.tid);if(!isDynamicLinkAttr){addAttributeForm();}cfg.addSeparator();}fmtOptIdx=cfg.getMenuItems().length;if(DZ.hasReplaceCandidates(itemContext)){cfg.addSubMenuItem(mstrmojo.desc(14003,"Replace With"),"",visGM.zonesModel.id,DZ.getReplaceSubMenu,itemContext);}if(userInfo.elem&&userInfo.elem.firstChild){addRenameMenuItem(visGM,cfg,userInfo.elem.firstChild,item);}cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){DZ.deleteItem(zone,itemContext.idx);});}}}}break;case CTRL_TYPE.GM_ROW_HEADER_EXTRA:case CTRL_TYPE.GM_COL_HEADER_EXTRA:if(fmtMode){getHeaderMenuInFmtMode.call(this);}else{$VISUTIL.absorbMenuItems(cfg,getMetricSubMenu(userInfo.metric,selectionInfo));}break;case CTRL_TYPE.GM_SVG_CHART:if(visGM.legend){if(visGM.legend.height===0&&visGM.legend.width===0){cfg.addMenuItem(mstrmojo.desc(12001,"Show Legend"),"xt",function(){visGM.writeGlobalProperty("LegendVisibleness",true);});}}cfg.addPopupMenuItem(mstrmojo.desc(11991,"Grid Lines"),this.id,getGridLineShowSubMenu);cfg.addSeparator();EnableDisableAllTrendLine.call(me,cfg);cfg.addSeparator();getReferenceLineSubMenuForChart();break;case CTRL_TYPE.GM_TREND_LINE:if(!fmtMode){var trdLineCollection=visGM.readGlobalProperty($ENUM_XML_TAG.TREND_LINE_DEF,identity.tlOpt);cfg.addPopupMenuItem(mstrmojo.desc(3523,"Line Color"),this.id,function(){return getTrdRefColorPickerPopup(this.widget,$ENUM_XML_TAG.TREND_REF_LINE_COLOR,{realPropName:$ENUM_XML_TAG.TREND_LINE_DEF,opt:identity.tlOpt},trdLineCollection,false);});cfg.addMenuItem(mstrmojo.desc(13680,"Disable trend line"),"xt",function(){trdLineCollection.setProperty($ENUM_XML_TAG.TREND_ENABLED,false);visGM.writeGlobalProperty($ENUM_XML_TAG.TREND_LINE_DEF,trdLineCollection,identity.tlOpt);});}break;case CTRL_TYPE.GM_REF_LINE:if(!fmtMode){var refLineCollection=visGM.readGlobalProperty($ENUM_XML_TAG.REF_LINE_DEF,identity.tlOpt);cfg.addPopupMenuItem(mstrmojo.desc(3523,"Line Color"),this.id,function(){return getTrdRefColorPickerPopup(this.widget,$ENUM_XML_TAG.TREND_REF_LINE_COLOR,{realPropName:$ENUM_XML_TAG.REF_LINE_DEF,opt:identity.tlOpt},refLineCollection,false);});cfg.addMenuItem(mstrmojo.desc(13681,"Disable reference line"),"xt",function(){refLineCollection.setProperty($ENUM_XML_TAG.REF_ENABLED,false);visGM.writeGlobalProperty($ENUM_XML_TAG.REF_LINE_DEF,refLineCollection,identity.tlOpt);});}break;case CTRL_TYPE.GM_H_GRID_LINE:case CTRL_TYPE.GM_V_GRID_LINE:case CTRL_TYPE.GM_H_MINOR_GRID_LINE:case CTRL_TYPE.GM_V_MINOR_GRID_LINE:getGridLineShowSubMenu(cfg);break;default:}if(fmtOptIdx){cfg.fmtOptIdx=fmtOptIdx;}return cfg;},getSelectedTargetsIdentities:function(){var selected=this.selectedTargets,identities=[];(selected||[]).forEach(function(target){if(target.identity){identities.push(target.identity);}});return identities;},handleRMClick:function(target,drillTo,pos,e){target=this.getRealTargetForSetShape(target,e);var type,fmtMode=this.fmtMode,ctrlKey=e.ctlKey||e.metaKey,widget=this.widget,orgType=target.getAttribute("type"),elem=this.fmtMode?getRealTargetFMT(target):getRealTarget(target);var selected,clickOnSelected;if(!elem&&!this.fmtMode){elem=getRealTargetFMT(target);}if(!elem){var cfg=new $MOJO.ui.menus.MenuConfig();this.addFormatOption(cfg);if(cfg&&cfg.menus&&cfg.menus.length){this.hideTooltip();showContextMenu.call(this,pos,cfg);}return ;}type=elem.getAttribute("type");if(isShape(type)){this.clearSelectedTargets();if(!isShapeSelected(elem)){if(fmtMode){if(this.fmtState===ENUM_FMT_STATUS.NORMAL){this.fmtState=ENUM_FMT_STATUS.PER_COLORBY;}this.handleClickOnShapeFMT(elem,ctrlKey);widget.onFormatableTargetChanged();}else{this.handleClickOnShape(elem,ctrlKey);}}pos.x-=4;pos.y-=4;}else{if(fmtMode){selected=this.selectedTargets||[];var tempElem=this.copeTargetChangeForDBLClick([elem])[0];clickOnSelected=selected&&selected.indexOf(tempElem)!==-1;if(!clickOnSelected){this.clearSelectedTargets();this.selectTarget(this.getTargetsWithSameType(elem));}}else{if(type!==CTRL_TYPE.LASSO_SELECTOR){selected=this.selectedTargets||[];clickOnSelected=selected&&selected.indexOf(elem)!==-1;if(!clickOnSelected&&!isRMCOnAxisForMultiSelection.call(this,elem,type)){if(!ctrlKey){this.clearSelectedTargets();}if(mstrApp.appState!==mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION&&(isMatrixLine(type)||isAxisLine(type)||isGridLine(type)||isDataLabel(type))){this.fmtMode=true;this.selectTarget(this.getTargetsWithSameType(elem));this.fmtMode=false;}else{this.selectTarget(this.getTargetsWithSameType(elem));}}}}}if(!fmtMode){widget.endSelections();}if(type===CTRL_TYPE.LASSO_SELECTOR&&this.selectedShapes.length===0){return ;}var menuData,toolbarData,identity=elem.identity||(elem.parentNode&&elem.parentNode.identity),userInfo={};if(type===CTRL_TYPE.LASSO_SELECTOR&&!identity){identity=this.selectedShapes.length&&this.selectedShapes[0].identity;}userInfo.visGM=widget;userInfo.identity=identity;userInfo.selectionInfo=elem.selectionInfo;userInfo.metric=elem.innerText||elem.textContent||"";userInfo.metrics=elem.metrics;userInfo.selectionInfos=elem.selectionInfos;userInfo.subType=elem.getAttribute("subtype");userInfo.orgType=orgType;userInfo.elem=elem;userInfo.tagName=elem.tagName;if(isAxisTitle(this.selType)){var multiMetrics=[],idx;selected=this.selectedTargets||[];$ARR.forEach(selected,function(selectItem){idx=selectItem.selectionInfo?$ARR.find(multiMetrics,"mid",selectItem.selectionInfo.mid):null;if(idx===-1){multiMetrics.push(selectItem.selectionInfo);}});userInfo.multiMetrics=multiMetrics;}menuData=this.getMenuConfig(type,drillTo,userInfo,fmtMode);toolbarData=this.getToolbarConfig(type,userInfo,fmtMode);this.addFormatOption(menuData,menuData.fmtOptIdx);if(menuData&&menuData.menus&&menuData.menus.length){this.hideTooltip();showContextMenu.call(this,pos,menuData);}var mchild=this.domMenuPH.firstChild;if(mchild&&mchild.offsetTop<0){pos.y+=mchild.offsetTop;}if(toolbarData){this.hideTooltip();showToolBar.call(this,pos,toolbarData);}if(identity&&identity.objType!==IDEN_TYPE.GRAPH_SHAPE){var bgIdentity;if(orgType===CTRL_TYPE.GM_ROW_HEADER){bgIdentity=$HASH.copy(identity);bgIdentity.objType=IDEN_TYPE.ROWS_BACKGROUND;}if(orgType===CTRL_TYPE.GM_COL_HEADER){bgIdentity=$HASH.copy(identity);bgIdentity.objType=IDEN_TYPE.COLS_BACKGROUND;}if(bgIdentity){widget.raiseEventOnFormattingIdentity(encodeIdentities([bgIdentity]));}else{if(fmtMode){var identities=this.getSelectedTargetsIdentities();widget.raiseEventOnFormattingIdentity(encodeIdentities(identities));}else{widget.raiseEventOnFormattingIdentity(encodeIdentities([identity]));}}}this.toggleGMFade();},formatHandler:function(sels){var me=this,widget=this.widget,tfg;mstrApp.rootCtrl.docCtrl.selectViPanel("propertiesPanel");widget.parent.selectVIUnit();sels=sels||(me.selectedTargets.length?me.selectedTargets:me.selectedShapes);if(sels.length===0||sels[0].getAttribute("type")===CTRL_TYPE.GM_DUMMY_A){widget.raiseEventOnNonFormattingIdentity(encodeIdentities({objType:IDEN_TYPE.VIZ_BOX_CONTAINER}));if(widget.mousePos){tfg=me.getToolbarConfig(CTRL_TYPE.GM_SVG_CHART,{},true);me.hideTooltip();showToolbarByFormat.call(me,widget.mousePos,tfg);}return ;}var elem=sels[0],type=elem.getAttribute("type"),identity=elem.identity,userInfo={visGM:widget,identity:identity,subType:elem.getAttribute("subtype"),orgType:type};this.fmtFake=true;this.highlightByFormat(elem);this.fmtFake=false;tfg=me.getToolbarConfig(type,userInfo,true);if(tfg){me.hideTooltip();showToolbarByFormat.call(me,widget.mousePos,tfg);}},highlightByFormat:function(elem){var type=elem.getAttribute("type"),fmtState=this.fmtState,widget=this.widget,ctrlKey=false,n;if(isShape(type)){this.clearSelectedTargets();if(fmtState===ENUM_FMT_STATUS.NORMAL||fmtState===ENUM_FMT_STATUS.PER_COLORBY){n=this.handleClickOnShapeFMT(elem,ctrlKey);fmtState=ENUM_FMT_STATUS.PER_COLORBY;}else{if(ctrlKey){n=this.handleDblClickOnShapeFMT(elem,ctrlKey);}else{widget.clearUserSelections();n=this.handleClickOnShapeFMT(elem,ctrlKey);fmtState=ENUM_FMT_STATUS.PER_COLORBY;}}if(n===0){fmtState=ENUM_FMT_STATUS.NORMAL;}this.fmtState=fmtState;widget.onFormatableTargetChanged();}else{if(isOnRow(type)||isOnCol(type)||isMatrixLine(type)||isAxisLine(type)||isAxisTitle(type)||isAxisLabel(type)||isGridLine(type)||isDataLabel(type)||isDataLabel(type)||isAxisOriginLine(type)||isAxisOriginLabel(type)||isTrendLIne(type)||isReferenceLine(type)){widget.clearUserSelections();this.clearSelectedTargets();this.fmtMode=true;this.selectTarget(this.getTargetsWithSameType(elem));this.fmtMode=false;}else{this.clearSelectedTargets();widget.clearUserSelections();}var identities=this.getSelectedTargetsIdentities(),sup=[];$ARR.forEach(identities,function(idnt){switch(idnt.objType){case IDEN_TYPE.ROW_TITLE:sup.push({objType:IDEN_TYPE.ROWS_BACKGROUND});break;case IDEN_TYPE.COL_TITLE:sup.push({objType:IDEN_TYPE.COLS_BACKGROUND});break;case IDEN_TYPE.REF_LINE:case IDEN_TYPE.TREND_LINE:idnt.key=idnt.lineModel.trendLineModel.metricId;break;default:break;}});if(identities.length===0){identities={objType:IDEN_TYPE.VIZ_BOX_CONTAINER};}else{if(sup.length){identities=identities.concat(sup);}}widget.raiseEventOnNonFormattingIdentity(encodeIdentities(identities));}},addFormatOption:function(cfg,index){var me=this;if(mstrApp.appState===mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION){return ;}if(!mstrApp.allowWebDashboardDesign()){return ;}if(cfg&&cfg.menus&&cfg.menus.length>0){cfg.addSeparator();}var sels=me.selectedTargets.length?me.selectedTargets:me.selectedShapes;var copys=[];$ARR.forEach(sels,function(sel){var tmp=sel.cloneNode();tmp.identity=sel.identity;copys.push(tmp);});if(index){cfg.addMenuItem("","separator",function(){return false;},{},index+1);cfg.addMenuItem(mstrmojo.desc(1918,"Format"),"xt",function(){me.formatHandler(copys);},{},index+2);cfg.addMenuItem("","separator",function(){return false;},{},index+3);}else{cfg.addMenuItem(mstrmojo.desc(1918,"Format"),"xt",function(){me.formatHandler(copys);});}},copeTargetChangeForDBLClick:function(targetArray){var targets,realTargets=[];$ARR.forEach(targetArray||[],function(target){var type=target.getAttribute("type");if(type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_ROW_HEADER_EXTRA||type===CTRL_TYPE.GM_ROW_HEADER_TITLE||type===CTRL_TYPE.GM_COL_HEADER||type===CTRL_TYPE.GM_COL_HEADER_TITLE||type===CTRL_TYPE.GM_COL_HEADER_EXTRA){targets=findElementsByAttribute(target,"type",[CTRL_TYPE.GM_TEXT_BODY]);if(targets.length>0){realTargets.push(targets[0]);}else{realTargets.push(target);}}else{realTargets.push(target);}});return realTargets;},getRealTargetForSetShape:function(target,e){var orgType=target.getAttribute("type"),tempTarget,realTarget=target,widget=this.widget,toHideDom=widget.domGM.childNodes[0],realTargetType,chtInfo=this.widget.GMController.getChartInfo(),offset=$VISUTIL.getMouseOffset(e),isRMC=(e.button===2);if(orgType===CTRL_TYPE.GM_SVG_CHART){toHideDom.style.zIndex="-2";tempTarget=document.elementFromPoint(e.pageX,e.pageY);toHideDom.style.zIndex="auto";realTargetType=tempTarget.getAttribute("type");if(isRMC&&(realTargetType===CTRL_TYPE.LINE_CONTAINER||realTargetType===CTRL_TYPE.GM_H_GRID_LINE||realTargetType===CTRL_TYPE.GM_V_GRID_LINE||realTargetType===CTRL_TYPE.GM_H_MINOR_GRID_LINE||realTargetType===CTRL_TYPE.GM_V_MINOR_GRID_LINE)){realTarget=tempTarget;}else{if(chtInfo.tp===CHART_TYPE.LINE&&chtInfo.shape===SHAPE_TYPE.LINE){var linePoint=this.getLinePoint(target,chtInfo,offset.x,offset.y);if(linePoint){realTarget=linePoint;}else{realTarget=tempTarget;}}}}else{if(orgType===CTRL_TYPE.GM_SET_SHAPE&&chtInfo.tp===CHART_TYPE.AREA&&chtInfo.shape===SHAPE_TYPE.AREA){var areaPoint=this.getAreaPoint(target,chtInfo,offset.x,offset.y);if(areaPoint){realTarget=areaPoint;}}}return realTarget;},handleClick:function(target,ctrlKey,e,lassoSelector){target=this.getRealTargetForSetShape(target,e);var widget=this.widget,orgType=target.getAttribute("type"),elem=this.fmtMode?getRealTargetFMT(target):getRealTarget(target),fmtMode=this.fmtMode,n,type,fmtState=this.fmtState;var clearAllIsDisabled=widget.isClearAllDisabled();if(!!lassoSelector){if(elem){type=elem.getAttribute("type");if(!isShape(type)){return ;}}else{return ;}}if(!elem){if(clearAllIsDisabled){return ;}widget.clearUserSelections();this.clearSelectedTargets();if(fmtMode){widget.raiseEventOnFormattingIdentity([]);}if($VISUTIL.isOnExpressMode()){widget.singleUnitSelect();}return ;}type=elem.getAttribute("type");if(fmtMode){if(isShape(type)){this.clearSelectedTargets();if(fmtState===ENUM_FMT_STATUS.NORMAL||fmtState===ENUM_FMT_STATUS.PER_COLORBY){n=this.handleClickOnShapeFMT(elem,ctrlKey);fmtState=ENUM_FMT_STATUS.PER_COLORBY;}else{if(ctrlKey){n=this.handleDblClickOnShapeFMT(elem,ctrlKey);}else{widget.clearUserSelections();n=this.handleClickOnShapeFMT(elem,ctrlKey);fmtState=ENUM_FMT_STATUS.PER_COLORBY;}}if(n===0){fmtState=ENUM_FMT_STATUS.NORMAL;}this.fmtState=fmtState;widget.onFormatableTargetChanged();}else{if((orgType===CTRL_TYPE.GM_TEXT_BODY)||isOnRow(type)||isOnCol(type)||isMatrixLine(type)||isAxisLine(type)||isAxisTitle(type)||isAxisLabel(type)||isGridLine(type)||isDataLabel(type)||isDataLabel(type)||isAxisOriginLine(type)||isAxisOriginLabel(type)||isTrendLIne(type)||isReferenceLine(type)){widget.clearUserSelections();this.clearSelectedTargets();this.selectTarget(this.getTargetsWithSameType(elem));}else{this.clearSelectedTargets();widget.clearUserSelections();}var identities=this.getSelectedTargetsIdentities();widget.raiseEventOnFormattingIdentity(encodeIdentities(identities));}}else{if($VISUTIL.isOnExpressMode()){var clickOnMetric=isAxisTitle(type)&&(elem.identity&&elem.identity.mOriId);var clickOnAttribute=isShape(type)||isOnRow(type)||isOnCol(type);widget.processSelectedMetricIds(clickOnAttribute,clickOnMetric,ctrlKey);widget.precessSelectedAttributes(clickOnAttribute,clickOnMetric,ctrlKey);if(isShape(type)){this.handleClickOnShape(elem,ctrlKey);widget.endSelections();}else{if(type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_COL_HEADER||type===CTRL_TYPE.GM_ROW_HEADER_TITLE||type===CTRL_TYPE.GM_COL_HEADER_TITLE){widget.clearSelectedShapesAndCharts();this.handleClickOnTarget(target,ctrlKey,CTRL_TYPE_HEADER_TITLE);widget.endSelections();}else{if(isTrendLIne(type)||isReferenceLine(type)){widget.clearUserSelections();this.clearSelectedTargets();this.selectTarget(this.getTargetsWithSameType(elem));}else{if(type===CTRL_TYPE.LASSO_RESIZER){}else{if(widget.hasMetricSelector()&&isAxisTitle(type)){if(elem.identity.mOriId){widget.selectedMetricIds.push(elem.identity.mOriId);widget.endSelections();}}else{this.clearSelectedTargets();widget.clearUserSelections();}}}}}}else{if(isShape(type)){if(clearAllIsDisabled&&this.selectedShapes.indexOf(elem)>-1){return ;}this.handleClickOnShape(elem,ctrlKey);widget.endSelections();}else{if(type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_COL_HEADER||type===CTRL_TYPE.GM_ROW_HEADER_TITLE||type===CTRL_TYPE.GM_COL_HEADER_TITLE){if(clearAllIsDisabled&&this.selectedTargets.indexOf(elem)>-1){return ;}widget.clearSelectedShapesAndCharts();this.handleClickOnTarget(target,ctrlKey,CTRL_TYPE_HEADER_TITLE);widget.endSelections();}else{if(type===CTRL_TYPE.GM_XLABEL||type===CTRL_TYPE.GM_YLABEL){widget.clearSelectedShapesAndCharts();widget.endSelections();this.handleClickOnTarget(target,ctrlKey,type);}else{if(isTrendLIne(type)||isReferenceLine(type)){this.clearSelectRules();widget.clearSelections(true);widget.endSelections();this.selectTarget(this.getTargetsWithSameType(elem));}else{if(type===CTRL_TYPE.LASSO_RESIZER){}else{var oneSelectedTarget=this.selectedTargets.length>0&&this.selectedTargets[0],seletedTargetsType=oneSelectedTarget&&oneSelectedTarget.getAttribute("type"),oneSelectedShape=this.selectedShapes.length>0&&this.selectedShapes[0],selectedShapesType=oneSelectedShape&&oneSelectedShape.getAttribute("type");if(clearAllIsDisabled&&((oneSelectedTarget&&(seletedTargetsType===CTRL_TYPE.GM_ROW_HEADER||seletedTargetsType===CTRL_TYPE.GM_COL_HEADER))||(oneSelectedShape&&isShape(selectedShapesType)))){return ;}this.clearSelectRules();widget.clearSelections(true);widget.endSelections();}}}}}}}this.toggleGMFade();},deselectTarget:function(target){var widget=this.widget,manager=widget.manager,identity=target.identity,type=target.getAttribute("type");hSetTargetStatus(target,SHAPE_STAT.NORMAL);this.selectedTargets=(this.selectedTargets||[]).filter(function(tgt){return tgt!==target;});if(type===CTRL_TYPE.GM_ROW_HEADER){updateRelevantRows(target,false,"selected",manager);updateRelevantRows(target,false,"sh",manager);widget.removeAttributeSelection(identity.tid,identity.eid);}if(type===CTRL_TYPE.GM_COL_HEADER){updateRelevantCols(target,false,"selected",manager);updateRelevantCols(target,false,"sh",manager);widget.removeAttributeSelection(identity.tid,identity.eid);}},toggleSelectTarget:function(target){if(isAxisTitle(this.selType)){var isClickOnSelected=isShapeSelected(target)||isShapeSH(target);removeMetricRepeatSelection.call(this,target);if(isClickOnSelected){return false;}}else{if(isShapeSelected(target)||isShapeSH(target)){this.deselectTarget(target);this.deselectBorders(target);return false;}}this.selectTarget(this.getTargetsWithSameType(target));return true;},handleClickOnTarget:function(target,ctrlKey,selType){var elem=this.fmtMode?getRealTargetFMT(target):getRealTarget(target);if(!ctrlKey||this.selType!==selType){var returnEarly=(this.selectedTargets&&this.selectedTargets.length===1&&this.selectedTargets[0]===elem);this.clearSelectedTargets();this.selType=selType;if(returnEarly){return 0;}}this.toggleSelectTarget(elem);},handleDblClick:function(target,ctrlKey,e){target=this.getRealTargetForSetShape(target,e);var n,type,fmtMode=this.fmtMode,fmtState=this.fmtState,elem=fmtMode?getRealTargetFMT(target):getRealTarget(target),widget=this.widget;if(!elem){widget.clearUserSelections();this.clearSelectedTargets();if(fmtMode){widget.raiseEventOnFormattingIdentity([]);}return ;}if(elem&&fmtMode){type=elem.getAttribute("type");if(isShape(type)){if(fmtState===ENUM_FMT_STATUS.NORMAL||fmtState===ENUM_FMT_STATUS.PER_SHAPE){n=this.handleDblClickOnShapeFMT(elem,ctrlKey);fmtState=ENUM_FMT_STATUS.PER_SHAPE;}else{if(ctrlKey){n=this.handleClickOnShapeFMT(elem,ctrlKey);}else{widget.clearUserSelections();n=this.handleDblClickOnShapeFMT(elem,ctrlKey);fmtState=ENUM_FMT_STATUS.PER_SHAPE;}}if(n===0){fmtState=ENUM_FMT_STATUS.NORMAL;}this.fmtState=fmtState;widget.onFormatableTargetChanged();}else{widget.clearUserSelections();this.clearSelectedTargets();this.selectTarget(this.copeTargetChangeForDBLClick(this.getTargetsWithSameTypeForDBL(elem)));var identities=this.getSelectedTargetsIdentities();widget.raiseEventOnFormattingIdentity(encodeIdentities(identities));}}},handleDblClickOnShapeFMT:function(target,ctrlKey){var shape,cbInfo,idx,type=target.getAttribute("type"),rules=this.breakByRules,shapes=this.breakByShapes;if(type===CTRL_TYPE.GM_MARKER){shape=target.source;}else{shape=target;}if(!ctrlKey){this.clearSelectRules();}cbInfo=getBreakByInfo(shape);if(isShapeSelected(shape)){idx=indexColorByInfo(rules,cbInfo);if(idx!==-1){rules.splice(idx,1);shapes.splice(idx,1);}}else{rules.push(cbInfo);shapes.push(shape);}this.doHighlight(SEL_TYPE.METRICS,rules);return rules.length;},handleClickOnShapeFMT:function(target,ctrlKey){var shape,cbInfo,type=target.getAttribute("type"),rules=this.colorByRules,shapes=this.colorByShapes;if(type===CTRL_TYPE.GM_MARKER){shape=target.source;}else{shape=target;}if(!ctrlKey){this.clearSelectRules();}cbInfo=getColorByInfo(shape);rules.push(cbInfo);shapes.push(shape);this.widget.GMController.resetHighLightIndex=true;this.doHighlight(SEL_TYPE.METRICS,rules);return rules.length;},toggleGMFade:function(fade){var canvas=this.widget.domGM;fade=(fade===undefined)?this.selectedShapes.length>0:fade;$CSS.toggleClass(canvas,"gm-fade",fade);},handleClickOnShape:function(target,ctrlKey){var shape,returnEarly=false,selectedShapes=this.selectedShapes,type=target.getAttribute("type");if(!isShape(type)){return -1;}if(type===CTRL_TYPE.GM_MARKER){shape=target.source;}else{shape=target;}if(!ctrlKey){returnEarly=selectedShapes.length===1&&selectedShapes[0]===shape;if(!returnEarly||!this.widget.isClearAllDisabled()){this.widget.clearSelections(true);}if(returnEarly){return 0;}}else{this.clearSelectedTargets();}this.toggleSelectShape(shape);return this.selectedShapes.length;},getLinePoint:function(target,chtInfo,offsetX,offsetY){var getPointInfo=function(shapes){var shapeLength=shapes.length,pointsInfo=[],shape,i;for(i=0;i<shapeLength;i++){shape=shapes[i];pointsInfo.push({point:getShapeCenter(shape),dom:shape});}return pointsInfo;};var getPoint=function(shapesInfo,chtDirc,offsetX,offsetY){var pointsInfo=shapesInfo[0],pointsNum=pointsInfo&&pointsInfo.length||0,pointInfo,dom=null,isVertical=chtDirc===$ENUM_ABL_DIRECTION.VERTICAL,isBelow=false,offset,minOffset,pointIndex,rangeIndex,i;var offsetToLine=function(x,y,lineStart,lineEnd,isVertical){var x1=lineStart.point[0],y1=lineStart.point[1],x2=lineEnd.point[0],y2=lineEnd.point[1],k=(y2-y1)/(x2-x1);return isVertical?k*(x-x1)+y1-y:x-x1+(y1-y)/k;};for(i=0;i<pointsNum;i++){offset=isVertical?offsetX-pointsInfo[i].point[0]:offsetY-pointsInfo[i].point[1];if(i===0||minOffset>Math.abs(offset)){minOffset=Math.abs(offset);pointIndex=i;}if(offset<0){break;}}rangeIndex=i;if(rangeIndex>0&&rangeIndex<pointsNum){for(i=0;i<shapesInfo.length;i++){pointInfo=shapesInfo[i][pointIndex];offset=offsetToLine(offsetX,offsetY,shapesInfo[i][rangeIndex-1],shapesInfo[i][rangeIndex],isVertical);if(offset<=0){offset=Math.abs(offset);isBelow=true;}if(i===0||offset<minOffset){minOffset=offset;dom=pointInfo.dom;}}}return isBelow?dom:null;};var serieses=target.childNodes,seriesNum=serieses.length-1,series,i,seriesPointInfo=[],pointInfo,shapes;for(i=0;i<seriesNum;i++){series=serieses[i+1];shapes=findElementsByAttribute(series,"type",CTRL_TYPE.GM_SHAPE);pointInfo=getPointInfo(shapes);if(pointInfo&&pointInfo.length>0){seriesPointInfo.push(pointInfo);}}var point=getPoint(seriesPointInfo,chtInfo.dirc,offsetX,offsetY);return point;},isLineOrAreaPaint:function(shapeType){var setShapeTagName,setShapes,i=0,widget=this.widget,gmCtr=widget.GMController,metrics=widget.model.data.gsi.mx,getSetShapeTagName=function(st){switch(st){case SHAPE_TYPE.AREA:return"polygon";case SHAPE_TYPE.LINE:return"polyline";}};if(shapeType!==undefined){setShapeTagName=getSetShapeTagName(shapeType);}else{$ARR.forEach(metrics,function(){shapeType=gmCtr.getOnTheFlyShapeForMetric(i++);setShapeTagName=getSetShapeTagName(shapeType);if(setShapeTagName){return false;}});}if(setShapeTagName){setShapes=widget.domGM.getElementsByTagName(setShapeTagName);for(i=0;i<setShapes.length;i++){if(setShapes[i].getAttribute("type")==="set-shape"){return true;}}}return false;},hoverAreaChartPoint:function(target,chtInfo,offsetX,offsetY){var series=target.parentNode,points=$ARR.filter(series.childNodes,function(g){return g.tagName==="circle";}),minOffset,selectedPoint,selectedPointPos;$ARR.forEach(points,function(point,i){var pointPos=getShapeCenter(point),offset;if(chtInfo.dirc===$ENUM_ABL_DIRECTION.VERTICAL){offset=Math.abs(offsetX-pointPos[0]);}else{offset=Math.abs(offsetY-pointPos[1]);}if(i===0||offset<minOffset){minOffset=offset;selectedPoint=point;selectedPointPos=pointPos;}});if(selectedPoint){var pos=$DOM.position(series.parentNode);this.hoverShape(selectedPoint);this.showTooltip(selectedPoint,{x:pos.x+selectedPointPos[0],y:pos.y+selectedPointPos[1]});}},hoverLineChartPoint:function(target,chtInfo,offsetX,offsetY){var pointOnLine=this.getLinePoint(target,chtInfo,offsetX,offsetY);if(pointOnLine&&pointOnLine!==this.hoveredShape){var point=getShapeCenter(pointOnLine),pos=$DOM.position(target);var tx=pos.x+point[0],ty=pos.y+point[1];this.hoverShape(pointOnLine);this.showTooltip(pointOnLine,{x:tx,y:ty});}},hoverLineWithDataPoint:function(target){var svgNode,line;if((target.getAttribute("subtype")===SHAPE_SUBTYPE.SCIRCLE)){svgNode=target.parentNode;line=svgNode&&svgNode.querySelector(".gm-set-polyline");if(line){this.hoverSetShape(line);}}},handleMouseOver:function(target,chtInfo,offsetX,offsetY){var elem=this.fmtMode?getRealTargetFMT(target):getRealTarget(target),type;if(!elem){this.clearHoveredShape();this.clearHoveredSetShape();this.clearHoveredTarget();return ;}type=elem.getAttribute("type");if(type===CTRL_TYPE.GM_SHAPE){this.clearHoveredSetShape();this.clearHoveredShape();this.clearHoveredTarget();this.hoverShape(elem);this.hoverLineWithDataPoint(elem);this.hoverOverSelectedShape(elem);}else{if(type===CTRL_TYPE.GM_SET_SHAPE&&chtInfo.tp===CHART_TYPE.AREA&&chtInfo.shape===SHAPE_TYPE.AREA){this.clearHoveredShape();this.clearHoveredSetShape();this.clearHoveredTarget();this.hoverAreaChartPoint(elem,chtInfo,offsetX,offsetY);}else{if(type===CTRL_TYPE.GM_SET_SHAPE){this.clearHoveredSetShape();this.clearHoveredShape();this.clearHoveredTarget();this.hoverSetShape(elem);}else{if(type===CTRL_TYPE.GM_SVG_CHART&&chtInfo.tp===CHART_TYPE.LINE&&chtInfo.shape===SHAPE_TYPE.LINE){this.clearHoveredShape();this.clearHoveredSetShape();this.clearHoveredTarget();this.hoverLineChartPoint(target,chtInfo,offsetX,offsetY);}else{this.clearHoveredShape();this.clearHoveredSetShape();this.hoverTarget(this.getTargetsWithSameType(elem,true));if(!this.isToolbarShow()){this.hoverSelectedTarget([elem]);}}}}}},isToolbarShow:function(){return this.domToolbarPH&&this.domToolbarPH.firstChild;},isShowGradientAllowed:function(shapeType){var visGM=this.widget,gmCtr=visGM.GMController,dz=visGM.model.data.dz,colorByAttrs=dz.ColorBy.TemplateUnit,xAxisAttrs=dz.XAxis.TemplateUnit,yAxisAttrs=dz.YAxis.TemplateUnit,metrics=visGM.model.data.gsi.mx,midx,showGradient=function(st){var show=true;if(st===SHAPE_TYPE.LINE||st===SHAPE_TYPE.TICK){show=false;}if(st===SHAPE_TYPE.AREA&&colorByAttrs){$ARR.forEach([xAxisAttrs,yAxisAttrs],function(tu){$ARR.forEach(tu,function(attr){if($ARR.find(colorByAttrs,"id",attr.id)!==-1){show=false;}return show;});return show;});}return show;};if(shapeType===undefined){for(midx in metrics){shapeType=gmCtr.getOnTheFlyShapeForMetric(midx);if(showGradient(shapeType)){return true;}}return false;}else{return showGradient(shapeType);}},getDisplayFormsMenu:function(item){var gmDropZones=this.widget.zonesModel;return $DU.getDisplayFormsMenu(item,gmDropZones.getHost(),gmDropZones.docModel.datasets,function(actions){gmDropZones.submitDropZoneUpdates(actions);});},handleRMCOnLegend:function(target,pos){var type=target.getAttribute("type"),legend=this.widget.legend,tfg,identity,corners,menuConfig,me=this;if(type!==CTRL_TYPE.LGD_COLORBOX&&type!==CTRL_TYPE.LGD_COLORBOX_CTN){menuConfig=new $MOJO.ui.menus.MenuConfig();if(mstrApp.appState!==mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION&&mstrApp.allowWebDashboardDesign()){menuConfig.addMenuItem(mstrmojo.desc(1918,"Format"),"xt",function(){mstrApp.rootCtrl.docCtrl.selectViPanel("propertiesPanel");me.widget.raiseEventOnNonFormattingIdentity(encodeIdentities({objType:IDEN_TYPE.LEGEND}));switch(type){case CTRL_TYPE.LGD_TITLE:case CTRL_TYPE.LGD_TEXT:legend.selectText(true);var childrenNames=[$ENUM_FORMAT_TAG.LEGEND_FONT_SIZE,$ENUM_FORMAT_TAG.LEGEND_FONT_FAMILY,$ENUM_FORMAT_TAG.LEGEND_FONT_STYLE,$ENUM_FORMAT_TAG.LEGEND_FONT_COLOR];tfg=getFontToolbar(me.widget,"lgd",childrenNames,EnumControlScope.GLOBAL,undefined,false);break;default:legend.selectLegendBody();var fillChildrenNames=[$ENUM_FORMAT_TAG.LEGEND_BG_COLOR,$ENUM_FORMAT_TAG.LEGEND_BG_FILL_TRANSPARENCY];tfg=getFillToolbar(me.widget,mstrmojo.desc(2885,"Fill"),fillChildrenNames,EnumControlScope.GLOBAL);break;}if(tfg){me.hideTooltip();showToolbarByFormat.call(me,pos,tfg,true);}});showContextMenu.call(me,pos,menuConfig);switch(type){case CTRL_TYPE.LGD_TITLE:case CTRL_TYPE.LGD_TEXT:legend.selectText(true);break;default:legend.selectLegendBody();break;}}}if(!this.fmtMode&&(type!==CTRL_TYPE.LGD_COLORBOX)&&(type!==CTRL_TYPE.LGD_COLORBOX_CTN)){return false;}switch(type){case CTRL_TYPE.LGD_COLORBOX_CTN:case CTRL_TYPE.LGD_COLORBOX:if(type===CTRL_TYPE.LGD_COLORBOX){target=target.parentNode;}identity=target.firstChild.identity;if(identity&&identity.comb){this.widget.colorSqureIdentity=identity;legend.selectColorBox(target,this.fmtMode);tfg=getColorpickerToolbar(this.widget,$ENUM_FORMAT_TAG.COLOR_SQUARE_COLOR,EnumControlScope.GLOBAL,{showGradient:this.isShowGradientAllowed(),showAutomatic:true});pos=legend.adjustColorPickerPos(target);if(!pos.alignLeft){corners=tfg.ENUM_CORNERS;tfg.setAlignment(corners.BOTTOM_LEFT,corners.TOP_RIGHT);}}break;case CTRL_TYPE.LGD_TITLE:case CTRL_TYPE.LGD_TEXT:legend.selectText(true);var childrenNames=[$ENUM_FORMAT_TAG.LEGEND_FONT_SIZE,$ENUM_FORMAT_TAG.LEGEND_FONT_FAMILY,$ENUM_FORMAT_TAG.LEGEND_FONT_STYLE,$ENUM_FORMAT_TAG.LEGEND_FONT_COLOR];tfg=getFontToolbar(this.widget,"lgd",childrenNames,EnumControlScope.GLOBAL,undefined,false);break;default:legend.selectLegendBody();var fillChildrenNames=[$ENUM_FORMAT_TAG.LEGEND_BG_COLOR,$ENUM_FORMAT_TAG.LEGEND_BG_FILL_TRANSPARENCY];tfg=getFillToolbar(this.widget,mstrmojo.desc(2885,"Fill"),fillChildrenNames,EnumControlScope.GLOBAL);break;}if(tfg){this.hideTooltip();showToolBar.call(this,pos,tfg,true);}},hideContextMenu:function(){var ph=this.domMenuPH,phChild=ph.firstChild,phParent=ph.parentNode,widget=this.widget;GMUTIL.destroyDisposable(widget,widget.menuEditor);if(phChild){ph.removeChild(phChild);}if(phParent){phParent.removeChild(ph);}var _this=widget.menuEditor;if(_this){widget.removeChildren(_this);_this.unrender=function(){_this._super();};_this.destroy();_this.unrender=function(){};delete widget.menuEditor;}if(widget.menuEditorClosefn){$DOM.detachEvent(document.body,"mousedown",widget.menuEditorClosefn,true);delete widget.menuEditorClosefn;}},hideToolbar:function(){var ph=this.domToolbarPH,phChild=ph.firstChild,phParent=ph.parentNode,widget=this.widget;GMUTIL.destroyDisposable(widget,widget.toolEditor);if(phChild){ph.removeChild(phChild);widget.clearUserSelections();if(widget.legend){widget.legend.clearSelectedTargets();}}if(phParent){phParent.removeChild(ph);}var _this=widget.toolEditor;if(_this){widget.removeChildren(_this);_this.unrender=function(){_this._super();};_this.destroy();_this.unrender=function(){};delete widget.toolEditor;$CSS.toggleClass(document.body,"hasToolbarPopup",false);$CSS.toggleClass(ph,mstrApp.getThemeClassName(),false);}if(widget.toolEditorClosefn){$DOM.detachEvent(document.body,"mousedown",widget.toolEditorClosefn,true);delete widget.toolEditorClosefn;}},handleMouseMove4DropZone:function(x,y){var widget=this.widget,config=this.prepare4DropZoneManipulation(x,y,widget);if(!config.process){return ;}},doHighlight:function(type,data){var shapes,charts,widget=this.widget,manager=widget.manager,dataCopy=$HASH.clone(data);widget.clearSelections(true,true);if(type===SEL_TYPE.METRICS){$HASH.forEach(data,function(sel){widget.addMetricValueSelection(sel);});}else{if(type===SEL_TYPE.ATTS){$HASH.forEach(data,function(sel){$HASH.forEach(sel,function(ee,aid){$ARR.forEach(ee,function(e){widget.addAttributeSelection(aid,e.id,e.n);});});});}}if(manager){if(type===SEL_TYPE.METRICS){var keys=Object.keys(data);if(keys[0]){dataCopy={};var intersectionUnitIds=widget.GMController.checkAttributeIntersection(data[keys[0]],["Rows","Columns","XAxis","YAxis"]);if(intersectionUnitIds.length===1){var intersectionUnitId=intersectionUnitIds[0],attributeElementsIds=[];$HASH.forEach(data,function(oneMetricSelectionRule,metricSelectionRuleKey){$HASH.forEach(oneMetricSelectionRule,function(oneAttributeRule,attributeKey){if(attributeKey===intersectionUnitId&&attributeElementsIds.indexOf(oneAttributeRule[0].id)===-1){attributeElementsIds.push(oneAttributeRule[0].id);dataCopy[metricSelectionRuleKey]={};dataCopy[metricSelectionRuleKey][attributeKey]=oneAttributeRule;}});});}charts=manager.filterCharts(dataCopy);if(charts&&charts.length>0){batchSelectCharts.call(this,charts);}else{dataCopy=$HASH.clone(data);shapes=manager.filterShapes(dataCopy);if(shapes&&shapes.length>0){this.selectShapes(shapes);}}}else{dataCopy=$HASH.clone(data);shapes=manager.filterShapes(dataCopy);if(shapes&&shapes.length>0){this.selectShapes(shapes);}}}else{if(type===SEL_TYPE.ATTS){dataCopy=$HASH.clone(data);charts=manager.filterCharts(dataCopy);if(charts&&charts.length>0){batchSelectCharts.call(this,charts);}else{if(!$HASH.isEmpty(data)){dataCopy=$HASH.clone(data);var dz=widget.model.data.dz,axisUnits=(dz.XAxis.TemplateUnit||[]).concat(dz.YAxis.TemplateUnit||[]),axisUnitIds=[];$ARR.forEach(axisUnits,function(axisUnit){axisUnitIds.push(axisUnit.id);});shapes=manager.filterShapes(dataCopy);if(shapes&&shapes.length>0){this.selectShapes(shapes);}}}}}}if((charts&&charts.length>0)||$HASH.isEmpty(data)||(data&&data.length===1&&data[0].hashKey==="")){this.toggleGMFade(false);}widget.resetSelectionEmptyFlag();},prepare4DropZoneManipulation:function(x,y,widget,direction){if(widget.isEmpty()){return{process:true,box:this.getComponentBBox(widget,CTRL_TYPE.GM_MINI_CHART),row:0,col:0};}var i,row,col,chartBox,chartDivX,chartDivY,labelDiv,combinedLabelDiv,mainContainerPos=$DOM.position(widget.domMainContainer),yBoxWithExtra=this.getComponentBBox(widget,CTRL_TYPE.GM_YAXIS,true),yBox=this.getComponentBBox(widget,CTRL_TYPE.GM_YAXIS),xBox=this.getComponentBBox(widget,CTRL_TYPE.GM_XAXIS),gmBox=this.getComponentBBox(widget,CTRL_TYPE.GM_MINI_CHART),y2Box=this.getComponentBBox(widget,CTRL_TYPE.GM_YAXIS2),x2Box=this.getComponentBBox(widget,CTRL_TYPE.GM_XAXIS2),isPrimary=this.isAxisPrimary(widget.currEnteredDropZoneID),manager=widget.manager,yBody=isPrimary?manager.yAxis:manager.yAxis2,xBody=isPrimary?manager.xAxis:manager.xAxis2,oppoXBody=isPrimary?manager.xAxis2:manager.xAxis,oppoYBody=isPrimary?manager.yAxis2:manager.yAxis,gmBody=manager.master,config={process:false},shiftBox=function(box,dx,dy){box.left+=dx;box.top+=dy;};var tgtItemsInGraphZone=this.getZoneItems(widget.currEnteredDropZoneID,widget,true),itemsCnt=tgtItemsInGraphZone.length,getLabelNodes=function(row,itemsCnt,body){var curr=row%itemsCnt,start=row-curr,end=start+itemsCnt-1,labelNodes=[],chartDiv,labelDiv;for(i=start;i<=end;i++){chartDiv=direction==="V"?body.getChart(i,0):body.getChart(0,i);labelDiv=chartDiv&&chartDiv.labelDiv;labelDiv=labelDiv&&labelDiv.firstChild;if(labelDiv){labelNodes.push({node:labelDiv,nodePos:$DOM.position(labelDiv),nodeContent:getInnerText(labelDiv)});}}return labelNodes;},fnGetLabelDiv=function(chartDiv,idx,body,isOpposite){labelDiv=chartDiv&&chartDiv.labelDiv;combinedLabelDiv=chartDiv&&chartDiv.combinedLabelDiv;labelDiv=labelDiv&&labelDiv.firstChild;if(labelDiv){config.dzId=parseInt(labelDiv.getAttribute("dzId"),10);config.axisIndex=parseInt(labelDiv.getAttribute("dzIndex"),10);if(body){config.labelNodes=getLabelNodes(idx,itemsCnt,body);}}if(combinedLabelDiv&&!isOpposite){config.labelNodes=[{node:combinedLabelDiv,nodePos:$DOM.position(combinedLabelDiv),clonedNode:combinedLabelDiv.cloneNode(true)}];}return labelDiv;},fnGetAxisIndexAndLabels=function(chartDiv,idx,body,oppoChartDiv){if(!fnGetLabelDiv(chartDiv,idx,body)){fnGetLabelDiv(oppoChartDiv,null,null,true);}};x=x-mainContainerPos.x;y=y-mainContainerPos.y;if(isPointInBox(x,y,yBoxWithExtra)){x-=yBox.left;y-=yBox.top;row=yBody.doRowIntersectionCheck(y,y,true).start;chartBox=yBody.getChartBBox(row,0,true);chartDivY=yBody.getChart(row,0);shiftBox(chartBox,yBox.left,yBox.top);config.process=true;config.box=chartBox;config.nearToV=((y-chartBox.top)<(chartBox.height>>1))?0:1;config.row=row;config.col=0;fnGetAxisIndexAndLabels(chartDivY,row,yBody,oppoYBody&&oppoYBody.getChart(row,0));}else{if(isPointInBox(x,y,xBox)){x-=xBox.left;y-=xBox.top;col=xBody.doColIntersectionCheck(x,x,true).start;chartBox=xBody.getChartBBox(0,col,true);chartDivX=xBody.getChart(0,col);labelDiv=chartDivX.labelDiv;combinedLabelDiv=chartDivX.combinedLabelDiv;shiftBox(chartBox,xBox.left,xBox.top);config.process=true;config.box=chartBox;config.row=0;config.col=col;config.nearToH=((x-chartBox.left)<(chartBox.width>>1))?0:1;fnGetAxisIndexAndLabels(chartDivX,col,xBody,oppoXBody&&oppoXBody.getChart(0,col));}else{if(isPointInBox(x,y,gmBox)){x-=gmBox.left;y-=gmBox.top;gmBody=manager.master;row=gmBody.doRowIntersectionCheck(y,y,true).start;col=gmBody.doColIntersectionCheck(x,x,true).start;chartBox=gmBody.getChartBBox(row,col,true);chartDivY=yBody&&yBody.getChart(row,0);chartDivX=xBody&&xBody.getChart(0,col);shiftBox(chartBox,gmBox.left,gmBox.top);config.process=true;config.box=chartBox;config.row=row;config.col=col;config.nearToV=((y-chartBox.top)<(chartBox.height>>1))?0:1;config.nearToH=((x-chartBox.left)<(chartBox.width>>1))?0:1;if(direction==="H"){fnGetAxisIndexAndLabels(chartDivX,col,xBody,oppoXBody&&oppoXBody.getChart(0,col));}else{fnGetAxisIndexAndLabels(chartDivY,row,yBody,oppoYBody&&oppoYBody.getChart(row,0));}}else{if(isPointInBox(x,y,y2Box)){x-=y2Box.left;y-=y2Box.top;if(!yBody){return config;}row=yBody.doRowIntersectionCheck(y,y,true).start;chartBox=yBody.getChartBBox(row,0,true);chartDivY=yBody.getChart(row,0);shiftBox(chartBox,y2Box.left,y2Box.top);config.process=true;config.box=chartBox;config.nearToV=((y-chartBox.top)<(chartBox.height>>1))?0:1;config.row=row;config.col=0;fnGetAxisIndexAndLabels(chartDivY,row,yBody,oppoYBody&&oppoYBody.getChart(row,0));}else{if(isPointInBox(x,y,x2Box)){x-=x2Box.left;y-=x2Box.top;if(!xBody){return config;}col=xBody.doColIntersectionCheck(x,x,true).start;chartBox=xBody.getChartBBox(0,col,true);chartDivX=xBody.getChart(0,col);shiftBox(chartBox,x2Box.left,x2Box.top);config.process=true;config.box=chartBox;config.row=0;config.col=col;config.nearToH=((x-chartBox.left)<(chartBox.width>>1))?0:1;fnGetAxisIndexAndLabels(chartDivX,col,xBody,oppoXBody&&oppoXBody.getChart(0,col));}}}}}return config;},getBackGroundColor:function getBGColor(widget){return $CSS.getComputedStyle(widget.domGM).backgroundColor;},toggleHoverEffect:function disableHoverEffect(w,enable){var resizers,cnt,resizer,i;if(enable){resizers=w.domNode.getElementsByClassName("disable-draggable");cnt=resizers.length;for(i=cnt-1;i>=0;i--){resizer=resizers[i];$CSS.addClass(resizer,"draggable");$CSS.removeClass(resizer,"disable-draggable");}}else{resizers=w.domNode.getElementsByClassName("draggable");cnt=resizers.length;for(i=cnt-1;i>=0;i--){resizer=resizers[i];$CSS.removeClass(resizer,"draggable");$CSS.addClass(resizer,"disable-draggable");}}},getComponentBBox:function(widget,type,withExtraSpace){var dx,dy,domNode,box={};dx=dy=0;box.left=box.top=box.width=box.height=0;if(widget.isEmpty()){var w=widget.domNode.offsetWidth,h=widget.domNode.offsetHeight;switch(type){case CTRL_TYPE.GM_ROW_HEADER:box.height=h;break;case CTRL_TYPE.GM_COL_HEADER:box.width=w;break;case CTRL_TYPE.GM_YAXIS:box.height=h;break;case CTRL_TYPE.GM_XAXIS:box.top=h;box.width=w;break;case CTRL_TYPE.GM_MINI_CHART:box.width=w;box.height=h;break;case CTRL_TYPE.GM_YAXIS2:box.height=h;box.left=w;break;case CTRL_TYPE.GM_XAXIS2:box.width=w;break;}return box;}switch(type){case CTRL_TYPE.GM_ROW_HEADER:domNode=widget.domRowHeader;break;case CTRL_TYPE.GM_COL_HEADER:domNode=widget.domColHeader;break;case CTRL_TYPE.GM_YAXIS:domNode=widget.domYAxis;break;case CTRL_TYPE.GM_XAXIS:domNode=widget.domXAxis;break;case CTRL_TYPE.GM_MINI_CHART:domNode=widget.domGM;break;case CTRL_TYPE.GM_YAXIS2:domNode=widget.domYAxis2;break;case CTRL_TYPE.GM_XAXIS2:domNode=widget.domXAxis2;break;}var stringToInt=function(str){var f=parseFloat(str);f=isNaN(f)?0:f;return Math.floor(f+0.5);};if(domNode){if(type===CTRL_TYPE.GM_XAXIS2&&widget.domColHeader){dx=stringToInt(widget.domColHeader.style.left);}box.left=stringToInt(domNode.style.left)+dx;box.top=stringToInt(domNode.style.top)+dy;box.width=stringToInt(domNode.style.width);box.height=stringToInt(domNode.style.height);}else{if(type===CTRL_TYPE.GM_XAXIS2){box.left=widget.offsetX;box.top=widget.offsetY;box.width=widget.GMW;box.height=0;}}if(withExtraSpace){if(type===CTRL_TYPE.GM_COL_HEADER){var hArray=widget.colHeaderHArr,hh=0;var i;for(i=0;hArray&&i<hArray.length;i++){hh+=hArray[i];}box.height=hh;box.width+=stringToInt(widget.colTitleW);box.left-=stringToInt(widget.colTitleW);}else{if(type===CTRL_TYPE.GM_ROW_HEADER){box.top-=stringToInt(widget.rowTitleH);box.height+=widget.actualHeight-box.top;}else{if(type===CTRL_TYPE.GM_YAXIS){var colHeaderBox=this.getComponentBBox(widget,CTRL_TYPE.GM_COL_HEADER,true);box.top=colHeaderBox.height;box.height=widget.actualHeight-box.top;}}}}return box;},getOppositeZoneID:function getOppositeZoneID(zoneKey){var oppoZoneKey=null;switch(zoneKey){case CTRL_TYPE.GM_XAXIS:oppoZoneKey=CTRL_TYPE.GM_XAXIS2;break;case CTRL_TYPE.GM_XAXIS2:oppoZoneKey=CTRL_TYPE.GM_XAXIS;break;case CTRL_TYPE.GM_YAXIS:oppoZoneKey=CTRL_TYPE.GM_YAXIS2;break;case CTRL_TYPE.GM_YAXIS2:oppoZoneKey=CTRL_TYPE.GM_YAXIS;break;}return oppoZoneKey;},isZoneOnGraphDropAllowed:function isZoneOnGraphDropAllowed(zoneKey,dragData,w){var dropZoneOnGraph=w.dropZonesOnGraph[zoneKey],zone=dropZoneOnGraph.zoneModel,item=dragData.item,oppoZoneKey=this.getOppositeZoneID(zoneKey),itemsOnOppoSide=this.getZoneItems(oppoZoneKey,w,true),otherAxisHasMetricCnt=0,gmZoneModels=getEssentialZoneModels(w),zoneCtrlType,i;if(gmZoneModels.isGraphDroppingAllowed(zone,dragData.src,dragData.item)){if(gmZoneModels.isAttrCategory(item)){}else{if(gmZoneModels.isMetric(item)){if(itemsOnOppoSide&&itemsOnOppoSide.length>0&&gmZoneModels.isAttrCategory(itemsOnOppoSide[0])){return false;}if(dragData.src!==ENUM_SOURCE.VIZ){for(zoneCtrlType in w.dropZonesOnGraph){var hasMetricInGraphZone=this.hasMetricInGraphZone(zoneCtrlType,w,dragData);if(zoneCtrlType!==zoneKey&&hasMetricInGraphZone){otherAxisHasMetricCnt++;}}if(otherAxisHasMetricCnt>=2){return false;}}if(gmZoneModels.isMetricZone(zone.id)&&itemsOnOppoSide.length>0){var otherSideHeaderZone=this.getDropZoneModelByCtlType(this.isWhichAxis(zoneKey)==="x"?CTRL_TYPE.GM_ROW_HEADER:CTRL_TYPE.GM_COL_HEADER,w),metricNameOnOtherSide=false;for(i=0;i<otherSideHeaderZone.items.length;i++){if(gmZoneModels.isMetricName(otherSideHeaderZone.items[i])){metricNameOnOtherSide=true;}}if(metricNameOnOtherSide){if(gmZoneModels.isMetric(itemsOnOppoSide[0])&&item.zone!==itemsOnOppoSide[0].zone){return false;}}}}}return true;}return false;},getDropZoneIdByCtlType:function getDZIdByCtlType(zoneCT){var zoneID=null;if(zoneCT===CTRL_TYPE.GM_ROW_HEADER){zoneID=ENUM_DZID.Rows;}else{if(zoneCT===CTRL_TYPE.GM_COL_HEADER){zoneID=ENUM_DZID.Columns;}else{if(zoneCT===CTRL_TYPE.GM_XAXIS||zoneCT===CTRL_TYPE.GM_XAXIS2){zoneID=ENUM_DZID.XAxis;}else{if(zoneCT===CTRL_TYPE.GM_YAXIS||zoneCT===CTRL_TYPE.GM_YAXIS2){zoneID=ENUM_DZID.YAxis;}}}}return zoneID;},getDropZoneModelByCtlType:function getDropZoneModelByCtlType(zoneCT,w){var zoneID=this.getDropZoneIdByCtlType(zoneCT);return this.getZoneModelByZoneId(zoneID,w);},getZoneModelByZoneId:function getZoneModelByZoneId(id,w){var zonesModel=getEssentialZoneModels(w);return zonesModel&&zonesModel.getZoneModelByZoneId(id);},hasMetricInGraphZone:function hasMetricInGraphZone(zoneCtrlType,w,dragData){var items=this.getZoneItems(zoneCtrlType,w,true),cnt=items.length,i,gmZoneModels=getEssentialZoneModels(w);if(cnt<=0){return false;}if(dragData.item&&(dragData.src===ENUM_SOURCE.VIZ_EDITOR||dragData.src===ENUM_SOURCE.VIZ)){var dragItemIdx=$ARR.find(items,"did",dragData.item.did);if(dragItemIdx>=0){items.splice(dragItemIdx,1);}}for(i=0;i<items.length;i++){if(gmZoneModels.isMetric(items[i])){return true;}}return false;},getDropZoneDirection:function getDropZoneDirection(zoneID){var direction=null;if(zoneID===CTRL_TYPE.GM_COL_HEADER||zoneID===CTRL_TYPE.GM_XAXIS||zoneID===CTRL_TYPE.GM_XAXIS2){direction="H";}else{if(zoneID===CTRL_TYPE.GM_ROW_HEADER||zoneID===CTRL_TYPE.GM_YAXIS||zoneID===CTRL_TYPE.GM_YAXIS2){direction="V";}}return direction;},isWhichAxis:function isWhichAxis(zoneID){var axis=null;if(zoneID===CTRL_TYPE.GM_XAXIS||zoneID===CTRL_TYPE.GM_XAXIS2){axis="x";}else{if(zoneID===CTRL_TYPE.GM_YAXIS||zoneID===CTRL_TYPE.GM_YAXIS2){axis="y";}}return axis;},isAxisPrimary:function isAxisPrimary(zoneID){var result=null;if(zoneID===CTRL_TYPE.GM_XAXIS||zoneID===CTRL_TYPE.GM_YAXIS){result=true;}else{if(zoneID===CTRL_TYPE.GM_XAXIS2||zoneID===CTRL_TYPE.GM_YAXIS2){result=false;}}return result;},getMetricIDAndDZIdxFromAxisIdx:function getMetricIDAndDZIdxFromAxisIdx(zoneCtlType,axisIndex,isPrimary,w,findPrevMIdx){var gmCtl=w.GMController,isDualAxis=this.isWhichAxis(zoneCtlType)==="x"?gmCtl.isXDualAxis:gmCtl.isYDualAxis,dzIndex,metricID,tgtItems=this.getZoneItems(zoneCtlType,w),res,group,groupInfo;var shallWeUseGroupInfo=gmCtl.shallWeUseGroupInfo,existingGroupInfo=gmCtl.hasGroupInfoStored();if(shallWeUseGroupInfo){groupInfo=existingGroupInfo.gi;if(axisIndex>=0&&axisIndex<groupInfo.length){group=groupInfo[axisIndex];metricID=group.length===2&&(isPrimary?group[0]:group[1]);}dzIndex=$ARR.find(tgtItems,"did",metricID);}else{if(isDualAxis){if(!shallWeUseGroupInfo){var idxArray=isPrimary?gmCtl.getPrimaryMetrics():gmCtl.getSecondaryMetrics(),metricIds=gmCtl.model.getMetricIds();if(axisIndex>=0&&axisIndex<idxArray.length){dzIndex=idxArray[axisIndex];metricID=metricIds[dzIndex];}}}else{dzIndex=axisIndex;var zoneMapper={x:gmCtl.getMetricsOnPrimaryXAxis,x2:gmCtl.getMetricsOnSecondaryXAxis,y:gmCtl.getMetricsOnPrimaryYAxis,y2:gmCtl.getMetricsOnSecondaryYAxis};var getMetrics=zoneMapper[zoneCtlType];if(getMetrics&&getMetrics.call(gmCtl).length===0){metricID=INVALID_METRIC_IDX;}else{if(axisIndex>=0&&axisIndex<tgtItems.length){metricID=tgtItems[dzIndex].did;}}}}res={metricID:metricID,dzIndex:dzIndex};var mIDs=[],i=0;if(findPrevMIdx){if(groupInfo){if(!isPrimary){mIDs[i++]=group[0];}if(axisIndex-1>=0){mIDs[i++]=groupInfo[axisIndex-1][1];mIDs[i++]=groupInfo[axisIndex-1][0];}res.prevMetricDZIdx=-1;for(i=0;i<mIDs.length;i++){if(mIDs[i]!==INVALID_METRIC_IDX){res.prevMetricDZIdx=$ARR.find(tgtItems,"did",mIDs[i]);break;}}}else{res.prevMetricDZIdx=axisIndex;}}return res;},getDropZonesOnGraph:function getDropZonesOnGraph(context,w){var dragData=context.src.data,item=dragData.item,gmZoneModels=getEssentialZoneModels(w),idx,dropZoneOnGraph,dropZoneKey,me=this;var dropZones=[];if(gmZoneModels.isAttrCategory(item)){dropZones=[CTRL_TYPE.GM_ROW_HEADER,CTRL_TYPE.GM_COL_HEADER];var handleXYAxisForDraggingAttr=function(axisID,axisCtlType,axis2CtlType){if(gmZoneModels.isAttrCategoryZone(axisID)){dropZones.push(axisCtlType);}else{if(gmZoneModels.isMetricZone(axisID)){if(me.getZoneItems(axisCtlType,w,true).length>0){dropZones.push(axisCtlType);}if(me.getZoneItems(axis2CtlType,w,true).length>0){dropZones.push(axis2CtlType);}}else{dropZones.push(axisCtlType);}}};handleXYAxisForDraggingAttr(ENUM_DZID.XAxis,CTRL_TYPE.GM_XAXIS,CTRL_TYPE.GM_XAXIS2);handleXYAxisForDraggingAttr(ENUM_DZID.YAxis,CTRL_TYPE.GM_YAXIS,CTRL_TYPE.GM_YAXIS2);}else{if(gmZoneModels.isMetric(item)){dropZones=[CTRL_TYPE.GM_XAXIS,CTRL_TYPE.GM_YAXIS,CTRL_TYPE.GM_XAXIS2,CTRL_TYPE.GM_YAXIS2];}}w.dropZonesOnGraph={};for(idx in dropZones){dropZoneKey=dropZones[idx];dropZoneOnGraph={zoneModel:this.getDropZoneModelByCtlType(dropZoneKey,w),direction:this.getDropZoneDirection(dropZoneKey,w)};w.dropZonesOnGraph[dropZoneKey]=dropZoneOnGraph;}for(dropZoneKey in w.dropZonesOnGraph){if(!this.isZoneOnGraphDropAllowed(dropZoneKey,dragData,w)){delete w.dropZonesOnGraph[dropZoneKey];}}},calculateDropZoneOnGraphRange:function calculateDropZoneOnGraphRange(widget,context){if(!widget.dropZonesOnGraph){this.getDropZonesOnGraph(context,widget);}var me=this,dropZones=Object.keys(widget.dropZonesOnGraph),w=widget.actualWidth,h=widget.actualHeight,chartBox=me.getComponentBBox(widget,CTRL_TYPE.GM_MINI_CHART),rowHeaderBox=me.getComponentBBox(widget,CTRL_TYPE.GM_ROW_HEADER),yBox=me.getComponentBBox(widget,CTRL_TYPE.GM_YAXIS),colHeaderBox=me.getComponentBBox(widget,CTRL_TYPE.GM_COL_HEADER,true),x2Box=me.getComponentBBox(widget,CTRL_TYPE.GM_XAXIS2),spliterPoint={x:chartBox.left+0.75*chartBox.width,y:chartBox.top+0.25*chartBox.height},zoneCnt=dropZones.length,dragData=context.src.data,dragItem=dragData.item,gmZoneModels=getEssentialZoneModels(widget),itemsReplaced=me.getZoneItems(widget.currEnteredDropZoneID,widget);var isZoneEmpty=function(ctlType){return me.getDropZoneModelByCtlType(ctlType,widget).items.length===0;},rowHeaderToYAxis=false;if(!itemsReplaced&&gmZoneModels.isAttrCategory(dragItem)&&isZoneEmpty(CTRL_TYPE.GM_YAXIS)){rowHeaderToYAxis=true;}if(widget.dropZonesOnGraph[CTRL_TYPE.GM_ROW_HEADER]){dropZones.splice(dropZones.indexOf(CTRL_TYPE.GM_ROW_HEADER),1);zoneCnt--;if(rowHeaderToYAxis){delete widget.dropZonesOnGraph[CTRL_TYPE.GM_ROW_HEADER];}else{if(rowHeaderBox.width===0){if(chartBox.left<=1){rowHeaderBox.width+=30;chartBox.left+=30;chartBox.width-=30;}else{if(yBox.width>0){var rowHeaderWidth=Math.min(30,0.5*yBox.width);rowHeaderBox.width+=rowHeaderWidth;yBox.left+=rowHeaderWidth;yBox.width-=rowHeaderWidth;}}}widget.dropZonesOnGraph[CTRL_TYPE.GM_ROW_HEADER].areaCoords=[[0,x2Box.top,rowHeaderBox.width,x2Box.top,rowHeaderBox.width,h,0,h]];}}if(widget.dropZonesOnGraph[CTRL_TYPE.GM_COL_HEADER]){dropZones.splice(dropZones.indexOf(CTRL_TYPE.GM_COL_HEADER),1);zoneCnt--;if(colHeaderBox.height===0){if(chartBox.top>1){colHeaderBox.height+=chartBox.top;x2Box.top+=chartBox.top;}else{colHeaderBox.height+=30;chartBox.top+=30;chartBox.height-=30;x2Box.top+=30;}}widget.dropZonesOnGraph[CTRL_TYPE.GM_COL_HEADER].areaCoords=[[0,0,w,0,w,x2Box.top,0,x2Box.top]];}var xAxisCoords=[chartBox.left,h,chartBox.left,chartBox.top+chartBox.height,chartBox.left+chartBox.width,chartBox.top+chartBox.height,chartBox.left+chartBox.width,h],yAxisCoords=[rowHeaderBox.width,chartBox.top,chartBox.left,chartBox.top,chartBox.left,h,rowHeaderBox.width,h],xAxis2Coords=[chartBox.left,x2Box.top,chartBox.left+chartBox.width,x2Box.top,chartBox.left+chartBox.width,chartBox.top,chartBox.left,chartBox.top],yAxis2Coords=[chartBox.left+chartBox.width,x2Box.top,w,x2Box.top,w,h,chartBox.left+chartBox.width,h],extraTitleCoords=[rowHeaderBox.width,x2Box.top,chartBox.left,x2Box.top,chartBox.left,chartBox.top,rowHeaderBox.width,chartBox.top];switch(zoneCnt){case 4:widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS].areaCoords=[xAxisCoords,[chartBox.left,chartBox.top+chartBox.height,spliterPoint.x,spliterPoint.y,chartBox.left+chartBox.width,chartBox.top+chartBox.height]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords=[yAxisCoords,[chartBox.left,chartBox.top,spliterPoint.x,spliterPoint.y,chartBox.left,chartBox.top+chartBox.height]];widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS2].areaCoords=[xAxis2Coords,[chartBox.left,chartBox.top,spliterPoint.x,spliterPoint.y,chartBox.left+chartBox.width,chartBox.top]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS2].areaCoords=[yAxis2Coords,[chartBox.left+chartBox.width,chartBox.top,spliterPoint.x,spliterPoint.y,chartBox.left+chartBox.width,chartBox.top+chartBox.height]];break;case 3:if(dropZones.indexOf(CTRL_TYPE.GM_XAXIS2)<0){spliterPoint={x:chartBox.left+0.75*chartBox.width,y:chartBox.top+0.75*chartBox.height};widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS].areaCoords=[xAxisCoords,[chartBox.left,chartBox.top+chartBox.height,spliterPoint.x,spliterPoint.y,chartBox.left+chartBox.width,chartBox.top+chartBox.height]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords=[yAxisCoords,[chartBox.left,chartBox.top,spliterPoint.x,chartBox.top,spliterPoint.x,spliterPoint.y,chartBox.left,chartBox.top+chartBox.height],[chartBox.left,x2Box.top,spliterPoint.x,x2Box.top,spliterPoint.x,chartBox.top,chartBox.left,chartBox.top]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].coordsTransferMap={2:{y:chartBox.top+1}};widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS2].areaCoords=[yAxis2Coords,[spliterPoint.x,spliterPoint.y,spliterPoint.x,chartBox.top,chartBox.left+chartBox.width,chartBox.top,chartBox.left+chartBox.width,chartBox.top+chartBox.height],[spliterPoint.x,x2Box.top,chartBox.left+chartBox.width,x2Box.top,chartBox.left+chartBox.width,chartBox.top,spliterPoint.x,chartBox.top]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS2].coordsTransferMap={2:{y:chartBox.top+1}};}else{if(dropZones.indexOf(CTRL_TYPE.GM_YAXIS2)<0){spliterPoint={x:chartBox.left+0.25*chartBox.width,y:chartBox.top+0.25*chartBox.height};widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS].areaCoords=[xAxisCoords,[chartBox.left,chartBox.top+chartBox.height,spliterPoint.x,spliterPoint.y,chartBox.left+chartBox.width,spliterPoint.y,chartBox.left+chartBox.width,chartBox.top+chartBox.height],[chartBox.left+chartBox.width,spliterPoint.y,w,spliterPoint.y,w,h,chartBox.left+chartBox.width,h]];widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS].coordsTransferMap={2:{x:chartBox.left+chartBox.width-1}};widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords=[yAxisCoords,[chartBox.left,chartBox.top,spliterPoint.x,spliterPoint.y,chartBox.left,chartBox.top+chartBox.height]];widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS2].areaCoords=[xAxis2Coords,[chartBox.left,chartBox.top,spliterPoint.x,spliterPoint.y,chartBox.left+chartBox.width,spliterPoint.y,chartBox.left+chartBox.width,chartBox.top],[chartBox.left+chartBox.width,spliterPoint.y,w,spliterPoint.y,w,x2Box.top,chartBox.left+chartBox.width,x2Box.top]];widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS2].coordsTransferMap={2:{x:chartBox.left+chartBox.width-1}};}}if((dropZones.indexOf(CTRL_TYPE.GM_XAXIS2)<0||dropZones.indexOf(CTRL_TYPE.GM_YAXIS2)<0)){break;}break;case 2:var isXYAxes=this.isWhichAxis(dropZones[0])!==this.isWhichAxis((dropZones[1]));if(!isXYAxes){if(dropZones.indexOf(CTRL_TYPE.GM_YAXIS)>=0){widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords=[[rowHeaderBox.width,chartBox.top,spliterPoint.x,chartBox.top,spliterPoint.x,chartBox.top+chartBox.height,rowHeaderBox.width,chartBox.top+chartBox.height],[rowHeaderBox.width,chartBox.top+chartBox.height,spliterPoint.x,chartBox.top+chartBox.height,spliterPoint.x,h,rowHeaderBox.width,h],[rowHeaderBox.width,x2Box.top,spliterPoint.x,x2Box.top,spliterPoint.x,chartBox.top,rowHeaderBox.width,chartBox.top]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].coordsTransferMap={1:{y:chartBox.top+chartBox.height-1},2:{y:chartBox.top+1}};widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS2].areaCoords=[[spliterPoint.x,chartBox.top,spliterPoint.x,chartBox.top+chartBox.height,w,chartBox.top+chartBox.height,w,chartBox.top],[spliterPoint.x,chartBox.top+chartBox.height,spliterPoint.x,h,w,h,w,chartBox.top+chartBox.height],[spliterPoint.x,x2Box.top,spliterPoint.x,chartBox.top,w,chartBox.top,w,x2Box.top]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS2].coordsTransferMap={1:{y:chartBox.top+chartBox.height-1},2:{y:chartBox.top+1}};}else{if(dropZones.indexOf(CTRL_TYPE.GM_XAXIS)>=0){widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS].areaCoords=[[chartBox.left,spliterPoint.y,w,spliterPoint.y,w,h,chartBox.left,h],[rowHeaderBox.width,spliterPoint.y,chartBox.left,spliterPoint.y,chartBox.left,h,rowHeaderBox.width,h]];widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS].coordsTransferMap={1:{x:chartBox.left+1}};widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS2].areaCoords=[[chartBox.left,x2Box.top,w,x2Box.top,w,spliterPoint.y,chartBox.left,spliterPoint.y],[rowHeaderBox.width,x2Box.top,chartBox.left,x2Box.top,chartBox.left,spliterPoint.y,rowHeaderBox.width,spliterPoint.y]];widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS2].coordsTransferMap={1:{x:chartBox.left+1}};}}}else{if(dropZones.indexOf(CTRL_TYPE.GM_XAXIS)>=0&&dropZones.indexOf(CTRL_TYPE.GM_YAXIS)>=0){widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS].areaCoords=[xAxisCoords,yAxis2Coords,[chartBox.left,chartBox.top+chartBox.height,chartBox.left+chartBox.width,chartBox.top,chartBox.left+chartBox.width,chartBox.top+chartBox.height]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords=[yAxisCoords,xAxis2Coords,[chartBox.left,chartBox.top,chartBox.left+chartBox.width,chartBox.top,chartBox.left,chartBox.top+chartBox.height]];if(rowHeaderToYAxis){widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords.push([0,x2Box.top,rowHeaderBox.width,x2Box.top,rowHeaderBox.width,chartBox.top+chartBox.height,0,chartBox.top+chartBox.height]);widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords.push([0,chartBox.top+chartBox.height,rowHeaderBox.width,chartBox.top+chartBox.height,rowHeaderBox.width,h,0,h]);widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].coordsTransferMap={3:{x:chartBox.left+1},4:{x:chartBox.left+1,y:chartBox.top+chartBox.height-1}};}}else{if(dropZones.indexOf(CTRL_TYPE.GM_XAXIS2)>=0&&dropZones.indexOf(CTRL_TYPE.GM_YAXIS2)>=0){widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS2].areaCoords=[yAxisCoords,xAxis2Coords,[chartBox.left,chartBox.top,chartBox.left+chartBox.width,chartBox.top,chartBox.left,chartBox.top+chartBox.height]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS2].areaCoords=[xAxisCoords,yAxis2Coords,[chartBox.left,chartBox.top+chartBox.height,chartBox.left+chartBox.width,chartBox.top,chartBox.left+chartBox.width,chartBox.top+chartBox.height]];if(!(dropZones.indexOf(CTRL_TYPE.GM_XAXIS2)<0||dropZones.indexOf(CTRL_TYPE.GM_YAXIS2)<0)){if(dragItem.ax===0&&dragItem.zone===4){widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords=[yAxisCoords,[chartBox.left,chartBox.top,spliterPoint.x,spliterPoint.y,chartBox.left,chartBox.top+chartBox.height]];}else{if(dragItem.ax===0&&dragItem.zone===3){widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS].areaCoords=[xAxisCoords,[chartBox.left,chartBox.top+chartBox.height,spliterPoint.x,spliterPoint.y,chartBox.left+chartBox.width,chartBox.top+chartBox.height]];}else{if(dragItem.ax===1&&dragItem.zone===4){widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords=[yAxisCoords,[chartBox.left,chartBox.top,spliterPoint.x,spliterPoint.y,chartBox.left,chartBox.top+chartBox.height]];}else{if(dragItem.ax===1&&dragItem.zone===3){widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS2].areaCoords=[xAxis2Coords,[chartBox.left,chartBox.top,spliterPoint.x,spliterPoint.y,chartBox.left+chartBox.width,chartBox.top]];}}}}}}else{if(dropZones.indexOf(CTRL_TYPE.GM_XAXIS)>=0&&dropZones.indexOf(CTRL_TYPE.GM_YAXIS2)>=0){widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS].areaCoords=[xAxisCoords,yAxisCoords,[chartBox.left,chartBox.top,chartBox.left+chartBox.width,chartBox.top+chartBox.height,chartBox.left,chartBox.top+chartBox.height]];widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS2].areaCoords=[xAxis2Coords,yAxis2Coords,[chartBox.left,chartBox.top,chartBox.left+chartBox.width,chartBox.top,chartBox.left+chartBox.width,chartBox.top+chartBox.height]];}else{if(dropZones.indexOf(CTRL_TYPE.GM_XAXIS2)>=0&&dropZones.indexOf(CTRL_TYPE.GM_YAXIS)>=0){widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords=[xAxisCoords,yAxisCoords,[chartBox.left,chartBox.top,chartBox.left+chartBox.width,chartBox.top+chartBox.height,chartBox.left,chartBox.top+chartBox.height]];widget.dropZonesOnGraph[CTRL_TYPE.GM_XAXIS2].areaCoords=[xAxis2Coords,yAxis2Coords,[chartBox.left,chartBox.top,chartBox.left+chartBox.width,chartBox.top,chartBox.left+chartBox.width,chartBox.top+chartBox.height]];}}}}}break;case 1:widget.dropZonesOnGraph[dropZones[0]].areaCoords=[[rowHeaderBox.width,colHeaderBox.height,w,colHeaderBox.height,w,h,rowHeaderBox.width,h]];break;}if(widget.extraTitleDiv&&dropZones.indexOf(CTRL_TYPE.GM_YAXIS)>=0){yAxisCoords=widget.dropZonesOnGraph[CTRL_TYPE.GM_YAXIS].areaCoords;yAxisCoords=yAxisCoords.push(extraTitleCoords);}},getDropAvatarIcon:function getDropAvatarIcon(context){var dragData=context.src.data,iconCls,tgtData=context.tgtData;if(tgtData){if(dragData.src===ENUM_SOURCE.DATASETS||dragData.src===ENUM_SOURCE.ALL_OBJECT_LIST){if(tgtData.edge===TARGET_ON){iconCls="replace";}else{iconCls="add";}}else{if(dragData.src===ENUM_SOURCE.VIZ_EDITOR||dragData.src===ENUM_SOURCE.VIZ){if(tgtData.edge===TARGET_ON){iconCls="swap";}else{iconCls="move";}}}}else{if(context.isDragingMultipleObj){iconCls="add";}}return iconCls;},drawReplaceHighlight:function drawReplaceHighlight(context,ctx,l,t,w,h,widget){var tgtData=context.tgtData,bgColor=this.getBackGroundColor(widget),dzAxis=widget.currEnteredDropZoneID,i;l=Math.max(l,0);t=Math.max(t,0);var mainContainerPos=$DOM.position(widget.domMainContainer),dndTooltip=widget.dndTooltip;tgtData.tooltipAnchorPos={x:l+mainContainerPos.x,y:t+mainContainerPos.y,w:w,h:h};var tooltipText;if(tgtData.isReplaceAll||(tgtData.highlightNodes&&tgtData.highlightNodes.length>1)){var itemsReplaced=this.getZoneItems(widget.currEnteredDropZoneID,widget),itemsReplacedCnt=itemsReplaced.length;if(itemsReplacedCnt===1){tooltipText=mstrmojo.desc(14438,"Replace")+" "+itemsReplaced[0].n;}else{if(itemsReplacedCnt>1){tooltipText=mstrmojo.desc(14439,"Replace All")+"( "+itemsReplacedCnt+"): ";for(i=0;i<itemsReplacedCnt;i++){tooltipText+=itemsReplaced[i].n;if(i<itemsReplacedCnt-1){tooltipText+=", ";}}}}}else{var item=(tgtData.zoneSource&&tgtData.zoneSource.zoneModel.items[tgtData.tgtIdx])||(tgtData.highlightNodes&&tgtData.highlightNodes[0]&&tgtData.highlightNodes[0].item);tooltipText=mstrmojo.desc(14438,"Replace")+" "+item.n;}tgtData.tooltipText=tooltipText;tgtData.placementOrder=[dndTooltip.PLACEMENT_ABOVE];tgtData.popupNodeOffset=5;ctx.save();ctx.beginPath();ctx.rect(l,t,w,h);ctx.fillStyle=mstrApp.getThemeClassName()==="mojo-theme-light"?"#bce8ff":"#20516b";ctx.globalAlpha=0.4;ctx.fill();ctx.lineWidth=2;ctx.strokeStyle=bgColor;ctx.beginPath();ctx.moveTo(l,t);if(dzAxis===CTRL_TYPE.GM_XAXIS||dzAxis===CTRL_TYPE.GM_XAXIS2||dzAxis===CTRL_TYPE.GM_COL_HEADER){ctx.lineTo(l+w,t);ctx.moveTo(l,t+h);}else{if(dzAxis===CTRL_TYPE.GM_YAXIS||dzAxis===CTRL_TYPE.GM_YAXIS2||dzAxis===CTRL_TYPE.GM_ROW_HEADER){ctx.lineTo(l,t+h);ctx.moveTo(l+w,t);}}ctx.lineTo(l+w,t+h);ctx.stroke();ctx.strokeStyle=mstrApp.getThemeClassName()==="mojo-theme-light"?"#e4f6ff":"#1f333d";ctx.globalAlpha=1;ctx.stroke();ctx.strokeStyle="#34abeb";ctx.globalAlpha=1;if(dzAxis===CTRL_TYPE.GM_XAXIS||dzAxis===CTRL_TYPE.GM_XAXIS2||dzAxis===CTRL_TYPE.GM_COL_HEADER){$VISUTIL.drawDashLine(ctx,l,t,l+w,t,2,2);$VISUTIL.drawDashLine(ctx,l,t+h,l+w,t+h,2,2);}else{if(dzAxis===CTRL_TYPE.GM_YAXIS||dzAxis===CTRL_TYPE.GM_YAXIS2||dzAxis===CTRL_TYPE.GM_ROW_HEADER){$VISUTIL.drawDashLine(ctx,l,t,l,t+h,2,2);$VISUTIL.drawDashLine(ctx,l+w,t,l+w,t+h,2,2);}}ctx.restore();},showDndArrow:function showDndArrow(context,ctx,ax,ay,widget){var canvasPos=$DOM.position(ctx.canvas),dzAxis=widget.currEnteredDropZoneID,lArrow,tArrow,cssClass;lArrow=ax-ADD_POS_INDICATOR_HALF_WIDTH+canvasPos.x;tArrow=ay-ADD_POS_INDICATOR_HALF_HEIGHT+canvasPos.y;if(dzAxis===CTRL_TYPE.GM_XAXIS){cssClass="gm-dnd-arrow below";}else{if(dzAxis===CTRL_TYPE.GM_XAXIS2){cssClass="gm-dnd-arrow above";}else{if(dzAxis===CTRL_TYPE.GM_YAXIS){cssClass="gm-dnd-arrow left";}else{if(dzAxis===CTRL_TYPE.GM_YAXIS2){cssClass="gm-dnd-arrow right";}}}}if(widget.dndArrow){widget.dndArrow.className=cssClass;widget.dndArrow.style.top=tArrow+"px";widget.dndArrow.style.left=lArrow+"px";widget.dndArrow.style.display="block";}},hideDndArrow:function hideDndArrow(widget){if(widget.dndArrow){widget.dndArrow.style.display="none";}},drawAddHighlight:function drawAddHighlight(context,ctx,x1,y1,x2,y2,widget,boundary){var tgtData=context.tgtData,edge=tgtData&&tgtData.edge,dragData=context.src.data;boundary=boundary||{x:0,y:0,w:widget.actualWidth,h:widget.actualHeight};var minWidth=boundary.x,minHeight=boundary.y,maxWidth=boundary.w,maxHeight=boundary.h,isVertical=(x1===x2),borderWidth=2,borderWidthHeightAdjust=-(borderWidth-1),fnBoundary=function(v,min,max){return Math.max(min+ADD_HIGHLIGHT_HALF_WIDTH,Math.min(v,max-ADD_HIGHLIGHT_HALF_WIDTH-borderWidthHeightAdjust));};if(isVertical){x1=fnBoundary(x1,minWidth,maxWidth);x2=fnBoundary(x2,minWidth,maxWidth);}else{y1=fnBoundary(y1,minHeight,maxHeight);y2=fnBoundary(y2,minHeight,maxHeight);}var l=isVertical?x1-ADD_HIGHLIGHT_HALF_WIDTH:x1,t=isVertical?y1:y1-ADD_HIGHLIGHT_HALF_WIDTH,w=isVertical?ADD_HIGHLIGHT_WIDTH:x2-x1,h=isVertical?y2-y1:ADD_HIGHLIGHT_WIDTH;var canvasPos=$DOM.position(ctx.canvas),dndTooltip=widget.dndTooltip,lInScreen=l+canvasPos.x,tInScreen=t+canvasPos.y,dragItems=dragData.items,len=dragItems.length||0,tooltipText=mstrmojo.desc(531,"Add");for(var i=0;i<len;i++){if(i===0){tooltipText+=" "+dragItems[i].n;}else{if(i===len-1){tooltipText+=" "+mstrmojo.desc(14450,"add")+" "+dragItems[i].n;}else{tooltipText+=", "+dragItems[i].n;}}}tgtData.tooltipText=tooltipText;tgtData.tooltipAnchorPos={x:lInScreen,y:tInScreen,w:w,h:h};tgtData.placementOrder=[dndTooltip.PLACEMENT_ABOVE];if(!tgtData.isAttr&&(edge===TARGET_ABOVE||edge===TARGET_BELOW)){tgtData.popupNodeOffset=5;}else{tgtData.popupNodeOffset=isVertical?-7:-3;}ctx.save();ctx.beginPath();ctx.rect(l,t,w,h);ctx.fillStyle=mstrApp.getThemeClassName()==="mojo-theme-light"?"#bce8ff":"#20516b";ctx.globalAlpha=0.4;ctx.fill();ctx.lineWidth=2;ctx.strokeStyle=mstrApp.getThemeClassName()==="mojo-theme-light"?"#e4f6ff":"#1f333d";ctx.globalAlpha=1;ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.strokeStyle="#34abeb";$VISUTIL.drawDashLine(ctx,x1,y1,x2,y2,2,2);ctx.restore();},drawGridScale:function drawGridScale(context,ctx,l,t,w,h,isGrid,widget){var tgtData=context.tgtData,edge=tgtData&&tgtData.edge,highlightType=tgtData.highlightType,bgColor=this.getBackGroundColor(widget),dzAxis=widget.currEnteredDropZoneID;l=Math.max(l,0);t=Math.max(t,0);ctx.save();ctx.lineWidth=2;if(edge===TARGET_ON){ctx.strokeStyle=bgColor;ctx.beginPath();ctx.moveTo(l,t);if(dzAxis===CTRL_TYPE.GM_XAXIS||dzAxis===CTRL_TYPE.GM_XAXIS2||dzAxis===CTRL_TYPE.GM_COL_HEADER){ctx.lineTo(l+w,t);ctx.moveTo(l,t+h);}else{if(dzAxis===CTRL_TYPE.GM_YAXIS||dzAxis===CTRL_TYPE.GM_YAXIS2||dzAxis===CTRL_TYPE.GM_ROW_HEADER){ctx.lineTo(l,t+h);ctx.moveTo(l+w,t);}}ctx.lineTo(l+w,t+h);ctx.stroke();ctx.strokeStyle="#34abeb";if(dzAxis===CTRL_TYPE.GM_XAXIS||dzAxis===CTRL_TYPE.GM_XAXIS2||dzAxis===CTRL_TYPE.GM_COL_HEADER){$VISUTIL.drawDashLine(ctx,l,t,l+w,t,2,2);$VISUTIL.drawDashLine(ctx,l,t+h,l+w,t+h,2,2);}else{if(dzAxis===CTRL_TYPE.GM_YAXIS||dzAxis===CTRL_TYPE.GM_YAXIS2||dzAxis===CTRL_TYPE.GM_ROW_HEADER){$VISUTIL.drawDashLine(ctx,l,t,l,t+h,2,2);$VISUTIL.drawDashLine(ctx,l+w,t,l+w,t+h,2,2);}}ctx.beginPath();ctx.rect(l,t,w,h);ctx.fillStyle="#34abeb";ctx.globalAlpha=0.2;ctx.fill();}else{ctx.strokeStyle="#1BA11B";ctx.beginPath();ctx.rect(l,t,w,h);ctx.stroke();}ctx.lineWidth=1;ctx.beginPath();var x,y,i,shortW=6,longW=10;if(dzAxis===CTRL_TYPE.GM_XAXIS||dzAxis===CTRL_TYPE.GM_XAXIS2||dzAxis===CTRL_TYPE.GM_COL_HEADER){if(isGrid){if(highlightType!==WHOLE_ZONE){for(x=l+45;x<(l+w);x+=45){ctx.moveTo(x,t);ctx.lineTo(x,t+h);}}}else{if(highlightType!==WHOLE_ZONE){if(dzAxis===CTRL_TYPE.GM_XAXIS){for(i=1;12*i<w;i++){x=l+12*i;ctx.moveTo(x,t);if(i%2===1){ctx.lineTo(x,t+shortW);}else{ctx.lineTo(x,t+longW);}}}else{for(i=1;12*i<w;i++){x=l+12*i;if(i%2===1){ctx.moveTo(x,t+h-shortW);}else{ctx.moveTo(x,t+h-longW);}ctx.lineTo(x,t+h);}}}}}else{if(dzAxis===CTRL_TYPE.GM_YAXIS||dzAxis===CTRL_TYPE.GM_YAXIS2||dzAxis===CTRL_TYPE.GM_ROW_HEADER){if(isGrid){if(highlightType!==WHOLE_ZONE){for(y=t+45;y<t+h;y+=45){ctx.moveTo(l,y);ctx.lineTo(l+w,y);}}}else{if(highlightType!==WHOLE_ZONE){if(dzAxis===CTRL_TYPE.GM_YAXIS){for(i=1;12*i<h;i++){y=t+12*i;if(i%2===1){ctx.moveTo(l+w-shortW,y);}else{ctx.moveTo(l+w-longW,y);}ctx.lineTo(l+w,y);}}else{for(i=1;12*i<h;i++){y=t+12*i;ctx.moveTo(l,y);if(i%2===1){ctx.lineTo(l+shortW,y);}else{ctx.lineTo(l+longW,y);}}}}}}}ctx.stroke();ctx.restore();},drawRoundRect:function drawRoundRect(ctx,x,y,w,h,r){r=Math.min(w/2,h/2,r||5);ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();ctx.stroke();},drawHighlightOnWholeAxis:function drawHighlightOnWholeAxis(context,ctx,dzAxis,box,zonePos,isAttr,w){var tgtData=context.tgtData,edge=tgtData.edge,highlightType=tgtData.highlightType,borderWidth=2,borderWidthHeightAdjust=-(borderWidth-2);if(highlightType===WHOLE_BOX){if(dzAxis===CTRL_TYPE.GM_XAXIS){this.drawReplaceHighlight(context,ctx,box.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST,box.width-2*borderWidthHeightAdjust,zonePos.height-2*borderWidthHeightAdjust,w);}else{if(dzAxis===CTRL_TYPE.GM_XAXIS2){this.drawReplaceHighlight(context,ctx,box.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST,box.width-2*borderWidthHeightAdjust,zonePos.height-2*borderWidthHeightAdjust,w);}else{if(dzAxis===CTRL_TYPE.GM_YAXIS){this.drawReplaceHighlight(context,ctx,zonePos.left+CANVAS_ADJUST,box.top+CANVAS_ADJUST,zonePos.width-2*borderWidthHeightAdjust,box.height-2*borderWidthHeightAdjust,w);}else{if(dzAxis===CTRL_TYPE.GM_YAXIS2){this.drawReplaceHighlight(context,ctx,zonePos.left+CANVAS_ADJUST,box.top+CANVAS_ADJUST,zonePos.width-2*borderWidthHeightAdjust,box.height-2*borderWidthHeightAdjust,w);}}}}}else{if(highlightType===WHOLE_ZONE){if(edge===TARGET_MIDDLE&&isAttr){if(dzAxis===CTRL_TYPE.GM_XAXIS){this.drawAddHighlight(context,ctx,zonePos.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST,zonePos.left+zonePos.width,zonePos.top+CANVAS_ADJUST,w);}else{if(dzAxis===CTRL_TYPE.GM_YAXIS){this.drawAddHighlight(context,ctx,zonePos.left+CANVAS_ADJUST+zonePos.width,zonePos.top+CANVAS_ADJUST,zonePos.left+CANVAS_ADJUST+zonePos.width,zonePos.top+CANVAS_ADJUST+zonePos.height,w);}}}else{this.drawReplaceHighlight(context,ctx,zonePos.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST,zonePos.width-2*borderWidthHeightAdjust,zonePos.height-2*borderWidthHeightAdjust,w);}}else{if(dzAxis===CTRL_TYPE.GM_XAXIS){this.drawAddHighlight(context,ctx,box.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST,box.left+CANVAS_ADJUST+box.width-2*borderWidthHeightAdjust,zonePos.top+CANVAS_ADJUST,w);}else{if(dzAxis===CTRL_TYPE.GM_XAXIS2){this.drawAddHighlight(context,ctx,box.left+CANVAS_ADJUST,zonePos.top+zonePos.height+CANVAS_ADJUST,box.left+CANVAS_ADJUST+box.width-2*borderWidthHeightAdjust,zonePos.top+zonePos.height+CANVAS_ADJUST,w);}else{if(dzAxis===CTRL_TYPE.GM_YAXIS){this.drawAddHighlight(context,ctx,zonePos.left+zonePos.width+CANVAS_ADJUST,box.top+CANVAS_ADJUST,zonePos.left+zonePos.width+CANVAS_ADJUST,box.top+CANVAS_ADJUST+box.height-2*borderWidthHeightAdjust,w);}else{if(dzAxis===CTRL_TYPE.GM_YAXIS2){this.drawAddHighlight(context,ctx,zonePos.left+CANVAS_ADJUST,box.top+CANVAS_ADJUST,zonePos.left+CANVAS_ADJUST,box.top+CANVAS_ADJUST+box.height-2*borderWidthHeightAdjust,w);}}}}}}},drawHighlightOnHeaders:function drawHighlightOnHeaders(context,ctx,dzAxis,zonePos,w){var tgtData=context.tgtData,edge=tgtData.edge,tgtIdx=tgtData.tgtIdx,borderWidth=2,borderWidthHeightAdjust=-(borderWidth-2),widthArray,i,tgtHeaderOffset=0;if(w.currEnteredDropZoneID===CTRL_TYPE.GM_COL_HEADER){widthArray=w.colHeaderHArr;}else{if(w.currEnteredDropZoneID===CTRL_TYPE.GM_ROW_HEADER){widthArray=w.rowHeaderWArr;}}if(tgtIdx===0&&edge===TARGET_ABOVE){if(dzAxis===CTRL_TYPE.GM_COL_HEADER){this.drawAddHighlight(context,ctx,zonePos.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST,zonePos.left+CANVAS_ADJUST+zonePos.width-2*borderWidthHeightAdjust,zonePos.top+CANVAS_ADJUST,w);}else{if(dzAxis===CTRL_TYPE.GM_ROW_HEADER){this.drawAddHighlight(context,ctx,zonePos.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST,zonePos.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST+zonePos.height-2*borderWidthHeightAdjust,w);}}}else{if(tgtIdx===widthArray.length-1&&edge===TARGET_BELOW&&dzAxis===CTRL_TYPE.GM_ROW_HEADER){this.drawAddHighlight(context,ctx,zonePos.left+zonePos.width+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST,zonePos.left+zonePos.width+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST+zonePos.height,w);}else{if(edge===TARGET_ON){for(i=0;i<tgtIdx;i++){tgtHeaderOffset+=widthArray[i]+1;}tgtHeaderOffset-=1;if(dzAxis===CTRL_TYPE.GM_COL_HEADER){this.drawReplaceHighlight(context,ctx,zonePos.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST+tgtHeaderOffset,zonePos.width-2*borderWidthHeightAdjust,widthArray[tgtIdx]-2*borderWidthHeightAdjust,w);}else{if(dzAxis===CTRL_TYPE.GM_ROW_HEADER){this.drawReplaceHighlight(context,ctx,zonePos.left+CANVAS_ADJUST+tgtHeaderOffset,zonePos.top+CANVAS_ADJUST,widthArray[tgtIdx]-2*borderWidthHeightAdjust,zonePos.height-2*borderWidthHeightAdjust,w);}}}else{for(i=0;i<tgtIdx;i++){tgtHeaderOffset+=widthArray[i]+1;}if(edge===TARGET_BELOW){tgtHeaderOffset+=widthArray[tgtIdx]+1;}tgtHeaderOffset-=1;if(dzAxis===CTRL_TYPE.GM_COL_HEADER){this.drawAddHighlight(context,ctx,zonePos.left+CANVAS_ADJUST,zonePos.top+CANVAS_ADJUST+tgtHeaderOffset,zonePos.left+CANVAS_ADJUST+zonePos.width,zonePos.top+CANVAS_ADJUST+tgtHeaderOffset,w);}else{if(dzAxis===CTRL_TYPE.GM_ROW_HEADER){this.drawAddHighlight(context,ctx,zonePos.left+CANVAS_ADJUST+tgtHeaderOffset,zonePos.top+CANVAS_ADJUST,zonePos.left+CANVAS_ADJUST+tgtHeaderOffset,zonePos.top+CANVAS_ADJUST+zonePos.height,w);}}}}}},updateAvatarIcon:function updateAvatarIcon(context,iconClass){var dragData=context.src.data;if(dragData.setAvatarClass){dragData.setAvatarClass(iconClass||this.getDropAvatarIcon(context));}},onHighLightObjectChange:function(evt){if(this.fmtMode){var idMap=IDENTITY_TYPE_TO_CTRL_TYPE_MAP,targetCtrlTypes=[],targets;evt.identities=decodeIdentities(evt.identities);$ARR.forEach(evt.identities||[],function(identityType){if(idMap.hasOwnProperty(identityType)){targetCtrlTypes=targetCtrlTypes.concat(idMap[identityType]);}});targets=findElementsByAttribute(this.widget.domNode,"type",targetCtrlTypes);this.widget.clearUserSelections();this.clearSelectedTargets();this.selectTarget(targets);}},clearHighlightDropZoneOnGraph:function clearHighlightDropZoneOnGraph(widget){var canvas=widget.dndHighlightCanvas,ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);var nodes=widget.dndHighlightNodes,dndTooltip=widget.dndTooltip;nodes.toggle(false);dndTooltip.toggle(false);this.hideDndArrow(widget);},highlightDropZoneOnGraph:function highlightDropZoneOnGraph(context,widget){var canvas=widget.dndHighlightCanvas,ctx=canvas.getContext("2d");if(!context.isDragingMultipleObj){var tgtData=context.tgtData,tgtInfo=tgtData&&tgtData.tgtInfo,dzAxis=widget.currEnteredDropZoneID,dragData=context.src.data;if(tgtData){var zonePos=tgtData.zonePos,box=tgtInfo&&tgtInfo.box,widgetPos=$DOM.position(widget.domNode);if(widget.currEnteredDropZoneID===CTRL_TYPE.GM_COL_HEADER||widget.currEnteredDropZoneID===CTRL_TYPE.GM_ROW_HEADER){this.drawHighlightOnHeaders(context,ctx,dzAxis,zonePos,widget);}else{if(tgtData.edge===TARGET_ON||tgtData.edge===TARGET_MIDDLE){this.drawHighlightOnWholeAxis(context,ctx,dzAxis,box,zonePos,dragData.isAttr,widget);}else{if(tgtData.edge===TARGET_ABOVE||tgtData.edge===TARGET_BELOW){var gmCtl=widget.GMController,existingGroupInfo=gmCtl.hasGroupInfoStored(),groupInfo=existingGroupInfo.existing&&existingGroupInfo.gi,items=this.getZoneItems(widget.currEnteredDropZoneID,widget),itemRowCnt=existingGroupInfo.existing?groupInfo.length:items.length,axisIndex=tgtInfo.axisIndex,isPrimary=this.isAxisPrimary(tgtData.zoneID),pivotMetricNameToHeader=tgtData.pivotMetricNameTo===CTRL_TYPE.GM_COL_HEADER||tgtData.pivotMetricNameTo===CTRL_TYPE.GM_ROW_HEADER,nextCell=this.getMetricIDAndDZIdxFromAxisIdx(widget.currEnteredDropZoneID,tgtData.edge===TARGET_ABOVE?tgtInfo.axisIndex-1:tgtInfo.axisIndex+1,isPrimary,widget).metricID,addBesideOnTop=(tgtData.edge===TARGET_ABOVE&&axisIndex===0)||((nextCell===INVALID_METRIC_IDX||pivotMetricNameToHeader)&&tgtData.edge===TARGET_ABOVE),addBesideOnBottom=(tgtData.edge===TARGET_BELOW&&axisIndex===itemRowCnt-1)||((nextCell===INVALID_METRIC_IDX||pivotMetricNameToHeader)&&tgtData.edge===TARGET_BELOW),addBeside=addBesideOnTop||addBesideOnBottom,drawFactor=addBeside?(items.length===1?3:5):5,shiftFactor=addBeside?0:2.5,x1,y1,x2,y2,ax,ay;if(tgtData.edge===TARGET_ABOVE){if(dzAxis===CTRL_TYPE.GM_XAXIS){x1=box.left-shiftFactor*getTargetRange(box.width)+CANVAS_ADJUST;y1=zonePos.top+CANVAS_ADJUST;x2=box.left+CANVAS_ADJUST+(drawFactor-shiftFactor)*getTargetRange(box.width);y2=zonePos.top+CANVAS_ADJUST;}else{if(dzAxis===CTRL_TYPE.GM_XAXIS2){x1=box.left-shiftFactor*getTargetRange(box.width)+CANVAS_ADJUST;y1=zonePos.top+zonePos.height+CANVAS_ADJUST;x2=box.left+(drawFactor-shiftFactor)*getTargetRange(box.width)+CANVAS_ADJUST;y2=zonePos.top+zonePos.height+CANVAS_ADJUST;}else{if(dzAxis===CTRL_TYPE.GM_YAXIS){x1=zonePos.left+zonePos.width+CANVAS_ADJUST;y1=box.top-shiftFactor*getTargetRange(box.height)+CANVAS_ADJUST;x2=zonePos.left+zonePos.width+CANVAS_ADJUST;y2=box.top+(drawFactor-shiftFactor)*getTargetRange(box.height)+CANVAS_ADJUST;}else{if(dzAxis===CTRL_TYPE.GM_YAXIS2){x1=zonePos.left+CANVAS_ADJUST;y1=box.top-shiftFactor*getTargetRange(box.height)+CANVAS_ADJUST;x2=zonePos.left+CANVAS_ADJUST;y2=box.top+(drawFactor-shiftFactor)*getTargetRange(box.height)+CANVAS_ADJUST;}}}}}else{if(tgtData.edge===TARGET_BELOW){if(dzAxis===CTRL_TYPE.GM_XAXIS){x1=box.left+box.width-(drawFactor-shiftFactor)*getTargetRange(box.width)+CANVAS_ADJUST;y1=zonePos.top+CANVAS_ADJUST;x2=box.left+box.width+shiftFactor*getTargetRange(box.width)+CANVAS_ADJUST;y2=zonePos.top+CANVAS_ADJUST;}else{if(dzAxis===CTRL_TYPE.GM_XAXIS2){x1=box.left+box.width-(drawFactor-shiftFactor)*getTargetRange(box.width)+CANVAS_ADJUST;y1=zonePos.top+zonePos.height+CANVAS_ADJUST;x2=box.left+box.width+shiftFactor*getTargetRange(box.width)+CANVAS_ADJUST;y2=zonePos.top+zonePos.height+CANVAS_ADJUST;}else{if(dzAxis===CTRL_TYPE.GM_YAXIS){x1=zonePos.left+zonePos.width+CANVAS_ADJUST;y1=box.top+box.height-(drawFactor-shiftFactor)*getTargetRange(box.height)+CANVAS_ADJUST;x2=zonePos.left+zonePos.width+CANVAS_ADJUST;y2=box.top+box.height+shiftFactor*getTargetRange(box.height)+CANVAS_ADJUST;}else{if(dzAxis===CTRL_TYPE.GM_YAXIS2){x1=zonePos.left+CANVAS_ADJUST;y1=box.top+box.height-(drawFactor-shiftFactor)*getTargetRange(box.height)+CANVAS_ADJUST;x2=zonePos.left+CANVAS_ADJUST;y2=box.top+box.height+shiftFactor*getTargetRange(box.height)+CANVAS_ADJUST;}}}}}}this.drawAddHighlight(context,ctx,x1,y1,x2,y2,widget);if(dzAxis===CTRL_TYPE.GM_XAXIS||dzAxis===CTRL_TYPE.GM_XAXIS2){ay=y1;if(addBesideOnTop){ax=x1;}else{if(addBesideOnBottom){ax=x2;}else{ax=Math.round((x1+x2)/2);}}}else{if(dzAxis===CTRL_TYPE.GM_YAXIS||dzAxis===CTRL_TYPE.GM_YAXIS2){ax=x1;if(addBesideOnTop){ay=y1;}else{if(addBesideOnBottom){ay=y2;}else{ay=Math.round((y1+y2)/2);}}}}this.showDndArrow(context,ctx,ax,ay,widget);}}}var nodes=widget.dndHighlightNodes,dndTooltip=widget.dndTooltip;var highlightNodes=tgtData.highlightNodes,tooltipText=tgtData.tooltipText;if(highlightNodes&&highlightNodes.length>0){var rotate="gm-rotate-270",node=highlightNodes[0].node,nodeParent=node&&node.parentNode,needRotate=false;while(nodeParent&&nodeParent.classList){if(nodeParent.classList.contains([rotate])){needRotate=true;break;}nodeParent=nodeParent.parentNode;}rotate=needRotate?rotate:"";nodes.updateNodes(tgtData.highlightNodes,widgetPos,rotate);dndTooltip.placementOrder=[dndTooltip.PLACEMENT_ABOVE];dndTooltip.popupNodeOffset=5;dndTooltip.updateContent(null,nodes.getBoundaryPosForAllNodes(),tooltipText);}else{if(tgtData.tooltipAnchorPos){dndTooltip.placementOrder=tgtData.placementOrder;dndTooltip.popupNodeOffset=tgtData.popupNodeOffset;dndTooltip.updateContent(null,tgtData.tooltipAnchorPos,tooltipText);}}}}},findEnteredDropZoneOnGraph:function findEnteredDropZoneOnGraph(context,w){var pos=context.tgt.pos,i,axis,mainContainerPos=$DOM.position(w.domMainContainer),px=pos.x-mainContainerPos.x,py=pos.y-mainContainerPos.y,isInDropZoneArea=function(zoneCT,x,y){var zone=w.dropZonesOnGraph[zoneCT],areaCoords=zone.areaCoords,coordsTransferMap=zone.coordsTransferMap,cbFun=function(v,k){pos[k]=v+mainContainerPos[k];};for(i=0;i<areaCoords.length;i++){if(inPoly(areaCoords[i],x,y)){if(coordsTransferMap&&coordsTransferMap[i]){$HASH.forEach(coordsTransferMap[i],cbFun);}return true;}}return false;};if(w.currEnteredDropZoneID&&w.dropZonesOnGraph[w.currEnteredDropZoneID]){if(isInDropZoneArea(w.currEnteredDropZoneID,px,py)){return true;}}for(axis in w.dropZonesOnGraph){if(isInDropZoneArea(axis,px,py)){w.currEnteredDropZoneID=axis;return true;}}w.currEnteredDropZoneID=null;context.tgtData=null;return false;},prepareDP4Axis:function(row,col,whichAxis,w){var gmCtrl=w.GMController,iLdsIdx=gmCtrl.mapFromChartToLDSIndex(row,col),rLds=whichAxis==="x"?row:iLdsIdx.r,cLds=whichAxis==="x"?iLdsIdx.c:col,dpIdx=iLdsIdx.dpIdx,dm=gmCtrl.model,lds=dm.getLocalDataSet(rLds,cLds),dps=lds.generateDataProvider(),dp=dps[dpIdx];return dp;},getTgtNode4Dnd:function getTgtNode4Dnd(target,w){return this.getTargetInfo(w,target&&target.pos,true);},getZoneItems:function getZoneItem(zoneID,w,filter,onlyMetric){var zone=this.getDropZoneModelByCtlType(zoneID,w),items=$HASH.cloneArray(zone&&zone.items)||[],item,i,idx,gmZoneModels=getEssentialZoneModels(w);for(i=0;i<items.length;i++){if(gmZoneModels.isMetricName(items[i])){items.splice(i,1);}}if(onlyMetric){for(i=0;i<items.length;i++){if(!gmZoneModels.isMetric(items[i])){items.splice(i,1);}}}if(items.length>0&&filter){if(gmZoneModels.isMetric(items[0])){var gmCtl=w.GMController,metricsIdxArray=[],filteredItems=[];if(zoneID===CTRL_TYPE.GM_XAXIS){metricsIdxArray=gmCtl.getMetricsOnPrimaryXAxis();}else{if(zoneID===CTRL_TYPE.GM_YAXIS){metricsIdxArray=gmCtl.getMetricsOnPrimaryYAxis();}else{if(zoneID===CTRL_TYPE.GM_XAXIS2){metricsIdxArray=gmCtl.getMetricsOnSecondaryXAxis();}else{if(zoneID===CTRL_TYPE.GM_YAXIS2){metricsIdxArray=gmCtl.getMetricsOnSecondaryYAxis();}}}}for(i=0;i<metricsIdxArray.length;i++){idx=$ARR.find(items,"idx",metricsIdxArray[i]);item=items[idx];filteredItems.push(item||{});}return filteredItems;}if(gmZoneModels.isAttrCategory(items[0])){if(zoneID===CTRL_TYPE.GM_XAXIS2||zoneID===CTRL_TYPE.GM_YAXIS2){return[];}return items;}return[];}return items;},handleDropZoneNoChange:function handleDropZoneNoChange(context,w,offset){var gmZoneModels=getEssentialZoneModels(w),gmCtr=w.GMController,tgtData=context.tgtData,zone=tgtData.zoneSource,dragData=context.src.data,draggedItem=dragData.item,draggedItems=dragData.items,itemIdx=gmZoneModels.getUnitIndexInZone(zone.zoneModel,draggedItem),edge=tgtData.edge,idx=tgtData.tgtIdx,tgtInfo=tgtData.tgtInfo,target=context.tgt,targetPos=target.pos,x=targetPos.x,y=targetPos.y,isInSameZone=itemIdx>=0,isAboveDraggedMetric,isBelowDraggedMetric,isOnDraggedMetric,dropZoneNoChange,i,pair,isPrimary=this.isAxisPrimary(w.currEnteredDropZoneID),isDualAxis=this.isWhichAxis(w.currEnteredDropZoneID)==="x"?gmCtr.isXDualAxis:gmCtr.isYDualAxis;if(draggedItems.length>1){return false;}if(gmZoneModels.isMetric(draggedItem)&&gmCtr.shallWeUseGroupInfo){var axisIndex=tgtInfo.axisIndex,groupInfo=gmCtr.getGroupInfo(),groupInfoClone=$HASH.cloneArray(groupInfo),getAxisIndexByGroupInfo=function(metricDid,groupInfo){for(i=0;i<groupInfo.length;i++){pair=groupInfo[i];if(pair[0]===metricDid||pair[1]===metricDid){return i;}}return -1;},draggedItemAxisIndex=getAxisIndexByGroupInfo(draggedItem.did,groupInfo);groupInfoClone=gmZoneModels.fillGroupInfo(context,groupInfoClone,draggedItem.did,isPrimary);if(dragData.src===ENUM_SOURCE.VIZ&&edge===TARGET_MIDDLE&&draggedItemAxisIndex!==axisIndex){dropZoneNoChange=false;}else{dropZoneNoChange=$HASH.equals(groupInfo,groupInfoClone);}}else{if(isDualAxis){var dragToOtherSide=isPrimary!==dragData.isPrimary;if(tgtData.edge!==TARGET_MIDDLE||dragToOtherSide){dropZoneNoChange=false;}else{dropZoneNoChange=true;}}else{isAboveDraggedMetric=itemIdx===idx+1&&tgtData.edge===TARGET_BELOW;isBelowDraggedMetric=itemIdx===idx-1&&tgtData.edge===TARGET_ABOVE;isOnDraggedMetric=itemIdx===idx;dropZoneNoChange=isInSameZone&&(isOnDraggedMetric||isAboveDraggedMetric||isBelowDraggedMetric);}}if(dropZoneNoChange){tgtData.edge=TARGET_ON;if(w.currEnteredDropZoneID===CTRL_TYPE.GM_COL_HEADER||w.currEnteredDropZoneID===CTRL_TYPE.GM_ROW_HEADER){tgtData.tgtIdx=itemIdx;}else{var factor=isAboveDraggedMetric?1:isOnDraggedMetric?0:-1;if(zone.direction==="H"){x+=factor*offset;}else{y+=factor*offset;}tgtData.tgtInfo=this.prepare4DropZoneManipulation(x,y,w,zone.direction);tgtData.highlightType=WHOLE_BOX;tgtData.dropZoneNoChange=true;var isTgtPrimary=this.isAxisPrimary(tgtData.zoneID),md=this.getMetricIDAndDZIdxFromAxisIdx(w.currEnteredDropZoneID,tgtData.tgtInfo.axisIndex,isTgtPrimary,w),dzIndex=md.dzIndex;tgtData.tgtIdx=dzIndex;}}return dropZoneNoChange;},findTargetInDropZoneOnGraph:function findTargetInDropZoneOnGraph(context,w){var target=context.tgt,targetPos=target.pos,dragData=context.src.data,dragItem=dragData.item,tgtNode=null,tgtData={};tgtNode=this.getTgtNode4Dnd(target,w);if(tgtNode){tgtData.highlightNodes=[];tgtData.highlightNodes.push(tgtNode);tgtData.edge=TARGET_ON;if(tgtNode.dropZoneID&&tgtNode.dropZoneID!==w.currEnteredDropZoneID){w.currEnteredDropZoneID=tgtNode.dropZoneID;}}var zone=w.dropZonesOnGraph[w.currEnteredDropZoneID],tgtItems=this.getZoneItems(w.currEnteredDropZoneID,w),tgtItemsInGraphZone=this.getZoneItems(w.currEnteredDropZoneID,w,true),zonePos=this.getComponentBBox(w,w.currEnteredDropZoneID),zonePosWithExtra=this.getComponentBBox(w,w.currEnteredDropZoneID,true),x=targetPos.x,y=targetPos.y,mainContainerPos=$DOM.position(w.domMainContainer),widthArray,i,x1,gmZoneModels=getEssentialZoneModels(w),gmCtr,metricSplite,offset;context.tgtData=tgtData;tgtData.zonePos=zonePosWithExtra;tgtData.zoneSource=zone;tgtData.zoneID=w.currEnteredDropZoneID;if(w.currEnteredDropZoneID===CTRL_TYPE.GM_COL_HEADER||w.currEnteredDropZoneID===CTRL_TYPE.GM_ROW_HEADER){x=x-zonePos.left-mainContainerPos.x;y=y-zonePos.top-mainContainerPos.y;dragData.isAttr=true;tgtData.isAttr=true;if(tgtNode){tgtData.tgtIdx=tgtNode.tgtIdx;tgtData.highlightType=WHOLE_ZONE;}else{widthArray=w.currEnteredDropZoneID===CTRL_TYPE.GM_COL_HEADER?w.colHeaderHArr:w.rowHeaderWArr;if(!widthArray||widthArray.length===0){tgtData.tgtIdx=0;tgtData.edge=TARGET_ABOVE;}else{x1=w.currEnteredDropZoneID===CTRL_TYPE.GM_COL_HEADER?y:x;for(i=0;i<widthArray.length;i++){if(i===0){if(widthArray.length>1){if(x1<0.67*widthArray[i]){tgtData.tgtIdx=i;tgtData.edge=TARGET_ABOVE;break;}else{if(x1<widthArray[i]){tgtData.tgtIdx=i;tgtData.edge=TARGET_BELOW;break;}}}else{if(x1<0.5*widthArray[i]){tgtData.tgtIdx=i;tgtData.edge=TARGET_ABOVE;break;}else{if(x1<widthArray[i]){tgtData.tgtIdx=i;tgtData.edge=TARGET_BELOW;break;}}}}else{if(i===widthArray.length-1){if(x1<0.33*widthArray[i]){tgtData.tgtIdx=i;tgtData.edge=TARGET_ABOVE;break;}else{if(w.currEnteredDropZoneID===CTRL_TYPE.GM_COL_HEADER&&x1>0.67*widthArray[i]&&x1<widthArray[i]*1.33){tgtData.tgtIdx=i;tgtData.edge=TARGET_BELOW;break;}else{if(w.currEnteredDropZoneID===CTRL_TYPE.GM_ROW_HEADER&&x1<widthArray[i]){tgtData.tgtIdx=i;tgtData.edge=TARGET_BELOW;break;}}}}else{if(x1<0.33*widthArray[i]){tgtData.tgtIdx=i;tgtData.edge=TARGET_ABOVE;break;}else{if(x1<0.67*widthArray[i]){context.tgtData=null;return ;}}if(x1<widthArray[i]){tgtData.tgtIdx=i;tgtData.edge=TARGET_BELOW;break;}}}x1-=widthArray[i];}if(i>=widthArray.length){context.tgtData=null;return ;}this.handleDropZoneNoChange(context,w);}}}else{var tgtInfo=this.prepare4DropZoneManipulation(x,y,w,zone.direction);if(!tgtInfo.process){context.tgtData=null;return ;}var otherAxis=this.isWhichAxis(w.currEnteredDropZoneID)==="x"?CTRL_TYPE.GM_YAXIS:CTRL_TYPE.GM_XAXIS,otherAxisTgtItems=this.getZoneItems(otherAxis,w,false,true),otherAxisItemCnt=otherAxisTgtItems.length;tgtData.tgtIdx=0;tgtData.tgtInfo=tgtInfo;tgtData.isSideBySide=true;if(gmZoneModels.isAttrCategory(dragItem)){if(tgtItems.length<=0){tgtData.edge=TARGET_MIDDLE;}else{if(gmZoneModels.isMetric(tgtItems[0])){tgtData.edge=TARGET_ON;tgtData.highlightNodes=tgtInfo.labelNodes;tgtData.highlightType=WHOLE_ZONE;tgtData.isAttr=false;tgtData.isReplaceAll=true;}else{if(gmZoneModels.isAttrCategory(tgtItems[0])){tgtData.isAttr=true;if(tgtNode){tgtData.tgtIdx=tgtNode.dzIndex||0;tgtData.highlightType=WHOLE_ZONE;}else{tgtData.edge=TARGET_MIDDLE;tgtData.highlightType=WHOLE_ZONE;tgtData.tgtIdx=tgtItems.length;}}}}dragData.isAttr=true;}else{if(gmZoneModels.isMetric(dragItem)){gmCtr=w.GMController;metricSplite=gmCtr.getSplitPlottingMetrics();tgtData.isSideBySide=metricSplite;if(tgtItems.length<=0){tgtData.edge=TARGET_MIDDLE;}else{if(gmZoneModels.isMetric(tgtItems[0])){tgtData.isAttr=false;if(tgtNode){tgtInfo.axisIndex=tgtNode.axisIndex;tgtData.tgtIdx=this.getMetricIDAndDZIdxFromAxisIdx(w.currEnteredDropZoneID,tgtInfo.axisIndex,this.isAxisPrimary(w.currEnteredDropZoneID),w).dzIndex;tgtData.highlightType=WHOLE_BOX;}else{if((tgtItems.length===1&&otherAxisItemCnt<=1)||(tgtItems.length===2&&tgtItemsInGraphZone.length===1)){if(tgtItemsInGraphZone.length===0){tgtData.isSideBySide=true;tgtData.edge=TARGET_MIDDLE;}else{tgtData.edge=getTargetEdge.call(this,x,y,tgtInfo,zone.direction,false,w);offset=getTargetEdgeRange.call(this,tgtInfo,zone.direction,false,w);this.handleDropZoneNoChange(context,w,offset);tgtData.isSideBySide=tgtData.edge===TARGET_ABOVE||tgtData.edge===TARGET_BELOW;}}else{gmCtr=w.GMController;metricSplite=gmCtr.getSplitPlottingMetrics();var isXAxis=this.isWhichAxis(w.currEnteredDropZoneID)==="x",sameSideHeaderZoneCtrlType=isXAxis?CTRL_TYPE.GM_COL_HEADER:CTRL_TYPE.GM_ROW_HEADER,otherSideHeaderZoneCtrlType=isXAxis?CTRL_TYPE.GM_ROW_HEADER:CTRL_TYPE.GM_COL_HEADER;if(metricSplite){var otherSideHeaderZone=this.getDropZoneModelByCtlType(otherSideHeaderZoneCtrlType,w),metricNameOnOtherSide=false;for(i=0;i<otherSideHeaderZone.items.length;i++){if(gmZoneModels.isMetricName(otherSideHeaderZone.items[i])){metricNameOnOtherSide=true;}}var isScatterChart=otherAxisItemCnt>0&&gmZoneModels.isMetric(otherAxisTgtItems[0]);if(metricNameOnOtherSide&&!isScatterChart){tgtData.isSideBySide=true;tgtData.edge=TARGET_MIDDLE;tgtData.tgtIdx=tgtItems.length;tgtInfo.axisIndex=tgtItems.length;}else{var isPrimary=this.isAxisPrimary(tgtData.zoneID),md=this.getMetricIDAndDZIdxFromAxisIdx(w.currEnteredDropZoneID,tgtInfo.axisIndex,isPrimary,w),metricID=md.metricID,isEmptyCell=metricID===INVALID_METRIC_IDX,dzIndex=md.dzIndex;tgtData.tgtIdx=dzIndex;if(dragData.src===ENUM_SOURCE.VIZ&&!isEmptyCell){tgtData.edge=getTargetEdge.call(this,x,y,tgtInfo,zone.direction,false,w);offset=getTargetEdgeRange.call(this,tgtInfo,zone.direction,false,w);if(!this.handleDropZoneNoChange(context,w,offset)&&tgtData.edge===TARGET_MIDDLE){tgtData.pivotMetricNameTo=gmZoneModels.isMetricZone(this.getDropZoneIdByCtlType(CTRL_TYPE.GM_YAXIS))?CTRL_TYPE.GM_XAXIS:CTRL_TYPE.GM_YAXIS;}}else{tgtData.isSideBySide=true;if(isEmptyCell){tgtData.edge=TARGET_MIDDLE;dzIndex=this.getMetricIDAndDZIdxFromAxisIdx(w.currEnteredDropZoneID,tgtInfo.axisIndex,isPrimary,w,true).prevMetricDZIdx;tgtData.tgtIdx=dzIndex;}else{tgtData.edge=getTargetEdge.call(this,x,y,tgtInfo,zone.direction,true,w);offset=getTargetEdgeRange.call(this,tgtInfo,zone.direction,true,w);this.handleDropZoneNoChange(context,w,offset);}}}}else{if(dragData.src===ENUM_SOURCE.VIZ){tgtData.edge=getTargetEdge.call(this,x,y,tgtInfo,zone.direction,false,w);if(tgtData.edge===TARGET_ABOVE){tgtData.isSideBySide=true;tgtData.tgtIdx=0;tgtData.pivotMetricNameTo=sameSideHeaderZoneCtrlType;}else{if(tgtData.edge===TARGET_BELOW){tgtData.isSideBySide=true;tgtData.tgtIdx=tgtItems.length;tgtData.pivotMetricNameTo=sameSideHeaderZoneCtrlType;}else{if(tgtData.edge===TARGET_MIDDLE){tgtData.isSideBySide=false;tgtData.tgtIdx=parseInt(dragItem.zoneIdx,10);}}}}else{tgtData.isSideBySide=false;tgtData.edge=TARGET_MIDDLE;tgtData.tgtIdx=tgtItems.length;}}}}}else{if(gmZoneModels.isAttrCategory(tgtItems[0])){tgtData.edge=TARGET_ON;tgtData.highlightType=WHOLE_ZONE;tgtData.isAttr=true;tgtData.isReplaceAll=true;}}}dragData.isAttr=false;}}}},ondrop:function ondrop(context,w){var tgtData=context.tgtData,gmZoneModels=w.zonesModel;this.augmentDropContextForSchema(context,gmZoneModels.docModel);if(tgtData&&!tgtData.dropZoneNoChange){var zone=tgtData.zoneSource,idx=tgtData.tgtIdx,edge=tgtData.edge,zoneID=tgtData.zoneID,isPrimary=this.isAxisPrimary(zoneID),isSideBySide=tgtData.isSideBySide,pivotMetricNameTo=this.getDropZoneIdByCtlType(tgtData.pivotMetricNameTo);gmZoneModels.unitsDropped(zone.zoneModel,context,{idx:idx,edge:edge,allowedItems:context.src.data.items},isPrimary,isSideBySide,pivotMetricNameTo);}},allowDrag:function allowDrag(){},getElementFromPoint:function(x,y,w){var target,styles=[],fnHide=function(){var i;for(i=0;i<styles.length;i++){styles[i].display="none";}},fnShow=function(){var i;for(i=0;i<styles.length;i++){styles[i].display="block";}},fnAddToStyles=function(node){if(node&&node.style.display!=="none"){styles.push(node.style);}};fnAddToStyles(w.dndHighlightCanvas);fnAddToStyles(this.domHLBox);fnHide();target=document.elementFromPoint(x,y);fnShow();return target;},getTargetInfo:function getTargetInfo(w,sourcePos,isGetTgtNode){var sourceNode=this.getElementFromPoint(sourcePos.x,sourcePos.y,w),node=sourceNode&&sourceNode.parentNode,type=node.getAttribute("type"),sourceNodeType=sourceNode.getAttribute("type"),dropZone,idx,item,dzid,axisIndex,zoneCtlType,isPrimary,zonesModel=getEssentialZoneModels(w),mainContainerPos=$DOM.position(w.domMainContainer),info={},x=sourcePos.x-mainContainerPos.x,y=sourcePos.y-mainContainerPos.y;if(type===CTRL_TYPE.GM_COL_HEADER||type===CTRL_TYPE.GM_COL_HEADER_TITLE){dropZone=this.getDropZoneModelByCtlType(CTRL_TYPE.GM_COL_HEADER,w);if(type===CTRL_TYPE.GM_COL_HEADER_TITLE){node=node.parentNode.parentNode;}idx=node.getAttribute("depth");item=dropZone&&dropZone.items[idx];if(isGetTgtNode){info.node=sourceNode;info.nodePos=$DOM.position(sourceNode);info.tgtIdx=idx;info.nodeContent=getInnerText(sourceNode);info.dropZoneID=CTRL_TYPE.GM_COL_HEADER;}}else{if(type===CTRL_TYPE.GM_ROW_HEADER||type===CTRL_TYPE.GM_ROW_HEADER_TITLE){dropZone=this.getDropZoneModelByCtlType(CTRL_TYPE.GM_ROW_HEADER,w);if(type===CTRL_TYPE.GM_ROW_HEADER_TITLE){node=node.parentNode.parentNode;}idx=node.getAttribute("depth");item=dropZone&&dropZone.items[idx];if(isGetTgtNode){info.node=sourceNode;info.nodePos=$DOM.position(sourceNode);info.tgtIdx=idx;info.nodeContent=getInnerText(sourceNode);info.dropZoneID=CTRL_TYPE.GM_ROW_HEADER;}}else{if(type===CTRL_TYPE.GM_YLABEL||type===CTRL_TYPE.GM_XLABEL||type===CTRL_TYPE.GM_COL_HEADER_EXTRA){dzid=parseInt(node.getAttribute("dzid"),10);axisIndex=parseInt(node.getAttribute("dzindex"),10);if(!isNaN(dzid)&&!isNaN(axisIndex)){dropZone=this.getZoneModelByZoneId(dzid,w);if(isPointInBox(x,y,this.getComponentBBox(w,CTRL_TYPE.GM_YAXIS))){zoneCtlType=CTRL_TYPE.GM_YAXIS;isPrimary=true;}else{if(isPointInBox(x,y,this.getComponentBBox(w,CTRL_TYPE.GM_XAXIS))){zoneCtlType=CTRL_TYPE.GM_XAXIS;isPrimary=true;}else{if(isPointInBox(x,y,this.getComponentBBox(w,CTRL_TYPE.GM_YAXIS2))){zoneCtlType=CTRL_TYPE.GM_YAXIS2;isPrimary=false;}else{if(isPointInBox(x,y,this.getComponentBBox(w,CTRL_TYPE.GM_XAXIS2))){zoneCtlType=CTRL_TYPE.GM_XAXIS2;isPrimary=false;}}}}if(zoneCtlType){idx=this.getMetricIDAndDZIdxFromAxisIdx(zoneCtlType,axisIndex,isPrimary,w).dzIndex;item=this.getZoneItems(zoneCtlType,w,false,true)[idx];}if(!item){idx=axisIndex;item=dropZone&&dropZone.items[axisIndex];}info.axisIndex=axisIndex;info.dzId=dzid;info.isPrimary=isPrimary;info.sourceNode=sourceNode;info.sourcePos=sourcePos;if(isGetTgtNode){info.node=sourceNode;info.nodePos=$DOM.position(sourceNode);info.nodeContent=getInnerText(sourceNode);info.dropZoneID=zoneCtlType;}}}else{if(sourceNodeType===CTRL_TYPE.GM_AXIS_WORD){var svgNode=$DOM.findAncestorByName(sourceNode,"svg"),svgType=svgNode.getAttribute("type");if(svgType===CTRL_TYPE.GM_SVG_Y_CATEGORY||svgType===CTRL_TYPE.GM_SVG_X_CATEGORY){var identity=node.identity,idIdx=parseInt(sourceNode.getAttribute("Index"),10),identityItem=identity&&identity[idIdx];dzid=identityItem&&identityItem.dzid;axisIndex=identityItem&&identityItem.dzindex;if(dzid!==undefined&&axisIndex!==undefined){dropZone=this.getZoneModelByZoneId(dzid,w);idx=axisIndex;item=dropZone&&dropZone.items[idx];info.dzIndex=idx;}if(isGetTgtNode){if(svgType===CTRL_TYPE.GM_SVG_Y_CATEGORY){info.dropZoneID=CTRL_TYPE.GM_YAXIS;}else{info.dropZoneID=CTRL_TYPE.GM_XAXIS;}var svgNodePos=$DOM.position(svgNode.parentNode),sourceNodePos=$DOM.position(sourceNode),left=parseInt(sourceNode.getAttribute("x"),10),top=parseInt(sourceNode.getAttribute("y"),10),fontSize=sourceNode.parentNode.style.fontSize,labelHeight=parseInt(fontSize,10)||11;info.svgNodePos=svgNodePos;var parentNode=sourceNode.parentNode.cloneNode(true),words=parentNode.childNodes,wordCnt=words.length,wordsHTML="",word,wordIdx,wordIdentityItem,wordAxisIndex,wordsInAttributeCnt=0;for(var i=0;i<wordCnt;i++){word=words[i];wordIdx=parseInt(word.getAttribute("Index"),10);wordIdentityItem=identity&&identity[wordIdx];wordAxisIndex=wordIdentityItem&&wordIdentityItem.dzindex;if(wordAxisIndex===axisIndex){wordsInAttributeCnt++;if(wordsInAttributeCnt===1){left=parseInt(word.getAttribute("x"),10);top=parseInt(word.getAttribute("y"),10);}else{word.style.paddingLeft="5px";info.isMultipleTspan=true;}word.style.fontSize=fontSize;wordsHTML+=getOuterHTML(word);}}info.nodeContent=wordsHTML;info.transform=sourceNode.parentNode.getAttribute("transform");var switchWH=info.transform&&(info.transform.indexOf("rotate(-90")>=0||info.transform.indexOf("rotate(90")>=0||info.transform.indexOf("rotate(270")>=0),nodeH=switchWH?sourceNodePos.w:sourceNodePos.h;info.nodePos={x:svgNodePos.x+left,y:svgNodePos.y+top-(nodeH+labelHeight)/2,w:Math.round(sourceNode.getComputedTextLength()),h:nodeH};}}}}}}if(item&&!isGetTgtNode){item.fromZoneId=dropZone.id;item.zoneIdx=zonesModel.getUnitIndexInZone(dropZone,item);}info.item=item;if(item){return info;}else{return null;}},getDragData:function getDragData(context,w){var id=w.id,sourcePos=context.src.pos,info=this.getTargetInfo(w,sourcePos);if(info){info.setAvatarClass=function setAvatarClass(cls){var list=$MOJO.all[id],avatar=list.avatar;if(avatar){var classes=[list.avatarCssClass,"hasOwnAvatar",cls];avatar.className=classes.join(" ");}};if(info.item){info.items=[];info.items.push(info.item);}info.src=ENUM_SOURCE.VIZ;info.onRemove=function(item){w.deleteItem(item);};}return info;},deleteItem:function deleteItem(item,w){var gmZoneModels=getEssentialZoneModels(w);gmZoneModels.deleteItem(this.getZoneModelByZoneId(item.fromZoneId,w),item.zoneIdx);},getShapeSelectionInfo:function(shapeIdentity){return extractSelectionInfo.call(this,shapeIdentity);}});}());