(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo._Formattable","mstrmojo.VisChartUtils","mstrmojo.array","mstrmojo.date","mstrmojo.VisCalendar");var $P=mstrmojo.date,$A=mstrmojo.array,$D=mstrmojo.dom,_DT=function(){return mstrmojo.locales.datetime;};function getRangeIndexFromDate(d){return d.getFullYear()+"_"+(d.getMonth()+1)+"_"+d.getDate();}function getJsonFromDate(d){return{year:d.getFullYear(),month:d.getMonth()+1,day:d.getDate()};}mstrmojo.VisDateSelection=mstrmojo.declare(mstrmojo.Vis,[mstrmojo._Formattable],{scriptClass:"mstrmojo.VisDateSelection",markupString:'<div id="{@id}" class="mstrmojo-Chart mstrmojo-visDateSelection {@cssClass}" style="{@domNodeCssText}"  mstrAttach:mouseover,mousemove><div></div><div class="mstrmojo-visDateSelection-msg"></div></div>',markupSlots:{calendarNode:function(){return this.domNode.firstChild;},msgNode:function(){return this.domNode.lastChild;}},markupMethods:{onerrMsgChange:function(){var mn=this.msgNode,msg=this.errMsg;mn.style.display=msg?"block":"none";mn.innerHTML=msg||"";}},formatHandlers:{domNode:["z-index","P","B","F","T","D"]},fmts:{},dfm:null,firstDayOfWeek:1,hilightToday:false,selectedColor:"#7FCEFF",update:function(node){if(!this.docModel){this.docModel=this.model.docModel?this.model.docModel:this.model;}this._super(node);},initFromVisProps:function(vp){var VPTP={Color:1,Boolean:2,Integer:3,FontIndex:4},FONTS=["Arial","Arial Black","Comic Sans","Courier","Georgia","Impact","Monaco","Palatino","Tahoma","Times New Roman","Trebuchet MS","Verdana"],cfg={bgColor:{df:"0xFFFFFF",tp:VPTP.Color},borderColor:{df:"0xAFAFAF",tp:VPTP.Color},fDayType:{df:"8",tp:VPTP.FontIndex},fDaySize:{df:"11",tp:VPTP.Integer},fDayColor:{df:"0x000000",tp:VPTP.Color},daybold:{df:"false",tp:VPTP.Boolean},dayitalic:{df:"false",tp:VPTP.Boolean},fHeaderType:{df:"8",tp:VPTP.FontIndex},fHeaderSize:{df:"11",tp:VPTP.Integer},fHeaderColor:{df:"0x000000",tp:VPTP.Color},headerbold:{df:"false",tp:VPTP.Boolean},headeritalic:{df:"false",tp:VPTP.Boolean},fWeekDayType:{df:"8",tp:VPTP.FontIndex},fWeekDaySize:{df:"11",tp:VPTP.Integer},fWeekDayColor:{df:"0x000000",tp:VPTP.Color},weekDaybold:{df:"true",tp:VPTP.Boolean},weekDayitalic:{df:"false",tp:VPTP.Boolean},rollColor:{df:"0x7fceff",tp:VPTP.Color},selctedColor:{df:"0x98d8ff",tp:VPTP.Color,p:"selectedColor"},fDayOfWeek:{df:"1",tp:VPTP.Integer,p:"firstDayOfWeek"},showToday:{df:"false",tp:VPTP.Boolean,p:"hilightToday"},inhSelectorFormat:{df:"false",tp:VPTP.Boolean}},convertValue=function(v,tp){if(tp==VPTP.Boolean){v=(v.toUpperCase()=="TRUE");}else{if(tp==VPTP.Integer){v=parseInt(v);}else{if(tp==VPTP.Color){v="#"+(parseInt(v)+16777216).toString(16).substring(1);}else{if(tp==VPTP.FontIndex){v=FONTS[v];}}}}return v;};for(var n in cfg){var c=cfg[n],v=(vp&&vp[n])||c.df,p=c.p||n;this.set(p,convertValue(v,c.tp));}},_resolveCGBToTKS:function(cgbMap){var sc=this.dfm.sc,cgb=sc&&sc.cgb;for(var i in cgb){var cgbKey=cgb[i],targetKey=cgbMap[cgbKey];if(targetKey){if(!sc.tks){sc.tks=targetKey;}else{if(sc.tks&&(sc.tks.indexOf(targetKey)<0)){sc.tks+="\u001E"+targetKey;}}}}},onCGBMapChange:function(evt){this._resolveCGBToTKS(evt.cgbMap);},postBuildRendering:function(){this.dfm=null;var ts=this.model.gts;if(ts){var tts=(ts.row||[]).concat(ts.col||[]);var i=0,tCnt=0,fCnt=0,len=tts&&tts.length,t=null,r=null;for(;i<len;i++){t=tts[i];if(t.otp!=-1){tCnt++;if(t.es){fCnt++;r=t;}}}this.dfm=(fCnt==1&&tCnt==1)?r:null;}this.set("errMsg",this.model.eg||(this.dfm?"":"The Date Selection widget requires exactly one attribute with a Date form"));if(!this.dfm){return ;}var dm=this.docModel;if(dm){if(dm.getCGBMap){this._resolveCGBToTKS(this.docModel.getCGBMap());}if(dm.attachEventListener){dm.attachEventListener("CGBMapChange",this.id,"onCGBMapChange");}}var fm=this.dfm,es=fm.es,r={},sd=[],sc=fm.sc,ces=sc&&sc.ces,convert=function(rv){return new Date(mstrmojo.VisChartUtils.convertRawValueToMilliseconds(rv));},sz=(es&&es.length)||0,max=(sz&&es[0].rv)?convert(es[0].rv):null,min=max;for(var i=0;i<sz;i++){var d=convert(es[i].rv),jd=getJsonFromDate(d);r[getRangeIndexFromDate(d)]=es[i].id||true;if($P.compareDate(max,jd)<=0){max=jd;}if($P.compareDate(min,jd)>=0){min=jd;}if($A.find(ces,"id",es[i].id)>=0){sd.push(jd);}}r.length=es&&es.length;if(max){r.max=max;}var zf=(this.docModel.getZoomFactor)?this.docModel.getZoomFactor():1,buildStyle=function(fi,fb,fs,ff,fc){return"font:"+(fi?"italic ":"")+(fb?"bold ":"")+(fs*zf)+"px "+ff+";color:"+fc+";";},monthYearStyle=buildStyle(this.headeritalic,this.headerbold,this.fHeaderSize,this.fHeaderType,this.fHeaderColor);mstrmojo.insert({scriptClass:"mstrmojo.VisCalendar",placeholder:this.calendarNode,availableDates:r,isMultiSelect:true,forceNonEmptySelection:!(sc&&sc.all),selectedDates:sd,selectedColor:this.selectedColor,rollColor:this.rollColor,hilightToday:this.hilightToday,firstDayOfWeek:this.firstDayOfWeek+1,min:$P.formatDateInfo(min,_DT().DATEOUTPUTFORMAT),max:$P.formatDateInfo(max,_DT().DATEOUTPUTFORMAT),showCurMonthDatesOnly:true,cssTextHeader:monthYearStyle+"line-height:"+198*0.1414*zf+"px;",cssTextMonthYearLabel:"padding-bottom:"+3*zf+"px;border-bottom-width:"+zf+"px;line-height:"+this.fHeaderSize*zf+"px;background-size:"+zf+"px;",cssTextDay:buildStyle(this.dayitalic,this.daybold,this.fDaySize,this.fDayType,this.fDayColor),cssTextMonth:monthYearStyle,cssTextYear:monthYearStyle,cssTextWeekDay:buildStyle(this.weekDayitalic,this.weekDaybold,this.fWeekDaySize,this.fWeekDayType,this.fWeekDayColor),cssTextBody:"border-top-color:"+this.borderColor+";",cssText:"width:"+198*zf+"px;height:"+198*zf+"px;background-color:"+this.bgColor+";border-color:"+this.borderColor+";",container:this}).render();}});}());