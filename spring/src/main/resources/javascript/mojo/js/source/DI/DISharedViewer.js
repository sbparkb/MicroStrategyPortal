(function(){mstrmojo.requiresCls("mstrmojo.qb.MissingColumnWarning","mstrmojo.DI.DIConstants","mstrmojo.HTMLButton","mstrmojo.Label","mstrmojo.registry","mstrmojo.Editor","mstrmojo.Obj");mstrmojo.requiresDescs(1442,12584,12585,12586,12588,12598,12599,12647,12648,12883,12884);var constants=mstrmojo.DI.DIConstants;mstrmojo.DI.DISharedViewer=mstrmojo.provide("mstrmojo.DI.DISharedViewer",new mstrmojo.Obj({showPreview:true,sourceSelected:false,sourceChanged:false,publishCube:function(model){var m=model;var missings=m.currentSource.getMissingColumns();var p=this;if(missings){var dialog=mstrmojo.insert({scriptClass:"mstrmojo.qb.MissingColumnWarning",mappings:missings,title:m.applicationName(),warning:mstrmojo.desc(12598,"The following previously uploaded columns are missing"),details:mstrmojo.desc(12599,"If you publish without these columns, existing reports, documents and analyses based on this cube might be affected. Do you still want to continue?"),onOK:function(){p.publish(m);return true;}});dialog.open();}else{p.publish(m);}},publish:function(m){var p=this;var callback={success:function(res){m.cubeID=res.objectId;p.pollPublish(m);},failure:function(res){p.publishErrorHandler(res,m);}};var params={taskId:"saveAndPublishCube",msgID:m.msgid};if(m.operationMode===constants.operationMode.create){}else{params.folderID=m.folderID;params.objName=m.cubeName;params.saveAsOverwrite=true;m.showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,m.restructCB(callback),params);}},pollPublish:function(m){var paramsPoll={taskId:"pollStatus",resultSetType:3,pollingFrequency:500,maxWait:60000,taskEnv:"xhr",taskContentType:"json",msgID:m.msgid};var p=this;var cb={success:function(res){if(res.status==="1"){var url=p.getRedirectURL(m.redirect,m.cubeID);mstrmojo.form.send(url,mstrApp.name,"POST",null,null,false);}else{mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,m.restructCB(this),paramsPoll);}},failure:function(res){p.publishErrorHandler(res,m);}};m.showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,m.restructCB(cb),paramsPoll);},publishErrorHandler:function(res,m){var errorCode=res.errorCode;switch(errorCode){case constants.backendError.unexpectedDataType:var message=res.getMessage();var startPos=message.indexOf("#");var endPos=message.indexOf("#",startPos+1);var info=message.substring(startPos,endPos);startPos=info.indexOf("[");endPos=info.indexOf("]",startPos+1);info=info.substring(startPos+1,endPos);var content=[];content=info.split(",");var gridInfo=[];var length=content.length;var i;for(i=0;i<length;i++){var x=content[i].split("=");gridInfo.push(x[1]);}var displayMessage=mstrmojo.desc(12883,"Error converting the data type of the cell in row ## and column $$ with the value @@.").replace("##",gridInfo[0]).replace("$$",gridInfo[1]+1).replace("@@",gridInfo[2]);this.displayError(m.applicationName(),displayMessage,false);break;case constants.backendError.noExternalSession:this.displayError(m.applicationName(),mstrmojo.desc(12585,"The external session has expired."),false);break;case constants.backendError.overwriteObject:this.displayError(m.applicationName(),mstrmojo.desc(12586,"You are trying to overwrite an object which is not allowed"),false);break;case constants.backendError.noPermission:this.displayError(m.applicationName(),mstrmojo.desc(12647,"You do not have the permission to modify this object"),false);break;case constants.backendError.invalidObjectName:this.displayError(m.applicationName(),mstrmojo.desc(12588,"The name of the cube being saved in invalid. Please give a valid name."),false);break;case constants.backendError.incrementalRefresh:this.displayError(m.applicationName(),mstrmojo.desc(12648,"The was an error when trying to update cube contents using incremental refresh."),false);break;default:this.displayError(m.applicationName(),mstrmojo.desc(12884,"Unable to publish the cube: ##").replace("##",res.getResponseHeader("X-MSTR-TaskFailureMsg")),true);return ;}m.loadRptData(constants.requestFlag.mapping);},getRedirectURL:function(redirect,rid){var url={};switch(redirect){case 3:url={evt:"3104",src:mstrApp.name+".3104",executionMode:"1",rwDesignMode:"0",objectType:"3",objectID:rid,rwCreateFlags:"16",rwViewMode:"2048"};break;case 2:url={evt:"3104",src:mstrApp.name+".3104",executionMode:"2",rwDesignMode:"1",objectType:"3",objectID:rid};break;case 1:url={iframe:"true",evt:["5005","17004"],src:[mstrApp.name+".create.5005",mstrApp.name+".create.ObjectExplorer.17004"],selectedObjectID:rid,defaultevtlist:"17004"};break;default:url={evt:"3010"};}return url;},displayError:function(title,errorMessage,isFatal,fn){var d=new mstrmojo.Editor({cssText:"background: white; width:270px;border: 10px solid rgba(0, 0, 0, 0.3); border-radius:5px; -moz-border-radius:5px;-webkit-border-radius:10px;",showTitle:true,zIndex:10,onOpen:function(){var st=this.curtainNode.style;st.background="black";st.opacity=0.5;st.filter="alpha(opacity=50)";},title:title,children:[{scriptClass:"mstrmojo.Label",cssText:"padding:0px 10px 20px 20px; color: blue;",text:errorMessage},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width: 46px; float:right;",text:mstrmojo.desc(1442,"OK"),onclick:function(evt){var e=this.parent;if(e.onOK){e.onOK();}e.close();}}]});d.open();}}));}());