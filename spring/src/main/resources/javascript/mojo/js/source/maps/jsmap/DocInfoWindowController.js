(function(){mstrmojo.requiresCls("mstrmojo.android.controllers.DocumentController","mstrmojo.maps.jsmap.InfoWindow","mstrmojo.maps.jsmap.AndroidMapDoc","mstrmojo.hash","mstrmojo.array","mstrmojo.MobileDocBuilder");var $HASH=mstrmojo.hash;mstrmojo.maps.jsmap.DocInfoWindowController=mstrmojo.declare(mstrmojo.android.controllers.DocumentController,null,{scriptClass:"mstrmojo.maps.jsmap.DocInfoWindowController",initModel:function initModel(){var params=this._startParams,model=this._super(params);var docParams=params.docParams;if(docParams){model.st=docParams.st;model.n=docParams.ttl;}return model;},restart:function start(params){var rootContainer=mstrApp.rootView.rootContainer;rootContainer.render();var model=this.model=this.initModel(),doc=this.doc;$HASH.copy($HASH.copy(params.docParams,{controller:this,model:model,renderMode:"normal",placeholder:rootContainer.domNode}),doc);if(doc.hasRendered){doc.unrender();}doc.removeChildren();doc.render();this.loadLayout(params,true);},start:function start(params){this.model=this.initModel();this.view=this.doc=this.createView(null,params);if(params.model.vp.lyt!==""){this.loadLayout(params);}else{this.loadPanelStack(params);}},createView:function createView(res,params){var doc=new mstrmojo.maps.jsmap.AndroidMapDoc($HASH.copy(params.docParams,{controller:this,model:this.model,renderMode:"normal",placeholder:mstrApp.rootView.rootContainer.domNode}));doc.builder=new mstrmojo.MobileDocBuilder({parent:doc});doc.render();return doc;},loadPanelStack:function loadPanelStack(){var controller=this,docModel=this.model,elemID=docModel.gts.row[0].id,sc=this.sc,action=dataService.getSelectorElementsAction({ck:sc.ck,eid:elemID,ctlKey:sc.ckey,include:sc.include});dataService.submitUpdates(action,{success:function(res){var id=elemID+"_ifw",w=mstrmojo.all[id],psId="*l"+res.currlaykey+"*k"+sc.tks+"*t"+docModel.buildTime;if(w){w.destroy();}controller.doc.builder.newInfoWindow({id:id,parent:controller,builder:controller.builder,model:docModel,psKey:controller.sc.tks,psId:psId}).render();},submission:mstrmojo.emptyFn,complete:mstrmojo.emptyFn},{config:mstrmojo.DocDataService.PROGRESS_CONFIG,params:{onAndroid:true}});},loadLayout:function loadLayout(params,reload){var d=this.model=params.model,doc=this.doc,initialIdx=params.rowIndex,layouts=doc.getLayouts(),lyt=d.vp.lyt,layout=layouts[mstrmojo.array.find(layouts,"k",lyt)];if(reload){layout.defn.loaded=false;}doc.selectLayout(layout,true,{success:function(){var sep="\x1F",dssXmlTypeAttribute="12",attribute=d.gts.row[0],attrID=attribute.id,elemID=attribute.es[initialIdx].id,gbIDs=attrID+sep+dssXmlTypeAttribute+sep+elemID,taskParams={layoutKey:lyt,groupByIDs:gbIDs};doc.getNewLayout(taskParams,doc.getLayouts(),false,{complete:function(){mstrApp.hideMessage();var mapJs=window.mapInfoJSInterface;if(mapJs!==undefined){mapJs.setWaitScreenVisibility(false);}},submisson:function(){mstrApp.showMessage();},success:function(res){doc.gb=res.gb;doc.currentView=doc.replaceView(res,mstrApp.rootView.rootContainer);res.set("visible",true);}},true);}});},update:function update(idx){var doc=this.doc,gb=doc.gb.groupbys[0],key=gb.k,elemID=gb.unit.elms[parseInt(idx,10)+1].v;doc.controller.onGroupBy(this,{groupbyKey:key,elementId:elemID},{complete:function(){var mapJs=window.mapInfoJSInterface;if(mapJs!==undefined){mapJs.setWaitScreenVisibility(false);}}});}});}());