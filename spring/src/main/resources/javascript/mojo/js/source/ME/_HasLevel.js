(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.expr","mstrmojo.Table","mstrmojo.CheckBox","mstrmojo.ME.LevelInputBox","mstrmojo.ME.ConditionInputBox","mstrmojo.ME.TransformInputBox","mstrmojo.ME.MetricDataService","mstrmojo.Button","mstrmojo.Editor","mstrmojo.ME._MetricEditorHelper","mstrmojo.mstr.EnumFunction");mstrmojo.requiresDescs(1107,1281,2148,2397,2399,3324,3377,4788,6223,9577,9579,9581,9582,9583,9584,11564,11565,12178,12179,12853);var E=mstrmojo.expr,ARR=mstrmojo.array,ENUM_F=mstrmojo.mstr.EnumFunction,MEH=mstrmojo.ME._MetricEditorHelper,_brackets=mstrmojo.ME.MetricToken.brackets;var ID,EDITOR;var getReportLevelObject=function(){var n=this.isDME?mstrmojo.desc(12178,"Visualization level"):mstrmojo.desc(1107,"Report Level");return mstrmojo.hash.copy({n:n,did:-1,t:-1,state:0});};var EnumEditorComponents={level:-4,condition:-5,transformation:-6,simple:-7},hasAllComponents=function(t){return !(t===-4||t===-5||t===-6);},hasComponent=function(t,w){return hasAllComponents(t)||parseInt(t,10)===EnumEditorComponents[w];},hasAnyComponent=function(t){return t===-4||t===-5||t===-6||t===-7;};var FillerItem={n:"",did:"-1",desc:""},FILTERINGS={1:"+",2:"*",3:"%",4:""},GROUPINGS={1:"",2:"!",3:"<",4:">",5:"<|",6:">|"},browseObject=function(me,t){var tps,cb,fctxt;switch(t){case"level":tps=[E.TP.ATTR,E.TP.DIM];cb="onLevelAdded";fctxt=16;break;case"transform":tps=[E.TP.ROLE];cb="onTransformAdded";fctxt=26;break;case"condition":tps=[E.TP.FILTER,E.STP.PROMPT_OBJECTS];cb="onConditionAdded";fctxt=10;break;case"expression":tps=[E.TP.FACT,E.TP.ATTR,E.TP.FUNCTION,E.TP.METRIC];cb="onExpressionAdded";fctxt=25;break;default:}tps[tps.length]=E.TP.FOLDER;me.openPopup("ob",{zIndex:me.zIndex+10});var ob=me.ob.browser;ob.browse({folderLinksContextId:fctxt,onSelectCB:[me,cb],browsableTypes:tps.join(","),includeObjectDesc:true});};mstrmojo.ME._HasLevel=mstrmojo.provide("mstrmojo.ME._HasLevel",{_mixinName:"mstrmojo.ME._HasLevel",isAggFunction:false,init:function init(props){if(this._super){this._super(props);}ID=this.id;EDITOR=this;},onOpen:function onOpen(){if(this._super){this._super();}if(!this.isAggFunction){return ;}EDITOR=this;var meDef=this.getLCTDefFromTokens();this.updateToggleBarStatus(meDef);var li=this.metricLCT.levelInput;li.set("candidates",this.getCandidates4LCT([E.TP.ATTR,E.STP.NDE]));li.set("items",meDef.level);var ci=this.metricLCT.conditionInput;if(!this.noCache&&!ci.candidates&&!this.isDME){mstrmojo.ME.MetricDataService.getFilters({pattern:"*",blockBegin:1,blockCount:-1},{success:function(res){if(res){ci.set("candidates",{items:res.items,isComplete:(res.bc===-1||(res.bb+res.bc>res.sz))});}},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}});}else{ci.candidates=this.getCandidates4LCT([E.TP.FILTER,E.STP.PROMPT_OBJECTS]);this.metricLCT.lblCondition.set("visible",meDef.filter.length>0);}ci.set("items",meDef.filter);var ti=this.metricLCT.transformInput;if(!this.noCache&&!ti.candidates&&!this.isDME){mstrmojo.ME.MetricDataService.getTransformations({pattern:"*",blockBegin:1,blockCount:-1},{success:function(res){if(res){ti.set("candidates",{items:res.items,isComplete:(res.bc===-1||(res.bb+res.bc>res.sz))});}},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}});}else{ti.candidates=this.getCandidates4LCT(E.TP.ROLE);this.metricLCT.lblTransform.set("visible",meDef.tranformation.length>0);}ti.set("items",meDef.tranformation);},getLCTDefAsTokens:function getLCTDefAsTokens(){if(!this.isAggFunction){return[];}var levels=this.metricLCT.levelInput.getSelectedObjects(),fltr=this.metricLCT.conditionInput.getSelectedObjects(),trfms=this.metricLCT.transformInput.getSelectedObjects(),tokens=[],token,i,len,parenthesisDimty=function(level,dimty){return level.filtering===1?"("+dimty+")":dimty;};tokens.push({v:"{",isDelimiter:true});var lvl=null;for(i=0,len=levels.length;i<len;i++){lvl=levels[i];tokens.push({v:GROUPINGS[lvl.grouping],isDelimiter:true});if(MEH.isDimty(lvl.n)){tokens.push({v:parenthesisDimty(lvl,lvl.n)});}else{if(/^@/.test(lvl.did)){tokens.push({v:parenthesisDimty(lvl,lvl.did)});}else{if(lvl.did===-1){tokens.push({v:"~",isDelimiter:true});}else{tokens.push({v:_brackets(lvl.n),oi:lvl});}}}tokens.push({v:FILTERINGS[lvl.filtering],isDelimiter:true});if(i<(len-1)){tokens.push({v:", ",isDelimiter:true});}}if(!this.levelFilterRest){tokens.push({v:";",isDelimiter:true});tokens.push({v:"-",isDelimiter:true});}if(!this.levelCanContinue){tokens.push({v:";",isDelimiter:true});tokens.push({v:"/",isDelimiter:true});}tokens.push({v:"}",isDelimiter:true});if(fltr.length>0){tokens.push({v:"<",isDelimiter:true});token={v:_brackets(fltr[0].n)};if(fltr[0].did){token.oi=fltr[0];}tokens.push(token);tokens.push({v:";",isDelimiter:true});tokens.push({v:"@",isDelimiter:true});tokens.push({v:this.conditionEmbedMethod});tokens.push({v:";",isDelimiter:true});tokens.push({v:this.conditionIgnoreFilterElem?"-":"+",isDelimiter:true});tokens.push({v:">",isDelimiter:true});}var idx=ARR.indexOf(trfms,FillerItem);len=idx<0?trfms.length:idx;if(len>0){tokens.push({v:"|",isDelimiter:true});var tr=null;for(i=0;i<len;i++){tr=trfms[i];token={v:_brackets(tr.n)};if(tr.did){token.oi=tr;}tokens.push(token);if(i<(len-1)){tokens.push({v:", ",isDelimiter:true});}}tokens.push({v:"|",isDelimiter:true});}for(i=0,len=tokens.length;i<len;i++){tokens[i].isNew=true;}return tokens;},getLCTDefFromTokens:function getLCTDefFromTokens(){var level=[],hasLevel=false,fltr=[],trfms=[],tokens=this.oi.tks.items,len=tokens.length,i;if(this.insertMode||len===0){level.push(getReportLevelObject.call(this));}else{for(i=0;i<len;i++){var token=tokens[i],tp=token.tp,sctt=token.sctt;switch(sctt){case 262144:hasLevel=true;switch(tp){case 64:case 126:case 264:case 265:case 310:var i0=i,oi;if(tp===64){var dimtyCode=token.v+tokens[++i].v;token=tokens[i+1];if(token.tp===43||token.tp===45){dimtyCode+=tokens[++i].v;dimtyCode+=tokens[++i].v;}else{if(token.tp===41){i++;}}oi=mstrmojo.ME.Enum.DYNAMIC_DIMTY.getDimtyObject(dimtyCode,this.isDME);}else{oi=tp===126?getReportLevelObject.call(this):token.oi;}oi.grouping=1;oi.filtering=4;switch(tokens[i0-1].tp){case 33:oi.grouping=2;break;case 60:oi.grouping=3;break;case 62:oi.grouping=4;break;case 297:oi.grouping=5;break;case 298:oi.grouping=6;break;}switch(tokens[i+1].tp){case 37:oi.filtering=3;break;case 42:oi.filtering=2;break;case 43:oi.filtering=1;break;}level.push(oi);break;case 45:this.levelFilterRest=false;break;case 47:this.levelCanContinue=false;break;}break;case 327680:switch(tp){case 270:case 273:fltr.push(token.oi);break;case 262:this.conditionEmbedMethod=token.v;break;case 43:this.conditionIgnoreFilterElem=false;break;case 45:this.conditionIgnoreFilterElem=true;break;}break;case 393216:switch(tp){case 271:trfms.push(token.oi);break;}break;}}if(level.length===0&&!hasLevel){level.push(getReportLevelObject.call(this));}}return{level:level,filter:fltr,tranformation:trfms};},levelCanContinue:true,levelFilterRest:true,conditionEmbedMethod:2,conditionIgnoreFilterElem:true,_set_candidates:function(n,v){this.candidates=v;if(this.hasRendered){var li=this.metricLCT.levelInput,ci=this.metricLCT.conditionInput,ti=this.metricLCT.transformInput;li.candidates=this.getCandidates4LCT([E.TP.ATTR,E.STP.NDE]);ci.candidates=this.getCandidates4LCT([E.TP.FILTER]);ti.candidates=this.getCandidates4LCT([E.TP.ROLE]);}return true;},getCandidates4LCT:function getCandidates4LCT(ts,showForms){var cs=this.candidates,its;if(cs){ts=ARR.ensureArray(ts);its=ARR.filter(cs.items,function(it){return ARR.indexOf(ts,it.t)>-1||ARR.indexOf(ts,it.st)>-1;});if(ARR.indexOf(ts,12)>-1&&showForms){if(this.replaceAttributeWithForms){its=this.replaceAttributeWithForms(its);}}return{items:its,isComplete:cs.isComplete};}return null;},updateToggleBarStatus:function updateToggleBarStatus(meDef){var showMore=false;if(meDef.level){showMore=meDef.level.length>1||meDef.level.length==1&&meDef.level[0].did!==-1;}if(meDef.filter){showMore=showMore||meDef.filter.length>0;}if(meDef.transformation){showMore=showMore||meDef.transformation.length>0;}if(hasAnyComponent(this.did)){showMore=true;}this.metricLCT.toggle.set("selected",showMore);},levelAdvRef:{scriptClass:"mstrmojo.Editor",title:mstrmojo.desc(9577,"Level Advanced Options"),help:"Level_Advanced_Options_dialog_box.htm",cssClass:"mstrmojo-ME-level-options",onOpen:function(){var o=this.opener;this.contentTable.ccCheckBox.set("checked",o.levelCanContinue);this.contentTable.frCheckBox.set("checked",o.levelFilterRest);},children:[{scriptClass:"mstrmojo.Table",alias:"contentTable",rows:3,cols:1,children:[{scriptClass:"mstrmojo.CheckBox",alias:"ccCheckBox",slot:"0,0",label:mstrmojo.desc(9583,"Allow other users to add extra units to this definition")},{scriptClass:"mstrmojo.CheckBox",alias:"frCheckBox",slot:"1,0",label:mstrmojo.desc(9584,"Include filter attributes which are not in report or level in metric calculation")}]},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",cssText:"float:right;margin: 5px 0px;",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(1442,"OK"),onclick:function(){var e=this.parent.parent;e.saveLevelOptions(e.contentTable.ccCheckBox.checked,e.contentTable.frCheckBox.checked);e.opener.onmetricModify();e.close();}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var e=this.parent.parent;e.close();}}]}]},conditionAdvRef:{scriptClass:"mstrmojo.Editor",title:"Condition Advanced Options",help:"Condition_Advanced_Options_dialog_box.htm",cssText:"width: 286px;",onOpen:function(){var o=this.opener;this.contentTable.emPulldown.set("value",o.conditionEmbedMethod);this.contentTable.irfeCheckBox.set("checked",o.conditionIgnoreFilterElem);},children:[{scriptClass:"mstrmojo.Table",cssText:"margin-top:5px;",alias:"contentTable",rows:3,cols:1,children:[{scriptClass:"mstrmojo.Label",slot:"0,0",text:mstrmojo.desc(9585,"Interaction between metric filter and report filter: ")},{scriptClass:"mstrmojo.Pulldown",alias:"emPulldown",itemField:"n",itemIdField:"did",slot:"1,0",value:2,items:[{n:mstrmojo.desc(9586,"Merge into new"),did:1},{n:mstrmojo.desc(9587,"Merge report filter into metric"),did:2},{n:mstrmojo.desc(9588,"Merge metric condition into report"),did:3}]},{scriptClass:"mstrmojo.CheckBox",alias:"irfeCheckBox",slot:"2,0",label:mstrmojo.desc(9589,"Ignore related report filter elements")}]},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",cssText:"float:right;margin: 5px 0px;",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(1442,"OK"),onclick:function(){var e=this.parent.parent;e.saveConditionOptions(e.contentTable.emPulldown.value,e.contentTable.irfeCheckBox.checked);e.opener.onmetricModify();e.close();}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var e=this.parent.parent;e.close();}}]}]},getLCTComponent:function getLCTComponent(){return{scriptClass:"mstrmojo.Table",cssClass:"mstrmojo-ME-LCT",alias:"metricLCT",layout:[{cells:[{cssClass:"mstrmojo-SME-label mstrmojo-ME-LCT-label"},{}]},{cells:[{cssClass:"mstrmojo-SME-label mstrmojo-ME-LCT-label"},{}]},{cells:[{cssClass:"mstrmojo-SME-label mstrmojo-ME-LCT-label"},{}]},{cells:[{cssClass:"mstrmojo-SME-label mstrmojo-ME-LCT-label"},{cssText:"width:252px;padding-right:6px;"}]}],bindings:{visible:function(){return this.parent.isAggFunction;}},labelWidth:"auto",children:[{scriptClass:"mstrmojo.Button",cssClass:"toggle",alias:"toggle",text:mstrmojo.desc(6223,"Show All"),selected:false,bindings:{visible:function(){return !this.parent.parent.isDME;}},onclick:function(evt){var ex=!this.selected;this.set("selected",ex);},slot:"0,0"},{scriptClass:"mstrmojo.Label",alias:"lblLevel",text:mstrmojo.desc(4788,"Level"),bindings:{visible:function(){return this.parent.parent.isDME||!this.parent.parent.isDME&&this.parent.toggle.selected;},width:"this.parent.labelWidth"},onwidthChange:function(){if(this.hasRendered){this.domNode.style.width=this.width;}},slot:"1,0"},{scriptClass:"mstrmojo.ME.LevelInputBox",emptyText:mstrmojo.desc(12179,"Search for #").replace("#",mstrmojo.desc(2148,"Attribute").toLowerCase()),alias:"levelInput",dtp:-4,xacptSugItemOnly:true,bindings:{noCache:function(){return this.parent.parent.noCache;},isDME:function(){return this.parent.parent.isDME;},visible:function(){return this.parent.lblLevel.visible;}},reportLevelAdded:true,onadd:function(evt){var sos=this.getSelectedObjects();this.set("reportLevelAdded",ARR.find(sos,"did",-1)>-1);},onremove:function(evt){var sos=this.getSelectedObjects();this.set("reportLevelAdded",ARR.find(sos,"did",-1)>-1);},onitemchange:function(){this.parent.parent.onmetricModify();if(EDITOR.updateScrollbars){EDITOR.updateScrollbars();}},onSaveOnClose:function(){this.parent.parent.onmetricModify();},slot:"1,1"},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-ME-link-text right bold",text:mstrmojo.desc(9577,"Level Advanced Options"),bindings:{visible:function(){return !this.parent.parent.isDME&&this.parent.toggle.selected;}},onclick:function(){var me=this.parent.parent;me.openPopup("levelAdvRef",{saveLevelOptions:function(cc,fr){me.levelCanContinue=cc;me.levelFilterRest=fr;},zIndex:me.zIndex+10});},slot:"1,1"},{scriptClass:"mstrmojo.Label",alias:"lblCondition",text:mstrmojo.desc(9579,"Condition"),bindings:{visible:function(){return !this.parent.parent.isDME&&this.parent.toggle.selected;}},slot:"2,0"},{scriptClass:"mstrmojo.ME.ConditionInputBox",cssClass:"mstrmojo-ME-ObjectInputBox-condition singleObject",emptyText:mstrmojo.desc(12179,"Search for #").replace("#",mstrmojo.desc(1281,"Filter").toLowerCase()),alias:"conditionInput",dtp:-4,xacptSugItemOnly:true,bindings:{visible:function(){return this.parent.lblCondition.visible;},isDME:function(){return this.parent.parent.isDME;},noCache:function(){return this.parent.parent.noCache;}},onitemchange:function(){this.parent.parent.onmetricModify();},slot:"2,1"},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-ME-link-text right bold condition",text:mstrmojo.desc(9581,"Condition Advanced Options"),bindings:{visible:function(){return this.parent.lblCondition.visible&&!this.parent.parent.isDME;}},onclick:function(){var me=this.parent.parent;me.openPopup("conditionAdvRef",{saveConditionOptions:function(em,ife){me.conditionEmbedMethod=em;me.conditionIgnoreFilterElem=ife;},zIndex:me.zIndex+10});},slot:"2,1"},{scriptClass:"mstrmojo.Label",alias:"lblTransform",text:mstrmojo.desc(3324,"Transformation"),bindings:{visible:function(){return !this.parent.parent.isDME&&this.parent.toggle.selected;}},slot:"3,0"},{scriptClass:"mstrmojo.ME.TransformInputBox",cssClass:"mstrmojo-ME-ObjectInputBox-transform",emptyText:mstrmojo.desc(12179,"Search for #").replace("#",mstrmojo.desc(3377,"Object").toLowerCase()),alias:"transformInput",dtp:-4,xacptSugItemOnly:true,bindings:{visible:function(){return this.parent.lblTransform.visible;},isDME:function(){return this.parent.parent.isDME;},noCache:function(){return this.parent.parent.noCache;}},onitemchange:function(){this.parent.parent.onmetricModify();if(EDITOR.updateScrollbars){EDITOR.updateScrollbars();}},slot:"3,1"}]};}});mstrmojo.ME._HasLevel.EnumEditorComponents=EnumEditorComponents;}());