(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css","mstrmojo.array","mstrmojo.gm.GMContainer","mstrmojo.gm.GMEnums","mstrmojo.ui.menus.MenuConfig","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.VisUtility","mstrmojo.VisSplitter");var $MOJO=mstrmojo,$DOM=$MOJO.dom,$CSS=$MOJO.css,$ARR=$MOJO.array,$U=$MOJO.VisUtility,$M=Math,CTRL_TYPE=mstrmojo.VisEnum.ControlType,DOCK_POS=mstrmojo.gm.EnumDockPosition,ID_TYPE=mstrmojo.gm.EnumIdentityType;var SPLITTER_BORDER_W=2,DATA_LABEL_CLASS="imageLayout-dataLabel";var CATEGORIES_DATA_EXPLORATION="de",CATEGORIES_LEGEND="lgd",CATEGORIES_ROWS_COLUMNS="rcl",CATEGORIES_SHAPES_AND_DATA_LABELS="dl";function getEventHandler(fn,scopeId,params){return function(evt){fn.call(mstrmojo.all[scopeId],evt,params);};}function getOffsetFromEvent(evt){var offsetX=evt.subWidgetX===undefined?evt.e.offsetX:evt.subWidgetX,offsetY=evt.subWidgetY===undefined?evt.e.offsetY:evt.subWidgetY;return{x:offsetX,y:offsetY};}mstrmojo.HtmlWidgetMatrix=mstrmojo.declare(mstrmojo.gm.GMContainer,[mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.HtmlWidgetMatrix",enableLassoSelect:true,useDropDownBtn:false,minChartHeight:150,minChartWidth:150,markupString:'<div class="{@cssClass}" style="position:absolute; left:{@left}px; top:{@top}px; width:{@width}px; height:{@height}px;"  mstrAttach:mouseover,mouseout,mousedown,mousemove,mouseup,mousewheel,dblclick,keyup><div style="position:absolute; left:0px; bottom:0px; width:100%; height:100%; overflow:hidden"><div class="canvas" style="position:absolute; width:{@canvasW}px; height:{@canvasH}px"></div></div><div id="{@id}-tooltip" style="z-index:2" class="mstrmojo-ImageLayout-tooltip" clk="clk"><table style="margin:5px 7px"></table></div><div id="{@id}-DDButton" class="lasso-selector-dropdown-button"></div><span style="visibility:hidden"></span><canvas id="textCanvas" width="900" height="500" style="z-index:-11;visibility:hidden;-webkit-text-size-adjust: none;"></canvas></div>',markupSlots:{domContainer:function(){return this.domNode.firstChild;},domCanvas:function(){return this.domNode.firstChild.firstChild;},tooltip:function(){return this.domNode.children[1];},ddButtonForNode:function(){return this.domNode.children[2];},domSpan:function(){return this.domNode.children[3];},textCanvas:function(){return this.domNode.lastChild;}},postBuildRendering:function(){var me=this,apiOwner=me.APIOwner;this.initParas();if(this._super){this._super();}this.attachListeners();if(apiOwner){apiOwner.createTooltipTable();}},doUpdateInChartSplitters:function(doRow,doCol){if(!this.useOwnSplitter){return ;}this.calculateBBox();var i,x,y,size,div,splitter,flag,vStyles,hStyles,domCanvas=this.domCanvas,domContainer=this.domContainer,nRows=this.nRows,nCols=this.nCols,hs=this.hSplitters,vs=this.vSplitters,wAccArr=this.wAccArr,hAccArr=this.hAccArr,rowIndex=this.doRowIntersectionCheck(),colIndex=this.doColIntersectionCheck(),rowStart=rowIndex.start,rowEnd=rowIndex.end,colStart=colIndex.start,colEnd=colIndex.end,apiOwner=this.APIOwner,propertyManager=apiOwner.propertyManager,scrollLeft=apiOwner.domHSBar.scrollLeft,scrollTop=apiOwner.domVSBar.scrollTop;if(doRow){flag=this.rowSplitterEnabled;hStyles=propertyManager.getMatrixLineStyles(false);for(i=0;i<nRows;i++){splitter=vs[i];if(i>=rowStart&&i<=rowEnd&&i!==nRows-1&&this.getActiveFlag(i+1,colStart)===true&&flag){y=hAccArr[i];if(splitter===undefined){div=document.createElement("div");splitter=new mstrmojo.VisSplitter({placeholder:div,dir:"h",styles:hStyles,context:{dock:DOCK_POS.BOTTOM,isInChart:true,index:i,isRowIndex:true},type:CTRL_TYPE.GM_H_MATRIX_LINE,parent:this});this.addDisposable(splitter);splitter.render();div=splitter.domNode;domContainer.appendChild(div);vs[i]=splitter;this.addDisposable(splitter.attachEventListener("splitterMoved",this.id,function(evt){this.splitterMoved(evt.position,evt.info);}));}else{splitter.updateStyle(hStyles);}splitter.updatePosition({top:y-scrollTop,left:$M.max(this._x1,0)-scrollLeft,width:($M.min(this._x2,this.canvasW)-$M.max(this._x1,0))});splitter.updateSize({size:hAccArr[i]-(hAccArr[i-1]||0),min:40,max:65535});}else{if(splitter){splitter.hide();}}}}if(doCol){flag=this.colSplitterEnabled;vStyles=propertyManager.getMatrixLineStyles(true);for(i=0;i<nCols;i++){splitter=hs[i];if(i>=colStart&&i<=colEnd&&i!==nCols-1&&this.getActiveFlag(rowStart,i+1)===true&&flag){x=wAccArr[i];if(splitter===undefined){div=document.createElement("div");splitter=new mstrmojo.VisSplitter({placeholder:div,dir:"v",styles:vStyles,context:{dock:DOCK_POS.RIGHT,isInChart:true,index:i,isRowIndex:false},type:CTRL_TYPE.GM_V_MATRIX_LINE,parent:this});this.addDisposable(splitter);splitter.render();div=splitter.domNode;domContainer.appendChild(div);hs[i]=splitter;this.addDisposable(splitter.attachEventListener("splitterMoved",this.id,function(evt){this.splitterMoved(evt.position,evt.info);}));}else{splitter.updateStyle(vStyles);}splitter.updatePosition({left:x-scrollLeft,top:$M.max(this._y1,0)-scrollTop,height:($M.min(this._y2,this.canvasH)-$M.max(this._y1,0))});splitter.updateSize({size:wAccArr[i]-(wAccArr[i-1]||0),min:40,max:65535});}else{if(splitter){splitter.hide();}}}}},getSplitterInfo:function getSplitterInfo(splitter){if(splitter&&splitter.getAttribute("type")===CTRL_TYPE.SPLITTER_BODY){splitter=splitter.parentNode;}return this._super(splitter);},attachListeners:function(){if(this.ddButtonForNode){$DOM.attachEvent(this.ddButtonForNode,"click",getEventHandler(this.ddButtonClickListener,this.id));}},initParas:function(){if(this.APIOwner){this.minChartWidth=this.APIOwner.CONSTANTS.MIN_WIDTH_OR_HEIGHT;this.minChartHeight=this.APIOwner.CONSTANTS.MIN_WIDTH_OR_HEIGHT;}},getMapsAndDraw:function(){var me=this,activeFlags=me.activeFlags,miniCharts=me.APIOwner&&me.APIOwner.miniCharts,miniChart,i,j,rowCharts,chart;for(i in activeFlags){if(activeFlags.hasOwnProperty(i)){rowCharts=activeFlags[i];for(j in rowCharts){if(rowCharts.hasOwnProperty(j)){chart=rowCharts[j];if(chart===true){miniChart=miniCharts&&miniCharts[i]&&miniCharts[i][j];if(miniChart&&miniChart.hasDrawnMap===false){miniChart.getMapAndDraw();}}}}}}},getSubTitleHeight:function(){return this.APIOwner.subTitleHeight;},onkeyup:function onkeyup(evt){if(evt.ctrlKey){console.log("ctrl key up");}},onmouseover:function onmouseover(evt){var me=this,apiOwner=me.APIOwner,miniChart=me.getMiniChartFromTouch(evt),offset=getOffsetFromEvent(evt);if(miniChart){apiOwner.touchedMiniChart=miniChart;me.handleHover(offset.x,offset.y,me.targetIsLasso(evt));}},onmouseout:function onmouseout(evt){var me=this,apiOwner=me.APIOwner,e=evt.e;apiOwner.touchedMiniChart=null;apiOwner.hideTooltip();},onmousedown:function onmousedown(evt){var e=evt.e;},onmousemove:function onmousemove(evt){var me=this,apiOwner=me.APIOwner,miniChart=me.getMiniChartFromTouch(evt),offset=getOffsetFromEvent(evt);if(miniChart){apiOwner.touchedMiniChart=miniChart;me.handleHover(offset.x,offset.y,me.targetIsLasso(evt));}},onmouseup:function onmouseup(evt){var e=evt.e;},onmousewheel:function onmousewheel(evt){var manager=this.manager,e=evt.e,constDelta=30,delta=Math.max(-1,Math.min(1,e.wheelDelta)),originY=this.origin.y;},ondblclick:function ondblclick(evt){var e=evt.e;console.log("double click");this.APIOwner.refresh();},targetIsLasso:function(evt){var target=evt&&evt.getTarget(),lasso=this.lassoSelector;if(target&&lasso&&target===lasso){return true;}return false;},handleHover:function handleHover(touchX,touchY,targetIsLasso){var me=this,apiOwner=me.APIOwner,touchedMiniChart=apiOwner.touchedMiniChart,nearestObj=touchedMiniChart&&touchedMiniChart.getAreaOrNearestBubble(false,touchX,touchY),topPoint;if(!nearestObj){apiOwner.hideTooltip();}else{if(!apiOwner.currHoverObj||nearestObj.touchVal!==apiOwner.currHoverObj.touchVal){apiOwner.currHoverObj=nearestObj;apiOwner.currHoverObjMiniChart=touchedMiniChart;apiOwner.highlightMiniCharts();}else{touchedMiniChart.renderTooltip(nearestObj.touchVal,nearestObj.point.x,nearestObj.point.y,nearestObj.hdrIndex);}}if(this.useDropDownBtn){if(touchedMiniChart&&apiOwner.currHoverObj&&apiOwner.defaultSelectedObjs&&apiOwner.defaultSelectedObjs.hasOwnProperty(apiOwner.currHoverObj.lineIndex)){this.showDDButton(targetIsLasso);}else{this.hideDDButton(targetIsLasso);}}},showDDButton:function(targetIsLasso){function showDDButtonForLasso(){var ddButton=this.dropDownBtn;if(ddButton){ddButton.style.visibility="visible";}}function showDDButtonForNode(){var ddButton=this.ddButtonForNode,apiOwner=this.APIOwner,touchedMiniChart=apiOwner.touchedMiniChart,topPoint;if(ddButton){ddButton.style.visibility="visible";topPoint=touchedMiniChart.getTopPoint(apiOwner.currHoverObj);this.positionDDButton(ddButton,touchedMiniChart.domNode,topPoint.x,topPoint.y);}}if(this.isLassoSelectorActive()){if(!targetIsLasso){showDDButtonForLasso.call(this);}}else{showDDButtonForNode.call(this);}},hideDDButton:function(targetIsLasso){function hideDDButtonForLasso(){var ddButton=this.dropDownBtn;if(ddButton){ddButton.style.visibility="hidden";}}function hideDDButtonForNode(){var ddButton=this.ddButtonForNode,menuDom;if(ddButton){ddButton.style.visibility="hidden";if(ddButton.childNodes.length!==0){menuDom=ddButton.childNodes[0];menuDom.style.visibility="hidden";}}}if(this.isLassoSelectorActive()){if(!targetIsLasso){hideDDButtonForLasso.call(this);}}else{hideDDButtonForNode.call(this);}},positionDDButton:function(ddButtonDom,miniChartDom,offsetX,offsetY){if(!ddButtonDom||!miniChartDom||offsetX===undefined||offsetY===undefined){return ;}var offset=$DOM.delta(miniChartDom,this.domNode),left=offset.x+offsetX,top=offset.y+offsetY;ddButtonDom.style.left=left+"px";ddButtonDom.style.top=top+"px";},handleSingleClick:function handleSingleClick(evt){var me=this,apiOwner=me.APIOwner,touchedMiniChart=me.getMiniChartFromTouch(evt),defaultSelectedObjs=apiOwner.defaultSelectedObjs,e=evt.e,ctrlKey=e.ctrlKey,offset=getOffsetFromEvent(evt),touchedObj=touchedMiniChart&&touchedMiniChart.getTouchedObj(true,offset.x,offset.y),isRMC=evt.name==="contextmenu",isTargetLasso=me.targetIsLasso(evt);apiOwner.touchedMiniChart=touchedMiniChart;apiOwner.clearRMCTargets();if(!isTargetLasso){this.dismissLassoSelector();}function hasClickOnNode(obj){return obj&&obj.hdrIndex>=0;}function hasClickOnSelectedPoint(obj){var lineIndex=obj&&obj.lineIndex;if(defaultSelectedObjs&&defaultSelectedObjs.hasOwnProperty(lineIndex)){return true;}return false;}function addNode(){defaultSelectedObjs[touchedObj.lineIndex]={touchVal:touchedObj.touchVal,hdrIndex:touchedObj.hdrIndex};apiOwner.highlightMiniCharts();apiOwner.doSelection();}function deleteNode(){if(defaultSelectedObjs.hasOwnProperty(touchedObj.lineIndex)){delete defaultSelectedObjs[touchedObj.lineIndex];}apiOwner.highlightMiniCharts();apiOwner.doSelection();}function clearNode(){defaultSelectedObjs={};apiOwner.defaultSelectedObjs=defaultSelectedObjs;apiOwner.highlightMiniCharts();apiOwner.doSelection();}function keepOnlyNode(){defaultSelectedObjs={};apiOwner.defaultSelectedObjs=defaultSelectedObjs;defaultSelectedObjs[touchedObj.lineIndex]={touchVal:touchedObj.touchVal,hdrIndex:touchedObj.hdrIndex};apiOwner.highlightMiniCharts();apiOwner.doSelection();}function noResponse(){}var asSelectorAndCannotClearAll=apiOwner.useAsSelector()&&!apiOwner.canClearAll();if(ctrlKey){if(!hasClickOnNode(touchedObj)){noResponse();}else{if(hasClickOnSelectedPoint(touchedObj)){if(!isRMC){deleteNode();}}else{addNode();}}}else{if(!ctrlKey){if(!hasClickOnNode(touchedObj)){if(asSelectorAndCannotClearAll||isTargetLasso){noResponse();}else{clearNode();}}else{if(hasClickOnSelectedPoint(touchedObj)){if(!isRMC){if(apiOwner.hasMultipleSelected()){keepOnlyNode();}else{if(apiOwner.hasSingleSelected()){if(asSelectorAndCannotClearAll){noResponse();}else{deleteNode();}}}}}else{keepOnlyNode();}}}}},getWidgetXY:function getWidgetXY(e){var imageLayoutTableNode=this.domNode,subPosition=$DOM.position(e.target),imageLayoutTablePosition=imageLayoutTableNode?$DOM.position(imageLayoutTableNode):{x:0,y:0},widgetXY={widgetX:0,widgetY:0};if(subPosition&&imageLayoutTablePosition){widgetXY.widgetX=e.offsetX+(subPosition.x-imageLayoutTablePosition.x);widgetXY.widgetY=e.offsetY+(subPosition.y-imageLayoutTablePosition.y);}return widgetXY;},getSampleMiniChart:function gsmc(){return(this.activeCharts&&this.activeCharts.length>0)?this.activeCharts[0]:null;},getMiniChartFromTouch:function(evt){var me=this,target=evt&&evt.getTarget(),newTarget,miniChart=null,row,col;function findMiniChartFromTarget(target){var miniChart,miniChartObj,miniChartDom;miniChartObj=$DOM.findAncestorByAttr(target,"row",true,me.APIOwner.domNode);if(miniChartObj){miniChartDom=miniChartObj.node;row=miniChartDom.getAttribute("row");col=miniChartDom.getAttribute("col");miniChart=me.APIOwner.getMiniChart(row,col);}return miniChart;}function showDom(dom){if(dom){dom.style.display="block";}}function hideDom(dom){if(dom){dom.style.display="none";}}function repositionEventAndFindMiniChart(dom){var newTarget,newTargetPosition,subWidgetXY,miniChart;hideDom(dom);newTarget=document.elementFromPoint(evt.e.pageX,evt.e.pageY);newTargetPosition=$DOM.position(newTarget);subWidgetXY=newTargetPosition?{x:evt.e.pageX-newTargetPosition.x,y:evt.e.pageY-newTargetPosition.y}:{x:0,y:0};evt.subWidgetX=subWidgetXY.x;evt.subWidgetY=subWidgetXY.y;miniChart=findMiniChartFromTarget(newTarget);showDom(dom);return miniChart;}function getMiniChartFromDataLabel(target){var dataLabel=$DOM.findAncestorByAttr(target,"isDataLabel",true,me.domNode),dataLabelDiv,miniChart;if(dataLabel){dataLabelDiv=dataLabel.node;miniChart=repositionEventAndFindMiniChart(dataLabelDiv);}return miniChart;}if(!target){miniChart=null;}else{if(target===this.lassoSelector){hideDom(target);newTarget=document.elementFromPoint(evt.e.pageX,evt.e.pageY);if(newTarget.tagName.toLowerCase()==="div"){miniChart=getMiniChartFromDataLabel(newTarget);}else{if(newTarget.tagName.toLowerCase()==="canvas"){miniChart=repositionEventAndFindMiniChart(target);}}showDom(target);}else{if(target.tagName.toLowerCase()==="div"){miniChart=getMiniChartFromDataLabel(target);}else{if(target.tagName.toLowerCase()==="canvas"){miniChart=findMiniChartFromTarget(target);}}}}return miniChart;},ddButtonClickListener:function(evt){var hasSelection=true,hasLinkdrill=true,menuConfig,ddButton=this.ddButtonForNode,menu=ddButton.childNodes&&ddButton.childNodes.length>0&&ddButton.childNodes[0];if(menu){menu.style.visibility="visible";}else{if(hasSelection){menuConfig=this.getSelectionMenuConfig();this.showMenu(menuConfig,evt.target);}else{if(hasLinkdrill){menuConfig=this.getLinkdrillMenuConfig();this.showMenu(menuConfig,evt.target);}}}},intersectionCheckOnChart:function(selected,i,j,x1,x2,y1,y2){var miniChart=this.APIOwner.getMiniChart(i,j);if(miniChart){miniChart.getLassoElements(selected,i,j,x1,x2,y1,y2);}},lassoSelecting:function(info){},lassoSelected:function(info){if(this._super){this._super(info);}var apiOwner=this.APIOwner,defaultSelectedObjs=apiOwner.defaultSelectedObjs,selObjsInfo;if(info.ctrlKey){this.addLassoSelectedObjs(info.selectedShapes,defaultSelectedObjs);}else{defaultSelectedObjs={};apiOwner.defaultSelectedObjs=defaultSelectedObjs;this.addLassoSelectedObjs(info.selectedShapes,defaultSelectedObjs);}apiOwner.highlightMiniCharts();if(apiOwner.isOwnEmpty(apiOwner.defaultSelectedObjs)){$CSS.removeClass(this.lassoSelector,["lasso-selector-hasContent"]);}else{$CSS.addClass(this.lassoSelector,["lasso-selector-hasContent"]);}if(apiOwner.useAsSelector()){this.dismissLassoSelector();}apiOwner.doSelection();},addLassoSelectedObjs:function(srcObjs,dstObjs){var lineIndex,hdrIndex,touchVal,elem,srcObj;for(elem in srcObjs){if(srcObjs.hasOwnProperty(elem)){srcObj=srcObjs[elem];lineIndex=srcObj.lineIndex;hdrIndex=srcObj.hdrIndex;touchVal=srcObj.touchVal;if(!dstObjs.hasOwnProperty(lineIndex)){dstObjs[lineIndex]={touchVal:touchVal,hdrIndex:hdrIndex};}}}},configurePopup:function(config,itemBtn){config.hostId=this.id;config.hostElement=itemBtn;},showMenu:function(menuCfg,el){this.configurePopup(menuCfg,el);this.openPopup(menuCfg.newInstance());},getDataLabelMenuConfig:function(){var dataLabelCfg=this.addDisposable(new mstrmojo.ui.menus.MenuConfig()),apiOwner=this.APIOwner;dataLabelCfg.addPopupMenuItem(mstrmojo.desc(11993,"Data Labels"),apiOwner.id,apiOwner.getDataLabelShowSubMenu,"xt");return dataLabelCfg;},getSelectionMenuConfig:function(){var filterCfg=this.addDisposable(new mstrmojo.ui.menus.MenuConfig()),showDataCfg=this.addDisposable(new mstrmojo.ui.menus.MenuConfig()),dataLabelCfg=this.addDisposable(new mstrmojo.ui.menus.MenuConfig()),colorByThresholdCfg=this.addDisposable(new mstrmojo.ui.menus.MenuConfig()),apiOwner=this.APIOwner;filterCfg.addMenuItem(mstrmojo.desc(11701,"Keep only"),"xt",apiOwner.getMenuHandler("selectionKeepOnly"));filterCfg.addMenuItem(mstrmojo.desc(3946,"Exclude"),"xt",apiOwner.getMenuHandler("selectionExclude"));showDataCfg.addMenuItem(mstrmojo.desc(13537,"Show Data..."),"xt",apiOwner.getMenuHandler("selectionShowData"));dataLabelCfg.addPopupMenuItem(mstrmojo.desc(11993,"Data Labels"),apiOwner.id,apiOwner.getDataLabelShowSubMenu,"xt");var cfg={filter:filterCfg,showData:showDataCfg,dataLabel:dataLabelCfg},menuOrder=[{name:"filter"},{name:"showData"},{name:"dataLabel"}];if(apiOwner.hasColorByThs()){var metricsInColorByDropZone=$U.getMetricsInDropZone(apiOwner.zonesModel,mstrmojo.vi.viz.EnumDSSDropZones.ColorBy);colorByThresholdCfg.addMenuItem(mstrmojo.desc(13174,"Select color ranges..."),"",function(){apiOwner.model.openThresholdEditor(metricsInColorByDropZone[0],true,false);});cfg.threshold=colorByThresholdCfg;menuOrder.push({name:"threshold"});}return $U.mergeMenuConfigs(cfg,menuOrder);},getLinkdrillMenuConfig:function(){var cfg=this.addDisposable(new mstrmojo.ui.menus.MenuConfig());cfg.addMenuItem("Hypelink 1","xt",function(){});cfg.addMenuItem("Hypelink 2","xt",function(){});cfg.addMenuItem("Hypelink 3","xt",function(){});return cfg;},lassoButtonClicked:function(evt){var menuConfig=this.getSelectionMenuConfig();this.showMenu(menuConfig,evt.target);},unrender:function(ignoreDom){var me=this;if(this._super){this._super(ignoreDom);}if(this.ddButtonForNode){$DOM.attachEvent(this.ddButtonForNode,"click",getEventHandler(this.ddButtonClickListener,this.id));}}});}());