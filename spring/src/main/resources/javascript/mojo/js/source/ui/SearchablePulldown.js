(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.css","mstrmojo.hash","mstrmojo._HasEditableText","mstrmojo.ui.Pulldown");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,ARROW_WIDTH=19,KEY_ENTER=13,KEY_ESC=27;mstrmojo.ui.SearchablePulldown=mstrmojo.declare(mstrmojo.ui.Pulldown,[mstrmojo._HasEditableText],{scriptClass:"mstrmojo.ui.SearchablePulldown",editableSlot:"selectedNode",allowCustomText:false,isSearching:false,editOnClick:false,init:function init(props){this._super(props);var popupList=this.getPopupList();popupList.renderOnScroll=this.renderOnScroll||popupList.renderOnScroll;popupList.renderBlockSize=this.renderBlockSize||popupList.renderBlockSize;mstrmojo.css.addWidgetCssClass(this,"mstrmojo-ui-SearchablePulldown");var prt=popupList.constructor.prototype,getItemProps=popupList.getItemProps?popupList.getItemProps:prt.getItemProps,getItemMarkup=popupList.getItemMarkup?popupList.getItemMarkup:prt.getItemMarkup;popupList.getItemProps=function(item,idx){var input=this._spft||"",itemName=item.n,index=itemName.toUpperCase().indexOf(input);if(index===-1){input="";}var props=getItemProps.call(this,item,idx);props.before=itemName.slice(0,index);props.input=itemName.substring(index,index+input.length);props.after=itemName.slice(index+input.length,itemName.length);return props;};popupList.getItemMarkup=function(item,idx){return getItemMarkup.call(this,item,idx).replace("{@en@n}","{@en@before}<span class='sp-highlight'>{@en@input}</span>{@en@after}");};},onclick:function onclick(evt){var selectedNode=this.selectedNode,target=evt.getTarget(),isArrow=evt.e.offsetX>=(selectedNode.offsetWidth-ARROW_WIDTH),popupWidget=this.getPopupWidget(),isPopupWidgetVisible=popupWidget.visible;if(target===selectedNode&&(!isPopupWidgetVisible||(isPopupWidgetVisible&&isArrow))){this.set("isEditing",!isPopupWidgetVisible);this._super(evt);}},onPopupWidgetClosed:function onPopupWidgetClosed(){this.set("isEditing",false);var pulldownList=this.getPopupList(),oldItems=pulldownList._oldItems,textValue=this.text;delete pulldownList._oldItems;if(oldItems){var selIdx=$ARR.find(oldItems,"n",textValue);if(selIdx===-1&&!this.allowCustomText){var fallbackItem=pulldownList.items[0]||oldItems[0];selIdx=$ARR.find(oldItems,"n",fallbackItem.n);}pulldownList.set("items",oldItems);this.set("selectedIndex",selIdx);}},_set_selectedIndex:function onselectedIndexChange(n,v){if(this.allowCustomText&&v===-1){this.selectedIndex=-1;this.onitemSelected(null,v);}else{this.isSearching=false;this._super(n,v);if(this.hasRendered){var selNode=this.selectedNode;this.text=selNode.innerText?selNode.innerText:selNode.textContent;}}return true;},onkeydown:function onkeydown(event){this._super(event);var evt=window.event||event.e;if(evt.keyCode===KEY_ENTER){this.getPopupList().close();}},onkeyup:function onkeyup(event){this._super(event);var evt=window.event||event.e,keyCode=evt.keyCode,pulldownList=this.getPopupList();if(keyCode===KEY_ESC||keyCode===KEY_ENTER){pulldownList.close();}else{this.processSearch();}},processSearch:function processSearch(){this.isSearching=true;this.hideTooltip();var result=[],pulldownList=this.getPopupList(),searchValue=this.selectedNode.innerHTML,oldItems=pulldownList._oldItems||pulldownList.items,input=searchValue.toUpperCase();input=input.replace(/<BR>/,"");if(input.length>0){$ARR.forEach(oldItems,function(item){if(item.n.toUpperCase().indexOf(input)>-1){result.push($HASH.clone(item));}},this);}else{result=oldItems;}pulldownList._spft=input;if(this.customizeSearchResult){this.customizeSearchResult(result);}pulldownList.set("items",result);pulldownList.adjustCornersForPopupOverflow();delete pulldownList._spft;pulldownList._oldItems=oldItems;pulldownList.set("visible",result.length!==0);}});}());