(function(){mstrmojo.requiresCls("mstrmojo.dom");var $DOM=mstrmojo.dom;var TEXTMARGIN=5;var D_S_P=1;var D_E_P=2;var D_O_P=4;var T_Z_A=0;var needAdjust=true;var ZoomFactor=0;var millisOnDay=86400000;mstrmojo.VisChartUtils=mstrmojo.provide("mstrmojo.VisChartUtils",{getScreenZoomFactor:function getScrnZmFctr(){if(ZoomFactor==0){if(mstrMobileApp){var dpi=mstrMobileApp.getDeviceDPI();console.log("dpi:"+dpi);ZoomFactor=dpi/160;}else{ZoomFactor=1;}}return ZoomFactor;},changeElementSize:function chngfntsz(el,prop,zf){if(prop=="fontSize"||prop=="height"||prop=="line-height"){var propValue=mstrmojo.css.getStyleValue(el,prop);var intSize=Math.round(zf*parseInt(propValue));el.style[prop]=intSize+"px";}else{if(prop=="font"){var fontSize=mstrmojo.css.getStyleValue(el,"fontSize");var intSize=Math.round(zf*parseInt(fontSize));var fontWeight=mstrmojo.css.getStyleValue(el,"fontWeight");var fontFamily=mstrmojo.css.getStyleValue(el,"fontFamily");el.style.font=fontWeight+" "+intSize+"px "+fontFamily;}}},rgbaStr2rgba:function C_rgbaStr2rgba(color){var rgba=null;color=color.replace(/ /g,"");var i=color.indexOf("rgba");if(i>=0){color=color.substring(i+5,color.length-1);rgba=color.split(",");}return rgba;},fillBackground:function fllBckgrnd(widget,width,height,context,opacity){var cntx=context||widget.context,wd=width||widget.canvas.width,ht=height||widget.canvas.height,themeColor=widget.themeColor||"#000000",gradient=null,opc=opacity||1;if(!cntx){cntx=widget.canvas.getContext("2d");if(!cntx){return ;}}cntx.save();if(widget.noBackground){}else{if(!widget.isAndroid&&!widget.isTimeSeries){gradient=cntx.createLinearGradient(0,0,0,ht/2);cntx.fillStyle=themeColor;cntx.fillRect(0,0,wd,ht);cntx.globalAlpha=0.4;gradient.addColorStop(0,"#fff");gradient.addColorStop(0.1,"#fff");gradient.addColorStop(1,themeColor);cntx.fillStyle=gradient;cntx.rect(0,0,wd,ht/2);cntx.fill();cntx.globalAlpha=0.1;cntx.fillStyle="#fff";cntx.fillRect(0,0,wd,ht/2);}else{if(widget.isTimeSeries){var formatProp=widget.formatProp;gradient=cntx.createLinearGradient(0,0,0,ht);cntx.globalAlpha=formatProp.backgroundAlpha;cntx.fillStyle=this.rgb2rgbStr(formatProp.backgroundClr)||"#000000";cntx.rect(0,0,wd,ht);cntx.fill();}else{cntx.globalAlpha=opc;cntx.fillStyle=themeColor;cntx.fillRect(0,0,wd,ht);}}}cntx.restore();},rgb2rgbStr:function rgb2rgbStr(rgb,opc){var result="";if(!rgb||rgb.length!=3){return result;}if(opc||opc==0){result="rgba("+rgb[0]+","+rgb[1]+","+rgb[2]+","+opc+")";}else{result="rgb("+rgb[0]+","+rgb[1]+","+rgb[2]+")";}return result;},getRGBWithOpacity:function getRGBWithOpacity(rgb,opacity,rgb2){if(isNaN(opacity)){return ;}if(!rgb2){rgb2=[255,255,255];}var resultRGB=[];for(color in rgb){resultRGB[color]=parseInt(rgb[color]*(1-opacity)+rgb2[color]*opacity);}return resultRGB;},fillMasterChartBackground:function fillMasterChartBackground(widget,topX,topY,width,height,bottomY,context){var cntx=context||widget.context,wd=width||widget.canvas.width,ht=height||widget.canvas.height,themeColor=widget.themeColor,gradient=null;var formatProp=widget.formatProp;cntx.save();cntx.globalAlpha=formatProp.backgroundAlpha;cntx.fillStyle=this.rgb2rgbStr(formatProp.backgroundClr)||"#000000";cntx.fillRect(0,0,wd,topY+height+bottomY);cntx.globalAlpha=1;cntx.strokeStyle=this.rgb2rgbStr(widget.formatProp.textClr,0.5);cntx.lineWidth=1;var lineY=topY+0.5;this.drawLineSet(this,[{x:topX,y:lineY},{x:topX+wd,y:lineY}],false,cntx);lineY=topY+ht-0.5;this.drawLineSet(this,[{x:topX,y:lineY},{x:topX+wd,y:lineY}],false,cntx);cntx.restore();},drawLineSetWithSplit:function(widget,lines,fill,context,split){var n=lines.length,np=Math.ceil(n/split),start,end;for(var i=0;i<np;i++){start=i*split;end=Math.min(start+split+1,n);this.drawLineSet(widget,lines.slice(start,end),fill,context);}},drawLineSet:function drwlnst(widget,lines,fill,context){var cntx=null,l=lines.length,li=null;if(context){cntx=context;}else{cntx=widget.context;}var lastPoint=null,moveToPoint=false;cntx.beginPath();var i=0;while(i<l){if(lines[i]){cntx.moveTo(lines[i].x,lines[i].y);lastPoint=lines[i];moveToPoint=true;i++;break;}i++;}var skip=false;for(;i<l;i++){li=lines[i];if(li){if(!skip){cntx.lineTo(li.x,li.y);moveToPoint=false;}else{cntx.moveTo(li.x,li.y);moveToPoint=true;lastPoint=li;skip=false;}}else{if(!skip){skip=true;if(moveToPoint){cntx.arc(lastPoint.x,lastPoint.y,1,0,Math.PI*2,false);}}}}if(fill){cntx.closePath();cntx.fill();}else{cntx.stroke();}},getMinYPosition:function getMinYPosition(lines,start,end){var i=start,min;while(i<=end){if(lines[i]){min=lines[i].y;break;}i++;}for(i=start;i<=end;i++){if(lines[i]){min=Math.min(min,lines[i].y);}}return min;},drawLineAreaWithSplit:function(widget,lines,start,end,bottomY,rgbClr,context,split){var n=end-start+1,np=Math.ceil(n/split),p1,p2;for(var i=0;i<np;i++){p1=start+i*split;p2=Math.min(p1+split,start+n-1);this.drawLineArea(widget,lines,p1,p2,bottomY,rgbClr,context);}},drawLineArea:function drwlnst(widget,lines,start,end,bottomY,rgbClr,context){var cntx=null,l=lines.length,li=null,startBottomX=0,endBottomX=0;if(context){cntx=context;}else{cntx=widget.context;}var lastPoint=null,moveToPoint=false;cntx.save();cntx.lineWidth=0;cntx.beginPath();var i=start,startIndex;while(i<=end){if(lines[i]){startBottomX=lines[i].x;cntx.moveTo(startBottomX,bottomY);lastPoint=lines[i];moveToPoint=true;break;}i++;}startIndex=i;var skip=false;for(;i<=end;i++){li=lines[i];if(li){if(!skip){cntx.lineTo(li.x,li.y);moveToPoint=false;endBottomX=li.x;}else{startBottomX=li.x;cntx.moveTo(startBottomX,bottomY);if(i+1<=end&&lines[i+1]){cntx.lineTo(li.x,li.y);}lastPoint=li;skip=false;startIndex=i;}}else{if(!skip){skip=true;if(!moveToPoint){cntx.lineTo(endBottomX,bottomY);cntx.lineTo(startBottomX,bottomY);var MinY=this.getMinYPosition(lines,startIndex,i)||0;cntx.fillStyle=this.rgb2rgbStr(rgbClr,1);cntx.globalAlpha=0.65;cntx.fill();}}}}if(!moveToPoint){cntx.lineTo(endBottomX,bottomY);cntx.lineTo(startBottomX,bottomY);var MinY=this.getMinYPosition(lines,startIndex,end)||0;cntx.closePath();cntx.fillStyle=this.rgb2rgbStr(rgbClr,1);cntx.globalAlpha=0.65;cntx.fill();}cntx.restore();},drawRectangle:function drwRect(widget,x,y,w,h,fill,context){var cntx=null;if(context){cntx=context;}else{cntx=widget.context;}if(fill){cntx.fillRect(x,y,w,h);}else{cntx.strokeRect(x,y,w,h);}},drawArc:function drwArc(widget,x,y,radius,startAngle,endAngle,anticlockwise,fill,context){var cntx=null;if(context){cntx=context;}else{cntx=widget.context;}cntx.beginPath();cntx.arc(x,y,radius,startAngle,endAngle,anticlockwise);if(fill){cntx.fill();}else{cntx.stroke();}},drawRoundRect:function drawRoundRect(ctx,x,y,w,h,r,fill){r=Math.min(w/2,h/2,r);ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();if(fill){ctx.fill();}else{ctx.stroke();}},drawHalfRoundedRectangle:function drwHRRect(widget,x,y,w,h,r,fill,context){var cntx=null;if(context){cntx=context;}else{cntx=widget.context;}cntx.beginPath();cntx.moveTo(x+w,y);cntx.lineTo(x+r,y);cntx.arcTo(x,y,x,y+r,r);cntx.lineTo(x,y+h-r);cntx.arcTo(x,y+h,x+r,y+h,r);cntx.lineTo(x+w,y+h);if(fill){cntx.fill();}else{cntx.stroke();}},drawStartEndPoints:function dsep(widget,lines,context,dp){var l=lines.length;var cntx=null,r=widget.startEndPointRadius;if(context){cntx=context;}else{cntx=widget.context;}cntx.save();var spc="#f0f43e",epc="#f0f43e",opc="#663300";if(widget.startPointColor){spc=widget.startPointColor;}if(widget.endPointColor){epc=widget.endPointColor;}else{var s=lines[0].y,h=lines[l-1].y;if(s>h){epc="#008000";}else{if(s<h){epc="#8d1616";}else{epc=spc;}}}if(widget.otherPointColor){opc=widget.otherPointColor;}if(dp&D_S_P&&lines[0]){cntx.strokeStyle=spc;cntx.fillStyle=spc;this.drawArc(this,lines[0].x,lines[0].y,r,0,Math.PI*2,true,true,cntx);}if(dp&D_E_P&&lines[l-1]){cntx.strokeStyle=epc;cntx.fillStyle=epc;this.drawArc(this,lines[l-1].x,lines[l-1].y,r,0,Math.PI*2,true,true,cntx);}if(dp&D_O_P){cntx.strokeStyle=opc;cntx.fillStyle=opc;for(var i=1;i<l-1;i++){if(lines[i]){this.drawArc(this,lines[i].x,lines[i].y,r,0,Math.PI*2,true,true,cntx);}}}cntx.restore();},getColor:function gtclr(w){return(parseInt(w.themeColor.substr(1),16)>8388607)?"#000000":"#ffffff";},drawHighlightLine:function drwHghlghtln(w,y){var ctx=w.context,margin=w.margin,x1=margin.l,x2=w.isTimeSeries?w.chartWidth+margin.l:w.getWidth()-margin.r;ctx.save();ctx.globalAlpha=1;ctx.strokeStyle=this.rgb2rgbStr(w.formatProp.textClr,0.35);ctx.lineWidth=1;ctx.lineCap="round";while(x1<x2){ctx.beginPath();ctx.moveTo(x1,y);x1+=2;ctx.lineTo(x1,y);ctx.stroke();x1+=3;}ctx.restore();},addLabel:function adDtLbl(w,text,x,y,width,rotate,prevLabel){var lbl=document.createElement("div");lbl.className="mstrmojo-Chart-lbl";lbl.style.color=this.rgb2rgbStr(w.formatProp.textClr,0.8);lbl.innerHTML=text;if(width){lbl.style.width=width+"px";}var node=null;var aWidth=0;if(w.isTimeSeries){if(prevLabel.w>=0){node=w.xdiv;aWidth=w.animationCanvas.width;}else{node=w.domNode.getElementsByClassName("mstrmojo-chart-ylbl-div")[0];if(!node){node=document.createElement("div");node.id="mstrmojo-chart-ylbl-div";node.className="mstrmojo-chart-ylbl-div";w.domNode.appendChild(node);}node.style.width=w.margin.l-1+"px";}}else{node=w.domNode;aWidth=w.getWidth();}node.appendChild(lbl);var lblTextWidth=lbl.offsetWidth||(w.getTextWidth&&w.getTextWidthByElem(text,lbl));var ht=lbl.offsetHeight||22*(ZoomFactor||1);var wd=width||lblTextWidth||100;var X_PAD=w.xLabelPadding/2;var Y_PAD=w.yLabelPadding/2;if(prevLabel.w>=0&&w.isTimeSeries&&w._scroller.origin){var distanceOffOrgin=x-w._scroller.origin.x;if(distanceOffOrgin<=0&&(distanceOffOrgin+lblTextWidth/2>-w.maxYLblWidth)){w.needRedrawVerticalLine=true;node.removeChild(lbl);return null;}var distanceOffLegend=distanceOffOrgin-w.getChartWidthOnScreen();if((distanceOffLegend-lblTextWidth/2)<=0&&distanceOffLegend>=0){w.needRedrawVerticalLine=true;node.removeChild(lbl);return null;}}if(prevLabel.w>=0){x=x-wd/2;}if(prevLabel.h>=0&&((y>=prevLabel.y-Y_PAD&&y<=prevLabel.y+prevLabel.h)||(y+ht>=prevLabel.y-Y_PAD&&y+ht<=prevLabel.y+prevLabel.h)||(y+ht>=w.canvas.height-w.margin.b))){node.removeChild(lbl);return null;}if(prevLabel.w>=0&&(((x>=prevLabel.x&&x<prevLabel.x+prevLabel.w+X_PAD))||x<prevLabel.x||x<w.margin.l||x+wd>aWidth)){node.removeChild(lbl);return null;}if(w.isTimeSeries&&prevLabel.h>=0){node.style.top=(w.margin.t-ht/2)+"px";node.style.height=(w.canvas.height-w.margin.t-w.margin.b-1+ht/2)+"px";this.translateCSS(x,(y-w.margin.t)+ht/2,rotate,lbl);}else{this.translateCSS(x,y,rotate,lbl);lbl.style.maxHeight=ht+"px";}prevLabel.x=x;prevLabel.y=y;if(prevLabel.h>=0){prevLabel.h=ht;}if(prevLabel.w>=0){prevLabel.w=wd;lbl.style.textAlign="center";}return lbl;},addDataLabel:function adDtLbl(w,text,y,prevLabel){var xText=(w.margin.l>w.margin.r)?TEXTMARGIN:w.getWidth()-w.margin.r+TEXTMARGIN,spaceAvailable=(w.margin.l>w.margin.r)?w.margin.l:w.margin.r;return this.addLabel(w,text,xText,y-10,spaceAvailable-TEXTMARGIN*2,false,prevLabel);},translateCSS:function trnlt(x,y,rotate,lbl){var value="translate("+x+"px,"+y+"px)";if(rotate){value+=" rotate(45deg)";}lbl.style[$DOM.CSS3_TRANSFORM]=value;},getTouchXYOnWidget:function getTouchXYOnWidget(touchX,touchY,widget){var TouchScroller=mstrmojo.TouchScroller,scrollerOffsets=(TouchScroller&&widget.parent&&TouchScroller.getScrollPositionTotals(widget.parent))||{x:0,y:0};touchX=touchX-widget.offsetLeft+scrollerOffsets.x;touchY=touchY-widget.offsetTop+scrollerOffsets.y;return{touchX:touchX,touchY:touchY};},getYValue:function gyval(widget,point){var height=widget.canvas.height,margin=widget.margin,mvalues=widget.model.mvalues;return height-margin.b-4-((parseFloat(point)-mvalues[0])*widget.RTY);},getMasterYValue:function getMasterYValue(widget,point,mm){var height=widget.masterCanvas.height,mvalues=widget.model.mvalues;return height-mm.b-3-((parseFloat(point)-mvalues[0])*widget.MRTY);},getSeriesIndexAndYValue:function gsiyv(w,rowIdx,touchY){var s=w.model.series,l=s.length,si=0;y=this.getYValue(w,s[si].rv[rowIdx])||0;var cp=touchY-y<0?-(touchY-y):touchY-y,pp=cp;for(var i=1;i<l;i++){var cy=this.getYValue(w,s[i].rv[rowIdx])||0;cp=touchY-cy<0?-(touchY-cy):touchY-cy;if(cp<pp){y=cy;pp=cp;si=i;}}return{y:y,si:si};},getLabelWidthForMargin:function tsip(w,text){var lbl=document.createElement("div");lbl.className="mstrmojo-Chart-lbl";lbl.innerHTML=text;w.domNode.appendChild(lbl);var wd=lbl.offsetWidth||60;w.domNode.removeChild(lbl);return wd+TEXTMARGIN*2;},animateLineSet:function anmtHLnSt(w,fromLines,toLines,cfg){var lines=[],x=w.animationContext,l=toLines.length;x.clearRect(0,0,w.getWidth(),w.canvas.height);if(!cfg.index){cfg.index=0;}else{if(cfg.index>=cfg.rate){this.drawLineSet(w,toLines,false,x);w.drawLabels();if(w.isFillLinesArea){this.fillLinesArea(w,toLines.slice(0));}if(w.isDrawStartEndPoints){this.drawStartEndPoints(w,toLines,x,w.isDrawStartEndPoints);}return ;}}for(var i=0;i<l;i++){var tli=toLines[i],fli=fromLines[i];lines[i]={x:(cfg.index*(tli.x-fli.x)/cfg.rate)+fli.x,y:(cfg.index*(tli.y-fli.y)/cfg.rate)+fli.y};}this.drawLineSet(w,lines,false,x);var me=this;cfg.index++;window.setTimeout(function(){me.animateLineSet(w,fromLines,toLines,cfg);},40);},fillLinesArea:function flA(w,area){var hgt=w.canvas.height;area.push({x:w.getWidth()-w.margin.r,y:hgt-w.margin.b});area.push({x:w.margin.l,y:hgt-w.margin.b});var fillColor=new Array();if(w.fillinColor){mstrmojo.requiresCls("mstrmojo.color");var g=mstrmojo.color.hex2rgb(w.fillinColor).join(",");fillColor[0]="rgba("+g+", 0.8)";fillColor[1]="rgba("+g+", 0.2)";}else{fillColor=["rgba(255,128,0,0.8)","rgba(255,128,0,0.2)"];}var ctx=w.animationContext;var g=ctx.createLinearGradient(0,0,0,hgt);g.addColorStop(0,fillColor[0]);g.addColorStop(0.75,fillColor[1]);ctx.fillStyle=g;this.drawLineSet(w,area,true,ctx);},convertRawValueToMilliseconds:function convertRawValueToMilliseconds(val){var daysSinceJan1st1899_12_30=Number(val),realVal=daysSinceJan1st1899_12_30-((Date.UTC(1970,1,1)-Date.UTC(1899,12,30))/millisOnDay)-T_Z_A,dt=new Date(realVal*millisOnDay);return new Date(dt.getUTCFullYear(),dt.getUTCMonth(),dt.getUTCDate()).getTime();},getAncestorBgColor:function getAncestorBgColor(widget){var bgColor=null,me=widget,modelData=me.modelData?me.modelData:me.model,docModel=null;if(me.hasOwnProperty("xtabModel")&&me.xtabModel.hasOwnProperty("docModel")){docModel=me.xtabModel.docModel;}if(docModel&&docModel.defn&&docModel.defn.layouts&&docModel.defn.layouts.length>0){var layouts=docModel.defn.layouts,layout;var i;for(i in layouts){if(layouts[i].loaded){layout=layouts[i];}}if(layout&&layout.hasOwnProperty("units")){var units=layout.units;var parent=modelData.parent;while(parent){var pk=parent.k||null;if(units[pk]&&units[pk].fmts&&units[pk].fmts["background-color"]){bgColor=units[pk].fmts["background-color"];break;}else{parent=parent.parent||null;}}if(!bgColor){if(layout.fmts&&layout.fmts["background-color"]){bgColor=layout.fmts["background-color"];}}}}return bgColor;},isLightColor:function isLightColor(color){var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,i,r,g,b,brightness,isLight=false;if(color){var colorNew,tempColor;if(/^(rgba|RGBA)/.test(color)){tempColor=color.replace(/rgba\(|RGBA\(/,"");tempColor=tempColor.replace(")","");colorNew=tempColor.split(",");r=colorNew[0];g=colorNew[1];b=colorNew[2];}else{if(/^(rgb|RGB)/.test(color)){tempColor=color.replace(/rgb\(|RGB\(/,"");tempColor=tempColor.replace(")","");colorNew=tempColor.split(",");r=colorNew[0];g=colorNew[1];b=colorNew[2];}else{if(reg.test(color)){if(color.length===4){colorNew="#";for(i=1;i<4;i++){colorNew+=color.slice(i,i+1).concat(color.slice(i,i+1));}color=colorNew;}var colorChange=[];for(i=1;i<7;i+=2){colorChange.push(parseInt("0x"+color.slice(i,i+2)));}r=colorChange[0];g=colorChange[1];b=colorChange[2];}}}brightness=(r*299+g*587+b*114)/1000;if(brightness>150){isLight=true;}}return isLight;},getPointDistanceSquare:function getPointDistSquare(p1,p2){return(p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y);},truncateTextToLine:function(elem,span,lineCount){span.className=elem.className;span.style.whiteSpace="nowrap";var str=span.innerHTML=elem.innerHTML;var paddingWidth=parseInt(elem.offsetWidth)-parseInt(elem.style.width);var maxWidth=lineCount*parseInt(elem.style.width)+paddingWidth;var res=str;if(span.offsetWidth>maxWidth){var low=0,high=str.length-1;while(low<=high){var mid=Math.round((low+high)/2);var s0=str.substr(0,mid+1);var s1=str.substr(0,mid+2);span.innerHTML=s0;var h0=span.offsetWidth;span.innerHTML=s1;var h1=span.offsetWidth;if(h0<=maxWidth&&h1>maxWidth){break;}else{if(h0>maxWidth){high=mid-1;}else{if(h1<=maxWidth){low=mid+1;}}}}res=str.substr(0,mid+1);if(res.length<str.length){if(res.charAt(res.length-1)===" "){res=res.substr(0,res.length-1);}var pos=res.lastIndexOf(" ");var left=res.length-1-pos;if(left>=2&&left<=8){res=res.substr(0,res.length-left-1)+"...";}else{res=res.substr(0,res.length-3)+"...";}}}elem.innerHTML=res;},getLen:function(text,span,errorAdjust,paddingWidth){span.innerHTML=text;var wiLen=span.offsetWidth+errorAdjust-paddingWidth;return wiLen;},splitWordIfTooLong:function(wlst,span,availSp,paddingWidth,errorAdjust){var wordsArr=wlst.split(" ");var res=[];var sz=wordsArr.length;var i=0;var j=0;for(i=0;i<sz;i++){var wd=wordsArr[i];while(true){var wiLen=this.getLen(wd,span,errorAdjust,paddingWidth);if(wiLen>availSp){var clipL=(availSp/wiLen)*wd.length;var intClip=Math.round(clipL);while(intClip>0){var tpWd=wd.substr(0,intClip);var len1=this.getLen(tpWd,span,errorAdjust,paddingWidth);if(len1<=availSp){res.push(tpWd);break;}else{intClip--;}}wd=wd.substr(intClip,wd.length-intClip);}else{res.push(wd);break;}}}return res.join(" ");},truncateTextToLineWithWordWrap:function(elem,span,lineCount){span.className=elem.className;span.style.whiteSpace="nowrap";var errorAdjust=7;var availSp=-1;if(elem.style&&elem.style.width&&elem.style.width.length>0){availSp=parseFloat(elem.style.width);}if(availSp<0){availSp=parseFloat(mstrmojo.css.getComputedStyle(elem).width);}var str=elem.innerHTML;var paddingWidth=parseFloat(elem.offsetWidth)-availSp;str=this.splitWordIfTooLong(str,span,availSp,paddingWidth,errorAdjust);var wordsArr=str.split(" ");var lenArr=[];var preLenArr=[];var i=0;var totalLen=0;var sz=wordsArr.length;span.innerHTML="&nbsp;";var blankSpaceLen=span.offsetWidth-paddingWidth;preLenArr.push(0);for(i=0;i<sz;i++){var wiLen=this.getLen(wordsArr[i],span,errorAdjust,paddingWidth);if(wiLen>availSp){var wd=wordsArr[i];var clipL=(availSp/wiLen)*wd.length;wordsArr[i]=wd.substr(0,parseInt(clipL));wiLen=availSp;}lenArr.push(wiLen);totalLen+=wiLen;preLenArr.push(totalLen);if(i!==sz-1){totalLen+=blankSpaceLen;}}var lnS=0,lnE=0;var ln=lineCount;for(;lnE<preLenArr.length;){var len1=preLenArr[lnE]-preLenArr[lnS];if(lnS>0&&lnE!=lnS){len1-=blankSpaceLen;}var len2=preLenArr[lnE+1]-preLenArr[lnS];if(lnS>0&&lnE+1!=lnS){len2-=blankSpaceLen;}if(len1<=availSp&&((lnE+1==preLenArr.length)||(len2>availSp))){ln--;if(ln==0||lnE===sz){break;}else{lnS=lnE;lnE++;}}else{lnE++;}}if(lnE>sz){lnE=sz;}var lastlineLen=preLenArr[lnE]-preLenArr[lnS];if(lnS>0&&lnE!=lnS){lastlineLen-=blankSpaceLen;}var res;if(lnE>=sz&&lastlineLen<availSp){res=wordsArr.join(" ");}else{res=wordsArr.slice(0,lnE).join(" ");var elipLen=this.getLen("...",span,errorAdjust,paddingWidth);if(lastlineLen+elipLen<=availSp){res+="...";}else{if(res.charAt(res.length-1)===" "){res=res.substr(0,res.length-1);}var pos=res.lastIndexOf(" ");var left=res.length-1-pos;if(left===3){res=res.substr(0,res.length-3)+" ...";}else{res=res.substr(0,res.length-3)+"...";}}}elem.innerHTML=res;},getLen2:function(text,fontStr,txtCvs){var canvas=txtCvs;var context=canvas.getContext("2d");context.font=fontStr;context.textAlign="center";context.fillStyle="blue";var metrics=context.measureText(text);var width=metrics.width;return width;},splitWordIfTooLong2:function(wlst,availSp,fontStyle,txtCvs){var wordsArr=wlst.split(" ");var res=[];var sz=wordsArr.length;var i=0;var j=0;for(i=0;i<sz;i++){var wd=wordsArr[i];while(true){var wiLen=this.getLen2(wd,fontStyle,txtCvs);if(wiLen>availSp){var clipL=(availSp/wiLen)*wd.length;var intClip=Math.max(Math.round(clipL),1);while(intClip>0){var tpWd=wd.substr(0,intClip);var len1=this.getLen2(tpWd,fontStyle,txtCvs);if(len1<=availSp||intClip==1){res.push(tpWd);break;}else{intClip--;}}wd=wd.substr(intClip,wd.length-intClip);}else{res.push(wd);break;}}}return res.join(" ");},getComputedFontStyle:function getCFontStyle(computedStyle){var fontStyle=computedStyle.fontStyle+" "+computedStyle.fontWeight+" "+computedStyle.fontSize+"/"+computedStyle.fontVariant+" "+computedStyle.fontFamily;return fontStyle;},truncateTextToLineWithWordWrap2:function(elem,str,txtCvs,lineCount){var availSp=-1;if(elem.style&&elem.style.width&&elem.style.width.length>0){var paddingWidth=0;var compStyle=mstrmojo.css.getComputedStyle(elem);if(compStyle.paddingLeft){paddingWidth+=parseFloat(compStyle.paddingLeft);}if(compStyle.paddingRight){paddingWidth+=parseFloat(compStyle.paddingRight);}var elemWidth=elem.offsetWidth;availSp=elemWidth?elemWidth-paddingWidth:parseInt(elem.style.width);}if(availSp<0){elem.innerHTML="...";return ;}var computedStyle=mstrmojo.css.getComputedStyle(elem);var fontStyle=this.getComputedFontStyle(computedStyle);str=this.splitWordIfTooLong2(str,availSp,fontStyle,txtCvs);var wordsArr=str.split(" ");var lenArr=[];var preLenArr=[];var i=0;var totalLen=0;var sz=wordsArr.length;var blankSpaceLen=this.getLen2(" ",fontStyle,txtCvs);preLenArr.push(0);for(i=0;i<sz;i++){var wiLen=this.getLen2(wordsArr[i],fontStyle,txtCvs);if(wiLen>availSp){var wd=wordsArr[i];var clipL=(availSp/wiLen)*wd.length;wordsArr[i]=wd.substr(0,parseInt(clipL));wiLen=availSp;}lenArr.push(wiLen);totalLen+=wiLen;preLenArr.push(totalLen);if(i!==sz-1){totalLen+=blankSpaceLen;}}var lnS=0,lnE=0;var ln=lineCount;for(;lnE<preLenArr.length;){var len1=preLenArr[lnE]-preLenArr[lnS];if(lnS>0&&lnE!=lnS){len1-=blankSpaceLen;}var len2=preLenArr[lnE+1]-preLenArr[lnS];if(lnS>0&&lnE+1!=lnS){len2-=blankSpaceLen;}if(len1<=availSp&&((lnE+1==preLenArr.length)||(len2>availSp))){ln--;if(ln==0||lnE===sz){break;}else{lnS=lnE;lnE++;}}else{lnE++;}}if(lnE>sz){lnE=sz;}var lastlineLen=preLenArr[lnE]-preLenArr[lnS];if(lnS>0&&lnE!=lnS){lastlineLen-=blankSpaceLen;}var res;if(lnE>=sz&&lastlineLen<availSp){res=wordsArr.join(" ");}else{res=wordsArr.slice(0,lnE).join(" ");var elipLen=this.getLen2("...",fontStyle,txtCvs);if(lastlineLen+elipLen<=availSp){res+="...";}else{if(res.charAt(res.length-1)===" "){res=res.substr(0,res.length-1);}var pos=res.lastIndexOf(" ");var left=res.length-1-pos;if(left===3){res=res.substr(0,res.length-3)+" ...";}else{res=res.substr(0,res.length-3)+"...";}}}elem.innerHTML=res;return res.indexOf("...")>-1;},truncateDivContent:function(str,span,comp){span.innerHTML=str;if(span.offsetHeight>comp){var low=0,high=str.length-1;while(low<=high){var mid=Math.round((low+high)/2);var s0=str.substr(0,mid+1);var s1=str.substr(0,mid+2);span.innerHTML=s0;var h0=span.offsetHeight;span.innerHTML=s1;var h1=span.offsetHeight;if(h0<=comp&&h1>comp){break;}else{if(h0>comp){high=mid-1;}else{if(h1<=comp){low=mid+1;}}}}var res=str.substr(0,mid+1);if(res.length<str.length){if(res.charAt(res.length-1)===" "){res=res.substr(0,res.length-1);}var pos=res.lastIndexOf(" ");var left=res.length-1-pos;if(left>=2&&left<=8){res=res.substr(0,res.length-left-1)+"...";}else{res=res.substr(0,res.length-3)+"...";}}return res;}else{return str;}},positionTooltip:function(tooltipDom,anchorPoint,boundaryDom,offset){if(!tooltipDom||!anchorPoint||!boundaryDom){return ;}if(isNaN(offset)){offset=45;}var pWidth=boundaryDom.offsetWidth,pHeight=boundaryDom.offsetHeight,tWidth=tooltipDom.offsetWidth,tHeight=tooltipDom.offsetHeight,tDomStyle=tooltipDom.style,tempLeft=0,tempTop=0;function putL(){return tWidth+offset<anchorPoint.x&&tHeight<pHeight;}function putT(){return tHeight+offset<anchorPoint.y&&tWidth<pWidth;}function putR(){return anchorPoint.x+offset+tWidth<pWidth&&tHeight<pHeight;}function putB(){return anchorPoint.y+offset+tHeight<pHeight&&tWidth<pWidth;}function putMX(){return anchorPoint.x>tWidth/2&&(pWidth-anchorPoint.x)>tWidth/2;}function putMY(){return anchorPoint.y>tHeight/2&&(pHeight-anchorPoint.y)>tHeight/2;}function putTL(){return putT()&&putL();}function putTM(){return putT()&&putMX();}function putTR(){return putT()&&putR();}function putLM(){return putL()&&putMY();}function putBL(){return putB()&&putL();}function putRM(){return putR()&&putMY();}function putBM(){return putB()&&putMX();}function putBR(){return putB()&&putR();}if(putTL()){tempLeft=anchorPoint.x-offset-tWidth;tempTop=anchorPoint.y-offset-tHeight;}else{if(putTM()){tempLeft=anchorPoint.x-tWidth/2;tempTop=anchorPoint.y-offset-tHeight;}else{if(putTR()){tempLeft=anchorPoint.x+offset;tempTop=anchorPoint.y-offset-tHeight;}else{if(putLM()){tempLeft=anchorPoint.x-offset-tWidth;tempTop=anchorPoint.y-tHeight/2;}else{if(putBL()){tempLeft=anchorPoint.x-offset-tWidth;tempTop=anchorPoint.y+offset;}else{if(putRM()){tempLeft=anchorPoint.x+offset;tempTop=anchorPoint.y-tHeight/2;}else{if(putBM()){tempLeft=anchorPoint.x-tWidth/2;tempTop=anchorPoint.y+offset;}else{if(putBR()){tempLeft=anchorPoint.x+offset;tempTop=anchorPoint.y+offset;}}}}}}}}tDomStyle.left=tempLeft+"px";tDomStyle.top=tempTop+"px";}});})();