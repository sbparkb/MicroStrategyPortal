(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.Editor","mstrmojo.Box","mstrmojo.ValidationTextBox","mstrmojo.ME.AttributeEditBox","mstrmojo.ME.MetricEditBox","mstrmojo.ME.MetricToken","mstrmojo.ME.DynamicLinkEditBox","mstrmojo.mstr.EnumDSSXMLTokenStates");mstrmojo.requiresDescs(2399,2400,3993,4547,11569,11617,14720,14722);var $DESC=mstrmojo.desc,$BTN=mstrmojo.Button.newWebButton,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$BKTS=mstrmojo.ME.MetricToken.brackets,preprocessTokenStream=mstrmojo.ME.AttributeEditBox.preprocessTokenStream,getTokenStreamXML=mstrmojo.ME.AttributeEditBox.getTokenStreamXML,validateSyntax=mstrmojo.ME.AttributeEditBox.validateSyntax,V_STATUS=mstrmojo.ME.MetricEditBox.VALIDATION_STATUS,preProcessBackendTks=mstrmojo.ME.DynamicLinkEditBox.preProcessBackendTks,convertBackendTksToDisplayTks=mstrmojo.ME.DynamicLinkEditBox.convertBackendTksToDisplayTks,addDoubleQuotationMark=mstrmojo.ME.DynamicLinkEditBox.addDoubleQuotationMark,preprocessDisplayTokens=mstrmojo.ME.DynamicLinkEditBox.preprocessDisplayTokens,constructBackendToken=mstrmojo.ME.DynamicLinkEditBox.constructBackendToken,DSS_TOKEN_STATE=mstrmojo.mstr.EnumDSSXMLTokenStates;function _wait(btn,v){btn.set("enabled",!v);btn.set("iconClass",btn.iconClass.replace(/mstrmojo-InlineWaitIcon/,"")+" "+(v?"mstrmojo-InlineWaitIcon":""));}function _setupCandidatesCache(cds,tib){if(cds&&tib){tib.candidates=null;tib.set("candidates",cds);}}function _focusOnNameInputBox(me){if(me.oi&&me.oi.alias){return ;}me.tmr=window.setInterval(function(){if(me.visible&&me.domNode){window.clearInterval(me.tmr);delete me.tmr;me.nameEditBox.nameInput.inputNode.select();}},50);}function _newEmptyForm(nn){return{n:nn,k:nn,ftk:[],vs:1,is:""};}mstrmojo.ME.DynamicLinkEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.ME.DynamicLinkEditor",cssClass:"mstrmojo-DAEditor mstrmojo-DLEditor",zIndex:10,help:"creating_a_grid_visualization_html5.htm#dynamic-link",useKeyDelay:true,noCache:false,name:"New Link",attrid:null,forms:null,defaultIDToken:undefined,editingNode:undefined,init:function init(props){if(this._super){this._super(props);}},postBuildRendering:function postBuildRendering(){this._super();this.hrefInput.inputBox.attachEventListener("tokenInputBoxSelected",this.id,"ontokenInputBoxSelected");this.linkTextInput.inputBox.attachEventListener("tokenInputBoxSelected",this.id,"ontokenInputBoxSelected");},onObjectInsert:function onObjectInsert(oi){this.editingNode=this.editingNode||this.hrefInput;this.editingNode.onObjectInsert(oi);},onOpen:function onOpen(){var me=this;var oi=this.oi;var n=oi.alias||oi.n||"New Link";_setupCandidatesCache(me.attrCandidates,me.linkTextInput.inputBox);_setupCandidatesCache(me.attrCandidates,me.hrefInput.inputBox);this.linkTextInput.inputBox.noCache=this.hrefInput.inputBox.noCache=this.noCache;this.linkTextInput.inputBox.useKeyDelay=this.hrefInput.inputBox.useKeyDelay=this.useKeyDelay;this.set("name",n);this.set("nameLabel",mstrmojo.desc(14722,"Link Name"));if(oi&&oi.forms){this.set("attrid",oi.did);this.forms=oi.forms;$ARR.forEach(this.forms,function(fm){preprocessTokenStream({items:fm.ftk});});this.updateInputBoxesItems();}else{var refOi=this.parent.action.refOi;var refOiIDForm=refOi&&refOi.fs&&refOi.fs[0];this.defaultIDToken=refOiIDForm?{extp:8,exv:refOiIDForm.fid,ift:true,isNew:true,oi:refOi,v:$BKTS(refOi.n)+"@"+$BKTS(refOiIDForm.fnm),isRawStr:false}:null;var defaultDisplayTk=$HASH.clone(this.defaultIDToken);var linkTextDisplayTokens=[{isDelimiter:true,isNew:true,v:"{"},defaultDisplayTk,{isDelimiter:true,isNew:true,v:"}"}],hrefDisplayTokens=[{v:"http://",isDelimiter:false,isNew:true,sta:1,ift:undefined}];this.linkTextInput.updateInputBoxItems({items:linkTextDisplayTokens});this.hrefInput.updateInputBoxItems({items:hrefDisplayTokens});this.set("forms",[_newEmptyForm("ID"),_newEmptyForm("DYNAMICLINK")]);}this.linkTextInput.set("cValid",true);this.hrefInput.set("cValid",true);_focusOnNameInputBox(this);},onClose:function onClose(){if(this._super){this._super();}this.clear();},onformsChange:function(){var fms=this.forms;$ARR.forEach(fms,function(fm){preprocessTokenStream({items:fm.ftk});});},ontokenInputBoxSelected:function(param){var editbox=param&&param.src&&param.src.parent,alias=editbox&&editbox.alias;this.editingNode=this[alias]||this.hrefInput;},updateInputBoxesItems:function(){var forms=this.forms;if(!forms){return ;}var idTokens=forms[0].ftk,descTokens=forms[1].ftk,translatedTokens=this.translateBackendTokensToDisplayTokens(descTokens),linkTextTokens=translatedTokens[0],hrefTokens=translatedTokens[1];this.linkTextInput.updateInputBoxItems({items:linkTextTokens});this.hrefInput.updateInputBoxItems({items:hrefTokens});var preprocessedIdTks=preProcessBackendTks(idTokens);this.defaultIDToken=preprocessedIdTks[0];this.defaultIDToken.isRawStr=false;},save:function save(){var editorId=this.parent.id,oi=this.oi,btn=this.buttonBar.saveBtn,dlEditor=this,hrefEditBox=this.hrefInput,linkTextEditBox=this.linkTextInput,dsid=oi.dsid,daid=oi.did,params,saveCb=this.oncreate,updateCb=this.onupdate,nm=this.nameEditBox.nameInput.value;var callback={success:function success(){_wait(btn,false);dlEditor.clear();var editor=mstrmojo.all[editorId];if(editor){editor.close();}}};var savefn=function(forms){if(forms&&saveCb){var fms=[],i;for(i=0;i<forms.length;i++){fms.push({n:forms[i].n,formula:forms[i].tokenXML});}if(fms[1]){fms[1].bft=7;}params={act:"addDAToDataset",dsid:dsid,name:nm,isTokenStream:true,forms:fms};saveCb(params,callback);}else{_wait(btn,false);}};var updatefn=function(forms){if(forms&&updateCb){var toAdd=[],toUpdate=[],pfm,fm,i;for(i=0;i<forms.length;i++){pfm=forms[i];fm={n:pfm.n,formula:pfm.tokenXML};if(pfm.did){fm.did=pfm.did;toUpdate.push(fm);}else{toAdd.push(fm);}}params={act:"updateDA",name:nm,dsid:dsid,attrId:daid,isTokenStream:true,add:toAdd,del:[],update:toUpdate};updateCb(params,callback);}else{_wait(btn,false);}};if(hrefEditBox.dirty||linkTextEditBox.dirty||nm!==(oi.alias||oi.n)){_wait(btn,true);this.linkTextInput.set("vStatus",V_STATUS.VALIDATING);this.hrefInput.set("vStatus",V_STATUS.VALIDATING);this.validateForms(!daid?savefn:updatefn);}else{callback.success();}},generateTksToBeSent:function generateTksToBeSent(hrefItems,linkTextItems,defaultIDToken){var constructIDToken=function(hrefTokens,linkTokens){var tokens=[],hashmap={};if(defaultIDToken){tokens.push(defaultIDToken);hashmap[defaultIDToken.v]=[defaultIDToken.oi&&defaultIDToken.oi.did];}var isTokenExist=function isTokenExist(token,map){var didArray=map[token.v];if(didArray){var did=token.oi&&token.oi.did;if(did&&didArray.indexOf(did)===-1){didArray.push(did);return false;}return true;}map[token.v]=[token];return false;};$ARR.forEach([].concat(hrefTokens,linkTokens),function(it){if(!it.isRawStr&&!isTokenExist(it,hashmap)){tokens.push(it);}});return constructBackendToken(tokens);};var head={v:"<a href='",isRawStr:true,isNew:true},mid={v:"' target='_blank'>",isRawStr:true,isNew:true},tail={v:"</a>",isRawStr:true,isNew:true},hrefTokens=preprocessDisplayTokens(hrefItems)||[],linkTextTokens=preprocessDisplayTokens(linkTextItems)||[];return[constructIDToken(hrefTokens,linkTextTokens),constructBackendToken([head].concat(hrefTokens,mid,linkTextTokens,tail))];},translateBackendTokensToDisplayTokens:function translateBackendTokensToDisplayTokens(tokens){var preprocessdTks=preProcessBackendTks(tokens),idx=$ARR.find(preprocessdTks,"v",addDoubleQuotationMark("' target='_blank'>"));if(idx===-1||preprocessdTks[0].v!==addDoubleQuotationMark("<a href='")||preprocessdTks[preprocessdTks.length-1].v!==addDoubleQuotationMark("</a>")){return[[],[]];}var hrefPart=preprocessdTks.slice(1,idx),linkTxtPart=preprocessdTks.slice(idx+1,preprocessdTks.length-1);return[convertBackendTksToDisplayTks(linkTxtPart),convertBackendTksToDisplayTks(hrefPart)];},validateForms:function validateForms(callback){var me=this,hrefInput=this.hrefInput,linkTextInput=this.linkTextInput,tokens=this.generateTksToBeSent(hrefInput.inputBox.items,linkTextInput.inputBox.items,this.defaultIDToken);this.forms[0].ftk=tokens[0];this.forms[1].ftk=tokens[1];var fms=this.forms;var validateIDFormCallback=function handleError(tks){var f=fms[0];f.ftk=tks.items;f.vs=tks.vs;f.is=tks.rjed||"";f.tokenXML=getTokenStreamXML({items:tks.items});if(tks.vs!==V_STATUS.VALID){if(callback){callback(null,false);}}else{if(callback){callback(fms,true);}}};var validateLinkFormCallback=function validateLinkFormCallback(tks){var f=fms[1];f.ftk=tks.items;f.vs=tks.vs;f.is=tks.rjed||"";f.tokenXML=getTokenStreamXML({items:tks.items});if(tks.vs!==V_STATUS.VALID){var displayTokens=me.translateBackendTokensToDisplayTokens(tks.items);var linkTextDisplayTokens={};var hrefDisplayTokens={};$HASH.copy(tks,linkTextDisplayTokens);$HASH.copy(tks,hrefDisplayTokens);linkTextDisplayTokens.items=displayTokens[0];hrefDisplayTokens.items=displayTokens[1];if($ARR.find(linkTextDisplayTokens.items,"sta",DSS_TOKEN_STATE.Error)===-1){linkTextDisplayTokens.vs=V_STATUS.UNKNOWN;linkTextDisplayTokens.rjed=undefined;linkTextDisplayTokens.rjec=undefined;}if($ARR.find(hrefDisplayTokens.items,"sta",DSS_TOKEN_STATE.Error)===-1){hrefDisplayTokens.vs=V_STATUS.UNKNOWN;hrefDisplayTokens.rjed=undefined;hrefDisplayTokens.rjec=undefined;}linkTextInput.handleValidation(linkTextDisplayTokens);hrefInput.handleValidation(hrefDisplayTokens);if(callback){callback(null,false);return ;}}validateSyntax(me.attrid,{items:fms[0].ftk},true,validateIDFormCallback);};validateSyntax(this.attrid,{items:fms[1].ftk},false,validateLinkFormCallback);},clear:function clear(){this.name=null;this.linkTextInput.clear();this.hrefInput.clear();},children:[{scriptClass:"mstrmojo.Box",alias:"nameEditBox",cssClass:"mstrmojo-ME-nameEditBox",cssDisplay:"inline-block",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-DA-nameLabel",bindings:{text:"this.parent.parent.nameLabel"}},{scriptClass:"mstrmojo.ValidationTextBox",alias:"nameInput",cssClass:"mstrmojo-ME-nameInput",size:20,tooltipOpenDelay:0,constraints:{trigger:mstrmojo.validation.TRIGGER.ALL,invalidCssClass:"mstrmojo-ME-invalidName"},prefocus:function(){if(this._super){this._super();}this.validate();},validate:function(v){v=v||this.value;var val=v&&!/[\[\]\"\\]/g.test(v);this.valid=null;this.set("valid",val);this.set("validationStatus",{code:val?0:1});return val;},showErrTooltip:function showTooltip(){var position=mstrmojo.dom.position(this.domNode),msg=mstrmojo.string.isEmpty(this.value)?mstrmojo.desc(9122,"Name cannot be empty"):mstrmojo.desc(11569,"Input contains invalid character");this.useRichTooltip=true;this.richTooltip={contentNodeCssClass:"me-tooltip-content left me-err",content:'<div class="content"><span>'+msg+"</span></div>",top:position.y-5,left:position.x+position.w+10};this.showTooltip();var me=this;window.setTimeout(function(){me.hideTooltip();},1500);},valid:true,onvalidChange:function(){if(this.valid){this.hideTooltip();}else{this.set("validationStatus",1);this.showErrTooltip();}mstrmojo.css.toggleClass(this.parent.domNode,"err",!this.valid);},bindings:{value:"this.parent.parent.name"}}]},{scriptClass:"mstrmojo.Box",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-DL-Label",text:mstrmojo.desc(14720,"URL Display Text")},{scriptClass:"mstrmojo.Button",alias:"validateBtn",text:mstrmojo.desc(11897,"Validate"),cssClass:"mstrmojo-WebHoverButton mstrmojo-AEB-validate",onclick:function(){this.parent.parent.linkTextInput.backendValidate();}}]},{scriptClass:"mstrmojo.ME.DynamicLinkEditBox",alias:"linkTextInput",renderOnScroll:false,renderBlockSize:0,browseItemVisible:false,cValid:false,bindings:{candidates:"this.parent.parent.attrCandidates"},getStatusDesc:function _getStatusDesc(s){return{0:mstrmojo.desc(11655,"Valid Formula."),1:mstrmojo.desc(3993,"Example:")+" Link for {City@ID}'s images"}[s];}},{scriptClass:"mstrmojo.Box",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-DL-Label",text:mstrmojo.desc(4547,"Navigate to this URL")},{scriptClass:"mstrmojo.Button",alias:"validateBtn",text:mstrmojo.desc(11897,"Validate"),cssClass:"mstrmojo-WebHoverButton mstrmojo-AEB-validate",onclick:function(){this.parent.parent.hrefInput.backendValidate();}}]},{scriptClass:"mstrmojo.ME.DynamicLinkEditBox",alias:"hrefInput",renderOnScroll:false,renderBlockSize:0,browseItemVisible:false,cValid:false,bindings:{candidates:"this.parent.parent.attrCandidates"},getStatusDesc:function _getStatusDesc(s){return{0:mstrmojo.desc(11655,"Valid Formula."),1:mstrmojo.desc(3993,"Example:")+" http://www.google.com/search?tbm=isch&q={City@ID}"}[s];}},{scriptClass:"mstrmojo.HBox",alias:"buttonBar",slot:"buttonNode",cssClass:"mstrmojo-ME-buttonBox",cellCssClass:"subBox",children:[$BTN($DESC(2400,"Save"),function(){var dle=this.parent.parent;dle.save();},true,{alias:"saveBtn",bindings:{enabled:"!!(this.parent.parent.nameEditBox.nameInput.valid && this.parent.parent.hrefInput.cValid && this.parent.parent.linkTextInput.cValid)"}}),$BTN($DESC(2399,"Cancel"),function(){var editor=this.parent.parent,ide=editor.parent;editor.clear();ide.close();})]}]});}());