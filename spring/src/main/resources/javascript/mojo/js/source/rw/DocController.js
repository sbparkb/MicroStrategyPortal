(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.form","mstrmojo._IsDocController","mstrmojo.AdvancedSortEditor","mstrmojo._DocToolbarActions","mstrmojo.func","mstrmojo.vi.controllers.UICmdMgr");var OBJECT_TYPE_REPORT=3,ADV_SORT_EDITOR_ID="mstrmojo-advancedSort";var $FUNC=mstrmojo.func;mstrmojo.rw.DocController=mstrmojo.declare(mstrmojo.Obj,[mstrmojo._IsDocController,mstrmojo._DocToolbarActions],{scriptClass:"mstrmojo.rw.DocController",start:function start(){var model=this.model;model.lastSavedStid=model.stid||0;this.cmdMgr=new mstrmojo.vi.controllers.UICmdMgr({controller:this,model:model});this.cmdMgr.dataService=model.getDataService();},onCmdMgrChanged:function onCmdMgrChanged(){},getSorts:function getSorts(action){var sorts=[],index=action.axis-1,axisSorts=[],subTotalsPos=[];sorts[index]=axisSorts;axisSorts.push({key:action.sortKey,isAsc:action.isAsc});subTotalsPos[index]=action.subTotalsPos;return{sorts:sorts,subTotalsPos:subTotalsPos};},onSort:function onSort(view,action){var s=this.getSorts(action);this.onAdvancedSort(view,s.sorts,s.subTotalsPos,action.stt);},onAdvancedSort:function onAdvancedSort(view,sorts,stp,stt){view.model.sort({sorts:sorts,stp:stp,stt:stt},this._getXtabCallback(view));},onGetAdvSortData:function onAdvSort(view,axis,type){var me=this,openAdvSortEditor=function openAdvSortEditor(sortData){var e=mstrmojo.all[ADV_SORT_EDITOR_ID]||mstrmojo.insert({scriptClass:"mstrmojo.AdvancedSortEditor",id:ADV_SORT_EDITOR_ID,postCreate:function postCreate(){if(mstrmojo.dom.isIE8){mstrmojo.css.addWidgetCssClass(this,"ie8");}}});e.set("sortData",sortData);e.set("controller",me);e.set("xtab",view);e.set("sourceAxis",axis||1);e.set("sourceType",type||-1);e.open();};view.model.getAdvSortData({partialDisplayKeys:view.k,gridStyle:"AdvSortDataStyle"},this.model.newCallback({success:function(res){openAdvSortEditor(res.grids[0]);},failure:function failure(details){mstrmojo.alert(details.code+": "+details.message);}}));},onPivot:function onPivot(view,action){view.model.pivot(this._addNodeKeyToAction(view,action),this._getXtabCallback(view));},onSubmitTemplateUpdates:function onSubmitTemplateUpdates(view,actions,callback){view.model.submitTemplateActions(view.k,actions,$FUNC.wrapMethods(this._getXtabCallback(view),callback));},onShowTotals:function onShowTotals(view,action){view.model.showTotals(this._addNodeKeyToAction(view,action),this._getXtabCallback(view));},onDrill:function onDrill(view,action,callback){var model=this.model,prefs=this.model.prefs,retainParent=prefs.rtprnt,retainThreshold=prefs.rtthld;if(action.isWithin){if(!this.isInRequest()){action.retainParent=prefs.rtprnt;this.submitDrillWithin(view,action,callback);}}else{mstrmojo.form.send({evt:3125,displayMode:-1,drillPathKey:action.drillPathKey,elementList:action.drillElements,rwMesageID:model.mid,retainParent:isNaN(retainParent)?"":retainParent,retainThresh:isNaN(retainThreshold)?"":retainThreshold,rwGroupByElements:this.getGroupByElements(view).join(","),sliceId:view.sid||0},null,null,((prefs.drillnw)?"_blank":null));}},onDrillGraph:function onDrillGraph(view,action,callback){var model=this.model,prefs=this.model.prefs,retainParent=prefs.rtprnt,retainThreshold=prefs.rtthld;if(action.isWithin){if(!this.isInRequest()){action.retainParent=prefs.rtprnt;this.submitDrillWithin(view,action,callback);}}else{mstrmojo.form.send({evt:3126,drillPathKey:action.drillPathKey,retainParent:isNaN(retainParent)?"":retainParent,retainThresh:isNaN(retainThreshold)?"":retainThreshold,rwMesageID:model.mid,"3126.x":action.x,"3126.y":action.y,graphHeight:action.graphHeight,graphWidth:action.graphWidth,rwGroupByElements:this.getGroupByElements(view).join(","),sliceId:view.sid||0,displayMode:action.displayType||2},null,null,((prefs.drillnw)?"_blank":null));}},submitDrillWithin:function submitDrillWithin(view,action,callback){view.model.drillGrid(this._addNodeKeyToAction(view,action),mstrmojo.func.wrapMethods(this._getXtabCallback(view),callback));},onExecuteNewObject:function onExecuteNewObject(view,params){if(params){var m={};if(params.objType===OBJECT_TYPE_REPORT){m.evt=4001;m.reportID=params.did;m.reportViewMode=1;if(params.forceExec){m.execFlags=1;m.doNotUpdateCaches=true;}}else{m.evt=2048001;m.objectID=params.did;if(params.forceExec){m.freshExec=true;m.doNotUpdateCaches=true;}}if(params.linkAnswers){m.linkAnswers=params.linkAnswers;}mstrmojo.form.send(m,null,"POST",null);}},onReExecute:function(view,ignoreStatus){var md=view.model,params={evt:2048030,src:md.bp+".2048030",rwb:md.bs};if(ignoreStatus){params.ignoreStatus=true;mstrmojo.form.send(params,null,"POST",null);}else{mstrmojo.form.send(params,null,"POST",null);}},isAutoRefreshEnabled:function isAutoRefreshEnabled(){return this.model&&this.model.rf;},isAutoRefreshStarted:function isAutoRefreshStarted(){return !!this.autoRefreshHandler;},startAutoRefresh:function startAutoRefresh(){var model=this.model,rf=model.rf,me=this;if(this.autoRefreshHandler){this.stopAutoRefresh();}this.autoRefreshHandler=setTimeout(function(){model.getDataService().refresh({},{success:function success(res){if(model.clearDisposables){model.clearDisposables();}model.loadLayout(res);if(me.autoRefreshHandler){me.startAutoRefresh();}}});},rf*1000);},stopAutoRefresh:function stopAutoRefresh(){clearTimeout(this.autoRefreshHandler);this.autoRefreshHandler=null;},offlineTransactionsSubmitted:function offlineTransactionsSubmitted(ck){},transactionDiscarded:function transactionDiscarded(ck){},openOfflineTransactions:function openOfflineTransactions(){},invalidClientCache:function invalidClientCache(){},confirmMsgBeforeSubmit:function confirmMsgBeforeSubmit(){},onLink:function onLink(view,action){if(action.link){var i,prm,link=action.link,cnt=(link.prms?link.prms.length:0);for(i=0;i<cnt;i++){prm=link.prms[i];if(prm.pa&&prm.pa.v){prm.pa.v=mstrmojo.string.decodeHtmlString(prm.pa.v,false);}}var linkXml=action.link.toXml();if(linkXml){action.linkAnswers=linkXml;}delete action.link;}if(action.linkInfo&&action.linkInfo.so>0){action.originMessageID=this.model.mid;if(!action.linkAnswers){action.promptAnswerMode="0";}action.selectorMode=action.linkInfo.so;}var target=action.target||action.linkTarget||"_self";if(action.url){if(action.url.toLowerCase().indexOf("javascript:")>=0&&!mstrConfig.isLinkJSEnabled){return ;}if(mstrApp.isSingleTier){window.FormWrapper.openPage(action.url);}else{if(action.submitAsPost||action.url.length>2083){var form=mstrmojo.form.createDynamicForm(action.url);form.target=target;form.submit();}else{window.open(action.url,target);}}}else{mstrmojo.form.send(action,null,"POST",target);}},onTransactionUpdates:function onTransactionUpdates(view,updateObject,autoRefresh,ctlKey){var evt={name:"TransactionUpdates",ctlKey:ctlKey};if(autoRefresh){view.autoRefresh(evt);}},onDownloadGridData:function onDownloadGridData(view,action){this.model.downloadGridData(this._addNodeKeyToAction(view,action));},onGroupBy:function onGroupBy(view,params){var model=view.model,groupbyKey=params.groupbyKey,unloadLayouts=false;params.flags=model.agb===2?2:0;unloadLayouts=!!params.flags;model.getDataService().changeDocGroupBy(params,{success:function(res){if(unloadLayouts){view.parent.parent.unloadGbLayuts(groupbyKey);}model.loadLayout(res);}});},_getAdvSortCallback:function(view,stp){var me=this,model=me.model,openAdvSortEditor=function openAdvSortEditor(gridData){var e=mstrmojo.all[ADV_SORT_EDITOR_ID];if(!e){e=mstrmojo.insert({scriptClass:"mstrmojo.AdvancedSortEditor",gridData:gridData,controller:me,model:model,xtab:view,subTotalsPos:stp});}else{e.set("gridData",gridData);}e.open();};return model.newCallback({submission:mstrmojo.emptyFn,success:function success(res){openAdvSortEditor(res.grids[0]);},failure:function failure(details){mstrmojo.alert(details.code+": "+details.message);},complete:mstrmojo.emptyFn});},onXtabColumnsResized:function onXtabColumnsResized(view,action){view.model.resizeXtabColumn(this._addNodeKeyToAction(view,action));},addScrollPosition:function addScrollPosition(key,left,top){if(window.sessionStorage){window.sessionStorage.setItem("sp."+key,JSON.stringify({x:left,y:top}));}},getScrollPosition:function getScrollPosition(key){var pos=(window.sessionStorage&&window.sessionStorage.getItem("sp."+key));if(pos){pos=JSON.parse(pos);}return pos;},onRemoveUnit:function onRemove(view,action){view.model.removeUnit(this._addNodeKeyToAction(view,action),this._getXtabCallback(view));}});}());