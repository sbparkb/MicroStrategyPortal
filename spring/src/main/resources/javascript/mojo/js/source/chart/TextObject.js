(function(){mstrmojo.requiresClsP("mstrmojo.chart","Rect2D","FormatFont","ChartContext","ShapeObject","SubTextHolder","Point2D");mstrmojo.requiresCls("mstrmojo.chart.common.Utility","mstrmojo.VisUtility");mstrmojo.requiresClsP("mstrmojo.chart.enums","EnumCollectionType","EnumGraphMajorType","EnumAnchorPoint","EnumBoxStyle","EnumFontAlignment","EnumFontRotation","EnumRectExpandDirection");mstrmojo.requiresClsP("mstrmojo.chart.model.enums","EnumDSSGraphObject");var $C=mstrmojo.chart,$CHART_ENUMS=$C.enums,$M=$C.model,$MODEL_ENUMS=$M.enums,$CT=$CHART_ENUMS.EnumCollectionType,$GMT=$CHART_ENUMS.EnumGraphMajorType,$VISUTIL=mstrmojo.VisUtility,$AP=$CHART_ENUMS.EnumAnchorPoint,$BS=$CHART_ENUMS.EnumBoxStyle,$FA=$CHART_ENUMS.EnumFontAlignment,$FR=$CHART_ENUMS.EnumFontRotation,$RECT_EXPAND_DIR=$CHART_ENUMS.EnumRectExpandDirection,$GO=$MODEL_ENUMS.EnumDSSGraphObject,$Utility=$C.common.Utility;var kUseLargerTruncationLimit=true;var kIsGridChart=false,kGreenColor=65280,kWidthEdgeMarginRatio=0.03,kHeightEdgeMarginRatio=0,kTextLineSpaceRatio=0,kDoubleLineMarginRatio=0.2,kFontHeightRatio=0.85,kAdjustTextYPosition=0,kAdjustDominateBaseline=0;var deviceAnchor=new $C.Point2D(),textStartPoint=new $C.Point2D(),rotateAnchor=new $C.Point2D(),perfExpandCurrentRect=new $C.Rect2D(),perfExpandInputRect=new $C.Rect2D();function getDominateBaselineOffset(id){var chartCtx=this.mChartContextPtr,adjustY=true,rect,isVerticalChart=chartCtx.IsVertical();if(!adjustY){return 0;}if(isVerticalChart){switch(id.mObjectId){case $GO.DssGraphY1Label:case $GO.DssGraphY2Label:return(0.5*this.mFontHeight);case $GO.DssGraphX1Label:if(this.mFormatFontPtr.mFontRotation===$FR.FR_NORMAL){rect=this.GetTransformedRect(true);return(0.5*rect.height)+1;}return 0;default:return 0;}}if(this.mFormatFontPtr.mFontRotation===$FR.FR_NORMAL){switch(id.mObjectId){case $GO.DssGraphX1Label:case $GO.DssGraphX2Label:case $GO.DssGraph2DO1Label:rect=this.GetTransformedRect(true);return(0.5*rect.height)+1;default:return 0;}}return 0;}function getAdjustedY(id){var adjustY=true;var chartCtx=this.mChartContextPtr;if(adjustY){switch(id.mObjectId){case $GO.DssGraph2DO1Label:case $GO.DssGraph2DO2Label:if(chartCtx.IsGridChart()||chartCtx.IsVertical()){return Math.ceil(0.25*this.mFontHeight);}return 0;case $GO.DssGraphDataText:return Math.ceil(0.2*this.mFontHeight);default:return 0;}}return 0;}function hIsVisual(){if(!this.mIsShown||!this.mText.localeCompare("")){return false;}if(!this.mIsOnScreen){return false;}if(this.mChartContextPtr.mImageFormat===103){var rect=this.rect;return(rect.width>0&&rect.height>0);}return true;}function hGetStartOffsetForWord(lineIndex,idx,texts){var textHolder=this.mSubTextHolder,formatFont=this.mFormatFontPtr,text,i,width=0,lineStartWordIndex=textHolder.mVecPartition[lineIndex];for(i=0;i<idx-lineStartWordIndex;i++){text=texts[i];if(text.Truncated){width+=textHolder.GetStringWidth(text.Word,formatFont);}else{width+=textHolder.GetOneWordWidth(text.Index);}if(texts.length>0){width+=textHolder.GetSpaceWidth();}}return width;}function hInitFormat(){var chartCtx=this.mChartContextPtr,parent=this.mpParentObject;this.mFormatFontPtr=(parent===null)?chartCtx.GetFormatFont(this.mTripleId):parent.GetFormatFont();var fmt=this.mFormatFontPtr;if(fmt.mFontBox!==$BS.BS_NOFRAME&&chartCtx.mIsGraphMatrix===false){if(parent===null){this.mFormatFillPtr=chartCtx.GetFormatFill(this.mTripleId,$CT.CT_NO_COLLECTION);if(!kIsGridChart){this.mFormatLinePtr=chartCtx.GetFormatLine(this.mTripleId,$CT.CT_NO_COLLECTION,-1);}}else{this.mFormatFillPtr=parent.GetFormatFill();if(!kIsGridChart){this.mFormatLinePtr=parent.mFormatLinePtr;}}}}function hCalculateFontHeight(precisely){precisely=precisely||false;var height=8,formatFont=this.mFormatFontPtr;if(formatFont){if(precisely){height=formatFont.GetStringExtent("H").Height;}else{height=formatFont.GetFontExtent();}}height=Math.floor(height*kFontHeightRatio+0.5);return height;}function hCalculateParas(){var formatFont=this.mFormatFontPtr,chartCtx=this.mChartContextPtr,hasFrameBox,graphMajorType,is3DChart;this.mFontHeight=hCalculateFontHeight.call(this,true);if(chartCtx.mIsGraphMatrix){var array=formatFont.evalMargins();this.mWidthEdgeMargin=array[0]||0;this.mHeightEdgeMargin=array[1]||0;this.mTextLineSpace=array[2]||0;}else{graphMajorType=this.mChartContextPtr.GetGraphMajorType();is3DChart=(graphMajorType===$GMT.GMT_3D_SCATTER||graphMajorType===$GMT.GMT_3D_CATEGORY);hasFrameBox=formatFont.mFontBox!==$BS.BS_NOFRAME;this.mDoubleLineMargin=this.mDoubleLineMargin||0;this.mDoubleLineMargin=Math.floor(formatFont.mFontSize*kDoubleLineMarginRatio+0.5);if(this.mDoubleLineMargin===0){this.mDoubleLineMargin=1;}this.mWidthEdgeMargin=Math.floor(formatFont.mFontSize*kWidthEdgeMarginRatio+0.5);if((this.mWidthEdgeMargin===0&&hasFrameBox)||is3DChart){this.mWidthEdgeMargin=1;}this.mHeightEdgeMargin=Math.floor(formatFont.mFontSize*kHeightEdgeMarginRatio+0.5);if((this.mHeightEdgeMargin===0&&hasFrameBox)||is3DChart){this.mHeightEdgeMargin=1;}this.mTextLineSpace=Math.floor(formatFont.mFontSize*kTextLineSpaceRatio+0.5);if(this.mTextLineSpace===0){this.mTextLineSpace=1;}switch(formatFont.mFontBox){case $BS.BS_NOFRAME:break;case $BS.BS_SINGLE_LINE_FRAME:this.mWidthEdgeMargin+=this.mDoubleLineMargin;this.mHeightEdgeMargin+=this.mDoubleLineMargin;break;case $BS.BS_DOUBLE_LINE_FRAME:case $BS.BS_BEVELED_FRAME:case $BS.BS_REVERSE_BEVELED_FRAME:this.mWidthEdgeMargin+=this.mDoubleLineMargin*2;this.mHeightEdgeMargin+=this.mDoubleLineMargin*2;break;}}}function hGetRadian(){var degree=0;switch(this.mFormatFontPtr.mFontRotation){case $FR.FR_45:degree=45;break;case $FR.FR_90:degree=90;break;case $FR.FR_180:degree=180;break;case $FR.FR_270:degree=270;break;case $FR.FR_315:degree=315;break;default:break;}return $C.gModuleMain.DegreeToRadian(-degree);}function hGetDevicePolygon(){var radian;var orDevicePolygon=[],rect=this.rect;deviceAnchor.x=rect.x+rect.width/2;deviceAnchor.y=rect.y+rect.height/2;radian=hGetRadian.call(this);orDevicePolygon.push(new $C.Point2D({x:rect.x,y:rect.y}).rotateAndClone(deviceAnchor,radian));orDevicePolygon.push(new $C.Point2D({x:rect.x+rect.width,y:rect.y}).rotateAndClone(deviceAnchor,radian));orDevicePolygon.push(new $C.Point2D({x:rect.x+rect.width,y:rect.y+rect.height}).rotateAndClone(deviceAnchor,radian));orDevicePolygon.push(new $C.Point2D({x:rect.x,y:rect.y+rect.height}).rotateAndClone(deviceAnchor,radian));return orDevicePolygon;}function hDoWordTruncation(input,limit,result){var i,S,T,W,Value,size=input.length;for(i=1;i<=size;++i){S=input.substring(0,size-i);T=S.concat("...");Value=this.mFormatFontPtr.GetStringExtent(T);W=Value.Width;if(W<limit){result.Text=T;result.TextWidth=W;return true;}}return false;}function hDoTruncation(input,limit,result,drawByWords){var ret={},size=input.length;drawByWords=drawByWords||false;if(drawByWords){var sumWidth=0,wordWidth=0,allowWordWrap=true,textHolder=this.mSubTextHolder,spaceWidth=textHolder.GetSpaceWidthEx(this.mFormatFontPtr),threeDotsWidth=this.mFormatFontPtr.GetStringExtent("...").Width,inspectString="",pre=-1;if(threeDotsWidth>limit){return false;}var i;for(i=0;i<size;i++){wordWidth=textHolder.GetOneWordWidth(input[i]);if(sumWidth+(i>0?spaceWidth:0)>limit-threeDotsWidth){break;}if(sumWidth+wordWidth+(i>0?spaceWidth:0)>limit-threeDotsWidth){break;}inspectString=inspectString.concat(textHolder.mVecStr[input[i]]);if(i>0){inspectString=inspectString.concat(" ");}sumWidth+=wordWidth+(i>0?spaceWidth:0);pre=i;}var j,idx=0;for(j=0;j<=pre;j++){idx=input[j];result.Texts.push({Truncated:true,Index:idx,Word:textHolder.mVecStr[idx]});}if(i>=size){$VISUTIL.visPrint("where is the truncated word....");return true;}limit-=sumWidth;if(allowWordWrap===false&&pre!==-1){limit-=spaceWidth;}idx=input[i];var incomplete="";incomplete=incomplete.concat(textHolder.mVecStr[idx]);if(hDoWordTruncation.call(this,incomplete,limit,ret)){result.Texts.push({Truncated:true,Highlighted:false,Index:idx,Word:ret.Text});sumWidth+=ret.TextWidth;}else{$VISUTIL.visPrint("Should have truncated, but...");result.Texts.push({Truncated:false,Highlighted:false,Index:idx,Word:textHolder.mVecStr[idx]});sumWidth+=((idx===0?0:spaceWidth)+textHolder.GetOneWordWidth(idx));}result.TextWidth=sumWidth;result.TextXBearing=0;return true;}if(hDoWordTruncation.call(this,input,limit,ret)){result.TextWidth=ret.TextWidth;result.TextXBearing=0;result.Texts.push({Truncated:true,Highlighted:false,Index:-1,Word:ret.Text});return true;}return false;}function hTruncate(lineIndex,drawByWords){var chartCtx=this.mChartContextPtr,textHolder=this.mSubTextHolder,Result={TextWidth:0,TextXBearing:0,Texts:[]},T,W,V;drawByWords=drawByWords||false;W=textHolder.GetOneLineWidth(lineIndex);T=textHolder.GetOneLineString(lineIndex);if(W<=this.rect.width+(kUseLargerTruncationLimit?4:0)){Result.TextXBearing=textHolder.GetOneLineXBearing(lineIndex);Result.TextWidth=W;if(drawByWords){var i,idx=-1,words=textHolder.GetOneLineWords(lineIndex);for(i=0;i<words.length;i++){idx=words[i];Result.Texts.push({Index:idx,Word:textHolder.mVecStr[idx],Highlighted:false,Truncated:false});}}else{Result.Texts.push({Index:-1,Word:T,Highlighted:false,Truncated:false});}return Result;}var isGM=chartCtx.mIsGraphMatrix,input=drawByWords?textHolder.GetOneLineWords(lineIndex):T;if(isGM&&!chartCtx.isUADataAreaOutput()){if(this.mFormatFontPtr.mFontRotation===$FR.FR_90){var oldRect=this.GetBoundingRect(true);if(oldRect.y+W>chartCtx.mGraphHeight){if(hDoTruncation.call(this,input,chartCtx.mGraphHeight,Result,drawByWords)){this.mIsTruncated=true;return Result;}}}if(this.rect.x<0&&W>this.rect.width+this.rect.x){if(hDoTruncation.call(this,input,this.rect.width+this.rect.x,Result,drawByWords)){this.mIsTruncated=true;return Result;}}}if(hDoTruncation.call(this,input,this.rect.width,Result,drawByWords)){this.mIsTruncated=true;return Result;}this.mIsTruncated=true;V=this.mFormatFontPtr.GetStringExtent(Result.Text);Result.TextWidth=V.Width;Result.TextXBearing=0;Result.Texts.push({Index:-1,Word:isGM?"":"...",Highlighted:false,Truncated:true});return Result;}function hFormatSingleLineText(startPoint,iLineIndex,drawByWords){var chartCtx=this.mChartContextPtr,Result,text,texts,i,formatFont=this.mFormatFontPtr,lineTextWidth;drawByWords=drawByWords||false;Result=hTruncate.call(this,iLineIndex,drawByWords);text=Result.Text;texts=Result.Texts;lineTextWidth=Result.TextWidth;switch(this.mFormatFontPtr.mFontAlignment){case $FA.FA_LEFT:startPoint.x+=this.mWidthEdgeMargin;break;case $FA.FA_CENTER:startPoint.x+=Math.floor((this.rect.width-lineTextWidth)/2+0.5);break;case $FA.FA_RIGHT:startPoint.x+=Math.floor(this.rect.width-lineTextWidth-this.mWidthEdgeMargin+0.5);break;}if(chartCtx.mIsGraphMatrix&&!chartCtx.isUADataAreaOutput()){if(this.rect.x<0&&this.mIsTruncated){startPoint.x=this.rect.width+this.rect.x-lineTextWidth+0.5;}if(formatFont.mFontRotation===$FR.FR_90){var oldRect=this.GetBoundingRect();if(oldRect.y+oldRect.height>chartCtx.mGraphHeight&&this.mIsTruncated){var originalWidth=this.mSubTextHolder.GetOneLineWidth(iLineIndex),xOffset=originalWidth-lineTextWidth;startPoint.x-=xOffset/2;startPoint.x+=xOffset;}}}if(texts===undefined){return ;}kAdjustTextYPosition=getAdjustedY.call(this,this.mTripleId);kAdjustDominateBaseline=getDominateBaselineOffset.call(this,this.mTripleId);var basePoint={x:startPoint.x,y:startPoint.y-kAdjustTextYPosition},point,props,offset;for(i=0;i<texts.length;i++){text=texts[i];startPoint.x=basePoint.x;startPoint.y=basePoint.y;if(i>0){offset=hGetStartOffsetForWord.call(this,iLineIndex,text.Index,texts);startPoint.x+=offset;}props={};if(kAdjustDominateBaseline!==0){props={BaselineOffset:kAdjustDominateBaseline};}point=startPoint;if(text.Highlighted){var backupColor=formatFont.mFontColor;formatFont.mFontColor=kGreenColor;chartCtx.AddFormatedText(formatFont,point,text.Word,props);formatFont.mFontColor=backupColor;}else{chartCtx.AddFormatedText(formatFont,point,text.Word,props);}}}function hRenderBBox(){var polygon,chartCtx=this.mChartContextPtr,forDataLabel=false;if(chartCtx.mIsGraphMatrix){if(this.showBBox){polygon=hGetDevicePolygon.call(this);chartCtx.DrawPolygon(polygon,true);if(this.mTripleId.mObjectId===$GO.DssGraphDataText){forDataLabel=true;}this.mChartContextPtr.FinishTextBoundingBox(polygon,this.BBoxColor,forDataLabel);}else{if($Utility.isValidNumber(this.BBoxColor)){var borderStroke=true,useBold=true;if(borderStroke){var FS_BOLD=1,formatFont=new $C.FormatFont({Font:this.mFormatFontPtr});formatFont.mStrokeColor=this.BBoxColor;formatFont.mStrokeWidth=this.mChartContextPtr.isCombinationChart()?0.01:0.5;if(useBold){formatFont.mFontStyle=FS_BOLD;}this.mFormatFontPtr=formatFont;}}}}else{if(kIsGridChart||this.mFormatFontPtr.mFontBox!==$BS.BS_NOFRAME){polygon=hGetDevicePolygon.call(this);chartCtx.DrawPolygon(polygon,false,null,null,null);this.ApplyFillFormat();}}return this.mFormatFontPtr;}mstrmojo.chart.TextObject=mstrmojo.declare(mstrmojo.chart.ShapeObject,null,{scriptClass:"mstrmojo.chart.TextObject",clientDrag:false,rect:null,mFormatFontPtr:null,mText:"",mSubTextHolder:null,mIsShown:true,mWidthEdgeMargin:0,mHeightEdgeMargin:0,mTextLineSpace:0,mFontHeight:0,mIsRectCalculated:false,mTextWidthLimit:-1,mIsStringent:true,mLineCount:-1,mIsTruncated:false,mOnMarker:false,mIsOnScreen:true,init:function init(props){props.hasLine=false;props.hasFill=false;if(props.hasLine||props.hasFill){this._super(props);}else{this.mpParentObject=props.GraphCollectionObject||null;this.mTripleId=props.TripleId||$C.gNullTripleId;this.mpManager=props.GraphObjectManager||null;this.mChartContextPtr=this.mpManager?this.mpManager.mChartContextPtr:null;this.mIsDetectable=true;if(props.Shape){this.mShapeType=props.Shape;}}if(props.Identity!==undefined&&props.Identity!==null){this.identity=props.Identity;}this.rect=this.rect||new $C.Rect2D();this.mSubTextHolder=new $C.SubTextHolder();if(props&&props.OnMarker){this.mOnMarker=props.OnMarker;}hInitFormat.call(this);hCalculateParas.call(this);},GetFormatFont:function GetFormatFont(){return this.mFormatFontPtr;},SetText:function SetText(irText,wordLenLimit){if(wordLenLimit===undefined){wordLenLimit=-1;}this.mText=irText;this.mIsRectCalculated=false;if(this.mText!==""){var subTextHolder=this.mSubTextHolder;subTextHolder.Clear();subTextHolder.ParseText(this.mText," ",wordLenLimit);subTextHolder.UpdateText(this.mChartContextPtr,this.mFormatFontPtr);}},GetBoundingRectEx:function GetBoundignRectEx(orRect){var fontRotation=this.mFormatFontPtr.mFontRotation;if(!this.mIsRectCalculated){this.CalculateDeviceRect();}var rect=this.rect;if(fontRotation!==$FR.FR_NORMAL){if(fontRotation===$FR.FR_90||fontRotation===$FR.FR_270){orRect.Reset(rect.x,rect.y,rect.width,rect.height);var centerX=rect.x+0.5*rect.width,centerY=rect.y+0.5*rect.height;orRect.width=this.rect.height;orRect.height=this.rect.width;orRect.x=centerX-0.5*orRect.width;orRect.y=centerY-0.5*orRect.height;}else{var theRect=this.GetBoundingRectFromPolygon(hGetDevicePolygon.call(this));orRect.ResetRect(theRect);}}else{orRect.Reset(rect.x,rect.y,rect.width,rect.height);}},GetBoundingRect:function GetBoundingRect(intact){var fontRotation=this.mFormatFontPtr.mFontRotation,boundingRect;if(!this.mIsRectCalculated){this.CalculateDeviceRect();}if(fontRotation!==$FR.FR_NORMAL){if(fontRotation===$FR.FR_90||fontRotation===$FR.FR_270){boundingRect=new $C.Rect2D({Rect2D:this.rect});var rect=this.rect,centerX=rect.x+0.5*rect.width,centerY=rect.y+0.5*rect.height;boundingRect.width=this.rect.height;boundingRect.height=this.rect.width;boundingRect.x=centerX-0.5*boundingRect.width;boundingRect.y=centerY-0.5*boundingRect.height;}else{boundingRect=this.GetBoundingRectFromPolygon(hGetDevicePolygon.call(this));}}else{intact=intact||false;if(intact){return this.rect;}boundingRect=new $C.Rect2D({Rect2D:this.rect});}return boundingRect;},GetClockwisePolygon:function GetClockwisePolygon(){if(!this.mIsRectCalculated){this.CalculateDeviceRect();}return hGetDevicePolygon.call(this);},CalculateDeviceRect:function CalculateDeviceRect(){var textHolder=this.mSubTextHolder,rect=this.rect,fontHeight=this.mFontHeight,textWidthLimit=this.mTextWidthLimit,textLineSpace=this.mTextLineSpace,widthEdgeMargin=this.mWidthEdgeMargin,heightEdgeMargin=this.mHeightEdgeMargin,lineNumber=1,maxLineCount=this.mLineCount;if(rect.width===0||rect.height===0){if(textWidthLimit===-1&&maxLineCount===-1){lineNumber=textHolder.GetLineCount();rect.width=textHolder.GetMaxWidth();rect.height=(fontHeight+(lineNumber===1?0:textLineSpace))*lineNumber;rect.Explode(widthEdgeMargin,heightEdgeMargin);}else{if(textWidthLimit!==-1&&maxLineCount===-1){textHolder.PartitionBy(textWidthLimit,this.mIsStringent);lineNumber=textHolder.GetLineCount();rect.height=(fontHeight+(lineNumber===1?0:textLineSpace))*lineNumber+heightEdgeMargin*2;if(this.mIsStringent){rect.width=Math.min(textHolder.GetMaxWidth(),textWidthLimit)+widthEdgeMargin*2;}else{rect.width=textHolder.GetMaxWidth()+widthEdgeMargin*2;}}else{if(textWidthLimit===-1&&maxLineCount!==-1){textHolder.SetLineCount(maxLineCount);lineNumber=textHolder.GetLineCount();rect.width=textHolder.GetMaxWidth();rect.height=(fontHeight+(lineNumber===1?0:textLineSpace))*lineNumber;rect.Explode(widthEdgeMargin,heightEdgeMargin);}else{textHolder.SetLineCount(maxLineCount,textWidthLimit);lineNumber=textHolder.GetLineCount();rect.height=(fontHeight+(lineNumber===1?0:textLineSpace))*lineNumber+heightEdgeMargin*2;if(this.mIsStringent){rect.width=Math.min(textHolder.GetMaxWidth(),textWidthLimit)+widthEdgeMargin*2;}else{rect.width=textHolder.GetMaxWidth()+widthEdgeMargin*2;}}}}}else{if(textWidthLimit===-1){if(textHolder.GetMaxWidth()>rect.width){textHolder.PartitionBy(rect.width);}}else{if(textHolder.GetMaxWidth()>textWidthLimit){textHolder.PartitionBy(textWidthLimit,this.mIsStringent);if(this.mIsStringent){rect.width=Math.min(textHolder.GetMaxWidth(),textWidthLimit)+widthEdgeMargin*2;}else{rect.width=textHolder.GetMaxWidth()+widthEdgeMargin*2;}}}lineNumber=textHolder.GetLineCount();rect.height=(fontHeight+(lineNumber===1?0:textLineSpace))*lineNumber+heightEdgeMargin*2;}this.mIsRectCalculated=true;},GetLineCount:function GetLineCount(){return this.mSubTextHolder.GetLineCount();},SetTextWidthLimit:function SetTextWidthLimit(iWidthLimit,iIsStringent){if(iIsStringent===undefined){iIsStringent=true;}this.mTextWidthLimit=iWidthLimit;this.mIsStringent=iIsStringent;this.mIsRectCalculated=false;},SetRect:function SetRect(irRect){this.rect.copy(irRect);},SetRotation:function SetRotation(r){var rotation=this.mFormatFontPtr.mFontRotation;if(r!==rotation){var newFormatFont=new $C.FormatFont({Font:this.mFormatFontPtr});newFormatFont.mFontRotation=r;this.mFormatFontPtr=newFormatFont;}},MoveTo:function MoveTo(iDestX,iDestY,iAnchor){iAnchor=iAnchor||$AP.TOP_LEFT;if(!this.mIsRectCalculated){this.CalculateDeviceRect();}var r=this.rect;switch(iAnchor){case $AP.TOP_LEFT:r.x=iDestX;r.y=iDestY;break;case $AP.CENTER:r.x=iDestX-r.width/2;r.y=iDestY-r.height/2;break;case $AP.TOP_MIDDLE:r.x=iDestX-r.width/2;r.y=iDestY;break;case $AP.TOP_RIGHT:r.x=iDestX-r.width;r.y=iDestY;break;case $AP.LEFT_MIDDLE:r.x=iDestX;r.y=iDestY-r.height/2;break;case $AP.RIGHT_MIDDLE:r.x=iDestX-r.width;r.y=iDestY-r.height/2;break;case $AP.BOTTOM_LEFT:r.x=iDestX;r.y=iDestY-r.height;break;case $AP.BOTTOM_MIDDLE:r.x=iDestX-r.width/2;r.y=iDestY-r.height;break;case $AP.BOTTOM_RIGHT:r.x=iDestX-r.width;r.y=iDestY-r.height;break;}},MoveToCenter:function MoveToCenter(destX,destY){this.rect.x=Math.round(destX-this.rect.width/2);this.rect.y=Math.round(destY-this.rect.height/2);},GetTransformedRect:function GetTransformedRect(intact){var center,factor,Rect;if(!this.mIsRectCalculated){this.CalculateDeviceRect();}var rotation=this.mFormatFontPtr.mFontRotation;if(rotation===$FR.DssGraphFontRotate45||rotation===$FR.DssGraphFontRotate315){Rect=new $C.Rect2D({Rect2D:this.rect});center=new $C.Point2D({x:Rect.x+Rect.width*0.5,y:Rect.y+Rect.height*0.5});factor=(rotation===$FR.DssGraphFontRotate45)?1:-1;Rect.x=Math.floor((center.x-factor*center.y)*Math.SQRT1_2+(Rect.x-center.x)+0.5);Rect.y=Math.floor((factor*center.x+center.y)*Math.SQRT1_2+(Rect.y-center.y)+0.5);}else{Rect=this.GetBoundingRect(intact);}return Rect;},GetTransformedRectEx:function GetTransformedRectEx(orRect){var centerX,centerY,factor;if(!this.mIsRectCalculated){this.CalculateDeviceRect();}var rotation=this.mFormatFontPtr.mFontRotation;if(rotation===$FR.FR_45||rotation===$FR.FR_315){orRect.ResetRect(this.rect);centerX=orRect.x+orRect.width*0.5;centerY=orRect.y+orRect.height*0.5;factor=(rotation===$FR.FR_45)?1:-1;orRect.x=Math.floor((centerX-factor*centerY)*Math.SQRT1_2+(orRect.x-centerX)+0.5);orRect.y=Math.floor((factor*centerX+centerY)*Math.SQRT1_2+(orRect.y-centerY)+0.5);}else{this.GetBoundingRectEx(orRect);}},HasOverlapForSameRotation:function HasOverlapForSameRotation(ipTextObject,iLabelSpan,iSpanDirection){iLabelSpan=iLabelSpan||0;iSpanDirection=iSpanDirection||$RECT_EXPAND_DIR.REC_EXP_INVALID;var currentRect=this.GetTransformedRect(true),inputRect=ipTextObject.GetTransformedRect(true),offset=iLabelSpan/2;if(offset>0){perfExpandCurrentRect.ResetRect(currentRect);perfExpandInputRect.ResetRect(inputRect);perfExpandCurrentRect.Expand(offset,iSpanDirection);perfExpandInputRect.Expand(offset,iSpanDirection);return perfExpandCurrentRect.HasIntersection(perfExpandInputRect);}return currentRect.HasIntersection(inputRect);},strokeBBox:function strokeBBox(color){var strokeBoundingBox=false,chartCtx=this.mChartContextPtr;if(color===undefined){if(strokeBoundingBox){color=chartCtx.getDefaultContrastColor();}else{color=chartCtx.getDefaultThemeColor();}}this.BBoxColor=color;},Draw:function Draw(){var chartCtx=this.mChartContextPtr,formatFont=this.mFormatFontPtr,lineCount,singleLineHeight,heightEdgeMargin,i,drawByWord=false;if(hIsVisual.call(this)===false){return ;}if(isNaN(this.rect.x)||isNaN(this.rect.y)){return ;}this.mIsTruncated=false;formatFont=hRenderBBox.call(this);formatFont.ApplyFontFormat(chartCtx,false);switch(this.mTripleId.mObjectId){case $GO.DssGraph2DO1Label:case $GO.DssGraph2DO2Label:drawByWord=true;break;default:drawByWord=false;break;}if(formatFont.mFontRotation!==$FR.FR_NORMAL){chartCtx.saveState();rotateAnchor.x=this.rect.x+this.rect.width/2;rotateAnchor.y=this.rect.y+this.rect.height/2;chartCtx.Rotate(rotateAnchor,hGetRadian.call(this));}lineCount=this.mSubTextHolder.GetLineCount();singleLineHeight=this.mFontHeight+this.mTextLineSpace;heightEdgeMargin=Math.max((this.rect.height-singleLineHeight*lineCount)/2,0);for(i=0;i<lineCount;i++){textStartPoint.x=this.rect.x;textStartPoint.y=this.rect.y+heightEdgeMargin+(i+1)*this.mFontHeight;hFormatSingleLineText.call(this,textStartPoint,i,drawByWord);}if(formatFont.mFontRotation!==$FR.FR_NORMAL){chartCtx.RestoreState();}chartCtx.FinishDrawText(this.mTripleId,{OnMarker:this.mOnMarker,Tooltip:this.mIsTruncated?this.mText:null,Identities:this.IdentityMap,Identity:this.identity});},getFormatFromParent:function getFormatFromParent(){var p=this.mpParentObject;this.mFormatLinePtr=p.mFormatLinePtr;this.mFormatFillPtr=p.GetFormatFill();this.mFormatFontPtr=p.GetFormatFont();},GetBoundingRectNoRotation:function GetBoundingRectNoRotation(intact){if(!this.mIsRectCalculated){this.CalculateDeviceRect();}intact=intact||false;if(intact){return this.rect;}return new $C.Rect2D({Rect2D:this.rect});},RestoreWidthAndHeight:function RestoreWidthAndHeight(){this.mSubTextHolder.ParseText(this.mText," ",-1);this.rect.width=0;this.rect.height=0;this.mTextWidthLimit=-1;this.mIsStringent=true;this.mLineCount=-1;this.CalculateDeviceRect();},Restore:function Restore(props){if(props===undefined){this.RestoreWidthAndHeight();return ;}this.rect.width=0;this.rect.height=0;this.rect.x=0;this.rect.y=0;this.mTextWidthLimit=(props.TextWidthLimit!==undefined)?props.TextWidthLimit:-1;this.mLineCount=(props.LineCount!==undefined)?props.LineCount:-1;this.mIsStringent=(props.Stringent!==undefined)?props.Stringent:true;if(props.Restroke!==undefined&&props.Restroke){this.SetText(this.mText,this.mTextWidthLimit);}},GetOneLineHeight:function GetOneLineHeight(){return this.mFontHeight;},getWidthHeightMargin:function getWidthHeightMargin(isWidth){return isWidth?this.mWidthEdgeMargin:this.mHeightEdgeMargin;},possibleTruncate:function possibleTruncate(){return this.mTextWidthLimit>0&&this.rect.width>this.mTextWidthLimit&&!this.mIsStringent;},getDevicePolygon:function getDevicePolygon(){return hGetDevicePolygon.call(this);}});}());