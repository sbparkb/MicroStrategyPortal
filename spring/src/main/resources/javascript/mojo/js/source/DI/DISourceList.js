(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.List","mstrmojo.Pulldown","mstrmojo.ui.ButtonBar","mstrmojo.hash","mstrmojo.DI.DIConstants","mstrmojo.DI.DIHelpers","mstrmojo.Table","mstrmojo.DI.DIDatabaseImportOption","mstrmojo.DI.DISourceItem","mstrmojo.ui.CheckList","mstrmojo.array","mstrmojo.ui.SearchBox");mstrmojo.requiresDescs(10,489,1563,2461,4700,9095,9096,9097,9098,9100,9213,9214,10213,12459,12666,12726,12727,12758,12889,12890,13027,13416,13961,14101,14102,14103,14104,14208,14209,14210,14211,14212,14213);var $DOM=mstrmojo.dom,$A=mstrmojo.array,constants=mstrmojo.DI.DIConstants,$HELPER=mstrmojo.DI.DIDatabaseHelper,pageType=constants.pageType,sourceItem="mstrmojo.DI.DISourceItem",GRID_MODE=0,LIST_MODE=1,EMPTY_SEARCH_TEXT=mstrmojo.desc(12666,"Search..."),maxRows=24,numOfcols=4,maxRows_narrow=17,CACHE_WIDTH,CACHE_COLS;function getAdvSearchItems(){var items=[];if(mstrApp.diParams.ImportDatabase===1){items.push({n:mstrmojo.desc(14208,"BI"),did:0,v:"BI"});items.push({n:mstrmojo.desc(14209,"BigData"),did:1,v:"BigData"});}if(mstrApp.diParams.AccessDataFromCloudApp===1||mstrApp.diParams.AccessDataFromFiles===1){items.push({n:mstrmojo.desc(14210,"Cloud"),did:2,v:"Cloud"});}if(mstrApp.diParams.ImportDatabase===1){if(!mstrApp.isSingleTier){items.push({n:mstrmojo.desc(14211,"Cube"),did:3,v:"Cube"});}items.push({n:mstrmojo.desc(1563,"Database"),did:4,v:"Database"});}if(mstrApp.diParams.AccessDataFromFiles===1){items.push({n:mstrmojo.desc(489,"File"),did:5,v:"File"});}if(mstrApp.diParams.ImportDatabase===1){items.push({n:mstrmojo.desc(12758,"Hadoop"),did:6,v:"Hadoop"});if(!mstrApp.isSingleTier){items.push({n:mstrmojo.desc(13416,"OLAP"),did:9,v:"OLAP"});}items.push({n:mstrmojo.desc(14212,"NoSQL"),did:8,v:"NoSQL"});if(!mstrApp.isSingleTier){items.push({n:mstrmojo.desc(10,"Search"),did:11,v:"Search"});}}if(mstrApp.diParams.AccessDataFromCloudApp===1){items.push({n:mstrmojo.desc(14213,"Social"),did:12,v:"Social"});}return items;}function ddaVisible(){var model=mstrApp.getRootController().model;if(mstrApp.showDDAOptions===false){return false;}if(mstrApp.diParams.ImportDatabase===0){return false;}if(model.currentDataset){return false;}var count=0,prop,sources=model.importSources;for(prop in sources){if(sources.hasOwnProperty(prop)){count++;}}return count<1;}var tagConfig={scriptClass:"mstrmojo.Container",markupString:"<div class='mstrmojo-di-search-tag' mstrAttach:click ><div></div><div></div></div>",markupSlots:{containerNode:function(){return this.domNode;},contentNode:function(){return this.domNode.children[0];},deleteNode:function(){return this.domNode.children[1];}},tag:"",children:[{scriptClass:"mstrmojo.Label",alias:"tagName",slot:"contentNode",cssClass:"mstrmojo-di-search-tag-name"},{scriptClass:"mstrmojo.Button",slot:"deleteNode",cssClass:"mstrmojo-di-tag-delete-button",innerIconClass:"close-button"}],preBuildRendering:function(){if(this._super){this._super();}this.tagName.text=this.tag;},onclick:function(){var tagList=this.parent;tagList.removeChildren();var filterTags=tagList.parent.filterTags;var index=$A.find(filterTags,"n",this.tag);if(index>-1){$A.removeIndices(filterTags,index,1);}tagList.parent.raiseEvent({name:"filterTagsChange"});}};function composeSourceListChildren(items,hasFilterTag,keyWord){var row=0,col=0,SAP_HAHA_DBTYPE=4000;var initials={},children=[],text;var index=0;var $this=this;var isFilterDDA=$this.isFilterDDA;var dbItems=[];var dbTypes=[];var model=mstrApp.getRootController().getModel();var sourceItemClickFn=function sourceItemClickFn(evt){var target=mstrmojo.dom.findWidget(evt.getTarget());if(target===this.dbList){mstrmojo.css.addClass(this.domNode,"selected");}else{if(target.alias==="closeList"){mstrmojo.css.removeClass(this.domNode,"selected");}else{if(this.parent.parent.mode===LIST_MODE){if(target.sourceInfo.type===constants.sourceType.googleBigQuery){mstrApp.getRootController().showDialog(constants.dialogType.qbImportOptionDialog,{isODBC:true,srcInfo:target.sourceInfo});}else{if(target.dbTypes){dbTypes=$HELPER.getUniqueDBTypes(target.dbTypes);$A.forEach(dbTypes,function(dbType){if(!isFilterDDA||model.canAddToDDACube(target.sourceInfo.subtype,dbType)){dbItems.push(dbType);}});mstrApp.dbTypes=dbItems;}else{mstrApp.dbTypes=[target.dbType];}mstrApp.supportDBObjects=mstrApp.getRootController().model.supportDBObjects;mstrApp.dbObjectsDisplayOptions=target.dbObjectsDisplayOptions;if(target.dbObjectsDisplayOptions===16){mstrApp.dbRolesVersionExcludeFilter=[17,18,21,22,23,24,25,37,45,46,47,48,63,66,74,89,92,101,103,105,123,134,157,172,202,232];}if(target.dbIds){mstrApp.dbIds=target.dbIds;}else{mstrApp.dbIds=target.dbId?[].concat(target.dbId):undefined;}if(target.showImportOption){mstrApp.getRootController().showDialog(constants.dialogType.qbImportOptionDialog,(target.dbType===SAP_HAHA_DBTYPE)?{isSAPHana:true}:{isODBC:true});}else{$this.selectedSource=this;$this.onNextButtonClick(evt);}}}}}};var maxCol=hasFilterTag?numOfcols:numOfcols+1;var initialsAmount=0;var max_row=maxRows_narrow;if(hasFilterTag&&CACHE_WIDTH<940){maxCol-=1;}CACHE_COLS=maxCol;$A.forEach(items,function(item){if(!initials[item.initial]){initialsAmount++;initials[item.initial]=true;}});initials={};var childrenAmount=initialsAmount+items.length;if(childrenAmount>maxCol*maxRows_narrow){max_row=childrenAmount/maxCol+1;}$A.forEach(items,function(item){if(!initials[item.initial]){children.push({scriptClass:"mstrmojo.Label",text:item.initial,cssClass:"initial",slot:row+","+col});row++;initials[item.initial]=true;if(row>=max_row){row=0;col++;}}if(keyWord){index=item.n.toLowerCase().indexOf(keyWord.toLowerCase());if(index!==-1){text=item.n.substring(0,index)+'<span style="font-weight: bold;">'+item.n.substring(index,index+keyWord.length)+"</span>"+item.n.substr(index+keyWord.length);}}item.slot=row+","+col;if(item.isEnabled){item.enabled=item.isEnabled();}if(typeof item.title==="function"){item.title=item.title();}children.push(mstrmojo.hash.copy(item,{scriptClass:"mstrmojo.Label",allowHTML:true,text:text||item.n,onclick:sourceItemClickFn,tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){var pos=$DOM.position(this.domNode);if(this.title!==undefined){this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-V",top:Math.max(pos.y,0),left:Math.max(pos.x+4,0),posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:this.title});}}}));row++;if(row>=max_row){row=0;col++;}});return children;}mstrmojo.DI.DISourceList=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup,mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.DI.DISourceList",cssClass:"mstrmojo-di-sources",selectedSource:null,filterTags:[],mode:GRID_MODE,hasDDAOnlySource:true,isFilterDDA:true,isSAPHana:false,markupString:'<div id="{@id}" class="mstrmojo-di-sources {@cssClass}" mstrAttach:mousedown ><div class="mstrmojo-di-source-datasets"></div><div class = "mstrmojo-di-source-content"></div><div class = "mstrmojo-di-search-tags"></div></div>',markupSlots:{datasetsNode:function(){return this.domNode.children[0];},allSourceNode:function(){return this.domNode.children[1];},searchTagsNode:function(){return this.domNode.children[2];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},onmodeChange:function(){var model=mstrApp.getRootController().model;if(this.mode===LIST_MODE){if(!this.sourceList.children){this.populateSources();}this.updateViewByMode();if(model.isDirectDataAccess!==this.sourceList.ddaList){this.update();}}else{if(!this.sourceTable.children){this.populateSources();}this.updateViewByMode();if(model.isDirectDataAccess!==this.sourceTable.ddaList){this.update();}}this.persistViewMode();},onhasDDAOnlySourceChange:function(){if(this.hasRendered){this.update();}},updateViewByMode:function updateViewByMode(){var model=mstrApp.getRootController().model;if(this.mode===LIST_MODE){this.sourceList.set("visible",true);this.sourceTable.set("visible",false);this.searchTagsNode.style.display="block";this.sourceView.set("selectedIndex",1);}else{this.sourceList.set("visible",false);this.sourceTable.set("visible",true);this.searchTagsNode.style.display="none";this.sourceView.set("selectedIndex",0);}if(model.isDirectDataAccess){this.allddatabs.children[0].set("selectedIndex",1);}else{this.allddatabs.children[0].set("selectedIndex",0);}},onfilterTagsChange:function(){var $this=this,filterTags={},children;var model=mstrApp.getRootController().model;var filteredItems=model.sourceList;this.searchTagList.removeChildren();$A.forEach(this.filterTags,function(item){tagConfig.tag=item.n;$this.searchTagList.addChildren([mstrmojo.insert(tagConfig)]);filterTags[item.v]=true;});if(this.filterTags.length!==0){filteredItems=mstrApp.getRootController().filterSourcesbyTag(model.sourceList,filterTags,numOfcols);}if(model.isDirectDataAccess){filteredItems=mstrApp.getRootController().filterSourcesByDDA(filteredItems);}if(!mstrApp.isSingleTier){filteredItems=mstrApp.getRootController().filterSourcesByPrivileges(filteredItems);}else{filteredItems=mstrApp.getRootController().filterSourcesForOneTier(filteredItems);}if(this.searchBox.inputNode.value!==""&&this.searchBox.inputNode.value!==EMPTY_SEARCH_TEXT){filteredItems=mstrApp.getRootController().filterSourcesByText(filteredItems,this.searchBox.inputNode.value,numOfcols);}children=composeSourceListChildren.call($this,filteredItems,this.filterTags.length!==0);mstrmojo.css.toggleClass(this.sourceList.domNode,"narrow",this.filterTags.length>0);this.sourceList._set_children("children",children);},persistViewMode:function persitViewMode(){mstrApp.getRootController().rootView.setHomepageViewMode(this.mode);},children:[{scriptClass:"mstrmojo.Box",slot:"datasetsNode",cssClass:"mstrmojo-di-source-datasets-box cf",bindings:{visible:function(){var ds=$A.filter(mstrApp.getRootController().model.datasets||[],function(item){return !item.hcs;});return ds&&ds.length>1&&!mstrApp.diParams.isEdit&&!mstrApp.getRootController().model.hasEMMAReportInstance();}},children:[{scriptClass:"mstrmojo.Label",cssClass:"dataset-box-label",text:mstrmojo.desc(13027,"Add to:")},{scriptClass:"mstrmojo.ui.Pulldown",bindings:{items:function(){var dsArray=[];$A.forEach(mstrApp.getRootController().model.datasets||[],function(item){if(!item.hcs){dsArray.push({id:item.did,n:item.name});}});return dsArray;}},onitemSelected:function onitemSelected(item){var model=mstrApp.getRootController().getModel(),idx=$A.find(model.datasets,"did",item.id);if(idx>-1){model.selectDataset(model.datasets[idx]);this.parent.parent.set("hasDDAOnlySource",model.datasets[idx].did===-1);this.parent.parent.allddatabs.set("visible",ddaVisible());}},preBuildRendering:function preBuildRendering(){if(this._super){this._super();}if(this.items.length>0){this.selectedIndex=0;}}}]},{alias:"sourceView",slot:"allSourceNode",scriptClass:"mstrmojo.ui.ButtonBar",cssClass:"mstrmojo-di-source-view",renderOnScroll:false,selectedIndex:0,postselectionChange:function(evt){var value=evt.added&&this.items[evt.added[0]].v;this.parent.set("mode",value);},items:[{v:GRID_MODE,css:"grid"},{v:LIST_MODE,css:"list"}]},{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-di-source-direct-access-container",slot:"allSourceNode",alias:"allddatabs",bindings:{visible:function(){return ddaVisible();}},children:[{scriptClass:"mstrmojo.ui.ButtonBar",renderOnScroll:false,showIcon:false,selectedIndex:0,postselectionChange:function(evt){var controller=mstrApp.getRootController(),model=controller.model,value=evt.added&&this.items[evt.added[0]].v,isDDA=!!value;if(model.isDirectDataAccess!==isDDA){controller.getDDAController().setDirectDataAccess(isDDA);model.origIsDirectDataAccess=isDDA;this.parent.parent.update();}},items:[{n:mstrmojo.desc(2461,"All"),v:0},{n:mstrmojo.desc(12726,"Connect Live"),v:1}]}]},{scriptClass:"mstrmojo.Button",slot:"allSourceNode",alias:"dropDownBtn",cssClass:"mstrmojo-di-source-search-button",onclick:function(){this.parent.showEditorConfig();},bindings:{visible:function(){return this.parent.mode===LIST_MODE;}}},{scriptClass:"mstrmojo.Label",slot:"allSourceNode",text:mstrmojo.desc(12727,"Advanced Search"),cssClass:"mstrmojo-di-source-search-label",bindings:{visible:function(){return this.parent.mode===LIST_MODE;}},onclick:function(){this.parent.showEditorConfig();}},{scriptClass:"mstrmojo.ui.SearchBox",markupString:'<div id={@id} class="mstrmojo-ui-SearchBox cf {@cssClass}" style="{@cssText}"><input class="mstrmojo-ui-sb-input" type="text" placeholder="{@emptyText}" mstrAttach:keyup,blur/><div class="mstrmojo-ui-sb-btn" mstrAttach:click ></div></div>',searchDelay:0,cssClass:"mstrmojo-di-source-search",slot:"allSourceNode",alias:"searchBox",emptyText:EMPTY_SEARCH_TEXT,bindings:{visible:function(){return this.parent.mode===LIST_MODE;}},searchTriggered:function(value){this.parent.onSearch(value);}},{scriptClass:"mstrmojo.Box",alias:"sourceTable",cssClass:"mstrmojo-di-sourceGrid",slot:"allSourceNode",ddaList:false},{scriptClass:"mstrmojo.Table",alias:"sourceList",cssClass:"mstrmojo-di-sourceList",slot:"allSourceNode",visible:false,rows:maxRows,cols:5,ddaList:false},{scriptClass:"mstrmojo.Label",slot:"searchTagsNode",text:mstrmojo.desc(12889,"Returned results are related to:"),bindings:{visible:function(){return this.parent.filterTags.length>0;}}},{scriptClass:"mstrmojo.VBox",slot:"searchTagsNode",alias:"searchTagList"}],showEditorConfig:function(){var diSourceList=this;var cfgEditor=new mstrmojo.ui.menus.EditorConfig({hostId:this.id,hostElement:this.dropDownBtn.domNode,isHostedWithin:false,hostProxyCssClass:"item-mn-proxy",cssClass:"searchTagMenu",contents:new mstrmojo.ui.CheckList({multiSelect:true,orientation:"v",itemIdField:"did",alias:"list",items:getAdvSearchItems.call()}),data:{}});cfgEditor.fnOk=function(){var selectedItems=cfgEditor.contents.getSelectedItems();diSourceList.set("filterTags",selectedItems);};var listEditor=cfgEditor.newInstance();if(this.filterTags&&this.filterTags.length>0){listEditor.list.selectItems(this.filterTags);}this.openPopup(listEditor);},preBuildRendering:function(){if(this._super){this._super();}var model=mstrApp.getRootController().getModel();this.populateSources();model.attachEventListener("isDirectDataAccessChange",this.id,this.update);model.attachEventListener("windowSizeChanged",this.id,this.adjustSize);},adjustSize:function(evt){var width=Math.floor(parseInt(evt.size.w,10)),numCols,margin;if(isNaN(width)||width<0||!this.domNode){return ;}numCols=Math.floor(width/160);if(numCols>0){margin=Math.floor((width-numCols*160)/2);if(margin<20){numCols--;margin=Math.floor((width-numCols*160)/2);}}if(margin>0){this.sourceTable.domNode.style.marginLeft=margin+"px";}if(this.sourceList&&this.sourceList.domNode){this.sourceList.domNode.children[0].style.width=(width-28)+"px";if(width-630<200){this.dropDownBtn.domNode.style.marginRight=(width-630)+"px";}if(this.filterTags.length>0){if(width<940&&CACHE_COLS!==3){this.onfilterTagsChange();}else{if(width>=940&&CACHE_COLS===3){this.onfilterTagsChange();}}}}CACHE_WIDTH=width;},postBuildRendering:function(){if(this._super){this._super();}this.updateViewByMode();},populateSources:function populateSources(){var controller=mstrApp.getRootController(),model=mstrApp.getRootController().getModel(),items,hasNonSAPHana=this.hasNonSAPHana,selectedSourceItem;selectedSourceItem=$A.filter(model.sourceItems,function(item){return item.selected!==false;});if(this.mode===GRID_MODE){if(this.parent.parent&&this.parent.parent.items){items=this.parent.parent.items;}else{if(this.isSAPHana){items=[model.sourceItems[2]];items[0].isSAPHanaDDA=true;}else{items=this.isFilterDDA&&model.isDirectDataAccess?mstrApp.getRootController().filterSourcesByDDA(selectedSourceItem):selectedSourceItem;$A.forEach(items,function(item){item.hasNonSAPHana=hasNonSAPHana;item.isSAPHanaDDA=false;});}}items=controller.filterSourcesByDDAOnly(items,this.hasDDAOnlySource);if(mstrApp.isSingleTier){items=mstrApp.getRootController().filterSourcesForOneTier(items);}else{items=mstrApp.getRootController().filterSourcesByPrivileges(items);}var enabledItem=[],disabledItem=[];$A.forEach(items,function(item){if(item.bindings.enabled()){enabledItem.push(item);}else{disabledItem.push(item);}});items=enabledItem.concat(disabledItem);if($A.find(items,"alias","suggest")<0){items=items||[];items.push({scriptClass:sourceItem,icon:"ds_suggest",n:mstrmojo.desc(12890,"Suggest a Data Source"),desc:mstrmojo.desc(12459,"Is your data source not available? Tell us which source it is and why it is important to you."),pageType:pageType.suggestNewSource,alias:"suggest",sourceInfo:0});}this.sourceTable.addChildren(items);}else{if(this.mode===LIST_MODE){if(model.sourceList.length===0&&mstrApp.diParams.ImportDatabase===1){model.attachEventListener("dbTypeFetched",this.id,this.populateListView);mstrApp.showProgress();}else{if(mstrApp.diParams.ImportDatabase===0){model.sourceList=model.staticSourceList;}this.populateListView();}}}},populateListView:function populateListView(){var controller=mstrApp.getRootController(),model=mstrApp.getRootController().getModel(),filterTags={},items=model.isDirectDataAccess?mstrApp.getRootController().filterSourcesByDDA(model.sourceList):model.sourceList;items=controller.filterSourcesByDDAOnly(items,this.hasDDAOnlySource);$A.forEach(this.filterTags,function(item){filterTags[item.v]=true;});if(this.filterTags.length!==0){items=mstrApp.getRootController().filterSourcesbyTag(items,filterTags,numOfcols);}if(this.searchBox.inputNode&&this.searchBox.inputNode.value!==""&&this.searchBox.inputNode.value!==EMPTY_SEARCH_TEXT){items=mstrApp.getRootController().filterSourcesByText(items,this.searchBox.inputNode.value,numOfcols);}if(mstrApp.isSingleTier){items=mstrApp.getRootController().filterSourcesForOneTier(items);}else{items=mstrApp.getRootController().filterSourcesByPrivileges(items);}var children=composeSourceListChildren.call(this,items,this.filterTags.length!==0);this.sourceList.addChildren(children);mstrApp.hideProgress();},update:function update(){var model=mstrApp.getRootController().model;if(this.mode===GRID_MODE){this.sourceTable.removeChildren();this.sourceTable.ddaList=model.isDirectDataAccess;}if(this.mode===LIST_MODE){this.sourceList.removeChildren();this.sourceList.ddaList=model.isDirectDataAccess;}this.populateSources();},onSearch:function(keyWord){var model=mstrApp.getRootController().model;var filteredItems=mstrApp.getRootController().filterSourcesByText(model.sourceList,keyWord,numOfcols);if(this.filterTags.length!==0){var filterTags={};$A.forEach(this.filterTags,function(item){filterTags[item.v]=true;});filteredItems=mstrApp.getRootController().filterSourcesbyTag(filteredItems,filterTags,numOfcols);}if(model.isDirectDataAccess){filteredItems=mstrApp.getRootController().filterSourcesByDDA(filteredItems);}if(!mstrApp.isSingleTier){filteredItems=mstrApp.getRootController().filterSourcesByPrivileges(filteredItems);}else{filteredItems=mstrApp.getRootController().filterSourcesForOneTier(filteredItems);}var children=composeSourceListChildren.call(this,filteredItems,this.filterTags.length!==0,keyWord);this.sourceList._set_children("children",children);},onmousedown:function(evt){if(evt&&evt.e&&evt.e.button===1){evt.preventDefault();evt.cancel();}},onNextButtonClick:function(evt){var controller=mstrApp.getRootController(),item=this.selectedSource,slot;if(item.enabled){if(mstrApp.isSingleTier&&item.checkConectivity&&window.FormWrapper.testInternetConnection()!==0){var errorMessage=mstrmojo.desc(13961,"No Internet connection. You can configure an Internet proxy through your computer's #."),replaceStr='<a href="" onclick="mstrApp.getRootController().dialogController.close(mstrmojo.DI.DIConstants.dialogType.errorDialog);mstrApp.getRootController().wrapUpDataImport();window.setTimeout(function(){window.FormWrapper.showProxyEditor();},100);return false;">'+mstrmojo.desc(14125,"settings")+"</a>";errorMessage=errorMessage.replace("#",replaceStr)+".";controller.displayError(errorMessage,false,"",null,mstrmojo.desc(11812,"Notification"));return ;}slot=mstrApp.getRootController().navigationController.getPageSlot();var properties={operationMode:constants.operationMode.create};if(item.mode){properties.mode=item.mode;}slot.setConfig({properties:properties});item.sourceInfo.evt=evt;controller.showPage(item.pageType,item.sourceInfo,slot);}},onHelpButtonClick:function onHelpButtonClick(){return"About_importing_data.htm";}});}());