(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.css","mstrmojo.string","mstrmojo.dom","mstrmojo.boxmodel","mstrmojo.vi.ui.rw.RichTooltipBox","mstrmojo.vi.ui.rw.ImageBoxOverlay","mstrmojo.vi.ui.rw.ImageBoxOverlayEmbeded");mstrmojo.requiresDescs(3415,10493,12277,12963,14634);var $CSS=mstrmojo.css,$STR=mstrmojo.string,$HASH=mstrmojo.hash,$PX2INCHES=mstrmojo.boxmodel.px2Inches,$DOM=mstrmojo.dom,EMBEDDED_IMAGE_DUMMY_NAME=mstrmojo.desc(14634,"Embedded_Image");function toggleOverlay(){if(this.boxContent&&$STR.isEmpty(this.boxContent.origV)){this.showControlOverlay(this.getEditOverlayControls());applyOverlayDimension.call(this,this.height,this.width);}else{this.hideControlOverlay();}}function applyOverlayDimension(height,width){var ctrlOverlay=this.ctrlOverlay;if(ctrlOverlay&&ctrlOverlay.imageBoxOverlay){var imageBoxOverlay=ctrlOverlay.imageBoxOverlay;imageBoxOverlay.set("height",height);imageBoxOverlay.set("width",width);imageBoxOverlay.doLayout();}}mstrmojo.vi.ui.rw.ImageBox=mstrmojo.declare(mstrmojo.vi.ui.rw.RichTooltipBox,null,{scriptClass:"mstrmojo.vi.ui.rw.ImageBox",ctrlOverlay:null,mode:"o",fw:100,fh:100,lock:true,isDynamicTooltip:true,tooltipTopOffset:35,isEmbedded:false,isEmbeddedImageFeatureEnabled:true,embeddedImageName:undefined,init:function init(props){this._super(props);var defn=this.defn,fmts=defn&&defn.fmts,imgName=fmts&&fmts["img-name"];this.isEmbeddedImageFeatureEnabled=!!mstrApp.enableEmbeddedImages&&!$DOM.isIE9;this.isEmbedded=!!defn&&defn.oid;this.embeddedImageName=(imgName)?decodeURIComponent(imgName):EMBEDDED_IMAGE_DUMMY_NAME;$CSS.addWidgetCssClass(this,"mstrmojo-ImageBox");},getDisplayName:function getDisplayName(){return this.defn.n||mstrmojo.desc(2922,"Image");},applyBoxSize:function applyBoxSize(height,width,top,left){this._super(height,width,top,left);var newOrientation=parseInt(width,10)>=302?"h":"v";if(newOrientation!==this.orientation){this.set("orientation",newOrientation);}var boxContent=this.boxContent;boxContent.fw=this.fw;boxContent.fh=this.fh;boxContent.mode=this.mode;boxContent.lock=this.lock;if(boxContent.hasRendered){boxContent.refresh();}applyOverlayDimension.call(this,height,width);},getBoxDimension:function getBoxDimension(orientation){return(orientation==="h")?{f:false,l:null}:{f:true,l:40};},getAvatarCls:function getAvatarCls(){return this._super().concat(["imageAvatar"]);},createDeleteUpdate:function createDeleteUpdate(){return this.model.getRemoveFieldUpdate(this);},postBuildRendering:function postBuildRendering(){this._super();toggleOverlay.call(this);this.addDragHandle();var boxContent=this.boxContent;this.toggleDragHandleVisibility(boxContent.hasActiveLink()&&boxContent.v);},updateOverlay:function updateOverlay(){toggleOverlay.call(this);var boxContent=this.boxContent;this.toggleDragHandleVisibility(boxContent.hasActiveLink()&&boxContent.v);},showControlOverlay:function showControlOverlay(controls){this._super(controls);this.boxContent.set("visible",false);},hideControlOverlay:function hideControlOverlay(){this._super();this.boxContent.set("visible",true);},urlEdited:function urlEdited(newURL){this.boxContent.v=newURL;this.isEmbedded=false;this.refresh();this.boxContent._isNewUrl=true;},localImageAdded:function localImageAdded(para){var docImg=this.boxContent;para.fieldKey=docImg.k;para.fieldName=docImg.defn&&docImg.defn.n||docImg.k;para.nodeKey=docImg.defn.pnk;para.sectionKey=docImg.defn.pnk;para.fieldGroupKey=docImg.defn.fgk;var me=this;var callback={success:function(res){me.boxContent.v=para.base64Str;me.isEmbedded=true;me.refresh();me.boxContent._isNewEmbeddedImg=true;},complete:function(){mstrApp.hideWait();}};mstrApp.showWait({message:mstrmojo.desc(12963,"Uploading File...")});this.model.controller.uploadImageToServer(para,callback);},addFormatProps:function addFormatProps(action,skipPartialRetrieval){var content=this.boxContent,model=this.model;action=this._super(action,skipPartialRetrieval)||this.model.getUnitFormatAction(this,NaN,null,skipPartialRetrieval);if(content&&!$STR.isEmpty(content.origV)){var formatAction=action.format=$HASH.copy(action.format,{FormattingSize:{}});formatAction.FormattingSize.ImageWidth=$PX2INCHES(model.getZoomProps(),parseFloat(content.getImageWidth()));formatAction.FormattingSize.ImageHeight=$PX2INCHES(model.getZoomProps(),parseFloat(content.getImageHeight()));}return action;},getEditOverlayControls:function getOverlayControls(){return[{scriptClass:this.isEmbeddedImageFeatureEnabled?"mstrmojo.vi.ui.rw.ImageBoxOverlayEmbeded":"mstrmojo.vi.ui.rw.ImageBoxOverlay",alias:"imageBoxOverlay",imageBox:this,defn:this.defn}];},switchToEditMode:function switchToEditMode(){var ctrlOverlay=this.ctrlOverlay;if(ctrlOverlay.visible){ctrlOverlay.imageBoxOverlay.imgURL.focus();return ;}this._super();applyOverlayDimension.call(this,this.height,this.width);var origV=this.boxContent.origV,imgURL=ctrlOverlay.imageBoxOverlay.imgURL;if(this.isEmbedded){imgURL.set("value",this.embeddedImageName);ctrlOverlay.imageBoxOverlay.origURLStr=this.embeddedImageName;}else{if(origV){imgURL.set("value",origV);ctrlOverlay.imageBoxOverlay.origURLStr=origV;}}imgURL.focus();}});mstrmojo.vi.ui.rw.ImageBox.boxConfiguration={f:{h:166,v:76},minSize:{h:38,v:40},o:"v"};}());