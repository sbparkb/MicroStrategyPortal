(function(){mstrmojo.requiresCls("mstrmojo.Base");mstrmojo.requiresClsP("mstrmojo.chart","GraphObject","FormatLine","Vector2D","Point2D");var $C=mstrmojo.chart,sTolerance=1e-14,sWeakTolerance=0.1,sSplitTolerance=0.001,sSqrt3=1.732050807568877;function hGetTaoFromX(valueX){return(valueX-this.mP0.x)/(this.mP3.x-this.mP0.x);}function hHaveSameY(){return(this.mP0.y===this.mP1.y)&&(this.mP1.y===this.mP2.y)&&(this.mP2.y===this.mP3.y);}function hEvaluate(s){var t=1/(s+1);return(((this.mP0.y*s+3*this.mP1.y)*s+3*this.mP2.y)*s+this.mP3.y)*t*t*t;}function hEvaluateDerivative(s){var t=1/(s+1);return(((this.mP1.y-this.mP0.y)*s+2*(this.mP2.y-this.mP1.y))*s+this.mP3.y-this.mP2.y)*t*t/(this.mP1.x-this.mP0.x);}function hSplit(tao){var p01=(1-tao)*this.mP0.y+tao*this.mP1.y,p11=(1-tao)*this.mP1.y+tao*this.mP2.y,p21=(1-tao)*this.mP2.y+tao*this.mP3.y,p02=(1-tao)*p01+tao*p11,p12=(1-tao)*p11+tao*p21,p03=(1-tao)*p02+tao*p12,splitPoint=new $C.Point2D({x:((1-tao)*this.mP0.x+tao*this.mP3.x),y:p03}),curve=new $C.BezierCurve({P0:splitPoint,P1:p12,P2:p21,P3:this.mP3,IsVertical:this.mIsVertical,IsXAlwaysIndependent:true});this.mP3=splitPoint;this.mP1.Reset((2*this.mP0.x+this.mP3.x)/3,p01);this.mP2.Reset((this.mP0.x+2*this.mP3.x)/3,p02);return curve;}function hSolveQuadraticEquation(a,b,c,positiveRoots){var root;if(-sTolerance<a&&a<sTolerance){if(-sTolerance<b&&b<sTolerance){return ;}root=-c/(2*b);if(root<sTolerance){return ;}positiveRoots.push(root);return ;}var lDelta=b*b-a*c;if(lDelta<-sTolerance){return ;}if(-sTolerance<lDelta&&lDelta<sTolerance){root=-b/a;if(root<sTolerance){return ;}positiveRoots.push(root);return ;}var sqrtDelta=Math.sqrt(lDelta),root1=(-b+sqrtDelta)/a,root2=(-b-sqrtDelta)/a;if(root1>sTolerance){positiveRoots.push(root1);}if(root2>sTolerance){positiveRoots.push(root2);}}function hCubicRoot(value){var sign=(value<0)?-1:1;return sign*Math.pow(sign*value,1/3);}function hSolveCubicEquation(a,b,c,d,positiveRoots){if(-sTolerance<=a&&a<=sTolerance){hSolveQuadraticEquation.call(this,3*b,3*c/2,d,positiveRoots);return ;}var b1=b/a,c1=c/a,d1=d/a,q=c1-b1*b1,r=(3*b1*c1-d1)/2-b1*b1*b1,delta=q*q*q+r*r;if(delta>sTolerance){var sqrtDelta=Math.sqrt(delta),root=hCubicRoot.call(this,r+sqrtDelta)+hCubicRoot.call(this,r-sqrtDelta)-b1;positiveRoots.push(root);}else{if(delta>-sTolerance){var cubicRootR=hCubicRoot.call(this,r);positiveRoots.push(2*cubicRootR-b1);positiveRoots.push((r<0?0.5:-1)*cubicRootR-b1);}else{var lRouSquared=r*r-delta,theta=Math.acos(r/Math.sqrt(lRouSquared))/3,rou1=Math.pow(lRouSquared,1/6),rou1Cos=rou1*Math.cos(theta);positiveRoots.push(2*rou1Cos-b1);var diff=sSqrt3*rou1*Math.sin(theta);positiveRoots.push(-rou1Cos-b1+diff);positiveRoots.push(-rou1Cos-b1-diff);}}positiveRoots.sort();positiveRoots.reverse();while(positiveRoots.length!==0&&positiveRoots[positiveRoots.length-1]<=sTolerance){positiveRoots.pop();}}function hGetTangentPositions(slope,positions){var p0=this.mP1.y-this.mP0.y,p1=this.mP2.y-this.mP1.y,p2=this.mP3.y-this.mP2.y,k=slope*(this.mP3.x-this.mP0.x)/3;hSolveQuadraticEquation.call(this,p0-k,p1-k,p2-k,positions);}function hSplitAtPositions(positions,splitCurves){positions.sort();positions.reverse();var previousTao=1;while(positions.length!==0){var tao=1/(positions[positions.length-1]+1);tao*=previousTao;positions.pop();var x=this.mP0.x+(this.mP3.x-this.mP0.x)*tao;if(Math.abs(x-this.mP0.x)>sSplitTolerance&&Math.abs(this.mP3.x-x)>sSplitTolerance){previousTao=tao;splitCurves.push(hSplit.call(this,tao));}}splitCurves.reverse();}function hMakeXAscending(){if(this.mP0.x<this.mP3.x){return ;}this.mP0.swapPoints(this.mP3);var temp=this.mP1;this.mP1=this.mP2;this.mP2=temp;}function hGetSubCurve(valueX,isRightPart){var tempCurve=this.Clone();hMakeXAscending.call(tempCurve);if(valueX-tempCurve.mP0.x<sTolerance){return isRightPart?tempCurve:null;}if(tempCurve.mP3.x-valueX<sTolerance){return isRightPart?null:tempCurve;}var rightCurve=hSplit.call(tempCurve,hGetTaoFromX.call(tempCurve,valueX));return isRightPart?rightCurve:tempCurve;}function hMakeDeltaBezier(bezierCurve){this.mP0.y-=bezierCurve.mP0.y;this.mP1.y-=bezierCurve.mP1.y;this.mP2.y-=bezierCurve.mP2.y;this.mP3.y-=bezierCurve.mP3.y;}function hGetXRoots(xRoots){var positions=[],i;hSolveCubicEquation.call(this,this.mP0.y,this.mP1.y,this.mP2.y,this.mP3.y,positions);if(positions.length===0){return ;}var numberOfPositions=positions.length;for(i=0;i<numberOfPositions;++i){var lX=(positions[i]*this.mP0.x+this.mP3.x)/(positions[i]+1);xRoots.push(lX);}}function hHasIntersection(start,end){var curveLeftX=this.getMinX(),curveRightX=this.getMaxX(),leftX=Math.min(start.x,end.x),rightX=Math.max(start.x,end.x);if(rightX-curveLeftX<sWeakTolerance||curveRightX-leftX<sWeakTolerance){return false;}if(rightX-leftX<sWeakTolerance){var lY=this.evaluate(start.x);return(lY-start.y)*(end.y-lY)>-sWeakTolerance;}leftX=Math.max(curveLeftX,leftX);rightX=Math.min(curveRightX,rightX);var lineSlope=(end.y-start.y)/(end.x-start.x),lineLeftY=start.y+lineSlope*(leftX-start.x),lineRightY=start.y+lineSlope*(rightX-start.x);return(this.evaluate(leftX)-lineLeftY)*(this.evaluate(rightX)-lineRightY)<-sWeakTolerance;}function hGetIntersections(bezierCurve,intersections){var currentMinX=this.getMinX(),currentMaxX=this.getMaxX(),inputMinX=bezierCurve.getMinX(),inputMaxX=bezierCurve.getMaxX();if(currentMaxX-sWeakTolerance<inputMinX||inputMaxX-sWeakTolerance<currentMinX){return ;}if(currentMinX>inputMinX){hGetIntersections.call(bezierCurve,this,intersections);return ;}var currentSubCurve=null,inputSubCurve=null;if(currentMaxX<inputMaxX){currentSubCurve=hGetSubCurve.call(this,inputMinX,true);inputSubCurve=hGetSubCurve.call(bezierCurve,currentMaxX,false);}else{currentSubCurve=hGetSubCurve.call(this,inputMinX,true);currentSubCurve=hGetSubCurve.call(currentSubCurve,inputMaxX,false);inputSubCurve=bezierCurve.Clone();hMakeXAscending.call(inputSubCurve);}hMakeDeltaBezier.call(currentSubCurve,inputSubCurve);hGetXRoots.call(currentSubCurve,intersections);}mstrmojo.chart.BezierCurve=mstrmojo.declare(mstrmojo.Base,null,{scriptClass:"mstrmojo.chart.BezierCurve",mP0:null,mP1:null,mP2:null,mP3:null,mIsVertical:false,init:function init(props){if(props.P0!==undefined&&props.P1!==undefined&&props.P2!==undefined&&props.P3!==undefined){this.mP0=new $C.Point2D({Point2D:props.P0});this.mP1=new $C.Point2D({Point2D:props.P1});this.mP2=new $C.Point2D({Point2D:props.P2});this.mP3=new $C.Point2D({Point2D:props.P3});this.mIsVertical=true;}if(props.P0!==undefined&&props.F1!==undefined&&props.F2!==undefined&&props.P3!==undefined){props.IsXAlwaysIndependent=props.IsXAlwaysIndependent||false;this.mP0=new $C.Point2D({Point2D:props.P0});this.mP3=new $C.Point2D({Point2D:props.P3});this.mIsVertical=props.IsVertical;if(!this.mIsVertical&&!props.IsXAlwaysIndependent){this.mP0.swap();this.mP3.swap();}if(this.mP3.x-this.mP0.x<sTolerance&&this.mP0.x-this.mP3.x<sTolerance){this.mP3.x=this.mP0.x+0.01;}this.mP1=new $C.Point2D({x:(2*this.mP0.x+this.mP3.x)/3,y:props.F1});this.mP2=new $C.Point2D({x:(this.mP0.x+2*this.mP3.x)/3,y:props.F2});}},getStartPoint:function getStartPoint(){return this.mIsVertical?this.mP0:new $C.Point2D({x:this.mP0.y,y:this.mP0.x});},getEndPoint:function getEndPoint(){return this.mIsVertical?this.mP3:new $C.Point2D({x:this.mP3.y,y:this.mP3.x});},getMinX:function getMinX(){return this.mP0.x<this.mP3.x?this.mP0.x:this.mP3.x;},getMaxX:function getMaxX(){return this.mP0.x<this.mP3.x?this.mP3.x:this.mP0.x;},getStartIndependent:function getStartIndependent(){return this.mP0.x;},getEndIndependent:function getEndIndependent(){return this.mP3.x;},GetApproximatePolygon:function GetApproximatePolygon(lineWidth,polygon){var approximateLine=[],i;this.GetApproximatePolyline(approximateLine);var derivatives=[],numberOfIntervals=approximateLine.length-1,deltaX=this.mP1.x-this.mP0.x;derivatives.push((this.mP1.y-this.mP0.y)/deltaX);for(i=1;i<numberOfIntervals;++i){var pos=numberOfIntervals/i-1;derivatives.push(hEvaluateDerivative.call(this,pos));}derivatives.push((this.mP3.y-this.mP2.y)/deltaX);var halfWidth=(lineWidth+3)/2,numberOfLinePoints=approximateLine.length,polygonSize=2*numberOfLinePoints;if(polygon===undefined){polygon=[];}for(i=0;i<polygonSize;++i){polygon.push(null);}for(i=0;i<numberOfLinePoints;++i){var normalDirection=new $C.Vector2D({x:-derivatives[i],y:1}),factor=halfWidth/normalDirection.Length(),offset=new $C.Point2D({x:normalDirection.x*factor+0.5,y:(normalDirection.y*factor+0.5)});polygon[i]=approximateLine[i].Shifted(offset);polygon[polygonSize-1-i]=approximateLine[i].NegativeShifted(offset);}if(!this.mIsVertical){for(i=0;i<polygonSize;++i){polygon[i].swap();}}},GetApproximatePolyline:function GetApproximatePolyline(polyline){var maxStep=10,minIntervals=3,numberOfIntervals=Math.floor(this.getMaxX()-this.getMinX()+0.5)/maxStep,i;numberOfIntervals=Math.max(minIntervals,numberOfIntervals);polyline.push(new $C.Point2D({x:this.mP0.x+0.5,y:this.mP0.y+0.5}));for(i=1;i<numberOfIntervals;++i){var lTao=i/numberOfIntervals;var lPos=1/lTao-1;polyline.push(new $C.Point2D({x:((1-lTao)*this.mP0.x+lTao*this.mP3.x+0.5),6:(hEvaluate.call(this,lPos)+0.5)}));}polyline.push(new $C.Point2D({x:this.mP3.x+0.5,y:(this.mP3.y+0.5)}));},isBefore:function isBefore(offset,bezierCurve){if(!this.mIsVertical){offset.swap();}if(hHasIntersection.call(bezierCurve,this.mP0,this.mP0.Shifted(offset))||hHasIntersection.call(bezierCurve,this.mP3,this.mP3.Shifted(offset))){return true;}offset.Reset(-offset.x,-offset.y);if(hHasIntersection.call(this,bezierCurve.mP0,bezierCurve.mP0.Shifted(offset))||hHasIntersection.call(this,bezierCurve.mP3,bezierCurve.mP3.Shifted(offset))){return true;}var minX=Math.max(this.getMinX(),bezierCurve.getMinX()),maxX=Math.min(this.getMaxX(),bezierCurve.getMaxX());if(minX-maxX>-0.1*sWeakTolerance){return false;}var middleX=(minX+maxX)/2,middlePoint=new $C.Point2D({x:middleX,y:bezierCurve.evaluate(middleX)});return hHasIntersection.call(this,middlePoint,middlePoint.Shifted(offset));},SplitAtTangentPoints:function SplitAtTangentPoints(offset,splitCurves){if(offset.x===0){return ;}var tangentPositions=[];hGetTangentPositions.call(this,offset.y/offset.x,tangentPositions);var numberOfTangentPositions=tangentPositions.length,splitPositions=[],i;for(i=0;i<numberOfTangentPositions;++i){var x=(tangentPositions[i]*this.mP0.x+this.mP3.x)/(tangentPositions[i]+1);if(Math.abs(this.evaluate2ndDerivative(x))>0.01*sWeakTolerance){splitPositions.push(tangentPositions[i]);}}hSplitAtPositions.call(this,splitPositions,splitCurves);},SplitAtIntersections:function SplitAtIntersections(bezierCurve,splitCurves){var intersections=[];hGetIntersections.call(this,bezierCurve,intersections);if(intersections.length===0){return ;}var splitPositions=[],i;var numberOfIntersections=intersections.length;for(i=0;i<numberOfIntersections;++i){var deltaX0=(intersections[i]-this.mP0.x);if(Math.abs(deltaX0)>sSplitTolerance){splitPositions.push((this.mP3.x-this.mP0.x)/deltaX0-1);}}if(splitPositions.length===0){return ;}hSplitAtPositions.call(this,splitPositions,splitCurves);},GetControlPoints:function GetControlPoints(points){points.push(this.mP0);points.push(this.mP1);points.push(this.mP2);points.push(this.mP3);},Reverse:function Reverse(){this.mP0.swapPoints(this.mP3);this.mP1.swapPoints(this.mP2);},MoveToStart:function MoveToStart(context,tuning){var xOffset=tuning?0.5:0,yOffset=tuning&&hHaveSameY.call(this)?0.5:0;if(this.mIsVertical){context.MoveTo(this.mP0.x+xOffset,this.mP0.y+yOffset);}else{context.MoveTo(this.mP0.y+yOffset,this.mP0.x+xOffset);}},CurveToEnd:function CurveToEnd(context,tuning){var xOffset=tuning?0.5:0,yOffset=tuning&&hHaveSameY.call(this)?0.5:0,sameXOffset=(Math.abs(this.mP0.x-this.mP1.x)<0.5)?0.5:0;if(this.mIsVertical){context.BezierCurveTo(this.mP1.x+sameXOffset,this.mP1.y+yOffset,this.mP2.x+sameXOffset,this.mP2.y+yOffset,this.mP3.x+xOffset,this.mP3.y+yOffset);}else{context.BezierCurveTo(this.mP1.y+yOffset,this.mP1.x+sameXOffset,this.mP2.y+yOffset,this.mP2.x+sameXOffset,this.mP3.y+yOffset,this.mP3.x+xOffset);}},LineToStart:function LineToStart(context,tuning){var xOffset=tuning?0.5:0,yOffset=tuning&&hHaveSameY.call(this)?0.5:0;if(this.mIsVertical){context.LineTo(this.mP0.x+xOffset,this.mP0.y+yOffset);}else{context.LineTo(this.mP0.y+yOffset,this.mP0.x+xOffset);}},GetMinMax:function GetMinMax(){var returnVal={MinY:Math.min(this.mP0.y,this.mP3.y)+0.5,MaxY:Math.max(this.mP0.y,this.mP3.y)+0.5};if((this.mP1.y>=returnVal.MinY&&this.mP2.y>=returnVal.MinY)&&(this.mP1.y<=returnVal.MaxY&&this.mP2.y<=returnVal.MaxY)){return returnVal;}var extremePositions=[];hGetTangentPositions.call(this,0,extremePositions);while(extremePositions.length!==0){var lExtremeY=(hEvaluate.call(this,extremePositions[extremePositions.length-1])+0.5);extremePositions.pop();returnVal.MinY=Math.min(returnVal.MinY,lExtremeY);returnVal.MaxY=Math.max(returnVal.MaxY,lExtremeY);}return returnVal;},Clone:function Clone(){return new $C.BezierCurve({P0:this.mP0,P1:this.mP1.y,P2:this.mP2.y,P3:this.mP3,IsVertical:this.mIsVertical,IsXAlwaysIndependent:true});},evaluate:function evaluate(independentValue){var t=(independentValue-this.mP0.x)/(this.mP3.x-this.mP0.x);return(((this.mP3.y-3*this.mP2.y+3*this.mP1.y-this.mP0.y)*t+(this.mP2.y-2*this.mP1.y+this.mP0.y)*3)*t+(this.mP1.y-this.mP0.y)*3)*t+this.mP0.y;},evaluateDerivative:function evaluateDerivative(independentValue){var t=(independentValue-this.mP0.x)/(this.mP3.x-this.mP0.x);return(((this.mP3.y-3*this.mP2.y+3*this.mP1.y-this.mP0.y)*t+(this.mP2.y-2*this.mP1.y+this.mP0.y)*2)*t+(this.mP1.y-this.mP0.y))*3/(this.mP3.x-this.mP0.x);},evaluate2ndDerivative:function evaluate2ndDerivative(independentValue){var p0=this.mP1.y-this.mP0.y,p1=this.mP2.y-this.mP1.y,p2=this.mP3.y-this.mP2.y,deltaX=this.mP3.x-this.mP0.x,tao=(independentValue-this.mP0.x)/(this.mP3.x-this.mP0.x);return 6*(p1-p0+(p2-2*p1+p0)*tao)/(deltaX*deltaX);},evaluate3rdDerivative:function evaluate3rdDerivative(){var deltaX=this.mP3.x-this.mP0.x;return 6*(this.mP3.y-3*this.mP2.y+3*this.mP1.y-this.mP0.y)/(deltaX*deltaX*deltaX);},CloneReverseShift:function CloneReverseShift(offset){if(!this.mIsVertical){offset.swap();}return new $C.BezierCurve({P0:this.mP3.Shifted(offset),P1:this.mP2.y+offset.y,P2:this.mP1.y+offset.y,P3:this.mP0.Shifted(offset),IsVertical:this.mIsVertical,IsXAlwaysIndependent:true});}});}());