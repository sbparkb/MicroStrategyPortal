(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.EnumRWUnitType","mstrmojo.models.FormatModel","mstrmojo.DocDataService","mstrmojo.hash");mstrmojo.requiresClsP("mstrmojo.vi.models","PanelFormatSaver","EnumPanelTypes","VIComponentMap");var $MOJO=mstrmojo,$HASH=$MOJO.hash,$ARR=$MOJO.array,$VI_MODELS=$MOJO.vi.models,$VI_TYPES=$VI_MODELS.VIComponentMap.TYPES,$PANEL_TYPES=$VI_MODELS.EnumPanelTypes,VI_FILTER_STACK=$VI_TYPES.FILTER_STACK,$FORMAT_MODEL=$MOJO.models.FormatModel,$GET_FORMAT_OBJ=$FORMAT_MODEL.getFormatUpdate,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$RW_UNIT_TYPES=$MOJO.EnumRWUnitType,$ERR=$MOJO.mstr.EnumWebAPIErrorCodes,PANEL_FILTER_STACK=$PANEL_TYPES.FILTERS,UNDO_KEY=$MOJO.DocDataService.UNDO_KEY,ITEM_SEPARATOR="\u001E",REQUEST_DEFN_DATA=$MOJO.DocDataService.REQUEST_DEFN_DATA,FP_PATH="sections.0.subsections.0";var DEFAULT_ROWS_COUNT=8;function isUC(unit){return unit.t!==1&&(unit.t!==47||unit.st===12033);}function pivotExistingStackSelectors(stack,startIdx,endIdx,shiftOffset,refreshKeys){var actions=[];if(!stack){return actions;}refreshKeys=refreshKeys||{};stack.getFilters().forEach(function(filter){var oldIdx=parseInt(filter.defn.fmts["z-index"],10);if(oldIdx>=startIdx&&(!endIdx||oldIdx<=endIdx)){actions.push(this.getUnitFormatAction(filter,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.Z_INDEX,oldIdx+shiftOffset)));refreshKeys[filter.ckey]=filter.id;}},this);return actions;}function getAddFilterActions(unit,targetKeys,nodeKey,ctrlKey,zIndex){var actions=[],ctrlStyle=this.getCtrlStyleFromDatasetUnit(unit,true),layoutUnits=this.getCurrentLayoutDef().units,stackKey=this.getVIPanelKeyFromUnits(PANEL_FILTER_STACK),panelKey=$HASH.keyarray(layoutUnits).filter(function(key){return layoutUnits[key].t===$RW_UNIT_TYPES.PANEL&&layoutUnits[key].isFilterPanel;})[0],panelFormats=this.getTargetDefn(panelKey)[panelKey].fmts,formatWidth=panelFormats&&panelFormats.width,width=(formatWidth&&formatWidth.charAt(formatWidth.length-1)!=="%")?parseInt(formatWidth,10):undefined,orientation;if(zIndex===undefined||zIndex===null){zIndex=999;}actions.push(this.getDataService().getAddCtrlAction(panelKey,nodeKey,ctrlKey,[stackKey],isUC(unit),unit.t,unit.did,targetKeys));if(ctrlStyle===1){orientation=1;}actions=actions.concat(this.getCtrlActionsByStyle(unit,this.buildKeyContext(nodeKey,ctrlKey),ctrlStyle,orientation,this.getCtrlHeightByStyle(ctrlStyle,unit.card||DEFAULT_ROWS_COUNT+1),width,zIndex,1));return actions;}function getExecAddFilterActions(update,keyContexts,units,zIndex,refreshKeys,extraInfo){var viMap=this.getVIMap(),stack=viMap.getComponent(VI_FILTER_STACK);if(extraInfo&&extraInfo.preInfo){update.addActions(extraInfo.preInfo.actions);}if(!keyContexts.length){var cmdZIndex=zIndex;units.forEach(function(unit){var nodeKey=this.getNextKey(),ctrlKey=this.getNextKey(),ctrlKeyContext=this.buildKeyContext(nodeKey,ctrlKey);keyContexts.push(ctrlKeyContext);update.addActions(getAddFilterActions.call(this,unit,[viMap.getComponentKey($VI_TYPES.MAIN_CONTENT)],nodeKey,ctrlKey,(cmdZIndex!==null?cmdZIndex++:null)));},this);var endzIndex=keyContexts.length&&(stack.getFilters().length-1);update.addActions(pivotExistingStackSelectors.call(this,stack,zIndex,endzIndex,keyContexts.length,refreshKeys));}else{var dataService=this.getDataService();keyContexts.forEach(function(key){dataService.addMoveControlAction(update,key,stack.contents.k);});update.addActions(pivotExistingStackSelectors.call(this,stack,zIndex,null,keyContexts.length,refreshKeys));}if(extraInfo&&extraInfo.postInfo){update.addActions(extraInfo.postInfo.actions);}}function getUndoAddFilterActions(update,keyContexts,zIndex,refreshKeys){var viMap=this.getVIMap(),stack=viMap.getComponent(VI_FILTER_STACK),dataService=this.getDataService();keyContexts.forEach(function(key){dataService.addMoveControlAction(update,key,UNDO_KEY);});update.addActions(pivotExistingStackSelectors.call(this,stack,zIndex+1,undefined,-keyContexts.length,refreshKeys));}function getDeleteFilterActions(update,model,filterDefinitions,refreshKeys,ignoreTargetData){var stack=model.getDocBuilder().getLayoutVIMap(model.getCurrentLayoutKey()).getComponent(VI_FILTER_STACK),panelKey=stack.contents.k,dataService=model.getDataService();var filters=stack.getFilters(),toRemove={},zIndexOffset=0;filterDefinitions.forEach(function(def){toRemove[def.ckey]=def;});filters.forEach(function(filter){var oldIdx=parseInt(filter.defn.fmts["z-index"],10);if(!toRemove[filter.ckey]){if(zIndexOffset!==0){update.addActions(model.getUnitFormatAction(filter,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.Z_INDEX,oldIdx-zIndexOffset)));refreshKeys[filter.ckey]=filter.id;}else{var targetKeys=filter.tks?filter.tks.split(ITEM_SEPARATOR):[];for(var p in toRemove){if(targetKeys.indexOf(toRemove[p].ckey)>=0){refreshKeys[filter.ckey]=filter.id;break;}}}}else{var definition=toRemove[filter.ckey],targetKeys=definition.tks?definition.tks.split(ITEM_SEPARATOR):[],targetDsKeys=definition.dsTks?definition.dsTks.split(ITEM_SEPARATOR):[],keyContext=definition.ck,fnTargetState=dataService.getRemoveCtrlTargetAction,fnTargetDsState=dataService.getRemoveCtrlTargetDatasetAction;targetKeys.forEach(function(targetKey){if(ignoreTargetData){update.addActions(fnTargetState.call(dataService,keyContext,targetKey,[],true));}else{update.addActions(fnTargetState.call(dataService,keyContext,targetKey,targetKey));}});targetDsKeys.forEach(function(targetKey){update.addActions(fnTargetDsState.call(dataService,keyContext,targetKey));});if(model.datasetsSettings.unitOpr(definition.ttl,"isDeleteWithFilter")){update.addActions({act:"removeDerivedMetricFromDataset",dsid:model.findDatasetIdFromUnit(definition.srcid),metricId:definition.srcid});model.datasetsSettings.unitOpr(definition.ttl,"isDeleteWithFilter",false);model.datasetsSettings.unitOpr(definition.ttl,"completeHide",false);update.addActions(model.datasetsSettings.getSaveActions());}var updateNodeKeys=[panelKey];if(!ignoreTargetData){updateNodeKeys.concat(targetKeys);}update.addActions(dataService.getRemoveCtrlAction(definition.ckey,updateNodeKeys));zIndexOffset=zIndexOffset+1;}},this);}function addFilterStackCallback(update,stack,refreshKeys,forcePU,extraInfo){var model=this;if(mstrmojo.array.find(update.actions,"act","removeDerivedMetricFromDataset")>=0){update.addCallbacks(model.getDatasetsUpdateCallback());}if(extraInfo&&extraInfo.preInfo){update.addCallbacks(extraInfo.preInfo.callback);}update.addCallbacks({success:function(response,request){var panel=stack.contents,rebuildKeys=stack.k,requestParameters=request.params.params,partialRetrieval=requestParameters&&JSON.parse(requestParameters).partialRetrieval,partialRetrievalNodes=partialRetrieval&&partialRetrieval.nodes;if(forcePU){rebuildKeys=response.pukeys;}else{if(partialRetrievalNodes){rebuildKeys=$HASH.keyarray(refreshKeys||{}).concat(partialRetrievalNodes).join(ITEM_SEPARATOR);}}model.partialUpdate(response.data,model.getTargetDefn(rebuildKeys),response.defn,$HASH.keyarray(refreshKeys||{}));if(panel&&panel.children){panel.rebuildChildren();}stack.getFilterDefinitions().forEach(function(defn){if(!defn.sfs){var sfs=[],item=model.getDatasetUnits(["att","mx"],function(it){return it.did===defn.srcid;})[0]||{};(item.fs||[]).forEach(function(form){sfs.push({did:form.fid});});if(sfs.length){defn.sfs=sfs;}}});var tabList=stack.parent&&stack.parent.tabList;if(tabList){tabList.singleSelect($ARR.find(tabList.items,"id","vi_flt"));}},failure:function(response,request){var fn=null;if(response.code==$ERR.DFC_QRYENG_RES_TRUNC){fn=function(){model.controller.undo();};}mstrmojo.error({longDesc:response.message},fn,{title:"Error"});}});if(extraInfo&&extraInfo.postInfo){update.addCallbacks(extraInfo.postInfo.callback);}}mstrmojo.vi.models._FilterStackActions=mstrmojo.provide("mstrmojo.vi.models._FilterStackActions",{_mixinName:"mstrmojo.vi.models._FilterStackActions",addFilterStackSelectors:function addFilterStackSelectors(units,toIdx,extraInfo,forcePU){var dataService=this.getDataService(),model=this,viMap=this.getVIMap(),stack=viMap.getComponent(VI_FILTER_STACK),keyContexts=[],zIndex=toIdx!==undefined?toIdx:(stack?stack.getFilters().length:null),ds=model.getDataService();var addFiltersFN=function(){var isValid=(!stack||$ARR.find(stack.getFilterDefinitions(),"srcid",units[0]&&units[0].did)===-1);if(isValid){forcePU=forcePU||!!units.filter(function(unit){return !isUC(unit);}).length;model.execute({execute:function(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={},panel=stack.contents;update.extras.skipUICmdMgrOnFailure=[$ERR.DFC_QRYENG_RES_TRUNC];update.extras.config={hideFailureErr:true};refreshKeys[panel.k]=true;getExecAddFilterActions.call(model,update,keyContexts,units,zIndex,refreshKeys,extraInfo);addFilterStackCallback.call(model,update,stack,refreshKeys,forcePU,extraInfo);var phase=zIndex===null?this.mgr.CMD_PHASE.FIRST:this.mgr.CMD_PHASE.LAST;this.submitUpdate(update,phase);}});}};if(!stack){ds.submitUpdates(model.getShowVIStackAction(PANEL_FILTER_STACK),{success:function(response,request){model.buildLoadedVIStack(PANEL_FILTER_STACK,FP_PATH,response,model.getDocBuilder());model.controller.view.openViPanel("filterPanel",{success:addFiltersFN});stack=model.getVIMap().getComponent(VI_FILTER_STACK);}},{preserveUndo:true});}else{if(stack.getOpenStatus()){addFiltersFN();}else{model.controller.view.openViPanel("filterPanel",{success:addFiltersFN});}}},pivotFilterStackSelector:function pivotFilterStackSelector(selector,fromIdx,toIdx){var dataService=this.getDataService(),selectorId=selector.id,stack=this.getVIMap().getComponent(VI_FILTER_STACK),model=this,shiftUp=fromIdx<toIdx;function cmdMethod(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={},cmdFromIdx=this.getStateValue(fromIdx,toIdx),cmdToIdx=this.getStateValue(toIdx,fromIdx),cmdShiftUp=this.getStateValue(shiftUp,!shiftUp);selector=mstrmojo.all[selectorId];update.addActions(pivotExistingStackSelectors.call(model,stack,cmdToIdx,cmdFromIdx+(cmdShiftUp?1:-1),cmdShiftUp?-1:1,refreshKeys));update.addActions(model.getUnitFormatAction(selector,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.Z_INDEX,cmdToIdx)));refreshKeys[selector.ckey]=selectorId;addFilterStackCallback.call(model,update,stack,refreshKeys);this.urInfo=this.urInfo||{};this.urInfo.callback=update.callback;update.submit();}this.execute({execute:cmdMethod});},deleteFilterStackSelectors:function deleteFilterStackSelectors(filterDefinitions,ignoreTargetData){var dataService=this.getDataService(),stack=this.getVIMap().getComponent(VI_FILTER_STACK),model=this,act=stack.model.getDataService().newUpdate(stack);if(stack.applyBufferedSlices){stack.applyBufferedSlices(true,act);}function cmdMethod(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={};refreshKeys[stack.contents.k]=true;getDeleteFilterActions.call(this,update,model,filterDefinitions,refreshKeys,ignoreTargetData);addFilterStackCallback.call(model,update,stack,refreshKeys);this.urInfo=this.urInfo||{};this.urInfo.callback=update.callback;var actions=(act.actions||[]).concat(update.actions);this.submit(actions,update.callback,update.extras);}this.execute({execute:cmdMethod});},changeFilterStackSelectors:function changeFilterStackSelectors(unitsToAdd,definitionsToDelete){var dataService=this.getDataService(),model=this,viMap=this.getVIMap(),stack=viMap.getComponent(VI_FILTER_STACK),forcePU=!!unitsToAdd.filter(function(unit){return !isUC(unit);}).length,keyContexts=[];this.execute({execute:function(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={};refreshKeys[stack.contents.k]=true;getDeleteFilterActions.call(this,update,model,definitionsToDelete,refreshKeys);getExecAddFilterActions.call(model,update,keyContexts,unitsToAdd,stack.getFilters().length+1,refreshKeys);addFilterStackCallback.call(model,update,stack,refreshKeys,forcePU);if(definitionsToDelete.length&&unitsToAdd.length){this.submitUpdate(update,this.mgr.CMD_PHASE.FIRST);}else{this.submitUpdate(update);}}});},loadHiddenFilterStack:function loadHiddenFilterStack(builder,fnCallback){this.loadHiddenVIStack(PANEL_FILTER_STACK,FP_PATH,builder,fnCallback);}});}());