(function(){mstrmojo.requiresCls("mstrmojo.Widget");var _D=mstrmojo.dom;var _this,deletedWorksheet,getKeys;var actionsMenu={singleColumnSelect:1,multipleColumnSelect:2,singleRowSelect:3,multipleRowSelect:4};var pasteMode={directPaste:0,refreshPaste:1};function getNodeText(node){var text="";if(node.innerText!==undefined){text=node.innerText;}else{if(node.textContent!==undefined){text=node.textContent;}else{text=node.innerHTML;}}return text;}function addToHash(source,key,value){if(!(source.cellHash.hasOwnProperty(key))){source.cellHash[key]=value;}}function removeSelectionStyle(source,removedSelection){if(removedSelection===undefined){return ;}if(removedSelection===null){return ;}mstrmojo.css.removeClass(removedSelection,["selected"]);mstrmojo.css.removeClass(removedSelection,["super-selected"]);var columnHeaderCell=source.table.rows[0].cells[removedSelection.cellIndex];mstrmojo.css.removeClass(columnHeaderCell,["selectedHeader"]);mstrmojo.css.removeClass(columnHeaderCell,["super-selectedHeader"]);if(source.showRowHeaders){var rowHeaderCell=source.table.rows[removedSelection.parentNode.rowIndex].cells[0];mstrmojo.css.removeClass(rowHeaderCell,["selectedHeader"]);}}function removeSelections(source){var selections=source.selections;if(selections===undefined){return ;}while(selections.length>0){var rowSelection=selections.pop();while(rowSelection.length>0){var removedSelection=rowSelection.pop();removeSelectionStyle(source,removedSelection);}}}function enableActionMenuOptions(source,action){var i;var actionsMenu=source.actionsMenu;var actionMenuOptions=actionsMenu.childNodes;for(i=3;i<actionMenuOptions.length;i++){mstrmojo.css.addClass(actionMenuOptions[i],["inactive"]);mstrmojo.css.removeClass(actionMenuOptions[i],["active"]);}switch(action){case 1:mstrmojo.css.removeClass(actionMenuOptions[3],["inactive"]);mstrmojo.css.removeClass(actionMenuOptions[4],["inactive"]);mstrmojo.css.addClass(actionMenuOptions[3],["active"]);mstrmojo.css.addClass(actionMenuOptions[4],["active"]);break;case 2:mstrmojo.css.removeClass(actionMenuOptions[4],["inactive"]);mstrmojo.css.addClass(actionMenuOptions[4],["active"]);break;case 3:mstrmojo.css.removeClass(actionMenuOptions[5],["inactive"]);mstrmojo.css.removeClass(actionMenuOptions[6],["inactive"]);mstrmojo.css.addClass(actionMenuOptions[5],["active"]);mstrmojo.css.addClass(actionMenuOptions[6],["active"]);break;case 4:mstrmojo.css.removeClass(actionMenuOptions[6],["inactive"]);mstrmojo.css.addClass(actionMenuOptions[6],["active"]);break;default:break;}}function removeSingleSelection(source,cell){var i,j;var selections=source.selections;if(selections===undefined){return ;}for(i=0;i<selections.length;i++){for(j=0;j<selections[i].length;j++){if(selections[i][j]===cell){removeSelectionStyle(source,selections[i][j]);selections[i].splice(j,1);return ;}}}}function changeSelections(source,selectedSource,ctrlKey,shiftKey,eventType){if(selectedSource===undefined){return ;}var i,rowSelection,rowHeaderCell,cell,columnHeaderCell,ctrl=ctrlKey||false,shift=shiftKey||false,sc,sr;if(!ctrl&&!shift){removeSelections(source);}sc=selectedSource.cellIndex;sr=selectedSource.parentNode.rowIndex;var removeSelection=false;if(ctrlKey&&selectedSource.className.indexOf("selected")!==-1){removeSelection=true;}if(source.showRowHeaders){if(sc===0&&sr===0){removeSelections(source);enableActionMenuOptions(source,0);return ;}}if(sr===0){enableActionMenuOptions(source,actionsMenu.singleColumnSelect);if(ctrlKey){enableActionMenuOptions(source,actionsMenu.multipleColumnSelect);}if(eventType===undefined||(eventType!==undefined&&(eventType!=="dblclick"&&eventType!=="contextmenu"))){for(i=0;i<source.rowCount;i++){cell=source.table.rows[i].cells[sc];if(removeSelection){removeSingleSelection(source,cell);}else{mstrmojo.css.addClass(cell,["selected"]);var headerCell=source.table.rows[0].cells[cell.cellIndex];mstrmojo.css.addClass(headerCell,["super-selectedHeader"]);if(source.showRowHeaders){if(i!==0){rowHeaderCell=source.table.rows[i].cells[0];mstrmojo.css.addClass(rowHeaderCell,["selectedHeader"]);}}rowSelection=[];rowSelection.push(cell);source.selections.push(rowSelection);}}}else{removeSelections(source);mstrmojo.css.addClass(selectedSource,["selected"]);columnHeaderCell=source.table.rows[0].cells[selectedSource.cellIndex];mstrmojo.css.addClass(columnHeaderCell,["selectedHeader"]);if(source.showRowHeaders){rowHeaderCell=source.table.rows[selectedSource.parentNode.rowIndex].cells[0];mstrmojo.css.addClass(rowHeaderCell,["selectedHeader"]);}rowSelection=[];rowSelection.push(selectedSource);source.selections.push(rowSelection);}}else{if(source.showRowHeaders&&sc===0){enableActionMenuOptions(source,actionsMenu.singleRowSelect);rowSelection=[];for(i=1;i<source.columnCount;i++){cell=source.table.rows[sr].cells[i];if(removeSelection){removeSingleSelection(source,cell);}else{mstrmojo.css.addClass(cell,["selected"]);columnHeaderCell=source.table.rows[0].cells[cell.cellIndex];mstrmojo.css.addClass(columnHeaderCell,["selectedHeader"]);rowSelection.push(cell);}}source.selections.push(rowSelection);if(!removeSelection){rowHeaderCell=source.table.rows[sr].cells[0];mstrmojo.css.addClass(rowHeaderCell,["selectedHeader"]);}if(source.selections.length>1){enableActionMenuOptions(source,actionsMenu.multipleRowSelect);}}else{enableActionMenuOptions(source,0);if(removeSelection){removeSingleSelection(source,selectedSource);}else{mstrmojo.css.addClass(selectedSource,["super-selected"]);columnHeaderCell=source.table.rows[0].cells[selectedSource.cellIndex];mstrmojo.css.addClass(columnHeaderCell,["selectedHeader"]);if(source.showRowHeaders){rowHeaderCell=source.table.rows[selectedSource.parentNode.rowIndex].cells[0];mstrmojo.css.addClass(rowHeaderCell,["selectedHeader"]);}rowSelection=[];rowSelection.push(selectedSource);source.selections.push(rowSelection);}}}if(removeSelection){source.selectedSource=null;}}getKeys=function(obj){var key,keys=[];for(key in obj){if(obj.hasOwnProperty(key)){keys.push(key);}}return keys;};function checkCellsHash(source){var changed=getKeys(source.cellHash).length>0;source.raiseEvent({name:"WorksheetContentChanged",data:changed});return changed;}function deleteFromHash(source,key){if((source.cellHash.hasOwnProperty(key))){delete source.cellHash[key];}}function generateCellKey(cell){var colId=cell.cellIndex;var rowId=cell.parentNode.rowIndex;return colId+"."+rowId;}function clearSelections(source){var i,j;var selections=source.selections;if(selections){for(i=0;i<selections.length;i++){for(j=0;j<selections[i].length;j++){selections[i][j].firstChild.innerHTML="";deleteFromHash(source,generateCellKey(selections[i][j]));}}}source.isDirty=checkCellsHash(source);}function renderTable(source){source.rowCount=source.numOfRows;source.columnCount=source.numOfcols;source.selections=[];var i,j;var rs=[],ccc=source.tableRowCellCssClass,cccHeader=ccc+" header";var rowHeader=source.tableRowHeaderCssClass;var columnHeader=(cccHeader?' class="'+cccHeader+'"':"");var cell=(ccc?' class="'+ccc+'"':""),cs=[];for(i=0;i<source.rowCount;i++){for(j=0;j<source.columnCount;j++){if(source.showRowHeaders){if(j===0){if(i===0){cs[j]='<td class="'+rowHeader+'"><div class="'+source.editableDivCssClass+'" contentEditable = "false" style="outline: 0;"></div></td>';}else{cs[j]='<td class="'+rowHeader+'"><div class="'+source.editableDivCssClass+'" contentEditable = "false" style="outline: 0;">'+i+"</div></td>";}}else{if(i===0){cs[j]="<td"+columnHeader+'><div class="'+source.editableDivCssClass+'" contentEditable = "false" style="outline: 0;"></div></td>';}else{cs[j]="<td"+cell+'><div class="'+source.editableDivCssClass+'" contentEditable = "false" style="outline: 0;"></div></td>';}}}else{if(i===0){cs[j]="<td"+columnHeader+'><div class="'+source.editableDivCssClass+'" contentEditable = "false" style="outline: 0;"></div></td>';}else{cs[j]="<td"+cell+'><div class="'+source.editableDivCssClass+'" contentEditable = "false" style="outline: 0;"></div></td>';}}}rs[i]="<tr>"+cs.join("")+"</tr>";}return rs.join("");}function transitionEnded(evt){evt.source.table.parentNode.removeChild(deletedWorksheet);}function clearCellHash(source){source.cellHash={};source.isDirty=checkCellsHash(source);}function clearWorksheet(source){var copyTable,dotransition=false,transitionEndEvent="";if(mstrmojo.dom.isWK===true){transitionEndEvent="webkitAnimationEnd";dotransition=true;}else{if(mstrmojo.dom.isFF===true){transitionEndEvent="animationend";dotransition=true;}else{if(mstrmojo.dom.isIE8===false&&mstrmojo.dom.isIE9===false){transitionEndEvent="MSAnimationEnd";dotransition=true;}else{if(mstrmojo.dom.isIE8===true||mstrmojo.dom.isIE9===true){dotransition=false;}}}}if(dotransition===true){deletedWorksheet=document.createElement("div");copyTable=source.table.cloneNode(true);mstrmojo.css.addClass(copyTable,["animated bounceOut"]);source.table.parentNode.setAttribute("cssText","style=z-index: 0;position:absolute;");deletedWorksheet.appendChild(copyTable);deletedWorksheet.setAttribute("cssText","style=z-index: 2;position:absolute;top:70px;");deletedWorksheet.style.top="70px";deletedWorksheet.style.position="absolute";if(transitionEndEvent!==""){deletedWorksheet.addEventListener(transitionEndEvent,function(event){event.source=source;transitionEnded(event);},false);}source.table.parentNode.appendChild(deletedWorksheet);}if(mstrmojo.dom.isIE8===true||mstrmojo.dom.isIE9===true){var temp=document.getElementsByName("tempTableSpan")[0];temp.innerHTML="<table>"+renderTable(source)+"</table>";var tb=document.getElementsByName("tableBody")[0];tb.parentNode.replaceChild(temp.firstChild.firstChild,tb);}else{source.table.innerHTML=renderTable(source);}if(source.selectedSource&&source.selectedSource.firstChild&&source.selectedSource.firstChild.contentEditable==="true"){source.selectedSource.firstChild.contentEditable=false;}source.selectedSource=null;removeSelections(source);clearCellHash(source);source.tableContainer.focus();source.parent.refresh();}function copySelections(selections){var i,j;var copiedData="";if(selections){for(i=0;i<selections.length;i++){for(j=0;j<selections[i].length;j++){var cell=selections[i][j].firstChild;var text=(cell.innerText||cell.textContent).replace("\n","");if(j===selections[i].length-1){copiedData+=text;}else{copiedData+=text+"\t";}}if(i!==selections.length-1){copiedData+="\n";}copiedData=copiedData.replace("\t\n","\n");}}return copiedData;}function createCSV(source){var i,j,text,node;var tbl=source.table;if(tbl===null||tbl===undefined){return null;}var trs=tbl.getElementsByTagName("tr");var csv="";var startColIndex=0;if(source.showRowHeaders){startColIndex=1;}for(i=0;i<trs.length;i++){var c=trs[i].cells;for(j=startColIndex;j<c.length;j++){node=c[j].firstChild;text=getNodeText(node).replace("\n","");text=text.replace(/&amp;/g,"&");text=text.replace(/"/g,'""');text=text.replace(/\xA0/g," ");if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)){text='"'+text+'"';}else{text="&quot;"+text+"&quot;";}csv+=text;if(j!==c.length-1){csv+=",";}}if(i!==trs.length-1){csv=csv+"\n";}}var lines=csv.split("\n");for(i=lines.length-1;i>=0;i--){var line=lines[i];var emptyRow=true;var cells=line.split(",");for(j=0;j<cells.length;j++){if(cells[j]!=='""'){emptyRow=false;break;}}if(!emptyRow){break;}}lines=lines.slice(0,i+1);csv=lines.join("\n");return csv;}function handleKeyUp(event,source){var text;if(event.keyCode===17||event.keyCode===91){return ;}if(event.keyCode===8){if(!source.selectedSource){return ;}if(!source.selectedSource.firstChild){return ;}if(source.selectedSource.firstChild.innerHTML===""){deleteFromHash(source,generateCellKey(source.selectedSource));}source.isDirty=checkCellsHash(source);}if(event.keyCode===46){if(!source.selectedSource){return ;}if(!source.selectedSource.firstChild){return ;}if(source.selectedSource.firstChild.contentEditable!=="false"){text=getNodeText(source.selectedSource.firstChild);if(text.replace("\n","")===""){deleteFromHash(source,generateCellKey(source.selectedSource));}source.isDirty=checkCellsHash(source);}return true;}if(source.selectedSource.firstChild.innerHTML===""){deleteFromHash(source,generateCellKey(source.selectedSource));}else{addToHash(source,generateCellKey(source.selectedSource),source.selectedSource);}source.isDirty=checkCellsHash(source);}function createPseudoCopy(source){var copiedData=copySelections(source.selections);var txtOk=document.getElementById(source.id+"_pseudoText");txtOk.value=copiedData;txtOk.focus();txtOk.select();}function deleteColumn(source,index){var i;if(source.table.rows[0].cells[index]===null){return ;}for(i=0;i<source.rowCount;i++){var row=source.table.rows[i];row.deleteCell(index);}source.columnCount--;}function insertColumn(source,position,addMode,data){var i,pos,mode=addMode||0;if(mode===0){pos=position+1||source.columnCount;}else{pos=position||source.columnCount;}for(i=0;i<source.rowCount;i++){var row=source.table.rows[i];var newCol=row.insertCell(pos);newCol.className=source.tableRowCellCssClass;newCol.contentEditable=false;var editableDiv=document.createElement("DIV");editableDiv.contentEditable=false;editableDiv.className=source.editableDivCssClass;editableDiv.style.outline="0";if(data){editableDiv.innerHTML=data[i];}if(i===0){mstrmojo.css.addClass(newCol,["header"]);}newCol.appendChild(editableDiv);}source.columnCount++;source.updateScrollbars();}function deleteColumns(source,sourceSelections){var i,j;for(i=0;i<sourceSelections.length;i++){for(j=0;j<sourceSelections[i].length;j++){var toDeleteCellIndex=sourceSelections[i][j].cellIndex;if(toDeleteCellIndex===-1){continue;}deleteColumn(source,toDeleteCellIndex);insertColumn(source);}}}function deleteRow(source,index){source.table.deleteRow(index);source.rowCount--;}function insertRow(source,position,insertMode){var i,pos,mode=insertMode||0;if(mode===0){pos=position+1||source.rowCount;}else{pos=position||source.rowCount;}var newRow=source.table.insertRow(pos);for(i=0;i<source.columnCount;i++){var newCol=newRow.insertCell(i);var editableDiv=document.createElement("DIV");editableDiv.contentEditable=false;editableDiv.className=source.editableDivCssClass;editableDiv.style.outline="0";if(i===0){if(source.showRowHeaders){newCol.className=source.tableRowHeaderCssClass;editableDiv.innerHTML=pos++;}else{newCol.className=source.tableRowCellCssClass;}}else{newCol.className=source.tableRowCellCssClass;}newCol.appendChild(editableDiv);}source.rowCount++;source.updateScrollbars();}function deleteRows(source,sourceSelections){var i;for(i=0;i<sourceSelections.length;i++){deleteRow(source,sourceSelections[i][0].parentNode.rowIndex);insertRow(source);}}var dragObject=(function(){var i,j,sourceContent=[];return{getSourceContent:function(source,sourceColumn){sourceContent=[];for(i=0;i<source.rowCount;i++){var cell=source.table.rows[i].cells[sourceColumn];sourceContent.push(cell.firstChild.innerHTML);}return sourceContent;},createDragDiv:function(source,sourceColumn,event){if(!source.dragDiv){var sourceContent=this.getSourceContent(source,sourceColumn);source.dragDiv=document.createElement("div");source.dragDiv.className="testDragDiv";source.dragDiv.style.left=event.clientX+10+"px";source.dragDiv.style.top=event.clientY+"px";var table=document.createElement("table");var rs=[],ccc=_this.tableRowCellCssClass+" selected",cccHeader=ccc+" header selectedHeader";var attHeader=(cccHeader?' contentEditable = "false" class="'+cccHeader+'"':"");var att=(ccc?' contentEditable = "false" class="'+ccc+'"':""),cs=[];for(i=0;i<10;i++){for(j=0;j<1;j++){if(i===0){cs[j]="<td"+attHeader+'><div class="'+source.editableDivCssClass+'" contentEditable = "false" style="outline: 0;">'+sourceContent[i]+"</div></td>";}else{cs[j]="<td"+att+'><div class="'+source.editableDivCssClass+'" contentEditable = "false" style="outline: 0;">'+sourceContent[i]+"</div></td>";}}rs[i]="<tr>"+cs.join("")+"</tr>";}table.innerHTML=rs.join("");source.dragDiv.appendChild(table);source.table.parentNode.parentNode.parentNode.appendChild(source.dragDiv);}else{source.dragDiv.style.left=event.clientX+10+"px";source.dragDiv.style.top=event.clientY+"px";}},removeDragDiv:function(source){if(source.dragDiv){source.table.parentNode.parentNode.parentNode.removeChild(source.dragDiv);source.dragDiv=null;}},swapColumns:function(source,sourceColumn){var dropColumnIndex=event.target.cellIndex;deleteColumn(source,sourceColumn);insertColumn(source,dropColumnIndex-1,0,sourceContent);}};}());function getNewSelectedSource(source,oldSelectionCellIndex,oldSelectionRowIndex){var newSelection;if(oldSelectionCellIndex===-1){if(oldSelectionRowIndex===source.rowCount){newSelection=source.table.rows[source.rowCount-1].cells[0];}else{newSelection=source.table.rows[oldSelectionRowIndex].cells[0];}}else{if(oldSelectionCellIndex===source.columnCount){newSelection=source.table.rows[0].cells[source.columnCount-1];}else{newSelection=source.table.rows[0].cells[oldSelectionCellIndex];}}return newSelection;}function updateCellsHash(source){var newHash={};while(getKeys(source.cellHash).length>0){var oldKey=getKeys(source.cellHash).pop();var oldValue=source.cellHash[oldKey];delete source.cellHash[oldKey];var newKey=generateCellKey(oldValue);if(!(newHash.hasOwnProperty(newKey))){newHash[newKey]=oldValue;}}source.cellHash={};source.cellHash=newHash;source.isDirty=checkCellsHash(source);}function updateRowHeaderIndex(source){var i;var rowHeaders=document.getElementsByClassName(source.tableRowHeaderCssClass);for(i=1;i<rowHeaders.length;i++){rowHeaders[i].innerHTML=rowHeaders[i].parentNode.rowIndex;}}function handleClick(evt,source){var i,j,sourceSelections;if(evt.e.target.className.indexOf("inactive")!==-1){return ;}if(evt.e.target.className.indexOf("add_col")!==-1){insertColumn(source);return ;}if(evt.e.target.className.indexOf("add_row")!==-1){insertRow(source);updateCellsHash(source);return ;}if(evt.e.target.className.indexOf("clear_grid")!==-1){clearWorksheet(source);return ;}if(evt.e.target.className.indexOf("insert_col")!==-1){insertColumn(source,source.selectedSource.cellIndex,1);updateCellsHash(source);return ;}if(evt.e.target.className.indexOf("delete_col")!==-1){sourceSelections=[];for(i=0;i<source.selections.length;i++){var sourceRowSelection=[];for(j=0;j<source.selections[i].length;j++){sourceRowSelection[j]=source.selections[i][j];}sourceSelections[i]=sourceRowSelection;}var oldSelectionCellIndex=source.selectedSource.cellIndex;clearSelections(source);removeSelections(source);deleteColumns(source,sourceSelections);updateCellsHash(source);source.selectedSource=getNewSelectedSource(source,oldSelectionCellIndex,-1);changeSelections(source,source.selectedSource);if(source.showRowHeaders!==undefined&&source.showRowHeaders===true){if(source.columnCount===1){enableActionMenuOptions(source,0);}}else{if(source.columnCount===0){enableActionMenuOptions(source,0);}}return ;}if(evt.e.target.className.indexOf("insert_row")!==-1){if(source.showRowHeaders!==undefined&&source.showRowHeaders===true){insertRow(source,source.selectedSource.parentNode.rowIndex,1);updateRowHeaderIndex(source);updateCellsHash(source);}return ;}if(evt.e.target.className.indexOf("delete_row")!==-1){if(source.showRowHeaders!==undefined&&source.showRowHeaders===true){sourceSelections=[];for(i=0;i<source.selections.length;i++){var rowSelection=source.selections[i];var newRowSelections=[];for(j=0;j<rowSelection.length;j++){newRowSelections[j]=rowSelection[j];}sourceSelections[i]=newRowSelections;}var oldSelectionRowIndex=source.selectedSource.parentNode.rowIndex;clearSelections(source);removeSelections(source);deleteRows(source,sourceSelections);updateRowHeaderIndex(source);updateCellsHash(source);source.selectedSource=getNewSelectedSource(source,-1,oldSelectionRowIndex);changeSelections(source,source.selectedSource);if(source.rowCount===0){enableActionMenuOptions(source,0);}}return ;}}function handleContextMenuClick(evt,source){if(source.showRowHeaders!==undefined&&source.showRowHeaders===true){if(source.selectedSource.cellIndex===0){source.selectedSource.firstChild.contentEditable=false;evt.e.stopImmediatePropagation();evt.e.preventDefault();return ;}}handleClick(evt,source);source.selectedSource.firstChild.contentEditable=true;source.selectedSource.firstChild.focus();changeSelections(source,source.selectedSource,false,false,evt.e.type);return false;}function handleDoubleClick(evt,source){var target=evt.e.target;if(target.tagName==="DIV"){target=target.parentNode;}source.selectedSource=target;if(source.showRowHeaders&&target.cellIndex===0){return ;}source.selectedSource.firstChild.contentEditable=true;if(source.selectedSource.firstChild.innerHTML!==""){source.selectedSource.setAttribute("data-editable","true");var sel=window.getSelection();sel.collapse(source.selectedSource.firstChild,1);}source.selectedSource.firstChild.focus();changeSelections(source,source.selectedSource,evt.e.ctrlKey,false,evt.e.type);}function selectAll(source){var i,j,rowSelections;clearSelections(source);var startColIndex=0;if(source.showRowHeaders){startColIndex=1;}for(i=0;i<source.rowCount;i++){rowSelections=[];for(j=startColIndex;j<source.columnCount;j++){if(source.showRowHeaders){if(j===0){continue;}}var cell=source.table.rows[i].cells[j];mstrmojo.css.addClass(cell,["selected"]);var columnHeaderCell=source.table.rows[0].cells[cell.cellIndex];mstrmojo.css.addClass(columnHeaderCell,["selectedHeader"]);if(source.showRowHeaders){if(i!==0){var rowHeaderCell=source.table.rows[cell.parentNode.rowIndex].cells[0];mstrmojo.css.addClass(rowHeaderCell,["selectedHeader"]);}}rowSelections.push(cell);}source.selections.push(rowSelections);}}function makeShiftSelections(source,currentSelectedCell){if(!source.selections||(source.selections&&source.selections.length===0)){return ;}var lastSelection=source.selections[0][0],sourceSelectionsLength,lastRowLength;if(currentSelectedCell.cellIndex>lastSelection.cellIndex){if(currentSelectedCell.parentNode.rowIndex<lastSelection.parentNode.rowIndex){sourceSelectionsLength=source.selections.length;lastRowLength=1;}else{sourceSelectionsLength=1;lastRowLength=1;}}else{if(currentSelectedCell.parentNode.rowIndex>lastSelection.parentNode.rowIndex){sourceSelectionsLength=1;lastRowLength=source.selections[0].length;}else{sourceSelectionsLength=source.selections.length;lastRowLength=source.selections[sourceSelectionsLength-1].length;}}var firstSelectedCell=source.selections[sourceSelectionsLength-1][lastRowLength-1];var sc=firstSelectedCell.cellIndex;var sr=firstSelectedCell.parentNode.rowIndex;var dc=currentSelectedCell.cellIndex;var dr=currentSelectedCell.parentNode.rowIndex;if(currentSelectedCell.parentNode.rowIndex===0&&firstSelectedCell.parentNode.rowIndex===0){dr=source.rowCount-1;enableActionMenuOptions(source,actionsMenu.multipleColumnSelect);}if(source.showRowHeaders){if(currentSelectedCell.cellIndex===0&&currentSelectedCell.parentNode.rowIndex===0){removeSelections(source);enableActionMenuOptions(source,0);return ;}}removeSelections(source);var srow=Math.min(sr,dr);var drow=Math.max(sr,dr);var scol=Math.min(sc,dc);var dcol=Math.max(sc,dc);var i,j=0,superSelection;for(i=srow;i<=drow;i++){var rowSelections=[];for(j=scol;j<=dcol;j++){if(source.showRowHeaders){if(j===0){continue;}}var cell=source.table.rows[i].cells[j];mstrmojo.css.addClass(cell,["selected"]);var columnHeaderCell=source.table.rows[0].cells[cell.cellIndex];mstrmojo.css.addClass(columnHeaderCell,["selectedHeader"]);if(source.showRowHeaders){if(i!==0){var rowHeaderCell=source.table.rows[cell.parentNode.rowIndex].cells[0];mstrmojo.css.addClass(rowHeaderCell,["selectedHeader"]);}}if(i===srow&&j===scol){superSelection=cell;}rowSelections.push(cell);}source.selections.push(rowSelections);}mstrmojo.css.addClass(superSelection,["super-selected"]);}function handleKeyDown(event,source){if(!source.selectedSource){return false;}if(event.keyCode===17||(event.metaKey===true&&event.keyCode===91)){createPseudoCopy(source);return false;}if(event.keyCode===27){source.selectedSource.firstChild.contentEditable=false;source.tableContainer.focus();source.selectedSource.firstChild.innerHTML=source.preText;if(getNodeText(source.selectedSource.firstChild).replace("\n","")===""){clearSelections(source);}return true;}if(event.keyCode===67&&(event.ctrlKey||event.metaKey)){source.selectedSource.firstChild.contentEditable=true;source.selectedSource.firstChild.focus();createPseudoCopy(source);return true;}if(event.keyCode===88&&(event.ctrlKey||event.metaKey)){source.selectedSource.firstChild.contentEditable=true;source.selectedSource.firstChild.focus();createPseudoCopy(source);clearSelections(source);return true;}if(event.keyCode===65&&(event.ctrlKey||event.metaKey)){clearSelections(source);selectAll(source);enableActionMenuOptions(source,0);return true;}if(event.keyCode===16){return false;}var colId=source.selectedSource.cellIndex;var rowId=source.selectedSource.parentNode.rowIndex;if(source.showRowHeaders!==undefined&&source.showRowHeaders===true){if(colId===0){if(event.keyCode===86&&(event.ctrlKey||event.metaKey)){source.selectedSource.firstChild.contentEditable=true;source.selectedSource.firstChild.focus();return false;}}}if(event.keyCode===46){if(source.selectedSource.firstChild.contentEditable==="false"){clearSelections(source);}return true;}var moveSelection=false;if(event.keyCode===9){if(event.shiftKey){if((colId-1)>0){colId--;}}else{if(colId<=source.columnCount-1){colId++;}}moveSelection=true;}var keyCode=event.keyCode;switch(keyCode){case 37:colId--;moveSelection=true;break;case 39:colId++;moveSelection=true;break;case 38:rowId--;moveSelection=true;break;case 40:rowId++;moveSelection=true;break;}if(moveSelection){if(source.selectedSource.getAttribute("data-editable")==="true"){return false;}if(source.selectedSource.firstChild.contentEditable==="true"){source.selectedSource.firstChild.contentEditable=false;source.tableContainer.focus();}if(rowId<0||rowId>source.rowCount-1||colId<0||colId>source.columnCount-1){return false;}source.selectedSource=source.table.rows[rowId].cells[colId];if(!event.shiftKey&&!event.ctrlKey){changeSelections(source,source.selectedSource,event.ctrlKey,event.shiftKey);}else{if(event.shiftKey&&event.keyCode===9){changeSelections(source,source.selectedSource,false,false);}else{makeShiftSelections(source,source.selectedSource);}}var off=_D.delta(source.selectedSource,source.table.parentNode.parentNode);var yInside=!!(off.y>=0&&off.y<580);var xInside=!!(off.x>=0&&off.x<950);if(xInside&&yInside){event.preventDefault();event.stopImmediatePropagation();}}else{if(source.showRowHeaders!==undefined&&source.showRowHeaders===true){if(colId===0){return false;}}if(event.keyCode===13){source.selectedSource.setAttribute("data-editable","false");source.selectedSource.firstChild.contentEditable=false;source.tableContainer.focus();if(rowId===source.rowCount-1){insertRow(source);}source.selectedSource=source.table.rows[rowId+1].cells[colId];source.preText=source.selectedSource.firstChild.innerHTML;changeSelections(source,source.selectedSource);}else{if(!event.ctrlKey&&!event.metaKey){if(source.selectedSource.firstChild.contentEditable==="false"){source.selectedSource.firstChild.contentEditable=true;source.selectedSource.firstChild.focus();source.preText=source.selectedSource.firstChild.innerHTML;source.selectedSource.firstChild.innerHTML="";}}}}return true;}function toggleSelectedItem(evt,toggle){var selectedClassName="";if(evt.e.target.className.indexOf("add_col")!==-1){selectedClassName="DIClipboard-add_col_click";mstrmojo.css.toggleClass(evt.e.target,"DIClipboard-add_col",!toggle);}if(evt.e.target.className.indexOf("add_row")!==-1){selectedClassName="DIClipboard-add_row_click";mstrmojo.css.toggleClass(evt.e.target,"DIClipboard-add_row",!toggle);}if(evt.e.target.className.indexOf("clear_grid")!==-1){selectedClassName="DIClipboard-clear_grid_click";mstrmojo.css.toggleClass(evt.e.target,"DIClipboard-clear_grid",!toggle);}if(evt.e.target.className.indexOf("insert_col")!==-1){selectedClassName="DIClipboard-insert_col_click";mstrmojo.css.toggleClass(evt.e.target,"DIClipboard-insert_col",!toggle);}if(evt.e.target.className.indexOf("insert_row")!==-1){selectedClassName="DIClipboard-insert_row_click";mstrmojo.css.toggleClass(evt.e.target,"DIClipboard-insert_row",!toggle);}if(evt.e.target.className.indexOf("delete_col")!==-1){selectedClassName="DIClipboard-delete_col_click";mstrmojo.css.toggleClass(evt.e.target,"DIClipboard-delete_col",!toggle);}mstrmojo.css.toggleClass(evt.e.target,selectedClassName,toggle);}function handleMouseUp(evt,source){if(evt.e.target.getAttribute("type")==="menuItem"){toggleSelectedItem(evt,false);}return false;}function handleMouseDown(evt,source){if(evt.e.target.getAttribute("type")==="menuItem"){toggleSelectedItem(evt,true);return ;}if(evt.e.target.id===source.actionsMenu.id){return ;}if(source.selectedSource&&source.selectedSource.firstChild&&source.selectedSource.firstChild.contentEditable==="true"){if(evt.e.target.parentNode===source.selectedSource){return ;}source.selectedSource.firstChild.contentEditable=false;}source.tableContainer.focus();var target=evt.e.target;if(target.tagName==="DIV"){target=target.parentNode;}source.selectedSource=target;source.preText=target.firstChild.innerHTML;if(evt.e.shiftKey){makeShiftSelections(source,target);}else{changeSelections(source,target,evt.e.ctrlKey);}if(evt.e.which!==3){source.clickPosition={x:evt.e.clientX,y:evt.e.clientY};source.domNode.addEventListener("mousemove",source.mouseSelections,false);source.domNode.addEventListener("mouseup",source.removeSelections,false);}}function handleMouseSelections(evt,source,that){var target=evt.target;if(target.tagName==="DIV"){target=target.parentNode;}if(source.dragColumns){if(target.parentNode.rowIndex===0){if(evt.clientX<source.clickPosition.x-10||evt.clientX>source.clickPosition.x+10||evt.clientY<source.clickPosition.y-10||evt.clientY>source.clickPosition.y+10){if(that.dropTarget){that.dropTarget.setAttribute("style","border-right:1px solid;");}dragObject.createDragDiv(source,source.selectedSource.cellIndex,evt);source.table.setAttribute("style","cursor:move;");that.dropTarget=target;that.dropTarget.setAttribute("style","border-right:3px solid;");}}else{dragObject.removeDragDiv(source,evt);if(that.dropTarget!=="undefined"){that.dropTarget.setAttribute("style","border-right:1px solid;");that.dropTarget=null;}makeShiftSelections(source,target);}}if(source.resizeColumns){if(target.parentNode.rowIndex===0){source.table.setAttribute("style","cursor:w-resize;");var width=parseInt(target.clientWidth,10);var delta=evt.clientX-source.clickPosition.x;if(delta!==0){var newWidth=width+delta;var newMaxWidth=newWidth+50;target.setAttribute("style","max-width:"+newMaxWidth+"px;");target.setAttribute("style","width:"+newWidth+"px;");}}else{makeShiftSelections(source,target);source.table.setAttribute("style","cursor:auto;");}}else{makeShiftSelections(source,target);}}function handleRemoveMouseSelections(evt,source,that){that.removeEventListener("mousemove",source.mouseSelections);that.removeEventListener("mouseup",source.removeSelections);if(source.dragColumns){if(source.selectedSource.parentNode.rowIndex===0){if(evt.clientX<source.clickPosition.x-10||evt.clientX>source.clickPosition.x+10||evt.clientY<source.clickPosition.y-10||evt.clientY>source.clickPosition.y+10){if(that.dropTarget){that.dropTarget.setAttribute("style","border-right:1px solid;");that.dropTarget=null;}dragObject.removeDragDiv(source,evt);dragObject.swapColumns(source,source.selectedSource.cellIndex,evt);}}}source.table.setAttribute("style","cursor:auto;");}function performPaste(clipText,source,mode){var i,j,clipRows,cell;if(mstrmojo.string.trim(clipText)===""){return ;}source.table.setAttribute("style","cursor:wait;");if(clipText.length>50000){mstrApp.getRootController().displayError(mstrmojo.desc(12578,"Please paste less data, maximum limit is 50000 characters!"));source.table.setAttribute("style","cursor:auto;");source.isDirty=checkCellsHash(source);return ;}if(clipText.indexOf(String.fromCharCode(10))!==-1){clipRows=clipText.split(String.fromCharCode(10));}else{clipRows=clipText.split(String.fromCharCode(13));}if(clipRows.length>0){if(clipRows[clipRows.length-1]===""||clipRows[clipRows.length-1]===String.fromCharCode(10)){clipRows.splice(clipRows.length-1,1);}}var singleCell=false;var pm=mode||pasteMode.directPaste;if(clipRows.length===1&&pm!==pasteMode.refreshPaste){singleCell=true;}for(i=0;i<clipRows.length;i++){clipRows[i]=clipRows[i].split(String.fromCharCode(9));if(clipRows[i].length>1){singleCell=false;}}if(singleCell){for(i=0;i<source.selections.length;i++){for(j=0;j<source.selections[i].length;j++){cell=source.selections[i][j].firstChild;if(cell.innerText!==undefined){cell.innerText=clipText;}else{cell.textContent=clipText;}addToHash(source,generateCellKey(source.selections[i][j]),source.selections[i][j]);}}}else{var startCol=source.selections[0][0].cellIndex;var startRow=source.selections[0][0].parentNode.rowIndex;var extraRowsNeeded=startRow+clipRows.length-source.rowCount;var colLength=clipRows[0].length;for(i=0;i<clipRows.length;i++){colLength=Math.max(clipRows[i].length,colLength);}var extraColsNeeded=startCol+colLength-source.columnCount;for(i=0;i<extraRowsNeeded;i++){insertRow(source);}for(i=0;i<extraColsNeeded;i++){insertColumn(source);}for(i=0;i<clipRows.length;i++){for(j=0;j<clipRows[i].length;j++){cell=source.table.rows[startRow+i].cells[startCol+j];if(cell.firstChild.innerText!==undefined){cell.firstChild.innerText=clipRows[i][j];}else{cell.firstChild.textContent=clipRows[i][j];}addToHash(source,generateCellKey(cell),cell);cell.contentEditable=false;}}}source.isDirty=checkCellsHash(source);source.table.setAttribute("style","cursor:auto;");}function handlePaste(evt,source){if(navigator.userAgent.indexOf("Trident")!==-1||mstrmojo.dom.isIE){performPaste(window.clipboardData.getData("Text"),source);evt.e.preventDefault();}else{source.selectedSource.firstChild.contentEditable=false;performPaste(evt.e.clipboardData.getData("Text"),source);}source.tableContainer.focus();source.updateScrollbars();}function renderActionsMenu(source){var actionsMenuHTML="";actionsMenuHTML='<div type = "menuItem" class="active DIClipboard-add_col" mstr_title = "'+mstrmojo.desc(7555,"Add Column")+'"></div>';actionsMenuHTML+='<div type = "menuItem" class="active DIClipboard-add_row" mstr_title = "'+mstrmojo.desc(12572,"Add Row")+'"></div>';if(source.clearSheet){actionsMenuHTML+='<div type = "menuItem" class="active DIClipboard-clear_grid" mstr_title = "'+mstrmojo.desc(12573,"Clear Sheet")+'"></div>';}actionsMenuHTML+='<div type = "menuItem" class="inactive DIClipboard-insert_col" mstr_title = "'+mstrmojo.desc(12574,"Insert Column")+'"></div>';actionsMenuHTML+='<div type = "menuItem" class="inactive DIClipboard-delete_col" mstr_title= "'+mstrmojo.desc(12575,"Delete Column")+'"></div>';if(source.showRowHeaders!==undefined&&source.showRowHeaders===true){actionsMenuHTML+='<div type = "menuItem" class="inactive DIClipboard-insert_row" mstr_title= "'+mstrmojo.desc(12576,"Insert Row")+'"></div>';actionsMenuHTML+='<div type = "menuItem" class="inactive DIClipboard-delete_row" mstr_title= "'+mstrmojo.desc(12577,"Delete Row")+'"></div>';}return actionsMenuHTML;}function handleTooltip(evt,source){source.richTooltip.refNode=evt.target;source.richTooltip.content=evt.target.getAttribute("mstr_title");source.showTooltip(evt.e,self);}mstrmojo.Worksheet=mstrmojo.declare(mstrmojo.Widget,[mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.Worksheet",cssClass:"mstrmojo-di-worksheet-main-container",tableCssClass:"mstrmojo-di-worksheet-main-table",tableRowCellCssClass:"mstrmojo-di-worksheet-table-row-cell",tableRowHeaderCssClass:"mstrmojo-di-worksheet-table-rowHeader-cell",buttonCssClass:"mstrmojo-di-worksheet-buttonCssClass",numOfRows:10,numOfcols:5,showRowHeaders:false,selectedSource:null,selections:null,preText:"",isDirty:false,cellHash:{},dropTarget:null,dragColumns:false,clearSheet:false,resizeColumns:false,editableDivCssClass:"mstrmojo-di-worksheet-nonHighlightDiv",tableHtml:undefined,listHtml:undefined,markupString:'<div id="{@id}" class="{@cssClass}" mstrAttach:keydown,keyup><div id="{@id}" class = "mstrmojo-di-worksheet-navigationMenu" mstrAttach:click,mousedown,mouseup>{@listHtml}</div><div id="{@id}" class = "mstrmojo-di-worksheet-table-container" tabindex="0"><div class = "mstrmojo-di-worksheet-table-scroller"><table id="{@id}" class="{@tableCssClass}"><tbody id ="tableBody" mstrAttach:dblclick,contextmenu,mousedown,paste>{@tableHtml}</tbody></table></div></div><span id="tempTableSpan" style="visibility:hidden"></span><textarea id = "{@id}_pseudoText" class="mstrmojo-di-worksheet-copyTextBox" mstrAttach:paste></textarea></div>',markupSlots:{containerNode:function(){return this.domNode;},actionsMenu:function(){return this.domNode.firstChild;},tableContainer:function(){return this.domNode.childNodes[1];},table:function(){return this.domNode.childNodes[1].firstChild.lastChild;},tableScrollerNode:function(){return this.domNode.childNodes[1].firstChild;}},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.tableScrollerNode;},setInitialSelection:function setInitialSelection(selectedSource){var me=this;changeSelections(this,selectedSource);selectedSource.firstChild.contentEditable=false;window.setTimeout(function(){me.tableContainer.focus();},0);},preBuildRendering:function(){_this=this;this.tableHtml=renderTable(this);this.listHtml=renderActionsMenu(this);if(this._super){this._super();}},postBuildRendering:function(){var rtn=0;if(this._super){rtn=this._super();}this.selectedSource=this.table.rows[0].cells[1];this.setInitialSelection(this.selectedSource);clearCellHash(this);checkCellsHash(this);this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-A",posType:mstrmojo.tooltip.POS_TOPLEFT,top:32});if(!this._ontooltipover){var id=this.id;this._ontooltipover=function(e){var me=mstrmojo.all[id];handleTooltip(e,me);};this._ontooltipout=function(e){var me=mstrmojo.all[id];me.hideTooltip(e,self);};}mstrmojo.dom.attachEvent(this.actionsMenu,"mouseover",this._ontooltipover);mstrmojo.dom.attachEvent(this.actionsMenu,"mouseout",this._ontooltipout);return rtn;},oncontextmenu:function(evt){handleContextMenuClick(evt,this);},onclick:function(evt){handleClick(evt,this);},onmousedown:function(evt){handleMouseDown(evt,this);},onmouseup:function(evt){handleMouseUp(evt,this);},mouseSelections:function(evt){handleMouseSelections(evt,_this,this);},removeSelections:function(evt){handleRemoveMouseSelections(evt,_this,this);},ondblclick:function(evt){handleDoubleClick(evt,this);},onpaste:function(evt){handlePaste(evt,this);},onkeydown:function(evt){handleKeyDown(evt.e,this);},onkeyup:function(evt){handleKeyUp(evt.e,this);},formatData:function formatData(rawData){if((rawData.datap&&rawData.datap.data&&rawData.datap.data.dcs)===undefined){return null;}var data=rawData.datap.data.dcs,columns=data.length,maxRows=0,i,j,formatText="";for(i=0;i<columns;i++){maxRows=Math.max(data[i].dvs.length,maxRows);}for(j=0;j<columns;j++){formatText+=data[j].dcns.cln;if(j!==columns-1){formatText+="\t";}}formatText+="\n";for(i=0;i<maxRows;i++){for(j=0;j<columns;j++){var rowText=data[j].dvs[i];if(rowText!==null){formatText+=rowText;}else{formatText+="";}if(j!==columns-1){formatText+="\t";}}formatText+="\n";}return formatText;},getData:function(){return createCSV(this);},setData:function(data){var formattedData=this.formatData(data);if(formattedData!==null){performPaste(formattedData,this,pasteMode.refreshPaste);}}});}());