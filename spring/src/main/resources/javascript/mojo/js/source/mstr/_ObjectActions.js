(function(){mstrmojo.requiresCls("mstrmojo.form","mstrmojo.hash","mstrmojo.date","mstrmojo.dom","mstrmojo.expr","mstrmojo.NumberFormat","mstrmojo.Button","mstrmojo.CustomGroupEditor","mstrmojo.ME.MetricIDE","mstrmojo.SharingEditor");var DOM=mstrmojo.dom,expr=mstrmojo.expr,STP=expr.STP,EXTENDED_TYPE_DATA_IMPORT=256;var TP=mstrmojo.mstr.EnumDSSXMLObjectTypes;var EnumFeatures={ExecuteCubeReport:"web-execute-cube-report",CreateAnalysis:"create-analysis"};function checkSessionAndSendForm(params,action,method,target){var sm=mstrApp.sessionManager;if(sm&&sm.sessionTimedout){sm.openLoginEditor({success:function(){if(target!=="_blank"){mstrApp.showWait();}mstrmojo.form.send(params,action,method,target);}});}else{if(target!=="_blank"){mstrmojo._IsWebApp.showWait({message:mstrmojo.desc(97,"Executing...")});}mstrmojo.form.send(params,action,method,target);}}function toPage(params){checkSessionAndSendForm(params,null,"post");}mstrmojo.mstr._ObjectActions=mstrmojo.provide("mstrmojo.mstr._ObjectActions",{_mixinName:"mstrmojo.mstr._ObjectActions",execute:function execute(item,options){mstrmojo.hash.copy(mstrApp.searchAppFeatures,mstrApp.features);var features=mstrApp.features;var appName=mstrApp.name;var t=parseInt(item.tp||item.t,10),st=parseInt(item.stp||item.st,10),et=item.et&&parseInt(item.et,10),did=item.dssid||item.did,vm=item.viewMedia||item.dvm,vis=item.visMode||0,params={};switch(t){case TP.Filter:switch(st){case 256:params={evt:3113,filterID:did,src:appName+".3113"};break;case 257:this.openCustomGroupEditor(item,options);return ;}break;case TP.Metric:this.openMetricEditor(item,options);return ;case TP.Folder:params={evt:2001,folderID:did,src:appName+".2001"};break;case TP.ReportDefinition:if(this.designMode){params={evt:3005,src:appName+".3005",reportID:did,reportDesignMode:this.designMode};break;}var rvm=1;switch(st){case STP.REPORT_CUBE:case STP.REPORT_EMMACUBE:if(!mstrApp.features[EnumFeatures.CreateAnalysis]){return ;}var browserSupported=!features.IE9Pre||features.IE9Pre&&(features["run-vi-flash"]||features["run-vi-smart"]);if(browserSupported){var type=features.flashvi?"analysis":"HTML5VI";cubeHandler.convertFromCube({st:st,type:type,did:did,folderId:getFolderId(item),et:et});}else{mstrmojo.alert(mstrmojo.desc(12187,"Please upgrade your browser or turn off Internet Explorer Compatibility View to work with HTML5 dashboards."));}return ;case STP.REPORT_GRID:rvm=1;break;case STP.REPORT_GRAPH:rvm=2;break;case STP.REPORT_GRIDGRAPH:rvm=3;break;}params={reportID:did,evt:4001,src:appName+".4001",visMode:vis,reportViewMode:rvm};break;case TP.DocumentDefinition:var VIEW_M={Reserved:0,ViewStatic:1,ViewInteractive:2,ViewEditable:4,ViewFlash:8,ExportExcel:16,ExportPDF:32,ExportHTML:64,ExportFlash:128,ExportExcelPlainText:256,ExportCSV:512,ExportPlainText:1024,ViewAnalysis:2048,HTML5Dashboard:8192,All:134217727},EXEC_M={DATA:1,DESIGN:2,PDF:3,EXCEL:4,SAVE:5,DETAILS:6,FLASH_EXPORT:7,FLASH_VIEW:8,FLASH_BINARY_VIEW:9};var emm={};emm[VIEW_M.ExportPDF]=EXEC_M.PDF;emm[VIEW_M.ExportExcel]=EXEC_M.EXCEL;emm[VIEW_M.ExportFlash]=EXEC_M.FLASH_EXPORT;var evts={};evts[VIEW_M.ViewStatic]=2048001;evts[VIEW_M.ViewInteractive]=2048001;evts[VIEW_M.ViewEditable]=2048001;evts[VIEW_M.ExportHTML]=3130;evts[VIEW_M.ExportExcel]=3069;evts[VIEW_M.ExportFlash]=3069;evts[VIEW_M.ExportPDF]=3069;evts[VIEW_M.ViewAnalysis]=2048001;evts[VIEW_M.HTML5Dashboard]=3140;var evt=2048001;if(st===14081){if(this.designMode){evt=3104;params={evt:evt,objectID:did,src:appName+"."+evt,rwDesignMode:this.designMode,executionMode:2};}else{if(vm>8){evt=evts[vm];params={evt:evt,documentID:did,src:appName+"."+evt};if(vm===VIEW_M.HTML5Dashboard){if(DOM.ISDXIE&&!DOM.isIE9){mstrmojo.alert(mstrmojo.desc(12187,"Please upgrade your browser or turn off Internet Explorer Compatibility View to work with HTML5 dashboards"));return false;}}else{params.executionMode=emm[vm]||0;}}else{evt=2048001;params={evt:evt,documentID:did,src:appName+"."+evt,visMode:vis||0,currentViewMedia:vm||2};}}}else{if(st===14080){params={evt:32001,documentID:did,src:appName+".32001"};}}break;case TP.Prompt:params={evt:3119,objectID:did,promptType:item.pt,src:appName+".3119"};break;default:return false;}toPage(params);},openCustomGroupEditor:function(item,options){var customGroupId=item.did;var id="mstrCGE",w=mstrmojo.all[id],openCGE=function(data){if(!w){return ;}data.scriptClass="mstrmojo.Obj";w.set("model",mstrmojo.insert(data));w.open();},reqModel=function(){var cfg={success:function(res){if(!res){mstrmojo.alert("Error retrieving the Custom Group definition!");return ;}openCGE(res);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mstrmojo.xhr.request("POST",mstrConfig.taskURL,cfg,{taskId:"getCustomGroup",customGroupId:customGroupId,styleName:"MojoCustomGroupStyle"});},newModel=function(){openCGE({cgp:{agg:1,flat:false,pf:true,rfi:-1,ce:true,isp:true}});},getModel=customGroupId?reqModel:newModel;if(!w){w=mstrmojo.insert(mstrmojo.CustomGroupEditor);w.set("noRefresh",true);if(options&&options.zIndex){w.set("zIndex",options.zIndex);}}getModel();},openMetricEditor:function(item,options){var metricId=item.did;var id="mstrMetricIDE",ide=mstrmojo.all[id];if(!ide){ide=mstrmojo.insert({scriptClass:"mstrmojo.ME.MetricIDE",id:id,metricId:metricId,noRefresh:true});if(options&&options.zIndex){ide.zIndex=options.zIndex;}}else{ide.set("metricId",metricId);}ide.open(null,{action:{cmd:metricId?"edit":"add"}});},openDataImport:function(){openDataImport({});},createFilter:function(){var params={evt:3113,src:(mstrApp.servletName||mstrApp.name)+".3113",isNew:true};checkSessionAndSendForm(params);},createDashboard:function(){var isHTML5=!mstrmojo.resolveFeature("flashvi"),params={evt:3187,src:(mstrApp.servletName||mstrApp.name)+".3187"};if(isHTML5&&mstrmojo.dom.isIE8){mstrmojo.alert(mstrmojo.desc(12187));return false;}if(isHTML5&&mstrApp.currentFolderId){params.parentFolderId=mstrApp.currentFolderId();}checkSessionAndSendForm(params);},openSharingEditor:openSharingEditor});var cubeHandler={isCubeSupportDDA:function(cubeInfo){return !!(cubeInfo&&(cubeInfo.dda===1||cubeInfo.dda===3));},allowCreateReport:function(cubeInfo){if(cubeInfo&&cubeInfo.ddam===2){mstrmojo.alert(mstrmojo.desc(13384,"The 'Create Report' option is currently not available for Live Connection Datasets."));}return true;},getCubesInfo:function(cubeIds,callback){mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(cubesInfo){callback(cubesInfo);}},{taskId:"getUserDICubeInfo",cubeIds:cubeIds.join(",")});},convertFromCube:function(config){var me=this,type=config.type,dssid=config.did,curFolder=config.folderId;this.getCubesInfo([dssid],function(cubesInfo){var cubeInfo=cubesInfo[dssid],servlet=mstrApp.name,dda=(cubeInfo&&!cubeInfo.published&&me.isCubeSupportDDA(cubeInfo)),extraCreateFlags=!!dda?128:0,params={};if(cubeInfo&&cubeInfo.ddam!==2&&!cubeInfo.published){mstrmojo.confirm(mstrmojo.desc(14111,"This cube has not been published"),{confirmBtn:{t:mstrmojo.desc(9242,"Republish"),fn:function onOK(){if(config.st===779&&(config.et&EXTENDED_TYPE_DATA_IMPORT)>0){openDataImport({CubeDesc:"",CubeName:config.executeReport,ReportId:dssid,folderId:curFolder,StatusCode:2,isEdit:false,callback:function(){me.convertFromCube(config);}});}else{var params={evt:4001,src:mstrApp.name+".4001",reportID:dssid,visMode:0,reportViewMode:1};toPage(params);}}}});return ;}switch(type){case"document":params={evt:"3104",src:servlet+".3104",executionMode:"2",rwDesignMode:"1",objectType:"3",objectID:dssid,rwCreateFlags:0};if(curFolder){params.saveFolderId=curFolder;}break;case"analysis":params={evt:"3104",src:servlet+".3104",executionMode:"1",rwDesignMode:"0",objectType:"3",objectID:dssid,rwCreateFlags:16,rwViewMode:8192};break;case"HTML5VI":params={evt:"3185",src:servlet+".3185",executionMode:"1",rwDesignMode:"0",objectType:"3",objectID:dssid,rwCreateFlags:32};if(curFolder){params.saveFolderId=curFolder;}break;case"report":if(!me.allowCreateReport(cubeInfo)){return ;}params={evt:"3005",src:servlet+".3005",srcID:dssid,srcType:2,reportDesignMode:1};break;}if(typeof params.rwCreateFlags==="number"){params.rwCreateFlags|=extraCreateFlags;}toPage(params);});}};function getFolderId(item){if(item.fdid){return item.fdid;}var items=item.anc&&item.anc.items||[],folder=items[items.length-1];return folder&&folder.did;}function loadDescriptors(config){var loadDescriptorBundle=function(){mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(res){if(res){var dlen=res.descriptors.length,di;for(di=0;di<dlen;di++){var d=res.descriptors[di];mstrmojo.descriptors[d.key]=d.v;}}if(config.callback){config.callback();}},failure:function(){if(config.callback){config.callback();}}},{taskId:"getBundleDescriptors",bundle:config.bundle});};loadDescriptorBundle();}function openDataImport(config){var curFolder=config.folderId,me=this;mstrmojo._IsWebApp.showWait();var openDI=function(){var di;if(me.dataImportId){di=mstrmojo.all[me.dataImportId];}if(!di){getDICss();mstrmojo.requiresBundle("mojo-di.js");di=mstrmojo.insert({scriptClass:"mstrmojo.DI.DIContainer"});di.dataImportCallback=function(datasets){var f=document.getElementById("formRefresh");if(f&&datasets&&datasets.length>0){f.submit();}};me.dataImportId=di.id;}if(config){mstrmojo.hash.copy(config,di.dataImportParams);if(config.callback){di.dataImportCallback=function(datasets){config.callback(datasets);};}else{if(config.isCalledByFlex){di.dataImportCallback=function(datasets){if(datasets&&datasets.length>0){var MSTRFlash;if(navigator.appName.indexOf("Microsoft")!==-1){MSTRFlash=window.MstrFlashFlashViewer;}else{MSTRFlash=document.MstrFlashFlashViewer;}if(MSTRFlash){MSTRFlash.onCloseDI(datasets);}}};}}}if(curFolder){mstrmojo.hash.copy({cubeSaveFolderId:curFolder},di.dataImportParams);}di.open();mstrmojo._IsWebApp.hideWait();};var checkSession=function(){var callback={success:function(res){if(res){openDI();}else{if(mstrApp.onSessionExpired){mstrApp.onSessionExpired();}}}},params={taskId:"keepSessionAlive"};mstrmojo.xhr.request("POST",mstrConfig.taskURL,callback,params);};var getDICss=function(){var file="data-import.css";if(DOM.isIE8||DOM.isIE9){file="data-import-ie.css";}var link=document.createElement("link");link.rel="stylesheet";link.href="../javascript/mojo/css/"+file;link.type="text/css";document.head.appendChild(link);};if(!this.dataImportId){loadDescriptors({bundle:"mojo-di",callback:checkSession});}else{checkSession();}}function openSharingEditor(href,objInfo,isLinkDirty,cfg){var $ID="sharingEditor",defaultOi=mstrApp.oi,objectID=(objInfo&&objInfo.objId)||defaultOi.objId,objectType=(objInfo&&objInfo.objType)||defaultOi.objType,messageId=(objInfo&&objInfo.mid)||mstrApp.getMsgID&&mstrApp.getMsgID(),showLinkOnOpen=cfg&&cfg.showLinkOnOpen,openSE=function(oi){var sharingEditor=mstrmojo.all[$ID];if(!sharingEditor){cfg=cfg||{};oi.acls=cfg.acls||oi.acls;sharingEditor=mstrmojo.insert(mstrmojo.hash.copy(cfg,{scriptClass:"mstrmojo.SharingEditor",guestModeEnabled:mstrApp.guestModeEnabled,mid:messageId,id:$ID,oi:oi,href:href,isLinkDirty:isLinkDirty,viewMode:objInfo?objInfo.viewMode:1,lastState:objInfo?objInfo.lastState:0,showWait:function(){mstrApp.showWait();},hideWait:function hideWait(){mstrApp.hideWait();},onClose:function(){this.destroy();}}));}else{sharingEditor.set("oi",oi);sharingEditor.href=href;sharingEditor.mid=messageId;sharingEditor.isLinkDirty=isLinkDirty;sharingEditor.viewMode=objInfo?objInfo.viewMode:1;sharingEditor.lastState=objInfo?objInfo.lastState:0;sharingEditor.showLinkOnOpen=showLinkOnOpen;}sharingEditor.open();},requestSharingEditor=function(){var cb={success:function(res){openSE(res.objects[0]);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));},complete:function(){mstrApp.hideWait();}};mstrmojo.xhr.request("POST",mstrConfig.taskURL,cb,{taskId:"getObjectInfo",objectIDs:objectID,objectTypes:objectType,includeACL:mstrmojo.resolveFeature("web-use-sharing-editor"),sessionState:mstrApp.sessionState});};mstrApp.showWait();requestSharingEditor();}}());