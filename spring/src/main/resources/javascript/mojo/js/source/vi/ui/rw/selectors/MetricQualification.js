(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.num","mstrmojo.dom","mstrmojo.string","mstrmojo.expr","mstrmojo.ui.Pulldown","mstrmojo.MetricSelectorUtility","mstrmojo.hash");var $M=mstrmojo.MetricSelectorUtility,$P=mstrmojo.vi.ui.rw.selectors.EnumWarningPosition,$OP=$M.OP,$NC=$M.EnumNumberCategory,$NM=mstrmojo.num,$D=mstrmojo.dom,$S=mstrmojo.string,$E=mstrmojo.expr,$DTP=$E.DTP,$HASH=mstrmojo.hash,valueOperators=$M.OP_NAMES.slice(0),rankOperators=$M.RANK_OP_NAMES.slice(0),notNull=function(){var check=function(v){return v===undefined||v===null;},i;for(i=0;i<arguments.length;i++){if(check(arguments[i])){return false;}}return true;},isValue=function(qualifyOn){return qualifyOn===$M.Q._G;},isPercent=function(qualifyOn){return qualifyOn===$M.Q._PT||qualifyOn===$M.Q._PB;},hasLeftTextBox=function(qua,opId){return !(isValue(qua)&&(opId===$OP._IS_NULL||opId===$OP._IS_NOT_NULL));},hasRightTextBox=function(qua,opId){return isValue(qua)&&(opId===$OP._BETWEEN||opId===$OP._NOT_BETWEEN);},isTextBoxEmpty=function(textBox){return !textBox.visible||$S.isEmpty(textBox.value);},getDtp=function(category,qualifyOn){return((category===$NC.Date||category===$NC.Time)&&qualifyOn===$M.Q._G)?$DTP.DATE:$DTP.REAL;},toPercent=function(isPercent,value){return value+((isPercent&&!$S.isEmpty(value)&&!String(value).match(/^\d+%$/))?"%":"");},getDefaultOpId=function(qua){return isValue(qua)?$OP._GREATER_EQUAL:$OP._LESS_EQUAL;},getCurrentSelectionParam=function(category,qualifyOn,op,leftValue,rightValue){var cs=[],dtp=getDtp(category,qualifyOn),isPercentType=isPercent(qualifyOn);if(op===$OP._IN||op===$OP._NOT_IN){var _cs=String(leftValue).split(";"),i;for(i=0;i<_cs.length;i++){if(!mstrmojo.string.isEmpty(_cs[i])){cs.push({dtp:dtp,v:toPercent(isPercentType,_cs[i])});}}}else{if(leftValue!==null){cs.push({dtp:dtp,v:toPercent(isPercentType,leftValue)});}if(rightValue!==null){cs.push({dtp:dtp,v:toPercent(isPercentType,rightValue)});}}return cs;},hideWarningIfShown=function(evt){this.parent.submit(this,true);},submitText=function(evt){var widget=this.parent;if(widget.valueChanged||this.value===""){widget.submit(this);}},visibleChange=function(){this.set("value","");},valueChange=function(){var widget=this.parent;widget.docSelector.hideWarning();widget.valueChanged=true;};mstrmojo.vi.ui.rw.selectors.MetricQualification=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasLayout,mstrmojo._HasPopup],{scriptClass:"mstrmojo.vi.ui.rw.selectors.MetricQualification",markupString:'<div id="{@id}" class="mstrmojo-vi-metric-qual {@cssClass}" style="{@cssText}"><div class="pulldown"></div><div class="v1"></div><div class="v2"></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;},leftTextNode:function(){return this.domNode.childNodes[1];},rightTextNode:function(){return this.domNode.childNodes[2];}},children:[{scriptClass:"mstrmojo.ui.Pulldown",alias:"func",isHostedWithin:false,items:valueOperators,isSilentSelected:false,onitemSelected:function(){var widget=this.parent,qua=widget.qua,opId=widget.opId,leftText=widget.leftText,rightText=widget.rightText,value=widget.func.getSelectedItem().v,oldOpId=opId;if(this.isSilentSelected){return ;}opId=widget.opId=isValue(qua)?value:$OP._LESS_EQUAL;leftText.set("visible",hasLeftTextBox(qua,opId));rightText.set("visible",hasRightTextBox(qua,opId));if(leftText.hasRendered&&leftText.visible){$D.setInputSelection(leftText.inputNode);}if(isValue(qua)){if(oldOpId!==opId){widget.opChanged=true;}this.parent.submit();}else{widget.set("qua",value);}}},{scriptClass:"mstrmojo.TextBox",alias:"leftText",slot:"leftTextNode",onEnter:submitText,onblur:hideWarningIfShown,onfocus:submitText,onvisibleChange:visibleChange,onvalueChange:valueChange},{scriptClass:"mstrmojo.TextBox",alias:"rightText",slot:"rightTextNode",onEnter:submitText,onblur:hideWarningIfShown,onfocus:submitText,onvisibleChange:visibleChange,onvalueChange:valueChange}],parseModel:function parseModel(){var qua=this.qua,cs=this.cs,da=this.da,f=this.f,ft=this.ft,isValueQua=isValue(qua),items=isValueQua?valueOperators:rankOperators,opId=notNull(f,ft)?$M.getOpIdxByfunc(f,ft):getDefaultOpId(qua),cs1,i;this.opId=opId;if(da){var lowValue,highValue;switch(qua){case $M.Q._G:lowValue=Number(da.low).toFixed(0);highValue=Number(da.high).toFixed(0);break;case $M.Q._RB:case $M.Q._RT:lowValue=1;highValue=da.cnt;break;case $M.Q._PB:case $M.Q._PT:lowValue=0;highValue=100;break;}this.set("low",lowValue);this.set("high",highValue);}cs1=(cs&&cs.length>0)?$NM.toLocaleString(cs[0].v):"";if(opId===$OP._IN||opId===$OP._NOT_IN){for(i=1;i<cs.length;i++){cs1+=";"+$NM.toLocaleString(String(cs[i].v));}}else{this.set("cs2",(cs&&cs.length>1)?$NM.toLocaleString(cs[1].v):"");}if(cs&&cs.length>0&&isPercent(qua)&&!cs1.match("%")){cs1=$NM.toLocaleString(cs[0].v*100);}this.set("cs1",cs1);var leftText=this.leftText,rightText=this.rightText,func=this.func;leftText.set("visible",hasLeftTextBox(qua,opId));leftText.set("value",this.cs1);rightText.set("visible",hasRightTextBox(qua,opId));rightText.set("value",this.cs2);func.set("items",items);func.isSilentSelected=true;func.selectItemByField("v",isValueQua?opId:qua);func.isSilentSelected=false;this.valueChanged=false;},onquaChange:function onquaChange(evt){var oldQua=evt.valueWas,newQua=evt.value,oldFt=$M.getFuncInfo(this.opId,oldQua).ft,newFt=$M.getFuncInfo(this.opId,newQua).ft;this.opId=getDefaultOpId(newQua);this.changeQual=true;if(newFt!==oldFt){var fInfo=$M.getFuncInfo(this.opId,newQua);this.cs=[];this.f=fInfo.f;this.ft=fInfo.ft;this.parseModel();}else{this.submit();}},validateValues:function validateValues(submitTextBox){var leftTextBox=this.leftText,rightTextBox=this.rightText,qua=this.qua,opId=this.opId,validation;if(opId===$OP._IS_NULL||opId===$OP._IS_NOT_NULL){this.docSelector.hideWarning();return null;}if(opId===$OP._IN||opId===$OP._NOT_IN){var _cs=String(leftTextBox.value).split(";"),i;for(i=0;i<_cs.length;i++){validation=$M.doValidation(_cs[i],this,{refNode:leftTextBox.inputNode,position:$P.TOP,closeOnClick:false});if(validation.invalid){return validation;}}}else{submitTextBox=submitTextBox||leftTextBox;validation=$M.doValidation(submitTextBox.value,this,{refNode:submitTextBox.inputNode,position:$P.TOP,closeOnClick:false});if(!validation.invalid&&hasRightTextBox(qua,opId)){var anotherBox=(submitTextBox===leftTextBox)?rightTextBox:leftTextBox;validation=$M.doValidation(anotherBox.value,this,{refNode:anotherBox.inputNode,position:$P.TOP,closeOnClick:false});}return validation.invalid?validation:null;}return null;},submit:function submit(textBox,hideWarningIfShown){var oldError=this.validation&&this.validation.errorCode,errValidation=this.validateValues(textBox),warningBox=textBox?textBox.parent.parent.warning:null,isWarningVisible=warningBox?warningBox.visible:null,hasValueChanged=this.valueChanged||this.value==="";if(!errValidation||!errValidation.invalid){if(hasValueChanged||this.changeQual||!!this.opChanged){var qua=this.qua,opId=this.opId,cs1=this.cs1=hasLeftTextBox(qua,opId)?this.leftText.value:null,cs2=this.cs2=hasRightTextBox(qua,opId)?this.rightText.value:null;this.cs=getCurrentSelectionParam(this.numFmts.cat,qua,opId,cs1,cs2);this.parent.node.data.cs=this.cs;this.changeQual=true;this.onchange();this.valueChanged=false;this.opChanged=false;this.changeQual=false;}}else{if(textBox){if(isWarningVisible&&hideWarningIfShown&&errValidation.errorCode===oldError){this.set("validation",null);}else{this.set("validation",errValidation);$D.setInputSelection(errValidation.refNode);}}}return !errValidation;},updateData:function updateData(da,props){this.da=da;this.updateExpr(props);},updateExpr:function updateExpr(props){if(props){this.cs=props.cs;this.f=props.f;this.ft=props.ft;this.qua=props.qua;}this.parseModel();},doLayout:function doLayout(){this.layoutConfig=this.layoutConfig?$HASH.copy({xt:true},this.layoutConfig):{xt:true};if(this.parent.isInFilterPanel()){this.layoutConfig.w={containerNode:"65%",leftTextNode:"30%",rightTextNode:"30%"};}this._super();}});}());