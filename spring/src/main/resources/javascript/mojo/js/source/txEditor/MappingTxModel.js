(function(){mstrmojo.requiresCls("mstrmojo.Model","mstrmojo.hash","mstrmojo.num","mstrmojo.string","mstrmojo.date","mstrmojo.Arr","mstrmojo.array","mstrmojo.txEditor.CommonComponent");mstrmojo.requiresDescs(8258,8278,8279,8283,8284,8999);var _H=mstrmojo.hash,_N=mstrmojo.num,_S=mstrmojo.string,_A=mstrmojo.array,_P=mstrmojo.date,_TC=mstrmojo.txEditor.CommonComponent,_TCCH=_TC.CHANGE_TYPES,_TCCT=_TC.CTRL_TYPES,_TCIV=_TC.INPUT_VALUES,_TCLT=_TC.LIST_TYPES,DSSXML_ATTRIBUTE=12,REG_EXP=5;var _getPDList=function _getPDList(arr){return arr.t===_TCCT.CTRL_LIST&&arr.st===_TCLT.LIST_TYPE_PULLDOWN;};mstrmojo.txEditor.MappingTxModel=mstrmojo.declare(mstrmojo.Model,null,{scriptClass:"mstrmojo.txEditor.MappingTxModel",markMappedObjects:function(){var tscObjs=this.rwTxs.tscObjs,txInputs=this.txRpt.inputs,i,len;for(i=0,len=tscObjs.length;i<len;i++){tscObjs[i].mapped=0;}for(i=0,len=txInputs.length;i<len;i++){var toi=txInputs[i].toi;if(_N.isInt(toi)){tscObjs[toi].mapped=1;}}this.raiseEvent({name:"InputMappingModify"});},setTxReport:function(txRptId,txRptName,newFlag){this.isNew=newFlag;this.rwTxs.txRptId=txRptId;if(!this.rwTxs.ctp){this.rwTxs.ctp=_TCCH.CHANGE_TYPE_DEFAULT;}if(!this.rwTxs.arn){this.rwTxs.arn=0;}mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(res){if(res){res.nm=txRptName;mstrmojo.all.teModel.set("txRpt",res);mstrmojo.all.teModel.markMappedObjects();}},failure:function(res){_TC.showError(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{taskId:"getTransactionReportDefinition",transactionReportId:txRptId});},_set_rwTxs:function(n,v){var ls=v.tscObjs,len=ls.length,i;for(i=0;i<len;i++){ls[i].idx=i;}this.rwTxs=v;if(this.rwTxs.txRptId){this.setTxReport(this.rwTxs.txRptId,this.rwTxs.txRptName,false);}this.dirty=false;return true;},_set_txRpt:function(n,v){var i,l,j,ll,a,k,lll;if(v){for(i=0,l=v.inputs.length;i<l;i++){var ti=v.inputs[i];_H.make(ti,mstrmojo.Obj);ti.edt=0;ti.ctl=null;for(j=0,ll=this.rwTxs.tscObjs.length;j<ll;j++){var tso=this.rwTxs.tscObjs[j];if(this.isNew){if(tso.did===ti.did&&tso.fid===ti.fid){ti.toi=tso.idx;break;}}else{if(tso.tix===ti.tix){ti.toi=tso.idx;ti.edt=tso.edt;ti.req=tso.req;ti.ctl=tso.ctl||null;if(ti.ctl){var dfvs=this.rwTxs.dfvs,pr=ti.ctl.pr;if(ti.dtp===14||ti.dtp===15||ti.dtp===16){if(pr.t===_TCCT.CTRL_CALENDAR){pr.max=_TC.toLocaleDateString(pr.max);pr.min=_TC.toLocaleDateString(pr.min);}else{if(pr.vls){var vls=pr.vls;for(a=0,lll=vls.length;a<lll;a++){var vl=vls[a];vl.v=_TC.toLocaleDateString(vl.v);}}}}pr.dtp=ti.dtp;for(k=0,lll=dfvs.length;k<lll;k++){if(dfvs[k].t===pr.t&&(dfvs[k].st===pr.st||(pr.st===undefined&&dfvs[k].st===0))){ti.ctl.pr=_H.copy(pr,_H.clone(dfvs[k]));break;}}if(pr.t===_TCCT.CTRL_LIST&&pr.ipt===_TCIV.INPUT_VALUES_DATASET&&!ti.ctl.ddic){ti.ctl.ddic={};}_H.make(ti.ctl,mstrmojo.Obj);_H.make(ti.ctl.pr,mstrmojo.Obj);_H.make(ti.ctl.ddic,mstrmojo.Obj);}if(ti.edt===1&&!ti.ctl){ti.edt=0;}break;}}}}}else{this.set("currentTxInput",null);if(this.rwTxs){_A.forEach(this.rwTxs.tscObjs,function(tscObj){tscObj.mapped=0;tscObj.edt=0;if(tscObj.ctl){tscObj.ctl={ctlKey:tscObj.ctl.ctlKey};}});}}this.txRpt=v;return true;},_set_currentTxInput:function(n,v){if(v&&v.ctl){v.ctl.dirty=-1;}this.currentTxInput=v;return true;},updateTxMapping:function(txInput,idx){var i,len;if(_N.isInt(idx)){var tscObjs=this.rwTxs.tscObjs,inputs=this.txRpt.inputs;if(_N.isInt(txInput.toi)){tscObjs[txInput.toi].mapped=0;}tscObjs[idx].mapped=1;if(txInput.ctl&&txInput.ctl===tscObjs[txInput.toi].ctl){txInput.ctl=_H.clone(txInput.ctl);}for(i=0,len=inputs.length;i<len;i++){if(inputs[i].toi===idx){inputs[i].set("toi",null);inputs[i].set("edt",0);inputs[i].set("ctl",null);break;}}txInput.set("toi",idx);this.raiseEvent({name:"InputMappingModify"});}},updateDDICSetting:function(txInput){var i,len;if(!txInput.ctl.ddic){var ddic=new mstrmojo.Obj(),rwTxs=mstrmojo.all.teModel.rwTxs,ds=rwTxs.ds,idx=mstrmojo.array.find(rwTxs.tscObjs,"idx",txInput.toi),to=rwTxs.tscObjs[idx];if(to.tp===DSSXML_ATTRIBUTE){for(i=0,len=ds.length;i<len;i++){if(mstrmojo.array.find(ds[i].attrs,"did",to.did)>-1){ddic.dsid=ds[i].dsid;ddic.dst=ds[i].dst;break;}}ddic.cst=to.tp;ddic.csid=to.did;if(txInput.ctl.pr.t===_TCCT.CTRL_BARCODE){ddic.mfid=to.fid;}ddic.wfid=to.fid;ddic.dfid=1;}txInput.ctl.set("ddic",ddic);}},getControls:function(dtp){var ctrls,i,len;if(_TC.isNumericType(dtp)){ctrls=[_TCCT.CTRL_SLIDER,_TCCT.CTRL_TEXTFIELD,_TCCT.CTRL_TEXTAREA,_TCCT.CTRL_SWITCH,_TCCT.CTRL_LIST,_TCCT.CTRL_TOGGLE,_TCCT.CTRL_RATING,_TCCT.CTRL_STEPPER,_TCCT.CTRL_LIKERTSCALE,_TCCT.CTRL_BARCODE];}else{if(_TC.isStringType(dtp)){ctrls=[_TCCT.CTRL_TEXTFIELD,_TCCT.CTRL_TEXTAREA,_TCCT.CTRL_SWITCH,_TCCT.CTRL_LIST,_TCCT.CTRL_TOGGLE,_TCCT.CTRL_SIG_CAPTURE,_TCCT.CTRL_BARCODE];}else{if(dtp===14){ctrls=[_TCCT.CTRL_CALENDAR,_TCCT.CTRL_TEXTFIELD,_TCCT.CTRL_TEXTAREA,_TCCT.CTRL_LIST];}else{if(dtp===15){ctrls=[_TCCT.CTRL_TIMEPICKER,_TCCT.CTRL_TEXTFIELD,_TCCT.CTRL_TEXTAREA,_TCCT.CTRL_LIST];}else{if(dtp===16){ctrls=[_TCCT.CTRL_CALENDAR,_TCCT.CTRL_TIMEPICKER,_TCCT.CTRL_TEXTFIELD,_TCCT.CTRL_TEXTAREA,_TCCT.CTRL_LIST];}else{ctrls=[_TCCT.CTRL_TEXTFIELD,_TCCT.CTRL_TEXTAREA,_TCCT.CTRL_SWITCH,_TCCT.CTRL_LIST,_TCCT.CTRL_SLIDER,_TCCT.CTRL_CALENDAR,_TCCT.CTRL_TIMEPICKER,_TCCT.CTRL_TOGGLE];}}}}}for(i=0,len=ctrls.length;i<len;i++){switch(ctrls[i]){case _TCCT.CTRL_LIST:ctrls[i]=mstrmojo.array.filter(this.rwTxs.dfvs,_getPDList)[0];break;default:ctrls[i]=this.rwTxs.dfvs[mstrmojo.array.find(this.rwTxs.dfvs,"t",ctrls[i])];}ctrls[i].n=_TC.CONTROL_NAMES[ctrls[i].t];}return ctrls;},isAllInputsMapped:function(){var txInputs=mstrmojo.all.teModel.txRpt.inputs,i,len;for(i=0,len=txInputs.length;i<len;i++){if(!_N.isInt(txInputs[i].toi)){_TC.showError(mstrmojo.desc(8257));return false;}}return true;},isPropertiesValid:function(){var cti=this.currentTxInput,pr=cti&&cti.editing&&cti.ctl.pr,errMsg="",i,j,len,vl;if(pr){for(i in pr){if(i==="vls"){for(j=0,len=pr.vls.length;j<len;j++){vl=pr.vls[j];if(vl.invalidFlag===1){errMsg=mstrmojo.desc(8258);break;}}}else{if(pr[i]===null){if(pr.ipt!==undefined&&pr.ipt!==_TCIV.INPUT_VALUES_CALCULATED&&(i==="min"||i==="max"||i==="itv")){continue;}else{if(pr.t===_TCCT.CTRL_TEXTFIELD){if((_TC.isNumericType(cti.dtp)&&((i==="min"&&pr.emin)||(i==="max"&&pr.emax)))||(_TC.isStringType(cti.dtp)&&(i==="ml"||i==="mnl"))||(pr.vm===REG_EXP&&i==="rgx")){errMsg=mstrmojo.desc(8258);}}else{errMsg=mstrmojo.desc(8258);}}}}if(errMsg){break;}}if(!errMsg){switch(pr.t){case _TCCT.CTRL_TEXTFIELD:if(_TC.isNumericType(cti.dtp)){if(pr.emin&&pr.emax){if(parseFloat(pr.min)>parseFloat(pr.max)){errMsg=mstrmojo.desc(8283);}}}else{if(_TC.isStringType(cti.dtp)){if(parseInt(pr.mnl,10)>parseInt(pr.ml,10)){errMsg=mstrmojo.desc(8999);}}}break;case _TCCT.CTRL_CALENDAR:if(pr.min&&pr.max&&_P.compareDateAndOrTime(pr.min,pr.max)>0){errMsg=mstrmojo.desc(8278);}break;case _TCCT.CTRL_RATING:if(pr.vls.length===0){errMsg=mstrmojo.desc(8258);}break;case _TCCT.CTRL_SLIDER:case _TCCT.CTRL_LIST:case _TCCT.CTRL_STEPPER:case _TCCT.CTRL_BARCODE:if(pr.t===_TCCT.CTRL_STEPPER||pr.ipt===_TCIV.INPUT_VALUES_CALCULATED){var min=parseFloat(pr.min),max=parseFloat(pr.max),range=max-min,itv=parseFloat(pr.itv),esp=0.00001;if(range<=0){errMsg=mstrmojo.desc(8283);}else{if(itv-range>esp||Math.abs(Math.round(range/itv)*itv-range)>esp){errMsg=mstrmojo.desc(8284);}}break;}else{if(pr.t===_TCCT.CTRL_BARCODE||pr.ipt===_TCIV.INPUT_VALUES_DATASET){if(pr.t===_TCCT.CTRL_BARCODE&&!pr.em){break;}var ddic=cti.ctl.ddic;if(!ddic.dsid||!ddic.csid||!ddic.wfid||!ddic.dfid){errMsg=mstrmojo.desc(8258);}if(pr.t===_TCCT.CTRL_BARCODE&&!ddic.mfid){errMsg=mstrmojo.desc(8258);}break;}}case _TCCT.CTRL_TOGGLE:var isListEmpty=true;for(i=0,len=pr.vls.length;i<len;i++){vl=pr.vls[i];if(!_S.isEmpty(vl.n)||!_S.isEmpty(vl.v)){isListEmpty=false;break;}}if(isListEmpty){errMsg=mstrmojo.desc(8279);}break;}}}if(errMsg){_TC.showError(errMsg);return false;}return true;},clearDirtyFlags:function clearDirtyFlags(){this.isNew=false;this.dirty=false;var tscObjs=this.rwTxs&&this.rwTxs.tscObjs||[],tscObj,i,len;for(i=0,len=tscObjs.length;i<len;++i){tscObj=tscObjs[i];tscObj.mark=0;if(tscObj.ctl){tscObj.ctl.dirty=false;}}},hasDirtyTscObjs:function hasDirtyTscObjs(){var hasDirtyTscObjs=this.isNew||(!this.txRpt)||this.dirty;if(!hasDirtyTscObjs){var inputs=this.txRpt.inputs,tscObjs=this.rwTxs.tscObjs,input,tscObj,i,len;for(i=0,len=inputs.length;i<len&&!hasDirtyTscObjs;++i){input=inputs[i];tscObj=tscObjs[input.toi];if(!tscObj||tscObj.tix!==input.tix||tscObj.edt!==input.edt||(input.ctl&&input.ctl.dirty)){hasDirtyTscObjs=true;}}}return hasDirtyTscObjs;},getXML:function(){if(!this.txRpt){return _S.json2xml("rwTxs",{keyCtx:this.rwTxs.keyCtx},{isSerializable:function(){return true;}});}var inputs=this.txRpt.inputs,tscObjs=this.rwTxs.tscObjs,dirtyTscObjs=[],ctlKey,i,len,input,tscObj;for(i=0,len=inputs.length;i<len;i++){input=inputs[i];tscObj=tscObjs[input.toi];if(this.isNew||tscObj.tix!==input.tix||tscObj.edt!==input.edt||(input.ctl&&input.ctl.dirty)){dirtyTscObjs.push(tscObj);}tscObj.tix=input.tix;tscObj.edt=input.edt;tscObj.req=input.req||0;ctlKey=tscObj.ctl&&tscObj.ctl.ctlKey;tscObj.ctl=input.ctl;if(tscObj.ctl){tscObj.ctl.ctlKey=ctlKey||mstrmojo.all.teModel.getNewCtlKey();}tscObj.mark=-1;}for(i=0;i<tscObjs.length;i++){tscObj=tscObjs[i];if(!tscObj.mark&&_N.isInt(tscObj.tix)){tscObj.edt=0;tscObj.req=0;tscObj.ctl=null;tscObj.tix=-1;dirtyTscObjs.push(tscObj);}tscObj.mark=0;}var cfg={isSerializable:function(nodeName,jsons,idx){var pr=jsons[idx],t=pr.t;switch(nodeName){case"keyCtx":case"txRptId":case"tp":case"ctp":case"arc":case"sci":case"arn":case"tscObjs":case"did":case"fid":case"key":case"edt":case"req":case"tix":case"ctl":case"ctlKey":case"ddic":case"dsid":case"dst":case"csid":case"cst":case"wfid":case"dfid":case"mfid":case"pr":case"ml":case"mnl":case"emax":case"emin":case"vm":case"rgx":case"siwc":case"sp":case"pl":case"w":case"wm":case"ict":case"ipt":case"itv":case"dm":case"t":case"ust":case"sgl":case"psw":case"ldw":case"st":case"mint":case"maxt":case"stl":case"em":case"ipr":case"sort":case"sortfmid":case"sortdir":return true;case"min":case"max":var v=pr[nodeName];if(t===_TCCT.CTRL_CALENDAR){return{att:nodeName+'="'+_S.encodeXMLAttribute(_TC.toUSDateString(v))+'"'};}return true;case"vls":var vls=pr.vls,dtp=pr.dtp,regExp=/(\^|\||\\)/g,as=[],j,ESC=function(n){if(_S.isEmpty(n)){n="";}return(typeof n==="string")?n.replace(regExp,"\\$1"):n;};if((t===_TCCT.CTRL_LIST||t===_TCCT.CTRL_SLIDER)&&pr.ipt!==_TCIV.INPUT_VALUES_MANUAL){return{att:'vls=""'};}for(j=0;j<vls.length;j++){var vl=vls[j],s="";if(vl.unset){continue;}if(t===_TCCT.CTRL_TOGGLE||t===_TCCT.CTRL_LIST||t===_TCCT.CTRL_RATING||t===_TCCT.CTRL_LIKERTSCALE){s+=ESC(vl.n)+"^";}if(!_S.isEmpty(vl.v)){if(dtp===14||dtp===15||dtp===16){s+=ESC(_TC.toUSDateString(vl.v));}else{s+=ESC(vl.v);}}if(s){as.push(s);}}return{att:'vls="'+_S.encodeXMLAttribute(as.join("|"))+'"'};}return false;},getArrItemName:function(n,v,i){if(n==="tscObjs"){return"tscObj";}},skipNull:true};var temp=this.rwTxs.tscObjs;this.rwTxs.tscObjs=dirtyTscObjs;var xml=_S.json2xml("rwTxs",this.rwTxs,cfg);this.rwTxs.tscObjs=temp;return xml;}});}());