(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo._TouchGestures","mstrmojo.TouchScroller","mstrmojo._HasTouchScroller");var legendFontStyle="bold 14px Roboto",legendFontStyleHighlight="bold 18px Roboto",legendSwitcherBarHeight=30,zf=1;function resetSizeByDPI(zoomfactor){zf=zoomfactor;legendFontStyle="bold "+Math.round(14*zf)+"px Roboto";legendFontStyleHighlight="bold "+Math.round(18*zf)+"px Roboto";legendSwitcherBarHeight=Math.round(30*zf);}function getTouchedElement(touch){var item=mstrmojo.dom.findAncestorByAttr(touch.target,"clk",true,this.domNode);return item||null;}function setScrollerPosition(){var scl=this._scroller;var realHeight=this.height-this.legendBarSwitcher.height-15*zf;var realOffSetHeight=this.legendListDiv.offsetHeight;if(realOffSetHeight>realHeight){this.scrollPast=true;}var offsetEnd=realOffSetHeight>realHeight?realOffSetHeight-realHeight:0;scl.origin={x:0,y:0};scl.showScrollbars=true;scl.noVScroll=false;scl.vScroll=(offsetEnd!==0&&scl.noVScroll!==true)||this.scrollPast;if(scl.vScroll){scl.offset={y:{start:0,end:offsetEnd},scrollPast:this.scrollPast};}var icn=this.legendListDiv;this.utils.translateCSS(0,0,false,icn);}mstrmojo.VisTimeSeriesLegend=mstrmojo.declare(mstrmojo.Vis,[mstrmojo._TouchGestures,mstrmojo._HasTouchScroller],{scriptClass:"mstrmojo.VisTimeSeriesLegend",scrollerConfig:{bounces:false,showScrollbars:true,useTranslate3d:true},multiTouch:true,scrollPast:false,isAndroidTab:false,legendBarWidth:30,isLegendBarOpen:false,isLegendSelected:false,legendSelectedIndex:-1,maxLegendAttrLength:0,widget:null,y_axis_interval:25,markupString:'<div id="{@id}-legend-bar" style="position:absolute;top:{@top};right:{@right};z-index:{@zIndex};" ><div id="{@id}-legend-switcher" class="mstrmojo-timeseries-legend-switcher" clk="S"><canvas id="{@id}-legend-triangle" width="15px" height="17px" style="position:absolute;" ></canvas><div id="{@id}-legend-shadow" class="timeseries-legend-switcher-shadow" style="height:0px; width:0px;position:absolute"></div></div><div class="mstrmojo-timeseries-legend-List-Div" style="overflow:hidden;"><div id="{@id}-legend-List" ></div></div><canvas style="z-index:-1;" clk="C"></canvas></div>',markupSlots:{legendBarDiv:function(){return this.domNode;},legendBarSwitcher:function(){return this.domNode.firstChild;},triangle:function(){return this.domNode.firstChild.firstChild;},legendListDivContainer:function(){return this.domNode.childNodes[1];},legendListDiv:function(){return this.domNode.childNodes[1].firstChild;},legendCanvas:function(){return this.domNode.childNodes[2];}},switchLegendBar:function switchLegendBar(){this.isLegendBarOpen=!this.isLegendBarOpen;this.calculateAndSetLegendWidth();this.widget.reDrawSlaveChartImpl();this.renderLegend(true);setScrollerPosition.call(this);},enableLegendGlowEffect:function enableLegendGlowEffect(index,clr){var selectedLegend=this.legendListDiv.childNodes[index];var color=clr||selectedLegend.style.color;selectedLegend.style.font=legendFontStyleHighlight;},hiddenLegendGlowEffect:function hiddenLegendGlowEffect(index){var selectedLegend=this.legendListDiv.childNodes[index];selectedLegend.style.textShadow="none";selectedLegend.style.font=legendFontStyle;},toggleTriangle:function toggleTriangle(open){var canvas=this.triangle,tStyle=canvas.style,cntx=canvas.getContext("2d"),ts=this.widget;var triH=Math.round(17*zf),triW=Math.round(15*zf);canvas.height=triH;canvas.width=triW;tStyle.top=Math.round(7*zf)+"px";tStyle.left=Math.round(8*zf)+"px";cntx.save();cntx.fillStyle=ts.utils.rgb2rgbStr(ts.formatProp.textClr,0.75);cntx.beginPath();if(open){cntx.moveTo(0,0);cntx.lineTo(triW,triH/2);cntx.lineTo(0,triH);cntx.lineTo(0,0);}else{cntx.moveTo(0,triH/2);cntx.lineTo(triW,0);cntx.lineTo(triW,triH);cntx.lineTo(0,triH/2);}cntx.closePath();cntx.fill();cntx.restore();},renderLegend:function renderLegend(hasGlowEffect){var model=this.model,s=model.series,sl=s&&s.length||0,h=this.height,utils=this.utils,ch=model.colHeaders,lc=this.legendCanvas.getContext("2d"),legendListDiv=this.legendListDiv,legendBarSwitcher=this.legendBarSwitcher;this.legendBarDiv.style.width=this.legendBarWidth+"px";this.legendBarDiv.style.height=h+"px";legendListDiv.style.width=this.legendBarWidth+"px";legendBarSwitcher.width=this.legendBarWidth;legendBarSwitcher.height=legendSwitcherBarHeight;legendBarSwitcher.style.width=this.legendBarWidth+"px";this.legendCanvas.width=this.legendBarWidth;this.legendCanvas.height=h;if(this.isLegendSelected&&this.legendSelectedIndex>=sl){this.legendSelectedIndex=0;this.widget.setLegendSelected(this.isLegendSelected,this.legendSelectedIndex);}if(legendListDiv.childNodes.length==0){for(var i=0;i<sl;i++){var legendAttr=document.createElement("div");legendAttr.id="legendAttr"+i;legendAttr.style.font=legendFontStyle;legendAttr.className="timeseries-legendAttr";legendAttr.innerHTML=this.widget.getLegendName(ch,s,i);legendAttr.setAttribute("clk","LA");legendAttr.setAttribute("vIndex",i);legendAttr.style.color=this.widget.getSerieColor(i);legendListDiv.appendChild(legendAttr);utils.changeElementSize(legendAttr,"height",utils.getScreenZoomFactor());}this.y_axis_interval=Math.max(legendAttr.offsetHeight,25);}if(this.isLegendBarOpen){this.toggleTriangle(true);legendListDiv.style.display="block";this.legendListDivContainer.style.height=(h-legendBarSwitcher.height-15*zf)+"px";this.legendListDivContainer.style.weight=this.legendBarWidth+"px";this._scroller.updateScrollBars();this.utils.translateCSS(0,legendBarSwitcher.height,false,this.legendListDivContainer);if(this.isLegendSelected){this.enableLegendGlowEffect(this.legendSelectedIndex);}this.legendCanvas.height=h;this.legendCanvas.style.position="absolute";this.legendCanvas.style.top="0px";this.legendCanvas.style.left="0px";this.drawLegendOutline(h,legendBarSwitcher.height,lc);}else{this.toggleTriangle(false);legendListDiv.style.display="none";this.legendCanvas.height=h;this.legendCanvas.style.position="absolute";this.legendCanvas.style.top="0px";this.legendCanvas.style.left="0px";this.drawLegendOutline(h,legendBarSwitcher.height,lc);lc.save();var x=this.legendBarWidth/2;var y=this.y_axis_interval/2;var r=Math.round(5*zf);for(var i=0;i<sl&&y+this.y_axis_interval<h-15*zf;i++){lc.fillStyle=this.widget.getSerieColor(i);y+=this.y_axis_interval;utils.drawArc(this,x,y,r,0,Math.PI*2,true,true,lc);}lc.restore();}var glowDiv=this.legendBarSwitcher.lastChild;if(hasGlowEffect){glowDiv.className="timeseries-legend-switcher-shadow";glowDiv.style.left=Math.round(15*zf)+"px";glowDiv.style.top=Math.round(15*zf)+"px";glowDiv.style.display="";glowDiv.style.visibility="visible";}else{glowDiv.className="";glowDiv.style.visibility="hidden";}},reRender:function reRender(){this.calculateAndSetLegendWidth();this.height=this.calculateHeight();this.renderLegend(false);this.legendBarDiv.style.top=this.widget.margin.t+"px";setScrollerPosition.call(this);},hiddenSwitcherArrowGlowEffect:function hiddenSwitcherArrowGlowEffect(){var glowDiv=this.legendBarSwitcher.lastChild;glowDiv.innerHTML="";glowDiv.style.visibility="hidden";},drawLegendOutline:function drawLegendOutline(totalH,switcherH,context){var utils=this.utils,formatProp=this.widget.formatProp;context.save();context.globalAlpha=0.5;context.strokeStyle=utils.rgb2rgbStr(formatProp.textClr);context.lineWidth=2;utils.drawHalfRoundedRectangle(this,1,1,this.legendBarWidth,totalH-2,Math.round(10*zf),false,context);context.globalAlpha=1;var gradient=context.createLinearGradient(0,0,this.legendBarWidth-2,0);var topGradient=utils.rgb2rgbStr(formatProp.textClr,0.5)||"#58595B";var bottomGradient=utils.rgb2rgbStr(formatProp.textClr,0.13)||"#222222";gradient.addColorStop(0,topGradient);gradient.addColorStop(1,bottomGradient);context.strokeStyle=gradient;context.lineWidth=1;var yPos=switcherH-0.5;utils.drawLineSet(this,[{x:2,y:yPos},{x:this.legendBarWidth,y:yPos}],false,context);context.restore();},calculateMaxLegendAttrLength:function calculateMaxLegendAttrLength(useHighlightFontStyle){var model=this.model,s=model.series,sl=s.length,ch=model.colHeaders;for(var i=0;i<sl;i++){var tmpLegendLength=0;var legendName=this.widget.getLegendName(ch,s,i);var fontStyle=useHighlightFontStyle?legendFontStyleHighlight:legendFontStyle;tmpLegendLength=this.widget.getTextWidth(legendName,fontStyle);this.maxLegendAttrLength=Math.max(this.maxLegendAttrLength,tmpLegendLength);}this.maxLegendAttrLength=this.maxLegendAttrLength+10;},calculateAndSetLegendWidth:function cLegendWidth(){if(this.isLegendBarOpen){var maxLegendBarWidth=(this.widget.getWidth()-50)*0.3+20;this.legendBarWidth=Math.min(maxLegendBarWidth,this.maxLegendAttrLength);}else{this.legendBarWidth=Math.round(40*zf);}this.widget.setlegendStatus(this.isLegendBarOpen,this.legendBarWidth);},calculateHeight:function cHeight(){var m=this.widget.margin;return this.widget.getHeight()-this.widget.masterChartHeight-m.t-m.b;},postBuildRendering:function postBR(){resetSizeByDPI(this.utils.getScreenZoomFactor());this.height=this.calculateHeight();var sLength=this.model.series&&this.model.series.length;if(sLength==1){this.isLegendSelected=true;this.legendSelectedIndex=0;this.widget.setLegendSelected(this.isLegendSelected,this.legendSelectedIndex);}this.calculateMaxLegendAttrLength(sLength==1);this.calculateAndSetLegendWidth();this.scrollerConfig.scrollEl=this.legendListDiv;if(this._super){this._super();}this.renderLegend(false);setScrollerPosition.call(this);},initScroller:function initScroller(scroller){scroller.vScroll=true;this._super(scroller);},touchBegin:function touchBegin(touch){this.widget.hiddenTooltipAndShowTimeSelector();var item=getTouchedElement.call(this,touch);if(item){var value=item.value;if(value==="S"){this.switchLegendBar();}else{if(!this.isLegendBarOpen&&value==="C"){this.switchLegendBar();}}}},touchTap:function touchTap(touch){var item=getTouchedElement.call(this,touch);if(item){var value=item.value;if(value==="LA"){var itemIndex=mstrmojo.dom.findAncestorByAttr(touch.target,"vIndex",true,this.domNode);if(itemIndex){this.handleLegendItemTap(parseInt(itemIndex.value,10));}}}},touchEnd:function touchEnd(touch){var me=this;me.hiddenSwitcherArrowGlowEffect();},touchSelectBegin:function touchSelectBegin(touch){var item=getTouchedElement.call(this,touch);if(item){var value=item.value;if(value==="LA"){var itemIndex=mstrmojo.dom.findAncestorByAttr(touch.target,"vIndex",true,this.domNode);if(itemIndex){var fontStyle=(itemIndex.value==this.legendSelectedIndex)?legendFontStyleHighlight:legendFontStyle;var tmpItemLength=this.widget.getTextWidth(item.node.innerHTML,fontStyle);if(tmpItemLength>this.legendBarWidth-12){var tooltipY=item.node.offsetTop-this._scroller.origin.y+this.widget.margin.t+this.legendBarSwitcher.height-5;this.widget.showLegendTooltip(item.node);}}}}},touchSelectEnd:function touchSelectEnd(touch){this.widget.hiddenLegendTooltip();},touchMultiBegin:function touchMultiBegin(touch){this.touchSelectEnd(touch);},onCrossWidgetMultitouch:function onCrossWidgetMultitouch(){this.widget.hiddenLegendTooltip();this.hiddenSwitcherArrowGlowEffect();},handleLegendItemTap:function handleLegendItemTap(vIndex){if(this.model.series.length==1){return ;}if(this.isLegendSelected){if(this.legendSelectedIndex===vIndex){this.isLegendSelected=false;this.hiddenLegendGlowEffect(vIndex);this.legendSelectedIndex=-1;}else{this.hiddenLegendGlowEffect(this.legendSelectedIndex);this.legendSelectedIndex=vIndex;this.enableLegendGlowEffect(vIndex);}}else{this.isLegendSelected=true;this.legendSelectedIndex=vIndex;this.enableLegendGlowEffect(vIndex);}this.widget.setLegendSelected(this.isLegendSelected,this.legendSelectedIndex);this.widget.reDrawSlaveChart();},destroy:function destroy(){if(this._super){this._super();}}});})();