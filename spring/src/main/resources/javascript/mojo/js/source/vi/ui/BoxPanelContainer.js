(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo._HasOwnAvatar","mstrmojo.vi.ui._IsBoxLayoutChild","mstrmojo.vi.ui.BoxPanel","mstrmojo.vi.ui.IconTabList","mstrmojo.vi.ui._HasMask","mstrmojo.vi._MonitorsAppState","mstrmojo.dom","mstrmojo.hash","mstrmojo.array","mstrmojo.css");var $DOM=mstrmojo.dom,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$CSS=mstrmojo.css,CSS_HIDDEN="hidden",CSS_DROP_SHADOW="drop-shadow",CSS_HIGHLIGHT="highlightSelected",CSS_FADEOUT="fadeout";function getPanels(){return(this.children||[]).filter(function(child){return child.slot==="containerNode";});}function getTabInfo(context){return context.src.data.tabInfo;}function findTabPanel(tabInfo){return(this.children||[]).filter(function(child){return child.alias===tabInfo.item.id;})[0];}function toggleAvatar(context,isVisible){$CSS.toggleClass(context.src.data.avatar,CSS_HIDDEN,!isVisible);}function extractPanel(panel){this.tabList.removeTab(panel.alias);this.removeChildren(panel);}function detachExtractTabHandler(){$DOM.detachEvent(document,"mousemove",this._checkAndExtractTab);delete this._checkAndExtractTab;}function exitTabDragMode(tabInfo,context){var tabList=this.tabList;tabList.exitDragMode(tabInfo);extractPanel.call(this,tabInfo.panel);toggleAvatar(context,true);if(!tabInfo.extractedFromSrcBPC){tabInfo.extractedFromSrcBPC=true;detachExtractTabHandler.call(this);}}function enterTabDragMode(tabInfo,context){this.resetMask();toggleAvatar(context,false);this.addChildren([tabInfo.panel]);var tabList=this.tabList;$HASH.copy(tabList.addTab(tabInfo.item,NaN,true),tabInfo);tabList.enterDragMode(tabInfo,context);}function hasPropPanel(children){return children.some(function(child){return child instanceof mstrmojo.vi.ui.VIBoxPropertyEditor;});}mstrmojo.vi.ui.BoxPanelContainer=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._HasOwnAvatar,mstrmojo.vi.ui._IsBoxLayoutChild,mstrmojo.vi.ui._HasMask,mstrmojo.vi._MonitorsAppState],{scriptClass:"mstrmojo.vi.ui.BoxPanelContainer",markupString:'<div id="{@id}" class="mstrmojo-VIBoxPanelContainer {@cssClass}" style="{@cssText}" mstrAttach:click><div class="mstrmojo-VIBoxPanelContainer-header"><div class="mstrmojo-VIBoxPanelContainer-handle"><div mstrAttach:click></div></div><div class="mstrmojo-VIBoxPanelContainer-tabs"></div><div class="mstrmojo-VIBoxPanelContainer-closeBtn" tooltip="'+mstrmojo.desc(1995,"Hide")+'"></div></div><div class="mstrmojo-VIBoxPanelContainer-content"></div><div class="mstrmojo-VIDND-mask"></div></div>',markupSlots:{headerNode:function(){return this.domNode.firstChild;},handleNode:function(){return this.domNode.firstChild.firstChild;},tabsNode:function(){return this.domNode.firstChild.childNodes[1];},closeNode:function(){return this.domNode.firstChild.lastChild;},containerNode:function(){return this.domNode.childNodes[1];},maskNode:function(){return this.domNode.lastChild;}},layoutConfig:{h:{handleNode:"11px",tabsNode:"18px",containerNode:"100%"},w:{handleNode:"100%",tabsNode:"100%",containerNode:"100%"},xt:true},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod},draggable:true,dropZone:true,headerNode:null,tabsNode:null,tabList:null,model:null,parent:null,slot:"containerNode",children:[{scriptClass:"mstrmojo.vi.ui.IconTabList",slot:"tabsNode",alias:"tabList",selectedIndex:0,tabSelected:function(item){var panelContainer=this.parent,layoutViewer=panelContainer.parent;getPanels.call(panelContainer).forEach(function(panel){var isVisible=panel.alias===item.id;panel.set("visible",isVisible);if(isVisible){panel.doLayout();}});this.parent.ontabSelected();if(layoutViewer){layoutViewer.model.updateRootDefn({root:{layoutXML:layoutViewer.getBoxLayoutConfig().box}});}}}],init:function init(props){this._super(props);this.tabList.attachEventListener("click",this.id,function(evt){var evtId=evt.src.getItemFromTarget(evt.getTarget());var item;this.parent.model.raiseEvent($HASH.copy({name:"viIconTabClicked",id:evtId.id},item));});this.model.attachEventListener("viUnitSelected",this.id,function(evt){var unit=mstrmojo.all[evt.id],fnGetViType=mstrmojo.vi.ui.rw.DocLayoutViewer.getViPanelType,panelToSelect=null;if(evt.isAddAction){panelToSelect=this[fnGetViType(unit.getPanelForAddAction())];}else{var excludedPanels=unit?unit.getExcludedPanels().map(function(id){return fnGetViType(id);}):[];if(excludedPanels.indexOf(this.tabList.getSelectedItems()[0].id)>-1){var panelTypes=mstrmojo.vi.ui.BoxPanel.PANEL_TYPES;Object.keys(panelTypes).some(function(panelType){var panelId=panelTypes[panelType],panel=this[panelId];if(panel&&excludedPanels.indexOf(panelId)<0){panelToSelect=panel;return true;}return false;},this);}}if(panelToSelect){this.selectPanel(panelToSelect);}});},postBuildRendering:function postBuildRendering(){if(mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation()){this.draggable=false;}this._super();},onAppStateChange:function onAppStateChange(evt){this._super(evt);var $APP_STATES=mstrmojo.vi.VisualInsightApp.APP_STATES;this.set("isMasked",evt.value===$APP_STATES.SELECTOR_TARGETING);this.draggable=evt.value!==$APP_STATES.PRESENTATION;},getIdentifier:function getIdentifier(){return this.tabList.getTabIds();},getDragData:function getDragData(context){var data={},dragNode=context.src.node;if($DOM.contains(this.tabsNode,dragNode,true,this.domNode)){var tabInfo=this.tabList.getDragTabInfo(dragNode);if(tabInfo){tabInfo.panel=findTabPanel.call(this,tabInfo);data.tabInfo=tabInfo;tabInfo.extractedFromSrcBPC=false;}}return data;},isDragValid:function isDragValid(context){return $DOM.contains(this.headerNode,context.src.node,true,this.domNode);},ondragstart:function ondragstart(context){if(!getTabInfo(context)){this.domNode.style.display="none";}this._super(context);},initializeDrag:function initializeDrag(context){this._super(context);var tabInfo=getTabInfo(context);if(tabInfo){if(tabInfo.isSingleTab){this.set("visible",false);exitTabDragMode.call(this,tabInfo,context);}else{this.tabList.enterDragMode(tabInfo,context);}}var me=this;this._checkAndExtractTab=function checkAndExtractTab(){var tabInfo=getTabInfo(context);if(tabInfo&&!tabInfo.extractedFromSrcBPC&&context.tgt&&me!==context.tgt.widget){exitTabDragMode.call(me,tabInfo,context);}};$DOM.attachEvent(document,"mousemove",this._checkAndExtractTab);},createAvatar:function createAvatar(node,context){var dragData=context.src.data,tabInfo=dragData.tabInfo,themeCssClass=mstrApp.rootCtrl.view.themeClassName;var avatar=document.createElement("div");avatar.className=this.domNode.className+" panelAvatar";avatar.style.width=this.width;var headerNode=this.headerNode.cloneNode(true);if(tabInfo){var tabItems=Array.prototype.slice.call(headerNode.getElementsByClassName("item"),0);if(tabInfo.isSingleTab){$CSS.addClass(tabItems[0],"selected");}else{tabItems.forEach(function(tab){if(tab.className.indexOf("selected")===-1){tab.parentNode.removeChild(tab);}else{tab.style.left=0;}});}}avatar.appendChild(headerNode);$CSS.addClass(avatar,themeCssClass);dragData.avatar=avatar;toggleAvatar(context,!tabInfo||tabInfo.isSingleTab);return this.offsetAvatar(avatar);},cacheCtxtBoxPosition:function cacheCtxtBoxPosition(context){this._super(context);if(getTabInfo(context)){var boxPosition=context.boxCache[this.id],tabPosition=$DOM.position(this.tabsNode),tabTop=tabPosition.y;boxPosition.tabTop=tabTop;boxPosition.tabBottom=tabTop+tabPosition.h;}},getTargetDropZone:function getTargetDropZone(context){var edge=this._super(context),boxPosition=context.boxCache[this.id],mouseY=context.tgt.pos.y,isNestedBox=this.parent.boxLayoutConfig.getBoxPath(this).indexOf("|")>-1,isInTopHalf=mouseY-boxPosition.y<boxPosition.h/2;if(getTabInfo(context)){if(mouseY<boxPosition.tabTop){return"Top";}else{if(mouseY<boxPosition.tabBottom){return"Tab";}else{if(isNestedBox){return isInTopHalf?"Tab":"Bottom";}else{if(edge==="Top"){return"Tab";}return edge;}}}}if(isNestedBox){return isInTopHalf?"Top":"Bottom";}return edge;},highlightMask:function highlightMask(dropZone,context){var tabInfo=getTabInfo(context);if(tabInfo){var isTabDragging=tabInfo.active;if(dropZone==="Tab"){if(!isTabDragging){enterTabDragMode.call(this,tabInfo,context);}this.tabList.dragTab(tabInfo,context);return true;}if(isTabDragging){exitTabDragMode.call(this,tabInfo,context);}}return this._super(dropZone,context);},ondragleave:function ondragleave(context){this._super(context);var tabInfo=getTabInfo(context);if(tabInfo&&tabInfo.active){exitTabDragMode.call(this,tabInfo,context);}},wasDropped:function wasDropped(context){var tabInfo=getTabInfo(context);if(tabInfo){if(!tabInfo.active){var newBox=new mstrmojo.vi.ui.BoxPanelContainer({model:this.model}),boxContext=context.box;delete boxContext.initState;boxContext.boxId=newBox.id;this.parent.addChildren([newBox]);newBox.addPanel(tabInfo.item,tabInfo.panel,tabInfo.idx,true);}}this._super(context);},ondrop:function ondrop(context){var tabInfo=getTabInfo(context);if(tabInfo){if(tabInfo.active){var tabList=this.tabList;tabList.pivotTab(tabInfo);tabList.exitDragMode(tabInfo);this.doLayout();context.dropSuccessful=true;this.parent.saveBoxLayout();this.setMaskVisibility(false);return ;}context.box.parentPath+="x";}this._super(context);},ondragend:function ondragend(context){if(!getTabInfo(context)){this.domNode.style.display="block";}this._super(context);if(context.dropSuccessful){var panels=getPanels.call(this);if(!panels.length){this.parent.removeChildren(this);this.destroy();}}detachExtractTabHandler.call(this);},cancelBoxMove:function cancelBoxMove(context){var tabInfo=getTabInfo(context),tabList=this.tabList;if(!tabInfo){return false;}if(tabInfo.active){tabList.exitDragMode(tabInfo);return true;}this.addChildren([tabInfo.panel]);if(tabInfo.isSingleTab){this.set("visible",true);}tabList.addTab(tabInfo.item,tabInfo.homeIdx,true);return false;},addPanel:function addPanel(item,panel,idx,isSelected){var panelAlias=item.id,oldPanel=this[panelAlias];if(oldPanel){this.removeChildren(oldPanel);}if(panel){panel.alias=panelAlias;panel.width=this.width;panel.visible=!!isSelected;this.addChildren([panel]);this.tabList.addTab(item,idx,isSelected);}},removeAllPanels:function removeAllPanels(){var panels=getPanels.call(this),update=this.model.getDataService().newUpdateWithoutCmd();update.addExtras(mstrmojo.DocDataService.SUPPRESS_DATA);$ARR.forEach(panels,function(panel){panel.setOpenStatus(false,false,update);});var actions=update.actions;if(actions&&actions.length){update.submit();}},removePanel:function removePanel(panel,update,skipServerRequest,skipReLayout){extractPanel.call(this,panel);if(panel.alias===mstrmojo.vi.ui.BoxPanel.PANEL_TYPES.FILTERS){panel.unrender();}else{panel.destroy();}var layoutViewer=this.parent;if(!skipServerRequest){layoutViewer.saveBoxLayout(undefined,undefined,undefined,update);}if(!getPanels.call(this).length){if(skipServerRequest){layoutViewer.deleteBox(this,skipReLayout);}else{layoutViewer.deleteBoxAndSubmitDeferred(update,this,undefined,true);}this.destroy();}},highlightSelected:function highlightSelected(){var me=this;$CSS.addClass(me.domNode,CSS_HIGHLIGHT);me._highlightTimeout=window.setTimeout(function(){$CSS.addClass(me.domNode,CSS_FADEOUT);$CSS.removeClass(me.domNode,CSS_HIGHLIGHT);window.setTimeout(function(){$CSS.removeClass(me.domNode,CSS_FADEOUT);},500);},1000);},removeHighlightSelected:function removeHighlightSelected(){if(this._highlightTimeout){window.clearTimeout(this._highlightTimeout);}$CSS.removeClass(this.domNode,CSS_FADEOUT);$CSS.removeClass(this.domNode,CSS_HIGHLIGHT);},ontabSelected:function ontabSelected(){this.removeHighlightSelected();},selectPanel:function selectPanel(panel){var tabList=this.tabList;tabList.doItemSelect(tabList.items.filter(function(tab){return tab.id===panel.alias;})[0],{});},onclick:function onclick(evt){if(evt.getTarget()===this.closeNode){this.removeAllPanels();}var evtId=this.tabList.selectedItem;var item;this.parent.model.raiseEvent($HASH.copy({name:"viIconTabClicked",id:evtId.id},item));},getPanelByType:function getPanelByType(type){return(this.children||[]).filter(function(child){return child.viPanelType===type;})[0];},addChildren:function addChildren(c,idx,silent){var ret=this._super(c,idx,silent);this.doLayout();return ret;},onremoveChild:function(evt){if(hasPropPanel((evt&&evt.value)||[])){$CSS.removeClass(this.domNode,CSS_DROP_SHADOW);}},onaddChild:function(evt){if(hasPropPanel((evt&&evt.value)||[])){var hasRendered=this.hasRendered;$CSS[hasRendered?"addClass":"addWidgetCssClass"](hasRendered?this.domNode:this,CSS_DROP_SHADOW);}},getBoxBorderWidth:function getBoxBorderWidth(){return 2;}});mstrmojo.vi.ui.BoxPanelContainer.boxConfiguration={f:{h:185,v:150},o:"h"};}());