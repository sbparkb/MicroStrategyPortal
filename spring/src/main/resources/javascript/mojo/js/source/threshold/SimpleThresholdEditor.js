(function(){mstrmojo.requiresClsP("mstrmojo","array","css","hash","color","Editor","Button","Box","Label","num");mstrmojo.requiresClsP("mstrmojo.ui","Pulldown","Checkbox","CheckList");mstrmojo.requiresClsP("mstrmojo.threshold","ColorSlider","ThresholdModel");mstrmojo.requiresClsP("mstrmojo.models","FormatModel");mstrmojo.requiresDescs(2268,2281,2491,2519,3606,5585,7665,7666,7905,7907,7908,7909,7910,12110,12111,13613,13614,13615);var $ARR=mstrmojo.array,$CSS=mstrmojo.css,$HASH=mstrmojo.hash,$NWB=mstrmojo.Button.newWebButton,$NUM=mstrmojo.num,$GET_FORMAT_OBJ=mstrmojo.models.FormatModel.getFormatUpdate,METRIC_TYPE=4;var SLIDER_MODE=mstrmojo.threshold.ThresholdModel.SLIDER_MODE,FEATURES=mstrmojo.threshold.ThresholdModel.FEATURES;var COLOR_PALETTES_ITEMS=null,IMAGE_SELECTOR_ITEMS=null,BASED_ON_TYPES_ITEMS=[{n:mstrmojo.desc(527,"Value"),v:7},{n:mstrmojo.desc(4405,"Lowest"),v:4},{n:mstrmojo.desc(529,"Highest"),v:5},{n:mstrmojo.desc(4406,"Lowest %"),v:1},{n:mstrmojo.desc(4407,"Highest %"),v:2}];function onSubmit(isApply){var newThresholds=[],colorSlider=this.colorSlider,comp=colorSlider.getComp(),color=colorSlider.getPalette(),thresholdType=this.basedOn.value,model=this.model,controller=this.controller,thresholds=model.orgThresholds,metricId=this.metricId,templateThresholds=thresholds&&thresholds[metricId],breakByList=this.breakBy.breakByList,breakByItem=breakByList.items[breakByList.selectedIndex],compLength=comp.length,i,t;if(colorSlider.getReversedValue()){color=color.concat().reverse();}for(i=0;i<compLength;i++){t={};if(this.colorSlider.sliderMode===SLIDER_MODE.IMAGE_BASED){t.rtp=4;t.rtxt=color[i];}else{t.fmt=$GET_FORMAT_OBJ("bc",color[i]);}if(i>0){t.flr=$NUM.toLocaleString(model.getRealValue(comp[i-1],thresholdType));}if(i<compLength-1||compLength===1){t.ceil=$NUM.toLocaleString(model.getRealValue(comp[i],thresholdType));}if(breakByItem&&breakByItem.did!==-1){t.dmy={did:breakByItem.did,t:breakByItem.t};}newThresholds.push(t);}controller.onSubmitActions(newThresholds,templateThresholds,metricId,controller.supportsFeature(FEATURES.SHOW_BASED_ON)?this.basedOn.selectedMetric:metricId,this.basedOn.value,isApply,METRIC_TYPE);}function renderTemplateThreshold(itemId){var model=this.model,thresholds=model.thresholds&&model.thresholds[itemId],gridStructureInfo=model.data.gsi,colorSlider=this.colorSlider,tempThresholds=[],tempComp=[],tempPalette=[],thresholdType,baseColor,isImageBased,colorPalettes=this.colorPalettes,imageSelector=this.imageSelector,colorPulldown=colorPalettes.colorPulldown,typeCheckList=this.typeSelector.typeCheckList,imagePulldown=imageSelector.imagePulldown,basedOn=this.basedOn,options=basedOn.options,metricsList=basedOn.metricsList,breakByList=this.breakBy.breakByList,showBasedOn=this.controller.supportsFeature(FEATURES.SHOW_BASED_ON);if(thresholds&&thresholds.length>0){thresholdType=model.getSimpleThresholdType(itemId);if(thresholdType!==-2){isImageBased=model.isImageBasedType(itemId);thresholds.forEach(function(threshold){var temp=$HASH.copy(threshold),comp=temp.ceil;if(comp!==Infinity){temp.comp=model.getNormalizedValue(comp,threshold.ttp);}else{temp.comp=1;}tempThresholds.push(temp);});tempThresholds.sort(function(a,b){return a.comp-b.comp;});tempThresholds.forEach(function(t){tempComp.push(t.comp);if(isImageBased){tempPalette.push(t.rtxt);}else{tempPalette.push(t.fmt.bc);}});typeCheckList.set("selectedIndex",isImageBased?SLIDER_MODE.IMAGE_BASED:SLIDER_MODE.COLOR_BASED);if(isImageBased){baseColor=model.getImageSetName(tempPalette);imagePulldown.set("selectedIndex",$ARR.find(IMAGE_SELECTOR_ITEMS,"v",baseColor));}else{baseColor=model.getColorScheme(tempPalette);if(baseColor==="custom"){this.switchToCustomScheme(tempComp,tempPalette);colorSlider.unselectAll();colorSlider.update();}else{colorPulldown.set("items",COLOR_PALETTES_ITEMS);colorPulldown.set("selectedIndex",$ARR.find(COLOR_PALETTES_ITEMS,"v",baseColor));}}colorSlider.set("baseColor",baseColor);colorSlider.setColorComp(baseColor,tempComp);if(model.isMapReversed(baseColor,tempPalette,isImageBased)){colorSlider.reverseMapColor();}if(showBasedOn){var expr=thresholds[0].expr,metric=expr.m||expr.nds[0].m;metricsList.set("selectedIndex",$ARR.find(gridStructureInfo.mx,"did",(metric&&metric.did)||model.metricId));}options.set("selectedIndex",$ARR.find(options.items,"v",thresholdType));var did;try{did=thresholds[0].expr.nds[0].dmy.uts[0].utgt.did;}catch(e){}breakByList.set("selectedIndex",Math.max(0,$ARR.find(breakByList.items,"did",did)));}}else{typeCheckList.set("selectedIndex",SLIDER_MODE.COLOR_BASED);colorPulldown.set("items",COLOR_PALETTES_ITEMS);colorPulldown.set("selectedIndex",0);colorSlider.update();if(showBasedOn){metricsList.set("selectedIndex",0);}breakByList.set("selectedIndex",0);}}function onPullDownItemSelected(value){this.parent.colorSlider.set("baseColor",value);this.selectedColor=value;}function getReverseButton(){return mstrmojo.Button.newWebButton(mstrmojo.desc(12282,"Reversed"),function(){this.parent.parent.colorSlider.reverseMapColor(this.checked);},false,{cssClass:"reverse"});}function updateBasedOnOptionsItems(){var model=this.model,basedOnOptions=this.basedOn.options,oldItem=basedOnOptions.items,isMetricTypeNaN=isNaN(model.getMetricsMaxValue())||isNaN(model.getMetricsMinValue()),newItem=(isMetricTypeNaN||!this.controller.supportsFeature(FEATURES.SHOW_VALUE_ITEM))?BASED_ON_TYPES_ITEMS.slice(1):BASED_ON_TYPES_ITEMS,selectedItem=oldItem[basedOnOptions.selectedIndex];if(newItem.length!==oldItem.length){basedOnOptions.set("items",newItem);basedOnOptions.set("selectedIndex",Math.max(newItem.indexOf(selectedItem),0));}}mstrmojo.threshold.SimpleThresholdEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.threshold.SimpleThresholdEditor",cssClass:"mstrmojo-SimpleThresholdEditor",title:mstrmojo.desc(3647,"Thresholds"),help:"thresholds_editor.htm",model:undefined,controller:undefined,metricId:undefined,metricName:undefined,typeSelector:undefined,basedOn:undefined,breakBy:undefined,colorSlider:undefined,colorPalettes:undefined,imageSelector:undefined,showAdvancedEditorLink:undefined,init:function init(props){this._super(props);var customThresholds=mstrApp.customization.getCustomThresholds(),fnItemMap=function(defaultSet){return{n:mstrmojo.desc(defaultSet.title,"N/A"),v:defaultSet.id,cls:defaultSet.id};};if(!COLOR_PALETTES_ITEMS){COLOR_PALETTES_ITEMS=customThresholds.color.map(function(colorSet){return fnItemMap(colorSet);});}this.colorPalettes.colorPulldown.set("items",COLOR_PALETTES_ITEMS);if(!IMAGE_SELECTOR_ITEMS){IMAGE_SELECTOR_ITEMS=customThresholds.image.map(function(imageSet){var imageItem=fnItemMap(imageSet);imageItem.bc=imageSet.combinedImageUrl;return imageItem;});this.imageSelector.imagePulldown.set("items",IMAGE_SELECTOR_ITEMS);}},onOpen:function onOpen(){var controller=this.controller,model=this.model,basedOn=this.basedOn,basedOnOptions=basedOn.options,metricsList=basedOn.metricsList,metricId=this.metricId,gridStructureInfo=model.data.gsi;this.colorSlider.resetColorMap();$CSS.toggleClass(this.containerNode,"hideImage",!controller.supportsFeature(FEATURES.SHOW_IMAGE));if(controller.supportsFeature(FEATURES.SHOW_BASED_ON)){$CSS.addClass(basedOnOptions.domNode,"short");metricsList.set("items",gridStructureInfo.mx);metricsList.set("visible",true);}else{metricsList.set("visible",false);$CSS.removeClass(basedOnOptions.domNode,"short");}this.breakBy.breakByList.set("items",[{n:mstrmojo.desc(2057,"None"),did:-1}].concat(this.targets.filter(function(item){return item.t===12;})));this.showAdvancedEditorLink.set("visible",controller.supportsFeature(FEATURES.SHOW_ADVANCED_EDITOR));renderTemplateThreshold.call(this,metricId);this.colorSlider.updateLabels();this.domNode.oncontextmenu=function(){if(mstrApp.isSingleTier){return false;}};},onClose:function onClose(){this.model.cleanUp();},switchToCustomScheme:function switchColorScheme(newComposition,newPalette){var CUSTOM_BASE_COLOR="custom",colorSlider=this.colorSlider,colorPulldown=this.colorPalettes.colorPulldown,pulldownItems=colorPulldown.items,hasCustomItem=pulldownItems.map(function(item){return item.v;}).indexOf(CUSTOM_BASE_COLOR)!==-1;newComposition=newComposition||colorSlider.getComp().concat();if(!newPalette){var oldPalette=colorSlider.getPalette().concat();newPalette=colorSlider.getReversedValue()?oldPalette.reverse():oldPalette;}colorSlider.addCustomScheme(newComposition,newPalette);if(!hasCustomItem){colorPulldown.set("items",pulldownItems.concat({n:mstrmojo.desc(2056,"Custom"),v:CUSTOM_BASE_COLOR}));}colorPulldown.set("selectedIndex",$ARR.find(colorPulldown.items,"v",CUSTOM_BASE_COLOR));},children:[{scriptClass:"mstrmojo.Box",cssClass:"row",alias:"typeSelector",typeCheckList:undefined,children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(12112,"Thresholds Type:")},{scriptClass:"mstrmojo.ui.CheckList",alias:"typeCheckList",multiSelect:false,orientation:"h",postselectionChange:function postselectionChange(evt){var editor=this.parent.parent,model=editor.model,colorSlider=editor.colorSlider,colorPalettes=editor.colorPalettes,imageSelector=editor.imageSelector,imagePulldown=imageSelector.imagePulldown,selectedColor=COLOR_PALETTES_ITEMS[colorPalettes.colorPulldown.selectedIndex],selectedImage=IMAGE_SELECTOR_ITEMS[imagePulldown.selectedIndex],idx=evt.added[0],selectedValue=idx?selectedImage:selectedColor,defaultValue=idx?model.getDefaultImages()[0].id:model.getDefaultColors()[0].id;colorPalettes.set("visible",!idx);imageSelector.set("visible",!!idx);colorSlider.set("sliderMode",idx);colorSlider.set("baseColor",(selectedValue&&selectedValue.v)||defaultValue);colorSlider.editableBubble.set("visible",false);if(idx===SLIDER_MODE.IMAGE_BASED&&!imagePulldown.selectedIndex){imagePulldown.set("selectedIndex",0);}},selectedIndex:0,items:[{n:mstrmojo.desc(12113,"Color-based"),v:"color",cls:"color"},{n:mstrmojo.desc(12114,"Image-based"),v:"image",cls:"image"}]}]},{scriptClass:"mstrmojo.Box",cssClass:"row",alias:"colorPalettes",selectedColor:undefined,colorPulldown:undefined,children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(2060,"color:")},{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"short",alias:"colorPulldown",onitemSelected:function onitemSelected(item){onPullDownItemSelected.call(this.parent,item.v);},selectedIndex:0,items:COLOR_PALETTES_ITEMS},getReverseButton()]},{scriptClass:"mstrmojo.Box",cssClass:"row",alias:"imageSelector",visible:false,selectedColor:undefined,imagePulldown:undefined,children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(6369,"Images:")},{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"image-pulldown short",alias:"imagePulldown",onitemSelected:function onitemSelected(item){onPullDownItemSelected.call(this.parent,item.v);},getPopupListConfig:function getpopupListConfig(){var config=mstrmojo.ui.Pulldown.prototype.getPopupListConfig.call(this);config.getItemMarkup=function getItemMarkup(){return'<{@tag} class="item {@cls}" idx="{@idx}" style="{@style}" title="{@title}"><div class="text">{@n}</div><div class="bc" style="{@bc}"></div></{@tag}>';};config.getItemProps=function getItemProps(item,idx){var props=mstrmojo._IsList.getItemProps.call(this,item,idx);props.bc="background:url("+item.bc+")";return props;};return config;},items:IMAGE_SELECTOR_ITEMS},getReverseButton()]},{scriptClass:"mstrmojo.Box",cssClass:"row",alias:"basedOn",value:"",metricsList:undefined,options:undefined,children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(4402,"Based on:")},{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"short",alias:"metricsList",onitemSelected:function onitemSelected(item){var basedOn=this.parent,editor=basedOn.parent,did=item.did;basedOn.selectedMetric=editor.model.basedOnId=did;editor.colorSlider.updateLabels();updateBasedOnOptionsItems.call(editor);}},{scriptClass:"mstrmojo.ui.Pulldown",selectedIndex:3,cssClass:"short option",alias:"options",onitemSelected:function onitemSelected(item){var p=this.parent,editor=p.parent,breakBy=editor.breakBy,value=item.v,isBasedOnValue=value===7;p.value=value;editor.colorSlider.set("selectedOption",item.v);breakBy.set("visible",!isBasedOnValue);if(isBasedOnValue){breakBy.breakByList.set("selectedIndex",0);}},items:BASED_ON_TYPES_ITEMS}]},{scriptClass:"mstrmojo.Box",cssClass:"row",alias:"breakBy",breakByList:undefined,children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(4564,"Break By:")},{scriptClass:"mstrmojo.ui.Pulldown",alias:"breakByList"}]},{scriptClass:"mstrmojo.threshold.ColorSlider",alias:"colorSlider"},{scriptClass:"mstrmojo.Label",cssClass:"link",alias:"showAdvancedEditorLink",slot:"buttonNode",text:mstrmojo.desc(4569,"Advanced Thresholds Editor..."),onclick:function onclick(){var editor=this.parent,breakByList=editor.breakBy.breakByList,hasBreakBy=breakByList.items[breakByList.selectedIndex].did!==-1,fnPreOpenAdvancedEditor=function(){editor.colorSlider.unselectAll();editor.close();editor.model.editorMode=mstrmojo.threshold.ThresholdModel.EDITOR_TYPES.ADVANCED_EDITOR;};mstrmojo.warn(hasBreakBy?mstrmojo.desc(14160,"Save thresholds definition before proceeding to the Advanced Thresholds Editor? The Break By attribute will be lost."):mstrmojo.desc(14159,"Save thresholds definition before proceeding to the Advanced Thresholds Editor?"),undefined,{cssClass:"save-threshold-warning",buttons:[$NWB(mstrmojo.desc(2827,"Clear"),function(){fnPreOpenAdvancedEditor();editor.controller.openEditor();},false,{cssClass:"nosave"}),$NWB(mstrmojo.desc(2031,"Apply"),function(){fnPreOpenAdvancedEditor();breakByList.set("selectedIndex",0);onSubmit.call(editor,true);},true),$NWB(mstrmojo.desc(2223,"Cancel"))]});}},{scriptClass:"mstrmojo.Box",cssClass:"editor-buttons",slot:"buttonNode",children:[$NWB(mstrmojo.desc(221,"Cancel"),function onclick(){var editor=this.parent.parent;editor.colorSlider.unselectAll();editor.close();}),$NWB(mstrmojo.desc(1442,"OK"),function onclick(){var editor=this.parent.parent;onSubmit.call(editor);editor.colorSlider.unselectAll();editor.close();},true),$NWB(mstrmojo.desc(2031,"Apply"),function onclick(){var editor=this.parent.parent;onSubmit.call(editor,true);editor.colorSlider.unselectAll();},true)]}]});}());