(function(){mstrmojo.requiresCls("mstrmojo.EnumRWUnitType","mstrmojo.boxmodel","mstrmojo.string","mstrmojo.DocDataService");var $MOJO=mstrmojo,$BOX=$MOJO.boxmodel,$STR=mstrmojo.string,$RW_UNIT_TYPES=$MOJO.EnumRWUnitType,REQUEST_DEFN_DATA=$MOJO.DocDataService.REQUEST_DEFN_DATA;function replaceKeys(keyArrToMatch,keyArr,layoutRoot){(layoutRoot.children||[]).forEach(function(node){replaceKeys(keyArrToMatch,keyArr,node);});var ix=keyArrToMatch.indexOf(layoutRoot.k);if(ix!==-1){layoutRoot.k=keyArr[ix];}}mstrmojo.vi.models._PanelActions=mstrmojo.provide("mstrmojo.vi.models._PanelActions",{_mixinName:"mstrmojo.vi.models._PanelActions",addPanel:function(update,panelStack){var builder=panelStack.builder,panelNode=this.createNewUnitNode(null,function(defn){defn.t=$RW_UNIT_TYPES.PANEL;return defn;}),panelKey=panelNode.k,panelStackKey=panelStack.k,id=this.id,panel=builder.build([panelNode],this,{pk:panelStackKey})[0];panelStack.addChildren([panel],null,false,true);panelStack.doLayout();panel.boxLayoutConfig.useDefaultBox([]);update.add([{act:"addPanel",nodeKey:panelKey,parentKey:panelStackKey,index:0}],{success:function(res){var model=mstrmojo.all[id];model.partialUpdate(res.data,model.getUnitDefinitions(panelKey),res.defn);panelNode.defn=model.getUnitDefinitions(panelKey)[panelKey];panel.defn=panelNode.defn;panel.node.defn=panelNode.defn;}},REQUEST_DEFN_DATA);return panel;},selectNewPanel:function(update,panelKey){update.add([{act:"setCurrentPanel",unitKey:panelKey}],{success:function(){var panel=this.getPanel(panelKey);panel.parent.selectPanel(panelKey,null,true);}.bind(this)});},duplicatePanel:function duplicatePanel(panel,panelStack,builder,undoRedoCB){var panelNode=this.createNewUnitNode(null,function(defn){defn.t=$RW_UNIT_TYPES.PANEL;return defn;}),duplicatedPanelKey=panelNode.k,panelKey=panel.k,panelStackKey=panelStack.k,id=this.id,duplicatedPanelName=mstrmojo.desc(11450,"## copy ###"),actions=[{act:"duplicatePanel",nodeKey:panelKey,parentKey:panelStackKey,duplicateKey:duplicatedPanelName.replace("###",panel.numDupl===0?"":panel.numDupl).replace("##",panel.titleText),newKey:duplicatedPanelKey},{act:"setCurrentPanel",unitKey:duplicatedPanelKey}],newPanel;var dataService=this.getDataService();this.execute({execute:function(){var cmd=this,update=dataService.newUpdate(cmd,{actions:actions,extras:REQUEST_DEFN_DATA,callback:{success:function(res){var model=mstrmojo.all[id];model.partialUpdate(res.data,model.getUnitDefinitions(res.pukeys||duplicatedPanelKey),res.defn);panelNode.defn=model.getUnitDefinitions(duplicatedPanelKey)[duplicatedPanelKey];var newChildren=builder.build([panelNode],model,{pk:panelStackKey});newPanel=newChildren[0];panelStack.addChildren(newChildren);if(newPanel.defn.layoutXML){replaceKeys.call(this,panel.getTargetKeysExcludingTypes(),newPanel.getTargetKeysExcludingTypes(),panelNode.defn.layoutXML);}panel.numDupl=panel.numDupl+1;panelStack.selectPanel(duplicatedPanelKey,null,true);panelStack.doLayout();model.getPanel().saveBoxLayout(null,model.cmdMgr().CMD_PHASE.LAST);}}});update.submit();},urInfo:{disablePU:true,treesToRender:3,undo:undoRedoCB.undo,redo:undoRedoCB.redo},discard:undoRedoCB.discard});},movePanel:function movePanel(panel,newIdx,oldIdx,callback){var dataService=this.getDataService();this.execute({execute:function(){this.submit([dataService.getMoveNodeAction(panel,panel.parent.k,newIdx),{act:"setCurrentPanel",unitKey:panel.k}],{success:function(){callback(oldIdx,newIdx);}},{params:{suppressData:true}});},urInfo:{silent:true,undo:function(){callback(newIdx,oldIdx);},redo:function(){callback(oldIdx,newIdx);}}});},getRemoveUnitAction:function getRemoveUnitAction(panel){return{act:"removeUnit",unitKey:panel.k,unitType:panel.defn.t};},getSetCurrentPanelAction:function getSetCurrentPanelAction(newSelectedPanel){return{act:"setCurrentPanel",unitKey:newSelectedPanel.k};}});}());