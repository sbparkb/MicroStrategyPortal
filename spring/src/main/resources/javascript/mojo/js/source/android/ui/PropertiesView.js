(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._TouchGestures","mstrmojo._HasTouchScroller","mstrmojo.Image","mstrmojo.Label","mstrmojo.Box","mstrmojo.Button","mstrmojo.android.ui.Button","mstrmojo.android.ui.Label","mstrmojo.dom","mstrmojo.css");var PREVIEW_CLS_NAME=mstrmojo.Image.baseCssClass+" prv",$DOM=mstrmojo.dom,$CSS=mstrmojo.css;function togglePreviewCtrl(preview,opacity){var imgNode=preview.imgNode;if(imgNode){var imgNodeStyle=preview.imgNode.style;imgNodeStyle[$DOM.CSS3_TRANSITION_DURATION]=opacity?"300ms":0;imgNodeStyle.opacity=opacity;}}function openObject(){var params=this.imgPreview.params,item=params&&params.item;if(item){this.onOpenItem();mstrmojo.all[params.ctrlId].executeItem(item);}}function positionScrollNode(){if(mstrApp.isTablet()){this.updateScroller();return ;}var compStyle=this._scrollStyle,scrollNode=this.scrollNode,scrollNodeContainer=scrollNode.parentNode,scrollView=scrollNodeContainer.parentNode;if(!compStyle){var scrollViewCompStyle=$CSS.getComputedStyle(scrollView),scrollNodeCompStyle=$CSS.getComputedStyle(scrollNode);this._scrollStyle=compStyle={p:parseInt(scrollViewCompStyle.paddingLeft,10)+parseInt(scrollViewCompStyle.paddingRight,10),b:0,sp:parseInt(scrollNodeCompStyle.paddingLeft,10)+parseInt(scrollNodeCompStyle.paddingRight,10)};}var px="px",scrollViewPadding=compStyle.p,scrollContainerBorder=compStyle.b,scrollElPadding=compStyle.sp,widgetHeight=parseInt(this.height,10),widgetWidth=parseInt(this.width,10),staticNode=this.staticNode,staticHeight=staticNode.offsetHeight,staticWidth=staticNode.offsetWidth,scrollLeft=0,scrollWidth=(widgetWidth-scrollViewPadding),scrollHeight=(widgetHeight-staticHeight-scrollViewPadding);if(!this.controller.orientation){scrollLeft=staticWidth;scrollWidth=(widgetWidth-staticWidth-scrollViewPadding);scrollHeight=widgetHeight-scrollViewPadding;}var scrollViewStyle=scrollView.style;scrollViewStyle.left=scrollLeft+px;scrollViewStyle.width=scrollWidth+px;scrollViewStyle.height=scrollHeight+px;var scrollNodeContainerStyle=scrollNodeContainer.style;scrollNodeContainerStyle.width=(scrollWidth-scrollContainerBorder)+px;scrollNodeContainerStyle.height=(scrollHeight-scrollContainerBorder)+px;scrollNode.style.width=(scrollWidth-scrollContainerBorder-scrollElPadding)+px;this.updateScroller();}var $PV=mstrmojo.android.ui.PropertiesView=mstrmojo.declare(mstrmojo.Container,[mstrmojo._TouchGestures,mstrmojo._HasTouchScroller],{scriptClass:"mstrmojo.android.ui.PropertiesView",markupString:'<div id="{@id}" class="mstrmojo-PropertiesView {@cssClass}" style="{@cssText}"><div class="mstrmojo-PropertiesViewStatic"></div><div class="mstrmojo-PropertiesViewScroll"><div><div></div></div></div></div>',markupSlots:{staticNode:function(){return this.domNode.firstChild;},scrollNode:function(){return this.domNode.lastChild.firstChild.firstChild;}},markupMethods:{onheightChange:mstrmojo.Widget.heightMarkupMethod,onwidthChange:mstrmojo.Widget.widthMarkupMethod},children:[{scriptClass:"mstrmojo.Image",slot:"staticNode",alias:"imgPreview",cssClass:"prv",visible:false,onload:function(){togglePreviewCtrl(this,1);}},{scriptClass:"mstrmojo.Box",slot:"staticNode",cssClass:"btns",alias:"btns",children:[mstrmojo.android.ui.Button.newButton(mstrmojo.desc(1900,"View"),function(){openObject.call(this.parent.parent);},{alias:"btnView",cssClass:"mstrmojo-GlowButton",visible:false}),{scriptClass:"mstrmojo.android.ui.Label",alias:"txView",cssClass:"txOffline",visible:false,txData:{},ontxDataChange:function ontxDataChange(){if(!this.txData){this.set("visible",false);this.txData={};}},touchTap:function(){var ctrl=mstrApp.getTransactionNotificationController(),ctrlContext=ctrl&&ctrl.rootCtrl.getCurrent();if(ctrlContext){if(ctrlContext.ctrlType!==2048){ctrlContext=ctrlContext.getController("ctrlType",2048);}ctrl.showNotificationBoard(ctrlContext||ctrl.rootCtrl,this.did,this.n);}}}]},{scriptClass:"mstrmojo.Label",slot:"scrollNode",alias:"lblName",cssClass:"nm",visible:false},{scriptClass:"mstrmojo.Label",slot:"scrollNode",alias:"lblDesc",cssClass:"ds"},{scriptClass:"mstrmojo.Label",slot:"scrollNode",alias:"lblCachedOn",cssClass:"ch",text:""}],afterViewVisible:function afterViewVisible(){positionScrollNode.call(this);},rootOrientationChange:function rootOrientationChange(){positionScrollNode.call(this);},updateScrollerConfig:function updateScrollerConfig(){var cfg=this._super(),scrollEl=this.scrollNode;cfg.scrollEl=scrollEl;cfg.noHScroll=true;cfg.origin={x:0,y:0};var offsetEnd=Math.max(scrollEl.offsetHeight-scrollEl.parentNode.clientHeight,0);var enableScroll=cfg.vScroll=(offsetEnd!==0);if(enableScroll){cfg.offset={y:{start:0,end:offsetEnd}};}else{cfg.offset=null;}$CSS.toggleClass(this.domNode,"can-scroll",enableScroll);return cfg;},onOpenItem:mstrmojo.emptyFn,updateView:function updateView(params){var imgPreview=this.imgPreview,lblName=this.lblName,lblDescription=this.lblDesc,lblCachedOn=this.lblCachedOn,btnView=this.btns.btnView,btnTx=this.btns.txView,item=params.item,viz="visible",txt="text";var txtDescription=params.desc||params.defaultMsg;lblDescription.set(txt,txtDescription);lblDescription.set(viz,!!txtDescription);if(!item){imgPreview.set(viz,false);lblName.set(viz,false);lblCachedOn.set(viz,false);btnView.set(viz,false);btnTx.set(viz,false);delete imgPreview.params;}else{var sizes=mstrmojo.android.ui.PropertiesView.getPreviewSizes();if(mstrApp.isTablet()&&this.controller.orientation){sizes.reverse();}mstrMobileApp.getScreenShot(this.id,item.pid||mstrApp.getCurrentProjectId(),item.did,sizes[0].h,sizes[0].w);var oldParams=imgPreview.params;if(!oldParams||oldParams.did!==params.did){imgPreview.set("cssClass",PREVIEW_CLS_NAME+" i"+params.st);imgPreview.set("src","");}imgPreview.params=params;imgPreview.set(viz,true);var txtTitle=params.ttl;lblName.set(txt,txtTitle);lblName.set(viz,!!txtTitle);var cachedTime=params.cached;lblCachedOn.set(txt,cachedTime);lblCachedOn.set(viz,(cachedTime!==undefined));if(params.avail){btnView.set(viz,true);var did=params.did;if(did){var txCtlr=mstrApp.getTransactionNotificationController(),isVisible=(txCtlr&&txCtlr.hasTransactionQueue(did));btnTx.set("did",did);btnTx.set("n",params.ttl);btnTx.set("visible",isVisible);if(isVisible){txCtlr.addWidgetListener(did,btnTx);}}}else{btnView.set(viz,false);btnTx.set(viz,false);}}positionScrollNode.call(this);},onPreviewReady:function onPreviewReady(src){if(src){var imgPreview=this.imgPreview;if(imgPreview.src!==src){togglePreviewCtrl(imgPreview,0);imgPreview.domNode.className=PREVIEW_CLS_NAME;imgPreview.set("src",src);}}}});var phoneDpiSizes={160:{h:150,w:200},213:{h:150,w:200},240:{h:225,w:300},320:{h:300,w:400},480:{h:300,w:400}},tabletPortraitDpiSizes={160:{h:334,w:400},213:{h:334,w:400},240:{h:501,w:600},320:{h:668,w:800}},tabletLandscapeDpiSizes={160:{h:337,w:400},213:{h:337,w:400},240:{h:506,w:930},320:{h:674,w:1240}};$PV.getPreviewSizes=function(){var sizes=[],dpi=mstrMobileApp.getDeviceDPI();if(mstrApp.isTablet()){sizes.push(tabletLandscapeDpiSizes[dpi]);sizes.push(tabletPortraitDpiSizes[dpi]);}else{sizes.push(phoneDpiSizes[dpi]);}return sizes;};}());