(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.css","mstrmojo.HBox","mstrmojo.Label","mstrmojo.Button","mstrmojo.Editor","mstrmojo.DocDataService","mstrmojo.models.FormatModel","mstrmojo.chart.model.enums.EnumDSSDefaultFormats","mstrmojo.vi.ui.TextAlignButtonBar","mstrmojo.vi.ui.editors.EditorGroup","mstrmojo.ui.editors.controls.ContainerGroup","mstrmojo.ui.editors.controls.CharacterGroup","mstrmojo.gm.GMProperty");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$FMT_MODEL=mstrmojo.models.FormatModel,$PROP_NAME=$FMT_MODEL.ENUM_PROPERTY_NAMES,$EDF=mstrmojo.chart.model.enums.EnumDSSDefaultFormats,$CONTAINER_GROUP_CTRL=mstrmojo.ui.editors.controls.ContainerGroup.CTRL_FLAGS;var titleInitSettings={};titleInitSettings[$PROP_NAME.FONT_SIZE]=8;titleInitSettings[$PROP_NAME.FONT_FAMILY]="Arial";var overallInitSettings={};overallInitSettings[$PROP_NAME.FONT_FAMILY]="Arial";var FMT_GROUP_OVERALL="overall",FMT_GROUP_TITLE="title",FMT_GROUP_CONTAINER_Fill="containerFill",FMT_GROUP_CONTAINER_Border="containerBorder",titleFmtTypes=[$EDF.GridTitle,$EDF.ControlTitle],containerFmtTypes=[$EDF.Crosstab,$EDF.Control,$EDF.Text,$EDF.Image,$EDF.HTML],widgetFmtTypes=[$EDF.GraphMatrix,$EDF.HeatMap,$EDF.Network],TARGET_FORMATS={overall:{types:[$EDF.Crosstab,$EDF.Control,$EDF.Label,$EDF.Text,$EDF.Image,$EDF.Line,$EDF.Shape,$EDF.HTML,$EDF.Panel,$EDF.PanelStack,$EDF.MetricsHeader,$EDF.MetricsGrid,$EDF.MetricsSubtotalHeader,$EDF.MetricsSubtotalGrid,$EDF.RowHeader,$EDF.RowGrid,$EDF.RowSubtotalHeader,$EDF.RowSubtotalGrid,$EDF.ColumnHeader,$EDF.ColumnGrid,$EDF.ColumnSubtotalHeader,$EDF.ColumnSubtotalGrid].concat(titleFmtTypes).concat(widgetFmtTypes),props:[$PROP_NAME.FONT_FAMILY],initSettings:overallInitSettings},title:{types:titleFmtTypes,props:[$PROP_NAME.FONT_FAMILY,$PROP_NAME.FONT_WEIGHT,$PROP_NAME.FONT_STYLE,$PROP_NAME.UNDERLINE,$PROP_NAME.LINE_THROUGH,$PROP_NAME.FONT_SIZE,$PROP_NAME.COLOR,$PROP_NAME.BACKGROUND_COLOR,$PROP_NAME.TEXT_ALIGN],initSettings:titleInitSettings},containerFill:{types:containerFmtTypes.concat(),props:[$PROP_NAME.BACKGROUND_COLOR]},containerBorder:{types:containerFmtTypes.concat(),props:[$PROP_NAME.BORDER_STYLE,$PROP_NAME.BORDER_COLOR,$PROP_NAME.BORDER_TOP_STYLE,$PROP_NAME.BORDER_TOP_COLOR]}};function getLabel(text,cssClass,formatGroup){return{scriptClass:"mstrmojo.Label",text:text,cssClass:cssClass||"",formatGroup:formatGroup};}function getTextsWidget(texts,cssClass){var textsMarkup=texts.map(function(txt){return'<div class="text">'+txt+"</div>";}).join("");return{scriptClass:"mstrmojo.Widget",markupString:'<div class="TextContainer '+(cssClass||"")+'">'+textsMarkup+"</div>"};}function onGroupValueChange(name,newValue){this.parent.parent.parent.onFormatChange(this.formatGroup,name,newValue);}function synchronizeControls(){var defaultFormats=this.controller.model.defmts,cachedSettings={};this.container.controls.children.filter(function(ch){return !!ch.formatGroup;}).forEach(function(ch){var fmtGrp=ch.formatGroup,fmtSetting=cachedSettings[fmtGrp],tgtFmt=TARGET_FORMATS[fmtGrp];if(!fmtSetting){var result={},subset=defaultFormats.filter(function(fmtSet){return tgtFmt.types.indexOf(fmtSet.dft)>-1;});tgtFmt.props.forEach(function(propName){var pInfo=$FMT_MODEL.getFormatPropertyInfo(propName),pn=pInfo.pn,pValues=subset.map(function(fmtSet){var propSets=fmtSet.props,propertySet=propSets[pInfo.ps];return propertySet&&propertySet[(pn instanceof Array)?pn[0]:pn];}),firstVal=pValues[0];if(firstVal!==null&&firstVal!==undefined&&pValues.every(function(value,i){var dft=subset[i].dft;return(fmtGrp==="overall"&&(dft===15||dft===18))?true:value===firstVal;})){result[propName]=firstVal;}else{if(pInfo.pt===2){result[propName]="conflict";}}});fmtSetting=cachedSettings[fmtGrp]=$HASH.copy(result,$HASH.copy(tgtFmt.initSettings));}ch.setFormatSource(fmtSetting);});return cachedSettings;}function updatePreview(settings,encoded,resetPreviews){var container=this.container,allTgtPreviews=container.preview.children.filter(function(w){return !!w.formatGroup;});if(resetPreviews){allTgtPreviews.forEach(function(prev){prev.domNode.style.cssText="";});}$HASH.forEach(settings,function(fmts,fmtGrp){var tgtStyle=allTgtPreviews.filter(function(ch){return ch.formatGroup===fmtGrp;})[0].domNode.style;$HASH.forEach(fmts,function(value,propertyName){var sn="",sv=encoded?$FMT_MODEL.decodeValue(propertyName,value):value;if(propertyName===$PROP_NAME.FONT_FAMILY){sn="fontFamily";}else{if(propertyName===$PROP_NAME.FONT_SIZE){sn="fontSize";sv=parseInt(sv,10).toString()+"pt";}else{if(propertyName===$PROP_NAME.COLOR){sn="color";}else{if(propertyName===$PROP_NAME.BACKGROUND_COLOR){sn="backgroundColor";}else{if(propertyName===$PROP_NAME.FONT_WEIGHT){sn="fontWeight";sv=value?"bold":"";}else{if(propertyName===$PROP_NAME.FONT_STYLE){sn="fontStyle";sv=value?"italic":"";}else{if(propertyName===$PROP_NAME.TEXT_ALIGN){sn="textAlign";sv=container.controls.txtAlign.items.filter(function(item){return item.v===value;})[0].id;}else{if(propertyName===$PROP_NAME.BORDER_COLOR){sn="borderColor";}else{if(propertyName===$PROP_NAME.BORDER_STYLE){sn="border";sv=sv+" "+(tgtStyle.borderColor||"transparent");}else{if(propertyName===$PROP_NAME.UNDERLINE||propertyName===$PROP_NAME.LINE_THROUGH){sn="textDecoration";var valStr=propertyName===$PROP_NAME.UNDERLINE?"underline":"line-through";sv=(tgtStyle[sn].replace(valStr,"")+" "+(value?valStr:"")).trim();}}}}}}}}}}tgtStyle[sn]=sv;});},this);}function parseSingleQuoteJSON(jsonStr){return JSON.parse((jsonStr||"{}").replace(/\'/g,'"'));}function stringifyToSingleQuote(jsonObj){return JSON.stringify(jsonObj).replace(/\"/g,"'");}function getUpdateWidgetFontActions(defaultFormats,widgetFmtTypes,fontFamily){var actions=[],buildWidgetPropsXML=function buildWidgetPropsXML(vp){var xml=new mstrmojo.XMLBuilder();xml.addChild("props");xml.addChild("widgetProps");xml.addChild("fmt");$HASH.forEach(vp,function(v,n){xml.addChild(n);xml.addAttribute("value",v);xml.closeElement();});xml.closeElement();xml.closeElement();xml.closeElement();return xml.toString();};widgetFmtTypes.forEach(function(ft){var vp=$HASH.copy(defaultFormats.filter(function(defFmt){return defFmt.dft===ft;})[0].props.FormattingWidget.props.widgetProps.fmt),mergeObj=function mergeObj(srcObj,destObj){destObj=destObj||{};$HASH.forEach(srcObj,function(val,key){if(typeof val==="object"){destObj[key]=mergeObj(val,destObj[key]);}else{destObj[key]=val;}});return destObj;},mergeSettingsToVP=function mergeSettingsToVP(vpProp,newSettings){vp[vpProp]=stringifyToSingleQuote(mergeObj(newSettings,parseSingleQuoteJSON(vp[vpProp])));};if(ft===$EDF.GraphMatrix){var gmFontFamilyProps=mstrmojo.gm.GMProperty.getUnderlyingPropertyNameWithAll("allTxtFntFml");gmFontFamilyProps.forEach(function(fntProp){vp[fntProp]=fontFamily;});}else{if(ft===$EDF.Network){vp.lgFntFml=fontFamily;mergeSettingsToVP("BubFnt",{fontFamily:fontFamily});}else{if(ft===$EDF.HeatMap){vp.lgFntFml=fontFamily;mergeSettingsToVP("fts",{headerOnMiddle:{family:fontFamily},headerOnTop:{header:{family:fontFamily},cell:{family:fontFamily}}});}}}actions.push({act:"setDefaultFormat",dssFormatTypes:ft.toString(),format:{FormattingWidget:{WidgetProps:buildWidgetPropsXML(vp)}}});});return actions;}mstrmojo.vi.ui.editors.DashboardStylesEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.vi.ui.DashboardStylesEditor",title:mstrmojo.desc(13763,"Dashboard Formatting Properties"),controller:null,init:function init(props){this._super(props);mstrmojo.css.addWidgetCssClass(this,"DashboardStyles");},onOpen:function onOpen(){this.container.preview.domNode.setAttribute("themeClassName",this.controller.rootCtrl.view.themeClassName);this._initSettings=synchronizeControls.call(this);updatePreview.apply(this,[this._initSettings,true,true]);this._settings={};},onFormatChange:function onFormatChange(formatGroup,formatName,newValue){var groupSettings=this._settings[formatGroup]=this._settings[formatGroup]||{};groupSettings[formatName]=newValue;updatePreview.call(this,this._settings);},onOK:function onOK(){var actions=[],docCtrl=this.controller,settings=this._settings;[FMT_GROUP_OVERALL,FMT_GROUP_TITLE,FMT_GROUP_CONTAINER_Fill,FMT_GROUP_CONTAINER_Border].forEach(function(fmtGrp){var fmts=settings[fmtGrp];if(fmts){var fmtObj={};if(fmtGrp===FMT_GROUP_OVERALL){actions=actions.concat(getUpdateWidgetFontActions(docCtrl.model.defmts,widgetFmtTypes,fmts[$PROP_NAME.FONT_FAMILY]));}$HASH.forEach(fmts,function(value,propName){$FMT_MODEL.getFormatUpdate(propName,value,fmtObj);});actions.push({act:"setDefaultFormat",dssFormatTypes:TARGET_FORMATS[fmtGrp].types.join("\u001E"),format:fmtObj});}});if(actions.length){docCtrl.submitUndoRedoUpdates(actions,null,mstrmojo.func.wrapMethods({success:function(res){docCtrl.model.defmts=res.defmts;}},this.controller.getRefreshCallback()),mstrmojo.DocDataService.REQUEST_DEFN_DATA);}},children:[{scriptClass:"mstrmojo.HBox",alias:"container",children:[{scriptClass:"mstrmojo.vi.ui.editors.EditorGroup",alias:"controls",width:"160px",showDivider:false,children:[getLabel(mstrmojo.desc(13622,"Overall Font")),{scriptClass:"mstrmojo.ui.editors.controls.CharacterGroup",visibleControls:mstrmojo.ui.editors.controls.CharacterGroup.CTRL_FLAGS.FONT_FAMILY,formatGroup:FMT_GROUP_OVERALL,onGroupValueChange:function(name,newValue){onGroupValueChange.call(this,name,newValue);this.parent.titleFontFmt.fontFamily.selectItemByField("id",newValue);}},getLabel(mstrmojo.desc(3297,"Title"),"title"),getLabel(mstrmojo.desc(2172,"Font:"),"font-container"),{scriptClass:"mstrmojo.ui.editors.controls.CharacterGroup",alias:"titleFontFmt",formatGroup:FMT_GROUP_TITLE,onGroupValueChange:onGroupValueChange},{scriptClass:"mstrmojo.ui.editors.controls.ContainerGroup",visibleControls:$CONTAINER_GROUP_CTRL.FILL_COLOR,formatGroup:FMT_GROUP_TITLE,onGroupValueChange:onGroupValueChange},{scriptClass:"mstrmojo.vi.ui.TextAlignButtonBar",alias:"txtAlign",formatGroup:FMT_GROUP_TITLE,setFormatSource:function(formats){this._inSync=true;this.singleSelect($ARR.find(this.items,"v",formats[$PROP_NAME.TEXT_ALIGN]));this._inSync=false;},onValueChange:function(newValue){if(!this._inSync){onGroupValueChange.apply(this,[$PROP_NAME.TEXT_ALIGN,newValue]);}}},getLabel(mstrmojo.desc(11917,"Container"),"container"),{scriptClass:"mstrmojo.ui.editors.controls.ContainerGroup",visibleControls:$CONTAINER_GROUP_CTRL.FILL_COLOR,formatGroup:FMT_GROUP_CONTAINER_Fill,onGroupValueChange:onGroupValueChange,showBackgroundNoFill:false},{scriptClass:"mstrmojo.ui.editors.controls.ContainerGroup",borderTitle:mstrmojo.desc(13640,"Border style:"),visibleControls:$CONTAINER_GROUP_CTRL.BORDER,formatGroup:FMT_GROUP_CONTAINER_Border,onGroupValueChange:onGroupValueChange}]},{scriptClass:"mstrmojo.Box",alias:"preview",cssClass:"mstrmojo-DashboardStylesEditor-preview",children:[getLabel("","containerFillPrev",FMT_GROUP_CONTAINER_Fill),getLabel("","themePrev"),getLabel("","containerBorderPrev",FMT_GROUP_CONTAINER_Border),getLabel(mstrmojo.desc(13764,"Visualization 1"),"titlePrev",FMT_GROUP_TITLE),{scriptClass:"mstrmojo.Box",cssClass:"visTextsPrev",formatGroup:FMT_GROUP_OVERALL,children:[getTextsWidget(["20M","16M","12M","8M","4M"],"verticalAxis"),getTextsWidget(["2013Q4","2014Q1","2014Q2"],"horizonalAxis"),{scriptClass:"mstrmojo.Box",cssClass:"legend",children:[getLabel(mstrmojo.desc(7940,"Category"),"title"),getTextsWidget(["Cat A","Cat B","Cat C"],"detail")]}]}]}]}],buttons:[mstrmojo.Button.newWebButton(mstrmojo.desc(1442,"OK"),function(){var editor=this.parent.parent;editor.onOK();editor.close();},true),mstrmojo.Button.newWebButton(mstrmojo.desc(221,"Cancel"),function(){this.parent.parent.close();})]});}());