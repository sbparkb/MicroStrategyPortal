(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.PanelPortlet","mstrmojo.vi.ui.rw.selectors._HasFilterContextMenu","mstrmojo.vi._MonitorsAppState","mstrmojo.util.ui._HostsSplitter","mstrmojo.ui.menus.EditorConfig","mstrmojo.ui.CheckList","mstrmojo.ui.ScrollableContainer","mstrmojo.Label","mstrmojo.ToolSeparator","mstrmojo.vi.ui.InteractiveUnitList","mstrmojo.array","mstrmojo.hash","mstrmojo.dom","mstrmojo.boxmodel","mstrmojo.css","mstrmojo.expr","mstrmojo.vi.models.VIComponentMap","mstrmojo.ME._MetricEditorHelper","mstrmojo.DocDataService");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$EXPR=mstrmojo.expr,$BFTP=$EXPR.BFTP,$STYLES=mstrmojo.DocSelector.STYLES,$EH=mstrmojo.elementHelper,$VI_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,ITEM_SEP="\u001E",TP_METRIC=4,TP_ATTRIBUTE=12,TP_CONSOLIDATION=47,STP_CUSTOM_GROUP=257,SUBTYPE_REPORT_CUBE=776,SUBTYPE_REPORT_EMMA_CUBE=779,CTL_ELEMENT_SOURCE_DOCUMENT=1,DOUBLE_CLICK_INTERVAL=250,TOPN_DEFAULT_QT=1,TOPN_DEFAULT_N=10,MIN_HEIGHT=74,VIS_MIN_HEIGHT=85;function dragWithin(context){var epos=context.tgt.pos,ex=epos.x,ey=epos.y,dim=context.src.data.parentDim,dimx1=dim.x,dimx2=dimx1+dim.w,dimy1=dim.y,dimy2=dimy1+dim.h;return ex>=dimx1&&ex<=dimx2&&ey>=dimy1&&ey<=dimy2;}function getTopRankSubMenuEditor(){var fnGetDisplayUnits=function(datasets,type){var units=[];Object.keys(datasets).forEach(function(datasetKey){var ds=datasets[datasetKey];units=units.concat((ds[type]||[]).filter(function(dsUnit){var i=$ARR.find(units,"did",dsUnit.did);if(i>-1){if(units[i].hide&&!dsUnit.hide){units[i].hide=false;}return false;}return true;}).map(function(dsUnit){var newUnit=mstrmojo.hash.clone(dsUnit);newUnit.dsc="("+ds.name+")";return newUnit;}));});return units;},selector=this.selector,docModel=selector.model,srcId=selector.defn.srcid,datasets=docModel.datasets,allAttrs=fnGetDisplayUnits(datasets,["att"]),allMetrics=fnGetDisplayUnits(datasets,["mx"]),fnGetCandidateItems=function(datasets){var units=[],visited={};Object.keys(datasets).forEach(function(dsId){var dataset=datasets[dsId],attrs=dataset.att||[],mx=dataset.mx||[];if($ARR.find(attrs,"did",srcId)>=0){var elms=attrs.filter(function(attr){return attr.formType===$BFTP.NUMBER&&attr.did!==srcId&&!attr.hide&&!visited[attr.did];}).map(function(unit){unit.dsc=dataset.name;return unit;}).concat(mx.filter(function(metric){return !metric.hide&&!visited[metric.did];}).map(function(unit){unit.dsc=dataset.name;return unit;}));units=units.concat(elms);elms.forEach(function(el){visited[el.did]=true;});}});return units;},attr=$ARR.filterOne(allAttrs,function(unit){return unit.did===srcId;}),items=fnGetCandidateItems(datasets||{}),fnGetDuplicateItemNames=function(items){var visited={},duplicates={};(items||[]).forEach(function(item){if(item.n&&visited[item.n]){duplicates[item.n]=true;}visited[item.n]=true;});return duplicates;},dupNames=fnGetDuplicateItemNames(items);return new mstrmojo.ui.menus.EditorConfig({cssClass:"topRank",okVisible:false,cancelVisible:false,contents:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(11503,"Ranked By:")},{scriptClass:"mstrmojo.ui.ScrollableContainer",children:[{scriptClass:"mstrmojo.vi.ui.InteractiveUnitList",draggable:false,CLS_HAS_MENU:"",items:items,hasTooltipContent:function(item){return mstrmojo.vi.ui.InteractiveUnitList.prototype.hasTooltipContent.apply(this,arguments)||dupNames[item.n];},getItemTooltip:function(item,itemNode){var richTooltip=mstrmojo.vi.ui.InteractiveUnitList.prototype.getItemTooltip.apply(this,arguments);if(richTooltip){var position=$DOM.position(itemNode);$HASH.copy({cssClass:"vi-regular vi-tooltip-C",content:item.n+" ("+item.dsc+")",posType:mstrmojo.tooltip.POS_TOPLEFT,top:position.y,left:position.x+position.w+6},richTooltip);}return richTooltip;},listHooks:{select:function select(el,item){var primaryDSId=docModel.findDatasetIdFromUnit(attr.did),fnGetNewName=function(an,mn){var baseName=mn+" by "+an,newName=baseName,map=$ARR.hash(allMetrics.map(function(m){return m.n;})),cnt=1;while(map[newName]){newName=baseName+" ("+(cnt++)+")";}return newName;},newName=fnGetNewName(attr.n,item.n),dataService=docModel.getDataService(),getTokenStreamXML=function(metric,attr){var tks=[],funcToken={oi:{did:"8107C31BDD9911D3B98100C04F2233EA",t:11,st:2826,n:"Sum"},v:"Sum"},getDelimiterToken=function(delimiter){return{tp:2,lv:1,v:delimiter};},getItemToken=function(item){var cfg={v:mstrmojo.ME.MetricToken.brackets(item.n),lv:1,oi:{did:item.did,t:item.t,n:item.n}};if(item.st){cfg.oi.st=item.st;}return cfg;};tks=[funcToken,getDelimiterToken("("),getItemToken(metric),getDelimiterToken(")"),getDelimiterToken("{"),getItemToken(attr),getDelimiterToken("}")];return mstrmojo.ME._MetricEditorHelper.getTokenStreamXML({tks:{items:tks}});},actions=[dataService.getAddDerivedMetricToDatasetAction({dsid:primaryDSId,formula:getTokenStreamXML(item,attr),isTokenStream:true,name:newName,Ids:["$GUID_1"],afb:true,sfb:true}),dataService.getEditDocUnitPropAction({dsid:primaryDSId,unitId:"$GUID_1",unitType:TP_METRIC,prop:2,value:"1"})];docModel.datasetsSettings.unitOpr(newName,"isDeleteWithFilter",true);docModel.datasetsSettings.unitOpr(newName,"completeHide",true);actions=actions.concat(docModel.datasetsSettings.getSaveActions());dataService.submitUpdates(actions,mstrmojo.func.wrapMethods(docModel.getDatasetsUpdateCallback(),{success:function(res){var units=fnGetDisplayUnits(res.datasets,["mx"]).filter(function(m){return $ARR.find(allMetrics,"did",m.did)===-1;}).map(function(element){element.isTopRank=true;element.qt=TOPN_DEFAULT_QT;element.cs=TOPN_DEFAULT_N;return element;});docModel.addFilterStackSelectors(units,selector.fmts["z-index"]+1,null,true);}}));this.hideTooltip();this.parent.parent.closeAllMenus();return true;}}}]}]});}var getDatasetArrayItems=function(datasets){var units=[];(Object.keys(datasets)||[]).forEach(function(datasetKey){var ds=datasets[datasetKey];if(ds&&ds.st!==SUBTYPE_REPORT_CUBE&&ds.st!==SUBTYPE_REPORT_EMMA_CUBE){units=units.concat({n:ds.name,did:datasetKey});}});return units;};function getFilterDatasetMenuEditor(){var selector=this.selector,docModel=selector.model,selectorTargetsDataset=(selector.defn.dsTks||"").split(ITEM_SEP),datasets=docModel.datasets,datasetArrayItems=getDatasetArrayItems(datasets)||[],selectedIndices={};selectorTargetsDataset.forEach(function(did){var idx=$ARR.find(datasetArrayItems,"did",did);if(idx>=0){selectedIndices[idx]=true;}});var dsTargetList=new mstrmojo.ui.CheckList({cssClass:"selectors",items:datasetArrayItems,selectedIndices:selectedIndices});return new mstrmojo.ui.menus.EditorConfig({data:{},cssClass:"filterDataset",contents:[dsTargetList],fnOk:function(){var actions=[],model=selector.model,dataService=model.getDataService(),selItems=dsTargetList.getSelectedItems()||[],keyContext=selector.defn.ck;if(!selItems.length){mstrmojo.alert(mstrmojo.desc(13765,"Please choose at least one dataset as target."));return false;}actions.push(dataService.getClearCtrlTargetAction(keyContext));actions.push(dataService.getClearCtrlTargetDatasetAction(keyContext));if(selItems.length>0){selItems.forEach(function(item){actions.push(dataService.getAddCtrlTargetDatasetAction(keyContext,item.did));});actions.push(dataService.getChangeControlElementSource(keyContext,CTL_ELEMENT_SOURCE_DOCUMENT));model.submitDataDefnUpdate(actions,mstrmojo.func.wrapMethods(docModel.controller.getRefreshCallback(),docModel.controller.resumeVIPanelSelection()));}}});}function getTitle(){var title=this.baseTitle,count=this.count;if(count&&count.length){title+=" ("+count+")";}return title;}function getSummaryText(){var selector=this.selector,defn=selector&&selector.defn;if(!defn||defn.srct!==TP_ATTRIBUTE){return"";}var widget=selector.children&&selector.children[0],elements=widget.items,style=selector.style,include=selector.include;if(style===$STYLES.ATTR_QUAL){return widget.getSummaryText();}var ces=style===$STYLES.SEARCH_BOX?Object.keys(elements):Object.keys(selector.selIdx),elementLength=ces.length;if(!!selector.unset||ces.indexOf(String($ARR.find(elements,"v",$EH.ELEM_ALL_ID)))>-1){return"";}if(!elementLength){return mstrmojo.desc(2057,"None");}if(style===$STYLES.SCROLLER&&(ces[ces.length-1]-ces[0])===(elementLength-1)){var prefix=include?"":mstrmojo.desc(1099,"Not")+" ";return prefix+(elementLength===1?elements[ces[0]].n:(elements[ces[0]].n+" - "+elements[ces[elementLength-1]].n));}var _rtn=ces.map(function(idx){return elements[idx].n;}).join(", ");if(!defn.include){_rtn=mstrmojo.desc(1099,"Not")+" "+_rtn;}return _rtn;}function getSummaryChildren(text){text=text||"";return[{scriptClass:"mstrmojo.Label",alias:"summaryBar",cssClass:"subtitle",title:text,text:text,slot:"domNode"}];}function refreshSummaryBar(selector){var filterPortlet=selector.parent;if(filterPortlet.isCollapsed){var summary=getSummaryText.call(filterPortlet),bar=filterPortlet.summaryBar;bar.set("text",summary);bar.set("title",summary);}}function existSameNameObj(selector){var sameTypeObjCollection=[],srcId=selector.defn.srcid,srcType=selector.defn.srct===4?"mx":"att";mstrmojo.hash.forEach(selector.model.datasets,function(dataset){var arr=dataset[srcType];sameTypeObjCollection=sameTypeObjCollection.concat(arr);});var srcObj=$ARR.filterOne(sameTypeObjCollection,function(item){return item.did===srcId;});return !!$ARR.filterOne(sameTypeObjCollection,function(item){return item.n===srcObj.n&&item.did!==srcObj.did&&item.t===srcObj.t;});}function findItemSrcDataset(selector){var srcType=selector.defn.srct===4?"mx":"att",srcId=selector.defn.srcid,srcDataset=[];mstrmojo.hash.forEach(selector.model.datasets,function(dataset){var arr=dataset[srcType];var idx=$ARR.find(arr,"did",srcId);if(idx!==-1){srcDataset.push(dataset.name);}});return srcDataset;}function etraDNDEffect(titleBarNode,domNode){var tId;$DOM.attachEvent(titleBarNode,"mousedown",function(){tId=window.setTimeout(function(){$CSS.addClass(domNode,"showFPBorder");},300);});$DOM.attachEvent(titleBarNode,"mouseup",function(){window.clearTimeout(tId);$CSS.removeClass(domNode,"showFPBorder");});}var __DraggableFP=mstrmojo.mixin({scriptClass:"__DraggableFP",avatarCssClass:"mstrmojo-filterportlet-avatar",selfAvatarCssClass:"mstrmojo-filterportlet-selfAvatar",getDragData:function getDragData(context){var id=this.id,me=this;return{item:this.selector,idx:this.selector.defn.fmts["z-index"],src:mstrmojo.vi.models.EnumDragSources.FILTERS,dim:$DOM.position(this.domNode),parentDim:$DOM.position(this.parent.domNode),setAvatarClass:function setAvatarClass(cls){var portlet=mstrmojo.all[id],avatar=dragWithin(context)?context._selfAvatar:context._avatarNode;if(avatar){var classes=[(avatar===context._selfAvatar?portlet.selfAvatarCssClass:portlet.avatarCssClass),"hasOwnAvatar",cls];avatar.className=classes.join(" ");}},onRemove:function(portlet){delete me.domNode;var ignoreTargetData=!!(portlet.isSelectAll&&portlet.isSelectAll());portlet.model.deleteFilterStackSelectors([portlet.defn],ignoreTargetData);}};},isDragValid:function isDragValid(context){return $DOM.contains(this.titlebarNode,context.src.node);},ondragstart:function ondragstart(context){this._super(context);this.domNode.style.display="none";},ondragmove:function ondragmove(context){if(dragWithin(context)){var data=context.src.data,dim=data&&data.dim,pdim=data&&data.parentDim;this.avatar=context._selfAvatar;this.positionAvatar({x:(dim.x-pdim.x),y:(context.tgt.pos.y-pdim.y)});context._avatarNode.style.display="none";context._selfAvatar.style.display="block";return true;}this.avatar=context._avatarNode;context._avatarNode.style.display="block";context._selfAvatar.style.display="none";return this._super(context);},wasDropped:function(){delete this.selector.node.defn.iifp;this.parent.removeChildren(this);this.destroy();},ondragend:function ondragend(context){var domNode=this.domNode;if(domNode){$CSS.removeClass(domNode,"showFPBorder");domNode.style.display="block";}this.avatar=context._avatarNode;this._super(context);if(context._selfAvatar){var parent=this.parent;if(parent){parent.domNode.firstChild.removeChild(context._selfAvatar);}delete context._selfAvatar;}},createAvatar:function createAvatar(el,context){var avatar;if(!context._avatarNode){avatar=context._avatarNode=document.createElement("div");avatar.appendChild(this.titlebarNode.cloneNode(true));avatar.style.margin="20px 0 0 20px";avatar.style.display="none";avatar.className=this.avatarCssClass;}if(!context._selfAvatar){if(this.domNode.className.indexOf("showFPBorder")===-1){$CSS.addClass(this.domNode,"showFPBorder");}avatar=context._selfAvatar=document.createElement("div");avatar.className=this.selfAvatarCssClass;avatar.appendChild(this.domNode.cloneNode(true));var icon=document.createElement("div");icon.className="icon";avatar.appendChild(icon);avatar.style.position="absolute";avatar.style.opacity=0.75;this.parent.domNode.firstChild.appendChild(avatar);}return context._avatarNode;}},mstrmojo.mixin(mstrmojo._HasOwnAvatar,{}));mstrmojo.vi.ui.rw.FilterPortlet=mstrmojo.declare(mstrmojo.vi.ui.PanelPortlet,[__DraggableFP,mstrmojo.vi.ui.rw.selectors._HasFilterContextMenu,mstrmojo.vi._MonitorsAppState,mstrmojo.util.ui._HostsSplitter],{scriptClass:"mstrmojo.vi.ui.rw.FilterPortlet",layoutConfig:{h:{titlebarNode:"20px",containerNode:"100%",handleNode:"4px"},w:{titlebarNode:"all",containerNode:"all"},xt:true},canCollapse:true,showTitleBarContextMenu:true,srcId:"",selector:null,summaryBar:null,postBuildRendering:function postBuildRendering(){var handleNode=this.handleNode;$CSS.addClass(handleNode,"showSplitter "+mstrApp.getThemeClassName());$CSS.removeClass(handleNode,"v");$CSS.addClass(handleNode,"h");this.registerSplitter(this.handleNode);var titleBar=this.titleBar,label=titleBar.lblTitle,fnLabelOnclick=label.onclick;label.onclick=function(evt){var timeout=this._timeoutClick,me=this;if(!timeout){this._timeoutClick=window.setTimeout(function(){fnLabelOnclick.call(label,evt);titleBar.btnCollapse.onclick(evt);delete me._timeoutClick;},DOUBLE_CLICK_INTERVAL);}};etraDNDEffect(this.titlebarNode,this.domNode);if(this.isCollapsed&&!this.summaryBar){this.addChildren(getSummaryChildren.call(this,getSummaryText.call(this)));}this.height=Math.max(parseInt(this.height,0),MIN_HEIGHT)+"px";if(mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation()){this.draggable=false;}return this._super();},onAppStateChange:function onAppStateChange(evt){var presentationMode=mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION,isPresentationOn=evt.value===presentationMode;if(isPresentationOn||evt.valueWas===presentationMode){this.draggable=!isPresentationOn;this.generateToolbar();}},getFormats:function getFormats(){var fmts=this.selector.getFormats();delete fmts.left;delete fmts.top;return fmts;},getTitleBarCfg:function getTitleBarCfg(){var cfg=this._super(),selector=this.selector;cfg.isCollapsed=this.isCollapsed;this.baseTitle=cfg.title;this.title=cfg.title=getTitle.call(this);cfg.useRichTooltip=true;cfg.shouldShowTooltip=function shouldShowTooltip(evt,win){this._showTooltipForSameNameObj=existSameNameObj(selector);return this.constructor.prototype.shouldShowTooltip.call(this,evt,win)||this._showTooltipForSameNameObj;};cfg.getTooltipContent=function getTooltipContent(evt){return this.constructor.prototype.getTooltipContent.call(this,evt)+(this._showTooltipForSameNameObj?"("+mstrmojo.string.encodeHtmlString(findItemSrcDataset(selector).join(","))+")":"");};return cfg;},onisCollapsedChange:function onisCollapsedChange(){var portlet=this,portletKey=portlet.k,selector=this.selector,model=selector.model,isCollapsed=this.isCollapsed,ds=isCollapsed?1:0;selector.defn.set("ds",ds);selector.set("visible",!isCollapsed);this.handleNode.style.display=isCollapsed?"none":"block";if(!this._onCollapseAll){var filterPanel=model.getVIComponent($VI_TYPES.FILTER_PANEL),updateFilterPanelScrollBars=function(){filterPanel.raiseEvent({name:"filterPanelUpdated"});};model.execute({execute:function(){this.submit(model.getUnitFormatAction(selector,1,{FormattingView:{WindowState:ds}}),{success:updateFilterPanelScrollBars},mstrmojo.DocDataService.REQUEST_ONLY_DEFINITION);},urInfo:{callback:{success:function(res){model.updateDefnCache(res.defn,[portletKey]);filterPanel.rebuildChild(filterPanel.children.filter(function(child){return child.k===portletKey;})[0]);updateFilterPanelScrollBars();}},treesToRender:1}});}var summaryBar=this.summaryBar;if(isCollapsed){var summaryText=getSummaryText.call(this);if(!summaryBar){this.addChildren(getSummaryChildren.call(this,summaryText));}else{summaryBar.set("text",summaryText);summaryBar.set("title",summaryText);summaryBar.render();}}else{if(summaryBar){summaryBar.unrender();this.removeChildren(summaryBar);}}},oncountChange:function oncountChange(){this.set("title",getTitle.call(this));},onbaseTitleChange:function onbaseTitleChange(){this.set("title",getTitle.call(this));},clearFilters:function clearFilters(){var selector=this.selector;if(selector){selector.clearSelector();refreshSummaryBar(selector);}},getSplitterInfo:function getSplitterInfo(){return{min:VIS_MIN_HEIGHT};},splitterMoved:function splitterMoved(position){var value=parseInt(this.height,10)+position+"px",oldHeight,selector=this.selector,model=selector.model,handleNode=this.handleNode,me=this,filterPanel=me.parent,fnSetHeright=function(h){var portlet=me;if(!portlet.parent){(filterPanel.children||[]).forEach(function(item){if(item.k===portlet.k){portlet=item;}});}oldHeight=portlet.height;portlet.set("height",h);handleNode.style.top="";portlet.doLayout();selector.getFilterPanel().updateScrollbars();};fnSetHeright(value);var action=model.getUnitFormatAction(selector,1,{FormattingSize:{Height:mstrmojo.boxmodel.px2Inches(model.getZoomProps(),value)}}),callback={success:function(res){model.updateDefnCache(res.defn,[selector.k]);}},extras={style:{params:{treesToRender:1}}};model.execute({execute:function(){this.submit(action,callback,extras);},urInfo:{undo:function(){fnSetHeright(oldHeight);},redo:function(){fnSetHeright(oldHeight);},callback:callback,extras:extras}});},setSlotDimensions:function setSlotDimensions(slot,h,w){if(slot!=="containerNode"){this._super(slot,h,w);}},doLayout:function doLayout(){this._super();var domNode=this.domNode;if(domNode){domNode.style.height="auto";}},addMenuItems:function addMenuItems(cfg){var selector=this.selector;cfg.isHostedWithin=false;cfg.hostId=this.id;if(!selector.isRecursiveAttributeSelector()){this.addModeMenuItems(cfg,selector,function(){refreshSummaryBar(selector);});}cfg.addSeparator();var ctrlKey=selector.ckey,filterPanel=selector.getFilterPanel(),portletId=this.id,isPresentationMode=mstrApp.appState===mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION,isFromSolr=selector.model.isFromSolrCube(selector.defn.srcid);this.addClearFilterMenuItem(cfg,selector,function(){filterPanel.clearSingleBuffSlice(ctrlKey);refreshSummaryBar(selector);});cfg.addSeparator();this.addQualMenuItems(cfg,selector);if(!isPresentationMode){if(selector.isAttributeSelector()&&!isFromSolr){cfg.addEditorMenuItem(mstrmojo.desc(13628,"Filter by Rank"),portletId,getTopRankSubMenuEditor);}cfg.addSeparator();if(!isFromSolr){this.addFilterStyleMenuItem(cfg,selector);}this.addMultiSelectMenuItem(cfg,selector);cfg.addSeparator();}if(selector.supportsSetTarget()&&!isFromSolr){this.addMenuItemIfSelectTargetsValid(cfg,selector,mstrmojo.desc(11572,"Select other filters within the Filter panel."));cfg.addSeparator();}if(!isPresentationMode){cfg.addMenuItem(mstrmojo.desc(629,"Delete"),"Delete",function(){var ignoreTargetData=!!(selector.isSelectAll&&selector.isSelectAll());selector.model.deleteFilterStackSelectors([selector.defn],ignoreTargetData);});}var menus=cfg.menus,len=menus.length,i,low=-1,high=len;if(menus&&len>1){for(i=0;i<len;i++){if(menus[i].cls!=="seperator"){break;}low=i;}for(i=len-1;i>=0;i--){if(menus[i].cls!=="separator"){break;}high=i;}cfg.menus=menus.slice(low+1,high);}},getTargetInfo:function getTargetInfo(){var selector=this.selector;var targetItems=selector.getFilterPanel().getFilterDefinitions().filter(function(defn){return(defn.ckey!==selector.ckey)&&((defn.srct===TP_ATTRIBUTE&&defn.style!==$STYLES.ATTR_QUAL)||defn.srct===TP_CONSOLIDATION||defn.srct===STP_CUSTOM_GROUP);}).map(function(defn){return{n:defn.ttl,id:defn.ckey,st:defn.style};});return{keys:(selector.defn.tks||"").split(ITEM_SEP).filter(function(key){return targetItems.some(function(item){return item.id===key;});}),items:targetItems};}});}());