(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css","mstrmojo.Vis","mstrmojo._HasOwnAvatar");var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,PX="px";function getPositionInBoundary(pos,boundaryPosition){return{x:pos.x-boundaryPosition.x,y:pos.y-boundaryPosition.y};}function getPointDistanceSquare(p1,p2){return(p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y);}function isDragValid(context){var data=context.src.data;return(!data||!data.isScrollBar);}mstrmojo.VisLegend=mstrmojo.declare(mstrmojo.Vis,[mstrmojo._HasOwnAvatar],{scriptClass:"mstrmojo.gm.VisLegend",bodyCssClass:"",avatarCssClass:"legend-dragged",dropZoneHighlightCss:"legend-dropZone",ownAvatar:true,draggable:true,dropZone:true,dockedPositions:null,calculateDockedPositions:mstrmojo.emptyFn,widget:null,boundaryNode:null,draggableNodeName:"domLegend",legendMarkup:"",extrasMarkup:"",markupString:'<div id="{@id}" class="{@cssClass}" style="width:{@width}px;height:{@height}px;top:{@top}px;left:{@left}px;position:absolute;" mstrAttach:click,mouseover,mouseout><div class="gm-legend-bg"><div class="{@bodyCssClass}" style="width:{@width}px;height:{@height}px;text-decoration:inherit">{@legendMarkup}</div></div><div class="gm-anchor-point topLeft"></div><div class="gm-anchor-point topRight"></div><div class="gm-anchor-point bottomLeft"></div><div class="gm-anchor-point bottomRight"></div>{@extrasMarkup}</div>',markupSlots:{dropZoneNode:function(){return this.domNode;},domLegend:function(){return this.domNode.firstChild.firstChild;}},postBuildRendering:function(){this._super();this.calculateDockedPositions(this.widget.getWidth(),this.widget.getHeight());this.boundaryNode=this.widget.domNode;this.boundaryPosition=$DOM.position(this.boundaryNode,true);},createAvatar:function createAvatar(){return this[this.draggableNodeName];},updateDropZoneNode:function updateDropZoneNode(context){var dockedPos=this.dockedPositions;if(dockedPos&&dockedPos.length>0){var pos=getPositionInBoundary(context.tgt.pos,this.boundaryPosition);var minDistance=getPointDistanceSquare(pos,dockedPos[0]),dockedPosIdx=0,i,distance;for(i=1;i<dockedPos.length;i++){distance=getPointDistanceSquare(pos,dockedPos[i]);if(distance<minDistance){minDistance=distance;dockedPosIdx=i;}}if(dockedPosIdx!==this.currDockedPositionIdx){var dropZoneStyle=this.dropZoneNode.style;dropZoneStyle.left=dockedPos[dockedPosIdx].x+PX;dropZoneStyle.top=dockedPos[dockedPosIdx].y+PX;if(this.widget.onLegendDropZoneChange){this.widget.onLegendDropZoneChange(dockedPos[dockedPosIdx],dockedPosIdx);}this.currDockedPositionIdx=dockedPosIdx;this.updateAlignClass();return true;}}return false;},toggleDropZoneBorder:function toggleDropZoneBorder(on){$CSS.toggleClass(this.dropZoneNode,this.dropZoneHighlightCss,on);},isDragValid:isDragValid,ondragstart:function ondragstart(context){if(!isDragValid(context)){return ;}this._super(context);this.toggleDropZoneBorder(true);},ondragmove:function ondragmove(context){if(!isDragValid(context)){return ;}this.updateDropZoneNode(context);this._super(context);},allowDrop:function allowDrop(context){var dragSrc=context.src,widget=dragSrc&&dragSrc.widget;return(widget&&widget!==this&&widget.parent===this.parent);},ondrop:function ondrop(context){var legendNode=this.domLegend;$CSS.removeClass(legendNode,this.avatarCssClass);var legendStyle=legendNode.style;legendStyle.left="0";legendStyle.top="0";this.dropZoneNode.firstChild.appendChild(legendNode);if(this.widget.onLegendDropped){var dockedPosition=this.getDockedPosition();this.widget.onLegendDropped(dockedPosition&&dockedPosition.pos);}context.dropSuccessful=true;},getDockedPosition:function getDockedPosition(){return this.dockedPositions&&this.dockedPositions[this.currDockedPositionIdx];},ondragend:function ondragmove(context){if(!isDragValid(context)){return ;}this._super(context);if(!context.dropSuccessful){this.ondrop(context);}this.toggleDropZoneBorder(false);},positionAvatar:function positionAvatar(pos){var me=this,avatar=this.avatar,avs=avatar.style,boundaryPosition=this.boundaryPosition;var constrainPos=function(axis,value){if(axis==="x"){if(value<boundaryPosition.x){return boundaryPosition.x;}return Math.min(value,boundaryPosition.x+boundaryPosition.w-me.domNode.offsetWidth);}if(axis==="y"){if(value<boundaryPosition.y){return boundaryPosition.y;}return Math.min(value,boundaryPosition.y+boundaryPosition.h-me.domNode.offsetHeight);}};avs.left=constrainPos("x",pos.x)+PX;avs.top=constrainPos("y",pos.y)+PX;}});}());