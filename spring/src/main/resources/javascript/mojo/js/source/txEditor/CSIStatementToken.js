(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.hash","mstrmojo.array","mstrmojo.Widget","mstrmojo.txEditor.CommonComponent");var $A=mstrmojo.array,$S=mstrmojo.string,$C=mstrmojo.css,$H=mstrmojo.hash,_TC=mstrmojo.txEditor.CommonComponent,_CSIKT=_TC.CSI_KEYWORD_TYPE,OP_LIST=["=","+","-","*","/","<",">"],DEL_LIST=OP_LIST.concat(["(",")",",",";"," "]),SQL_KEYWD={AND:true,OR:true,NOT:true},DEL_MAP=null,OP_MAP=buildOperationMap();function _isDelimiter(c){if(!DEL_MAP){DEL_MAP={};$A.forEach(DEL_LIST,function(delimit){DEL_MAP[delimit]=true;});}return !!DEL_MAP[c];}function buildOperationMap(){var opMap={};$A.forEach(OP_LIST,function(op){opMap[op]=true;});return opMap;}function _isOperation(c){return c&&OP_MAP[c];}function mstrObj2Token(obj){var token={isDelimiter:false,isMstrObj:true,v:obj.v||obj.n};if(12===obj.tp){token.exv=obj.fid;token.extp="8";var an=(obj.n.split("@"))[0];token.oi={did:obj.did,t:12,n:an};}else{if(4===obj.tp){token.oi={did:obj.did,t:4,n:obj.n};}else{if(obj.key){token.exv=obj.key;token.extp="8";token.tp=_CSIKT.FIELDUNIT;}}}return token;}function _isMstrObj(data){var s=data.v,model=mstrmojo.all.offModel,dsObjs=model.tgtDs&&model.tgtDs.dsObjs,nObjs=model.offTxs.tscObjs,items=!(dsObjs&&nObjs)?(dsObjs||nObjs||[]):dsObjs.concat(nObjs),matchCount=0,matchItem;$A.forEach(items,function(item){if(item.n==s){++matchCount;matchItem=item;}});if(matchCount==1){$H.copy(mstrObj2Token(matchItem),data);data.isMstrObj=true;return true;}if(matchCount>1){}return false;}function _isKeyWord(word){if(!word){return false;}return !!(SQL_KEYWD[word.toUpperCase()]||OP_MAP[word]);}mstrmojo.txEditor.CSIStatementToken=mstrmojo.declare(mstrmojo.Widget,null,{data:null,markupString:'<span id={@id} class="mstrmojo-TransactionEditor-Token {@cssClass}"></span>',markupMethods:{ondataChange:function(){var d=this.data;if(d.v===","){this.domNode.innerHTML=String(d.v)+"&nbsp;";}else{this.domNode.innerHTML=$S.encodeHtmlString(String(d.v));}$C.toggleClass(this.domNode,["mstr"],this.isMstrObj());$C.toggleClass(this.domNode,["keyword"],_isKeyWord(String(d.v)));}},isMstrObj:function(){var isMs=this.data.isMstrObj||(this.length()&&_isMstrObj.call(this,this.data));this.data.isMstrObj=isMs;return isMs;},length:function length(){return this.data.v.length;},isDelimiter:function isDelimiter(){var isDel=this.data.isDelimiter||(this.length()===1&&_isDelimiter(this.data.v));this.data.isDelimiter=isDel;return isDel;},split2Tokens:function split2Tokens(offset){var d=this.data,s=d&&d.v,sb=s.substring(0,offset),sa=s.substring(offset),tokens=[];sb&&tokens.push({v:sb});sa&&tokens.push({v:sa});return tokens;},mergeTo:function(w){var d=this.data,s=d&&d.v||"",ws=w.data.v;return{v:s+ws};},spliceContent:function spliceContent(offset,length,istChar){var d=this.data,s=d&&d.v,sb=s.substring(0,offset);$H.clear(d);length=(null==length)?(s.length-offset):length;var sa=s.substring(offset+length);d.v=sb+(istChar||"")+sa;d.isMstrObj=false;d.isDelimiter=false;this.set("data",d);this.paint();}});mstrmojo.txEditor.CSIStatementToken.isDelimiter=_isDelimiter;mstrmojo.txEditor.CSIStatementToken.isMstrObj=_isMstrObj;mstrmojo.txEditor.CSIStatementToken.mstrObj2Token=mstrObj2Token;mstrmojo.txEditor.CSIStatementToken.isOperation=_isOperation;}());