(function(){mstrmojo.requiresCls("mstrmojo.array");var getCacheKey=function(obj){var mid=(mstrApp.docModelData&&mstrApp.docModelData.mid)||"";return obj.k+"-"+mid;},highlightsCache={},$ARR=mstrmojo.array;mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights=mstrmojo.provide("mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights",{_mixinName:"mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights",postBuildRendering:function postBldRndr(){this._super();this.setup();if(!this.getExp()){if(highlightsCache[getCacheKey(this)]){this.highlight.apply(this,highlightsCache[getCacheKey(this)]);}else{this.highlight(this.getSelectionType(),this.getSelectionHash(),true);}}},getExp:function(){var data=this.model.data,exp=data&&data.sc&&data.sc.exp;return exp;},clearsBrushingOnHighlight:true,brushSub:null,clearSub:null,getAssociatedNodes:function getAssociatedNodes(){var gt=this.defn.an;return gt&&gt.length>0?gt:[];},hasAssociatedNodes:function hasAssociatedNodes(){var an=this.getAssociatedNodes();return an.length>0;},getDocModelForEvent:function getDocModelForEvent(){return this.model&&this.model.docModel;},setup:function setup(){var docModel=this.getDocModelForEvent(),id=this.id;if(docModel){[this.brushSub,this.clearSub].forEach(function(sub){if(sub){sub.clear();}});this.brushSub=docModel.attachEventListener("brushing",id,this.onBrushing);this.clearSub=docModel.attachEventListener("clearBrush",id,this.onClearBrushing);}},handlesMultiSelection:function handlesMultiSelection(){return(this._super&&this._super())||this.getAssociatedNodes().length>0;},getHighlightKeys:function getHighlightKeys(){var r=[],an=this.getAssociatedNodes();an.forEach(function(item){r.push(item.k);});return r;},onSelectionChange:function onSelectionChange(data){var handled=false;if(this._super){handled=this._super(data);}var model=this.getDocModelForEvent();if(this.clearsBrushingOnHighlight){model.raiseEvent({name:"clearBrush",from:this});}if(this.handlesMultiSelection()&&!handled){model.raiseEvent({name:"brushing",from:this,keys:this.getHighlightKeys()});return true;}return false;},onBrushing:function onBrushing(evt){var evtKeys=evt.keys.slice();if(evtKeys.indexOf(this.k)!==-1){if(this.highlight){var f=evt.from;this.highlight(f.getSelectionType(),f.getSelectionHash());evtKeys.push(f.k);this.getDocModelForEvent().raiseEvent({name:"clearBrush",from:this,excludeKeys:evtKeys});}else{throw new Error(this.scriptClass+" must implement highlight method.");}}},onClearBrushing:function onClearBrushing(evt){var resolved=false;if($ARR.indexOf(evt.excludeKeys,this.k)===-1){if(this._super){resolved=this._super(evt);}if(!resolved){var associatedNodes=this.getAssociatedNodes();if($ARR.find(associatedNodes,"k",evt.from.k)!==-1){this.clearSelections(true);}}}return true;},highlight:function highlight(){highlightsCache[getCacheKey(this)]=arguments;if(this._super){this._super.apply(this,arguments);}},clearSelections:function clearSelections(){delete highlightsCache[getCacheKey(this)];if(this._super){this._super.apply(this,arguments);}},updateAssociatedNodesOnMove:function updateAssociatedNodesOnMove(){this.clearSelections(true);this.endSelections();delete this.defn.an;}});}());