(function(){mstrmojo.requiresCls("mstrmojo.ui.Pulldown","mstrmojo.ui.ButtonBar","mstrmojo.ui.editors.controls.ComboBox","mstrmojo.ui.editors.controls.ColorPickerButton","mstrmojo.NumGroupStepperContentProvider","mstrmojo._FormatDefinition","mstrmojo.models.FormatModel");var $FD=mstrmojo._FormatDefinition,$FORMAT_MODEL=mstrmojo.models.FormatModel,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,CTRL_FONT_FAMILY=1,CTRL_FONT_STYLE=2,CTRL_FONT_SIZE_AND_COLOR=4,CTRL_FONT_STYLE_NO_STRIKEOUT=8,CTRL_FONT_SIZE_STEPPER=16;var fontSizeItems;var fontFamilyItems;var fontStyleMap={bold:$ENUM_FORMAT_PROPERTIES.FONT_WEIGHT,italic:$ENUM_FORMAT_PROPERTIES.FONT_STYLE,underline:$ENUM_FORMAT_PROPERTIES.UNDERLINE,strikeout:$ENUM_FORMAT_PROPERTIES.LINE_THROUGH};function isFontSizeStepper(flag){return(flag&CTRL_FONT_SIZE_STEPPER)>0;}function updateFontFamily(formats){var enFontFamily=$ENUM_FORMAT_PROPERTIES.FONT_FAMILY,fontFamily=formats[enFontFamily]||$FORMAT_MODEL.getFormatBlockValue(formats,enFontFamily),pulldown=this.hcgControls.fontFamily;if(fontFamily===-1){var list=pulldown&&pulldown.list;if(!list){return ;}list.clearSelect();delete pulldown.selectedIndex;if(pulldown.hasRendered){pulldown.refresh();}}else{pulldown.set("selectedIndex",Math.max(fontFamilyItems.map(function(font){return font.n;}).indexOf(fontFamily)));}}function updateFontStyle(formats){var styleValues=[],fnAddFontStyle=function(propertyName,cssName,idx){var cssValue=formats[propertyName];if(cssValue===undefined){cssValue=$FORMAT_MODEL.getFormatBlockValue(formats,propertyName);}if(cssValue){styleValues.push(idx);}};fnAddFontStyle($ENUM_FORMAT_PROPERTIES.FONT_WEIGHT,"bold",0);fnAddFontStyle($ENUM_FORMAT_PROPERTIES.FONT_STYLE,"italic",1);fnAddFontStyle($ENUM_FORMAT_PROPERTIES.UNDERLINE,"underline",2);fnAddFontStyle($ENUM_FORMAT_PROPERTIES.LINE_THROUGH,"line-through",3);this.hcgControls.fontStyle.select(styleValues);}function updateFontSizeAndColor(formats){var hcgControls=this.hcgControls,enFontSize=$ENUM_FORMAT_PROPERTIES.FONT_SIZE,enFontColor=$ENUM_FORMAT_PROPERTIES.COLOR,fontSize=formats[enFontSize]||$FORMAT_MODEL.getFormatBlockValue(formats,enFontSize),fontSizeController=hcgControls.fontSize;var fontColor=formats[enFontColor];if(typeof fontColor==="undefined"||fontColor===null){fontColor=$FORMAT_MODEL.getFormatBlockValue(formats,enFontColor);}if(typeof fontColor==="undefined"||fontColor===null){fontColor="";}if(isFontSizeStepper(this.visibleControls)){if(fontSize.length){fontSizeController.provider.set("curValGroup",fontSize);}}else{if(fontSize===-1){fontSizeController.list.clearSelect();fontSizeController.selectedValue="";fontSizeController.updatePreview();}else{fontSizeController.set("selectedValue",fontSize?(parseInt(fontSize,10)).toString():fontSizeController.items[0].n);}}hcgControls.fontColor.set("selectedValue",fontColor===""?"conflict":$FORMAT_MODEL.decodeValue($ENUM_FORMAT_PROPERTIES.COLOR,fontColor));}function initFontItems(){if(fontSizeItems&&fontFamilyItems){return ;}fontSizeItems=$FD.SizesInVI.map(function(size){return{idx:parseInt(size.n,10),n:size.n};});fontFamilyItems=mstrmojo._FormatDefinition.Families.slice(1).map(function(font){return{n:font.n,id:font.n};});}mstrmojo.ui.editors.controls._HasCharacterGroup=mstrmojo.provide("mstrmojo.ui.editors.controls._HasCharacterGroup",{_mixinName:"mstrmojo.ui.editors.controls._HasCharacterGroup",visibleControls:CTRL_FONT_FAMILY+CTRL_FONT_STYLE+CTRL_FONT_SIZE_AND_COLOR,showNoFillInColor:true,hcgControls:null,getHCGControls:function getHCGControls(fnChange){initFontItems();var controls=this.hcgControls={},ctrlFlags=this.visibleControls;if((ctrlFlags&CTRL_FONT_FAMILY)>0){controls.fontFamily=mstrmojo.ui.Pulldown.newPulldown(fontFamilyItems,function(newItem,oldItem){fnChange($ENUM_FORMAT_PROPERTIES.FONT_FAMILY,newItem.id,oldItem&&oldItem.id);},0,{isHostedWithin:false});}if((ctrlFlags&CTRL_FONT_STYLE)>0||(ctrlFlags&CTRL_FONT_STYLE_NO_STRIKEOUT)>0){var fontStyleControl=controls.fontStyle=new mstrmojo.ui.ButtonBar({multiSelect:true,items:[{n:mstrmojo.desc(2718,"Bold"),id:"b",css:"bold"},{n:mstrmojo.desc(2719,"Italic"),id:"i",css:"italic"},{n:mstrmojo.desc(2720,"Underline"),id:"u",css:"underline"},{n:mstrmojo.desc(3062,"Strikeout"),id:"s",css:"strikeout"}],postselectionChange:function(evt){var added=evt.added,item=this.items[added?added[0]:evt.removed[0]],isSelected=!!added;if(item){fnChange(fontStyleMap[item.css],isSelected,!isSelected);}}});if((ctrlFlags&CTRL_FONT_STYLE_NO_STRIKEOUT)>0){fontStyleControl.items.pop();}}if((ctrlFlags&CTRL_FONT_SIZE_AND_COLOR)>0){controls.fontSize=isFontSizeStepper(ctrlFlags)?new mstrmojo.ui.editors.controls.Stepper({provider:new mstrmojo.NumGroupStepperContentProvider({item:{interval:1},curValGroup:[],min:Math.min.apply(Math,fontSizeItems.map(function(size){return size.idx;})),max:Math.max.apply(Math,fontSizeItems.map(function(size){return size.idx;})),container:this,onTraverse:function(){var stepper=this.container.fontSize;if(stepper._sync){return ;}this.container.raiseFormatValueChange($ENUM_FORMAT_PROPERTIES.FONT_SIZE,stepper.provider.getValGroup());},oncurValGroupChange:function(){var stepper=this.container.fontSize;if(stepper.textNode){stepper.updateDisplayText();}}})}):new mstrmojo.ui.editors.controls.ComboBox({selectedValue:"10",items:fontSizeItems,isHostedWithin:false,validateTextInput:function(text){return(/^[0-9]+(pt)?$/.test(text));},updateSelection:function(){this.set("selectedValue",parseInt(this.txtLabel.value,10).toString());},postselectedValueChange:function(evt){fnChange($ENUM_FORMAT_PROPERTIES.FONT_SIZE,parseInt(evt.value,10)+"pt",parseInt(evt.valueWas,10)+"pt");}});controls.fontColor=new mstrmojo.ui.editors.controls.ColorPickerButton({showGradient:false,showNoFill:this.showNoFillInColor,selectedValue:"#000000",postselectedValueChange:function(evt){fnChange($ENUM_FORMAT_PROPERTIES.COLOR,evt.value,evt.valueWas);}});}return controls;},setFormatSource:function setFormatSource(formats){var group=this;this.syncControls(function(){var ctrlFlags=this.visibleControls;if((ctrlFlags&CTRL_FONT_FAMILY)>0){updateFontFamily.call(group,formats);}if((ctrlFlags&CTRL_FONT_STYLE)>0||(ctrlFlags&CTRL_FONT_STYLE_NO_STRIKEOUT)>0){updateFontStyle.call(group,formats);}if((ctrlFlags&CTRL_FONT_SIZE_AND_COLOR)>0){updateFontSizeAndColor.call(group,formats);}});}});mstrmojo.ui.editors.controls._HasCharacterGroup.CTRL_FLAGS={FONT_FAMILY:CTRL_FONT_FAMILY,FONT_STYLE:CTRL_FONT_STYLE,FONT_SIZE_AND_COLOR:CTRL_FONT_SIZE_AND_COLOR,FONT_STYLE_NO_STRIKEOUT:CTRL_FONT_STYLE_NO_STRIKEOUT,FONT_SIZE_USE_STEPPER:CTRL_FONT_SIZE_STEPPER};mstrmojo.ui.editors.controls._HasCharacterGroup.ControlsType=null;}());