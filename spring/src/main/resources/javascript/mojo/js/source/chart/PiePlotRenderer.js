(function(){mstrmojo.requiresCls("mstrmojo.Base","mstrmojo.VisUtility");mstrmojo.requiresClsP("mstrmojo.chart","TripleId","FormatFill","FormatLine","PieSliceObject","ChartConstants");mstrmojo.requiresClsP("mstrmojo.chart.enums","EnumGraphMatrixPiePlotType","EnumGraphMatrixMarkerTypeInChart");mstrmojo.requiresClsP("mstrmojo.chart.model.enums","EnumDSSGraphMarkerShape","EnumDSSGraphObject","EnumVariantBool","EnumDSSExtraGraphProperty","EnumShapeType","EnumDSSGraphNumberFormatType");var $C=mstrmojo.chart,$VISUTIL=mstrmojo.VisUtility,$K=$C.ChartConstants,$CHART_ENUMS=$C.enums,$GMPPT=$CHART_ENUMS.EnumGraphMatrixPiePlotType,$GM_MarkerStyle=$CHART_ENUMS.EnumGraphMatrixMarkerTypeInChart,$M=$C.model,$MODEL_ENUMS=$M.enums,$GO=$MODEL_ENUMS.EnumDSSGraphObject,$SHP=$MODEL_ENUMS.EnumShapeType,$MS=$MODEL_ENUMS.EnumDSSGraphMarkerShape,kPieLayout_Pie=0,kPieLayout_Ring=1,kDataLabelHide=1,kDataLabelShowValue=2,kDataLabelShowText=3;var perfPieSliceId=new $C.TripleId(),axisFormat=new $C.ChartAdvFormat();function hGetMinSizeByGroupTotal(){var chartCtx=this.mChartContextPtr,gmCtx=chartCtx.GetGraphMatrixContext();this.mMinSizeByTotal=0;if(!this.mHasSizeBy){return this.mMinSizeByTotal;}this.mMinSizeByTotal=gmCtx.mMinSizeVal;return this.mMinSizeByTotal;}function hGetMaxSizeByGroupTotal(){var chartCtx=this.mChartContextPtr,gmCtx=chartCtx.GetGraphMatrixContext();if(!this.mHasSizeBy){this.mMaxSizeByTotal=1;return this.mMaxSizeByTotal;}this.mMaxSizeByTotal=gmCtx.mMaxSizeVal;return this.mMaxSizeByTotal;}function hInit(){var chartCtx=this.mChartContextPtr,gmCtx=chartCtx.GetGraphMatrixContext();hGetMaxSizeByGroupTotal.call(this);hGetMinSizeByGroupTotal.call(this);if(gmCtx.mMarkerShape===$MS.DssGraphMarkerShape2DPie){this.mPieOption.mLayout=kPieLayout_Pie;}else{this.mPieOption.mLayout=kPieLayout_Ring;}}function hGetPieRadius(iSeriesId,iGroupId,iAngleIndex,iAgnleCount){var gmCtx=this.mChartContextPtr.GetGraphMatrixContext(),innerPieRatio,angleCount,radius=2;if(this.mHasSizeBy){radius=gmCtx.getSizeByPieRadius(this.mDatasetPtr,iSeriesId,iGroupId,this.mMaxSizeByTotal,this.mMinSizeByTotal,this.mPieOption.mMaxRadius);if(radius>=0&&radius<1){radius=1;}}else{radius=this.mPieOption.mMaxRadius;}innerPieRatio=1;if(this.mPlotType===$GMPPT.GMPPT_VALUE){angleCount=iAgnleCount||this.mDatasetPtr.GetPieCountAtOneDataPoint(iSeriesId,iGroupId);innerPieRatio=(iAngleIndex+1)/angleCount;radius=innerPieRatio*radius;if(angleCount>1){radius-=1;}}return radius;}function hGetAngleInfoForSinglePie(iSeriesId,iGroupId,iAngleIndex){var angle,sliceCount,subTotalValue,i,dataset=this.mDatasetPtr,pieOptions=this.mPieOption,result={};result.Angles=[];result.ValidSeriesNumber=0;result.ValidSeriesIndex=[];result.IsValid=false;angle=360-pieOptions.mPieRotation;result.Angles.push(angle);result.ValidSeriesIndex.splice(0,result.ValidSeriesIndex.length);sliceCount=this.mDatasetPtr.GetPieSliceCount(iSeriesId,iGroupId,0);subTotalValue=0;for(i=0;i<sliceCount;++i){var percentage=dataset.GetPieSlicePercentage(iSeriesId,iGroupId,iAngleIndex,i);if(percentage!==null){if(percentage<=1||percentage>=-1){++result.ValidSeriesNumber;result.ValidSeriesIndex.push(i);}subTotalValue+=percentage;if(i===(sliceCount-1)){angle=720-pieOptions.mPieRotation;}else{angle=Math.round(Math.abs(360*subTotalValue)+1)+(360-pieOptions.mPieRotation);}}else{if(i===(sliceCount-1)){angle=720-pieOptions.mPieRotation;}}if(angle>720-pieOptions.mPieRotation){angle=720-pieOptions.mPieRotation;}result.Angles.push(angle);}result.IsValid=true;return result;}function hRenderSliceDataLabel(tripleId,pieSlice){var chartCtx=this.mChartContextPtr,gmCtx=chartCtx.GetGraphMatrixContext(),finalStr="",dataValue,dataset=this.mDatasetPtr,dataLabelId=new $C.TripleId({ObjectId:$GO.DssGraphDataText,SeriesId:tripleId.mSeriesId,GroupId:tripleId.mGroupId}),numberObj,text,dataLabel,datalabelStyle=dataset.dataLabelStyle,textRect,pieSliceInfo=pieSlice.GetSliceInfo(),middleAngleRadian,middleAngleQuadrant,xOffset,yOffset,yAdjust,isLeft=false,dataLabelPadding=5;if(dataset.showPieSliceDatalabel(tripleId.mSeriesId,tripleId.mGroupId,tripleId.angleByIndex,tripleId.sliceById)===false){return null;}dataLabelId.angleByIndex=tripleId.angleByIndex;dataLabelId.sliceById=tripleId.sliceById;if(chartCtx.mIsGraphMatrix){dataLabelPadding=gmCtx.getPadding($K.kDataLabel);}switch(datalabelStyle){case kDataLabelShowValue:dataValue=dataset.GetPieSliceData(tripleId.mSeriesId,tripleId.mGroupId,tripleId.angleByIndex,tripleId.sliceById);if(dataValue===undefined||dataValue===null){return null;}axisFormat.restore();dataset.getGridDataFormatForPie(axisFormat,tripleId);numberObj=new $C.NumberObject({TripleId:dataLabelId,GraphObjectManager:this.mpManager,Number:dataValue,NumberFormat:axisFormat,GraphCollectionObject:null,Locale:0,clientDrag:false,DataSet:null,IsFinal:false,ColumnOffset:0});if(numberObj!==undefined&&numberObj!==null){finalStr=numberObj.mText;}dataLabel=numberObj;break;case kDataLabelShowText:text=dataset.GetTextLabel(tripleId.mSeriesId,tripleId.mGroupId,tripleId.angleByIndex,tripleId.sliceById);finalStr=text;dataLabel=new $C.TextObject({TripleId:dataLabelId,GraphObjectManager:this.mpManager,GraphCollectionObject:null});break;}if(dataLabel!==undefined&&dataLabel!==null&&finalStr!==""){dataLabel.SetText(finalStr);textRect=dataLabel.GetBoundingRect();}else{return null;}middleAngleRadian=pieSlice.GetMiddleAngleRadian();xOffset=(pieSliceInfo.mRadius+dataLabelPadding)*Math.cos(middleAngleRadian);yOffset=(pieSliceInfo.mRadius+dataLabelPadding)*Math.sin(middleAngleRadian);middleAngleQuadrant=pieSlice.GetMiddleAngleQuadrant();if(middleAngleQuadrant===2||middleAngleQuadrant===3){isLeft=true;}yAdjust=textRect.height*0.5*Math.sin(middleAngleRadian);if(isLeft){dataLabel.MoveToCenter(pieSliceInfo.mCenter.x+xOffset-(textRect.width+1)/2,pieSliceInfo.mCenter.y+yOffset+yAdjust);}else{dataLabel.MoveToCenter(pieSliceInfo.mCenter.x+xOffset+(textRect.width+1)/2,pieSliceInfo.mCenter.y+yOffset+yAdjust);}return dataLabel;}function hCreateSlice(iSeriesIndex,iGroupId,iAngleIndex,iSliceId,iCenter,iStartAngle,iEndAngle,iIsOneSeries,iAngleCount){var pieTripleId={mObjectId:$GO.DssGraphPieSlice,mSeriesId:iSeriesIndex,mGroupId:iGroupId},chartCtx=this.mChartContextPtr,utility_id=chartCtx.getUtiliy().tripleId,pieOption=this.mPieOption,isGraphMatrix=chartCtx.mIsGraphMatrix,isRing,radius,onePieSliceObj,isValuePie=(this.mPlotType===$GMPPT.GMPPT_VALUE),pieLayout=pieOption.mLayout,dataLabel,dataLabelInfo;var angleCount=iAngleCount||this.mDatasetPtr.GetPieCountAtOneDataPoint(iSeriesId,iGroupId);if(iStartAngle>=iEndAngle){return null;}utility_id.reset(perfPieSliceId,pieTripleId.mObjectId,pieTripleId.mSeriesId,pieTripleId.mGroupId,iAngleIndex,iSliceId);if(chartCtx.checkColorByAndSizeByValue(perfPieSliceId,this.mDatasetPtr,this.mHasColorBy,false)===false){return null;}if(iEndAngle-iStartAngle===360){iIsOneSeries=true;}isRing=((pieLayout===kPieLayout_Ring)||(isValuePie&&iAngleIndex>0));if(isRing){if(pieLayout===kPieLayout_Ring){if(isValuePie&&iAngleIndex>0){pieOption.mRingFactor=(1-1/(iAngleIndex+1)*0.3)*100;}else{pieOption.mRingFactor=70;}}else{pieOption.mRingFactor=100/(iAngleIndex+1);}}radius=hGetPieRadius.call(this,iSeriesIndex,iGroupId,iAngleIndex);if(radius<=0){return null;}onePieSliceObj=new $C.PieSliceObject({TripleId:pieTripleId,AngleIndex:iAngleIndex,SliceId:iSliceId,GraphObjectManager:this.mpManager,Explode:0,StartAngle:iStartAngle,EndAngle:iEndAngle,RingPieFactor:pieOption.mRingFactor,IsRing:isRing,Is2DCircular:true,Scale:pieOption.mScale,Center:iCenter,Radius:radius,MaxRadius:pieOption.mMaxRadius,Depth:pieOption.mDepthInChart,OneSeries:iIsOneSeries,ParentObject:null,IsShown:true,Shape:$SHP._PIESLICE,hasFill:true});if(isGraphMatrix){var isDataLabelEnabled=this.mDatasetPtr.showPieDatalabels();if(isDataLabelEnabled&&!(isValuePie&&iAngleIndex<angleCount-1)){dataLabel=hRenderSliceDataLabel.call(this,pieTripleId,onePieSliceObj);if(dataLabel!==undefined&&dataLabel!==null){dataLabel.mIsShown=false;dataLabelInfo=new $C.GMDataLabelInfo({SeriesId:iSeriesIndex,GroupId:iGroupId,isValid:true,Label:dataLabel});dataLabelInfo.HostMarkerPoint=iCenter;dataLabelInfo.HostMarkerBound=new $C.Rect2D({x:iCenter.x-radius,y:iCenter.y-radius,height:2*radius,width:2*radius});this.dataLabels.push(dataLabelInfo);}}}return onePieSliceObj;}function hInitMaxPieRadius(){var angleCount,gmCtx=this.mChartContextPtr.GetGraphMatrixContext(),markerStyle=$GM_MarkerStyle._PIE;if(this.mPlotType===$GMPPT.GMPPT_CATEGORY){var isVertical=this.mChartContextPtr.IsVertical(),groupCount=this.mDatasetPtr.GetGroupCount();angleCount=this.mDatasetPtr.GetPieCountAtOneDataPoint(0,0);return gmCtx.GetMaxMarkerSize(markerStyle,isVertical,groupCount*angleCount);}else{if(this.mPlotType===$GMPPT.GMPPT_VALUE){return gmCtx.GetMaxMarkerSize(markerStyle,true,1,this.mHasSizeBy);}}return 0;}function hInitDataLabelManager(dataLabelManager){var plotPieCircles=this.mPieCircles,size=plotPieCircles.length,i,j,isAlreadyAppear=false,recordCenter=[],recordRadius=[],pieCircles=[],centerPoint,radius,boundRect,circle;for(i=0;i<size;++i){isAlreadyAppear=false;circle=plotPieCircles[i];for(j=0;j<recordCenter.length;++j){if(circle.mCenter.x===recordCenter[j].x&&circle.mCenter.y===recordCenter[j].y&&circle.mRadius===recordRadius[j]){isAlreadyAppear=true;break;}}if(!isAlreadyAppear){centerPoint=circle.mCenter;radius=circle.mRadius;recordRadius.push(radius);recordCenter.push(centerPoint);pieCircles.push(circle);}}dataLabelManager.CirclePieObjects=dataLabelManager.CirclePieObjects.concat(pieCircles);}mstrmojo.chart.PiePlotRenderer=mstrmojo.declare(mstrmojo.Base,null,{scriptClass:"mstrmojo.chart.PiePlotRenderer",mDatasetPtr:null,mChartContextPtr:null,mMaxSizeByTotal:0,mMinSizeByTotal:0,mHasColorBy:false,mHasSizeBy:false,mPlotType:$GMPPT.GMPPT_CATEGORY,mPieOption:{mLayout:kPieLayout_Pie,mRingFactor:70,mScale:1,mDepthInChart:0,mPieRotation:90},mpManager:null,dataLabels:[],shownDataLabels:[],mPieCircles:[],init:function init(props){this._super(props);this.mpManager=props.GraphObjectManager;this.mChartContextPtr=props.ChartContext;this.mDatasetPtr=props.Dataset;this.mPieOption={mLayout:kPieLayout_Pie,mRingFactor:70,mScale:1,mMaxRadius:10,mDepthInChart:0,mPieRotation:90};this.mPieOption.mLayout=props.Layout;this.mPlotType=props.PlotType;if(props.MaxRadius){this.mPieOption.mMaxRadius=props.MaxRadius;}else{this.mPieOption.mMaxRadius=hInitMaxPieRadius.call(this);}this.mHasColorBy=this.mChartContextPtr.GetGraphMatrixContext().mHasColorBy;this.mHasSizeBy=this.mChartContextPtr.GetGraphMatrixContext().mHasSizeBy;this.dataLabels=[];this.shownDataLabels=[];this.mPieCircles=[];if(props.shownDatalabels!==undefined&&props.shownDataLabels!==null){this.shownDataLabels=props.shownDataLabels;}hInit.call(this);},getShapeSizeAt:function getShapeSizeAt(seriesId,groupId,angleId,isGeneric){if(isGeneric===undefined){isGeneric=true;}if(isGeneric){return this.mPieOption.mMaxRadius;}return hGetPieRadius.call(this,seriesId,groupId,angleId);},drawSinglePie:function drawSinglePie(iSeriesId,iGroupId,iAngleIndex,iCenter,iAngleCount){var pieSlicesList=[],validSeriesNumber,validSeriesIndex,angles,radius,returnVal,oneSliceObject,sliceId,circle={},i;if(iCenter.x<0||iCenter.y<0){return pieSlicesList;}radius=hGetPieRadius.call(this,iSeriesId,iGroupId,iAngleIndex,iAngleCount);circle.mCenter=iCenter;circle.mRadius=radius;returnVal=hGetAngleInfoForSinglePie.call(this,iSeriesId,iGroupId,iAngleIndex);if(!returnVal.IsValid){return pieSlicesList;}validSeriesIndex=returnVal.ValidSeriesIndex;validSeriesNumber=returnVal.ValidSeriesNumber;angles=returnVal.Angles;var angleCount=iAngleCount||this.mDatasetPtr.GetPieCountAtOneDataPoint(iSeriesId,iGroupId),isValuePie=(this.mPlotType===$GMPPT.GMPPT_VALUE),isRing=((this.mPieOption.mLayout===kPieLayout_Ring)||(isValuePie&&iAngleIndex>0));if(validSeriesNumber===0){$VISUTIL.visPrint("pieplotRenderer::Should not reach here");}else{if(validSeriesNumber===1){oneSliceObject=hCreateSlice.call(this,iSeriesId,iGroupId,iAngleIndex,validSeriesIndex[0],iCenter,360-this.mPieOption.mPieRotation,720-this.mPieOption.mPieRotation,true,angleCount);if(oneSliceObject){oneSliceObject.SetWhitenOuterBorder(isValuePie&&iAngleIndex<angleCount-1&&!isRing);pieSlicesList.push(oneSliceObject);}this.mPieCircles.push(circle);}else{for(i=0;i<validSeriesNumber;++i){sliceId=validSeriesIndex[i];oneSliceObject=hCreateSlice.call(this,iSeriesId,iGroupId,iAngleIndex,sliceId,iCenter,angles[sliceId],angles[sliceId+1],false,angleCount);if(oneSliceObject){oneSliceObject.SetWhitenOuterBorder(isValuePie&&iAngleIndex<angleCount-1&&!isRing);pieSlicesList.push(oneSliceObject);}}this.mPieCircles.push(circle);}}return pieSlicesList;},SetInfo:function SetInfo(iLayout,iPlotType,iMaxRadius){this.mPieOption.mLayout=iLayout;this.mPieOption.mMaxRadius=iMaxRadius;this.mPlotType=iPlotType;},enableDataLabel:function enableDataLabel(dataLabelManager,shownDataLabels){var chartCtx=this.mChartContextPtr,isGM=chartCtx.mIsGraphMatrix,gmCtx=chartCtx.GetGraphMatrixContext();if(isGM){hInitDataLabelManager.call(this,dataLabelManager);dataLabelManager.PlaceDataLabels(this.dataLabels,shownDataLabels);}},GetPieRadius:function GetPieRadius(iSeriesId,iGroupId,iAngleIndex){return hGetPieRadius.call(this,iSeriesId,iGroupId,iAngleIndex);}});}());