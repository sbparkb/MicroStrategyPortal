window.DensityOverlayScript=true;function newEventPassthru(obj,event){return function(){window.google.maps.event.trigger(obj,event);};}(function(){mstrmojo.requiresCls("mstrmojo.hash");var EnumMarkerType={MARKER:"1",BUBBLE:"2",POLYGON:"3",DENSITY:"4"};var _H=mstrmojo.hash;mstrmojo.gmaps.DensityOverlay=mstrmojo.declare(google.maps.OverlayView,[mstrmojo._Provider,mstrmojo._CanDrawHeatMap],{scriptClass:"mstrmojo.gmaps.DensityOverlay",isDragging:false,mapViewer:null,overlayProjection:null,init:function init(props){_H.copy(props,this);if(props.map){this.setMap(props.map);this._map=props.map;}},onAdd:function onAdd(){var i;this.div_=document.createElement("DIV");this.div_.style.border="none";this.div_.style.borderWidth="0px";this.div_.style.position="absolute";if(this.clickable){var eventPassthrus=["click","dblclick","mousedown","mouseup","mouseover","mouseout"];for(i=0;i<eventPassthrus.length;i++){var name=eventPassthrus[i];google.maps.event.addDomListener(this.div_,name,newEventPassthru(this,name));}this.div_.style.cursor="pointer";}var panes=this.getPanes();panes.overlayImage.appendChild(this.div_);this.overlayProjection=this.getProjection();var that=this;google.maps.event.addListener(this._map,"dragstart",function(event){that.handleDragStart(event);});google.maps.event.addListener(this._map,"dragend",function(event){that.handleDragEnd(event);});google.maps.event.addListener(this._map,"click",function(event){that.handleMouseClick(event);});google.maps.event.addListener(this._map,"mousemove",function(event){that.handleMouseMove(event);});google.maps.event.addListener(this._map,"bounds_changed",function(event){that.drawDensity();});this.drawDensity();},handleDragStart:function handleDragStart(event){this.isDragging=true;},handleDragEnd:function handleDragEnd(event){this.isDragging=false;this.drawDensity();},onRemove:function onRemove(){if(this.div_){google.maps.event.clearInstanceListeners(this.div_);this.div_.parentNode.removeChild(this.div_);this.div_=null;}},draw:function draw(){},searchRect:function searchRect(bounds){var overlayProjection=this.getProjection();var ne=bounds.getNorthEast();var pixNe=overlayProjection.fromLatLngToDivPixel(ne);var sw=bounds.getSouthWest();var pixSw=overlayProjection.fromLatLngToDivPixel(sw);var ret=[];var minX=Math.ceil(Math.min(pixNe.x,pixSw.x));var maxX=Math.ceil(Math.max(pixNe.x,pixSw.x));var minY=Math.ceil(Math.min(pixNe.y,pixSw.y));var maxY=Math.ceil(Math.max(pixNe.y,pixSw.y));for(var i=minX;i<=maxX;i++){for(var j=minY;j<=maxY;j++){ret=ret.concat(this.getAttrsFromLocationMap(i,j));}}return ret;},cluster:null,handleMouseClick:function handleMouseClick(event){var latlng=event.latLng;var overlayProjection=this.getProjection();if(!overlayProjection){return ;}var pixLL=overlayProjection.fromLatLngToDivPixel(latlng);this.cluster=this.getAttrsFromLocationMapRange(Math.ceil(pixLL.x),Math.ceil(pixLL.y),5);if(this.cluster.length>0){if(this.mapViewer.parent.enableClickSelect&&this.mapViewer.wpMarkerType==EnumMarkerType.DENSITY){this.mapViewer.handleDensitySelections(this.cluster);}}},handleMouseMove:function handleMouseMove(event){var latlng=event.latLng;var overlayProjection=this.getProjection();if(!overlayProjection){return ;}var pixLL=overlayProjection.fromLatLngToDivPixel(latlng);this.cluster=this.getAttrsFromLocationMapRange(Math.ceil(pixLL.x),Math.ceil(pixLL.y),5);if(this.cluster.length>0){var pixel=this.cluster[0];if(this.mapViewer.parent.enablePopup){this.mapViewer.showTooltip(pixel,latlng);}}else{this.mapViewer.hideTooltip();}},getLastCluster:function getLastCluster(){return this.cluster;},set:function set(n,v){this._super(n,v);try{if(typeof (google.maps.OverlayView.prototype.set)=="function"){google.maps.OverlayView.prototype.set.apply(this,[n,v]);}}catch(e){}},getBounds:function getBounds(){return this._map.getBounds();},getTopLeft:function getTopLeft(){if(!this._map||!this.overlayProjection){return new google.maps.Point(0,0);}var bounds=this._map.getBounds();var ne=bounds.getNorthEast();var north=ne.lat();var sw=bounds.getSouthWest();var west=sw.lng();var nw=new google.maps.LatLng(north,west);var topLeftPoint=this.overlayProjection.fromLatLngToDivPixel(nw);var east=ne.lng();if(east==180&&west==-180){topLeftPoint.x=topLeftPoint.x-this.width;}return topLeftPoint;},getScreenPointForLocation:function getScreenPointForLocation(location){if(!this.overlayProjection||!location){return null;}return this.overlayProjection.fromLatLngToDivPixel(location);},hasMapBoundsChanged:function hasMapBoundsChanged(){if(this.isDragging){return false;}var newBounds=this._map.getBounds();if(this.bounds&&this.bounds.equals(newBounds)){return false;}return true;},zeroX:function zeroX(x,origin){if(origin){x=x-origin.x;}return x;},zeroY:function zeroY(y,origin){if(origin){y=y-origin.y;}return y;},getDrawingLayerWidth:function getDrawingLayerWidth(){var bounds=this._map.getBounds();if(!!bounds){var ne=bounds.getNorthEast();var east=ne.lng();var sw=bounds.getSouthWest();var west=sw.lng();if(east==180&&west==-180){return this.width*2;}}return this.width;}});}());