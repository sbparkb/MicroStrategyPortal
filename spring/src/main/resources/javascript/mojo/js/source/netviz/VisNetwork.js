(function(){if(!window.env){window.env={};}var env=window.env;env.isDebugging=false;var isDebugging=env.isDebugging;function log(msg){if(isDebugging){$U.visPrint(msg);}}mstrmojo.requiresCls("mstrmojo.css","mstrmojo.array","mstrmojo.num","mstrmojo.hash","mstrmojo.color","mstrmojo.dom","mstrmojo.Base","mstrmojo.Container","mstrmojo.Label","mstrmojo.VisBase","mstrmojo.ui.Pulldown","mstrmojo.VisMenuList","mstrmojo._VizSelectionHelper","mstrmojo._LoadsScript","mstrmojo.VisUtility","mstrmojo.VisEnum","mstrmojo.chart.enums.EnumFontStyle","mstrmojo.vi._MonitorsAppState","mstrmojo.chart.common.Utility","mstrmojo.vi.ui._IsDropTarget","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.util.color");mstrmojo.requiresClsP("mstrmojo.ui.menus","MenuConfig","_HasMenuPopup","EditorConfig");mstrmojo.requiresClsP("mstrmojo.gm","GMLegend","GMUtility","EnumLegendSlot","_SupportDndAsBlackBox");mstrmojo.requiresClsP("mstrmojo.netviz","_SupportNetworkBrushesAndHighlights","VisNetworkStage","ObservableModel","PropertyParser","_ForceDirectedLayout","_CircularLayout","_LinearLayout");mstrmojo.requiresClsP("mstrmojo.vi.ui.rw","_HasVisSelections","selectors._IsMultiUnitControl","selectors._BrushesAndHighlights","_XtabDE");var LegendPropDefault={lgdBgFillClr:[15461355,1710618],lgdBgFillStyle:[0,0],lgdBgFillEff:[1,1],lgdBgFillTrans:[0,100],lgdFntSz:["8pt","8pt"],lgdFntFml:["Arial","Arial"],lgdFntStyle:[0,0],lgdFntClr:[6710886,16777215],lgdBdrShw:[false,false],lgdBdrClr:[11579568,5855577],lgdBdrThk:["1px","1px"],lgdBdrLnStyle:[0,0],lm:[0,0],lwr:[undefined,undefined]};function sliceDefaultsLegendProp(idx){var rtn={};mstrmojo.hash.keyarray(LegendPropDefault).forEach(function(prop){rtn[prop]=LegendPropDefault[prop][idx];});return rtn;}var $MOJO=mstrmojo,$D=$MOJO.dom,$U=$MOJO.VisUtility,formater=$MOJO.num,$ARR=$MOJO.array,$HASH=$MOJO.hash,OM=$MOJO.netviz.ObservableModel,$CLRUTIL=$MOJO.util.color,$GM=$MOJO.gm,$LEGEND=$GM.GMLegend,LEGEND_PADDING=5,PRP_LEGEND_SLOT=$GM.EnumLegendSlot,LEGEND_DATA_TYPE=$MOJO.VisEnum.GMLegendDataType,ENUM_FONT_SYLTE=$MOJO.chart.enums.EnumFontStyle,LEGEND_FORMATTING_TYPE=mstrmojo.VisEnum.GMLegendFormatingPropertyTag,$VIS_ENUM=$MOJO.VisEnum,LEGEND_PROPERTY=$VIS_ENUM.LegendPropertyTag,ENUM_LEGEND_MODE=$VIS_ENUM.EnumLegendMode,$GMU=$GM.GMUtility,AGG_MTDS=$VIS_ENUM.NETWORK_AGGREGATION_METHOD,PROPERTIES_TYPES=$VIS_ENUM.NETWORK_PROPERTIES,LAYOUT_NAMES=$VIS_ENUM.NETWORK_LAYOUT,$DROP_ZONES=mstrmojo.vi.viz.EnumDSSDropZones,OBJECT_TYPE=mstrmojo.chart.model.enums.EnumDSSObjectType,NETWORK_MAX_NODE_SIZE_TYPE=$VIS_ENUM.NETWORK_MAX_NODE_SIZE_TYPE,NETWORK_MIN_NODE_SIZE_TYPE=$VIS_ENUM.NETWORK_MIN_NODE_SIZE_TYPE;var SWITCH_BUTTON_RIGHT=24,SWITCH_BUTTO_TOP=24,SWITCH_BUTTO_WIDTH=76,SWITCH_BUTTO_HEIGHT=28;var LEGEND_DOCK_POS=[{pos:PRP_LEGEND_SLOT.LEFT_TOP},{pos:PRP_LEGEND_SLOT.LEFT_MIDDLE},{pos:PRP_LEGEND_SLOT.LEFT_BOTTOM},{pos:PRP_LEGEND_SLOT.RIGHT_TOP},{pos:PRP_LEGEND_SLOT.RIGHT_MIDDLE},{pos:PRP_LEGEND_SLOT.RIGHT_BOTTOM}];var EDGE_TRANSPARENCY=0.5;var ERROR_TYPE=$VIS_ENUM.SERVER_JSON_ERROR_TYPE;var LAYOUT_MODE_IDX_TO_STR=[LAYOUT_NAMES.CIRCULAR,LAYOUT_NAMES.LINEAR,LAYOUT_NAMES.FORCE_DIRECTED];var ITEM_MAX_SIZE_BASE=50;var FULL_RANGE_ITEM_MIN_SIZE=4;var ADJUSTED_RANGE_ITEM_MIN_SIZE_RATIO=0.2;var ITEM_MAX_SIZE_DEFAULT_RATIO={};ITEM_MAX_SIZE_DEFAULT_RATIO[NETWORK_MAX_NODE_SIZE_TYPE.AUTOMATIC]={"size-by":0.9,"no-size-by":0.08};ITEM_MAX_SIZE_DEFAULT_RATIO[NETWORK_MAX_NODE_SIZE_TYPE.MANUAL]={"size-by":0.5,"no-size-by":0.16};var NETVIZ_ATTACHED_EVENTS=["click","contextmenu","mouseup"];function updateDropZoneInDrill(drillUnit,params){function getZoneId(tid){var dz=me.getDropZone();var zones={from:$DROP_ZONES.FromItem,to:$DROP_ZONES.ToItem};var id;Object.keys(zones).some(function(key){var path=key+".TemplateUnit.0.id";if($U.getPropertyByPath(dz,path)===tid){id=zones[key];return true;}return false;});return id;}var me=this,updateTemplateActions={act:"updateTemplate",keyContext:me.k,actions:[]},tplActArr=updateTemplateActions.actions,unitItem=[$U.pick(drillUnit,["did","t"])];var fromUnitId=params.drillFromUnit.id;var zoneId=getZoneId(fromUnitId);if(zoneId===undefined){return updateTemplateActions;}var argumentZone={id:zoneId},dzModel=me.zonesModel,zone=dzModel.getZoneModelByZoneId(zoneId),zoneItems=zone.items||[],fromUnitItem;var zoneIdx=$U.findInArray(zoneItems,function(z){return z.did===fromUnitId;});if(zoneIdx!==-1){fromUnitItem=zoneItems[zoneIdx];}if(fromUnitItem){tplActArr.push(dzModel.getRemoveDropZoneUnitAction(argumentZone,fromUnitItem));Array.prototype.push.apply(tplActArr,dzModel.getAddDropZoneUnitsActions(argumentZone,unitItem,fromUnitItem.idx));}return updateTemplateActions;}function selectLayoutMode(){var layoutModeIndex=this.propInfo.layoutMode,layoutMode=LAYOUT_MODE_IDX_TO_STR[layoutModeIndex];if(layoutMode===LAYOUT_NAMES.LINEAR){this.inputLinearIcon.checked=true;}else{if(layoutMode===LAYOUT_NAMES.CIRCULAR){this.inputCircularIcon.checked=true;}else{if(layoutMode===LAYOUT_NAMES.FORCE_DIRECTED){this.inputForceDirectedIcon.checked=true;}}}}function getLegendDockPosIdx(pos){var i,n=LEGEND_DOCK_POS.length;for(i=0;i<n;i++){if(pos===LEGEND_DOCK_POS[i].pos){return i;}}return -1;}function valueToRGBA(v,alpha){if(isNaN(v)){return"rgba(0,0,0,1)";}v=parseInt(v,10);if(isNaN(alpha)){alpha=1;}return $CLRUTIL.getCSSColorString(v,alpha);}function getSum(values){var sum=0;$ARR.forEach(values,function(value){var v=parseFloat(value);if(!isNaN(v)){sum+=v;}});return sum;}var AGGREGATION_TYPE={COUNT:"Count of",SUM:"Sum of",AVERAGE:"Average of",MIN:"Min of",MAX:"Max of"};var aggregationMethods={};aggregationMethods[AGGREGATION_TYPE.COUNT]=function(values){return values.length;};aggregationMethods[AGGREGATION_TYPE.SUM]=getSum;aggregationMethods[AGGREGATION_TYPE.AVERAGE]=function(values){var len=values.length;return(len>0?getSum(values)/len:NaN);};aggregationMethods[AGGREGATION_TYPE.MIN]=function(values){var len=values.length,min,i,v;if(len<1){return NaN;}min=values[0];for(i=1;i<len;i++){v=values[i];if(min>v){min=v;}}return min;};aggregationMethods[AGGREGATION_TYPE.MAX]=function(values){var len=values.length,max,i,v;if(len<1){return NaN;}max=values[0];for(i=1;i<len;i++){v=values[i];if(max<v){max=v;}}return max;};function linearInterpolation(value){if(!this.range||!this.sizeRange){log("No value range or size range available, cannot calculate size.");return 0;}var range=this.range,sizeRange=this.sizeRange,valueMax=Math.max(range.max,range.min*sizeRange.max/sizeRange.min);var rangeLength=valueMax-range.min||Infinity;var ret=(value-range.min)/rangeLength*(sizeRange.max-sizeRange.min)+sizeRange.min;if(isNaN(ret)){log("something wrong in linear interpolation");ret=0;}return ret;}function destroyStage(){var stage=this.stage;if(stage){if(stage.parent!==undefined){this.removeChildren(stage);}stage.destroy();delete this.stage;}}var sNodeID=0;var Node=mstrmojo.declare(mstrmojo.Base,null,{scriptClass:"mstrmojo.netviz.VisNetwork.Node",init:function(props){this.adjacence=[];this.edges=[];this.properties={};this.range={};this.attribute={};this.attributeElements=[];this.aggregationName=0;this.aggregationMethod=null;this.itemSizeMetricName=null;this.size=0;this.style=null;this._super(props);this.id="x"+(++sNodeID);},getAttributeName:function(){return this.hasSelfLoop?"Name":this.attribute&&this.attribute.name;},getName:function getName(){var ret="";$ARR.forEach(this.attributeElements||[],function(el){ret+=(el.name+" ");});return ret.slice(0,ret.length-1);},getFormNames:function(){var rv=[];$ARR.forEach(this.attribute.forms,function(f){rv.push(f.name);});return rv;},getFormValues:function(){var rv=[];$ARR.forEach(this.attributeElements,function(el){rv.push(el.name);});return rv;},setAggregationMethod:function(){var defaultAggMethod=AGGREGATION_TYPE.SUM;this.aggregationMethodName=(this.properties&&this.properties.nodeSizeAggregation)||defaultAggMethod;if(!AGG_MTDS.hasOwnProperty(this.aggregationMethodName)){this.aggregationMethodName=defaultAggMethod;}this.aggregationMethod=aggregationMethods[this.aggregationMethodName];},getAggregatedValue:function(){if(!this.aggregationMethod){this.setAggregationMethod();}var edges=this.edges,values=[],i,len;this.aggregationName=this.aggregationMethodName+" "+(this.itemSizeMetricName||"");if(this.itemSizeMetricName!==null){for(i=0,len=edges.length;i<len;i++){var edge=edges[i];if(edge&&edge.itemSizeValue&&!edge.isExcluded&&!isNaN(edge.itemSizeValue)){values.push(edge.itemSizeValue);}}return this.aggregationMethod(values);}return 0;},getSize:function(){if(isNaN(this.aggregatedValue)){this.aggregatedValue=this.getAggregatedValue();}return this.valueToSize(this.aggregatedValue);},valueToSize:function(value){var sizeRange=this.getNodeSizeRange();var valueRange=this.range;var sMin=sizeRange.min,sMax=sizeRange.max,vMin=valueRange.min,vMax=valueRange.max,useArea=sizeRange.area;var size,ratio;if(vMin===vMax){size=sMax;}else{ratio=(value-vMin)/(vMax-vMin);if(useArea){ratio=Math.sqrt(ratio);}size=sMin+(sMax-sMin)*ratio;}return size;},getNodeSizeRange:function(){var propInfo=this.properties;var valueRange=this.range;var maxOption=propInfo.maxNodeSize;var minOption=propInfo.minNodeSize;var vMax=valueRange.max,vMin=valueRange.min,areaProportional=false,max=ITEM_MAX_SIZE_BASE,min=FULL_RANGE_ITEM_MIN_SIZE;var maxSize,minSize;if(this.isMetricSizeBy){switch(minOption.type){case NETWORK_MIN_NODE_SIZE_TYPE.PROPORTIONAL:maxSize=maxOption.ratio*max;if(vMax===0){minSize=min;}else{minSize=maxSize*Math.sqrt(vMin/vMax);}areaProportional=true;break;case NETWORK_MIN_NODE_SIZE_TYPE.FULL_RANGE:maxSize=maxOption.ratio*max;minSize=min;break;case NETWORK_MIN_NODE_SIZE_TYPE.ADJUSTED_RANGE:maxSize=maxOption.ratio*max;minSize=maxSize*minOption.ratio;break;default:maxSize=maxOption.ratio*max;minSize=min;break;}}else{maxSize=max*maxOption.ratio;minSize=maxSize;}if(maxSize<min){maxSize=min;}if(maxSize>max){maxSize=max;}if(minSize<min){minSize=min;}return{min:minSize,max:maxSize,area:areaProportional};},updateValues:function(){var value=this.getAggregatedValue();if(!isNaN(value)){if(this.itemSizeMetricName!==undefined&&this.itemSizeMetricName!==null&&this.properties.minNodeSize.type===NETWORK_MIN_NODE_SIZE_TYPE.PROPORTIONAL){if(value<0&&Math.abs(value)<this.range.min){this.range.minNegtive=true;}if(value<0&&Math.abs(value)>this.range.max){this.range.maxNegtive=true;}value=Math.abs(value);}this.aggregatedValue=value;this.range.min=Math.min(this.range.min,value);this.range.max=Math.max(this.range.max,value);}},updateStyles:function(){this.size=this.getSize();},update:function(){this.updateValues();this.updateStyles();},exclude:function(){this.isExcluded=true;this.sprite.isExcluded=true;var edges=this.edges,el=edges.length,nodes=this.adjacence,nl=nodes.length,i;for(i=0;i<el;i++){var e=edges[i];e.isExcluded=true;e.sprite.isExcluded=true;}for(i=0;i<nl;i++){var n=nodes[i],lc=0,ne=n.edges,nel=ne.length,j;for(j=0;j<nel;j++){if(!ne[j].isExcluded){lc++;}}if(lc===0){n.isExcluded=true;n.sprite.isExcluded=true;}n.update();}},format:function(value){if(this.edges&&this.edges.length){var edge=this.edges[0];var mask;if(this.aggregationMethodName===AGGREGATION_TYPE.COUNT){mask=null;}else{if(edge&&edge.values[edge.indexes.nodeSizeMIndex]){mask=edge.values[edge.indexes.nodeSizeMIndex].formatString;}else{mask=null;}}return formater.formatByMask(mask,value);}return value.toString();},getActionInfo:function(){var info=[],node=this;$ARR.forEach(node.attributeElements,function(el){info.push({n:node.attribute.name,tid:node.attribute.id,v:el.name,eid:el.id});});return info;}});var EDGE_COLORS=[13376797,16734244,16749895,16762209,6672939];EDGE_COLORS.MISSING=5066061;EDGE_COLORS.FIRST_PALETTE_COLOR=2062260;var Edge=mstrmojo.declare(mstrmojo.Base,[],{scriptClass:"mstrmojo.netviz.VisNetwork.Edge",sizeRange:{min:1,max:16},valueToWidth:linearInterpolation,init:function(e){this.from=null;this.to=null;this.values=[];this.indexes={};this.properties={};this.range={};this.colorValueRange={};this.sizeValue=0;this.colorValue=0;this.itemSizeValue=0;this.width=0;this.color=0;if(this._super){this._super(e);}},update:function(){this.updateValues();this.updateStyles();},updateValues:function(){if(!this.values){return ;}var colorData=this.values[this.indexes.edgeColorMIndex],sizeData=this.values[this.indexes.edgeSizeMIndex],itemSizeData=this.values[this.indexes.nodeSizeMIndex];this.colorValue=colorData?parseFloat(colorData.value):"missing";this.sizeValue=sizeData?parseFloat(sizeData.value):"missing";this.itemSizeValue=itemSizeData?parseFloat(itemSizeData.value):"missing";if(!isNaN(this.sizeValue)){this.range.min=Math.min(this.sizeValue,this.range.min);this.range.max=Math.max(this.sizeValue,this.range.max);}if(!isNaN(this.colorValue)){this.colorValueRange.min=Math.min(this.colorValue,this.colorValueRange.min);this.colorValueRange.max=Math.max(this.colorValue,this.colorValueRange.max);}},updateStyles:function(){this.width=this.valueToWidth(this.sizeValue);},format:function(value,index){var mask=(this.values[index]&&this.values[index].formatString)||null;return formater.formatByMask(mask,value);}});function parseProperties(widget,vp){var PropertyParser=mstrmojo.netviz.PropertyParser,BooleanProperty=PropertyParser.BooleanProperty,IntegerProperty=PropertyParser.IntegerProperty,FloatProperty=PropertyParser.FloatProperty,StringProperty=PropertyParser.StringProperty,JsonProperty=PropertyParser.JsonProperty;var schema={showLegend:{key:PROPERTIES_TYPES.showLegend,type:BooleanProperty.preset(true)},showEdgeDirection:{key:PROPERTIES_TYPES.showEdgeDirection,type:BooleanProperty.preset(false)},showTransition:{key:PROPERTIES_TYPES.showTransition,type:BooleanProperty.preset(false)},nodeSizeAggregation:{key:PROPERTIES_TYPES.nodeSizeAggregation,type:StringProperty.preset(AGGREGATION_TYPE.SUM)},minNodeSize:{key:PROPERTIES_TYPES.minNodeSize,type:JsonProperty.preset({type:NETWORK_MIN_NODE_SIZE_TYPE.PROPORTIONAL}),postSet:function(value,prop,raw,key){if(value.type!==NETWORK_MIN_NODE_SIZE_TYPE.ADJUSTED_RANGE){value.ratio=FULL_RANGE_ITEM_MIN_SIZE/ITEM_MAX_SIZE_BASE;}else{if(value.ratio===undefined){value.ratio=ADJUSTED_RANGE_ITEM_MIN_SIZE_RATIO;}}return value;}},maxNodeSize:{key:PROPERTIES_TYPES.maxNodeSize,type:JsonProperty.preset({type:NETWORK_MAX_NODE_SIZE_TYPE.AUTOMATIC}),postSet:function(value,prop,raw,key){var vk=widget.hasSizeByMetric()?"size-by":"no-size-by";if(value.type===NETWORK_MAX_NODE_SIZE_TYPE.AUTOMATIC||value.type===NETWORK_MAX_NODE_SIZE_TYPE.MANUAL&&value.ratio===undefined){value.ratio=ITEM_MAX_SIZE_DEFAULT_RATIO[value.type][vk];}return value;}},themeType:{key:PROPERTIES_TYPES.themeType,type:StringProperty.preset("light"),preSet:function(value,prop,raw,key){return(parseInt(value,10)===0)?"dark":"light";}},background:{key:PROPERTIES_TYPES.background,type:JsonProperty.preset({})},circleStyle:{key:PROPERTIES_TYPES.bubbleStyle,type:JsonProperty.preset({}),postSet:function(value,prop,raw,key){var oldVal=raw.shownodelabel;if(value.showNodeLabel===undefined){value.showNodeLabel=!!(oldVal!==undefined&&oldVal.toString()==="true");}return value;}},circleLabelStyle:{key:PROPERTIES_TYPES.circleLabelFont,type:JsonProperty.preset({})},layoutMode:{key:PROPERTIES_TYPES.layoutMode,type:IntegerProperty.preset(0)},dragMode:{key:PROPERTIES_TYPES.dragMode,type:IntegerProperty.preset($VIS_ENUM.NETWORK_DRAG_MODE.pan)},lgdBgFillClr:{key:LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR,type:JsonProperty.preset(undefined)},lgdBgFillStyle:{key:LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_STYLE,type:StringProperty.preset(undefined)},lgdBgFillEff:{key:LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_EFFECT,type:StringProperty.preset(undefined)},lgdBgFillTrans:{key:LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY,type:StringProperty.preset(undefined)},lgdFntSz:{key:LEGEND_FORMATTING_TYPE.LEGEND_FONT_SIZE,type:StringProperty.preset(undefined)},lgdFntFml:{key:LEGEND_FORMATTING_TYPE.LEGEND_FONT_FAMILY,type:StringProperty.preset(undefined)},lgdFntStyle:{key:LEGEND_FORMATTING_TYPE.LEGEND_FONT_STYLE,type:IntegerProperty.preset(undefined)},lgdFntClr:{key:LEGEND_FORMATTING_TYPE.LEGEND_FONT_COLOR,type:IntegerProperty.preset(undefined)},lgdBdrShw:{key:LEGEND_FORMATTING_TYPE.LEGEND_BORDER_SHOW,type:BooleanProperty.preset(undefined)},lgdBdrClr:{key:LEGEND_FORMATTING_TYPE.LEGEND_BORDER_COLOR,type:StringProperty.preset(undefined)},lgdBdrStyle:{key:LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE,type:StringProperty.preset(undefined)},lm:{key:LEGEND_PROPERTY.LEGEND_MODE,type:IntegerProperty.preset(undefined)},LegendPosition:{key:LEGEND_PROPERTY.LEGEND_POSITION,type:IntegerProperty.preset(2)},lwr:{key:LEGEND_PROPERTY.SCALE_LEGEND_WIDTH,type:FloatProperty.preset(undefined)}};return new PropertyParser().parse(vp,schema);}function parseDropZone(dz){function getUnit(name){var zone=dz[name],items=zone&&(zone.TemplateUnit||zone.TemplateMetric);return(items&&items[0])||{};}return{edgeColor:getUnit("ColorBy"),edgeSize:getUnit("SizeBy"),itemSize:getUnit("itemsz"),from:getUnit("from"),to:getUnit("to")};}var GROUP_SUPPORTING_TAGS=["at","dei","dpt","o","tui","ui"];function convertDataToModel(modelData,properties,dropZone){properties=properties||{};properties.nodeValueRange=properties.nodeValueRange||{min:Infinity,max:-Infinity};properties.edgeValueRange=properties.edgeValueRange||{min:Infinity,max:-Infinity};properties.edgeColorValueRange=properties.edgeColorValueRange||{min:Infinity,max:-Infinity};properties.circleStyle.fromNode.shape=properties.circleStyle.fromNode.shape||"Circle";properties.circleStyle.toNode.shape=properties.circleStyle.toNode.shape||"Circle";var nodes=[],edges=[],attributes=[],metrics=[],nodesIdHash={};var edgeColorId=dropZone.edgeColor.id,edgeSizeId=dropZone.edgeSize.id,nodeSizeId=dropZone.itemSize.id,fromId=dropZone.from.id,toId=dropZone.to.id;var model={nodes:nodes,edges:edges,nodesIdHash:nodesIdHash,attributes:attributes,metrics:metrics,indexes:{edgeColorMIndex:-1,edgeSizeMIndex:-1,nodeSizeMIndex:-1,fromIndex:-1,toIndex:-1},modifiedNodes:[],formNameDisplayType:modelData.lnm};var xtabModel=this.model;function generateNode(attribute,attributeElements,fromId){return new Node({attribute:attribute,attributeElements:attributeElements,adjacence:[],edges:[],properties:properties,range:properties.nodeValueRange,isMetricSizeBy:nodeSizeId!==undefined,attSrc:attribute.id===fromId?"from":"to",shape:attribute.id===fromId?properties.circleStyle.fromNode.shape:properties.circleStyle.toNode.shape});}function generateEdge(from,to,indexes){return new Edge({from:from,to:to,values:[],indexes:indexes,properties:properties,range:properties.edgeValueRange,colorValueRange:properties.edgeColorValueRange});}var rowHeader=modelData.gts.row;var colHeader=modelData.gts.col;var rowItems=modelData.ghs.rhs.items;var metricValues=modelData.gvs.items||[];var idToIndex={};var allSupportsViewFilter=true,vfSupported;$ARR.forEach(rowHeader,function(attribute,i){var es=[],fs=[],att;$ARR.forEach(attribute.es,function(e){es.push({id:e.id,name:e.n});});$ARR.forEach(attribute.fs,function(f){fs.push({name:f.n});});vfSupported=xtabModel.supportsViewFilterActions(attribute.id);allSupportsViewFilter=allSupportsViewFilter&&vfSupported;att={id:attribute.id,name:attribute.n,elements:es,supportsViewFilter:vfSupported,forms:fs,formsLength:(attribute.fs&&attribute.fs.length)||1};if(attribute.sc!==undefined){att.sc=attribute.sc;}attributes.push(att);idToIndex[attribute.id]=i;});model.allSupportsViewFilter=allSupportsViewFilter;var mx=(modelData.gsi&&modelData.gsi.mx)||[];try{$ARR.forEach(mx,function(m,i){metrics.push({id:m.did,name:m.n,formatString:$U.getNumberFormat(modelData,i)||""});idToIndex[m.did]=i;});}catch(ex){mstrmojo.err(ex);}var indexes=model.indexes;indexes.edgeColorMIndex=idToIndex[edgeColorId];indexes.edgeSizeMIndex=idToIndex[edgeSizeId];indexes.nodeSizeMIndex=idToIndex[nodeSizeId];indexes.fromIndex=idToIndex[fromId];indexes.toIndex=idToIndex[toId];var edgeColors=[];if(indexes.edgeColorMIndex!==undefined){var thresholds=modelData.gsi&&modelData.gsi.thresholds[metrics[indexes.edgeColorMIndex].id],ii;if(thresholds!==undefined&&thresholds.length>0){for(ii=0;ii<thresholds.length;ii++){if(thresholds[ii].fmt&&thresholds[ii].fmt.bc){edgeColors[ii]=mstrmojo.VisUtility.parseCSSColor(thresholds[ii].fmt.bc);}else{edgeColors[ii]=EDGE_COLORS.FIRST_PALETTE_COLOR;}}}}var colorMetricValueRange={max:-Infinity,min:Infinity};if($U.isOnExpressMode()){var ci=indexes.edgeColorMIndex;$ARR.forEach(metricValues,function(row){var v=row&&row.items&&row.items[ci];if(v){colorMetricValueRange.max=Math.max(colorMetricValueRange.max,v.rv);colorMetricValueRange.min=Math.min(colorMetricValueRange.min,v.rv);}});}var nodesMap={},edgeMap={};var nRows=(rowItems&&rowItems.length)||0,i,j,k,row,rowLength,rowNodes,ai,fl,attribute,attrEs,es,key,attrEl,existingNode,cell,m,tag,tagsCnt=GROUP_SUPPORTING_TAGS.length,fsSeen,newNode,len;for(i=0;i<nRows;++i){row=rowItems[i].items;rowLength=row.length;rowNodes=[];ai=0;fl=1;len=1;if(modelData.gts.row[0].cs){len=modelData.gts.row[0].cs;}if(attributes[0].formsLength>1){len=attributes[0].formsLength;}for(j=0;j<rowLength;j+=len,ai++){if(ai!==indexes.fromIndex&&ai!==indexes.toIndex){rowNodes.push(null);continue;}attribute=attributes[ai];attrEs=attribute.elements;es=[];key="";fl=attribute.formsLength;fsSeen=[];for(k=j;k<j+fl;k++){cell=row[k];attrEl=attrEs[cell.idx];if(fsSeen.indexOf(attrEl)===-1){for(m=0;m!==tagsCnt;m+=1){tag=GROUP_SUPPORTING_TAGS[m];attrEl[tag]=cell[tag];}key+=attrEl.name;fsSeen.push(attrEl);es.push(attrEl);}}if(!nodesMap[key]){newNode=generateNode(attribute,es,fromId,toId);nodesMap[key]=nodesIdHash[newNode.id]=newNode;nodes.push(newNode);}else{existingNode=nodesMap[key];if(existingNode.attSrc==="to"&&j===0){existingNode.attSrc="from";existingNode.shape=properties.circleStyle.fromNode.shape;}if(existingNode.attribute!==attribute){existingNode.hasSelfLoop=true;existingNode.secondaryAttribute=attribute;existingNode.secondaryAttributeElements=es;}}rowNodes.push(nodesMap[key]);}var nodeFrom=rowNodes[indexes.fromIndex],nodeTo=rowNodes[indexes.toIndex];try{if(nodeFrom&&nodeTo){var edge=generateEdge(nodeFrom,nodeTo,model.indexes),edgeKey=edge.from.id+edge.to.id,reversedEdgeKey=edge.to.id+edge.from.id,reversedEdge,values=metricValues[i]?metricValues[i].items:[];if(values!==null){var nValues=metrics.length;for(j=0;j<nValues;++j){var data={},mj=metrics[j],vj=values[j];data.metricName=mj.name;data.value=vj.rv;data.formatString=mj.formatString;edge.values[j]=data;if(indexes.edgeColorMIndex!==undefined&&indexes.edgeColorMIndex===j&&edgeColors.length>0){var ti=vj.ti;if(ti===undefined&&$U.isOnExpressMode()){var p,max=colorMetricValueRange.max,min=colorMetricValueRange.min,rv=vj.rv;if(max===min){p=0;}else{p=(rv-min)/(max-min);}if(p<0.1){ti=0;}else{if(p>=0.1&&p<0.3){ti=1;}else{if(p>=0.3&&p<0.5){ti=2;}else{if(p>=0.5&&p<0.7){ti=3;}else{if(p>=0.7&&p<0.9){ti=4;}else{if(p>=0.9){ti=5;}}}}}}}edge.color=valueToRGBA(edgeColors[ti],EDGE_TRANSPARENCY);}}if(indexes.edgeColorMIndex===undefined||edgeColors.length===0){edge.color=valueToRGBA(EDGE_COLORS.MISSING,EDGE_TRANSPARENCY);}}if(edgeMap[edgeKey]){var existingEdge=edgeMap[edgeKey],edgeValues=edge.values||[],evl=edgeValues.length,kk;for(kk=0;kk<evl;kk++){existingEdge.values[kk].value+=edgeValues[kk].value;}}else{reversedEdge=edgeMap[reversedEdgeKey];if(reversedEdge){edge.reversedEdge=reversedEdge;reversedEdge.reversedEdge=edge;}edgeMap[edgeKey]=edge;edges.push(edge);nodeFrom.adjacence.push(nodeTo);nodeFrom.edges.push(edge);if(nodeFrom!==nodeTo){nodeTo.adjacence.push(nodeFrom);nodeTo.edges.push(edge);}}}}catch(ex){mstrmojo.err(ex);}}$ARR.forEach(edges,function(edge){edge.updateValues();});$ARR.forEach(edges,function(edge){edge.updateStyles();});var idx=indexes.nodeSizeMIndex,im=(metrics[idx]&&metrics[idx].name)||null;$ARR.forEach(nodes,function(node){node.itemSizeMetricName=im;node.updateValues();});$ARR.forEach(nodes,function(node){node.updateStyles();});$ARR.forEach(properties.modifiedNodes,function(info){var node=nodesMap[info.name];if(node){node.style=info.style;if(model.modifiedNodes.indexOf(node)===-1){model.modifiedNodes.push(node);}else{log("warning: duplicated nodes are store in the server.");}}});function getMetricName(metricId){var metricName;$ARR.forEach(colHeader[0].es,function(metric){if(metric.oid===metricId){metricName=metric.n;return false;}});return metricName;}function generateItemSizeItems(node,value){var label;if(isNaN(value)){label="--";}else{label=node.format(value);}return label;}function generateItemSizeByInfo(){if(dropZone&&dropZone.itemSize&&dropZone.itemSize.id){var node=model.nodes[0]||new Node(),itemSizeByInfo={},itemSizeItems=[],itemMin=node.range.minNegtive?(-node.range.min):node.range.min,itemMax=node.range.maxNegtive?(-node.range.max):node.range.max,value,elements,label;value=parseFloat(itemMax);if(itemMax===itemMin){value=parseFloat(itemMax);itemSizeItems.push({label:generateItemSizeItems(node,value)});}else{[itemMax,itemMin].forEach(function(item){value=parseFloat(item);itemSizeItems.push({label:generateItemSizeItems(node,value)});});}itemSizeByInfo.item=mstrmojo.desc(13616,"Item size:")+" "+getMetricName(dropZone.itemSize.id);if(itemSizeItems.length>1){elements=itemSizeByInfo.elements=[];$ARR.forEach(itemSizeItems,function(szByValue){elements.push({sign:"=",v:szByValue.label});});itemSizeByInfo.caseFlag=0;}else{if(itemSizeItems.length===1){itemSizeByInfo.elements=[{diameter:12,shape:"rect",sign:"=",v:itemSizeItems[0].label}];itemSizeByInfo.caseFlag=2;}}return itemSizeByInfo;}}model.itemSizeByInfo=generateItemSizeByInfo();function adjustEdgeSizeByValue(min,max,ticks,edgeSizeByNumber){var rets=[];if(!ticks||ticks.length<2){for(i=0;i<edgeSizeByNumber;i++){rets.push(min);}return rets;}var delta=(max-min)/(edgeSizeByNumber-1),tickStep=ticks[2]?(ticks[2]-ticks[1]):(ticks[1]-ticks[0]),actualValue,roundValue=ticks[1],minStep=1,diff,minDiff;while(tickStep<1){tickStep*=10;minStep/=10;}while(tickStep>=10){tickStep/=10;minStep*=10;}rets.push(min);while(roundValue>min){roundValue-=minStep;}for(i=1;i<edgeSizeByNumber-1;i++){actualValue=parseFloat(min+i*delta);minDiff=Number.POSITIVE_INFINITY;diff=Math.abs(actualValue-roundValue);while(diff<minDiff){minDiff=diff;roundValue+=minStep;diff=Math.abs(actualValue-roundValue);}roundValue-=minStep;rets.push(roundValue);}rets.push(max);return rets;}function generateEdgeSizeByInfo(){if(dropZone&&dropZone.edgeSize&&dropZone.edgeSize.id){var edge=model.edges[0]||new Edge(),edgeSizeByNumber=5,edgeSizeByItems=[],elements,edgeSizeByInfo={},edgeSizeValueMin=edge.range.min,edgeSizeValueMax=edge.range.max,sizeByMetricIndex=edge.indexes.edgeSizeMIndex,label,CEUtility=$MOJO.chart.common.Utility,options,sp,i,len,ret=[];if((!edgeSizeValueMin&&edgeSizeValueMin!==0)||(!edgeSizeValueMax&&edgeSizeValueMax!==0)||!isFinite(edgeSizeValueMin)||!isFinite(edgeSizeValueMax)||(edgeSizeValueMax<edgeSizeValueMin)){ret.push("Error");}else{if(edgeSizeValueMin===edgeSizeValueMax){ret.push(edgeSizeValueMin);}else{options=CEUtility.prepareScalePlateOptions(false,0,4);sp=CEUtility.getScalePlate(true);sp.computeTicks(options,4,edgeSizeValueMax,edgeSizeValueMin);sp.GetTicks(ret);ret=adjustEdgeSizeByValue(edgeSizeValueMin,edgeSizeValueMax,ret,edgeSizeByNumber);}}for(i=0,len=ret.length;i<len;i++){if(!isFinite(ret[i])){label="--";}else{label=edge.format(ret[i],sizeByMetricIndex);}edgeSizeByItems.push({label:label});}edgeSizeByInfo.item=mstrmojo.desc(13617,"Edge size:")+" "+getMetricName(dropZone.edgeSize.id);elements=edgeSizeByInfo.elements=[];$ARR.forEach(edgeSizeByItems,function(szByValue){elements.push({sign:"<",v:szByValue.label});});len=elements.length;if(len===5){elements[0].sign="=";elements[4].sign="=";}if(len===1){elements[0].sign="=";}edgeSizeByInfo.caseFlag=3;return edgeSizeByInfo;}}model.edgeSizeByInfo=generateEdgeSizeByInfo();function generateEdgeColorByInfo(thresholds){var edgeColorId=dropZone&&dropZone.edgeColor&&dropZone.edgeColor.id,mx=modelData.gsi.mx,mxOfEdgeColor;if(edgeColorId&&thresholds!==undefined){$ARR.forEach(mx,function(obj){if(obj.did===edgeColorId){mxOfEdgeColor=obj;}});if(mxOfEdgeColor){var edgeColorThresholds=thresholds[edgeColorId];if(edgeColorThresholds&&edgeColorThresholds.length>0&&edgeColorThresholds[0].fmt&&edgeColorThresholds[0].fmt.bc){var rankMode=mstrmojo.VisUtility.getRankMode(edgeColorThresholds),nfs=$U.getNumberFormat(modelData,model.indexes.edgeColorMIndex),fs=nfs?mstrmojo.VisUtility.getColorByFormatStr(nfs.replace(/\'/g,'"'),rankMode):"",edgeColorByItems=mstrmojo.VisUtility.getColorByItems(edgeColorThresholds,rankMode,mxOfEdgeColor.max,mxOfEdgeColor.min,mxOfEdgeColor.cnt,fs,valueToRGBA(EDGE_COLORS.FIRST_PALETTE_COLOR));return{item:mstrmojo.desc(13618,"Edge color:")+" "+mstrmojo.VisUtility.getColorByTitle(getMetricName(edgeColorId),rankMode),elements:edgeColorByItems};}}}}model.edgeColorByInfo=generateEdgeColorByInfo(modelData.gsi.thresholds);return model;}function generateObservableModel(){function updateData(propName,val,updateModel){var propInfo=this.propInfo,newValue;propInfo.unmarshal(propName,val);newValue=propInfo[propName];if(updateModel){this.observableModel[propName].setValue(newValue,true);}return newValue;}function updateLegendProperty(propertyName,newValue,vpName,refreshWidget){function update(val,updateModel){var lgd=this.legend;if(!lgd||!lgd.hasRendered){return ;}updateData.call(this,propertyName,val,updateModel);this.initHTML5Props(this.HTML5PROPS);lgd.updateStyle(this.HTML5PROPS.LEGEND);if(refreshWidget){lgd.updateTitleLineHeight();this.hEvalSize4Legend();this.updateLegend();lgd.updateSplitter();this.updateStageContentForLegendChanged(LEGEND_DOCK_POS[lgd.currDockedPositionIdx].pos);}}update.call(this,newValue);this.setProperty(vpName,this.propInfo.marshal(propertyName),{suppressData:true,clientUndoRedoCallback:update});}function updateNodeSizeProperty(propName){return function nodeSizeHandler(e){var newValue=e.newValue;function update(val,updateModel){var propInfo=this.propInfo;updateData.call(this,propName,val,updateModel);propInfo.nodeValueRange={min:Infinity,max:-Infinity};propInfo.edgeValueRange={min:Infinity,max:-Infinity};propInfo.edgeColorValueRange={min:Infinity,max:-Infinity};this.abstractedModel=convertDataToModel.call(this,this.modelData,propInfo,this.dropZoneInfo);this.generateSprites(this.abstractedModel,this.stage);this.refresh();}update.call(this,newValue);this.setProperty(PROPERTIES_TYPES[propName],this.propInfo.marshal(propName),{suppressData:true,clientUndoRedoCallback:update});};}var propInfo=this.propInfo,keys=["showEdgeDirection","showTransition","nodeSizeAggregation","layoutMode","lgdBgFillTrans","lgdBgFillClr","lgdFntClr","lgdFntSz","lgdFntFml","lgdFntStyle","showLegend","maxNodeSize","minNodeSize"],om=this.addDisposable(new OM(keys.reduce(function(model,key){model[key]=propInfo[key];return model;},{})));om.showEdgeDirection.attachEventListener("valueChanged",this.id,function(e){var newValue=e.newValue,propName="showEdgeDirection";function update(val,updateModel){var newValue=updateData.call(this,propName,val,updateModel);this.stage.showEdgeDirection=newValue;this.stage.draw(false,true,true);}update.call(this,newValue);this.setProperty(PROPERTIES_TYPES.showEdgeDirection,this.propInfo.marshal(propName),{suppressData:true,clientUndoRedoCallback:update});});om.showTransition.attachEventListener("valueChanged",this.id,function(e){var newValue=e.newValue,propName="showTransition";function update(val,updateModel){var newValue=updateData.call(this,propName,val,updateModel);this.stage.showTransition=newValue;}update.call(this,newValue);this.setProperty(PROPERTIES_TYPES.showTransition,this.propInfo.marshal(propName),{suppressData:true,clientUndoRedoCallback:update});});om.nodeSizeAggregation.attachEventListener("valueChanged",this.id,updateNodeSizeProperty("nodeSizeAggregation"));om.maxNodeSize.attachEventListener("valueChanged",this.id,updateNodeSizeProperty("maxNodeSize"));om.minNodeSize.attachEventListener("valueChanged",this.id,updateNodeSizeProperty("minNodeSize"));om.layoutMode.attachEventListener("valueChanged",this.id,function(e){var newValue=e.newValue,propName="layoutMode";function update(val,updateModel){var newValue=updateData.call(this,propName,val,updateModel);selectLayoutMode.call(this);this.layoutSprites(this.abstractedModel,this.stage,LAYOUT_MODE_IDX_TO_STR[newValue]);this.stage.draw(this.propInfo.showTransition,true,true);}update.call(this,newValue);this.setProperty(PROPERTIES_TYPES.layoutMode,this.propInfo.marshal(propName),{suppressData:true,clientUndoRedoCallback:update});});om.lgdBgFillTrans.attachEventListener("valueChanged",this.id,function(e){updateLegendProperty.call(this,"lgdBgFillTrans",e.newValue,PROPERTIES_TYPES.lgdBgFillTrans);});om.lgdBgFillClr.attachEventListener("valueChanged",this.id,function(e){updateLegendProperty.call(this,"lgdBgFillClr",e.newValue,PROPERTIES_TYPES.lgdBgFillClr);});om.lgdFntClr.attachEventListener("valueChanged",this.id,function(e){updateLegendProperty.call(this,"lgdFntClr",e.newValue,PROPERTIES_TYPES.lgdFntClr);});om.lgdFntSz.attachEventListener("valueChanged",this.id,function(e){updateLegendProperty.call(this,"lgdFntSz",e.newValue,PROPERTIES_TYPES.lgdFntSz,true);});om.lgdFntFml.attachEventListener("valueChanged",this.id,function(e){updateLegendProperty.call(this,"lgdFntFml",e.newValue,PROPERTIES_TYPES.lgdFntFml,true);});om.lgdFntStyle.attachEventListener("valueChanged",this.id,function(e){updateLegendProperty.call(this,"lgdFntStyle",e.newValue,PROPERTIES_TYPES.lgdFntStyle,true);});om.showLegend.attachEventListener("valueChanged",this.id,function(e){var newValue=e.newValue,propName="showLegend";function update(val,updateModel){var newValue=updateData.call(this,propName,val,updateModel);this.toggleLegend(newValue);this.updateStageContentForLegendChanged(LEGEND_DOCK_POS[this.legend.currDockedPositionIdx].pos,(propInfo.showLegend?this.legendW:0));}update.call(this,newValue);this.setProperty(PROPERTIES_TYPES.showLegend,this.propInfo.marshal(propName),{suppressData:true,clientUndoRedoCallback:update});});return om;}function selectionSupportsViewFilter(){var selection=this.selectedSprites,i,len,attr;for(i=0,len=selection.length;i!==len;i++){attr=selection[i].unit.attribute;if(!attr.supportsViewFilter){return false;}}return true;}function showMenu(menuCfg,evt){var anchor=this.menuAnchor;if(!anchor){anchor=document.createElement("div");anchor.id=this.id+"-netviz-menu-anchor";anchor.style.position="absolute";document.body.appendChild(anchor);this.menuAnchor=anchor;}anchor.style.left=evt.pageX+"px";anchor.style.top=evt.pageY+"px";this.configurePopup(menuCfg,anchor);this.openPopup(menuCfg.newInstance());}function getDrillMenuDialogCallback(){function getAttributeById(tid){var attributes=$U.getPropertyByPath(this,"modelData.gts.row",[]);var idx=$U.findInArray(attributes,function(attr){return attr.id===tid;});if(idx!==-1){return attributes[idx];}}function getFromToInDropzone(){var dz=this.getDropZone();var me=this;return["to","from"].map(function(zone){var path=zone+".TemplateUnit.0.id";var tid=$U.getPropertyByPath(dz,path);var attr=getAttributeById.call(me,tid);var item=$U.pick(attr,["n","id"]);item.title=item.n;return item;});}var me=this;return function(){return new mstrmojo.ui.menus.EditorConfig({cssClass:"base-on-calculation-editor",data:{},contents:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(11859,"Based on")},{scriptClass:"mstrmojo.ui.Pulldown",alias:"attributeList",items:getFromToInDropzone.call(me),selectedIndex:0},{scriptClass:"mstrmojo.VisMenuList",alias:"candidateList",itemField:"n",items:$U.getDrillCandidates(me)}],bindings:{okEnabled:"this.valid",valid:function(){return this.data.valid;}},fnOk:function(data,editor){var drillToUnit=$U.getPropertyByPath(editor,"candidateList.selectedItem");var drillFromUnit=$U.pick(editor.attributeList.getSelectedItem(),["id","n"]);me.doSelection(function prepareSlice(selection){var sliceAttrId=drillFromUnit.id;return selection.filter(function(node){return node.hasSelfLoop||node.attribute.id===sliceAttrId;}).map(function(node){var newNode=node;if(node.hasSelfLoop&&node.attribute.id!==sliceAttrId){newNode={attribute:node.secondaryAttribute,attributeElements:node.secondaryAttributeElements};}return newNode;});});$U.doDrill(me,drillToUnit,updateDropZoneInDrill,{drillFromUnit:drillFromUnit});}});};}function getSelectionDataMenuConfig(){var showDataMenu=this.abstractedModel.allSupportsViewFilter||selectionSupportsViewFilter.call(this.stage),filterCfg=new mstrmojo.ui.menus.MenuConfig(),showDataCfg=new mstrmojo.ui.menus.MenuConfig(),result={filter:filterCfg,showData:showDataCfg},me=this,getDrillSubMenu=function(callback){var selection=me.stage.selectedSprites;var summary=isSelectionFromSameAttribute(selection);if(summary.isSameAttr){return $U.getDrillMenuItemsCallback(me,callback,{drillFromUnit:$U.pick(summary.nonLoopAttr,["id","n"])});}else{return getDrillMenuDialogCallback.call(me);}};if(showDataMenu){filterCfg.addMenuItem(mstrmojo.desc(11701,"Keep only"),"xt",this.getMenuHandler("keepOnly"));filterCfg.addMenuItem(mstrmojo.desc(3946,"Exclude"),"xt",this.getMenuHandler("exclude"));var drillCandidates=$U.getDrillCandidates(this);if(drillCandidates.length>0){filterCfg.addPopupMenuItem(mstrmojo.desc(145,"Drill"),this.id,getDrillSubMenu(this.getMenuHandler("drill")),"xt");}else{filterCfg.addNonInteractiveMenuItem(mstrmojo.desc(145,"Drill"),"",true);}showDataCfg.addMenuItem(mstrmojo.desc(13537,"Show Data..."),"xt",this.getMenuHandler("showData"));}return result;}function isSelectionFromSameAttribute(selection){var attrSeen,same=selection.every(function(node){var unit=node.unit,attr=unit.attribute;if(!unit.hasSelfLoop){if(attrSeen===undefined){attrSeen=attr;}return attrSeen===attr;}return false;});return{isSameAttr:same,allSelfloops:attrSeen===undefined,nonLoopAttr:attrSeen};}function normalizeGroupSelection(selection){if(selection.length===0){return{isSameAttr:false,allSelfloops:false,selection:[]};}var summary=isSelectionFromSameAttribute(selection),isSameAttr=summary.isSameAttr,allSelfloops=summary.allSelfloops,nonLoopAttr=summary.nonLoopAttr;var newSelection=selection.reduce(function(items,sel){var unit=sel.unit,attr=unit.attribute,newUnit;if(unit.hasSelfLoop){if(allSelfloops||attr!==nonLoopAttr){newUnit={attribute:unit.secondaryAttribute,attributeElements:unit.secondaryAttributeElements};items.push({text:sel.text,unit:newUnit,title:newUnit.attribute.name});}if(allSelfloops||attr===nonLoopAttr){newUnit={attribute:attr,attributeElements:unit.attributeElements};items.push({text:sel.text,unit:newUnit,title:attr.name});}}else{newUnit={attribute:attr,attributeElements:unit.attributeElements};items.push({text:sel.text,unit:newUnit,title:attr.name});}return items;},[]);return{allSelfloops:allSelfloops,isSameAttr:isSameAttr,selection:newSelection};}function getSelectionGroupMenuConfig(){var cfg={};if(mstrApp.isAppStatePresentation()){return cfg;}var selection=this.stage.selectedSprites,normalizedSelection,allSelfloops,data,getCellName=function(cell){return cell.text;},fnIdentity=function(x){return x;};if(selection&&selection.length>0){normalizedSelection=normalizeGroupSelection(selection);selection=normalizedSelection.selection;allSelfloops=normalizedSelection.allSelfloops;if(!allSelfloops&&normalizedSelection.isSameAttr){data=this.getCellForNode(selection[0]);cfg=$U.getGroupAndCalculationContextMenu(this,data,{selection:selection,skipSingleAttrCheck:true,fnCellName:getCellName});}else{if(allSelfloops){cfg=$U.getGroupAndCalculationContextMenuForDataPoints(this,{selection:selection,fnCellName:getCellName,fnUnique:fnIdentity,fnMakeNode:fnIdentity});}}}return cfg;}function getSceneDimension(abstractedModel){var circleCount=0,dimension=0,maxR=0;function getInformation(node){if(node.isExcluded){return ;}var p=node.sprite.getGeometry();circleCount++;if(!isNaN(p.s)){dimension+=p.s*2;if(maxR<p.s){maxR=p.s;}}}$ARR.forEach(abstractedModel.nodes,getInformation);return{circleCount:circleCount,dimension:dimension,maxR:maxR};}function sortNodes(abstractedModel){var nodeIndexes=abstractedModel.nodes.reduce(function(acc,node,idx){acc[node.id]=idx;return acc;},{});abstractedModel.nodes.sort(function cmp(a,b){var ra=a.sprite.getGeometry().s,rb=b.sprite.getGeometry().s,ret;if(ra>rb){ret=1;}else{if(ra===rb){ret=nodeIndexes[a.id]>nodeIndexes[b.id]?1:-1;}else{ret=-1;}}return ret;});}mstrmojo.netviz.VisNetwork=mstrmojo.declare(mstrmojo.VisBase,[mstrmojo._VizSelectionHelper,mstrmojo._LoadsScript,mstrmojo.vi.ui.rw._HasVisSelections,mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl,mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights,mstrmojo.vi.ui.rw._XtabDE,mstrmojo.vi.ui._IsDropTarget,mstrmojo.gm._SupportDndAsBlackBox,mstrmojo.netviz._ForceDirectedLayout,mstrmojo.netviz._CircularLayout,mstrmojo.netviz._LinearLayout,mstrmojo.netviz._SupportNetworkBrushesAndHighlights,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.vi._MonitorsAppState],{scriptClass:"mstrmojo.netviz.VisNetwork",localProps:null,normalizedIdCache:{},markupString:'<div class="VisNetwork network-{@themeType}-theme mil-{@themeType} gm-{@themeType}-theme" id={@id} style="position: absolute; left: {@left}px; top: {@top}px; width: {@width}px; height: {@height}px; z-index: 1;" mstrAttach:'+NETVIZ_ATTACHED_EVENTS.join(",")+'><div style="width: {@width}px; height:{@height}px;"></div><div></div><div class="_layoutIcons" style="position: absolute; right: '+SWITCH_BUTTON_RIGHT+"px; top: "+SWITCH_BUTTO_TOP+"px; width: "+SWITCH_BUTTO_WIDTH+"px; height: "+SWITCH_BUTTO_HEIGHT+'px"><input id="{@id}-inputForceDirectedIcon" class="_inputForceDirectedIcon" type="radio" name="{@id}-layoutTypes" style="display:none;"><label for="{@id}-inputForceDirectedIcon" class="_forceDirectedIcon" style=""></label><input id="{@id}-inputCircularIcon" class="_inputCircularIcon" type="radio" name="{@id}-layoutTypes" style="display:none;"><label for="{@id}-inputCircularIcon" class="_circularIcon" style=""></label><input id="{@id}-inputLinearIcon" class="_inputLinearIcon" type="radio" name="{@id}-layoutTypes" style="display:none;"><label for="{@id}-inputLinearIcon" class="_linearIcon" style=""></label></div>',markupSlots:{stageContainer:function(){return this.domNode.firstChild;},legendPlaceholder:function(){return this.domNode.childNodes[1];},modeSwitchButton:function(){return this.domNode.childNodes[2];},inputForceDirectedIcon:function(){return this.domNode.childNodes[2].childNodes[0];},forceDirectedIcon:function(){return this.domNode.childNodes[2].childNodes[1];},inputCircularIcon:function(){return this.domNode.childNodes[2].childNodes[2];},circularIcon:function(){return this.domNode.childNodes[2].childNodes[3];},inputLinearIcon:function(){return this.domNode.childNodes[2].childNodes[4];},linearIcon:function(){return this.domNode.childNodes[2].childNodes[5];}},init:function(e){this._super(e);this.modeSwitchButtonRect={r:SWITCH_BUTTON_RIGHT,t:SWITCH_BUTTO_TOP,w:SWITCH_BUTTO_WIDTH,h:SWITCH_BUTTO_HEIGHT};this.HTML5PROPS={};this.localProps={};this.canOnlyDragOnTitleBar=true;},update:function(node){var continueUpdate,propInfo,modelData,egt,eg;$GMU.startTimer({functionName:"VisNetwork.update",purpose:"JSON loading and consuming"});continueUpdate=this._super(node);if(continueUpdate!==false){this.clearError();modelData=this.model.data||{};egt=modelData.egt;eg=modelData.eg;if(egt!==undefined||eg!==undefined){this.setError(eg,egt);return continueUpdate;}this.modelData=this.model.data;this.dropZoneInfo=parseDropZone(this.getDropZone());this.propInfo=parseProperties(this,this.getProperties());var containerBg=this.getFormats()["background-color"];if(containerBg===undefined){containerBg=this.propInfo.themeType==="dark"?"#333333":"#ffffff";}this.propInfo.background={value:containerBg,opacity:1};this.observableModel=generateObservableModel.call(this);destroyStage.call(this);propInfo=this.propInfo;this.stage=this.addDisposable(new mstrmojo.netviz.VisNetworkStage({owner:this,slot:"stageContainer",showTransition:propInfo.showTransition,showEdgeDirection:propInfo.showEdgeDirection,themeType:propInfo.themeType,background:$HASH.clone(propInfo.background),circleStyle:$HASH.clone(propInfo.circleStyle),circleLabelStyle:$HASH.clone(propInfo.circleLabelStyle),dragMode:propInfo.dragMode}));this.propInfo.circleStyle=this.stage.observableModel&&this.stage.observableModel.circleStyle;this.layoutMode=LAYOUT_MODE_IDX_TO_STR[propInfo.layoutMode];this.themeType=propInfo.themeType;if($U.isOnExpressMode()&&this.dropZoneInfo.edgeColor.id){var gsi=this.modelData.gsi;if(Object.keys(gsi.thresholds).length===0){var ecm=this.dropZoneInfo.edgeColor;gsi.thresholds=$U.getMockUpThresholds(ecm.id,ecm.n);}}if($U.hasMergedRowCells(this.modelData)){this.error=mstrmojo.desc(13702,"The Network doesn't support grid data with merged row cell. Please disable cell merge and retry");}else{if(this.dropZoneInfo.from.id||this.dropZoneInfo.to.id){if(propInfo.showLegend&&!this.hasSizebyOrColorby()){propInfo.showLegend=false;}this.abstractedModel=convertDataToModel.call(this,this.modelData,propInfo,this.dropZoneInfo);this.generateSprites(this.abstractedModel,this.stage);}else{this.setError(null,ERROR_TYPE.NO_TEMPLATE_UNIT);}}}$GMU.endTimer();return continueUpdate;},getColorByMetric:function(){return $U.getMetricsInDropZone(this.zonesModel,mstrmojo.vi.viz.EnumDSSDropZones.ColorBy)[0]||null;},hasSizebyOrColorby:function(){return $U.getPropertyByPath(this,"dropZoneInfo.edgeColor.id",false)||$U.getPropertyByPath(this,"dropZoneInfo.edgeSize.id",false)||$U.getPropertyByPath(this,"dropZoneInfo.itemSize.id",false);},hasSizeByMetric:function(){return $U.getPropertyByPath(this,"dropZoneInfo.itemSize.t")===OBJECT_TYPE.DssTypeMetric;},setError:function(msg,type){var translatedError=$U.translateGridError(msg,type);this.error=translatedError.msg;this.errorType=translatedError.type;},clearError:function(){this.error=undefined;this.errorType=undefined;},hasError:function(){return this.error!==undefined||this.errorType!==undefined;},isEmpty:function(){return this.hasError();},getVisEmptyMsgControls:function(){var msg=this.error,type=this.errorType,rv;if(!this.hasError()){return ;}switch(type){case ERROR_TYPE.NO_DATASET:case ERROR_TYPE.NO_TEMPLATE_UNIT:rv=[{scriptClass:"mstrmojo.Label",cssClass:"dropMsg",text:msg}];break;case ERROR_TYPE.AE_ERROR:rv=[{scriptClass:"mstrmojo.Container",cssClass:"error-msg",markupString:$U.getVisEmptyMsg("AE_ERROR"),markupSlots:{containerNode:function(){return this.domNode;}}}];break;default:rv=[{scriptClass:"mstrmojo.Container",cssClass:"error-msg",markupString:'<div class="{@cssClass}"><div class="error-content">'+msg+"</div></div>",markupSlots:{containerNode:function(){return this.domNode;}}}];break;}return rv;},preBuildRendering:function(){if(this.waitingForData){return ;}this._super();var stg=this.stage;if(stg){stg.height=parseInt(this.height,10);stg.width=parseInt(this.width,10);if(!this.hasError()&&!this.waitingForData){this.defaultsLegendPop=sliceDefaultsLegendProp.call(this,(this.themeType==="light"?0:1));this.initHTML5Props(this.HTML5PROPS);}}},postBuildRendering:function(){if(this.waitingForData){return ;}if(this.isEmpty()){if($U.isOnExpressMode()){$U.renderWidgetErrorRSD(this,this.error,NETVIZ_ATTACHED_EVENTS);}else{this._super();}return ;}this.addChildren(this.stage);this.stage.render();this.initLegend();selectLayoutMode.call(this);this.layoutSprites(this.abstractedModel,this.stage,LAYOUT_MODE_IDX_TO_STR[this.propInfo.layoutMode]);this.stage.draw(false);this.attachEventListener("click",this.id,this.onclick);var exp=this.getExp(),gtsModel=this.getRowsAndCols();$U.modifyScExp(exp,gtsModel,this.model,this.normalizedIdCache);if(this._super){this._super();}},destroy:function(){if(this.legend){this.legend.hideToolbar();}destroyStage.call(this);delete this.modelData;delete this.propInfo;delete this.legend;delete this.abstractedModel;if(this._super){this._super();}},getProperties:function(){return(this.modelData&&this.modelData.vp)||{};},getProperty:function(propertyName){var properties=this.getProperties();return properties[propertyName];},getDropZone:function(){var dz=this.modelData&&this.modelData.dz;if(!$U.isValidDropZone(dz)){dz={};var modelData=this.model&&this.model.data;if(modelData){var gts=modelData.gts||{},attributes=gts.row||[],metrics=(gts.col&&gts.col[0]&&gts.col[0].es)||[],attributeKeys=["from","to"],metricKeys=["SizeBy","ColorBy","itemsz"],unitSets=[{units:attributes,unitKeys:attributeKeys,setKey:"TemplateUnit"},{units:metrics,unitKeys:metricKeys,setKey:"TemplateMetric"}];$ARR.forEach(unitSets,function(us){$ARR.forEach(us.units,function(u,i){var k=us.unitKeys[i];if(k){var t={};t[us.setKey]=[{id:u.oid||u.id,t:u.otp}];dz[k]=t;}});});}}return dz;},onAppStateChange:function onAppStateChange(evt){this._super(evt);if(!this.selectorControl){this.clearSelections(true);}},onclick:function(evt){delete this.noHighlightAfterKeepOnlyExcludeDrill;var e=evt.e||evt,target=e.target,layout;if(target===this.circularIcon){layout="0";}if(target===this.linearIcon){layout="1";}if(target===this.forceDirectedIcon){layout="2";}if(layout){this.observableModel.layoutMode.setValue(layout);}this.stage.dismissLassoSelector();if(this.legend){this.legend.hideToolbar();}},oncontextmenu:function(evt){delete this.noHighlightAfterKeepOnlyExcludeDrill;var target=evt.getTarget();evt.cancel();evt.preventDefault();if(this.legend){if($D.contains(this.legend.domNode,target,true)){this.legend.handleRMCOnLegend(evt);}else{this.legend.hideToolbar();}}},onmouseup:function(evt){var e=evt.e||evt,stg=this.stage,target=e.target||e.srcElement;if(!$D.contains(stg.domNode,target,true)){stg.dismissLassoSelector();}},initLegend:function(){var leftX=0,extraBtnSpace=0;this.hEvalSize4Legend();if(this.propInfo.showLegend){this.renderLegend();var dockedPosition=LEGEND_DOCK_POS[this.legend.currDockedPositionIdx];leftX=this.isOnRight(dockedPosition.pos)?0:this.legendW;if(this.isLegendSwitchOverlap()){extraBtnSpace=SWITCH_BUTTON_RIGHT+this.modeSwitchButtonRect.w;this.modeSwitchButtonRect.r=this.legendW+SWITCH_BUTTON_RIGHT;}else{this.modeSwitchButtonRect.r=SWITCH_BUTTON_RIGHT;}}this.modeSwitchButton.style.right=this.modeSwitchButtonRect.r+"px";this.stage.setMainRect({x:leftX,y:0,w:parseInt(this.width-extraBtnSpace-this.legendW,10),h:parseInt(this.height,10)});},hEvalSize4Legend:function(){var rtn,cData=this.abstractedModel.edgeColorByInfo,sData1=this.abstractedModel.itemSizeByInfo,sData2=this.abstractedModel.edgeSizeByInfo,width=this.getWidth(),height=this.getHeight(),legendStyle=this.HTML5PROPS.LEGEND,scale;if(this.propInfo.showLegend===false){this.legendW=this.legendH=this.legendP=0;}else{$LEGEND.applyHTML5Props(legendStyle);this.legendP=LEGEND_PADDING;scale=this.readGlobalProperty(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH);if(scale===undefined||!this.legendScale||this.legendScale!==scale){this.legendScale=scale;this.legendResized=true;this.legendFixedW=undefined;}rtn=$LEGEND.getLegendSize([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:cData},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:sData1},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:sData2}],this.legendResized?this.legendScale:undefined,width,height,legendStyle,this.legendFixedW);this.legendCutBy=rtn.cutBy;this.legendMinHeight=rtn.minHeight;this.legendFixedW=rtn.width;if(rtn.scale){this.legendScale=rtn.scale;}if(this.readGlobalProperty(LEGEND_PROPERTY.LEGEND_MODE)===ENUM_LEGEND_MODE.MINIMIZED||rtn.autoCollapse){rtn=$LEGEND.getLegendSize4MinMode(cData,height);this.legendCutBy=undefined;}this.legendW=rtn.width;this.legendH=rtn.height;}},hInitLegendListeners:function(){var me=this,id=this.id;if(this.legend){this.legendResizeListener=this.legend.attachEventListener("gm-legend-resized",id,function(evt){me.onLegendResized(evt.position);});this.legendClickListener=this.legend.attachEventListener("gm-legend-clicked",id,function(evt){me.onLegendClicked(evt);});}},onLegendResized:function(distance){function refresh(){var lgd=this.legend;if(lgd){this.hEvalSize4Legend();this.updateLegend();lgd.updateAfterResize();this.updateStageContentForLegendChanged(LEGEND_DOCK_POS[lgd.currDockedPositionIdx].pos);}}function update(scale,reRender){if(reRender){this.legendScale=scale;this.legendResized=true;this.legendFixedW=undefined;refresh.call(this);}}if(this.legend){this.legendFixedW=this.legendW+distance;this.legendScale=(this.legendFixedW)/(this.legendW/this.legendScale);this.legendResized=true;this.writeLgendFormatProperty(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH,this.legendScale,{success:update});refresh.call(this);}},onLegendClicked:function(evt){var action=evt.action,legend=this.legend,callback={success:function(){this.hEvalSize4Legend();this.updateLegend();this.updateStageContentForLegendChanged(LEGEND_DOCK_POS[legend.currDockedPositionIdx].pos);}};if(action==="close"){this.observableModel.showLegend.setValue(false);return ;}if(action==="minimize"){this.writeLgendFormatProperty(LEGEND_PROPERTY.LEGEND_MODE,ENUM_LEGEND_MODE.MINIMIZED,callback);}else{if(action==="restore"){this.writeLgendFormatProperty(LEGEND_PROPERTY.LEGEND_MODE,ENUM_LEGEND_MODE.RESTORED,callback);}}},renderLegend:function(){var lph=this.legendPlaceholder;if(!this.propInfo.showLegend){lph.style.display="none";}lph.style.width=this.legendW+"px";lph.style.height=this.legendH+"px";this.legend=this.addDisposable(new $GM.GMLegend({widget:this,model:this.model,placeholder:lph,currDockedPositionIdx:getLegendDockPosIdx(this.readGlobalProperty(LEGEND_PROPERTY.LEGEND_POSITION)),cutBy:this.legendCutBy,cssClass:"gm-legend",styles:this.HTML5PROPS.LEGEND,readGlobalProperty:function(propName){return this.widget.readGlobalProperty(propName);},writeGlobalProperty:function(propName,newValue){this.widget.writeLgendFormatProperty(propName,newValue,{success:function(){this.widget.reRender();}.bind(this)});},configureLegendPopup:function(config,itemBtn){return this.widget.configurePopup(config,itemBtn);}}));this.legend.render();this.legend.parent=this;this.legend.cutBy=this.legendCutBy;this.legend.minHeight=this.legendMinHeight;this.legend.updateContainerSize(this.getWidth(),this.getHeight());this.legendPlaceholder=this.legend.domNode;this.hInitLegendListeners();this.legend.feedData([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:this.abstractedModel.edgeColorByInfo},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:this.abstractedModel.edgeSizeByInfo},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:this.abstractedModel.itemSizeByInfo}],(this.readGlobalProperty(LEGEND_PROPERTY.LEGEND_MODE)===ENUM_LEGEND_MODE.MINIMIZED));},showMenu:showMenu,showSelectionMenu:function(evt,formatHandler){var cfg;if(!$U.isOnExpressMode()){cfg=this.getSelectionMenuConfig();if(!mstrApp.isAppStatePresentation()&&mstrApp.allowWebDashboardDesign()&&formatHandler){if(cfg.hasMenuItems()){cfg.addSeparator();}cfg.addMenuItem(mstrmojo.desc(1918,"Format"),"xt",formatHandler);}if(cfg.hasMenuItems()){this.showMenu(cfg,evt);}}},showBlankSpaceMenu:function(evt,formatHandler){if(!$U.isOnExpressMode()&&!mstrApp.isAppStatePresentation()&&mstrApp.allowWebDashboardDesign()){this.showMenu(this.getBlankSpaceMenuConfig(formatHandler),evt);}},getSelectionMenuConfig:function(){var cfg=$U.mergeHashes(getSelectionDataMenuConfig.call(this),getSelectionGroupMenuConfig.call(this)),menuOrder=[{name:"filter"},{name:"editGroup"},{name:"editCalculation"},{name:"createDe"},{name:"showData"},{name:"renameDe"}];return $U.mergeMenuConfigs(cfg,menuOrder);},getFormatMenuConfig:function(){var cfg=this.addDisposable(new mstrmojo.ui.menus.MenuConfig()),modelNode=$U.getPropertyByPath(this,"stage.observableModel.circleStyle.showNodeLabel"),isLabelShown=!!(modelNode&&modelNode.getValue()),desc;if(isLabelShown){desc=mstrmojo.desc(13688,"Hide Node Label");}else{desc=mstrmojo.desc(12079,"Show Node Label");}cfg.addMenuItem(desc,"xt",function(){modelNode.setValue(!isLabelShown);});return cfg;},getBlankSpaceMenuConfig:function(formatHandler){var cfg=this.addDisposable(new mstrmojo.ui.menus.MenuConfig()),me=this;formatHandler=formatHandler||function(){mstrApp.rootCtrl.docCtrl.selectViPanel("propertiesPanel");};cfg.addMenuItem(mstrmojo.desc(1918,"Format"),"xt",formatHandler);if(this.hasSizebyOrColorby()){if(!me.propInfo.showLegend){cfg.addMenuItem(mstrmojo.desc(12001,"Show Legend"),"xt",this.getMenuHandler("showLegend"));}}return cfg;},getLocalProp:function(propName){return this.localProps[propName];},setLocalProp:function(propName,value){this.localProps[propName]=value;},unrender:function(){if(this.legendResizeListener){this.legendResizeListener.clear();}if(this.legendClickListener){this.legendClickListener.clear();}if(this.legend){this.legend.unrender();}if(this.stage){this.removeChildren(this.stage);}if(this.menuAnchor){document.body.removeChild(this.menuAnchor);this.menuAnchor=undefined;}if(this._super){this._super();}},generateSprites:function generateSprites(abstractedModel,stage){function parseCircleSprite(node){node.sprite=stage.createSprite({type:"Circle",position:{x:0,y:0,r:node.size},text:node.getName(),title:node.getAttributeName(),attSrc:node.attSrc,forms:node.getFormNames(),formValues:node.getFormValues(),displayValue:node.format(node.getAggregatedValue()),aggregationName:node.itemSizeMetricName?node.aggregationName:null,unit:node,style:node.style,selfLoop:node.hasSelfLoop});stage.addSprite(node.sprite);}function parseEdgeSprite(edge){edge.sprite=stage.createSprite({type:"Edge",from:edge.from.sprite,to:edge.to.sprite,controlPoint:{x:stage.width/2,y:stage.height/2},color:edge.color,width:edge.width,unit:edge});stage.addSprite(edge.sprite);}stage.clearSprites();$ARR.forEach(abstractedModel.nodes,parseCircleSprite);$ARR.forEach(abstractedModel.edges,parseEdgeSprite);},getSelectedNodes:function(){return $U.pluck((this.stage.selectedSprites||[]).filter(function(sprite){return sprite.type==="Circle"&&sprite.unit;}),"unit");},keepOnly:function(){var nodes=this.abstractedModel.nodes,len=nodes.length,selectedNodes=this.getSelectedNodes(),sl=selectedNodes.length,i,node;for(i=0;i<sl;i++){node=selectedNodes[i];var ads=node.adjacence,al=ads.length,j;for(j=0;j<al;j++){if(!ads[j].isExcluded&&selectedNodes.indexOf(ads[j])===-1){selectedNodes.push(ads[j]);}}}for(i=0;i<len;i++){node=nodes[i];if(selectedNodes.indexOf(node)===-1){node.exclude();}}this.stage.draw(false);},exclude:function(){var selectedNodes=this.getSelectedNodes(),len=selectedNodes.length,i;for(i=0;i<len;i++){selectedNodes[i].exclude();}this.stage.draw(false);},getSelectedNodesInfo:function(){var info=[];$ARR.forEach(this.getSelectedNodes(),function(node){info.push(node.getActionInfo());});return info;},getMenuHandler:function(name){var me=this,handler=this._super(name);if(handler!==mstrmojo.emptyFn){return handler;}var handlers={keepOnly:function selectionKeepOnly(){me.updateAfterKeepOnly(true);me.noHighlightAfterKeepOnlyExcludeDrill=true;},exclude:function selectionExclude(){me.updateAfterKeepOnly(false);me.noHighlightAfterKeepOnlyExcludeDrill=true;},drill:function selectionDrill(menuItem){$U.doDrill(me,menuItem.ctxt.drillUnit,updateDropZoneInDrill,menuItem.ctxt);me.noHighlightAfterKeepOnlyExcludeDrill=true;},showData:function selectionShowData(){me.showData(me.getSelectedNodesInfo());},showLegend:function showLegend(){me.observableModel.showLegend.setValue(true);},hideLegend:function hideLegend(){me.observableModel.showLegend.setValue(false);}};if(handlers.hasOwnProperty(name)){return handlers[name];}return mstrmojo.emptyFn;},doSelection:function(transformSelectionFn){this.prepareSelectedNodesInfo(transformSelectionFn);this.endSelections();},onStylesModified:function(type,obj,update){var wrapper=function(propertyName){return function(val,updateModel){var propInfo=this.propInfo;propInfo.unmarshal(propertyName,val);update.call(this.stage,propInfo[propertyName],updateModel);};};var handlers={circleStyle:function(style){this.setProperty(PROPERTIES_TYPES.bubbleStyle,style,{suppressData:true,clientUndoRedoCallback:wrapper("circleStyle")});},background:function(style){this.propInfo.background=style;},circleLabelStyle:function(style){this.setProperty(PROPERTIES_TYPES.circleLabelFont,style,{suppressData:true,clientUndoRedoCallback:wrapper("circleLabelStyle")});},dragMode:function(type){this.setProperty(PROPERTIES_TYPES.dragMode,type,{suppressData:true,clientUndoRedoCallback:wrapper("dragMode")});}};if(handlers[type]){this.propInfo[type]=obj;var fn=handlers[type];if(fn instanceof Function){fn.call(this,this.propInfo.marshal(type));}}},layoutSprites:function(abstractedModel,stage,layoutAlgorithm){$GMU.startTimer({functionName:"VisNetwork.layoutSprites",purpose:"layout the bubbles"});sortNodes(abstractedModel);$ARR.forEach(abstractedModel.nodes,function(node){node.sprite.setGeometry({s:node.size});});$ARR.forEach(abstractedModel.edges,function(edge){edge.sprite.setGeometry({s:edge.width});});this.layouts[layoutAlgorithm].call(this,abstractedModel,stage,getSceneDimension(abstractedModel));stage.setScene();$GMU.endTimer();},readGlobalProperty:function(propName){var itemValue;switch(propName){case LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR:itemValue=this.propInfo.lgdBgFillClr;break;case LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_STYLE:itemValue=this.propInfo.lgdBgFillStyle;break;case LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_EFFECT:itemValue=this.propInfo.lgdBgFillEff;break;case LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY:itemValue=this.propInfo.lgdBgFillTrans;break;case LEGEND_FORMATTING_TYPE.LEGEND_FONT_SIZE:itemValue=this.propInfo.lgdFntSz;break;case LEGEND_FORMATTING_TYPE.LEGEND_FONT_FAMILY:itemValue=this.propInfo.lgdFntFml;break;case LEGEND_FORMATTING_TYPE.LEGEND_FONT_STYLE:itemValue=this.propInfo.lgdFntStyle;break;case LEGEND_FORMATTING_TYPE.LEGEND_FONT_COLOR:itemValue=this.propInfo.lgdFntClr;break;case LEGEND_FORMATTING_TYPE.LEGEND_BORDER_SHOW:itemValue=this.propInfo.lgdBdrShw;break;case LEGEND_FORMATTING_TYPE.LEGEND_BORDER_COLOR:itemValue=this.propInfo.lgdBdrClr;break;case LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE:itemValue=this.propInfo.lgdBdrStyle;break;case LEGEND_FORMATTING_TYPE.COLOR_SQUARE_COLOR:itemValue=this.propInfo.clrSqrClr;break;case LEGEND_PROPERTY.LEGEND_MODE:itemValue=this.propInfo.lm;break;case LEGEND_PROPERTY.LEGEND_POSITION:itemValue=this.propInfo.LegendPosition;break;case LEGEND_PROPERTY.SCALE_LEGEND_WIDTH:itemValue=this.propInfo.lwr;break;}if(itemValue===undefined||((typeof itemValue)==="number"&&isNaN(itemValue))){itemValue=this.defaultsLegendPop[propName];}return itemValue;},initHTML5Props:function(props){function processFontStyle(obj,fs){obj.fontWeight=(fs&ENUM_FONT_SYLTE.FS_BOLD?"bold":"normal");obj.fontStyle=(fs&ENUM_FONT_SYLTE.FS_ITALIC?"italic":"normal");if((fs&ENUM_FONT_SYLTE.FS_STRIKETHROUGH)&&(fs&ENUM_FONT_SYLTE.FS_UNDERLINE)){obj.textDecoration="line-through underline";}else{if(fs&ENUM_FONT_SYLTE.FS_STRIKETHROUGH){obj.textDecoration="line-through";}else{if(fs&ENUM_FONT_SYLTE.FS_UNDERLINE){obj.textDecoration="underline";}else{obj.textDecoration="none";}}}}var LEGEND={};LEGEND.fontFamily=this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_FAMILY);LEGEND.fontSize=this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_SIZE);processFontStyle(LEGEND,this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_STYLE));LEGEND.color=$GMU.decodeColor(this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_COLOR));LEGEND.backgroundColor=$GMU.decodeColor(this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR));LEGEND.opacity=this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY)/100;if(this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_SHOW)){LEGEND.borderWidth=$U.translateLineStyle(this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE)).width;LEGEND.borderStyle=$U.translateLineStyle(this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE)).style;LEGEND.borderColor=$GMU.decodeColor(this.readGlobalProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_COLOR));}props.LEGEND=LEGEND;},configurePopup:function configurePopup(config,itemBtn){config.hostId=this.id;config.hostElement=itemBtn;},writeLgendFormatProperty:function(propName,newValue,callback){var hasCallback=!!(callback&&callback.success),update=function(val,updateModel){var propInfo=this.propInfo;propInfo.unmarshal(propName,val);if(hasCallback){callback.success.call(this,propInfo[propName],updateModel);}},model;if(propName===LEGEND_FORMATTING_TYPE.COLOR_SQUARE_COLOR){this.propInfo.unmarshal(propName,newValue);this.setProperty(propName,newValue,{callback:callback});}else{if(this.observableModel[propName]){model=this.observableModel[propName];model.setValue(newValue);}else{update.call(this,newValue,false);this.setProperty(propName,newValue,{suppressData:true,clientUndoRedoCallback:hasCallback?update:undefined});}}},onLegendDropZoneChange:function onLegendDropZoneChange(dropZoneInfo,dockedPosIdx){this.setLegendSlot(dropZoneInfo,dockedPosIdx);},onLegendDropped:function(legendDockPos){this.writeLgendFormatProperty(LEGEND_PROPERTY.LEGEND_POSITION,legendDockPos,{success:function(pos,reRender){if(reRender){this.renderLegend();this.updateStageContentForLegendChanged(pos);}}});},setLegendSlot:function(dropZoneInfo,dockedPosIdx){var prevSlotIndex=this.legend.currDockedPositionIdx;if(dockedPosIdx!==prevSlotIndex){var preOnRight=this.isOnRight(LEGEND_DOCK_POS[prevSlotIndex].pos),curOnRight=this.isOnRight(dropZoneInfo.pos),preOnRightTop=this.isOnRightTop(LEGEND_DOCK_POS[prevSlotIndex].pos),curOnRightTop=this.isOnRightTop(dropZoneInfo.pos);if(preOnRight!==curOnRight||(preOnRight&&curOnRight&&preOnRightTop!==curOnRightTop)){this.updateStageContentForLegendChanged(dropZoneInfo.pos);}}},isOnRight:function(slot){return(slot===PRP_LEGEND_SLOT.RIGHT_MIDDLE||slot===PRP_LEGEND_SLOT.RIGHT_TOP||slot===PRP_LEGEND_SLOT.RIGHT_BOTTOM);},isOnRightTop:function(slot){return slot===PRP_LEGEND_SLOT.RIGHT_TOP;},isLegendSwitchOverlap:function(){var legendRect=$D.position(this.legend.domNode),switchRect=$D.position(this.modeSwitchButton),x1=legendRect.x,y1=legendRect.y,w1=x1+legendRect.w,h1=y1+legendRect.h,x2=switchRect.x,y2=switchRect.y,w2=x2+switchRect.w,h2=y2+switchRect.h;return !(x1>=w2||y1>=h2||x2>=w1||y2>=h1);},updateStageContentForLegendChanged:function(slot,legendW){var leftX=0,extraBtnSpace=0;legendW=(typeof legendW==="number")?legendW:this.legendW;this.modeSwitchButtonRect.r=SWITCH_BUTTON_RIGHT;if(this.propInfo.showLegend){slot=slot||this.readGlobalProperty(LEGEND_PROPERTY.LEGEND_POSITION);leftX=this.isOnRight(slot)?0:legendW;if(this.isLegendSwitchOverlap()){extraBtnSpace=SWITCH_BUTTON_RIGHT+this.modeSwitchButtonRect.w;this.modeSwitchButtonRect.r=legendW+SWITCH_BUTTON_RIGHT;}}this.stage.setMainRect({x:leftX,y:0,w:parseInt(this.width-extraBtnSpace-legendW,10),h:parseInt(this.height,10)});this.modeSwitchButton.style.right=this.modeSwitchButtonRect.r+"px";selectLayoutMode.call(this);this.stage.setScene();this.stage.draw(false);},updateLegend:function(){var legend=this.legend,am=this.abstractedModel,lps=this.legendPlaceholder.style;lps.width=this.legendW+"px";lps.height=this.legendH+"px";legend.width=this.legendW;legend.height=this.legendH;legend.cutBy=this.legendCutBy;legend.minHeight=this.legendMinHeight;legend.updateContainerSize(this.getWidth(),this.getHeight());legend.feedData([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:am.edgeColorByInfo},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:am.edgeSizeByInfo},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:am.itemSizeByInfo}],(this.readGlobalProperty(LEGEND_PROPERTY.LEGEND_MODE)===ENUM_LEGEND_MODE.MINIMIZED));legend.updateAfterResize();},toggleLegend:function(show){var legend=this.legend,lds;if(!legend||!legend.hasRendered||!legend.domNode){this.initLegend();legend=this.legend;}lds=legend.domNode.style;if(!show){legend.hideToolbar();lds.display="none";}else{if(lds.display!=="block"){lds.display="block";}}},getCellForNode:function getCellForNode(sprite){var unit=sprite.unit,attr=unit.attribute,elem=unit.attributeElements[0];return{at:elem.at,dei:elem.dei,dpt:elem.dpt,o:elem.o,n:sprite.title,tui:elem.tui,ui:elem.tui,axis:1,v:sprite.text,tid:attr.id};},getCellUnitIndex:function getCellUnitIndex(cell){return cell.o;},execFormatHandler:function(){var stg=this.stage;if(stg){stg.execFormatHandler();}},onNDECreated:function(deItems){var stg=this.stage,sprites=stg.spriteCollection;deItems.forEach(function(de){var deId=de.id,deUnitId=de.unitId;var index=$U.findInArray(sprites,function(sprite){var unit=sprite.unit;return sprite.type==="Circle"&&unit.attribute.id===deUnitId&&unit.attributeElements.some(function(elem){return elem.id.indexOf(deId)!==-1;});});if(index!==-1){stg.addToSelection(sprites[index]);}});stg.draw(false,true);},isClearAllEnabled:function(node){var m=$U.getPropertyByPath(this,"modelData",{}),sc=$U.getPropertyByPath(node,"attribute.sc",m.sc);return !!(sc===undefined||sc.showall);}});}());