(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.hash");var $DOM=mstrmojo.dom,$HASH=mstrmojo.hash;var MS_PER_FRAME=100;var SPEED_AMP=$DOM.supportsTouches?0.5:1;var MIN_VELOCITY=1;var DRAG_TIME_LIMIT=100;var commonMarkupMethods={onvscrollVisibleChange:function(){var v=this.vscrollNode,s=v&&v.style;if(!s){return ;}if(this.vscrollVisible){var max=this.maxPos,cz=this.clientSize;s.height=Math.round(cz.y*cz.y/max.y)+"px";s.left=(cz.x-5)+"px";s.display="block";s.opacity=0.5;}else{s.opacity=0;}},onhscrollVisibleChange:function(){var h=this.hscrollNode,s=h&&h.style;if(!s){return ;}if(this.hscrollVisible){var max=this.maxPos,cz=this.clientSize;s.width=Math.round(cz.x*cz.x/max.x)+"px";s.top=(cz.y-5)+"px";s.display="block";s.opacity=0.5;}else{s.opacity=0;}}};var webkitMarkupMethods=$HASH.copy({onposChange:function(){var cz=this.clientSize,max=this.maxPos,x=0,y=0;if(this.scrollsVert){y=this.pos.y;if(this.vscrollVisible){this.vscrollNode.style[$DOM.CSS3_TRANSFORM]="translateY("+Math.round((cz.y-(cz.y*cz.y/max.y))*this.pos.y/max.y)+"px)";}}if(this.scrollsHoriz){x=this.pos.x;if(this.hscrollVisible){this.hscrollNode.style[$DOM.CSS3_TRANSFORM]="translateX("+Math.round((cz.x-(cz.y*cz.x/max.x))*this.pos.x/max.x)+"px)";}}this.scrollChild.style[$DOM.CSS3_TRANSFORM]="translate3d(-"+parseInt(x,10)+"px, -"+parseInt(y,10)+"px, 0px)";},ondeceleratingChange:function(){this.scrollChild.style[$DOM.CSS3_TRANSITION]=this.decelerating?($DOM.CSS3_PREFIX+"transform 0.2s linear"):"";}},$HASH.copy(commonMarkupMethods));var nonwebkitMarkupMethods=$HASH.copy({onposChange:function(){var cz=this.clientSize,max=this.maxPos,x=0,y=0,sb=this.scrollboxNode;if(this.scrollsVert){y=this.pos.y;if(this.vscrollVisible){this.vscrollNode.style.top=Math.round((cz.y-(cz.y*cz.y/max.y))*this.pos.y/max.y)+"px";}sb.scrollTop=parseInt(y,10);}if(this.scrollsHoriz){x=this.pos.x;if(this.hscrollVisible){this.hscrollNode.style.left=Math.round((cz.x-(cz.y*cz.x/max.x))*this.pos.x/max.x)+"px";}sb.scrollLeft=parseInt(x,10);}}},$HASH.copy(commonMarkupMethods));mstrmojo._TouchScrolling=mstrmojo.provide("mstrmojo._TouchScrolling",{FRICTION:0.65,BOUNCEFRICTION:0.5,usesTouches:false,bounces:true,scrollsHoriz:true,scrollsVert:true,pos:null,preBuildRendering:function prbr(){this.usesTouches=(mstrmojo.dom.supportsTouches&&this.usesTouches&&(this.scrollsHoriz||this.scrollsVert));if(this.usesTouches){this.pos={x:0,y:0};}if(this._super){this._super();}},postBuildRendering:function psbr(){if(this._super){this._super();}if(this.usesTouches){var sbn=this.scrollboxNode,sch=this.itemsContainerNode||sbn.firstChild;if(sbn&&sbn!==sch){this.scrollChild=sch;var ss=sbn.style;ss.position="relative";ss.overflow="hidden";var cs=sch.style;cs.position="absolute";cs.left=0;cs.top=0;this.markupMethods=$HASH.copy($DOM.isSafari?webkitMarkupMethods:nonwebkitMarkupMethods,$HASH.copy(this.markupMethods));this.attachTouchEvents();}}},unrender:function(ignoreDom){if(this.usesTouches){this.detachTouchEvents();}this._super(ignoreDom);},attachTouchEvents:function(){var n=this.touchNode||this.scrollboxNode;if(n){if(!this._tsCallback){var me=this;this._tsCallback=function(e){me.touchesBegin(self,e);};this._tmCallback=function(e){me.touchesMoved(self,e);};this._teCallback=function(e){me.touchesEnd(self,e);};}$DOM.attachEvent(n,$DOM.TOUCHSTART,this._tsCallback);this._tsNode=n;}},detachTouchEvents:function(){var n=this._tsNode;if(n){$DOM.detachEvent(n,$DOM.TOUCHSTART,this._tsCallback);delete this._tsNode;}},touchesBegin:function tb(hWin,e){var tagName=e.target&&e.target.tagName;if(tagName&&(tagName==="SELECT"||tagName==="INPUT")){return ;}$DOM.preventDefault(hWin,e);this.stopDeceleration();this.startTime=new Date();this.startTimePos={x:this.pos.x,y:this.pos.y};this.startTouchPos=$DOM.getMousePosition($DOM.firstTouch(hWin,e),hWin);this.dragging=false;$DOM.attachEvent(window,$DOM.TOUCHMOVE,this._tmCallback);$DOM.attachEvent(window,$DOM.TOUCHEND,this._teCallback);},touchesMoved:function touchesMoved(hWin,e){var evtPosition=$DOM.getMousePosition($DOM.firstTouch(hWin,e),hWin);$DOM.preventDefault(hWin,e);if(!this.dragging){var MIN_DRAG_DELTA=5,abs=Math.abs;if((this.scrollsHoriz&&abs(evtPosition.x-this.pos.x)>MIN_DRAG_DELTA)||(this.scrollsVert&&abs(evtPosition.y-this.pos.y)>MIN_DRAG_DELTA)){this.dragging=true;this.dragStartTime=new Date();this.startTouchPos=evtPosition;var sbn=this.scrollboxNode,cz={x:sbn.clientWidth,y:sbn.clientHeight},sz={x:sbn.scrollWidth,y:sbn.scrollHeight};this.clientSize=cz;this.scrollSize=sz;this.maxPos={x:Math.max(sz.x-cz.x,0),y:Math.max(sz.y-cz.y,0)};this.showScroll();}}if(this.dragging){$DOM.stopPropogation(hWin,e);var startTimePos=this.startTimePos,startTouchPos=this.startTouchPos,maxPosition=this.maxPos;var newPosition={x:this.scrollsHoriz?Math.max(Math.min(startTimePos.x-(evtPosition.x-startTouchPos.x),maxPosition.x),0):0,y:this.scrollsVert?Math.max(Math.min(startTimePos.y-(evtPosition.y-startTouchPos.y),maxPosition.y),0):0};this.set("pos",newPosition);this.nextLastDragPos=this.lastDragPos;this.lastDragPos=evtPosition;var now=new Date(),last=this.lastDragTime;this.nextLastDragTime=last;this.lastDragTime=now;if((now-last)>DRAG_TIME_LIMIT){this.startTime=this.lastDragTime;this.dragStartTime=this.startTime;this.startTimePos={x:newPosition.x,y:newPosition.y};this.startTouchPos=evtPosition;}}},touchesEnd:function te(hWin,e){$DOM.preventDefault(hWin,e);$DOM.detachEvent(window,$DOM.TOUCHMOVE,this._tmCallback);$DOM.detachEvent(window,$DOM.TOUCHEND,this._teCallback);if(this.dragging){this.dragging=false;$DOM.stopPropogation(hWin,e);if((new Date())-this.lastDragTime<=DRAG_TIME_LIMIT){this.startDeceleration(hWin,e);}else{this.hideScroll();}}},startDeceleration:function stad(hWin,e){var epos=$DOM.getMousePosition($DOM.firstChangedTouch(hWin,e),hWin),lastPos=((mstrmojo.dom.supportsTouches===null)?this.lastDragPos:this.nextLastDragPos)||epos,dist={x:epos.x-lastPos.x,y:epos.y-lastPos.y},lastTime=((mstrmojo.dom.supportsTouches===null)?this.lastDragTime:this.nextLastDragTime),tm=lastTime?(new Date())-lastTime:0,velocity={x:tm?Number(dist.x*MS_PER_FRAME*SPEED_AMP/tm).toFixed(2):0,y:tm?Number(dist.y*MS_PER_FRAME*SPEED_AMP/tm).toFixed(2):0};var me=this,fnFastEnough=function(vel){return(me.scrollsHoriz&&Math.abs(vel.x)>=MIN_VELOCITY)||(me.scrollsVert&&Math.abs(vel.y)>=MIN_VELOCITY);};if(fnFastEnough(velocity)){this.velocity=velocity;this.friction={x:this.FRICTION,y:this.FRICTION};this.set("decelerating",true);var fnDecel=function(){me.decelerate();if(!fnFastEnough(me.velocity)){me.stopDeceleration();me=null;}};fnDecel();if(this.decelerating){this.decelerationTimer=window.setInterval(fnDecel,MS_PER_FRAME);}}else{this.hideScroll();}},stopDeceleration:function stopDeceleration(){this.set("decelerating",false);delete this.velocity;if(this.decelerationTimer){window.clearTimeout(this.decelerationTimer);delete this.decelerationTimer;}this.hideScroll();},decelerate:function decelerate(){var position=this.pos,velocity=this.velocity,friction=this.friction,max=this.maxPos,newpos={x:position.x-velocity.x,y:position.y-velocity.y},bounces=this.bounces,bounceFriction=this.BOUNCEFRICTION;var x=newpos.x;if(x<0||x>max.x){newpos.x=(x<0)?0:max.x;velocity.x*=bounces?-bounceFriction:0;friction.x=bounceFriction;}var y=newpos.y;if(y<0||y>max.y){newpos.y=(y<0)?0:max.y;velocity.y*=bounces?-bounceFriction:0;friction.y=bounceFriction;}this.set("pos",newpos);this.velocity={x:friction.x*velocity.x,y:friction.y*velocity.y};},hideScroll:function hideScroll(){this.set("vscrollVisible",false);this.set("hscrollVisible",false);},showScroll:function showScroll(){var max=this.maxPos;if(this.scrollsVert&&max.y&&this.vscrollNode){this.set("vscrollVisible",true);}if(this.scrollsHoriz&&max.x&&this.hscrollNode){this.set("hscrollVisible",true);}}});}());