(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.array","mstrmojo.hash","mstrmojo.func","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.models.EnumDragSources","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.vi.models.DatasetDoubleClick","mstrmojo.vi.models._CheckDataCards","mstrmojo.vi.util.TemplateUtils");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$FUNC=mstrmojo.func,$TEMPLATE_UTILS=mstrmojo.vi.util.TemplateUtils,$DATASET_MENU_UTILS=mstrmojo.vi.ui.DatasetUnitMenuUtils,METRIC_NAMES_ID="00000000000000000000000000000000",$DRAG_SOURCE=mstrmojo.vi.models.EnumDragSources,$OBJ_TYPES=mstrmojo.chart.model.enums.EnumDSSObjectType;var ENUM_TARGET={ABOVE:0,ON:1,BELOW:2};mstrmojo.vi.models.DropZoneItemType=null;mstrmojo.vi.models.DropZoneType=null;mstrmojo.vi.models.DropZonesEditorConfigType=null;function getEditDropZoneUnitAction(act,zoneId,unitId,unitType,idx,datasetId,datasetType,isDisableOnly){var action={act:act,zoneId:zoneId,unitId:unitId,unitType:unitType};if(idx!==undefined){action.unitPos=idx+1;}if(isDisableOnly!==undefined){action.is_disableonly=isDisableOnly;}if(datasetId){action.datasetId=String(datasetId);action.datasetType=String(datasetType);}return action;}function getAllowInsertUnitMethod(type){return function(zone){var itemArr=[{t:type,did:NaN}];return !!this.getAllowDropInfo(zone,itemArr,zone.items.length-1,ENUM_TARGET.BELOW,{src:{data:{src:$DRAG_SOURCE.DATASETS}}}).allowedItems.length;};}mstrmojo.vi.models.DropZonesModel=mstrmojo.declare(mstrmojo.Obj,[mstrmojo.vi.models._CheckDataCards],{scriptClass:"mstrmojo.vi.models.DropZonesModel",hostId:"",docModel:null,getDropZones:mstrmojo.emptyFn,getDZFlatStruct:function getDZFlatStruct(){var data=this.getHost().model.data,gsi=data.gsi||{},attributes=(gsi.rows||[]).concat(gsi.cols||[]),stHash={},dzf={};attributes.forEach(function(a){if(a.hasOwnProperty("st")&&a.hasOwnProperty("did")){stHash[a.did]=a.st;}});if(data.dz){Object.keys(data.dz).forEach(function(dzName){var dzData=data.dz[dzName],entry=(dzData.TemplateUnit||[]).concat(dzData.TemplateMetric||[]);entry.forEach(function(item){var id=item.id;if(item.st===undefined&&stHash.hasOwnProperty(id)){item.st=stHash[id];}});dzf[dzName]=entry;});}return dzf;},getAvatarIconClass:function getAvatarIconClass(){throw new Error(this.scriptClass+" must implement getAvatarIconClass method.");},canSwapAxis:function canSwapAxis(){return false;},swapAxis:function swapAxis(){if(this.canSwapAxis()){throw new Error(this.scriptClass+" must implement swapAxis method if this.canSwapAxis returns true.");}},canDefineSubtotals:function(){return false;},getZoneMenuItems:function getZoneMenuItems(cfg,zone){},getUnitMenuItems:function getUnitMenuItems(cfg,zone,item,el){},getMultiUnitsMenuItems:function getMultiUnitsMenuItems(cfg,zone,items){var id=this.id;if($DATASET_MENU_UTILS.getMultiSelectionShortcutMetricFunctions(items).length){cfg.addSubMenuItem(mstrmojo.desc(5188,"Calculation"),"",this.id,function(){return mstrmojo.all[id].getMultipleMetricsCalcMenus(zone,items,true);});}cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){mstrmojo.all[id].deleteItems(zone,items);});},deleteItem:function deleteItem(zone,idx){this.throwAbstractMethodError("deleteItem");},deleteItems:function deleteItem(zone,items){this.throwAbstractMethodError("deleteItems");},addZoneItem:function addZoneItem(item,zoneItems){item.t=item.t||4;if(item.did===undefined){item.did=item.id;}var gridUnit=$TEMPLATE_UTILS.findUnitsById(this.getHost().model.data.gsi,item.did)[0];if(gridUnit){$HASH.copyProps(["n","um"],gridUnit,item);}if(item.t===12||item.t===47||item.t===4){var datasets=this.docModel.datasets,itemFound=false,itemsType=item.t===4?"mx":"att";Object.keys(datasets).every(function(datasetId){(datasets[datasetId][itemsType]||[]).every(function(selItem){if(selItem.did===item.did){itemFound=true;var prop;for(prop in selItem){if(!item.hasOwnProperty(prop)){item[prop]=selItem[prop];}}}return !itemFound;});return !itemFound;});}zoneItems.push(item);},getZone:function getZone(n,id,src,disabled,extraParas){var zoneItems=[];(src||[]).forEach(function(unit){this.addZoneItem($HASH.copy(unit),zoneItems,extraParas);},this);return{n:n,id:id,enabled:!disabled,cssClass:(extraParas&&extraParas.allowSingle)?"singleUnitZone":"",getDropIconCls:function(){return"pivot";},title:(extraParas&&extraParas.title)||"",items:zoneItems};},getZoneForObject:function getZoneForObject(objectID){var result=null;this.getDropZones().zones.every(function(zone){if($ARR.find(zone.items,"did",objectID)>-1){result=zone;return false;}return true;});return result;},getUnitIndexInZone:function getUnitIndexInZone(zone,item){return $ARR.find(zone.items,"did",item.did);},isZoneDropAllowed:function isZoneDropAllowed(zone){if(!zone.enabled){return false;}return true;},getAllowDropInfo:function getAllowDropInfo(zone,dragItems,idx,edge){return{allowedItems:dragItems.concat(),removeReplaced:edge===ENUM_TARGET.ON&&$ARR.find(dragItems,"did",zone.items[idx].did)===-1};},getTargetEdgePortion:function getTargetEdgePortion(context){return 0.33;},allowInsertNewMetric:getAllowInsertUnitMethod(4),allowInsertNewAttribute:getAllowInsertUnitMethod(12),unitsDropped:function unitsDropped(zone,context,dropInfo,isPrimary,splitMetric){if(this.unitDropped!==mstrmojo.vi.models.DropZonesModel.prototype.unitDropped){return this.unitDropped(zone,context,dropInfo.idx,dropInfo.edge,isPrimary,splitMetric);}this.throwAbstractMethodError("unitsDropped");},getHost:function getHost(){return mstrmojo.all[this.hostId];},getHostModel:function getHostModel(){this.throwAbstractMethodError("getHostModel");},shouldMetricNameShowIcon:function shouldMetricNameShowIcon(){return true;},addUnitsFromDataSource:function addUnitsFromDataSource(items,datasetId,actions,cb){var controller=this.docModel.controller,addObjectAction;actions=actions||[];var hasMetric=false,xtab=this.getHost(),newFmtUnits=[],isMetric;[].concat(items).forEach(function(item){isMetric=this.isMetric(item);hasMetric=isMetric||hasMetric;addObjectAction=mstrmojo.vi.models.DatasetDoubleClick.addObject(item,datasetId,this);actions=actions.concat(addObjectAction);if(isMetric){newFmtUnits.push(item);}},this);if(actions&&actions.length){if(hasMetric&&addObjectAction&&addObjectAction[0].actions){addObjectAction[0].actions.push(xtab.model.getValuesDefaultFormatGridZoneAction(newFmtUnits));}var callback=controller._getXtabCallback(this.getHost());if(cb){callback=$FUNC.wrapMethods(cb,callback);}if(this.existLargeOrManyItems()){this.warnAndExecCallBackForAddUnits(function(){controller.submitUndoRedoUpdates(actions,{},callback);});return ;}controller.submitUndoRedoUpdates(actions,{},callback);}},changeZoneUnits:function changeZoneUnits(zone,remove,add){},getZoneAddCandidates:function getZoneAddCandidates(zone){return[];},getRequiredItemsInfo:function getRequiredItemsInfo(type){if(!type){return 0;}var allItems=[];this.getDropZones().zones.forEach(function(zone){allItems=allItems.concat(zone.items);});return Number(allItems.reduce(function(sum,item){if(parseInt(item.did,10)!==-1&&item.t===type){return sum+1;}return sum;},0));},getUpdateCallback:function getUpdateCallback(){var boxKey=this.getHost().parent.k,docModel=this.docModel;return{success:function(){docModel.getPanel().getUnitByKey(boxKey).selectVIUnit(true);}};},getUpdateTemplateAction:function getUpdateTemplateAction(actions){return this.docModel.getDataService().getUpdateTemplateAction(this.getHost().k,actions);},getReplaceCandidates:function getReplaceCandidates(zone,item){var templateUnits=[],itemType=item.t,itemID=item.did,datasetId=this.getHostModel().datasetId;this.getDropZones().zones.forEach(function(zone){((zone&&zone.items)||[]).forEach(function(obj){var objectTp=obj.t,objectId=obj.did;if(objectTp!==21&&objectId!=="-1"&&objectId!==METRIC_NAMES_ID&&((objectTp===4&&itemType===4)||(objectTp!==4&&itemType!==4))&&objectId!==itemID&&$ARR.find(templateUnits,"did",objectId)===-1){templateUnits.push(obj);}});});if(datasetId){this.docModel.getDatasetUnits(itemType===4?["mx"]:["att"],null,datasetId).forEach(function(obj){if($ARR.find(templateUnits,"did",obj.did)===-1&&obj.did!==itemID&&!obj.hide){templateUnits.push(obj);}});}return $DATASET_MENU_UTILS.getSortedDatasetUnits(templateUnits);},getDropTargetIndex:function getDropTargetIndex(zone,dropInfo){var dropIdx=dropInfo.idx,dropEdge=(dropInfo.edge===ENUM_TARGET.ON&&!dropInfo.removeReplaced)?ENUM_TARGET.BELOW:dropInfo.edge,resultIdx=dropIdx,me=this,duplicateItems={};dropInfo.allowedItems.forEach(function(item){var idx=me.getUnitIndexInZone(zone,item);if(idx!==-1){duplicateItems[idx]=item;}});$HASH.forEach(duplicateItems,function(item,idxStr){var idx=parseInt(idxStr,10);if(idx<dropIdx){resultIdx--;}else{if(idx===dropIdx){dropEdge=ENUM_TARGET.ON;}}});return dropEdge===ENUM_TARGET.BELOW?(resultIdx+1):resultIdx;},getAddDropZoneUnitAction:function getAddDropZoneUnitAction(zone,item,idx,extras){return getEditDropZoneUnitAction("addDropZoneUnit",zone.id,item.did,item.t,idx,extras&&extras.datasetId,(extras&&extras.datasetType)||$OBJ_TYPES.DssTypeReportDefinition);},getAddDropZoneUnitsActions:function getAddDropZoneUnitsActions(zone,items,idx,extras){return items.reverse().map(function(itm){return getEditDropZoneUnitAction("addDropZoneUnit",zone.id,itm.did,itm.t,idx,extras&&extras.datasetId,(extras&&extras.datasetType)||$OBJ_TYPES.DssTypeReportDefinition);});},getRemoveDropZoneUnitAction:function getRemoveDropZoneUnitAction(zone,item,isDisableOnly){return getEditDropZoneUnitAction("removeDropZoneUnit",zone.id,item.did,item.t,undefined,undefined,undefined,isDisableOnly);},checkAndAddThresholdAction:function checkAndAddThresholdAction(zoneID,item,actions){return false;},getAllZones:function(){return this.getDropZones().zones||[];},getClearAllUnitsActions:function getClearAllUnitsActions(){var actions=[];(this.getAllZones()).forEach(function(zone){((zone&&zone.items)||[]).forEach(function(item){actions.push(this.getRemoveDropZoneUnitAction(zone,item));},this);},this);return actions;},getClearAllUnitsUnTemplateActions:function getClearAllUnitsUnTemplateActions(){return[];},clearAllDropZones:function clearAllDropZones(otherActions){var actions=this.getClearAllUnitsActions(),unTemplateActions=this.getClearAllUnitsUnTemplateActions(),visualization=this.getHost(),visId=visualization.id,data=visualization.gridData||visualization.model.data||visualization.node.data,limitExpression=data.vlexpr,docModel=this.docModel,vizModel=visualization.model,controller=docModel.controller,clearViewFilterCallback=$FUNC.wrapMethods({success:function(){var visualization=mstrmojo.all[visId];if(visualization._viSelections){visualization.clearSelections();visualization.endSelections();}}},controller._getXtabCallback(visualization),{success:function success(){mstrmojo.all[visId].raiseEvent({name:"regenerateToolbar"});}}),info=vizModel.getKeepOnlyActionsForAssociatedNodes([],clearViewFilterCallback);if(limitExpression){info.actions.push(controller.dataService().getUpdateTemplateAction(visualization.k,vizModel.getRemoveMetricLimitsAction(limitExpression)));}if(otherActions){otherActions.actions=[].concat(otherActions.actions).concat(info.actions);otherActions.callback=$FUNC.wrapMethods(otherActions.callback,info.callback);}else{otherActions=info;}if(unTemplateActions&&unTemplateActions.length>0){otherActions.actions=otherActions.actions.concat(unTemplateActions);}this.submitDropZoneTemplateUpdates(actions,otherActions);},submitDropZoneUpdates:function submitDropZoneUpdates(actions,callback,extras){var host=this.getHost(),docModel=this.docModel,controller=docModel.controller,_actions=[].concat(actions||[]);if(_actions&&_actions.length){var dzUpdateCallback=callback||controller._getXtabCallback(host);controller.cmdMgr.execute({execute:function(){this.submit(_actions,dzUpdateCallback,extras);},urInfo:{callback:dzUpdateCallback}});}},submitDropZoneTemplateUpdates:function submitDZTemplateUpdates(templateActions,otherActions){var allActions=(templateActions&&templateActions.length)?[this.getUpdateTemplateAction(templateActions)]:[];if(otherActions&&otherActions.actions){allActions=allActions.concat(otherActions.actions);}this.submitDropZoneUpdates(allActions,otherActions&&otherActions.callback,otherActions&&otherActions.extras);},getHighlightTargets:function getHighlightTargets(zonesSource,dropInfo){return[dropInfo];}});mstrmojo.vi.models.DropZonesModel.ENUM_TARGET_POSITION=ENUM_TARGET;mstrmojo.vi.models.DropZonesModel.ENUM_REQUIREMENT_TYPE={ATTRIBUTE:12,METRIC:4,LONGITUDE:"long",LATITUDE:"lat"};}());