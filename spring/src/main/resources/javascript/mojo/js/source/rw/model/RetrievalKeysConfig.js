(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,fnIsEmpty=$HASH.isEmpty;var ERROR_CLEAR_BOTH=1;function toObj(value){return(typeof value==="object")?value:{};}function resolveConflicts(excludes,includes){$HASH.forEach(includes,function(inclPropValue,inclPropName){var exclPropValue=excludes[inclPropName];if(exclPropValue===undefined){delete includes[inclPropName];return true;}inclPropValue=includes[inclPropName]=toObj(inclPropValue);exclPropValue=excludes[inclPropName]=toObj(exclPropValue);if(fnIsEmpty(inclPropValue)&&fnIsEmpty(exclPropValue)){throw (ERROR_CLEAR_BOTH);}else{if(fnIsEmpty(exclPropValue)){delete excludes[inclPropName];if(fnIsEmpty(excludes[inclPropName])){resolveConflicts(excludes,includes);}}else{if(fnIsEmpty(inclPropValue)){delete excludes[inclPropName];if(fnIsEmpty(excludes[inclPropName])){resolveConflicts(excludes,includes);}}else{try{resolveConflicts(excludes[inclPropName],includes[inclPropName]);}catch(e){switch(e){case ERROR_CLEAR_BOTH:excludes[inclPropName]=includes[inclPropName]={};break;}}}}}});}function resolveConflictsAndUpdateFilters(filterInfo){$HASH.forEach(filterInfo,function(treeFilters){$HASH.forEach(treeFilters,function(filter,tree){var includes=filter.include,excludes=filter.exclude;if(fnIsEmpty(includes)||fnIsEmpty(excludes)){return true;}if(!fnIsEmpty(includes)&&!fnIsEmpty(excludes)){try{resolveConflicts(excludes,includes);}catch(e){switch(e){case ERROR_CLEAR_BOTH:treeFilters[tree]={};break;}}}});});return filterInfo;}function serializeObj(obj,prefixPath,result){$HASH.forEach(obj,function(value,key){if(value===true||fnIsEmpty(value)){result.push(prefixPath+key);}else{serializeObj(value,prefixPath+key+".",result);}});return result;}function serializeResults(filterInfo){$HASH.forEach(filterInfo,function(treeFilters){$HASH.forEach(treeFilters,function(filter,tree){var serializedResult=[];serializeObj(filter.include,"",serializedResult);serializeObj(filter.exclude,"!",serializedResult);treeFilters[tree]=serializedResult.join(";");});});return filterInfo;}function preMergeIncludeFilterObjects(currIncludes,newIncludes){$HASH.forEach(currIncludes,function(currValue,prop){var newValue=newIncludes[prop];if(newValue!==undefined){if(currValue!==true&&newValue!==true){preMergeIncludeFilterObjects(currValue,newValue);}else{if(currValue===true&&newValue!==true){newIncludes[prop]=true;}else{if(currValue!==true&&newValue===true){currIncludes[prop]=true;}}}}});}function preMergeFilters(currFilterObj,newFilterObj){var result=true;$HASH.forEach(currFilterObj,function(currFilter,tree){var newFilter=newFilterObj[tree];if(newFilter){var currIncludes=currFilter.include,currExcludes=currFilter.exclude,newIncludes=newFilter.include,newExcludes=newFilter.exclude;if(!fnIsEmpty(newExcludes)&&!fnIsEmpty(currExcludes)){result=false;return result;}if(!fnIsEmpty(newIncludes)&&!fnIsEmpty(currIncludes)){preMergeIncludeFilterObjects(newIncludes,currIncludes);}}return result;});return result;}function buildHashTree(path,result){result=result||{};if(path){var currObj=result;$ARR.forEach(path.split("."),function(propName,i,arr,isLast){currObj[propName]=isLast?true:{};currObj=currObj[propName];});}return result;}mstrmojo.rw.model.RetrievalKeysConfig=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.rw.model.RetrievalKeysConfig",init:function init(){this.nodes=[];this.filters={};},addNode:function addNode(nodeKey,filterInfo){var filters=this.filters,nodeFilters=filters[nodeKey];if(!nodeFilters){this.nodes.push(nodeKey);nodeFilters=filters[nodeKey]={data:{},defn:{}};}if(filterInfo){if(preMergeFilters(nodeFilters,filterInfo)){filters[nodeKey]=$HASH.mergeHashes(nodeFilters,filterInfo);}else{throw ("The new filters for node key ## cannot be merged with the filters currently defined".replace("##",nodeKey));}}return this;}});mstrmojo.rw.model.RetrievalKeysConfig.getConsolidatedConfig=function getConsolidateConfig(actions){var result={},resultNodes={},resultFilters={};$ARR.forEach(actions,function actionIterator(action){var partialRetrieval=action.partialRetrieval;if(partialRetrieval){$ARR.forEach(partialRetrieval.nodes,function(key){resultNodes[key]=true;});resultFilters=$HASH.mergeHashes(resultFilters,partialRetrieval.filters);delete action.partialRetrieval;}$ARR.forEach(action.actions,actionIterator);});if(!fnIsEmpty(resultNodes)){result.nodes=$HASH.keyarray(resultNodes);}if(!fnIsEmpty(resultFilters)){result.filters=serializeResults(resolveConflictsAndUpdateFilters(resultFilters));}return result;};mstrmojo.rw.model.RetrievalKeysConfig.parseResponseFilters=function parseResponseFilters(serializedFilters){var fnBuildFilterObject=function(responseFilterTree){var resultObj={};$HASH.forEach(responseFilterTree,function(serializedFilter,key){var keyFilter=resultObj[key]={serialized:serializedFilter,include:{},exclude:{}};$ARR.forEach(serializedFilter.split(";"),function(filterPath){var isExcludePath=filterPath.indexOf("!")===0;filterPath=isExcludePath?filterPath.slice(1):filterPath;buildHashTree(filterPath,isExcludePath?keyFilter.exclude:keyFilter.include);});});return resultObj;};return{data:fnBuildFilterObject(serializedFilters.data),defn:fnBuildFilterObject(serializedFilters.defn)};};}());