(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.hash","mstrmojo._ValidateSuggestions","mstrmojo.WidgetList","mstrmojo.Editor","mstrmojo.LegacySuggestionList");mstrmojo.Enum_OIB_States=mstrmojo.hash.copy(mstrmojo._ValidateSuggestions.ENUM_STATES,{EDITING:2,ADDING:3,EMPTY:4});mstrmojo.Enum_OIB_States_CSS=(function(){var STATES=mstrmojo.Enum_OIB_States,CSS={},s;for(s in STATES){if(STATES.hasOwnProperty(s)){CSS[String(STATES[s])]=s;}}return CSS;}());var $DOM=mstrmojo.dom,$HASH=mstrmojo.hash,STATES=mstrmojo.Enum_OIB_States,_freeIdCounter=0,_ITEM_ID_FIELD="_did_",KEYS=mstrmojo.Enum_Keys,MIN_TEXTINPUT_WIDTH=80,KEY_DELAY=200;function _nextId(){return _freeIdCounter++;}function _isAddingItem(item){return(item&&item.state===STATES.ADDING);}function _emptyItem(t){var item={n:t||"",state:STATES.EMPTY};item[_ITEM_ID_FIELD]=-2;return item;}function _isEmptyItem(it){return(it&&it.state===STATES.EMPTY);}function _isEmpty(w){var items=w.items,len=items&&items.length;if(!len){return true;}return(len===1&&_isAddingItem(items[0]))||(len===2&&_isEmptyItem(items[0])&&_isAddingItem(items[1]));}function getAddingInput(){var ws=this.ctxtBuilder.itemWidgets,w=ws[ws.length-1];if(w&&w.isAdding){var me=this;$DOM.attachEvent(w.domNode,"click",function(){me.editingIdx=null;});return w;}return null;}function getActiveInput(){var idx=this.editingIdx;if(idx!==null){return this.ctxtBuilder.itemWidgets[idx];}return getAddingInput.call(this);}function deactivate(){this.isActive=false;var tx=this.emptyText||"",its=this.items;if(_isEmpty(this)&&!_isEmptyItem(its[0])&&(tx.length>0)){this.add([_emptyItem(tx)],0);var ew=this.ctxtBuilder.itemWidgets[0];ew.set("shouldEllipsize",true);ew.doEllipsize();}var w=getActiveInput.call(this);if(w){if(_isAddingItem(w)&&this.showEmptyItem){w.domNode.style.display="none";}this.scrollTo(this.items[0]);w.blur();}$DOM.detachEvent(document.body,"mousedown",this._mousedownHandler);if(this.tabNavigable){$DOM.detachEvent(w.inputNode,"keydown",this._tabKeyHander);}}function activate(){if(!this.enabled){return ;}this.isActive=true;if(_isEmptyItem(this.items[0])){this.remove(0);}var w=getActiveInput.call(this);if(w){if(_isAddingItem(w)&&!this.isFull){w.domNode.style.display="block";}this.scrollTo(w.data);w.focus();}$DOM.attachEvent(document.body,"mousedown",this._mousedownHandler);if(this.tabNavigable){$DOM.attachEvent(w.inputNode,"keydown",this._tabKeyHander);}}mstrmojo.ObjectInputBox=mstrmojo.declare(mstrmojo.WidgetList,[mstrmojo._ValidateSuggestions],{scriptClass:"mstrmojo.ObjectInputBox",cssClass:"mstrmojo-ObjectInputBox",emptyText:"",showEmptyItem:true,items:null,itemField:"n",dynamicVerify:true,suggestCount:10,candidates:null,makeObservable:true,renderOnScroll:false,editingIdx:null,isActive:false,maxObjectCount:null,isFull:false,suggestionListClass:"mstrmojo.LegacySuggestionList",acptSugItemOnly:false,useKeyDelay:false,showSuggestionOnEdit:true,tabNavigable:false,getSearchPattern:function(){var w=getActiveInput.call(this);if(w){return w.getSearchPattern();}return"";},getSuggestionTarget:function getSuggestionTarget(){return this.suggestTarget;},onsuggestTargetChanged:function onsuggestTargetChanged(evt){this._request_pattern=null;},getSuggestionPos:function getSuggestionPos(){return this._pop_cfg;},onSuggestionItemSelect:function onSuggestionItemSelect(it){if(this.suggestTarget){this.suggestTarget.setItem(it[this.itemField],it,false);}this.hideSuggestion();this.closePopup();},hideEditButton:function(d){return !!this.noEditButton;},_set_items:function initItems(n,items){items=mstrmojo.hash.clone(items)||[];var maxObjectCount=this.maxObjectCount;this.set("isFull",(maxObjectCount&&items.length>=maxObjectCount));if(items.length===0){var tx=this.emptyText||"";if(tx.length>0){items.push(_emptyItem(tx));}}var addingItem={n:"",state:STATES.ADDING};addingItem[_ITEM_ID_FIELD]=-1;items.push(addingItem);var w=items[items.length-1];if(w&&_isAddingItem(w)&&this.maxObjectCount&&(this.getSelectedObjects().length>=this.maxObjectCount)){this.set("isFull",true);}this.itemIdField=_ITEM_ID_FIELD;return this._super(n,items);},add:function add(arr,at){var w=getAddingInput.call(this);if(!this.maxObjectCount||this.getSelectedObjects().length<this.maxObjectCount){this._super(arr,at);}if(!_isEmpty(this)&&_isEmptyItem(this.items[0])){this.remove(0);}if(w){w.adjustInputWidth();if(this.maxObjectCount&&(this.getSelectedObjects().length===this.maxObjectCount)){this.set("isFull",true);w.domNode.style.display="none";}else{w.domNode.style.display=this.showEmptyItem?"none":"";}}},remove:function remove(arr){this._super(arr);var w=getAddingInput.call(this);if(w){if(this.maxObjectCount&&(this.getSelectedObjects().length<this.maxObjectCount)){this.set("isFull",false);}w.adjustInputWidth();}},preBuildRendering:function(){if(this.items==null||this.items.length==0){this.set("items",[]);}if(this._super){this._super();}},postBuildRendering:function postBuildRendering(){this._super();var me=this,w=getAddingInput.call(me);if(w&&(this.showEmptyItem||this.isFull)){w.domNode.style.display="none";}this._clickHandler=function(){activate.call(me);};this._mousedownHandler=function(evt){if(!me.isActive||me.browserShown){return ;}var s=$DOM.eventTarget(self,evt);if(s&&s.parentNode&&!$DOM.contains(getActiveInput.call(me).domNode,s,false,document.body)&&!$DOM.contains(me.suggestionPopup.domNode,s,false,document.body)){deactivate.call(me);}};if(this.tabNavigable){this._tabKeyHander=function(evt){var k=parseInt(evt.keyCode||evt.charCode,10);if(k===KEYS.TAB){if(!me.isActive||me.browserShown){return ;}deactivate.call(me);}};}$DOM.attachEvent(this.domNode,"click",this._clickHandler);},nextId:_nextId,item2textCss:function item2textCss(data){return data.cssClass||"";},itemFunction:function itemFunction(item,idx,w){item[w.itemIdField]=_nextId();var c=new mstrmojo.ObjectItem({parent:w,itemField:w.itemField,cssClass:w.item2textCss(item),data:item,showSuggestionOnEdit:this.showSuggestionOnEdit,enabled:w.enabled});w.attachEventListener4ItemWidget(c,w);return c;},attachEventListener4ItemWidget:function attachEventListener4ItemWidget(c,w){var evts=["ItemEditBegin","ItemEditEnd","ItemDeletePrev","ItemDelete","ItemAdd","SuggestionOn","SuggestionOff","ItemEditing"],len=evts.length,i;for(i=0;i<len;i++){c.attachEventListener(evts[i],w.id,"_itemChangeHandler");}return c;},getSelectedObjects:function getSelectedObjects(){if(_isEmpty(this)){return[];}var items=this.items,last=items.length-1;if((last>-1)&&_isAddingItem(items[last])){return items.slice(0,last);}return items.concat();},isValid:function isValid(){var ws=this.ctxtBuilder.itemWidgets,len=ws&&ws.length,i;for(i=0;i<len;i++){if(!ws[i].isValid()){return false;}}return true;},isEmpty:function isEmpty(){return _isEmpty(this);},_itemChangeHandler:function(evt){var evtName=evt.name,d=evt.d,idx,len=this.items.length,w;switch(evtName){case"ItemEditBegin":if(this.editingIdx!==null){w=getActiveInput.call(this);if(w){w.blur();}}idx=this.itemIndex(d);this.editingIdx=idx;activate.call(this);break;case"ItemEditEnd":this.editingIdx=null;if(evt.deactivate){deactivate.call(this);}else{activate.call(this);}w=getAddingInput.call(this);if(w){w.adjustInputWidth();}break;case"ItemDelete":if(this.editingIdx!==null){w=getActiveInput.call(this);if(w){w.blur();}this.editingIdx=null;}idx=this.itemIndex(d);this.remove(idx);if(!evt.deactivate){this.editingIdx=null;activate.call(this);}else{if(!this.isActive){deactivate.call(this);}else{activate.call(this);}}break;case"ItemDeletePrev":if(len>1){this.remove(len-2);}break;case"ItemAdd":var item=$HASH.copy(evt.d);this.add([item],len-1);if(evt.deactivate){deactivate.call(this);}else{activate.call(this);}break;case"SuggestionOn":this.set("suggestTarget",evt.target);this._pop_cfg={target:evt.target,left:evt.l,top:evt.t,zIndex:this.zIndex?this.zIndex:100};this.showSuggestion(evt.pattern);break;case"SuggestionOff":this.set("suggestTarget",null);this.hideSuggestion();break;}if(this.onitemchange&&(evtName==="ItemEditEnd"||evtName==="ItemAdd"||evtName==="ItemDelete"||evtName==="ItemDeletePrev"||evtName==="ItemEditing")){this.onitemchange();}},unrender:function unrender(ignoreDom){var pop=this.suggestionPopup;if(pop.hasRendered){pop.unrender(false);}if(this._super){this._super(ignoreDom);}},destroy:function destroy(skipCleanup){var pop=this.suggestionPopup;if(pop&&pop.hasRendered){pop.destroy(false);}if(this._super){this._super(skipCleanup);}}});mstrmojo._HasMarkup.addMarkupMethods(mstrmojo.ObjectInputBox,{onenabledChange:mstrmojo.Widget.enabledMarkupMethod});mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo._HasEllipsis");var objectItemCss="mstrmojo-ObjectItem-text";mstrmojo.ObjectItem=mstrmojo.declare(mstrmojo.Widget,[mstrmojo._HasEllipsis],{scriptClass:"mstrmojo.ObjectItem",markupString:'<div id={@id} class="mstrmojo-ObjectItem" style="{@cssText}"><div class="mstrmojo-ObjectItem-displayNode"><span title=" {@title}" class="'+objectItemCss+' {@cssClass}"></span><img class="mstrmojo-ObjectItem-edit" src="../images/1ptrans.gif" title="'+mstrmojo.desc(1088,"Edit")+'" onclick="mstrmojo.all[\'{@id}\'].edit()"/><img class="mstrmojo-ObjectItem-del" src="../images/1ptrans.gif" title="'+mstrmojo.desc(629,"Delete")+'" onclick="mstrmojo.all[\'{@id}\'].del(arguments[0])"/></div><div class="mstrmojo-ObjectItem-editNode"><input type="text" class="mstrmojo-ObjectItem-input" mstrAttach:keyup,keydown/></div></div>',markupSlots:{displayNode:function(){return this.domNode.firstChild;},editNode:function(){return this.domNode.childNodes[1];},textNode:function(){return this.domNode.firstChild.firstChild;},editButtonNode:function(){return this.domNode.firstChild.childNodes[1];},delButonNode:function(){return this.domNode.firstChild.lastChild;},inputNode:function(){return this.domNode.childNodes[1].firstChild;}},markupMethods:{oncssClassChange:function(){this.textNode.className=objectItemCss+" "+this.cssClass;},onstateChange:function(){var s=this.state,css=mstrmojo.Enum_OIB_States_CSS[s],dn=this.domNode;if(s===STATES.EMPTY){dn.innerHTML=this.enabled?'<div class="mstrmojo-ObjectItem-emptyText">'+this.text+"</div>":"";}else{if(s===STATES.EDITING){var w=Math.round(this.displayNode.clientWidth);this.editNode.style.width=w-4+"px";this.inputNode.style.width=w-9+"px";}}dn.className="mstrmojo-ObjectItem "+css;this.updateButtonsVisibility(this.data);},ontextChange:function(){this.inputNode.value=this.text;this.textNode.innerHTML=mstrmojo.string.encodeHtmlString(this.text);}},updateButtonsVisibility:function updateButtonsVisibity(){if(this.parent.hideEditButton(this.data)){this.editButtonNode.style.display="none";}},state:STATES.VALID,onstateChange:function onstateChange(evt){this.data.state=this.state;},ontextChange:function ontextChange(evt){this.data[this.itemField]=this.text;},updateData:function updateData(data){$HASH.copy(data,this.data);this.set("state",STATES.VALID);this.set("text",this.data[this.itemField]);this.set("cssClass",this.parent.item2textCss(this.data));},init:function init(props){this._super(props);var d=this.data,s=d.state,p=this.parent;s=this.initState();this.cssClass=p.item2textCss(d);this.text=d[this.itemField];this.state=s;this.isAdding=_isAddingItem(d);this.useRichTooltip=true;this.title=this.text;},initState:function initState(){var p=this.parent,d=this.data,s=d.state;if(d&&d.did){d.state=STATES.VALID;return d.state;}if(typeof s==="undefined"){s=p.dynamicVerify?p.verifyObject(d[this.itemField],this):STATES.UNDETERMINED;d.state=s;}return s;},isValid:function isValid(){var state=parseInt(this.state,10);return(state!==STATES.INVALID&&state!==STATES.UNDETERMINED);},adjustInputWidth:function adjustInputWidth(){if(this.isAdding){var inputNodeStyle=this.inputNode.style;inputNodeStyle.width=MIN_TEXTINPUT_WIDTH+"px";var wn=this.domNode.parentNode,cw=wn.parentNode.offsetWidth,tw=Math.max(cw-wn.offsetLeft-20,MIN_TEXTINPUT_WIDTH);if(!isNaN(tw)){inputNodeStyle.width=tw+"px";}}},blur:function blur(){this.hideSuggestion();if(!this.isActive){return ;}this.isActive=false;var n=this.inputNode,t=n.value,p=this.parent;window.setTimeout(function(){try{n.blur();}catch(e){}},0);if(!t){return ;}if(p.acptSugItemOnly&&this._tWas_){this.set("text",t);this.set("text","");this._tWas_=null;return ;}this.setItem(t,null,true);},focus:function focus(){var ti=this.inputNode,wasActive=this.isActive;window.setTimeout(function(){try{ti.focus();if(ti.createTextRange&&!wasActive){var tr=ti.createTextRange(),len=ti.value.length;tr.move("character",len);tr.select();}else{if(ti.setSelectionRange&&!wasActive){var len=ti.value.length;ti.setSelectionRange(len,len);}}}catch(e){}},0);this.isActive=true;},prekeydown:function prekeydown(evt){var t=this.inputNode.value,k=parseInt(evt.e.keyCode||evt.e.charCode,10),p=this.parent;if(!t){return ;}if(k===KEYS.TAB||k===KEYS.ENTER){if(k===KEYS.ENTER){$DOM.preventDefault(evt.hWin,evt.e);}var it=p.getSelected();if(it&&it.did){p.handleSuggestionItemSelect(it);}else{this.hideSuggestion();if(!p.acptSugItemOnly){this.setItem(t,null,false);}else{this.set("text",t);this.set("text","");}}}else{if(k===KEYS.DOWN_ARROW){if(!p.noCache&&!p.suggestionShown){this.showSuggestion(t);p.preHighlight();}p.nextHighlight();}else{if(k===KEYS.UP_ARROW){p.preHighlight();}}}},prekeyup:function prekeyup(evt){var t=this.inputNode.value,k=parseInt(evt.e.keyCode||evt.e.charCode,10),isAdding=this.isAdding,p=this.parent;if(!t){if(isAdding){if(k===KEYS.BACKSPACE&&!this._tWas_){this.raiseEvent({name:"ItemDeletePrev"});$DOM.preventDefault(evt.hWin,evt.e);}this._tWas_=null;}else{this.raiseEvent({name:"ItemDelete",d:this.data});}this.hideSuggestion();return ;}if(k===KEYS.ESCAPE||k===KEYS.TAB){this.hideSuggestion();if(p.acptSugItemOnly){this.set("text",t);this.set("text","");this._tWas_=null;return ;}}else{if(this._tWas_!==t){this.textChanged=true;this.raiseEvent({name:"ItemEditing",d:this.data});if(p.useKeyDelay){window.clearTimeout(this._timerID);var me=this;this._timerID=window.setTimeout(function(){var value=me.inputNode.value;if(value){me.showSuggestion(value);}me._timerID=null;},KEY_DELAY);}else{this.showSuggestion(t);}}}this._tWas_=t;},setItem:function(t,data,deactivate){var isAdding=this.isAdding;deactivate=deactivate||false;this.set("text",t);if(isAdding){this.setItem_Adding(t,data,deactivate);}else{this.setItem_Editing(t,data,deactivate);}this._tWas_=null;},setItem_Adding:function(t,data,deactivate){this.set("text","");if(!data){data={};data[this.itemField]=t;}else{data.state=STATES.VALID;}this.raiseEvent({name:"ItemAdd",d:data,deactivate:deactivate});},setItem_Editing:function(t,data,deactivate){var p=this.parent;this.set("text",t);if(data){this.updateData(data);}else{if(this.textChanged){var d={};d[_ITEM_ID_FIELD]=this.data[_ITEM_ID_FIELD];delete this.data.did;this.data=d;this.textChanged=false;}this.set("state",p.verifyObject(t,this));this.set("cssClass",p.item2textCss(this.data));}this.isActive=false;this.raiseEvent({name:"ItemEditEnd",d:data,deactivate:deactivate});},getSearchPattern:function getSearchPattern(){return this.inputNode.value;},showSuggestion:function showSuggestion(text){var pos=mstrmojo.dom.position(this.domNode,true);this.raiseEvent({name:"SuggestionOn",l:Math.round(pos.x)+"px",t:Math.round(pos.y+pos.h)+"px",pattern:text,target:this});},hideSuggestion:function hideSuggestion(){this.raiseEvent({name:"SuggestionOff"});},del:function del(e){e=e||self.event;$DOM.stopPropogation(self,e);this.raiseEvent({name:"ItemDelete",d:this.data,deactivate:true});if(this.useRichTooltip&&this.hideTooltip){this.hideTooltip();}},edit:function edit(){this.set("state",STATES.EDITING);this.raiseEvent({name:"ItemEditBegin",d:this.data});if(this.showSuggestionOnEdit){this.showSuggestion(this.text);}},doEllipsize:function doEllipsize(){if(!this.shouldEllipsize){return ;}var maxItemWidth=this.maxItemWidth,truncatedNode;if(maxItemWidth){this.domNode.style.maxWidth=maxItemWidth;switch(parseInt(this.state,10)){case STATES.VALID:case STATES.UNDETERMINED:case STATES.INVALID:truncatedNode=this.textNode;break;case STATES.EMPTY:truncatedNode=this.domNode.firstChild;break;}if(truncatedNode){this.set("richTooltip",{content:this.text,contentNodeCssClass:"sp-tooltip",posType:mstrmojo.tooltip.POS_TOPLEFT,left:0,top:30,refNode:this.domNode});mstrmojo.css.addClass(truncatedNode,"truncated");}}}});}());