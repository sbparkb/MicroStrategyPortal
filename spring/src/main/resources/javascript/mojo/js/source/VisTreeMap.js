(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.VisChartUtils","mstrmojo.VisTreeMapData","mstrmojo.boxmodel");var $DOM=mstrmojo.dom;function cutHex(h){return(h.charAt(0)==="#")?h.substring(1,7):h;}function hexToRed(h){return parseInt((cutHex(h)).substring(0,2),16);}function hexToGreen(h){return parseInt((cutHex(h)).substring(2,4),16);}function hexToBlue(h){return parseInt((cutHex(h)).substring(4,6),16);}function createGradient(sc,ec,steps){var start={};start.r=hexToRed(sc);start.g=hexToGreen(sc);start.b=hexToBlue(sc);var end={};end.r=hexToRed(ec);end.g=hexToGreen(ec);end.b=hexToBlue(ec);var colors=[];var range=steps-1,i;for(i=0;i<steps;i++){var j=range-i;var c={};c.r=Math.round(((start.r*j)+(end.r*i))/range);c.g=Math.round(((start.g*j)+(end.g*i))/range);c.b=Math.round(((start.b*j)+(end.b*i))/range);colors[i]="rgb("+c.r+","+c.g+","+c.b+")";}return colors;}function getTooltipName(ch,s){var nm="",l=ch.length;if(l!==s.hi.length){return ch[0].items[s.hi[0]].n;}var i;for(i=0;i<l;i++){nm+=(i>0?" ":"")+ch[i].items[s.hi[i]].n;}return nm;}function getNormalizedTooltipValue(val){if(val.toString().indexOf(".")>=0){return Number(val).toFixed(2);}return val;}mstrmojo.VisTreeMap=mstrmojo.declare(mstrmojo.Vis,null,{scriptClass:"mstrmojo.VisTreeMap",colorStart:"#7cc5d9",colorEnd:"#790000",utils:mstrmojo.VisChartUtils,data:mstrmojo.VisTreeMapData,treeMapData:[],legendWidget:null,selectedRectIndex:null,width:800,height:350,context:null,themeColor:"#000000",tooltipOn:false,isHighlightOnTouch:true,offsetLeft:null,browserSupportsHtml5:true,markupString:'<div id="{@id}" class="mstrmojo-TreeMap {@cssClass}"style="width:{@width}px;height:{@height}px;position:relative;{@cssText}" mstrAttach:mousedown,mouseup,mousemove,mouseout,click ><canvas style="position:absolute;left:0;top:10px" width="{@width}px" height="{@height}px"></canvas><canvas style="position:absolute;left:0;top:10px" width="{@width}px" height="{@height}px"></canvas><div id="{@id}-tooltip" class="mstrmojo-Chart-tooltip"></div><div id="{@id}-legend" class="mstrmojo-TreeMap-legend"></div></div>',markupSlots:{canvas:function(){return this.domNode.firstChild;},highlightContext:function(){return this.domNode.childNodes[1];},tooltip:function(){return this.domNode.childNodes[2];},legend:function(){return this.domNode.childNodes[3];}},postBuildRendering:function postBR(){if(this._super){this._super();}browserSupportsHtml5=this.canvas.getContext;if(!browserSupportsHtml5){alert("This browser does not support HTML5");return ;}this.context=this.canvas.getContext("2d");this.highlightContext=this.highlightContext.getContext("2d");this.highlightContext.lineWidth=3;this.drawChart();},update:function update(node){var continueUpdate=this._super(node);if(continueUpdate!==false){if(this.treeMapData){this.data.process(this);if(this.treeMapData.length===0){this.data.rectangles=[];}}}return continueUpdate;},drawChart:function drwchrt(){this.highlightContext.clearRect(0,0,this.width,this.height);this.context.clearRect(0,0,this.width,this.height);this.getColorBands();var colorsToUse=[];var i,j;for(i=0;i<this.treeMapData.length;i++){for(j=0;j<this.colorBands.length;j++){if(this.treeMapData[i].count<=Math.round(this.colorBands[j].size)){colorsToUse[i]=this.colorBands[j].color;break;}}}for(i=0;i<this.data.rectangles.length;i++){var rect=this.data.rectangles[i];this.context.fillStyle=colorsToUse[i];this.context.fillRect(rect.x,rect.y,rect.w,rect.h);this.context.strokeStyle="rgb(246,237,224)";this.context.strokeRect(rect.x,rect.y,rect.w,rect.h);}},colorBands:[],getColorBands:function(){var hitcount=[],i;for(i=0;i<this.treeMapData.length;i++){hitcount[i]=this.treeMapData[i].count;}var steps=50;var colorsToPick=createGradient(this.colorStart,this.colorEnd,steps);var minCount=Math.min.apply(null,hitcount),maxCount=Math.max.apply(null,hitcount);var increment=(maxCount-minCount)/steps;var bands=[];bands[0]={};bands[0].size=minCount+increment;bands[0].color=colorsToPick[0];for(i=1;i<steps;i++){bands[i]={};bands[i].color=colorsToPick[i];bands[i].size=bands[i-1].size+increment;}this.colorBands=bands;},drawLegend:function(w){if(!w){return ;}w.removeChildren();w.addChildren(mstrmojo.insert({scriptClass:"mstrmojo.Box"}));w.addChildren(mstrmojo.insert({scriptClass:"mstrmojo.Box"}));w.addChildren(mstrmojo.insert({scriptClass:"mstrmojo.Box"}));var boxwidth=0;var textwidth=0;var prevSize=0;if(isNaN(this.colorBands[this.colorBands.length-1].size)){w.children[0].addChildren(mstrmojo.insert({scriptClass:"mstrmojo.Label",text:"No caches data input",postApplyProperties:function(){var cssTextString="";cssTextString="position: absolute;left: 45%;top:5px;font-weight:bold;";this.set("cssText",cssTextString);}}));}else{w.children[0].addChildren(mstrmojo.insert({scriptClass:"mstrmojo.Label",text:mstrmojo.desc(8691,"Hit Count"),postApplyProperties:function(){var cssTextString="";cssTextString="position: absolute;left: 45%;top:5px;font-weight:bold;";this.set("cssText",cssTextString);}}));var bw=Math.round(this.width/this.colorBands.length);var toWidth=this.width-2;w.children[1].addChildren(mstrmojo.insert({scriptClass:"mstrmojo.Box",width:toWidth+"px",height:10+"px",cssText:"color:#790000;position:absolute;top:20px;left:-5px;background: -webkit-gradient(linear, left top, right top, from(#7cc5d9), to(#790000), color-stop(0.7, #790000)); background: -moz-linear-gradient(left top, #7cc5d9, #790000 70%);background-image: -ms-linear-gradient(left, #7CC5D9 0%, #790000 100%);"}));var txt="0";w.children[2].addChildren(mstrmojo.insert({scriptClass:"mstrmojo.Label",cssText:"position: absolute;top:35px;left:"+textwidth+"px;width:15px;height:10px",text:txt}));textwidth=Math.round(this.width/2);txt=String(Math.round(this.colorBands[this.colorBands.length-1].size/2));w.children[2].addChildren(mstrmojo.insert({scriptClass:"mstrmojo.Label",cssText:"position: absolute;top:35px;left:"+textwidth+"px;width:15px;height:10px",text:txt}));textwidth=this.width-15;txt=String(Math.round(this.colorBands[this.colorBands.length-1].size));w.children[2].addChildren(mstrmojo.insert({scriptClass:"mstrmojo.Label",cssText:"position: absolute;top:35px;left:"+textwidth+"px;width:15px;height:10px",text:txt}));}w.render();},drawLabels:function drwlbls(){},renderTooltip:function rndrttp(touchX,touchY){var rects=this.data.rectangles,i;if(rects.length===0){return ;}for(i=0;i<rects.length;i++){var rect=rects[i];if(touchX>=rect.x&&touchX<=(rect.x+rect.w)&&touchY>=rect.y&&touchY<=(rect.y+rect.h)){this.highlightContext.clearRect(0,0,this.width,this.height);this.highlightContext.strokeStyle="rgb(175,249,87)";this.highlightContext.strokeRect(rect.x,rect.y,rect.w,rect.h);this.tooltip.innerHTML='<p align="left"> <b>'+mstrmojo.desc(7559,"Name")+": </b>"+this.treeMapData[i].name+'<p align="left"><b>'+mstrmojo.desc(2178,"Size")+": </b>"+this.treeMapData[i].size+' KB<p align="left"><b>'+mstrmojo.desc(8691,"Hit Count")+": </b>"+this.treeMapData[i].count;this.set("selectedRectIndex",i);break;}}this.tooltip.style[$DOM.CSS3_TRANSFORM]="translate("+touchX+"px,"+touchY+"px)";if(this.tooltip.className.indexOf("fadeIn")<0){this.tooltip.className=this.tooltip.className+" fadeIn";if(this.isAndroid){this.tooltip.style.visibility="visible";}}},getTouchValue:function gtvlindx(x,y){var md=this.model,m=this.margin;var sz=md.rne-md.rns>0?md.rne-md.rns:this.windowSize;var touchVal=Math.round(((x-m.l)*(sz-1))/(this.width-m.l-m.r-1));return(touchVal<sz)?touchVal:null;},handleTouchBegin:function handleTouchBegin(touchX,touchY){if(!this.isHighlightOnTouch){return ;}this.tooltipOn=true;this.handleTouchMove(touchX,touchY);},handleTouchMove:function handleTouchMove(touchX,touchY){var me=this;if(!me.tooltipOn||!me.isHighlightOnTouch){return ;}touchX=touchX-me.offsetLeft;touchY=touchY-me.offsetTop;me.renderTooltip(touchX,touchY);},handleTouchEnd:function handleTouchEnd(){var me=this;me.tooltipOn=false;me.highlightContext.clearRect(0,0,me.width,me.height);me.tooltip.className=me.tooltip.className.replace(" fadeIn","");if(this.isAndroid){me.tooltip.style.visibility="hidden";}},onmousedown:function(evt){if(!this.isAndroid){this.handleTouchBegin(evt.e.pageX,evt.e.pageY);}},onmouseup:function(evt){if(!this.isAndroid){this.handleTouchEnd();}},onmousemove:function(evt){if(!this.isAndroid){this.handleTouchMove(evt.e.pageX,evt.e.pageY);}},onmouseout:function(evt){if(!this.isAndroid){this.handleTouchEnd();}}});}());