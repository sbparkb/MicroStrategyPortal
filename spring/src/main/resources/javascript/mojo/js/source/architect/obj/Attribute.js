(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.Obj","mstrmojo.architect.obj.Form","mstrmojo.warehouse.EnumObjectTypes");var Enum_SM_CreateObject=1,Enum_SM_DeleteObject=2,Enum_SM_RenameObject=3,$M=mstrmojo,$H=$M.hash,$A=$M.array,$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,ENUM_OT_ATTRIBUTE=$ENUM_OT.ATTRIBUTE;function getFormCount(attribute){var count=0;$H.forEach(attribute.forms,function(){count++;});return count;}function renameAttribute(attribute,newName,callback){attribute.model.submitRequest({success:function(){attribute.name=newName;if(callback&&callback.success){callback.success();}}},{objectid:attribute.id,objecttype:ENUM_OT_ATTRIBUTE,manipulationtype:Enum_SM_RenameObject,objectname:newName},"schemaManipulation");}function createAttribute(attribute,name,callback){attribute.model.submitRequest({success:function(res){var ele=res.mi["in"].oi;attribute.id=ele.did;attribute.name=ele.n;attribute.arity=1;attribute.forms={};attribute.tables={};attribute.relationshps={};attribute.automapping=false;if(callback&&callback.success){callback.success(attribute);}}},{objecttype:ENUM_OT_ATTRIBUTE,manipulationtype:Enum_SM_CreateObject,objectname:name,showWait:true},"schemaManipulation");}mstrmojo.architect.obj.Attribute=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.architect.obj.Attribute",init:function init(props){var attribute=this;this._super(props);if(props.isNew){createAttribute(attribute,props.name,props.callback);}else{attribute.forms={};attribute.tables={};attribute.relationshps={};attribute.automapping=false;}},id:undefined,name:undefined,arity:1,formGroups:[],rename:function rename(newName,callback){if(mstrApp.getRootController().validateName(ENUM_OT_ATTRIBUTE,newName,this.name)){renameAttribute(this,newName,callback);}},remove:function remove(callback){var attribute=this,attributeId=attribute.id,frmCount=getFormCount(attribute),idx=0;attribute.model.submitRequest({success:function(){$H.forEach(attribute.tables,function(table){for(idx=0;idx!==frmCount;idx++){table.removeAttributeInfo(false,idx.toString(),attributeId,null);}});if(callback&&callback.success){callback.success(attribute.id);}}},{manipulationtype:Enum_SM_DeleteObject,objecttype:ENUM_OT_ATTRIBUTE,objectid:attribute.id},"schemaManipulation");},addForm:function addForm(isNew,id,baseFormId,categoryId,tableId,columnId,expression,sortType,browseSortType,isMultiLingual,baseFormType,useName,useDescription,isBrowseForm,isTemplateForm,catn,callbackFn){var attribute=this,cbAddForm={callbackFn:callbackFn,success:function(res){if(this.callbackFn&&this.callbackFn.success){this.callbackFn.success(res);}}};attribute.forms[baseFormId]=new mstrmojo.architect.obj.Form({baseFormId:baseFormId,isNew:isNew,attributeId:attribute.id,categoryId:categoryId,tableId:tableId,columnId:columnId,expression:expression,sortType:sortType,browseSortType:browseSortType,isMultiLingual:isMultiLingual,baseFormType:baseFormType,useName:useName,useDescription:useDescription,isBrowseForm:isBrowseForm,isTemplateForm:isTemplateForm,model:attribute.model,catn:catn,callback:cbAddForm});},removeForm:function removeForm(baseFormId,callbackFn){var attribute=this,form=attribute.forms[baseFormId],attributeInfo,frmCount=getFormCount(attribute),tmpBaseFormId=0;form.remove({callbackFn:callbackFn,success:function(formId){delete attribute.forms[baseFormId];$H.forEach(attribute.tables,function(table){table.removeAttributeInfo(false,baseFormId,attribute.id,null);});if(baseFormId<frmCount){$H.forEach(attribute.forms,function(form){if(form.baseFormId>baseFormId){tmpBaseFormId=form.baseFormId-1;attribute.forms[tmpBaseFormId]=form;delete attribute.forms[form.baseFormId];form.baseFormId=tmpBaseFormId;}});$H.forEach(attribute.tables,function(table){attributeInfo=table.attributeInfos[attribute.id];$H.forEach(attributeInfo.baseForms,function(baseForm){if(baseForm.baseFormId>baseFormId){tmpBaseFormId=baseForm.baseFormId-1;attributeInfo.baseForms[tmpBaseFormId]=baseForm;delete attributeInfo.baseForms[baseForm.baseFormId];baseForm.baseFormId=tmpBaseFormId;}});});}if(this.callbackFn&&this.callbackFn.success){this.callbackFn.success(formId);}}});},isCompound:function isCompound(baseFormId){var attribute=this,form=attribute.forms[baseFormId],isComp=false;$A.forEach(attribute.formGroups,function(group){isComp=($A.find(group.fms,"did",form.categoryId)>-1);return !isComp;});return isComp;}});}());