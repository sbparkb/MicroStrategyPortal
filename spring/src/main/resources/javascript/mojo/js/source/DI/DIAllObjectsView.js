(function(){mstrmojo.requiresCls("mstrmojo.DI.DIAllObjectsGrid","mstrmojo.HBox","mstrmojo.VBox","mstrmojo.Pulldown");mstrmojo.requiresDescs(10,118,221,2177,4531,12667,12668,12954,13912,13913);var $ARR=mstrmojo.array,$func=mstrmojo.func,DistributionKeyTypes=[1,2,3,8,9,11],AllAttributesViewID="DI-All-Attributes-View",AllMetricsViewID="DI-All-Metrics-View",DistributionKeySelector="DI-Dist-Key-Selector",DistributionNumberInput="DI-Dist-Num-Input",SEARCH_TIP_TEXT=mstrmojo.desc(10,"Search"),emptyKey={id:"",alias:mstrmojo.desc(12667,"---- none ----")},autopaKey={id:"autopa",alias:mstrmojo.desc(4531,"Automatic")},_model=null,_controller=null,_saveCfgFn=mstrmojo.emptyFn;function getAttributeType(att){if(att.isMultiForm){var i,n=att.subColumns.length;for(i=0;i<n;i++){if(att.subColumns[i].fmn==="ID"){return att.subColumns[i].dtp;}}}return att.dtp;}function rawSaveCfg(){var cubeConfig,atView;if(!_controller){return ;}cubeConfig=_model.cubeConfig;atView=mstrmojo.all[AllAttributesViewID];if(atView){cubeConfig.sidxes=atView.getSearchIdxes();}_controller.persistCubeConfig(cubeConfig);}mstrmojo.DI.DIAllObjectsView=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.DIAllObjectsView",cssClass:"mstrmojo-di-allObjects-dialog",title:mstrmojo.desc(12668,"All Objects View"),model:null,noButtonCls:true,showTitle:true,help:"Multi_Table_View_Editor.htm",init:function init(props){var thisId;_controller=mstrApp.getRootController().allObjectsController;_model=mstrApp.getRootController().model;_saveCfgFn=mstrmojo.emptyFn;if(this._super){this._super(props);}_model.attachEventListener("MappingsFetched",this.id,"onMappingsChange");thisId=this.id;$ARR.forEach([AllAttributesViewID,AllMetricsViewID],function(id){var widget=mstrmojo.all[id];widget.attachEventListener("beginSelectionItem",thisId,"gridBeginSelectionItem");});mstrmojo.all[AllAttributesViewID].attachEventListener("searchIndexChange",thisId,"onsearchIndexChange");},onOpen:function(){if(this._super){this._super();}_saveCfgFn=$func.debounce(rawSaveCfg,500);},gridBeginSelectionItem:function(evt){var source=evt.src;$ARR.forEach([AllAttributesViewID,AllMetricsViewID],function(id){if(id!==source.id){mstrmojo.all[id].clearSelect();}});},onsearchIndexChange:function(){_saveCfgFn();},onClose:function onClose(){this.destroy();},onMappingsChange:function(){var distKeySelector=mstrmojo.all[DistributionKeySelector];var isKeyValid;if(distKeySelector){isKeyValid=distKeySelector.updateKeys(true);}if(!isKeyValid){var distNum=mstrmojo.all[DistributionNumberInput];if(distNum){distNum.enableInput(false);}}},buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(118,"Save"),visible:false,onclick:function(){var cubeConfig=_model.cubeConfig;var atView=mstrmojo.all[AllAttributesViewID];if(atView){cubeConfig.sidxes=atView.getSearchIdxes();}_controller.persistCubeConfig(cubeConfig);this.parent.parent.close();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(2177,"Close"),onclick:function(){this.parent.parent.close();}}],children:[{scriptClass:"mstrmojo.VBox",children:[{scriptClass:"mstrmojo.Box",cssClass:"all-objects-header cf",children:[{scriptClass:"mstrmojo.ui.SearchBox",cssClass:"all-objects-search",markupString:'<div id={@id} class="mstrmojo-ui-SearchBox cf {@cssClass}" style="{@cssText}"><input class="mstrmojo-ui-sb-input" type="text" mstrAttach:keyup,blur,focus/><div class="mstrmojo-ui-sb-btn" mstrAttach:click ></div></div>',searchDelay:200,onSearch:false,setSearchTip:function(){this.inputNode.value=SEARCH_TIP_TEXT;},postBuildRendering:function pbr(props){if(this._super){this._super(props);}this.setSearchTip();},onfocus:function(){if(this.text){this.inputNode.value=this.text;}else{this.clearSearch(true);}},onblur:function(){if(!this.text){this.setSearchTip();var gridView=mstrmojo.all[AllAttributesViewID];if(gridView.items.length===0){gridView.set("items",gridView.allItems);}gridView=mstrmojo.all[AllMetricsViewID];if(gridView.items.length===0){gridView.set("items",gridView.allItems);}}},searchTriggered:function(pattern){if(pattern===SEARCH_TIP_TEXT){return ;}var gridView=mstrmojo.all[AllAttributesViewID];if(gridView){gridView.filterItems(pattern);}gridView=mstrmojo.all[AllMetricsViewID];if(gridView){gridView.filterItems(pattern);}}},{scriptClass:"mstrmojo.HBox",cssClass:"distribution-key-box",cellPadding:5,bindings:{visible:function(){return mstrApp.getRootController().allObjectsController.isCubeConfigEnabled();}},children:[{scriptClass:"mstrmojo.Label",cssClass:"distribution-key-caption",text:mstrmojo.desc(13912,"Partition Attribute")},{scriptClass:"mstrmojo.Pulldown",id:DistributionKeySelector,itemField:"alias",itemIdField:"id",cssClass:"mstrmojo-ME-Pulldown",popupCssClass:"mstrmojo-ME-Pulldown-Popup mstrmojo-di-Pulldown-scrollOnHover",postCreate:function(){if(this._super){this._super();}var controller=mstrApp.getRootController().allObjectsController;controller.attachEventListener("updateDistKey",this.id,"updateKeys");},onvalueChange:function(){if(this._super){this._super();}_model.cubeConfig.distInfo.keyId=this.value;mstrmojo.all[DistributionNumberInput].enableInput(!!this.selectedIndex);_saveCfgFn();},updateKeys:function(refresh){var items=mstrmojo.all[AllAttributesViewID].getAllItems(),allAttributes=[];$ARR.forEach(items,function getAtt(element){allAttributes.push(element.col);});var keys=$ARR.filter(allAttributes,function isType(element){var attType=getAttributeType(element);return ~$ARR.indexOf(DistributionKeyTypes,attType);});keys.splice(0,0,autopaKey);keys.splice(0,0,emptyKey);var distInfo=_model.cubeConfig.distInfo;var selectedIndex=0;if(distInfo&&distInfo.keyId){var i;for(i=0;i<keys.length;i++){if(keys[i].id===distInfo.keyId){selectedIndex=i;break;}}}this.defaultSelection=selectedIndex;this.items=keys;if(refresh===true){this.paint();}return selectedIndex;}},{scriptClass:"mstrmojo.Label",cssClass:"distribution-number-caption",text:mstrmojo.desc(13913,"Number of Partition")},{scriptClass:"mstrmojo.TextBox",id:DistributionNumberInput,cssClass:"mstrmojo-di-distribution-number-input",type:mstrmojo.dom.isIE9?"text":"number",value:0,max:128,min:2,tooltip:mstrmojo.desc(12954,"Enter an integer between 2 and 128"),valueChangeDelay:1000,validateInput:function validateInput(value){if(this.enabled){if(value>this.max){this.set("value",this.max);}else{if(value!==""&&value<this.min){this.set("value",this.min);}}}},onvalueChange:function(evt){if(this._super){this._super();}var value=evt.value;this.validateInput(value);_model.cubeConfig.distInfo.pf=this.value;_saveCfgFn();},onblur:function onblur(){if(this.value<this.min){this.set("value",this.min);_model.cubeConfig.distInfo.pf=this.value;}},enableInput:function enableInput(value){if(this.enabled!==value){this.set("enabled",value);if(value){this.set("value",4);}else{this.set("value",0);}}},postCreate:function(){this._super();this.set("value",_model.cubeConfig.distInfo.pf);},postBuildRendering:function pbr(){if(this._super){this._super();}if(mstrmojo.all[DistributionKeySelector].defaultSelection===0){this.set("enabled",false);}}}]}]},{scriptClass:"mstrmojo.HBox",cssClass:"attribute-metric-box",cellPadding:5,children:[{scriptClass:"mstrmojo.DI.DIAllObjectsGrid",cssClass:"mstrmojo-di-all-objects-grid",id:AllAttributesViewID,type:"amps"},{scriptClass:"mstrmojo.DI.DIAllObjectsGrid",cssClass:"mstrmojo-di-all-objects-grid",id:AllMetricsViewID,type:"mtmps"}]}]}]});}());