(function(){mstrmojo.requiresCls("mstrmojo._HasOwnAvatar","mstrmojo.array","mstrmojo.css","mstrmojo.dom","mstrmojo.hash","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.ui.SimpleTree","mstrmojo.warehouse._CanToggleAvatarClass","mstrmojo.warehouse.EnumObjectTypes");var $A=mstrmojo.array,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$H=mstrmojo.hash,CSS_MENU_CLASS="item-mn",CSS_NAME_CLASS="item-n",CSS_USER_SELECT_CLASS="userSel",CSS_MULTI_SELECT_CLASS="mltSel",$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,ENUM_OT_TABLE=$ENUM_OT.TABLE,ITEM_TAG="li",ITEM_CONTAINER_TAG="ul",INDEX_ATTR="idx",INDEX_ATTR_DELIMITER=":";function forEachItemNode(fn){if(this.hasRendered){var treeNodes=this.domNode.getElementsByTagName(ITEM_TAG);$A.forEach(treeNodes,fn,this);}}function getUserSelectedData(){var userSelectedData=[];$H.forEach(this.userSelections,function(flag,index){userSelectedData.push(this.getTreeItem(index));},this);return(userSelectedData.length>1)?userSelectedData:null;}mstrmojo.warehouse.ui.TablesTree=mstrmojo.declare(mstrmojo.ui.SimpleTree,[mstrmojo._HasOwnAvatar,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.warehouse._CanToggleAvatarClass],{scriptClass:"mstrmojo.warehouse.ui.TablesTree",markupString:'<div id="{@id}" class="mstrmojo-SimpleTree {@cssClass}" mstrAttach:click,dblclick>{@itemsHTML}</div>',userSelections:undefined,draggable:true,dropZone:true,getMenuHelper:mstrmojo.emptyFn,showTablesNum:true,init:function init(props){this._super(props);this.cssClass+=" mstrmojo-wh-TablesTree";this.userSelections=[];},getItemMarkup:function getItemMarkup(){return'<div class="{@cls}" title="{@ttp}"><span class='+CSS_NAME_CLASS+' unselectable="on">{@n}</span><span class='+CSS_MENU_CLASS+"></span></div>";},treeHooks:{select:function select(el,item,level){var offsetItem=$DOM.findAncestorByAttr(el,"idx",true,this.domNode),itemIndex=offsetItem.value,userSelections=this.userSelections,rangeSelect=this.rangeSelect,userSelectionArray,userSelectionArrayLen,startIndex=Number.MAX_VALUE,endIndex=Number.MIN_VALUE,itemValue,shiftItemValue,itemIndexArray,shiftIndexArray,internalIndex,internalItem,li,shiftStartIndex=this.shiftStartIndex,levelIndex=parseInt(level,10),isUserSelected=userSelections[itemIndex]===true;if(item.tp===ENUM_OT_TABLE){if(isUserSelected){delete userSelections[itemIndex];}else{userSelections[itemIndex]=true;}userSelectionArray=$H.keyarray(userSelections);userSelectionArrayLen=userSelectionArray.length;$CSS.toggleClass(this.domNode,CSS_MULTI_SELECT_CLASS,userSelectionArrayLen>1);$CSS.toggleClass(el,CSS_USER_SELECT_CLASS,!isUserSelected);if(rangeSelect&&userSelectionArrayLen&&shiftStartIndex){shiftIndexArray=shiftStartIndex.split(INDEX_ATTR_DELIMITER);itemIndexArray=itemIndex.split(INDEX_ATTR_DELIMITER);if(shiftIndexArray&&itemIndexArray&&(shiftIndexArray.length===itemIndexArray.length)&&shiftIndexArray.length===(levelIndex+1)){for(li=0;li<shiftIndexArray.length;li++){if(shiftIndexArray[li]!==itemIndexArray[li]){break;}}if(li===levelIndex){itemValue=parseInt(itemIndexArray[levelIndex],10);shiftItemValue=parseInt(shiftIndexArray[levelIndex],10);if(!isNaN(itemValue)&&!isNaN(shiftItemValue)){startIndex=(itemValue<shiftItemValue)?itemValue:shiftItemValue;endIndex=(itemValue>shiftItemValue)?itemValue:shiftItemValue;}for(var index=startIndex;index<=endIndex;index++){itemIndexArray[level]=index.toString();internalIndex=itemIndexArray.join(INDEX_ATTR_DELIMITER);internalItem=this.getTreeItem(internalIndex);if(internalItem&&internalItem.tp===ENUM_OT_TABLE){userSelections[internalIndex]=true;delete this.selectedIndices[internalIndex];}}forEachItemNode.call(this,function(treeNode){var index=treeNode.getAttribute(INDEX_ATTR);if(userSelections[index]===true){$CSS.toggleClass(treeNode,CSS_USER_SELECT_CLASS,true);}});}}}}delete this.selectedIndices[itemIndex];return true;},unselect:function unselect(el,item,level,idx){this.itemRenderer.select(el,item,level,idx,this);this.selectedIndices[item._renderIdx]=true;return true;}},tablesTreeHooks:{},showMenu:function showMenu(itemInfo){var menuHelper=this.getMenuHelper(),MENU_CONTEXT_LAYER=1;mstrApp.getRootController().setTableMenuContext(MENU_CONTEXT_LAYER);menuHelper.target=this;menuHelper.data=itemInfo.data;var cfg=menuHelper.getMenuConfig();cfg.hostId=this.id;cfg.hostElement=itemInfo.menuNode;cfg.isHostedWithin=false;cfg.hostProxyCssClass="item-mn-proxy";this.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));},onclick:function onclick(evt){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),item=$DOM.findAncestorByAttr(target,"idx",true,this.domNode),level=item&&item.node.getAttribute("level"),shiftKey=$DOM.shiftKey(evt.hWin,evt.e),index=item&&item.value,popUpMenu=target.className===CSS_MENU_CLASS&&index!==null&&!isNaN(level);if(!($DOM.ctrlKey(evt.hWin,evt.e)||$DOM.metaKey(evt.hWin,evt.e)||shiftKey)){if(!popUpMenu||!this.userSelections[index]){this.clearUserSelections($H.copy(this.userSelections));}else{this.userSelections[index]=false;}}if(shiftKey){this.rangeSelect=true;}else{this.shiftStartIndex=index;}this._super(evt);if(popUpMenu){this.showMenu({data:getUserSelectedData.call(this)||this.getTreeItem(index),menuNode:target});}this.rangeSelect=false;},ondblclick:function ondblclick(evt){var $this=this,target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),targetTag=target.nodeName.toLowerCase(),item=$DOM.findAncestorByAttr(target,"idx",true,this.domNode),level=item&&item.node.getAttribute("level"),idx=item&&item.value,indices=this.selectedIndices,hook,isActionEnabled=indices[idx],itemData,tablesTreeHooks=$this.tablesTreeHooks;$this.onclick(evt);if((targetTag!==ITEM_CONTAINER_TAG)&&(targetTag!==ITEM_TAG)&&idx!==null&&!isNaN(parseInt(level,10))){itemData=this.getTreeItem(idx);if(tablesTreeHooks.isTable===undefined||tablesTreeHooks.isTable(itemData)){if(isActionEnabled){hook=tablesTreeHooks.removeItem;}else{hook=tablesTreeHooks.addItem;}if(hook){hook.call($this,item.node,itemData,level,idx,indices,this);}}}},createAvatar:function createAvatar(sourceNode){var div=document.createElement("div"),item=$DOM.findAncestorByAttr(sourceNode,INDEX_ATTR,true,this.domNode);if(item&&item.node){div.appendChild(item.node.cloneNode(true));div.appendChild(document.createElement("div"));}div.className=this.domNode.className;return div;},toggleAvatarClass:function toggleAvatarClass(cls,isAdd){$CSS.toggleClass(this.avatar,cls,isAdd);},getDragData:function getDragData(context){var sourceIndex=this.getNodeAttributes(context.src.node).index,defaultDragData=this.getTreeItem(sourceIndex),userSelections=this.userSelections;if(defaultDragData.tp===ENUM_OT_TABLE){if(userSelections[sourceIndex]===true){return getUserSelectedData.call(this)||[defaultDragData];}this.clearUserSelections($H.copy(userSelections));return[defaultDragData];}return defaultDragData;},isDragValid:function isDragValid(){return true;},ondragstart:function ondragstart(evt){this._super(evt);var dragData=evt.src.data;if(this.showTablesNum&&dragData&&dragData.length>1){this.avatar.getElementsByClassName(CSS_NAME_CLASS)[0].innerHTML=dragData.length;}},getNodeAttributes:function getNodeAttributes(node){var item=$DOM.findAncestorByAttr(node,INDEX_ATTR,true,this.domNode),level=item&&item.node.getAttribute("level");return{index:item&&item.value,level:parseInt(level,10)};},clearUserSelections:function clearUserSelections(indices){forEachItemNode.call(this,function(treeNode){var index=treeNode.getAttribute(INDEX_ATTR);if(indices[index]===true){$CSS.toggleClass(treeNode,CSS_USER_SELECT_CLASS,false);delete this.userSelections[index];}});$CSS.toggleClass(this.domNode,CSS_MULTI_SELECT_CLASS,false);}});}());