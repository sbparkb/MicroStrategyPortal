(function(){mstrmojo.requiresCls("mstrmojo.vi._MonitorsAppState","mstrmojo.Container","mstrmojo._FillsBrowser","mstrmojo._HasLayout","mstrmojo.date","mstrmojo.ui._HasUITheme","mstrmojo.ui.pathbar.PathBar","mstrmojo.css");mstrmojo.requiresDescs(3540,3541,6724,3196,14495,14496,14498,14499,14500,14501,14502);var ANNOTATIONS_TOOLBAR_HEIGHT=40,SCREENSHOT_TOOLBAR_HEIGHT=10,$DATE=mstrmojo.date,canvasContainer=annotationToolbar=waitBox=imageSrc=null;function saveAnnotations(annoCanvas){var dataURL=annoCanvas.toDataURL(),modelData=mstrApp.docModelData,dashboardName=(modelData&&modelData.n||"Annotation")+" ("+$DATE.getTimeStamp()+")";if(mstrApp.isSingleTier){var baseIndex=dataURL.indexOf(",");dataURL=dataURL.slice(baseIndex+1);window.FormWrapper.saveToLocalDisk(dataURL,".png",dashboardName);}else{var link=document.createElement("a");link.setAttribute("href",dataURL);link.setAttribute("download",dashboardName+".png");link.setAttribute("style","display: block;");var img=document.createElement("img");img.setAttribute("src",dataURL);img.setAttribute("width",annoCanvas.width);img.setAttribute("height",annoCanvas.height);link.appendChild(img);document.body.appendChild(link);link.click();setTimeout(function(){link.parentNode.removeChild(link);},200);}}function printAnnotations(annoCanvas){var dataURL=annoCanvas.toDataURL();if(mstrApp.isSingleTier){var baseIndex=dataURL.indexOf(",");dataURL=dataURL.slice(baseIndex+1);window.FormWrapper.print(dataURL);}else{var printWindow=window.open("","Print Window");printWindow.document.write("<html><head><title>Print Window</title></head><body><img src='"+dataURL+"' /></body></html>");printWindow.document.close();printWindow.focus();printWindow.print();printWindow.close();}}function emailAnnotations(annoCanvas){var dataURL=annoCanvas.toDataURL();if(mstrApp.isSingleTier){var baseIndex=dataURL.indexOf(",");dataURL=dataURL.slice(baseIndex+1);var path=window.FormWrapper.saveImageToAppFolder(dataURL);if(path!==null&&path!==""){var fullpath="file://"+path;var image=document.createElement("img");image.src=fullpath;document.body.appendChild(image);var range=document.createRange();range.selectNode(image);window.getSelection().addRange(range);document.execCommand("copy");document.body.removeChild(image);window.FormWrapper.deleteFile(path);}}}function exitAnnotations(){if(mstrApp.isSingleTier){window.FormWrapper.toggleNetMenu("enable");}canvasContainer.style.visibility="hidden";annotationToolbar.style.visibility="hidden";while(canvasContainer.firstChild){canvasContainer.removeChild(canvasContainer.firstChild);}while(annotationToolbar.firstChild){annotationToolbar.removeChild(annotationToolbar.firstChild);}if(waitBox!==null){waitBox.close();}}function getAnnotationsTooltip(name){var translatedString;switch(name){case"Undo":translatedString=mstrmojo.desc(3540,"Undo");break;case"Redo":translatedString=mstrmojo.desc(3541,"Redo");break;case"Comment":translatedString=mstrmojo.desc(6724,"Comment");break;case"Rectangle":translatedString=mstrmojo.desc(3196,"Rectangle");break;case"Arrow":translatedString=mstrmojo.desc(14495,"Arrow");break;case"Free Form":translatedString=mstrmojo.desc(14496,"Free form");break;case"Export Snapshot":translatedString=mstrmojo.desc(14498,"Export Snapshot");break;case"Print Snapshot":translatedString=mstrmojo.desc(14499,"Print Snapshot");break;case"Email Snapshot":translatedString=mstrmojo.desc(14500,"Email Snapshot");break;case"Copy to Clipboard":translatedString=mstrmojo.desc(14502,"Copy to Clipboard");break;case"Exit Annotation Mode":translatedString=mstrmojo.desc(14501,"Exit Annotation Mode");break;}return translatedString;}function createCanvasOverlay(host){canvasContainer=host.annotationsOverlayNode;annotationToolbar=host.annotationsToolbarNode;canvasContainer.style.visibility="visible";annotationToolbar.style.visibility="visible";var pathbar=host.pathbarNode;var pathbarHeight=parseInt(pathbar.style.height);var canvasTop=ANNOTATIONS_TOOLBAR_HEIGHT-SCREENSHOT_TOOLBAR_HEIGHT+pathbarHeight;canvasContainer.style.top=canvasTop+"px";canvasContainer.style.width=parseInt(host.width)+"px";canvasContainer.style.height=parseInt(host.height)-canvasTop+"px";}function showAnnotations(host){createCanvasOverlay(host);var annoOptions={width:parseInt(canvasContainer.style.width),height:parseInt(canvasContainer.style.height),borderColor:"#2bacfe",lineColor:"#cc2525",noteColor:"rgba(255,255,102,0.90)",textColor:"#333333",type:"text",img:imageSrc,lineWidth:3,fontSize:"10pt",bootstrap:false,position:"top"};$MSTR_JQUERY(host.annotationsOverlayNode).annotate(annoOptions,exitAnnotations,saveAnnotations,printAnnotations,emailAnnotations,getAnnotationsTooltip,host);if(waitBox!==null){waitBox.hide();}}function preShowAnnotations(){if(mstrApp.isSingleTier){imageSrc=window.FormWrapper.getScreenCapture();imageSrc="data:image/png;base64,".concat(imageSrc);window.FormWrapper.toggleNetMenu("disable");}waitBoxID="AnnotationWait",waitBox=mstrmojo.all[waitBoxID]||mstrmojo.insert({scriptClass:"mstrmojo.Editor",id:waitBoxID,cssClass:"mstrWaitBox",draggable:false,showTitle:false,zIndex:9,onOpen:function(){var curtainStyle=this.curtainNode.style;curtainStyle.background="black";curtainStyle.opacity=0.5;},hide:function(){this.editorNode.style.visibility="hidden";},show:function(){this.editorNode.style.visibility="visible";},position:null,children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrIcon-wait",alias:"icon"},{scriptClass:"mstrmojo.Label",cssClass:"mstrWaitMsg",text:mstrmojo.desc(11960,"Loading Data...")}]});if(!waitBox.visible){waitBox.open();waitBox.show();}}mstrmojo.vi.ui.Annotations=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.vi.ui.Annotations",id:"annotations",displayAnnotations:function displayAnnotations(host){window.setTimeout(function(){preShowAnnotations();showAnnotations(host);},50);}});}());