(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.func","mstrmojo.hash","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.gm.EnumGraphType","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.gm.EnumShape","mstrmojo.chart.model.enums.EnumDSSAxisName","mstrmojo.chart.model.enums.EnumDSSDynamicShortcut","mstrmojo.chart.model.enums.EnumDSSXMLAxesBitMap");mstrmojo.requiresClsP("mstrmojo.vi.models","DropZonesModel","GMDropZones","EnumDragSources");mstrmojo.requiresDescs(11710,11711,11712,11713,11714,11715);var $MOJO=mstrmojo,$ARR=$MOJO.array,$HASH=$MOJO.hash,$FUNC=$MOJO.func,$VI=$MOJO.vi,$DSSOBJ_TYPES=$MOJO.chart.model.enums.EnumDSSObjectType,ENUM_TARGET=$VI.models.DropZonesModel.ENUM_TARGET_POSITION,ENUM_DRAG_SOURCE=mstrmojo.vi.models.EnumDragSources,TARGET_ABOVE=ENUM_TARGET.ABOVE,TARGET_ON=ENUM_TARGET.ON,TARGET_BELOW=ENUM_TARGET.BELOW,METRIC_NAMES_VISIBLE_THRESH=1,METRIC_NAMES_ID="00000000000000000000000000000000",METRIC_NAMES_UNIT_TYPE=0,METRIC_NAMES_ITEM={n:"Metric Names",did:METRIC_NAMES_ID,t:METRIC_NAMES_UNIT_TYPE},DEBUG=false,MK_SHAPE=mstrmojo.gm.EnumShape,$SAB=mstrmojo.gm.DualAxisSubAxisBit,AXIS_PRIMARY=$SAB.PRIMARY,AXIS_SECONDARY=$SAB.SECONDARY,$GM=$MOJO.gm,$ENUM_XML_TAG=$GM.WidgetPropertyTag,ROWS=1,COLUMNS=2,XAXIS=3,YAXIS=4,BREAKBY=5,SLICEBY=6,COLORBY=7,SIZEBY=8,TOOLTIP=9,ANGLEBY=10,HORIZONTAL=11,VERTICAL=12,OTHER_ZONE_MAP={1:4,4:1,2:3,3:2},ENUM_AXIS_BIT_MAP=mstrmojo.chart.model.enums.EnumDSSXMLAxesBitMap,ENUM_AXIS_NAME=mstrmojo.chart.model.enums.EnumDSSAxisName,ENUM_DYNAMIC_SHORTCUT=mstrmojo.chart.model.enums.EnumDSSDynamicShortcut;function isAxisZone(zoneId){return zoneId===YAXIS||zoneId===XAXIS;}function reOrderColorByAttr(zoneId,gmZones){var cz=gmZones.getZoneModelByZoneId(COLORBY),sz=gmZones.getZoneModelByZoneId(SLICEBY),bz=gmZones.getZoneModelByZoneId(BREAKBY),item,fi,i,inc,actions=[],isDropZoneOrdered=function(){return[sz&&sz.items,bz&&bz.items].every(function(items){for(i=0,inc=0;items&&i<items.length;i++){item=items[i];fi=$ARR.find(cz.items,"did",item.did);if(fi!==-1&&fi<inc){return false;}inc=fi>inc?fi:inc;}return true;});},reorderElementsInDropZones=function(){[sz,bz].forEach(function(zone){for(i=0;zone&&zone.items&&i<cz.items.length;i++){item=cz.items[i];fi=$ARR.find(zone.items,"did",item.did);if(fi!==-1){actions.push(gmZones.getAddDropZoneUnitAction(zone,item,zone.items.length-1));}}});};if((zoneId===SLICEBY||zoneId===BREAKBY||zoneId===COLORBY)&&!isDropZoneOrdered()){reorderElementsInDropZones();}return actions;}function translateZone(zone,idx,edge,preferBottomZone){edge=(edge===undefined)?TARGET_ON:edge;var gmZones=this.gmZones,topZone,bottomZone,numItems,newZone,newIdx,newEdge=edge;switch(zone.id){case HORIZONTAL:case VERTICAL:bottomZone=gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?YAXIS:XAXIS);topZone=gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?ROWS:COLUMNS);if(bottomZone.items.length===0&&topZone.items.length===0){newZone=bottomZone;newIdx=0;newEdge=TARGET_ABOVE;}else{numItems=topZone.items.length;if(idx===numItems-1&&edge===TARGET_BELOW&&preferBottomZone){newZone=bottomZone;newIdx=0;newEdge=TARGET_ABOVE;}else{if(idx<numItems){newZone=topZone;newIdx=idx;}else{if(idx===numItems&&edge===TARGET_ABOVE&&!preferBottomZone){newZone=topZone;newIdx=(numItems>0)?(numItems-1):0;newEdge=TARGET_BELOW;}else{newZone=bottomZone;newIdx=idx-numItems;}}}}break;default:newZone=gmZones.getZoneModelByZoneId(zone.id);newIdx=idx;break;}return{zone:newZone,idx:newIdx,edge:newEdge};}function isItemDropAllowed(zone,dropItem,idx,context,edge){var xlated_drop=translateZone.call(this,zone,idx,edge,this.isMetric(dropItem));var result=this.gmZones.isItemDropAllowed(xlated_drop.zone,dropItem,xlated_drop.idx,context,xlated_drop.edge);if(DEBUG){window.console.log("isItemDrop: zone="+zone.id+",idx="+idx+",edge="+edge+",xzone="+xlated_drop.zone.id+",xidx="+xlated_drop.idx+",xedge="+xlated_drop.edge+",res="+result);}return result;}function isDualAxis(){var me=this,metricZone=[XAXIS,YAXIS];return metricZone.some(function(id){return me.gmZones.isDualAxis(id);});}function keepNewMetricShape(xtab,allowedItems,replacedItem){var metricShapes,replacedItemShape,newMetrics=[],me=this;$ARR.forEach(allowedItems,function(itm){if(me.isMetric(itm)){newMetrics.push(itm);}});metricShapes=xtab.readGlobalProperty($ENUM_XML_TAG.METRIC_SHAPES);replacedItemShape=metricShapes.jsonObj[replacedItem.did];if(replacedItemShape!==undefined){xtab.updateMetricShape(replacedItem);for(var i=0;i<newMetrics.length;i++){metricShapes=xtab.readGlobalProperty($ENUM_XML_TAG.METRIC_SHAPES);metricShapes.setProperty(newMetrics[i].did,replacedItemShape);xtab.setWidgetPropertyValue($ENUM_XML_TAG.METRIC_SHAPES,metricShapes.jsonObj);}}}mstrmojo.vi.models.CombineDropZonesModel=mstrmojo.declare(mstrmojo.vi.models.DropZonesModel,[mstrmojo.vi.models._DropZoneCommon],{scriptClass:"mstrmojo.vi.models.CombineDropZonesModel",dropZones:[],gmZones:null,init:function init(props){this._super(props);},getMetricCntInAxis:function getMetricCntInAxis(zone){var count=0,me=this;$ARR.forEach(zone.items,function(item){if(me.isMetric(item)){count++;}});return count;},shouldMetricNameShowIcon:function shouldMetricNameShowIcon(item,zoneId){var me=this,gmZones=this.gmZones,visGM=gmZones.getHost(),gmCtr=visGM.GMController,dualAxis=isDualAxis.call(me);if(me.isMetricName(item)){if(gmCtr.isBubbleOrScatter()){return true;}if(dualAxis){return false;}var range;if(zoneId===ROWS||zoneId===YAXIS){range=[ROWS,YAXIS];}else{if(zoneId===COLUMNS||zoneId===XAXIS){range=[COLUMNS,XAXIS];}}if(range){return !range.some(function(id){return gmZones.getMetricCntInZone(id);});}}return true;},addZoneItem:function addZoneItem(item,zoneItems,extraParas){if(!item.did){item.did=item.id;}this._super(item,zoneItems,extraParas);},getDropZones:function(){var gmZones=this.gmZones,xtabStructure=gmZones.getHostStructure(),visGM=gmZones.getHost(),gmCtr=visGM.GMController,isPie=gmCtr.isPie,breakbyDisabled=(gmCtr.chartType===mstrmojo.gm.EnumGraphType.GRID&&!gmCtr.isEmptyVis()&&!gmCtr.isEmptyBreakby()),sizebyDisabled=gmCtr.pureAreaChart,breakByZone=this.getZone(mstrmojo.desc(12173,"Break By"),BREAKBY,xtabStructure.BreakBy,breakbyDisabled,{title:mstrmojo.desc(13828)}),sizeByZone=this.getZone(mstrmojo.desc(12090,"Size By"),SIZEBY,xtabStructure.SizeBy,sizebyDisabled,{allowSingle:!gmCtr.isBubbleOrScatter(),title:mstrmojo.desc(13829)}),dropZones=[this.getZone(mstrmojo.desc(14294,"Angle"),ANGLEBY,xtabStructure.AngleBy,false,{title:mstrmojo.desc(13827)}),this.getZone(mstrmojo.desc(6188,"Slice"),SLICEBY,xtabStructure.SliceBy,false,{title:mstrmojo.desc(13828)}),this.getZone(mstrmojo.desc(2069,"Vertical"),VERTICAL,xtabStructure.Rows.concat(xtabStructure.YAxis),false,{title:mstrmojo.desc(11668)}),this.getZone(mstrmojo.desc(3691,"Horizontal"),HORIZONTAL,xtabStructure.Columns.concat(xtabStructure.XAxis),false,{title:mstrmojo.desc(11668)}),this.getZone(mstrmojo.desc(11662,"Color By"),COLORBY,xtabStructure.ColorBy,false,{title:mstrmojo.desc(11668)}),breakByZone,sizeByZone,this.getZone(mstrmojo.desc(2962,"Tooltip"),TOOLTIP,xtabStructure.AdditionalMetrics,false,{title:mstrmojo.desc(13827)})];if(!isPie){dropZones=dropZones.slice(2);}else{dropZones.splice(1,0,dropZones.splice(4,1)[0]);}this.dropZones=dropZones;this.updateBreakByAndSliceUnits();if(sizebyDisabled){sizeByZone.items.forEach(function(unit){unit.hidden=true;});}if(breakbyDisabled){breakByZone.items.forEach(function(unit){unit.hidden=true;});}var underlyingZones=gmZones.getDropZones();underlyingZones.zones.forEach(function(zn){if(zn.id===BREAKBY){breakByZone.siblings=zn.siblings;}});return{n:gmZones.getHost().defn.ttl,zones:dropZones};},getZone:function getZone(n,id,src,disabled,extraParas){var zone=this._super(n,id,src,disabled,extraParas);if(id===HORIZONTAL||id===VERTICAL){zone.cssClass=zone.cssClass+" mergedZone";}return zone;},canSwapAxis:function canSwapAxis(){return this.gmZones.canSwapAxis();},swapAxis:function swapAxis(){this.gmZones.swapAxis();},getClearAllUnitsActions:function getClearAllUnitsActions(){var actions=[],me=this;$ARR.forEach(me.gmZones.getDropZones().zones,function(zone){$ARR.forEach((zone&&zone.items)||[],function(item){actions.push(me.getRemoveDropZoneUnitAction(zone,item));});});return actions;},getClearAllUnitsUnTemplateActions:function getClearAllUnitsUnTemplateActions(){var actions=[],me=this,host=this.getHost(),gmCtr=host.GMController;gmCtr.removeGroupInfo();if(host.isXMLDirty()){actions.push(host.getPersistAction());}return actions;},getUnitMenuItems:function getUnitMenuItems(cfg,zone,item,el){if(!item){throw new Error(this.scriptClass+"::getUnitMenuItems: Item must be provided.");}var me=this,gmZones=me.gmZones,itemIsMetric=(item.t===$DSSOBJ_TYPES.DssTypeMetric&&!this.isMetricName(item)),itemAxis=(item.ax||AXIS_PRIMARY),onPrimaryAxis=(itemAxis===AXIS_PRIMARY),topZone=gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?ROWS:COLUMNS),bottomZone=gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?YAXIS:XAXIS),curZone,isMetricName=me.isMetricName(item),dualAxis=isDualAxis.call(me),bubbleOrScatter=me.getHost().GMController.isBubbleOrScatter(),metricCnt=me.getMetricCntInAxis(zone);if(isMetricName){curZone=gmZones.getZoneModelByZoneId(item.zone);}else{var xlated_zone=translateZone.call(this,zone,item._renderIdx);curZone=xlated_zone.zone;}var curValue=itemIsMetric?itemAxis:(curZone.id===bottomZone.id?AXIS_PRIMARY:AXIS_SECONDARY),zoneChangedFn=function(v,vWas,option){var wasChanged=v!==vWas,newZoneIsAxisZone=isAxisZone(option.newZone.id);if(wasChanged){me.unitsDropped(option.newZone,{src:{data:{src:ENUM_DRAG_SOURCE.VIZ_EDITOR}}},{idx:newZoneIsAxisZone?0:option.newZone.items.length,edge:newZoneIsAxisZone?TARGET_ABOVE:TARGET_BELOW,allowedItems:[item]},option.isPrimary);}return wasChanged;};if(zone.id===HORIZONTAL){if(!isMetricName||(isMetricName&&!dualAxis&&(bubbleOrScatter||(!bubbleOrScatter&&metricCnt<=0)))){cfg.addRadioMenuGroup(curValue,zoneChangedFn,[{value:AXIS_SECONDARY,text:itemIsMetric?mstrmojo.desc(11710,"Top Axis"):mstrmojo.desc(11711,"Top Column"),newZone:itemIsMetric?bottomZone:topZone,isPrimary:itemIsMetric?!onPrimaryAxis:true},{value:AXIS_PRIMARY,text:mstrmojo.desc(11712,"Bottom Axis"),newZone:bottomZone,isPrimary:true}],"checkMark");}}else{if(zone.id===VERTICAL){var radioMenuItems=[];if(!isMetricName||(isMetricName&&!dualAxis&&(bubbleOrScatter||(!bubbleOrScatter&&metricCnt<=0)))){if(!itemIsMetric){radioMenuItems.push({value:AXIS_SECONDARY,text:mstrmojo.desc(11714,"Left Row"),newZone:topZone,isPrimary:true});}radioMenuItems.push({value:AXIS_PRIMARY,text:mstrmojo.desc(11715,"Left Axis"),newZone:bottomZone,isPrimary:true});}if(itemIsMetric){radioMenuItems.push({value:AXIS_SECONDARY,text:mstrmojo.desc(11713,"Right Axis"),newZone:bottomZone,isPrimary:!onPrimaryAxis});}cfg.addRadioMenuGroup(curValue,zoneChangedFn,radioMenuItems,"checkMark");}}if(!this.isMetricName(item)&&(zone.id===HORIZONTAL||zone.id===VERTICAL)){cfg.addSeparator();}return this.gmZones.getUnitMenuItems(cfg,curZone,item,el);},getDynamicBreakByAxisOptions:function(useAsMenuOptions){var host=this.getHost(),gmCtr=host.GMController,entries=[];if(gmCtr.getAttributesOnDropZone("Rows").length){entries.push({n:useAsMenuOptions?mstrmojo.desc(3326,"By Columns"):mstrmojo.desc(122,"Columns"),axes_bitmap:ENUM_AXIS_BIT_MAP.DssXmlAxisRowsBit,dmy:"@cols"});}if(gmCtr.getAttributesOnDropZone("Columns").length){entries.push({n:useAsMenuOptions?mstrmojo.desc(3327,"By Rows"):mstrmojo.desc(2968,"Rows"),axes_bitmap:ENUM_AXIS_BIT_MAP.DssXmlAxisColumnsBit,dmy:"@rows"});}if(gmCtr.getAttributesOnDropZone("Rows").length||gmCtr.getAttributesOnDropZone("Columns").length){entries.push({n:useAsMenuOptions?mstrmojo.desc(13283,"By Cell"):mstrmojo.desc(13399,"Cell"),axes_bitmap:ENUM_AXIS_NAME.DssAxisDynamicShortcutRoot+ENUM_DYNAMIC_SHORTCUT.DssDynamicShortcutCell,dmy:"@cell"});}if(gmCtr.getAttributesOnDropZone("BreakBy").length){entries.push({n:useAsMenuOptions?mstrmojo.desc(13284,"By Shape"):mstrmojo.desc(2923,"Shape"),axes_bitmap:ENUM_AXIS_NAME.DssAxisDynamicShortcutRoot+ENUM_DYNAMIC_SHORTCUT.DssDynamicShortcutShape,dmy:"@shape"});}return entries;},filterAllowItems:function filterAllowItems(allowedItems,con,metricCnt,attrCnt){var i,isMetric;if(metricCnt>0&&attrCnt>0){for(i=allowedItems.length-1;i>=0;i--){isMetric=this.isMetric(allowedItems[i]);if((isMetric&&con)||(!isMetric&&!con)){allowedItems.splice(i,1);}}}if(allowedItems.length>1&&this.isMetric(allowedItems[0])){allowedItems.splice(1,allowedItems.length-1);}return allowedItems;},allowDropOnTarget:function allowDropOnTarget(targetId,info){var xlated_drop=translateZone.call(this,this.getZoneModelByZoneId(info.srcZoneId),info.itemIdx),xlated_info=$HASH.copy(info);xlated_info.srcZoneId=xlated_drop.zone.id;xlated_info.itemIdx=xlated_drop.idx;return this.gmZones.allowDropOnTarget(targetId,xlated_info);},getAllowDropInfo:function getAllowDropInfo(zone,dragItems,idx,edge,context){var info=this._super(zone,dragItems,idx,edge,context),allowedItems=info.allowedItems,me=this,i,attCnt=0,metricCnt=0,metricnameCnt=0,unitCount={},srcZone=context.src.data.src,angByEnabled=this.gmZones.getZoneModelByZoneId(ANGLEBY)!==undefined;unitCount[XAXIS]=me.gmZones.getMetricCntInZone(XAXIS);unitCount[YAXIS]=me.gmZones.getMetricCntInZone(YAXIS);if(angByEnabled){unitCount[ANGLEBY]=this.gmZones.getItemCountInZone(ANGLEBY);}$ARR.forEach(allowedItems,function(itm){if(me.isMetric(itm)){metricCnt++;}else{if(me.isMetricName(itm)){metricnameCnt++;}else{attCnt++;}}});if(metricCnt>0&&metricnameCnt>0&&zone.id!==srcZone){var targZone=zone;if(zone.id===VERTICAL||zone.id===HORIZONTAL){targZone=this.gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?YAXIS:XAXIS);if(srcZone===COLUMNS||srcZone===ROWS){srcZone=this.gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?XAXIS:YAXIS);}}unitCount[targZone.id]+=metricCnt;unitCount[srcZone.id]-=metricCnt;$ARR.forEach(allowedItems,function(itm,idx){if(me.isMetricName(itm)&&!(unitCount[XAXIS]>1||unitCount[YAXIS]>1||unitCount[ANGLEBY]>1)){allowedItems.splice(idx,1);}});}if(metricCnt>0&&attCnt>0&&(zone.id===HORIZONTAL||zone.id===VERTICAL)){if(edge===ENUM_TARGET.ON){var targetItem=zone.items[idx];if(this.isMetricName(targetItem)){info.allowedItems=[];}}return info;}else{if(allowedItems.length>1&&(metricCnt>=1||attCnt>=1)&&zone.id===COLORBY){if(this.getItemCountInZone(COLORBY)===0){var acceptAtt=(attCnt+metricnameCnt>=metricCnt);allowedItems=this.filterAllowItems(allowedItems,acceptAtt,metricCnt,attCnt+metricnameCnt);return info;}var isAttr=this.isAttrCategory(zone.items[0])||this.isMetricName(zone.items[0]);allowedItems=this.filterAllowItems(allowedItems,isAttr,metricCnt,attCnt+metricnameCnt);return info;}}for(i=allowedItems.length-1;i>=0;i--){if(!isItemDropAllowed.call(me,zone,allowedItems[i],idx,context,edge)){allowedItems.splice(i,1);}}return info;},getAvatarIconClass:function getAvatarIconClass(){var gmZones=this.gmZones,visGM=gmZones.getHost(),chtInfo=visGM.getChartInfo();if(chtInfo.isCombo){return"viGMCombo";}if(chtInfo.isPie){return"viGMPie";}if(chtInfo.isBubbleOrScatter){return"viGMBubble";}if(chtInfo.isABL){var sp=chtInfo.shape;if(sp===MK_SHAPE.BAR){return"viGMBar";}if(sp===MK_SHAPE.LINE){return"viGMLine";}if(sp===MK_SHAPE.AREA){return"viGMArea";}return"viGMLine";}return"viGMCombo";},shouldAddMetricCount:function shouldAddMetricCount(zoneItems,dropItem,edge,idx){var cnt=1,itemOccur=this.gmZones.hGetItemOccurrence(METRIC_NAMES_ITEM,[BREAKBY]);zoneItems.forEach(function(item){if(item.did===dropItem.did){cnt=0;}});if(edge===TARGET_ON&&itemOccur.length&&zoneItems[idx].did===dropItem.did){cnt=-1;}return cnt;},processDualAxis:function processDualAxis(zone,item){var flag=0,me=this,xAxis=me.gmZones.getZoneModelByZoneId(XAXIS),yAxis=me.gmZones.getZoneModelByZoneId(YAXIS),actions=[],dualAxis,axisZone=zone===XAXIS?xAxis:yAxis,posAxisZone=axisZone===xAxis?yAxis:xAxis,posZoneId=zone===XAXIS?YAXIS:XAXIS,isPosZoneContainMetric=me.gmZones.getMetricCntInZone(posZoneId);if(isPosZoneContainMetric){$ARR.forEach(axisZone.items,function(itm){if(me.isMetric(itm)&&itm.id!==item.id&&itm.ax!==item.ax){flag=1;actions.push(me.gmZones.getAddDropZoneUnitAction(axisZone,itm,itm.idx,{isPrimary:item.ax===0?true:false}));}});}if(flag!==1){dualAxis=me.gmZones.isDualAxis(posZoneId);if(dualAxis){$ARR.forEach(posAxisZone.items,function(itm){if(itm.id!==item.id&&itm.ax===1){actions.push(me.gmZones.getAddDropZoneUnitAction(posAxisZone,itm,itm.idx,{isPrimary:true}));}});}}return actions;},getUnitDroppedActions:function getUnitDroppedActions(zone,context,item,idx,edge,isPrimary,splitMetric,pivotMetricNameTo){var me=this,gmZones=this.gmZones,xlated_drop=translateZone.call(this,zone,idx,edge,this.isMetric(item)),dragSrc=context.src.data.src,actions=[],isMetric=me.isMetric(item);if(context&&(dragSrc===ENUM_DRAG_SOURCE.DATASETS||dragSrc===ENUM_DRAG_SOURCE.VIZ_EDITOR)&&!isItemDropAllowed.call(me,zone,item,idx,context,edge)){return actions;}if(DEBUG){window.console.log("unitDropped: zone="+zone.id+", idx="+idx+", edge="+edge+", xzone="+xlated_drop.zone.id+", xidx="+xlated_drop.idx+", xedge="+xlated_drop.edge);}if(!item.did){item.did=item.id;}if(zone.id===VERTICAL||zone.id===HORIZONTAL){var bottomZone=gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?YAXIS:XAXIS),topZone=gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?ROWS:COLUMNS),bottomIsMetricZone=gmZones.isMetricZone(bottomZone.id),showMetricName=false,itemToMove;if((xlated_drop.zone.id===bottomZone.id)&&bottomZone.id!==item.zone&&!bottomIsMetricZone&&edge!==TARGET_ON&&!this.isMetricName(item)&&!this.isMetric(item)){$ARR.forEach(bottomZone.items,function(itm){if(!me.isMetricName(itm)&&itm.did!==item.did){itemToMove=itm;return false;}});if(itemToMove){actions.push(gmZones.getAddDropZoneUnitAction(topZone,itemToMove,topZone.items.length));bottomZone.items.splice($ARR.indexOf(bottomZone.items,itemToMove),1);if(xlated_drop.idx){xlated_drop.idx--;}else{if(xlated_drop.idx===0&&xlated_drop.edge===TARGET_BELOW){xlated_drop.edge=TARGET_ABOVE;}}actions.callback=$FUNC.wrapMethods(gmZones.getUpdateCallback(),{failure:function(){topZone.items.pop();bottomZone.items=[itemToMove].concat(bottomZone.items);}});}context.metricNamesHandled=true;}if(isMetric){var angleByZone=gmZones.getZoneModelByZoneId(ANGLEBY),angleByIsMetricZone=false,angleByUnitCount=0,zoneToAddMetricName=topZone.id;if(angleByZone!==undefined){angleByIsMetricZone=this.isMetricZone(ANGLEBY);angleByUnitCount=angleByZone.items.length;}var metricCnt=0;$ARR.forEach(bottomZone.items,function(itm){if(me.isMetric(itm)){metricCnt++;}});var cnt=me.shouldAddMetricCount(bottomZone.items,item,xlated_drop.edge,idx);if(metricCnt+(cnt&&edge!==TARGET_ON?1:0)>METRIC_NAMES_VISIBLE_THRESH){showMetricName=true;}if(context.dndGM&&!splitMetric&&edge!==ENUM_TARGET.ON){if(bottomZone.id===XAXIS){zoneToAddMetricName=YAXIS;}else{zoneToAddMetricName=XAXIS;}}var fakedItem=$HASH.clone(METRIC_NAMES_ITEM),occurrences=this.gmZones.hGetItemOccurrence(fakedItem,[ROWS,COLUMNS,XAXIS,YAXIS,COLORBY,BREAKBY,SLICEBY]);if(occurrences.length===0){actions=actions.concat(gmZones.getUpdateMetricNameUnitActions(showMetricName,zoneToAddMetricName));context.metricNamesHandled=true;}else{context.metricNamesHandled=false;}}}actions=actions.concat(gmZones.getUnitDroppedActions(item,xlated_drop.zone,context,xlated_drop.idx,xlated_drop.edge,isPrimary,splitMetric,pivotMetricNameTo));if(isMetric&&(zone.id===VERTICAL||zone.id===HORIZONTAL)){var bottZone=gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?YAXIS:XAXIS);if(bottZone.id===XAXIS){actions=actions.concat(me.processDualAxis(XAXIS,item));}else{if(bottZone.id===YAXIS){actions=actions.concat(me.processDualAxis(YAXIS,item));}}}if(isMetric&&context.src.data.src===mstrmojo.vi.models.EnumDragSources.VIZ){if(zone.id===XAXIS){actions=actions.concat(me.processDualAxis(XAXIS,item));}else{if(zone.id===YAXIS){actions=actions.concat(me.processDualAxis(YAXIS,item));}}}return actions;},unitsDropped:function unitsDropped(zone,context,dropInfo,isPrimary,splitMetric,pivotMetricNameTo){var gmZones=this.gmZones,executeActions=context.actions||[],actions=[],action,idx=dropInfo.idx,edge=dropInfo.edge,allowedItems=dropInfo.allowedItems,me=this,i,xtab=$MOJO.all[this.hostId],handled=false,newEdge,oldCombined=isDualAxis.call(this);if(zone.id===VERTICAL||zone.id===HORIZONTAL){if(this.isMetric(zone.items[idx])&&isPrimary===undefined){if(edge===TARGET_ON){isPrimary=(zone.items[idx].ax===0);}else{if(allowedItems.length>0&&this.isMetric(allowedItems[0])&&allowedItems[0].ax!==undefined){isPrimary=(allowedItems[0].ax===0);}}}}if(edge===TARGET_ON&&this.isMetric(zone.items[idx])){keepNewMetricShape.call(this,xtab,allowedItems,zone.items[idx]);}actions=actions.concat(reOrderColorByAttr(zone.id,gmZones));if(allowedItems.length>1&&(zone.id===HORIZONTAL||zone.id===VERTICAL)){var allowedMetrics=[],allowedAttributes=[];$ARR.forEach(allowedItems,function(itm){if(me.isMetric(itm)){allowedMetrics.push(itm);}else{allowedAttributes.push(itm);}});if(allowedMetrics.length>0&&allowedAttributes.length>0){var xlated_drop=translateZone.call(this,zone,idx,edge,false),insertZone=xlated_drop.zone,appendZone=gmZones.getZoneModelByZoneId(OTHER_ZONE_MAP[insertZone.id]),insertUnits=(insertZone.id===XAXIS||insertZone.id===YAXIS)?allowedMetrics:allowedAttributes,appendUnits=(appendZone.id===XAXIS||appendZone.id===YAXIS)?allowedMetrics:allowedAttributes,fnNeedAdjustForMetricNames=function(item,zone){return me.isAttrCategory(item)&&me.isMetricName(zone.items[zone.items.length-1]);};idx=xlated_drop.idx;edge=xlated_drop.edge;if(fnNeedAdjustForMetricNames(insertUnits[0],insertZone)&&(idx>=insertZone.items.length-1)){idx-=1;}insertUnits.forEach(function(itm,itmIdx){newEdge=(itmIdx!==0?TARGET_BELOW:edge);action=me.getUnitDroppedActions(insertZone,context,itm,idx,newEdge,true,splitMetric);idx+=(action.length>0&&newEdge===TARGET_BELOW?1:0);actions=actions.concat(action);});idx=appendZone.items.length-1;if(fnNeedAdjustForMetricNames(appendUnits[0],appendZone,idx)){idx-=1;}appendUnits.forEach(function(itm){action=me.getUnitDroppedActions(appendZone,context,itm,idx++,TARGET_BELOW,true,splitMetric);actions=actions.concat(action);});handled=true;}}if(!handled){for(i=0;i<allowedItems.length;i++){newEdge=(i!==0?TARGET_BELOW:edge);action=me.getUnitDroppedActions(zone,context,allowedItems[i],idx,newEdge,isPrimary,splitMetric,pivotMetricNameTo);idx+=(action.length>0&&newEdge===TARGET_BELOW?1:0);actions=actions.concat(action);}}var newCombined=isDualAxis.call(this);var colorByZone=gmZones.getZoneModelByZoneId(COLORBY);if(!oldCombined&&newCombined&&colorByZone!==undefined&&colorByZone.items.length===0){actions=actions.concat(gmZones.getUpdateMetricNameUnitActions(true,COLORBY));}var dataService=this.docModel.getDataService(),nodeKey=xtab.k,callbacks=$FUNC.wrapMethods({success:function(){xtab.resetXMLDirtyFlag();}},xtab.controller._getXtabCallback(xtab)),updAct=dataService.getUpdateTemplateAction(nodeKey,actions);var prNodes=updAct.partialRetrieval.nodes;callbacks=$FUNC.wrapMethods(context.callback,callbacks);updAct.partialRetrieval.nodes=prNodes.concat(this.docModel.getSourceFilterKeys(nodeKey));executeActions.push(updAct);if(xtab.isXMLDirty()){executeActions.push(xtab.getPersistAction());}this.checkAndWarnLargeItemsForAddUnits(allowedItems,function(){xtab.controller.submitUndoRedoUpdates(executeActions,null,callbacks);});},getRemoveDZUnitAction:function getRemoveDZUnitAction(zone,idx){var xlated_drop=translateZone.call(this,zone,idx);return this.gmZones.getRemoveDZUnitAction(xlated_drop.zone,xlated_drop.idx);},getClearDZUnitActions:function getClearDZUnitActions(zone,skipMetricName){var gmZones=this.gmZones,actions=[];switch(zone.id){case HORIZONTAL:actions.concat(gmZones.getClearDZUnitActions(gmZones.getZoneModelByZoneId(COLUMNS),skipMetricName));actions.concat(gmZones.getClearDZUnitActions(gmZones.getZoneModelByZoneId(XAXIS),skipMetricName));break;case VERTICAL:actions.concat(gmZones.getClearDZUnitActions(gmZones.getZoneModelByZoneId(ROWS),skipMetricName));actions.concat(gmZones.getClearDZUnitActions(gmZones.getZoneModelByZoneId(YAXIS),skipMetricName));break;default:actions=gmZones.getClearDZUnitActions(zone,skipMetricName);break;}return actions;},getAddDZUnitAction:function(zone,item,idx,isPrimary){var gmZones=this.gmZones;return gmZones.getAddDropZoneUnitAction(zone,item,idx,{isPrimary:isPrimary});},moveAttributesToZone:function moveAttributesToZone(sourceZoneId,targetZoneId){return this.gmZones.moveAttributesToZone(sourceZoneId,targetZoneId);},deleteItem:function deleteItem(zone,idx){var xlated_drop=translateZone.call(this,zone,idx);this.gmZones.deleteItem(xlated_drop.zone,xlated_drop.idx,METRIC_NAMES_VISIBLE_THRESH-1);},deleteItems:function(zone,items){this.gmZones.deleteItems(items,METRIC_NAMES_VISIBLE_THRESH-1);},getHostModel:function(){return this.gmZones.getHostModel();},getMultiUnitsMenuItems:function getMultiUnitsMenuItems(cfg,zone,items){var id=this.id;if(mstrmojo.vi.ui.DatasetUnitMenuUtils.getMultiSelectionShortcutMetricFunctions(items).length){var targetedZone=zone;if(zone.id===VERTICAL||zone.id===HORIZONTAL){targetedZone=this.gmZones.getZoneModelByZoneId((zone.id===VERTICAL)?YAXIS:XAXIS);}cfg.addSubMenuItem(mstrmojo.desc(5188,"Calculation"),"",this.id,function(){return mstrmojo.all[id].getMultipleMetricsCalcMenus(targetedZone,items,true);});}cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){mstrmojo.all[id].deleteItems(zone,items);});},addUnitsFromDataSource:function addUnitsFromDataSource(items,datasetId,actions,cb){this.gmZones.addUnitsFromDataSource(items,datasetId,actions,cb);},getHighlightTargets:function getHighlightTargets(zonesSource,dropInfo){var transZone=translateZone.call(this,zonesSource,dropInfo.idx,dropInfo.edge),zone=transZone.zone,res,topZone,numItems;if(zone.id===XAXIS||zone.id===YAXIS){topZone=this.gmZones.getZoneModelByZoneId((zonesSource.id===VERTICAL)?ROWS:COLUMNS);numItems=topZone.items.length;res=this.gmZones.getHighlightTargets(zone,numItems,{allowedItems:dropInfo.allowedItems,idx:transZone.idx,edge:transZone.edge});}var needAllHighlight=(this.isAttrCategory(dropInfo.item)&&this.isMetric(zonesSource.items[dropInfo.idx]))||(this.isMetric(dropInfo.item)&&(this.isAttrCategory(zonesSource.items[dropInfo.idx])||this.isMetricName(zonesSource.items[dropInfo.idx])));if(zonesSource.id===COLORBY&&zonesSource.items.length&&needAllHighlight){res=[];zonesSource.items.forEach(function(item,ix){res.push({idx:ix,edge:dropInfo.edge});},this);return res;}if(!res){return this._super(zonesSource,dropInfo);}return res;}});}());