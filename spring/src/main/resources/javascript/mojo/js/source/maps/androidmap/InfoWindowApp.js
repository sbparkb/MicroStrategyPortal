(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.Container","mstrmojo.Label","mstrmojo.hash","mstrmojo.func","mstrmojo.dom","mstrmojo.android.Dialog","mstrmojo.MobileDoc","mstrmojo.MobileDocBuilder","mstrmojo.DocModel","mstrmojo.MobileConfiguration","mstrmojo._CanSupportOfflineTransactions","mstrmojo._CanMakeServerProxyRequests");var $DOM=mstrmojo.dom,dialogs=[];function handleError(res,app){var msg=[],map={name:"Exception",message:"Error",sourceURL:"Source URL",fileName:"File",lineNumber:"Line",line:"Line",method:"Method"};res=res||{};mstrmojo.hash.forEach(map,function(v,n){if(n in res){msg.push(v+": "+res[n]);}});if(res.getResponseHeader){msg.push("XHR: "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}msg=msg.join("\n");if(app&&app.rootView){app.rootView.hideMessage();}if(!res.handledError&&msg.length>0){mstrmojo.alert(msg);res.handledError=true;}mstrmojo.dbg(res.stack||msg);}function onWindowError(errMsg,fName,lineNum){handleError({message:errMsg,fileName:fName,lineNumber:lineNum});}function _getDocParams(dd){return{ab:dd.ab,did:dd.did,st:dd.st,ttl:dd.ttl};}function _getDocModel(dd){return{mid:dd.mid,bs:dd.bs,ci:dd.ci,defn:dd.defn,currlaykey:dd.currlaykey,data:dd.data};}mstrmojo.maps.androidmap.InfoWindowApp=mstrmojo.declare(mstrmojo.Obj,[mstrmojo._CanSupportOfflineTransactions],{scriptClass:"mstrmojo.maps.androidmap.InfoWindowApp",init:function init(props){this._super(props);var fn=window.onerror;window.onerror=(fn)?mstrmojo.func.composite([onWindowError,fn]):onWindowError;this.handleError=handleError;},start:function start(){var descriptors=eval(String(mstrMobileApp.getResourceBundleJson()));if(descriptors&&descriptors!==""){mstrmojo.populateDescriptors(descriptors);}if(!this.onMobileDevice()){mstrMobileApp.saveConfiguration(mstrMobileApp.getConfiguration());}mstrMobileApp.setBinaryFormat(this.getConfiguration().getBinaryMode());this.useBinaryFormat=mstrMobileApp.useBinaryFormat();mstrApp.oflnTxModel=new mstrmojo.OfflineTransactionModel();var vw=this.rootView=new mstrmojo.Container({id:"rootView",placeholder:this.placeholder,markupString:'<div id="{@id}" style="{@cssText}"><div></div><div></div></div>',markupMethods:{onvisibleChange:function(){this.domNode.style.display=(this.visible)?"block":"none";}},markupSlots:{containerNode:function(){return this.domNode.firstChild;},msgNode:function(){return this.domNode.lastChild;}},children:[{scriptClass:"mstrmojo.Container",slot:"containerNode",alias:"rootContainer",markupString:"<div></div>"},{scriptClass:"mstrmojo.Label",alias:"msg",slot:"msgNode",text:"Loading...",visible:true}],getContentDimensions:function getContentDimensions(){var contentChild=this.containerNode;return{h:parseInt(contentChild.height,10),w:parseInt(contentChild.width,10)};},showMessage:function(text){var msg=text||this.msg.text,msgNode=this.msg.domNode,msgNodeStyle=msgNode.style;msgNode.innerText=msg;msgNodeStyle.display="block";msgNodeStyle.opacity=1;},hideMessage:function hideMessage(){this.msg.domNode.style.opacity=0;}});vw.render();var ctlr=this.rootController=new mstrmojo.maps.androidmap.InfoWindowRootController({id:"rootController",firstView:vw}),dd=this.getDocData(),docParams=_getDocParams(dd),docModel=_getDocModel(dd);ctlr.start({placeholder:vw.id,parent:this,docParams:docParams,docModel:docModel,gridProps:this.getGridProp(),sc:this.sc});vw.set("visible",false);},onLink:function onLink(params){if(mapProxy&&mapProxy.sendControllerAction){mapProxy.sendControllerAction("onLink",JSON.stringify(params));}},onDrill:function(params){if(mapProxy&&mapProxy.sendControllerAction){mapProxy.sendControllerAction("onDrill",JSON.stringify(params));}},clearContent:function clearContent(){var iw=document.getElementById("mainInfoWindow");iw.style.visibility="hidden";},loadNewDoc:function(){mstrmojo.hash.forEach(mstrmojo.all,function(item){item.destroy();});this.start();},getDocData:function(){return eval("("+mapDataObj.getDocData()+")");},getGridProp:function(){return eval("("+mapDataObj.getGridProp()+")");},getConfiguration:function getConfiguration(){if(!this._cfg){this._cfg=new mstrmojo.MobileConfiguration();}return this._cfg;},showMessage:function showMessage(msg){this.rootView.showMessage(msg);},hideMessage:function hideMessage(){this.rootView.hideMessage();},onMobileDevice:function onMobileDevice(){return !mstrApp.isHosted();},isTouchApp:function isTouchApp(){return($DOM.isIPad||$DOM.isAndroid||mstrApp.onMobileDevice());},onerror:function onerror(res){handleError(res,this);},getScreenDimensions:function getScreenDimensions(){var deviceDimensions=String(mstrMobileApp.getScreenDimensions()).split("|");return{h:parseInt(deviceDimensions[0],10),w:parseInt(deviceDimensions[1],10)};},showDialog:function showDialog(dialogConfig){if(mapProxy&&mapProxy.fullScreenInfoWindow){mapProxy.fullScreenInfoWindow();}dialogConfig.scriptClass=dialogConfig.scriptClass||"mstrmojo.android.Dialog";var me=this,cfg=mstrmojo.func.wrapMethods(dialogConfig,{onClose:function(){if(mapProxy&&mapProxy.restoreInfoWindow){mapProxy.restoreInfoWindow();}dialogs.pop();}});var d=dialogs[dialogs.push(mstrmojo.insert(cfg))-1];d.render();return d;},showPopup:function showPopup(popupConfig,anchor){popupConfig.scriptClass=popupConfig.scriptClass||"mstrmojo.android.Popup";if(anchor){popupConfig.anchor=anchor;}return this.showDialog(popupConfig);},closeDialog:function closeDialog(noForwarding){if(dialogs.length){dialogs[dialogs.length-1].close();return true;}return false;},doAfterAnimation:function doAfterAnimation(foo){foo();},serverRequest:function serverRequest(params,callback,config){if(callback&&callback.proxy){var arr=[params,{},config,callback.proxy];mapProxy.sendDocModelCommand(JSON.stringify({method:"anonymous",params:arr}));}},isHosted:function isHosted(){return mstrMobileApp.isProxy;},closeAllDialogs:mstrmojo.emptyFn,isHosted:function isHosted(){return mstrMobileApp.isProxy;}});}());