(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.dom","mstrmojo.Label","mstrmojo.TextArea","mstrmojo.warehouse.dbroles.DBRoleHelper","mstrmojo.warehouse.dbroles.DBRoleSettingCheckbox","mstrmojo.warehouse.dbroles.DBRoleSettingPulldown");mstrmojo.requiresDescs(14036,14037,14038,14467);var $A=mstrmojo.array,$H=mstrmojo.hash,$DBHLP=mstrmojo.warehouse.dbroles.DBRoleHelper,MSTR_CUSTOM_SETTING="MSTR_CUSTOM=true;",STR_SHOW_CONNECTION_STRING=mstrmojo.desc(14036,"Show connection string"),STR_HIDE_CONNECTION_STRING=mstrmojo.desc(14037,"Hide connection string"),STR_EDIT_CONNECTION_STRING=mstrmojo.desc(14038,"Edit connection string");mstrmojo.warehouse.dbroles.DBRoleSettingConnectionStringEditor=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSettingConnectionStringEditor",cssClass:"mstrmojo-wh-DBRoleSettingConnectionStringEditor",enabled:true,getValue:function getValue(){if(this.visibleContents&&this.enabledContents){var txt=this.contents.connectionArea.value;return $DBHLP.cleanDSNConnection(txt+(txt.slice(-1)===";"?"":";")+MSTR_CUSTOM_SETTING);}return"";},setValue:function setValue(connectionString){var c=this.contents;this.toggleContents();c.editString.setValue(true);c.connectionArea.set("value",$DBHLP.cleanDSNConnectionPlaceHolders(connectionString).replace(MSTR_CUSTOM_SETTING,""));},isValid:function isValid(){return{val:true,msg:""};},connectionArea:undefined,driverList:undefined,showLabel:undefined,editString:undefined,info:{},drivers:[],enableFn:mstrmojo.emptyFn,generateConnectionStringFn:mstrmojo.emptyFn,dbID:{},dbms:{},load:function load(){var c=this.contents,dbID=this.dbID,dbms=this.dbms,dbversion=dbID.dbVersions[$A.find(dbID.dbVersions,"v",dbms.db_ver)],connection=dbversion.connections[0],driverInfo=$DBHLP.driverExists.call(this,[connection]),allDrivers={},drivers=[];$A.forEach(this.dbIDVersions,function(dbIDVersion){$A.forEach(dbIDVersion.dbVersions,function(dbVersion){$A.forEach(dbVersion.connections.concat(dbVersion.altconnections),function(connection){allDrivers[connection.driver]=connection;});});});var driverCopy;$H.forEach(this.drivers,function(driver){driverCopy=mstrmojo.hash.clone(driver);if(allDrivers[driver.n]){driverCopy.n=driverCopy.n+" (Certified)";driverCopy.title=driverCopy.n;driverCopy.str=allDrivers[driver.n].str;}drivers.push(driverCopy);});c.driverList.set("items",drivers);if(driverInfo.exists){var index=$A.find(this.drivers,"n",driverInfo.driver);if(index<0){index=0;}c.driverList.set("selectedID",drivers[index].n);}this.updateString();},visibleContents:false,enabledContents:false,toggleContents:function toggleContents(){this.visibleContents=!this.visibleContents;this.contents.set("visible",this.visibleContents);this.showLabel.set("text",(this.visibleContents?STR_HIDE_CONNECTION_STRING:STR_SHOW_CONNECTION_STRING));if(!this.visibleContents){this.contents.editString.setValue(false);this.enableFn(true);}else{this.load();}},updateString:function updateString(){if(this.visibleContents){this.contents.connectionArea.set("value",$DBHLP.cleanDSNConnectionPlaceHolders(this.generateConnectionStringFn()));}},children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-wh-DBRoleConnection-ShowConnection",alias:"showLabel",text:STR_SHOW_CONNECTION_STRING,onclick:function onclick(){this.parent.toggleContents();}},{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-wh-DBRoleConnection-ConnectionStringContents",alias:"contents",visible:false,children:[{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSettingCheckbox",label:STR_EDIT_CONNECTION_STRING,alias:"editString",oncheckedChange:function oncheckedChange(){var p=this.parent;p.parent.enableFn(!this.checked);p.connectionArea.set("enabled",this.checked);p.driverList.set("enabled",this.checked);p.parent.enabledContents=this.checked;}},{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSettingPulldown",cssClass:"mstrmojo-wh-DBRolePulldown mstrmojo-wh-DBRoleConnection-driverList",caption:mstrmojo.desc(14467,"Driver"),alias:"driverList",itemIdField:"n",itemField:"n",enabled:false,bindings:{visible:function(){var strEditor=this.parent.parent;return(strEditor.dbID.connType&4)!==4;}},onChange:function onChange(item){var p=this.parent.parent,c=this.parent.parent.contents,str;if(p.enabledContents){str=item.str||"";}c.connectionArea.set("value",$DBHLP.cleanDSNConnectionPlaceHolders(p.generateConnectionStringFn(str).replace(MSTR_CUSTOM_SETTING,"")));}},{scriptClass:"mstrmojo.TextArea",cssClass:"mstrmojo-wh-DBRoleConnection-ConnectionString",value:"",alias:"connectionArea",enabled:false}]}]});}());