(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.warehouse.dbroles.DBRoleHelper","mstrmojo.warehouse.dbroles.DBRoleSetting","mstrmojo.warehouse.dbroles.DBRoleSettingCheckbox","mstrmojo.warehouse.dbroles.DBRoleSettingConnectionStringEditor","mstrmojo.warehouse.dbroles.DBRoleSettingFileSelector","mstrmojo.warehouse.dbroles.DBRoleSettingGroupBox","mstrmojo.warehouse.dbroles.DBRoleSettingPulldown","mstrmojo.warehouse.dbroles.DBRoleSettingRadioButton");mstrmojo.requiresDescs(15,260,512,689,1034,2523,3332,3989,7790,7952,8517,8518,8519,8521,8522,8523,8524,8526,8528,8529,8530,8532,8533,8534,8536,8538,8539,8540,8546,8547,8548,8549,8550,8560,10055,10058,10059,10061,10064,10065,11392,11394,12308,12309,12310,12312,12313,12542,12752,12758,12997,13100,13101,13103,13104,13105,13106,13107,13108,13109,13110,13111,13112,13113,13114,13115,13116,13117,13118,13119,13121,13122,13123,13124,13125,13126,13234,13373,13531,13532,13533,13540,13541,13904,13905,13906,13907,13908,13909,13910,13944,13945,13946,13947,13948,13949,13950,13951,13952,13962,13979,13980,13981,13982,13990,14002,14005,14620,14621,14641,14685,14686,14687);var $A=mstrmojo.array,$H=mstrmojo.hash,$S=mstrmojo.string,cookie="hideUnavailableDrivers",$FULLCONNECTION="FULLCONNECTION",widget,$DBHLP=mstrmojo.warehouse.dbroles.DBRoleHelper,STR_DATABASE=mstrmojo.desc(8538,"Database:"),STR_VERSION=mstrmojo.desc(2523,"Version:"),STR_SHOW_NOT_FOUND_DSNLESS=mstrmojo.desc(13540,"Show databases whose certified drivers were not found"),STR_SHOW_NOT_FOUND_DSN=mstrmojo.desc(13990,"Show databases which are not certified for the DSNâ€™s driver"),STR_ADD_DRIVER=mstrmojo.desc(13234,"Add driver"),STR_MISSING_PARAMS=mstrmojo.desc(11392,"Missing parameters"),STR_DRIVER_NOT_FOUND=" ("+mstrmojo.desc(13541,"Certified driver not found")+")",STR_ERR_NOT_INSTALLED_ODBC=mstrmojo.desc(11394,"The ODBC driver used by this database connection is currently not installed, until that happens this connection may not work"),STR_ERR_NOT_INSTALLED_JDBC=mstrmojo.desc(14002,"The JDBC driver used by this database connection is currently not installed, until that happens this connection may not work"),STR_SELECT_DSN=mstrmojo.desc(8526,"select a dsn");function generateConnectionString(changeSpecialChars,removeEmptyParams,defaultConnectionString){var connstr,errMsg="";if(this.isDSNLess){var values={},str,children=this.contents.children,driverMode=1;if(defaultConnectionString===undefined){var db=this.dbIDSelectList.selectedItem,dbVersion=db.dbVersions[$A.find(db.dbVersions,"v",this.dbmsList.selectedItem.db_ver)],connection=dbVersion.connections[this.selectedSection],driverInfo=$DBHLP.driverExists.call(this,[connection]);if(driverInfo.exists){str=connection.str;}else{if(dbVersion.altconnections.length>0){str=dbVersion.altconnections[this.selectedSection].str;}else{str=connection.str;errMsg=STR_ERR_NOT_INSTALLED_ODBC;if(str.indexOf("JDBC;")>=0){errMsg=STR_ERR_NOT_INSTALLED_JDBC;}}}}else{str=defaultConnectionString;}$A.forEach(children,function(child){var value=child.getValue();if(child.field){if(typeof value==="string"){values[child.field]=$S.trim(value);}else{values[child.field]=value;}}if((!!value)&&child.driverMode){driverMode=child.driverMode;}});this.driverMode=driverMode;connstr=str.replace(/@([\w\d]+)/gm,function tokenRepl(token,prop){return(values.hasOwnProperty(prop)&&values[prop]!==null)?values[prop]:"";});if(removeEmptyParams){var separator="=;",idx,lfToken,token,pattern=/[\s\x28\x29\x3B]/g;do{idx=connstr.indexOf(separator);if(idx>-1){lfToken=connstr.substring(0,idx);while(pattern.test(lfToken)){idx=pattern.lastIndex;}token=lfToken.substring(idx);connstr=connstr.replace(token+separator,"");}}while(connstr.indexOf(separator)>0);}}else{connstr="DSN="+this.dsnBox.dsnList.selectedItem.n+";";}if(changeSpecialChars){connstr=$DBHLP.cleanDSNConnection(connstr);}return{str:connstr,err:errMsg};}function extractParams(templates,str){var rootController=mstrApp.rootController,xq="XQUERY",startToken="@",templatestr,idx,lfToken="",token="",tokens=[],key="",values={},separators=/[,:]/g,index=0,pattern=/[\x28\x29\x3B\x7D]|(!#)/g,endoftokenIdx,endoftokenChar="",endoftokenPattern=/[\x29\x3B\x7D\/!]/g,driver=$DBHLP.cleanDriver(str),templateDriver,bestMatch={},bestIndex=0,bestCount=0;$A.forEach(templates,function(template){templatestr=template.str;tokens=[];values={};templateDriver=$DBHLP.cleanDriver(templatestr);index++;if(templatestr.indexOf($FULLCONNECTION)===0){if(template.driver===xq){token=templatestr.replace($FULLCONNECTION+"="+xq+";"+startToken,"");var indexMac=str.indexOf(";;");if(indexMac>=0){str=str.substring(0,indexMac+1);}values[token]=str.replace(xq+";","");bestMatch=values;bestCount=rootController.getObjectCount(values);return false;}templatestr=templatestr.replace($FULLCONNECTION+"=",";");}if(driver.toUpperCase()!==templateDriver.toUpperCase()){return true;}do{idx=templatestr.indexOf(startToken);lfToken=templatestr.substring(0,idx);pattern.lastIndex=0;while(pattern.test(lfToken)){idx=pattern.lastIndex;}token=$S.trim(lfToken.substring(idx));templatestr=templatestr.replace(lfToken,"").replace(startToken,"");endoftokenPattern.test(templatestr);endoftokenIdx=endoftokenPattern.lastIndex-1;endoftokenChar=templatestr[endoftokenIdx];endoftokenPattern.lastIndex=1;key=templatestr.substring(0,endoftokenIdx).replace("@","");tokens.push({key:key,token:token,endoftokenChar:endoftokenChar});}while(templatestr.indexOf(startToken,endoftokenIdx)>0);var tkn;$A.forEach(tokens,function(token,idx){tkn=token.token;idx=str.toUpperCase().indexOf(tkn.toUpperCase());if(idx>-1){idx+=tkn.length;pattern.lastIndex=0;var strsub=str.substring(idx);var match=pattern.exec(strsub);if(match){var val=strsub.substring(0,match.index);if(strsub[match.index]!==token.endoftokenChar&&val.length){if(val[val.length-1]===token.endoftokenChar){val=val.substring(0,val.length-1);}}separators.test(val);var sep=val.substring(separators.lastIndex-1,separators.lastIndex)||",",tkns=token.key.split(sep),vals=val.split(sep);if(tkns.length===vals.length){$A.forEach(tkns,function(tk,i){values[tk]=vals[i];});}else{values[token.key]=val;}}}});if(rootController.getObjectCount(values)>bestCount){bestMatch=values;bestCount=rootController.getObjectCount(values);bestIndex=index;}return true;});bestMatch["RB"+bestIndex]=true;return bestMatch;}function extractSettingValues(valuesStr){var tokens={},values=valuesStr.split(";"),pairs=[];$A.forEach(values,function(value){pairs=value.split("=");if(pairs[0]!==""){tokens[pairs[0]]=pairs[1];}});return tokens;}function joinSettingValues(setting,tokens){var value,found,keys=[],pairs={};$A.forEach($H.keyarray(tokens),function(token){value=tokens[token];if(token){pairs[token]=token+"="+value;}else{$A.forEach($H.keyarray(pairs),function(pair){keys.push(pair);});$A.forEach(keys,function(key){found=false;$A.forEach(setting.parent.children,function(child){if(child.propfield===key){found=true;return !found;}});if(!found){delete pairs[key];}});pairs[token]=value;}});return $H.valarray(pairs).join(";");}function setSettingValue(setting,params,vldbProperties){var param,vldbValue;if(setting.field){param=params[setting.field];}else{if(setting.propset){vldbValue=vldbProperties[setting.propset][setting.prop];if(setting.propformat==="json"){param=JSON.parse(vldbValue||"{}")[setting.propfield];}else{if((setting.propformat==="text")){if(setting.propfield){param=(extractSettingValues(vldbValue||"")[setting.propfield]);}else{var fields=extractSettingValues(vldbValue||"");$A.forEach(setting.parent.children,function(child){if(child.propfield){delete fields[child.propfield];}});var tokens=[];$A.forEach($H.keyarray(fields),function(field){tokens.push(field+"="+fields[field]);});param=tokens.join(";");}}else{param=vldbValue;}}}else{$A.forEach(setting.children,function(child){setSettingValue(child,params,vldbProperties);});}}if(param){setting.setValue(param);}}function getSettingValue(setting,vldbProperties){var value,cleanValue,vldbValue,txt={},json={};if(setting.propset){value=setting.getValue();if(typeof value==="string"){cleanValue=$S.trim(value).replace(/\\/g,"\\\\");}else{cleanValue=value;}vldbValue=vldbProperties[setting.propset][setting.prop];if(setting.propformat==="json"){json=JSON.parse(vldbValue||"{}");json[setting.propfield]=cleanValue;vldbProperties[setting.propset][setting.prop]=JSON.stringify(json).replace(/\\"/g,'"');}else{if((setting.propformat==="text")){txt=extractSettingValues(vldbValue||"");txt[setting.propfield]=cleanValue;vldbProperties[setting.propset][setting.prop]=joinSettingValues(setting,txt);}else{vldbProperties[setting.propset][setting.prop]=cleanValue;}}}else{$A.forEach(setting.children,function(child){getSettingValue(child,vldbProperties);});}}function applyContents(dbInfo){if(this.info.connstr){var c=this.contents;var conn=this.info.connstr.split(";")[0],conntype=(conn.split("=")[0]).toUpperCase();switch(conntype){case"DSN":c=this.dsnBox;conn=conn.substring(conntype.length+1,conn.length);c.dsnList.set("selectedID",conn.toUpperCase());break;default:conn=$DBHLP.cleanLoadedDSNConnection(this.info.connstr,dbInfo.dbID);var db=this.supportedDBs[$A.find(this.supportedDBs,"id",dbInfo.dbID)],dbversion=db.dbVersions[$A.find(db.dbVersions,"v",dbInfo.dbver)],connections=dbversion.connections.concat(dbversion.altconnections);var params=extractParams(connections,conn);var vldb=this.info.vldbProperties;$A.forEach(c.children,function(child){setSettingValue(child,params,vldb);});if($DBHLP.isCustomConnection(conn)||mstrApp.rootController.getObjectCount(params)<=dbversion.DBPS.length){c.stringEditor.setValue(conn);}}}}function findIndex(){var infoIndex;if(this.info.connstr){var driver=$DBHLP.cleanDriver(this.info.connstr),isCustom=$DBHLP.isCustomConnection(this.info.connstr),conntype=(driver.split("=")[0]).toUpperCase(),alldbms=this.dbObjects.dbms,dbms=alldbms[$A.find(alldbms,"did",this.info.dbms)],allConnections,fnVersion=function loopVersion(dbVersions,dbid){$A.forEach(dbVersions,function(dbver){if(dbms.db_ver===dbver.v){allConnections=dbver.connections.concat(dbver.altconnections);if(driver!==""&&!isCustom){if($A.find(allConnections,"driver",driver)>=0){infoIndex={dbver:dbver.v,dbID:dbid};}}else{infoIndex={dbver:dbver.v,dbID:dbid};}}if(infoIndex){return false;}return true;});};switch(conntype){case"DSN":infoIndex={dbver:dbms.db_ver,dbID:this.dbIDs.Undefined};break;default:var dbid=parseInt(this.info.ab,10)||0;if(dbid>=0){var dbIndex=$A.find(this.supportedDBs,"id",dbid),db;if(dbIndex>=0){db=this.supportedDBs[dbIndex];fnVersion(db.dbVersions,db.id);}}if(!infoIndex){$A.forEach(this.supportedDBs,function(db){fnVersion(db.dbVersions,db.id);if(infoIndex){return false;}return true;});}if(!infoIndex){isCustom=true;$A.forEach(this.supportedDBs,function(db){fnVersion(db.dbVersions,db.id);if(infoIndex){return false;}return true;});}break;}}if(!infoIndex){infoIndex={dbID:-1};}return infoIndex;}function addGroupSettings(parent,children,groupId,addControlFn){var $this=this,settingChildren=[],clonedChild,box;box=new mstrmojo.warehouse.dbroles.DBRoleSettingGroupBox({alias:parent.alias+"groupBox"});$this.contents.addChildren([box]);$A.forEach(children,function(child){if(child.group===groupId){clonedChild=$H.clone(child);delete clonedChild.group;settingChildren.push(clonedChild);}});addControlFn.call($this,settingChildren,box.alias,box);if(parent.oncheckedChange){parent.checked=true;parent.set("checked",false);}}function addControl(DBP,parentRBAlias,container){var $this=this,children=[];$A.forEach(DBP,function(dbp){if(!!(dbp.group)){children.push(dbp);}});var addSetting;$A.forEach(DBP,function(dbp,idx){addSetting=false;if(mstrApp.isSingleTier){if((dbp.scope&2)===2){addSetting=true;}}else{if((dbp.scope&1)===1){addSetting=true;}}if(!addSetting){return ;}var setting,caption=mstrmojo.desc(dbp.IDS,dbp.n),alias="dbp"+idx,isGroup=(dbp.isgroup===1);if(caption&&caption[caption.length-1]!==":"){caption+=":";}if(dbp.group){return true;}switch(dbp.tp){case"text":setting=new mstrmojo.warehouse.dbroles.DBRoleSetting({caption:caption,alias:alias,isRequired:dbp.req,onEnter:$this.onEnterFn,onvalueChange:function ontextChange(){if(this.parent&&this.parent.stringEditor){this.parent.stringEditor.updateString();}}});break;case"number":setting=new mstrmojo.warehouse.dbroles.DBRoleSetting({caption:caption,alias:alias,isNumeric:true,isRequired:dbp.req,onEnter:$this.onEnterFn,onvalueChange:function ontextChange(){if(this.parent&&this.parent.stringEditor){this.parent.stringEditor.updateString();}}});break;case"list":var itemfield="v",pvoptions=dbp.options;if(pvoptions[0].n){itemfield="n";$A.forEach(pvoptions,function(pv){pv.n=mstrmojo.desc(pv.IDS,pv.n);});}else{$A.forEach(pvoptions,function(pv){pv.n=pv.v;});}setting=new mstrmojo.warehouse.dbroles.DBRoleSettingPulldown({caption:caption,alias:alias,itemIdField:"v",itemField:itemfield,onChange:function onChange(){if(this.parent&&this.parent.stringEditor){this.parent.stringEditor.updateString();}}});setting.render();setting.set("items",pvoptions);setting.set("selectedID",pvoptions[0].v);break;case"boolean":setting=new mstrmojo.warehouse.dbroles.DBRoleSettingCheckbox({label:caption,alias:alias,isGroup:isGroup,isNumeric:(dbp.stp&&(dbp.stp==="numeric")),driverMode:1,helpLink:dbp.help,driverModeChecked:dbp.driverMode||1,display:dbp.display,oncheckedChange:function oncheckedChange(){if(this.parent.stringEditor){this.parent.stringEditor.updateString();}this.driverMode=(this.checked?this.driverModeChecked:1);if(!this.isGroup){return ;}var visible=(this.checked&&(this.display==="onChecked"))||(!this.checked&&(this.display==="onUnChecked"));this.parent[this.alias+"groupBox"].set("visible",visible);}});break;case"file":setting=new mstrmojo.warehouse.dbroles.DBRoleSettingFileSelector({caption:caption,alias:alias,isRequired:dbp.req,selectorOption:dbp.selectorOption,onEnter:$this.onEnterFn,onvalueChange:function ontextChange(){if(this.parent&&this.parent.stringEditor){this.parent.stringEditor.updateString();}}});break;}setting.field=dbp.field;setting.parentRBAlias=parentRBAlias;setting.propset=dbp.propset;setting.prop=dbp.prop;setting.propformat=dbp.propformat;setting.propfield=dbp.propfield;if(dbp.defaultValue){setting.setValue(dbp.defaultValue);}container.addChildren([setting]);if(isGroup){addGroupSettings.call($this,setting,children,dbp.groupid,addControl);}});}function addRB(dbp,idbps,len){return new mstrmojo.warehouse.dbroles.DBRoleSettingRadioButton({label:mstrmojo.desc(dbp.IDS,dbp.n),index:idbps,alias:"RB"+idbps,count:len,field:"RB"+(idbps+1),onclick:function onclick(){var i;if(this.checked){for(i=0;i<this.count;i++){this.parent["RB"+i].set("checked",false);this.parent["RB"+i].enableChildren();}this.set("checked",true);this.enableChildren();}},oncheckedChange:function oncheckedChange(){if(this.checked){this.parent.parent.selectedSection=this.index;}}});}function buildContents(){if(!this.isDSNLess){return ;}var c=this.contents,db,dbps,$this=this;if(!c){return ;}if(c.children){c.removeChildren(null,true);}if(!this.dbmsList.selectedItem){return ;}db=this.dbIDSelectList.selectedItem||this.dbIDSelectList.items[0];var dbversion=db.dbVersions[$A.find(db.dbVersions,"v",this.dbmsList.selectedItem.db_ver)];if(!dbversion){return ;}if(!$DBHLP.driverExists.call(this,dbversion.connections).exists&&(dbversion.altDBPS.length>0)){dbps=dbversion.altDBPS;}else{dbps=dbversion.DBPS;}if(dbps&&dbps.length>1){var len=dbps.length;$A.forEach(dbps,function(dbp,idx){if(dbp.defaultSection){$this.selectedSection=idx;}var rb=addRB(dbp,idx,len);c.addChildren([rb]);addControl.call($this,dbp.DBP,rb.alias,$this.contents);});c["RB"+$this.selectedSection].checked=true;c["RB"+$this.selectedSection].onclick();}else{addControl.call($this,dbps[0].DBP,"",$this.contents);}var setting=new mstrmojo.warehouse.dbroles.DBRoleSettingConnectionStringEditor({alias:"stringEditor",drivers:$this.drivers,dbIDVersions:this.dbIDSelectList.items,info:$this.info,dbID:$this.dbIDSelectList.selectedItem,dbms:$this.dbmsList.selectedItem,enableFn:function enableContents(isEnabled){var p=this.parent.parent,sectionRB=p.contents["RB"+p.selectedSection];$A.forEach(c.children,function(child){if(!child.isGroupSetting&&!child.isGroup){child.set("enabled",isEnabled);}});if(isEnabled&&sectionRB){sectionRB.setValue(true);}},generateConnectionStringFn:function generateConnectionStringFn(defaultString){return generateConnectionString.call($this,false,false,defaultString).str.replace($FULLCONNECTION+"=","");}});c.addChildren([setting]);}function findDBMS(dbver){var alldbms=this.dbObjects.dbms;return alldbms[$A.find(alldbms,"db_ver",dbver)];}function filterDBList(){var $this=this,addDBtoList=false,dbs=this.dbObjects.supportedDBs,dbIdFilter=this.dbIdFilter||[],dbIdExcludeFilter=this.dbIdExcludeFilter||[],dsnlessdbs=[],isExcluded,isMac=(mstrApp.isSingleTier&&(navigator.platform.indexOf("Win")===-1)),isWin=(mstrApp.isSingleTier&&(navigator.platform.indexOf("Win")!==-1)),isWin32=(mstrApp.isSingleTier&&window.FormWrapper.isWin32&&window.FormWrapper.isWin32()),trimJDBC=function trimJDBC(db){if(isMac){var dbMac=$H.clone(db);dbMac.n=$S.trim(db.n.replace("(JDBC)",""));return dbMac;}if(isWin){var dbWin=$H.clone(db);dbWin.n=$S.trim(db.n.replace("(32 bit)",""));return dbWin;}return db;},ONETIER_EXCLUDE_DBTYPES=[6800,5300,5600,6600,7000];$A.forEach(dbs,function(db){addDBtoList=false;if(mstrApp.isSingleTier&&isMac&&db.dbType===100){return true;}if(mstrApp.isSingleTier){if($A.indexOf(ONETIER_EXCLUDE_DBTYPES,db.dbType)!==-1){return true;}}$A.forEach(db.dbVersions,function(dbver){if(dbver.dsnless){if(!$this.showUnavailable){$A.forEach(dbver.connections.concat(dbver.altconnections),function(dbc){if($DBHLP.driverAvailable.call($this,dbc)){addDBtoList=true;}return !addDBtoList;});}else{addDBtoList=true;}return !addDBtoList;}return !addDBtoList;});if(addDBtoList){isExcluded=false;$A.forEach(dbIdExcludeFilter,function(dbExcludedId){if(dbExcludedId===db.id){isExcluded=true;return false;}});if(!isExcluded){if(dbIdFilter.length>0){$A.forEach(dbIdFilter,function(dbFilterId){if(dbFilterId===db.id){dsnlessdbs.push(trimJDBC(db));}});}else{dsnlessdbs.push(trimJDBC(db));}}}});this.dbIDSelectList.set("items",dsnlessdbs);if(dsnlessdbs.length===0&&!$this.showUnavailable){$this.showUnavailable=true;this.driverBox.hideUnavailable.setValue(true);}}function restrictDBType(dbVersions,certifiedDSNVersions){var alldbms=this.dbObjects.dbms,dbmsList=this.dbmsList;if(dbVersions.length===0){var dsndbms,dbmsArray=this.dbObjects.dsndbms,filterObj={};if(this.cfgDbmsTypeExcludeFilter&&this.cfgDbmsTypeExcludeFilter.length>0){$A.forEach(this.cfgDbmsTypeExcludeFilter,function(dbmsType){filterObj[dbmsType]=true;});dbmsArray=$A.filter(this.dbObjects.dsndbms,function(dbms){return !filterObj[dbms.db_type];});}dsndbms=$H.cloneArray(dbmsArray);$A.forEach(certifiedDSNVersions,function(certifiedVersion){if(certifiedVersion.v>-1){var index=$A.find(dsndbms,"db_ver",certifiedVersion.v);if(index>=0){dsndbms[index].n+=" (Certified for DSN)";}}});dbmsList.set("items",dsndbms);}else{var dbmsbytype={},$this=this;$A.forEach(alldbms,function(dbms){dbms.enabled=true;if(!(dbVersions.length===1&&dbVersions[0].v===-1)){if((dbms.db_type===$this.dbTypes.Generic.v)||(dbms.db_ver===-1)){if(!$this.alwaysShowGeneric){return true;}}}$A.forEach(dbVersions,function(dbver){if(dbms.db_ver===dbver.v){if((dbver.dsnless&&$this.isDSNLess)||(!$this.isDSNLess)){var allConnections=dbver.connections.concat(dbver.altconnections);if(!$this.showUnavailable){$A.forEach(allConnections,function(dbc){if($DBHLP.driverAvailable.call($this,dbc)){dbmsbytype[dbms.did]=dbms;}return true;});}else{var isAvailable=false;$A.forEach(allConnections,function(dbc){if($DBHLP.driverAvailable.call($this,dbc)){isAvailable=true;}return !isAvailable;});if(isAvailable){dbms.title=(dbms.n.length>50)?dbms.n:"";dbmsbytype[dbms.did]=dbms;}else{var dbmscopy=mstrmojo.hash.clone(dbms);dbmscopy.n=dbmscopy.n+STR_DRIVER_NOT_FOUND;dbms.enabled=false;dbmscopy.title=(dbmscopy.n.length>50)?dbmscopy.n:"";dbmsbytype[dbmscopy.did]=dbmscopy;}}}}});});if(mstrApp.rootController.getObjectCount(dbmsbytype)===0){var dbms=findDBMS.call(this,-1);if(dbms){dbmsbytype[dbms.did]=dbms;}}dbmsList.set("items",mstrmojo.hash.valarray(dbmsbytype));}var items=dbmsList.items;if(items.length>0){if(this.info&&this.info.dbms){dbmsList.set("selectedID",this.info.dbms);}else{if(dbmsList.selectedItem&&($A.find(items,"did",dbmsList.selectedItem.did)>-1)){dbmsList.set("selectedID",dbmsList.selectedItem.did);}else{dbmsList.set("selectedID",items[0].did);}}dbmsList.onChange();}else{dbmsList.set("selectedID","");}}function populateDSNs(){var $this=this,selectDSN={n:STR_SELECT_DSN,nU:STR_SELECT_DSN.toUpperCase(),des:0};var dsns={},dbObjDSNs=$this.dbObjects.dsns,selectedDSNs=[];dsns[selectDSN.nU]=selectDSN;if($this.dbIdFilter.length===1){$A.forEach($this.supportedDBs,function(db){$A.forEach(db.dbVersions,function(dbver){$A.forEach(dbver.connections.concat(dbver.altconnections),function(conn){$A.forEach(dbObjDSNs,function(dsn){if(conn.driver===dsn.des){dsns[dsn.nU]=dsn;}return true;});});});});selectedDSNs=$H.cloneArray($H.valarray(dsns));}else{selectedDSNs=$H.cloneArray($this.dbObjects.dsns);}var excludedDSNs={};if($this.dsnDbTypeExcludeFilter&&$this.dsnDbTypeExcludeFilter.length>0){$A.forEach($this.dsnDbTypeExcludeFilter,function(dsnExcludeFilter){$A.forEach($this.dsnMapDBs,function(db){if(db.dbType===dsnExcludeFilter){$A.forEach(db.dbVersions,function(dbver){$A.forEach(dbver.connections.concat(dbver.altconnections),function(conn){$A.forEach(selectedDSNs,function(dsn){if(conn.driver===dsn.des){excludedDSNs[dsn.nU]=dsn;}return true;});});});}});});var i,index,valExcludedDsns=$H.valarray(excludedDSNs),len=valExcludedDsns.length;for(i=0;i<len;i++){index=$A.find(selectedDSNs,"nU",valExcludedDsns[i].nU);if(index>=0){selectedDSNs.splice(index,1);}}}this.dsnBox.dsnList.set("items",selectedDSNs);this.onisDSNLessChange();}mstrmojo.warehouse.dbroles.DBRoleDSNConnection=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleDSNConnection",cssClass:"mstrmojo-wh-DBRoleDSNConnection",postCreate:function postCreate(){var dbObjects=mstrApp.rootController.getDBObjects();this.dbObjects=dbObjects;this.dbTypes=dbObjects.dbTypes;this.dbIDs=dbObjects.dbIDs;this.dbVersions=dbObjects.dbVersions;this.supportedDBs=dbObjects.supportedDBs;this.dsnMapDBs=dbObjects.dsnMapDBs;this.drivers=dbObjects.drivers;this.preferences=dbObjects.preferences;},onEnterFn:mstrmojo.emptyFn,info:undefined,oninfoChange:function oninfoChange(){var str=this.info.connstr;if(str&&(str.substring(0,1)===";")){this.info.connstr=this.info.connstr.replace(";","");}filterDBList.call(this);var idx=findIndex.call(this);var wls=window.localStorage,c=(wls&&wls.getItem(cookie));this.driverBox.hideUnavailable.setValue((c?(c==="1"):false));if((mstrApp.rootController.getObjectCount(this.info)>0)&&(this.info.did!=="")&&($A.find(this.dbIDSelectList.items,"id",idx.dbID)<0)){this.driverBox.hideUnavailable.setValue(true);}if(this.isDSNLess){this.dbIDSelectList.set("selectedID",idx.dbID);this.dbmsList.set("selectedID",this.info.dbms);}else{if(this.info.n){populateDSNs.call(this);}}applyContents.call(this,idx);this.driverBox.hideUnavailable.set("visible",!this.hideDriverCheck);},selectedSection:0,isDSNLess:undefined,dbIdFilter:[],dbIdExcludeFilter:[],dsnDbTypeExcludeFilter:[],driverMode:1,singleType:false,onisDSNLessChange:function onisDSNLessChange(){var dbList=this.dbIDSelectList,box=this.dsnBox,dsnList=box.dsnList,connstr=this.info&&this.info.connstr,conn,conntype,selDSN;if(this.isDSNLess){dbList.set("selectedItem",null);dbList.set("selectedID",this.supportedDBs[0].id);this.driverBox.hideUnavailable.set("label",STR_SHOW_NOT_FOUND_DSNLESS);}else{if(!(dsnList.items&&dsnList.items.length>0)){populateDSNs.call(this);}if(connstr){conn=connstr.split(";")[0];conntype=(conn.split("=")[0]).toUpperCase();if(conntype==="DSN"){conn=conn.substring(conntype.length+1,conn.length);selDSN=conn.toUpperCase();}}if(selDSN===undefined){selDSN=dsnList.items[0].nU;}dsnList.set("selectedID",selDSN);dsnList.onChange();this.driverBox.hideUnavailable.set("label",STR_SHOW_NOT_FOUND_DSN);}dbList.set("visible",this.isDSNLess&&!this.singleType);this.contents.set("visible",this.isDSNLess);box.set("visible",!this.isDSNLess);},dsnBox:undefined,dsnList:undefined,dbIDSelectList:undefined,dbmsList:undefined,contents:undefined,hideUnavailable:undefined,hideDriverCheck:false,onhideDriverCheckChange:function onhideDriverCheckChange(){this.driverBox.hideUnavailable.set("visible",!this.hideDriverCheck);},driverBox:undefined,addDriver:undefined,showAddDriver:false,showConnectionString:false,Hive:undefined,db_ver:undefined,DBP:undefined,DBPS:undefined,altDBPS:undefined,IDS:undefined,connections:undefined,altconnections:undefined,dsnless:undefined,Undefined:undefined,isgroup:undefined,groupid:undefined,showUnavailable:false,alwaysShowGeneric:false,children:[{scriptClass:"mstrmojo.Table",rows:1,cols:2,alias:"dsnBox",postCreate:function postCreate(){this.cssClass="mstrmojo-wh-DSNConnection-Box "+((mstrApp.isSingleTier&&navigator.platform.indexOf("Win")!==-1)?"one-tier-win":"");},layout:[{cells:[{cssClass:"mstrmojo-wh-DSNConnection-Box-list"},{cssClass:"mstrmojo-wh-DSNConnection-Box-btn"}]}],children:[{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSettingPulldown",slot:"0,0",caption:"dsn:",alias:"dsnList",itemIdField:"nU",allowHTML:false,onChange:function onChange(){var p=this.parent.parent,dsn=p.dsnBox.dsnList.selectedItem,dbversions=[];if(dsn){$A.forEach(p.supportedDBs,function(db){$A.forEach(db.dbVersions,function(dbver){$A.forEach(dbver.connections.concat(dbver.altconnections),function(conn){if(conn.driver===dsn.des){dbversions.push(dbver);return false;}return true;});});});}if(p.showUnavailable){restrictDBType.call(p,[],dbversions);}else{restrictDBType.call(p,dbversions);}}},{scriptClass:"mstrmojo.Button",slot:"0,1",onclick:function onclick(){var cancelbtn=this.parent.parent.parent.parent.buttonsbox.buttonCancel;if(cancelbtn){cancelbtn.onclick();}mstrApp.getRootController().getDataService().submitRequest({},{taskId:"openODBCAdmin"});}}]},{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSettingPulldown",alias:"dbIDSelectList",itemIdField:"id",caption:STR_DATABASE,bindings:{visible:function(){return !this.parent.singleType;}},onChange:function onChange(item){var p=this.parent,id;if(item){id=item.id;restrictDBType.call(p,p.supportedDBs[$A.find(p.supportedDBs,"id",id)].dbVersions);this.set("selectedID",id);if((item.connType&4)!==4){p.driverBox.addDriver.set("visible",p.showAddDriver);}p.updateLoginFn(item.stdLogin!==0);}}},{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSettingPulldown",alias:"dbmsList",itemIdField:"did",caption:STR_VERSION,bindings:{visible:function(){return !this.parent.singleType;}},onChange:function onChange(){var p=this.parent;if(p.isDSNLess&&p.dbIDSelectList.selectedItem){buildContents.call(p);}this.selectedID=this.selectedItem.did;if(p.onDBMSSelectFn){p.onDBMSSelectFn(this.selectedItem);}}},{scriptClass:"mstrmojo.Box",alias:"driverBox",children:[{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSettingCheckbox",alias:"hideUnavailable",label:STR_SHOW_NOT_FOUND_DSNLESS,oncheckedChange:function oncheckedChange(){var wls=window.localStorage;if(wls){wls.setItem(cookie,this.checked?"1":"0");}var p=this.parent.parent,dbTypeId,dbmsId;if(p.dbIDSelectList.items){dbTypeId=p.dbIDSelectList.selectedID;}if(p.dbmsList.items){dbmsId=p.dbmsList.selectedID;}p.showUnavailable=(this.checked);if(p.isDSNLess){filterDBList.call(p);if(p.dbIDSelectList.hasRendered){if(!!(p.dbIDSelectList.items.length)&&((!dbTypeId)||($A.find(p.dbIDSelectList.items,"id",dbTypeId)<0))){dbTypeId=p.dbIDSelectList.items[0].id;p.dbIDSelectList.selectedID=-1;p.dbIDSelectList.set("selectedID",dbTypeId);}else{p.dbIDSelectList.onChange(p.dbIDSelectList.selectedItem);}}}else{if(this.parent.parent.hasRendered){this.parent.parent.dsnBox.dsnList.onChange();}}if(p.dbmsList.hasRendered){if(((!dbmsId)||($A.find(p.dbmsList.items,"did",dbmsId)<0))&&(p.dbmsList.items&&p.dbmsList.items[0])){dbmsId=p.dbmsList.items[0].id;p.dbmsList.selectedID=-1;p.dbmsList.set("selectedID",dbmsId);}}}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-wh-DBRoleConnection-AddDriver",visible:false,alias:"addDriver",text:STR_ADD_DRIVER,onclick:function onclick(){widget=this.parent.parent;mstrApp.rootController.launchOneTierFileBrowser("mstrmojo.warehouse.dbroles.DBRoleDSNConnection.oneTierFileUploader");}}]},{scriptClass:"mstrmojo.Box",alias:"contents",cssClass:"mstrmojo-wh-DBRoleConnection-Box"}],dbObjects:{},dbVersions:[],dbTypes:[],preferences:{},dbIDs:{},supportedDBs:[],dsnMapDBs:[],drivers:[],getConnectionStr:function getConnectionStr(){if(this.isDSNLess){var stringEditor=this.contents.stringEditor;if(stringEditor.visibleContents&&stringEditor.enabledContents){return{str:stringEditor.getValue(),err:""};}}return generateConnectionString.call(this,true,true,undefined);},getVLDBProperties:function getVLDBProperties(vldbProperties){if(this.isDSNLess&&vldbProperties){$A.forEach(this.contents.children,function(child){if(!(child.field)){getSettingValue(child,vldbProperties);}});}},isValidInput:function isValidInput(){var children=this.contents.children,isValid={val:false,msg:STR_MISSING_PARAMS};if(this.isDSNLess){$A.forEach(children,function(child){if(child.isGroupSetting&&child.visible){$A.forEach(child.children,function(setting){if(setting.alias!=="groupbox"){isValid=setting.isValid();return(isValid.val);}return true;});}else{isValid=child.isValid();}return(isValid.val);});return isValid;}return this.dsnBox.dsnList.isValid();},getDbmsID:function getDbmsID(){return this.dbmsList.selectedItem.did;},getDBId:function getDBId(){if(this.dbIDSelectList.selectedItem&&this.isDSNLess){return this.dbIDSelectList.selectedItem.id;}return 0;},getDBType:function getDBType(){return this.dbmsList.selectedItem.db_type;},getCharEncodingForUnix:function getCharEncodingForUnix(){var item=this.dbmsList.selectedItem,dbVersion=item.db_ver,idx=$A.find(this.dbVersions,"v",dbVersion);if(idx>=0){return this.dbVersions[idx].unixEncoding;}return 1;},getDriverMode:function getDriverMode(){return this.driverMode;},getOdbcv:function getOdbcv(){if(this.getDBType()===this.dbTypes.Hive.v){return"20";}return"";},clear:function clear(){this.set("info",{});}});mstrmojo.warehouse.dbroles.DBRoleDSNConnection.oneTierFileUploader=function(file){mstrApp.rootController.oneTierFileUploader({success:function success(){widget.dbObjects.reloadDrivers({success:function success(){widget.drivers=widget.dbObjects.drivers;widget.oninfoChange.call(widget);}});}},{fp:file});};}());