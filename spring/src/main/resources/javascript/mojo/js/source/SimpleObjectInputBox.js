(function(){mstrmojo.requiresCls("mstrmojo.ListBase","mstrmojo._IsList","mstrmojo._HasSuggestion","mstrmojo.Enum_Keys","mstrmojo.hash","mstrmojo.dom");var $DOM=mstrmojo.dom,$KEYS=mstrmojo.Enum_Keys,KEY_DELAY=200,markup;var STATES={DEFAULT:1,ADDING:2,EMPTY:3,FULL:4};var deleteCssCls="mstrmojo-SimpleObjectInputBox-del";function testInputText(){var inputBox=this.inputBox,text=inputBox.value;if(text!==this._lastPattern&&text!==""){this.showSuggestion(text);}this._lastPattern=text;delete this._timerHandle;}function clearInputTextTimer(){var timerHandle=this._timerHandle;if(timerHandle){window.clearTimeout(timerHandle);delete this._timerHandle;}}mstrmojo.SimpleObjectInputBox=mstrmojo.declare(mstrmojo.ListBase,[mstrmojo._IsList,mstrmojo._HasSuggestion,mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.SimpleObjectInputBox",markupString:'<div id="{@id}" class="mstrmojo-ListBase mstrmojo-SimpleObjectInputBox {@cssClass}" style="{@cssText}" mstrAttach:click><div class="mstrmojo-SimpleObjectInputBox-container {@icnCss}" style="{@icnCssText}">{@itemsHtml}<input type="text" mstrAttach:keydown,keyup,blur style="display: none;" /></div><div class="mstrmojo-SimpleObjectInputBox-empty"><div>{@emptyText}</div></div></div>',markupSlots:{itemsContainerNode:function(){return this.domNode.firstChild;},emptyTextNode:function(){return this.domNode.childNodes[1];},inputBox:function(){return this.domNode.firstChild.lastChild;},scrollboxNode:function(){return this.domNode.firstChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,onheightChange:mstrmojo.Widget.heightMarkupMethod,onwidthChange:mstrmojo.Widget.widthMarkupMethod,onmaxItemWidthChange:function onmaxItemWidthChange(){var w=this.maxItemWidth;if(!isNaN(w)&&w>0){this.emptyTextNode.style.maxWidth=w+"px";}}},itemField:"n",emptyText:"",state:0,maxItemWidth:"none",useKeyDelay:false,maxObjectCount:null,useRichTooltip:true,showTooltip:function showTooltip(evt,win){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),item=this.getItemFromTarget(target);if(item&&item.n){var textNode=this.getItemNodeFromTarget(target).firstChild,position=$DOM.position(textNode);this.richTooltip={posType:mstrmojo.tooltip.POS_TOPCENTER,cssClass:"vi-regular vi-tooltip-A A-center",refNode:textNode,content:mstrmojo.string.encodeHtmlString(item.n),top:position.h+11,left:position.w/2};this._super(evt,win);}},getItemMarkup:function(item){if(!markup){var itemField=this.itemField;markup=this._super(item).replace(">{@en@n}<",'"><div class="elem">{@'+itemField+'}<div class="'+deleteCssCls+'"></div></div><');}return markup;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx),itemField=this.itemField;props[itemField]=item[itemField];var maxWidth=this.maxItemWidth;if(!isNaN(maxWidth)&&maxWidth>0){maxWidth=(maxWidth-24)+"px";}props.addStyle("max-width:"+maxWidth);return props;},getSuggestionPos:function getSuggestionPos(){var inputPosition=this._inputPos;return{target:this.inputBox,left:inputPosition.x+"px",top:inputPosition.y+inputPosition.h+"px",zIndex:100};},getSearchPattern:function getSearchPattern(){return this.inputBox.value;},onSuggestionItemSelect:function onSuggestionItemSelect(item){clearInputTextTimer.call(this);this.set("items",this.items.concat(item));this._super();var id=this.id;window.setTimeout(function(){var obj=mstrmojo.all[id];if(parseInt(obj.state,10)!==STATES.FULL){obj.set("state",STATES.ADDING);}},0);},onstateChange:function onstateChange(evt){var state=evt.value;this.emptyTextNode.style.display=(state===STATES.EMPTY)?"block":"none";this.itemsContainerNode.style.display=(state===STATES.EMPTY)?"none":"block";var inputBox=this.inputBox,inputStyle=inputBox.style;if(state===STATES.ADDING){inputStyle.display="";this.updateScrollbars();inputBox.focus();this._inputPos=$DOM.position(inputBox,true);}else{clearInputTextTimer.call(this);inputStyle.display="none";inputBox.value="";this._lastPattern="";this.updateScrollbars();}},postBuildRendering:function postBuildRendering(){KEY_DELAY=mstrApp.getSearchAutoCompleteDelay&&mstrApp.getSearchAutoCompleteDelay()||KEY_DELAY;this.state=0;this.setDefaultState();return this._super();},preitemsChange:function preitemsChange(){this.setDefaultState();},onclick:function onclick(evt){var target=$DOM.eventTarget(evt.hWin,evt.e);if(target&&target.className===deleteCssCls){var item=$DOM.findAncestorByAttr(target,"idx",true,this.domNode),idx=item&&parseInt(item.value,10);this.hideTooltip();if(idx!==null&&!isNaN(idx)){var items=this.items.concat();items.splice(idx,1);this.set("items",items);}return ;}if(parseInt(this.state,10)!==STATES.FULL){this.set("state",STATES.ADDING);}},onblur:function onblur(){clearInputTextTimer.call(this);if(!this.suggestionShown){this.setDefaultState();}},prekeydown:function prekeydown(evt){var e=evt.e;switch(parseInt(e.keyCode||e.charCode,10)){case $KEYS.DOWN_ARROW:this.nextHighlight();break;case $KEYS.UP_ARROW:this.preHighlight();break;case $KEYS.TAB:case $KEYS.ENTER:$DOM.preventDefault(evt.hWin,e);var item=this.getSelected();if(item){this.handleSuggestionItemSelect(item);}else{this.hideSuggestion();this.setDefaultState();}break;case $KEYS.ESCAPE:clearInputTextTimer.call(this);this.hideSuggestion();this.setDefaultState();break;case $KEYS.BACKSPACE:if(!this.getSearchPattern()){$DOM.preventDefault(evt.hWin,e);var items=this.items&&this.items.concat();if(items&&items.length){items.splice(items.length-1,1);mstrApp.ignoreBackSpace=true;this.set("items",items);var id=this.id;window.setTimeout(function(){mstrmojo.all[id].set("state",STATES.ADDING);mstrApp.ignoreBackSpace=false;},0);}}break;}},prekeyup:function prekeyup(evt){if(!this.getSearchPattern()){$DOM.preventDefault(evt.hWin,evt.e);this.hideSuggestion();}if(this.useKeyDelay){var id=this.id;if(!this._timerHandle){this._timerHandle=window.setTimeout(function(){testInputText.call(mstrmojo.all[id]);},KEY_DELAY);}}else{testInputText.call(this);}},widgetResized:function widgetResized(){if(this.hasRendered){var width=parseInt(this.width,10),itemCount=this.items.length,itemsNode=this.itemsContainerNode.childNodes;if(itemCount<=itemsNode&&itemsNode.length){for(var i=0;i<itemCount;i++){itemsNode[i].style.maxWidth=width-24+"px";}}if(this.emptyTextNode){this.emptyTextNode.style.maxWidth=width+"px";}this.updateScrollbars();}},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.scrollboxNode;},setDefaultState:function setDefaultState(){var mx=this.maxObjectCount,itsLen=(this.items&&this.items.length)||0,isFull=(mx!==null&&mx!==undefined&&itsLen>=mx);this.set("state",!itsLen?STATES.EMPTY:(isFull?STATES.FULL:STATES.DEFAULT));}});}());