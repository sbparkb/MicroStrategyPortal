(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.hash","mstrmojo.Box","mstrmojo.Label","mstrmojo.expr","mstrmojo.ValidationTextBox","mstrmojo.Dialog","mstrmojo.cookies");mstrmojo.requiresDescs(17,18,221,9772,11773,14028,14136,14137,14138,14139,14140,14149,14522,14523,14524,14525,14526,14527);var CSS=mstrmojo.css,DOM=mstrmojo.dom,HASH=mstrmojo.hash;var _VAL=mstrmojo.validation,_SC=_VAL.STATUSCODE,_TR=_VAL.TRIGGER,_VALIDATOR=_VAL.VALIDATOR,DTP=mstrmojo.expr.DTP;var usherProps={intervalCtr:0,qrLoaded:false,maxPollingAttempts:80,timeDelay:3000};var DEFAULT_BADGE={mini_badge:"#ddd",mini_badge_icon:"https://uvs-v2.usher.com/assets/images/img_badge_placeholder.png",t_color:"#797979",appName:"",name:""};var userInfo={firstName:"",badgeId:""};var notificationTimer={duration:undefined,elem:undefined,callback:undefined,timerInterval:null,init:function(duration,elem,callback){this.duration=duration;this.elem=elem;this.callback=callback;},startTimer:function(){this.stopTimer();var start=Date.now(),diff,minutes,seconds;var me=this;function timer(){diff=me.duration-(((Date.now()-start)/1000)|0);minutes=(diff/60)|0;seconds=(diff%60)|0;minutes=minutes<10?"0"+minutes:minutes;seconds=seconds<10?"0"+seconds:seconds;me.elem.set("text",minutes+":"+seconds);if(diff<=0){start=Date.now()+1000;me.callback();me.stopTimer();}}timer();this.timerInterval=setInterval(timer,1000);},stopTimer:function(){if(this.timerInterval){clearInterval(this.timerInterval);}}};function addExtraParams(params){params.sn=this.serverName||mstrConfig.serverName;params.sp=this.serverPort||mstrConfig.serverPort;params.connectionId=this.connectionId||"";return params;}function disableQRCode(){this.set("expired",true);this.usherProps.qrLoaded=false;}function checkForUsherScan(){try{var widgetUsherProps=this.usherProps;var me=this;if(widgetUsherProps.qrLoaded){if(widgetUsherProps.intervalCtr>widgetUsherProps.maxPollingAttempts){disableQRCode.call(me);}else{clearTimeout(this.pullTimeout);this.pullTimeout=setTimeout(function(){widgetUsherProps.intervalCtr+=1;if(!me.stopPolling){usherPollForScan.call(me);}},widgetUsherProps.timeDelay);}}}catch(e){}}function serverRequest(params,callbacks,config){if(mstrApp.serverRequest){mstrApp.serverRequest(params,callbacks,config);}else{mstrmojo.xhr.request("POST",mstrConfig.taskURL,callbacks,params);}}function usherPollForScan(){var me=this,widgetUsherProps=this.usherProps,params={taskId:"usherLoginWeb",pollOnly:"true",server:this.serverName||mstrConfig.serverName,port:this.serverPort||mstrConfig.serverPort,project:this.projectName||mstrConfig.projectName,connectionId:this.connectionId},callbacks={success:function(res){try{if(res.status=="invalid"){checkForUsherScan.call(me);}else{if(res.status=="success"){function doUsherLogin(res){me.onUsherLogin(res);widgetUsherProps.qrLoaded=false;}if(me.rememberMe===true){var callbacks={success:function(res){doUsherLogin(res);},failure:function(res){me.onUsherError(res);}};var params={taskId:"usherRememberMe"};params.deviceId=mstrmojo.cookies.getCookieSetting("usher_sso_device")?mstrmojo.cookies.getCookieSetting("usher_sso_device"):"";serverRequest(params,callbacks,{doNotHold:true});}else{doUsherLogin(res);}}}}catch(e){mstrmojo.alert("usherPollForScan:\n "+e.messsage);}},failure:function(res){disableQRCode.call(me);me.onUsherError(res);}};serverRequest(params,callbacks,{doNotHold:true});}function updateUserDetails(msg){this.userDetails.set("text",msg||"");}function toggleLoginNotification(show){var me=this;me.loginButton.set("visible",show);me.loginNotificationBox.set("visible",!show);}function submitLogin(){var widgetUsherProps=this.usherProps;var notificationTimer=this.notificationTimer;var me=this,callbacks={success:function(res){try{if(res.status==1){function callback(){toggleLoginNotification.call(me,true);}function submitForPolling(){if(me.pullTimeout){clearTimeout(me.pullTimeout);}me.usherProps.intervalCtr=0;widgetUsherProps.qrLoaded=true;checkForUsherScan.call(me);}var fiveMinutes=60*5;notificationTimer.init(fiveMinutes,me.loginNotificationBox.timer,callback);notificationTimer.startTimer();toggleLoginNotification.call(me,false);submitForPolling();}else{me.onUsherError(res);}}catch(e){mstrmojo.alert("Error:\n"+e.message);}},failure:function(res){me.onUsherError(res);}},params={taskId:"usherNotifyMe"};params.deviceId=mstrmojo.cookies.getCookieSetting("usher_sso_device")?mstrmojo.cookies.getCookieSetting("usher_sso_device"):"";serverRequest(addExtraParams.call(this,params),callbacks,{doNotHold:true});}function forgetMe(){var me=this,callbacks={success:function(res){try{me.set("notificationMode",false);me.reloadQR();}catch(e){mstrmojo.alert("Error:\n"+e.messsage);}},failure:function(res){me.onUsherError(res);}},params={taskId:"usherRememberMe",rememberMe:false};if(me.userInfo.badgeId!==""){params.badgeId=me.userInfo.badgeId;}params.deviceId=mstrmojo.cookies.getCookieSetting("usher_sso_device")?mstrmojo.cookies.getCookieSetting("usher_sso_device"):"";serverRequest(addExtraParams.call(this,params),callbacks,{doNotHold:true});}function getQRCode(ignoreNotificationMode){if(this.notificationMode==true&&!ignoreNotificationMode){return ;}var widgetUsherProps=this.usherProps;this.showQRLoading(true);var me=this,callbacks={success:function(res){try{if(res.img){me.set("notificationMode",false);me.updateQRCode(res.img);me.set("badge",res.badgeInfo&&res.badgeInfo[0]);widgetUsherProps.intervalCtr=0;widgetUsherProps.qrLoaded=true;this.stopPolling=false;checkForUsherScan.call(me);}else{var data=JSON.parse(res.data);var pn=data.pnEnabled||data.isPNEnabled;me.set("isPnEnabled",pn);if(data.code||data.proximityBasedLogin){me.set("notificationMode",false);if(data.proximityBasedLogin&&!ignoreNotificationMode){me.updateQRCodeProximity();me.set("proximityMode",true);}else{me.updateQRCode(data.code);me.set("proximityMode",false);}me.set("badge",res.badgeInfo&&res.badgeInfo[0]);widgetUsherProps.intervalCtr=0;widgetUsherProps.qrLoaded=true;this.stopPolling=false;mstrmojo.cookies.updateCookieSetting("usher_sso_device",res.device_id);checkForUsherScan.call(me);}else{me.set("proximityMode",false);me.set("notificationMode",true);me.refresh.set("visible",false);if(me.userInfoNode){me.userInfoNode.src="data:image/png;base64,"+data.photoData;}me.userInfo.firstName=data.firstName;me.userInfo.badgeId=data.badgeId;toggleLoginNotification.call(me,true);me.set("badge",res.badgeInfo&&res.badgeInfo[0]);}}}catch(e){mstrmojo.alert("getQRCode:\n "+e.messsage);}},failure:function(res){me.handleQRCodeError(res);disableQRCode.call(me);me.onUsherError(res);},complete:function(){me.showQRLoading(false);}},params={taskId:"usherQRWeb"};params.deviceId=mstrmojo.cookies.getCookieSetting("usher_sso_device")?mstrmojo.cookies.getCookieSetting("usher_sso_device"):"";serverRequest(addExtraParams.call(this,params),callbacks,{doNotHold:true});}function registerHandler(){var me=this,regBtn=this.registerButton,dotsNode=this.parent.badgeNode.childNodes[1];if(regBtn.enabled){regBtn.set("enabled",false);CSS.addClass(dotsNode,["anim"]);var regMsg={},callbacks={success:function(res){var successful=res&&res.name==me.user.value;regMsg={msg:successful?mstrmojo.desc(14139,"You've successfully registered. Please check your email to continue.")+" "+mstrmojo.desc(14177,"Or perform an Usher badge recovery."):res.getResponseHeader("X-MSTR-TaskFailureMsg"),successful:successful};},failure:function(res){regMsg={msg:res.getResponseHeader("X-MSTR-TaskFailureMsg"),successful:false};},complete:function(){regBtn.set("enabled",true);CSS.removeClass(dotsNode,["anim"]);me.set("regMsg",regMsg);}},params={taskId:"usherRegUsr",server:this.serverName||mstrConfig.serverName,project:mstrConfig.projectName,port:this.serverPort||mstrConfig.serverPort,email:this.email.value,userid:this.user.value,password:this.pwd.value};serverRequest(params,callbacks);}}function getTextBoxJson(props){return mstrmojo.hash.copy(props,{scriptClass:"mstrmojo.ValidationTextBox",cssDisplay:"block",postCreate:function(){if(DOM.isIE9||DOM.isIE8||DOM.isIE7){this.emptyText=this.hint;}},onEnter:function(){registerHandler.call(this.parent);}});}mstrmojo.UsherLogin=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.UsherLogin",markupString:'<div id="{@id}" class="mstrmojo-UsherLogin-Container {@cssClass}" style="{@cssText}" ><div class="mstrmojo-UsherLogin-badge"><div class="icn"><img src="../images/1ptrans.gif"/></div><div class="dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div><div class="app"><img src="../style/mstr/images/badge-app.png"/></div></div><div class="mstrmojo-UsherLogin-badgeLabel"><div class="app-name"></div><div class="badge-name"></div></div><div class="mstrmojo-UsherLogin"><div class="mstrmojo-UsherLogin-QR mode"><img class="QR" src="../images/1ptrans.gif" alt="" /></div><div class="mstrmojo-UsherLogin-register mode"></div></div><div class="mstrmojo-UsherLogin-userInfo mode"><img class="userInfo" src="../images/1ptrans.gif" alt="" /></div><div class="mstrmojo-UsherLogin-notification"></div><div class="mstrmojo-UsherLogin-remember-setting"><div class = "mstrmojo-UsherLogin-remember"></div><div class = "mstrmojo-UsherLogin-forget"></div></div><div class="mstrmojo-UsherLogin-link"></div></div>',markupSlots:{containerNode:function(){return this.domNode;},badgeNode:function(){return this.domNode.firstChild;},badgeIconNode:function(){return this.domNode.firstChild.firstChild.firstChild;},badgeLabelNode:function(){return this.domNode.childNodes[1];},usherNode:function(){return this.domNode.childNodes[2];},qrNode:function(){return this.domNode.childNodes[2].firstChild;},qrCodeNode:function(){return this.domNode.childNodes[2].firstChild.firstChild;},refreshNode:function(){return this.domNode.childNodes[2].firstChild.lastChild;},registerNode:function(){return this.domNode.childNodes[2].lastChild;},userNode:function(){return this.domNode.childNodes[3];},userInfoNode:function(){return this.domNode.childNodes[3].firstChild;},notificationNode:function(){return this.domNode.childNodes[4];},rememberSettingsNode:function(){return this.domNode.childNodes[5];},rememberNode:function(){return this.domNode.childNodes[5].firstChild;},forgetNode:function(){return this.domNode.childNodes[5].lastChild;},linksNode:function(){return this.domNode.lastChild;}},markupMethods:{onqrCodeChange:function(){if(this.qrCodeNode){this.qrCodeNode.src=this.qrCode;}},onbadgeChange:function(){var badge=this.badge||DEFAULT_BADGE,badgeFormat=badge.badgeFormat,fmt=badgeFormat&&(window.JSON?JSON.parse(badgeFormat):eval("("+badgeFormat+")"))||{isnull:true},labelNode=this.badgeLabelNode,iconNode=this.badgeIconNode,domNode=this.domNode;if(this.showBadgeBackgroundImage){domNode.style.backgroundColor=fmt.mini_badge;if(fmt.bg_4){domNode.style.backgroundImage="url("+fmt.bg_4+")";}}iconNode.src=fmt.mini_badge_icon||DEFAULT_BADGE.mini_badge_icon;if(!fmt.isnull&&!fmt.mini_badge_icon){CSS.addClass(iconNode.parentNode,"default");}labelNode.firstChild.innerHTML=badge.appName||DEFAULT_BADGE.appName;labelNode.lastChild.innerHTML=badge.name||DEFAULT_BADGE.name;labelNode.lastChild.title=badge.name||DEFAULT_BADGE.name;labelNode.style.color=fmt.t_color||DEFAULT_BADGE.t_color;this.linksNode.style.color=fmt.t_color||DEFAULT_BADGE.t_color;},onexpiredChange:function(){CSS.toggleClass(this.usherNode,"expired",this.expired);},onloadingChange:function(){CSS.toggleClass(this.usherNode,"loading",this.loading);},onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";if(this.visible&&this.canRequestQR()&&!this._lastVisible){getQRCode.call(this);}this.stopPolling=!this.visible;this._lastVisible=this.visible;},onnotificationModeChange:function(evt){CSS.toggleClass(this.containerNode,"notificationMode",this.notificationMode);},onproximityModeChange:function(evt){CSS.toggleClass(this.containerNode,"proximityMode",this.proximityMode);},onisPnEnabledChange:function(){this.hideRememberMe(!this.isPnEnabled);}},qrCode:"../images/1ptrans.gif",badge:DEFAULT_BADGE,expired:false,onUsherLogin:mstrmojo.emptyFn,onUsherError:mstrmojo.emptyFn,showBadgeBackgroundImage:true,usherProps:null,serverName:null,serverPort:null,rememberMe:false,userInfo:null,notificationTimer:null,loadQR:false,notificationMode:false,isPnEnabled:false,init:function init(props){if(this._super){this._super(props);}CSS.addWidgetCssClass(this,"");this.usherProps=this.usherProps?HASH.copy(this.usherProps,HASH.clone(usherProps)):HASH.clone(usherProps);this.userInfo=this.userInfo?HASH.copy(this.userInfo,HASH.clone(userInfo)):HASH.clone(userInfo);this.notificationTimer=this.notificationTimer?HASH.copy(this.notificationTimer,HASH.clone(notificationTimer)):HASH.clone(notificationTimer);},destroy:function destroy(ignoreDOM){this.stopPolling=true;clearTimeout(this.pullTimeout);this._super(ignoreDOM);},canRequestQR:function(){return this.usherProps&&(this.loadQR||(this.serverName||mstrConfig.serverName));},showUserInfo:function(res){this.refresh.set("visible",false);this.refresh.set("visible",false);},updateQRCode:function(res){this.set("qrCode","data:image/png;base64,"+res);this.set("expired",false);this.refresh.set("visible",false);},updateQRCodeProximity:function(){this.set("qrCode","../images/WaitUsherRadar.gif");this.set("expired",false);this.refresh.set("visible",false);},handleQRCodeError:function(){this.set("qrCode","../style/mstr/images/msgError.gif");this.set("expired",true);this.refresh.set("visible",true);},showQRLoading:function showQRLoading(show){this.set("loading",show);if(show){this.refresh.set("visible",false);}},postBuildRendering:function(){this._super();this.registerForm.set("tabIndex",-1);},toggleRegister:function(force){this.registerVisible=(force!==undefined)?force:!this.registerVisible;CSS.toggleClass(this.usherNode,"show-register",this.registerVisible);this.registerLink.set("text",this.registerLink.texts[this.registerVisible?1:0]);if(this.isPnEnabled===true){this.hideRememberMe(this.registerVisible&&this.isPnEnabled);}},hideRememberMe:function(force){CSS.toggleClass(this.rememberSettingsNode,"hide-rememeber",force);},reloadQR:function(){if(this.canRequestQR()){if(this.pullTimeout){clearTimeout(this.pullTimeout);}this.usherProps.intervalCtr=0;this.usherProps.qrLoaded=false;if(this.visible){getQRCode.call(this);}}},children:[{scriptClass:"mstrmojo.Label",slot:"qrNode",alias:"refresh",cssClass:"refresh",text:mstrmojo.desc(14028,"Refresh QR Code"),visible:false,onclick:function(){getQRCode.call(this.parent);}},{scriptClass:"mstrmojo.Box",slot:"registerNode",alias:"registerForm",regMsg:null,children:[getTextBoxJson({alias:"user",cssClass:"login-username",cssDisplay:"block",hint:mstrmojo.desc(17,"User name")}),getTextBoxJson({alias:"pwd",cssClass:"login-pwd",hint:mstrmojo.desc(18,"Password"),type:"password"}),getTextBoxJson({alias:"email",cssClass:"login-email",dtp:DTP.VARCHAR,constraints:{validator:_VALIDATOR.VALIDATE_EMAIL,trigger:mstrmojo.validation.TRIGGER.ONKEYUP},bindings:{visible:"this.parent.parent.usherRegistrationOption > 2"},hint:mstrmojo.desc(9772,"Email")}),getTextBoxJson({alias:"confirmEmail",cssClass:"login-email",bindings:{visible:function(){return this.parent.parent.usherRegistrationOption>2;}},hint:mstrmojo.desc(14149,"Confirm Email"),onpaste:function(evt){DOM.preventDefault(evt.hWin,evt.e||evt.hWin.event);}}),{scriptClass:"mstrmojo.Box",alias:"regMsg",cssClass:"register-msg",bindings:{regMsg:function(){return this.parent.regMsg;},visible:function(){return this.parent.regMsg;}},onregMsgChange:function(){if(this.domNode){this.domNode.style.color=this.regMsg&&this.regMsg.successful?"#42C31E":"#f00";}},children:[{scriptClass:"mstrmojo.Label",alias:"msg",cssClass:"register-msg-txt",bindings:{text:function(){return this.parent.regMsg.msg;}}},{scriptClass:"mstrmojo.Label",alias:"icn",cssClass:"register-msg-icn",onclick:function(){this.parent.parent.parent.toggleRegister();this.parent.parent.set("regMsg",null);}}]},{scriptClass:"mstrmojo.Button",alias:"registerButton",cssClass:"register mstrmojo-WebButton hot",cssDisplay:"inline-block",text:mstrmojo.desc(11773,"Register"),bindings:{enabled:function(){var username=this.parent.user.value,email=this.parent.email.value,confirmEmail=this.parent.confirmEmail.value;var registerStatus=username.length>0;if(registerStatus){if(this.parent.parent.usherRegistrationOption>1){var emailStatus=email.length>=3&&confirmEmail.length>=3&&email.toUpperCase()===confirmEmail.toUpperCase()&&this.parent.email.validationStatus.code===_SC.VALID;if(emailStatus){if(this.parent.parent.usherRegistrationOption==7){var restrictedDomains=this.parent.parent.usherRegistrationDomain.toUpperCase();var emailDomain=email.substr(email.indexOf("@")+1).toUpperCase();return restrictedDomains.indexOf(emailDomain)>=0;}}return emailStatus;}}return registerStatus;}},onclick:function(){registerHandler.call(this.parent);}},{scriptClass:"mstrmojo.Button",alias:"registerCancelButton",cssClass:"register-cancel",cssDisplay:"inline-block",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var p=this.parent;p.parent.toggleRegister();p.set("regMsg",null);p.user.set("value","");p.pwd.set("value","");p.email.set("value","");p.confirmEmail.set("value","");p.user.domNode.focus();}}]},{scriptClass:"mstrmojo.CheckBox",slot:"rememberNode",alias:"remember-me",label:mstrmojo.desc(14522,"Remember me"),onclick:function onclick(){this.parent.set("rememberMe",this.checked);}},{scriptClass:"mstrmojo.Label",slot:"forgetNode",allowHTML:true,text:mstrmojo.desc(14527,"Forget me/Switch user"),onclick:function(){forgetMe.call(this.parent);}},{scriptClass:"mstrmojo.Label",slot:"linksNode",allowHTML:true,text:'<a id="proximityProblems" href="#">Login via Phone</a>',onclick:function(evt){getQRCode.call(this.parent,true);return false;},bindings:{visible:"this.parent.proximityMode"},},{scriptClass:"mstrmojo.Label",slot:"linksNode",allowHTML:true,text:mstrmojo.desc(14136,"Use your ###Usher## app to scan the QR Code.").replace("###",'<a href="https://itunes.apple.com/us/app/usher-identity/id776079205" target="_blank">').replace("##","</a>"),},{scriptClass:"mstrmojo.Label",slot:"linksNode",alias:"registerLink",cssClass:"register-label",allowHTML:true,bindings:{visible:"this.parent.usherRegistrationOption > 0"},text:"",texts:[mstrmojo.desc(14137,"Don't have an Usher Badge? Click ###here## to register."),mstrmojo.desc(14140,"Display your ###QR Code##.")],postCreate:function(){this.set("text",this.texts[0]);},ontextChange:function(){this.text=this.text.replace("###",'<a href="#" onclick="mstrmojo.all.'+this.parent.id+'.toggleRegister(); return false;">').replace("##","</a>");}},{scriptClass:"mstrmojo.Label",alias:"userDetails",cssClass:"user-details",slot:"userNode"},{scriptClass:"mstrmojo.Button",alias:"loginButton",cssClass:"mstrmojo-WebButton login-button .mstrButton",cssDisplay:"inline-block",text:mstrmojo.desc(14525,"Login with Usher"),slot:"notificationNode",visible:false,onclick:function(){submitLogin.call(this.parent);},onvisibleChange:function(){var node=this.parent,msg=mstrmojo.desc(14523,"Hi ")+" "+node.userInfo.firstName;this.visible?msg+="!":msg+=mstrmojo.desc(14524,", please approve on your device.");updateUserDetails.call(node,msg);}},{scriptClass:"mstrmojo.Box",alias:"loginNotificationBox",cssClass:"login-notification",slot:"notificationNode",visible:false,children:[{scriptClass:"mstrmojo.Label",alias:"timer",cssClass:"notification-timer"},{scriptClass:"mstrmojo.Label",alias:"notificationFailure",cssClass:"notification-failure",text:mstrmojo.desc(14526,"Did not get notification"),onclick:function(){toggleLoginNotification.call(this.parent.parent,true);}}]},]});}());