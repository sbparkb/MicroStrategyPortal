(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.hash","mstrmojo.ui.ScrollableContainer","mstrmojo.Box","mstrmojo.DynamicClassFactory","mstrmojo.Button","mstrmojo.Label","mstrmojo.TextBox");var $CSS=mstrmojo.css,$HASH=mstrmojo.hash,$NWB=mstrmojo.Button.newWebButton,$CFC=mstrmojo.DynamicClassFactory.newComponent,FIRST_COL_WIDTH=150,$PX="px";var HOST_TYPE_OPTIONS=[{n:mstrmojo.desc(7787,"ASP.NET"),v:"asp"},{n:mstrmojo.desc(7788,"J2EE"),v:"j2ee"}],CONNECTION_TYPE_OPTIONS=[{n:mstrmojo.desc(7785,"HTTP"),v:"http:"},{n:mstrmojo.desc(7786,"HTTPS"),v:"https:"}];function indexOfValue(arr,v){return arr.map(function(obj){return obj.v;}).indexOf(v);}function isConnectionDataValid(data){if(!data||Object.keys(data).length===0){return false;}else{return["wsn","wsport","wspath","wstp","conntp"].every(function(v){var configValue=data[v];return configValue!==undefined&&configValue!=="";});}}function onAdvancedConfigChanged(){var isConnectionValid=isConnectionDataValid.call(this,this.connectionData);this.testButton.set("enabled",isConnectionValid);if(!isConnectionValid){toggleAdvancedConfigBox.call(this,true);}if(this.hasRendered){this.doLayout();}}function autoCompleteConnection(connection,callback){var jspExtension="servlet/mstrWeb",aspMainExtension="asp/Main.aspx",aspAdminExtension="asp/Admin.aspx",url=connection.url,originalUrl=connection.url;function isComplete(url){var value=false;if((url.indexOf(jspExtension)>0)||(url.indexOf(aspMainExtension)>0)||(url.indexOf(aspAdminExtension)>0)){value=true;}else{if((url.indexOf("servlet")<0||url.indexOf("asp")<0)){value=true;}}return value;}if(!isComplete(url)){url=originalUrl+aspMainExtension;}else{callback();return false;}function testTask(){this.parent.parent.model.connectivityProxy.testServerConnection({url:url},serverConnectionCB);}var serverConnectionCB={success:function success(res){switch(res.code){case 404:case 500:if(url.indexOf(aspMainExtension)>0){url=originalUrl+jspExtension;testTask.call(this);}else{callback();return false;}break;default:connection.url=url;var urlInput=this.parent.urlContainer.getCtrl();urlInput.set("value",url);callback();return true;}}.bind(this),failure:function failure(res){callback();return false;}};testTask.call(this);}function getAdvancedOptionsBox(isVisible){var data=this.connectionData||{},serverPanel=this.parent,commonProps={col1Width:(FIRST_COL_WIDTH-15)+$PX},fnChange=function fnChange(dataPropKey,value){data[dataPropKey]=value;var urlInput=this.urlContainer.getCtrl();if(!data.url){if(dataPropKey!=="conntp"){data.conntp="http:";}if(dataPropKey!=="wstp"){data.wstp="asp";}}if(dataPropKey==="wstp"){if(value==="j2ee"){data.wsfolderpath="/servlet";data.wsservlet="mstrWeb";}else{data.wsfolderpath="/asp";data.wsservlet="Main.aspx";}}urlInput.value=urlInput.inputNode.value=data.url=this.parent.model.buildServerURLFromInfo(data);this.testButton.set("enabled",isConnectionDataValid.call(this,data));}.bind(this),getLabelAndTextBoxHelper=function(label,dataPropKey,defaultValue){if(defaultValue!==undefined&&!data[dataPropKey]){data[dataPropKey]=defaultValue;}return serverPanel.getLabelAndTextBox(label,function(){var value=this.value;this.set("textValid",!!value);fnChange(dataPropKey,value);},data[dataPropKey],commonProps,{textValid:!!data[dataPropKey]});}.bind(this),childrenWidgets=[];childrenWidgets=childrenWidgets.concat([getLabelAndTextBoxHelper(mstrmojo.desc(13704,"Server Name"),"wsn"),getLabelAndTextBoxHelper(mstrmojo.desc(13705,"Server Port"),"wsport",this.parent.model.getDefaultPort(data.conntp)),getLabelAndTextBoxHelper(mstrmojo.desc(13706,"Server Path"),"wspath"),serverPanel.getLabelAndPulldown(mstrmojo.desc(8935,"Server Type"),HOST_TYPE_OPTIONS,function(newValue){fnChange("wstp",newValue);},indexOfValue(HOST_TYPE_OPTIONS,data.wstp),commonProps),serverPanel.getLabelAndPulldown(mstrmojo.desc(13707,"Connection Type"),CONNECTION_TYPE_OPTIONS,function(newValue){fnChange("conntp",newValue);},indexOfValue(CONNECTION_TYPE_OPTIONS,data.conntp),commonProps)]);return{scriptClass:"mstrmojo.onetier.vi.prefs.ServerConfigBox.LayoutBox",cssClass:"cfg-advanced",alias:"advOptionsBox",visible:!!isVisible,layoutConfig:{w:{containerNode:"100%"},xt:true},getLayoutOffsets:function getLayoutOffsets(){return{w:30};},children:childrenWidgets};}function toggleAdvancedConfigBox(forceVisibleValue){var advOptionsBox=this.advOptionsBox,toggledValue=forceVisibleValue===undefined?!advOptionsBox.visible:forceVisibleValue;if(advOptionsBox.visible!==forceVisibleValue){advOptionsBox.set("visible",toggledValue);$CSS.toggleClass(this.advLabel.domNode,"open",toggledValue);}}function onURLChanged(urlParams){var advOptionsBox=this.advOptionsBox,previousVisibleValue=advOptionsBox.visible;$HASH.copy(urlParams,this.connectionData);this.removeChildren(advOptionsBox);advOptionsBox.destroy();this.addChildren([getAdvancedOptionsBox.call(this,previousVisibleValue)],3);onAdvancedConfigChanged.call(this);}function deleteServerConnectionHelper(){this.deleteServerConnection(this.connectionData);}function getRemoveServerBtnConfig(){return $NWB(mstrmojo.desc(13711,"Remove Server"),deleteServerConnectionHelper.bind(this),true,{alias:"deleteButton"});}function getCancelLabelConfig(){return{scriptClass:"mstrmojo.Label",alias:"cancelLabel",cssClass:"ot-sc-cancel-unsaved",text:mstrmojo.desc(221,"Cancel"),onclick:deleteServerConnectionHelper.bind(this)};}mstrmojo.onetier.vi.prefs.ServerConfigBox=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.onetier.vi.prefs.ServerConfigBox",urlContainer:undefined,advOptionsBox:undefined,testButton:undefined,deleteButton:undefined,advLabel:undefined,taSuccessLabel:undefined,viewFactory:undefined,connectionData:undefined,isConnectionValid:function isConnectionValid(){return isConnectionDataValid.call(this,this.connectionData);},isEditConfig:false,layoutConfig:{w:{containerNode:"100%"},xt:true},init:function init(props){this._super(props);$CSS.addWidgetCssClass(this,"ot-server-cfg");var viewFactory=this.viewFactory;var connectionData=this.connectionData=this.connectionData||{};var model=this.parent.model,id=this.id,isEditConfig=this.isEditConfig,testButtonText=isEditConfig?mstrmojo.desc(13708,"Test & Save Changes"):mstrmojo.desc(13709,"Test & Add"),children=[this.parent.getLabelAndTextBox(mstrmojo.desc(13710,"Server URL"),function(){onURLChanged.call(mstrmojo.all[id],model.parseServerURL(this.value));},connectionData.url||"",{alias:"urlContainer"}),viewFactory.getLabelAndControl("",{scriptClass:"mstrmojo.Label",cssClass:"ot-prefs-tip",text:mstrmojo.desc(13712,"Ask your administrator for the server URL and enter it here to load the connection information. You can also enter it manually in the advanced section below.")},FIRST_COL_WIDTH+$PX,"100%",false),{scriptClass:"mstrmojo.Label",alias:"advLabel",cssClass:"ot-sc-adv-lbl",text:mstrmojo.desc(702,"Advanced"),onclick:function onclick(){toggleAdvancedConfigBox.call(mstrmojo.all[id]);}},getAdvancedOptionsBox.call(this),$NWB(testButtonText,function saveNewServerConffig(){var serverConfigBox=mstrmojo.all[id],newConnectionData=serverConfigBox.connectionData,callbackFn=function(){if(serverConfigBox.isEditConfig){serverConfigBox.editServerConnection(newConnectionData);}else{serverConfigBox.saveNewServerConnection(newConnectionData);}};autoCompleteConnection.call(this,newConnectionData,callbackFn);},true,{alias:"testButton",enabled:isConnectionDataValid.call(this,this.connectionData)&&!isEditConfig})];children.push(isEditConfig?getRemoveServerBtnConfig.call(this):getCancelLabelConfig.call(this));children.push({scriptClass:"mstrmojo.Label",alias:"taSuccessLabel",cssClass:"ot-ta-success-label",visible:false});this.addChildren(children);},getLayoutOffsets:function getLayoutOffsets(){return{w:40,h:20};},onisEditConfigChange:function onisEditConfigChange(){var isEditConfig=this.isEditConfig;this.removeChildren(isEditConfig?this.cancelLabel:this.deleteButton);this.addChildren([isEditConfig?getRemoveServerBtnConfig.call(this):getCancelLabelConfig.call(this)],this.children.length-1);this.testButton.set("text",isEditConfig?mstrmojo.desc(13708,"Test & Save Changes"):mstrmojo.desc(13709,"Test & Add"));},saveNewServerConnection:mstrmojo.emptyFn,editServerConnection:mstrmojo.emptyFn,deleteServerConnection:mstrmojo.emptyFn});mstrmojo.onetier.vi.prefs.ServerConfigBox.isConnectionInfoComplete=function(data){return data.id!==undefined&&isConnectionDataValid(data);};mstrmojo.onetier.vi.prefs.ServerConfigBox.LayoutBox=$CFC(mstrmojo.Box,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.onetier.vi.prefs.ServerConfigBox.LayoutBox"});}());