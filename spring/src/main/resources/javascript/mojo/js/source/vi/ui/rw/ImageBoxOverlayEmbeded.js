(function(){mstrmojo.requiresCls("mstrmojo.string","mstrmojo.hash","mstrmojo.ui._HasScroller","mstrmojo.vi.ui.rw.selectors._HasWarningMessage","mstrmojo.vi.ui.rw._ValidInputLocalImage","mstrmojo.Box","mstrmojo._HasLayout","mstrmojo._Formattable","mstrmojo.Label","mstrmojo.Button","mstrmojo.TextBox","mstrmojo.dom","mstrmojo.imageUtils");mstrmojo.requiresDescs(1825,1442,14552);var $STR=mstrmojo.string,$IMGUTIL=mstrmojo.imageUtils,widget;mstrmojo.vi.ui.rw.ImageBoxOverlayEmbeded=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasLayout,mstrmojo._Formattable,mstrmojo.vi.ui.rw.selectors._HasWarningMessage,mstrmojo.vi.ui.rw._ValidInputLocalImage,mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.vi.ui.rw.ImageBoxOverlayEmbeded",markupString:'<div id="{@id}" class="mstrmojo-ImageBoxOverlayEmbeded {@cssClass}" style="{@domNodeCssText}" mstrAttach:dragover,dragleave,drop><div class="container-scroll-host"><div class="container"><div class="lbl"></div><div class="txt"></div><div class="buttons"><label><input class="mstrmojo-imageBoxOverlayEmbeded-file" type="file" accept=".png, .jpg, .jpeg, .gif, .bmp" onchange="mstrmojo.all.{@id}.syncFile();"/><div class="browseBtnLabel"></div></label><div class="okBtn"></div></div></div></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;},labelNode:function(){return this.domNode.firstChild.firstChild.firstChild;},textNode:function(){return this.domNode.firstChild.firstChild.children[1];},fileNode:function(){return this.domNode.firstChild.firstChild.children[2].firstChild.firstChild;},browseBtnNode:function(){return this.domNode.firstChild.firstChild.children[2].firstChild.lastChild;},okButtonNode:function(){return this.domNode.firstChild.firstChild.children[2].lastChild;}},postBuildRendering:function postBuildRendering(){this._super();this.bindWarningHandler(this);},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.containerNode;},layoutConfig:{h:{containerNode:"100%"},w:{containerNode:"100%"}},formatHandlers:{domNode:["BG"]},imageBox:undefined,imgURL:undefined,origURLStr:undefined,droppable:true,ondragover:function ondragover(evt){if(!this.droppable){return ;}var e=evt.e;e.stopPropagation();e.preventDefault();var items=e.dataTransfer.items;if(items){e.dataTransfer.dropEffect=this.VALID_MIME_TYPES.indexOf(items[0]&&items[0].type)!==-1?"copy":"none";}mstrmojo.css.addClass(this.dnDNode,"dragging");},ondragleave:function ondragleave(){if(!this.droppable){return ;}this.className="";mstrmojo.css.removeClass(this.dnDNode,"dragging");},ondrop:function ondrop(evt){if(!this.droppable){return ;}var e=evt.e;e.preventDefault();var files=e.dataTransfer.files;mstrmojo.css.removeClass(this.dnDNode,"dragging");if(files&&files.length>0){var file=files[0];this.fileSelected.call(this,file);}},children:[{scriptClass:"mstrmojo.Label",slot:"labelNode",cssClass:"init-label"},mstrmojo.Button.newActionButton(mstrmojo.desc(1442,"OK"),function(){var overlayWidget=this.parent;if(overlayWidget.imgURL.value!==overlayWidget.origURLStr){overlayWidget.imageBox.urlEdited(overlayWidget.imgURL.value);}else{overlayWidget.imageBox.hideControlOverlay();}},{alias:"okBtn",slot:"okButtonNode",enabled:false}),{scriptClass:"mstrmojo.TextBox",cssClass:"init-input",alias:"imgURL",slot:"textNode",hint:mstrmojo.desc(14552,"Enter an image URL or choose a file."),draggable:true,ownAvatar:true,onkeydown:function(eventWrapper){if(eventWrapper.e.keyCode===13){var overlayWidget=this.parent;if(overlayWidget.imgURL.value!==overlayWidget.origURLStr){overlayWidget.imageBox.urlEdited(this.value);}else{overlayWidget.imageBox.hideControlOverlay();}}},getLayoutOffsets:function getLayoutOffsets(){return{h:0,w:2};},_set_value:function(n,v){var oldValue=this.value;if(oldValue!==v){this.value=v;var okBtn=this.parent.okBtn;okBtn.set("enabled",!$STR.isEmpty(v));okBtn.set("iconClass",!$STR.isEmpty(v)?"hot":"");}}},mstrmojo.Button.newActionButton(mstrmojo.desc(1825,"Browse"),function(){if(mstrApp.isSingleTier){widget=this.parent;var formWrapper=window.FormWrapper;formWrapper.openImageFileDialog("mstrmojo.vi.ui.rw.ImageBoxOverlayEmbeded.onOneTierFileSelected");}},{alias:"browseBtn",slot:"browseBtnNode",enabled:true})],validationFailed:function(){this._super();var validation=this.getValidationObj();if(validation){validation.refNode=this.textNode;}this.set("validation",validation);this.okBtn.set("enabled",false);this.okBtn.set("iconClass","");},validationSuccess:function(processedFileStruct){this._super(processedFileStruct);this.okBtn.set("enabled",true);this.okBtn.set("iconClass","hot");},syncFile:function(){if(this.fileNode.files.length===1){var file=this.fileNode.files[0];var num=file.size/1024;this.imgURL.set("value",file.name+" - "+num.toFixed(2)+"KB");this.fileSelected.call(this,file);}}});mstrmojo.vi.ui.rw.ImageBoxOverlayEmbeded.onOneTierFileSelected=function(res){if(res&&res.data&&res.filename){var BASE64_MARKER=";base64,";if(res.data.indexOf(BASE64_MARKER)===-1){res.data="data:image/jpeg;base64,"+res.data;}var blob=$IMGUTIL.dataURLToBlob(res.data);widget.imgURL.set("value",res.filename);var mFile={fileBlob:blob,name:res.filename};widget.fileSelected.call(widget,mFile);}};}());