(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.VisChartUtils","mstrmojo._TouchGestures","mstrmojo._HasTouchScroller");function getAreaBubbleAttrFormCount(abai){var fc=0;if(abai){if(abai.length>0){fc=abai[0].length;}}return fc;}mstrmojo.AndroidImageLayout=mstrmojo.declare(mstrmojo.Vis,[mstrmojo._TouchGestures,mstrmojo._HasTouchScroller],{scriptClass:"AndroidImageLayout",markupString:'<div id="{@id}" class="mstrmojo-Chart {@cssClass}" style="position:absolute;width:{@width};height:{@height};top:{@top};left:{@left}; z-index:{@zIndex}; overflow:hidden;"  mstrAttach:mouseover,mouseout,mousedown,mousemove,mouseup,click,dblclick><div id="{@id}"-scroll-element style="position:absolute;left:0;top:0;width:{@width};height={@height}"><canvas id="{@id}-highlightCanvas" style="position:absolute;left:0;top:0;z-index:1" width="{@width}" height="{@height}"></canvas><canvas id="{@id}-animationCanvas" style="position:absolute;left:0;top:0" width="{@width}" height="{@height}"></canvas></div><div id="{@id}-tooltip" style="z-index:2" class="mstrmojo-ImageLayout-tooltip" clk="clk"><table style="margin:5px 7px"></table></div><div id="{@id}-infowindow-anchor" style="position:absolute;width:18px;height:18px;display:block;z-index:-1;"></div><div id="{@id}-css" style="display:none"></div><div id="{@id}-errMsg" align="center" style="position:absolute; top:35%; word-wrap:break-word;"></div></div>',markupSlots:{scrollableCanvasDiv:function(){return this.domNode.childNodes[0];},highlightCanvas:function(){return this.domNode.childNodes[0].firstChild;},animationCanvas:function(){return this.domNode.childNodes[0].lastChild;},tooltip:function(){return this.domNode.childNodes[1];},infowindowAnchor:function(){return this.domNode.childNodes[2];},cssDiv:function(){return this.domNode.childNodes[3];},errorMessage:function(){return this.domNode.childNodes[4];}},init:function(props){if(this._super){this._super(props);}this.sbwh=0;},scrollerConfig:{bounces:false,showScrollbars:false,useTranslate3d:true,vScroll:true,hScroll:true,offset:{y:{start:0,end:0},x:{start:0,end:0}},origin:{x:0,y:0}},isTablet:true,utils:mstrmojo.VisChartUtils,multiTouch:true,multiTap:true,postBuildRendering:function postBR(){var me=this;var sclConfig=me.scrollerConfig;sclConfig.scrollEl=me.scrollableCanvasDiv;sclConfig.offset.x.start=0;sclConfig.offset.x.end=me.getWidth()*(me.scaleFactor-1);sclConfig.offset.y.start=0;sclConfig.offset.y.end=me.getHeight()*(me.scaleFactor-1);if(sclConfig.origin.x>sclConfig.offset.x.end){sclConfig.origin.x=sclConfig.offset.x.end;}if(sclConfig.origin.y>sclConfig.offset.y.end){sclConfig.origin.y=sclConfig.offset.y.end;}me.animationCanvas.width=me.highlightCanvas.width=me.getWidth()*2;me.animationCanvas.height=me.highlightCanvas.height=me.getHeight()*2;me.createTooltipTable();me.attrFormIndices=me.getAttrFormIndices();me.areaBubbleAttrIndex=me.getAreaBubbleAttrIndex();me.areaBubbleAttrFormCount=getAreaBubbleAttrFormCount(me.attrFormIndices);if(this._super){this._super();}if(this._tn){var backup=this._tsCallback;this._tsCallback=function(e){me.savedInfowindowOn=me.realtimeInfowindowOn;me.currSelectedObjBackup=me.currSelectedObj;backup.call(this,e);};mstrmojo.dom.detachEvent(this._tn,mstrmojo.dom.TOUCHSTART,backup);mstrmojo.dom.attachEvent(this._tn,mstrmojo.dom.TOUCHSTART,this._tsCallback);}me.fullScreenListener=mstrmojo.touchManager.attachEventListener("fullScreenStateChange",this.id,function(evt){me.adjustWidgetOffsets();});},getAreaBubbleAttrElems:function getAreaBubbleAttrElems(){var areaBubbleAttrElems={},me=this,attrFormIndices=me.attrFormIndices,areaBubbleAttrIndex=me.areaBubbleAttrIndex,headerIndexLineIndexObj=me.headerIndexLineIndexObj={};if(areaBubbleAttrIndex>-1){var model=me.model,rhsItems=model&&model.ghs&&model.ghs.rhs&&model.ghs.rhs.items,gtsRows=model&&model.gts&&model.gts.row,allAreaBubbleAttrElems=gtsRows&&gtsRows.length>areaBubbleAttrIndex&&gtsRows[areaBubbleAttrIndex].es,areaBubbleAttrElemFirstFormIndex,areaBubbleAttrFirstFormName;if(rhsItems&&gtsRows&&allAreaBubbleAttrElems){var i;if(gtsRows.length===1){for(i=0;i<rhsItems.length;i++){areaBubbleAttrElemFirstFormIndex=(rhsItems[i].items&&rhsItems[i].items.length>0)?rhsItems[i].items[0].idx:-1;areaBubbleAttrFirstFormName=(areaBubbleAttrElemFirstFormIndex>-1&&allAreaBubbleAttrElems.length>areaBubbleAttrElemFirstFormIndex)?allAreaBubbleAttrElems[areaBubbleAttrElemFirstFormIndex].n:null;if(areaBubbleAttrFirstFormName&&areaBubbleAttrElemFirstFormIndex>-1){areaBubbleAttrElems[areaBubbleAttrFirstFormName.toLowerCase()]=areaBubbleAttrElemFirstFormIndex;headerIndexLineIndexObj[areaBubbleAttrElemFirstFormIndex]=i;}}}else{if(gtsRows.length>1){var rhsLength=rhsItems.length;for(i=0;i<rhsLength;i++){areaBubbleAttrElemFirstFormIndex=(rhsItems[i].items&&rhsItems[i].items.length>0)?rhsItems[i].items[0].idx:-1;var nextRowAreaBubbleAttrElemFirstFormIndex=(i+1===rhsLength)?-1:((rhsItems[i+1].items&&rhsItems[i+1].items.length>0)?rhsItems[i+1].items[0].idx:-1);if(nextRowAreaBubbleAttrElemFirstFormIndex>-1){if(areaBubbleAttrElemFirstFormIndex===nextRowAreaBubbleAttrElemFirstFormIndex){continue;}else{areaBubbleAttrFirstFormName=(allAreaBubbleAttrElems.length>areaBubbleAttrElemFirstFormIndex)?allAreaBubbleAttrElems[areaBubbleAttrElemFirstFormIndex].n:null;if(areaBubbleAttrFirstFormName&&areaBubbleAttrElemFirstFormIndex>-1){areaBubbleAttrElems[areaBubbleAttrFirstFormName.toLowerCase()]=areaBubbleAttrElemFirstFormIndex;headerIndexLineIndexObj[areaBubbleAttrElemFirstFormIndex]=i;}}}else{if(i>0){var preRowAreaBubbleAttrElemFirstFormIndex=(rhsItems[i-1].items&&rhsItems[i-1].items.length>0)?rhsItems[i-1].items[0].idx:-1;if(areaBubbleAttrElemFirstFormIndex!==preRowAreaBubbleAttrElemFirstFormIndex){areaBubbleAttrFirstFormName=(allAreaBubbleAttrElems.length>areaBubbleAttrElemFirstFormIndex)?allAreaBubbleAttrElems[areaBubbleAttrElemFirstFormIndex].n:null;if(areaBubbleAttrFirstFormName&&areaBubbleAttrElemFirstFormIndex>-1){areaBubbleAttrElems[areaBubbleAttrFirstFormName.toLowerCase()]=areaBubbleAttrElemFirstFormIndex;headerIndexLineIndexObj[areaBubbleAttrElemFirstFormIndex]=i;}}}else{if(i===0){areaBubbleAttrFirstFormName=(allAreaBubbleAttrElems.length>areaBubbleAttrElemFirstFormIndex)?allAreaBubbleAttrElems[areaBubbleAttrElemFirstFormIndex].n:null;if(areaBubbleAttrFirstFormName&&areaBubbleAttrElemFirstFormIndex>-1){areaBubbleAttrElems[areaBubbleAttrFirstFormName.toLowerCase()]=areaBubbleAttrElemFirstFormIndex;headerIndexLineIndexObj[areaBubbleAttrElemFirstFormIndex]=i;}}}}}}}}}return areaBubbleAttrElems;},setFontByDPI:function setFontByDPI(){if(this.setFontByDPIFlag){return ;}var me=this;me.setFontByDPIFlag=true;me.hoverBubbleRadiusLarger=5;me.bubbleStrokeWidth=2;me.baseMaxBubbleSizeAuto=12;me.baseMaxBubbleSizeManual=24;me.polygonStrokeWidth=1;me.highlightPolygonStrokeWidth=2;me.borderSpace=5;me.tooltipFontSize=12;me.tooltipBorderWidth=1;me.tooltipBorderRadius=5;me.errMsgFontSize=16;me.bias=30;me.tooltipRightShadowWidth=4;var xtabModel=me.xtabModel,docModel=(xtabModel&&xtabModel.docModel),fitToPage=false,microApp=false;if(docModel){fitToPage=docModel.zt&&(parseInt(docModel.zt,10)===2);var layouts=docModel.defn&&docModel.defn.layouts,layout,i;for(i in layouts){if(layouts.hasOwnProperty(i)&&layouts[i]&&layouts[i].loaded){layout=layouts[i];break;}}if(layout&&layout.hasOwnProperty("fch")){microApp=layout.fch;}}if(fitToPage&&microApp){var devicedpi=149;if(mstrMobileApp!==undefined){devicedpi=mstrMobileApp.getDeviceDPIX();}var baseDpi=149;var ratio=1;if(devicedpi>0){ratio=devicedpi/baseDpi;}if(ratio>1){me.hoverBubbleRadiusLarger*=ratio;me.bubbleStrokeWidth*=ratio;me.baseMaxBubbleSizeAuto*=ratio;me.baseMaxBubbleSizeManual*=ratio;me.polygonStrokeWidth*=ratio;me.highlightPolygonStrokeWidth*=ratio;me.borderSpace*=ratio;me.tooltipFontSize*=ratio;me.tooltipBorderWidth*=ratio;me.tooltipBorderRadius*=ratio;me.errMsgFontSize*=ratio;me.bias*=ratio;me.tooltipRightShadowWidth*=ratio;var tooltip=me.tooltip,table=tooltip.childNodes[0];tooltip.style.fontSize=me.tooltipFontSize+"px";tooltip.style.borderWidth=me.tooltipBorderWidth+"px";tooltip.style.borderRadius=me.tooltipBorderRadius+"px";tooltip.style.boxShadow=3*ratio+"px "+3*ratio+"px "+4*ratio+"px RGBA(0,0,0,0.45)";table.style.margin=5*ratio+"px "+7*ratio+"px";}}},isTouchedOnWidget:function isTouchedOnWidget(touch){if(!touch){return false;}var me=this,touchPointOnWidget=me.utils.getTouchXYOnWidget(touch.pageX,touch.pageY,me),x=touchPointOnWidget.touchX,y=touchPointOnWidget.touchY;if(x>0&&x<me.getWidth()&&y>0&&y<me.getHeight()){return true;}return false;},getAttrFormIndices:function getAttrFormIndices(){var me=this,model=me.model,rows=model&&model.gts&&model.gts.row,i,j,attrFormIndices=[];if(rows){var idx=0;for(i=0;i<rows.length;i++){var fs=rows[i]&&rows[i].fs;attrFormIndices.push([]);if(fs){for(j=0;j<fs.length;j++){attrFormIndices[i].push(idx++);}}}}else{attrFormIndices=null;}return attrFormIndices;},getAreaBubbleAttrIndex:function getAreaBubbleAttrIndex(){var me=this,model=me.model,rows=model&&model.gts&&model.gts.row,index=-1;if(rows&&rows.length>0){index=0;}return index;},touchMultiBegin:function(touch){this.hideTooltip();var touch1,touch2;if(touch.evt.touches&&touch.evt.touches.length===2){touch1=touch.evt.touches[0];touch2=touch.evt.touches[1];}else{touch1=touch;touch2={pageX:100,pageY:100};}var xDiff=touch1.pageX-touch2.pageX,yDiff=touch1.pageY-touch2.pageY;this.initDiffDiff=xDiff*xDiff+yDiff*yDiff;this.initCenterX=(touch1.pageX+touch2.pageX)>>1;this.initCenterY=(touch1.pageY+touch2.pageY)>>1;this.initScrollX=this._scroller.origin.x;this.initScrollY=this._scroller.origin.y;this.relScaleFactor=1;},touchMultiMove:function(touch){var touch1,touch2;if(touch.evt.touches&&touch.evt.touches.length===2){touch1=touch.evt.touches[0];touch2=touch.evt.touches[1];}else{touch1=touch;touch2={pageX:100,pageY:100};}var xDiff=touch1.pageX-touch2.pageX,yDiff=touch1.pageY-touch2.pageY,curDiffDiff=xDiff*xDiff+yDiff*yDiff,curCenterX=(touch1.pageX+touch2.pageX)>>1,curCenterY=(touch1.pageY+touch2.pageY)>>1;var scale=Math.sqrt(curDiffDiff/this.initDiffDiff);var offset={x:scale*(this.initCenterX+this.initScrollX)-curCenterX,y:scale*(this.initCenterY+this.initScrollY)-curCenterY};var transform={scale:scale,offset:offset};this.relScaleFactor=scale;this.applyTransform(transform);},touchMultiEnd:function(touch){if(this.relScaleFactor*this.scaleFactor<1){this.relScaleFactor=1/this.scaleFactor;this.applyTransform({scale:this.relScaleFactor},500,this.postScale);}else{if(this.relScaleFactor*this.scaleFactor>2){var scaleBack=this.relScaleFactor*this.scaleFactor/2;this.relScaleFactor=2/this.scaleFactor;this.applyTransform({scale:this.relScaleFactor,scaleBack:scaleBack},500,this.postScale);}else{this.postScale();}}},applyTransform:function(transform,duration,callback){var scl=this._scroller;if(duration===undefined){duration=0;}scl.scrollEl.style.webkitTransformOrigin="left top";scl.transform="scale("+transform.scale+","+transform.scale+")";var scrollX,scrollY;if(transform.offset){scrollX=transform.offset.x;scrollY=transform.offset.y;}else{var scaleBack=transform.scaleBack||1;scrollX=this._scroller.origin.x/scaleBack;scrollY=this._scroller.origin.y/scaleBack;}var scrollerOffsetScale=this.scaleFactor*this.relScaleFactor-1,vOffsetEnd=this.getHeight()*scrollerOffsetScale,hOffsetEnd=this.getWidth()*scrollerOffsetScale;if(scrollerOffsetScale<0){scl.offset={y:{start:vOffsetEnd,end:0},x:{start:hOffsetEnd,end:0}};}else{scl.offset={y:{start:0,end:vOffsetEnd},x:{start:0,end:hOffsetEnd}};}this._scroller.scrollTo(scrollX,scrollY,duration);if(callback){var that=this;setTimeout(function(){callback.apply(that);that=null;},duration);}},postScale:function(){delete this._scroller.transform;this._scroller.scrollTo(this._scroller.origin.x,this._scroller.origin.y,0);this.scaleFactor*=this.relScaleFactor;this.refreshWidget();},refreshWidget:function(){this.drawMap();this.highlightPoint();},initScroller:function initScroller(scroller){scroller.vScroll=true;scroller.hScroll=true;this._super(scroller);},getWidgetXY:function getWidgetXY(touch){var widgetXY=this.utils.getTouchXYOnWidget(touch.pageX,touch.pageY,this);touch.widgetX=widgetXY.touchX;touch.widgetY=widgetXY.touchY;},touchSelectBegin:function touchSelectBegin(touch){console.log("touchSelectBegin");if(touch.evt.ctrlKey){this.touchMultiBegin(touch);return ;}this.getWidgetXY(touch);this.touchSelectBegin_mouseOver(touch);},touchSelectMove:function touchSelectMove(touch){console.log("touchSelectMove");if(touch.evt.ctrlKey){this.touchMultiMove(touch);return ;}this.getWidgetXY(touch);this.touchSelectMove_mouseMove(touch);},touchSelectEnd:function touchSelectEnd(touch){console.log("touchSelectEnd");if(touch.evt.ctrlKey){this.touchMultiEnd(touch);return ;}this.getWidgetXY(touch);this.touchSelectEnd_mouseOut(touch);},touchSwipeBegin:function touchSwipeBegin(touch){console.log("touchSwipeBegin");this.touchSwipeBegin_mouseDown(touch);if(this._super){this._super(touch);}},touchTap:function touchTap(touch){console.log("touchTap");this.getWidgetXY(touch);if(touch.count===2){this.touchDblTap_dblClick(touch);}else{if(touch.count===1){this.touchTap_click(touch);}}}});}());