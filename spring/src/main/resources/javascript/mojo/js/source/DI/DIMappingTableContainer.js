(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.qb.DBTableView","mstrmojo.qb.EnumDataChangeEvents","mstrmojo.qb.EnumDragActions","mstrmojo.qb.EnumMenuActions","mstrmojo.dom","mstrmojo.hash","mstrmojo.array");var $DOM=mstrmojo.dom,$H=mstrmojo.hash,$ARR=mstrmojo.array,$CSS=mstrmojo.css,$STR=mstrmojo.string,$PX="px",constants=mstrmojo.DI.DIConstants,TABLE_DEFAULT_Y=16,DEFAULT_HEIGHT=260+4,DEFAULT_WIDTH=175;function isPosCovered(pos,data){var posx,posy,isCoverd=false;if(!pos||!data){return false;}posx=parseInt(pos.x,10);posy=parseInt(pos.y,10);$H.forEach(data,function(v){var x,y,w,h;var maxLeft=0,maxTop=0,minRight=0,minBottom=0;if(!v.x||!v.y){return ;}x=parseInt(v.x,10);y=parseInt(v.y,10);w=parseInt(v.w,10);h=parseInt(v.h,10);if(isNaN(w)){w=DEFAULT_WIDTH;}if(isNaN(h)){h=DEFAULT_HEIGHT;}maxLeft=x>posx?x:posx;maxTop=y>posy?y:posy;minRight=(x+w)<(posx+DEFAULT_WIDTH)?(x+w):(posx+DEFAULT_WIDTH);minBottom=(y+h)<(posy+DEFAULT_HEIGHT)?(y+h):(posy+DEFAULT_HEIGHT);if(maxLeft<=minRight&&maxTop<=minBottom){isCoverd=true;return false;}});return isCoverd;}mstrmojo.DI.DIMappingTableContainer=mstrmojo.declare(mstrmojo.qb.TableContainer,null,{scriptClass:"mstrmojo.DI.DIMappingTableContainer",dropZone:false,joinInfos:null,clickedNode:null,postCreate:function postCreate(){if(this._super){this._super();}var m=this.parent.model;m.attachEventListener("CurrentSourceChanged",this.id,"updateSelected");m.attachEventListener("MappingsFetched",this.id,"update");m.attachEventListener("scrollToTable",this.id,"showTable");this.attachEventListener("allTableSelectionClear",this.id,"clearAllTableSelection");},postBuildRendering:function postBuildRendering(){var me=this;if(this._super){this._super();}window.setTimeout(function(){me.update();},0);},clearAllTableSelection:function clearAllTableSelection(evt){$ARR.forEach(this.children,function(child){if(evt&&evt.source&&evt.source.id===child.tableData.id){return true;}else{child.clearRowSelections();}});},recordTableData:function recordTableData(){var tables=this.children;var containerPosition=$DOM.position(this.containerNode),item,x,y,itemMap={},tableID,node;$ARR.forEach(tables,function(table){var tablePosition=null;if(table.domNode){tablePosition=$DOM.position(table.domNode);}tableID=table.tableData.id;if(tablePosition){x=tablePosition.x-containerPosition.x;y=tablePosition.y-containerPosition.y;if(x<0){return false;}item={x:(x+$PX),y:(y+$PX),w:tablePosition.w,h:tablePosition.h,shouldExpand:table.isExpanded};if(table.attrRows&&table.attrRows.domNode){node=table.attrRows.domNode;item.attrRowsScroll=node.scrollTop;item.attrRowsHeight=node.clientHeight;}if(table.metricRows&&table.metricRows.domNode){node=table.metricRows.domNode;item.metricRowsScroll=node.scrollTop;item.metricRowsHeight=node.clientHeight;}itemMap[tableID]=item;}else{itemMap[tableID]=null;}});return itemMap;},selectLinkedAttribute:function selectLinkedAttribute(evt){var alias=evt.alias,oid=evt.oid,i,j,join,links,joins=this.joinInfos&&this.joinInfos.joins,srcTableId,tgtTableId,srcTableWidget,tgtTableWidget,srcItemNode,tgtItemNode;if(evt.source&&evt.source.tableData){srcTableWidget=this.findTableById(evt.source.tableData.id);if(evt.oid){srcTableWidget.selectItemById(evt.oid);}else{if(evt.alias){srcTableWidget.selectItemByName(evt.alias);}}}if(joins){for(i=0;i<joins.length;i++){join=joins[i];links=join.links;for(j=0;j<links.length;j++){if(links[j].source.alias===alias){srcTableId=links[j].source.tableId;tgtTableId=links[j].target.tableId;srcTableWidget=this.findTableById(srcTableId);tgtTableWidget=this.findTableById(tgtTableId);if(oid){if(srcTableWidget){srcItemNode=srcTableWidget.selectItemById(oid);}if(tgtTableWidget){tgtItemNode=tgtTableWidget.selectItemById(oid);}}else{if(alias){if(srcTableWidget){srcItemNode=srcTableWidget.selectItemByName(alias);}if(tgtTableWidget){tgtItemNode=tgtTableWidget.selectItemByName(alias);}}}if(tgtItemNode&&tgtTableWidget&&srcItemNode&&srcTableWidget&&(evt.source.parent===tgtTableWidget||evt.source.parent===srcTableWidget)){if(links[j].source.tp===12&&links[j].target.tp===12){this.parent.linker.drawLink(tgtItemNode,tgtTableWidget,srcItemNode,srcTableWidget);}}}}}}},findTableById:function findTableById(id){var i;for(i=0;i<this.children.length;i++){if(this.children[i].tableData.id===id){return this.children[i];}}},updateSelected:function(){var me=this,m=this.parent.model,tables;tables=$ARR.filter(me.children,function(child){return child.scriptClass==="mstrmojo.DI.DIMappingTable";});$ARR.forEach(tables,function(table){var tableID=table.tableData.id,bSelected=m.currentSource&&(m.currentSource.tableID===tableID);table.set("selected",bSelected);$CSS.toggleClass(table.domNode,"selected",bSelected);});},onremoveChild:function(evt){var children=evt.value;for(var i=0;i<children.length;i++){children[i].destroy();}},update:function update(){var items,source,sourceInfo,partition;var i,tableData,data,maps,m=this.parent.model,pos,disableNewTables=false,scrollLeft,arrangedTables,k,isFirstTime=true;if(!this.hasRendered){return ;}scrollLeft=this.domNode.scrollLeft;if(this.children){data=this.recordTableData();this.removeChildren();isFirstTime=false;}var index=0;var mappingsFilterFunc=function(map){return map.selected;};var clickedNode=this.clickedNode;function rearrangeTables(importSources){var i,srcTableID,info={},srcTables=[],tables=[];for(i in importSources){srcTableID=importSources[i].srcTableID||i;if(!info[srcTableID]){info[srcTableID]=[];srcTables.push(srcTableID);}info[srcTableID].push(i);}$ARR.forEach(srcTables,function(srcTableID){tables=tables.concat(info[srcTableID]);});return tables;}arrangedTables=rearrangeTables(m.importSources);for(k=0;k<arrangedTables.length;k++){i=arrangedTables[k];if(!m.importSources[i].sourceInfo){continue;}if(m.importSources[i].currentTransformations&&m.importSources[i].currentTransformations.xtab&&m.importSources[i].currentTransformations.xtab.isCrosstab){maps=m.importSources[i].transformedMapping;}else{maps=m.importSources[i].currentMapping;}items=mstrmojo.hash.clone(maps);items=mstrmojo.array.filter(items,mappingsFilterFunc);if(!items){continue;}source=m.importSources[i];sourceInfo=source.sourceInfo;partition=sourceInfo.partition;tableData={n:sourceInfo.name,items:items,id:source.tableID,idx:index++,partition:partition&&partition.tables,type:source.type,subtype:source.subtype};if(tableData.subtype===constants.sourceSubtype.searchOnSource){disableNewTables=true;}var controller=mstrApp.getRootController();if(tableData.subtype===constants.sourceSubtype.hadoop&&controller.model.isDirectDataAccess){disableNewTables=true;}pos=null;if(isFirstTime){if(source.tablePosition){pos={};if(source.tablePosition.x){pos.x=Math.max(source.tablePosition.x,0)+$PX;}if(source.tablePosition.y){pos.y=Math.max(source.tablePosition.y,0)+$PX;}if(source.tablePosition.w){pos.w=source.tablePosition.w+$PX;}if(source.tablePosition.h){pos.h=source.tablePosition.h+$PX;}}}if(!pos&&data){pos=data[i];}$H.copy(pos,tableData);data=this.addTable(tableData,data);}for(i in m.importSources){if(!m.importSources[i].sourceInfo){continue;}if(m.importSources[i].currentTransformations&&m.importSources[i].currentTransformations.xtab&&m.importSources[i].currentTransformations.xtab.isCrosstab){maps=m.importSources[i].transformedMapping;}else{maps=m.importSources[i].currentMapping;}items=mstrmojo.hash.clone(maps);items=mstrmojo.array.filter(items,mappingsFilterFunc);if(!items){continue;}source=m.importSources[i];if(clickedNode&&source.tableID===clickedNode.tableId){var z,tableNode,children=this.children;for(k=0;k<children.length;k++){if(children[k].tableData.id===clickedNode.tableId){tableNode=children[k];break;}}if(clickedNode.tableRow.alias==="metricRows"){var metricRowsItems=tableNode.metricRows.items;for(z=0;z<metricRowsItems.length;z++){if(clickedNode.node.innerText&&metricRowsItems[z].alias===clickedNode.node.innerText.replace("\xA0"," ")){tableNode.metricRows.raiseEvent({name:"selectLinkedItems",source:tableNode.metricRows,oid:metricRowsItems[z].oid,alias:metricRowsItems[z].alias});}}}else{var attrRowsItems=tableNode.attrRows.items;for(z=0;z<attrRowsItems.length;z++){if(clickedNode.node.innerText&&attrRowsItems[z].alias===clickedNode.node.innerText.replace("\xA0"," ")){tableNode.attrRows.raiseEvent({name:"selectLinkedItems",source:tableNode.attrRows,oid:attrRowsItems[z].oid,alias:attrRowsItems[z].alias});}}}}}if(this.children&&this.children.length>1){this.joinInfos={joins:this.addJoinInfos()};}this.domNode.scrollLeft=scrollLeft;this.parent.set("disableNewTables",disableNewTables);},addTable:function addTable(tableData,recordData){var tableContainer=this;var tableID=tableData.id;var m=this.parent.model;var bSelected=m.currentSource&&(m.currentSource.tableID===tableID),cssGroup="",pos,i,partition;if((tableData.x===undefined)||(tableData.y===undefined)){i=0;while(!pos||isPosCovered(pos,recordData)){pos={x:(i*209)+$PX,y:TABLE_DEFAULT_Y+$PX};i++;}}if(pos){tableData=$H.copy(pos,tableData);if(!recordData){recordData={};}recordData[tableID]=pos;}partition=tableData.partition;if(partition&&partition.length>1){cssGroup="partition-group";}tableContainer.addChildren([new mstrmojo.DI.DIMappingTable({alias:"table",tableData:tableData,left:tableData.x,top:tableData.y,height:tableData.h,width:tableData.w,shouldExpand:tableData.shouldExpand,attrRowsScroll:tableData.attrRowsScroll,metricsScroll:tableData.metricRowsScroll,attrRowsHeight:tableData.attrRowsHeight,metricRowsHeight:tableData.metricRowsHeight,model:m,linker:this.parent.linker,selected:bSelected,cssClass:bSelected?"selected":"",group:cssGroup,convertEnabled:tableData.subtype!==constants.sourceSubtype.hanaSingleTable,initSelectNode:tableData.initSelectNode})]);return recordData;},addJoinInfos:function(){var i,j;var joins=[],links;for(i=0;i<this.children.length;i++){for(j=i+1;j<this.children.length;j++){links=this.findCommonRows(this.children[i],this.children[j]);if(links&&links.length>0){joins.push({targetTable:this.children[i],sourceTable:this.children[j],links:links});}}}return joins;},findCommonRows:function(tableA,tableB){var attributesFromA=tableA.attrRows.items,attributesFromB=tableB.attrRows.items,metricFromA=tableA.metricRows.items,metricFromB=tableB.metricRows.items,links=[];$ARR.forEach(attributesFromA,function(itemA){$ARR.forEach(attributesFromB,function(itemB){if(itemA.oid&&itemB.oid&&itemA.oid===itemB.oid){links.push({target:itemA,source:itemB});}});});$ARR.forEach(metricFromA,function(itemA){$ARR.forEach(metricFromB,function(itemB){if(itemA.alias&&itemB.alias&&itemA.alias===itemB.alias){links.push({target:itemA,source:itemB});}});});return links;},showTable:function showTable(evt){var tableID=evt.value,mappingTable=null,tableNode,tableStyle,left,top,offsetWidth,offsetHeight,containerNode,containerStyle,containerWidth,containerHeight,containerScrollLeft,containerScrollTop;$ARR.forEach(this.children,function(table){if(table.tableData.id===tableID){mappingTable=table;return false;}});if(!mappingTable){return ;}tableNode=mappingTable.domNode;tableStyle=tableNode.style;left=parseInt(tableStyle.left);top=parseInt(tableStyle.top);if(left<0||top<0){return ;}offsetWidth=tableNode.offsetWidth;offsetHeight=tableNode.offsetHeight;containerNode=this.domNode;containerStyle=containerNode.style;containerWidth=parseInt(containerStyle.width);containerHeight=parseInt(containerStyle.height);containerScrollLeft=containerNode.scrollLeft;containerScrollTop=containerNode.scrollTop;if(left-containerScrollLeft<0||left-containerScrollLeft+offsetWidth>containerWidth){containerNode.scrollLeft=left;}if(top-containerScrollTop<0||top-containerScrollTop+offsetHeight>containerHeight){containerNode.scrollTop=top-TABLE_DEFAULT_Y;}}});}());