(function(){mstrmojo.requiresCls("mstrmojo.Container");var _D=mstrmojo.dom;var diHelper=mstrmojo.DI.DIHelpers;function handleMouseDown(evt){var column=this.columnIndex;var row=this.rowIndex;this.preview.downColumn=column;this.preview.downRow=row;this.preview.controller.isClickedInDatePreview=true;this.preview.controller.model.raiseEvent({name:"columnSelected",columnIndex:this.columnIndex,columnName:this.columnName,isCtrlKey:diHelper.isCtrlKey(evt.hWin,evt.e)});}function handleMouseUp(evt){var element=evt.e.srcElement;var col=this.columnIndex;var row=this.rowIndex;if(this.preview.downColumn===col&&this.preview.downRow===row){var selObj=null,range,startOffset,endOffset;var textLength=String(this.text).length;var text=String(this.text);if(window.getSelection){selObj=window.getSelection();range=selObj.getRangeAt(0);startOffset=range.startOffset;endOffset=range.endOffset;if(!range.collapsed&&range.startContainer===range.endContainer){this.preview.controller.generateSuggestions(col,this.preview.columns[col].name,text,textLength,startOffset,endOffset,this.preview.columns,this);}else{this.preview.controller.resetRecords();}}else{selObj=document.selection;range=selObj.createRange();var stored_range=range.duplicate();stored_range.moveToElementText(element);stored_range.setEndPoint("EndToEnd",range);startOffset=stored_range.text.length-range.text.length;endOffset=startOffset+range.text.length;this.preview.controller.generateSuggestions(col,this.preview.columns[col].name,text,textLength,startOffset,endOffset,this.preview.columns,this);}}}function handleEditCell(){var controller=this.parent.parent.controller;controller.resetRecords();controller.model.raiseEvent({name:"columnUnSelected"});var col=this.columnIndex;var cell=this.column[col].cellIndex;var row=this.rowIndex;var posDom=_D.position(this.domNode);var posData=_D.position(this.preview.dataNode);var delta=(posDom.x+posDom.w)-(posData.x+posData.w);if(delta>0){this.preview.tableNode.scrollLeft=this.preview.tableNode.scrollLeft+delta;posDom=_D.position(this.domNode);posData=_D.position(this.preview.dataNode);}else{if(posDom.x-posData.x<0){this.preview.tableNode.scrollLeft=this.preview.tableNode.scrollLeft-(posData.x-posDom.x);posDom=_D.position(this.domNode);posData=_D.position(this.preview.dataNode);}}var floatLeft=(posDom.x+posDom.w+72)<=(posData.x+posData.w);var left=(floatLeft?(posDom.x):(posDom.x-72-3))-1-1-3;var top=posDom.y-1-1-3;var preview=this.preview;mstrmojo.insert({scriptClass:"mstrmojo.PopupEditBox",top:top+document.body.scrollTop+"px",left:left+document.body.scrollLeft+"px",width:posDom.w+72+2+3+"px",text:String(this.text).replace(/\n/g," "),value:String(this.text),preview:preview,columnName:this.columnName,row:row,cell:cell,type:this.cssClass,floatLeft:floatLeft}).render();}function handleBlur(){if(this.preview.columnIndex>=0){if(this.preview.lastColumnIndex>=0&&this.preview.columnIndex>=this.preview.lastColumnIndex){this.preview.controller.generateColumnSuggestions(this.preview.columnIndex,this.preview.lastColumnName,this.preview.columnIndex-this.preview.lastColumnIndex+1);}else{this.preview.controller.generateColumnSuggestions(this.preview.columnIndex);}}if(this.preview.controller.isClickedInTransformation){this.preview.controller.resetRecords();this.preview.controller.isClickedInTransformation=false;}if(window.getSelection){window.getSelection().removeAllRanges();}else{document.selection.empty();}}mstrmojo.Refine.RefineDataCell=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.Refine.RefineDataCell",markupString:'<div tabindex="-1" id="{@id}" class="refine-cell-node {@cssClass}" style="{@cssText}" mstrAttach:mousedown,mouseup,blur,dblclick><div class="refine-cell-text-container"><div class="refine-cell-pseudo-text"></div><div class="refine-cell-text"></div></div></div>',markupSlots:{pseudoNode:function(){return this.domNode.firstChild.firstChild;},textNode:function(){return this.domNode.firstChild.children[1];}},markupMethods:{ontextChange:function(){this.textNode.innerHTML=mstrmojo.string.encodeHtmlString(String(this.text).replace(/\n/g," ")||"",null,true);this.textNode.title=this.text;this.pseudoNode.innerHTML=mstrmojo.string.encodeHtmlString(String(this.text).replace(/\n/g," ")||"",null,true);}},resetText:function(){if(this.pseudoNode){this.pseudoNode.innerHTML=mstrmojo.string.encodeHtmlString(String(this.text)||"",null,true);}},highlightSelectedText:function(startOffset,endOffset){this.pseudoNode.innerHTML=mstrmojo.string.encodeHtmlString(String(this.text).substring(0,startOffset),null,true)+'<span class="refine-selected-text">'+mstrmojo.string.encodeHtmlString(String(this.text).substring(startOffset,endOffset),null,true)+"</span>"+mstrmojo.string.encodeHtmlString(String(this.text).substring(endOffset),null,true);},columnIndex:null,preview:null,onmousedown:handleMouseDown,onmouseup:handleMouseUp,ondblclick:handleEditCell,onblur:handleBlur});}());