(function(){mstrmojo.requiresCls("mstrmojo.HBox","mstrmojo.Box","mstrmojo.Table","mstrmojo.DataGrid","mstrmojo.qb.AttributeMapping","mstrmojo.qb.TimeDimension","mstrmojo.qb.GeoRole");mstrmojo.requiresDescs(218,219,517,518,629,1088,1388,2052,2170,3434,3544,4530,4699,8984,9133,9134,9912,9918,9919,9920,9921,9922,11170,11171,11621,12927,13036);var _C=mstrmojo.css,_D=mstrmojo.dom,$S=mstrmojo.string;var GEO_ROLE_TOOLTIP=mstrmojo.desc(11170,"This column contains geographical locations. Additional columns will be created automatically so that you can view your data on Google Maps. See menu options for details."),TIME_DIMENSION_TOOLTIP=mstrmojo.desc(11171,"This column contains date values. Additional columns will be created automatically. See menu options for details.");var _getUniqueName=function(name,mp,tp){var nhash={},nn=name,i,len;for(i=0,len=mp.length;i<len;i++){(mp[i].tp==tp)&&(nhash[mp[i].alias]=1);}i=0;while(nhash[nn]){nn=name+" ("+(++i)+")";}return nn;};function _getTimeWidget(mode,h,der){var id="mstrmojo-di-timedimension";var wgt=mstrmojo.all[id];if(!wgt){wgt=new mstrmojo.qb.TimeDimension({height:h,mode:mode,der:der});}else{wgt.set("height",h);wgt.set("mode",mode);wgt.set("der",der);}return wgt;}function _getGeoWidget(georole,der,shapeKey,shapeKeys){var id="mstrmojo-di-georole";var wgt=mstrmojo.all[id];if(!wgt){wgt=new mstrmojo.qb.GeoRole({height:"200px",georole:georole,der:der,shapeKey:shapeKey,shapeKeys:shapeKeys});}else{wgt.set("georole",georole);wgt.set("der",der);wgt.set("shapeKey",shapeKey);}return wgt;}var _menus=[{did:"QBAttribute",n:mstrmojo.desc(518,"Attribute"),items:[{did:"QBTimeGeo"}]},{did:"QBMetric",n:mstrmojo.desc(517,"Metric")},{did:"QBNone",n:mstrmojo.desc(13036,"Do Not Import")},{did:-1,n:"-"},{did:"QBRename",n:mstrmojo.desc(1388,"Rename")},{did:"QBMap",n:mstrmojo.desc(9133,"Map to project ...")},{did:"QBUnMap",n:mstrmojo.desc(9134,"Unmap from project")},{did:-1,n:"-"},{did:"QBEdit",n:mstrmojo.desc(1088,"Edit")},{did:"QBRemove",n:mstrmojo.desc(629,"Delete")}];function _restrictDerivedFlags(w,mapping,dtp){var limiter,DATA_TYPE_LIMITER={1:1|2|4|8|16|32|64|128|256|512|1024|2048|4096,8:1|2|4|8|16|32|64|128|256|512,9:1024|2048|4096};limiter=DATA_TYPE_LIMITER[dtp];limiter=limiter?limiter:(268435456|536870912|1073741824);w.der=w.der&limiter;mapping.der=w.der;}var _cxtMenu={scriptClass:"mstrmojo.MenuButton",cssClass:"mstrmojo-di-datapreview-cxtmenu",cmCssClass:"mstrmojo-di-datapreview-popmenu",id:"mstrmojo-di-datapreview-cm",postCreate:function(){if(!mstrApp.isCloudPro){_menus=_menus.concat([{did:-1,n:"-"},{did:"QBDataType",n:mstrmojo.desc(9918,"Data Type"),items:[{did:"2",n:mstrmojo.desc(3434,"Number")},{did:"3",n:mstrmojo.desc(3544,"Text")},{did:"8",n:mstrmojo.desc(2052,"Date")},{did:"1",n:mstrmojo.desc(9919,"DateTime")},{did:"9",n:mstrmojo.desc(2170,"Time")},{did:"11",n:mstrmojo.desc(9920,"Big Decimal")},{did:"6",n:mstrmojo.desc(4699,"Email")},{did:"7",n:mstrmojo.desc(9921,"HTML Tag")},{did:"12",n:mstrmojo.desc(8984,"Phone Number")},{did:"10",n:mstrmojo.desc(4530,"Symbol")},{did:"5",n:mstrmojo.desc(9922,"URL")}]}]);}this.cm=_menus;},getMenuPosition:function getMenuPosition(){var pos=mstrmojo.dom.position(this.domSrc,true);return{x:Math.round(pos.x),y:Math.round(pos.y+pos.h)};},dataGrid:null,widget:null,dynamicUpdate:true,queryEnabled:function(item){var currentWidget=this.widget;switch(item.did){case"QBAttribute":return !currentWidget.ipa;break;case"QBMetric":return(currentWidget.tp!=4)&&!currentWidget.ipa;break;case"QBNone":return currentWidget.mapped;break;case"QBRename":return currentWidget.mapped&&!currentWidget.ipa;break;case"QBEdit":case"QBMap":return !currentWidget.ipa;break;case"QBUnMap":return currentWidget.ipa;break;default:return true;}},queryVisible:function(item){var datagrid=this.dataGrid,w=this.widget;switch(item.did){case"QBAttribute":case"QBMetric":case"QBRename":return this.widget.hasMapped;break;case"QBMap":case"QBUnMap":return this.widget.hasMapped&&this.widget.tp==12&&this.widget.sptMap;break;case"QBEdit":return !!this.widget.isQB;break;case"QBRemove":return !!this.widget.isQB&&(!this.widget.isReadOnly);break;case"QBNone":return !!this.widget.isDI;break;case"QBDataType":return this.widget.hasMapped&&this.widget.sptGeo&&this.widget.tp==12;break;default:return true;}},queryChecked:function(item){var w=this.widget;var i=parseInt(item.did,10);if(i>0&&i<=12){return i==w.dtp;}return false;},executeCommand:function(item){var did=this.widget.did;var model=this.dataGrid.model;var m=model.mappings;var idx=mstrmojo.array.find(m,"did",did);var datagrid=this.dataGrid;var _bak;if(idx!=-1){_bak=mstrmojo.hash.copy(m[idx]);}var cb={failure:function(res){m[idx]=_bak;datagrid.populatePreview();}};switch(item.did){case"QBAttribute":if(idx!=-1){m[idx].alias=m[idx].isPA?m[idx].alias:_getUniqueName(m[idx].alias,m,12);m[idx].tp=12;m[idx].selected=true;if(m[idx].isPA){m[idx].ipa=1;}this.dataGrid.populatePreview();if(model.remap){model.remap({did:m[idx].did,alias:m[idx].alias,ot:12},cb);}}break;case"QBMetric":if(idx!=-1){m[idx].alias=_getUniqueName(m[idx].alias,m,4);m[idx].tp=4;m[idx].selected=true;m[idx].dtp=2;this.dataGrid.populatePreview();if(model.remap){model.remap({did:m[idx].did,alias:m[idx].alias,ot:4},cb);}}break;case"QBNone":if(idx!=-1){if(model.unimport){model.unimport(did,m[idx]);}}break;case"QBRename":var alias=m[idx].alias;var w=this.widget;var width=w.domNode.parentNode.clientWidth-25;width=(width>0)?(width+"px"):"20px";var left=_D.position(w.domNode).x-_D.position(datagrid.domNode).x+datagrid.scrollboxNode.scrollLeft+20+"px";datagrid.openPopup("inlineTextRef",{top:(_D.isIE?0:-1)+"px",left:left,txtConfig:{value:alias||"",width:width,onEnter:function(){var v=$S.trim(this.value),isValid=false;this.parent.close({enter:true});if(v===m[idx].alias){return ;}if(model.validateRename){isValid=model.validateRename(v);}else{isValid=(v===_getUniqueName(v,m,m[idx].tp));}if(isValid){m[idx].alias=v;w.set("text",$S.encodeHtmlString(v));model.remap&&model.remap({did:w.did,alias:v},cb);}else{var msg=mstrmojo.desc(12927,"The name ## has been used by another column. Please give a new name.");mstrmojo.alert($S.encodeHtmlString(msg.replace("##",v)),null,model.alertTitle);}}}});break;case"QBEdit":var idx=this.widget.ix,rowwidget=model.selectedClns[idx],ENUM_EXPRESSION_TYPE_EXISTING_COLUMN=3;mstrApp.getRootController().openExpressionEditor({type:ENUM_EXPRESSION_TYPE_EXISTING_COLUMN,w:rowwidget,tkn:rowwidget.expr,cIndex:idx+1});break;case"QBRemove":var w=this.widget;var cIndex=w.ix+1;if(model.removeSelectedColumn){model.removeSelectedColumn(cIndex);}break;case"QBMap":var datagrid=this.dataGrid,w=this.widget,pos=_D.position(w.domNode),cur=model.mappings[idx],openAttributeMapping=function openEditor(){var sb=new mstrmojo.qb.AttributeMapping({model:model});sb.placeholder=document.body.appendChild(document.createElement("div"));sb.top=pos.y+22+"px";sb.left=pos.x+"px";sb.did=w.did;sb.target=w;sb.open();},buttonCfg={confirmBtn:{t:mstrmojo.desc(219,"Yes"),fn:function(){openAttributeMapping();}},cancelBtn:{t:mstrmojo.desc(218,"No")}};_C.toggleClass(w.domNode,"highlight",true);if(cur.georole){mstrmojo.confirm(mstrmojo.desc(9912,"Mapping this column to a project attribute will remove its geographical role and any derived attributes. Do you want to continue?"),buttonCfg);}else{if(cur.der){mstrmojo.confirm(mstrmojo.desc(11621,"Mapping this column to a project attribute will remove all related derived date/time attributes. Do you want to continue?"),buttonCfg);}else{openAttributeMapping();}}break;case"QBUnMap":if(model.unmap){model.unmap(did,m[idx].oid);}break;case"1":case"8":case"9":case"2":case"3":case"4":case"5":case"6":case"7":case"10":case"11":case"12":var w=this.widget;var dtp=parseInt(item.did,10);if(w.dtp!=dtp){w.dtp=dtp;model.mappings[idx].dtp=dtp;model.remap&&model.remap({did:did,bft:dtp},cb);if(dtp==1||dtp==8||dtp==9){w.georole=0;_C.removeClass(w.domNode,"geo");!w.ipa&&_C.addClass(w.domNode,"time");}else{_C.removeClass(this.widget.domNode,"time");}_restrictDerivedFlags(w,model.mappings[idx],dtp);}break;case"QBTime":if(idx!=-1){var cur=model.mappings[idx];cur.tp=12;cur.selected=true;cur.der=item.der;datagrid.populatePreview();}break;case"QBGeo":if(idx!=-1){var cur=model.mappings[idx];cur.tp=12;cur.selected=true;cur.georole=item.georole;cur.der=item.der;cur.shapeKey=item.shapeKey;datagrid.populatePreview();}break;default:break;}}};function openCxtMenu(src,domSrc,data){var id="mstrmojo-di-datapreview-cm",e=mstrmojo.all[id];var datagrid=src.parent.dataGrid;if(!e){e=mstrmojo.insert(_cxtMenu);e.set("domSrc",domSrc);e.widget=src;e.dataGrid=datagrid;e.render();}else{e.widget=src;e.dataGrid=datagrid;e.set("domSrc",domSrc);}e._subMenu&&e._subMenu.domNode&&e._subMenu.domNode.parentNode.removeChild(e._subMenu.domNode);e._subMenu=null;if(src.sptGeo&&src.tp!=4&&src.tp!=0&&!src.ipa){var cfg={},useGeo=true;switch(src.dtp){case 8:cfg={height:"220px",mode:1};useGeo=false;break;case 9:cfg={height:"100px",mode:2};useGeo=false;break;case 1:cfg={height:"260px",mode:3};useGeo=false;break;default:cfg={georole:src.georole};break;}if(useGeo){var model=datagrid.model;_menus[0].items=[{did:"QBGeo",itemWidget:_getGeoWidget(src.georole,src.der,src.shapeKey,model.shapeKeys)}];}else{_menus[0].items=[{did:"QBTime",itemWidget:_getTimeWidget(cfg.mode,cfg.height,src.der)}];}}else{delete (_menus[0].items);}e.cm=_menus;e.showContextMenu();}function getAttributesMappingCount(mappings){var hashmap={},attributeid;mstrmojo.array.forEach(mappings,function(item){if(item.tp===12||item.tp===0){attributeid=item.oid;hashmap[attributeid]=(hashmap[attributeid]||0)+1;}});return hashmap;}mstrmojo.qb.QBPreview=mstrmojo.declare(mstrmojo.DataGrid,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.qb.QBPreview",resizeColumnBehavior:mstrmojo.RESIZE_ALL_COLUMN_MODE,model:null,visible:false,cssClass:"lockHeader",lockHeader:true,markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},adjustSize:function(columnCount){var COLUMN_WIDTH=200,p=this.parent&&this.parent.domNode,calculateWidth=COLUMN_WIDTH*columnCount;if(!p||!this.scrollboxNode){return ;}this.scrollboxNode.style.overflowX=(calculateWidth>p.clientWidth)?"auto":"hidden";this.contentWidth=Math.max(calculateWidth,p.clientWidth)+"px";var cw=this.contentWidth,hc=this.headerContainerNode,ic=this.itemsContainerNode;if(cw&&hc&&ic){hc.style.width=cw;ic.style.width=cw;}},onheightChange:function onheightChange(){var currentHeight=this.height,containerNode=this.headerContainerNode,scrollboxNode=this.scrollboxNode;if(currentHeight&&containerNode&&scrollboxNode){scrollboxNode.style.height=parseInt(currentHeight,10)-containerNode.clientHeight+"px";}},onwidthChange:function onwidthChange(){if(this.domNode&&this.model&&this.model.mappings){this.domNode.style.width="100%";this.adjustSize(this.model.mappings.length);}},populatePreview:function populatePreview(){if(!this.model){return ;}var model=this.model,mappings=model.mappings,sptGeo=model.supportTimeGeo,sptMap=!mstrApp.isCloudPro,scrollLeft=0,scrollboxNode=this.scrollboxNode;this.columns=[];if(scrollboxNode){scrollLeft=scrollboxNode.scrollLeft?scrollboxNode.scrollLeft:0;}this.unrender();var tag,hw,als,sfx,istime,title,attributesMappingCount=getAttributesMappingCount(mappings);for(var i=0,len=mappings.length;i<len;i++){tag=mappings[i];als=$S.encodeHtmlString(tag.alias);als=(attributesMappingCount[tag.oid]>1&&tag.fmn)?[als,"(",tag.fmn,")"].join(""):als;sfx=tag.tp;istime=((tag.dtp==1)||(tag.dtp==8)||(tag.dtp==9))&&!tag.ipa;title="";if(istime){sfx+=" time";if(tag.tp===12){title=TIME_DIMENSION_TOOLTIP;}}else{if(tag.georole){sfx+=" geo";if(tag.tp===12){title=GEO_ROLE_TOOLTIP;}}}hw={tag:tag,headerWidget:{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-di-datapreview-header",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-datapreview-headerIcon t"+(tag.selected?sfx:0).toString(),text:als,did:tag.did,tp:tag.tp,isReadOnly:tag.isReadOnly,hasMapped:tag.hasMapped,isQB:tag.isQB,isDI:tag.isDI,sptGeo:sptGeo,sptMap:sptMap,mapped:tag.selected,ix:tag.ix,nochange:tag.nochange,ipa:tag.ipa,dtp:tag.dtp,georole:tag.georole,der:tag.der,shapeKey:tag.shapeKey,multiForms:tag.multiForms,isIDForm:tag.isIDForm},{scriptClass:"mstrmojo.Widget",cssClass:"menu",alias:"tips",title:title,markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" title="{@title}" style="{@cssText}" mstrAttach:click></div>',onclick:function(){var ol=this.parent.children[0],data=ol.tag;openCxtMenu(ol,this.domNode,data);},markupMethods:{ontitleChange:function(){this.domNode.title=this.title;}}}]},colWidth:"60",colCss:"mstrmojo-qb-metric",dataFunction:function(d,idx,datagrid){var cls=datagrid.columns,txt=d[this.dataField],css="mstrmojo-di-datapreview-DataRow-text";if(this.tag.selected){css+={"12":" Attribute","4":" Metric"}[this.tag.tp];}css+=(idx%2==1)?" odd":" even";return'<div class="'+css+'">'+txt+"</div>";},dataField:i.toString()};this.columns.push(hw);}var dataset=model.dataset;if(dataset.length==0&&this.columns.length>0){var _row_height=21;var count=parseInt(parseInt(this.parent.height)/_row_height)-1;count=count>0?count:1;var row;for(var i=0;i<count;i++){row=[];for(var j=0,len=this.columns.length;j<len;j++){row.push("");}dataset.push(row);}}this.items=dataset;this.render();this.adjustSize(mappings.length);var that=this;window.setTimeout(function(){that.scrollboxNode.scrollLeft=scrollLeft;},3);},inlineTextRef:{scriptClass:"mstrmojo.Popup",locksHover:true,slot:"headerContainerNode",children:[{scriptClass:"mstrmojo.TextBox",alias:"txt",onblur:function(){this.onEsc();},onEsc:function(){if(this.onCancel){this.onCancel();}this.parent.close({cancel:true});}}],onOpen:function(){var t=this.txt,c=this.txtConfig;if(c){for(var k in c){t.set(k,c[k]);}}t.domNode.style.width=t.width;t.focus();},onClose:function(dbt){if(!dbt||(!dbt.cancel&&!dbt.enter)){this.txt.onEnter();}this.unrender();}},onvisibleChange:function(e){if(e.value){this.populatePreview();}}});})();