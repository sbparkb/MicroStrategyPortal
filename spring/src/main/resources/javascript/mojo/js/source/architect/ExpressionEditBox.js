(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.ME.MetricEditBox");var $A=mstrmojo.array,_D=mstrmojo.dom,VSTATUS={VALID:0,UNKNOWN:1,VALIDATING:2,ERROR:3},VSTATUSCSS={0:"valid",1:"unknown",2:"validating",3:"error"},VSTATUSDESC={0:mstrmojo.desc(9105,"Valid Expression Formula."),1:mstrmojo.desc(9106,"Require Validation?"),2:mstrmojo.desc(9107,"Validation in Progress..."),3:mstrmojo.desc(9108,"Validation Failed with Syntax Error")},DEL_LIST=["(",")","{","}","-","+","*","/","<",">","=","|","~",","," ","\t","\n",";"],DEL_MAP=null;function mapErrorCode(code){return !code?VSTATUS.VALID:VSTATUS.ERROR;}function isDelimiterHelper(c){var i;if(!DEL_MAP){DEL_MAP={};for(i=0;i<DEL_LIST.length;i++){DEL_MAP[DEL_LIST[i]]=true;}}return DEL_MAP[c];}function brackets(s){return"["+s+"]";}mstrmojo.architect.ExpressionEditBox=mstrmojo.declare(mstrmojo.ME.MetricEditBox,[mstrmojo.warehouse._CanToggleAvatarClass],{scriptClass:"mstrmojo.architect.ExpressionEditBox",markupMethods:{onvStatusChange:function onvStatusChange(){var statusCode=this.vStatus,validationNode=this.vStatusNode;validationNode.className="mstrmojo-MEBox-vStatus "+VSTATUSCSS[statusCode];validationNode.innerHTML=VSTATUSDESC[statusCode];},oniStatusChange:function oniStatusChange(){this.iStatusNode.innerHTML=this.iStatus;}},handleValidation:function handleValidation(res,isSaved){if(!res){this.set("vStatus",VSTATUS.ERROR);return ;}res.vs=mapErrorCode(res.reject_error_code);this.set("vStatus",res.vs);this.set("iStatus",res.reject_error_description||"");var oi=res.tknstrm.mi["in"].oi,newTokens=[],cmid;if(!oi){return ;}$A.forEach([].concat(oi),function(obj){if(obj.tp===26){cmid=obj.did;return false;}return true;});this.parent.oi.cmid=cmid||"68AC1409417D6232E6DADFB198A8A245";$A.forEach(res.tknstrm.mi.tkn,function(token){var newToken={};newToken.sta=token.sta;if(token.orf){newToken.v=token.orf.c?brackets(token.v):" "+token.v+" ";newToken.oi=token.orf;}else{newToken.v=token.v.toString();}newTokens.push(newToken);});this.inputBox.set("items",newTokens);if(!isSaved){this.inputBox.focus();}},children:[{scriptClass:"mstrmojo.ME.TokenInputBox",alias:"inputBox",slot:"editNode",cssText:"height:100px;",browseItemVisible:false,renderBlockSize:1000,item2textCss:function item2textCss(data){return{11:" mstrmojo-ArchitectListIconSuggest t11 ",26:" mstrmojo-ArchitectListIconSuggest t26 "}[data.tp||data.t]||"";},ondropCuePosChange:function ondropCuePosChange(){this.dropCueNode.style.visibility="hidden";},breakOnEnterKeyDown:function breakOnEnterKeyDown(){return !this.suggestionShown;},getCharacter:function getCharacter(e){var k=(_D.isIE&&!_D.isIE9)?e.keyCode:e.charCode;return(k>0)?((k===13)?"\n":String.fromCharCode(k)):null;},itemFunction:function itemFunction(item){return new mstrmojo.ME.MetricToken({data:item,brackets:brackets,isDelimiter:function isDelimiter(){var data=this.data,dataLength=data.v.length;if(data){return data.isDelimiter||(dataLength===1&&isDelimiterHelper(data.v));}return false;}});},isDelimiter:isDelimiterHelper}]});}());