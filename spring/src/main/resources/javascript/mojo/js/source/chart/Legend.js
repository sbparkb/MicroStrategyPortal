(function(){mstrmojo.requiresClsP("mstrmojo.chart","Point2D","GraphObjectManager","TripleId","FormatFont","ChartContext","GraphCollectionObject","FancyBoxObject","MarkerObject","FormatFill","StraightLineObject","TextObject","Rect2D");mstrmojo.requiresClsP("mstrmojo.chart.enums","EnumCollectionType","EnumMarkerShape","EnumBoxStyle","EnumLineStyle","EnumLegendLayout","EnumLegendMarkersStyle");mstrmojo.requiresClsP("mstrmojo.chart.model.enums","EnumDSSGraphMarkerShape","EnumDSSGraphType","EnumDSSGraphProperty","EnumDSSGraphObject","EnumVariantType","EnumVariantBool","EnumDSSExtraGraphProperty","EnumDSSGraphMarkerLayout","EnumDSSGraphLegendPosition");mstrmojo.requiresCls("mstrmojo.chart.common.MapStructure");var $C=mstrmojo.chart,$CHART_ENUMS=mstrmojo.chart.enums,$CT_TEXT=$CHART_ENUMS.EnumCollectionType.CT_TEXT,$LOCAL_MARKER_SHAPE=$CHART_ENUMS.EnumMarkerShape,$BS=$CHART_ENUMS.EnumBoxStyle,$LSL=$CHART_ENUMS.EnumLineStyle,$LL=$CHART_ENUMS.EnumLegendLayout,$LMS=$CHART_ENUMS.EnumLegendMarkersStyle,$NTID=$C.gNullTripleId,kLegendMakerTextRatio=0.75,kLegendMakerSizeThreshold=16,kLegendMakerTextMarginRatio=0.5,kLegendTextThreshold=0.15,kLegendThreshold=0.9,kExpandedGraphWidthLimit=1742,kExpandedGraphHeightLimit=725,kManualLayoutEdgeMarginTolerance=2;var $M=mstrmojo.chart.model,$MODEL_ENUMS=$M.enums,$MS=$MODEL_ENUMS.EnumDSSGraphMarkerShape,$GT=$MODEL_ENUMS.EnumDSSGraphType,$GP=$MODEL_ENUMS.EnumDSSGraphProperty,$GO=$MODEL_ENUMS.EnumDSSGraphObject,$VB=$MODEL_ENUMS.EnumVariantBool,$VF=$VB.VARIANT_FALSE,$EGP=$MODEL_ENUMS.EnumDSSExtraGraphProperty,$ML=$MODEL_ENUMS.EnumDSSGraphMarkerLayout,$LP=$MODEL_ENUMS.EnumDSSGraphLegendPosition;var kDefaultMargin=0;function hCalculateLegendLayoutParas(formatFont){this.mLegendMarkerSize=formatFont.mFontSize<kLegendMakerSizeThreshold?formatFont.mFontSize:kLegendMakerSizeThreshold;this.mLegendMarkerSize=Math.floor(this.mLegendMarkerSize*kLegendMakerTextRatio+1.5);if(this.mLegendMarkerSize<2){this.mLegendMarkerSize=2;}this.mItemMargin=Math.floor(this.mLegendMarkerSize*0.3);this.mEdgeMargin=Math.floor(this.mLegendMarkerSize*0.8);}function hGenerateLegendText(area,graphCollectionObject){var chartCtx=this.mChartContextPtr,dataSet=this.mDatasetPtr,graphOptionsLegend=this.mGraphOptionsLegend,seriesCount,legendTextArea,i,tripleId,textObject,seriesTitle,graphType,value,legendTextWidth,widthThreshold,legendLocation,legendText,textArea,numberOfLegendItems;seriesCount=dataSet.GetSeriesCount();legendTextArea=new $C.Rect2D();numberOfLegendItems=this.mLegendItemCount;for(i=0;i<numberOfLegendItems;++i){tripleId=new $C.TripleId({ObjectId:$GO.DssGraphLegendText,SeriesId:i});textObject=new $C.TextObject({TripleId:tripleId,GraphObjectManager:this,GraphCollectionObject:graphCollectionObject});textObject.mIsShown=false;graphCollectionObject.AddGraphObject(textObject);graphType=chartCtx.mGraphType;if(i>=seriesCount&&graphType!==$GT.DssGraphTypeGridChart){if(chartCtx.mGraphType===$GT.DssGraphTypePareto_Percent){value=chartCtx.GetProperty($GP.DssGraphCumulativePercentLabel,new $C.TripleId({SeriesId:i-seriesCount}));if(value){seriesTitle=value;}else{seriesTitle="Cumulative Percent";}}else{if(graphType>=$GT.DssGraphTypeHiLo_Stock_Chart&&graphType<=$GT.DssGraphTypeHiLoOpenClose_DualAxis_Stock_Chart){seriesTitle=this.mStockMetricValue[this.mLegendItemIndexToStockMetricIndex[i]];}}}else{if(graphOptionsLegend.mIsByGroup){seriesTitle=dataSet.GetGroupLabel(i,false);}else{seriesTitle=dataSet.GetSeriesLabel(i,false);}}textObject.SetText(seriesTitle);textArea=textObject.GetBoundingRect();this.AddToMapAndList(textObject);if(textArea.width>legendTextArea.width){legendTextArea.width=textArea.width;}}if(!chartCtx.mManualLayoutMode||graphOptionsLegend.mReposition){widthThreshold=Math.floor(area.width*kLegendTextThreshold+0.5);if(graphOptionsLegend.mLegendPosition===$LP.DssGraphLegendPositionBottom){widthThreshold=area.width;}legendTextWidth=(legendTextArea.width<widthThreshold)?legendTextArea.width:widthThreshold;}else{legendLocation=chartCtx.GetLocation($GP.DssGraphLegendLocation);if(legendLocation.width===0){widthThreshold=Math.floor(area.width*kLegendTextThreshold+0.5);legendTextWidth=(legendTextArea.width<widthThreshold)?legendTextArea.width:widthThreshold;}else{legendTextWidth=legendLocation.width-2*this.mEdgeMargin;if(graphOptionsLegend.mLegendMarkersStyle===$ML.DssGraphMarkerLeft||graphOptionsLegend.mLegendMarkersStyle===$ML.DssGraphMarkerRight){legendTextWidth-=this.mLegendMarkerSize*(1+kLegendMakerTextMarginRatio);}}}legendTextArea.width=0;for(i=0;i<numberOfLegendItems;++i){legendText=this.GetGraphObject(new $C.TripleId({ObjectId:$GO.DssGraphLegendText,SeriesId:i}));legendText.SetTextWidthLimit(legendTextWidth);textArea=legendText.GetBoundingRect();if(textArea.height>legendTextArea.height){legendTextArea.height=textArea.height;}if(textArea.width>legendTextArea.width){legendTextArea.width=textArea.width;}}return legendTextArea;}function hIsReversedOrder(){var graphType=this.mChartContextPtr.mGraphType;switch(graphType){case $GT.DssGraphTypeVertical_Area_Stacked:case $GT.DssGraphTypeVertical_Area_BiPolar_Stacked:case $GT.DssGraphTypeVertical_Area_DualAxis_Stacked:case $GT.DssGraphTypeVertical_Area_Percent:case $GT.DssGraphTypeVertical_Bar_Stacked:case $GT.DssGraphTypeVertical_Bar_DualAxis_Stacked:case $GT.DssGraphTypeVertical_Bar_BiPolar_Stacked:case $GT.DssGraphTypeVertical_Bar_Percent:case $GT.DssGraphTypeVertical_Line_Stacked:case $GT.DssGraphTypeVertical_Line_BiPolar_Stacked:case $GT.DssGraphTypeVertical_Line_DualAxis_Stacked:case $GT.DssGraphTypeVertical_Line_Percent:case $GT.DssGraphRadar_Line_Stacked:case $GT.DssGraphTypePareto:case $GT.DssGraphTypePareto_Percent:return true;default:return false;}}function hCalculateLegendLayoutInDevice(area,legendTextCollection){var graphOptionsLegend=this.mGraphOptionsLegend,maxTextAreaInDevice=hGenerateLegendText.call(this,area,legendTextCollection),legendArea=new $C.Rect2D(),heightMargin=this.mItemMargin,widthMargin=this.mItemMargin,seriesCount=this.mDatasetPtr.GetSeriesCount(),markerArea=new $C.Rect2D({x:0,y:0,width:this.mLegendMarkerSize,height:this.mLegendMarkerSize}),itemLength=0,itemHeight=0,colNum,rowNum,legendAreaCapacity,maxItemNumber,legendLocation,maxRowNum,maxColNum,graphWidth,graphHeight,newWidth,newHeight,i,rowIndex,colIndex,xOffset,itemPosition,markerPosition,textPosition,seriesId,tripleId,legendMarker,graphType,stockMetricIndex,position,lSize,startPoint,endPoint,legendMarkerLine,formatLine,markerShape,legendText;switch(graphOptionsLegend.mLegendMarkersStyle){case $ML.DssGraphMarkerLeft:case $ML.DssGraphMarkerRight:itemLength=Math.floor(maxTextAreaInDevice.width+markerArea.width*(1+kLegendMakerTextMarginRatio));itemHeight=maxTextAreaInDevice.height;break;case $ML.DssGraphMarkerCentered:itemLength=maxTextAreaInDevice.width;itemHeight=maxTextAreaInDevice.height;break;case $ML.DssGraphMarkerAbove:case $ML.DssGraphMarkerBelow:itemLength=maxTextAreaInDevice.width;itemHeight=Math.floor(maxTextAreaInDevice.height+markerArea.height*(1+kLegendMakerTextMarginRatio));break;default:break;}if(itemHeight===0){itemHeight=1;}if(itemLength===0){itemLength=1;}colNum=0;rowNum=0;legendAreaCapacity=this.mLegendItemCount;switch(graphOptionsLegend.mLegendPosition){case $LP.DssGraphLegendPositionRight:case $LP.DssGraphLegendPositionLeft:maxItemNumber=Math.floor((area.height-heightMargin)/(itemHeight+heightMargin));if(maxItemNumber===0){maxItemNumber=1;}colNum=Math.floor(this.mLegendItemCount/maxItemNumber);if(colNum*maxItemNumber<this.mLegendItemCount){colNum++;}rowNum=Math.floor(this.mLegendItemCount/colNum);if(rowNum*colNum<this.mLegendItemCount){rowNum++;}break;case $LP.DssGraphLegendPositionBottom:maxItemNumber=Math.floor((area.width-widthMargin)/(itemLength+widthMargin));if(maxItemNumber===0){maxItemNumber=1;}rowNum=Math.floor(this.mLegendItemCount/maxItemNumber);if(rowNum*maxItemNumber<this.mLegendItemCount){rowNum++;}colNum=Math.floor(this.mLegendItemCount/rowNum);if(rowNum*colNum<this.mLegendItemCount){colNum++;}break;case $LP.DssGraphLegendPositionFreeFloat:legendLocation=this.mChartContextPtr.GetLocation($GP.DssGraphLegendLocation);legendArea.y=legendLocation.y;legendArea.x=legendLocation.x;if(!graphOptionsLegend.mRecalculate){legendArea.width=legendLocation.width;legendArea.height=legendLocation.height;maxRowNum=Math.floor((legendArea.height-this.mEdgeMargin*2+kManualLayoutEdgeMarginTolerance)/itemHeight);maxColNum=Math.floor((legendArea.width-this.mEdgeMargin*2+kManualLayoutEdgeMarginTolerance)/itemLength);if(maxRowNum*maxColNum<legendAreaCapacity){legendAreaCapacity=maxRowNum*maxColNum;rowNum=maxRowNum;colNum=maxColNum;}else{colNum=Math.floor(this.mLegendItemCount/maxRowNum);if(colNum===0){colNum=1;}if(colNum*maxRowNum<this.mLegendItemCount){colNum++;}rowNum=Math.floor(this.mLegendItemCount/colNum);if(rowNum*colNum<this.mLegendItemCount){rowNum++;}}if(rowNum>0){heightMargin=Math.floor((legendArea.height-rowNum*itemHeight-this.mEdgeMargin*2)/rowNum);}if(colNum>0){widthMargin=Math.floor((legendArea.width-colNum*itemLength-this.mEdgeMargin*2)/colNum);}}else{maxItemNumber=Math.floor((area.height-heightMargin)/(itemHeight+heightMargin));if(maxItemNumber===0){maxItemNumber=1;}colNum=Math.floor(this.mLegendItemCount/maxItemNumber);if(colNum*maxItemNumber<this.mLegendItemCount){colNum++;}rowNum=Math.floor(this.mLegendItemCount/colNum);if(rowNum*colNum<this.mLegendItemCount){rowNum++;}}break;default:break;}if(graphOptionsLegend.mLegendPosition!==$LP.DssGraphLegendPositionFreeFloat||graphOptionsLegend.mRecalculate){legendArea.height=Math.floor(itemHeight*rowNum+heightMargin*rowNum+this.mEdgeMargin*2);legendArea.width=Math.floor(itemLength*colNum+widthMargin*colNum+this.mEdgeMargin*2);if(graphOptionsLegend.mRecalculate){if(!this.mIsExpanded){graphWidth=this.mChartContextPtr.mGraphWidth;graphHeight=this.mChartContextPtr.mGraphHeight;if(legendArea.x+legendArea.width>graphWidth){legendArea.width=graphWidth-legendArea.x;}if(legendArea.y+legendArea.height>graphHeight){legendArea.height=graphHeight-legendArea.y;}}}}if(this.mIsExpanded){switch(graphOptionsLegend.mLegendPosition){case $LP.DssGraphLegendPositionRight:case $LP.DssGraphLegendPositionLeft:this.mArea.width=legendArea.width*1.8+530;if(this.mArea.width>kExpandedGraphWidthLimit){this.mArea.width=kExpandedGraphWidthLimit;}this.mChartContextPtr.SetGraphSize(this.mArea.x+this.mArea.width+this.mChartContextPtr.vdWidth(kDefaultMargin),this.mChartContextPtr.mGraphHeight);break;case $LP.DssGraphLegendPositionBottom:this.mArea.height=legendArea.height*0.4+400;if(this.mArea.height>kExpandedGraphHeightLimit){this.mArea.height=kExpandedGraphHeightLimit;}this.mChartContextPtr.SetGraphSize(this.mChartContextPtr.mGraphWidth,this.mArea.y+this.mArea.height+this.mChartContextPtr.vdHeight(kDefaultMargin));break;case $LP.DssGraphLegendPositionFreeFloat:newWidth=this.mChartContextPtr.mGraphWidth;newHeight=this.mChartContextPtr.mGraphHeight;if(legendArea.x+legendArea.width>this.mChartContextPtr.mGraphWidth){newWidth=legendArea.x+legendArea.width+this.mChartContextPtr.vdWidth(kDefaultMargin);}if(legendArea.y+legendArea.height>this.mChartContextPtr.mGraphHeight){newHeight=legendArea.y+legendArea.height+this.mChartContextPtr.vdHeight(kDefaultMargin);}this.mChartContextPtr.SetGraphSize(newWidth,newHeight);break;default:break;}}switch(graphOptionsLegend.mLegendPosition){case $LP.DssGraphLegendPositionRight:legendArea.y=Math.floor(this.mArea.y+this.mArea.height/2-legendArea.height/2);legendArea.x=Math.floor(this.mArea.x+this.mArea.width-legendArea.width);break;case $LP.DssGraphLegendPositionLeft:legendArea.y=Math.floor(this.mArea.y+this.mArea.height/2-legendArea.height/2);legendArea.x=this.mArea.x;break;case $LP.DssGraphLegendPositionBottom:legendArea.y=this.mArea.y+this.mArea.height-legendArea.height;legendArea.x=Math.floor(this.mArea.x+(this.mArea.width-legendArea.width)/2);break;case $LP.DssGraphLegendPositionFreeFloat:break;default:break;}if(!this.mChartContextPtr.mManualLayoutMode||graphOptionsLegend.mReposition){this.mChartContextPtr.PutLocation($GP.DssGraphLegendLocation,legendArea);}for(i=0;i<legendAreaCapacity;++i){rowIndex=Math.floor(i/colNum);colIndex=i-rowIndex*colNum;xOffset=0;switch(graphOptionsLegend.mLegendMarkersStyle){case $ML.DssGraphMarkerRight:xOffset=widthMargin;break;case $ML.DssGraphMarkerCentered:case $ML.DssGraphMarkerAbove:case $ML.DssGraphMarkerBelow:xOffset=widthMargin/2;break;}itemPosition=new $C.Point2D();itemPosition.x=legendArea.x+(itemLength+widthMargin)*colIndex+this.mEdgeMargin+xOffset;itemPosition.y=Math.floor(legendArea.y+(itemHeight+heightMargin)*rowIndex+this.mEdgeMargin+heightMargin/2);markerPosition=new $C.Point2D();textPosition=new $C.Point2D();switch(graphOptionsLegend.mLegendMarkersStyle){case $ML.DssGraphMarkerLeft:markerPosition.x=Math.floor(itemPosition.x+markerArea.width/2);markerPosition.y=Math.floor(itemPosition.y+itemHeight/2);textPosition.x=Math.floor(itemPosition.x+markerArea.width*(1+kLegendMakerTextMarginRatio));textPosition.y=itemPosition.y;break;case $ML.DssGraphMarkerRight:markerPosition.x=Math.floor(itemPosition.x+itemLength-markerArea.width/2);markerPosition.y=Math.floor(itemPosition.y+itemHeight/2);textPosition.x=itemPosition.x;textPosition.y=itemPosition.y;break;case $ML.DssGraphMarkerCentered:markerPosition.x=Math.floor(itemPosition.x+itemLength/2);markerPosition.y=Math.floor(itemPosition.y+itemHeight/2);textPosition.x=itemPosition.x;textPosition.y=itemPosition.y;break;case $ML.DssGraphMarkerAbove:markerPosition.x=Math.floor(itemPosition.x+itemLength/2);markerPosition.y=Math.floor(itemPosition.y+markerArea.height/2);textPosition.x=itemPosition.x;textPosition.y=itemPosition.y+markerArea.height*(1+kLegendMakerTextMarginRatio);break;case $ML.DssGraphMarkerBelow:markerPosition.x=Math.floor(itemPosition.x+itemLength/2);markerPosition.y=Math.floor(itemPosition.y+itemHeight-markerArea.height/2);textPosition.x=itemPosition.x;textPosition.y=itemPosition.y;break;default:break;}seriesId=hIsReversedOrder.call(this)?(this.mLegendItemCount-i-1):i;tripleId=new $C.TripleId({ObjectId:$GO.DssGraphLegendMarker,SeriesId:seriesId});graphType=this.mChartContextPtr.mGraphType;if(graphType>=$GT.DssGraphTypeHiLo_Stock_Chart&&graphType<=$GT.DssGraphTypeHiLoOpenClose_DualAxis_Stock_Chart&&i>=seriesCount){var lRet=this.mLegendItemIndexToStockMetricIndex[i];if(lRet===undefined){break;}stockMetricIndex=lRet.value;if(this.mStockMetricLayout[stockMetricIndex]===$GO.DssGraphMetricVerticalLine||this.mStockMetricLayout[stockMetricIndex]===$GO.DssGraphMetricLine){position=new $C.Point2D({Point2D:markerPosition});lSize=this.mLegendMarkerSize/2;startPoint=this.mStockMetricLayout[stockMetricIndex]===$GO.DssGraphMetricVerticalLine?new $C.Point2D({x:position.x,y:Math.floor(position.y-1.75*lSize)}):new $C.Point2D({x:Math.floor(position.x-1.75*lSize),y:position.y});endPoint=this.mStockMetricLayout[stockMetricIndex]===$GO.DssGraphMetricVerticalLine?new $C.Point2D({x:position.x,y:Math.floor(position.y+1.75*lSize)}):$C.Point2D({x:Math.floor(position.x+1.75*lSize),y:position.y});legendMarkerLine=new $C.StraightLineObject({TripleId:tripleId,GraphObjectManager:this,StartPoint:startPoint,EndPoint:endPoint});formatLine=new $C.FormatLine({LineStyle:$LSL.LS_SHORT_DASH,Alpha:255,LineThickness:1,LineColor:$C.gBlack.ToInteger()});legendMarkerLine.SetFormatLine(formatLine);this.mLegendMarkerLines.push(legendMarkerLine);legendMarker=new $C.MarkerObject({TripleId:tripleId,GraphObjectManager:this,MarkerPosition:markerPosition,MarkerShape:$LOCAL_MARKER_SHAPE.MS_Rectangle,IsIsometric:true,MarkerSize:Math.floor(this.mLegendMarkerSize/2),GraphCollectionObject:null,IsDialogSize:false});legendMarker.mIsShown=false;}else{markerShape=this.mStockMetricLayout[stockMetricIndex]===$GO.DssGraphMetricBar?$MS.DssGraphMarkerShapeRectangle:$MS.DssGraphMarkerShapeHouse;legendMarker=new $C.MarkerObject({TripleId:tripleId,GraphObjectManager:this,MarkerPosition:markerPosition,MarkerShape:markerShape,IsIsometric:true,MarkerSize:Math.floor(this.mLegendMarkerSize/2),GraphCollectionObject:null,IsDialogSize:false});legendMarker.SetFormatFill(new $C.FormatFill({SimpleColor:$C.gBlack.ToInteger()}));}}else{legendMarker=new $C.MarkerObject({TripleId:tripleId,GraphObjectManager:this,MarkerPosition:markerPosition,MarkerShape:$LOCAL_MARKER_SHAPE.MS_Rectangle,IsIsometric:true,MarkerSize:Math.floor(this.mLegendMarkerSize/2),GraphCollectionObject:null,IsDialogSize:false});}this.AddToMapAndList(legendMarker);legendText=this.GetGraphObject(new $C.TripleId({ObjectId:$GO.DssGraphLegendText,SeriesId:seriesId}));legendText.SetRect(maxTextAreaInDevice);legendText.MoveTo(textPosition.x,textPosition.y);legendText.mIsShown=true;}return legendArea;}function hGetItemCount(){var dataSet=this.mDatasetPtr;if(!this.mGraphOptionsLegend.mIsByGroup){return dataSet.GetSeriesCount();}return dataSet.GetGroupCount();}function hCalculateLegendPosition(){var chartCtx=this.mChartContextPtr,legendLocation,legendCenterPoint,distance=[],min,legendPosition,i;legendLocation=chartCtx.GetLocationRect($GP.DssGraphLegendLocation);legendCenterPoint=new $C.Point2D({x:Math.floor(legendLocation.x+legendLocation.width/2),y:Math.floor(legendLocation.y+legendLocation.height/2)});distance[0]=legendCenterPoint.Distance(new $C.Point2D({x:chartCtx.mGraphWidth,y:Math.floor(chartCtx.mGraphHeight/2)}));distance[1]=legendCenterPoint.Distance(new $C.Point2D({x:0,y:Math.floor(chartCtx.mGraphHeight/2)}));distance[2]=legendCenterPoint.Distance(new $C.Point2D({x:Math.floor(chartCtx.mGraphWidth/2),y:chartCtx.mGraphHeight}));min=distance[0];legendPosition=0;for(i=1;i<3;++i){if(distance[i]<min){min=distance[i];legendPosition=i;}}return(legendPosition+1);}function hLoadProperties(){var chartCtx=this.mChartContextPtr,graphOptionsLegend=this.mGraphOptionsLegend,value,value2,useChartArea,numerOfChartAreas,graphType,i;value=chartCtx.GetProperty($GP.DssGraphShowLegendText,$NTID);if(value){graphOptionsLegend.mShowLegend=(value!==$VF);}value=chartCtx.GetProperty($GP.DssGraphMarkerLayout,$NTID);if(value){graphOptionsLegend.mLegendMarkersStyle=value;}value=chartCtx.GetProperty($GP.DssGraphLegendLock,$NTID);if(value){graphOptionsLegend.mLegendPosition=value;if(!chartCtx.mManualLayoutMode&&graphOptionsLegend.mLegendPosition===$LL.LL_LegendFreeFloat){graphOptionsLegend.mLegendPosition=$LL.LL_LegendOnRightSide;}}if(chartCtx.mManualLayoutMode){graphOptionsLegend.mLegendPosition=$LL.LL_LegendFreeFloat;value=chartCtx.GetProperty($GP.DssGraphInfoRecalculateLegend,$NTID);if(value){graphOptionsLegend.mRecalculate=value!==$VF;if(graphOptionsLegend.mRecalculate){value=chartCtx.GetProperty($EGP.DssGraphInfoRecalculateChartFrame,$NTID);if(value){graphOptionsLegend.mReposition=value!==$VF;if(graphOptionsLegend.mReposition){graphOptionsLegend.mLegendPosition=hCalculateLegendPosition.call(this);}}}}value=chartCtx.GetProperty($GP.DssGraphAxisAutoFit,$NTID);if(value){graphOptionsLegend.mAxisLabelsAutoFit=value!==$VF;}if(graphOptionsLegend.mAxisLabelsAutoFit){graphOptionsLegend.mRecalculate=true;graphOptionsLegend.mReposition=true;graphOptionsLegend.mLegendPosition=hCalculateLegendPosition.call(this);}}graphOptionsLegend.mIsByGroup=chartCtx.isLegendByGroup();if(!chartCtx.mManualLayoutMode||graphOptionsLegend.mRecalculate){value=chartCtx.GetProperty($EGP.DssGraphInfoAutosizeHorizontal,$NTID);value2=chartCtx.GetProperty($EGP.DssGraphInfoAutosizeVertical,$NTID);if(value&&value2){this.mIsExpanded=value!==$VF&&value2!==$VF;}this.mIsExpanded=false;}this.mLegendItemCount=hGetItemCount.call(this);graphType=chartCtx.mGraphType;if(graphType===$GT.DssGraphTypePareto_Percent){useChartArea=false;numerOfChartAreas=1;value=chartCtx.GetProperty($EGP.DssGraphUseChartArea,$NTID);if(value){useChartArea=value!==$VF;}if(useChartArea){value=chartCtx.GetProperty($EGP.DssGraphChartAreaNumber,$NTID);if(value){numerOfChartAreas=value;if(numerOfChartAreas>this.mLegendItemCount){numerOfChartAreas=this.mLegendItemCount;}}}this.mLegendItemCount+=numerOfChartAreas;}else{if(graphType>=$GT.DssGraphTypeHiLo_Stock_Chart&&graphType<=$GT.DssGraphTypeHiLoOpenClose_DualAxis_Stock_Chart){for(i=0;i<3;++i){value=chartCtx.GetProperty($GP.DssGraphShowMetric1+i,$NTID);if(value){if(value!==$VF){this.mLegendItemIndexToStockMetricIndex[this.mLegendItemCount++]=i;value=chartCtx.GetProperty($GP.DssGraphMetric1Value+i,$NTID);if(value){this.mStockMetricValue[i]=value;}value=chartCtx.GetProperty($GP.DssGraphMetric1Style+i,$NTID);if(value){this.mStockMetricLayout[i]=value;}}}}}}}mstrmojo.chart.Legend=mstrmojo.declare(mstrmojo.chart.GraphObjectManager,null,{scriptClass:"mstrmojo.chart.Legend",mDatasetPtr:null,mLegendArea:null,mArea:null,mGraphOptionsLegend:null,mStockMetricLayout:null,mStockMetricValue:null,mLegendMarkerLines:null,mItemMargin:0,mEdgeMargin:0,mLegendMarkerSize:0,mIsExpanded:false,mLegendItemCount:0,mLegendItemIndexToStockMetricIndex:null,init:function init(props){this._super(props);this.mDatasetPtr=props.DataSet||null;this.mLegendArea=props.Area?new $C.Rect2D({Rect2D:props.Area}):null;this.mArea=props.Area?new $C.Rect2D({Rect2D:props.Area}):null;this.mGraphOptionsLegend={mShowLegend:true,mShowSeriesTitles:true,mLegendPosition:$LL.LL_LegendOnRightSide,mLegendMarkersStyle:$LMS.LMS_LeftOfText,mLegendBoxStyle:$BS.BS_NOFRAME,mLegendItemsNum:0,mAxisLabelsAutoFit:true,mVertical:true,mRecalculate:false,mReposition:false,mIsByGroup:false};this.mStockMetricLayout=[0,0,0];this.mStockMetricValue=new Array(3);this.mLegendMarkerLines=[];this.mLegendItemIndexToStockMetricIndex={};hLoadProperties.call(this);},GenerateMapAndList:function GenerateMapAndList(){var chartCtx=this.mChartContextPtr,tripleId,legendTextCollection,formatFont,value,legendArea;tripleId=new $C.TripleId({ObjectId:$GO.DssGraphLegendText});legendTextCollection=new $C.GraphCollectionObject({TripleId:tripleId,GraphObjectManager:this,CollectionType:$CT_TEXT});this.AddToMap(legendTextCollection);formatFont=chartCtx.GetFormatFont(new $C.TripleId({ObjectId:$GO.DssGraphLegendText}));legendTextCollection.SetFormatFont(formatFont);hCalculateLegendLayoutParas.call(this,formatFont);this.mLegendArea=hCalculateLegendLayoutInDevice.call(this,this.mArea,legendTextCollection);value=chartCtx.GetProperty($GP.DssGraphLegendBox,$NTID);if(value===null||value===undefined){value=$BS.BS_NOFRAME;}tripleId=new $C.TripleId({ObjectId:$GO.DssGraphLegendArea});legendArea=new $C.FancyBoxObject({TripleId:tripleId,GraphObjectManager:this,BoxStyle:value,Area:this.mLegendArea});this.AddToMapAndList(legendArea);},GetLegendArea:function GetLegendArea(){return this.mLegendArea;},CalculateFrame:function CalculateFrame(widthMargin,heightMargin,area){var legendRect,right;legendRect=this.GetLegendArea();switch(this.mGraphOptionsLegend.mLegendPosition){case $LP.DssGraphLegendPositionRight:if(legendRect.width<this.mArea.width*kLegendThreshold){area.width=legendRect.x-widthMargin-this.mArea.x;}break;case $LP.DssGraphLegendPositionLeft:if(legendRect.width<this.mArea.width*kLegendThreshold){right=this.mArea.x+this.mArea.width;area.x=legendRect.x+legendRect.width+widthMargin;area.width=right-area.x;}break;case $LP.DssGraphLegendPositionBottom:if(legendRect.height<this.mArea.height*kLegendThreshold){area.height=legendRect.y-heightMargin-this.mArea.y;}break;case $LP.DssGraphLegendPositionFreeFloat:break;default:break;}},Draw:function Draw(){var graphObjList=this.mGraphObjectList,markerLegendLines=this.mLegendMarkerLines,len,i;graphObjList[0].Draw();len=markerLegendLines.length;for(i=0;i<len;++i){markerLegendLines[i].Draw();}len=graphObjList.length;for(i=1;i<len;++i){graphObjList[i].Draw();}},SetFormatLineOfLegendMarkerLine:function SetFormatLineOfLegendMarkerLine(formatLine,seriesId,isLineVertical){var chartCtx=this.mChartContextPtr,legendMarker,position,markerSize,ratio,startPoint,endPoint;if(isLineVertical===undefined){isLineVertical=false;}legendMarker=this.GetGraphObject(new $C.TripleId({ObjectId:$GO.DssGraphLegendMarker,SeriesId:seriesId}));if(!legendMarker){return false;}position=legendMarker.mMarkerPosition;markerSize=legendMarker.mMarkerSize;ratio=chartCtx.mIsGraphMatrix?1:1.75;startPoint=isLineVertical?new $C.Point2D({x:position.x,6:position.y-ratio*markerSize}):new $C.Point2D({x:position.x-ratio*markerSize,y:position.y});endPoint=isLineVertical?new $C.Point2D({x:position.x,y:position.y+ratio*markerSize}):new $C.Point2D({x:position.x+ratio*markerSize,y:position.y});var legendMarkerLine=new $C.StraightLineObject({TripleId:new $C.TripleId({ObjectId:$GO.DssGraphLegendMarker,SeriesId:seriesId}),GraphObjectManager:this,StartPoint:startPoint,EndPoint:endPoint});legendMarkerLine.SetFormatLine(formatLine);this.mLegendMarkerLines.push(legendMarkerLine);return true;},UpdateFormatForLegendMarker:function UpdateFormatForLegendMarker(idx,formatFill,formatLine,hasLine,isLineVertical){if(idx<0||idx>=this.mLegendItemCount){return ;}hasLine=(hasLine!==undefined)?hasLine:false;isLineVertical=(isLineVertical!==undefined)?isLineVertical:false;var markerId=new $C.TripleId({ObjectId:$GO.DssGraphLegendMarker,SeriesId:idx});var legendMarker=this.GetGraphObject(markerId);if(!legendMarker){return ;}if(formatFill){legendMarker.SetFormatFill(formatFill);}if(formatLine){if(hasLine){this.SetFormatLineOfLegendMarkerLine(formatLine,idx,isLineVertical);}else{legendMarker.SetFormatLine(formatLine);}}}});}());