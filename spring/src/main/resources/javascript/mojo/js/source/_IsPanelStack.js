(function(){mstrmojo.requiresCls("mstrmojo.array");var $ARR=mstrmojo.array;mstrmojo._IsPanelStack=mstrmojo.provide("mstrmojo._IsPanelStack",{_mixinName:"mstrmojo._IsPanelStack",TTL_SRC_PANEL:0,model:null,selectedIdx:undefined,init:function init(props){this._super(props);var defn=this.defn;if(!defn){defn=this.defn=this.node&&this.node.defn;this.titleSrc=this.titleSrc||defn.ttlSrc;}var key=this.selectedKey=this.defn.selKey=this.node.data.selKey;this.set("selectedIdx",$ARR.find(this.node.data.panels,"k",key));defn.attachEventListener("selKeyChange",this.id,function(evt){this.set("selectedKey",evt.value);});},addChildren:function addChildren(children,idx,silent){var fmts=this.getFormats(),overflow=fmts&&fmts.overflow,cnt=children.length,i;for(i=0;i<cnt;i++){var child=children[i],key=child.k;if(key){child.selected=child.visible=key===this.selectedKey;if(overflow){var pnlFmts=child.getFormats()||child.createEmptyFormats();if(pnlFmts){pnlFmts.overflow=overflow;}}}}return this._super(children,idx,silent);},refresh:function refresh(){if(this.hasRendered){var refreshKey=this.defn.newSelKey||this.selectedKey;$ARR.forEach(this.children,function(child){var key=child.k;if(key){child._delayRefresh=(key!==refreshKey);if(!child._delayRefresh){child.refresh();}}});}delete this.defn.newSelKey;},selectPanel:function selectPanel(key,hasLoader,skipServerCall){var ds=this.model.getDataService(),update=ds.newUpdateWithoutCmd();this.selectPanelDeferred(update,key,hasLoader,skipServerCall);if(update.actions&&update.actions.length>0){ds.addSuppressData(update.extras);update.submit();}},selectPanelDeferred:function(update,key,hasLoader,skipServerCall){if(key!==this.selectedKey){this.defn.set("selKeyChange",key);this.model.selectPanelDeferred(update,this.k,key,this.node.data.wid,hasLoader,skipServerCall);}},onselectedKeyChange:function onselectedKeyChange(evt){var skipCnt=0,off,on,selectedIdx;$ARR.forEach(this.children,function(panel,idx){var panelKey=panel.k;if(panelKey){if(evt.value===panelKey){on=panel;selectedIdx=idx-skipCnt;panel.set("visible",true);panel.set("selected",true);}else{if(evt.valueWas===panelKey){off=panel;panel.set("selected",false);panel.set("visible",false);}}if(on&&off){return false;}}else{skipCnt++;}return true;});if(this.titleSrc===this.TTL_SRC_PANEL&&this.title){var title=on&&on.title;this.set("title",title);this.defn.ttl=title;}this.prevSelectIdx=this.selectedIdx;this.set("selectedIdx",selectedIdx);this.raiseEvent({name:"panelSelected",key:on.k});return{on:on,off:off};},getSelectedPanel:function getSelectedPanel(){var skipCnt=0,selectedIdx=this.selectedIdx,selectedPanel;$ARR.forEach(this.children,function(panel,idx){if(panel.k){if(idx-skipCnt===selectedIdx){selectedPanel=panel;return false;}}else{skipCnt++;}return true;});return selectedPanel;},setDirtyChildren:function setDirtyChildren(includeAll){var selectedKey=this.selectedKey;$ARR.forEach(this.children,function(child){var key=child.k;if(key){child[((includeAll||key!==selectedKey)?"add":"remove")+"DirtyKey"](key);}});},clearDirtyChild:function clearDirtyChild(key){var panels=this.children,panel=panels[$ARR.find(panels,"k",key)];if(panel){panel.removeDirtyKey(panel.k);}},isPanelStack:true,checkRequiredObjects:function checkRequiredObjects(){var txWidgets=this.txWidgets||{},flag=true,i;for(i in txWidgets){flag&=!!txWidgets[i].checkRequiredObjects();}return flag;},updateSelectedIdx:mstrmojo.emptyFn,unrender:function unrender(ignoreDom){delete this.defn.newSelKey;this._super(ignoreDom);},switchToPanel:function switchToPanel(dir,selectedIdx){if(selectedIdx!==undefined){this.set("selectedIdx",selectedIdx);}else{this.updateSelectedIdx(dir);}this.children[this.selectedIdx]&&this.selectPanel(this.children[this.selectedIdx].k);}});}());