(function(){mstrmojo.requiresCls("mstrmojo.num","mstrmojo.VisChartUtils");var percent=0;var $NUM=mstrmojo.num;var NumUnits=[{n:1,s:""},{n:1000,s:"K"},{n:1000000,s:"M"},{n:1000000000,s:"B"},{n:1000000000000,s:"T"},{n:1000000000000000,s:"Q"}];var DEFAULT_LEN_LIMIT=3;var MAX_LEN_LIMIT=5;function normalizeValue(val,interval,isFloor){var ceilOrFloor=function(val,isFloor){return isFloor?Math.floor(val):Math.ceil(val);};var lab=ceilOrFloor(val/interval,isFloor)*interval;if(lab.toString().indexOf(".")>=0&&interval<1&&lab>1){lab=parseFloat(lab.toFixed(2));}if(lab>0&&lab<1&&interval>1/1000){lab=parseInt(ceilOrFloor(lab*100,isFloor))/100;}return lab;}function updateSeriesRawValues(s,ds){if(!ds){ds=",";}var sl=s.length;for(var i=0;i<sl;i++){var rvs=s[i].rv,l=rvs.length;for(var j=0;j<l;j++){if(Number(rvs[j])){break;}rvs[j]=rvs[j].replace(ds,".");}}}mstrmojo.VisChartData=mstrmojo.provide("mstrmojo.VisChartData",{process:function prcss(w){if((!w.baseModel&&w.model)||w.model.vp){this.setDerivedModel(w);var bm=w.baseModel,ch=bm.colHeaders,chl=ch.length,ds=ch[chl-1].items[0].ds;if(ds&&ds!=="."){updateSeriesRawValues(bm.series,ds);}else{if(!ds){updateSeriesRawValues(bm.series);}}}var model=w.model;var values=model.series,l=values.length;if(l<=0){return ;}var nlc=!w.isLinearChart&&w.isDrawAxis&&w.drawYAxisLabels,ms="";percent=0;var v=new Array();if(values&&values[0]&&values[0].rv.length){for(var j=0;j<l;j++){var s=values[j].rv,sl=s.length,k=v.length;for(var i=0;i<sl;i++){var val=s[i];if(!val||val.length==0){continue;}if(percent===0){percent=values[j].v[i].indexOf("%")>=0?100:1;}v[k]=parseFloat(val);if(nlc&&v[k].toString().length>ms.length){ms=v[k].toString();}k++;}}v=v.sort(function sortArray(a,b){return a-b;});}model.mvalues=v;if(nlc){model.mls=ms;model.ylbls=v;}},setDerivedModel:function sdm(w){var m=w.model,s=m.series,sl=s.length,ri=m.ri,rows=m.rowHeaders,cols=m.colHeaders;var rl=typeof (m.vp)!=="undefined"&&m.vp.rl&&m.vp.rl.length>0?m.vp.rl:null;w.baseModel=m;var rne=s[0].rv.length,rns=0;if(rl&&w.isTimeSeries){var rs=parseInt(rl[0].rs),sr=rl[0].sr;for(var i=0;i<rows.length;i++){if(rows[i].id==sr){rns=rne-(rows[i].l*rs)>=0?rne-(rows[i].l*rs):0;break;}}}w.model={categories:m.categories,mtrcs:m.mtrcs,series:s,colHeaders:cols,rowHeaders:rows,rne:rne,rns:rns,ri:ri};},processLinearData:function pld(w){this.process(w);var model=w.model;var vals=model.mvalues,_max=w.getMaxValue(),_min=w.getMinValue();var _lbs=this.generateAxisLabels(w,_max,_min);model.mvalues=_lbs;var da=w.isDrawAxis&&w.drawYAxisLabels;var useAbbr=w.isTimeSeries?w.formatProp.condenseLabels:true;if(da){var res=this.condenseLabels(_lbs,DEFAULT_LEN_LIMIT);if(useAbbr){var duplicatedCondensed=this.checkDuplicatedCondensed(res.condensedLabels);if(duplicatedCondensed){for(i=DEFAULT_LEN_LIMIT+1;i<MAX_LEN_LIMIT;++i){res=this.condenseLabels(_lbs,i);duplicatedCondensed=this.checkDuplicatedCondensed(res.condensedLabels);if(!duplicatedCondensed){break;}}if(duplicatedCondensed){useAbbr=false;}}model.mls=res.maxLabel;model.ylbls=res.condensedLabels;}if(!useAbbr){var formatedStr=[];var ms="";var items=model.colHeaders[model.colHeaders.length-1].items;var formatMask=items&&items[0]&&items[0].f||"";for(var i=0;i<_lbs.length;i++){formatedStr[i]=$NUM.formatByMask(formatMask,_lbs[i]);if(formatedStr[i].toString().length>ms.length){ms=formatedStr[i].toString();}}model.mls=ms;model.ylbls=formatedStr;}}},checkDuplicatedCondensed:function checkDuplicatedCondensed(lbls){var duplicatedCondensed=false;for(var i=1;i<lbls.length;i++){if(lbls[i]==lbls[i-1]){duplicatedCondensed=true;break;}}return duplicatedCondensed;},condenseLabels:function condenseLabels(lbls,lenLimit){var ll=lbls.length;var ms="";var _lbstr=new Array();for(var i=0;i<ll;i++){_lbstr[i]=this.formatNumber(lbls[i],lenLimit);if(_lbstr[i].toString().length>ms.length){ms=_lbstr[i].toString();}}return{condensedLabels:_lbstr,maxLabel:ms};},generateAxisLabels:function generateAxisLabels(w,_max,_min,intAsStep){var _lbs=new Array();if(_max==_min){if(_min<0){_lbs.push(_min);}_lbs.push(0);if(_min>0){_lbs.push(_min);}return _lbs;}var interval=this.calInterval(_max,_min,intAsStep);if(w.isTimeSeries&&w.formatProp.useCustomAxisScale){var labelMax=_max;var labelMin=_min;}else{var labelMax=normalizeValue(_max,interval,false);var labelMin=normalizeValue(_min,interval,true);}if((_min-labelMin)>0.9*interval){labelMin=normalizeValue(_min,interval,false);}if((labelMax-_max)>0.9*interval){labelMax=normalizeValue(_max,interval,true);}_lbs=new Array();if(interval<((labelMax-labelMin)/30)){_lbs.push(labelMin);_lbs.push(labelMax);}else{var currentValue=labelMin;while(currentValue<=labelMax){_lbs.push(currentValue);if(currentValue==labelMin){currentValue=Math.ceil((labelMin+interval/100)/interval)*interval;}else{currentValue=Math.ceil((currentValue+interval)*1000)/1000;}}if(_lbs[_lbs.length-1]<labelMax){_lbs.push(labelMax);}}return _lbs;},formatNumber:function formatNumber(number,lenLimit){var os="",on=1,posNum=number*percent;if(posNum<0){posNum=-number*percent;on=-1;os="-";}if(posNum<=1+0.000001){on*=posNum;if(posNum.toString().length<=lenLimit){os+=posNum;}else{var precision=2;os+=posNum.toFixed(precision);for(var i=os.length-1;i>=0;--i){if(os.charAt(i)=="."){break;}else{if(os.charAt(i)!="0"){++i;break;}}}if(i<os.length){os=os.substr(0,i);}}}else{var power=Math.log(posNum)/Math.LN10+0.000001;var n=parseInt(power/3);if(n>=NumUnits.length){n=NumUnits.length-1;}var fNum=posNum/NumUnits[n].n;var sNum=fNum.toString();if(sNum.length>lenLimit){var separatorIdx=sNum.indexOf(".");var fracLen=separatorIdx<0?0:sNum.length-separatorIdx+1,intLen=separatorIdx<0?sNum.length:separatorIdx;var nPrecision=lenLimit-intLen-1;sNum=fNum.toFixed(nPrecision<0?0:nPrecision);}on*=parseFloat(sNum)*NumUnits[n].n;os+=sNum+NumUnits[n].s;}return os;},calInterval:function cInt(_max,_min,intAsStep){var interval,diff=(_max-_min);if(diff==0){if(_max==0){_max=1;_min=-1;}else{_max=_max*2;_min=_min/2;}diff=_max-_min;}interval=1;if(diff<1){while(diff<1){diff*=10;interval/=10;}}else{if(diff>=10){while(diff>=10){diff/=10;interval*=10;}}}if(diff<1.8){interval*=0.2;}else{if(diff<3.1){interval*=0.4;}else{if(diff<4.6){interval*=0.5;}else{if(diff>=8.1){interval*=2;}}}}if(intAsStep){interval=Math.round(interval);if(interval<1){interval=1;}}else{if((interval>0&&interval<1)&&(parseInt(interval.toFixed(2)*100)/100)>0){interval=parseInt(interval.toFixed(2)*100)/100;}}return interval;}});})();