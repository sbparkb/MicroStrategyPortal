(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo.ui._HasScroller","mstrmojo.util.ui._HostsSplitter","mstrmojo.vi.ui._HasMask","mstrmojo.vi._MonitorsAppState","mstrmojo.vi.models.DropZonesModel","mstrmojo.dom","mstrmojo.css","mstrmojo.string","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.tooltip");mstrmojo.requiresClsP("mstrmojo.vi.ui","_IsViPanel","VizGalleryList");mstrmojo.requiresClsP("mstrmojo.vi.viz","EnumVisualizationTemplates","EnumVizStyles","EnumWidgetTypes");mstrmojo.requiresDescs(114,517,518,1995,7696,7697);var $MOJO=mstrmojo,$VIZ=$MOJO.vi.viz,$DOM=$MOJO.dom,$CSS=$MOJO.css,$STRING=$MOJO.string,$WIDGET_TYPES=$VIZ.EnumWidgetTypes,WTP_GRID=$WIDGET_TYPES.GRID,$VIZ_TEMPLATES=$VIZ.EnumVisualizationTemplates,$ARR=mstrmojo.array,$VizGalList=mstrmojo.vi.ui.VizGalleryList,$VIZ_LIST_TYPE=$VizGalList.VIZ_LIST_TYPE;var GRID_VIZ_ELEMENT={n:mstrmojo.desc(114,"Grid"),id:"VisGrid",vt:$VIZ_TEMPLATES.GRID},CUSTOM_STYLE="custom",DISPLAY_NONE="none",GALLERY_URL="http://visualizations.microstrategy.com";function getTooltipContent(requirements,model,preview){var selectedUnit=model.getSelectedViUnit(),unitDropZones=selectedUnit&&selectedUnit.getZonesModel(),htmlTooltip=['<div><span class="vi-name">{@n}</span>'+(preview?'<div class="vi-tooltip-icn icn-tooltip-{@id}"></div>':"")],htmlRequirements=[],fulfilledRequirements={};if(unitDropZones&&requirements){requirements.forEach(function(req){var type=req.t,requiredCnt=req.r,cnt=unitDropZones.getRequiredItemsInfo(type),requiredLabels={12:mstrmojo.desc(13429,"# more ##attributes###"),4:mstrmojo.desc(13431,"# more ##metrics###"),"long":mstrmojo.desc(13433,"# more ##longitudes###"),lat:mstrmojo.desc(13435,"# more ##latitudes###")};if(cnt<requiredCnt){htmlRequirements.push(requiredLabels[type].replace("###","</span><br/>").replace("##",'<span class="type'+type+'">').replace("#",requiredCnt-cnt));}else{fulfilledRequirements["t"+type]=requiredCnt;}});if(!htmlRequirements.length){var attributeRequirements=fulfilledRequirements["t"+12],metricRequirements=fulfilledRequirements["t"+4],resolvedLabels=[mstrmojo.desc(13436,"# attribute and ## metric"),mstrmojo.desc(13437,"# attribute and ## metrics"),mstrmojo.desc(13438,"# attributes and ## metric"),mstrmojo.desc(13439,"# attributes and ## metrics"),mstrmojo.desc(13440,"# attribute"),mstrmojo.desc(13441,"# attributes"),mstrmojo.desc(13442,"## metric"),mstrmojo.desc(13443,"## metrics")],resolvedLabelsIndex=-1;if(attributeRequirements&&metricRequirements){resolvedLabelsIndex=Math.min(attributeRequirements-1,1)<<1|Math.min(metricRequirements-1,1);}else{if(attributeRequirements){resolvedLabelsIndex=3+Math.min(attributeRequirements,2);}else{if(metricRequirements){resolvedLabelsIndex=5+Math.min(metricRequirements,2);}}}if(resolvedLabelsIndex!==-1){htmlRequirements.push(resolvedLabels[resolvedLabelsIndex].replace("##",metricRequirements).replace("#",attributeRequirements));}}}if(htmlRequirements.length){htmlRequirements=['<span class="vi-reqs">'].concat(htmlRequirements).concat(["</span>"]);}htmlTooltip=htmlTooltip.concat(htmlRequirements);htmlTooltip.push("</div>");return htmlTooltip.join("");}function isGalleryMasked(){var selectedUnit=this.model.getSelectedViUnit();return !selectedUnit||!(selectedUnit instanceof mstrmojo.vi.ui.rw.VizBox);}function viUnitSelected(){this.set("isMasked",isGalleryMasked.call(this));}function onItemSelection(evt){var added=evt.added,item=added&&this.items[added[0]];if(item){this.parent.model.changeSelectedVisType(item.s||"",item.vt,item.wtp||WTP_GRID,item.dz);}}mstrmojo.vi.ui.VizGallery=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo.vi.ui._IsViPanel,mstrmojo.ui._HasScroller,mstrmojo.vi.ui._HasMask,mstrmojo.vi._MonitorsAppState,mstrmojo.util.ui._HostsSplitter,mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.vi.ui.VizGallery",markupString:'<div id="{@id}" class="mstrmojo-VIGallery {@cssClass}" style="{@cssText}"><div class="mstrmojo-VIGallery-handle splitter v"></div><div class="mstrmojo-VIGallery-contents"><div class="mstrmojo-VIGallery-builtinVizList"></div><div class="mstrmojo-VIGallery-divider"></div><div class="mstrmojo-VIGallery-galleryLabel"></div><div class="mstrmojo-VIGallery-customVizList"></div><div class="mstrmojo-VIGallery-importCustomVizButton"></div></div><div class="mstrmojo-VIDND-mask"></div></div>',markupSlots:{handleNode:function handleNode(){return this.domNode.firstChild;},containerNode:function containerNode(){return this.domNode.childNodes[1];},builtinVizListNode:function builtinVizListNode(){return this.domNode.childNodes[1].childNodes[0];},dividerNode:function dividerNode(){return this.domNode.childNodes[1].childNodes[1];},galleryLabelNode:function galleryLabelNode(){return this.domNode.childNodes[1].childNodes[2];},customVizListNode:function customVizListNode(){return this.domNode.childNodes[1].childNodes[3];},importCustomVizBtnNode:function importCustomVizBtnNode(){return this.domNode.childNodes[1].childNodes[4];},maskNode:function maskNode(){return this.domNode.lastChild;}},layoutConfig:{h:{containerNode:"100%"},xt:true},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod},init:function init(props){this._super(props);this.model.attachEventListener("viUnitSelected",this.id,viUnitSelected);},getLayoutOffsets:function getLayoutOffsets(){return{w:1,h:0};},useRichTooltip:true,preview:false,DEFAULT_WIDTH:52,DEFAULT_LEFT_MARGIN:8,vizList:null,customVizList:null,model:null,handleNode:null,onAppStateChange:function onAppStateChange(evt){this._super(evt);this.set("isMasked",isGalleryMasked.call(this)||evt.value===mstrmojo.vi.VisualInsightApp.APP_STATES.SELECTOR_TARGETING);},setOpenStatus:function setOpenStatus(isOpen,noSave,update,skipReLayout){this._super(isOpen,noSave,update,skipReLayout);if(!noSave){var lv=mstrApp.rootCtrl.docCtrl.view.layoutViewer;lv.boxLayoutConfig.box.go=this.visible;lv.saveBoxLayout(undefined,undefined,undefined,update);}},children:[{scriptClass:"mstrmojo.vi.ui.VizGalleryList",slot:"builtinVizListNode",alias:"vizList",selectionPolicy:"reselect",type:$VIZ_LIST_TYPE.BUILT_IN_LIST,items:[GRID_VIZ_ELEMENT],postselectionChange:function postselectionChange(evt){onItemSelection.call(this,evt);}},{scriptClass:"mstrmojo.Widget",markupString:"<div class='separator'></div>",slot:"galleryLabelNode"},{scriptClass:"mstrmojo.Label",text:"CUSTOM",slot:"galleryLabelNode",cssClass:"galleryLabel"},{scriptClass:"mstrmojo.vi.ui.VizGalleryList",slot:"customVizListNode",alias:"customVizList",type:$VIZ_LIST_TYPE.CUSTOM_LIST,selectionPolicy:"reselect",items:[],postselectionChange:function postselectionChange(evt){onItemSelection.call(this,evt);}},{scriptClass:"mstrmojo.Button",slot:"importCustomVizBtnNode",cssClass:"importVizButton",onclick:function(){var position=$DOM.position(this.domNode),customVizButtonDiv=this.domNode.parentNode;position.x=position.x+4;position.y=position.y+3.65;$CSS.addClass(customVizButtonDiv,"clicked");var menuCfg=new mstrmojo.ui.menus.MenuConfig({position:position,isHostedWithin:false,menuCssClass:"importVizMenu"});menuCfg.addMenuItem(mstrmojo.desc(14736,"Import Visualization..."),"",function(){window.FormWrapper.importCustomVisualization();});menuCfg.addSeparator();menuCfg.addMenuItem(mstrmojo.desc(14691,"Browse Gallery..."),"",function(){window.FormWrapper.openPage(GALLERY_URL);});this.parent.openPopup(menuCfg.newInstance(),{onClose:function(){$CSS.removeClass(customVizButtonDiv,"clicked");}});}},],postBuildRendering:function postBuildRendering(){var handleNode=this.handleNode;handleNode.style.display="block";if(!mstrApp.isSingleTier){this.importCustomVizBtnNode.style.display=DISPLAY_NONE;if(this.customVizList.items.length===0){this.dividerNode.style.display=DISPLAY_NONE;this.galleryLabelNode.style.display=DISPLAY_NONE;this.customVizListNode.style.display=DISPLAY_NONE;}}this.registerSplitter(handleNode);return this._super();},setDimensions:function setDimensions(h,w){this._super(h,w);var handleNode=this.handleNode,handleStyle=handleNode&&handleNode.style;if(handleStyle){handleStyle.top=0;handleStyle.right=w;handleStyle.height=h;handleStyle.width="6px";}},getSplitterInfo:function getSplitterInfo(){return{isReverseMove:true,min:this.DEFAULT_WIDTH,max:this.DEFAULT_WIDTH*3-this.DEFAULT_LEFT_MARGIN};},splitterMoved:function splitterMoved(pixelsMoved){var prop="width",currentVizGalleryWidth=parseInt(this[prop],10),offset=0,ratio=pixelsMoved/this.DEFAULT_WIDTH,numberOfCoulmns=parseInt(ratio),isAnotherColumn=Math.abs(ratio%1);if(isAnotherColumn>0.25){offset=(pixelsMoved>0)?1:-1;}numberOfCoulmns+=offset;if(numberOfCoulmns!==0){currentVizGalleryWidth+=(this.DEFAULT_WIDTH-this.DEFAULT_LEFT_MARGIN)*numberOfCoulmns;this.set(prop,currentVizGalleryWidth+"px");}this.parent.doLayout();},splitterMouseDown:function splitterMouseDown(){this.domNode.parentNode.previousSibling.style.pointerEvents="none";},splitterMouseUp:function splitterMouseUp(){this.domNode.parentNode.previousSibling.style.pointerEvents="inherit";},update:function update(isOnVizDeletion){if(mstrApp.getRecentGallery){mstrApp.getRecentGallery(isOnVizDeletion);}this.vizList.set("items",[GRID_VIZ_ELEMENT].concat($VizGalList.getVizList($VIZ_LIST_TYPE.BUILT_IN_LIST)));this.customVizList.set("items",$VizGalList.getVizList($VIZ_LIST_TYPE.CUSTOM_LIST));this.cleanUpListeners();this.updateScrollbars(true);},showTooltip:function showTooltip(evt,win){var target=$DOM.findAncestorByAttr($DOM.eventTarget(win,evt),"idx",true,this.domNode),node=target&&target.node,isCustom=node&&node.className.indexOf(CUSTOM_STYLE)>-1,list=isCustom?this.customVizList:this.vizList,item=target&&list.items[target.value],name=item&&item.n,id=item&&item.id;if(!name||name===""){return ;}var position=$DOM.position(node),content=$STRING.apply(getTooltipContent(item.mr,this.model,this.preview),{n:name,id:id});if(!content){return ;}this.richTooltip={posType:mstrmojo.tooltip.POS_TOPRIGHT,cssClass:"viGallery-tooltip vi-regular vi-tooltip-D"+(this.preview?" preview":""),content:content,top:position.y-12-(this.preview?56:0),left:position.x-7,keepArrowYPos:true};this._super(evt,win);},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.containerNode;},updateScrollbars:function updateScrollbars(reRender){this._super();if(reRender){this.addScrollNodeProperties();}},cleanUpListeners:function cleanUpListeners(){$ARR.forEach(this.installedEventListeners,function(h){$DOM.detachEvent(h.e,h.evt,h.fn);});}});}());