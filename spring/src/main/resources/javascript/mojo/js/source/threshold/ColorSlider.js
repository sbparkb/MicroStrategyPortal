(function(){mstrmojo.requiresClsP("mstrmojo","Widget","num","css","Container","Box","Label","EditableLabel","Image");mstrmojo.requiresClsP("mstrmojo.threshold","ColorBand","ImageBand","MarkersNode","ColorMarker","ThresholdModel");var $DOM=mstrmojo.dom,$NUM=mstrmojo.num,$CSS=mstrmojo.css,ALIAS=["bands","markers"];var ENUM_TP_BAND=0,ENUM_TP_MARKER=1;var SLIDER_MODE=mstrmojo.threshold.ThresholdModel.SLIDER_MODE;function addChild(alias){var childWidget;if(alias===ALIAS[ENUM_TP_BAND]){childWidget=this.sliderMode===SLIDER_MODE.IMAGE_BASED?new mstrmojo.threshold.ImageBand():new mstrmojo.threshold.ColorBand();}else{childWidget=new mstrmojo.threshold.ColorMarker();}this[alias].addChildren([childWidget]);}function updateColorSlider(type){var containerWidget=this[ALIAS[type]],children=containerWidget.children,domLen=children?children.length:0,comp=this.getComp(),palette=this.getPalette(),sliderWidth=this.width,mapLen=type?comp.length-1:comp.length,isImageBased=this.sliderMode===SLIDER_MODE.IMAGE_BASED,i,child,width;if(domLen>mapLen){for(i=domLen-mapLen-1;i>=0;i--){containerWidget.removeChildren(children[i]);}}else{if(mapLen>domLen){for(i=0;i<mapLen-domLen;i++){addChild.call(this,ALIAS[type]);}}}if(type===0&&this.getReversedValue()){palette=palette.concat().reverse();}children=containerWidget.children;var previousPosition,currentPosition;for(i=0;i<mapLen;i++){child=children[i];previousPosition=parseInt(i===0?0:sliderWidth*comp[i-1],10);currentPosition=parseInt(sliderWidth*comp[i],10);if(type===0){child.set("left",(this.containerNode.offsetLeft+previousPosition+1)+"px");width=currentPosition-previousPosition;$CSS.toggleClass(child.domNode,"no-border",!width);child.set("width",width+"px");if(isImageBased){child.set("src",palette[i]);child.domNode.firstChild.style.left=child.domNode.clientWidth/2-12+"px";}else{child.set("backgroundColor",palette[i]);}}else{child.set("left",currentPosition-(isImageBased?0:1)+"px");}child.set("index",i);}}function buildDefaultMap(map,defaultModel,isImageBased){defaultModel.forEach(function(defaultSet){var m=map[defaultSet.id]={palette:[],comp:[],reversed:false};defaultSet.bands.forEach(function(band){m.palette.push(band[isImageBased?"url":"bc"]);m.comp.push(band.end/100);});});}function getDefaultColorMap(){var model=this.parent.model,map={};buildDefaultMap(map,model.getDefaultColors(),false);buildDefaultMap(map,model.getDefaultImages(),true);return map;}mstrmojo.threshold.TextBubble=mstrmojo.declare(mstrmojo.EditableLabel,null,{scriptClass:"mstrmojo.EditableLabel",visible:false,cssClass:"editable-bubble",text:"",isPercentage:true,maxValue:1,showBubble:function(value){this.updatePosition(value);this.updateText(value);this.set("visible",true);},hideBubble:function(){this.set("visible",false);},updatePosition:function updatePosition(value){this.domNode.style.left=this.parent.width*value+"px";},updateText:function(value){var slider=this.parent,model=slider.parent.model,displayValue=model.getRealValue(value,slider.selectedOption);if(slider.selectedOption===7){displayValue=$NUM.formatByMask(model.getFormatString(),displayValue);}if(this.isPercentage){displayValue+="%";}this.set("text",String(displayValue));}});mstrmojo.threshold.ColorSlider=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.threshold.ColorSlider",markupString:'<div class = "mstrmojo-color-slider {@cssClass}"  style="{@cssText}" mstrAttach:click,keyup><div class="labels"></div><input type="text" class="hidden-field"></div>',markupSlots:{containerNode:function containerNode(){return this.domNode;},labelsNode:function labelsNode(){return this.domNode.firstChild;},hiddenField:function hiddenField(){return this.domNode.lastChild;}},sliderMode:SLIDER_MODE.COLOR_BASED,baseColor:undefined,editableBubble:undefined,hoverBubble:undefined,bands:undefined,markers:undefined,colorMap:undefined,selectedOption:undefined,getComp:function getComp(){return this.colorMap[this.baseColor].comp;},getPalette:function getPalette(){return this.colorMap[this.baseColor].palette;},getReversedValue:function getReversedValue(){var colorMap=this.colorMap;return colorMap&&colorMap[this.baseColor].reversed||false;},postBuildRendering:function postBuildRendering(){this.width=$DOM.position(this.containerNode).w;this.resetColorMap();if(this._super){this._super();}this.update();},resetColorMap:function resetColorMap(){this.colorMap=getDefaultColorMap.call(this);},onkeyup:function(event){var evt=window.event||event.e,keyCode=evt.keyCode;if(this.sliderMode===SLIDER_MODE.COLOR_BASED&&(keyCode===mstrmojo.Enum_Keys.DELETE||keyCode===mstrmojo.Enum_Keys.BACKSPACE)){if(this.editableBubble.isEditing){return ;}var node,idx;if(this.bands.isSelected){node=this.bands;}else{if(this.markers.isSelected){node=this.markers;}else{return ;}}idx=node.selectedIndex;node.children[idx].unselect();node.remove(idx);this.update();}},update:function update(){if(this.baseColor){updateColorSlider.call(this,ENUM_TP_BAND);updateColorSlider.call(this,ENUM_TP_MARKER);}},onsliderModeChange:function onsliderModeChange(){$CSS.toggleClass(this.domNode,"image-mode",this.sliderMode===SLIDER_MODE.IMAGE_BASED);this.unselectAll();this.bands.removeChildren();},onbaseColorChange:function onbaseColorChange(){this.unselectAll();this.update();},onselectedOptionChange:function selectedOption(v){var model=this.parent.model,editableBubble=this.editableBubble,oldBubbleValue=editableBubble.text;this.updateLabels(v.value);if(editableBubble.visible){if(v.valueWas===1||v.valueWas===2){oldBubbleValue=oldBubbleValue.slice(0,oldBubbleValue.length-1);}editableBubble.updateText(model.getNormalizedValue(oldBubbleValue,v.valueWas));}},updateLabels:function updateLables(basedOnType){var model=this.parent.model,editableBubble=this.editableBubble,hoverBubble=this.hoverBubble,start,end;basedOnType=basedOnType||this.selectedOption;if(basedOnType===1||basedOnType===2){start="0%";end="100%";editableBubble.set("isPercentage",true);hoverBubble.set("isPercentage",true);}else{if(basedOnType===4||basedOnType===5){start="0";end=model.getMetricsCount();editableBubble.set("isPercentage",false);hoverBubble.set("isPercentage",false);}else{var formatString=model.getFormatString();start=$NUM.formatByMask(formatString,model.getMetricsMinValue());end=$NUM.formatByMask(formatString,model.getMetricsMaxValue());editableBubble.set("isPercentage",false);hoverBubble.set("isPercentage",false);}}this.startLabel.set("text",start);this.endLabel.set("text",end);},setColorComp:function setColorComp(color,comp){var colorMap=this.colorMap;if(colorMap){colorMap[color].comp=comp;this.unselectAll();this.update();}},addCustomScheme:function(comp,palette){this.colorMap.custom={comp:comp,palette:palette,reversed:false};this.set("baseColor","custom");},addMarkerToMap:function addMarkerToMap(x){var comp=this.getComp(),len=comp.length,i;if(comp[0]>x){i=0;}else{for(i=1;i<len;i++){if(comp[i-1]<=x&&comp[i]>=x){break;}}}comp.splice(i,0,x);this.unselectAll();return i;},unselectAll:function unselectAll(){var bands=this.bands;if(bands.isSelected){bands.children[bands.selectedIndex].unselect();}var markers=this.markers,selectedIndex=markers.selectedIndex;if(markers.isSelected&&markers.children[selectedIndex]){markers.children[selectedIndex].unselect();}},reverseMapColor:function reverseMapColor(){if(this.colorMap&&this.baseColor){var map=this.colorMap[this.baseColor];map.reversed=!map.reversed;this.unselectAll();this.update();}},children:[{scriptClass:"mstrmojo.Label",cssClass:"start-label",alias:"startLabel",slot:"labelsNode",text:"0%"},{scriptClass:"mstrmojo.Label",cssClass:"end-label",alias:"endLabel",slot:"labelsNode",text:"100%"},{scriptClass:"mstrmojo.threshold.TextBubble",alias:"editableBubble",slot:"labelsNode",allowEmptyText:true,onTextEditComplete:function(changed,oldText){if(changed){var text=this.text;if(this.isPercentage){text=text.replace(/%$/,"");}var prefix=oldText.charAt(0);if(prefix.match(/\W/)!==null){text=text.replace(new RegExp("^\\"+prefix),"");}text=$NUM.parseNumeric(text);if(isNaN(text)){this.set("text",oldText);return ;}var slider=this.parent,model=slider.parent.model,normalizedValue=model.getNormalizedValue(text,slider.selectedOption),comp=slider.getComp();this.updatePosition(normalizedValue);var selectedIdx=slider.markers.selectedIndex;comp.splice(selectedIdx,1);var i=slider.addMarkerToMap(normalizedValue);slider.markers.children[i].select();slider.update();}}},{scriptClass:"mstrmojo.threshold.TextBubble",alias:"hoverBubble",slot:"labelsNode",allowEmptyText:false},{scriptClass:"mstrmojo.Box",cssClass:"color-bands",alias:"bands",isSelected:false,selectedIndex:0,remove:function deleteBand(i){if(this.children.length===1){return ;}var slider=this.parent;var comp=slider.getComp(),palette=slider.getPalette();if(i===this.children.length-1){comp.splice(i-1,1);}else{comp.splice(i,1);}palette.splice(i,1);},onBandHovered:function(index){this.isSelected=true;},onBandUnhovered:function(index){this.isSelected=false;},onBandSelected:function(index){var i,bands=this.children,slider=this.parent,markers=slider.markers;for(i=0;i<bands.length;i++){if(i!==index&&bands[i].selected){bands[i].unselect();}}if(markers.isSelected===true){markers.children[markers.selectedIndex].unselect();}slider.hiddenField.focus();this.isSelected=true;this.selectedIndex=index;},onBandUnselected:function(index){var i,bands=this.children;for(i=0;i<bands.length;i++){if(i!==index&&bands[i].selected){return ;}}this.isSelected=false;}},{scriptClass:"mstrmojo.threshold.MarkersNode",alias:"markers",isSelected:false,selectedIndex:0,onMarkerSelected:function onMarkerSelected(index){var m=this.parent;m.editableBubble.showBubble(m.getComp()[index]);var i,markers=this.children;for(i=0;i<markers.length;i++){if(i!==index&&markers[i].selected){markers[i].unselect();}}var bands=m.bands;if(bands.isSelected===true){bands.children[bands.selectedIndex].unselect();}this.parent.hiddenField.focus();this.isSelected=true;this.selectedIndex=index;},onMarkerUnselected:function(index){var i,markers=this.children;for(i=0;i<markers.length;i++){if(i!==index&&markers[i].selected){return ;}}this.parent.editableBubble.hideBubble();this.isSelected=false;},onMarkerHovered:function onMarkerHovered(index){var m=this.parent;m.hoverBubble.showBubble(m.getComp()[index]);this.isSelected=true;},onMarkerUnhovered:function onMarkerUnhovered(index){this.parent.hoverBubble.hideBubble();this.isSelected=false;}}]});}());