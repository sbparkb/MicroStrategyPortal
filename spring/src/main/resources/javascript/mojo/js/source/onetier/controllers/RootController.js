(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.mstr.EnumWebAPIErrorCodes","mstrmojo.vi.controllers.RootController","mstrmojo.onetier.vi.prefs.OneTierPalettesEditor","mstrmojo.onetier.vi.prefs.PreferencesEditor","mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy","mstrmojo.onetier.vi.prefs.HostedDesktopConnectivityProxy","mstrmojo.onetier.vi.ui.LoginToProjectBox","mstrmojo.onetier.vi.ui.ObjectBrowserDataProvider","mstrmojo.onetier.vi.ui.OpenFromServerBrowser","mstrmojo.onetier.vi.ui.SaveToCloud","mstrmojo.onetier.vi.ui.SaveToServerBrowser","mstrmojo.onetier.vi.ui.CubeBrowser","mstrmojo.onetier.vi.ui.LoginBox");mstrmojo.requiresDescs(1442,2399,8966,13811,14012,14014,14298,14299,14300,14491,14492);var $DOM=mstrmojo.dom,$ERROR=mstrmojo.onetier.vi.prefs.handleErrorMessage,_forceShutDown;function getConnectivityProxy(){return mstrApp.isSingleTier?new mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy():new mstrmojo.onetier.vi.prefs.HostedDesktopConnectivityProxy();}mstrmojo.onetier.controllers.RootController=mstrmojo.declare(mstrmojo.vi.controllers.RootController,null,{scriptClass:"mstrmojo.onetier.controllers.RootController",dataProvider:null,handleFirstTimeUserHelp:function handleFirstTimeUserHelp(data){var dataSets=data.datasets;if(window.FormWrapper.getShowVITutorial()&&!mstrApp.tutorialShown&&(!dataSets||!Object.keys(dataSets).length)){this.showTutorial({cls:"initial"});mstrApp.tutorialShown=true;}else{this.hideTutorial();}},loadDataAndStartController:function loadDataAndStartController(startParams){if(mstrConfig.messageBundle){mstrmojo.locales.update(mstrConfig.messageBundle.localeInfo);}var data=startParams&&startParams.data;if(data){mstrApp.hideWait();if(data.showWait){var messageType=data.msgTp,waitConfig;if(messageType){waitConfig={message:{dda:mstrmojo.desc(14014,"Connecting to data source. Please wait...")}[messageType]};}mstrApp.showWait(waitConfig);}else{this.startControllerOnDataReady(startParams);["dragover","drop"].forEach(function(evtName){$DOM.attachEvent(window,evtName,function(e){e=e||event;e.preventDefault();});});}}},refreshVizGallery:function refreshVizGallery(isOnVizDeletion){this.galleryPanel.update(isOnVizDeletion);},showPrefsEditor:function showPrefsEditor(preferencesData){var connectivityProxy=getConnectivityProxy(),controller=this;openPrefsEditor=function openPrefsEditor(data){var editor=new mstrmojo.onetier.vi.prefs.PreferencesEditor({data:data,connectivityProxy:connectivityProxy});if(preferencesData&&preferencesData.inputConnectionDetails){editor.onClose=function(){controller.docCtrl.inputConnectionDetails();};}else{if(preferencesData&&preferencesData.browseAllObjects){editor.onClose=function(){controller.docCtrl.browseObjectsOnServer();};}else{if(preferencesData&&preferencesData.uploadDashboard){editor.onClose=function(){controller.openSaveToServerBrowser();};}else{if(preferencesData&&preferencesData.downloadDashboard){editor.onClose=function(){controller.openFromProjectBrowser();};}else{if(preferencesData&&preferencesData.addDataset){editor.onClose=function(){controller.openCubeBrowser();};}}}}}editor.open();};if(!preferencesData){connectivityProxy.getSavedPreferences({success:function success(res){openPrefsEditor(res);}.bind(this)});}else{openPrefsEditor(preferencesData);}},showColorPalettesEditor:function showColorPalettesEditor(colorPalettesData){(new mstrmojo.onetier.vi.prefs.OneTierPalettesEditor({title:mstrmojo.desc(13811,"Color Palette"),serverRequest:function(params,callback,config){mstrApp.serverRequest(params,callback,config);},paletteThemesData:colorPalettesData})).open();},showOrHideProgressBar:function showOrHideProgressBar(title,show){var viProgressBarID="viProgBar",viProgressBarConfig={scriptClass:"mstrmojo.Editor",id:viProgressBarID,draggable:false,showTitle:true,zIndex:99999,cssClass:"viProgressBarDialog",children:[{scriptClass:"mstrmojo.ProgressBar",markupString:'<div id="{@id}" class="mstrmojo-ProgressBar {@cssClass}" style="{@cssText}"><div class="percentage">{@pctText}</div><div class="bar"><div class="indicator"></div></div><div class="text">{@progressText}</div></div>',markupSlots:{progressNode:function(){return this.domNode.firstChild;},barNode:function(){return this.domNode.children[1];},textNode:function(){return this.domNode.lastChild;}},updateProgress:function updateProgress(ptg,text){var percentage=Math.min(100,Math.max(0,parseInt(ptg,10)));if(this.hasRendered){this.barNode.firstChild.style.width=percentage+"%";if(text!==undefined){this.set("progressText",text);}this.progressNode.innerHTML=percentage+"% complete";}},alias:"progress"},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-buttonBar",alias:"buttonBar",slot:"buttonNode",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",alias:"cancel",text:mstrmojo.desc(2399,"Cancel"),onclick:function(){var connectivityProxy=getConnectivityProxy(),editor=this.parent.parent;connectivityProxy.cancelRequest(editor.requestID,{success:function success(res){if(!res.isCancelled){mstrmojo.alert(mstrmojo.desc(14300,"You cannot cancel now."),null,"",editor.zIndex+1);}}});}}]}]},viProgressBarDialog=mstrmojo.all[viProgressBarID]||mstrmojo.insert(viProgressBarConfig);if(show){viProgressBarDialog.set("title",title);viProgressBarDialog.open();viProgressBarDialog.progress.updateProgress(0,"");}else{viProgressBarDialog.close();}},updateProgressBar:function updateProgressBar(data){var viProgressBarID="viProgBar",viProgressBarDialog=mstrmojo.all[viProgressBarID];if(viProgressBarDialog===undefined){return ;}viProgressBarDialog.requestID=data.requestID;viProgressBarDialog.progress.updateProgress(data.pct,data.msg);viProgressBarDialog.buttonBar.cancel.set("enabled",data.canCancel);},shutDownDesktop:function shutDownDesktop(){var connectivityProxy=getConnectivityProxy(),position,waitBoxID="ShutDownWait",waitBox=mstrmojo.all[waitBoxID]||mstrmojo.insert({scriptClass:"mstrmojo.Editor",id:waitBoxID,cssClass:"mstrWaitBox",draggable:false,showTitle:false,zIndex:1000000,position:null,children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrIcon-wait",alias:"icon"},{scriptClass:"mstrmojo.Label",cssClass:"mstrWaitMsg",text:mstrmojo.desc(14491,"Shutting down...")},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton mstrWaitCancel",text:mstrmojo.desc(14492,"Force Quit"),onclick:function onclick(){_forceShutDown=true;}}]});if(!waitBox.visible){waitBox.open();}mstrmojo.dom.center(waitBox.editorNode);position=mstrApp.getWaitBoxPosition();if(position){var top=position.top,left=position.left;if(top!==undefined){waitBox.set("top",top+"px");}if(left!==undefined){waitBox.set("left",left+"px");}}connectivityProxy.shutDownDesktop({success:function success(res){if(res.close){waitBox.close();}}},_forceShutDown);},confirmLogout:function confirmLogout(){var controller=this;this.datasetsPanel.onLogout();mstrmojo.confirm(mstrmojo.desc(14298,"You have successfully logged out."),{confirmBtn:{t:mstrmojo.desc(1442,"OK")},cancelBtn:{t:mstrmojo.desc(14299,"Login Again"),fn:function(){if(this.text===mstrmojo.desc(14299,"Login Again")){controller.openFromProjectBrowser();}}}});},loginToWebserver:function loginToWebserver(params){var connectivityProxy=getConnectivityProxy();var postAuthFunction=mstrmojo.emptyFn;var controller=this;if(params.recoveryIndex){mstrApp.recoveryIndex=params.recoveryIndex;}if(params.resumeDashboardExec){postAuthFunction=connectivityProxy.resumeDashboardExecution;}connectivityProxy.httpStatusCodeHandler(params.code,postAuthFunction,{loginTitle:mstrmojo.desc(14011,"Web Server: ##").replace("##",params.wsn),authenticateCredentials:function authenticateCredentials(userName,password){connectivityProxy.loginToWebserver(params.wsn,userName,password,{success:function(res){if(params.recoveryIndex){res.resumeDashboardExec=true;}controller.loginToWebserver(res);}});}});},loginToProxy:function loginToProxy(params){var connectivityProxy=getConnectivityProxy();if(params.recoveryIndex){mstrApp.recoveryIndex=params.recoveryIndex;}var proxyUrl=params.proxyUrl;connectivityProxy.httpStatusCodeHandler(params.code,mstrmojo.emptyFn,{saveToPrefs:true,loginTitle:mstrmojo.desc(14012,"Proxy authentication required: ##").replace("##",proxyUrl),authenticateCredentials:function authenticateCredentials(userName,password){connectivityProxy.loginToProxy(params.proxyUrl,userName,password,this.saveToPrefs,{success:this.loginToProxy.bind(this)});}.bind(this)});},loginToProject:function loginToProject(webServers){var webserverCntr=0,connectivityProxy=getConnectivityProxy(),items,index;if(webServers[0].recoveryIndex){mstrApp.recoveryIndex=webServers[0].recoveryIndex;}function handleWebserverLoop(){if(webserverCntr<webServers.length){var webServer=webServers[webserverCntr++],defaultLoginInfo=webServer.loginInfo,connectionId=webServer.connectionId,iServers=[],iServerCntr=0,showLoginDialog=function showLoginDialog(){if(webServer.loginRequired){var l=connectivityProxy.parseServerURL(webServer.ws),hostName=l.wsn+":"+l.wsport;mstrmojo.onetier.vi.ui.LoginBox.openDialog(mstrmojo.desc(14013,"Login to server ##").replace("##",hostName),{webServer:{connection:{id:connectionId||"-1"},loginInfo:defaultLoginInfo,loginFirst:true,url:webServer.ws}},connectivityProxy,{success:function success(sessionState,authMode){connectivityProxy.login({connectionId:connectionId,server:webServer.server,project:webServer.project,port:webServer.port,webServerURL:webServer.ws,lfs:sessionState,authMode:authMode||webServer.loginInfo.defaultAuthMode},{success:function(){handleWebserverLoop();},failure:function(res){if(res.taskErrorCode===mstrmojo.mstr.EnumWebAPIErrorCodes.MSI_SERVER_NOT_FOUND){handleWebserverLoop();}else{$ERROR(res);}}});}});}else{if(iServerCntr<iServers.length){var iServer=iServers[iServerCntr++],projects=iServer.projects;projects.forEach(function(projectInfo){var iServerName=projectInfo.iServer.clusterName;mstrmojo.onetier.vi.ui.LoginBox.openDialog(mstrmojo.desc(14013,"Login to server ##").replace("##",iServerName+" - "+projectInfo.name),{webServer:{connection:{id:connectionId||"-1"},loginInfo:defaultLoginInfo},iServer:projectInfo.iServer,project:projectInfo},connectivityProxy,{success:function success(){showLoginDialog();}});});}else{handleWebserverLoop();}}};mstrmojo.array.forEach(webServer.clusters,function(cluster){items=[];cluster.forEach(function(iServer){(iServer.projects||[]).forEach(function(project){index=mstrmojo.array.find(items,"name",project.name);if(index<0){iServer.clusterName=iServer.name;project.iServer=iServer;items.push(project);}else{items[index].iServer.clusterName=items[index].iServer.clusterName+"/"+iServer.name;}});});iServers.push({projects:items});});showLoginDialog();}else{connectivityProxy.resumeDashboardExecution();}}handleWebserverLoop();},openSaveToServerBrowser:function openSaveToServerBrowser(){this.docCtrl.model.operation="uploadDashboard";var editor=new mstrmojo.onetier.vi.ui.SaveToServerBrowser({connectivityProxy:getConnectivityProxy(),docModel:this.docCtrl.model,dataProvider:this.dataProvider,selectedProject:this.selectedProject});this.connectToServerEditorId=editor.id;editor.open();},openFromProjectBrowser:function openFromProjectBrowser(){this.docCtrl.model.operation="downloadDashboard";var editor=new mstrmojo.onetier.vi.ui.OpenFromServerBrowser({connectivityProxy:getConnectivityProxy(),docModel:this.docCtrl.model,dataProvider:this.dataProvider,selectedProject:this.selectedProject});this.connectToServerEditorId=editor.id;editor.open();},openCubeBrowser:function openCubeBrowser(callback){var cb=!!(callback&&(callback.success||callback.failure))?callback:null,model=this.docCtrl.model;this.docCtrl.model.operation="addDataset";var editor=new mstrmojo.onetier.vi.ui.CubeBrowser({connectivityProxy:getConnectivityProxy(),docModel:model,callback:cb,addDataset:!cb,dataProvider:this.dataProvider,selectedProject:this.selectedProject,authMode:this.authMode});this.connectToServerEditorId=editor.id;editor.open();},saveToCloud:function saveToCloud(){(new mstrmojo.onetier.vi.ui.SaveToCloud({connectivityProxy:getConnectivityProxy(),docModel:this.docCtrl.model})).open();},loadDataProvider:function loadDataProvider(callback){var me=this;var proxy=getConnectivityProxy();if(this.dataProvider&&(this.dataProvider.currentProject||this.selectedProject)){callback(this.dataProvider);}else{var openOB=function(res,project){me.set("dataProvider",new mstrmojo.onetier.vi.ui.ObjectBrowserDataProvider({connectivityProxy:proxy,sessionState:res.sessionState,connectionId:res.connectionId,currentProject:project}));callback(me.dataProvider);};var openDialog=function(){if(mstrmojo.onetier.vi.ui.LoginToProjectBox.isBoxOpen()){return ;}mstrmojo.onetier.vi.ui.LoginToProjectBox.openDialog({label:"",validateConnectedServer:true,docModel:me.docCtrl.model},null,{success:function(res,currentProject){proxy.isCurrentProject(currentProject,{success:function(isCurrentProject){if(isCurrentProject){openOB(res,currentProject);}else{mstrmojo.confirm(mstrmojo.desc(14316,"A dashboard can have Schema Objects from a single MicroStrategy project only. If you switch to a different project, you will lose all your changes. Do you want to continue? "),{confirmBtn:{fn:function(){proxy.getCleanDocModel({success:function(docModelData){mstrApp.start(docModelData);openOB(res,currentProject);}});}}});}}});}});};if(!mstrmojo.onetier.vi.ui.LoginToProjectBox.isBoxOpen()&&proxy){proxy.getWebServersProjects({success:openDialog,failure:openDialog});}}},resetUndoStack:function resetUndoStack(){var cmdMgr=this.docCtrl.cmdMgr;cmdMgr.reset();cmdMgr.dataService.stid=0;}});}());