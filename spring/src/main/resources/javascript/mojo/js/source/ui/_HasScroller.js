(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.dom","mstrmojo.fx");var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$ARR=mstrmojo.array,$SB_PROPS={v:{styleDim:"height",styleDir:"top",dimension:"h",position:"y",scroll:"scrollTop",scrollDimension:"scrollHeight",cls:"vertical",hostCls:"hasVertical",scrollNodeCls:"hasVertical"},h:{styleDim:"width",styleDir:"left",dimension:"w",position:"x",scroll:"scrollLeft",scrollDimension:"scrollWidth",cls:"horizontal",hostCls:"hasHorizontal",scrollNodeCls:"hasHorizontal"}},CSS_SCROLLING_MODE="scrollingMode",CSS_SCROLLING="scrolling",SCROLLBAR_MIN_BUFFER=3;var isMac=$DOM.getOSInfo().name.toLowerCase().indexOf("mac")>=0;function getScrollbarHostNode(){return(this.scrollbarHostNode||(this.scrollNode&&this.scrollNode.parentNode));}function scrollTrackClick(evt,hWin){var target=$DOM.eventTarget(hWin,evt),scrollNode=this.scrollNode,scrollNodePos=$DOM.position(scrollNode),scrollTrackNodes=this.scrollTrackNodes,scrollBarNodes=this.scrollBarNodes,processTrackClick=function processTrackClick(direction){var isScrollTrack=target===scrollTrackNodes[direction];if(isScrollTrack){var scrollBarProps=$SB_PROPS[direction],scrollBar=scrollBarNodes[direction],targetPos=$DOM.position(scrollBar),clickPos=$DOM.getMousePosition(evt,hWin)[scrollBarProps.position],scrollbarDelta=clickPos-targetPos[scrollBarProps.position],sign=scrollbarDelta>0?1:-1,scrollDimension=scrollNode[scrollBarProps.scrollDimension],scrollNodeDelta=Math.abs(scrollbarDelta-(targetPos.h/2))*(scrollDimension/scrollNodePos[scrollBarProps.dimension]),animateProps={};animateProps[scrollBarProps.scroll]={isStyle:false,start:scrollNode[scrollBarProps.scroll],stop:scrollNode[scrollBarProps.scroll]+(sign*Math.min(scrollDimension/3,500,scrollNodeDelta)),ease:mstrmojo.ease.linear};(new mstrmojo.fx.AnimateProp({props:animateProps,duration:200,interval:10,target:scrollNode})).play();}};processTrackClick.call(this,"h");processTrackClick.call(this,"v");}function scrollTrackWheelHandler(evt,hWin){var scrollNode=this.scrollNode,isMouseWheelEvt=evt.type==="mousewheel",negation=isMouseWheelEvt?-1:1;mstrmojo.array.forEach(["h","v"],function(direction){var scrollBarProps=$SB_PROPS[direction],wheelDeltaProp=isMouseWheelEvt?"wheelDelta":"delta",wheelDelta=evt[wheelDeltaProp+{h:"X",v:"Y"}[direction]]*negation,wheelDeltaAbs=Math.abs(wheelDelta),sign=wheelDelta/wheelDeltaAbs,isFirefoxOnWin=wheelDeltaAbs===3&&$DOM.isFF&&!isMac;scrollNode[scrollBarProps.scroll]+=isFirefoxOnWin?sign*40:wheelDelta;});$DOM.stopPropogation(hWin,evt);$DOM.preventDefault(hWin,evt);}function iSNodeScrollable(direction){var scrollBarProps=$SB_PROPS[direction],scrollNode=this.scrollNode,scrollNodePos=$DOM.position(scrollNode),scrollNodeDim=scrollNodePos[scrollBarProps.dimension],scrollDimension=scrollNode[scrollBarProps.scrollDimension],scrollRatio=Math.ceil(scrollNodeDim)/scrollDimension;return isScrollable(scrollRatio,scrollNodeDim,scrollDimension);}function isScrollable(scrollRatio,scrollNodeDim,scrollDimension){return(!isNaN(scrollRatio)&&scrollRatio<1)&&(Math.abs(scrollNodeDim-scrollDimension)>SCROLLBAR_MIN_BUFFER);}function setupScrollBars(direction){var px="px",scrollBarProps=$SB_PROPS[direction],scrollNode=this.scrollNode,hostNode=getScrollbarHostNode.call(this),scrollNodePos=$DOM.position(scrollNode),scrollNodeDim=scrollNodePos[scrollBarProps.dimension],scrollDimension=scrollNode[scrollBarProps.scrollDimension],scrollRatio=Math.ceil(scrollNodeDim)/scrollDimension,scrollBarNodes=this.scrollBarNodes,scrollBar=scrollBarNodes[direction],scrollTrackNodes=this.scrollTrackNodes,scrollTrack=scrollTrackNodes[direction],isNodeScrollable=isScrollable(scrollRatio,scrollNodeDim,scrollDimension),scrollCSSClass=scrollBarProps.cls;if(!scrollBar){scrollTrack=scrollTrackNodes[direction]=document.createElement("div");var widget=this,clickHandler=function(e){scrollTrackClick.call(widget,e);},wheelHandler=function(e){scrollTrackWheelHandler.call(widget,e);},registerEventListener=function(e,evt,h){$DOM.attachEvent(e,evt,h);widget.installedEventListeners.push({e:e,evt:evt,fn:h});};registerEventListener(scrollTrack,"click",clickHandler);scrollTrack.className="mstrmojo-scrolltrack "+scrollCSSClass;scrollBar=scrollBarNodes[direction]=document.createElement("div");scrollBar.className="mstrmojo-scrollbar "+scrollCSSClass;scrollTrack.appendChild(scrollBar);hostNode.appendChild(scrollTrack);var wheelEvent=mstrApp.isSingleTier?"mousewheel":"wheel";registerEventListener(scrollTrack,wheelEvent,wheelHandler);registerEventListener(scrollBar,wheelEvent,wheelHandler);}var scrollBarStyle=scrollBar.style,percentageScrolled=(scrollNode[scrollBarProps.scroll]/scrollNode[scrollBarProps.scrollDimension]),scrollNodeDelta=$DOM.delta(scrollNode,getScrollbarHostNode.call(this))[scrollBarProps.position],scrollTrackStyle=scrollTrack.style;if(isNodeScrollable){scrollTrackStyle[scrollBarProps.styleDir]=scrollNodeDelta+px;scrollBarStyle[scrollBarProps.styleDim]=(scrollRatio*scrollNodeDim)+px;scrollBarStyle[scrollBarProps.styleDir]=(scrollNodeDim*percentageScrolled)+px;}$CSS.toggleClass(hostNode,scrollBarProps.hostCls,isNodeScrollable);$CSS.toggleClass(scrollNode,scrollBarProps.scrollNodeCls,isNodeScrollable);return isNodeScrollable;}function shouldShowScrollbars(){return !(mstrApp.isSingleTier&&isMac);}mstrmojo.ui._HasScroller=mstrmojo.provide("mstrmojo.ui._HasScroller",{_mixinName:"mstrmojo.ui._HasScroller",hasCustomScrollbar:null,draggable:true,ownAvatar:true,scrollNode:undefined,scrollbarHostNode:undefined,scrollBarNodes:undefined,setupScrollNodes:mstrmojo.emptyFn,installedEventListeners:null,init:function init(props){this._super(props);if(this.hasCustomScrollbar===null){this.hasCustomScrollbar=shouldShowScrollbars();}this.installedEventListeners=[];},onRender:function onRender(){if(this._super){this._super();}this.updateScrollbars();this.addScrollNodeProperties();},addScrollNodeProperties:function addScrollNodeProperties(){var scrollNode=this.scrollNode;if(scrollNode){var fnEventHandler=$DOM.attachMarkupEvent(this.id,scrollNode,"scroll");this.installedEventListeners.push({e:scrollNode,evt:"scroll",fn:fnEventHandler});}if(!this.hasCustomScrollbar){$CSS.addClass(scrollNode,"mstrmojo-sb-show-default");return ;}if(scrollNode){$CSS.addClass(getScrollbarHostNode.call(this),"mstrmojo-scrollbar-host");$CSS.addClass(scrollNode,"mstrmojo-scrollNode");}},updateScrollbars:function updateScrollbars(){if(!this.hasRendered){return ;}this.setupScrollNodes();if(!this.hasCustomScrollbar){if(this.scrollNode){this.scrollNode.style.overflowX=iSNodeScrollable.call(this,"h")?"scroll":"hidden";}return ;}if(this.scrollNode){this.scrollBarNodes=this.scrollBarNodes||{};this.scrollTrackNodes=this.scrollTrackNodes||{};var scrollNodeStyle=this.scrollNode.style;scrollNodeStyle.overflowY=setupScrollBars.call(this,"v")?"scroll":"hidden";scrollNodeStyle.overflowX=setupScrollBars.call(this,"h")?"scroll":"hidden";}},onscroll:function onscroll(){var scrollNode=this.scrollNode;if(scrollNode&&this.hasCustomScrollbar){var getNumber=function getNumber(value){var n=parseInt(value);return n===null||isNaN(n)?0:n;},scrollNodePos=$DOM.position(scrollNode),scrollNodeHeight=scrollNodePos.h-getNumber($CSS.getStyleValue(scrollNode,"padding-bottom")),scrollNodeWidth=scrollNodePos.w-getNumber($CSS.getStyleValue(scrollNode,"padding-right")),scrollBarNodes=this.scrollBarNodes,vScrollBar=scrollBarNodes.v,hScrollBar=scrollBarNodes.h;if(scrollNode.scrollHeight-scrollNodeHeight>0){vScrollBar.style.top=((scrollNodeHeight-$DOM.position(vScrollBar).h)*(scrollNode.scrollTop/(scrollNode.scrollHeight-scrollNodeHeight)))+"px";}if(scrollNode.scrollWidth-scrollNodeWidth>0){hScrollBar.style.left=((scrollNodeWidth-$DOM.position(hScrollBar).w)*(scrollNode.scrollLeft/(scrollNode.scrollWidth-scrollNodeWidth)))+"px";}}if(this._super){this._super();}if(this.onScrollEnd){this.onScrollEnd();}},getDragData:function getDragData(context){var scrollNode=this.scrollNode,scrollNodePos=$DOM.position(scrollNode),sourceNode=context.src.node,scrollbarNodes=this.scrollBarNodes;if(this.isDraggingScrollBar(context)){return{isScrollBar:true,direction:sourceNode===scrollbarNodes.v?"v":"h",scrollTop:scrollNode.scrollTop,scrollLeft:scrollNode.scrollLeft,conversionRatio:{y:scrollNode.scrollHeight/scrollNodePos.h,x:scrollNode.scrollWidth/scrollNodePos.w}};}return(this._super&&this._super(context));},isDragValid:function isDragValid(context){return this.isDraggingScrollBar(context)||(this._super&&this._super(context))||false;},isDraggingScrollBar:function isDraggingScrollBar(context){var sourceNode=context.src.node,scrollbarNodes=this.scrollBarNodes;return !!scrollbarNodes&&(sourceNode===scrollbarNodes.v||sourceNode===scrollbarNodes.h);},ondragstart:function ondragstart(context){if(this.isDraggingScrollBar(context)){$CSS.addClass(context.src.node,CSS_SCROLLING);$CSS.addClass(getScrollbarHostNode.call(this),CSS_SCROLLING_MODE);}if(this._super){this._super(context);}},shouldDragBubble:function shouldDragBubble(context){var sourceNode=context.src.node,scrollTrackNodes=this.scrollTrackNodes;return !!scrollTrackNodes&&(sourceNode===scrollTrackNodes.v||sourceNode===scrollTrackNodes.h);},ondragmove:function ondragmove(context){if(this.isDraggingScrollBar(context)){var target=context.tgt,source=context.src,targetPos=target.pos,sourcePos=source.pos,sourceNode=source.node,scrollNode=this.scrollNode,scrollbarNodes=this.scrollBarNodes,dragData=source.data,scrollbarDelta={y:(targetPos.y-sourcePos.y),x:(targetPos.x-sourcePos.x)},conversionRatio=dragData.conversionRatio;if(sourceNode===scrollbarNodes.v){scrollNode.scrollTop=dragData.scrollTop+(scrollbarDelta.y*conversionRatio.y);}else{scrollNode.scrollLeft=dragData.scrollLeft+(scrollbarDelta.x*conversionRatio.x);}}if(this._super){this._super(context);}},ondragend:function ondragmove(context){if(this.isDraggingScrollBar(context)){$CSS.toggleClass(context.src.node,CSS_SCROLLING,false);$CSS.toggleClass(getScrollbarHostNode.call(this),CSS_SCROLLING_MODE,false);}if(this._super){this._super(context);}},widgetResized:function widgetResized(){if(this._super){this._super();}this.updateScrollbars();},unrender:function unrender(ignoreDom){$ARR.forEach(this.installedEventListeners,function(h){$DOM.detachEvent(h.e,h.evt,h.fn);});delete this.scrollNode;delete this.scrollbarHostNode;delete this.scrollBarNodes;delete this.scrollTrackNodes;this._super(ignoreDom);}});}());