(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.Button");mstrmojo.requiresDescs(1825,2121,12609,14216,14662);var constants=mstrmojo.DI.DIConstants;var fileObjectConfig={scriptClass:"mstrmojo.Container",slot:"tableNode",markupString:"<div class='mstrmojo-url-list-dnd' title='{@title}' mstrAttach:click ><div></div><div></div><div></div></div>",markupSlots:{containerNode:function(){return this.domNode;},imageNode:function(){return this.domNode.children[1];},contentNode:function(){return this.domNode.children[2];},deleteNode:function(){return this.domNode.children[0];}},markupMethods:{onisFolderChange:function(){if(this.isFolder){mstrmojo.css.addClass(this.imageNode.firstChild,"drop-zone-folder");}else{mstrmojo.css.addClass(this.imageNode.firstChild,"drop-zone-file");}}},name:"",isFolder:"",children:[{scriptClass:"mstrmojo.Button",slot:"deleteNode",cssClass:"item-delete",innerIconClass:"close-button",onclick:function(){}},{slot:"contentNode",alias:"text",cssClass:"item-content",scriptClass:"mstrmojo.Label",bindings:{text:"this.parent.text"}},{slot:"imageNode",alias:"image",cssClass:"item-image",scriptClass:"mstrmojo.Label"}],preBuildRendering:function(){if(this._super){this._super();}this.fileName.text=this.name;},onclick:function(evt){var fileObject=this;var originalSrc=evt.e.srcElement||evt.e.target;if(originalSrc.className!=="mstrmojo-Button item-delete"){return ;}var afterDelete=function(){var index=-1,i;var files=fileObject.parent.files;var newFiles=[];for(i=0;i<files.length;i++){if(files[i].name===fileObject.name){index=i;break;}}if(index>=0){files.splice(index,1);}fileObject.parent.set("files",files);fileObject.parent.removeChildren(fileObject);};var tableID=this.tableID;if(tableID){var cb={success:function(res){if(res&&res.msgid){mstrApp.getRootController().dataService.set("messageID",res.msgid);}mstrApp.getRootController().model.resetImportSource(tableID);afterDelete();},failure:function(res){mstrApp.getRootController().displayError(mstrmojo.desc(14662,"Delete file error."));}};var params={did:this.tableID,progressText:"Delting file..."};mstrApp.getRootController().removeEMMASourceTable(cb,params);}else{afterDelete();}}};var urlObjectConfig={scriptClass:"mstrmojo.Container",slot:"tableNode",markupString:"<div class='mstrmojo-url-list-dnd' title='{@title}' mstrAttach:click ><div></div><div></div><div></div></div>",markupSlots:{containerNode:function(){return this.domNode;},imageNode:function(){return this.domNode.children[1];},contentNode:function(){return this.domNode.children[2];},deleteNode:function(){return this.domNode.children[0];}},markupMethods:{onisFolderChange:function(){if(this.isFolder){mstrmojo.css.addClass(this.imageNode.firstChild,"drop-zone-folder");}else{mstrmojo.css.addClass(this.imageNode.firstChild,"drop-zone-file");}}},allowEdit:true,url:"",text:"",isFolder:"",children:[{scriptClass:"mstrmojo.Button",slot:"deleteNode",cssClass:"item-delete",innerIconClass:"close-button",onclick:function(){}},{slot:"contentNode",alias:"text",cssClass:"item-content",scriptClass:"mstrmojo.Label",bindings:{text:"this.parent.text"}},{slot:"imageNode",alias:"image",cssClass:"item-image",scriptClass:"mstrmojo.Label"}],onclick:function(evt){var urlObject=this;var originalSrc=evt.e.srcElement||evt.e.target;if(originalSrc.className!=="mstrmojo-Button item-delete"){return ;}var i;var afterDelete=function(){var urls=urlObject.parent.urls;for(i=0;i<urls.length;i++){if(urls[i]===urlObject.url){if(urlObject.parent.urlTableID){delete urlObject.parent.urlTableID[urls[i]];}urls.splice(i,1);break;}}if(urls.length===0){urlObject.parent.textNode.style.display="block";urlObject.parent.imageNode.style.display="block";}urlObject.parent.set("urls",urls);urlObject.parent.removeChildren(urlObject);urlObject.hideTooltip(evt,self);};var tableID=this.tableID;if(this.tableID){var cb={success:function(res){if(res&&res.msgid){mstrApp.getRootController().dataService.set("messageID",res.msgid);}mstrApp.getRootController().model.resetImportSource(tableID);afterDelete();},failure:function(res){mstrApp.getRootController().displayError(mstrmojo.desc(14662,"Delete file error."));}};var params={did:this.tableID,progressText:"Deleting file..."};mstrApp.getRootController().removeEMMASourceTable(cb,params);}else{afterDelete();}}};function isValidFile(transferObj){var r=true;var reader;if(transferObj.size%4096===0){if(transferObj.slice(0).size===0){mstrApp.getRootController().displayError(mstrmojo.desc(12609,"Error in importing the file. Please check the file being imported"));r=false;return r;}}return r;}mstrmojo.DI.FileDragDropBoxDnD=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.DI.FileDragDropBoxDnD",markupString:'<div class="{@cssClass}"><form target="{@id}_iframe" enctype="multipart/form-data" method="post" action="taskProc"><div class="mstrmojo-di-fileHolder drag-drop-box-dnd" mstrAttach:dragover,dragleave,drop,click,mouseenter,mouseleave><div class="mstrmojo-FileDragDropBox-count"></div><div class="di-dropbox-image"></div><div class="mstrmojo-FileDragDropBox-text">{@text}</div><div class="mstrmojo-FileDragDropBox-content"></div></div><div class="mstrmojo-FileDragDropBox-buttonDiv"><div class="mstrmojo-di-button primary-button">{@browseLabel}</div><input class="mstrmojo-FileUploadBox-file" type="file" {@multiple} size="30" style="font-size:4em;" name="{@fileFieldName}" onchange="mstrmojo.all.{@id}.synFile();"/></div><div style="display:none;"></div></form><iframe id="{@id}_iframe" + name="{@id}_iframe" style="display:none;" src="about:blank"></iframe></div>',markupSlots:{formNode:function(){return this.domNode.firstChild;},dnDNode:function(){return this.domNode.firstChild.children[0];},countNode:function(){return this.domNode.firstChild.children[0].children[0];},imageNode:function(){return this.domNode.firstChild.children[0].children[1];},textNode:function(){return this.domNode.firstChild.children[0].children[2];},tableNode:function(){return this.domNode.firstChild.children[0].children[3];},buttonNode:function(){return this.domNode.firstChild.children[1];},fileNode:function(){return this.domNode.firstChild.children[1].lastChild;},paramsNode:function(){return this.domNode.firstChild.children[2];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";this.buttonNode.style.display=this.fileUpload?"block":"none";this.textNode.style.display="block";}},visible:true,files:[],urls:[],fileFieldName:"myFile",text:mstrmojo.desc(14216,"Drop files here"),browseLabel:mstrmojo.desc(1825,"Browse"),multiple:"",droppable:true,fileUpload:true,dropZone:true,allowDrop:function allowDrop(context){return true;},jsonp:"parent.mstrmojo.all.{@id}.uploadCallback(@R@)",postCreate:function(){if(this._super){this._super();}this.files=[];this.urls=[];},onmouseenter:function mouseenter(){mstrmojo.css.addClass(this.dnDNode,"hover");},onmouseleave:function mouseleave(){mstrmojo.css.removeClass(this.dnDNode,"hover");},ondragenter:function ondragenter(){mstrmojo.css.addClass(this.dnDNode,"dragging");mstrmojo.css.addClass(this.dnDNode,"hover");},ondragover:function ondragover(){if(!this.droppable){return ;}},ondragleave:function ondragleave(){if(!this.droppable){return ;}this.className="";mstrmojo.css.removeClass(this.dnDNode,"dragging");mstrmojo.css.removeClass(this.dnDNode,"hover");},ondrop:function ondrop(evt){if(!this.droppable){return ;}var selectedNodes=evt.src.data,i;for(i=0;i<selectedNodes.length;i++){this.addURL(selectedNodes[i].data.address,selectedNodes[i].text);}mstrmojo.css.removeClass(this.dnDNode,"dragging");},_set_urls:function(n,v){this.urls=v||[];return true;},addURL:function(url,fileName,isFolder,fullPath){if(mstrmojo.string.isEmpty(url)){return ;}if(mstrmojo.string.isEmpty(fileName)){return ;}var urls=this.urls||[];urlObjectConfig.url=url;urlObjectConfig.text=fileName;urlObjectConfig.useRichTooltip=true;urlObjectConfig.fullPath=fullPath||"";var urlObj=this.addChildren(mstrmojo.insert(urlObjectConfig));urlObj._ontooltipover=function(e){urlObj.richTooltip={cssClass:"vi-regular vi-tooltip-A",refNode:urlObj.domNode,posType:mstrmojo.tooltip.POS_TOPLEFT,top:22,content:urlObj.fullPath};urlObj.showTooltip(e,self);};urlObj.render();urlObj.set("isFolder",isFolder);urls.push(url);this.set("urls",urls);this.textNode.style.display="none";this.imageNode.style.display="none";},removeURL:function(url){var urlObj=null,i,urls=this.urls;for(i=0;i<this.children.length;i++){if(this.children[i].url===url){urlObj=this.children[i];break;}}if(urlObj){urls.splice(i,1);this.removeChildren(urlObj);this.set("urls",urls);}},addFile:function addFile(name,file){fileObjectConfig.name=name;fileObjectConfig.title=name;fileObjectConfig.file=file;var fileTable=this.addChildren(mstrmojo.insert(fileObjectConfig));fileTable.render();this.textNode.style.display="none";this.imageNode.style.display="none";},submit:function(ps,callbacks,config){function handleFileLoaded(e){var array=[];array.push(e.target.result);var blob=new Blob(array);mstrApp.showProgress(config);mstrmojo.xhr.upload("POST",mstrConfig.taskURL,callbacks,ps,blob,config);}function handleFileLoadError(e){var res={code:0,message:"Cannot read file content"};if(callbacks.failure){callbacks.failure(res);}if(callbacks.complete){callbacks.complete();}}var r=true;if(this.onsubmit){r=this.onsubmit();}if(r){ps=ps||{};ps.fileFieldName=this.fileFieldName;ps.jsonp=this.jsonp.replace("{@id}",this.id);if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)){if(this.params){ps=this.params;}if(ps.__index!==undefined){(function(file){var filename=file.name;var reader=new FileReader();reader.onload=function(e){var tmp=filename;ps.fileName=filename;var array=[];array.push(e.target.result);var blob=new Blob(array);mstrApp.showProgress();mstrmojo.xhr.upload("POST",mstrConfig.taskURL,callbacks,ps,blob,config);};reader.onerror=handleFileLoadError;reader.readAsArrayBuffer(file);})(this.files[ps.__index]);}else{var i;for(i=0;i<this.files.length;i++){(function(file){var filename=file.name;var reader=new FileReader();reader.onload=function(e){var tmp=filename;ps.fileName=filename;var array=[];array.push(e.target.result);var blob=new Blob(array);mstrApp.showProgress();mstrmojo.xhr.upload("POST",mstrConfig.taskURL,callbacks,ps,blob,config);};reader.readAsArrayBuffer(file);})(this.files[i]);}}}else{ps.taskEnv="jsonp2";var h=[],p;for(p in ps){h.push('<input type="hidden" name="'+p+'" value="'+mstrmojo.string.encodeHtmlString(ps[p].toString())+'"/>');}if(this.params){ps=this.params;for(p in ps){h.push('<input type="hidden" name="'+p+'" value="'+mstrmojo.string.encodeHtmlString(ps[p])+'"/>');}}this.paramsNode.innerHTML=h.join("");if(callbacks){this.onSuccess=callbacks.success;this.onFailed=callbacks.failure;}this.formNode.submit();}this.set("status","loading");}},uploadCallback:function(d){var success=(d.status==200);if(success&&this.onSuccess){this.onSuccess(d);}if(!success&&this.onFailed){this.onFailed(d);}},preBuildRendering:function(){if(this._super){this._super();}},getFilesCnt:function(){if(this.files){return this.files.length;}else{return 0;}},getFileName:function(idx){if(idx<this.files.length){filename=this.files[idx].name;return filename;}return"";},getFileTableID:function(idx){if(this.urls&&idx<this.urls.length){return this.urlTableID&&this.urlTableID[this.urls[idx]];}if(this.files&&idx<this.files.length){return this.files[idx].tableID;}return null;},updatePageConfig:function(config){var i,child,cnt;var fileTable,urlList;var toRemovedChild=[];var tableID=config.properties.tableID;var currentSource=config.properties.model.importSources[tableID];if(config.name!==undefined&&config.tableID&&config.properties&&config.properties.sourceSubtype===constants.sourceSubtype.localFile){toRemovedChild=[];for(i=0;this.children&&i<this.children.length;i++){child=this.children[i];if(child.domNode&&child.domNode.parentNode===this.tableNode){toRemovedChild.push(child);}}cnt=toRemovedChild.length;for(i=0;i<cnt;i++){this.removeChildren(toRemovedChild[i]);}this.set("files",[]);config=mstrmojo.hash.copy(config,mstrmojo.hash.copy(fileObjectConfig));fileTable=this.addChildren([mstrmojo.insert(config)]);this.set("files",[{name:config.name,tableID:config.tableID}]);this.textNode.style.display="none";this.imageNode.style.display="none";}if(config.name!==undefined&&config.tableID&&config.properties&&config.properties.sourceSubtype===constants.sourceSubtype.url){toRemovedChild=[];if(currentSource){var url=currentSource.sourceInfo.url;}for(i=0;this.children&&i<this.children.length;i++){child=this.children[i];if(child.domNode&&child.domNode.parentNode===this.tableNode){toRemovedChild.push(child);}}cnt=toRemovedChild.length;for(i=0;i<cnt;i++){this.removeChildren(toRemovedChild[i]);}this.set("urls",[]);this.set("visible",true);config.url=url;config=mstrmojo.hash.copy(config,mstrmojo.hash.copy(urlObjectConfig));urlList=this.addChildren([mstrmojo.insert(config)]);this.set("urls",[url]);this.urlTableID={};this.urlTableID[url]=tableID;}},setFilesObject:function(files){var i,child,cnt;var toRemovedChild=[];for(i=0;this.children&&i<this.children.length;i++){child=this.children[i];if(child.domNode&&child.domNode.parentNode===this.tableNode){toRemovedChild.push(child);}}cnt=toRemovedChild.length;for(i=0;i<cnt;i++){this.removeChildren(toRemovedChild[i]);}this.set("files",[]);for(i=0;files&&i<files.length;i++){fileObjectConfig.name=files[i];this.addChildren([mstrmojo.insert(fileObjectConfig)]);}},setURLsObject:function(urls){var i,child,cnt;var toRemovedChild=[];for(i=0;this.children&&i<this.children.length;i++){child=this.children[i];if(child.domNode&&child.domNode.parentNode===this.tableNode){toRemovedChild.push(child);}}cnt=toRemovedChild.length;for(i=0;i<cnt;i++){this.removeChildren(toRemovedChild[i]);}this.set("urls",[]);if(urls.length>0){this.set("visible",true);this.textNode.style.display="none";this.imageNode.style.display="none";}else{this.set("visible",false);}for(i=0;i<urls.length;i++){urlObjectConfig.url=urls[i];var fileName=urls[i].substring(urls[i].lastIndexOf("/")+1,urls[i].lastIndexOf("?")===-1?urls[i].length:urls[i].lastIndexOf("?"));if(!mstrmojo.string.isEmpty(fileName)){urlObjectConfig.text=fileName;}this.addChildren([mstrmojo.insert(urlObjectConfig)]);}},synFile:function(){var files=[],i,fileTable,currFiles=this.files;if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)){files=this.fileNode.files;}else{var oas=new ActiveXObject("Scripting.FileSystemObject");files.push(oas.getFile(this.fileNode.value));}for(i=0;i<files.length;i++){currFiles.push(files[i]);fileObjectConfig.name=files[i].name;fileTable=this.addChildren(mstrmojo.insert(fileObjectConfig));fileTable.render();}this.set("files",currFiles);this.textNode.style.display="none";this.imageNode.style.display="none";},onclick:function(evt){var originalSrc=evt.e.srcElement||evt.e.target;var i=0,cnt=0,child;if(originalSrc.className!=="mstrmojo-Button-text close-button"){return ;}for(i=0;this.children&&i<this.children.length;i++){child=this.children[i];if(child.domNode&&child.domNode.parentNode===this.tableNode){cnt++;}}if(cnt===0){this.textNode.style.display="block";this.imageNode.style.display="block";}},getURLCnt:function(){if(this.urls){return this.urls.length;}else{return 0;}},updateItemsCount:function(cnt){if(cnt>1){this.countNode.style.display="block";}else{this.countNode.style.display="none";}this.countNode.textContent=mstrmojo.desc(2121,"Total")+": "+cnt;},onurlsChange:function(){this.updateItemsCount(this.getURLCnt());}});}());