(function(){var DefaultColor={Min:15872549,Max:1489202,Invalid:0,NoColorMetric:16119287};var BandDirection={LeftToRight:0,RightToLeft:1,Center:2,None:3};function getColorInRange(i,s,e){if(i<0||i>1){return 0;}var range=256,index=i*range,r,g,b,sR=s>>16,eR=e>>16,sG=(s&65280)>>8,eG=(e&65280)>>8,sB=(s&255),eB=(e&255);r=sR+Math.floor((index*(eR-sR)/range));g=sG+Math.floor((index*(eG-sG)/range));b=sB+Math.floor((index*(eB-sB)/range));return b+(g<<8)+(r<<16);}function darkerHex(h,p){var r=h>>16,g=(h&65280)>>8,b=(h&255);r=Math.floor((1-p)*r);g=Math.floor((1-p)*g);b=Math.floor((1-p)*b);return b+(g<<8)+(r<<16);}function convertBlendToBand(bl){var ba=[],blc,bac,dp=bl.dp,l=dp.length,blp,bln;if(bl==null||bl.length==0){return[];}for(var i=0;i<l;i++){bac={};var blp,bap;if(i>0){blp=blc;blc=bln;}else{blc=dp[i];}if(i<l-1){bln=dp[i+1];}bac.sv=(i==0)?blc.v:(blp.v+blc.v)/2;bac.ev=(i==l-1)?blc.v:(bln.v+blc.v)/2;bac.c=blc.c;bac.d=(i==0)?BandDirection.LeftToRight:(i==l-1?BandDirection.RightToLeft:BandDirection.Center);ba[i]=bac;}return ba;}function convertBandToBlend(ba){var bl=[],blc,bac,dp=ba.dp,l=dp.length;if(ba==null||ba.length==0){return[];}for(var i=0;i<l;i++){blc={};bac=dp[i];var s=bac.s,e=bac.e;blc.c=bac.c;switch(bac.d){case BandDirection.LeftToRight:blc.v=bac.s;break;case BandDirection.RightToLeft:blc.v=bac.e;case BandDirection.Center:case BandDirection.None:default:var avg=(bac.s+bac.e)/2;blc.v=avg;break;}bl[i]=blc;}return bl;}function getBlendFillInfo(min,max){var colors=[],alphas=[],ratios=[];if(this.min==this.max||isNaN(min)||isNaN(max)||min==max){colors[0]=getBlendColor.call(this,min);colors[1]=getBlendColor.call(this,max);alphas[0]=1;alphas[1]=1;ratios[0]=0;ratios[1]=1;}else{if(this.min<this.max){var c,dp=this.blend.dp,l=dp.length,index=0;colors[index]=getBlendColor.call(this,min);alphas[index]=1;ratios[index]=0;index++;for(var i=0;i<l;i++){c=dp[i];if(c.v>=min&&c.v<=max){colors[index]=c.c;alphas[index]=1;ratios[index]=(c.v-min)/(max-min);index++;}}colors[index]=getBlendColor.call(this,max);alphas[index]=1;ratios[index]=1;}}return{c:colors,a:alphas,r:ratios};}function getBandFillInfo(min,max){var colors=[],alphas=[],ratios=[];if(this.min==this.max||isNaN(min)||isNaN(max)||min==max){colors[0]=getBandColor.call(this,min);colors[1]=getBandColor.call(this,max);alphas[0]=1;alphas[1]=1;ratios[0]=0;ratios[1]=1;}else{if(this.min<this.max){var dp=this.band.dp,l=dp.length,a=0.4,c,co,dc,index=0;if(min<0){colors[index]=getBandColor(min);alphas[index]=1;ratios[index]=0;index++;if(max<1){colors[index]=getBandColor(max);alphas[index]=1;ratios[index]=1;index++;}}for(var i=0;i<l;i++){c=dp[i];if(c.s>max||c.e<min){continue;}co=c.c;dc=darkerHex(co,a);var sv=Math.max(c.s,min),ev=Math.min(c.e,max);if(ev!=sv){switch(c.d){case BandDirection.LeftToRight:case BandDirection.RightToLeft:case BandDirection.Center:if(sv==c.s){colors[index]=(c.d!=BandDirection.LeftToRight)?dc:co;}else{colors[index]=getBandColor.call(this,sv);}ratios[index]=(sv-min)/(max-min);alphas[index]=1;index++;if(c.d==BandDirection.Center){var avg=(c.s+c.e)/2;if(avg>sv&&avg<ev){colors[index]=co;ratios[index]=(avg-min)/(max-min);alphas[index]=1;index++;}}if(ev==c.e){colors[index]=(c.d!=BandDirection.RightToLeft)?dc:co;}else{colors[index]=getBandColor.call(this,ev);}ratios[index]=(ev-min)/(max-min);alphas[index]=1;index++;break;case BandDirection.None:default:colors[index]=co;ratios[index]=(sv-min)/(max-min);alphas[index]=1;index++;colors[index]=co;ratios[index]=(ev-min)/(max-min);alphas[index]=1;index++;break;}}}if(max>1){if(min>1){colors[index]=getBandColor.call(this,min);ratios[index]=0;alphas[index]=1;index++;}colors[index]=getBandColor.call(this,max);ratios[index]=1;alphas[index]=1;}}}return{c:colors,a:alphas,r:ratios};}function getBandColorFromData(v,d){var r=0.4,dc=darkerHex(d.c,r),mv,p;switch(d.d){case BandDirection.LeftToRight:if(v<d.s){return d.c;}if(v>d.e){return dc;}if(d.s==d.e){return getColorInRange(0.5,d.c,dc);}p=(v-d.s)/(d.e-d.s);return getColorInRange(p,d.c,dc);case BandDirection.RightToLeft:if(v<d.s){return dc;}if(v>d.e){return d.c;}if(d.s==d.e){return getColorInRange(0.5,dc,d.c);}p=(v-d.s)/(d.e-d.s);return getColorInRange(p,dc,d.c);case BandDirection.Center:mv=(d.s+d.e)/2;if(v<d.s||v>d.e){return dc;}if(d.s==d.e){return dc;}if(v<=mv){p=(v-d.s)/(mv-d.s);return getColorInRange(p,dc,d.c);}p=(v-mv)/(d.e-mv);return getColorInRange(p,d.c,dc);case BandDirection.None:default:return d.c;}}function getBlendColor(v){if(isNaN(v)){return DefaultColor.Invalid;}if(this.max==this.min){return this.blendEqualColor;}var dp=this.blend.dp,l=dp.length;if(!this.valid){var s=dp[0],e=dp[l-1];if(v<this.min){return s.c;}return e.c;}var i,c=dp[0],sv=c.v,sc=c.c,ev,ec;for(i=1;i<l;i++){c=dp[i];if(c.v>=v){break;}sv=c.v;sc=c.c;}i=Math.min(i,l-1);c=dp[i];ev=c.v;ec=c.c;if(v<sv){return sc;}if(v>ev){return ec;}if(sv==ev){return getColorInRange(0.5,sc,ec);}var p=(v-sv)/(ev-sv);return getColorInRange(p,sc,ec);}function getBandColor(v){if(isNaN(v)){return DefaultColor.Invalid;}if(this.min==this.max){return this.bandEqualColor;}var dp=this.band.dp,l=dp.length;if(!this.valid){var s=dp[0],e=dp[l-1];if(v<this.min){return getBandColorFromData(e.s,s);}else{return getBandColorFromData(e.e,e);}}for(var i=0;i<l;i++){c=dp[i];if(c.s===c.e){continue;}if(c.s<=v&&v<=c.e){return getBandColorFromData(v,c);}}}function createDefaultBlendDataProvider(min,max){this.blend.dp=[];var dp=this.blend.dp,bc;bc={};bc.c=min;bc.v=0;dp[0]=bc;bc={};bc.c=max;bc.v=1;dp[1]=bc;}function createDefaultBandDataProvider(min,max){this.band.dp=[];var dp=this.band.dp,bc;bc={};bc.d=BandDirection.LeftToRight;bc.s=0;bc.e=0.5;bc.c=min;dp[0]=bc;bc={};bc.d=BandDirection.LeftToRight;bc.s=0.5;bc.e=1;bc.c=max;dp[1]=bc;}function createBlendTooltipInfo(c,w,d){var ar=[],sx=0,sv,ev,min=this.min,max=this.max,tc=d.legendTickCount,rt={},co,valid=!isNaN(this.min)&&!isNaN(this.max);if(this.min>=this.max||this.blend.dp.length<=2){var f=(max-min)/tc;for(var i=0;i<c;i++){rt={x:sx,w:Math.floor(w/tc)};sx+=rt.w;if(valid){sv=min+i*f;ev=sv+f;co=this.getColor((sv+ev)/2);}else{sv="Null";ev="Null";co=0;}ar.push({r:rt,c:co,sv:sv,ev:ev});}}else{var dp=this.blend.dp,l=dp.length;for(var i=0;i<l;i++){var item=dp[i],p,n;if(i==0){sv=min;}else{p=dp[i-1];sv=min+(max-min)*(item.v+p.v)/2;}if(i==l-1){ev=max;}else{n=dp[i+1];ev=min+(max-min)*(item.v+n.v)/2;}rt={x:sx,w:Math.floor(w*(ev-sv)/(max-min))};sx+=rt.w;if(valid){co=this.getColor((sv+ev)/2);}else{sv="Null";ev="Null";co=0;}ar.push({r:rt,c:co,sv:sv,ev:ev});}}this.tooltipInfo=ar;}function createBandTooltipInfo(c,w,d){var ar=[],sx=0,sv,ev,min=this.min,max=this.max,tc=d.legendTickCount,rt={},co,st,valid=!isNaN(this.min)&&!isNaN(this.max);if(this.min>=this.max){for(var i=0;i<c;i++){rt={x:sx,w:Math.floor(w/tc)};st+=rt.w;if(valid){st=sv+" < "+ms+" < "+ev;co=this.getColor(min);}else{sv="Null";ev="Null";co=0;}ar.push({r:rt,c:co,sv:sv,ev:ev});}}else{var imax,imin;if(this.isFixedColorBanding){imax=this.initMax;imin=this.initMin;}else{imax=max;imin=min;}var dp=this.band.dp,l=dp.length;if(l<=2){for(var i=0;i<l;i++){var item=dp[i];if(i==0){sv=imin;}else{sv=imin+(imax-imin)*item.s;}if(i==l-1){ev=imax;}else{ev=imin+(imax-imin)*item.e;}if(sv<min){sv=min;}if(ev>max){ev=max;}if(sv>ev&&ev>=max){sv=max;ev=max;}else{if(ev<sv&&sv<=min){sv=min;ev=min;}}rt={x:sx,w:Math.floor(w*(ev-sv)/(max-min)/2)};sx+=rt.w;if(valid){ev=(sv+ev)/2;co=this.getColor((sv+ev)/2);}else{sv="Null";ev="Null";co=0;}ar.push({r:rt,c:co,sv:sv,ev:ev});sx+=rt.w;var bw=w*(ev-sv)/(max-min)/2;rt={x:sx,w:Math.ceil(bw)};if(i>0){var pr=ar[ar.length-1].r;if(rt.x<pr.x+pr.w+1){pr.w=rt.x-pr.x;}}sx+=Math.floor(bw);if(valid){sv=(sv+ev)/2;co=this.getColor((sv+ev)/2);}else{sv="Null";ev="Null";co=0;}ar.push({r:rt,c:co,sv:sv,ev:ev});}}else{for(var i=0;i<l;i++){var item=dp[i];if(i==0){sv=d.props.legendAsc?imin:imax;}else{sv=d.props.legendAsc?imin+(imax-imin)*item.s:imax+(imin-imax)*item.s;}if(i==l-1){ev=d.props.legendAsc?imax:imin;}else{ev=d.props.legendAsc?imin+(imax-imin)*item.e:imax+(imin-imax)*item.e;}if(sv<min){sv=min;}if(ev>max){ev=max;}if(sv>ev&&ev>=max){sv=max;ev=max;}else{if(ev<sv&&sv<=min){sv=min;ev=min;}}var bw=w*(ev-sv)/(max-min);rt={x:sx,w:Math.ceil(bw)};if(i>0){var pr=ar[ar.length-1].r;if(rt.x<pr.x+pr.w+1){pr.w=rt.x-pr.x;}}if(i==l-1){rt.w=w-sx;}sx+=Math.floor(bw);var sign=d.props.legendAsc?" < ":" > ";if(valid){co=this.getColor((sv+ev)/2);}else{sv="Null";ev="Null";co=0;}if(sign){ar.push({r:rt,c:co,sv:sv,ev:ev});}else{ar.push({r:rt,c:co,sv:sv,ev:ev,sign:">"});}}}}this.tooltipInfo=ar;}mstrmojo.VisHeatMapColorTheme={newInstance:function(){return{initialize:function prepareData(){this.blend={};this.band={};this.valid=true;this.blendEqualColor=0;this.bandEqualColor=0;this.isBlend=true;this.setDefaultDataProvider();this.checkMinMax();},getGradientFillInfo:function getGradientFillInfo(min,max){var tmin,tmax;if(isNaN(min)||isNaN(max)){if(this.isBlend){return getBlendFillInfo.call(this,min,max);}else{return getBandFillInfo.call(this,min,max);}}if(this.min==this.max){if(min<this.min){tmin=0;}else{tmin=1;}if(max<this.max){tmax=0;}else{tmax=1;}}else{if(this.isFixedColorBanding){var d=this.initMax-this.initMin;tmin=(min-this.initMin)/d;tmax=(max-this.initMin)/d;}else{var d=this.max-this.min;tmin=(min-this.min)/d;tmax=(max-this.min)/d;}}if(this.isBlend){return getBlendFillInfo.call(this,tmin,tmax);}else{return getBandFillInfo.call(this,tmin,tmax);}},checkMinMax:function checkValid(){var cmin=this.min,cmax=this.max;if(cmin>cmax){this.valid=false;}else{if(cmin==cmax){cmin=cmax=1;var dp=this.blend.dp,l=dp.length,c,index;for(var i=l-1;i>=0;i--){c=dp[i];if(i==l-1&&c.v<=cmin){this.blendEqualColor=c.c;break;}if(i==0&&c.c>=cmin){this.blendEqualColor=c.c;break;}if(i>0&&c.c>=cmin){var pc=dp[i-1];if(pc.c<cmin){index=(cmin-pc.v)/(c.v-pc.v);this.blendEqualColor=getColorInRange(index,pc.c,c.c);break;}}}dp=this.band.dp;l=dp.length;for(var i=0;i<l;i++){c=dp[i];if((i==0&&c.s>=cmin)||(i==l-1&&c.e<=cmin)||(c.s<=cmin&&c.e>=cmin)){this.bandEqualColor=c.c;break;}}}}},setDefaultDataProvider:function setDefaultData(){createDefaultBlendDataProvider.call(this,DefaultColor.Min,DefaultColor.Max);createDefaultBandDataProvider.call(this,DefaultColor.Min,DefaultColor.Max);this.useDefault=true;},getColor:function getColorForValue(v){if(this.hasNoColorMetric){return DefaultColor.NoColorMetric;}var value=NaN;if(isNaN(v)){value==0;}else{if(this.min==this.max){value=v<this.min?0:1;}else{if(this.isFixedColorBanding){value=(v-this.initMin)/(this.initMax-this.initMin);}else{value=(v-this.min)/(this.max-this.min);}}}if(this.isBlend){return getBlendColor.call(this,value);}else{return getBandColor.call(this,value);}},isBrightColor:function isBrightColor(c){var r=c>>16,g=(c&65280)>>8,b=(c&255),bright=(r*299+g*587+b*114)/1000;if(bright>150){return true;}return false;},getContrastColor:function getContrastColor(c){if(this.isBrightColor(c)){return 0;}return 16777215;},createTooltipInfo:function createTooltipInfo(t,w,d){var count=0;if(this.min>=this.max){count=1;}else{var l;if(this.isBlend){l=this.blend.dp.length;count=(l<=2)?5:l;}else{l=this.band.dp.length;count=(l<=2)?4:l;}}if(this.isBlend){createBlendTooltipInfo.call(this,count,w,d);}else{createBandTooltipInfo.call(this,count,w,d);}},getTooltipInfo:function getTooltip(v){var t=this.tooltipInfo;for(var i=0;i<t.length;i++){var item=t[i],rect=item.r;if(v>=rect.x&&v<rect.x+rect.w){return i;}}return i-1;},getMaxMinByMetricID:function(model,id){var col=model.gts.col,len=col.length,i=0,index=null;range={min:null,max:null};for(i=0;i<len&&index==null;i++){var es=col[i].es,lenes=es.length,j;for(j=0;j<lenes;j++){if(es[j].oid==id){index=j;break;}}}if(index==null){return range;}var gvs=model.gvs.items,len=gvs.length;for(i=0;i<len;i++){var value=parseFloat(gvs[i].items[index].rv);if(range.min==null){range.min=value;}if(range.max==null){range.max=value;}if(range.min>value){range.min=value;}if(range.max<value){range.max=value;}}return range;},convertFixedValueToBlendString:function(fixedBandingArray,range){var convertedBlend="";if(fixedBandingArray.length%2==0){var length=fixedBandingArray.length,min=range.min,max=range.max,i=0;var delta=max-min;convertedBlend="0,"+fixedBandingArray[1];for(i=2;i<length-2;i+=2){var value=parseInt(fixedBandingArray[i]);if(value<min||value>max){continue;}else{var colorIndex=(value-min)/delta;convertedBlend+=","+colorIndex+","+fixedBandingArray[i+1];}}convertedBlend+=",1,"+fixedBandingArray[length-1];}return convertedBlend;},convertFixedValueToBandString:function(string,range){var a=string.split(","),len=a.length,i,d=range.max-range.min;var ret="";if(len%4===0){for(i=0;i<len;i+=4){var j=0;for(j=0;j<2;j++){var v,str=a[i+j];if(str==="min"){v=range.min;}else{if(str==="max"){v=range.max;}else{v=parseFloat(a[i+j]);}}if(!isNaN(v)){a[i+j]=String((v-range.min)/d);}else{console.log("warning: invalid band string. In heatmap color theme");}}}for(i=0;i<len;i++){ret+=(a[i]+",");}ret=ret.substring(0,ret.length-1);}else{console.log("warning: Invalid band color string. In heatmap color theme");}return ret;},convertAbsoluteToBlend:function(heatMap,propValue){this.useDefault=false;this.isColorBanding=true;var abs=propValue.abs.replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");abs=(new window.DOMParser()).parseFromString(abs,"text/xml");var absM=abs.getElementsByTagName("m")[0];heatMap.absoluteColorID=absM.getAttribute("id");this.isFixedColorBanding=true;this.fixedBandingArray=absM.getAttribute("bl").split(",");var range;if(!isNaN(this.min)&&!isNaN(this.max)){range={max:this.max,min:this.min};}else{range=this.getMaxMinByMetricID(heatMap.model,heatMap.absoluteColorID);this.max=range.max;this.min=range.min;}if(isNaN(this.initMax)||isNaN(this.initMin)){range=this.getMaxMinByMetricID(heatMap.model,heatMap.absoluteColorID);this.max=range.max;this.min=range.min;this.initMax=range.max;this.initMin=range.min;}propValue.bandColors=this.convertFixedValueToBandString(absM.getAttribute("ba"),range);propValue.gradientColors=this.convertFixedValueToBlendString(this.fixedBandingArray,range);},createDataProviderFromString:function createDataProvider(bl,ba){var arr=bl.split(","),i=0,dp;this.blend.dp=[];this.useDefault=false;dp=this.blend.dp;if(arr.length%2==0){while(i<arr.length){var c={};c.v=parseFloat(arr[i]);i++;c.c=parseInt(arr[i]);i++;dp[dp.length]=c;}}i=0;arr=ba.split(",");this.band.dp=[];dp=this.band.dp;if(arr.length%4==0){while(i<arr.length){var c={};c.s=parseFloat(arr[i]);i++;c.e=parseFloat(arr[i]);i++;c.c=parseInt(arr[i]);i++;var str=arr[i];switch(str){case"leftToRight":c.d=BandDirection.LeftToRight;break;case"rightToLeft":c.d=BandDirection.RightToLeft;break;case"center":c.d=BandDirection.Center;break;default:c.d=BandDirection.None;}i++;dp[dp.length]=c;}}}};}};})();