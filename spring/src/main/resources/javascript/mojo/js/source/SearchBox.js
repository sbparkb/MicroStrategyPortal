(function(){mstrmojo.requiresCls("mstrmojo.Widget");function getSearchParams(taskId,extraParams){var params={searchMetadata:{taskId:"searchMetadata",styleName:this.searchStyleName,rootFolderID:this.rootFolderID,searchPattern:this.searchPattern,nameWildcards:1,blockBegin:this.blockBegin||1,blockCount:this.blockCount,recursive:1,folderBrowserStyle:0,includeAncestorInfo:"true",searchXML:this.searchXML||"",dataSourcesXML:this.dataSources||"",objectType:this.objectTypes},browseFolder:{taskId:"searchMetadata",rootFolderID:this.rootFolderID,blockBegin:this.blockBegin,blockCount:this.blockCount,recursive:this.hierarchical?0:(this.searchXML?"":1),folderBrowserStyle:this.hierarchical?1:0,includeAncestorInfo:String(!!this.hierarchical),searchXML:this.searchXML||"",dataSourcesXML:this.dataSources||"",objectType:this.objectTypes},browseElements:{taskId:"browseElements",attributeID:this.attributeID,blockBegin:this.blockBegin,blockCount:this.blockCount,filterXML:this.filterXML||"",searchPattern:this.searchPattern||"",matchCase:!!this.matchCase,dataSourcesXML:this.dataSourcesXML||"",includeFormNames:!!this.collectForms,includeFormValues:!!this.bIncludeFormValues,displayedForms:this.displayedForms||1,dimensionID:this.dimensionId||""}}[taskId];if(typeof extraParams==="object"){mstrmojo.hash.copy(extraParams,params);}return params;}mstrmojo.SearchBox=mstrmojo.declare(mstrmojo.Widget,null,{scriptClass:"mstrmojo.SearchBox",cssClass:"mstrmojo-charcoalbox mstrmojo-dxsprite mstrmojo-search",label:"Search for:",width:"200px",mWidth:"160px",lWidth:"30px",rWidth:"10px",taskId:"searchMetadata",searchStyleName:"MojoFolderStyle",objectTypes:"3,14,256,1024,1027,2048,3072,10",token:{searchMetadata:/\\/,browseElements:/(^-)|(,)|( OR )|( AND)|([<>]=?)|(&)|( )|(["\[\]\/])/},blockCount:50,minSearchLength:2,matchCase:false,enableMatchCase:true,markupString:'<div class="mstrmojo-SearchBox-Wrapper {@cssClass}" style="{@cssText}; width:{@width};"><div class="mstrmojo-SearchBox" mstrAttach:click ><span class="mstrmojo-SearchBox-search" id="sbSearch" style="width:{@lWidth};"></span><span class="mstrmojo-SearchBox-down" id="sbDown"></span><input class="mstrmojo-SearchBox-input" type="text" style="width:{@mWidth};" mstrAttach:keyup,blur /><span class="mstrmojo-SearchBox-right" style="width:{@rWidth};"></span><span class="mstrmojo-SearchBox-clear" id="sbClear" ></span><span class="mstrmojo-SearchBox-spinner" id="sbSpinner"></span></div><div class="mstrmojo-SearchBox-options"><input id="sbMatchCase" type="checkbox" mstrAttach:click /><label for="sbMatchCase">'+mstrmojo.desc(4326,"Case Sensitive")+"</label></div></div>",markupSlots:{inputNode:function(){return this.domNode.firstChild.firstChild.nextSibling.nextSibling;},downNode:function(){return this.domNode.firstChild.firstChild.nextSibling;},optionNode:function(){return this.domNode.lastChild.firstChild;},spinnerNode:function(){return this.domNode.firstChild.lastChild;},clearNode:function(){return this.domNode.firstChild.lastChild.previousSibling;}},onkeyup:function onkeyup(evt){var hWin=evt.hWin,e=evt.e||hWin.event;if(this.onEnter&&e.keyCode===13){this.onEnter();}this.clearNode.style.display="block";this._onsearch(this.inputNode.value);},onclick:function(evt){var hWin=evt.hWin,e=evt.e||hWin.event,tgt=e.target||e.srcElement,id=tgt&&tgt.id;switch(id){case"sbDown":if(this.enableMatchCase){var s=this.optionNode.parentNode.style;s.display=s.display=="block"?"none":"block";}break;case"sbSearch":if(this.onEnter&&e.keyCode===13){this.onEnter();}this._onsearch();break;case"sbMatchCase":this.set("matchCase",this.optionNode.checked);break;case"sbClear":this.inputNode.value="";tgt.style.display="none";this.searchPattern=".";this._onsearch();break;case"sbSpinner":break;}},onmatchCaseChange:function(){this._onsearch();},onreadystateChange:function(){},postBuildRendering:function(){if(this._super){this._super();}if(!this.enableMatchCase){this.downNode.className+=" disabled";}this.matchCase=this.optionNode.checked;},onrootFolderIDChange:function(){this.rootFolderChanged=true;var c=mstrmojo.all[this.id].searchCache,rfid=this.rootFolderID;if(c&&!c[rfid]){c[rfid]={};c[rfid][rfid]=(this.contentWidget&&this.contentWidget.items||this.rootFolderCacheItems||[]).concat();}},getRootFolderID:function(){},contentWidget:null,_notifyContentWidget:function(items){if(this.contentWidget){this.contentWidget.set("items",items);}else{this.set("items",items);}},_onsearch:function(){this.getRootFolderID();var c=mstrmojo.all[this.id].searchCache,rfid=this.rootFolderID;if(c&&!c[rfid]){c[rfid]={};c[rfid][rfid]=(this.contentWidget&&this.contentWidget.items||this.rootFolderCacheItems||[]).concat();}var input=this.inputNode.value;var token=this.token[this.taskId];if(token.test(input)){return null;}if(!this.matchCase){input=input.toLowerCase();}if(this.searchPattern==input&&!this.rootFolderChanged){return ;}this.searchPattern=input;var cache=mstrmojo.all[this.id].searchCache[rfid];if(input.length<this.minSearchLength){this._notifyContentWidget(cache[rfid]);}else{var items=this.filterCache(input,cache);if(items===null){this.rootFolderChanged=false;this.spinnerNode.style.display="block";var me=this,callback={success:function(res){var itms=res.items||[];mstrmojo.all[me.id].searchCache[me.rootFolderID][(me.searchPattern.length<me.minSearchLength?me.rootFolderID:me.buildIndex(me.searchPattern))]=itms;me._notifyContentWidget(itms);},failure:function(res){alert(mstrmojo.desc(8117,"Data request failed:")+" \n"+res.getResponseHeader("X-MSTR-TaskFailureMsg"));},complete:function(){me.spinnerNode.style.display="none";}},params=getSearchParams.apply(this,["searchMetadata",{searchPattern:this.searchPattern+"*"}]);mstrmojo.xhr.request("POST",mstrConfig.taskURL,callback,params);return ;}else{this._notifyContentWidget(items);}}},filterCache:function(){var input=this.inputNode.value,sc=mstrmojo.all[this.id].searchCache,cached=sc&&sc[this.rootFolderID],cacheItem=cached&&cached[this.buildIndex(input)];if(cacheItem){return cacheItem;}var token=this.token[this.taskId];if(token.test(input)||this.totalSize>this.blockCount){return null;}var subtxt=input.replace(/.$/,"");cacheItem=cached&&cached[this.buildIndex(subtxt)];while(cacheItem===undefined&&(subtxt=subtxt.replace(/.$/,"")).length>0){cacheItem=cached&&cached[this.buildIndex(subtxt)];}if(cacheItem!==undefined){var itms=cacheItem,r=[];for(var i in itms){if(itms[i].n.search(new RegExp(input,this.matchCase?"":"i"))>-1){r.push(itms[i]);}}this.totalSize=r.length;return(cached[this.buildIndex(input)]=r);}return null;},buildIndex:function(txt){if(txt.replace(/^\s|\s$/g,"").length===0){return"";}return !this.matchCase?txt.toLowerCase():txt+"::0";},init:function(props){this._super(props);this.xhr=new mstrmojo.SimpleXHR();mstrmojo.all[this.id].searchCache=mstrmojo.all[this.id].searchCache||{};}});})();