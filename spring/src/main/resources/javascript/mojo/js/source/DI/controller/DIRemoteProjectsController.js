(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.array","mstrmojo.warehouse.EnumDatabaseType","mstrmojo.warehouse.dbroles.DBRoleEditor","mstrmojo.qb.DataService","mstrmojo.DI.DIProjectDBRoleEditor","mstrmojo.DI.DIRemoteProjectDBRole");mstrmojo.requiresDescs(12815,13098);var $A=mstrmojo.array;mstrmojo.DI.controller.DIRemoteProjectsController=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.DI.controller.DIRemoteProjectsController",dbRoleID:"",hadoopConnURL:"",dbRole:"",saveDBRole:function saveDBRole(dbRole,editorNode){var controller=mstrApp.getRootController(),$this=this;editorNode.set("visible",false);editorNode.close();controller.getDataService().saveDBRole({success:function success(res){$this.dbRoleID=res.dbr.did;controller.model.raiseEvent({name:"projectDBRoleSaved",data:{dbrid:res.dbr.did,dbrn:res.dbr.n}});},fail:function fail(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{dbroleinfo:JSON.stringify(dbRole)});},deleteDBRole:function deleteDBRole(dbRoleId){var controller=mstrApp.getRootController(),$this=this;controller.getDataService().deleteDBRole({success:function success(res){$this.dbRoleID=undefined;$this.dbRole=undefined;controller.model.raiseEvent({name:"deleteDBRole"});},fail:function fail(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{objectid:dbRoleId});},loadRemoteProjectsDBRole:function loadRemoteProjectsDBRole(){var controller=mstrApp.getRootController(),$this=this,dbroles=[];var callback={success:function(res){var dbRoles=res.dbrs;if(dbRoles){$A.forEach(dbRoles,function(dbRole){if(dbRole.dbr_type==="5"){dbroles.push({dbrid:dbRole.did,dbrn:dbRole.n});}});}if(dbroles){controller.model.raiseEvent({name:"projectsDBRoleLoaded",data:dbroles});}},failure:function(){$this.displayError(mstrmojo.desc(12815,"Error when loading DB Roles."));}};controller.getDataService().loadDBRoles(callback,{});},loadDBRoleByID:function loadDBRoleByID(dbRoleId,isDuplicate){var $this=this,DB_Role=new mstrmojo.DI.DIRemoteProjectDBRole(),controller=mstrApp.getRootController();DB_Role.mdDBRole.did=dbRoleId;DB_Role.populate(function(db_role){var connStr=db_role.mdDBRole.connstr;$A.forEach(connStr.split(";"),function(x){var arr=x.split("=");db_role[arr[0].trim()]=arr[1];});$this.dbRoleID=dbRoleId;$this.dbRole=DB_Role;if(isDuplicate){controller.model.raiseEvent({name:"DuplicateDBRole"});}else{controller.model.raiseEvent({name:"DBRoleLoadedById"});}});},populateDBRole:function populateDBRole(dbRoleID,callback){var controller=mstrApp.getRootController();controller.model.populateDBRole(dbRoleID,callback);},renderDBRoleEditor:function renderDBRoleEditor(dbRole){var projectEditor=mstrmojo.all.projectDBRoleEditor;if(projectEditor){projectEditor.set("dbrole",dbRole);projectEditor.open();}else{mstrmojo.insert(new mstrmojo.DI.DIProjectDBRoleEditor({zIndex:9999}));projectEditor=mstrmojo.all.projectDBRoleEditor;projectEditor.set("dbrole",dbRole);projectEditor.render();}},editDBRole:function editDBRole(dbrid){this.loadDBRoleByID(dbrid);},getProjectSourceFolderId:function getProjectSourceFolderId(dbrid){var controller=mstrApp.getRootController();var params={dbrid:dbrid};var callback={success:function(res){mstrApp.getRootController().model.raiseEvent({name:"getFolderId",data:res});},failure:function(){mstrApp.getRootController().model.raiseEvent({name:"getFolderIdFailure"});mstrmojo.alert(mstrmojo.desc(13098,"Invalid Username, Password. Please check your login credentials to browse the Project"));}};controller.dataService.fetchRemoteFolderID(callback,params);},getProjectsFromRemote:function getProjectsFromRemote(serverName,serverPort){var controller=mstrApp.getRootController();var params={serverName:serverName,serverPort:serverPort};var callback={success:function(res){mstrApp.getRootController().model.raiseEvent({name:"projectsLoaded",data:res});},failure:function(){}};controller.dataService.getProjectsFromRemote(callback,params);},duplicateDBRole:function duplicateDBRole(dbrid){this.loadDBRoleByID(dbrid,true);},duplicate:function duplicate(){var dbr=this.dbRole,newDBRole=new mstrmojo.DI.DIRemoteProjectDBRole({mdDBRole:dbr.mdDBRole}),newName="Duplicate "+dbr.n;newDBRole.hostname=dbr.hostname;newDBRole.Port=dbr.Port;newDBRole.ProjectID=dbr.ProjectID;newDBRole.did="";newDBRole.mdDBRole.did="";newDBRole.mdDBRole.n=newName;newDBRole.n=newName;newDBRole.des=newName;newDBRole.mdDBRole.ln=dbr.mdDBRole.ln;newDBRole.mdDBRole.connstr="";delete newDBRole.mdDBRole.password;this.renderDBRoleEditor(newDBRole);}});}());