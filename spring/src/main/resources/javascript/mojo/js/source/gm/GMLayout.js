(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.VisUtility","mstrmojo.gm.GMEnums","mstrmojo.gm.GMUtility");var $HASH=mstrmojo.hash,$UTILS=mstrmojo.VisUtility,$DC=mstrmojo.gm.GMUtility.sizeCalculator,FIT_TO=mstrmojo.gm.EnumFitTo,AXIS_TYPE=mstrmojo.gm.EnumAxisType,CHART_TYPE=mstrmojo.gm.EnumGraphType,X_LABEL_STAT=mstrmojo.gm.EnumXAxisLabelStatus,MAX_ITERATION=6,TEXT_PADDING=2,TEXT_PADDING_TEXT_DIRECTION=9,TEXT_PADDING_NON_TEXT_DIRECTION=6,BORDER_PADDING=5;mstrmojo.gm.GMLayoutResult=null;mstrmojo.gm.GMLayoutConfig=null;function hasDifference(orgArr,newArr){var i,orgItem,newItem,n=orgArr.length;for(i=0;i<n;i++){orgItem=orgArr[i];newItem=newArr[i];if(orgItem!==undefined&&orgItem!==newItem){return true;}}return false;}function calculateAverage(arr){var i,item,n=arr.length,cnt=0,sum=0;for(i=0;i<n;i++){item=arr[i];if(item){sum+=item;cnt+=1;}}return(cnt===0)?40:Math.floor(sum/cnt+0.5);}function calculateSum(arr,avg){var i,item,n=arr.length,sum=0;for(i=0;i<n;i++){item=arr[i];if(item){sum+=item;}else{sum+=avg;}}return sum;}function batchEvalTextWidth(labels,heightRestrict,styles,textPadding){var i,width,maxHeight,n=labels.length,rtn=[];heightRestrict=heightRestrict||[];textPadding=textPadding||0;for(i=0;i<n;i++){maxHeight=heightRestrict[i];if(maxHeight){maxHeight-=2*textPadding;}width=$UTILS.measureTextWidth(labels[i],styles,2*textPadding,maxHeight);rtn.push(width);}return rtn;}mstrmojo.gm.GMLayout=mstrmojo.provide("mstrmojo.gm.GMLayout",{fitTo:FIT_TO.CONTENT,xAxisType:AXIS_TYPE.ATTRIBUTE,yAxisType:AXIS_TYPE.METRIC,chartType:CHART_TYPE.BAR,sBarWidth:0,API:{owner:undefined,getXAxisHeight:undefined,getYAxisWidth:undefined,getX2AxisHeight:undefined,getY2AxisWidth:undefined,getRowHeight:undefined,getColWidth:undefined,calculateAllXAxisStyle:undefined,calculateOneXAxisStyle:undefined},nRows:1,nCols:1,widthCache:[],heightCache:[],nLabels:0,maxXAxisWidth:undefined,maxXAxisWidthStagger:undefined,minXLabelWidth:undefined,widthRatio:undefined,heightRatio:undefined,xInfo:undefined,yInfo:undefined,calculateLayout:function(rhWidth,width,height,xAxisHeight,xAxis2Height,yAxisWidth,yAxis2Width,scales,context){var yInfo=this.yInfo,xInfo=this.xInfo,widthCache=this.widthCache,heightCache=this.heightCache,widthCacheBackup=$HASH.clone(widthCache),heightCacheBackup=$HASH.clone(heightCache),chartWidthFixed=scales.ctw!==1,chartHeightFixed=scales.cth!==1,metricOnX=this.xAxisType===AXIS_TYPE.METRIC,metricOnY=this.yAxisType===AXIS_TYPE.METRIC,metricOnXY=metricOnX&&metricOnY,config={xAxisHeight:xAxisHeight,xAxis2Height:xAxis2Height,yAxisWidth:yAxisWidth,yAxis2Width:yAxis2Width};if(this.fitTo===FIT_TO.CONTENT){config.xScalable=xInfo.items.length===0||metricOnX;config.yScalable=yInfo.items.length===0||metricOnY;}else{config.xScalable=true;config.yScalable=true;config.minChartWidth=metricOnXY?60:20;config.minChartHeight=metricOnXY?60:20;}if(!chartWidthFixed){widthCache.length=0;widthCache.length=this.nCols;}if(!chartHeightFixed){heightCache.length=0;heightCache.length=this.nRows;}var result=this.hLayout(rhWidth,width,height,config,scales,context);result.widthCacheChanged=hasDifference(widthCacheBackup,widthCache);result.heightCacheChanged=hasDifference(heightCacheBackup,heightCache);return result;},hLayout:function(rhWidth,width,height,config,scales,context){var i=0,yLabelText=this.yInfo.isMetric?"":this.yInfo.items.join(" "),minX2Height=0,API=this.API,styles=context.styles,apiOwner=this.API.owner,CHART_MIN_SIZE_RATIO=0.2,maxYWidth=Math.max((((width+rhWidth)*(1-CHART_MIN_SIZE_RATIO))-rhWidth),20),xScalable=config.xScalable,yScalable=config.yScalable,xHeightGiven=config.xAxisHeight,x2HeightGiven=config.xAxis2Height,yWidthGiven=config.yAxisWidth,y2WidthGiven=config.yAxis2Width,fixedXHeight=xHeightGiven!==undefined,fixedX2Height=x2HeightGiven!==undefined,fixedYWidth=yWidthGiven!==undefined,fixedY2Width=y2WidthGiven!==undefined,chartWidthScale=scales.ctw,chartHeightScale=scales.cth,yWidth=yWidthGiven||20,y2Width=y2WidthGiven||0,yOverflowed=false,yWidthNew,y2WidthNew,yOverflowedNew,xHeight,x2Height,xOverflowed,availWidth,availHeight,xRotate,result={};while(true){if(i>=MAX_ITERATION){break;}if(yLabelText!==""&&context.syat){minX2Height=this.batchEvalTextHeight([yLabelText],[yWidth],styles,TEXT_PADDING);}availWidth=width;availWidth-=$DC.add(0,yWidth,context.va);availWidth-=$DC.add(0,y2Width,context.va);if(xScalable){this.hFakeWidthCache(availWidth+context.v,config.minChartWidth);if(this.fitTo!==FIT_TO.COMPACT){this.hProcessWidthCache();}}xRotate=this.hCheckXLabelStatus(availWidth,scales.ctw);API.owner.xLabelPlacement=xRotate;apiOwner.layoutPaddingEchos={X1:[],X2:[],Y1:[],Y2:[]};xHeight=fixedXHeight?xHeightGiven:(API.getXAxisHeight.call(apiOwner,xRotate)*scales.x);x2Height=fixedX2Height?x2HeightGiven:Math.min(context.rhMaxH,Math.max(minX2Height,(API.getXAxis2Height.call(apiOwner)*scales.x2)));xOverflowed=this.hCheckPageOverflowX(availWidth+context.v,chartWidthScale);availHeight=height;availHeight-=$DC.add(0,xHeight,context.ha);availHeight-=$DC.add(0,x2Height,context.dx?context.ha:context.h);if(yScalable){this.hFakeHeightCache(availHeight+context.h,config.minChartHeight);if(this.fitTo!==FIT_TO.COMPACT){this.hProcessHeightCache();}}yWidthNew=fixedYWidth?yWidthGiven:Math.min(maxYWidth,(API.getYAxisWidth.call(apiOwner)*scales.y));y2WidthNew=fixedY2Width?y2WidthGiven:(API.getYAxis2Width.call(apiOwner)*scales.y2);yOverflowedNew=this.hCheckPageOverflowY(availHeight+context.h,chartHeightScale);if(yWidthNew===yWidth&&y2WidthNew===y2Width&&yOverflowedNew===yOverflowed){break;}yWidth=yWidthNew;y2Width=y2WidthNew;yOverflowed=yOverflowedNew;i++;}result.nRows=this.nRows;result.nCols=this.nCols;result.yAxisWidth=yWidth;result.yAxis2Width=y2Width;result.xAxisHeight=xHeight;result.xAxis2Height=x2Height;result.needHSBar=xOverflowed;result.needVSBar=yOverflowed;result.rotateLabelInXAxis=xRotate;result.avgChartWidth=this.hGetChartAvgWidth(chartWidthScale);result.avgChartHeight=this.hGetChartAvgHeight(chartHeightScale);result.canvasWidth=this.hEstimateCanvasWidth(chartWidthScale,result.avgChartWidth);result.canvasHeight=this.hEstimateCanvasHeight(chartHeightScale,result.avgChartHeight);if(!xOverflowed){result.pageWidth=this.hGetPageWidth(chartWidthScale);}if(!yOverflowed){result.pageHeight=this.hGetPageHeight(chartHeightScale);}return result;},hCheckXLabelStatus:function(availWidth,widthScale){var fitTo=this.fitTo,labelStatus=X_LABEL_STAT.NORMAL;if(fitTo===FIT_TO.CONTENT){labelStatus=this.hCheckXLabelStatus4FitContent(availWidth/this.nCols,widthScale);}else{labelStatus=this.hCheckXLabelStatus4FitPanel((availWidth-2*BORDER_PADDING)/this.nLabels);}return labelStatus;},hCheckXLabelStatus4FitPanel:function(availWidthPerLabel){var useLegacy=false;if(useLegacy){var truncatedLabelWidth=this.minXLabelWidth;if(truncatedLabelWidth>2*availWidthPerLabel){return X_LABEL_STAT.ROTATE;}if(truncatedLabelWidth>availWidthPerLabel){return X_LABEL_STAT.STAGGER;}return X_LABEL_STAT.NORMAL;}else{var apiOwner=this.API.owner,calculateAllXAxisLabelStyle=this.API.calculateAllXAxisStyle;return calculateAllXAxisLabelStyle.call(apiOwner);}},hCheckXLabelStatus4FitContent:function(availWidthPerChart,widthScale){var i,n,widthCache=this.widthCache,fixedChartWidth=(widthScale!==1);if(fixedChartWidth){availWidthPerChart=65535;n=widthCache.length;for(i=0;i<n;i++){if(widthCache[i]){availWidthPerChart=Math.min(availWidthPerChart,widthCache[i]*widthScale);}}}if(availWidthPerChart>=this.maxXAxisWidth){return X_LABEL_STAT.NORMAL;}if(availWidthPerChart>=this.maxXAxisWidthStagger){return X_LABEL_STAT.STAGGER;}return X_LABEL_STAT.ROTATE;},hProcessWidthCache:function(){var i,n=this.nCols,widthCache=this.widthCache,minWidths=this.minWidths;if(minWidths){for(i=0;i<n;i++){if(minWidths[i]){widthCache[i]=Math.max(widthCache[i],minWidths[i]);}}}},hProcessHeightCache:function(){var i,n=this.nRows,heightCache=this.heightCache,minHeights=this.minHeights;if(minHeights){for(i=0;i<n;i++){if(minHeights[i]){heightCache[i]=Math.max(heightCache[i],minHeights[i]);}}}},hFakeWidthCache:function(totalWidth,minWidth){var widthRatio=this.widthRatio;if(!widthRatio){this.hFakeSizeCacheEvenly(totalWidth,minWidth,this.nCols,this.widthCache);return ;}var sum=calculateSum(widthRatio,1);this.hFakeSizeCacheEvenly(totalWidth,minWidth,this.nCols,this.widthCache,this.widthRatio,sum);},hFakeSizeCacheEvenly:function(totalSize,minSize,n,sizeCache,ratioCache,totalRatio){var i,start=0,avgSize=totalSize/n;sizeCache.length=0;for(i=0;i<n;i++){if(ratioCache){avgSize=totalSize*(ratioCache[i]/totalRatio);sizeCache[i]=Math.round(start+avgSize+5e-14)-Math.round(start);}else{sizeCache[i]=Math.round(start+avgSize+5e-14)-Math.round(start);}start+=avgSize;}if(minSize){for(i=0;i<n;i++){sizeCache[i]=Math.max(sizeCache[i],minSize);}}},hFakeHeightCache:function(totalHeight,minHeight){var heightRatio=this.heightRatio;if(!heightRatio){this.hFakeSizeCacheEvenly(totalHeight,minHeight,this.nRows,this.heightCache);return ;}var sum=calculateSum(heightRatio,1);this.hFakeSizeCacheEvenly(totalHeight,minHeight,this.nRows,this.heightCache,this.heightRatio,sum);},hGetChartAvgWidth:function(scale){return Math.floor(calculateAverage(this.widthCache)*(scale||1));},hGetChartAvgHeight:function(scale){return Math.floor(calculateAverage(this.heightCache)*(scale||1));},hEstimateCanvasWidth:function(scale,avgWidth){return Math.floor(calculateSum(this.widthCache,avgWidth)*(scale||1));},hEstimateCanvasHeight:function(scale,avgHeight){return Math.floor(calculateSum(this.heightCache,avgHeight)*(scale||1));},hGetPageWidth:function(scale){var i,n=this.nCols,func=this.API.getColWidth,widthSum=0;scale=scale||1;for(i=0;i<n;i++){widthSum+=Math.floor(func(0,i)*scale);}return widthSum;},hGetPageHeight:function(scale){var i,n=this.nRows,func=this.API.getRowHeight,heightSum=0;scale=scale||1;for(i=0;i<n;i++){heightSum+=Math.floor(func(i,0)*scale);}return heightSum;},hCheckPageOverflowX:function(width,scale){var i,n=this.nCols,func=this.API.getColWidth,widthSum=0;scale=scale||1;width=Math.ceil(width);for(i=0;i<n;i++){widthSum+=Math.floor(func(0,i)*scale);if(widthSum>width){return true;}}return false;},hCheckPageOverflowY:function(height,scale){var i,n=this.nRows,func=this.API.getRowHeight,heightSum=0;scale=scale||1;height=Math.ceil(height);for(i=0;i<n;i++){heightSum+=Math.floor(func(i,0)*scale);if(heightSum>height){return true;}}return false;},evalTextHeight:function(label,maxWidth,styles,textPadding){if(textPadding===undefined){textPadding=TEXT_PADDING;}var rtn=this.batchEvalTextHeight([label],[maxWidth],styles,textPadding);return rtn[0];},batchEvalTextHeight:function(labels,widthRestrict,styles,textPadding,maxLineCount){var i,height,maxWidth,n=labels.length,rtn=[];maxLineCount=maxLineCount===undefined?1:maxLineCount;widthRestrict=widthRestrict||[];textPadding=textPadding||0;for(i=0;i<n;i++){maxWidth=widthRestrict[i];if(maxWidth){maxWidth-=2*textPadding;}var singleLineHeight=$UTILS.measureTextHeight(labels[i],styles,0,100,undefined,true,true);height=$UTILS.measureTextHeight(labels[i],styles,2*textPadding,maxWidth);height=Math.min(height,singleLineHeight*maxLineCount+2*textPadding);rtn.push(height);}return rtn;},getRowHeadersWidth:function(rhLabels,styles){var i,labels,labelsWidth,n=rhLabels.length,rtn=[];for(i=0;i<n;i++){labels=rhLabels[i];labelsWidth=batchEvalTextWidth(labels,[],styles,TEXT_PADDING_TEXT_DIRECTION);rtn.push(Math.max.apply(null,labelsWidth));}return rtn;},getColHeadersHeight:function(chLabels,styles){var i,labels,labelsHeight,n=chLabels.length,rtn=[];for(i=0;i<n;i++){labels=chLabels[i];labelsHeight=this.batchEvalTextHeight(labels,[],styles,TEXT_PADDING_NON_TEXT_DIRECTION);rtn.push(Math.max.apply(null,labelsHeight));}return rtn;},getRowHeaderP1Width:function(nRH,nCH,chInfo,heightRestrict,styles,showCHTitle,GMController){var labelsWidth,metricNamesOnYAxis=GMController.isMetricNamesOnYAxis,metricNamesOnRows=GMController.isMetricNamesOnRows,hasHeaderInY=GMController.hasHeaderInY,haveY2=GMController.haveY2,isPie=GMController.getChartInfo().isPie,dz=GMController.dz,hasMoreThanOneMetricsInAngleBy=dz.AngleBy.TemplateMetric&&dz.AngleBy.TemplateMetric.length>1,hasOnlyOneMetricInXAxis=dz.XAxis.TemplateMetric&&dz.XAxis.TemplateMetric.length===1;if(nRH===0&&nCH>0&&GMController.haveY1===false&&showCHTitle&&(!metricNamesOnYAxis||(isPie&&hasMoreThanOneMetricsInAngleBy&&hasOnlyOneMetricInXAxis))&&!(metricNamesOnRows&&(hasHeaderInY&&!haveY2))){labelsWidth=batchEvalTextWidth(chInfo.items,heightRestrict,styles,TEXT_PADDING);return Math.max.apply(null,labelsWidth);}return 0;},getColHeaderP1Height:function(rhInfo,widthRestrict,yAxisInfo,HTML5PROPS,hasExtraColInfo,maxLineCount){var rtHeights=[],yaatHeights=[],yamnHeights=[];if(hasExtraColInfo.hasAndShowRT){rtHeights=this.batchEvalTextHeight(rhInfo.items,widthRestrict,HTML5PROPS.RH_TITLE,TEXT_PADDING_NON_TEXT_DIRECTION,maxLineCount);}if(hasExtraColInfo.hasAndShowYAAT){yaatHeights=this.batchEvalTextHeight(yAxisInfo.items,[],HTML5PROPS.AXIS_TITLE_Y,TEXT_PADDING_NON_TEXT_DIRECTION);}if(hasExtraColInfo.hasAndShowFA){yamnHeights=this.batchEvalTextHeight(yAxisInfo.items,[],HTML5PROPS.CH,TEXT_PADDING_NON_TEXT_DIRECTION);}var totalHeights=rtHeights.concat(yaatHeights).concat(yamnHeights);return Math.max.apply(null,totalHeights);}});}());