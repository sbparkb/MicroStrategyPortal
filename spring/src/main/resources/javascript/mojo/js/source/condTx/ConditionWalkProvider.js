(function(){mstrmojo.requiresCls("mstrmojo.expr","mstrmojo.array","mstrmojo.hash","mstrmojo.registry","mstrmojo.css","mstrmojo.AjaxCall","mstrmojo._CanValidate","mstrmojo.ValidationTextBox","mstrmojo.condTx.CommonComponent","mstrmojo.rw.ConditionWalkProvider");mstrmojo.requiresDescs(308,547,2200,5225,8191,11900,12300,13206);var CWP=mstrmojo.rw.ConditionWalkProvider,getChildJSON=CWP.getChildJSON,updateList=CWP.updateList,setTip=CWP.setTip,fmJson=CWP.fmJson,cstJson=CWP.cstJson,$EXPR=mstrmojo.expr,$EXPRTYPE=$EXPR.ET,FN=$EXPR.FN,ET2TGT=$EXPR.ET2TGT,TP=$EXPR.TP,DTP=$EXPR.DTP,D2FD=$EXPR.DTP2FN_DTP,$A=mstrmojo.array,$H=mstrmojo.hash,$C=mstrmojo.css,$REG=mstrmojo.registry,$VALIDATE=mstrmojo.validation,$VALIDATE_TRIGGER=$VALIDATE.TRIGGER,$CC=mstrmojo.condTx.CommonComponent,_NT=$CC.NODE_TYPE,_AT=$CC.ACTION_TYPE,_SC=$CC.SOURCE_CONTEXT,_FNS=$CC.CTXN_FNS,_ALIS=$CC.ALIS;var ET2FNS={};ET2FNS[$EXPRTYPE.MQ]={key:"metricFns",def:$EXPR.METRIC_FNS};ET2FNS[$EXPRTYPE.MC]={key:"metricFns",def:$EXPR.METRIC_FNS};ET2FNS[$EXPRTYPE.AQ]={key:"formFns",def:$EXPR.FORM_FNS};ET2FNS[$EXPRTYPE.AL]={key:"formFns",def:$EXPR.FORM_FNS};ET2FNS[$EXPRTYPE.AC]={key:"formFns",def:$EXPR.FORM_FNS};ET2FNS[$EXPRTYPE.AE]={key:"elemFns",def:$EXPR.ELEM_FNS};var DUMMY_TP="dummy",SELECT_ITEM={did:"idSelect",v:"idSelect",n:mstrmojo.desc(547,"Select"),t:DUMMY_TP,css:"unselectable"},QUALIFICATION_ITEM={did:"idWait",v:"idQualification",n:mstrmojo.desc(5225,"Qualification"),t:DUMMY_TP,css:"unselectable"};var TIP_STAGE_1=mstrmojo.desc(11900,"Define a condition."),TIP_STAGE_2=mstrmojo.desc(13206,"Enter a value or choose an element from the list. When done, press ## button.").replace("##",'"âˆš"');var FORM_SELECTION_NOT_AE=0,FORM_SELECTION_AE=1;function fnItem(fn,fnt){var d=fnt+$EXPR.FN_SEP+fn;return(fn!=null)?{did:d,n:d}:undefined;}function isComparisonAllowed(model,ets){var etAllowed;if(ets){switch(ET2TGT[model.et]){case"a":etAllowed=ets[$EXPRTYPE.AC];break;case"m":etAllowed=ets[$EXPRTYPE.MC];break;default:etAllowed=false;break;}}else{etAllowed=true;}return etAllowed&&$EXPR.fn_AC_MC(model&&model.fn);}function shouldShowCst(w,idx){var m=w.model||{},fn=m.fn;return(fn!=null)&&((m.et===$EXPRTYPE.MQ)||(m.et===$EXPRTYPE.MC)||(m.et===$EXPRTYPE.AQ)||(m.et===$EXPRTYPE.AL)||(m.et===$EXPRTYPE.AC))&&($EXPR.fnCstCount(fn,m.fnt)>idx);}var isDATE={};isDATE[DTP.DATE]=1;isDATE[DTP.TIME]=1;isDATE[DTP.TIMESTAMP]=1;function getAvailableSourceElements(source,target,isEditable,isMxsContained,sourceContext){var nodeKey=target.nodeKey,fgs=source.fieldGroups||{},tps=source.templates||{},getAvailableFieldGroupItems=function(fgKey){var _items=[],calEditableFlag=function(fg){return !isEditable||(isEditable&&fg.rptId);},getItems=function(fg){var fields=fg.fields||[],its=[];$A.forEach(fields,function(field){if((!isEditable||(isEditable&&field.edt))&&field.dtp){field.nk=field.nk||fg.nk;its.push(field);}});return its;},isFGAvailable=function(fg){switch(sourceContext){case _SC.IN:return(fg.nk===fgKey&&calEditableFlag(fg));case _SC.EXCEPT:return(fg.nk!==fgKey&&calEditableFlag(fg));default:return calEditableFlag(fg);}};$H.forEach(fgs,function(fg){if(isFGAvailable(fg)){_items=_items.concat(getItems(fg));}});return _items;},getAvailableTemplateMxItems=function(){var _items=[],isTpAvailable=function(tp){return !isEditable||(isEditable&&tp.rptId);},getItems=function(tp){var its=[];$A.forEach(tp.mxs||[],function(mx){if(!isEditable||(isEditable&&mx.edt)){mx.nk=mx.nk||tp.nk;its.push(mx);}});return its;};$H.forEach(tps,function(tp){if(isTpAvailable(tp)){_items=_items.concat(getItems(tp));}});return _items;};var items=getAvailableFieldGroupItems(nodeKey);if(isMxsContained){items=items.concat(getAvailableTemplateMxItems());}return items;}function updateOkBtn(me){var model=me.model;model&&me.okBtn.set("visible",!!model.completed);}function onCstChg(){var d=this.parent,w=d.parent.parent,v=(this.isValid&&this.isValid())||(!this.isValid&&!mstrmojo.string.isEmpty(this.value)),m=w.model;if(!w){return ;}if(!this.updating&&v){this.updating=true;if(m){m.edit(d.alias,{v:this.value,dtp:this.dtp,isCst:true});}this.updating=false;}updateOkBtn(w);}function updateCstList(p){var model=p.model,targetId=model&&model[ET2TGT[model.et]]&&model[ET2TGT[model.et]]["did"],targetForm=model&&model.fm,fnc=$EXPR.fn_AC_MC(model&&model.fn),isDirty=false;if(this._lastTargetId!==targetId){this._lastTargetId=targetId;isDirty=true;}if(this.lastTargetForm!==targetForm){this.lastTargetForm=targetForm;isDirty=true;}if(this.lastFnTp!==fnc){this.lastFnTp=fnc;isDirty=true;}if(isDirty){var items=this.items.slice(0,this.preLen);if(!fnc){this.clearSelect();this.set("items",items);}else{var isMX=(model&&(model.et===$EXPRTYPE.MQ||model.et===$EXPRTYPE.MC)),nodeKey=p.target&&p.target.nodeKey,template=nodeKey&&p.source&&p.source.templates&&p.source.templates[nodeKey];srcItems=template?(isMX?template.mxs:template.atts):[];if(!isMX){srcItems=$A.filter(srcItems,function(item){var fms=item.fms;return !(item.did===targetId&&fms.length===1&&fms[0].did===targetForm.did);});}this.set("items",items.concat(srcItems));}}}function updateCst(me,idx){me.updating=true;var conditionWalk=me.parent.parent.parent,m=conditionWalk.model||{},show=(m.et!==$EXPRTYPE.XML)?shouldShowCst(conditionWalk,idx):((m.tx||m.exp)&&m.fn);if(show){var cs=m.cs,c=cs&&cs[idx],v=c&&c.v,dtp;updateCstList.call(me,conditionWalk);switch(m.et){case $EXPRTYPE.MQ:case $EXPRTYPE.MC:dtp=$EXPR.METRIC_DTP;break;case $EXPRTYPE.AQ:case $EXPRTYPE.AC:case $EXPRTYPE.AE:dtp=m.fm&&m.fm.dtp;break;case $EXPRTYPE.AL:dtp=m.fm&&m.fm.dtp;v=[];for(var i=0,len=cs&&cs.length;i<len;i++){v.push(cs[i].v);}v=v.join(mstrConfig.listSep);break;}dtp=dtp||DTP.CHAR;var isLF=$EXPR.fn_List(m.fn,m.fnt),isD=isDATE[dtp],isC=isD&&!isLF;var cx=me.ctxtBuilder,iws=cx&&cx.itemWidgets,si=isD?(isC?me.calIndex:me.dtxtIndex):me.txtIndex,ib=iws&&iws[me.bwIndex],iw;for(var i=0,len=me.preLen-1;i<len;i++){iw=iws[i];if(i==si){iw.set("dtp",dtp);iw.set("isList",isLF);iw.set("value",v);iw.set("visible",true);try{if(me.alias!=="c1"){iw.focus&&iw.focus();}}catch(x){}if(iw.clearValidation){iw.clearValidation();}}else{iw.set("visible",false);}if(isLF){iw.set("tooltip",mstrmojo.desc(8191,"value1## value2## ...## valueN").replace(/##/g,mstrConfig.listSep));}else{iw.set("tooltip","");}}if(ib){ib.set("visible",conditionWalk.objectBrowsingEnabled&&isComparisonAllowed(m,conditionWalk.ets));}switch(m.et){case $EXPRTYPE.AQ:case $EXPRTYPE.AL:case $EXPRTYPE.MQ:if(c&&c.p){me.set("selectedItem",c.p);}else{me.set("selectedIndex",si);}break;case $EXPRTYPE.MC:case $EXPRTYPE.AC:me.set("selectedItem",m[ET2TGT[m.et]+(2+idx)]);break;}}me.updating=false;}function getSourceProps(alias,showLabel,showCst){return function(){var me=this;return{alias:alias,children:[{scriptClass:"mstrmojo.Label",cssClass:"filter",visible:!!showLabel,text:mstrmojo.desc(2200,"Filter on")},cstJson({alias:alias,cstIndex:0,insertUnlistedValuesAt:0,allowUnlistedValues:true,makeObservable:true,hideIfEmpty:true,expended:false,itemFunction:widgetItemFn,update:function(bForce){var me=this,conditionWalk=this.parent.parent.parent,model=conditionWalk.model,at=conditionWalk.actionType,target=conditionWalk.target,source=conditionWalk.source,sel,tgs,items=[];if(this.lastModel!==model||bForce){this.lastModel=model;var nt=target.nodeType,tgs=this.items.slice(0,this.preLen);if(_NT.TEMPLATE_UNIT_CONTROL===nt&&_AT.DISABLE===at){var getTemplateUnitItems=function(nodeKey){var tps=source.templates||{},tp=tps[nodeKey],items=[];if(tp){items=items.concat(tp.atts||[]);items=items.concat(tp.mxs||[]);}$A.forEach(items,function(item){item.p=item.p||nodeKey;});return items;},isEditable=!!(alias===_ALIS.FILTERON),expendedItems=getAvailableSourceElements(source,target,isEditable,false,_SC.ALL),et=model&&model.et;if(alias===_ALIS.FILTERON){items=items.concat(getTemplateUnitItems(target.nodeKey));}if(!this.expended&&alias===_ALIS.FILTERON&&expendedItems.length>0){this.parent.SEM.set("visible",true);}if(alias!==_ALIS.FILTERON||this.expended){items=items.concat(expendedItems);}sel=model&&model[alias===_ALIS.FILTERON?((et&&et>1)?ET2TGT[et]:"tx"):"tx2"];}else{var showSM=(nt===_NT.TEXT_FIELD)&&!this.expended,sc=(nt===_NT.TEXT_FIELD)?_SC.IN:_SC.ALL,isEditable=!!(alias===_ALIS.FILTERON),expendedItems;items=items.concat(getAvailableSourceElements(source,target,isEditable,false,sc));if(nt===_NT.TEXT_FIELD){expendedItems=getAvailableSourceElements(source,target,isEditable,false,_SC.EXCEPT);if(this.expended){items=items.concat(expendedItems);}}sel=model&&model[alias===_ALIS.FILTERON?"tx":"tx2"];if(showSM&&expendedItems&&expendedItems.length>0){this.parent.SEM.set("visible",true);}}if(sel&&!sel.did){sel.did=sel.nk+sel.fk;}tgs=tgs.concat(items);updateList(this,true,tgs,sel);}if(showCst){var dtp=(model.tx&&model.tx.dtp)||$EXPR.DTP.CHAR,isLF=$EXPR.fn_List(model.fn,model.fnt),isD=isDATE[dtp],isC=isD&&!isLF,cx=me.ctxtBuilder,iws=cx&&cx.itemWidgets,si=isD?(isC?me.calIndex:me.dtxtIndex):me.txtIndex,cs=model.cs,c=cs&&cs[0],v=c&&c.v,iw;for(var i=0,len=me.preLen-1;i<len;++i){iw=iws[i];if(i==si){iw.set("dtp",dtp);iw.set("isList",isLF);iw.set("value",v);iw.set("visible",true);iw.focus&&iw.focus();if(iw.clearValidation){iw.clearValidation();}}else{iw.set("visible",false);}}}var isADVSelected=model&&model[alias===_ALIS.FILTERON?"exp":"exp2"];this.parent.ADV.set("selected",isADVSelected);if(isADVSelected){this.clearSelect();}this.parent.updateScrollbars();}}),{scriptClass:"mstrmojo.Label",alias:"SEM",cssClass:"mstrmojo-walkstep-label active",text:mstrmojo.desc(12300,"See More..."),visible:false,onclick:function onclick(){this.set("visible",false);var target=this.parent[alias];target.set("expended",true);target.update(true);}},{scriptClass:"mstrmojo.Label",alias:"ADV",cssClass:"mstrmojo-walkstep-label active",text:mstrmojo.desc(12301,"Advanced Expression"),onselectedChange:function onselectedChange(){$C.toggleClass(this.domNode,"selected",this.selected);},onclick:function onclick(){var conditionWalk=this.parent.parent.parent,model=conditionWalk.model,target=conditionWalk.target,source=conditionWalk.source,isFilterOn=alias===_ALIS.FILTERON,isEditable=!!isFilterOn,m={items:getAvailableSourceElements(source,target,isEditable,true,_SC.ALL),expr:model[isFilterOn?"exp":"exp2"],prop:alias};conditionWalk.editor.openAdvEditor(m,conditionWalk);}}],updateColumnContainer:function updateColumnContainer(){if(!this.parent){return ;}this[alias].update();var columnWalk=this.parent,conditionWalk=columnWalk.parent,model=conditionWalk.model,isV=(model.et!==$EXPRTYPE.XML),idx=this.idx,next=this.next;if(alias===_ALIS.FILTERON&&isV&&model.a&&!(next&&next.fm)){this.parent.insertAndRemoveTrailing(idx,me.getFmNodeProps());}else{if((alias===_ALIS.FILTERON&&(model.tx||model.exp||(isV&&model.m)))&&!(next&&next.fn)){this.parent.insertAndRemoveTrailing(idx,me.getFnNodeProps());}}next=this.next;if(next){setTip.call(conditionWalk,TIP_STAGE_1);next.updateColumnContainer();}}};};}function widgetItemFn(item,idx,widget){var config=item.cfg;if(config){config.data=item;config.parent=widget;return $REG.ref(config);}config=new mstrmojo.Label({text:item.n||"&nbsp;",cssClass:"dial-item "+(item.t?("t"+item.t):""),title:item.tn||""});config.markupMethods.onselectedChange=function(){$C.toggleClass(this.domNode,["selected"],this.selected);};config.data=item;config.parent=widget;return config;}mstrmojo.condTx.ConditionWalkProvider=mstrmojo.declare(mstrmojo.rw.ConditionWalkProvider,null,{scriptClass:"mstrmojo.condTx.ConditionWalkProvider",getFilterOnProps:getSourceProps(_ALIS.FILTERON,true),getFnNodeProps:function getFnNodeProps(){var me=this;return{alias:"fn",children:[fmJson({alias:"fn",allowUnlistedValues:false,update:function(){var conditionWalk=this.parent.parent.parent,m=conditionWalk.model||{},sel=fnItem(m.fn,m.fnt||1),fns;if(m.et===$EXPRTYPE.XML){this.lastEt=m.et;updateList(this,true,_FNS,sel);}else{var et=m.et,show=false,dtp;switch(et){case $EXPRTYPE.AE:show=!!m.a;break;case $EXPRTYPE.AQ:case $EXPRTYPE.AC:case $EXPRTYPE.AL:show=!!(m.fm&&m.fm.did);dtp=show?m.fm.dtp:null;break;case $EXPRTYPE.MQ:case $EXPRTYPE.MC:show=!!m.m;dtp=show?$EXPR.METRIC_DTP:null;break;}if(show){var fndtp=D2FD[dtp]||0;if((this.lastEt!==et)||(this.lastFnDtp!==fndtp)){this.lastEt=et;this.lastFnDtp=fndtp;var lookin=et?ET2FNS[et]:null,k=lookin&&lookin.key;fns=(k&&conditionWalk[k])||lookin.def||[];if(typeof (fns)==="object"){fns=fns[fndtp]||fns["*"];}}}var filtedFNS=fns&&$A.filter(fns,function(fn){return fn.tp!=2&&fn.tp!=3;});updateList(this,show,filtedFNS,sel);this.parent.updateScrollbars();}}})],updateColumnContainer:function updateColumnContainer(){if(!this.parent){return ;}this.fn.update();var columnWalk=this.parent,conditionWalk=columnWalk.parent,model=conditionWalk.model,fn=model&&model.fn,isV=(model.et!==$EXPRTYPE.XML),next=this.next;if(fn&&(fn===FN.IS_NULL||fn===FN.IS_NOT_NULL)){columnWalk.removeTrailingContainer(this.idx);}else{if(fn&&(fn===FN.BETWEEN||fn===FN.NOT_BETWEEN||isV)&&!(next&&next.c0)){columnWalk.insertAndRemoveTrailing(this.idx,me.getC0NodeProps());}else{if(fn&&!isV&&!(fn===FN.BETWEEN||fn===FN.NOT_BETWEEN)&&!(next&&next.s1)){var s1NodeProps=getSourceProps(_ALIS.SOURCE1,false,true);columnWalk.insertAndRemoveTrailing(this.idx,s1NodeProps.call(me));}}}next=this.next;if(next){setTip.call(conditionWalk,TIP_STAGE_2);next.updateColumnContainer();}}};},getFmNodeProps:function getFmNodeProps(){var me=this;return{alias:"fm",children:[fmJson({alias:"fm",fmPost:"",filter:false,update:function(){var columnWalk=this.parent.parent,conditionWalk=columnWalk.parent,m=conditionWalk.model,at=columnWalk.fo.fo.selectedItem,show=!!at,fm,fms;if(show){switch(m.et){case $EXPRTYPE.AQ:case $EXPRTYPE.AL:case $EXPRTYPE.AC:fm=m.fm;break;case $EXPRTYPE.AE:fm=fnItem(m.fn,1);break;}if(this.lastAttrId!==at.did){this.lastAttrId=at.did;fms=[];if(me.et!==$EXPRTYPE.AC){fms.push(SELECT_ITEM);var lookin=ET2FNS[$EXPRTYPE.AE],key=lookin&&lookin.key;fms=fms.concat((key&&conditionWalk[key])||lookin.def||[]);}fms.push(QUALIFICATION_ITEM);fms=fms.concat(at.fms||[]);}}updateList(this,show,$H.clone(fms),fm);}})],updateColumnContainer:function updateColumnContainer(){if(!this.parent){return ;}this.fm.update();var columnWalk=this.parent,conditionWalk=columnWalk.parent,model=conditionWalk.model,fm=model&&model.fm,fn=model&&model.fn,idx=this.idx,next=this.next,a=model&&model.a,disableElementsBrowsing=conditionWalk.disableElementsBrowsing,disEB=a&&disableElementsBrowsing&&disableElementsBrowsing(a);var oldType=(model.etWas&&model.etWas===$EXPRTYPE.AE)?FORM_SELECTION_AE:FORM_SELECTION_NOT_AE,newType=FORM_SELECTION_NOT_AE;if(model.et===$EXPRTYPE.AE&&!disEB){newType=FORM_SELECTION_AE;}if(oldType!==newType||newType===FORM_SELECTION_NOT_AE){columnWalk.removeTrailingContainer(idx);if(newType===FORM_SELECTION_NOT_AE&&fm){setTip.call(conditionWalk,TIP_STAGE_1);columnWalk.addNextColumn(me.getFnNodeProps());}else{if(newType===FORM_SELECTION_AE){setTip.call(conditionWalk,TIP_STAGE_2);columnWalk.addNextColumn(me.getEsNodeProps());}}}next=this.next;if(next){next.updateColumnContainer();}}};},getC0NodeProps:function getC0NodeProps(){var me=this;return{alias:"c0",children:[cstJson({alias:"c0",cstIndex:0,itemFunction:widgetItemFn,update:function(){updateCst(this,this.cstIndex);}}),{scriptClass:"mstrmojo.Label",alias:"btwn",cssClass:"btwn",text:mstrmojo.desc(308,"and"),visible:false},cstJson({alias:"c1",cstIndex:1,itemFunction:widgetItemFn,update:function(){updateCst(this,this.cstIndex);},visible:false})],updateColumnContainer:function updateColumnContainer(){if(!this.parent){return ;}this.c0.update();var columnWalk=this.parent,model=columnWalk.parent.model,fn=model&&model.fn,showBtwn=fn===FN.BETWEEN||fn===FN.NOT_BETWEEN,showFm2=fn===FN.EQUAL||fn===FN.NOT_EQUAL||fn===FN.GREATER||fn===FN.GREATER_EQUAL||fn===FN.LESS||fn===FN.LESS_EQUAL,idx=this.idx,next=this.next;this.btwn.set("visible",showBtwn);this.c1.set("visible",showBtwn);if(showBtwn){this.c1.update();}if(model.a2&&showFm2){if(!(next&&next.fm2)){columnWalk.insertAndRemoveTrailing(idx,me.getFm2NodeProps());}}else{columnWalk.removeTrailingContainer(idx);}next=this.next;if(next){next.updateColumnContainer();}}};},getFm2NodeProps:function getFm2NodeProps(){return{alias:"fm2",children:[fmJson({alias:"fm2",fmPost:2,update:function(){var conditionWalk=this.parent.parent.parent,m=conditionWalk.model,at=m&&m.a,at2=m&&m.a2,fm=m&&m.fm,fm2=m&&m.fm2,show=!!at,fms;if(show){fms=[];fms.push(QUALIFICATION_ITEM);if(at2&&at2.fms){fms=fms.concat(at2.fms);}if(at.did===at2.did){fms=$A.filter(fms,function(item){return !(fm.did===item.did);});}}updateList(this,show,fms,fm2);}})],updateColumnContainer:function updateColumnContainer(){if(!this.parent){return ;}this.fm2.update();var next=this.next;if(next){next.updateColumnContainer();}}};}});var _CWP=mstrmojo.condTx.ConditionWalkProvider;_CWP.updateOkBtn=updateOkBtn;}());