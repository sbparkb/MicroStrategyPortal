(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.boxmodel","mstrmojo.Model","mstrmojo._CanProxyCallback","mstrmojo.EnumRWUnitType","mstrmojo.models.template.DataInterface","mstrmojo.StringBuffer","mstrmojo.EnumReadystate");var $RW_TYPES=mstrmojo.EnumRWUnitType,$RS=mstrmojo.EnumReadystate,$HASH=mstrmojo.hash,$HFE=$HASH.forEach,$WRAP=mstrmojo.func.wrapMethods,$FREE=mstrmojo.Obj.free,$ARR=mstrmojo.array,$BOX=mstrmojo.boxmodel,$MIXIN=mstrmojo.mixin,ITEM_SEPARATOR="\u001E";var COLOR_BY={},COLOR_BY_PALETTE={},DEFAULT_PALETTE=[11826975,1381846,1810715,950271,12407690,2276796,13614615,8355711,15255470,9869567,9101208,7912447,14004421,9296859,15063710,13092807];mstrmojo.MultiRWUnitFormatEventsType=null;var observables={isObservable:function(defn){var t=defn&&defn.t;if((!t&&t!==$RW_TYPES.LAYOUT)||!this.hasOwnProperty(t)||defn.scriptClass){return false;}return(t!==$RW_TYPES.SUBSECTION||!defn.dt);},makeObservable:function(defn){var audibles=defn.audibles=this[defn.t]||{};if(audibles.hasOwnProperty("readyState")){defn.readyState=$RS.IDLE;}return new mstrmojo.Model(defn);}};observables[$RW_TYPES.PANELSTACK]={"*":false,selKey:true,readyState:true};observables[$RW_TYPES.GRID]={"*":false,readyState:true,ds:true};observables[$RW_TYPES.GRAPH]={"*":false,readyState:true,ds:true};observables[$RW_TYPES.GRIDGRAPH]={"*":false,qsm:true,ds:true};observables[$RW_TYPES.SUBSECTION]={"*":false,resize:true,adjustSize:true};observables[$RW_TYPES.VISUALIZATION]={"*":false,ds:true};observables[$RW_TYPES.SELECTOR]={"*":false,cek:true,ds:true,readyState:true};observables[$RW_TYPES.MOJOVISUALIZATION]={"*":false,ds:true};observables[$RW_TYPES.LAYOUT]={"*":false,readyState:true};var UNIT_DEFINITION_HANDLERS={};function getUnitDefinitionHandler(unitType){return UNIT_DEFINITION_HANDLERS[unitType]||UNIT_DEFINITION_HANDLERS["*"];}UNIT_DEFINITION_HANDLERS["*"]={update:function update(model,defn,newDefn,filteredProps){$HASH.copy(newDefn,defn);}};UNIT_DEFINITION_HANDLERS[$RW_TYPES.PANEL]=$MIXIN({update:function update(model,defn,newDefn,filteredProps){delete defn.layoutXML;this._super(model,defn,newDefn);}},UNIT_DEFINITION_HANDLERS["*"]);function getLayout(node,lytKey){var lyt=node.layoutMap&&node.layoutMap[lytKey];if(lyt){if(!lyt.t){lyt.t=$RW_TYPES.LAYOUT;}if(observables.isObservable(lyt)){lyt=node.layoutMap[lytKey]=this.addDisposable(observables.makeObservable(lyt));}return lyt;}var lyts=node.layouts,cnt=(lyts&&lyts.length)||0,i;for(i=0;i<cnt;i++){if(lyts[i].k===lytKey){var itLyt=lyts[i];if(!itLyt.t){itLyt.t=$RW_TYPES.LAYOUT;}if(observables.isObservable(itLyt)){lyts[i]=this.addDisposable(observables.makeObservable(itLyt));}return lyts[i];}}return null;}function lookupDefn(defn,lytKey,key,notObservable){var lyt=getLayout.call(this,defn,lytKey);if(key===lytKey){lyt._lkz=lytKey;return lyt;}if(lyt){var unit=lyt.units[key];if(unit){if(parseInt(unit.t,10)===$RW_TYPES.GRIDGRAPH){if(!lyt.units[key+"_0"]){lyt.units[key+"_0"]={ck:unit.ck,fmts:unit.fmts.gd,txi:unit.txi,t:$RW_TYPES.GRID};lyt.units[key+"_1"]={ck:unit.ck,fmts:unit.fmts.gp,t:$RW_TYPES.GRAPH};}}if(!notObservable&&observables.isObservable(unit)){unit=lyt.units[key]=observables.makeObservable(unit);this.disposables.push(unit);}unit._lkz=lytKey;}}return lyt&&lyt.units[key];}function filterSectionsByTypes(node,isPartial,types,include){var children=this.getChildren(node,isPartial,0);return(mstrApp.isMobile?($ARR.filter(children,function(sec){var idx=types&&types.indexOf(sec.defn.t),dk=sec.defn.dk;return include?(idx>-1&&dk===-1):(idx<0||dk!==-1);})):(include?[]:children));}var fnBuildId=function(data,lk){var id=new mstrmojo.StringBuffer();if(lk){id.append("*l"+lk);}id.append("*k"+data.k);if(data.hasOwnProperty("wid")){id.append("*x"+data.wid);}id.append("*t"+this.buildTime);return id.toString();};function getTxUpdates(t){var i,w,d=this.delta,pu=this.pendingUpdate=this.pendingUpdate||{},updates=[];if(!$HASH.isEmpty(d)){updates.push("<updates>");for(i in d){if(d.hasOwnProperty(i)){w=d[i];updates.push(w.getUpdates());}}pu[t]=d;this.delta={};updates.push("</updates>");}return updates.join("");}function fnGetTargetDefn(keys,delimiter){var definitions;if(keys){var keyArray=$ARR.isArray(keys)?keys:keys.split(delimiter||ITEM_SEPARATOR),cnt=keyArray.length,i;for(i=0;i<cnt;i++){definitions=definitions||{};definitions[keyArray[i]]=lookupDefn.call(this,this.defn,this.currlaykey,keyArray[i]);}}return definitions;}function fnGetWidget(k,wid){return mstrmojo.all[fnBuildId.call(this,{k:k,wid:wid},this.currlaykey)];}function isInfoWindowPS(key,layoutKey){var defn=this.getLayoutUnitDefn(key,layoutKey);return(defn&&defn.t===$RW_TYPES.PANELSTACK&&defn.ifw);}function isCurrentSlice(node,sid){return !sid||(node.wid===sid);}function selectPanelByEventDeferred(update,evt){var me=this,callback=me.getSliceCallback(evt),shared=callback.shared,panelStackKey=evt.tks,panelKey=evt.eid,dataService=me.getDataService();if(!panelStackKey){return ;}var pnlDef=lookupDefn.call(me,me.defn,me.currlaykey,panelKey);if(!pnlDef){return ;}var dirtyKeys=panelKey,panelStackDefn=shared.tgtDefs[panelStackKey],fnActivatePanel=function(){panelStackDefn.set("selKey",panelKey);},fnPanelState;panelStackDefn.newSelKey=panelKey;if(pnlDef.l){var dk=pnlDef.dirtyKeys;if(!!dk){dirtyKeys=$HASH.keyarray(dk).join(",");shared.orignalTargetDefs=shared.tgtDefs=fnGetTargetDefn.call(me,dirtyKeys,",");fnPanelState=function(){fnActivatePanel();$HFE(shared.dataCacheUpdate.upd,function(v,updatedId){var updatedWidget=mstrmojo.all[updatedId];if(updatedWidget&&updatedWidget.setDirty){updatedWidget.setDirty(false);}});};}else{if(evt.skipServerCall){fnActivatePanel();return ;}dataService.requestPanelChangeDeferred(update,panelKey,null,false,false,me.newCallback({method:"slice",success:fnActivatePanel}));return ;}}else{fnPanelState=function(){fnActivatePanel();pnlDef.l=true;};}var fnSuccess=callback.success;callback.success=function(res){if(!me.checkStatus(res)){return ;}me.updateDefnCache(res.defn,[panelKey]);fnSuccess(res);fnPanelState();var panelStack=fnGetWidget.call(me,evt.tks,0);if(panelStack){panelStack.clearDirtyChild(panelKey);}};dataService.requestPanelChangeDeferred(update,panelKey,dirtyKeys,true,!evt.hasLoader,callback);}function insertDataCache(node,cache){if(node.defn.t>=$RW_TYPES.GRID){mstrmojo.models.template.DataInterface.inflateGridData(node.data);}cache[node.id]=node;return node;}function getChildrenPrivate(node,gatherChildrenFn,isPartial,includeTotal){var layoutKey=this.currlaykey,defn;if(node){defn=node.defn;layoutKey=(defn&&defn._lkz)||node.k;}var dc=this.getLayoutDataCache(layoutKey),useCache=(!isPartial&&!$HASH.isEmpty(dc)),lookin;if(!node){lookin=this.data;}else{var src=node.data||node;if(useCache){lookin=dc[fnBuildId.call(this,src,layoutKey)];lookin=(lookin&&lookin.data)||lookin||src;}else{lookin=src;}}if(!!lookin.sections){this._buildingLayoutKey=lookin.k;}var arr=lookin?this.extractChildren(lookin):[],ch=[];var len=(arr&&arr.length)||0;if(len){defn=this.defn;var traversingLayouts=!node,ck=node?layoutKey:null,type=(node&&((node.defn)?node.defn.t:lookupDefn.call(this,defn,ck,node.k).t));var isGridGraph=(type===$RW_TYPES.GRIDGRAPH),isDetails=(type===$RW_TYPES.DETAILS),i,stop;arr=gatherChildrenFn(arr);for(i=0,stop=arr.length;i<stop;i++){var item=arr[i];if(isGridGraph){item.k=node.k;item.wid=node.data.wid;}var key=item.k,id=fnBuildId.call(this,item,ck),df;if(!traversingLayouts&&!isPartial&&isInfoWindowPS.call(this,key,ck)){var unitDef=this.getLayoutUnitDefn(key),unit=insertDataCache({data:item,defn:unitDef,id:id,k:key,p:lookin},dc);if(!this.infoWinByKey||!this.infoWinByKey[key]){var infoWindows=this.infoWindows=this.infoWindows||{};var infoWinByKey=this.infoWinByKey=this.infoWinByKey||{};infoWindows[unitDef.n]=infoWinByKey[key]=unit;}continue;}if(isGridGraph){id+="_"+i;df=lookupDefn.call(this,defn,ck,item.k+"_"+i);}else{df=lookupDefn.call(this,defn,ck||item.k,item.k);}if(isDetails){df.dt=true;}if(dc===null&&(df.t===$RW_TYPES.LAYOUT)){dc=this.getLayoutDataCache(item.k);}var nodeObj={k:item.k,id:id,defn:df,data:useCache?(dc[id]&&dc[id].data)||item:item};if(!dc[id]){insertDataCache(nodeObj,dc);}ch.push(nodeObj);}}return includeTotal?{nodes:ch,total:len}:ch;}function addSizeAndOrDimensionProps(formatProps,position,propsToAdd){var fnPxToInches=$BOX.px2Inches,zoomProps=this.getZoomProps(),ADD_POSITION=1,ADD_SIZE=2;if((propsToAdd&ADD_POSITION)>0){formatProps.FormattingPosition={Left:fnPxToInches(zoomProps,position.x||0),Top:fnPxToInches(zoomProps,position.y||0)};}if((propsToAdd&ADD_SIZE)>0){formatProps.FormattingSize={Height:fnPxToInches(zoomProps,position.h||0),Width:fnPxToInches(zoomProps,position.w||0)};}}function sortColorByElements(elements){function strCmp(s1,s2){return s1<s2?-1:(s1>s2?1:0);}elements.sort(function(a,b){var levelCmp=strCmp(a.levelID,b.levelID);return levelCmp!==0?levelCmp:strCmp(a.elemID,b.elemID);});return elements;}function getElementColorProperty(elements,prop){return elements.map(function(e){return e[prop];}).join(ITEM_SEPARATOR);}function getColorByLevelsKey(elements){return getElementColorProperty(elements,"levelID");}function getColorByElementsKey(elements){return getElementColorProperty(elements,"elemID");}function initColorByMap(resetAutoColor){if(resetAutoColor){COLOR_BY_PALETTE={};}COLOR_BY={};var colorMap=this.defn.epm;if(colorMap){colorMap.forEach(function(levelMap){levelMap.epmv.forEach(function(elementMap){var elements=sortColorByElements(elementMap.k.chn.map(function(chn){var isatt=chn.emt!==2;return{levelID:isatt?chn.at.did:"-1",elemID:isatt?chn.ei:chn.mt.did};})),levelsKey=getColorByLevelsKey(elements),elementsKey=getColorByElementsKey(elements);if(!COLOR_BY[levelsKey]){COLOR_BY[levelsKey]={};}COLOR_BY[levelsKey][elementsKey]=JSON.parse(elementMap.v.vv);});});}}function parseRawPUFilters(puFilters){if(puFilters){puFilters=mstrmojo.rw.model.RetrievalKeysConfig.parseResponseFilters(puFilters);}return puFilters;}function hasAllSelectedInGB(){var lyts=this.data&&this.data.layouts,lyt=lyts[$ARR.find(lyts,"k",this.getCurrentLayoutKey())],gbs=lyt&&lyt.gbys&&lyt.gbys.groupbys,isAllSelected=false;$ARR.forEach(gbs,function(gb){if(gb.unit&&gb.unit.elms&&gb.unit.elms[gb.unit.idx].v==="u;"){isAllSelected=true;return false;}});return isAllSelected;}mstrmojo.nativeandroid.DocModel=mstrmojo.declare(mstrmojo.Model,[mstrmojo._CanProxyCallback],{scriptClass:"mstrmojo.nativeandroid.DocModel",audibles:{"*":false,data:true,tsp:true},features:null,dataCache:null,searchElemsCache:null,controller:null,sdp:null,dpi:96,keySeed:0,currlaykey:"",init:function init(props){this._super(props);if(!this.features){this.features=new mstrmojo.Model();this.disposables.push(this.features);}this.ondefnChange();initColorByMap.call(this);this.buildTime=mstrmojo.now();},hasFeatures:function hasFeatures(featList){var fs=this.features;if(!fs){return false;}var arr=featList.split(","),len=arr.length,i;for(i=0;i<len;i++){var s=arr[i],neg=s.match(/^!/);if(neg){s=s.replace("!","");}if(!!neg===!!fs[s]){return false;}}return true;},makeObservable:function makeObservable(defn){return observables.makeObservable(defn);},checkStatus:function checkStatus(res){if(parseInt(res.status,10)===4){res.message=mstrmojo.desc(5781,"Request timed out.");mstrmojo.err(res);return false;}return true;},getDataService:function getDataService(){var dataService=this.dataService;if(!dataService){var params={rwb:this.bs,msgId:this.mid,stid:this.stid,cbKey:this.cbKey,model:this};if(mstrApp.modelFactory){dataService=mstrApp.modelFactory.newDataService("Document",params);}else{dataService=mstrApp.viewFactory.newDocDataService(params);}this.dataService=dataService;this.disposables.push(dataService);}return dataService;},getNextKey:function getNextKey(){return"W"+this.keySeed++;},getWidgetId:function getWidgetId(dataNode,layoutKey){return fnBuildId.call(this,dataNode,layoutKey||this.getCurrentLayoutKey());},getUIState:function getUIState(){return{};},ondefnChange:function ondefnChg(){var defn=this.defn,lyts=defn&&defn.layouts,lytMap={};if(defn){defn.layoutMap=lytMap;var cnt=(lyts&&lyts.length)||0,i;for(i=0;i<cnt;i++){var lyt=lyts[i];lytMap[lyt.k]=lyt;}}},extractChildren:function extractChildren(node){return(node.sections||node.subsections||node.objects||node.panels||node.layouts||node.children);},getChildren:function getCh(node,isPartial,start,count,includeTotal){start=start||0;var selectChildrenFn=function(children){return children.slice(start,start+(count||children.length));};return getChildrenPrivate.call(this,node,selectChildrenFn,isPartial,includeTotal);},getChildrenByKey:function getChByKey(node,isPartial,keys,includeTotal){var selectChildrenByKeyFn=function(children){var kids=[],pos;$ARR.forEach(keys,function(v){pos=$ARR.find(children,"k",v);if(pos!==-1){kids.push(children[pos]);}});return kids;};return getChildrenPrivate.call(this,node,selectChildrenByKeyFn,isPartial,includeTotal);},getTargetDefn:function getTargetDefn(keys){return fnGetTargetDefn.call(this,keys);},getUnitDefinitions:function(keys,delimeter){return fnGetTargetDefn.call(this,keys,delimeter);},getUnitInstance:function getUnitInstance(key,widgetID){return mstrmojo.all[fnBuildId.call(this,{k:key,wid:widgetID},this.currlaykey)];},getFirstUnitInstanceByName:function getFirstUnitInstanceByName(name){var lyt=getLayout.call(this,this.defn,this.currlaykey);if(lyt){var units=lyt.units,u;for(u in units){var unit=units[u];if(unit.n===name){return this.getUnitInstance(u,1);}}}return null;},getLayoutUnitDefn:function getLayoutUnitDefn(key,layoutKey){return lookupDefn.call(this,this.defn,layoutKey||this.currlaykey,key);},getRawLayoutUnitDefn:function getRawLayoutUnitDefn(key,searchDefinition,layoutKey){return lookupDefn.call(this,searchDefinition||this.defn,layoutKey||this.currlaykey,key,true);},getSelectedKey:function getSelectedKey(node){return(!node&&this.currlaykey)||null;},getCurrentLayoutKey:function getCurrentLayoutKey(){return this.currlaykey;},getLayoutDefn:function getLayoutDefn(layoutKey){var defn=this.defn,layouts=defn&&defn.layouts;return layouts&&layouts[$ARR.find(layouts,"k",layoutKey)];},getCurrentLayoutDef:function getCurrentLayoutDef(){return this.getLayoutDefn(this.getCurrentLayoutKey());},replaceLayout:function replaceLayout(key,node,isAdd){var defn=this.defn,data=this.data,nodeDefn=node&&node.defn,nodeData=node&&node.data,dc=this.dataCache;if(dc&&dc[key]){dc[key]={};}var lyts=(data&&data.layouts)||(defn&&defn.layouts),i,newLayout=false;for(i=(lyts&&lyts.length-1)||0;i>=0;i--){if(lyts[i].k===key){break;}}if(isAdd&&i<0){i=$ARR.find(nodeData.layouts||nodeDefn.layouts,"k",key);newLayout=true;}this.bs=node.bs;if(nodeData){if(newLayout){$ARR.insert(data.layouts,i,[nodeData.layouts[i]]);}else{data.layouts[i]=nodeData.layouts[i];}data.elems=nodeData.elems;}if(nodeDefn){if(newLayout){$ARR.insert(defn.layouts,i,[nodeDefn.layouts[i]]);}else{defn.layouts[i]=nodeDefn.layouts[i];}this.ondefnChange();}},loadLayout:function loadLayout(layoutJSON,unloadCache,restoreIW){this.replaceLayout(layoutJSON.currlaykey,layoutJSON);this.raiseEvent({name:"rebuildLayout",unloadCache:!!unloadCache,restoreIW:!!restoreIW});},getLayoutDataNode:function getLayoutDataNode(key){var lyts=this.data&&this.data.layouts;return $ARR.filterOne(lyts,function(lyt){return lyt.k===key;});},getLayoutDataCache:function getLayoutDataCache(key){if(!key){return null;}var dc=this.dataCache;if(!dc){dc=this.dataCache={};}if(!dc[key]){dc[key]={};}return dc[key];},saveRW:function saveRW(documentName,callback){var $DESC=mstrmojo.desc,dataService=this.getDataService();dataService.saveRW({objName:documentName||this.n,folderID:this.pfid,saveAsFlags:1},callback||{success:function(res){mstrmojo.alert($DESC(3819,"Document Saved")+": "+res.n);}});},saveAsRW:function saveAsRW(param,target){var m=this,newParams=mstrmojo.hash.copy(param,{evt:3102,applyChanges:false,executionMode:2,parentFolderID:mstrApp.saveFolderId||m.sfid||m.pfid,saveFromDesignMode:false,rwb:m.bs});if(target){newParams.target=target;newParams.saveAsOrigin=13;}mstrmojo.form.send(newParams,null,"post");},saveDocProps:function saveDocProps(formatObject,urInfo,requestData,callback){var dataService=this.getDataService(),suppressData=requestData?null:mstrmojo.DocDataService.SUPPRESS_DATA,action=[{act:"setDocumentProperties",props:formatObject}];$HASH.forEach(formatObject.RWDocumentProperties,function(value,key,hash){hash[key]=String(value);});if(urInfo){this.controller.cmdMgr.execute({execute:function(){this.submit(action,callback||{},suppressData);},urInfo:urInfo});}else{dataService.submitUpdates(action,callback||{},$HASH.copy(suppressData,{preserveUndo:true}));}},partialUpdate:function partialUpdate(data,targetDefinitions,defn,refreshKeys,puFilters){if(defn){this.updateDefnCache(defn,refreshKeys,puFilters);}if(data){var updatedDataCache=this.updateDataCache(data,targetDefinitions,undefined,puFilters);this.raiseEvent({name:"partialUpdate",tree:data,ids:updatedDataCache});return updatedDataCache;}},refreshDefinition:function refreshDefinition(unitKey,definitionNode,layoutKey,filteredProps){var modelNode=this.getLayoutUnitDefn(unitKey,layoutKey||this.getCurrentLayoutKey());if(!modelNode){return ;}getUnitDefinitionHandler(modelNode.t).update(this,modelNode,definitionNode,filteredProps);},loadPartialData:function loadPartialData(data,nodeKey){var tgtDef={};tgtDef[nodeKey]=lookupDefn.call(this,this.defn,this.currlaykey,nodeKey);var ids=this.updateDataCache(data,tgtDef),dc=this.getLayoutDataCache(this.getCurrentLayoutKey()),me=this;$ARR.forEach(data.layouts,function(l){var styles=l&&l.xtabStyles;if(styles){me.raiseEvent({name:"updateStyles",key:l.k,updatedStyles:styles});}});$HFE(ids,function(col,methodName){if(methodName==="upd"){$HFE(col,function(v,id){var w=mstrmojo.all[id];if(w&&w.update){w.update(dc[id]);}});}});},updateDefnCache:function updateDefnCache(newDefn,refreshKeys,puFilters){var currLayoutKey=this.currlaykey,lyt=getLayout.call(this,newDefn,currLayoutKey),oldLyt=getLayout.call(this,this.defn,currLayoutKey),fnAppendNewProps=function(oldObj,newObj){var u;for(u in newObj){if(oldObj[u]===undefined){oldObj[u]=newObj[u];}}},newUnits=lyt&&lyt.units,oldUnits=oldLyt&&oldLyt.units,newCGBMap=lyt&&lyt.cgbMap,oldCGBMap=oldLyt&&oldLyt.cgbMap,defnPuFilters=puFilters&&parseRawPUFilters(puFilters).defn,me=this;$ARR.forEach(refreshKeys,function(key){me.refreshDefinition(key,newUnits[key],null,defnPuFilters&&defnPuFilters[key]);});if(newUnits){fnAppendNewProps(oldUnits,newUnits);}if(newCGBMap){fnAppendNewProps(oldCGBMap,newCGBMap);this.raiseEvent({name:"CGBMapChange",cgbMap:oldCGBMap});}},updateDataCache:function updateDataCache(tree,tks,sid,puFilters){var dataCache=this.getLayoutDataCache(this.getCurrentLayoutKey()),dataFilters=puFilters&&parseRawPUFilters(puFilters).data,result={ifws:{},upd:{},tgts:{},def:{},secs:{}},fnUpdateCachedNode=function(id,newCache){var oldCache=dataCache[id];if(dataFilters){var widget=mstrmojo.all[id];if(widget){var key=oldCache.k,filter=dataFilters[key];if(filter){if(!$HASH.isEmpty(filter.exclude)){$HASH.copy(newCache.data,oldCache.data);}else{newCache.data=$HASH.copyProps(filter.serialized.split(";"),newCache.data,oldCache.data);}}}}insertDataCache(newCache,dataCache);};function findTgtDescendants(node,mnode,wasInst,activeKey){var isInst=false,chnodes=this.getChildren(node,true),w;if(!chnodes.length){return ;}if(wasInst){w=mstrmojo.all[node.id];isInst=!node.id||!!w;}var nodeDefn=node.defn,nodeData=node.data,selectedPanelKey;if(nodeDefn&&nodeDefn.t===$RW_TYPES.PANELSTACK&&nodeDefn.od){selectedPanelKey=nodeData.selKey;}var cnt,childKey,fnFilterChildren=function(modelNode){return(modelNode.k===childKey);};for(cnt in chnodes){var ch=chnodes[cnt],id=ch.id,localActiveKey=null,mch;childKey=ch.k;if(mnode){var childrenNodes=this.extractChildren(mnode);if(childrenNodes){mch=$ARR.filterOne(childrenNodes,fnFilterChildren);if(!mch){childrenNodes.push($HASH.clone(ch.data));}}else{$HASH.copy($HASH.clone(node.data),mnode);}}if(mstrmojo.all[id]){isInst=true;}if(tks.hasOwnProperty(childKey)){if(isInfoWindowPS.call(this,childKey)&&isCurrentSlice(ch.data,sid)){fnUpdateCachedNode(id,ch);if(!activeKey){result.ifws[childKey]=this.infoWinByKey[childKey].id;}}localActiveKey=childKey;if(isInst){if(selectedPanelKey&&selectedPanelKey!==childKey){continue;}if(!activeKey){result.tgts[id]=true;}var secDef=w&&w.defn,ty=secDef&&secDef.t,ck=secDef&&secDef.ck;if(ty===$RW_TYPES.SUBSECTION&&(ck&&ck.hasOwnProperty(childKey))){result.secs[w.id]=true;}}}if((activeKey||localActiveKey)&&(!selectedPanelKey||selectedPanelKey===childKey)){fnUpdateCachedNode(id,ch);result.def[childKey]=true;if(isInst){result.upd[id]=true;}}findTgtDescendants.call(this,ch,mch,isInst,activeKey||localActiveKey);}}if(tree&&tree.layouts&&tks){var treeLayout=$ARR.filterOne(tree.layouts,function(l){return(l.loaded);}),layouts=this.data.layouts;if(treeLayout){findTgtDescendants.call(this,treeLayout,layouts[$ARR.find(layouts,"k",treeLayout.k)],true);}}return result;},getDimensionAndPositionAction:function getDimensionAndPositionAction(unit,position,skipPartialRetrieval){var action=this.getUnitFormatAction(unit,null,null,skipPartialRetrieval);addSizeAndOrDimensionProps.call(this,action.format,position,3);return action;},getDimensionAction:function getDimensionAndPositionAction(unit,position,skipPartialRetrieval){var action=this.getUnitFormatAction(unit,null,null,skipPartialRetrieval);addSizeAndOrDimensionProps.call(this,action.format,position,2);return action;},getUnitFormatAction:function getUnitFormatAction(unit,formatType,format,skipPartialRetrieval){var defn=unit.defn,t=defn.t||1,unitKey=unit.k,partialRetrievalNodes=[unitKey];var action={act:"format",unitKey:unitKey,unitType:t===115?521:t,formatType:formatType||1,format:format||{}};if(!skipPartialRetrieval){action.partialRetrieval={nodes:partialRetrievalNodes};}if(t===$RW_TYPES.SELECTOR){var controlKey=defn.ck;action.keyContext=controlKey;partialRetrievalNodes[0]=this.getDataService().getNodeKeyFromKeyContext(controlKey);}if(t===$RW_TYPES.TEXTFIELD||t===$RW_TYPES.IMAGE||t===$RW_TYPES.HTMLCONTAINER){var nodeKey=unit.nk||defn.fgk;action.fieldKey=unitKey;action.nodeKey=nodeKey;action.keyContext=t+ITEM_SEPARATOR+nodeKey+ITEM_SEPARATOR+unitKey;partialRetrievalNodes[0]=nodeKey;}return action;},updateUnitFormat:function updateUnitFormat(unit,formatType,format,callback,extras){var action=this.getUnitFormatAction(unit,formatType,format);this.getDataService().submitUpdates(action,callback,extras);},selectPanelDeferred:function(update,panelStackKey,panelKey,sliceId,hasLoader,skipServerCall){selectPanelByEventDeferred.call(this,update,{type:3,tks:panelStackKey,eid:panelKey,sid:sliceId||1,ck:panelStackKey,hasLoader:hasLoader,skipServerCall:skipServerCall});},getSearchElemsCache:function getSEC(){var c=this.searchElemsCache;if(!c){c=this.searchElemsCache={};}return c;},getCGBMap:function getCGBMap(){var lyt=getLayout.call(this,this.defn,this.currlaykey);return lyt&&lyt.cgbMap;},getSliceCallback:function getSliceCallback(evt){var me=this,shared={};shared.dataCacheUpdate=null;shared.tgtDefs=evt.tks?fnGetTargetDefn.call(this,evt.tks):null;shared.orignalTargetDefs=shared.tgtDefs;var rsTgtDefs=shared.tgtDefs,fnSetReadyState=function(v){var tds=rsTgtDefs;if(evt.disablePU){tds=fnGetTargetDefn.call(me,me.currlaykey);}$HFE(tds,function(targetDef){if(targetDef&&targetDef.set){targetDef.set("readyState",v);}});},defaultCallback=this.newCallback({method:"slice",shared:shared,submission:function(){fnSetReadyState($RS.WAITING);},success:function(res){if(!me.checkStatus(res)){return ;}if(evt.disablePU){me.loadLayout(res,evt.isUConDS,evt.restoreIW);return ;}if(res.pukeys){shared.tgtDefs=fnGetTargetDefn.call(me,res.pukeys);}shared.dataCacheUpdate=me.updateDataCache(res.data,shared.tgtDefs,evt&&evt.sid,res.puFilters);if(typeof res==="object"){$HASH.copyProps(["bs","exopt","dty"],res,me);}var ue={name:"partialUpdate",tree:res.data,ids:shared.dataCacheUpdate,unloadCache:evt.isUConDS};if(!mstrmojo.hash.isEmpty(ue.ids.ifws)){if(evt&&!evt.suppressIW&&(evt.type===$RW_TYPES.GRID||evt.type===$RW_TYPES.GRAPH)){ue.anchor=evt.anchor;}else{ue.ids.ifws={};}}me.raiseEvent(ue);},complete:function(){fnSetReadyState($RS.IDLE);}}),callbackExtras={success:function(){$HFE(shared.orignalTargetDefs,function(def,targetKey){var targetWidget=fnGetWidget.call(me,targetKey,1);if(!targetWidget){if(!!me.sdp&&!!me.sdp[targetKey]){var sdpData=me.getLayoutDataCache(me.getCurrentLayoutKey());var sdpId=fnBuildId.call(me,{k:targetKey,wid:1},me.currlaykey);me.raiseEvent({name:"secondaryDataSliced",key:targetKey,data:sdpData[sdpId].data});}return ;}if(shared.dataCacheUpdate&&!shared.dataCacheUpdate.def.hasOwnProperty(targetKey)){if(targetWidget.setDirty){targetWidget.setDirty(true);}}else{if(parseInt(def.t,10)===$RW_TYPES.PANELSTACK){targetWidget.setDirtyChildren();}}});var ctlWidget=fnGetWidget.call(me,evt.ctlKey,1);if(ctlWidget&&shared.dataCacheUpdate&&!shared.dataCacheUpdate.upd.hasOwnProperty(ctlWidget.id)){var indices=(ctlWidget.children&&ctlWidget.children[0].selectedIndices)||{},data=ctlWidget.node.data,$SELECTOR_STYLES=mstrmojo.DocSelector.STYLES,ces=[];if(ctlWidget.style===$SELECTOR_STYLES.SEARCH_BOX){var items=(ctlWidget.children&&ctlWidget.children[0].items)||[];$ARR.forEach(items,function(item){ces.push($HASH.clone(item));});}else{$HASH.forEach(indices,function(item,idx){if(item){ces.push(data.elms[idx]);}});}var allIndex=$ARR.find(ces,"v",mstrmojo.elementHelper.ELEM_ALL_ID);if(allIndex>-1){ces=[ces[allIndex]];}data.ces=ces;ctlWidget.selIdx=indices;}}};if(evt.isUConDS||(parseInt(evt.type,10)===$RW_TYPES.GRAPH&&evt.tty===1)){defaultCallback.success=function(res){me.controller.setData(res,true);};return defaultCallback;}if((parseInt(evt.type,10)===3)){return defaultCallback;}return $WRAP(defaultCallback,callbackExtras);},slice:function slice(evt){var ds=this.getDataService(),update=ds.newUpdateWithoutCmd();this.sliceDeferred(update,evt);if(update.actions&&update.actions.length>0){ds.addSuppressData(update.extras);update.submit();}},sliceDeferred:function(update,evt){var emptyUpdate={};try{if(!evt||(!mstrmojo.dom.isAndroid&&!evt.tks&&!evt.multiSelect&&(evt.type===3||(evt.type===$RW_TYPES.GRAPH&&parseInt(evt.tty,10)!==1)))){return emptyUpdate;}var callback=this.getSliceCallback(evt),me=this,dataService=this.getDataService();var evtType=parseInt(evt.type,10);if(evtType===3){selectPanelByEventDeferred.call(me,update,evt);return ;}if(evt.multiSelect){if(evt.selectorObjects.length>0){dataService.setMultiDocSelectorElements(evt.selectorObjects,evt.multiSelect,callback);}return ;}if(evtType===$RW_TYPES.GRAPH){update.add(dataService.getGraphSelectionAction(evt.src,evt.cks,evt.sid,evt.x,evt.y,(evt.tty===1)),callback);if(!!evt.showLoadingIcon){update.addExtras({config:mstrmojo.DocDataService.PROGRESS_CONFIG});}return ;}var events=evt.events||{K0:evt},actions=[],act,extras={config:mstrmojo.DocDataService.PROGRESS_CONFIG},extraParams=extras.params={},i,sdpreqKeys={},fnSDPReq=function(obj,key){if(obj){sdpreqKeys[key]=obj.visName;}};for(i in events){evt=events[i];if(!evt){break;}if(evt.hasOwnProperty("eid")){if(evt.isUConDS){evt.disablePU=true;}if(hasAllSelectedInGB.call(this)){evt.disablePU=true;evt.restoreIW=true;}act=dataService.getSelectorElementsAction(evt);if(me.sdp){sdpreqKeys={};$HFE(me.sdp,fnSDPReq);extraParams.sdpKeys=JSON.stringify(sdpreqKeys);}if(evt.disablePU){extraParams.disablePU=true;}}else{if(evt.fromGM){act=dataService.getSelectorFromGMAction(evt);}else{if(parseInt(evt.srct,10)===4||evt.fid){act=dataService.getSelectorExpressionAction(evt);}else{if(evt.unset){act=dataService.getUnsetSelectorAction(evt);}else{if(parseInt(evt.ct,10)===6){act=dataService.getMultiUnitSelectorAction(evt);}else{act=dataService.getSelectorIncludeAction(evt);}}}}}actions.push(act);}update.add(actions,callback,extras);}catch(ex){mstrmojo.err(ex);}},getInfoWindow:function getInfoWindow(name){var infoWindows=this.infoWindows;return infoWindows&&infoWindows[name];},getTargetInfoWin:function(keys){var ret=[],tgtDefs=fnGetTargetDefn.call(this,keys);if(tgtDefs){var tgt;for(tgt in tgtDefs){if(tgtDefs[tgt]&&tgtDefs[tgt].ifw){ret.push(tgt);}}}return ret;},showInfoWin:function showInfoWin(key,anchor,orientation,invalidate,anchorPosition){var ifwunit=this.infoWinByKey&&this.infoWinByKey[key];if(ifwunit===undefined){return ;}this.raiseEvent({name:"showInfoWin",psId:ifwunit.id,psKey:ifwunit.k,anchor:anchor,anchorOrientation:orientation,anchorPosition:anchorPosition,invalidate:invalidate});},getSelectedXtabStyles:function getSelectedGridStyles(k){var sk=k||this.currlaykey;var ss={};var lyts=this.data&&this.data.layouts,i;for(i in lyts){if(lyts[i].k===sk){ss=lyts[i].xtabStyles;break;}}return ss;},downloadGridData:function downloadGridData(params){var me=this,widgetID=params.xtabId,memo=params.memo,widget=mstrmojo.all[widgetID];this.getDataService().downloadGridData(params,this.newCallback({success:function(res){function findWidgetData(node,wID){var childNodes=me.getChildren(node,true),sz=childNodes.length,cnt;for(cnt=0;cnt<sz;cnt++){var child=childNodes[cnt];if(wID===child.id){return child;}var w=findWidgetData(child,wID);if(w){return w;}}return null;}var layout=res.data&&getLayout.call(me,res.data,me.currlaykey);if(layout){var newGridData=findWidgetData(layout,widgetID);if(newGridData){mstrmojo.models.template.DataInterface.inflateGridData(newGridData.data);if(widget){widget.dataDownloaded(newGridData,memo);}}var xtabStyle=layout.xtabStyles;if(xtabStyle){me.raiseEvent({name:"updateStyles",key:layout.k,updatedStyles:xtabStyle});}}var nodeDefinition=lookupDefn.call(me,me.defn,me.currlaykey,params.nodeKey);if(nodeDefinition&&nodeDefinition.t===$RW_TYPES.GRIDGRAPH&&memo.recalculating){var gridGraph=widget.parent,graphWidget=gridGraph&&gridGraph.getGraphWidget();if(graphWidget&&gridGraph.updateGraph){gridGraph.updateGraph(findWidgetData(layout,graphWidget.id));}}if(res.pukeys){var targetDefinitions=fnGetTargetDefn.call(me,res.pukeys);delete targetDefinitions[params.nodeKey];if(!$HASH.isEmpty(targetDefinitions)){me.partialUpdate(res.data,targetDefinitions);}}},failure:widget.dataDownloadErr||mstrmojo.emptyFn}));},clearDisposables:function clearDisposables(){var newDisposables=[];$ARR.forEach(this.disposables,function(d){if(d._lkz){$FREE(d);}else{newDisposables.push(d);}});this.disposables=newDisposables;},getFixedHeaders:function(node,isPartial){return filterSectionsByTypes.call(this,node,isPartial,[$RW_TYPES.PAGEHEADER],true);},getFixedFooters:function(node,isPartial){return filterSectionsByTypes.call(this,node,isPartial,[$RW_TYPES.PAGEFOOTER],true);},getNonFixedSections:function(node,isPartial){return filterSectionsByTypes.call(this,node,isPartial,[$RW_TYPES.PAGEHEADER,$RW_TYPES.PAGEFOOTER],false);},addAutoWidthID:function addAutoWidthID(id){var aws=this.aws||{},units=aws[this.currlaykey]||[];units.push(id);aws[this.currlaykey]=units;this.aws=aws;},getAutoWidthIDs:function getAutoWidthIDs(){var aws=this.aws,l=this.currlaykey;var ids=aws&&aws[l];if(ids){delete aws[l];}return ids;},getTransactionUpdates:function getTransactionUpdates(t){return this.txDiscardTargets?"":getTxUpdates.call(this,t);},clearTransactionUpdates:function clearTransactionUpdates(t){this.clearTxDeltaUpdate(t);},resetTransactionUpdates:function resetTransactionUpdates(t){var pu=this.pendingUpdate,d=this.delta;if(pu&&pu[t]){$HFE(pu[t],function(v,i){if(d&&!d[i]){d[i]=v;}});delete pu[t];}},transactionUpdate:function transactionUpdate(res,evt){if(!res.data){return null;}var tgtDefs;if(evt&&evt.tks){tgtDefs=fnGetTargetDefn.call(this,evt.tks);}if(res.pukeys){tgtDefs=fnGetTargetDefn.call(this,res.pukeys);var tgt;for(tgt in tgtDefs){if(tgtDefs[tgt]&&tgtDefs[tgt].cek){tgtDefs[tgt].cek=null;}}}if(res.txrcd){this.txrcd=res.txrcd;}else{delete this.txrcd;}var ids=this.updateDataCache(res.data,tgtDefs,evt&&evt.sid),ue={name:"partialUpdate",tree:res.data,ids:ids};if(!$HASH.isEmpty(ids.ifws)){if(evt&&evt.type===$RW_TYPES.GRID){ue.anchor=evt.anchor;}else{ids.ifws={};}}this.raiseEvent(ue);return ids;},deltaUpdate:function dltUdt(w){var d=this.delta;if(!d){d=this.delta={};}d[w.id]=w;},clearTxDeltaUpdate:function clrDltUdt(t){var widgetsToClearTx=this.txDiscardTargets,clearAll=!widgetsToClearTx,pu=this.pendingUpdate,me=this;if(!clearAll){$HFE(widgetsToClearTx,function(v,id){if(me.delta&&me.delta[id]){me.delta[id].clear();delete me.delta[id];}});}if(pu&&pu[t]){$HFE(pu[t],function(w){w.clear();});delete this.pendingUpdate[t];}},sendTransactionActions:function sendTransactionActions(ck,at,callbacks){var me=this;if(!callbacks){callbacks={success:function(res){me.transactionUpdate(res);}};}me.getDataService().sendTransactionActions({keyContext:ck,actions:at,txrcd:this.txrcd},callbacks);},sendTransactionUpdates:function sendTransactionUpdates(evt){var callback=this.getSliceCallback(evt),dataService=this.getDataService();dataService.submitUpdates([dataService.getUpdateTransactionAction(evt)],callback);},addSDP:function addSDP(sdpKey,primaryWidgetInfo){if(!sdpKey||!primaryWidgetInfo){return ;}if(!this.sdp){this.sdp={};}this.sdp[sdpKey]={k:primaryWidgetInfo.k,visName:primaryWidgetInfo.visName};},removeSDP:function removeSDP(sdpKey){if(!sdpKey||!this.sdp[sdpKey]){return ;}delete this.sdp[sdpKey];},getUpdateColorMapCallback:function getUpdateColorMapCallback(){var me=this;return{success:function(res){me.defn.epm=res.defn.epm;initColorByMap.call(me);me.raiseEvent({name:"colorMapChanged"});}};},getUpdateThemePaletteCallback:function getUpdateThemePaletteCallback(){var me=this;return{success:function(res){me.thm=res.thm;me.plt=res.plt;me.defmts=res.defmts;initColorByMap.call(me,true);}};},getCurrentPaletteColors:function getCurrentPaletteColors(){return(this.plt&&this.plt.colors)||DEFAULT_PALETTE;},getColorBy:function(levelIDs,elementIDs){var elements=elementIDs.map(function(elemID,idx){return{levelID:levelIDs[idx].toString(),elemID:elemID};});sortColorByElements(elements);var levelsKey=getColorByLevelsKey(elements),elementsKey=getColorByElementsKey(elements),levelColorBy=COLOR_BY_PALETTE[levelsKey];if(!levelColorBy){levelColorBy=COLOR_BY_PALETTE[levelsKey]={_currentColorIdx:0};}if(!levelColorBy[elementsKey]){var pltColors=this.getCurrentPaletteColors();levelColorBy[elementsKey]=pltColors[levelColorBy._currentColorIdx];levelColorBy._currentColorIdx=(levelColorBy._currentColorIdx+1)%pltColors.length;}if(COLOR_BY[levelsKey]&&COLOR_BY[levelsKey][elementsKey]){return{color:COLOR_BY[levelsKey][elementsKey].color,isManual:true};}return{color:levelColorBy[elementsKey],isManual:false};},getZoomFactor:function getZoomFactor(){return this.getCurrentLayoutDef().zf||1;},getZoomProps:function getZoomProps(){return{dpi:this.dpi,zf:this.getZoomFactor()};},executeLink:function executeLink(url,target,src){if(url.indexOf("prevMsgID")>0){var replacement="prevMsgID="+this.mid;url=url.replace(/prevMsgID=0($|&)/g,function(match,cap){if(cap==="&"){return(replacement+"&");}return replacement;});if(mstrmojo.dom.isIE){url+="&cb"+mstrmojo.now()+"=1";}}url=mstrmojo.addCSRFTokenToURL(url);this.controller.onLink(this,{url:url,target:target,src:src||null,submitAsPost:!mstrmojo.isUrlExternal(url)});},getDatasetUnits:function getDatasetUnits(collectionTypes,fnFilter,defDatasetId,tableIx){var datasets=this.datasets,units=[];$HASH.keyarray(datasets).forEach(function(datasetId){if(!defDatasetId||datasetId===defDatasetId){var dataset=datasets[datasetId],unitsContainer=dataset,datasetUnits=[];collectionTypes.forEach(function(collection){if(tableIx!==undefined){unitsContainer=dataset.tables[tableIx];}(unitsContainer[collection]||[]).forEach(function(unit){if(!fnFilter||fnFilter(unit)){datasetUnits.push(unit);}});});units=units.concat(datasetUnits.map(function(unit){return mstrmojo.hash.copyProps(["did","n","t","st","formType","dt","f","hide","usedInDropZones","card","lock","fs"],unit,{ds:dataset.name,dsId:datasetId,dm:!!unit.um,da:!!unit.da,de:!!unit.de});}));}});return units;}});}());