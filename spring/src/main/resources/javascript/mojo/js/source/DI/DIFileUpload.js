(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.FileUploadBox","mstrmojo.TextBox","mstrmojo.RadioList","mstrmojo.CheckBox","mstrmojo.Image","mstrmojo.DI.DIConstants","mstrmojo.DI.DIHelpers","mstrmojo.DI.FileDragDropBox","mstrmojo.css");mstrmojo.requiresDescs(1825,12509,12691,12692,12737,12738,12739,12740,14099,14194);var constants=mstrmojo.DI.DIConstants,$DESC=mstrmojo.desc,MSTRFileDragDropBoxID,helpers=mstrmojo.DI.DIHelpers,isOperationMode=helpers.isOperationMode;function getCurrentSource(){var m=this.model;var source;if(this.currentSource){source=this.currentSource;}else{source=m.currentSource;}return source;}function getRealFileLength(files){var i=0,j,a;if(mstrApp.isSingleTier){for(j=0;j<files.length;j++){var file=files[j];var pos=file.lastIndexOf("\\");if(pos===-1){pos=file.lastIndexOf("/");}if(pos!==-1){i++;}}}else{for(a in files){if(files[a].size){i++;}}}return i;}function isExtensionValid(){var isValid=true;var name,currentExtension;var source=getCurrentSource.call(this);if(!source||!source.sourceInfo){return isValid;}var operationMode=this.getOperationMode();if((operationMode===constants.operationMode.refresh)||(operationMode===constants.operationMode.edit)){if(this.origFileExt===""){name=mstrApp.isEMMACube?source.sourceInfo.dbTableName:source.sourceInfo.name;this.origFileExt=helpers.getExtensionType(name.substring(name.lastIndexOf(".")));}var file="";if(this.dnDBox.files&&this.dnDBox.files.length>0){file=this.dnDBox.files[0].name;}currentExtension=helpers.getExtensionType(file.substring(file.lastIndexOf(".")));if(this.origFileExt!==currentExtension){isValid=false;}}return isValid;}function __doImport(action){var i;var dndBox=this.dnDBox;var files=dndBox.files;var fileName;var file;var extension;var detailMsg="<ul>";var controller=mstrApp.getRootController();var operationMode=this.getOperationMode();var fileUploadPage=this;var allFileExceedSize=true;var showPreview=true;var fSize,oas,e,source;var showDetailedError=false;var failedFiles=[];for(i=0;i<files.length;i++){file=files[i];fileName="C:\\fakepath\\"+file.name;extension=fileName.substring(fileName.lastIndexOf(".")+1);if(files!==undefined){if(files[i]!==undefined){fSize=files[i].size;}}else{oas=new ActiveXObject("Scripting.FileSystemObject");e=oas.getFile(files);fSize=e.Size;}if(fSize>(mstrApp.diParams.UploadSizeLimit*1024*1024)){showDetailedError=true;failedFiles.push(file.name);var currErrorMsg=mstrmojo.desc(12738,"The maximum file size for #### files is @@@@ MB. ").replace("####",extension).replace("@@@@",mstrApp.diParams.UploadSizeLimit);detailMsg+="<li>"+file.name+"<br>"+currErrorMsg||" </li>";file.toDel=true;}else{allFileExceedSize=false;}if(extension==="mstr"){controller.displayError(mstrmojo.desc(14194,"Error: Only Excel Text, CSV can be uploaded. Please use the Upload MicroStrategy File to import .MSTR files."),false);return ;}}if(operationMode!==constants.operationMode.create&&files.length>0){source=getCurrentSource.call(this);fileName=files[0].name;if(!source.isExtensionValid(fileName)){controller.displayError(mstrmojo.desc(12509,"Switching the file type is not allowed during republishing or editing the cube."),false);return ;}}if(showDetailedError){detailMsg+="</ul>";if(allFileExceedSize){controller.displayError(mstrmojo.desc(12900,"Error importing following files. Please check the files or delete them."),false,detailMsg);}else{var okHandler=function(){for(i=0;i<dndBox.files.length;i++){var file=dndBox.files[i];if(file.toDel){mstrmojo.array.removeItem(dndBox.files,file);}}controller.importFileEMMA(dndBox,fileName,showPreview,!controller.model.hasEMMAReportInstance(),this.id,true,action);};var config={detailErrorMessage:detailMsg,okBtnText:mstrmojo.desc(219,"Yes"),cancelBtnText:mstrmojo.desc(218,"No"),onCancel:function(){var leftFiles=[];for(i=0;i<dndBox.files.length;i++){var file=dndBox.files[i];if(!file.toDel){leftFiles.push(file);}}if(fileUploadPage.setFilesObject){fileUploadPage.setFilesObject(failedFiles);}dndBox.files=leftFiles;}};controller.displayWarning(mstrmojo.desc(13324,"Error importing the following files. Click 'Yes' to ignore the erroneous files and proceed with the successful files. Otherwise, click 'No' to check the erroneous files or delete them."),mstrmojo.desc(12537,"Data Import"),okHandler,config);}return ;}controller.importFileEMMA(dndBox,fileName,showPreview,!controller.model.hasEMMAReportInstance(),this.id,true,action);}function doImport(action){var me=this,dndBox=this.dnDBox,controller=mstrApp.getRootController(),okHandler,config;okHandler=function(){__doImport.call(me,action);};config={detailErrorMessage:"",okBtnText:mstrmojo.desc(219,"Yes"),cancelBtnText:mstrmojo.desc(218,"No"),onCancel:function(){}};if(dndBox.failedFilesCount>0){controller.displayWarning($DESC(14099,"Some files could not be imported last time. Click 'Yes' to ignore them and proceed with the rest files. Otherwise, click 'No' to check the erroneous files or delete them."),$DESC(12537,"Data Import"),okHandler,config);}else{__doImport.call(me,action);}}mstrmojo.DI.DIFileUpload=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.DI.DIFileUpload",cssClass:"mstrmojo-di-fu",markupString:'<div id="{@id}" class="mstrmojo-di-fileUpload {@cssClass}" ><div></div><div></div><div class="mstrmojo-di-fileUpload-fileinput"></div><div></div><div></div><div></div></div>',markupSlots:{containerNode:function(){return this.domNode;},URLOrFileSwitchNode:function(){return this.domNode.children[0];},radioListNode:function(){return this.domNode.children[1];},fileInputNode:function(){return this.domNode.children[2];},infoNode:function(){return this.domNode.children[3];},showPreviewNode:function(){return this.domNode.children[4];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},origFileExt:"",init:function init(props){if(this._super){this._super(props);}var evtConfig={},cfg=evtConfig[this.id]={};cfg.windowSizeChanged=this.adjustSize;mstrApp.getRootController().attachDataChangeListeners(evtConfig);},onNextButtonClick:function onNextButtonClick(){doImport.call(this,this.tableID?constants.actions.refreshData:constants.actions.importSource);},onFinishButtonClick:function(){doImport.call(this,constants.actions.savePublish);},onBackButtonClick:function onBackButtonClick(){var controller=mstrApp.getRootController();controller.showPage(constants.pageType.dataSelection);},onHelpButtonClick:function onHelpButtonClick(){return"importing_data_from_a_file.htm";},updatePageConfig:function(config){var page=this;if(config&&config.properties){mstrmojo.hash.forEach(config.properties,function(value,key){page.set(key,value);});}this.dnDBox.updatePageConfig(config);},setFilesObject:function(files){this.dnDBox.setFilesObject(files);},onforceEnableChange:function(){mstrApp.getRootController().sourceSelected(this.forceEnable);},getOperationMode:function(){var r=this.model.operationMode;if(isOperationMode(this.operationMode)){r=this.operationMode;}return r;},adjustSize:function adjustSize(evt){var size=evt.size,width,buttonNode;this.dnDBox.adjustSize(size);if(mstrApp.isSingleTier){width=parseInt(size.w,10);buttonNode=this.fileInputNode.children[1];buttonNode.style.marginRight=width/2-(buttonNode.clientWidth/2+1)+"px";}},children:[{slot:"fileInputNode",scriptClass:"mstrmojo.DI.FileDragDropBox",cssClass:"drag-drop-box",alias:"dnDBox",markupMethods:{onvalueChange:function(){var controller=mstrApp.getRootController();if(this.files&&this.files.length>0){controller.sourceSelected(true);}else{controller.sourceSelected(false);}},onfilesChange:function(){var controller=mstrApp.getRootController(),operationMode=this.parent.getOperationMode();if((this.files.length!==0||this.parent.forceEnable===true)){if(operationMode===constants.operationMode.create){controller.sourceSelected(true);}else{if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){var len=getRealFileLength(this.files);controller.sourceSelected((len===1));}}}else{controller.sourceSelected(false);}},onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";this.dragLabelNode.style.display=this.fileUpload&&!mstrmojo.dom.isIE8&&!mstrmojo.dom.isIE9?"block":"none";}},addOneTierFile:function addOneTierFile(selectedFiles){var i=0;if(!selectedFiles){return ;}var isWindows=mstrmojo.dom.getOSInfo().name.toLowerCase().indexOf("windows")>=0,files;if(isWindows){files=selectedFiles.split("*");}else{files=selectedFiles.split(":");}var file,newfiles=[].concat(this.files);if(this.parent.tableID&&newfiles.length>0){this.removeChildren();newfiles=[];}for(i=0;i<files.length;i++){file=files[i];newfiles.push(file);this.addFile(mstrmojo.DI.DIHelpers.getAbsoluteFileName(file),file);}this.set("files",newfiles);if(this.parent.tableID){var len=getRealFileLength(this.files);mstrApp.getRootController().sourceSelected((len===1));}},bindings:{value:function(){var source=getCurrentSource.call(this.parent);if((isOperationMode(this.parent.operationMode)?this.parent.operationMode:this.parent.model.operationMode)!==constants.operationMode.create){if(!this.initValue){this.initValue=true;if(source.subtype===constants.sourceSubtype.localFile){var name=source.sourceInfo.name;name=name.substr("C:/fakepath/".length);return mstrmojo.desc(12739,"Previously uploaded file:####").replace("####",name);}}}return"";}},preBuildRendering:function preBuildRendering(){if(this._super){this._super();}var model=mstrApp.getRootController().model;var currentSource=getCurrentSource.call(this.parent);var partition=currentSource&&currentSource.sourceInfo.partition;if(mstrApp.isSingleTier){this.markupString='<div><form target="{@id}_iframe" enctype="multipart/form-data" method="post" action="taskProc"><div class="mstrmojo-di-fileHolder {@cssClass}" mstrAttach:dragover,dragend,drop,click><div class="mstrmojo-FileDragDropBox-text {@textcssClass}">{@text}</div><div class="mstrmojo-FileDragDropBox-content"></div><div class="mstrmojo-FileDragDropBox-count"></div></div><div></div><div><div><div></div></div></div><div style="display:none;"></div></form><iframe id="{@id}_iframe" + name="{@id}_iframe" style="display:none;" src="about:blank"></iframe></div>';}if(model.operationMode!==constants.operationMode.create&&(!partition||!partition.isPartition)&&!model.isAddingNewTable){this.descriptor=mstrmojo.desc(13867,"Drag a file to replace this file");this.browseLabel=mstrmojo.desc(13864,"Choose a file");}else{this.multiple="multiple";}this.text=mstrmojo.desc(12691,"Data can be in crosstab or tabular format");MSTRFileDragDropBoxID=this.id;}},{slot:"fileInputNode",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot mstrmojo-onetier-browse",text:mstrmojo.desc(13865,"Choose files"),onclick:function(){mstrApp.getRootController().launchOneTierBrowser("mstrmojo.DI.DIFileUpload.OneTierFiles");},bindings:{visible:function(){return mstrApp.isSingleTier;}}},{slot:"fileInputNode",scriptClass:"mstrmojo.Label",text:"",cssClass:"di-fu-refresh-text",postBuildRendering:function postBuildRendering(){var source=getCurrentSource.call(this.parent);if((isOperationMode(this.parent.operationMode)?this.parent.operationMode:this.parent.model.operationMode)!==constants.operationMode.create){var fileName=source.sourceInfo.dbTableName;this.set("text",mstrmojo.desc(13868,"Upload original file or a new file to refresh this table.")+"("+mstrmojo.desc(12739,"Previously uploaded file:####").replace("####",fileName)+")");}}}]});mstrmojo.DI.DIFileUpload.OneTierFiles=function(file){var component=mstrmojo.all[MSTRFileDragDropBoxID];component.addOneTierFile(file);};}());