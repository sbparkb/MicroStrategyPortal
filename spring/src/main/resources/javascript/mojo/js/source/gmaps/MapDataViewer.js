(function(){var DRILLING_ACTION=1;var SELECTOR_ACTION=2;var HYPERLINK_ACTION=4;var SORT_ACTION=8;var DEFAULT_BUBBLE_SIZE=10;var LATITUDE_MAX=90,LATITUDE_MIN=-90,LONGITUDE_MAX=180,LONGITUDE_MIN=-180;mstrmojo.requiresCls("mstrmojo.num","mstrmojo.hash","mstrmojo.array","mstrmojo.VisUtility","mstrmojo.VisEnum","mstrmojo.gm.GMLegend","mstrmojo.gm.EnumLegendSlot","mstrmojo.gm.GMUtility","mstrmojo.gmaps.MapManipulation","mstrmojo._VizSelectionHelper","mstrmojo.chart.enums.EnumFontStyle","mstrmojo.vi.ui.rw._HasVisSelections","mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl","mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights","mstrmojo.gmaps._SupportMapBrushesAndHighlights","mstrmojo.vi.viz.MapHelper","mstrmojo.elementHelper");var $A=mstrmojo.array,$H=mstrmojo.hash,$N=mstrmojo.num,$VU=mstrmojo.VisUtility,$GM=mstrmojo.gm,$LEGEND=$GM.GMLegend,$GMU=$GM.GMUtility,$VIS_ENUM=mstrmojo.VisEnum,ENUM_FONT_SYLTE=mstrmojo.chart.enums.EnumFontStyle,LEGEND_DATA_TYPE=$VIS_ENUM.GMLegendDataType,LEGEND_FORMATTING_TYPE=$VIS_ENUM.GMLegendFormatingPropertyTag,LEGEND_PROPERTY=$VIS_ENUM.LegendPropertyTag,MAPS_PROPERTIES=$VIS_ENUM.MAPS_PROPERTIES,PRP_LEGEND_SLOT=$GM.EnumLegendSlot,SELECTION_TYPE=mstrmojo.vi.ui.rw.SelectionType,$EH=mstrmojo.elementHelper;function processFontStyle(obj,fs){obj.fontWeight=(fs&ENUM_FONT_SYLTE.FS_BOLD?"bold":"normal");obj.fontStyle=(fs&ENUM_FONT_SYLTE.FS_ITALIC?"italic":"normal");if((fs&ENUM_FONT_SYLTE.FS_STRIKETHROUGH)&&(fs&ENUM_FONT_SYLTE.FS_UNDERLINE)){obj.textDecoration="line-through underline";}else{if(fs&ENUM_FONT_SYLTE.FS_STRIKETHROUGH){obj.textDecoration="line-through";}else{if(fs&ENUM_FONT_SYLTE.FS_UNDERLINE){obj.textDecoration="underline";}}}}var LegendPropDefault={lgdBgFillClr:[15461355,1710618],lgdBgFillStyle:[0,0],lgdBgFillEff:[1,1],lgdBgFillTrans:[100,80],lgdFntSz:["11px","11px"],lgdFntFml:["Verdana","Verdana"],lgdFntStyle:[0,0],lgdFntClr:[6710886,16777215],lgdBdrShw:[false,false],lgdBdrClr:[11579568,5855577],lgdBdrThk:["1px","1px"],lgdBdrLnStyle:[0,0],lm:[0,0],LegendPosition:[2,2],lwr:[1,1]};function sliceDefaultsLegendProp(idx){var rtn={};$H.keyarray(LegendPropDefault).forEach(function(prop){rtn[prop]=LegendPropDefault[prop][idx];});return rtn;}function getFormatString(idx){var data=this.data,nf=data.nf||[],len=nf.length,nfs;if(idx>=0&&idx<len){nfs=$VU.getNumberFormat(data,idx);return nfs.replace(/\'/g,'"');}return"";}function generateItemColorByInfo(){var colorById=this.dropZones&&this.dropZones.colorBy,data=this.data,gsi=data&&data.gsi,mx=gsi&&gsi.mx,thresholds=gsi&&gsi.thresholds;if(colorById&&thresholds){var colorByMetric,mxIdx;$A.forEach(mx,function(obj,i){if(obj.did===colorById){colorByMetric=obj;mxIdx=i;}});if(colorByMetric){var colorByThresholds=thresholds[colorById],fstThreshold=colorByThresholds&&colorByThresholds[0],isImageType=function(){return fstThreshold.rtp===4;};if(fstThreshold&&(isImageType()||(fstThreshold.fmt&&fstThreshold.fmt.bc))){var rankMode=$VU.getRankMode(colorByThresholds),fs=$VU.getColorByFormatStr(getFormatString.call(this,mxIdx),rankMode),colorByItems=$VU.getColorByItems(colorByThresholds,rankMode,colorByMetric.max,colorByMetric.min,colorByMetric.cnt,fs,this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR));if(isImageType()){$A.forEach(colorByItems,function(item,i){item.image="url("+colorByThresholds[i].rtxt+")";});}return{item:$VU.getColorByTitle(colorByMetric.n,rankMode),elements:colorByItems};}}}}function generateItemSizeByInfo(){var sizeById=this.dropZones&&this.dropZones.sizeBy,data=this.data,gsi=data&&data.gsi,mx=gsi&&gsi.mx,thresholds=gsi&&gsi.thresholds;if(sizeById&&thresholds){var sizeByMetric,mxIdx;$A.forEach(mx,function(obj,i){if(obj.did===sizeById){sizeByMetric=obj;mxIdx=i;}});if(sizeByMetric){var sfs=getFormatString.call(this,mxIdx),sizeByValueStrings=[],start=sizeByMetric.min,end=sizeByMetric.max,delta=(end-start)/4;for(var i=0;i<5;++i){sizeByValueStrings.push($N.formatByMask(sfs,end-i*delta));}var res={item:sizeByMetric.n},elements;if(sizeByValueStrings.length>1){elements=res.elements=[];$A.forEach(sizeByValueStrings,function(szByValue){elements.push({sign:"<",v:szByValue});});if(elements.length===5){elements[0].sign="=";elements[4].sign="=";}res.caseFlag=0;}else{if(sizeByValueStrings.length===1){res.elements=[{diameter:12,shape:"circle",sign:"=",v:sizeByValueStrings[0]}];res.caseFlag=2;}}return res;}}}function showPanelStackInfoWindows(mapViewer,ifws,sc,colIndex,rowIndex,infoWindowRenderedCallback){var me=mapViewer,model=me.primaryModel,eid=model.getRowHeaders(rowIndex).getHeader(colIndex).getElementId(),ps={x:0,y:0,h:60,w:0};if(mstrApp.docModel){me.infoWindowRenderedSub=mstrApp.docModel.attachEventListener("infoWindowRendered",me.id,function(evt){infoWindowRenderedCallback&&infoWindowRenderedCallback(evt);if(me.infoWindowRenderedSub&&mstrApp.docModel){mstrApp.docModel.detachEventListener(me.infoWindowRenderedSub);me.infoWindowRenderedSub=null;}});mstrApp.docModel.slice({type:mstrmojo.EnumRWUnitType.GRID,sPos:ps,ck:sc.ck,ctlKey:sc.ckey,tks:sc.tks,eid:eid});$H.forEach(ifws,function(psId,psKey){mstrApp.docModel.showInfoWin(psId);});}}function findPanelStackAsInfoWindowSelectorTarget(sc){var ifws=null;if(sc&&sc.tks){var dm=mstrApp.docModel,targets=sc.tks.split("\u001E");if(!dm){return ifws;}for(var i=0,len=targets.length;i<len;++i){var d=dm.getTargetDefn(targets[i]);if(d[targets[i]]&&d[targets[i]].ifw){if(!ifws){ifws=[];}ifws.push(targets[i]);}}}return ifws;}function getColumnIndex(unitConfig){var model=this.primaryModel,uid=unitConfig.unitId,isAtt=!!unitConfig.isAttr,excludes=unitConfig.excludes||[],titles=model.getRowTitles(),title,forms,form,i,len,j,size,idx=0,cis=[];for(i=0,len=titles.size();i<len;i++){title=titles.getTitle(i);forms=title.getForms();if(isAtt){if(title.getUnitId()!==uid){idx+=forms.length;}else{for(j=0,size=forms.length;j<size;j++,idx++){form=forms[j];if(excludes&&excludes.length>0){if($A.indexOf(excludes,form.id)===-1){cis.push(idx);}}else{cis.push(idx);}}}}else{for(j=0,size=forms.length;j<size;j++,idx++){form=forms[j];if(form.id===uid){cis.push(idx);}}}}return cis;}mstrmojo.gmaps.MapDataViewer=mstrmojo.declare(mstrmojo.Obj,[mstrmojo._VizSelectionHelper,mstrmojo.vi.ui.rw._HasVisSelections,mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl,mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights,mstrmojo.gmaps._SupportMapBrushesAndHighlights],{scriptClass:"mstrmojo.gmaps.MapDataViewer",beanPath:null,command:null,currentSelections:null,data:null,DEFAULT_COLOR:"#FE766A",defaultInfoWindowHTML:"",gridParams:null,highlightedGraphics:null,idMarkerMap:null,infoWindowHTML:"",isPrimary:false,k:null,layerIndex:0,maxRadius:50,maxValue:-Infinity,minMaxMap:null,minRadius:4,msgID:null,parent:null,selectedMetricIndex:0,bubbleSizeMetricIndex:-1,angleMetricIndex:-1,selectedRowIndices:null,widgetProps:null,model:null,visible:true,validBubble:false,primaryModel:null,bubbleMode:false,attributeFormIndices:null,applyThreshold:true,dropZones:null,selectionBackUp:null,enumDefault:-1,enumNumber:2,enumText:3,enumImage:4,enumUrl:5,enumQuickSymbol:10,init:function init(props){this._super(props);this.command=this.addDisposable(new mstrmojo.gmaps.MapManipulation({viewerLayer:this,_key:this.k}));if(mstrApp&&mstrApp.isVI){this.initLegendProperties();}},handleMetricSelectionChange:function handleMetricSelectionChange(){},performDrill:function performDrill(columnIndex){var selected=this.getSelectedRowIndices(columnIndex);if(selected===undefined||!selected instanceof Array||selected.length===0){selected=this.getTempSelectedRowIndices(columnIndex);if(selected.length===0){return ;}}var actionType=this.data.ghs.rhs.items[selected[0]].items[columnIndex].at;if(actionType===undefined||isNaN(actionType)){return ;}if((actionType&HYPERLINK_ACTION)>0){this.command.execHL(null,null,columnIndex);}},getGeoObjectExt:mstrmojo.emptyFn(),filterElements:function filterElements(matchPattern,unitMatchConfig,stopFun){var model=this.primaryModel,rc=model.getTotalRows(),i,len,re=new RegExp(matchPattern,"i"),ci,header,vs=[],stopLoop=false,n,v;ci=getColumnIndex.call(this,unitMatchConfig);if(ci&&ci.length>0){for(i=0,len=rc;i<len;i++){$A.forEach(ci,function(idx){header=model.getRowHeaders(i).getHeader(idx);n=header.getName();v={n:n,v:i,id:header.getElementId()};if(re.test(n)){if(stopFun&&stopFun(v)){stopLoop=true;vs.push(v);return false;}else{vs.push(v);}return false;}});if(stopLoop){break;}}}return vs;},getCurrentSelections:function getCurrentSelection(columnIndex){if(!this.currentSelections){this.currentSelections={};}if(!this.currentSelections.hasOwnProperty(columnIndex)){this.currentSelections[columnIndex]=[];}return this.currentSelections[columnIndex];},getDocModel:function getDocModel(){return this.model&&this.model.docModel;},getDrillStatus:function getDrillStatus(){var results=false;if(this.enablePolygon){results|=this.getDrillStatusByColumnIndex(this.geoPosition);}if(this.enableMarker){results|=this.getDrillStatusByColumnIndex(this.latIndex);}return results;},getDrillStatusByColumnIndex:function getDrillStatusByColumnIndex(index){var selected=this.getSelectedRowIndices(index);if(selected===undefined||!selected instanceof Array||selected.length===0){return false;}var actionType=this.data.ghs.rhs.items[selected[0]].items[index].at;if(actionType===undefined||isNaN(actionType)){return false;}if((actionType&HYPERLINK_ACTION)>0){return true;}if(this.data.gts.row[index].dp){return true;}return false;},getGeoColumnIndex:function getGeoColumnIndex(){return -1;},getGeoColumnAttribute:function getGeoColumnAttribute(){var columnIndex=this.getGeoColumnIndex(),model=this.primaryModel,title;title=model.getRowTitles().getTitle(columnIndex);if(!!title){return title.getUnitId();}return null;},getHighlightedGraphics:function getHighlightedGraphics(columnIndex){if(!this.highlightedGraphics){this.highlightedGraphics={};}if(!this.highlightedGraphics.hasOwnProperty(columnIndex)){this.highlightedGraphics[columnIndex]=[];}return this.highlightedGraphics[columnIndex];},getInfoWindowHTML:function getInfoWindowHTML(){return this.infoWindowHTML;},getLinkDetails:function getLinkDetails(){var colInd=this.getGeoColumnIndex();return this.data.gts.row[colInd].lm[0];},getMetricSelectorIndex:function getMetricSelectorIndex(){return this.selectedMetricIndex;},getPrimaryGridViewer:function getPrimaryGridViewer(){return this.parent.getPrimaryGridViewer();},getLayerGridName:function getLayerGridName(){return this.data&&this.data.n;},getRowAxisAttributeIndex:function getRowAxisAttributeIndex(columnIndex){var titles=this.data.gts.row;var i;if(typeof (columnIndex)=="undefined"||columnIndex>=titles.length){return -1;}var attributeIndex=-1;var attributeLookup={};for(i=0;i<=columnIndex;i++){if(typeof (attributeLookup[titles[i].id])=="undefined"){attributeLookup[titles[i].id]=1;attributeIndex++;}}return attributeIndex;},getSelectedRowIndices:function getSelectedRowIndices(columnIndex){if(!this.selectedRowIndices){this.selectedRowIndices={};}if(!this.selectedRowIndices.hasOwnProperty(columnIndex)){this.selectedRowIndices[columnIndex]=[];}return this.selectedRowIndices[columnIndex];},getWidgetProps:function getWidgetProps(){return this.widgetProps;},initMapProperty:function initMapProperty(){var geoName;for(geoName in this.columnIndices){if(this.columnIndices.hasOwnProperty(geoName)){this.columnIndices[geoName]=-1;}}this.geoPosition=-1;},initMetricSelectorIndex:function initMetricSelectorIndex(metricId){if(!!mstrApp&&!!mstrApp.isVI){this.selectedMetricIndex=-1;}if(this.data.eg||!metricId){return ;}var selectedMetricId=this.justMetricId(metricId),cols=this.data.gts.col,i,j,il=cols.length,col,es;for(i=0;i<il;i++){col=cols[i];if(col.otp===-1){es=col.es;jl=es.length;for(j=0;j<jl;j++){if(selectedMetricId===this.justMetricId(es[j].id)){this.selectedMetricIndex=j;break;}}}}},initBubbleSizeMetricIndex:function initBubbleSizeMetricIndex(metricId){if(this.data.eg||!metricId){return ;}var sizeMetricId=this.justMetricId(metricId),cols=this.data.gts.col,i,j,il=cols.length,col,es;for(i=0;i<il;i++){col=cols[i];if(col.otp===-1){es=col.es;jl=es.length;for(j=0;j<jl;j++){if(sizeMetricId===this.justMetricId(es[j].id)){this.bubbleSizeMetricIndex=j;break;}}}}},initAngleMetricIndex:function initAngleMetricIndex(metricId){if(this.data.eg||!metricId){return ;}var angleMetricId=this.justMetricId(metricId),cols=this.data.gts.col,i,j,il=cols.length,col,es;for(i=0;i<il;i++){col=cols[i];if(col.otp===-1){es=col.es;jl=es.length;for(j=0;j<jl;j++){if(angleMetricId===this.justMetricId(es[j].id)){this.angleMetricIndex=j;break;}}}}},initMapDisplayMetrics:function initMapDisplayMetrics(){this.initMetricSelectorIndex(this.dropZones.colorBy);this.initBubbleSizeMetricIndex(this.dropZones.sizeBy);this.initAngleMetricIndex(this.dropZones.angle);if(!this.dropZones.colorBy&&!this.dropZones.sizeBy){this.bubbleSizeMetricIndex=this.selectedMetricIndex;}},isAffinityLinesEnabled:function isAffinityLinesEnabled(){return false;},isPrimaryGrid:function isPrimaryGrid(){return this.isPrimary;},isValidLatLng:function isValidLatLng(lat,lng){if(isNaN(lat)||isNaN(lng)){return false;}if(parseInt(lat)<LATITUDE_MIN||parseInt(lat)>LATITUDE_MAX||parseInt(lng)<LONGITUDE_MIN||parseInt(lng)>LONGITUDE_MAX){return false;}return true;},isViewerDrillable:function isViewerDrillable(){if(this.data.eg){return false;}if(this.data.eg||this.primaryModel.getTotalRows()==0){return false;}var index=this.getGeoColumnIndex(),item=this.data.ghs.rhs.items[0].items[index],actionType;if(!!item){actionType=item.at;if(actionType===undefined||isNaN(actionType)){return false;}if((actionType&HYPERLINK_ACTION)>0){return true;}}return false;},isViewerSliceable:function isViewerSliceable(){var index=this.getGeoColumnIndex(),item=this.data.ghs.rhs.items[0].items[index],actionType;if(!!item){actionType=item.at;if(actionType===undefined||isNaN(actionType)){return false;}if((actionType&SELECTOR_ACTION)>0){return true;}}return false;},justMetricId:function justMetricId(id){var result;if(id.indexOf("CD:")===0){result=id.match(/(CD:=?)([0-9a-zA-Z]*)/)[2];}else{if(id.indexOf("i")===0){result=id.match(/(i=?)([0-9a-zA-Z]*)(?=;)/)[2];}else{result=id;}}return result;},populateBubbleVariables:function populateBubbleVariables(){if(!this.bubbleMode){return ;}var colCount=this.primaryModel.getTotalCols();if(this.bubbleSizeMetricIndex>=0&&this.bubbleSizeMetricIndex<colCount){this.populateMinMax(this.bubbleSizeMetricIndex);var minMaxObject=this.minMaxMap[this.bubbleSizeMetricIndex];this.maxValue=minMaxObject.max;this.validBubble=(this.maxValue!=Infinity);}},resetData:function resetData(data){this.data=data;this.primaryModel=this.addDisposable(new mstrmojo.models.template.DataInterface(this.data));},setInfoWindowHTML:function setInfoWindowHTML(value){this.infoWindowHTML=value;this.widgetProps.iwd=escape(this.replaceInfoWindowHTMLMacros());},parseInfoWindowHTML:function parseInfoWindowHTML(){var input=this.infoWindowHTML,result="",baseIndex=0,startIndex=input.indexOf("${",baseIndex),endIndex=input.indexOf("}",startIndex+1),macroName,transformedMacroName,dataIDNameTable={},rows=this.data.gts.row,cols=this.data.gts.col,index,row,col,es,colElement,j;for(index=0;index<rows.length;index++){row=rows[index];dataIDNameTable[row.id+"|"+row.fid]=row.n;dataIDNameTable[row.fid]=row.n;}for(index=0;index<cols.length;index++){col=cols[index];if(col.otp===-1){es=col.es;for(j=0;j<es.length;j++){colElement=es[j];dataIDNameTable[colElement.id]=colElement.n;}break;}}while(startIndex>=0&&endIndex>startIndex){macroName=input.substring(startIndex+2,endIndex);if(dataIDNameTable.hasOwnProperty(macroName)){result+=input.substring(baseIndex,startIndex+2)+dataIDNameTable[macroName];}else{result+=input.substring(baseIndex,endIndex);}baseIndex=endIndex;startIndex=input.indexOf("${",baseIndex);endIndex=input.indexOf("}",startIndex+1);}result+=input.substring(baseIndex);this.infoWindowHTML=result;},replaceInfoWindowHTMLMacros:function replaceInfoWindowHTMLMacros(){var input=this.infoWindowHTML,result="",baseIndex=0,startIndex=input.indexOf("${",baseIndex),endIndex=input.indexOf("}",startIndex+1),macroName,transformedMacroName,dataNameIDTable={},rows=this.data.gts.row,cols=this.data.gts.col,row,col,index,es,colElement,j;for(index=0;index<rows.length;index++){row=rows[index];dataNameIDTable[this.parent.replaceSpace(row.n)]=row.id+"|"+row.fid;}for(index=0;index<cols.length;index++){col=cols[index];if(col.otp===-1){es=col.es;for(j=0;j<es.length;j++){colElement=es[j];dataNameIDTable[this.parent.replaceSpace(colElement.n)]=colElement.id;}break;}}while(startIndex>=0&&endIndex>startIndex){macroName=input.substring(startIndex+2,endIndex);var colonIndex=macroName.indexOf(":");if(colonIndex>=0){macroName=macroName.substring(0,colonIndex)+" "+macroName.substring(colonIndex+1);}macroName=this.parent.replaceSpace(macroName);if(dataNameIDTable.hasOwnProperty(macroName)){result+=input.substring(baseIndex,startIndex+2)+dataNameIDTable[macroName];}else{result+=input.substring(baseIndex,endIndex);}baseIndex=endIndex;startIndex=input.indexOf("${",baseIndex);endIndex=input.indexOf("}",startIndex+1);}result+=input.substring(baseIndex);return result;},selectedMetricIndexChange:function selectedMetricIndexChange(metricIndex,metricId){this.selectedMetricIndex=metricIndex;if(this.bubbleMode){this.bubbleSizeMetricIndex=metricIndex;}this.handleMetricSelectionChange();},getThresholdString:function getThresholdString(rowIndex,metricIndex,defaultValue,useBackgroundColor,dataModel){var result=defaultValue;if(!this.applyThreshold){return result;}var model=dataModel?dataModel:this.primaryModel,cell=model.getMetricValue(rowIndex,metricIndex);if(!cell||!cell.value){return result;}var cellValue=cell.value,thresholds=this.data.gsi&&this.data.gsi.thresholds,colorArray,threshold,cols=model.getColTitles(),colCount=cols.size(),col,metric,metricId,i,j;if(this.data.th&&this.data.fc){if(useBackgroundColor){result=cell.getFillColor(defaultValue);}else{result=cell.getThresholdValue(defaultValue);}}else{if(!!thresholds){if(!!cellValue&&cellValue.hasOwnProperty("ti")){for(i=0;i<colCount;i++){col=cols.getTitle(i);if(col.getUnitDssType()===-1){var es=col.getHeaderValues();metric=es[metricIndex];if(!!metric){metricId=this.justMetricId(metric.id);}break;}}colorArray=thresholds[metricId];if(!!colorArray&&!!colorArray[cellValue.ti]){threshold=colorArray[cellValue.ti];if(useBackgroundColor){result=(threshold.fmt&&threshold.fmt.bc)?threshold.fmt.bc:defaultValue;}else{if(cell.getThresholdType()===this.enumImage||cell.getThresholdType()===this.enumUrl){result=threshold.rtxt||defaultValue;}else{if(cell.getThresholdType()===this.enumText||cell.getThresholdType()===this.enumQuickSymbol){result=(threshold.fmt&&threshold.fmt.fc)?threshold.fmt.fc:defaultValue;}else{result=(threshold.fmt&&threshold.fmt.bc)?threshold.fmt.bc:defaultValue;}}}}}}}return result;},getObjInfo:function getObjInfo(rowIndex){var gridData=this.primaryModel,rowItems,titles=gridData.getRowTitles(),attrFormIndices=this.getAttrFormIndices(),oneAttrForms,oneAttrFormCount,attrCount=attrFormIndices.length,formCount,selObjInfo,rowItems,rowItem,rowItemIndex,attrIndex,formIndex,i,attrTitle,attrName,attrID,attrElemName,attrElemID;rowItems=gridData.getRowHeaders(rowIndex);formCount=rowItems.size();selObjInfo=[];for(attrIndex=0;attrIndex<attrCount;attrIndex++){oneAttrForms=attrFormIndices[attrIndex];oneAttrFormCount=oneAttrForms.length;attrTitle=titles.getTitle(attrIndex);attrName=attrTitle.getName();attrID=attrTitle.getUnitId();for(i=0;i<oneAttrFormCount;i++){formIndex=oneAttrForms[i];if(formIndex<formCount){rowItem=rowItems.getHeader(formIndex);attrElemName=rowItem.getName();attrElemID=rowItem.getElementId();selObjInfo.push({n:attrName,tid:attrID,v:attrElemName,eid:attrElemID});}}}return selObjInfo;},getSelectedObjectMetricInfo:function getSelectedObjectMetricInfo(rowIndex){var i,item,rtn={},info=this.getObjInfo(rowIndex),n=info.length,value;for(i=0;i<n;i++){item=info[i];value=item.v;if(rtn[item.tid]&&rtn[item.tid][0]&&rtn[item.tid][0].n){value=rtn[item.tid][0].n+":"+item.v;}rtn[item.tid]=[{id:item.eid,n:value}];}return rtn;},addMetricSelections:function addMetricSelections(){var selected=this.getSelectedRowIndices(this.getGeoColumnIndex());if(selected===undefined||!selected instanceof Array||selected.length===0){return ;}var selObjInfo,index,rowIndex,selectedCount=selected.length;for(index=0;index<selectedCount;index++){rowIndex=selected[index];selObjInfo=this.getSelectedObjectMetricInfo(rowIndex);this.addMetricValueSelection(selObjInfo);}},addAttributeSelections:function addAttributeSelections(){var attributeIndex=this.getGeoColumnIndex(),selected=this.getSelectedRowIndices(attributeIndex);if(selected===undefined||!selected instanceof Array||selected.length===0){return ;}var selObjInfo,index,rowIndex,selectedCount=selected.length,selAttrInfo;for(index=0;index<selectedCount;index++){rowIndex=selected[index];selObjInfo=this.getObjInfo(rowIndex);selAttrInfo=selObjInfo[attributeIndex];this.addAttributeSelection(selAttrInfo.tid,selAttrInfo.eid,selAttrInfo.v);}},addVisSelection:function addVisSelection(rowIndices){if(!this.parent.isVI()){return ;}var rowIndex,rowCount,i,selObjInfo,attributeIndex=this.getGeoColumnIndex(),selAttrInfo,filterSelectionInfo=function(si){if(!!this.dropZones.geoAttribute){delete si[this.dropZones.latitude];delete si[this.dropZones.longitude];}};if(!!rowIndices&&rowIndices instanceof Array){rowCount=rowIndices.length;for(i=0;i<rowCount;i++){rowIndex=rowIndices[i];if(this.getSelectionType()===SELECTION_TYPE.ATTS){selObjInfo=this.getObjInfo(rowIndex);selAttrInfo=selObjInfo[attributeIndex];this.addAttributeSelection(selAttrInfo.tid,selAttrInfo.eid,selAttrInfo.v);}else{if(this.getSelectionType()===SELECTION_TYPE.METRICS){selObjInfo=this.getSelectedObjectMetricInfo(rowIndex);this.addMetricValueSelection(selObjInfo);}}}}else{if(this.getSelectionType()===SELECTION_TYPE.ATTS){selObjInfo=this.getObjInfo(rowIndices);selAttrInfo=selObjInfo[attributeIndex];this.addAttributeSelection(selAttrInfo.tid,selAttrInfo.eid,selAttrInfo.v);}else{if(this.getSelectionType()===SELECTION_TYPE.METRICS){selObjInfo=this.getSelectedObjectMetricInfo(rowIndices);filterSelectionInfo.call(this,selObjInfo);this.addMetricValueSelection(selObjInfo);}}}},calculateBubbleRadius:function calculateBubbleRadius(value){if(isNaN(value)){return this.minRadius;}if(value<0){if(this.wpMapSizingStyle==="1"){return this.minRadius;}else{value=Math.abs(value);}}return Math.max(this.maxRadius*Math.sqrt(value/this.maxValue),this.minRadius);},calculateBubbleSize:function calculateBubbleSize(rowIndex){var radius=DEFAULT_BUBBLE_SIZE,bubbleSizeCell,priModel=this.primaryModel,cellNumber,value,rawValue,colCount=priModel.getTotalCols();if(this.bubbleSizeMetricIndex>=0&&this.bubbleSizeMetricIndex<colCount){bubbleSizeCell=priModel.getMetricValue(rowIndex,this.bubbleSizeMetricIndex);value=bubbleSizeCell.getValue();rawValue=bubbleSizeCell.getRawValue();cellNumber=parseFloat(!rawValue?this.parent.stripNumberFormat(value):rawValue);if(this.validBubble){radius=this.calculateBubbleRadius(cellNumber);}}return radius;},getAngleMetricValue:function getAngleMetricValue(rowIndex){var priModel=this.primaryModel,colCount=priModel.getTotalCols(),angleCell,value,rawValue=0;if(this.angleMetricIndex>=0&&this.angleMetricIndex<colCount){angleCell=priModel.getMetricValue(rowIndex,this.angleMetricIndex);value=angleCell.getValue();rawValue=angleCell.getRawValue();rawValue=parseFloat(!rawValue?this.parent.stripNumberFormat(value):rawValue);if(isNaN(rawValue)){rawValue=0;}}return rawValue;},removeVisSelection:function removeVisSelection(rowIndices){if(!this.parent.isVI()){return ;}var rowIndex,rowCount,i,selObjInfo,attributeIndex=this.getGeoColumnIndex(),selAttrInfo;if(!!rowIndices&&rowIndices instanceof Array){rowCount=rowIndices.length;for(i=0;i<rowCount;i++){rowIndex=rowIndices[i];if(this.getSelectionType()===SELECTION_TYPE.ATTS){selObjInfo=this.getObjInfo(rowIndex);selAttrInfo=selObjInfo[attributeIndex];this.removeAttributeSelection(selAttrInfo.tid,selAttrInfo.eid);}else{if(this.getSelectionType()===SELECTION_TYPE.METRICS){selObjInfo=this.getSelectedObjectMetricInfo(rowIndex);this.removeMetricValueSelection(selObjInfo);}}}}else{if(this.getSelectionType()===SELECTION_TYPE.ATTS){selObjInfo=this.getObjInfo(rowIndices);selAttrInfo=selObjInfo[attributeIndex];this.removeAttributeSelection(selAttrInfo.tid,selAttrInfo.eid);}else{if(this.getSelectionType()===SELECTION_TYPE.METRICS){selObjInfo=this.getSelectedObjectMetricInfo(rowIndices);this.removeMetricValueSelection(selObjInfo);}}}},getAttrFormIndices:function getAttrFormIndices(){if(!!this.attributeFormIndices){return this.attributeFormIndices;}var me=this,gridData=me.primaryModel,titles=gridData.getRowTitles(),i,j,attrFormIndices=[],titleCount=titles.size();if(titleCount>0){var idx=0;for(i=0;i<titleCount;i++){var fs=titles.getTitle(i).getForms();attrFormIndices.push([]);if(fs){for(j=0;j<fs.length;j++){attrFormIndices[i].push(idx++);}}else{idx++;}}}else{attrFormIndices=null;}this.attributeFormIndices=attrFormIndices;return attrFormIndices;},findSelectorControl:function findSelectorControl(){var data=this.data,v=data&&data.sc;if(v&&parseInt(v.ct,10)===6){this.selectorControl=v;this.isMultiSelect=true;}else{delete this.selectorControl;}this.controller=!!this.model?this.model.controller:null;this.sid=this.data.sid;return this.selectorControl;},showData:function(objsInfo){if(this.k!=this.parent.k){return ;}if(!this.parent.gridData){this.parent.gridData=this.data;}mstrmojo.vi.ui.ViewDataDialog.open(this.parent.parent,true);},postBuildRendering:function postBuildRendering(){if(!!mstrApp&&!!mstrApp.isVI&&this._super){this._super();this.attachEventListener("regenerateToolbar",this.parent.parent.id,"generateToolbar");}},onClearBrushing:function onClearBrushing(evt){},endSelections:function endSelections(){if(!!mstrApp&&!!mstrApp.isVI&&this._super){this._super();}},destroy:function destroy(){if(!!mstrApp&&mstrApp.isVI){var dm=mstrApp.rootCtrl.docCtrl.model;if(this.brushSub){dm.detachEventListener(this.brushSub);}if(this.clearSub){dm.detachEventListener(this.clearSub);}}if(this._super){this._super();}},isSelected:function isSelected(marker){var result=false,selectedRowIndices=this.getSelectedRowIndices(this.getGeoColumnIndex()),rowIndex=-1;if(marker&&marker.attributes){if(marker.attributes.hasOwnProperty("rowIndex")){rowIndex=marker.attributes.rowIndex;}else{if(marker.attributes.hasOwnProperty("rowIndices")){rowIndex=marker.attributes.rowIndices[0];}}if(rowIndex>=0&&mstrmojo.array.indexOf(selectedRowIndices,rowIndex)>=0){result=true;}}return result;},getElementIdWithoutAttributeID:function getElementIdWithoutAttributeID(elementID){var pres=$EH.getIdPresentation(elementID);var newElementID="";var pos=0;var i;switch(pres){case"terse":case"terseLong":for(i=0;i<elementID.length;i++){if(elementID.charAt(i)===";"){pos++;}if(pos===1){continue;}newElementID=newElementID+elementID.charAt(i);}return newElementID;case"old":for(i=0;i<elementID.length;i++){if(elementID.charAt(i)===":"){pos++;continue;}if(pos===0){continue;}newElementID=newElementID+elementID.charAt(i);}return newElementID;case"oldLong":for(i=0;i<elementID.length;i++){if(elementID.charAt(i)===":"){pos++;}if(pos===1){continue;}newElementID=newElementID+elementID.charAt(i);}return newElementID;}return elementID;},initLegendProperties:function initLegendProperties(){var lightTheme=(mstrmojo.all.rootView.themeClassName.indexOf("light")>=0);this.defaultsLegendPop=sliceDefaultsLegendProp(lightTheme?0:1);this.colorByInfo=generateItemColorByInfo.call(this);this.sizeByInfo=generateItemSizeByInfo.call(this);var LEGEND=this.legendProperty={};LEGEND.fontFamily=this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_FAMILY);LEGEND.fontSize=this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_SIZE);processFontStyle(LEGEND,this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_STYLE));LEGEND.color=$GMU.decodeColor(this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_COLOR));LEGEND.backgroundColor=$GMU.decodeColor(this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR));LEGEND.opacity=this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY)/100;LEGEND.tbHeight=0;if(this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_SHOW)){LEGEND.borderWidth=$VU.translateLineStyle(this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE)).width;LEGEND.borderStyle=$VU.translateLineStyle(this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE)).style;LEGEND.borderColor=$GMU.decodeColor(this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_COLOR));}},getLegendProperty:function(propName){var itemValue,props=this.getWidgetProps();switch(propName){case MAPS_PROPERTIES.SHOW_LEGEND:itemValue=props.ls===undefined||props.ls.toString()==="true";break;case LEGEND_PROPERTY.SCALE_LEGEND_WIDTH:itemValue=parseFloat(props.lwr);break;}if(itemValue===undefined||((typeof itemValue)==="number"&&isNaN(itemValue))){itemValue=this.defaultsLegendPop[propName];}return itemValue;},hEvalSize4Legend:function(){var rtn,p=this.parent,cData=this.colorByInfo,sData=this.sizeByInfo,width=p.getWidth(),height=p.getHeight();if(this.getLegendProperty(MAPS_PROPERTIES.SHOW_LEGEND)===false){this.legendW=this.legendH=0;}else{rtn=$LEGEND.getLegendSize([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:cData},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:sData}],this.getLegendProperty(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH),width,height,this.legendProperty);this.legendCutBy=rtn.cutBy;this.legendW=rtn.width;this.legendH=rtn.height;}},resizeLegend:function(legend,delta){var rtn,p=this.parent,width=p.getWidth(),height=p.getHeight(),factor=delta/this.legendW+1,scale=this.getLegendProperty(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH);if(legend){scale*=factor;this.legendW+=delta;rtn=$LEGEND.getLegendSize([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:this.colorByInfo},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:this.sizeByInfo}],scale,width,height,this.legendProperty,this.legendW);this.legendH=rtn.height;this.legendCutBy=rtn.cutBy;this.setLegendProperty(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH,scale);}},setLegendProperty:function(n,v){switch(n){case LEGEND_PROPERTY.SCALE_LEGEND_WIDTH:this.parent.setProperty(n,v,{suppressData:true});break;}},getLegendStyles:function(){return this.legendProperty;},isLegendMinimized:function(){return false;},getLegendSize:function(){return{width:this.legendW,height:this.legendH,cutBy:this.legendCutBy};},startAffinityLinesAnimation:function startAffinityLinesAnimation(sourceIds){return ;},drawAffinityLinesUsingSecondaryDataProvider:function drawAffinityLinesUsingSecondaryDataProvider(){return ;},backupSelections:function backupSelections(){var columnIndex=this.getGeoColumnIndex();this.selectionBackUp={};this.selectionBackUp.currentSelections=[].concat(this.getCurrentSelections(columnIndex));this.selectionBackUp.selectedRowIndices=[].concat(this.getSelectedRowIndices(columnIndex));this.selectionBackUp.highlightedGraphics=[].concat(this.getHighlightedGraphics(columnIndex));},restoreSelectionEffects:function restoreSelectionEffects(){var columnIndex=this.getGeoColumnIndex(),highlightedGraphics=this.getHighlightedGraphics(columnIndex),count=highlightedGraphics?highlightedGraphics.length:0;for(var i=0;i<count;i++){this.highlightGraphic(highlightedGraphics[i]);}},restoreSelectionDataOnly:function restoreSelectionDataOnly(){if(!this.selectionBackUp){return ;}var columnIndex=this.getGeoColumnIndex(),i,count;if(!this.currentSelections){this.currentSelections={};}if(!this.selectedRowIndices){this.selectedRowIndices={};}if(!this.highlightedGraphics){this.highlightedGraphics={};}this.currentSelections[columnIndex]=this.selectionBackUp.currentSelections;this.selectedRowIndices[columnIndex]=this.selectionBackUp.selectedRowIndices;this.highlightedGraphics[columnIndex]=this.selectionBackUp.highlightedGraphics;var selectedRowIndices=this.getSelectedRowIndices(columnIndex);this.addVisSelection(selectedRowIndices);},clearSelectionBackup:function clearSelectionBackup(){this.selectionBackUp=null;},addTempSelections:function addTempSelections(selections){var selectionArray=mstrmojo.array.ensureArray(selections),i,j,count=selectionArray.length,selection,rowIndices,geoIndices,rowIndex,geoIndex,tempSelectedRowIndices,tempHighlightedGraphics,geoColumnIndex;geoColumnIndex=this.getGeoColumnIndex();tempSelectedRowIndices=this.getTempSelectedRowIndices(geoColumnIndex);tempHighlightedGraphics=this.getTempHighlightedGraphics(geoColumnIndex);for(i=0;i<count;i++){selection=selectionArray[i];if(selection.attributes){if(selection.attributes.hasOwnProperty("rowIndices")){rowIndices=selection.attributes.rowIndices;geoIndices=selection.attributes.geoIndices;for(j=0;j<rowIndices.length;j++){rowIndex=rowIndices[j];tempSelectedRowIndices.push(rowIndex);}tempHighlightedGraphics.push(selection);this.addVisSelection(rowIndices);}else{if(selection.attributes.hasOwnProperty("rowIndex")){rowIndex=selection.attributes.rowIndex;tempSelectedRowIndices.push(rowIndex);tempHighlightedGraphics.push(selection);this.addVisSelection(rowIndex);}}}}},clearTempSelections:function clearTempSelections(){var tempSelectedRowIndices,tempHighlightedGraphics,geoColumnIndex;geoColumnIndex=this.getGeoColumnIndex();tempSelectedRowIndices=this.getTempSelectedRowIndices(geoColumnIndex);tempHighlightedGraphics=this.getTempHighlightedGraphics(geoColumnIndex);this.removeVisSelection(tempSelectedRowIndices);for(var i=0;i<tempHighlightedGraphics.length;i++){this.clearHighlight(tempHighlightedGraphics[i]);}tempSelectedRowIndices.length=0;tempHighlightedGraphics.length=0;},getTempSelectedRowIndices:function getTempSelectedRowIndices(columnIndex){if(!this.tempSelectedRowIndices){this.tempSelectedRowIndices={};}if(!this.tempSelectedRowIndices.hasOwnProperty(columnIndex)){this.tempSelectedRowIndices[columnIndex]=[];}return this.tempSelectedRowIndices[columnIndex];},getTempHighlightedGraphics:function getTempHighlightedGraphics(columnIndex){if(!this.tempHighlightedGraphics){this.tempHighlightedGraphics={};}if(!this.tempHighlightedGraphics.hasOwnProperty(columnIndex)){this.tempHighlightedGraphics[columnIndex]=[];}return this.tempHighlightedGraphics[columnIndex];},generateSelectorControlInfoWindowContent:function generateSelectorControlInfoWindowContent(ifw){var newDiv=document.createElement("div");if(!!ifw){ifw.set("autoCloses",false);ifw.set("locksHover",false);newDiv.className="fusionTableInfoWindow";var portlet=ifw.children[0],panelStack=portlet&&portlet.content;ifw.containerNode.style.top=0;ifw.containerNode.style.left=0;if(panelStack){newDiv.appendChild(panelStack.containerNode);ifw.close();}else{newDiv.appendChild(ifw.domNode);}if(portlet){newDiv.style.height=portlet.defn.fmts.height;newDiv.style.width=portlet.defn.fmts.width;newDiv.style.position="relative";}else{newDiv.style.height="125px";newDiv.style.width="200px";newDiv.style.overflow="auto";}}return newDiv;},unrender:function unrender(){this.tempSelectedRowIndices=null;this.tempHighlightedGraphics=null;if(this._super){this._super();}}});var $MDV=mstrmojo.gmaps.MapDataViewer;$MDV.showPanelStackInfoWindows=showPanelStackInfoWindows;$MDV.findPanelStackAsInfoWindowSelectorTarget=findPanelStackAsInfoWindowSelectorTarget;})();