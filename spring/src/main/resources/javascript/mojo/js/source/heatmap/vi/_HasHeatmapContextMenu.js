(function(){mstrmojo.requiresCls("mstrmojo.ui.editors.controls.TwoColumnContainer","mstrmojo.Label","mstrmojo.array","mstrmojo.hash","mstrmojo.Popup","mstrmojo.Box","mstrmojo.ui.editors.controls.ColorPickerButton","mstrmojo.ui.PopupConfig","mstrmojo.ui.Pulldown","mstrmojo.dom","mstrmojo._FormatDefinition","mstrmojo.Button","mstrmojo.models.FormatModel","mstrmojo.VisUtility","mstrmojo.heatmap.vi.VisHeatmapUtility");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$UTIL=mstrmojo.VisUtility,$HM_UTIL=mstrmojo.heatmap.vi.VisHeatmapUtility,$FD=mstrmojo._FormatDefinition,FILL_CONFIG_CONTROL=mstrmojo.ui.editors.controls.FillConfigGroup.CTRL_FLAGS;var fontFamilyItems=$FD.Families.slice(1).map(function(font){return{n:font.n,did:font.n};});function findSelectedItemIndex(items,value){var len=items.length,i;for(i=0;i<len;i++){if(value===items[i].did){return i;}}}function getRowContainer(children,cfg){children=children||[];$ARR.forEach(children,function(child){child.cssDisplay="inline-block";});return $HASH.copy(cfg||{},{scriptClass:"mstrmojo.Box",cssClass:"row-container",children:children});}function getPulldown(items,selectedIndex,model,width){var cb=function(evt){var newIndex=evt.value,newValue=items[newIndex]&&items[newIndex].did;model.setValue(newValue);};return getPulldownWithCallback(items,selectedIndex,cb,width);}function getPulldownWithCallback(items,selectedIndex,callback,width){width=width||"60px";var pulldown=new mstrmojo.ui.Pulldown({items:items,width:width,postselectedIndexChange:callback});pulldown.set("selectedIndex",selectedIndex);return{scriptClass:"mstrmojo.Box",children:[pulldown]};}function colorControls(model,extraParam){extraParam=$HASH.copy(extraParam,{label:mstrmojo.desc(3905,"Background"),noOpacity:false,showNoFill:true});var showOpacity=!extraParam.noOpacity;var visibleControls,components,width;var FILL="ColorClr",OPACITY="ColorFillTrans";if(showOpacity){visibleControls=FILL_CONFIG_CONTROL.FILL_COLOR|FILL_CONFIG_CONTROL.FILL_TRANSPARENCY;components=[FILL,OPACITY];width="125px";}else{visibleControls=FILL_CONFIG_CONTROL.FILL_COLOR;components=[FILL];width="60px";}var colorControl=new mstrmojo.ui.editors.controls.FillConfigGroup({colorPickerHostWithin:true,showNoFill:extraParam.showNoFill,visibleControls:visibleControls,onGroupValueChange:function(name,newValue){if(name===FILL){model.value.setValue(newValue);}if(name===OPACITY){model.opacity.setValue(newValue/100);}},width:width});if(colorControl){if(showOpacity){colorControl.fillColorAndTrans.layoutConfig={w:{col1Node:"50%",dividerNode:"5px",col2Node:"50%"},xt:true};}colorControl.iniChildrenComp(components);colorControl.syncControls(function(){this.setChildValue(FILL,model.value.getValue());if(showOpacity){this.setChildValue(OPACITY,model.opacity.getValue()*100);}});}var controls=[{scriptClass:"mstrmojo.Box",width:"60px",children:[{scriptClass:"mstrmojo.Label",text:extraParam.label}]},colorControl];return[getRowContainer(controls)];}var configFactory={background:colorControls,headerFill:colorControls,font:function(model,extraParams){var stepper=$HM_UTIL.getStepper(function(d){if(d>0){model.scale.setValue(model.scale.getValue()+0.1);}else{model.scale.setValue(Math.max(0.1,model.scale.getValue()-0.1));}},{width:"62px"});this.attachEventListener("fontScaleChange",this.id,function(evt){$HM_UTIL.setStepperEnabled(stepper,[extraParams.modelPath],evt.limits);if(extraParams.disableFontSize){stepper.set("enabled",false);}});var controls=[getRowContainer([{scriptClass:"mstrmojo.Box",width:"60px",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(3544,"Text")}]},stepper,getPulldown(fontFamilyItems,findSelectedItemIndex(fontFamilyItems,model.family.getValue()),model.family)])];this.triggerFontScaleChangeEvent();return controls;},attributeColorBy:function(colorby,params){params=params||{};var title=mstrmojo.desc(2885,"Fill"),callback=params.callback;var SHAPE_FILL="ShapeClr",SHAPE_OPACITY="ShapeFillTrans",hasCallback=callback&&callback.onFillChanged&&callback.onOpacityChanged,cb=hasCallback?function(name,newVal){if(name===SHAPE_FILL){callback.onFillChanged.call(this,newVal,function(color){colorControl.syncControls(function(){this.setChildValue(SHAPE_FILL,color);});});$UTIL.setColorPickerShowAutomatic(colorControl,newVal!=="automatic");}else{if(name===SHAPE_OPACITY){callback.onOpacityChanged.call(this,newVal);}}}:mstrmojo.emptyFn,colorControl=new mstrmojo.ui.editors.controls.FillConfigGroup({colorPickerHostWithin:true,onGroupValueChange:cb,width:"125px"});if(colorControl){colorControl.fillColorAndTrans.layoutConfig={w:{col1Node:"50%",dividerNode:"5px",col2Node:"50%"},xt:true};colorControl.iniChildrenComp([SHAPE_FILL,SHAPE_OPACITY]);colorControl.syncControls(function(){this.setChildValue(SHAPE_FILL,colorby.color);this.setChildValue(SHAPE_OPACITY,colorby.opacity);});$UTIL.setColorPickerShowAutomatic(colorControl,colorby.showAutomatic);}return[getRowContainer([{scriptClass:"mstrmojo.Box",width:"60px",children:[{scriptClass:"mstrmojo.Label",text:title}]},colorControl],{width:"147px"})];},metricColorByOpacity:function(model){var SHAPE_OPACITY="ShapeFillTrans";var fillCtrl=new mstrmojo.ui.editors.controls.FillConfigGroup({visibleControls:FILL_CONFIG_CONTROL.FILL_TRANSPARENCY,onGroupValueChange:function(name,newVal){if(name===SHAPE_OPACITY&&model){model.setValue(newVal/100);}},width:"60px"});if(fillCtrl&&model){fillCtrl.iniChildrenComp([SHAPE_OPACITY]);fillCtrl.syncControls(function(){this.setChildValue(SHAPE_OPACITY,model.getValue()*100);});}return[getRowContainer([{scriptClass:"mstrmojo.Box",width:"60px",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(2885,"Fill")}]},fillCtrl])];}};function getPopupConfig(descriptors,e,alignment){var controls=[],_this=this;descriptors.forEach(function(d){var type=d.type,model=d.model,factory=configFactory[type],widget=_this.getWidget();if(factory){controls=controls.concat(factory.call(widget,model,d));}});if(controls.length){var containerPosition=$DOM.position(this.containerNode,true),x=e.pageX-containerPosition.x,y=e.pageY-containerPosition.y;var popup={scriptClass:"mstrmojo.Popup",cssClass:"widget-inner-context-menu "+mstrApp.getThemeClassName(),locksHover:true,children:controls};var anchor=this._contextMenuAnchor;if(!anchor||!anchor.parentElement){anchor=document.createElement("div");anchor.style.position="absolute";this._contextMenuAnchor=anchor;this.containerNode.appendChild(anchor);}anchor.style.left=x+1+"px";anchor.style.top=y+1+"px";var popupConfig={hostId:this.id,hostElement:anchor,isHostedWithin:false};if(alignment){popupConfig.alignment=alignment;}popup.popupConfig=new mstrmojo.ui.PopupConfig(popupConfig);popup.visible=true;popup.onClose=function(){this.unrender();};return popup;}}mstrmojo.heatmap.vi._HasHeatmapContextMenu=mstrmojo.provide("mstrmojo.heatmap.vi._HasHeatmapContextMenu",{getWidget:function(){return this;},showContextMenu:function(descriptors,e,alignment){descriptors=[].concat(descriptors);this.openPopup(getPopupConfig.call(this,descriptors,e,alignment));},unrender:function(params){this._contextMenuAnchor=undefined;this._super(params);}});}());