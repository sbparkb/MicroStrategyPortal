(function(){mstrmojo.requiresCls("mstrmojo.ME.FunctionWizard","mstrmojo.ME._MetricEditorHelper","mstrmojo.ui._HasScroller");mstrmojo.requiresDescs(1058,1059,4046,4049,12853,13357,13358,13359,13360,13361);var H=mstrmojo.hash;var ID,EDITOR;var WINDOW_TYPE={First:"0",Last:"1",Current:"2",Previous:"3",Next:"4"},WINDOW_TYPE_LIST=[{n:mstrmojo.desc(4046,"First"),did:WINDOW_TYPE.First},{n:mstrmojo.desc(1058,"Previous"),did:WINDOW_TYPE.Previous},{n:mstrmojo.desc(13361,"Current"),did:WINDOW_TYPE.Current},{n:mstrmojo.desc(1059,"Next"),did:WINDOW_TYPE.Next},{n:mstrmojo.desc(4049,"Last"),did:WINDOW_TYPE.Last}],FAKE_DTP={StartAt:-3,StopAt:-4};var _DTPBuilder=function(d){var editor=mstrmojo.all[ID];var w=null;if(d.isParam){w=editor.getParamWidget(d);}else{switch(d&&d.dtp){case FAKE_DTP.StartAt:case FAKE_DTP.StopAt:w={scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-olap-type-box",children:[{scriptClass:"mstrmojo.Pulldown",alias:"winType",cssClass:"mstrmojo-olapArgs-pulldown mstrmojo-ME-Pulldown",popupCssClass:"mstrmojo-ME-Pulldown-Popup",items:{"-3":WINDOW_TYPE_LIST.slice(0,4),"-4":WINDOW_TYPE_LIST.slice(1)}[d.dtp],itemIdField:"did",postCreate:function(){var data=this.parent.data.type;this.value=data.v||data.dfv;},getTokens:function(){var d=this.parent.data.type;if(this.value!==d.dfv){return[{v:d.n},{v:"=",isDelimiter:true},{v:this.value}];}return[];},onvalueChange:function(){EDITOR.onmetricModify();}},{scriptClass:"mstrmojo.ValidationTextBox",alias:"winOffset",cssClass:"mstrmojo-olap-offset",bindings:{visible:function(){return this.parent.winType.value===WINDOW_TYPE.Previous||this.parent.winType.value===WINDOW_TYPE.Next;}},postCreate:function(){var data=this.parent.data.offset;this.value=data.v||data.dfv;},dtp:mstrmojo.expr.DTP.INTEGER,constraints:{trigger:mstrmojo.validation.TRIGGER.ONKEYUP,min:1},getTokens:function(){var d=this.parent.data.offset;if(!mstrmojo.string.isEmpty(this.value)&&this.value!==d.dfv){return[{v:d.n},{v:"=",isDelimiter:true},{v:this.value}];}return[];}},{scriptClass:"mstrmojo.Label",bindings:{visible:function(){return this.parent.winType.value===WINDOW_TYPE.Previous||this.parent.winType.value===WINDOW_TYPE.Next;},text:function(){return this.parent.winType.value===WINDOW_TYPE.Previous?mstrmojo.desc(13357,"row(s) before current"):mstrmojo.desc(13358,"row(s) after current");}}}],getTokens:function(){var tks=[],typeTks=this.winType.getTokens(),offsetTks=this.winOffset.getTokens(),len;len=typeTks.length;if(len>0){tks=tks.concat(typeTks);}len=offsetTks.length;if(len>0){tks.push({v:",",isDelimiter:true});tks=tks.concat(offsetTks);}return tks;}};break;case -2:w=editor.getBreakByWidget(d);break;case -1:w=editor.getSortByWidget(d);break;default:w=editor.getTextWidget(d);}}if(w){w.alias="inputWidget";}return w;};mstrmojo.ME.OLAPEditor=mstrmojo.declare(mstrmojo.ME.FunctionWizard,[mstrmojo.ME._MetricEditorHelper,mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.ME.OLAPEditor",init:function init(props){this._super(props);mstrmojo.css.addWidgetCssClass(this,"olap");ID=this.id;EDITOR=this;},onOpen:function onOpen(){ID=this.id;EDITOR=this;this._super();var fp=this.argsGrid.ctxtBuilder.itemWidgets[0].fctBox.fctPulldown;fp.set("value",this.fctOi.did);if(this.updateScrollbars){this.updateScrollbars();}},setupScrollNodes:function setupScrollNodes(){if(!mstrmojo.dom.ISIE8){this.scrollNode=this.containerNode;}},getPROPBuilder:function getPROPBuilder(){return function(d){var w=null;if(d.isParam){var getOLAPFunctionItems=function(){return mstrmojo.array.map(mstrmojo.ME.MetricDataService.getOLAPAggFunctions(),function(item){item.dn=item.n.substring(4);return item;});};w={scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-olap-fctBox",alias:"fctBox",children:[{scriptClass:"mstrmojo.Pulldown",alias:"fctPulldown",cssClass:"mstrmojo-SME-funcs-pulldown mstrmojo-ME-Pulldown",popupCssClass:"mstrmojo-ME-Pulldown-Popup",itemIdField:"did",itemField:"dn",items:getOLAPFunctionItems(),onvalueChange:function(evt){var syntax="",desc="",item=this.selectedItem;if(item){desc=item.desc+"  "+mstrmojo.ME.MetricDataService.getFunctionHelpTopic(item.h);var pars=item.pars,sa=[],i,len;sa.push(item.n);sa.push("(");for(i=0,len=pars.length;i<len;i++){sa.push(pars[i].n);if(i!==(len-1)){sa.push(", ");}}sa.push(")");syntax=sa.join("");}EDITOR.set("fctSyntax",syntax);EDITOR.set("fctDesc",desc);EDITOR.set("fctName",item&&item.n);EDITOR.fctOi=item;if(evt.valueWas){EDITOR.onmetricModify();}EDITOR.raiseEvent({name:"fctDidChange",did:item.did});}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-SME-agg-label",text:mstrmojo.desc(12853,"of")}]};}else{var cls=(d.dtp===-1?" sortBy":"");w={scriptClass:"mstrmojo.Label",markupString:'<div id="{@id}" class="mstrmojo-DataRow-text '+cls+'"title="'+(d.desc||"")+'"></div>',alias:"labelWidget",text:(d.dn||d.n)+(d.isParam?"*":"")+":"};}return w;};},getDTPBuilder:function getDTPBuilder(){return _DTPBuilder;},postProcessProsFromToken:function(res){var ps=[],p,i,pros=res.pros,len=(pros&&pros.length)||0,hiddenPs=[];for(i=0;i<len;i++){p=H.copy(pros[i]);switch(p.n){case"OLAPWinStType":ps.push({n:mstrmojo.desc(13359,"Start At"),dtp:FAKE_DTP.StartAt,type:H.copy(pros[i]),offset:H.copy(pros[++i])});break;case"OLAPWinEndType":ps.push({n:mstrmojo.desc(13360,"Stop At"),dtp:FAKE_DTP.StopAt,type:H.copy(pros[i]),offset:H.copy(pros[++i])});break;default:if(p.v!=null){hiddenPs.push(p);}}}this.hiddenPs=hiddenPs;return ps;}});}());