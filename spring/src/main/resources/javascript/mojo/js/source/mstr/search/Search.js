(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.css","mstrmojo.Model","mstrmojo.Container","mstrmojo._HasSuggestion","mstrmojo._IsWebApp","mstrmojo.mstr.search.SearchSettings","mstrmojo.mstr.search.SearchResults");var $DESC=mstrmojo.desc,$CSS=mstrmojo.css,$ARR=mstrmojo.array,$STR=mstrmojo.string;var SEARCH_TYPES=[16,1,2,4,8],QUICK_SEARCH_TYPES=SEARCH_TYPES,OLD_SEARCH_TYPES=[1,2,4,8],DEFAULT_OBJECT_TYPE=[3,8,14081],OBJECT_TYPE_SUGGESTION=-1;var SearchCallbacks={suggest:function(me){return{success:function(res){if(!mstrmojo.all.search){return ;}if(!me.hasSearchPattern){me.clear();me.hideSuggestion();return ;}me.sItems=res.items||[];var i,len=me.sItems.length;for(i=0;i<len;i++){me.sItems[i].t=OBJECT_TYPE_SUGGESTION;}if(len){me.selectedSuggestionIndex=null;}else{me.hideSuggestion();}var suggest=res.items&&res.items[0]&&res.items[0].n.toLowerCase();if(suggest){me.suggestInputNode.value=suggest.replace(new RegExp("^"+me.searchPattern,"i"),me.inputNode.value);me.syncInputWithSuggest();}else{suggest=me.searchPattern;}me.suggest=suggest;if(me.last_searchPattern!==suggest){me.last_searchPattern=suggest;window.setTimeout(function(){me.requestResults();},0);}},failure:function(res){mstrmojo.alert(res.status+" : "+res.statusText);},complete:function(res){me.showSpinnerIcon(false);me.handleSearchErrorAndModeSwitching(res);}};},search:function(me){return{success:function(res){if(!mstrmojo.all.search){return ;}var i;for(i in me){this[i]=me[i];}if(!me.hasSearchPattern&&!me.allowEmptyInput){me.clear();me.hideSuggestion();return ;}if(!res){mstrmojo.xhr.abort();me.requestResults();return ;}me.rItems=res.items||[{t:0,dssid:"",n:mstrmojo.desc(9135,"No match found")}];if(me.showAsPopup){me.renderResultsPopup(me.rItems);}else{me.renderResults(res||{});}},failure:function(res){mstrmojo.alert(res.status+" : "+res.statusText);},complete:function(res){me.showSpinnerIcon(false);me.handleSearchErrorAndModeSwitching(res);}};}};var addAdminInfo=function(msg){var info=mstrApp.adminInfo;return msg.replace("#",(info&&info.length>0?" ("+info+")":""));};var focus4IE=function(){if(mstrmojo.dom.isDXIE||mstrmojo.dom.isSafari){var inputNode=this.inputNode;window.setTimeout(function(){inputNode.focus();},10);}};mstrmojo.mstr.search.Search=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasSuggestion,mstrmojo._IsWebApp],{scriptClass:"mstrmojo.mstr.search.Search",noCache:true,suggestionPopupCssClss:"mstrmojo-Search-suggestion",resultsOnly:false,allowEmptyInput:false,showAsPopup:true,allowHTMLOnObjectDesc:false,searchDelay:200,doAutoComplete:true,minSearchLength:1,supportIncFetch:true,searchTootipText:mstrmojo.desc(9168,"Type to search"),enableSuggestion:true,hasSearchPattern:false,searchProps:null,quickSearch:false,includeObjectDesc:true,blockBegin:1,blockCount:10,rootFolderType:39,rootFolderID:null,nameWildcards:16,recursive:1,objectType:[3,8,14081],fields:"name",dereferenceshortcut:"1",dateType:1,created:0,dateSubType:1,intervalUnit:1,intervalValue:1,startDate:"",endDate:"",ownerType:1,description:"",maxObjects:100,searchDomain:2,styleName:"MojoFolderStyle",clearVisible:false,spinnerVisible:false,markupString:'<div class="mstrmojo-Search {@cssClass}" style="{@cssText}"><div class="mstrmojo-Search-settings1"></div><div class="mstrmojo-Search-container"><div class="mstrmojo-Search-input" style="position: relative"  mstrAttach:mousedown><div class="mstrmojo-Search-search" style="position: relative"><input class="searchPattern" maxlength="100" autocomplete="off" {@autofocus}                                   placeholder="{@searchTootipText}"mstrAttach:mousedown,keyup,keydown,blur,paste,cut,input /><div class="SearchBox-tip" n="searchTip"></div></div><div class="mstrmojo-Search-suggest" style="background: none transparent;"><input class="suggestPattern" maxlength="100" autocomplete="off" disabled="disabled" data-act="suggest"/></div></div><div class="mstrmojo-Search-btns" mstrAttach:click><div class="mstrmojo-Search-btnClear" data-act="clear"></div><div class="mstrmojo-Search-btnSpinner" data-act="spinner"></div><div class="mstrmojo-Search-btnSearch" data-act="search"></div></div></div><div class="mstrmojo-Search-btnSettings" data-act="settings" mstrAttach:click>'+mstrmojo.desc(14521,"Refineseaaa")+'</div><div class="mstrmojo-Search-infoIcon" data-act="info"></div><div class="mstrmojo-Search-settings"></div><div class="mstrmojo-Search-result"></div></div>',markupSlots:{settings1ContainerNode:function(){return this.domNode.firstChild;},suggestInputNode:function(){return this.domNode.childNodes[1].firstChild.childNodes[1].firstChild;},inputNode:function(){return this.domNode.childNodes[1].firstChild.childNodes[0].firstChild;},searchTipNode:function(){return this.domNode.childNodes[1].firstChild.childNodes[1].childNodes[1];},btnsNode:function(){return this.domNode.childNodes[1].childNodes[1];},clearNode:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[0];},spinnerNode:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[1];},searchNode:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[2];},settingsBtnNode:function(){return this.domNode.childNodes[2].childNodes[2];},infoIconNode:function(){return this.domNode.childNodes[3];},settingsContainerNode:function(){return this.domNode.childNodes[4];},resultsContainerNode:function(){return this.domNode.childNodes[5];}},markupMethods:{onclearVisibleChange:function(){$CSS.toggleClass(this.btnsNode,"clear",this.clearVisible);},onspinnerVisibleChange:function(){$CSS.toggleClass(this.btnsNode,"spinner",this.spinnerVisible);$CSS.toggleClass(this.domNode,"searching",this.spinnerVisible);}},init:function init(props){var me=this;this.autofocus=mstrmojo.dom.isSafari?"":"autofocus";if(this._super){this._super(props);}if(this.resultsOnly){$CSS.addWidgetCssClass(this,"resultsOnly");}this.updateQuickSearchEnabled();mstrmojo.hash.copy(props.searchProps,this);this.objectType=$ARR.filter(this.objectType,function(t){return $ARR.find(me.allowedObjectTypesData,"t",parseInt(t,10))>-1;});this.maxObjects=parseInt(this.maxSearchResults||this.blockCount,10);var date=new Date();this.endDate=mstrmojo.date.formatDateInfo({day:date.getDate(),month:parseInt(date.getMonth(),10)+1,year:date.getFullYear()},mstrmojo.locales.datetime.DATEOUTPUTFORMAT);this.nameWildcards=(this.pqse?16:1);if(this.rootFolderID){this.rootFolderType=0;}else{this.rootFolderType=(parseInt(this.rootFolderType,10)>=0?this.rootFolderType:39);}this.updateQuickSearchEnabled();},preBuildRendering:function preBuildRendering(){var me=this;this.addChildren([mstrmojo.mstr.search.SearchSettings.getLocationPulldown({rootFolderName:this.rootFolderName,rootFolderType:this.rootFolderType,slot:"settings1ContainerNode"}),mstrmojo.mstr.search.SearchSettings.getSearchTypePulldown({className:"searchType",qse:this.qse,slot:"settings1ContainerNode"}),{scriptClass:"mstrmojo.mstr.search.SearchSettings",alias:"settingsWidget",allowedObjectTypesData:this.allowedObjectTypesData,model:new mstrmojo.Model({settings:{rootFolderType:this.rootFolderType,rootFolderID:this.rootFolderID,nameWildcards:this.nameWildcards,objectType:this.objectType,dereferenceshortcut:this.dereferenceshortcut,dateType:this.dateType,created:this.created,dateSubType:this.dateSubType,intervalUnit:this.intervalUnit,intervalValue:this.intervalValue,startDate:this.startDate,endDate:this.endDate,ownerType:this.ownerType,description:this.description}}),onmodelChange:function(){mstrmojo.hash.copy(this.model.settings,me);me.blockBegin=1;me.delayedRequestResults();},slot:"settingsContainerNode"}]);if(this._super){this._super();}},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.showSearchInfoIcon();if(this.showInfoIcon){this.addChildren([{scriptClass:"mstrmojo.Label",cssDisplay:"inline-block",bindings:{visible:function(){return this.showInfoIcon||true;}},useRichTooltip:true,richTooltip:{posType:mstrmojo.tooltip.POS_BOTTOMLEFT,cssClass:"vi-regular vi-tooltip-V",contentNodeCssClass:"mstrmojo-Search-infoIcon-tip",keepArrowXPos:true,refNode:this.infoIconNode,content:addAdminInfo(mstrmojo.desc(9264))},slot:"infoIconNode"}]);this.renderChildren();}focus4IE.call(this);if(this.searchPattern){this.inputNode.value=this.searchPattern;}},getSearchPattern:function getSearchPattern(){if(this.inputNode){this.searchPattern=mstrmojo.string.trim(this.inputNode.value);}else{this.searchPattern=null;}return this.searchPattern;},getRootFolderName:function getRootFolderName(){var names={0:this.rootFolderName,7:$DESC(2,"Shared Reports"),20:$DESC(3,"My Reports"),39:mstrConfig.projectName};return names[this.rootFolderType||39];},getNotFoundMsg:function getNotFoundMsg(){var escape4HTML=function(txt){return"<b>"+mstrmojo.string.escape4HTMLText(txt)+"</b>";};var msg=$DESC(9202,"Your search for ## in ### returned no results").replace("###",escape4HTML(this.getRootFolderName())).replace("##",escape4HTML(this.getSearchPattern()));return msg;},onmousedown:function onmousedown(){focus4IE.call(this);},onkeyup:function onkeyup(evt){var me=this;var e=evt.e;this.value=evt.getTarget().value;var v=this.value;var kc=e.keyCode;if(kc==32&&/^\s/.test(v)){this.value=v.replace(/^\s+/,"");evt.cancel();return false;}me.hasSearchPattern=this.value&&(this.value.length>0);if(!me.doAutoComplete){if(me.hasSearchPattern){me.showClearIcon();}me.searchPattern=this.value;if(e.keyCode!==13){return ;}}var checkMatch=function(arr,v){if(v.indexOf("?")>-1||v.indexOf("*")>-1){return false;}var matched=false;try{if(typeof arr==="string"){matched=(new RegExp("^"+v,"")).test(arr);}else{var i;for(i in arr){matched=(new RegExp("^"+v,"i")).test(arr[i].n);if(!matched){break;}}}}catch(ignore){}return matched;};if(kc&&$ARR.indexOf([8,13,27,37,38,39,40],kc)===-1&&checkMatch(me.suggestInputNode.value,this.value)&&checkMatch(me.sItems,this.value)){return ;}me.processInput(evt);me.syncInputWithSuggest();this.set("clearVisible",this.getSearchPattern().length>0);},onkeydown:function onkeydown(evt){if(mstrmojo.dom.isIE){var e=evt.e;if(e.keyCode===27){e.cancelBubble=true;return false;}}},onpaste:function onpaste(evt){var me=this;window.setTimeout(function(){me.onkeyup(evt);},0);},onclick:function onclick(evt){var hWin=evt.hWin,e=evt.e||hWin.event,tgt=e.target||e.srcElement,act=tgt&&((tgt.dataset&&tgt.dataset.act)||tgt.getAttribute("data-act"));switch(act){case"search":this.forceSearch();break;case"clear":this.clear();break;case"settings":this.settingsWidget.set("visible",!this.settingsWidget.visible);break;}},processInput:function processInput(evt){var e=evt.e,kc=e.keyCode,input=this.inputNode.value;this.searchPattern=input;this.blockBegin=1;if(!this.doAutoComplete&&kc!==13){return ;}if(kc===13||input.length<this.minKeyLength){if(!this.hasSearchPattern){this.clear();}this.hideSuggestion();this.forceSearch();return ;}else{switch(kc){case 38:case 40:if(this.updateSelectedIndex(kc)){this.delayedRequestResults();}else{if(this.tmrRR){window.clearTimeout(this.tmrRR);}}break;case 13:case 27:this.hideSuggestion();this.cancel();break;case 37:break;case 39:if(this.suggestInputNode.value&&this.inputNode.value!==this.suggestInputNode.value){this.inputNode.value=this.suggestInputNode.value;this.suggestInputNode.value="";}break;default:if(!this.enableSuggestion){return ;}this.showSpinnerIcon(true);this.suggestInputNode.value="";this.delayedRequestSuggestion(input);}}},cancel:function cancel(){mstrmojo.xhr.cancel();},requestSuggestion:function requestSuggestion(){return this.showSuggestion(this.getSearchPattern());},delayedRequestSuggestion:function requestSuggestion(key){if(this.tmrRS){window.clearTimeout(this.tmrRS);}if(this.tmrRR){window.clearTimeout(this.tmrRR);}var me=this;this.tmrRS=window.setTimeout(function(){me.requestSuggestion(key);},this.searchDelay);},requestResults:function requestResults(){if(!this.hasUserInput()){return ;}if(!this.searchPattern){this.searchPattern="";}var me=this;var fnCheckObjectType=function(types){if(!me.isMiniSearchBox){return types.toString();}var newTypes=[],dot=DEFAULT_OBJECT_TYPE,i;for(i in dot){if($ARR.find(types,dot[i])>-1){newTypes.push(dot[i]);}}return newTypes.toString();};var fnGetTargetObjectTypes=function(){var types="";if(me.isMiniSearchBox||me.dereferenceshortcut=="1"){return types;}if(me.objectType.length===0||$ARR.indexOf(me.objectType,18)===-1){return types;}var allTypes=[],i;for(i=0;i<me.allowedObjectTypesData.length;i++){allTypes.push(me.allowedObjectTypesData[i].t);}return allTypes.toString();};var params={taskId:"searchMetadata",searchId:this.blockBegin>this.blockCount?this.searchId||"":"",quickSearch:this.qse,fields:this.fields,styleName:this.styleName,searchPattern:this.last_searchPattern||this.searchPattern,objectType:fnCheckObjectType(this.objectType),targetObjectType:fnGetTargetObjectTypes(),rootFolderType:this.rootFolderType,rootFolderID:(this.rootFolderType=="0"?this.rootFolderID:""),dereferenceshortcut:this.dereferenceshortcut,searchDomain:this.searchDomain,servletName:mstrApp&&mstrApp.name,supportOMD:this.supportOMD,maxObjects:this.maxObjects,blockCount:this.blockCount,blockBegin:this.blockBegin,nameWildcards:this.nameWildcards,recursive:this.recursive,sortKey:this.qse?-1:6,dateType:this.dateType,created:this.created,dateSubType:this.dateSubType,intervalUnit:this.intervalUnit,intervalValue:this.intervalValue,startDate:this.startDate,endDate:this.endDate,ownerType:this.ownerType,description:this.description,includeObjectDesc:false,includeAncestorInfo:true,includeHiddenAncestors:true,uses:this.uses||""};this.serverRequest(params,SearchCallbacks.search(this));this.showSpinnerIcon(true);},delayedRequestResults:function requestResults(){if(this.tmrRR){window.clearTimeout(this.tmrRR);}var me=this;this.tmrRR=window.setTimeout(function(){me.requestResults();},this.searchDelay);},renderResults:function renderResultsPopup(results){var me=this;if(!this.resultsWidget){this.addChildren([{scriptClass:"mstrmojo.mstr.search.SearchResults",alias:"resultsWidget",slot:"resultsContainerNode",maxSearchResults:this.maxSearchResults,allowHTMLOnObjectDesc:this.allowHTMLOnObjectDesc,onfetch:function(evt){me.fetchPage(evt);}}]);this.renderChildren();}this.resultsWidget.set("results",results);},renderResultsPopup:function renderResultsPopup(rItems){var idx=this.suggestionPopup.list.selectedIndex;this.set("suggestionItems",rItems.concat(this.sItems));this.suggestionPopup.list.set("selectedIndex",idx);},hasUserInput:function hasUserInput(){if(!this.inputNode){return false;}var v=this.hasSearchPattern;v=v||!$STR.isEmpty(this.description)||this.ownerType==2||(this.dateType!=1)&&((this.dateSubType==1)&&!$STR.isEmpty(this.intervalValue)||(this.dateSubType==2)&&!$STR.isEmpty(this.startDate));return v||this.allowEmptyInput;},forceSearch:function forceSearch(){if(!this.hasUserInput()){return ;}this.suggestInputNode.value="";this.hideSuggestion();this.last_searchPattern=null;this.currentPage=1;this.blockBegin=1;this.requestResults();},updateQuickSearchEnabled:function updateQuickSearchEnabled(){this.qse=!!this.isQuickSearchEngineEnabled&&this.enableQuickSearchPref;this.pqse=this.qse;this.qse=this.qse&&($ARR.indexOf(QUICK_SEARCH_TYPES,parseInt(this.nameWildcards,10))>-1);this.doAutoComplete=this.qse&&this.enableSearchAutoComplete;this.searchDelay=Math.max(0,this.searchAutoCompleteDelay);},syncInputWithSuggest:function syncInputWithSuggest(){return ;},getSelectedIndex:function(){return this.suggestionPopup.list.selectedIndex;},getSelectedItem:function(){return this.suggestionPopup.list.selectedItem;},updateSelectedIndex:function updateSelectedIndex(keycode){try{if(!this.suggestionShown){return ;}if(keycode==38||keycode==40||keycode==13){switch(keycode){case 40:this.nextHighlight();break;case 38:this.preHighlight();break;case 13:this.hideSuggestion();this.selectedIndex=-1;return ;}var selItem=this.getSelectedItem()||{};var applySuggestion=false;if(selItem.t=="-1"){applySuggestion=this.applySuggestionItem(selItem);}else{applySuggestion=false;this.selectedIndex=this.getSelectedIndex()-((this.sItems&&this.sItems.length)||0);}return applySuggestion;}}catch(ignore){}},clear:function clear(){this.showClearIcon(false);this.showSpinnerIcon(false);this.searchPattern="";this.last_searchPattern="";this.hasSearchPattern=false;this.inputNode.value="";this.suggestInputNode.value="";if(this.resultsWidget){this.resultsWidget.set("results",{});}this.hideSuggestion();focus4IE.call(this);},showSpinnerIcon:function showSpinnerIcon(show){this.set("spinnerVisible",show);},showClearIcon:function showClearIcon(show){this.set("clearVisible",show);},getCandidatesThroughTaskCall:function getCandidatesThroughTaskCall(params,callbacks){params={taskId:"getSearchSuggestions",keyword:this.searchPattern};var suggestCallbacks=SearchCallbacks.suggest(this);callbacks=mstrmojo.func.wrapMethods(suggestCallbacks,callbacks);this.serverRequest(params,callbacks);},getSuggestionPos:function getSuggestionPos(){var p=mstrmojo.dom.position(this.inputNode,true);return{left:Math.round(p.x)+"px",top:Math.round(p.y+p.h)+"px",zIndex:102};},onSuggestionItemSelect:function onSuggestionItemSelect(item){if(this.applySuggestionItem(item)){this.delayedRequestResults();}},applySuggestionItem:function applySuggestionItem(item){this.inputNode.value=item.n;this.suggestInputNode.value=this.inputNode.value;var applySuggestion=false;if(this.last_searchPattern!=this.suggestInputNode.value){this.last_searchPattern=this.suggestInputNode.value;applySuggestion=true;}this.selectedSuggestionIndex=this.getSelectedIndex();return applySuggestion;},fetchPage:function fetchPage(evt){var pn=Math.max(evt.v-1,0);this.blockBegin=pn*this.blockCount+1;this.requestResults();},serverRequest:function serverRequest(params,callback){mstrmojo.xhr.request("POST",mstrConfig.taskURL,callback,params);},handleSearchErrorAndModeSwitching:function handleSearchErrorAndModeSwitching(xhr){if(!xhr){return ;}var me=this;if(me.qse){var code=xhr.getResponseHeader("X-MSTR-TaskErrorCode"),msg=xhr.getResponseHeader("X-MSTR-TaskFailureMsg")||"";if(!code||code==-2147209051){return ;}var SESVC_E_SEARCH_ENGINE_NOT_STARTED=-2147212073;var SESVC_E_PROJECT_SEARCH_DISABLED=-2147212154;if(code==SESVC_E_SEARCH_ENGINE_NOT_STARTED||code==SESVC_E_PROJECT_SEARCH_DISABLED){me.isQuickSearchEngineEnabled=false;me.updateQuickSearchEnabled();me.nameWildcards={16:1,2:2,4:4,8:8}[me.nameWildcards];me.requestResults();this.showInfoIconOnce=true;}else{mstrmojo.alert(me.addAdminInfo(msg));}}else{var flag=JSON.parse(xhr.responseText).qsr;if(this.enableQuickSearch&&flag){this.isQuickSearchEnabled=true;me.updateQuickSearchEnabled();me.nameWildcards={1:16,2:2,4:4,8:8}[me.nameWildcards];me.requestResults();}}},showSearchInfoIcon:function showSearchInfoIcon(visible){this.set("showInfoIcon",!this.qse||visible);},destroy:function destroy(ignoreDom){this._super(ignoreDom);this.destroyChildren(true);}});mstrmojo.mstr.search.Search.zIndex=10;}());