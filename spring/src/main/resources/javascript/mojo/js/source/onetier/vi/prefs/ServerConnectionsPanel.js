(function(){mstrmojo.requiresCls("mstrmojo.onetier.vi.prefs.PreferencesEditorPanel","mstrmojo.onetier.vi.prefs.ServerConfigBox","mstrmojo.ui.ScrollableList","mstrmojo._HasLayout","mstrmojo.css");var ADD_ITEM_ID=-1,ADD_SERVER_ITEM_CFG={n:"",id:ADD_ITEM_ID,cls:"mstrmojo-Button mstrmojo-WebButton add"},$CSS=mstrmojo.css,CSS_CLASS_DISABLE_ADD="disable-add",CSS_CLASS_RENAME_ITEM="rnm",unsavedServerConnectionConfig,promptUserOnEditorClose=true;function getNewServerItem(count){return{n:mstrmojo.desc(13713,"Server Name ##").replace("##",count)};}function getIncompleteConnectionIndex(connectionItems){var incompleteConnectionIdx=-1;connectionItems.every(function(data,index){if(!mstrmojo.onetier.vi.prefs.ServerConfigBox.isConnectionInfoComplete(data)&&data.id!==ADD_ITEM_ID){incompleteConnectionIdx=index;}return incompleteConnectionIdx===-1;});return incompleteConnectionIdx;}function addNewServerConnection(){var connectionList=this.connectionList;var items=connectionList.items,length=items.length,start=length,item,keepSearching=true;while(keepSearching){item=getNewServerItem(start);keepSearching=false;mstrmojo.array.forEach(items,function(itm){if(itm.n===item.n){keepSearching=true;start++;return false;}});}connectionList.set("items",items.concat(item));connectionList.select(length);$CSS.addClass(connectionList.domNode,CSS_CLASS_DISABLE_ADD);}function removeServerConnection(idx){var connectionList=this.connectionList;var items=connectionList.items.concat();items.splice(idx,1);connectionList.set("items",items);connectionList.select(Math.min(idx,items.length-1));$CSS.toggleClass(connectionList.domNode,CSS_CLASS_DISABLE_ADD,getIncompleteConnectionIndex(items)>-1);}function createAndAddServerConfigBox(connectionData){var serverConfigBox=this.serverConfigBox;if(serverConfigBox){this.removeChildren(serverConfigBox);serverConfigBox.destroy();}this.addChildren([{scriptClass:"mstrmojo.onetier.vi.prefs.ServerConfigBox",viewFactory:this.viewFactory,connectionData:connectionData,alias:"serverConfigBox",slot:"configBoxNode",isEditConfig:!!connectionData.id,saveNewServerConnection:function saveServerConnection(serverConnectionInfo){var panel=this.parent,model=panel.model;serverConnectionInfo.url=serverConnectionInfo.url.trim();model.testServerConnection(serverConnectionInfo.url,function(){model.addServerConnectionDelta(serverConnectionInfo);this.set("isEditConfig",true);this.testButton.set("enabled",false);this.taSuccessLabel.set("text",mstrmojo.desc(3336,"## has been saved successfully.").replace("##",this.connectionData.wsn));this.taSuccessLabel.set("visible",true);window.setTimeout(function(){this.taSuccessLabel.set("visible",false);}.bind(this),5000);panel.refresh();}.bind(this));},editServerConnection:function editServerConnection(serverConnectionInfo){var model=this.parent.model;serverConnectionInfo.url=serverConnectionInfo.url.trim();model.testServerConnection(serverConnectionInfo.url.trim(),function(){model.editServerConnection(serverConnectionInfo);this.testButton.set("enabled",false);this.taSuccessLabel.set("text",mstrmojo.desc(3336,"## has been saved successfully.").replace("##",this.connectionData.wsn));this.taSuccessLabel.set("visible",true);window.setTimeout(function(){this.taSuccessLabel.set("visible",false);}.bind(this),5000);}.bind(this));},deleteServerConnection:function deleteServerConnection(serverConnectionInfo){mstrmojo.warn(mstrmojo.desc(13714,'Are you sure you want to remove "##"?').replace("##",serverConnectionInfo.n),{confirmBtn:{t:mstrmojo.desc(190,"Remove"),fn:function(){var panel=this.parent,connectionId=serverConnectionInfo.id;if(connectionId){panel.model.deleteServerConnection(connectionId);}removeServerConnection.call(panel,serverConnectionInfo._renderIdx);}.bind(this)}});}}]);serverConfigBox=this.serverConfigBox;if(serverConfigBox.isEditConfig){serverConfigBox.testButton.set("enabled",serverConfigBox.isConnectionValid());}if(this.hasRendered){this.doLayout();}}mstrmojo.onetier.vi.prefs.ServerConnectionsPanel=mstrmojo.declare(mstrmojo.onetier.vi.prefs.PreferencesEditorPanel,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.onetier.vi.prefs.ServerConnectionsPanel",markupString:'<div id="{@id}" class="ot-server-conn cf {@cssClass}" style="{@cssText}"><div class="conn-list"></div><div class="conf-box"></div></div>',markupSlots:{connectionListNode:function connectionListNode(){return this.domNode.firstChild;},configBoxNode:function configBoxNode(){return this.domNode.lastChild;}},layoutConfig:{w:{connectionListNode:"150px",configBoxNode:"100%"},h:{connectionListNode:"100%",configBoxNode:"100%"},xt:true},connectionList:undefined,serverConfigBox:undefined,init:function init(props){this._super(props);var savedConnections=this.model.getServerConnections().concat(unsavedServerConnectionConfig||[]),initialSelectedItemIdx=unsavedServerConnectionConfig?(savedConnections.length):1,items=[].concat(ADD_SERVER_ITEM_CFG),id=this.id;if(savedConnections.length===0){items=items.concat(getNewServerItem(items.length));}items=items.concat(savedConnections);this.addChildren([{scriptClass:"mstrmojo.ui.ScrollableList",items:items,alias:"connectionList",slot:"connectionListNode",getItemMarkup:function getItemMarkup(item){return mstrmojo.ui.ScrollableList.prototype.getItemMarkup.call(this,item).replace("{@en@n}",'<div class="srvr-name">{@en@n}</div><div class="srvr-edit"></div><span class="'+CSS_CLASS_RENAME_ITEM+'"></span>');},onclick:function onclick(evt){var evtTarget=evt.getTarget();mstrmojo.ui.ScrollableList.prototype.onclick.call(this,evt);if(evtTarget.className===CSS_CLASS_RENAME_ITEM){var listWidget=this,itemNode=this.getItemNodeFromTarget(evtTarget),itemEditSlot=itemNode.children[1],item=this.getItemFromTarget(evtTarget),serverConnectionsPanel=this.parent,editableLabel=this.addDisposable(new mstrmojo.EditableLabel({onTextEditComplete:function onTextEditComplete(){var newName=this.text;if(item.n!==newName){var nameExists=false;var items=listWidget.items;mstrmojo.array.forEach(items,function(itm){if(itm.n===newName){nameExists=true;return false;}});if(nameExists){mstrmojo.alert(mstrmojo.desc(14614,"This name already exists. Please choose a different name."),function(){listWidget.refresh();});return ;}item.n=newName;}listWidget.refresh();serverConnectionsPanel.model.serverConnectionNameEdited(item);this.destroy();}}));editableLabel.set("text",item.n);editableLabel.render();$CSS.addClass(itemNode,"is-editing");itemEditSlot.appendChild(editableLabel.domNode);editableLabel.set("isEditing",true);}},selectionAdded:function selectionAdded(evt){var addedIndex=evt.added[0],removedIndex=evt.removed[0],serverConnectionsPanel=mstrmojo.all[id],connectionItems=this.items,serverConfigBox=serverConnectionsPanel.serverConfigBox,fnIsConnectionComplete=mstrmojo.onetier.vi.prefs.ServerConfigBox.isConnectionInfoComplete;if(addedIndex>0){createAndAddServerConfigBox.call(serverConnectionsPanel,connectionItems[addedIndex]);}else{var incompleteConnectionIdx=-1;if(serverConfigBox){if(!fnIsConnectionComplete(serverConfigBox.connectionData)){incompleteConnectionIdx=removedIndex;}else{incompleteConnectionIdx=getIncompleteConnectionIndex(connectionItems);}}if(incompleteConnectionIdx>0){this.select(incompleteConnectionIdx);}else{addNewServerConnection.call(serverConnectionsPanel);}}}}]);createAndAddServerConfigBox.call(this,items[initialSelectedItemIdx]);this.connectionList.select(initialSelectedItemIdx);promptUserOnEditorClose=true;},preCloseEditor:function preCloseEditor(closeCallbackFn){unsavedServerConnectionConfig=null;var connectionData=this.serverConfigBox.connectionData;if(promptUserOnEditorClose&&!connectionData.id&&connectionData.url){mstrmojo.alert(mstrmojo.desc(14168,'Server will not be saved without "Test & Add".'),function(){promptUserOnEditorClose=false;});}else{this._super(closeCallbackFn);}},clearCache:function clearCache(){var currentConnectionData=this.serverConfigBox.connectionData;if(!currentConnectionData.id&&currentConnectionData.url){currentConnectionData.url=null;}unsavedServerConnectionConfig=null;},destroy:function destroy(skipCleanup){var currentConnectionData=this.serverConfigBox.connectionData;unsavedServerConnectionConfig=(!currentConnectionData.id&&currentConnectionData.url)?currentConnectionData:null;this._super(skipCleanup);}});}());