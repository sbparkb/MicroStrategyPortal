(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo._HasBuilder","mstrmojo._IsRwDocument","mstrmojo.express.ui._IsDocumentView","mstrmojo.vi._MonitorsAppState","mstrmojo.vi.ui.DocBuilder","mstrmojo.vi.ui.VisualizationEditor","mstrmojo.vi.ui.tabs.LayoutTabStrip","mstrmojo.array","mstrmojo.func","mstrmojo.hash","mstrmojo.css","mstrmojo.vi.ui.rw.xtab.XtabMenuConfig");var $ARR=mstrmojo.array,$FUNC=mstrmojo.func,$HASH=mstrmojo.hash;function getDuplicatedLayoutName(layouts,key){var dupName=mstrmojo.desc(11450,"## copy ###"),duplicateIdx=$ARR.find(layouts,"k",key),layout=layouts[duplicateIdx],newName=layout.numDupl===0?dupName.replace("###","").replace("##",layout.n):dupName.replace("###",layout.numDupl).replace("##",layout.n),h={};(layouts||[]).forEach(function(u){h[u.n]=true;});while(h[newName]){layout.numDupl++;newName=dupName.replace("###",layout.numDupl).replace("##",layout.n);}return newName;}function getRedisplayLayoutCallback(index,key,oldLayout){var model=this.model;return{success:function(response){var newLayout=this.replaceLayout(null,model.getChildren(response,false,index,1)[0],index);this.selector.setTabs(this.getLayouts(),key);model.currlaykey=response.currlaykey;this.reDisplayLayout(oldLayout,newLayout);}.bind(this),failure:function(err){mstrApp.onerror(err);}};}function getSaveLayoutCallback(model){return{success:function(){var boxes=model.replaceKeyBoxes,cmd=model.cmdMgr().getInterimCmd(),boxUpdate=model.getDataService().newUpdate(cmd,{extras:mstrmojo.DocDataService.SUPPRESS_DATA});if(boxes&&boxes.length>0){$ARR.forEach(boxes,function(unit){unit.addSaveBoxLayoutActions(boxUpdate,true);});}model.clearMapLayout();cmd.submitUpdate(boxUpdate,model.cmdMgr().CMD_PHASE.LAST);}};}function updateSelectorPosition(){var selector=this.selector,alignBottom=this.model.tsp!==0,slot=alignBottom?"bottom":"top",hasRendered=selector.hasRendered;if(hasRendered){this.removeChildren(selector);}selector.slot=slot+"CtrlNode";selector.set("isAlignBottom",alignBottom);if(hasRendered){this.addChildren([selector]);}}mstrmojo.vi.ui.DocumentView=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._HasBuilder,mstrmojo._IsRwDocument,mstrmojo.express.ui._IsDocumentView,mstrmojo.vi._MonitorsAppState],{scriptClass:"mstrmojo.vi.ui.DocumentView",markupString:'<div id="{@id}" class="mstrmojo-VIDocument {@cssClass}" style="{@cssText}" ><div></div><div class="mstrmojo-VIDocument-doc"></div><div></div></div>',markupSlots:{topCtrlNode:function(){return this.domNode.firstChild;},containerNode:function(){return this.domNode.childNodes[1];},bottomCtrlNode:function(){return this.domNode.lastChild;}},layoutConfig:{h:{topCtrlNode:"auto",containerNode:"100%",bottomCtrlNode:"auto"},w:{topCtrlNode:"100%",containerNode:"100%",bottomCtrlNode:"100%"},xt:true},hasDataSource:false,selector:null,layoutViewer:null,model:null,builder:null,renderedLayoutsQueue:[],LAYOUTS_CACHE_SIZE:10,init:function init(props){this._super(props);var model=this.model;this.addDisposable(this.builder=new mstrmojo.vi.ui.DocBuilder({parent:this,model:model}));model.attachEventListener("tspChange",this.id,updateSelectorPosition);updateSelectorPosition.call(this);},children:[{scriptClass:"mstrmojo.vi.ui.tabs.LayoutTabStrip",alias:"selector",isStatic:true}],buildChildren:function buildChildren(){var selector=this.selector,editor=this.editor,cachedChildren=[selector];if(editor){cachedChildren.push(editor);}var layouts=this._layouts=this._super(true);this.addChildren(cachedChildren);selector.setTabs(layouts,this.model.getCurrentLayoutKey());},onRender:function onRender(){var selectedLayout=this.getSelectedLayoutWidget();this.addChildren([selectedLayout]);this.selector.setStatic(false);},pushToRenderedQueue:function pushToRenderedQueue(layout,newLayout){var queue=this.renderedLayoutsQueue||[];if(queue.indexOf(layout.k)===-1){queue.push(layout.k);if(queue.length>this.LAYOUTS_CACHE_SIZE){var key2Release=queue.shift(),layouts=this._layouts,layout2Release=layouts[$ARR.find(layouts,"k",key2Release)]||{};if(layout2Release.hasRendered&&key2Release!==newLayout.k){layout2Release.unrender();}}}},showLayout:function showLayout(layout,callback,update){var newKey=layout.k,oldLayout=this.getSelectedLayoutWidget();if(newKey!==oldLayout.k){this.getNewLayout({layoutKey:newKey},this._layouts,true,{success:function(newLayout){this.reDisplayLayout(oldLayout,newLayout,callback);}.bind(this)},update);return true;}return false;},reDisplayLayout:function reDisplayLayout(oldLayout,newLayout,callback){var selector=this.selector,model=this.model,selectedComponent=model.getSelectedViUnit(),selectedComponentKey=selectedComponent&&selectedComponent.k,layoutKey=newLayout.k,layouts=this._layouts;selector.setStatic(true);var existingLayout=(this.children||[]).filter(function(child){return child.k===layoutKey;})[0];if(existingLayout){newLayout=this.rebuildChild(existingLayout);}else{this.removeChildren(oldLayout);this.pushToRenderedQueue(oldLayout,newLayout);this.addChildren([newLayout]);if(newLayout.isBoxLayoutDirty){newLayout.updateRootBoxLayout();newLayout.buildBoxLayout();delete newLayout.isBoxLayoutDirty;}}var idx=$ARR.find(layouts,"k",layoutKey);layouts[idx]=newLayout;(existingLayout||newLayout).raiseEvent({name:"layoutRedisplay"});this.updateXtabStyles(layoutKey);var vizPanel=model.getVizContentPanel(),selectedUnit=selectedComponentKey&&vizPanel.getUnitByKey(selectedComponentKey);if(selectedUnit){vizPanel.selectVIUnit(selectedUnit,true);}else{vizPanel.selectFirstBox();}selector.setSelectedTab(layoutKey);selector.setStatic(false,true);var rootCtrl=this.controller.rootCtrl;rootCtrl.generateToolbar();if(callback){callback();}if(mstrApp.isAppStatePresentation()){this.layoutViewer.syncFilterPanelStack();}this.doLayout();},replaceLayout:function replaceLayout(oldLayout,newLayoutNode,newIdx){var layouts=this._layouts||[],idx=$ARR.find(layouts,"k",oldLayout&&oldLayout.k);if(idx>=0){oldLayout.unrender();oldLayout.destroy();this.model.getDocBuilder().removeVIMapRef(oldLayout.k);}var c=this.builder.build([newLayoutNode],this.model)[0];if(idx>=0){layouts[idx]=c;}else{$ARR.insert(layouts,newIdx,[c]);}this._layouts=layouts;return c;},destroy:function destroy(ignoreDom){(this._layouts||[]).forEach(function(layout){layout.destroy(ignoreDom);});this.builder.destroy();this._super(ignoreDom);},getLayouts:function(){return this._layouts;},updateLayouts:function(node){var layouts=this.getLayouts(),tmpLayouts=[],newLayouts=this.model.getChildren(node,false),oldLayout=this.getSelectedLayoutWidget(),selector=this.selector,i,key,idx;for(i=0;i<newLayouts.length;i++){key=newLayouts[i].k;idx=$ARR.find(layouts,"k",key);if(idx<0){this.replaceLayout(null,newLayouts[i]);}else{if(newLayouts[i].data.loaded&&this.model.currlaykey!==node.currlaykey){this.replaceLayout(layouts[idx],newLayouts[i]);}}}for(i=0;i<layouts.length;i++){idx=$ARR.find(newLayouts,"k",layouts[i].k);if(idx<0){var removed=layouts.splice(i,1)[0];selector.deleteTab(i);removed.unrender();removed.destroy();i--;}}for(i=0;i<newLayouts.length;i++){key=newLayouts[i].k;idx=$ARR.find(layouts,"k",key);if(idx>=0){tmpLayouts.push(layouts[idx]);}}this._layouts=tmpLayouts;this.model.currlaykey=node.currlaykey;selector.setTabs(this._layouts,node.currlaykey);this.reDisplayLayout(oldLayout,this.getSelectedLayoutWidget());},moveLayout:function moveLayout(fromIdx,toIdx){var me=this,model=this.model,layouts=this._layouts,fnMove=function(fromIdx,toIdx){model.moveLayout(fromIdx,toIdx);layouts.splice(toIdx,0,layouts.splice(fromIdx,1)[0]);};model.execute({execute:function execute(){var act=model.getMoveLayoutAction(fromIdx,toIdx);fnMove(fromIdx,toIdx);this.submitSilent(act);},urInfo:{undo:function undo(){fnMove(toIdx,fromIdx);me.selector.moveTab(toIdx,fromIdx,toIdx,true);return true;},redo:function redo(){fnMove(fromIdx,toIdx);me.selector.moveTab(fromIdx,toIdx,fromIdx,true);return true;}}});},deleteLayout:function deleteLayout(key,update){var layouts=this._layouts,deleteIdx=$ARR.find(layouts,"k",key),id=this.id,bLoad=true,fnDelete=function(res){var me=mstrmojo.all[id],oldLayout=layouts.splice(deleteIdx,1)[0],children=bLoad?me.model.getChildren(res,false):layouts,currentLayoutKey=res.currlaykey,newIdx=$ARR.find(children,"k",currentLayoutKey),newLayout;if(bLoad){newLayout=me.replaceLayout(layouts[newIdx],children[newIdx],newIdx);}else{newLayout=children[newIdx];}me.selector.deleteTab(deleteIdx);me.selector.setTabs(me.getLayouts(),currentLayoutKey);me.model.currlaykey=currentLayoutKey;me.reDisplayLayout(oldLayout,newLayout);oldLayout.unrender();oldLayout.destroy();me.model.getDocBuilder().removeVIMapRef(key);};this.model.removeLayout(key,{success:fnDelete},update);var targetIdx=deleteIdx+1;if(!layouts[targetIdx]){targetIdx=deleteIdx-1;}this.model.getDataService().setCurrentDocLayout(layouts[targetIdx].k,null,update);bLoad=this.needLoadLayout(layouts[targetIdx]);update.setTreesToRender(bLoad?3:1);},duplicateLayout:function duplicateLayout(update,key){var layouts=this.getLayouts(),newIdx=$ARR.find(layouts,"k",key)+1,newKey=this.model.getNextKey();this.model.duplicateLayout(update,{srcKey:key,destKey:newKey,name:getDuplicatedLayoutName(layouts,key),index:newIdx+1},$FUNC.wrapMethods(getRedisplayLayoutCallback.call(this,newIdx,newKey,this.getSelectedLayoutWidget(),update),getSaveLayoutCallback(this.model)));},addNewLayout:function addNewLayout(update,idx,params){var newKey=(params&&params.nodeKey)||this.model.getNextKey(),len=this.getLayouts().length;idx=(0<=idx&&idx<len)?idx:len;this.model.addNewLayout(update,$HASH.copy(params,{nodeKey:newKey,index:idx+1}),$FUNC.wrapMethods(getRedisplayLayoutCallback.call(this,idx,newKey,this.getSelectedLayoutWidget()),getSaveLayoutCallback(this.model)));},importDashboard:function importDashboard(update,idx,params){var newKey=(params&&params.nodeKey)||this.model.getNextKey(),len=this.getLayouts().length,controller=this.model.controller;idx=len;this.model.addExistingLayouts(update,$HASH.copy(params,{index:idx+1}));},getSelectedLayoutWidget:function getSelectedLayoutWidget(){return(this._layouts||[]).filter(function(layout){return(layout.k===this.model.getCurrentLayoutKey());},this)[0];},showSelectedLayout:function showSelectedLayout(){var currentLayout=this.getSelectedLayoutWidget();if(this.containerNode.children.length>0){return ;}(this.children||[]).filter(function(child){return child.k===currentLayout.k;}).forEach(function(child){this.removeChildren(child);child.destroy();},this);this.addChildren([currentLayout]);},getViPanel:function getViPanel(type){return this.getSelectedLayoutWidget().getViPanel(type);},selectViPanel:function selectViPanel(type){var panel=this.getViPanel(type);if(panel){panel.parent.selectPanel(panel);}else{this.openViPanel(type);}},openViPanel:function openViPanel(type,callback){this.getSelectedLayoutWidget().openViPanel(type,callback);},onAppStateChange:function onAppStateChange(){this.selector.set("visible",(!mstrApp.isAppStatePrintPreview())&&(!mstrApp.isAppStatePresentation()||this._layouts.length>1));},onLayoutSelected:function onLayoutSelected(update){var model=this.model,cmdMgr=model.controller.cmdMgr,cmd=cmdMgr.getInterimCmd();if(cmd){cmd.submitUpdate(update,cmdMgr.CMD_PHASE.LAST);}else{model.execute({execute:function(){this.submitUpdate(update,cmdMgr.CMD_PHASE.LAST);},urInfo:{treesToRender:3}});}},loadDocLayout:function loadDocLayout(params,callback,update){var autoSubmit=!update;update=update||this.model.getDataService().newUpdate();this._super(params,callback,update);if(autoSubmit){this.onLayoutSelected(update);}},setCurrentDocLayout:function setCurrentDocLayout(key,callback,update){update=update||this.model.getDataService().newUpdate(this);this._super(key,callback,update);update.setTreesToRender(1);this.onLayoutSelected(update);},changeCurrLytTabTtl:function changeCurrLytTabTtl(text,oldText){var tabSelector=this.selector,tab=tabSelector.getSelectedTab();if(tab){tab.set("title",text);tab.titleEdited(text,oldText);}},getXtabCellMenuConfig:function(props){return new mstrmojo.vi.ui.rw.xtab.XtabMenuConfig(props);}});mstrmojo._HasMarkup.addMarkupMethods(mstrmojo.vi.ui.DocumentView,{onhasDataSourceChange:function(){mstrmojo.css.toggleClass(this.domNode,"noDataSource",!this.hasDataSource);}});}());