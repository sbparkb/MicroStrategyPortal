(function(){mstrmojo.requiresCls("mstrmojo.gmaps.MapDataViewer","mstrmojo.color","mstrmojo.array","mstrmojo.hash","mstrmojo.models.template.DataInterface","mstrmojo.VisUtility","mstrmojo.dom","mstrmojo.gmaps._MapDataLabel","mstrmojo.VisTooltip","mstrmojo.gmaps.MapEnums");var $D=mstrmojo.dom,$HASH=mstrmojo.hash,$MDV=mstrmojo.gmaps.MapDataViewer,$ALIGN_OPT=mstrmojo.gmaps.MarkerAlignOption,VisUtil=mstrmojo.VisUtility;var HYPERLINK_ACTION=4;var PRIMARY_DATA_PROVIDER=0;var SECONDARY_DATA_PROVIDER=1;var $EnumMarkerType=mstrmojo.gmaps.EnumMapType;var EnumAreaSelectionType={RECTANGLE:1,CIRCLE:2,POLYGON:3};var DEFAULT_PIN,GLOW_MARKER,TOOLTIP_WIN;function getSvgMarker(props){return $HASH.copy(props,{anchor:{x:488.8,y:296.3},path:this.pushPinPath,strokeColor:"#ffffff",strokeWeight:2,fillOpacity:1,scale:1.1});}function getHiliHoverSvg(props){return $HASH.copy(props,getSvgMarker.call(this,{scale:1.6,fillOpacity:0.7}));}function getHoverSvg(props){return $HASH.copy(props,getSvgMarker.call(this,{fillOpacity:0.7}));}mstrmojo.gmaps.GoogleMapViewer=mstrmojo.declare(mstrmojo.gmaps.MapDataViewer,[mstrmojo.gmaps._MapDataLabel],{scriptClass:"mstrmojo.gmaps.GoogleMapViewer",_affinityAnimationFinished:false,_affinityLines:null,AFFINITY_LINE_DEFAULT_COLOR:null,_animationMarkers:null,_animationSourceMarkerLines:null,previousState:null,savedSliceInfo:null,areaInfoWindow:null,bounds:null,bubbleBorderRegularStroke:"#ffffff",cluster:[],clusterIndex:0,columnIndices:{state:-1,zip:-1},createMode:true,_currentAffinityInterval:0,DEFAULT_LINE_COLOR:16711680,defaultThresholdColor:"#81BEF7",_defaultView:null,densityLayer:null,densityLocations:null,_displayTitleIndex:-1,enableBubble:false,enableLatLng:false,enablePoint:false,enableShape:false,geoElements:{},geoLists:null,grids:null,gridParams:null,highlightStroke:"#000000",imageMap:{},infoAnchor:null,infoWindow:null,infoWindowUseGrid:true,infoWindowRenderedSub:null,previousTooltip:null,latColumnIndex:-1,longColumnIndex:-1,lookupColumnIndex:-1,map:null,mapLayers:[],MAX_PATH_BUBBLE_RADIUS:2,_markerElementIDs:null,_markerImage:null,_hiliImage:null,_markerHoverImage:null,_hiliHoverImage:null,mstrInfo:null,numAttributes:-1,pathObject:null,pointColumnIndex:-1,previousShownBubble:null,regularStroke:"#ffffff",renderCompleteCallbackFunc:null,secondaryDPFirstAttrColIndex:-1,secondaryDPMetricMaxVal:null,secondaryDPSecondAttrColIndex:-1,secondaryModel:null,_selectedAffinityMarkers:null,selectedStroke:"#0000ff",_useAttribute:false,_useLatlng:true,validBubble:false,viewerEventListeners:null,wpAggregateAttributeForm:true,wpAttribute:null,wpDensityTheme:null,wpDrawArcsLines:"Arcs",wpDisPlayAffinityLines:0,wpLat:null,wpLng:null,wpLookupAttId:null,wpMarkerType:"1",wpMarkerStyle:null,_MarkerHoverStyle:null,wpMarkerHighlightedStyle:null,_MarkerHighlightedHoverStyle:null,wpMapSizingStyle:null,wpMaxLineThickness:5,wpPoint:null,wpSecondaryDPKey:null,loadByGridChange:false,mouseX:0,mouseY:0,pushPinPath:"M488.8,274.3c0.7,0,2,0.2,2.4,0.4c4,1.4,5.9,5.5,4.5,9.7c-1.2,3.6-3.5,6.5-6,9.2c-0.5,0.6-1.2,0.6-1.7,0.1c-2.9-3.1-5.6-6.4-6.5-10.7c-0.8-4,1.8-7.7,5.8-8.5C487.6,274.4,488.2,274.3,488.8,274.3L488.8,274.3z",init:function init(props){this._super(props);this.initMarkerStyle();this.setMapModel(this.grids);this.initPathVariables();this.initMapProperty();this.loadWidgetProps();this.initMapDisplayMetrics();this._markerImage=new google.maps.MarkerImage(this.wpMarkerStyle,null,null,null,new google.maps.Size(19,24));this._hiliImage=new google.maps.MarkerImage(this.wpMarkerHighlightedStyle,null,null,null,new google.maps.Size(33,36));if(this.wpMarkerStyle===DEFAULT_PIN){this._markerHoverImage=new google.maps.MarkerImage(this._MarkerHoverStyle,null,null,null,new google.maps.Size(19,24));this._hiliHoverImage=new google.maps.MarkerImage(this._MarkerHighlightedHoverStyle,null,null,null,new google.maps.Size(33,36));}this.viewerEventListeners=[];if(!TOOLTIP_WIN){TOOLTIP_WIN=new mstrmojo.VisTooltip();TOOLTIP_WIN.render();}},initMarkerStyle:function(){var imgPath=mstrApp.isSingleTier?"../images/":"./images/";DEFAULT_PIN=imgPath+"defaultPin.png";GLOW_MARKER=imgPath+"glow_marker.png";this.wpMarkerStyle=DEFAULT_PIN;this._MarkerHoverStyle=imgPath+"defaultPin_hover.png";this.wpMarkerHighlightedStyle=imgPath+"defaultPin_Highlighted.png";this._MarkerHighlightedHoverStyle=imgPath+"defaultPin_Highlighted_hover.png";},initPathVariables:function initPathVariables(){this.pathObject={};this.minRadius=this.pathObject.minPathBubbleRadius=1;this.pathObject.pathCurrentPolygonIndex=-1;this.pathObject.animatePathBubbleIndex=-1;},addDensity:function addDensity(markerList,latLng,attributes,simpleHTML,geoPosition,cell,idkey,oldMarker){if(this.densityLocations===null){this.densityLocations=[];}this.densityLocations.push({position:latLng,attributes:attributes,geoPosition:geoPosition,simpleHTML:simpleHTML});this.bounds.extend(latLng);},animatePathBubbles:function animatePathBubbles(){var that=this;this.pathObject.pathBubbles[this.pathObject.animatePathBubbleIndex].setMap(this.map);this.pathObject.animatePathBubbleIndex++;if(this.pathObject.animatePathBubbleIndex==this.pathObject.pathBubbles.length){clearTimeout(this.pathObject.pathLabelTimer);}else{this.pathObject.pathLabelTimer=setTimeout(function(){that.animatePathBubbles();},50);}},animatePath:function animatePath(){var that=this;this.pathObject.pathLines[this.pathObject.pathCurrentPolygonIndex].setMap(this.map);this.pathObject.pathCurrentPolygonIndex++;if(this.pathObject.pathCurrentPolygonIndex==this.pathObject.pathLines.length){clearTimeout(this.pathObject.pathTimer);}else{this.pathObject.pathTimer=setTimeout(function(){that.animatePath();},75);}},handleMetricSelectionChange:function handleMetricSelectionChange(){if(this.enableLatLng||this.enablePoint){this.adjustMarker();}},adjustMarker:function adjustMarker(){if(this.wpMarkerType===$EnumMarkerType.Marker&&!this.applyThreshold){return ;}this.populateBubbleVariables();var gradientFill={type:"radial",cx:0,cy:0},markerList=[],g,colorString,numMarker,priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),colCount=priModel.getTotalCols(),markerImage,hiliImage;if(this.enableLatLng){markerList=this.getGeoList(this.latColumnIndex);}else{if(this.enablePoint){markerList=this.getGeoList(this.pointColumnIndex);}}numMarker=markerList.length;var highlightedGraphics=this.getHighlightedGraphics(this.latColumnIndex);highlightedGraphics.length=0;for(g=0;g<numMarker;g++){var marker=markerList[g],rowIndex=marker.attributes.rowIndex,rowCell=null,markerSelected=false,type=this.enumNumber;if(this.selectedMetricIndex<colCount){rowCell=priModel.getMetricValue(rowIndex,this.selectedMetricIndex);type=rowCell.getThresholdType();}for(var i in this.selectedRowIndices){if(mstrmojo.array.indexOf(this.selectedRowIndices[i],rowIndex)>-1){markerSelected=true;break;}}if(this.wpMarkerType===$EnumMarkerType.Marker){var fill=null,imageMarker;if(rowCell&&(type===this.enumImage)||(type===this.enumUrl)){var imageString=this.getThresholdString(rowIndex,this.selectedMetricIndex,"no",false);if(imageString!="no"){if(this.imageMap.hasOwnProperty(imageString)){markerImage=this.imageMap[imageString];}else{markerImage=new google.maps.MarkerImage(imageString,null,null,null,new google.maps.Size(23,28));this.imageMap[imageString]=markerImage;}if(marker instanceof google.maps.MarkerImage){marker.setIcon(markerImage);}else{imageMarker=new google.maps.Marker({position:marker.getPosition(),icon:markerImage,attributes:marker.attributes,simpleHTML:marker.simpleHTML,mapWidget:this,geoPosition:[this.latColumnIndex,this.longColumnIndex],map:this.map,isSelected:markerSelected});}}}else{if(this.applyThreshold&&rowCell){colorString=this.getThresholdString(rowIndex,this.selectedMetricIndex,null,true);}else{colorString=null;}if(!colorString){imageMarker=new google.maps.Marker({position:marker.getPosition(),icon:markerSelected?this._hiliImage:this._markerImage,attributes:marker.attributes,mapWidget:this,geoPosition:[this.latColumnIndex,this.longColumnIndex],simpleHTML:marker.simpleHTML,image:this._markerImage,hili:this._hiliImage,hover:this._markerHoverImage,hiliHover:this._hiliHoverImage,map:this.map,isSelected:markerSelected});}else{markerImage=getSvgMarker.call(this,{fillColor:colorString});hiliImage=getSvgMarker.call(this,{fillColor:colorString,scale:1.6});imageMarker=new google.maps.Marker({position:marker.getPosition(),icon:markerSelected?hiliImage:markerImage,attributes:marker.attributes,mapWidget:this,geoPosition:[this.latColumnIndex,this.longColumnIndex],simpleHTML:marker.simpleHTML,image:markerImage,hili:hiliImage,hover:getHoverSvg.call(this),hiliHover:getHiliHoverSvg.call(this),map:this.map,isSelected:markerSelected});}}if(markerSelected){highlightedGraphics.push(imageMarker);}var that=this;this.viewerEventListeners.push(google.maps.event.addListener(imageMarker,"mouseover",function(){if($D.isIE9||$D.isIE10||$D.isIEW3C){var rawMouseEvent=marker.getMouseEventFromGoogleEvent&&marker.getMouseEventFromGoogleEvent(event);if(!!rawMouseEvent){that.mouseX=rawMouseEvent.clientX;that.mouseY=rawMouseEvent.clientY;}}if(this.isSelected){if(this.hiliHover){this.setIcon(this.hiliHover);}else{if(this.hili){this.setIcon(this.hili);}}}else{if(this.hover){this.setIcon(this.hover);}else{if(this.hili){this.setIcon(this.hili);}}}if(marker instanceof mstrmojo.gmaps.CircleMarker){marker.set("highlight",true);if(that.previousShownBubble){that.previousShownBubble.set("highlight",false);}that.previousShownBubble=marker;that.previousShownBubble.set("highlight",true);}that.showTooltip(marker);}));this.viewerEventListeners.push(google.maps.event.addListener(imageMarker,"mouseout",function(){if($D.isIE9||$D.isIE10||$D.isIEW3C){var rawMouseEvent=marker.getMouseEventFromGoogleEvent&&marker.getMouseEventFromGoogleEvent(event);if(!!rawMouseEvent){if(rawMouseEvent.clientX==-1&&rawMouseEvent.clientY==-1||rawMouseEvent.clientX==that.mouseX&&rawMouseEvent.clientY==that.mouseY){return ;}}}var columnIndex=that.getGeoColumnIndex(),tempHighlightedGraphics=that.getTempHighlightedGraphics(columnIndex),keepHighlighted=false;if(mstrmojo.array.indexOf(tempHighlightedGraphics,imageMarker)>=0){keepHighlighted=true;}if(!keepHighlighted){if(!this.isSelected){if(this.image){this.setIcon(this.image);}}else{if(this.hili){this.setIcon(this.hili);}}}this.isHover=false;this._mousedown=false;that.hideTooltip();}));this.viewerEventListeners.push(google.maps.event.addListener(imageMarker,"mousedown",function(){if(that.parent.getToolbarState()==0){this._mousedown=true;}}));this.viewerEventListeners.push(google.maps.event.addListener(imageMarker,"rightclick",function(event){if(!that.parent.toolbarStateChanged&&!that.isSelected(marker)){that.handleMarkerMouseClick(marker,this,event);}var targetConfig={type:that.parent.EnumContextMenuTargetType.GeoGraphic,object:imageMarker};that.parent.onRightClick(event,targetConfig);}));this.viewerEventListeners.push(google.maps.event.addListener(imageMarker,"click",function(event){that.handleMarkerMouseClick(imageMarker,this,event);}));markerList[g]=imageMarker;marker.setMap(null);}else{if(this.applyThreshold&&rowCell){colorString=this.getThresholdString(rowIndex,this.selectedMetricIndex,this.defaultThresholdColor,true);}else{colorString=this.defaultThresholdColor;}var radius=this.calculateBubbleSize(rowIndex);if(marker instanceof mstrmojo.gmaps.CircleMarker){if(colorString==="transparent"){marker.set("fillOpacity",0);marker.set("strokeColor",this.defaultThresholdColor);}else{marker.set("fillColor",colorString);marker.set("strokeColor",this.bubbleBorderRegularStroke);}marker.set("radius",radius);}}}},addMarker:function addMarker(markerList,latLng,attributes,simpleHTML,geoPosition,rowIndex,idkey,oldMarker){var marker,colorString,symbolSize,priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),colCount=priModel.getTotalCols(),cell=null,dataLabelsConfig=this.dataLabelsConfig,markerImage,hiliImage;if(this.selectedMetricIndex<colCount){cell=priModel.getMetricValue(rowIndex,this.selectedMetricIndex);}if(this.wpMarkerType===$EnumMarkerType.Marker){if(this.applyThreshold&&cell&&cell.value&&((cell.getThresholdType()===this.enumImage)||(cell.getThresholdType()===this.enumUrl))){var imageString=this.getThresholdString(rowIndex,this.selectedMetricIndex,"no",false);markerImage=new google.maps.MarkerImage(imageString,null,null,null,new google.maps.Size(23,28));hiliImage=new google.maps.MarkerImage(imageString,null,null,null,new google.maps.Size(29,36));symbolSize={width:23,height:28};marker=new google.maps.Marker({position:latLng,icon:markerImage,attributes:attributes,mapWidget:this,geoPosition:geoPosition,simpleHTML:simpleHTML,image:markerImage,hili:hiliImage,map:this.map});}else{if(this.applyThreshold&&cell){colorString=this.getThresholdString(rowIndex,this.selectedMetricIndex,null,true);}else{colorString=null;}if(!colorString){symbolSize={width:19,height:24};marker=new google.maps.Marker({position:latLng,icon:this._markerImage,attributes:attributes,mapWidget:this,geoPosition:geoPosition,simpleHTML:simpleHTML,image:this._markerImage,hover:this._markerHoverImage,hili:this._hiliImage,hiliHover:this._hiliHoverImage,map:this.map});}else{markerImage=getSvgMarker.call(this,{fillColor:colorString});hiliImage=getSvgMarker.call(this,{fillColor:colorString,scale:1.6});symbolSize={width:21,height:25};marker=new google.maps.Marker({position:latLng,icon:markerImage,attributes:attributes,mapWidget:this,geoPosition:geoPosition,simpleHTML:simpleHTML,image:markerImage,hover:getHoverSvg.call(this,{colorString:colorString,fillColor:colorString}),hili:hiliImage,hiliHover:getHiliHoverSvg.call(this,{colorString:colorString,fillColor:colorString}),map:this.map});}}symbolSize.alignOption=$ALIGN_OPT.BOTTOM;marker.setZIndex(this.layerIndex);marker.originalzIndex=this.layerIndex;}else{if(this.wpMarkerType===$EnumMarkerType.Bubble||this.wpMarkerType===$EnumMarkerType.Path){if(this.applyThreshold&&cell){colorString=this.getThresholdString(rowIndex,this.selectedMetricIndex,this.defaultThresholdColor,true);}else{colorString=this.defaultThresholdColor;}var radius=this.calculateBubbleSize(rowIndex);symbolSize={width:radius*2,height:radius*2};if(oldMarker){if(oldMarker instanceof mstrmojo.gmaps.CircleMarker){if(colorString==="transparent"){oldMarker.set("fillOpacity",0);}else{oldMarker.set("fillColor",colorString);}oldMarker.set("radius",radius);}marker=oldMarker;}else{marker=new mstrmojo.gmaps.CircleMarker({position:latLng,fillOpacity:colorString==="transparent"?0:0.75,fillColor:colorString,strokeColor:colorString==="transparent"?this.defaultThresholdColor:this.bubbleBorderRegularStroke,selectedColor:this.selectedStroke,radius:radius,attributes:attributes,mapWidget:this,geoPosition:geoPosition,simpleHTML:simpleHTML,map:this.map,originalzIndex:this.layerIndex+Math.round(this.parent.maxBubbleRadius-radius)});}}else{if(this.isDensityMap()){this.addDensity(markerList,latLng,attributes,simpleHTML,geoPosition,cell,idkey,oldMarker);return ;}}}marker.attributes=attributes;dataLabelsConfig.push({text:attributes.dlTextName,rowIndex:rowIndex,mapPoint:latLng,symbolSize:symbolSize});var registeredMarker=marker;if(registeredMarker instanceof mstrmojo.gmaps.CircleMarker){registeredMarker=marker.circle;}var that=this;this.viewerEventListeners.push(google.maps.event.addListener(registeredMarker,"mouseover",function(){if($D.isIE9||$D.isIE10||$D.isIEW3C){var rawMouseEvent=marker.getMouseEventFromGoogleEvent&&marker.getMouseEventFromGoogleEvent(event);if(!!rawMouseEvent){that.mouseX=rawMouseEvent.clientX;that.mouseY=rawMouseEvent.clientY;}}if(this.isSelected){if(this.hiliHover){this.setIcon(this.hiliHover);}else{if(this.hili){this.setIcon(this.hili);}}}else{if(this.hover){this.setIcon(this.hover);}else{if(this.hili){this.setIcon(this.hili);}}}this.isHover=true;if(marker instanceof mstrmojo.gmaps.CircleMarker){marker.set("highlight",true);if(that.previousShownBubble){that.previousShownBubble.set("highlight",false);}that.previousShownBubble=marker;that.previousShownBubble.set("highlight",true);}that.showTooltip(marker);}));this.viewerEventListeners.push(google.maps.event.addListener(registeredMarker,"mouseout",function(){if($D.isIE9||$D.isIE10||$D.isIEW3C){var rawMouseEvent=marker.getMouseEventFromGoogleEvent&&marker.getMouseEventFromGoogleEvent(event);if(!!rawMouseEvent){if(rawMouseEvent.clientX==-1&&rawMouseEvent.clientY==-1||rawMouseEvent.clientX==that.mouseX&&rawMouseEvent.clientY==that.mouseY){return ;}}}if(!this.isSelected){if(this.image){this.setIcon(this.image);}else{if(marker instanceof mstrmojo.gmaps.CircleMarker){marker.set("highlight",false);}}}else{if(this.hili){this.setIcon(this.hili);}}this.isHover=false;this._mousedown=false;that.hideTooltip();}));this.viewerEventListeners.push(google.maps.event.addListener(registeredMarker,"mouseup",function(event){that.parent.onMouseUp(event);}));this.viewerEventListeners.push(google.maps.event.addListener(registeredMarker,"mousemove",function(event){that.parent.onMouseMove(event);}));this.viewerEventListeners.push(google.maps.event.addListener(registeredMarker,"mousedown",function(){if(that.parent.getToolbarState()==0){this._mousedown=true;}}));this.viewerEventListeners.push(google.maps.event.addListener(registeredMarker,"rightclick",function(event){if(!that.parent.toolbarStateChanged&&!that.isSelected(marker)){that.handleMarkerMouseClick(marker,this,event);}var targetConfig={type:that.parent.EnumContextMenuTargetType.GeoGraphic,object:marker};that.parent.onRightClick(event,targetConfig);}));this.viewerEventListeners.push(google.maps.event.addListener(registeredMarker,"click",function(event){that.handleMarkerMouseClick(marker,this,event);}));markerList.push(marker);this.bounds.extend(latLng);this.idMarkerMap[idkey]=marker;return marker;},checkLookUpAttributeInSecondaryDP:function checkLookUpAttributeInSecondaryDP(){var rowAttributes=this.getMapModel(SECONDARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size();for(i=0;i<numTemplateUnits;i++){if(rowAttributes.getTitle(i).getUnitId()===this.wpLookupAttId){return true;}}return false;},cleanDensityMap:function cleanDensityMap(){if(this.densityLayer){this.densityLayer.setMap(null);this.densityLayer=null;}},clearAffinityAnimationObjects:function clearAffinityAnimationObjects(){if(this._animationMarkers){var len=this._animationMarkers.length;for(i=0;i<len;i++){this._animationMarkers[i].setMap(null);}for(i=len;i>0;i--){this._animationMarkers.pop();}}this._selectedAffinityMarkers=null;this._affinityAnimationFinished=false;},clearAffinityLines:function clearAffinityLines(){if(!this._affinityLines){return ;}for(id in this._affinityLines){var polyline=this._affinityLines[id];polyline.setMap(null);}},clearAllHighlight:function clearAllHighlight(){var i,j;for(i in this.highlightedGraphics){if(this.highlightedGraphics[i] instanceof Array){var highlightedGraphics=this.highlightedGraphics[i];var hilightCount=highlightedGraphics.length;for(j=0;j<hilightCount;j++){var g=highlightedGraphics[j];this.clearHighlight(g);}}}},clearPath:function clearPath(){if(!this.pathObject.pathLines){return ;}for(line in this.pathObject.pathLines){this.pathObject.pathLines[line].setMap(null);}this.pathObject.pathLabel.setMap(null);},computeSecondaryDPMetricMax:function computeSecondaryDPMetricMax(metricColumnIndex){if(!this.secondaryDPMetricMaxVal){this.secondaryDPMetricMaxVal={};}if(this.secondaryDPMetricMaxVal.hasOwnProperty(metricColumnIndex)){return ;}var rowIndex=0,maxValue=-Infinity,secModel=this.getMapModel(SECONDARY_DATA_PROVIDER),rowCount=secModel.getTotalRows(),cell;for(rowIndex=0;rowIndex<rowCount;rowIndex++){cell=secModel.getMetricValue(rowIndex,metricColumnIndex);if(cell.getValue()){var cellNumber=parseFloat(!cell.getRawValue()?this.stripNumberFormat(cell.getValue()):cell.getRawValue());maxValue=(cellNumber>maxValue)?cellNumber:maxValue;}}this.secondaryDPMetricMaxVal[metricColumnIndex]={max:maxValue};},createAffinityAnimationMarker:function createAffinityAnimationMarker(latLng){var markerImage=new google.maps.MarkerImage(GLOW_MARKER,null,null,null,new google.maps.Size(10,8));return new google.maps.Marker({position:latLng,icon:markerImage,map:this.map});},createDensityMap:function createDensityMap(){this.cleanDensityMap();this.densityLayer=new mstrmojo.gmaps.DensityOverlay({width:parseInt(this.parent.width),height:parseInt(this.parent.height),map:this.map,mapViewer:this,themeId:this.wpDensityTheme,bounds:this.bounds,locations:this.densityLocations,originalzIndex:this.layerIndex});},createGridInfoWindow:function createGridInfoWindow(dataRows,table){var parent=this.parent,table=parent.infoTabDiv.childNodes[0],css="gridInfoWindowTable googleInfoWindow",cell,header,tui,idx,td,titleSpan,i,j,k,tr,priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),numRowAttributes=priModel.getRowHeaders(0).size(),numColAttributes=priModel.getTotalCols(),titles=priModel.getRowTitles(),colHeaders=priModel.getColHeaders(0),numRows=dataRows.length,rowIndex,rowHeaders,numMetrics=priModel.getColumnHeaderCount(),numAttributes=priModel.getRowHeaders(0).size();while(table.rows.length>0){table.deleteRow(table.rows.length-1);}table.className=css;if(table.tHead){var thead=table.tHead;while(thead.rows.length>0){thead.deleteRow(thead.rows.length-1);}tr=thead.insertRow(thead.rows.length);for(i=0;i<numRowAttributes;i++){if(this.canSkipItem(i,this.isIndexGeoPosition)){continue;}td=tr.insertCell(tr.cells.length);titleSpan=document.createElement("span");titleSpan.innerHTML=parent.getAttributeName(i);td.appendChild(titleSpan);}for(i=0;i<numColAttributes;i++){td=tr.insertCell(tr.cells.length);header=colHeaders.getHeader(i);titleSpan=document.createElement("span");titleSpan.innerHTML=header.getName();td.appendChild(titleSpan);}}var tbody=table.tBodies[0],itemSkip=[],lastItemIdx,canSkipItem,me=this;canSkipItem=function(k){if(me.canSkipItem(k,me.isIndexGeoPosition)){return true;}return false;};lastItemIdx=this.getLastItemIdx(itemSkip,numAttributes,canSkipItem);for(i=0;i<numRows;i++){rowIndex=dataRows[i];tr=tbody.insertRow(tbody.rows.length);rowHeaders=priModel.getRowHeaders(rowIndex);for(j=0;j<numAttributes;j++){if(itemSkip[j]){continue;}cell=rowHeaders.getHeader(j);var attributeName="";if(!!cell){idx=cell.getElementIndex();attributeName=cell.getName();}td=tr.insertCell(tr.cells.length);if(numMetrics===0&&j===lastItemIdx){td.className="lastTD";}td.innerHTML="    "+attributeName+"    ";}for(k=0;k<numMetrics;k++){var metricValues=priModel.getMetricValue(rowIndex,k),metricValue=metricValues.getValue(),thresholdType=metricValues.getThresholdType();td=tr.insertCell(tr.cells.length);if(k===numMetrics-1){td.className="lastTD";}if(!thresholdType||thresholdType===this.enumNumber){td.innerHTML="    "+metricValue+"    ";}else{td.innerHTML="    "+metricValues.getRawValue()+"    ";}}}return table;},createInfoWindow:function createInfoWindow(title,content){var s;s='<div id="infoWindow" class="mstrMapButton" style="max-width:640px;font-size:8pt;">';s+=this.getInfoWindowNavigationHTML(title);if(title){s+='<div id="title" style="line-height:16px;white-space:nowrap"><b>'+title+"</b></div>";}if(title||this.cluster.length>1){s+='<div id="bodyContent" style="border-top: 2px solid #C0C0C0; padding: 3px;">';}else{s+='<div id="bodyContent" >';}s+=content+"</div>";s+="</div>";return s;},createLatLngMarker:function createLatLngMarker(){if(!this.map){return ;}this.defaultInfoWindowHTML=this.getDefaultInfoWindowTemplate();if(this.infoWindowHTML===""){this.infoWindowHTML=this.defaultInfoWindowHTML;}var markerList=this.getGeoList(this.latColumnIndex);markerList.length=0;var priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),rowAttributes=priModel.getRowTitles(),colCount=priModel.getTotalCols(),colHeaderRowCount=priModel.getTotalColHeaderRows(),rowHeaderElements,rowCount=priModel.getTotalRows(),strippedElementID,attrId,nextElementIndex=Math.max(this.latColumnIndex,this.longColumnIndex)+1,marker,latitudeTitleIndex,latitude,latitudeId,latitudeElement,longitudeTitleIndex,longitude,longitudeId,longitudeElement,rowIndex,dlTextName,geoAttrIndics=this.geoAttrIndics,idkey,s="",markersCounter=0;this._markerElementIDs=new Object();this.populateBubbleVariables();for(rowIndex=rowCount-1;rowIndex>=0;rowIndex--){rowHeaderElements=priModel.getRowHeaders(rowIndex);latitudeElement=rowHeaderElements.getHeader(this.latColumnIndex);if(!latitudeElement||latitudeElement.getElementIndex()<0){continue;}latitudeTitleIndex=this.latColumnIndex;latitude=this.stripNumberFormat(latitudeElement.getName());latitudeId=latitudeElement.getElementId();if(latitudeId.indexOf("DB:")===0){continue;}longitudeElement=rowHeaderElements.getHeader(this.longColumnIndex);if(!longitudeElement||longitudeElement.getElementIndex()<0){continue;}longitudeTitleIndex=this.longColumnIndex;longitude=this.stripNumberFormat(longitudeElement.getName());longitudeId=longitudeElement.getElementId();if(longitudeId.indexOf("DB:")===0){continue;}if(isNaN(latitude)){continue;}if(isNaN(longitude)){continue;}if(!this.isValidLatLng(latitude,longitude)){continue;}if(this._useAttribute){if(!this.isAggregate){idkey=rowIndex;}else{idkey=latitudeId+"|"+longitudeId;}}else{if(!this.wpAggregateAttributeForm){idkey=rowIndex;}else{idkey=latitudeId;}}marker=null;if(this.idMarkerMap[idkey]){if((this.wpMarkerType===$EnumMarkerType.Bubble||this.wpMarkerType===$EnumMarkerType.Path)&&this.isTotal(nextElementIndex,rowIndex)){marker=this.idMarkerMap[idkey];}else{continue;}}attrId=latitudeElement.getElementId();if(this._useAttribute&&this.lookupColumnIndex>=0){strippedElementID=this.getElementIdWithoutAttributeID(rowHeaderElements.getHeader(this.lookupColumnIndex).getElementId());}else{strippedElementID=this.getElementIdWithoutAttributeID(attrId);}var attributes={},i,titleIndex,elementValue;dlTextName="";for(i=0;i<rowHeaderElements.size();i++){titleIndex=i;elementValue=rowHeaderElements.getHeader(titleIndex).getName();attributes[this.parent.replaceSpace(rowAttributes.getTitle(titleIndex).getName())]=elementValue;if(titleIndex===this._displayTitleIndex){attributes.NAME=elementValue;}if(geoAttrIndics.indexOf(i)>=0){dlTextName+=!dlTextName?elementValue:" "+elementValue;}}var columnHeaderName,columnHeaderColumnIndex,columnHeaderRowIndex;for(columnHeaderColumnIndex=0;columnHeaderColumnIndex<colCount;columnHeaderColumnIndex++){columnHeaderName=null;for(columnHeaderRowIndex=0;columnHeaderRowIndex<colHeaderRowCount;columnHeaderRowIndex++){var cellElement=priModel.getColHeaders(columnHeaderRowIndex).getHeader(columnHeaderColumnIndex),cellName=cellElement.getName();if(!columnHeaderName){columnHeaderName=cellName;}else{columnHeaderName+=" "+cellName;}}var values=priModel.getMetricValue(rowIndex,columnHeaderColumnIndex),thresholdType=values.getThresholdType();if(!thresholdType||thresholdType===this.enumNumber){attributes[this.parent.replaceSpace(columnHeaderName)]=values.getValue();}else{attributes[this.parent.replaceSpace(columnHeaderName)]=values.getRawValue();}if(rowIndex===0){s+="<b>"+columnHeaderName+"</b> :${"+this.parent.replaceSpace(columnHeaderName)+"}<br />";}}attributes.rowIndex=rowIndex;attributes.geoIndex=latitudeElement.getElementIndex();attributes.id=attrId;attributes.layerKey=this.k;attributes.dlTextName=dlTextName;var latLng=new google.maps.LatLng(latitude,longitude);this.parent.updateMinMaxLatLng(latLng);attributes.latLng=latLng;this._markerElementIDs[strippedElementID]=latLng;s=this.createSimpleInfoHTML(rowIndex,attributes);this.addMarker(markerList,latLng,attributes,s,[this.latColumnIndex,this.longColumnIndex],rowIndex,idkey,marker);markersCounter++;}if(markersCounter==0){this.parent.map.setZoom(1);this.parent.map.setCenter(new google.maps.LatLng(31,-10));}else{if(this.createMode==true){this.parent.updateMapExtent(this.loadByGridChange);}}if(this.isDensityMap()){this.createDensityMap();}else{this.doPostViewerRenderComplete();}this.doPostMapRendering();},createPointMarker:function createPointMarker(){if(!this.map){return ;}this.defaultInfoWindowHTML=this.getDefaultInfoWindowTemplate();this.infoWindowHTML=this.defaultInfoWindowHTML;var markerList=this.getGeoList(this.pointColumnIndex);markerList.length=0;var priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),rowAttributes=priModel.getRowTitles(),rowCount=priModel.getTotalRows(),colCount=priModel.getTotalCols(),colHeaderRowCount=priModel.getTotalColHeaderRows(),s="",marker,leftParenIndex,rightParenIndex,coreString,strippedElementID,attrId,rowHeaderElements,pointElement,pointTitleIndex,point,pointId,leftParenIndex,rightParenIndex,elems,rowIndex,dlTextName,geoAttrIndics=this.geoAttrIndics,longitude,latitude,columnHeaderName,columnHeaderColumnIndex,columnHeaderRowIndex,markersCounter=0;this.populateBubbleVariables();this._markerElementIDs=new Object();for(rowIndex=0;rowIndex<rowCount;rowIndex++){rowHeaderElements=priModel.getRowHeaders(rowIndex);pointElement=rowHeaderElements.getHeader(this.pointColumnIndex);if(!pointElement||pointElement.getElementIndex()<0){continue;}pointTitleIndex=this.pointColumnIndex;point=pointElement.getName();pointId=pointElement.getElementId();marker=null;if((this._useAttribute&&this.isAggregate)||(!this._useAttribute&&this.wpAggregateAttributeForm)){if(this.idMarkerMap[pointId]){if((this.wpMarkerType===$EnumMarkerType.Bubble||this.wpMarkerType===$EnumMarkerType.Path)&&this.isTotal(this.pointColumnIndex+1,rowIndex)){marker=this.idMarkerMap[pointId];}else{continue;}}}if(this._useAttribute&&this.lookupColumnIndex>=0){attrId=rowHeaderElements.getHeader(this.lookupColumnIndex).getElementId();strippedElementID=this.getElementIdWithoutAttributeID(attrId);}else{strippedElementID=this.getElementIdWithoutAttributeID(pointId);}leftParenIndex=point.indexOf("(");if(leftParenIndex<0){continue;}rightParenIndex=point.indexOf(")",leftParenIndex);if(rightParenIndex<0){continue;}coreString=point.substring(leftParenIndex+1,rightParenIndex);elems=coreString.split(" ");if(!elems||elems.length!=2){continue;}longitude=this.stripNumberFormat(elems[0]);latitude=this.stripNumberFormat(elems[1]);if(isNaN(latitude)||isNaN(longitude)){continue;}var attributes={},i,titleIndex,elementValue;dlTextName="";for(i=0;i<rowHeaderElements.size();i++){titleIndex=i;elementValue=rowHeaderElements.getHeader(titleIndex).getName();attributes[this.parent.replaceSpace(rowAttributes.getTitle(titleIndex).getName())]=elementValue;if(geoAttrIndics.indexOf(i)>=0){dlTextName+=!dlTextName?elementValue:" "+elementValue;}}if(this._useAttribute){attributes.id=attrId;}else{attributes.id=pointId;}for(columnHeaderColumnIndex=0;columnHeaderColumnIndex<colCount;columnHeaderColumnIndex++){columnHeaderName=null;for(columnHeaderRowIndex=0;columnHeaderRowIndex<colHeaderRowCount;columnHeaderRowIndex++){var cellElement=priModel.getColHeaders(columnHeaderRowIndex).getHeader(columnHeaderColumnIndex),cellName=cellElement.getName();if(!columnHeaderName){columnHeaderName=cellName;}else{columnHeaderName+=" "+cellName;}}var values=priModel.getMetricValue(rowIndex,columnHeaderColumnIndex),thresholdType=values.getThresholdType();if(!thresholdType||thresholdType===this.enumNumber){attributes[this.parent.replaceSpace(columnHeaderName)]=values.getValue();}else{attributes[this.parent.replaceSpace(columnHeaderName)]=values.getRawValue();}if(rowIndex===0){s+="<b>"+columnHeaderName+"</b> :${"+this.parent.replaceSpace(columnHeaderName)+"}<br />";}}attributes.rowIndex=rowIndex;attributes.geoIndex=pointElement.getElementIndex();attributes.layerKey=this.k;attributes.dlTextName=dlTextName;var latLng=new google.maps.LatLng(latitude,longitude);this.parent.updateMinMaxLatLng(latLng);s=this.createSimpleInfoHTML(rowIndex,attributes);this.addMarker(markerList,latLng,attributes,s,this.pointColumnIndex,rowIndex,pointId,marker);this._markerElementIDs[strippedElementID]=latLng;markersCounter++;}if(markersCounter==0){this.parent.map.setCenter(new google.maps.LatLng(31,-10));this.parent.map.setZoom(1);}else{if(this.createMode==true){this.parent.updateMapExtent(this.loadByGridChange);}}},canSkipItem:function canSkipItem(idx,isGeoElement){var priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),rowTitles=priModel.getRowTitles(),tooltipElements=this.dropZones.tooltips,unitId=rowTitles.getTitle(idx).getUnitId();if(!tooltipElements||mstrmojo.array.indexOf(tooltipElements,unitId)<0){if(isGeoElement.call(this,idx)){return true;}}return false;},getLastItemIdx:function getLastItemIdx(itemSkip,itemNum,canSkipItem){var k;for(k=0;k<itemNum;k++){if(canSkipItem(k)){itemSkip[k]=true;}else{itemSkip[k]=false;}}for(k=itemNum-1;k>=0;k--){if(!itemSkip[k]){break;}}return k;},createSimpleInfoHTML:function createSimpleInfoHTML(rowIndex,attributes){var rowCellTitle,rowCellValue,k,j,s="",priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),parent=this.parent,rowHeaders=priModel.getRowHeaders(rowIndex),rowTitles=priModel.getRowTitles(),colTitle=priModel.getColTitles(),colHeaderCount=priModel.getColumnHeaderCount(),showMetric=this.showMetric(),headerSize=rowHeaders.size(),itemSkip=[],lastAttrIdx,canSkipItem,me=this;var fnAddRow=function(title,value,lastRow){var stylePrefix="<tr><th>";if(!!lastRow){stylePrefix='<tr class="lastRow"><th>';}return stylePrefix+title+" :</th><td> "+value+"</td></tr>";};canSkipItem=function(k){if(me.canSkipItem(k,function(k){if(!!me.dropZones.geoAttribute&&(k===me.latColumnIndex||k===me.longColumnIndex||k===me.pointColumnIndex)){return true;}return false;})){return true;}return false;};lastAttrIdx=this.getLastItemIdx(itemSkip,headerSize,canSkipItem);for(k=0;k<headerSize;k++){rowCellTitle=rowTitles.getTitle(k).getName();if(itemSkip[k]){continue;}rowCellValue=rowHeaders.getHeader(k).getName();attributes[parent.replaceSpace(rowCellTitle)]=rowCellValue;s+=fnAddRow(parent.getAttributeName(k),rowCellValue,!showMetric&&(k===lastAttrIdx));}if(colTitle.size()===1&&colTitle.getTitle(0).getUnitDssType()===-1){rowHeaders=colTitle.getTitle(0).getHeaderValues();for(j=0;j<colHeaderCount;j++){var dataRow=priModel.getMetricValue(rowIndex,j);rowCellTitle=rowHeaders[j].n;rowCellValue=dataRow.getValue();var thresholdType=dataRow.getThresholdType();var isLastRow=j<colHeaderCount-1?false:true;if(!thresholdType||thresholdType===this.enumNumber){s+=fnAddRow(rowCellTitle,rowCellValue,isLastRow);attributes[parent.replaceSpace(rowCellTitle)]=rowCellValue;}else{s+=fnAddRow(rowCellTitle,dataRow.getRawValue(),isLastRow);attributes[parent.replaceSpace(rowCellTitle)]=dataRow.getRawValue();}}}return"<div style='overflow:hidden'><table class=\"nonGridInfoWindow\">"+s+"</table></div>";},doAffinityAnimation:function doAffinityAnimation(){var that=this;this._glowTimer=setTimeout(function(){that.moveAffinityAnimationMarker();},50);},doDrill:function doDrill(index){this.performDrill(index);},doPostMapRendering:function doPostMapRendering(){if(this.isPath()){this.clearPath();this.drawPath();}},drawAffinityLinesUsingSecondaryDataProvider:function drawAffinityLinesUsingSecondaryDataProvider(){var secModel=this.getMapModel(SECONDARY_DATA_PROVIDER);if(!secModel){mstrmojo.alert("Secondary data provider could not be found. In order to see the Affinity Lines, please reset the secondary data provider in the design mode.",null,"Affinity Lines Error");return ;}if(this.findSecondaryDPAttrColIndexes()===-1){return ;}if(this._useAttribute&&!this.checkLookUpAttributeInSecondaryDP()){mstrmojo.alert("Lookup Attribute must be present in the affinity data provider.",null,"Affinity Lines Error");return ;}var sourceAttrElementID,destAttrElementID,lineColor,lineThickness,secondMetricIndex,cell,polyline,maxLineThickness=this.wpMaxLineThickness,rowCount=secModel.getTotalRows();if(secModel.getColTitles().size()===0){mstrmojo.alert("No Metric is present on the secondary data provider.",null,"Affinity Lines Error");return ;}secondMetricIndex=this.findSecondaryDPSecondMetricIndex();this.computeSecondaryDPMetricMax(0);this.clearAffinityLines();this._affinityLines=new Object();if(!this.AFFINITY_LINE_DEFAULT_COLOR){this.AFFINITY_LINE_DEFAULT_COLOR=this.parent.getNextDefaultAffinityLineColor();}for(rowIndex=0;rowIndex<rowCount;rowIndex++){var rowHeaderElements=secModel.getRowHeaders(rowIndex);var firstAttrElementHeader=rowHeaderElements.getHeader(this.secondaryDPFirstAttrColIndex);var secondAttrElementHeader=rowHeaderElements.getHeader(this.secondaryDPSecondAttrColIndex);sourceAttrElementID=this.getElementIdWithoutAttributeID(firstAttrElementHeader.getElementId());destAttrElementID=this.getElementIdWithoutAttributeID(secondAttrElementHeader.getElementId());if(!this._markerElementIDs[sourceAttrElementID]||!this._markerElementIDs[destAttrElementID]){continue;}lineColor=this.getThresholdString(rowIndex,this.selectedMetricIndex,this.AFFINITY_LINE_DEFAULT_COLOR,true,secModel);if(secondMetricIndex!=-1){lineColor=this.getThresholdString(rowIndex,secondMetricIndex,lineColor,true,secModel);}cell=secModel.getMetricValue(rowIndex,0);if(cell.getValue()){metricCellValue=parseFloat(!cell.getRawValue()?this.stripNumberFormat(cell.getValue()):cell.getRawValue());lineThickness=(metricCellValue*maxLineThickness)/this.secondaryDPMetricMaxVal[0]["max"];}else{lineThickness=1;}polyline=new google.maps.Polyline({path:[this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]],icons:[{icon:{path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,scale:1.8,strokeColor:lineColor},offset:"0%",repeat:"10%"}],geodesic:(this.wpDrawArcsLines==="Arcs"),strokeColor:lineColor,strokeOpacity:1,strokeWeight:lineThickness});this._affinityLines[sourceAttrElementID+destAttrElementID]=polyline;polyline.setMap(this.map);}},drawPath:function drawPath(){var projection=this.parent.overlay.getProjection();if(!projection){return ;}this.clearPath();var count=0;var bubbles=[],latlng=[];this.pathObject.pathLines=[];var currentBubbleRadius,nextBubbleRadius,currentBubbleCenterXCoordinate,currentBubbleCenterYCoordinate,nextBubbleCenterXCoordinate,nextBubbleCenterYCoordinate,center;var points1,points2,latlng1,latlng2,upperTangentPath=[],lowerTangentPath=[],originalPath=[];var markerList=this.getGeoList(this.latColumnIndex);this.pathObject.pathBubbles=markerList;var currentBubbleLatLng,nextBubbleLatLng;var polyFillColor=this.pathObject.pathFillColor;var labelPos=markerList[0].attributes.latLng;var labelxPos=projection.fromLatLngToContainerPixel(labelPos).x;for(var i=0;i<markerList.length-1;i++){markerList[i].setMap(null);currentBubbleLatLng=markerList[i].attributes.latLng;originalPath.push(currentBubbleLatLng);center=projection.fromLatLngToContainerPixel(currentBubbleLatLng);currentBubbleCenterXCoordinate=center.x;currentBubbleCenterYCoordinate=center.y;currentBubbleRadius=markerList[i].getRadius();if(labelxPos<currentBubbleCenterXCoordinate){labelxPos=currentBubbleCenterXCoordinate;labelPos=currentBubbleLatLng;}nextBubbleLatLng=markerList[i+1].attributes.latLng;center=projection.fromLatLngToContainerPixel(nextBubbleLatLng);nextBubbleCenterXCoordinate=center.x;nextBubbleCenterYCoordinate=center.y;nextBubbleRadius=markerList[i+1].getRadius();points1=this.getTangentPoints(currentBubbleRadius,nextBubbleRadius,currentBubbleCenterXCoordinate,currentBubbleCenterYCoordinate,nextBubbleCenterXCoordinate,nextBubbleCenterYCoordinate);currentBubbleRadius=currentBubbleRadius*-1;nextBubbleRadius=nextBubbleRadius*-1;points2=this.getTangentPoints(currentBubbleRadius,nextBubbleRadius,currentBubbleCenterXCoordinate,currentBubbleCenterYCoordinate,nextBubbleCenterXCoordinate,nextBubbleCenterYCoordinate);latlng1=projection.fromContainerPixelToLatLng(points1[0],true);latlng2=projection.fromContainerPixelToLatLng(points1[1],true);lowerTangentPath.push(latlng2);lowerTangentPath.push(latlng1);latlng1=projection.fromContainerPixelToLatLng(points2[0],true);latlng2=projection.fromContainerPixelToLatLng(points2[1],true);upperTangentPath.push(latlng2);upperTangentPath.push(latlng1);}var that=this;for(i=0;i<upperTangentPath.length-1;i++){var polygon=new google.maps.Polygon({paths:[upperTangentPath[i],upperTangentPath[i+1],lowerTangentPath[i+1],lowerTangentPath[i]],strokeColor:polyFillColor,strokeWeight:1,strokeOpacity:0,fillColor:polyFillColor,fillOpacity:1});polygon._bubbleIndex=Math.floor(i/2);this.viewerEventListeners.push(google.maps.event.addListener(polygon,"click",function(event){var markerList=that.getGeoList(that.getGeoColumnIndex());var bubble;for(var ind in markerList){bubble=markerList[ind];bubble.setMap(that.map);}if(that.clearHighlights){that.clearHighlights();}}));this.pathObject.pathLines.push(polygon);}this.pathObject.pathCurrentPolygonIndex=0;this.pathObject.pathTimer=setTimeout(function(){that.animatePath();},75);this.pathObject.pathLabel=new mstrmojo.gmaps.TextMarker({labelText:this.getViewerGridName(),clickable:true,position:labelPos,map:this.map,labelClass:"pathLabel",labelOffset:new google.maps.Size(-20,10)});this.viewerEventListeners.push(google.maps.event.addListener(this.pathObject.pathLabel,"click",function(event){that.pathObject.pathLabelTimer=setTimeout(function(){that.animatePathBubbles();},50);that.pathObject.animatePathBubbleIndex=0;if(that.clearHighlights){that.clearHighlights();}}));},getPathArrowColor:function getPathArrowColor(color){var hsv=mstrmojo.color.hex2hsv(color);var rgb=mstrmojo.color.hsv2rgb(hsv[0],hsv[1],(hsv[2]*0.8)%100);return"#"+mstrmojo.color.rgb2hex(rgb[0],rgb[1],rgb[2]);},drawRectangleEnd:function drawRectangleEnd(searchBounds,selectionType){if(this.visible&&(this.enableLatLng||this.enablePoint)){this.rectangleMarkerSearch(searchBounds,selectionType);if(this.parent._affinityGlow){if(!this._selectedAffinityMarkers){this._selectedAffinityMarkers=new Object();}var highlightedGraphics=this.getHighlightedGraphics(this.latColumnIndex);var sourceIds=new Object();for(marker in highlightedGraphics){var id=highlightedGraphics[marker].attributes.id;sourceIds[this.getElementIdWithoutAttributeID(id)]=id;}this.startAffinityLinesAnimation(sourceIds);}}},findCluster:function findCluster(latlng,width,height){var bounds=this.parent.createClusterBounds(latlng,width,height);var markerList=[];if(this.enableLatLng){markerList=this.getGeoList(this.latColumnIndex);}else{if(this.enablePoint){markerList=this.getGeoList(this.pointColumnIndex);}}var i;for(i=0;i<markerList.length;i++){marker=markerList[i];markerLatLng=marker.getPosition();geoIndex=marker.attributes.geoIndex;rowIndex=marker.attributes.rowIndex;var markerSelected=mstrmojo.array.indexOf(this.cluster,marker);if((markerSelected<0)&&bounds.contains(markerLatLng)){this.cluster.push(marker);}}},findLatLngPositionAttribute:function findLatLngPositionAttribute(){this.enableLatLng=false;var rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),latAttrId=this.wpLat,longAttrId=this.wpLng,i,attrId;for(i=0;i<numTemplateUnits;i++){attrId=rowAttributes.getTitle(i).getUnitId();if(attrId===latAttrId){this.columnIndices.Lat=i;this.latColumnIndex=i;}else{if(attrId===longAttrId){this.columnIndices.Long=i;this.longColumnIndex=i;}}if(attrId===this.wpLookupAttId){this.lookupColumnIndex=i;}}this.enableLatLng=((this.latColumnIndex!=-1)&&(this.longColumnIndex!=-1));return this.enableLatLng;},findLatLngPositionForm:function findLatLngPositionForm(){this.enableLatLng=false;var rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),latFormId=this.wpLat,longFormId=this.wpLng,attrId=this.wpAttribute,geoAttrIndics=this.geoAttrIndics,i,title,formId;for(i=0;i<numTemplateUnits;i++){title=rowAttributes.getTitle(i);if(title.getUnitId()===attrId){formId=title.getFormId();if(formId===latFormId){this.columnIndices.Lat=i;this.latColumnIndex=i;}else{if(formId===longFormId){this.columnIndices.Long=i;this.longColumnIndex=i;}else{geoAttrIndics.push(i);}}}}this.enableLatLng=((this.latColumnIndex!=-1)&&(this.longColumnIndex!=-1));return this.enableLatLng;},findNumAttributes:function findNumAttributes(){var attrList=[],rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),i;this.numAttributes=0;for(i=0;i<numTemplateUnits;i++){if(mstrmojo.array.indexOf(attrList,rowAttributes.getTitle(i).getUnitId())<0){attrList.push(rowAttributes.getTitle(i).getUnitId());this.numAttributes++;}}},findPointPositionAttribute:function findPointPositionAttribute(){this.enablePoint=false;var rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),pointAttrId=this.wpPoint,i,id;for(i=0;i<numTemplateUnits;i++){id=rowAttributes.getTitle(i).getUnitId();if(id===pointAttrId){this.columnIndices.Point=i;this.pointColumnIndex=i;}if(id===this.wpLookupAttId){this.lookupColumnIndex=i;}}this.enablePoint=this.pointColumnIndex!=-1;return this.enablePoint;},findPointPositionForm:function findPointPositionForm(){this.enablePoint=false;var rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),pointFormId=this.wpPoint,attrId=this.wpAttribute,geoAttrIndics=this.geoAttrIndics,i,title;for(i=0;i<numTemplateUnits;i++){title=rowAttributes.getTitle(i);if(title.getUnitId()===attrId){if(title.getFormId()===pointFormId){this.columnIndices.Point=i;this.pointColumnIndex=i;}else{geoAttrIndics.push(i);}}}this.enablePoint=this.pointColumnIndex!=-1;return this.enablePoint;},findSecondaryDPAttrColIndexes:function findSecondaryDPAttrColIndexes(){var rowAttributes=this.getMapModel(SECONDARY_DATA_PROVIDER).getRowTitles(),attrId=rowAttributes.getTitle(0).getUnitId(),size=rowAttributes.size(),i;this.secondaryDPFirstAttrColIndex=0;for(i=1;i<size;i++){if(rowAttributes.getTitle(i).getUnitId()!=attrId){this.secondaryDPSecondAttrColIndex=i;break;}}return this.secondaryDPSecondAttrColIndex;},findSecondaryDPSecondMetricIndex:function findSecondaryDPSecondMetricIndex(){var colAttributes=this.getMapModel(SECONDARY_DATA_PROVIDER).getColTitles().getTitle(0).getHeaderValues();return(colAttributes.length>1)?1:-1;},getBounds:function getBounds(){return this.bounds;},getColumnHeaderByIndex:function getColumnHeaderByIndex(colIndex){if(!this.isValidColIndex(colIndex)){return"invalid column index";}var columnHeaders=this.getMapModel(PRIMARY_DATA_PROVIDER).getColTitles(),numColumnHeaders=columnHeaders.size(),columnHeaderString=columnHeaders.getTitle(0).getHeaderValues()[colIndex].n,i;for(i=0;i<numColumnHeaders;i++){columnHeaderString+=" "+columnHeaders.getTitle(i).getHeaderValues()[colIndex].n;}return columnHeaderString;},getCurrentSelections:function getCurrentSelection(columnIndex){if(!this.currentSelections){this.currentSelections={};}if(!this.currentSelections.hasOwnProperty(columnIndex)){this.currentSelections[columnIndex]=[];}return this.currentSelections[columnIndex];},showMetric:function(){var model=this.getMapModel(PRIMARY_DATA_PROVIDER),colTitles=model.getColTitles();if(colTitles.size()===1&&colTitles.getTitle(0).getUnitDssType()===-1){return true;}return false;},getDefaultInfoWindowTemplate:function getDefaultInfoWindowTemplate(){var contentHTML='<table class="nonGridInfoWindow">',model=this.getMapModel(PRIMARY_DATA_PROVIDER),rowHeaders=model.getRowHeaders(0),rowTitles=model.getRowTitles(),colTitles=model.getColTitles(),rowCellTitle,k,j,size,lastAttrIdx,me=this,parent=this.parent,itemSkip=[],showMetric=this.showMetric();var canSkipItem=function(k){if(me.canSkipItem(k,function(k){if(!!me.dropZones.geoAttribute&&(k===me.latColumnIndex||k===me.longColumnIndex||k===me.pointColumnIndex)){return true;}return false;})){return true;}return false;};size=rowHeaders.size();lastAttrIdx=this.getLastItemIdx(itemSkip,size,canSkipItem);for(k=0;k<size;k++){rowCellTitle=rowTitles.getTitle(k).getName();if(itemSkip[k]){continue;}if(!showMetric&&(k===lastAttrIdx)){contentHTML+='<tr class="lastRow">';}else{contentHTML+="<tr>";}contentHTML+="<th>"+parent.getAttributeName(k)+":</th><td> ${"+parent.replaceSpace(rowCellTitle)+"}</td>";contentHTML+="</tr>";}if(showMetric){rowHeaders=colTitles.getTitle(0).getHeaderValues();for(j=0,size=rowHeaders.length;j<size;j++){contentHTML+=j<rowHeaders.length-1?"<tr>":'<tr class="lastRow">';rowCellTitle=rowHeaders[j].n;contentHTML+="<th>"+rowCellTitle+":</th><td> ${"+parent.replaceSpace(rowCellTitle)+"}</td>";contentHTML+="</tr>";}}contentHTML+="</table>";return contentHTML;},getDrillStatus:function getDrillStatus(){return this.getDrillStatusByColumnIndex(this.latColumnIndex);},getDrillStatusByColumnIndex:function getDrillStatusByColumnIndex(index){var selected=this.getSelectedRowIndices(index);if(selected===undefined||!selected instanceof Array||selected.length===0){return false;}var actionType=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowHeaders(selected[0]).getHeader(index).getActionType();if(actionType===undefined||isNaN(actionType)){return false;}if((actionType&HYPERLINK_ACTION)>0){return true;}if(this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(index).getDrillPath()){return true;}return false;},getElementIDByIndex:function getElementIDByIndex(index,columnIndex){var es=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(columnIndex).getHeaderValues();if(index>=0&&index<es.length){return es[index].id;}return null;},getGeoColumnIndex:function getGeoColumnIndex(){if(this.enableLatLng){return this.latColumnIndex;}if(this.enablePoint){return this.pointColumnIndex;}},getGeoList:function getGeoList(columnIndex){if(!this.geoLists){this.geoLists={};}if(!this.geoLists.hasOwnProperty(columnIndex)){this.geoLists[columnIndex]=[];}return this.geoLists[columnIndex];},getHighlightedGraphics:function getHighlightedGraphics(columnIndex){if(!this.highlightedGraphics){this.highlightedGraphics={};}if(!this.highlightedGraphics.hasOwnProperty(columnIndex)){this.highlightedGraphics[columnIndex]=[];}return this.highlightedGraphics[columnIndex];},getInfoWindowClusterNavigationHTML:function getInfoWindowClusterNavigationHTML(isPrev){var htmlStr="";var isEnabled=isPrev?(this.clusterIndex>0):(this.clusterIndex<this.cluster.length-1);if(this.cluster.length>1){htmlStr='<div id="'+(isPrev?"infoPrev":"infoNext")+'" class="mstrmojo-Button mstrtbMap'+(isPrev?"Prev":"Next");if(isEnabled){htmlStr+='" onclick="mstrmojo.all[\'';htmlStr+=this.id;htmlStr+="']."+(isPrev?"getPrev":"getNext")+"();return false;";}else{htmlStr+=" disabled";}htmlStr+='" ></div>';}return htmlStr;},getInfoWindowNavigationHTML:function getInfoWindowNavigationHTML(title){var s="";if(this.cluster.length>1){s+='<div class="pageTab"><div class="innerNav">';s+=this.getInfoWindowClusterNavigationHTML(true);s+='<div style="color: black; font-size: 8pt; position: absolute; top: 9px; left: 21px;"> ';var ofString=mstrmojo.desc(4891,"## of ###");var resultString=ofString.replace("##",""+(this.clusterIndex+1)).replace("###",""+(this.cluster.length));s+=resultString+"</div>";s+=this.getInfoWindowClusterNavigationHTML(false);s+="</div></div>";}return s;},getMapModel:function(key){return key===PRIMARY_DATA_PROVIDER?this.primaryModel:this.secondaryModel;},getNext:function getNext(){this.clusterIndex++;var mapObj=this.cluster[this.clusterIndex];this.showInfoWindow(mapObj,null,true);},getPrev:function getPrev(){this.clusterIndex--;var mapObj=this.cluster[this.clusterIndex];this.showInfoWindow(mapObj,null,true);},getRowAxisAttributeIndex:function getRowAxisAttributeIndex(columnIndex){var titles=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles();if(typeof (columnIndex)=="undefined"||columnIndex>=titles.size()){return -1;}var attributeIndex=-1,attributeLookup={},i;for(i=0;i<=columnIndex;i++){if(typeof (attributeLookup[titles.getTitle(i).getUnitId()])=="undefined"){attributeLookup[titles.getTitle(i).getUnitId()]=1;attributeIndex++;}}return attributeIndex;},getSelectionInfo:function(sliceInfo){var newIndicesKey=sliceInfo.elementIndex.sort().join("_");if(this.currentSelectedIndex===newIndicesKey){return ;}this.currentSelectedIndex=newIndicesKey;var geoPosition=sliceInfo.pos,geoAttributeSelector=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(geoPosition).getSelectorControl();if(!geoAttributeSelector){return ;}var targetKeys=geoAttributeSelector.tks,controlKeyContext=geoAttributeSelector.ck,controlKey=geoAttributeSelector.ckey,elementsList,elementIDs=[],numElements=sliceInfo.elementIndex.length,itemSeparator="\x1e";var i;for(i=0;i<numElements;i++){elementIDs.push(this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(geoPosition).getHeaderValues()[sliceInfo.elementIndex[i]].id);}elementsList=elementIDs.join(itemSeparator);return{targetKeys:targetKeys,elementsList:elementsList,controlKeyContext:controlKeyContext,controlKey:controlKey};},handleAffinityAnimationMouseClick:function handleAffinityAnimationMouseClick(marker,event){if(!marker){return ;}if(this._affinityAnimationFinished){this.clearAffinityAnimationObjects();}var ctrlKey=event.ctrlKey;if(!this._selectedAffinityMarkers){this._selectedAffinityMarkers=new Object();}if(!ctrlKey){this._selectedAffinityMarkers[marker.attributes.id]=marker;marker.isSelected=true;this.handleAffinityAnimationKeyUp();}else{if(this._selectedAffinityMarkers.hasOwnProperty(marker.attributes.id)){marker.isSelected=false;id=marker.attributes.id;delete this._selectedAffinityMarkers[marker.attributes.id];}else{this._selectedAffinityMarkers[marker.attributes.id]=marker;marker.isSelected=true;}}},handleAffinityAnimationKeyUp:function handleAffinityAnimationKeyUp(){if(!this._affinityAnimationFinished&&this.parent._affinityGlow){var sourceId={},id,marker;for(id in this._selectedAffinityMarkers){sourceId[this.getElementIdWithoutAttributeID(id)]=id;}this.startAffinityLinesAnimation(sourceId);}},getTangentPoints:function getTangentPoints(rA,rB,xA,yA,xB,yB){var points=[new google.maps.Point(),new google.maps.Point()];var cosT=((xA-xB)*(rA-rB)+(yA-yB)*Math.sqrt((xA-xB)*(xA-xB)+(yA-yB)*(yA-yB)-(rA-rB)*(rA-rB)))/((xA-xB)*(xA-xB)+(yA-yB)*(yA-yB));var sinT=((yA-yB)*(rA-rB)-(xA-xB)*Math.sqrt((xA-xB)*(xA-xB)+(yA-yB)*(yA-yB)-(rA-rB)*(rA-rB)))/((xA-xB)*(xA-xB)+(yA-yB)*(yA-yB));points[0].x=xB-rB*cosT;points[0].y=yB-rB*sinT;points[1].x=xA-rA*cosT;points[1].y=yA-rA*sinT;return points;},getViewerGridName:function getViewerGridName(){return this.data.n;},handleDensitySelections:function handleDensitySelections(selections){if(this.clearHighlights){this.clearHighlights();}var columnIndex;if(this._useLatlng){columnIndex=this.latColumnIndex;}else{columnIndex=this.pointColumnIndex;}var markerList=this.getGeoList(columnIndex);var marker;var markerLatLng;var geoIndex;var rowIndex;var markerSelected;var highlightedGraphics=this.getHighlightedGraphics(columnIndex);var currentSelections=this.getCurrentSelections(columnIndex);var selectedRowIndices=this.getSelectedRowIndices(columnIndex);var i;for(i=0;i<selections.length;i++){var attr=selections[i].attributes;geoIndex=attr.geoIndex;rowIndex=attr.rowIndex;markerSelected=mstrmojo.array.indexOf(currentSelections,geoIndex);if(markerSelected>=0){if(this.parent.isCtrl||selectedRowIndices.length<=1){currentSelections.splice(i,1);selectedRowIndices.splice(i,1);this.removeVisSelection(rowIndex);}else{this.removeVisSelection(selectedRowIndices);selectedRowIndices.splice(0,selectedRowIndices.length,rowIndex);currentSelections.splice(0,currentSelections.length,geoIndex);this.addVisSelection(rowIndex);}}else{if(this.parent.isCtrl){currentSelections.push(geoIndex);selectedRowIndices.push(rowIndex);this.addVisSelection(rowIndex);}else{this.removeVisSelection(selectedRowIndices);selectedRowIndices.splice(0,selectedRowIndices.length,rowIndex);currentSelections.splice(0,currentSelections.length,geoIndex);this.addVisSelection(rowIndex);}}}var sliceInfo={pos:[columnIndex],elementIndex:currentSelections,setViewDataFlag:false,applyControl:true,beanPath:this.parent.getBeanPath()};this.command.applySelection(sliceInfo);this.endSelections();},handleMapOnMouseUp:function handleMapOnMouseUp(){if(this.wpMarkerType===$EnumMarkerType.Path){var markerList=this.getGeoList(this.getGeoColumnIndex());for(var i=0;i<markerList.length;i++){markerList[i].setMap(null);}}if(this.previousShownBubble){this.previousShownBubble.set("highlight",false);this.previousShownBubble=null;}},handleMarkerMouseClick:function handleMarkerMouseClick(marker,dp,event){if(this.parent._affinityGlow){this.handleAffinityAnimationMouseClick(dp,event);}else{if(this.parent.enableClickSelect){this.handleSelection(marker,null,null);this.parent.handleSingleSelection(true);if(VisUtil.isOnExpressMode()){this.handlePanelStackInfoWindow(marker,event.latLng);}}}dp._mousedown=false;if(this.clearHighlights){this.clearHighlights();}},handleSelection:function handleSelection(mapObj,isCtrlKey,isAdd){if(!this.parent.enableClickSelect){return ;}var geoIndex=mapObj.attributes.geoIndex,rowIndex=mapObj.attributes.rowIndex,columnIndex,highlightedGraphics,currentSelections,selectedRowIndices,i,sliceInfo,isCtrl=(!!isAdd)||this.parent.isCtrlClick;if(mapObj.geoPosition instanceof Array){columnIndex=mapObj.geoPosition[0];}else{columnIndex=mapObj.geoPosition;}highlightedGraphics=this.getHighlightedGraphics(columnIndex);currentSelections=this.getCurrentSelections(columnIndex);selectedRowIndices=this.getSelectedRowIndices(columnIndex);if(!this.previousState){this.previousState={};this.previousState.columnIndex=columnIndex;this.previousState.currentSelections=currentSelections.slice(0);this.previousState.selectedRowIndices=selectedRowIndices.slice(0);this.previousState.highlightedGraphics=highlightedGraphics.slice(0);this.previousState.mapObjectsState={selectedObj:[],unselectedObj:[]};this.previousState.stateChangedMarker=[];}i=mstrmojo.array.indexOf(currentSelections,geoIndex);if(i!=-1){if(isCtrl||selectedRowIndices.length<=1){currentSelections.splice(i,1);selectedRowIndices.splice(i,1);this.removeVisSelection(rowIndex);if(mstrmojo.array.indexOf(this.previousState.stateChangedMarker,geoIndex)==-1){this.previousState.stateChangedMarker.push(geoIndex);this.previousState.mapObjectsState.selectedObj.push(mapObj);}var graphicIndex=mstrmojo.array.indexOf(highlightedGraphics,mapObj);this.clearHighlight(mapObj);highlightedGraphics.splice(graphicIndex,1);}else{this.removeVisSelection(selectedRowIndices);this.clearAllHighlight();selectedRowIndices.splice(0,selectedRowIndices.length,rowIndex);currentSelections.splice(0,currentSelections.length,geoIndex);highlightedGraphics.splice(0,highlightedGraphics.length,mapObj);this.addVisSelection(rowIndex);this.highlightGraphic(mapObj);}}else{if(isCtrl){currentSelections.push(geoIndex);selectedRowIndices.push(rowIndex);highlightedGraphics.push(mapObj);this.addVisSelection(rowIndex);}else{this.removeVisSelection(selectedRowIndices);this.clearAllHighlight();selectedRowIndices.splice(0,selectedRowIndices.length,rowIndex);currentSelections.splice(0,currentSelections.length,geoIndex);highlightedGraphics.splice(0,highlightedGraphics.length,mapObj);this.addVisSelection(rowIndex);}if(mstrmojo.array.indexOf(this.previousState.stateChangedMarker,geoIndex)==-1){this.previousState.stateChangedMarker.push(geoIndex);this.previousState.mapObjectsState.unselectedObj.push(mapObj);}this.highlightGraphic(mapObj);}sliceInfo={pos:[columnIndex],elementIndex:currentSelections,setViewDataFlag:false,applyControl:true,beanPath:this.parent.getBeanPath()};this.savedSliceInfo=sliceInfo;return currentSelections;},initMapProperty:function initMapProperty(){var geoName;for(geoName in this.columnIndices){if(this.columnIndices.hasOwnProperty(geoName)){this.columnIndices[geoName]=-1;}}this.bounds=new google.maps.LatLngBounds();},isAffinityLinesEnabled:function isAffinityLinesEnabled(){return this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0";},isDensityMap:function isDensityMap(){return(this.wpMarkerType===$EnumMarkerType.Density);},isIndexGeoPosition:function isIndexGeoPosition(index){return(this.latColumnIndex===index)||(this.longColumnIndex===index);},isPath:function isPath(){return(this.wpMarkerType===$EnumMarkerType.Path);},isTotal:function isTotalCell(nextColumnIndex,rowIndex){var rowHeaderElements=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowHeaders(rowIndex),nextCellElement=rowHeaderElements.getHeader(nextColumnIndex),nextElementId;if(!nextCellElement){return false;}nextElementId=nextCellElement.getElementId();if(nextElementId.indexOf("DB:")===0){return true;}return false;},isValidColIndex:function isValidColIndex(colIndex){var firstRowOfColumnHeader=this.getMapModel(PRIMARY_DATA_PROVIDER).getColTitles().getTitle(0).getHeaderValues();return(colIndex>=0&&colIndex<firstRowOfColumnHeader.length);},latlngDrill:function latlngDrill(){this.doDrill(this.latColumnIndex);},loadWidgetProps:function loadWidgetProps(){var props=this.widgetProps;if(!props){return false;}var property=props.af;if(property){this._useAttribute=(property==="0");}property=props.gr;if(property){this._useLatlng=(property==="0");}if(!this._useAttribute){this.wpAttribute=this.dropZones.geoAttribute;}if(this._useLatlng){this.wpLat=this.dropZones.latitude;this.wpLng=this.dropZones.longitude;}else{this.wpPoint=props.fpt;}property=props.mtp;if(property){this.wpMarkerType=property;this.bubbleMode=this.wpMarkerType==$EnumMarkerType.Bubble||this.wpMarkerType==$EnumMarkerType.Path;if(this.isDensityMap()){if(this.parent.isCanvasSupported()){this.wpDensityTheme=parseInt(props.dms);}else{this.wpMarkerType=$EnumMarkerType.Marker;mstrmojo.alert(mstrmojo.desc(9281,"Density Maps is not supported on this Browser version."));}}else{property=props.mss;if(property){this.wpMapSizingStyle=property;}if(this.wpMarkerType===$EnumMarkerType.Path){property=props.pcp;if(property){this.pathObject.pathFillColor="#"+property;}else{this.pathObject.pathFillColor=this.parent.getNextDefaultAffinityLineColor();}this.maxRadius=this.MAX_PATH_BUBBLE_RADIUS;}}}property=props.mstyl;if(property){this.wpMarkerStyle=property;this.wpMarkerHighlightedStyle=property;}property=props.at;if(property){this.applyThreshold=(property==="1");}property=props.da;if(property){this.wpDisPlayAffinityLines=property;if(this.wpDisPlayAffinityLines!="0"){this.wpDrawArcsLines=props.dal;this.wpMaxLineThickness=props.lwm;}}else{this.wpDisPlayAffinityLines="0";}property=props.dv;if(property){this._defaultView=property;}property=props.dm;if(property){this.isAggregate=(property==="1");}else{if(mstrApp&&mstrApp.isVI){this.isAggregate=true;}}property=props.dmaf;if(property){this.wpAggregateAttributeForm=(property==="1");}else{if(mstrApp&&mstrApp.isVI){this.wpAggregateAttributeForm=true;}}property=props.mbs;if(property){this.maxRadius=parseInt(property)/2;if(this.wpMarkerType===$EnumMarkerType.Path){this.maxRadius=this.MAX_PATH_BUBBLE_RADIUS;}}this.parent.updateMaxBubbleRadius(this.maxRadius);property=props.latt;if(property){this.wpLookupAttId=property;}if(props&&props.iwd){this.infoWindowHTML=unescape(props.iwd);}this._displayTitleIndex=-1;var displayUnitId=this._useAttribute?props.atf:props.satf;if(displayUnitId&&this.primaryModel&&this.primaryModel.getTotalRows()>0){var titles=this.primaryModel.getRowTitles();if(titles){for(var i=0,len=titles.size();i<len;++i){var title=titles.getTitle(i);var unitIdToCheck=this._useAttribute?title.getUnitId():title.getFormId();if(title&&displayUnitId==unitIdToCheck){this._displayTitleIndex=i;break;}}}}},moveAffinityAnimationMarker:function moveAffinityAnimationMarker(){var i,len,arr,marker,interval=this._currentAffinityInterval;for(i=0,len=this._animationSourceMarkerLines.length;i<len;i++){arr=this._animationSourceMarkerLines[i];marker=this._animationMarkers[i];if(interval<this.parent.NO_OF_POINTS){marker.setPosition(arr[interval]);}if(interval===0){marker.setMap(this.map);}}if(interval===this.parent.NO_OF_POINTS-1){for(i=0,len=this._animationMarkers.length;i<len;i++){this._animationMarkers[i].setMap(null);}clearTimeout(this._glowTimer);}else{this._currentAffinityInterval++;this.doAffinityAnimation();}},onAffinityAnimationModeChange:function onAffinityAnimationModeChange(){if(this.wpDisPlayAffinityLines==="0"||!this.getMapModel(SECONDARY_DATA_PROVIDER)){return ;}if(!this.parent._affinityGlow){var polyline;var key;for(key in this._affinityLines){polyline=this._affinityLines[key];polyline.setMap(this.map);}this.clearAffinityAnimationObjects();}},onInfoWindowRendered:function onInfoWindowRendered(evt,pos,ifw,marker){var id=evt.id,w=mstrmojo.all[id],newDiv;if(w){newDiv=this.generateSelectorControlInfoWindowContent(w);}if(pos instanceof google.maps.LatLng){ifw.setContent(newDiv);ifw.setPosition(pos);if(marker instanceof google.maps.Marker){ifw.open(this.map,marker);}else{ifw.open(this.map);}}else{ifw.open(this.map,pos);}},populateMinMax:function populateMinMax(metricColumnIndex){if(!this.minMaxMap){this.minMaxMap={};}var geoColumnIndices,priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),rowAttributes=priModel.getRowTitles(),rowCount=priModel.getTotalRows(),rowIndex=0,minValue=Infinity,maxValue=-Infinity,latitudeElement,latitudeTitleIndex,latitude,latitudeId,longitudeElement,longitudeTitleIndex,longitude,longitudeId,pointElement,pointTitleIndex,point,pointId,leftParenIndex,rightParenIndex,elems,errTitle,err,cell,type,cellNumber;for(rowIndex=0;rowIndex<rowCount;rowIndex++){var rowHeaderElements=priModel.getRowHeaders(rowIndex);if(this.enableLatLng){latitudeElement=rowHeaderElements.getHeader(this.latColumnIndex);if(!latitudeElement||latitudeElement.getElementIndex()<0){continue;}latitudeTitleIndex=this.latColumnIndex;latitude=this.stripNumberFormat(latitudeElement.getName());latitudeId=latitudeElement.getElementId();if(latitudeId.indexOf("DB:")===0){continue;}longitudeElement=rowHeaderElements.getHeader(this.longColumnIndex);if(!longitudeElement||longitudeElement.getElementIndex()<0){continue;}longitudeTitleIndex=this.longColumnIndex;longitude=this.stripNumberFormat(longitudeElement.getName());longitudeId=longitudeElement.getElementId();if(longitudeId.indexOf("DB:")===0){continue;}if(isNaN(latitude)||isNaN(longitude)){continue;}}else{pointElement=rowHeaderElements.getHeader(this.pointColumnIndex);if(!pointElement||pointElement.getElementIndex()<0){continue;}pointTitleIndex=this.pointColumnIndex;point=pointElement.getName();pointId=pointElement.getElementId();if(pointId.indexOf("DB:")===0){continue;}leftParenIndex=point.indexOf("(");if(leftParenIndex<0){continue;}rightParenIndex=point.indexOf(")",leftParenIndex);if(rightParenIndex<0){continue;}coreString=point.substring(leftParenIndex+1,rightParenIndex);elems=coreString.split(" ");if(!elems||elems.length!=2){continue;}latitude=this.stripNumberFormat(elems[0]);longitude=this.stripNumberFormat(elems[1]);if(isNaN(latitude)||isNaN(longitude)){continue;}}cell=priModel.getMetricValue(rowIndex,metricColumnIndex);type=cell.getThresholdType();cellNumber;if(!type||type===this.enumNumber){cellNumber=parseFloat(!cell.getRawValue()?this.stripNumberFormat(cell.getValue()):cell.getRawValue());}else{cellNumber=cell.getRawValue();}if(this.wpMapSizingStyle==="1"&&cellNumber<0){continue;}cellNumber=Math.abs(cellNumber);maxValue=(cellNumber>maxValue)?cellNumber:maxValue;minValue=(cellNumber<minValue)?cellNumber:minValue;}this.minMaxMap[metricColumnIndex]={min:minValue,max:maxValue};},processDrill:function processDrillRequest(){if(this.enableLatLng){this.latlngDrill();}if(this.enablePoint){this.doDrill(this.pointColumnIndex);}},rectangleMarkerSearch:function rectangleMarkerSearch(searchBounds,selectionType){if(!searchBounds){return ;}var columnIndex;if(this._useLatlng){columnIndex=this.latColumnIndex;}else{columnIndex=this.pointColumnIndex;}var markerList=this.getGeoList(columnIndex);var marker;var markerLatLng;var geoIndex;var rowIndex;var markerSelected;var highlightedGraphics=this.getHighlightedGraphics(columnIndex);var currentSelections=this.getCurrentSelections(columnIndex);var selectedRowIndices=this.getSelectedRowIndices(columnIndex);var i;if(this.isDensityMap()){var selection=[],location,position;for(var i=0;i<this.densityLocations.length;i++){location=this.densityLocations[i];position=location.position;if(this.isMarkerInArea(searchBounds,position,selectionType)){selection.push(location);}}for(i=0;i<selection.length;i++){var attr=selection[i].attributes;geoIndex=attr.geoIndex;rowIndex=attr.rowIndex;markerSelected=mstrmojo.array.indexOf(currentSelections,geoIndex);if(markerSelected<0){currentSelections.push(geoIndex);selectedRowIndices.push(rowIndex);this.addVisSelection(rowIndex);}}}else{for(i=0;i<markerList.length;i++){marker=markerList[i];markerLatLng=marker.getPosition();geoIndex=marker.attributes.geoIndex;rowIndex=marker.attributes.rowIndex;markerSelected=mstrmojo.array.indexOf(currentSelections,geoIndex);var isMarkerInArea=this.isMarkerInArea(searchBounds,markerLatLng,selectionType);if((markerSelected<0)&&isMarkerInArea){currentSelections.push(geoIndex);selectedRowIndices.push(rowIndex);this.addVisSelection(rowIndex);this.highlightGraphic(marker);highlightedGraphics.push(marker);}}}if(this.parent._affinityGlow){return ;}var sliceInfo={pos:[columnIndex],elementIndex:currentSelections,setViewDataFlag:false,applyControl:true,beanPath:this.parent.getBeanPath()};this.command.applySelection(sliceInfo);this.endSelections();},isMarkerInArea:function isMarkerInArea(areaObj,markerLatLng,selectionType){if(selectionType==EnumAreaSelectionType.RECTANGLE){return areaObj.getBounds().contains(markerLatLng);}else{if(selectionType==EnumAreaSelectionType.CIRCLE){var radius=areaObj.getRadius();var center=areaObj.getCenter();var distance=google.maps.geometry.spherical.computeDistanceBetween(center,markerLatLng);return distance<=radius?true:false;}else{return google.maps.geometry.poly.containsLocation(markerLatLng,areaObj);}}},render:function renderGridLayer(loadByGridChange,createMode,callbackFunc){this.loadByGridChange=loadByGridChange;if(this.primaryModel.getTotalRows()==0){if(typeof console!==undefined){console.log("No rows returned for this dataset.");}return ;}this.renderCompleteCallbackFunc=callbackFunc;this.visible=true;this.createMode=createMode;this.findNumAttributes();var that=this;this.viewerEventListeners.push(google.maps.event.addListener(this.parent.infowindow,"closeclick",function(){if(that.previousShownBubble){that.previousShownBubble.setBubbleZIndex(that.previousShownBubble.getOriginalBubbleZIndex());that.previousShownBubble.set("highlight",false);}}));this.idMarkerMap={};this.geoAttrIndics=[];this.dataLabelsConfig=[];var validAttributes=false;if(this._useAttribute){if(this._useLatlng){if(this.findLatLngPositionAttribute()){validAttributes=true;this.createLatLngMarker();if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}}}else{if(this.findPointPositionAttribute()){validAttributes=true;this.createPointMarker();if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}}}}else{if(this._useLatlng){if(this.findLatLngPositionForm()){validAttributes=true;this.createLatLngMarker();if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}}}else{if(this.findPointPositionForm()){validAttributes=true;this.createPointMarker();if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}}}}if(!validAttributes){if(console&&console.log){console.log("No Mappable attributes present on the report.");}}this.populateDataLabelMetricValues();this.reBuildDataLebels();},doPostViewerRenderComplete:function doPostViewerRenderComplete(){if(this.renderCompleteCallbackFunc){this.renderCompleteCallbackFunc.call(this.parent);this.renderCompleteCallbackFunc=null;}},resetModel:function resetModel(data){this.primaryModel=null;this.primaryModel=new mstrmojo.models.template.DataInterface(data);this.data=data;this.unrender();this.render();},resetAffinityLinesData:function resetAffinityLinesData(data){this.secondaryModel=null;this.secondaryModel=new mstrmojo.models.template.DataInterface(data);if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}},resolveCustomizedInfoWindow:function resolveCustomizedInfoWindow(attributes){var input=this.infoWindowHTML;var result="";var baseIndex=0;var startIndex=input.indexOf("${",baseIndex);var endIndex=input.indexOf("}",startIndex+1);var macroName;var transformedMacroName;var replaceValue;while(startIndex>=0&&endIndex>startIndex){macroName=input.substring(startIndex+2,endIndex);var colonIndex=macroName.indexOf(":");if(colonIndex>=0){transformedMacroName=macroName.substring(0,colonIndex)+" "+macroName.substring(colonIndex+1);}else{transformedMacroName=macroName;}transformedMacroName=this.parent.replaceSpace(transformedMacroName);if(attributes.hasOwnProperty(transformedMacroName)){result+=input.substring(baseIndex,startIndex)+attributes[transformedMacroName];}else{result+=input.substring(baseIndex,endIndex);}baseIndex=endIndex+1;startIndex=input.indexOf("${",baseIndex);endIndex=input.indexOf("}",startIndex+1);}result+=input.substring(baseIndex,input.length);return result;},retrieveDataRows:function retrieveDataRows(sliceInfo){var dataRows=[];var j,k;if(sliceInfo){var geoElemIdx=parseInt(sliceInfo.elementIndex,10);var pos;if(sliceInfo.pos instanceof Array){pos=sliceInfo.pos;}else{pos=[parseInt(sliceInfo.pos,10)];}if(!this.viewCache){this.viewCache={};}if(this.viewCache[geoElemIdx]){dataRows=this.viewCache[geoElemIdx];}else{var numRows=this.getMapModel(PRIMARY_DATA_PROVIDER).getTotalRows();var validRow;for(k=0;k<numRows;k++){var rowHeader=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowHeaders(k);validRow=true;for(j=0;j<pos.length;j++){var cellHeader=rowHeader.getHeader(pos[j]);if(!cellHeader||cellHeader.getElementIndex()!=geoElemIdx){validRow=false;break;}}if(validRow){dataRows.push(k);}}this.viewCache[geoElemIdx]=dataRows;}}return dataRows;},setMapModel:function(model){this.primaryModel=(model.grid1?new mstrmojo.models.template.DataInterface(model.grid1):null);this.secondaryModel=(model.grid2?new mstrmojo.models.template.DataInterface(model.grid2):null);},currentActionItem:null,clearActionItem:function clearActionItem(geoItem){var actionItem=!!geoItem?geoItem:this.currentActionItem;if(!actionItem){return ;}if(!actionItem.isSelected&&actionItem.image){actionItem.setIcon(geoItem.image);}if(actionItem instanceof mstrmojo.gmaps.CircleMarker){actionItem.setBubbleZIndex(geoItem.getOriginalBubbleZIndex());if(this.previousShownBubble){this.previousShownBubble.set("highlight",true);}}},showInfoWindow:function createContent(geoItem,latlng,clusterMode){if(this.clearHighlights){this.clearHighlights();}if(!this.parent.enablePopup||!this.parent.infowindow){return ;}var geoPos=[],sc,ifws;if(geoItem.geoPosition instanceof Array){geoPos=geoItem.geoPosition;}else{geoPos[0]=geoItem.geoPosition;}if(!clusterMode){this.clusterIndex=0;if(this.isDensityMap()){this.cluster=this.densityLayer.getLastCluster();}else{if(this.isPath()){this.cluster=this.getGeoList(this.getGeoColumnIndex());this.clusterIndex=geoItem.attributes.rowIndex;}else{this.cluster.length=0;this.cluster.push(geoItem);if(geoItem instanceof mstrmojo.gmaps.CircleMarker){this.findCluster(latlng||geoItem.getPosition(),geoItem.radius,geoItem.radius);}else{this.findCluster(latlng||geoItem.getPosition(),9,32);}}}}if(!(geoItem instanceof google.maps.Marker)&&!(geoItem instanceof google.maps.OverlayView)&&geoItem.position){latlng=geoItem.position;}var dataRows,sliceInfo,div,content,detail,title,size;if((this._useAttribute&&this.isAggregate)||(!this._useAttribute&&this.wpAggregateAttributeForm)){var posValue=(geoItem.geoPosition instanceof Array)?geoItem.geoPosition:[geoItem.geoPosition];sliceInfo={pos:posValue,elementIndex:geoItem.attributes.geoIndex,setViewDataFlag:false,applyControl:false,beanPath:this.parent.getBeanPath()};dataRows=this.retrieveDataRows(sliceInfo);}else{dataRows=[geoItem.attributes.rowIndex];}if(this.infoWindowHTML!==undefined&&(this.infoWindowHTML!=""&&this.infoWindowHTML!=this.defaultInfoWindowHTML)){detail=this.resolveCustomizedInfoWindow(geoItem.attributes);content=this.createInfoWindow(geoItem.attributes.NAME,detail);this.parent.infowindow.setContent(content);}else{if(dataRows.length===1){if(geoItem.attributes.NAME){content=this.createInfoWindow(geoItem.attributes.NAME,geoItem.simpleHTML);}else{content=this.createInfoWindow("",geoItem.simpleHTML);}size=mstrmojo.dom.position(content);this.parent.infowindow.setContent(content);}else{if(this.infoWindowUseGrid){content=this.createGridInfoWindow(dataRows);this.parent.infowindow.setContent(this.parent.infoTabDiv);}}}if(latlng){this.parent.infowindow.setPosition(latlng);this.parent.infowindow.open(this.map);}else{this.parent.infowindow.open(this.map,geoItem);}},handlePanelStackInfoWindow:function handlePanelStackInfoWindow(geoItem,latlng){if(!VisUtil.isOnExpressMode()){return ;}var map=this.parent,me=this,ifw=map.infowindow,columnIndex=this.getGeoColumnIndex(),sc,ifws,pos;if(geoItem.isSelected===false){ifw.close();map.set("infoWindowVisible",false);this.infoWindowVisible=false;return ;}map.set("infoWindowVisible",true);this.infoWindowVisible=true;if(!map.enablePopup||!map.infowindow){return ;}if(!(geoItem instanceof google.maps.Marker)&&!(geoItem instanceof google.maps.OverlayView)&&geoItem.position){latlng=geoItem.position;}if(geoItem instanceof mstrmojo.gmaps.CircleMarker){ifw.setOptions({pixelOffset:{height:-1*geoItem.radius,width:0}});}else{ifw.setOptions({pixelOffset:{height:0,width:0}});}sc=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(columnIndex).getSelectorControl();ifws=$MDV.findPanelStackAsInfoWindowSelectorTarget(sc);if(ifws){pos=latlng||geoItem;$MDV.showPanelStackInfoWindows(me,ifws,sc,columnIndex,geoItem.attributes.rowIndex,function(evt){me.onInfoWindowRendered(evt,pos,ifw,geoItem);});}},showTooltip:function showTooltip(geoItem,latlng,clusterMode){if(!this.parent.enablePopup||!this.parent.infowindow){return ;}latlng=latlng||geoItem.position;var overlayProjection=this.parent.overlay.getProjection();var containerPos=this.map.getDiv().getBoundingClientRect();var geoItemPos=overlayProjection.fromLatLngToContainerPixel(latlng);var pos={x:geoItemPos.x+containerPos.left,y:geoItemPos.y+containerPos.top};TOOLTIP_WIN.toggle(true);if(this.previousTooltip===geoItem){TOOLTIP_WIN.moveTo(pos.x,pos.y);return ;}if(!clusterMode){this.clusterIndex=0;if(this.isDensityMap()){this.cluster=this.densityLayer.getLastCluster();}else{if(this.isPath()){this.cluster=this.getGeoList(this.getGeoColumnIndex());this.clusterIndex=geoItem.attributes.rowIndex;}else{this.cluster.length=0;this.cluster.push(geoItem);if(geoItem instanceof mstrmojo.gmaps.CircleMarker){this.findCluster(latlng||geoItem.getPosition(),geoItem.radius,geoItem.radius);}else{this.findCluster(latlng||geoItem.getPosition(),9,32);}}}}var dataRows,sliceInfo,div,content,detail;if((this._useAttribute&&this.isAggregate)||(!this._useAttribute&&this.wpAggregateAttributeForm)){var posValue=(geoItem.geoPosition instanceof Array)?geoItem.geoPosition:[geoItem.geoPosition];sliceInfo={pos:posValue,elementIndex:geoItem.attributes.geoIndex,setViewDataFlag:false,applyControl:false,beanPath:this.parent.getBeanPath()};dataRows=this.retrieveDataRows(sliceInfo);}else{dataRows=[geoItem.attributes.rowIndex];}if(this.infoWindowHTML!==undefined&&(this.infoWindowHTML!==""&&this.infoWindowHTML!==this.defaultInfoWindowHTML)){detail=this.resolveCustomizedInfoWindow(geoItem.attributes);content=this.createInfoWindow(geoItem.attributes.NAME,detail);}else{if(dataRows.length===1){content=geoItem.simpleHTML;}else{if(dataRows.length>1){content=(this.createGridInfoWindow(dataRows)).outerHTML;}else{content='<div id="chartDiv" style="width: 300px; height: 150px;" />';}}}var TOOLTIP_DOM=TOOLTIP_WIN.domNode;if(!TOOLTIP_DOM.parentNode){document.body.appendChild(TOOLTIP_DOM);}TOOLTIP_DOM.innerHTML=content;TOOLTIP_WIN.moveTo(pos.x,pos.y);this.previousTooltip=geoItem;},hideTooltip:function hideTooltip(){if(this.parent.enablePopup){var win=TOOLTIP_WIN.domNode;if(win&&win.parentNode){TOOLTIP_WIN.toggle(false);win.parentNode.removeChild(win);win.innerHTML="";this.previousTooltip=null;}}},startAffinityLinesAnimation:function startAffinityLinesAnimation(sourceMarkerIds){var secModel=this.getMapModel(SECONDARY_DATA_PROVIDER);if(!secModel){mstrmojo.alert("Secondary data provider could not be found. In order to see the Affinity Lines, please reset the secondary data provider in the design mode.",null,"Affinity Lines Error");return ;}if(this.findSecondaryDPAttrColIndexes()===-1){return ;}var secondMetricIndex,sourceAttrElementID,destAttrElementID,polyline,option,i,arr,marker,len,rowCount=secModel.getTotalRows();if(secModel.getColTitles().size()===0){mstrmojo.alert("No Metric is present on the secondary data provider.",null,"Affinity Lines Error");return ;}secondMetricIndex=this.findSecondaryDPSecondMetricIndex();this.computeSecondaryDPMetricMax(0);if(!this._animationSourceMarkerLines){this._animationSourceMarkerLines=[];}len=this._animationSourceMarkerLines.length;for(i=len;i>0;i--){this._animationSourceMarkerLines.pop();}for(rowIndex=0;rowIndex<rowCount;rowIndex++){var rowHeaderElements=secModel.getRowHeaders(rowIndex);var firstAttrElementHeader=rowHeaderElements.getHeader(this.secondaryDPFirstAttrColIndex);var secondAttrElementHeader=rowHeaderElements.getHeader(this.secondaryDPSecondAttrColIndex);sourceAttrElementID=this.getElementIdWithoutAttributeID(firstAttrElementHeader.getElementId());destAttrElementID=this.getElementIdWithoutAttributeID(secondAttrElementHeader.getElementId());if(!sourceMarkerIds[sourceAttrElementID]||!this._markerElementIDs[destAttrElementID]){if(this._affinityLines[sourceAttrElementID+destAttrElementID]!=null){polyline=this._affinityLines[sourceAttrElementID+destAttrElementID];polyline.setMap(null);}continue;}polyline=this._affinityLines[sourceAttrElementID+destAttrElementID];polyline.strokeOpacity=1;polyline.setMap(this.map);if(this.wpDrawArcsLines==="Arcs"){this._animationSourceMarkerLines[this._animationSourceMarkerLines.length]=this.parent.findPointsOnArc(this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]);}else{this._animationSourceMarkerLines[this._animationSourceMarkerLines.length]=this.parent.findPointsOnLine(this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]);}}if(!this._animationMarkers){this._animationMarkers=[];}len=this._animationMarkers.length;for(i=len;i>0;i--){this._animationMarkers.pop();}this._affinityAnimationFinished=true;if(this._animationSourceMarkerLines.length===0){return ;}len=this._animationSourceMarkerLines.length;for(i=0;i<len;i++){arr=this._animationSourceMarkerLines[i];marker=this.createAffinityAnimationMarker(arr[0]);this._animationMarkers[i]=marker;}this._currentAffinityInterval=0;this.doAffinityAnimation();},stripNumberFormat:function stripNumberFormat(numString){var newString=numString.replace(this.gridParams.currencySymbol,"");var oldString;do{oldString=newString;newString=newString.replace(this.gridParams.groupingSeparator,"");}while(oldString!=newString);var resultString=newString.replace(this.gridParams.decimalSeparator,".");return resultString;},unrender:function unrender(){if(this._super){this._super();}var key,markerList,ind,listeners=this.viewerEventListeners;this.visible=false;if(!this.idMarkerMap){return ;}for(key in this.idMarkerMap){this.idMarkerMap[key].setMap(null);}this.idMarkerMap=null;if(this.enableLatLng){markerList=this.getGeoList(this.latColumnIndex);}else{if(this.enablePoint){markerList=this.getGeoList(this.pointColumnIndex);}}if(!!markerList){for(ind=0;ind<markerList.length;ind++){markerList[ind].setMap(null);}}this.removeDataLabelLayer();if(this.geoLists){this.geoLists={};}this.clearAffinityAnimationObjects();this.clearAffinityLines();if(!!this.densityLayer){this.cleanDensityMap();this.densityLocations=null;}if(this.currentSelections){this.currentSelections={};}if(this.selectedRowIndices){this.selectedRowIndices={};}if(this.highlightedGraphics){this.highlightedGraphics={};}this.parent.removeEventListeners(listeners);this.viewerEventListeners=[];this.clearPath();},destroy:function destroy(deepClean){if(this.unrenderred){return ;}this.unrender(deepClean);var disposables=this.parent.disposables;for(var i=0,il=disposables.length;i<il;i++){if(this===disposables[i]){delete disposables[i];disposables.splice(i,1);break;}}this._super(deepClean);},getAllGraphics:function getAllGraphics(){return this.getGeoList(this.getGeoColumnIndex());},highlightGraphic:function highlightGraphic(graphic){if(typeof (graphic.onisSelectedChange)!="undefined"){graphic.set("isSelected",true);graphic.setBubbleZIndex(this.parent.maxBubbleRadius+1);}else{if(graphic.hili){graphic.isSelected=true;if(graphic.isHover&&graphic.hiliHover){graphic.setIcon(graphic.hiliHover);}else{graphic.setIcon(graphic.hili);}if(graphic instanceof google.maps.Marker){graphic.setZIndex(this.parent.maxBubbleRadius+1);}}}this.parent.infowindow.setZIndex(this.parent.maxBubbleRadius+2);},clearHighlight:function clearHighlight(graphic){if(typeof (graphic.onisSelectedChange)!="undefined"){graphic.set("isSelected",false);if(typeof (graphic.onhighlightChange)!="undefined"){graphic.set("highlight",false);}graphic.setBubbleZIndex(graphic.getOriginalBubbleZIndex());}else{graphic.isSelected=false;if(graphic.isHover&&graphic.hover){graphic.setIcon(graphic.hover);}else{if(graphic.image){graphic.setIcon(graphic.image);}else{if(graphic.setOptions){graphic.setOptions({strokeColor:(graphic.highlight?this.highlightedStroke:this.regularStroke)});}}}if(graphic instanceof google.maps.Marker){graphic.setZIndex(graphic.originalzIndex);}}},supportDataLabel:function(){return this.isMarkerMap();},isMarkerMap:function(){return(this.wpMarkerType===$EnumMarkerType.Marker)||(this.wpMarkerType===$EnumMarkerType.Bubble);},createDataLavelLayer:function(){this.dataLabelOverlays=[];},removeDataLabelLayer:function(){var i,dataLabelOverlays=this.dataLabelOverlays,n=(dataLabelOverlays&&dataLabelOverlays.length)||0;for(i=0;i<n;i++){dataLabelOverlays[i].removeOverLay();}this.dataLabelOverlays=null;},clearDataLabelLayer:function(){this.removeDataLabelLayer();},showDataLabelLayer:function(){var i,dataLabelOverlays=this.dataLabelOverlays,n=(dataLabelOverlays&&dataLabelOverlays.length)||0;for(i=0;i<n;i++){dataLabelOverlays[i].show();}},hideDataLabelLayer:function(){var i,dataLabelOverlays=this.dataLabelOverlays,n=(dataLabelOverlays&&dataLabelOverlays.length)||0;for(i=0;i<n;i++){dataLabelOverlays[i].hide();}},updateScreenPoint:function(pointsConfig){var i,config,projection=this.parent.overlay.getProjection(),n=(pointsConfig&&pointsConfig.length)||0;if(!projection){throw"Projection didn't prepared!";}for(i=0;i<n;i++){config=pointsConfig[i];config.screenPoint=projection.fromLatLngToContainerPixel(config.mapPoint);}},drawDataLabels:function(labels,mapPoint){var k,textMarker,label,m=labels.length,dataLabelOverlays=this.dataLabelOverlays;for(k=0;k<m;k++){label=labels[k];textMarker=new mstrmojo.gmaps.TextMarker({labelText:label.label,position:mapPoint,map:this.map,labelClass:"mapDataLabel",labelStyle:this.dlFontStyle,labelOffset:new google.maps.Size(label.xOffset,label.yOffset)});dataLabelOverlays.push(textMarker);}},reBuildDataLebels:function(){var me=this;if(this.updateDataLabelHandler){clearTimeout(this.updateDataLabelHandler);}this.updateDataLabelHandler=setTimeout(function(){me.buildDataLabelLayer();delete me.updateDataLabelHandler;},150);}});})();