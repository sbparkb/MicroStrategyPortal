(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo._RowRendTracker","mstrmojo.array","mstrmojo.chart.model.enums.EnumDSSBaseFormType");var AUTO_TR="<tr>";var TBL_MKP_START=['<table cellspacing="0" cellpadding="0" style="table-layout:',null,";width:",null,';mstr-tablestyle-slot" ',null,">",null,"<tbody>"];var NBSP="&nbsp;";var STITCH_TOP_CSS="fsbp_1 ";var STITCH_MIDDLE_CSS="fsbp_2 ";var STITCH_BOTTOM_CSS="fsbp_3 ";var STACK_TOP=1,STACK_MIDDLE=2,STACK_BOTTOM=3,STACK_BOTTOM_LAST=4,NO_STACK=5,STACK_CSS={1:" stack-top",2:" stack-middle",3:" stack-bottom",4:" stack-bottom-last",5:" no-stack",6:" stack-full"},TOP_PADDING_STACKED=1,HALF_INNER_PADDING_STACKED=3;var $CSS=mstrmojo.css,$ARR=mstrmojo.array,$BFT=mstrmojo.chart.model.enums.EnumDSSBaseFormType;var BASEFORM_PICTURE=4;function stitchBottomCells(cells,tbody){for(var i=0,iLen=cells.length;i<iLen;i++){var c=cells[i];var d=tbody.rows[c.rows].cells[c.cells];if(d){mstrmojo.css.addClass(d,STITCH_TOP_CSS);}}}function resolveImagePath(value){var startIndex=value.indexOf('src="');if(startIndex<0){return value;}var str=value.substring(startIndex+5),endIndex=str.indexOf('"'),imgUrl;str=str.substring(0,endIndex);imgUrl=str;var ds=this.parent&&this.parent.controller&&this.parent.controller.model&&this.parent.controller.model.dataService;if(ds&&ds.getImage){imgUrl=ds.getImage(str);}return value.replace(str,imgUrl);}var getCellMarkup=(function(){var regexNewLine=/\n/g,newLineReplacement="<br/>",regexAnchor=/<a\s[^>]+>/gi,anchorText="<a ",anchorReplacement='<a target="_blank" ',targetText="target=";var linkMarkup0='<a href="',linkMarkup2='" target="_blank">',linkMarkup4="</a>",urlMarkup0="<span>",urlMarkup2="</span>",raBtnMarkup0='<span rabtn class="raBtn ',raBtnMarkup2='"></span>',raBtnClassExpand="icon-expand",raBtnClassCollapse="icon-collapse",indentMarkup0="<span>",indentMarkup2="</span>";return function(cell,cp){var markup=(cell.v||cell.n||NBSP).replace(regexNewLine,newLineReplacement),isUrl=cell.ts===$BFT.DssBaseFormUrl,isHTML=cell.ts===$BFT.DssBaseFormHTMLTag,isRA=cell.lv!==undefined;if(isUrl){markup=linkMarkup0+markup+linkMarkup2+markup+linkMarkup4;}else{if(isHTML){(markup.match(regexAnchor)||[]).forEach(function(anchor){if(anchor.indexOf(targetText)===-1){markup=markup.replace(anchor,anchor.replace(anchorText,anchorReplacement));}});}}if((cell.css&&cell.css.indexOf("hl")>-1)||isUrl){markup=urlMarkup0+markup+urlMarkup2;}if(isRA){var indentCount=cell.lv,INDENT_HTML="&nbsp;&nbsp;&nbsp;&nbsp;",indentMarkup="",raIndentSpan="",raBtnSpan="",i;for(i=0;i<indentCount;i++){indentMarkup+=INDENT_HTML;}if(cell.hcd&&cell.fi===undefined){raBtnSpan=raBtnMarkup0+(cell.epd?raBtnClassCollapse:raBtnClassExpand)+raBtnMarkup2;}else{indentMarkup+=INDENT_HTML;}if(cell.axis===1){raIndentSpan=indentMarkup0+indentMarkup+indentMarkup2;}markup=raIndentSpan+raBtnSpan+markup;}return markup;};}());mstrmojo.GridBase=mstrmojo.declare(mstrmojo.Widget,[mstrmojo._RowRendTracker],{scriptClass:"mstrmojo.GridBase",markupString:'<span id="{@id}" class="mstrmojo-Grid {@cssClass}" style="{@cssText}"></span>',markupSlots:{gridContainerNode:function(){return this.domNode;}},autoFitWindow:false,tableLayout:null,numAutoHeightRows:0,cp:null,rc:0,cc:0,cws:null,rh:null,totalColWidth:0,start:0,end:0,forceFixedSizes:true,hiliteCellsMap:null,eiMap:null,init:function init_Grid(props){this._super(props);},numColumnCanMerge:0,preBuildRendering:function preBuildRendering(){var cp=this.cp;if(!cp){return ;}cp.initContent();this.rc=cp.rc||0;this.cws=cp.colWidths||[];this.cc=this.cws.length;this.tdWidths=cp.tdWidths||[];this.tdCnt=this.tdWidths?this.tdWidths.length:0;this.start=0;this.end=this.rc-1;this.numAutoHeightRows=cp.getNumAutoHeightRows&&cp.getNumAutoHeightRows()||0;this.hiliteCellsMap={};this.eiMap={};this.posMap=[];this.thPosMap=[];this.totalColWidth=0;},buildRendering:function buildRendering(res){var ret=this._super(res);this.renderGrid();return ret;},renderGrid:function renderGrid(append){var containerNode=this.getGridContainer();this.preBuildGridTable();this.buildGridTable(containerNode,append);this.postBuildGridTable();},getGridContainer:function getGridContainer(){return this.gridContainerNode;},buildGridTable:function buildGridTable(gridContainer,append){var tms=this.getTableStartMarkup();var tme=this.getTableEndMarkup();if(append){this.mergeHdrsAcrossBlks=true;}var tInnerHTML=this.buildTableRowsMarkup(this.start,this.end,tms,tme).join("");if(append){var creationContainer=document.createElement("div");creationContainer.innerHTML=tInnerHTML;var cn=gridContainer.firstChild,tBodies=cn&&cn.tBodies,ntBody=creationContainer.firstChild.tBodies[0],mh=this.matchedHdrsAcrossBlks;cn.appendChild(ntBody);if(mh&&mh.length>0){stitchBottomCells(mh,tBodies[tBodies.length-2]);}}else{gridContainer.innerHTML=tInnerHTML;}this.markPages(this.start,this.end);},getTableStartMarkup:function _bldTableSMkp(){var gw=this._getGridWidths(),mkp=TBL_MKP_START;mkp[1]=gw.tableLayout;mkp[3]=gw.totalColWidths;mkp[5]=this.tableCssClass?"class="+this.tableCssClass:"";mkp[7]="<colgroup>"+gw.colgroup+"</colgroup>";if(this.tbodyStyle){mkp[8]='<tbody style="'+this.tbodyStyle+'">';}return mkp.join("");},getTableEndMarkup:function _bldTableEMkp(){return"</tbody></table>";},_getGridWidths:function _initGridWidths(){var gw={};var totalColWidths="",colgroup=[],tl="fixed",cws=this.cws,cols=cws.length;if(cols){totalColWidths=0;colgroup=[];for(var i=0;i<cols;i++){if(cws[i].w!==""){totalColWidths+=parseInt(cws[i].w,10);}}for(i=0;i<cols;i++){var width=cws[i];if(width.w!==""&&!this.autoFitWindow){var w=parseInt(width.w,10);if(mstrmojo.dom.isIE7){if(w===0){colgroup.push('<col style="width:0%;display:none"></col>');}else{colgroup.push('<col style="width:'+(w/totalColWidths*100)+'%"></col>');}}else{if(mstrmojo.dom.isWK&&w===0){colgroup.push('<col style="width:-1px"></col>');}else{colgroup.push('<col style="width:'+width.w+'"></col>');}}}else{colgroup.push("<col />");tl="auto";}}this.totalColWidth=totalColWidths;}gw.colgroup=colgroup.join("");tl=this.tableLayout||tl;if(this.autoFitWindow){tl=this.tableLayout||tl||"fixed";totalColWidths="100%";}else{if(tl==="fixed"){totalColWidths+="px";}else{totalColWidths="auto";}}gw.totalColWidths=totalColWidths;gw.tableLayout=tl;return gw;},_CELL_MARKUP:['<td rowSpan="',null,'" colSpan="',null,'" class="',null,'" ei="',null,'" style="',null,'" r="',null,'">',null,"</td>"],buildTableRowsMarkup:function _buildRowsMarkup(start,end,markupPrefix,markupSuffix,tableLayout){var markup=[],i=0;markup[i++]=markupPrefix||"<table><tbody>";var cp=this.cp,actualColumnWidth=this.acws,rowMerged=this.rowMerge,headerOffset=this.headerOffset,metricNameIndex=this.mxPos,hasMergeStatus=!!cp.gemh,rh=cp.getRowHeight(),TD=this._CELL_MARKUP,TR=rh?'<tr style="height:'+(rh?rh+"px":"")+'">':AUTO_TR;var firstRow=true,lastMatched=true,nlr=[],rhi;var getAttrIndex=function getAttrIndex(cellIndex){var result=-1;mstrmojo.array.forEach(actualColumnWidth,function(width,index){cellIndex=cellIndex-width;if(cellIndex<0){result=index;return false;}});return result;};var getCrossingRow=function getCrossingRow(row,rowspan){var line=-1;mstrmojo.hash.forEach(cp.gemh,function(status,key){if(row<=key&&row+rowspan>key){line=key;return false;}});return line;};var needStitching=function needStitching(cp,row,cellIndex){var stitchCSS="",index,status;status=cp.gemh&&cp.gemh[row];if(status){index=getAttrIndex(cellIndex);if(status[index]&&status[index].v===0||metricNameIndex===cellIndex){stitchCSS+=STITCH_TOP_CSS;}}status=cp.gsmh&&cp.gsmh[row];if(status){index=getAttrIndex(cellIndex);if(status[index]&&status[index].v===0||metricNameIndex===cellIndex){stitchCSS+=STITCH_BOTTOM_CSS;}}return stitchCSS;};var hideCell,ct,len,rsStack=[],j,v,colOffset=0,colStart=0,stitchCSS,prevCellStitched,totalColumnNumber=cp.colWidths&&cp.colWidths.length,cellOffset=0,numColumnCanMerge=0,tl=tableLayout||((markupPrefix&&markupPrefix.indexOf("table-layout:fixed;")!==-1)?"fixed":"auto");if(actualColumnWidth&&hasMergeStatus){for(j=0;j<actualColumnWidth.length-1;j++){numColumnCanMerge+=actualColumnWidth[j];}}numColumnCanMerge=numColumnCanMerge||this.numColumnCanMerge;if(tl==="fixed"){hideCell=[];for(ct=0,len=this.cws.length;ct<len;ct++){if(window.parseFloat(this.cws[ct].w)<=0){hideCell[ct]=true;}else{hideCell[ct]=false;}}}this.matchedHdrsAcrossBlks=[];for(var r=start;r<=end;r++){colOffset=0;rhi=i++;markup[rhi]=r<this.numAutoHeightRows?AUTO_TR:TR;var cells=cp.getRowCells(r);var maxRowspan=end+1-r;var umCellsLen=0;prevCellStitched=rowMerged;stitchCSS="";if(!this.mergeHdrsAcrossBlks){if(firstRow&&start>0&&cells.length<cp.colWidths.length){var umCells=cp.getUnmergedCells(start),filledRowcells;if(umCells){umCellsLen=umCells.length;}for(j=0,len=umCellsLen;j<len;j++){var unMergedCell=umCells[j],rowSpan=unMergedCell.rs;if(rowSpan>maxRowspan){TD[1]=maxRowspan;TD[5]=STITCH_MIDDLE_CSS+unMergedCell.css;}else{TD[1]=rowSpan||1;TD[5]=STITCH_BOTTOM_CSS+unMergedCell.css;}if(hideCell&&hideCell[colStart+colOffset]){TD[5]+=" nwFixedWidth0 ";}if(rowSpan&&rowSpan>1){rsStack.push(rowSpan);}colOffset+=unMergedCell.cs||1;if(unMergedCell.cet){TD[5]+=" mstrmojo-selected-cell";this.addHilitePosition(unMergedCell.cet,r,j);}if(unMergedCell._ei){this.addExtraInfoMap(unMergedCell._ei,r,j);TD[5]+=" pt";}TD[9]="";TD[13]=NBSP;TD[3]=unMergedCell.cs;if(unMergedCell._ei===undefined){filledRowcells=cp.getRowCells(unMergedCell.o+(cp.cps[0]&&cp.cps[0].rc||0));unMergedCell=$ARR.filterOne(filledRowcells,function(cell){return cell.dpt===unMergedCell.dpt&&cell.idx===unMergedCell.idx;});}TD[7]=unMergedCell._ei;TD[11]=r;if(hasMergeStatus){if(prevCellStitched){stitchCSS=needStitching(cp,r-headerOffset,j);}if(!!stitchCSS){TD[5]=stitchCSS+TD[5];}else{prevCellStitched=false;}stitchCSS=needStitching(cp,getCrossingRow(r-headerOffset,TD[1]),j);if(!!stitchCSS){TD[5]=STITCH_TOP_CSS+TD[5];prevCellStitched=true;}}markup[i++]=TD.join("");}firstRow=false;}}cellOffset=totalColumnNumber;len=cells.length;var c;for(c=0;c<len;c++){cellOffset-=cells[c].cs||1;}for(c=0;c<len;c++){var cell=cells[c],rt;cell.colIx=cellOffset;if(cell.rs&&cell.rs>maxRowspan){TD[1]=maxRowspan;TD[5]=STITCH_TOP_CSS+cell.css;if(cell._ei){this.addExtraInfoMap(cell._ei,r,c);}}else{TD[1]=cell.rs||1;TD[5]=cell.css;}if(hideCell&&hideCell[colStart+colOffset]){if((cell.cs==undefined)||((cell.cs!=undefined)&&(cell.cs==1))){TD[5]+=" nwFixedWidth0 ";}}if(cell.rs&&cell.rs>1){rsStack.push(cell.rs);}colOffset+=cell.cs||1;if(cell.rowType!==STACK_TOP){TD[5]+=" xtab-td ";}if(cell.cet){TD[5]+="sc_"+this.parent.k;this.addHilitePosition(cell.cet,r,c);}if(cell.lv){TD[5]+=" ra ";}rt=cell.rowType;if(rt){TD[5]+=STACK_CSS[rt]||"";var srh=cp.getRowHeight(rt);if(srh){markup[rhi]='<tr style="height:'+(srh?srh+"px":"")+'">';}}TD[3]=cell.cs||1;TD[7]=cell._ei!==undefined?cell._ei:"";if(cell.fs||cell._e){this.addTitleHeaderPositionMap(r,c+umCellsLen,cell);}if(cell._ei!=null){this.addPositionMap(cell._ei,r,c+umCellsLen);}TD[11]=r;if(cell.ts===BASEFORM_PICTURE){var imgUrl=cell.v;if(this.imgCacheMap){var m=this.imgCacheMap,v=imgUrl&&imgUrl.replace(/\\/g,"/");if(m.cachedImg[v]){cell.v=imgUrl=m.baseURL+m.cachedImg[v];}else{if(v&&!m.unCachedImg[v]){m.unCachedImg[v]=v;}}}else{var ds=this.parent&&this.parent.controller&&this.parent.controller.model&&this.parent.controller.model.dataService;if(ds&&ds.getImage){imgUrl=ds.getImage(imgUrl);}}if(cell.rowType){var height=(cp.getRowHeight(cell.rowType)||cp.rh||rh),fsHeight=height,cws=this.tdWidths,colIdx=cell.colIdx,colWidth=0,maxHeight=0;var topPadding=cp.getPadding(TOP_PADDING_STACKED),halfInnerPadding=cp.getPadding(HALF_INNER_PADDING_STACKED);if(cell.rowType===STACK_TOP||cell.rowType===STACK_BOTTOM_LAST){maxHeight=height>(topPadding+halfInnerPadding)?(height-topPadding-halfInnerPadding):0;}else{if(cell.rowType===STACK_MIDDLE||cell.rowType===STACK_BOTTOM){maxHeight=height>2*halfInnerPadding?(height-2*halfInnerPadding):0;}else{if(cell.rowType===NO_STACK){maxHeight=height>(halfInnerPadding*2)?(height-halfInnerPadding*2):0;}}}if(colIdx!=="undefined"&&colIdx>-1&&cws&&cws.length>colIdx){var cw=cws[colIdx]&&cws[colIdx].w;if(cw!=="undefined"){colWidth=parseInt(cw,10);}}var maxWidth=colWidth>30?(colWidth-30):0;TD[13]='<div><div style="top:'+(-parseInt(fsHeight/2,10))+"px;height:"+(height-1)+"px;line-height:"+(height-1)+'px !important;">&nbsp;<img style="max-height:'+maxHeight+"px; max-width: "+maxWidth+'px;" src="'+imgUrl+'"></img></div></div>';}else{TD[9]="";var onload="",dm=this.parent&&this.parent.controller&&this.parent.controller.model&&this.parent.controller.model,zf=dm.getZoomFactor();if(zf!=1){onload='onload="this.style.height='+zf+"*this.offsetHeight+'px';\"";}TD[13]='<img src="'+imgUrl+'" '+onload+"></img>";if(cell.css&&cell.css.indexOf("hl")>-1){TD[13]="<span>"+TD[13]+"</span>";}}}else{TD[9]="";if(mstrApp.useBinaryFormat&&cell.v&&cell.v.indexOf("img")>=0){cell.v=resolveImagePath.call(this,cell.v);}TD[13]=getCellMarkup(cell,cp);}if(c<numColumnCanMerge){if(r===start&&this.mergeHdrsAcrossBlks){var lr=this.rowHdsAcrossBlks;if(lastMatched&&cell.v&&lr&&lr[c]){if(cell.v===lr[c].v){TD[1]=cell.rs||1;TD[5]=STITCH_BOTTOM_CSS+cell.css;TD[13]="";this.matchedHdrsAcrossBlks.push(lr[c]);}else{lastMatched=false;}}}if(hasMergeStatus){if(prevCellStitched){stitchCSS=needStitching(cp,r-headerOffset,cellOffset);if(!!stitchCSS){TD[5]=stitchCSS+TD[5];if(stitchCSS.indexOf(STITCH_BOTTOM_CSS)>=0&&r-headerOffset>1){TD[13]=NBSP;}}else{prevCellStitched=false;}stitchCSS=needStitching(cp,getCrossingRow(r-headerOffset,TD[1]),cellOffset);if(!!stitchCSS){TD[5]=STITCH_TOP_CSS+TD[5];prevCellStitched=true;}}}if(TD[1]>=maxRowspan&&cell.v){nlr.push({rows:r-start,cells:c,v:cell.v});}}cellOffset+=cell.cs||1;markup[i++]=TD.join("");}markup[i++]="</tr>";for(c=rsStack.length-1;c>=0;c--){v=rsStack[c];if(v<=1){rsStack.pop();}else{rsStack[c]=--v;}}colStart=rsStack.length;}markup[i++]=markupSuffix||"</tbody></table>";this.rowHdsAcrossBlks=nlr;return markup;},addHilitePosition:function(key,row,cell){var hm=this.hiliteCellsMap[key];if(!hm){this.hiliteCellsMap[key]={pos:[],nodes:[]};}this.hiliteCellsMap[key].pos.push({row:row,cell:cell,page:0});},addExtraInfoMap:function(ei,r,c){if(!this.eiMap[ei]){this.eiMap[ei]=[];}this.eiMap[ei].push({row:r,cell:c,page:0});},addPositionMap:function(ei,r,c){if(!this.posMap[ei]){this.posMap[ei]={row:r,cell:c,page:0};}},addTitleHeaderPositionMap:function(r,c,o){this.thPosMap.push({row:r,cell:c,page:0,obj:o});},clearHilites:function(key){var hc=this.hiliteCellsMap[key],ns=hc&&hc.nodes,parent=this.parent;if(ns){if(ns.length==0&&hc.pos){ns=this.getNodesByPositions(hc.pos);}for(var i=0,iLen=ns.length;i<iLen;i++){var nd=ns[i],cell=parent.getCellForNode(nd);if(cell){delete cell.cet;}$CSS.removeClass(nd,"sc_"+parent.k);}this.hiliteCellsMap[key].nodes=[];}},setHilites:function(key,node){$CSS.addClass(node,"sc_"+this.parent.k);if(!this.hiliteCellsMap[key]){this.hiliteCellsMap[key]={pos:[],nodes:[]};}this.hiliteCellsMap[key].nodes.push(node);var cell=this.parent.getCellForNode(node);if(cell){cell.cet=key;}},getNodesByPositions:function(pos){var tbl=this.tableNode,arr=[];for(var i in pos){var v=pos[i];arr.push(tbl.tBodies[0].rows[v.row].cells[v.cell]);}return arr;},preBuildGridTable:function preBuildGridTable(){},postBuildGridTable:function postBuildGridTable(){this.addSlots({tableNode:this.gridContainerNode&&this.gridContainerNode.firstChild});}});})();