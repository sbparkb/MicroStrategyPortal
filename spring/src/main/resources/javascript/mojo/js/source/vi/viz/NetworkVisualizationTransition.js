(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.VisUtility");mstrmojo.requiresClsP("mstrmojo.vi.viz","VisualizationTransition","EnumDSSDropZones","NetworkVisualizationHelper");var $MOJO=mstrmojo,$ARR=$MOJO.array,$VIZ=$MOJO.vi.viz,$UTIL=$MOJO.VisUtility,$KNOWN_VIZ=$VIZ.KnownVisualizations,$CHART_ENUMS=$MOJO.chart.model.enums,$DSSOBJ_TYPES=$CHART_ENUMS.EnumDSSObjectType,METRIC_TYPE=$DSSOBJ_TYPES.DssTypeMetric,NETWORK_THRESHOLD_COLORS=["#CC2525","#E34B4B","#E97D7D","#79D479","#57BA57","#2CA02C"],NETWORK_THRESHOLD_BANDS=[0.1,0.3,0.5,0.7,0.9];function getRawObjectArray(arr,src,isMetric){var rets=[];$ARR.forEach(arr,function(outer){$ARR.forEach(src,function(inner){if((outer.id===inner.did)||(outer.did===inner.did)){if((isMetric&&(inner.t===METRIC_TYPE))||(!isMetric&&(inner.t!==METRIC_TYPE))){rets.push(inner);return false;}}});});return rets;}function getRealSliceOrBreakByAttr(thisby,colorby){var rets=[];$ARR.forEach(thisby,function(outer){var found=false;$ARR.forEach(colorby,function(inner){if(outer.id===inner.id){found=true;return false;}});if(!found){rets.push(outer);}});return rets;}function getColorByMetric(dz,mx){if(dz&&dz.ColorBy&&dz.ColorBy.TemplateMetric){return getRawObjectArray(dz.ColorBy.TemplateMetric,mx,true);}return[];}function getSizeByMetric(dz,mx){if(dz&&dz.SizeBy&&dz.SizeBy.TemplateMetric){return getRawObjectArray(dz.SizeBy.TemplateMetric,mx,true);}return[];}function getTemplateUnit(item){return(item&&item.TemplateUnit)||[];}function getTemplateMetric(item){return(item&&item.TemplateMetric)||[];}function getAttributesOrMetrics(arr,type,sizebyIdx){var rets=[],index=0,sizebyMetricIdx;$ARR.forEach(arr,function(item){if(index===sizebyIdx){sizebyMetricIdx=rets.length;}index++;if(item instanceof Array){rets=rets.concat(item);}else{if(type==="attribute"){rets=rets.concat(getTemplateUnit(item));}else{rets=rets.concat(getTemplateMetric(item));}}});if(type==="attribute"){return rets;}return{metrics:rets,idx:sizebyMetricIdx};}function populateFromAndToZones(node,networkHelper){var data=node.data,gsi=data.gsi,dz=data.dz,attrs,src=(gsi.rows||[]).concat(gsi.cols||[]);switch(data.visName){case"GraphMatrixVisualizationStyle":var colorby=getTemplateUnit(dz.ColorBy),sliceby=getRealSliceOrBreakByAttr(getTemplateUnit(dz.SliceBy),colorby),breakby=getRealSliceOrBreakByAttr(getTemplateUnit(dz.BreakBy),colorby);attrs=getAttributesOrMetrics([sliceby,dz.Rows,dz.YAxis,dz.Columns,dz.XAxis,colorby,breakby],"attribute");break;case"VIHeatMapVisualizationStyle":attrs=getAttributesOrMetrics([dz.Grp,dz.ColorBy],"attribute");break;case"ESRIMapVisualizationStyle":case"GoogleMapVisualizationStyle":attrs=getAttributesOrMetrics([dz.Geo,dz.Lat,dz.Long,dz.AdditionalMetrics],"attribute");break;}if(attrs&&attrs.length>0){attrs=getRawObjectArray.call(this,attrs,src,false);}else{attrs=src;}$ARR.forEach(attrs,function(item){if(item.t!==$DSSOBJ_TYPES.DssTypeMetric&&item.t!==$DSSOBJ_TYPES.DssTypeDimension&&item.did!=="-1"){networkHelper.fromItemAttribute=item;return false;}});$ARR.forEach(attrs,function(item){if(item.t!==$DSSOBJ_TYPES.DssTypeMetric&&item.t!==$DSSOBJ_TYPES.DssTypeDimension&&item.did!=="-1"&&item.did!==networkHelper.fromItemAttribute.did){networkHelper.toItemAttribute=item;return false;}});}function populateColorSizeZones(node,networkHelper,actions,thresholdActions){var data=node.data,dz=data.dz,mx=data.gsi.mx||[],metrics,ret,sizebyMetricIdx;mx.forEach(function(m){m.t=4;});var cbm=getColorByMetric.call(this,dz,mx);if(cbm.length>0){networkHelper.edgeColorMetric=cbm[0];cbm=cbm.slice(1);}var sbm=getSizeByMetric.call(this,dz,mx);switch(data.visName){case"GraphMatrixVisualizationStyle":ret=getAttributesOrMetrics([dz.AngleBy,dz.Rows,dz.YAxis,dz.Columns,dz.XAxis,cbm,sbm,dz.AdditionalMetrics],"metric",6);break;case"VIHeatMapVisualizationStyle":ret=getAttributesOrMetrics([dz.Grp,sbm,cbm,dz.AdditionalMetrics],"metric",1);break;case"ESRIMapVisualizationStyle":case"GoogleMapVisualizationStyle":ret=getAttributesOrMetrics([cbm,sbm,dz.AdditionalMetrics],"metric",1);break;default:metrics=mx;break;}if(ret){sizebyMetricIdx=ret.idx;metrics=ret.metrics;}if(metrics&&metrics.length>0){metrics=getRawObjectArray.call(this,metrics,mx,true);}else{if(!dz||!dz.ColorBy){metrics=mx;}}if(!networkHelper.edgeColorMetric&&metrics&&metrics[0]){networkHelper.edgeColorMetric=metrics[0];metrics=metrics.slice(1);sizebyMetricIdx--;}if(sbm.length>0){networkHelper.nodeSizeMetric=sbm[0];if(sizebyMetricIdx>=0){metrics=metrics.slice(0,sizebyMetricIdx).concat(metrics.slice(sizebyMetricIdx+1));}}if(!metrics&&data.visName&&$KNOWN_VIZ.getDefinition(data.visName).id===$KNOWN_VIZ.UNKNOWN){networkHelper.edgeColorMetric=null;networkHelper.nodeSizeMetric=null;networkHelper.edgeSizeMetric=null;metrics=mx;}metrics.forEach(function(m){if(!networkHelper.nodeSizeMetric){networkHelper.nodeSizeMetric=m;}else{if(!networkHelper.edgeSizeMetric){networkHelper.edgeSizeMetric=m;}}});if(networkHelper.edgeColorMetric){this.addThresholds(node,networkHelper.edgeColorMetric,thresholdActions,NETWORK_THRESHOLD_COLORS,NETWORK_THRESHOLD_BANDS);}}function transitionFromVisualization(node,actions,templateActions,thresholdActions){var networkHelper=new $VIZ.NetworkVisualizationHelper({node:node});populateFromAndToZones.call(this,node,networkHelper);populateColorSizeZones.call(this,node,networkHelper,templateActions,thresholdActions);var dzActions=networkHelper.getAddDropZonesAction();dzActions.actions=templateActions.concat(dzActions.actions).concat(thresholdActions);if(dzActions.actions.length){actions.push(dzActions);}return{wp:networkHelper.getXml(),handled:false};}mstrmojo.vi.viz.NetworkVisualizationTransition=mstrmojo.declare(mstrmojo.vi.viz.VisualizationTransition,null,{scriptClass:"mstrmojo.vi.viz.NetworkVisualizationTransition",transitionDropZones:function transitionDropZones(actions,vt){var vis=this.vis,node=vis.node,data=node.data,curVisName=data.visName||"Grid",templateActions=[],thresholdActions=[],ii,th,edgeColorThresholds=$UTIL.getPropertyByPath(vis,"node.data.gsi.thresholds");this.clearImageThreshold(edgeColorThresholds,thresholdActions);if($KNOWN_VIZ.getDefinition(curVisName).id!==$KNOWN_VIZ.NETWORK){return transitionFromVisualization.call(this,vis.node,actions,templateActions,thresholdActions);}return{wp:"",handled:false};}});}());