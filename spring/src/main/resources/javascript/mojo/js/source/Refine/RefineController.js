(function(){mstrmojo.requiresCls("mstrmojo.Refine.RefinePanel","mstrmojo.Refine.RefineDataPreview","mstrmojo.Refine.RefineSuggestionPreview","mstrmojo.Refine.RefineControlSplit","mstrmojo.Refine.RefineControlWhitespace","mstrmojo.Refine.RefineControlDelete","mstrmojo.Refine.RefineControlFacet","mstrmojo.Refine.RefineControlTransformCell","mstrmojo.Refine.RefineControlFindAndReplace","mstrmojo.Refine.RefineControlRemoveText","mstrmojo.Refine.RefineControlOther","mstrmojo.Refine.RefineSuggestions","mstrmojo.Refine.RefineControlExtract","mstrmojo.string","mstrmojo.array","mstrmojo.Refine.RefineTransformations","mstrmojo.Refine.RefineHelpers");mstrmojo.requiresDescs(12799);var $ARR=mstrmojo.array,RefineHelpers=mstrmojo.Refine.RefineHelpers;function escapeSpecial(str){str=str.replace(/\n/g,"\\n");str=str.replace(/\t/g,"\\t");return str;}function replaceDollar(str){return str.replace(/\$/g,"$$$$").replace(/[\\"']/g,"\\$&");}var dw={};dw.regex=function(){var r={};var numberRecord=function(m){return[new RegExp(m),/\d+/];};var stringRecord=function(m){var r=[new RegExp(m),/[a-zA-Z]+/];if(m.toLowerCase()===m){r.push(/[a-z]+/);}else{if(m.toUpperCase()===m){r.push(/[A-Z]+/);}}return r;};var symbolRecord=function(m){return[new RegExp(mstrmojo.string.regEscape(m))];};r.candidates=function(records){if(records.length){var enumerations=r.parse(records[0].text,records[0].start,records[0].end),tests=records.slice(0),on,between,match,candidates;on=(enumerations.on||[]).map(function(c){return{on:c};});var before=enumerations.before,after=enumerations.after;if(before===undefined||before.length===0){between=after.map(function(a){return{after:a,on:/.*/};});}else{if(after===undefined||after.length===0){between=before.map(function(a){return{before:a,on:/.*/};});}else{between=after.map(function(a){return{after:a,on:/.*/};}).concat(before.map(function(a){return{before:a,on:/.*/};}));}}candidates=on.concat(between);if(tests.length===0){return candidates;}candidates=candidates.filter(function(candidate){return tests.filter(function(test){match=dw.regex.match(test.text,candidate);if(tests.length===1){if((candidate.before===undefined)&&(candidate.after===undefined)){var code;if(candidate.on.source.length===1){code=candidate.on.source.charCodeAt(0);if(!(code>64&&code<91)&&!(code>96&&code<123)&&!(code>47&&code<58)){return false;}}if(candidate.on.source[0]==="\\"&&candidate.on.source.length===2){code=candidate.on.source.charCodeAt(1);if(!(code>64&&code<91)&&!(code>96&&code<123)&&!(code>47&&code<58)){return false;}}}}return(match.length<2||((candidate.before===undefined)&&match[1].start!==test.start)||((candidate.after===undefined)&&match[1].end!==test.end));}).length===0;});return candidates;}return[];};var collapse=function(regexArray){var joined=regexArray.map(function(r){return r.toString().replace(/^\/|\/$/g,"");}).join("");return new RegExp(joined);};r.parse=function(str,startCursor,endCursor,op){str=String(str);var token=/([a-zA-Z]+)|([0-9]+)|([^a-zA-Z0-9])/g;var match=(str.substring(0,startCursor).match(token)||[]).concat(str.substring(startCursor,endCursor).match(token)||[]).concat(str.substring(endCursor).match(token)||[]);var o=op||{},code,records,startIndex,endIndex,index=0,on,before,after,matchAfter=o.matchAfter||2,matchBefore=o.matchBefore||2;if(!Array.prototype.filter){Array.prototype.filter=function(callback){var i=0,l=this&&this.length||0,out=[],value;for(;i<l;++i){value=this[i];if(callback(value,i,this)){out.push(value);}}return out;};}if(!Array.prototype.map){Array.prototype.map=function(callback){var i=0,l=this&&this.length||0,out=new Array(l);for(;i<l;++i){out[i]=callback(this[i],i,this);}return out;};}if(!Array.prototype.reduce){Array.prototype.reduce=function(callback,initialValue){if(this===null){throw new TypeError("Array.prototype.reduce called on null or undefined");}if(typeof callback!=="function"){throw new TypeError(callback+" is not a function");}var t=Object(this),len=t.length>>>0,k=0,value;if(arguments.length===2){value=initialValue;}else{while(k<len&&!(k in t)){k++;}if(k>=len){throw new TypeError("Reduce of empty array with no initial value");}value=t[k++];}for(;k<len;k++){if(k in t){value=callback(value,t[k],k,t);}}return value;};}if(!Array.prototype.forEach){Array.prototype.forEach=function(callback){var i=0,l=this&&this.length||0;for(;i<l;++i){callback(this[i],i,this);}};}match=match.filter(function(m){return m!==null;});records=match.map(function(m,ind){code=m.charCodeAt(0);if(startCursor>=index&&startCursor<index+m.length){startIndex=ind;}if(endCursor>index&&endCursor<=index+m.length){endIndex=ind;}index+=m.length;if((code>64&&code<91)||(code>96&&code<123)){return stringRecord(m);}if(code>47&&code<58){return numberRecord(m);}return symbolRecord(m);});if(startIndex===undefined){startIndex=match.length-1;}if(endIndex===undefined){endIndex=match.length-1;}if(endIndex-startIndex>10){on=[[]];records.slice(startIndex,endIndex+1).forEach(function(i){on[0].push(i[0]);});}else{on=records.slice(startIndex,endIndex+1).reduce(function(a,b){var cross=[];a.forEach(function(i){b.forEach(function(j){cross.push(i.concat(j));});});return cross;},[[]]);}var enumerate=function(a,b){var cross=[];if(a.length){a.forEach(function(i){b.forEach(function(j){cross.push(i.concat(j));});});return a.concat(cross);}return b.map(function(j){return[j];});};after=records.slice(Math.max(startIndex-matchAfter,0),startIndex).reverse().reduce(enumerate,[]);before=records.slice(endIndex+1,Math.min(endIndex+matchBefore+1,records.length)).reduce(enumerate,[]);return{on:on.map(collapse),after:(after||[]).map(function(x){return collapse(x.reverse());}),before:(before||[]).map(function(x){return collapse(x);})};};return r;};dw.regex.record=function(text,start,end,col,row,table){return{text:text,start:start,end:end,col:col,row:row,table:table};};dw.regex.friendly_description=function(reg){var regex=reg.toString().replace(/^\/|\/$/g,"");regex=regex.replace(/\n/g,"newline");regex=regex.replace(/ /g," ");regex=regex.replace(/\t/g,"tab");regex=regex.replace(/\(?(\[0\-9\]|\\d)\+\)?/g,"any number");regex=regex.replace(/\(?(\[a\-z\A\-Z\]|\[A\-Z\a\-\z\])\+\)?/g,"any word");regex=regex.replace(/\(?(\[a\-z\])\+\)?/g,"any lowercase word");regex=regex.replace(/\(?(\[A\-Z\])\+\)?/g,"any uppercase word");regex=regex.replace("\\","");if(regex==="newline"){return regex;}return regex;};dw.regex.match=function(value,params){if(!value){return"";}var max_splits=params.max_splits;if(max_splits===undefined){max_splits=1;}var remainder_to_split={start:0,end:value.length,value:value};var splits=[];var numSplit=0;var which=Number(params.which);var occurrence;if(isNaN(which)){which=1;}while(max_splits<=0||numSplit<max_splits*which){var s=dw.regex.matchOnce(remainder_to_split.value,params);if(s.length>1){remainder_to_split=s[2];splits.push(s[0]);splits.push(s[1]);occurrence=0;}else{break;}numSplit++;if(numSplit>1000){break;}}splits.push(remainder_to_split);occurrence=0;var newSplits=[];var prefix="";var i;for(i=0;i<splits.length;++i){if(i%2===1){occurrence++;if(occurrence===which){newSplits.push({value:prefix,start:0,end:prefix.length});newSplits.push({start:prefix.length,end:prefix.length+splits[i].value.length,value:splits[i].value});occurrence=0;prefix="";continue;}}prefix+=splits[i].value;}newSplits.push({start:0,end:prefix.length,value:prefix});return newSplits;};dw.regex.matchOnce=function(value,params){var positions=params.positions;var splits=[];var split_start,split_end;if(positions&&positions.length){if(positions.length===2){if(value.length>=positions[1]){split_start=positions[0];split_end=positions[1];splits.push({start:0,end:split_start,value:value.substr(0,split_start)});splits.push({start:split_start,end:split_end,value:value.substr(split_start,split_end-split_start)});splits.push({start:split_end,end:value.length,value:value.substr(split_end)});return splits;}return[{start:0,end:value.length,value:value}];}}var before=params.before;var after=params.after;var on=params.on;var ignore_between=params.ignore_between;var remainder=value;var remainder_offset=0;var start_split_offset=0;var match;while(remainder.length){var valid_split_region=remainder;var valid_split_region_offset=0;start_split_offset=remainder_offset;if(ignore_between){match=remainder.match(ignore_between);if(match){valid_split_region=valid_split_region.substr(0,match.index);remainder_offset+=match.index+match[0].length;remainder=remainder.substr(match.index+match[0].length);}else{remainder="";}}else{remainder="";}if(after){match=valid_split_region.match(after);if(match){valid_split_region_offset=match.index+match[0].length;valid_split_region=valid_split_region.substr(valid_split_region_offset);}else{continue;}}if(before){match=valid_split_region.match(before);if(match){valid_split_region=valid_split_region.substr(0,match.index);}else{continue;}}match=valid_split_region.match(on);if(match){split_start=start_split_offset+valid_split_region_offset+match.index;split_end=split_start+match[0].length;splits.push({start:0,end:split_start,value:value.substr(0,split_start)});splits.push({start:split_start,end:split_end,value:value.substr(split_start,split_end-split_start)});splits.push({start:split_end,end:value.length,value:value.substr(split_end)});return splits;}}return[{start:0,end:value.length,value:value}];};function getPreviewData(){var model=this.model;var callback={success:function(res){model.populateData(res);},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var params={},postParams={};params={project:model.projectID,start:model.start,limit:model.limit};postParams={engine:this.model.engine};this.dataService.getPreviewData(callback,params,postParams);}function getColumns(){var model=this.model;var callback={success:function(res){model.populateColumns(res.columnModel);},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var params;params={project:model.projectID};this.dataService.getColumns(callback,params);}function getHistory(){var model=this.model;var callback={success:function(res){model.populateHistory(res);},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var params={project:model.projectID};this.dataService.getHistory(callback,params);}function getOperations(){var model=this.model;var me=this;var callback={success:function(res){model.populateOperations(res);me.raiseEvent({name:"RefineStarted"});var tableID=me.tableID;var controller=mstrApp.getRootController();var diModel=controller.model;var source=diModel.importSources[tableID];if(!source.inRefine){source.inRefine=true;source.RefineOperations=res.entries;}},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var params={project:model.projectID};this.dataService.getOperations(callback,params);}function getProcesses(progress,fn){var controller=this;var model=this.model;var callback={success:function(res){if(!res.processes.length){if(typeof fn==="function"){fn();}else{controller.loadData();}}else{getProcesses.call(controller,res.processes[0].progress/100);}},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var params={project:model.projectID};var config={progress:0};if(progress){config.progress=progress;}this.dataService.getProcesses(callback,params,config);}mstrmojo.Refine.RefineController=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.Refine.RefineController",refinePanel:null,parsePanel:null,records:[],start:function(refineServerURL){if(!this.dataService){this.dataService=new mstrmojo.Refine.DataService({model:this.model,projectID:this.model.rpid,refineServerURL:refineServerURL});}this.loadData();this.loadSampleStatus();this.model.attachEventListener("startChange",this.id,this.handleStartChanged);this.model.attachEventListener("columnUnSelected",this.id,this.handleColumnUnSelected);},applyOperations:function applyOperations(postParams,isUndoRedo){var controller=this;var model=this.model;var callback={success:function(res){if(res.code==="ok"){controller.loadData();}else{if(res.code==="pending"){getProcesses.call(controller);}else{if(res.code==="error"){controller.loadData();var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}}}},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var params={project:model.projectID};var hasFillOrBlank=false,isRollBack=true;if(postParams.hasOwnProperty("lastDoneID")){for(var i=0;i<model.history.future.length;i++){if(model.history.future[i].op){hasFillOrBlank=true;}if(postParams.lastDoneID.toString()===model.history.future[i].id.toString()){isRollBack=false;break;}}}if(isUndoRedo){model.start=0;model.limit=50;if(model.hasAddSample()&&hasFillOrBlank&&!isRollBack){RefineHelpers.confirmFilldownOrBlankdown(function(){controller.dataService.undoRedo(callback,params,postParams);});}else{this.dataService.undoRedo(callback,params,postParams);}}else{this.dataService.applyOperations(callback,params,postParams);}},MergeCluster:function MergeCluster(postParams,onDone){var controller=this;var model=this.model;var callback={success:function(res){if(res.code==="ok"){controller.loadData();onDone();}else{if(res.code==="pending"){getProcesses.call(controller);}}},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var params={project:model.projectID};this.dataService.massEdit(callback,params,postParams);},computeFacets:function(){var me=this;var model=this.model;var callback={success:function(res){if(res.code==="error"){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");return ;}me.refinePanel.bottomPanal.splitter.facetPanel.handleFacetsFetched(res);me.refinePanel.topPanal.RefineTransformations.transformationList.setItems();getPreviewData.call(me);},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var postParams={engine:this.refinePanel?JSON.stringify(this.refinePanel.bottomPanal.splitter.facetPanel.getJSON(true)):this.model.engine};var params={project:model.projectID};this.dataService.computeFacets(callback,params,postParams);},computeClusters:function(postParams){var model=this.model;var callback={success:function(res){model.raiseEvent({name:"clustersFetched",clusters:res});model.raiseEvent({name:"columnUnSelected"});},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var params={project:model.projectID};this.dataService.computeClusters(callback,params,postParams);},loadData:function(){getColumns.call(this);getHistory.call(this);getOperations.call(this);this.computeFacets();},rollBackOperations:function(postParams){var controller=this;var model=this.model;var params={project:model.projectID};var callback2={success:function(){},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};var callback={success:function(){controller.dataService.applyOperations(callback2,params,postParams);},failure:function(res){var diController=mstrApp.getRootController();diController.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};model.start=0;model.limit=50;this.dataService.undoRedo(callback,params,{lastDoneID:0});},addFacets:function(type,config){this.refinePanel.bottomPanal.splitter.facetPanel.addFacets(type,config);},getRefinePanel:function getRefinePanel(){this.refinePanel=new mstrmojo.Refine.RefinePanel({controller:this});this.model.attachEventListener("sampleStatusChange",this.refinePanel.id,this.refinePanel.handleSampleStatusChanged);var preview=new mstrmojo.Refine.RefineDataPreview({controller:this});if(this.model.data.rows){preview.populate(this.model.data);}this.model.attachEventListener("dataChange",preview.id,preview.handleDataChanged);this.model.attachEventListener("columnsChange",preview.id,preview.handleColumnsChanged);this.model.attachEventListener("unHighlightSuggestion",preview.id,preview.handleUnHighlightSuggestion);this.model.attachEventListener("startChange",preview.id,preview.handleStartChange);this.model.attachEventListener("columnSelected",preview.id,preview.handleColumnSelected);this.model.attachEventListener("columnUnSelected",preview.id,preview.handleColumnUnSelected);preview.slot="firstSplitNode";preview.alias="refinePreview";this.refinePanel.bottomPanal.splitter.addChildren(preview);var suggestionPreview=new mstrmojo.Refine.RefineSuggestionPreview({controller:this});this.model.attachEventListener("previewSuggestion",suggestionPreview.id,suggestionPreview.handlePreviewSuggestion);this.model.attachEventListener("unPreviewSuggestion",suggestionPreview.id,suggestionPreview.handleUnPreviewSuggestion);this.model.attachEventListener("previewScrollTop",suggestionPreview.id,suggestionPreview.handlePreviewScrollTop);suggestionPreview.slot="firstSplitNode";this.refinePanel.bottomPanal.splitter.addChildren(suggestionPreview);var transformations=new mstrmojo.Refine.RefineTransformations({controller:this});this.model.attachEventListener("columnsChange",transformations.id,transformations.handleColumnsChanged);this.model.attachEventListener("columnSelected",transformations.id,transformations.handleColumnSelected);this.model.attachEventListener("columnUnSelected",transformations.id,transformations.handleColumnUnSelected);this.refinePanel.topPanal.addChildren([transformations]);var historyList=new mstrmojo.Refine.RefineHistoryList({controller:this});historyList.populate(this.model.history);this.model.attachEventListener("historyChange",historyList.id,historyList.handleListChanged);this.refinePanel.topPanal.addChildren([historyList]);var splitControl=new mstrmojo.Refine.RefineControlSplit({controller:this,operations:this.model.transformations.split,parentBox:transformations});splitControl.slot="controlNode";transformations.addChildren([splitControl]);var whitespaceControl=new mstrmojo.Refine.RefineControlWhitespace({controller:this,operations:this.model.transformations.Whitespace,parentBox:transformations});whitespaceControl.slot="controlNode";transformations.addChildren([whitespaceControl]);var transformCellControl=new mstrmojo.Refine.RefineControlTransformCell({controller:this,operations:this.model.transformations.TransformCell,parentBox:transformations});transformCellControl.slot="controlNode";transformations.addChildren([transformCellControl]);var deleteControl=new mstrmojo.Refine.RefineControlDelete({controller:this,operations:this.model.transformations.Delete,parentBox:transformations});deleteControl.slot="controlNode";transformations.addChildren([deleteControl]);var extractControl=new mstrmojo.Refine.RefineControlExtract({controller:this,operations:this.model.transformations.Extract,parentBox:transformations});extractControl.slot="controlNode";transformations.addChildren([extractControl]);var FacetControl=new mstrmojo.Refine.RefineControlFacet({controller:this,operations:this.model.transformations.Facet,parentBox:transformations});FacetControl.slot="controlNode";transformations.addChildren([FacetControl]);var findAndReplaceControl=new mstrmojo.Refine.RefineControlFindAndReplace({controller:this,operations:this.model.transformations.FindAndReplace,parentBox:transformations});findAndReplaceControl.slot="controlNode";transformations.addChildren([findAndReplaceControl]);var removeTextControl=new mstrmojo.Refine.RefineControlRemoveText({controller:this,operations:this.model.transformations.FindAndReplace,parentBox:transformations});removeTextControl.slot="controlNode";transformations.addChildren([removeTextControl]);var otherControl=new mstrmojo.Refine.RefineControlOther({controller:this,operations:this.model.transformations.Other,parentBox:transformations});otherControl.slot="controlNode";this.model.attachEventListener("columnsChange",otherControl.id,otherControl.handleColumnsChanged);this.model.attachEventListener("columnUnSelected",otherControl.id,otherControl.handleColumnUnSelected);transformations.addChildren([otherControl]);var suggestions=new mstrmojo.Refine.RefineSuggestions({controller:this});suggestions.slot="suggestionsNode";transformations.addChildren([suggestions]);this.model.attachEventListener("dataChange",suggestions.id,suggestions.handleDataChanged);this.model.attachEventListener("columnsChange",suggestions.id,suggestions.handleColumnsChanged);this.model.attachEventListener("gotSuggestions",suggestions.id,suggestions.handleGotSuggestions);this.model.attachEventListener("emptySuggestions",suggestions.id,suggestions.handleEmptySuggestions);return this.refinePanel;},generateSuggestions:function generateSuggestions(index,columnName,text,textLength,startOffset,endOffset,columns,cell){var i=1,j,operation,suggestion,suggestions=[];var newColumn,newColumnName,unique;while(true){newColumnName=columnName+" "+i;unique=true;for(j=0;j<columns.length;j++){if(newColumnName===columns[j].name){unique=false;break;}}i++;if(unique){newColumn=newColumnName;break;}}if(startOffset===0){operation=JSON.parse(JSON.stringify(this.model.transformations.split.byFieldLengths));operation.description=operation.description.replace("[column name]",columnName);operation.columnName=columnName;operation.fieldLengths.push(endOffset);operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.split[0]));suggestion.operations=JSON.stringify([operation]);suggestion.startOffset=-1;suggestion.endOffset=endOffset;suggestion.index=index;suggestions.push(suggestion);}else{if(textLength===endOffset){operation=JSON.parse(JSON.stringify(this.model.transformations.split.byFieldLengths));operation.description=operation.description.replace("[column name]",columnName);operation.columnName=columnName;operation.fieldForward=false;operation.fieldLengths.push(endOffset-startOffset);operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.split[0]));suggestion.operations=JSON.stringify([operation]);suggestion.startOffset=endOffset-startOffset;suggestion.endOffset=-1;suggestion.index=index;suggestions.push(suggestion);}else{operation=JSON.parse(JSON.stringify(this.model.transformations.split.byFieldLengths));operation.description=operation.description.replace("[column name]",columnName);operation.columnName=columnName;operation.fieldLengths.push(startOffset);operation.fieldLengths.push(endOffset-startOffset);operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.split[0]));suggestion.operations=JSON.stringify([operation]);suggestion.startOffset=startOffset;suggestion.endOffset=endOffset;suggestion.index=index;suggestions.push(suggestion);}}var record={text:text,start:startOffset,end:endOffset,col:index,cell:cell};if(this.records.length===0||record.col===this.records[0].col){if(this.records.length>0){for(j=0;j<this.records.length;j++){if(this.records[j].cell===cell){this.records.splice(j,1);}}}this.records.push(record);}else{if(this.records.length!==0){this.resetRecords();}this.records=[record];}cell.highlightSelectedText(startOffset,endOffset);var candidate,candidates=dw.regex().candidates(this.records);while(this.records.length>0&&candidates.length===0){this.records[0].cell.resetText();this.records=this.records.slice(1);candidates=dw.regex().candidates(this.records);}for(j=0;j<candidates.length;j++){candidate=candidates[j];if(candidate.before!==undefined){operation=JSON.parse(JSON.stringify(this.model.transformations.split.beforeFirst));operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("####",escapeSpecial(candidate.before.toString()));operation.columnName=columnName;operation.separator=candidate.before.source;operation.regex=true;operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.split[1]));suggestion.description=suggestion.description.replace("####",'"'+mstrmojo.string.encodeHtmlString(dw.regex.friendly_description(candidate.before),false,true)+'"');suggestion.operations=JSON.stringify([operation]);suggestion.index=index;suggestion.separator=candidate.before;suggestions.push(suggestion);}else{if(candidate.after!==undefined){operation=JSON.parse(JSON.stringify(this.model.transformations.split.afterFirst));operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("####",escapeSpecial(candidate.after.toString()));operation.columnName=columnName;operation.separator=candidate.after.source;operation.regex=true;operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.split[2]));suggestion.description=suggestion.description.replace("####",'"'+mstrmojo.string.encodeHtmlString(dw.regex.friendly_description(candidate.after),false,true)+'"');suggestion.operations=JSON.stringify([operation]);suggestion.index=index;suggestion.separator=candidate.after;suggestions.push(suggestion);}else{operation=JSON.parse(JSON.stringify(this.model.transformations.split.bySeparator));operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("####",escapeSpecial(candidate.on.toString()));operation.columnName=columnName;operation.separator=candidate.on.source;operation.regex=true;operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.split[3]));suggestion.description=suggestion.description.replace("####",'"'+mstrmojo.string.encodeHtmlString(dw.regex.friendly_description(candidate.on),false,true)+'"');suggestion.operations=JSON.stringify([operation]);suggestion.index=index;suggestion.separator=candidate.on;suggestions.push(suggestion);}}}for(j=0;j<candidates.length;j++){candidate=candidates[j];if(candidate.before!==undefined){operation=JSON.parse(JSON.stringify(this.model.transformations.Extract.beforeFirst));operation.description=operation.description.replace("[new column name]",newColumn);operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("[index]",index+1);operation.description=operation.description.replace("####",escapeSpecial(candidate.before.toString()));operation.columnInsertIndex=index+1;operation.newColumnName=operation.newColumnName.replace("[column name]",newColumn);operation.baseColumnName=operation.baseColumnName.replace("[column name]",columnName);operation.expression=operation.expression.replace(new RegExp("\\[separator\\]","gm"),candidate.before);operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.extract[0]));suggestion.description=suggestion.description.replace("####",'"'+mstrmojo.string.encodeHtmlString(dw.regex.friendly_description(candidate.before),false,true)+'"');suggestion.operations=JSON.stringify([operation]);suggestion.index=index;suggestion.separator=candidate.before;suggestions.push(suggestion);}else{if(candidate.after!==undefined){operation=JSON.parse(JSON.stringify(this.model.transformations.Extract.afterFirst));operation.description=operation.description.replace("[new column name]",newColumn);operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("[index]",index+1);operation.description=operation.description.replace("####",escapeSpecial(candidate.after.toString()));operation.columnInsertIndex=index+1;operation.newColumnName=operation.newColumnName.replace("[column name]",newColumn);operation.baseColumnName=operation.baseColumnName.replace("[column name]",columnName);operation.expression=operation.expression.replace(new RegExp("\\[separator\\]","gm"),candidate.after);operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.extract[1]));suggestion.description=suggestion.description.replace("####",'"'+mstrmojo.string.encodeHtmlString(dw.regex.friendly_description(candidate.after),false,true)+'"');suggestion.operations=JSON.stringify([operation]);suggestion.index=index;suggestion.separator=candidate.after;suggestions.push(suggestion);}else{operation=JSON.parse(JSON.stringify(this.model.transformations.Extract.on));operation.description=operation.description.replace("[new column name]",newColumn);operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("[index]",index+1);operation.description=operation.description.replace("####",escapeSpecial(candidate.on.toString()));operation.columnInsertIndex=index+1;operation.newColumnName=operation.newColumnName.replace("[column name]",newColumn);operation.baseColumnName=operation.baseColumnName.replace("[column name]",columnName);operation.expression=operation.expression.replace(new RegExp("\\[separator\\]","gm"),candidate.on);operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.extract[2]));suggestion.description=suggestion.description.replace("####",'"'+mstrmojo.string.encodeHtmlString(dw.regex.friendly_description(candidate.on),false,true)+'"');suggestion.operations=JSON.stringify([operation]);suggestion.index=index;suggestion.separator=candidate.on;suggestions.push(suggestion);}}}for(j=0;j<candidates.length;j++){candidate=candidates[j];if(candidate.before!==undefined){operation=JSON.parse(JSON.stringify(this.model.transformations.FindAndReplace.CutBefore));operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("####",escapeSpecial(candidate.before.toString()));operation.columnName=columnName;operation.expression=operation.expression.replace(new RegExp("\\[separator\\]","gm"),candidate.before);operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.cut[0]));suggestion.description=suggestion.description.replace("####",'"'+mstrmojo.string.encodeHtmlString(dw.regex.friendly_description(candidate.before),false,true)+'"');suggestion.operations=JSON.stringify([operation]);suggestion.index=index;suggestion.separator=candidate.before;suggestions.push(suggestion);}else{if(candidate.after!==undefined){operation=JSON.parse(JSON.stringify(this.model.transformations.FindAndReplace.CutAfter));operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("####",escapeSpecial(candidate.after.toString()));operation.columnName=columnName;operation.expression=operation.expression.replace(new RegExp("\\[separator\\]","gm"),candidate.after);operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.cut[1]));suggestion.description=suggestion.description.replace("####",'"'+mstrmojo.string.encodeHtmlString(dw.regex.friendly_description(candidate.after),false,true)+'"');suggestion.operations=JSON.stringify([operation]);suggestion.index=index;suggestion.separator=candidate.after;suggestions.push(suggestion);}else{operation=JSON.parse(JSON.stringify(this.model.transformations.FindAndReplace.CutOn));operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("####",escapeSpecial(candidate.on.toString()));operation.columnName=columnName;operation.expression=operation.expression.replace("[separator]",candidate.on);operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.cut[2]));suggestion.description=suggestion.description.replace("####",'"'+mstrmojo.string.encodeHtmlString(dw.regex.friendly_description(candidate.on),false,true)+'"');suggestion.operations=JSON.stringify([operation]);suggestion.index=index;suggestion.separator=candidate.on;suggestions.push(suggestion);}}}operation=JSON.parse(JSON.stringify(this.model.transformations.Delete.RowsContains));operation.engineConfig.facets[0].query=text.substring(startOffset,endOffset);operation.description=operation.description.replace("####","'"+escapeSpecial(replaceDollar(text.substring(startOffset,endOffset)))+"'");operation.description=operation.description.replace("[column name]",columnName);operation.engineConfig.facets[0].name=operation.engineConfig.facets[0].columnName=columnName;operation.engineConfig.facets[0].mode="text";operation.engineConfig.facets=operation.engineConfig.facets.concat(JSON.parse(this.model.engine).facets);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.partialCell.deleteRows[0]));suggestion.description=suggestion.description.replace("####","'"+mstrmojo.string.encodeHtmlString(escapeSpecial(replaceDollar(text.substring(startOffset,endOffset))),false,true)+"'");suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);var windowWidth=(window.innerWidth||document.documentElement.clientWidth);var cellRect=cell.domNode.getBoundingClientRect();var distanceToLeft=cellRect.left;var distanceToRight=windowWidth-cellRect.right;var tableRect=cell.preview.domNode.getBoundingClientRect();var cellPos={tableTop:tableRect.top,cellLeft:cellRect.left,cellRight:cellRect.right,distanceToLeft:distanceToLeft,distanceToRight:distanceToRight};this.model.raiseEvent({name:"gotSuggestions",src:this,list:suggestions,cellPos:cellPos});},generateColumnSuggestions:function generateColumnSuggestions(ColumnIndex,fromColumnName,toColumnName,Count){var operation,suggestion,suggestions=[];var refinePreview=this.refinePanel.bottomPanal.splitter.refinePreview;var data=refinePreview.data;var columns=refinePreview.columns;var ColumnName=columns[ColumnIndex].name;var cell=data.rows[0]?data.rows[0].cells[columns[ColumnIndex].cellIndex]:null,cellType="text";if(cell){if(cell.t){cellType="date";}else{if(typeof cell.v==="string"||cell.v instanceof String){cellType="text";}else{cellType="number";}}}if(fromColumnName){operation=JSON.parse(JSON.stringify(this.model.transformations.Other.TransposeColumnsIntoRows));operation.description=operation.description.replace("####",Count);operation.description=operation.description.replace("@@@@",fromColumnName);operation.description=operation.description.replace("@@@@","Transpose:key");operation.description=operation.description.replace("@@@@","Transpose:value");operation.startColumnName=fromColumnName;operation.keyColumnName="Transpose:key";operation.valueColumnName="Transpose:value";operation.columnCount=Count;suggestion=JSON.parse(JSON.stringify(this.model.suggestions.column[8]));suggestion.description=suggestion.description.replace("####",fromColumnName);suggestion.description=suggestion.description.replace("@@@@",toColumnName);suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);}operation=JSON.parse(JSON.stringify(this.model.transformations.Delete.Colomn));operation.description=operation.description.replace("[column name]",ColumnName);operation.columnName=ColumnName;suggestion=JSON.parse(JSON.stringify(this.model.suggestions.column[0]));suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);operation=JSON.parse(JSON.stringify(this.model.transformations.TransformCell.fillDown));operation.description=operation.description.replace("[column name]",ColumnName);operation.columnName=ColumnName;operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.column[1]));suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);operation=JSON.parse(JSON.stringify(this.model.transformations.TransformCell.blankDown));operation.description=operation.description.replace("[column name]",ColumnName);operation.columnName=ColumnName;operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.column[2]));suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);if(cellType==="text"){operation=JSON.parse(JSON.stringify(this.model.transformations.TransformCell.titlecase));operation.description=operation.description.replace("[column name]",ColumnName);operation.columnName=ColumnName;operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.column[3]));suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);operation=JSON.parse(JSON.stringify(this.model.transformations.TransformCell.uppercase));operation.description=operation.description.replace("[column name]",ColumnName);operation.columnName=ColumnName;operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.column[4]));suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);operation=JSON.parse(JSON.stringify(this.model.transformations.TransformCell.lowercase));operation.description=operation.description.replace("[column name]",ColumnName);operation.columnName=ColumnName;operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.column[5]));suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);operation=JSON.parse(JSON.stringify(this.model.transformations.Whitespace.collapse));operation.description=operation.description.replace("[column name]",ColumnName);operation.columnName=ColumnName;operation.engineConfig=JSON.parse(this.model.engine);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.column[7]));suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);}var name=ColumnName;if(ColumnName.length>50){name=ColumnName.substring(0,50)+"...";}operation=JSON.parse(JSON.stringify(this.model.transformations.Delete.RowsBlank));operation.description=operation.description.replace("[column name]",ColumnName);operation.engineConfig.facets[0].name=operation.engineConfig.facets[0].columnName=ColumnName;operation.engineConfig.facets=operation.engineConfig.facets.concat(JSON.parse(this.model.engine).facets);suggestion=JSON.parse(JSON.stringify(this.model.suggestions.column[6]));suggestion.description=suggestion.description.replace("[column name]",name);suggestion.operations=JSON.stringify([operation]);suggestions.push(suggestion);this.model.raiseEvent({name:"gotSuggestions",src:this,list:suggestions});},handleStartChanged:function(){getPreviewData.call(this);},handleColumnUnSelected:function(){this.resetRecords();},resetRecords:function(){for(var j=0;j<this.records.length;j++){this.records[j].cell.resetText();}this.records=[];},setSampleData:function(num){var ctrl=this,diCtrl=mstrApp.getRootController(),model=ctrl.model,params={project:model.projectID};function failureHandler(res){diCtrl.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}ctrl.dataService.setSampleData({success:function(res){if(res.code==="error"){ctrl.loadData();failureHandler(res);return ;}model.populateSampleStatus(res);ctrl.loadData();},failure:failureHandler},params,{row_num:num});},loadSampleStatus:function(){var ctrl=this,diCtrl=mstrApp.getRootController(),model=ctrl.model,params={project:model.projectID};function failureHandler(res){diCtrl.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}ctrl.dataService.getSampleStatus({success:function(res){if(res.code==="error"){failureHandler(res);return ;}if(res.hasSample){model.hasUploadData=true;model.populateSampleStatus(res);}else{model.hasUploadData=false;}},failure:failureHandler},params);}});}());