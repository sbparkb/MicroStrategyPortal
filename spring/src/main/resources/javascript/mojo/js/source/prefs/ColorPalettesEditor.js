(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.css","mstrmojo.color","mstrmojo.dom","mstrmojo.func","mstrmojo.Label","mstrmojo.EditableLabel","mstrmojo.Box","mstrmojo.Editor","mstrmojo.MultipleColorsPicker","mstrmojo.ui.List","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.ui.menus.MenuConfig","mstrmojo.ui.editors.controls.ListPreviewButton");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$FUNC=mstrmojo.func,$COLOR=mstrmojo.color,LIGHT_THEME_ID="21E8ECEA4EACEA161B5828BD79A4B1E2",DARK_THEME_ID="F1FED8AC42B57AC1B0E9518FED0F89D6",DESC_LIGHT=mstrmojo.desc(8959,"Light"),DESC_DARK=mstrmojo.desc(8958,"Dark"),TYPE_SYSTEM_PALETTE=1,TYPE_CUSTOM_PALETTE=2,TYPE_PALETTE=71,CLS_MENU_OPENED="hasMenuOpened",CLS_EDITOR_OPENED="hasEditorOpened",CLS_COLOR_ICON="colorIcon",CLS_LIGHT_TOGGLER="lightToggler",CLS_DARK_TOGGLER="darkToggler",_reNameInMarkup=/\{[^{}]*@n\}/;var NEW_PLT="NEW_PLT_",NEW_PLT_CNT=0,ERR_NOT_EXISTED="-2147216373",ACTION={CREATING:"creating",EDITING:"editing",DELETING:"deleting"};function appendHTMLToNode(node,html){var div=document.createElement("div");div.innerHTML=html;var resultNode=div.firstChild;node.appendChild(resultNode);return resultNode;}function getErrMsgHTML(content){return'<div class="mstrmojo-ErrorMessage mstrmojo-Tooltip vi-regular vi-tooltip-C"><div class="mstrmojo-Tooltip-contentWrapper"><div class="mstrmojo-Tooltip-content">'+(content||"")+"</div></div></div>";}function getStateIndicatorHTML(){return'<div class="mstrmojo-StateIndicator"></div>';}function getLabel(text,cls,props){return $HASH.copy(props,{scriptClass:"mstrmojo.Label",text:text,cssClass:cls||""});}function getDefaultPaletteCfg(themedid,pltPage){var proto=mstrmojo.ui.editors.controls.ListPreviewButton.prototype;return{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-PaletteSelector",themedid:themedid,children:[getLabel("","",{alias:"label"}),{scriptClass:"mstrmojo.ui.editors.controls.ListPreviewButton",alias:"selector",itemValueField:"pltid",isHostedWithin:true,getListCfg:function getListCfg(){return $HASH.copy({postCreate:function postCreate(){$FUNC.override({getItemMarkup:function getItemMarkup(item,idx){return this._super(item,idx).replace(_reNameInMarkup,"{@pltColorsHTML}");},getItemProps:function getItemProps(pltItem,idx){return $HASH.copy({pltColorsHTML:getPaletteColorsHTML(pltItem.colors)},this._super(pltItem,idx));}},this);}},proto.getListCfg.call(this));},updatePreview:function updatePreview(){if(this.previewNode){this.previewNode.innerHTML=getPaletteColorsHTML(findItem(this.items,"pltid",this.selectedValue).colors);}},postselectedValueChange:function postselectedValueChange(){if(!this._initializing){pltPage.doSetDefaultPalette(this.parent.themedid,this.selectedValue);}},postBuildRendering:function(){proto.postBuildRendering.call(this);appendHTMLToNode(this.domNode,getStateIndicatorHTML());this.errorContentNode=appendHTMLToNode(this.domNode,getErrMsgHTML()).firstChild;}}]};}function getPaletteColorsHTML(encodedColors){var colorIconsHTML=$ARR.map(encodedColors,function(color){return'<div class="'+CLS_COLOR_ICON+'" style="background-color: '+$COLOR.decodeColor(color)+'"></div>';}).join("");return'<div class="paletteColors">'+colorIconsHTML+"</div>";}function findItem(arr,n,v){var idx=$ARR.find(arr,n,v);return idx!==-1?arr[idx]:null;}function _openPaletteEditor(pltPref,pltid,colors,config){var paletteEditorId="mstrColorPalette";if(!mstrmojo.all[paletteEditorId]){mstrmojo.insert({scriptClass:"mstrmojo.MultipleColorsPicker",id:paletteEditorId,zIndex:11});}config=config||{};config.top=config.top||"";config.left=config.left||"";config.onClose=config.onClose||mstrmojo.emptyFn;mstrmojo.all[paletteEditorId].open(pltPref,$HASH.copy(config,{colors:$ARR.map(colors,function(encodedColor){return $COLOR.decodeColor(encodedColor);}),onOK:function onOK(){var encodedColors=$ARR.map(this.colors,function(clr){return $COLOR.encodeColor(clr);});if(!pltid){pltPref.doNewPalette(encodedColors);}else{pltPref.doUpdatePaletteColors(encodedColors,pltid);}}}));}function openPaletteEditorForEditing(pltPref,pltid,colors,itemNode,mousePos){$CSS.addClass(itemNode,CLS_EDITOR_OPENED);_openPaletteEditor(pltPref,pltid,colors,{top:mousePos.y.toString()+"px",left:mousePos.x.toString()+"px",onClose:function(){$CSS.removeClass(itemNode,CLS_EDITOR_OPENED);}});}function getPaletteBelongThemes(themes,pltid){return $ARR.map($ARR.filter(themes,function(thm){return $ARR.indexOf(thm.plts,pltid)!==-1;}),function(belongThemes){return belongThemes.did;});}function getProcessingActions(obj){var acts=[];$HASH.forEach(obj.actions,function(actCnt,actName){if(actCnt>0){acts.push(actName);}});return acts;}function isPaletteAvailable(plt){var processingActs=getProcessingActions(plt);return $ARR.indexOf(processingActs,ACTION.DELETING)===-1&&($ARR.indexOf(processingActs,ACTION.CREATING)===-1||plt.pltid.indexOf(NEW_PLT)===-1);}function _doUpdatePalette(plt){var me=this,palettes=this.palettes;var config={act:ACTION.EDITING,getErrMsg:function getErrMsg(res){if(res.code===ERR_NOT_EXISTED){return mstrmojo.desc(13718,"This color palette is no longer available.");}else{return mstrmojo.desc(13719,"The changes made to the color palette were not saved. Please try again.");}},onErrorHandled:function onErrorHandled(error){if(error.code===ERR_NOT_EXISTED){$ARR.removeItem(palettes,plt);$ARR.forEach(me.themes,function(thm){$ARR.removeItem(thm.plts,plt.pltid);});}}},callback=this.paletteList.doPaletteAction(plt,config);return callback;}function _getPaletteCfg(paletteEditor){return{scriptClass:"mstrmojo.Container",markupString:'<div id="{@id}" class="item cf {@cssClass}" mstrAttach:click,dblclick,mouseover,mouseout,contextmenu><div class="paletteLabel"></div><div class="paletteColorsContainer"></div><div class="themeMarker light"><div class="'+CLS_LIGHT_TOGGLER+'"></div>'+DESC_LIGHT+'</div><div class="themeMarker dark"><div class="'+CLS_DARK_TOGGLER+'"></div>'+DESC_DARK+'</div><div class="mask"></div><div class="mstrmojo-StateIndicator"></div>{@errorTooltip}</div>',markupSlots:{labelNode:function(){return this.domNode.firstChild;},colorsNode:function(){return this.domNode.childNodes[1];}},pltid:null,actions:null,colors:null,belongThemes:null,n:null,tp:null,children:[{scriptClass:"mstrmojo.EditableLabel",alias:"paletteLabel",slot:"labelNode",onTextEditComplete:function onTextEditComplete(){var text=this.text,pltGroup=this.parent;if(pltGroup.n===text){return ;}if(paletteEditor.isPaletteLabelValid(text)){paletteEditor.doUpdatePaletteLabel(text,pltGroup.pltid);}else{this.set("text",pltGroup.n);}}}],markupMethods:{oncolorsChange:function oncolorsChange(){this.colorsNode.innerHTML=getPaletteColorsHTML(this.colors);},onbelongThemesChange:function onbelongThemesChange(){var belongLightTheme=false,belongDarkTheme=false;$ARR.forEach(this.belongThemes,function(thm){if(thm===LIGHT_THEME_ID){belongLightTheme=true;}else{belongDarkTheme=true;}});$CSS.toggleClass(this.domNode,"belongLightTheme",belongLightTheme);$CSS.toggleClass(this.domNode,"belongDarkTheme",belongDarkTheme);}},postBuildRendering:function postBuildRendering(){var isRendered=mstrmojo.Container.prototype.postBuildRendering.call(this);if(isRendered){$CSS.toggleClass(this.domNode,"paletteEditable",this.isPaletteEditable());this.paletteLabel.set("text",this.n);}return isRendered;},update:function update(props){$HASH.copy(props,this);this.set("colors",this.colors);this.set("belongThemes",this.belongThemes);},isPaletteEditable:function isPaletteEditable(){return this.tp===TYPE_CUSTOM_PALETTE&&isPaletteAvailable(this);},onclick:function onclick(evt){var tgtNode=evt.getTarget(),tgtCls=tgtNode.className;switch(tgtCls){case CLS_COLOR_ICON:var mousePos=$DOM.getMousePosition(evt.e,evt.hWin);openPaletteEditorForEditing(paletteEditor,this.pltid,this.colors,this.domNode,mousePos);break;case CLS_LIGHT_TOGGLER:case CLS_DARK_TOGGLER:paletteEditor.doTogglePaletteTheme(this.pltid,tgtCls===CLS_LIGHT_TOGGLER?LIGHT_THEME_ID:DARK_THEME_ID);break;}},oncontextmenu:function oncontextmenu(evt){$DOM.preventDefault(evt.hWin,evt.e);var tgtNode=evt.getTarget();if(tgtNode.className===CLS_COLOR_ICON){this.showPaletteMenu(evt);}},showPaletteMenu:function showPaletteMenu(evt){var itemNode=this.domNode,mousePos=$DOM.getMousePosition(evt.e,evt.hWin),menuCfg=new mstrmojo.ui.menus.MenuConfig({position:$HASH.copy({h:0,w:0},mousePos),isHostedWithin:false}),me=this;menuCfg.addMenuItem(mstrmojo.desc(1088,"Edit"),"",function(){openPaletteEditorForEditing(paletteEditor,me.pltid,me.colors,itemNode,mousePos);});menuCfg.addMenuItem(mstrmojo.desc(629,"Delete"),"",function(){paletteEditor.doDeletePalette(me.pltid);});$CSS.addClass(itemNode,CLS_MENU_OPENED);paletteEditor.openPopup(menuCfg.newInstance({onClose:function onClose(){$CSS.removeClass(itemNode,CLS_MENU_OPENED);}}));},actionStart:function actionStart(action){var me=this,isFirstAct=getProcessingActions(this).length===0,acts=this.actions=this.actions||{};acts[action]=(acts[action]||0)+1;if(isFirstAct){window.setTimeout(function(){if(getProcessingActions(me).length>0){$CSS.addClass(me.domNode,"showLoading");}},300);}if(acts[action]===1){$CSS.addClass(this.domNode,action);}},actionEnd:function actionEnd(action){var acts=this.actions=this.actions||{};acts[action]--;if(getProcessingActions(this).length===0){$CSS.removeClass(this.domNode,"showLoading");}if(acts[action]===0){$CSS.removeClass(this.domNode,action);}},getCallback:function getCallback(config){var me=this;return{failure:function(res){var error=$HASH.copy(res),errMsg=config.getErrMsg?config.getErrMsg(res):error.originErrmsg;me.errorTooltip=getErrMsgHTML(errMsg);$CSS.addClass(me.domNode,"showError");setTimeout(function(){me.errorTooltip="";$CSS.removeClass(me.domNode,"showError");if(config.onErrorHandled){config.onErrorHandled(error);}me.actionEnd(config.act);},1500);},success:function(){if(config.act===ACTION.DELETING){me.parent.removePalette(me);}},complete:function(){if(config.act!==ACTION.DELETING){me.actionEnd(config.act);}}};}};}function _getPaletteListCfg(pltEditor){return{scriptClass:"mstrmojo.Box",alias:"paletteList",cssClass:"mstrmojo-PaletteList",getPaletteCfg:function getPaletteCfg(props){return $HASH.copy(props,_getPaletteCfg(pltEditor||this.parent));},addPalettes:function addPalettes(items){var me=this;$ARR.forEach(items,function(item){me.addChildren([me.getPaletteCfg(item)]);});},removePalette:function removePalettes(c){this.removeChildren(c);},getPaletteWidget:function getPaletteWidget(pltid){return $ARR.filterOne(this.children,function(c){return c.pltid===pltid;});},doPaletteAction:function doPaletteAction(obj,config){var me=this,targetPlt;if(config.act===ACTION.CREATING){this.showFocus=true;this.addPalettes([obj]);}targetPlt=this.getPaletteWidget(obj.pltid);targetPlt.actionStart(config.act);if(config.act===ACTION.EDITING){targetPlt.update(obj);}if(config.act!==ACTION.CREATING){config=$FUNC.wrapMethods({onErrorHandled:function onErrorHandled(error){if(error.code===ERR_NOT_EXISTED){me.removePalette(targetPlt);}}},config);}return targetPlt.getCallback(config);},updatePaletteID:function updatePaletteID(oldId,newId){var targetPlt=this.getPaletteWidget(oldId);targetPlt.pltid=newId;}};}mstrmojo.prefs.ColorPalettesEditor=mstrmojo.declare(mstrmojo.Box,[mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.prefs.ColorPalettesEditor",cssClass:"mstrmojo-ColorPalettesEditor mojo-theme-light",palettes:null,themes:null,serverRequest:mstrmojo.emptyFn,initData:function initData(paletteThemes){this.palettes=$HASH.clone(paletteThemes.palettes);this.themes=$ARR.map(paletteThemes.themes,function(srcTheme){return $HASH.copyProps(["n","did","dplt"],srcTheme,{plts:$ARR.map(srcTheme.sup,function(pltInfo){return pltInfo.did;})});});this.initPaletteList(this.palettes);},start:function start(initPaletteThemes){this.initData(initPaletteThemes);if(this.palettes.length){this.render();}else{mstrmojo.alert(mstrmojo.desc(13716,"No color palettes available."));}},doNewPalette:function doNewPalette(colors){var me=this,plts=this.palettes,pltName=this.generatePaletteLabel(),newPlt={pltid:NEW_PLT+(++NEW_PLT_CNT).toString(),tp:TYPE_CUSTOM_PALETTE,colors:colors,n:pltName};plts.push(newPlt);var config={act:ACTION.CREATING,getErrMsg:function getErrMsg(){return mstrmojo.desc(13717,"This color palette could not be created. Please try again.");}},callback=this.paletteList.doPaletteAction(newPlt,config);this.serverRequest({taskId:"savePalette",colors:colors.join(","),objectname:pltName},$FUNC.wrapMethods(callback,{success:function success(res){var newPltid=res.pltid;me.paletteList.updatePaletteID(newPlt.pltid,newPltid);newPlt.pltid=newPltid;$ARR.forEach(me.themes,function(thm){me.doTogglePaletteTheme(newPltid,thm.did);});}}));},doUpdatePaletteColors:function doUpdatePaletteColors(colors,pltid){var palettes=this.palettes,plt=findItem(palettes,"pltid",pltid);plt.colors=colors;var callback=_doUpdatePalette.call(this,plt);this.doThemeChanged();this.serverRequest({taskId:"savePalette",objectID:pltid,colors:colors.join(",")},callback);},doUpdatePaletteLabel:function doUpdatePaletteLabel(pltName,pltid){var palettes=this.palettes,plt=findItem(palettes,"pltid",pltid);plt.n=pltName;var callback=_doUpdatePalette.call(this,plt);this.serverRequest({taskId:"renameObject",objectid:pltid,objecttype:TYPE_PALETTE,objectname:plt.n},callback);},doDeletePalette:function doDeletePalette(pltid){var isDefault=!!$ARR.filterOne(this.themes,function(thm){return thm.dplt===pltid;}),me=this,palettes=this.palettes,plt=findItem(palettes,"pltid",pltid),execute=function execute(){$ARR.forEach(getPaletteBelongThemes(me.themes,pltid),function(thmdid){me.doTogglePaletteTheme(pltid,thmdid);});var config={act:ACTION.DELETING,getErrMsg:function getErrMsg(res){if(res.code===ERR_NOT_EXISTED){return mstrmojo.desc(13718,"This color palette is no longer available.");}else{return mstrmojo.desc(13720,"This color palette could not be deleted.  Please try again.");}},onErrorHandled:function onErrorHandled(error){if(error.code===ERR_NOT_EXISTED){$ARR.removeItem(palettes,plt);}}},callback=me.paletteList.doPaletteAction(plt,config);me.serverRequest({taskId:"deletePalette",objectID:pltid},$FUNC.wrapMethods({success:function success(){$ARR.removeItem(me.palettes,plt);}},callback));};if(isDefault){mstrmojo.confirm(mstrmojo.desc(13721,"This is the default color palette of a theme. Do you want to delete it?"),{confirmBtn:{fn:execute}});}else{execute();}},doTogglePaletteTheme:function doTogglePaletteTheme(pltid,themedid){var thm=findItem(this.themes,"did",themedid),plt=findItem(this.palettes,"pltid",pltid),thmPlts=thm.plts,isAdding=$ARR.indexOf(thmPlts,pltid)===-1;if(isAdding){thmPlts.push(pltid);}else{$ARR.removeItem(thmPlts,pltid);if(thm.dplt===pltid){$ARR.forEach(thmPlts,function(thmPltid){if(findItem(this.palettes,"pltid",thmPltid).tp===TYPE_SYSTEM_PALETTE){thm.dplt=thmPltid;return false;}},this);}}var me=this,callback=this.paletteList.doPaletteAction($HASH.copy(plt,{belongThemes:getPaletteBelongThemes(me.themes,pltid)}),{act:ACTION.EDITING});this.doThemeChanged();this.serverRequest({taskId:"updateTheme",themeID:themedid,paletteIDs:pltid,pltAction:isAdding?"add":"remove"},callback);},doSetDefaultPalette:function doSetDefaultPalette(themedid,defPltid){var thm=findItem(this.themes,"did",themedid),me=this;thm.dplt=defPltid;this.doThemeChanged();this.serverRequest({taskId:"updateTheme",themeID:themedid,defPaletteID:defPltid},{failure:function(res){thm.error=$HASH.copy(res);setTimeout(function(){thm.error=null;me.doThemeChanged();},1500);}});},doThemeChanged:function doThemeChanged(){this.defPlts.update(this.themes,$ARR.filter(this.palettes,isPaletteAvailable));},isPaletteLabelValid:function isPaletteLabelValid(label){return $ARR.find(this.palettes,"n",label)<0;},generatePaletteLabel:function generatePaletteLabel(){var pref=mstrmojo.desc(14283,"Untitled Palette #"),labelCnt=1,label=pref.replace("#",labelCnt.toString());while(!this.isPaletteLabelValid(label)){label=pref.replace("#",(++labelCnt).toString());}return label;},initPaletteList:function initPaletteList(){var me=this,fnUpdatePalette=function(plt){return $HASH.copy({belongThemes:getPaletteBelongThemes(me.themes,plt.pltid)},$HASH.copy(plt));};this.paletteList.addPalettes($ARR.map(me.palettes,fnUpdatePalette));this.doThemeChanged();},getPaletteListCfg:function getPaletteListCfg(){return _getPaletteListCfg(this);},openPaletteEditor:function openPaletteEditor(plt,config){_openPaletteEditor(this,plt?plt.pltid:null,plt?plt.colors:[],config);},children:[{scriptClass:"mstrmojo.Widget",markupString:'<div class="EditingWarningText"><div class="icn"></div>'+mstrmojo.desc(14311,"Editing custom color palette may affect dashboards that are currently using it")+"</div>"},getLabel(mstrmojo.desc(13722,"Define color palette:"),"definePalette"),getLabel(mstrmojo.desc(13724,"Available to theme"),"applyToTheme"),_getPaletteListCfg(),getLabel(mstrmojo.desc(13725,"Add a Palette"),"newPalette",{onclick:function onclick(){var pos=$DOM.position(this.domNode);_openPaletteEditor(this.parent,null,[],{top:(pos.y+7).toString()+"px",left:(pos.x+pos.w+5).toString()+"px"});}}),getLabel(mstrmojo.desc(13726,"Select default color palette for:"),"selectDefaultPalette"),{scriptClass:"mstrmojo.Box",alias:"defPlts",cssClass:"mstrmojo-PaletteSelectorsContainer cf",postCreate:function postCreate(){var palettePage=this.parent;this.addChildren([getDefaultPaletteCfg(LIGHT_THEME_ID,palettePage),getDefaultPaletteCfg(DARK_THEME_ID,palettePage)]);},update:function update(themes,palettes){var selectorWrappers=$ARR.filter(this.children,function(ch){return ch.themedid;});$ARR.forEach(selectorWrappers,function(selWrapper){var thm=findItem(themes,"did",selWrapper.themedid),thmPltids=thm.plts,selector=selWrapper.selector;selWrapper.label.set("text",thm.n);if(selector.hasRendered){$CSS.toggleClass(selector.domNode,"showLoading",thm.showLoading);$CSS.toggleClass(selector.domNode,"showError",!!thm.error);selector.errorContentNode.innerHTML=thm.error?thm.error.message:"";}selector._initializing=true;selector.set("items",$ARR.map($ARR.filter(palettes,function(plt){return $ARR.indexOf(thmPltids,plt.pltid)!==-1;}),function(plt){return $HASH.copy({pltColorsHTML:getPaletteColorsHTML(plt.colors)},$HASH.copy(plt));}));selector.set("selectedValue",thm.dplt);selector.onselectedValueChange();selector._initializing=false;});}}]});}());