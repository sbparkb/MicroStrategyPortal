(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.hash","mstrmojo.array","mstrmojo.func","mstrmojo.Editor");var $H=mstrmojo.hash,$A=mstrmojo.array,getConnInfo=function(){var connInfo;$H.forEach(this.docModel.datasets,function(dataset){if(dataset.hcs){connInfo=dataset.connInfo;return false;}});return connInfo;},filter=function(res){var connInfo=getConnInfo.call(this),allLoginAfter=true,allLoginFirst=true,found=false,filteredReponse={},message=null,compare=function(x,y,type){if(type==="url"){var getUrl=function(url){return url.toLowerCase().split("/").slice(0,3).join();};return getUrl(x)===getUrl(y);}else{if(type==="number"||(typeof (x)==="number"||typeof (y)==="number")){return parseInt(x)===parseInt(y);}else{if(type==="string"||(typeof (x)==="string"&&typeof (y)==="string")){return x.toLowerCase()===y.toLowerCase();}else{return x===y;}}}},addCandidate=function(key,webServer,iServer,project){if(webServer.loginFirst){filteredReponse[key]=webServer;}else{var clusters=(filteredReponse[key]&&filteredReponse[key].clusters)||[];filteredReponse[key]=$H.clone(webServer);clusters.push([$H.clone(iServer)]);filteredReponse[key].clusters=clusters;filteredReponse[key].clusters[clusters.length-1][0].projects=[project];}},processLoginAfter=function(webServer,k){var f=false,targetCluster,targetProject,targetIServer;var conn=webServer.connection;if(compare(conn.url,connInfo.ws,"url")){$A.forEach(webServer.clusters,function(cluster){$A.forEach(cluster,function(iServer){if(compare(iServer.hostName,connInfo.isn)||compare(iServer.name,connInfo.isn)){targetCluster=cluster;}});});$A.forEach(targetCluster,function(iServer){if(iServer.st===1){$A.forEach(iServer.projects,function(project){if(compare(project.name,connInfo.pn)){if(targetIServer){targetIServer.clusterName=targetIServer.clusterName+"/"+iServer.name;}else{targetIServer=$H.copy(iServer,{clusterName:iServer.name});targetProject=project;}f=true;}});}});if(targetIServer&&targetProject){addCandidate(k,webServer,targetIServer,targetProject);}}if(!f){$A.forEach(webServer.clusters,function(cluster){$A.forEach(cluster,function(iServer){if(iServer){$A.forEach(iServer.projects,function(project){if(compare(project.id,connInfo.pid)){addCandidate(k,webServer,iServer,project);f=true;}});}});});}return f;},processLoginFirst=function(webServer,k){var f=false,conn=webServer.connection;if(compare(conn.url,connInfo.ws,"url")){f=true;addCandidate(k,webServer);}return f;};if(!connInfo){return{response:res};}$H.forEach(res,function(webServer){if(webServer.loginFirst){allLoginAfter=false;}else{allLoginFirst=false;}});if(allLoginAfter){$H.forEach(res,function(webServer,k){found=processLoginAfter(webServer,k)||found;});if(!found){message=mstrmojo.desc(14068,"The dashboard you are trying to upload uses one or more Intelligent Cubes from the project named #. This project cannot be  located on any of the servers currently configured on your Desktop. Please make sure the project is available for you to upload the dashboard successfully.").replace("#",'"'+connInfo.pn+'"');}}else{if(allLoginFirst){$H.forEach(res,function(webServer,k){found=processLoginFirst(webServer,k)||found;});if(!found){if(this.currentProject){message=mstrmojo.desc(14170,"The dashboard you are trying to upload uses one or more Intelligent Cubes from the project  named #. This project cannot be  located on the Webserver named ##. Please pick a different Webserver.").replace("##",'"'+this.currentProject.webServer.connection.wsn+'"').replace("#",'"'+connInfo.pn+'"');}else{message=mstrmojo.desc(14069,"The dashboard you are trying to upload uses the Webserver # which cannot be reached. Please make sure that your Desktop is correctly configured "+"to this Webserver or try picking a different Webserver.".replace("#",connInfo.ws));}filteredReponse=res;}}else{$H.forEach(res,function(webServer,k){if(!webServer.loginFirst){found=processLoginAfter(webServer,k)||found;}});if(!found){$H.forEach(res,function(webServer,k){if(webServer.loginFirst){found=processLoginFirst(webServer,k)||found;}});if(!found){$H.forEach(res,function(webServer,k){if(webServer.loginFirst){addCandidate(k,webServer);}});if(this.currentProject){message=mstrmojo.desc(14170,"The dashboard you are trying to upload uses one or more Intelligent Cubes from the project  named #. This project cannot be  located on the Webserver named ##. Please pick a different Webserver.").replace("##",'"'+this.currentProject.webServer.connection.wsn+'"').replace("#",'"'+connInfo.pn+'"');}else{message=mstrmojo.desc(14070,"The dashboard you are trying to upload uses one or more Intelligent Cubes from the project named #. Please pick a Webserver to login to this project.").replace("#",'"'+connInfo.pn+'"');}}}}}return{message:message,response:filteredReponse};};mstrmojo.onetier.vi.ui.FilteredLoginProjectBox=mstrmojo.declare(mstrmojo.onetier.vi.ui.LoginToProjectBox,null,{scriptClass:"mstrmojo.onetier.vi.ui.FilteredLoginProjectBox",getWebServerProjects:function(callback){var me=this;this.connectivityProxy.getWebServersProjects({success:function(res){var filterResponse=filter.call(me,res),r=filterResponse.response,m=filterResponse.message;if(m){mstrmojo.alert(m,function(){if(!$H.isEmpty(r)){callback.success(r,!!m);}else{callback.failure();}});}else{callback.success(r);}},failure:function(res){callback.failure(res);}});}});}());