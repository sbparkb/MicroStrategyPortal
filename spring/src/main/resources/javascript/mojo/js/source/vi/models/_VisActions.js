(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.EnumRWUnitType","mstrmojo.DocDataService","mstrmojo.func","mstrmojo.array","mstrmojo.vi.viz.KnownVisualizations","mstrmojo.VisEnum");mstrmojo.requiresClsP("mstrmojo.vi.models","EnumPanelTypes");var $ARRAY=mstrmojo.array,$HASH=mstrmojo.hash,$FUNC=mstrmojo.func,$RW_UNIT_TYPES=mstrmojo.EnumRWUnitType,$VI_COMPONENT_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,$KNOWN_VIZ=mstrmojo.vi.viz.KnownVisualizations,$PANEL_TYPES=mstrmojo.vi.models.EnumPanelTypes,ITEM_SEPARATOR="\u001E",REQUEST_DEFN_DATA=mstrmojo.DocDataService.REQUEST_DEFN_DATA,SUPPRESS_DATA=mstrmojo.DocDataService.SUPPRESS_DATA,CARDLIMIT=mstrmojo.VisEnum.VIS_CARDLIMIT.NON_GRID;var TYPE_METRIC=4;function createNewVizNode(params){params=params||{};return this.createNewUnitNode(function(data){data.eg="";if(params.fnData){data=params.fnData(data);}return data;},function(defn){defn.t=$RW_UNIT_TYPES.GRID;defn.n=params.n||"";defn.ttl=params.title||defn.n;defn.ds=0;defn.tt=1;defn.eo=0;if(params.fnDefn){defn=params.fnDefn(defn);}return new mstrmojo.Model(defn);},params.fnNode,params.nodeKey,params.layoutKey);}function copyMoveVisualization(me,vizBox,vizPanelStack,dstPanelKey,dstLayoutKey,isMoving){me.execute({execute:function(){var dataService=me.getDataService(),cmdMgr=me.cmdMgr(),cmd=this,docView=me.controller.view,update=dataService.newUpdate(),srcPanel=vizBox.parent,srcPanelKey=srcPanel.k,srcLayoutKey=me.getCurrentLayoutKey(),dstPanel,sameLayout=dstLayoutKey===srcLayoutKey,srcVizKey=vizBox.k,dstVizKey,destination,loaded,existing,cmdPhase;if(isMoving&&vizBox.boxContent&&vizBox.boxContent.updateAssociatedNodesOnMove){vizBox.boxContent.updateAssociatedNodesOnMove();}if(sameLayout){existing=!!dstPanelKey;if(!existing){dstPanel=me.addPanel(update,vizPanelStack);dstPanelKey=dstPanel.k;loaded=true;var vizPanelStackId=vizPanelStack.id,vizPanelStackParentId=vizPanelStack.parent.id,vizPanelStackKey=vizPanelStack.k,fnPreUndoRedoNewPanel=function(){this.urInfo.puKeys=[vizPanelStackKey];}.bind(this);this.urInfo=$HASH.copy({undo:fnPreUndoRedoNewPanel,redo:fnPreUndoRedoNewPanel,callback:$FUNC.wrapMethods({success:function(res){me.controller.view.updateXtabStyles(dstLayoutKey,res.data.layouts[$ARRAY.find(res.data.layouts,"k",dstLayoutKey)].xtabStyles);me.updateDefnCache(res.defn,[vizPanelStackKey,srcPanelKey,dstPanelKey]);me.updateDataCache(res.data,me.getTargetDefn(vizPanelStackKey));var parent=mstrmojo.all[vizPanelStackParentId];parent.rebuildChild(mstrmojo.all[vizPanelStackId]);parent.doLayout();}})},this.urInfo);}else{dstPanel=me.getPanel(dstPanelKey);loaded=dstPanelKey===srcPanelKey||dstPanel.defn.l;if(dstPanelKey!==srcPanelKey){this.urInfo=$HASH.copy({undo:function(){this.urInfo.puKeys=[srcPanelKey];},redo:function(){this.urInfo.puKeys=[dstPanelKey];},callback:$FUNC.wrapMethods({success:function(){me.getPanel(srcPanelKey).unload();me.getPanel(dstPanelKey).unload();}},me.getRebuildCallback()),treesToRender:3},this.urInfo);}}destination={parentKey:dstPanelKey};}else{if(dstLayoutKey){loaded=false;existing=true;me.markDirtyLayout(dstLayoutKey);docView.showLayout(docView.getLayout(dstLayoutKey),null,update);destination={layoutKey:dstLayoutKey,analysisSectionType:$PANEL_TYPES.VISUALIZATION};cmd.urInfo=$HASH.copy({callback:$FUNC.wrapMethods({success:function(){if(isMoving){me.markDirtyLayout(srcLayoutKey);}me.markDirtyLayout(dstLayoutKey);}},me.getRebuildCallback())},this.urInfo);}else{loaded=false;existing=false;dstLayoutKey=me.getNextKey();dstPanelKey=me.getNextKey();cmdPhase=cmdMgr.CMD_PHASE.FIRST;docView.addNewLayout(update,-1,{nodeKey:dstLayoutKey,newPanelKey:dstPanelKey,analysisSectionType:$PANEL_TYPES.VISUALIZATION});destination={parentKey:dstPanelKey};}}if(isMoving){dstVizKey=srcVizKey;if(!srcPanel.hasMultipleChildren()){me.addVisualizationDeferred(update,srcPanelKey);}srcPanel.deleteBoxAndSubmitDeferred(update,vizBox,undefined,true,true);update.addActions(dataService.getMacroMoveNodeAction(vizBox,destination));if(loaded){vizBox.unrender();dstPanel.insertNewBoxAndSaveDeferred(update,vizBox);update.addCallbacks({success:function(res){var pukeys=[dstPanelKey,vizBox.k];me.updateDefnCache(res.defn,pukeys);me.updateDataCache(res.data,me.getTargetDefn(pukeys.join(ITEM_SEPARATOR)));dstPanel.rebuildChild(vizBox);}});}else{if(!sameLayout){me.markDirtyLayout(srcLayoutKey);}vizBox.destroy();}}else{var dstVizNode=createNewVizNode.call(me,{n:vizBox.title,layoutKey:dstLayoutKey});dstVizKey=dstVizNode.k;update.addActions(dataService.getMacroCopyNodeAction(vizBox,destination,dstVizKey));if(loaded){var dstVizBox=me.createUnit(dstVizNode,dstPanelKey);me.deferredInsertUnit(update,dstVizBox,dstPanelKey);if(srcPanelKey===dstPanelKey){copyVisAsFilterDeferred(me,vizBox,dstVizBox,update);this.urInfo.puKeys=[srcPanelKey];}}}if(sameLayout){if(!existing){me.selectNewPanel(update,dstPanelKey);}else{if(srcPanelKey!==dstPanelKey){vizPanelStack.selectPanelDeferred(update,dstPanelKey);}}}if(existing){if(!loaded){cmdPhase=cmdMgr.CMD_PHASE.FIRST;update.addCallbacks({success:function(){dstPanel=me.getPanel();var dstViz=dstPanel.getUnitByKey(dstVizKey),prevCmd=cmdMgr.getInterimCmd();if(!dstPanel.hasBoxLayoutChild(dstViz)){dstPanel.insertNewBox(dstViz);}if(dstPanel.defn.layoutXML){dstPanel.saveBoxLayout(prevCmd,cmdMgr.CMD_PHASE.LAST,null,null,true);}else{dstPanel.saveBoxLayout(prevCmd,cmdMgr.CMD_PHASE.LAST,null,null,true);}}});}update.addCallbacks({success:function(){dstPanel.getUnitByKey(dstVizKey).selectVIUnit();}});}update.addExtras(REQUEST_DEFN_DATA);this.submitUpdate(update,cmdPhase);},urInfo:{treesToRender:3}});}function copyVisAsFilterDeferred(me,srcVizBox,dstVizBox,update){var srcVizKey=srcVizBox.k,dstVizKey=dstVizBox.k,vizBoxs=srcVizBox.parent.children,puKeys=[],bc=srcVizBox.boxContent,separateFilter=bc.getFilterType()===1,newCGB=true,cgbKey,tks,dataService=me.getDataService();$ARRAY.forEach(vizBoxs,function(vizBox){var an=vizBox.defn.an,isTargetSrcViz=$ARRAY.find(an,"k",srcVizKey)!==-1,sc;if(newCGB){cgbKey=me.getNextKey();}if(isTargetSrcViz){sc=vizBox.boxContent.selectorControl;puKeys.push(vizBox.k);an.push({k:dstVizKey,muc:24});update.addActions({act:"associateNodes",nodeKey:vizBox.k,targetKeys:[dstVizKey],partialRetrieval:dataService.newRetrievalKeysConfig().addNode(vizBox.k)});if(sc){sc.cgb[$HASH.keyarray(sc.cgb).length+1]=cgbKey;update.addActions({act:"addVisToFilter",parentKey:srcVizKey,targetKey:dstVizKey,ctrlKey:sc.ckey,newCGB:newCGB,cgbKey:cgbKey});}}if(!separateFilter){newCGB=false;}});if(bc&&bc.selectorControl){var cgbMap=me.getCurrentLayoutDef().cgbMap,targetKeys=[],newCGBNodeKeys=[],oldCGBNodeKeys=[],sourceControl=bc.selectorControl,findCGBKey=function(targetKey){var r;$HASH.forEach(cgbMap,function(cgbTarget,mapCGBKey){if($HASH.valarray(sourceControl.cgb).indexOf(mapCGBKey)!==-1&&targetKey===cgbTarget){r=mapCGBKey;}});return r;};tks=(sourceControl.tks||"").split("\u001E");tks.forEach(function(targetKey){var ft,newKey,oldKey,cgbIndex,bx=(vizBoxs.filter(function(b){return b.k===targetKey;}))[0];ft=bx.boxContent.getFilterType();if(ft===1){targetKeys.push(targetKey);newKey=me.getNextKey();cgbMap[newKey]=targetKey;newCGBNodeKeys.push([newKey,true]);oldKey=findCGBKey(targetKey);$HASH.forEach(sourceControl.cgb,function(v,k){if(v===oldKey){cgbIndex=k;}});if(cgbIndex){sourceControl.cgb[cgbIndex]=newKey;}oldCGBNodeKeys.push([oldKey,false]);}});if(targetKeys.length){update.addActions({act:"replaceControlCGB",oldCGBNodeKey:oldCGBNodeKeys,targetKeys:targetKeys,newCGBNodeKeys:newCGBNodeKeys,controlKey:bc.selectorControl.ckey,sourceKey:srcVizKey});}}if(puKeys.length>0){update.addCallbacks({success:function(res){me.partialUpdate(res.data,me.getTargetDefn(puKeys),res.defn,puKeys);}});}}mstrmojo.vi.models._VisActions=mstrmojo.provide("mstrmojo.vi.models._VisActions",{_mixinName:"mstrmojo.vi.models._VisActions",createNewVizNode:createNewVizNode,addVisualizationDeferred:function(update,panelKey){var model=this,title=mstrmojo.desc(11659,"New Visualization"),node=model.createNewUnitNode();$HASH.copy({t:$RW_UNIT_TYPES.GRID,ttl:title,n:title,ds:0,tt:1,eo:0},node.defn);node.data.eg="";var unit=model.createUnit(node,panelKey);update.addActions([model.getCopyEmptyTemplateAction(unit.k,panelKey)]);model.deferredInsertUnit(update,unit,panelKey);update.actions.some(function(act){if(act.unitKey===unit.k){act.partialRetrieval={nodes:[unit.k]};return true;}});update.addExtras(REQUEST_DEFN_DATA);return unit;},addVisualization:function addVisualization(){var model=this,vizKey,node,panelKey=this.getPanel().k;model.execute({execute:function(){var dataService=model.getDataService(),update=dataService.newUpdate(this);var unit=model.addVisualizationDeferred(update,panelKey);vizKey=unit.k;node=unit.boxContent.node;this.submitUpdate(update);},urInfo:{treesToRender:3,undo:function(){this.urInfo.puKeys=[];this.urInfo.callback={};var panel=model.getUnitInstance(panelKey,1),viz=panel.getUnitByKey(vizKey),defn=model.getLayoutUnitDefn(vizKey),parentDefn=model.getLayoutUnitDefn(defn.pnk),parentXml=parentDefn.layoutXML;defn._isDeleted=true;parentXml.children=parentXml.children.filter(function(c){return c.k!==vizKey;});panel.removeChildren(viz);viz.destroy();model.restoreUIState(this.undoUIState);return true;},redo:function(){this.urInfo.puKeys=[vizKey];this.urInfo.callback={success:function(res){var unit=model.createUnit(node,panelKey),panel=model.getUnitInstance(panelKey,1),defn=model.getLayoutUnitDefn(vizKey);if(defn){delete defn._isDeleted;}panel.addChildren(unit);panel.boxLayoutConfig.dirty=true;model.partialUpdate(res.data,model.getTargetDefn([vizKey]),res.defn,[vizKey]);panel.rebuildChild(unit);}};return false;}}});},duplicateVisualization:function duplicateVisualization(vizBox){var curLayoutKey=this.getCurrentLayoutKey(),panelStack=vizBox.boxContent.builder.getLayoutVIMap(curLayoutKey).getComponent($VI_COMPONENT_TYPES.VIZ_CONTENT);copyMoveVisualization(this,vizBox,panelStack,panelStack.selectedKey,curLayoutKey,false);},copyVisualization:function(vizBox,vizPanelStack,dstPanelKey,dstLayoutKey){copyMoveVisualization(this,vizBox,vizPanelStack,dstPanelKey,dstLayoutKey,false);},moveVisualization:function(vizBox,vizPanelStack,dstPanelKey,dstLayoutKey){copyMoveVisualization(this,vizBox,vizPanelStack,dstPanelKey,dstLayoutKey,true);},renameRWUnitTitle:function renameRWUnitTitle(title,oldTitle,key,callback){this.updateTitle(title,oldTitle,key,this.currlaykey,"ttl",callback);},changeSelectedVisType:function changeSelectedVisType(style,vt,widgetType,dropZone){var selectedUnit=this.getSelectedViUnit();if(!selectedUnit){return ;}var templateActions=[],w=selectedUnit.boxContent,data=w.node.data,visDefinition=$KNOWN_VIZ.getDefinition(style),visTransition=this.controller.visTransitionFactory.newVisualizationTransition(style||"Grid",{vis:w,newVizInfo:{s:style,dz:dropZone}});if($KNOWN_VIZ.getDefinition(data.visName||"Grid").id===$KNOWN_VIZ.GRID){var thresholdActions=[];visTransition.addClearAllThresholdsActions(thresholdActions);templateActions.push({act:"updateTemplate",keyContext:w.k,actions:thresholdActions});}if(style!==""&&visDefinition.id!==$KNOWN_VIZ.UNKNOWN){templateActions.push({act:"updateTemplate",keyContext:w.k,actions:[{act:"createDefaultDropZones",nodeKey:w.k,treeType:w.defn.tt,datasetId:data.datasetId,datasetType:3,widgetType:widgetType,partialUpdate:{nodes:[w.k]}}]});}var transitionData=visTransition?visTransition.transitionDropZones(templateActions,vt):{wp:""},widgetProps=transitionData.wp,handled=transitionData.handled,allowedItems=[],viz=visTransition&&visTransition.vis,vizGts=viz&&viz.node&&viz.node.data&&viz.node.data.gts||{},items=(vizGts.col||[]).concat(vizGts.row||[]);if(widgetType){$ARRAY.forEach(items,function(item){allowedItems.push(item);});}var datasetId=[],attrArr={},fn=function(item){if(!item.id){item.id=item.did;}var itmId=item.id;attrArr[itmId]=item.card;};$HASH.keyarray(this.datasets).forEach(function(datasetid){datasetId.push(datasetid);});for(var h=0;h<datasetId.length;h++){$ARRAY.forEach(this.datasets[datasetId[h]].att,fn);}$ARRAY.forEach(allowedItems,function(item){if(!item.id){item.id=item.did;}if(!item.cardg&&!item.card){item.card=attrArr[item.id];}});visTransition.vis.zonesModel.checkAndWarnLargeItemsForAddUnits(allowedItems,function(w,selectedUnit){if(widgetProps.length>0&&!handled){var widgetClassName=mstrmojo.ExpressVisList.findWidgetName(style)||"",extras=REQUEST_DEFN_DATA,key=selectedUnit.k;templateActions.push(this.getUnitChangeVizAction(style,widgetClassName,selectedUnit,widgetProps));templateActions.push({act:"changeGridDisplayMode",nodeKey:key,displayMode:style===mstrmojo.vi.viz.EnumVizStyles.GRAPH_MATRIX?2:1});if(w.model.data.eg!==undefined){extras=$HASH.copy(extras,{preserveUndo:true});}this.controller.submitUndoRedoUpdates(templateActions,null,{success:function success(res){var currentLayoutKey=this.getCurrentLayoutKey(),panel=this.getPanel();this.refreshDefinition(key,this.getRawLayoutUnitDefn(key,res.defn));this.updateDataCache(res.data,this.getTargetDefn(key));if(res.data){res.data.layouts.some(function(layout){var isCurrentLayout=layout.k===currentLayoutKey;if(isCurrentLayout){this.controller.view.updateXtabStyles(currentLayoutKey,layout.xtabStyles);}return isCurrentLayout;},this);}this.selectVIUnit(panel.rebuildChild(panel.getUnitByKey(key)).id,true);}.bind(this)},extras);}}.bind(this,w,selectedUnit),null,!widgetType,null,false,CARDLIMIT);},getUnitChangeVizAction:function getUnitChangeVizAction(visStyle,widgetClassName,selectedUnit,widgetProps){var visDefinition=$KNOWN_VIZ.getDefinition(visStyle);var mobileVIStyles={IPhoneVisualization:"",IPadVisualization:"",APhoneVisualization:"",ATabletVisualization:""};if(visDefinition&&visDefinition.mobileVIStyles){mobileVIStyles=$HASH.copy(visDefinition.mobileVIStyles,mobileVIStyles);}var visProps={Visualization:$HASH.copy(mobileVIStyles,{VisualizationsEnabled:visStyle?-1:0,ViewMode:visStyle?51:0,SelectedVisualization:visStyle||"",VisualizationList:visStyle||""}),FormattingIncrementalFetch:{EnableIFOnGrid:visStyle?0:-1},FormattingWidget:{ClassName:visStyle?widgetClassName:"",Enable:(widgetClassName!=="")?1:0}};if(widgetProps){visProps.FormattingWidget.WidgetProps=widgetProps;}return this.getUnitFormatAction(selectedUnit,1,visProps);},setVisAsFilter:function setVisAsFilter(vis,delta,update){var actions=[],controlNode=delta.sc,targets=delta.targetKeys,fos=delta.isFilter,showAll=delta.clearAll,model=this,puTgts=[],oldTargets=[],newTargets=[],changedTargets=[],targetsUpdated=false,ac,filterType,controlKey,CGBKeys=[],targetKeys=[],resetToMulti=delta.forAllData!==undefined&&delta.forAllData,oldNodeCleared=false,newNodeCreated=false,singleUnit=delta.singleUnit,cgbMap=model.getCurrentLayoutDef().cgbMap,addToCGBMap={},newCGB,deleteCGBKeys=[],nk,undoRedo=function undoRedo(){delete vis.defn.an;},isShowAll=function(){if(showAll===undefined&&controlNode){return controlNode.all||controlNode.showall;}return showAll===undefined?true:!!showAll;},isFilterOnSelection=function(){if(targetsUpdated&&fos===undefined){if(newTargets.length===changedTargets.length){return true;}return !!controlNode;}else{if(fos!==undefined){return fos;}}return true;},amountOfJSON=SUPPRESS_DATA,isSingleSelectionCGB=function(cgbKey){var res=false;$HASH.forEach(targets,function(target){if(target.cgbs&&target.cgbs.length){target.cgbs.forEach(function(controlCGB){res=res||$HASH.valarray(controlCGB.sc.cgb).indexOf(cgbKey)!==-1;});}});return res;};mstrmojo.hash.forEach(targets,function(target,k){if(target.c){targetsUpdated=true;changedTargets.push(k);}if((target.v&&!target.c)||(!target.v&&target.c)){oldTargets.push(k);}if(target.v){newTargets.push(k);}return true;},this);if(singleUnit){puTgts=[vis.k];amountOfJSON=REQUEST_DEFN_DATA;}if(singleUnit&&!resetToMulti&&targetsUpdated){$ARRAY.forEach($HASH.valarray(controlNode.cgb),function(cgbKey){deleteCGBKeys.push([cgbKey,true]);delete cgbMap[cgbKey];});if(!newTargets.length){ac={act:"clearVisAsFilter",nodeKey:vis.k,associatedNodes:oldTargets,cgbNodeKeys:deleteCGBKeys,controlKey:controlNode.ckey};puTgts=puTgts.concat(oldTargets);oldNodeCleared=true;}else{newTargets.forEach(function(k){CGBKeys.push(model.getNextKey());if(puTgts.indexOf(k)===-1){puTgts.push(k);}},this);ac={act:"updateSingleUnitControl",controlKey:controlNode.ckey,nodeKey:vis.k,removeTargetKeys:deleteCGBKeys,newTargetKeys:newTargets,CGBKeys:CGBKeys,unitId:delta.unitId};}actions.push(ac);}else{if(resetToMulti||targetsUpdated||fos!==undefined){ac={act:"clearVisAsFilter",nodeKey:vis.k};if(oldTargets){ac.associatedNodes=oldTargets;puTgts=puTgts.concat(oldTargets);}if(controlNode){$ARRAY.forEach($HASH.valarray(controlNode.cgb),function(cgbKey){var del=model.getSourceControls(vis,cgbKey).length<=1;if(del){delete cgbMap[cgbKey];}deleteCGBKeys.push([cgbKey,del]);});ac.cgbNodeKeys=deleteCGBKeys;ac.controlKey=controlNode.ckey;}if(controlNode||!$HASH.isEmpty(oldTargets)){oldNodeCleared=true;actions.push(ac);amountOfJSON=REQUEST_DEFN_DATA;}}if(resetToMulti||(targetsUpdated&&newTargets.length>0)||fos!==undefined){if(isFilterOnSelection()){controlKey=model.getNextKey();}newTargets.forEach(function(k){if(isFilterOnSelection()){filterType=targets[k].ft;if(!filterType){newCGB=true;$HASH.forEach(cgbMap,function(tk,cgbk){if(k===tk&&!isSingleSelectionCGB(cgbk)){CGBKeys.push([cgbk,false]);newCGB=false;}});if(newCGB){nk=model.getNextKey();addToCGBMap[nk]=k;CGBKeys.push([nk,true]);}}else{nk=model.getNextKey();addToCGBMap[nk]=k;CGBKeys.push([nk,true]);}}if(puTgts.indexOf(k)===-1){puTgts.push(k);}targetKeys.push(k);},this);actions.push({act:"setVisAsFilter",sourceKey:vis.k,targetKeys:targetKeys,controlKey:controlKey,CGBKeys:CGBKeys,showAll:isShowAll(),fos:isFilterOnSelection()});amountOfJSON=isFilterOnSelection()&&model.hasUnitSelector?REQUEST_DEFN_DATA:amountOfJSON;newNodeCreated=true;}}if(!newNodeCreated&&showAll!==undefined){actions.push({act:"setControlShowAll",nodeKey:vis.k,controlKey:controlNode.ckey,showAll:showAll});}if(actions.length){$HASH.copy(addToCGBMap,cgbMap);actions[0].partialUpdate={nodes:puTgts};if(!update){this.execute({execute:function(){var dataService=model.getDataService(),update=dataService.newUpdate(this);update.addActions(actions);update.addExtras(amountOfJSON);if(amountOfJSON!==SUPPRESS_DATA){update.addCallbacks(model.getRebuildCallback());}update.addCallbacks({success:function(){var node=vis.boxContent.node,cgb=[],an,bc=vis.boxContent;if(oldNodeCleared){delete node.data.sc;delete node.defn.an;}if(newNodeCreated){if(isFilterOnSelection()){$ARRAY.forEach(CGBKeys,function(v){cgb.push(v[0]);});node.data.sc={ck:[1].concat([vis.k,controlKey]).join(ITEM_SEPARATOR),ckey:controlKey,ct:6,showall:isShowAll(),cgb:cgb,tks:targetKeys.join(ITEM_SEPARATOR)};}an=node.defn.an=[];targetKeys.forEach(function(item){an.push({k:item,muc:24});},this);}if(!newNodeCreated&&showAll!==undefined){node.data.sc.showall=showAll;}if(bc&&bc.findSelectorControl){bc.findSelectorControl();}}});this.submitUpdate(update);},urInfo:{treesToRender:3,undo:undoRedo,redo:undoRedo,extraPuKeys:singleUnit?null:[vis.k],puKeys:amountOfJSON===SUPPRESS_DATA&&[vis.k].concat(puTgts)}});}else{update.addActions(actions);}}return oldNodeCleared;},getSourceControls:function getSourceControls(vis,cgbKey){var vizBoxs=vis.parent.children,sc,res=[],bc;$ARRAY.forEach(vizBoxs,function(vizBox){bc=vizBox.boxContent;sc=bc.selectorControl||(bc.findSelectorControl&&bc.findSelectorControl());if(sc&&$HASH.valarray(sc.cgb).indexOf(cgbKey)>=0){res.push({bc:bc,sourceKey:vizBox.k,control:sc});}});return $ARRAY.filter(res,function(ctrl){return Number(ctrl.control.ct)===6;});},clearVisAsFilterAction:function clearVisAsFilterAction(vis,isVisDeleted){var model=this,controlNode=vis.boxContent.selectorControl,an=vis.defn.an,prKeys=[],acs=[],ac,cb,cgbKeys=[],cgbMap=this.getCGBMap(),getCGBs=function(){return $ARRAY.filter($HASH.keyarray(cgbMap),function(item){return vis.k===cgbMap[item];});},cgbs;if(an){an.forEach(function(node){prKeys.push(node.k);});ac={act:"clearVisAsFilter",nodeKey:vis.k,associatedNodes:prKeys,partialRetrieval:{nodes:prKeys}};if(controlNode){$ARRAY.forEach($HASH.valarray(controlNode.cgb),function(cgbKey){cgbKeys.push([cgbKey,model.getSourceControls(vis,cgbKey).length<=1]);});ac.cgbNodeKeys=cgbKeys;ac.controlKey=controlNode.ckey;}cb=isVisDeleted?{success:function(res){model.partialUpdate(res.data,model.getTargetDefn(prKeys));}}:$FUNC.wrapMethods(this.associatedNodesUpdate([vis]).callback,this.controller._getXtabCallback(vis.boxContent));acs.push(ac);}if(isVisDeleted){cgbs=getCGBs();$ARRAY.forEach(cgbs,function(cgbKey){delete cgbMap[cgbKey];var sources=model.getSourceControls(vis,cgbKey),deleted=false,targetKeys,cgbsArr;$ARRAY.forEach(sources,function(source){targetKeys=source.control.tks.split("\u001E");ac={act:"clearVisAsFilter",nodeKey:source.sourceKey,associatedNodes:[vis.k],cgbNodeKeys:[[cgbKey,!deleted]],controlKey:source.control.ckey,removeControl:targetKeys.length===1,partialRetrieval:{nodes:[source.sourceKey]}};deleted=true;if(targetKeys.length>1){cgbsArr=$HASH.valarray(source.control.cgb);cgbsArr.splice(cgbsArr.indexOf(cgbKey),1);source.control.cgb={};$ARRAY.forEach(cgbsArr,function(c,i){source.control.cgb[i]=c;});targetKeys.splice(targetKeys.indexOf(vis.k),1);source.control.tks=targetKeys.join("\u001E");}else{var node=source.bc.node;delete node.data.sc;delete node.defn.an;delete source.bc.selectorControl;}acs.push(ac);});});if(acs.length>0){return{actions:acs,callback:cb,extras:{style:{params:{treesToRender:isVisDeleted?2:3}}}};}}},associatedNodesUpdate:function associatedNodesUpdate(viss){var m=this,layoutKey=m.getCurrentLayoutKey(),layout;return{callback:{success:function(res){res.defn.layouts.some(function(l){layout=l;return l.k===layoutKey&&l.loaded;});$ARRAY.forEach(viss,function(vis){var visDefn=layout.units[vis.k];if(visDefn){if($HASH.isEmpty(visDefn.an)){delete vis.defn.an;}else{vis.defn.an=visDefn.an;}}});}},extras:{style:{params:{treesToRender:1}}}};},redoFilterAssociations:function redoFilterAssociations(isNewCGB,controlKey,sourceKey,targetKey,removeCGB,addCGB){return{act:"redoFilterAssociations",isNewCGB:isNewCGB,controlKey:controlKey,sourceKey:sourceKey,targetKey:targetKey,removeCGB:removeCGB,addCGB:addCGB,partialUpdate:{nodes:[sourceKey,targetKey]}};},setFilterType:function setFilterType(update,vis,type){update.addActions({act:"setVisFilterType",nodeKey:vis.k,type:type});},getSourceFilterKeys:function getSourceFilterKeys(targetKey,onlyMetricFilters){var filterKeys=[],filterStack=this.getVIComponent($VI_COMPONENT_TYPES.FILTER_STACK),vizContent=this.getVizContentPanel(this.getCurrentLayoutKey());if(filterStack){if(onlyMetricFilters){$ARRAY.forEach(filterStack.getFilters(),function(lFilter){if(lFilter.node.defn.srct===TYPE_METRIC){filterKeys.push(lFilter.k);}});}else{filterKeys.push(filterStack.k);}}if(vizContent){vizContent.children.forEach(function(vizBox){var tks=vizBox.getTargetKeys&&vizBox.getTargetKeys()||[];if($ARRAY.indexOf(tks,targetKey)>-1){filterKeys.push(vizBox.k);}});}return filterKeys;}});}());