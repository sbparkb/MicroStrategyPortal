(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.qb.DBTableRows","mstrmojo._IsMovable","mstrmojo._HasOwnAvatar","mstrmojo.array","mstrmojo.dom","mstrmojo.hash","mstrmojo.css");mstrmojo.requiresDescs(12912,12913,12914,12915);var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$H=mstrmojo.hash,$MAX=Math.max,$MIN=Math.min,$PX="px",STR_EMPTY_TABLE=mstrmojo.desc(12915,"No columns."),CSS_CLASS_DRAGGING="dragging",DEFAULT_HEIGHT=320,DEFAULT_WIDTH=150,$DBTABLEVIEW,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.qb.EnumDataChangeEvents,TABLE_ZINDEX=10;function updatePosition(){if(this.domNode){var domNodeStyle=this.domNode.style,tableData=this.tableData;domNodeStyle.left=this.left||tableData.x;domNodeStyle.top=this.top||tableData.y;}}function updateTableDimensions(height,width){var rowsWidget=this.rows,domNode=this.domNode;if(height===undefined||width===undefined){this.maxHeight=$MAX(domNode.clientHeight,this._ttlHeight);this.height=$MIN(this.maxHeight,DEFAULT_HEIGHT);this.width=$MAX(domNode.clientWidth,DEFAULT_WIDTH);}else{this.height=$MAX($MIN(height,this.maxHeight),this._ttlHeight);this.width=$MAX(width,DEFAULT_WIDTH);}rowsWidget.set("height",$MAX(this.height-this._ttlHeight-this._rowHeight,0)+$PX);rowsWidget.set("width",this.width+$PX);}mstrmojo.qb.DBTableView=mstrmojo.declare(mstrmojo.Container,[mstrmojo._IsMovable,mstrmojo._HasOwnAvatar,mstrmojo._HasPopup],{scriptClass:"mstrmojo.qb.DBTableView",markupString:'<div id="{@id}" class="mstrmojo-qb-TableView {@cssClass}"><div class="mstrmojo-qb-tv-header item"><span class="mstrmojo-qb-tv-ttl" mstrAttach:dblclick,click>{@title}</span><span class="item-mn" mstrAttach:click></span></div><div class="mstrmojo-qb-tv-rsz"></div></div>',markupSlots:{headerNode:function headerNode(){return this.domNode.firstChild;},titleNode:function titleNode(){return this.domNode.firstChild.firstChild;},containerNode:function containerNode(){return this.domNode;},menuNode:function menuNode(){return this.domNode.firstChild.lastChild;},resizeHandle:function resizeHandle(){return this.domNode.children[1];}},init:function init(props){this._super(props);},rows:undefined,preBuildRendering:function preBuildRendering(){this._super();this.title=this.tableData.n;var items=this.tableData.items;if(!items||items.length===0){items=this.tableData.items=[{n:STR_EMPTY_TABLE,tp:"none"}];}this.rows.items=items;},postBuildRendering:function postBuildRendering(){this._super();updatePosition.call(this);this._ttlHeight=this.headerNode.clientHeight;this._rowHeight=this.dummyrow.domNode.clientHeight;updateTableDimensions.call(this);this.domNode.style.zIndex=TABLE_ZINDEX++;},getTableID:function getTableID(){return this.tableData.id;},onclick:function onclick(evt){if(evt.getTarget()===evt.src.titleNode){if(mstrApp.getRootController().selectSourceTable){mstrApp.getRootController().selectSourceTable(this.tableData.id);}return ;}mstrApp.getRootController().removeTable(this.tableData);},ondblclick:function ondblclick(){var title=this.title,width=this.headerNode.clientWidth-15;this.openPopup("inlineTextRef",{left:"2px",top:($DOM.isIE?0:1)+"px",txtConfig:{cssClass:"mstrmojo-qb-tablealias-edit",width:width+"px",value:mstrmojo.string.decodeHtmlString(title)||"",onEnter:function(){this.parent.close({enter:true});}}});this.isEditing=true;},ontableDataChange:function ontableDataChange(){var rowContainer=this.rows;rowContainer.height=rowContainer.width=undefined;this.refresh();},isItemAvailable:function isItemAvailable(itemId){return(this.getTableID()===itemId);},handleEvent:function handleEvent(evt){var itemID=(evt.item&&evt.item.id)||evt.id;if(this.getTableID()===itemID){switch(evt.name){case $ENUM_DATA_CHANGE_EVENTS.RENAME:this.titleNode.innerHTML=this.title=evt.value;return true;case $ENUM_DATA_CHANGE_EVENTS.TABLE_CHANGED:this.set("tableData",evt.item);return true;}}else{return this.rows.handleEvent(evt);}return false;},getMovingHandle:function getMovingHandle(){return(this.isEditing?null:this.headerNode);},draggable:true,createAvatar:function createAvatar(sourceNode){var div=document.createElement("div");if(sourceNode!==this.resizeHandle){var item=$DOM.findAncestorByAttr(sourceNode,"idx",true,this.domNode);if(item&&item.node){div.appendChild(item.node.cloneNode(true));}div.className=this.domNode.className+" "+this.rows.domNode.className;}return div;},isDragValid:function isDragValid(context){return context.src.node===this.resizeHandle||this._super(context);},ondragstart:function ondragstart(context){this._super(context);$CSS.toggleClass(this.domNode,[CSS_CLASS_DRAGGING],true);this._rszCfg={h:this.height,w:this.width};},ondragmove:function ondragmove(context){if(this._rszCfg){var sourcePos=context.src.pos,targetPos=context.tgt.pos,resizeConfig=this._rszCfg;updateTableDimensions.call(this,resizeConfig.h+targetPos.y-sourcePos.y,resizeConfig.w+targetPos.x-sourcePos.x);}else{this._super(context);}this.linker.drawLinks();},ondragend:function ondragend(context){this._super(context);var domNode=this.domNode,zIndex=domNode.style.zIndex;$CSS.toggleClass(domNode,[CSS_CLASS_DRAGGING],false);if(parseInt(zIndex,10)<(TABLE_ZINDEX-1)){domNode.style.zIndex=TABLE_ZINDEX++;}delete this._rszCfg;},getDragAction:function getDragAction(context){var item=$DOM.findAncestorByAttr(context.src.node,"idx",true,this.domNode);if(item){return mstrmojo.qb.EnumDragActions.JOIN_COLUMN;}},getDragData:function getDragData(context){var item=$DOM.findAncestorByAttr(context.src.node,"idx",true,this.domNode);if(item){var itemInfo=this.rows.getRowItem(item.value);return $H.copy(itemInfo,{columnId:itemInfo.did,tableName:this.tableData.did,tableId:this.tableData.id});}},inlineTextRef:{scriptClass:"mstrmojo.Popup",locksHover:true,slot:"headerNode",children:[{scriptClass:"mstrmojo.TextBox",alias:"txt",onEsc:function(){this.parent.close({cancel:true});}}],onOpen:function(){var textbox=this.txt;$H.forEach(this.txtConfig,function(value,prop){textbox.set(prop,value);});textbox.domNode.style.width=textbox.width;textbox.focus();},onClose:function(){this.parent.isEditing=false;}},children:[{scriptClass:"mstrmojo.Widget",markupString:'<div class="item st"><span class="item-ic"></span><span class="item-n">*</span><span class="item-add" mstrAttach:click></span></div>',onclick:function onclick(){try{var parent=this.parent;mstrApp.getRootController().addSelectedColumns(parent.tableData.items);}catch(ex){throw ex;}},alias:"dummyrow"},{scriptClass:"mstrmojo.qb.DBTableRows",alias:"rows"}]});$DBTABLEVIEW=mstrmojo.qb.DBTableView;$DBTABLEVIEW.showPopupMenu=function showPopMenu(tableView,itemInfo){var contextMenu=$DBTABLEVIEW.tableCtxMenu;contextMenu.target=tableView;contextMenu.data=itemInfo.data;contextMenu.domNode=itemInfo.menuNode;contextMenu.showContextMenu();};}());