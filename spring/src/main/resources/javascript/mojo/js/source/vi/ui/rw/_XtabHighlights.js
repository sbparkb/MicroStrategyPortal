(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.dom","mstrmojo.vi.ui.rw._HasVisSelections","mstrmojo.css","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.elementHelper");var $CSS=mstrmojo.css,$HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$ARR=mstrmojo.array,$OBJ_TYPES=mstrmojo.chart.model.enums.EnumDSSObjectType,$EH=mstrmojo.elementHelper,GROUP_BORDER_CSS={cssClass:"grpHlt",top:"grpT",bottom:"grpB",left:"grpL",right:"grpR",midHoriz:"grpMidH",midVert:"grpMidV"},getTDsForCells=function(interactiveCells,tableNode){var zone=this.zone;tableNode=tableNode||(zone&&zone.tableNode);if(tableNode){var cells=[],tBodies=tableNode.tBodies,binSearch=function(nodeList,v){var high=nodeList.length,low=-1,value;while(high-low>1){if(nodeList[value=high+low>>1].getAttribute("ei")<v){low=value;}else{high=value;}}return(nodeList[high]&&parseInt(nodeList[high].getAttribute("ei"),10)===v)?nodeList[high]:null;};$ARR.forEach(interactiveCells,function(cellData){var ei=cellData._ei,i;for(i=0;i<tBodies.length;i++){var tb=tBodies[i],r=binSearch(tb.getElementsByClassName(cellData.css),ei);if(r){cells.push(r);}}});return cells;}return[];},getCellDataUnion=function(cell){var union=this.model.getCellDataUnion(cell),res={};$ARR.forEach(union,function(item){res[item.tid]=[{id:item.eid,n:item.v}];});return res;},selectMetricValues=function(data){var dataAtts=data[$HASH.keyarray(data)[0]],attIds=$HASH.keyarray(dataAtts),commonAtts,that=this,model=this.model,attributeMapping={};return getTDsForCells.call(this,$ARR.filter(this.interactiveCellsArray,function(item){if(item.hasOwnProperty("mix")){var sc=getCellDataUnion.call(that,item);commonAtts=$ARR.filter(attIds,function(attId){var linkedAtts=model.getLinkedAttributes(attId),filterRes=false;if(!!sc[attId]){attributeMapping[attId]=attId;filterRes=true;}else{$ARR.forEach(linkedAtts,function(linkedAttrId){if(!!sc[linkedAttrId]){attributeMapping[attId]=linkedAttrId;filterRes=true;return false;}});}return filterRes;});var result=false;$HASH.forEach(data,function(singleData){$ARR.forEach(commonAtts,function(attId){if(!model.compareElementsId(sc[attributeMapping[attId]][0].id,singleData[attId][0].id)){result=false;return false;}result=true;});if(result){return false;}});return result;}return false;}));},selectAtts=function(data,noSiblings){var eids=(function(){var res=[];$HASH.forEach(data,function(a){$HASH.forEach(a,function(x,aid){$ARR.forEach(x,function(e){res.push([aid,e.id]);});});});return res;}()),ret,that=this,ic=$ARR.filter(this.interactiveCellsArray,function(item){ret=false;var isAttribute=!item.hasOwnProperty("mix")&&item._e&&item.fi===undefined,du=!isAttribute&&getCellDataUnion.call(that,item);if(isAttribute){$ARR.forEach(eids,function(eid){if((!noSiblings||that.model.getCellTitleInfo(item).title.id===eid[0])){ret=that.model.compareElementsId(item._e.id,eid[1]);}if(ret){return false;}});}else{if(!noSiblings&&du){$HASH.forEach(du,function(atts){$ARR.forEach(eids,function(eid){$ARR.forEach((atts||[]),function(att){if(att.id){ret=that.model.compareElementsId(att.id,eid[1]);}});if(ret){return false;}});if(ret){return false;}});}}return ret;}),someCells=getTDsForCells.call(this,ic),allCells=[],i,j,pn;if(noSiblings){allCells=someCells;}else{$ARR.forEach(someCells,function(cell){i=ic[$ARR.find(ic,"_ei",cell.getAttribute("ei"))];if(i.axis===1){var ridx=0,rowspan=cell.rowSpan||1,tr=cell.parentNode;do{pn=tr.childNodes;for(j=0;j<pn.length;j++){allCells.push(pn[j]);}}while((++ridx<rowspan)&&(tr=tr.nextSibling));}else{allCells.push(cell);}});}return allCells;},filterCellsForTarget=function(target){if(!this.getFormatTargetFromCell){return[];}var id=this.id;return getTDsForCells.call(this,$ARR.filter(this.interactiveCellsArray,function(cell){return mstrmojo.all[id].getFormatTargetFromCell(cell)===target;}));},filterForColHeaders=function(){var results=[],tableNode;if(this.getFormatTargetFromCell){$ARR.forEach(this.interactiveCellsArray,function(cell){if(this.getFormatTargetFromCell(cell)!==2){return false;}results.push(cell);return true;},this);}var clonedNodes=this.xtabClonedNodes;if(clonedNodes){var zone=$ARR.filterOne(clonedNodes,function(node){return node.lockType===2;});if(zone){tableNode=zone.domNode.getElementsByTagName("table")[0];}}return getTDsForCells.call(this,results,tableNode);},highlightCell=function(cell,isHighlighted,isRange){var css=["xtabSel"].concat($DOM.isIE||$DOM.isIEW3C?"ie":[],"sc_"+this.k);if(!isHighlighted||isRange){css.push("range");}if(!isHighlighted){css=css.concat($HASH.valarray(GROUP_BORDER_CSS));}$CSS.toggleClass(cell,css,isHighlighted);};mstrmojo.vi.ui.rw._XtabHighlights=mstrmojo.provide("mstrmojo.vi.ui.rw._XtabHighlights",{_mixinName:"mstrmojo.vi.ui.rw._XtabHighlights",highlights:null,highlight:function highlight(selectionType,data,fromExpression){if(this._super){this._super.apply(this,arguments);}var $SELECTION_TYPE=mstrmojo.vi.ui.rw.SelectionType,cells=[];this.clearHighlights();switch(selectionType){case $SELECTION_TYPE.METRICS:cells=selectMetricValues.call(this,data);break;case $SELECTION_TYPE.ATTS:cells=selectAtts.call(this,data,fromExpression);break;}this.highlightCells(cells,fromExpression);},highlightRange:function highlightRange(selectionType,preserveSelections){var $SELECTION_TYPE=mstrmojo.vi.ui.rw.SelectionType,currentHighlights=preserveSelections?this.highlights.slice():null,cells=[];this.clearHighlights();switch(selectionType){case $SELECTION_TYPE.COL_HEADERS:cells=filterForColHeaders.call(this);break;case $SELECTION_TYPE.ROW_HEADERS:cells=filterCellsForTarget.call(this,3);break;case $SELECTION_TYPE.METRIC_VALUES:cells=filterCellsForTarget.call(this,4);break;}$ARR.forEach(cells,function(td){var isRange=true;if(currentHighlights){var idx=$ARR.indexOf(currentHighlights,td);isRange=idx===-1;if(!isRange){currentHighlights.splice(idx,1);}}highlightCell.call(this,td,true,isRange);},this);this.highlights=cells;},clearSelections:function clearSelections(){if(this._super){this._super();}this.clearHighlights();},clearHighlights:function clearHighlights(){$ARR.forEach(this.highlights,function(v){highlightCell.call(this,v,false);},this);this.highlights=[];try{var cell=this.getCellForNode(this.lastSelectedCell),titles=cell&&this.gridData.gts[cell.axis===1?"row":"col"],ttl=titles&&titles[cell.tui||cell.ui],ttlId=ttl&&ttl.id;if(ttlId){this.zone.clearHilites(ttlId);}}catch(e){}},highlightCellsById:function highlightCellsById(oid,type,isNE){var model=this.model,fnCheckId=function(cell,eName,idName){return cell[eName]&&cell[eName]._e&&cell[eName]._e[idName]===oid;},cells=getTDsForCells.call(this,$ARR.filter(this.interactiveCellsArray,function(cell){var result=false;if(type===$OBJ_TYPES.DssTypeMetric){result=fnCheckId(cell,"_tp","oid")||fnCheckId(cell,"_lp","oid");}else{if(type===$OBJ_TYPES.DssTypeAttribute){if(isNE){result=fnCheckId(cell,"_tp","id")||fnCheckId(cell,"_lp","id");}else{if(model&&model.getNormalizedFormElementId&&cell._e&&cell._e.id){result=$EH.getAttributeId(model.getNormalizedFormElementId(cell._e.id))===oid;}}}}return result;}));this.clearHighlights();this.highlightCells(cells);},highlightCells:function(cells,fromExpression){if(this._super){this._super(cells,fromExpression);}$ARR.forEach(cells,function(v){highlightCell.call(this,v,true);},this);this.highlights=cells;},configureActions:function configureActions(){if(this._super){this._super();}if(!!this.selectorControl){this.highlight(this.getSelectionType(),this.getSelectionHash(),true);}},highlightGroupCells:function highlightGroupCells(icCollection,fromExpression){var highlights=[];$ARR.forEach(icCollection,function(ic){var axis=ic[0]&&ic[0].axis||1,isRowAxis=(axis===1),clonedHeader=this[isRowAxis?"clonedRowHeader":"clonedColHeader"],tableNode=(clonedHeader?clonedHeader.getTableNode():this.zone.tableNode),cells=getTDsForCells.call(this,ic,tableNode),len=cells.length;highlights=highlights.concat(cells);$ARR.forEach(cells,function(node,idx){var gbCss=GROUP_BORDER_CSS,css=[gbCss.cssClass];if(len>1){if(isRowAxis){css.push(idx>0?(idx<len-1?gbCss.midVert:gbCss.bottom):gbCss.top);}else{css.push(idx>0?(idx<len-1?gbCss.midHoriz:gbCss.right):gbCss.left);}}$CSS.addClass(node,css);},this);},this);this.highlights=highlights;}});}());