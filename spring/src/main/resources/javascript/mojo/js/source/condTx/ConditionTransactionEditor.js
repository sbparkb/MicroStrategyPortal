(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.css","mstrmojo.Editor","mstrmojo.Box","mstrmojo.Button","mstrmojo.fx","mstrmojo.expr","mstrmojo.array","mstrmojo.ui._HasScroller","mstrmojo.DropDownList","mstrmojo.condTx.ActionRow","mstrmojo.condTx.ActionModel","mstrmojo.condTx.ConditionWalk","mstrmojo.condTx.CommonComponent","mstrmojo.condTx.AdvancedExpression");mstrmojo.requiresDescs(221,1442,4787,6016,12305,12306);var $H=mstrmojo.hash,$C=mstrmojo.css,$E=mstrmojo.expr,$A=mstrmojo.array,_ET=$E.ET,_BF=$E.BRANCH_FNS,$NWB=mstrmojo.Button.newWebButton,$CC=mstrmojo.condTx.CommonComponent,_AT=$CC.ACTION_TYPE,_NT=$CC.NODE_TYPE;function addActionRow(at){var me=this,rowPanel=me.content.rowPanel,targetList=me.content.newAction.targetList,selectedTarget=(targetList.options&&targetList.options[targetList.idx||0])||{},children=rowPanel.children,idx=(children&&children.length)||0,model=me.model,actions=model.actions,action={actionType:at,target:selectedTarget,expr:{et:14,fn:19}};if(!actions){actions=model.actions=[];}actions.push(action);rowPanel.addChildren([{scriptClass:"mstrmojo.condTx.ActionRow",action:action,editor:me,model:model,idx:idx}]);rowPanel.children[idx].exprTree.newCondition(null);}function updateContent(){var me=this,target=me.target,content=me.content,model=me.model,actions=model.actions,rows=[],rowPanel=content.rowPanel,i=0,getTemplateCtlHostName=function(ck){var txnObjs=target&&target.txnObjs||[],idx=$A.find(txnObjs,"ctlKey",ck);return(idx>-1)?txnObjs[idx].n:"";};if(actions){$H.forEach(actions,function(action){if(target&&target.nodeType===_NT.TEMPLATE_UNIT_CONTROL&&action.target&&!action.target.n){action.target.n=getTemplateCtlHostName(action.target.ctlKey);}rows.push({scriptClass:"mstrmojo.condTx.ActionRow",action:action,editor:me,model:model,idx:i++});});}rowPanel.destroyChildren(false);rowPanel.addChildren(rows);this.updateScrollbars();}function getCtlTransactionCountXML(ctcs){var ctlCountsXML="";$H.forEach(ctcs,function(ctc){var att=[];for(var key in ctc){if(ctc[key]!=null){att.push(key+'="'+ctc[key]+'"');}}ctlCountsXML+=("<ctl "+att.join(" ")+"/>");});ctlCountsXML="<ctls>"+ctlCountsXML+"</ctls>";return ctlCountsXML;}function onSubmit(callBack){var model=this.model,actions=model.actions,target=$H.clone(this.target),msgID=this.messageID,thresholdsXML="",cIdx=0,nCIdx=0,me=this;if(actions){$H.forEach(actions,function(action){var targetInfo={nk:target.nodeKey,n:action.n,thact:action.actionType},expr=$CC.getExprXml(action.expr),att=[],key;if(action.actionType!=_AT.HIDE){targetInfo.ck=target.ctlKey||action.ck||(action.target&&action.target.ctlKey);++cIdx;targetInfo.ix=cIdx;}else{++nCIdx;targetInfo.ix=nCIdx;if(target.fieldKey){targetInfo.fk=target.fieldKey;}}for(key in targetInfo){if(targetInfo[key]!=null){att.push(key+'="'+targetInfo[key]+'"');}}thresholdsXML+=("<threshold "+att.join(" ")+">"+expr+"</threshold>");});}thresholdsXML="<thresholds>"+thresholdsXML+"</thresholds>";var params={taskId:"setConditionalTransaction",msgID:msgID,ntc:model.originNodeActionCount||0,ctc:getCtlTransactionCountXML(model.originCtlActionCount),ftc:model.originFieldActionCount||0,nodeKey:target.nodeKey||"",ctlKey:target.ctlKey||"",fieldKey:target.fieldKey||"",thresholds:thresholdsXML};if(microstrategy&&microstrategy.updateManager){params.rwb=microstrategy.updateManager.getRWBState(true);}mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(res){if(callBack){callBack(res);}},failure:function(res){var errMessage=res.getResponseHeader("X-MSTR-TaskFailureMsg");mstrmojo.alert(errMessage);}},params);}function slideProp(target,prop,start,stop,onEnd,ease,extraProps){var props={target:target,onEnd:function(){if(onEnd){onEnd();}},props:{}};props.props[prop]={ease:ease||mstrmojo.ease.linear,start:parseInt(start,10),stop:parseInt(stop,10),suffix:"px"};props=$H.copy(extraProps,props);var fx=new mstrmojo.fx.AnimateProp(props);fx.play();}function toggleVisibility(visible){var start,end,me=this;if(visible){$C.toggleClass(this.domNode,"disable",false);start=0;end=300;}else{start=300;end=0;}slideProp(this.domNode,"height",start,end,function(){if(!visible){$C.toggleClass(me.domNode,"disable",true);}},null);}mstrmojo.condTx.ConditionTransactionEditor=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.condTx.ConditionTransactionEditor",cssClass:"mstrmojo-ConditionTXN",title:mstrmojo.desc(12306,"Transaction Conditions"),id:"mstrCTE",postBuildRendering:function postBuildRendering(){this._super&&this._super();if(!this.model){this.set("model",mstrmojo.insert(mstrmojo.condTx.ActionModel));}},destroy:function destroy(ignoreDOM){var model=this.model;if(model&&model.destroy){model.destroy();}this._super(ignoreDOM);},onOpen:function onOpen(){updateContent.call(this);this.setRowPanelVisibility(true);},onClose:function onClose(){this.closeAdvEditor();if(this.content.conditionWalk){this.content.conditionWalk.close();}},openConditionWalk:function openConditionWalk(data,widget){var editor=this,content=editor.content,walk=content.conditionWalk,actionRow=widget.tree.parent,action=$H.clone(actionRow.action);action.expr=data;walk.set("editor",editor);var row=new mstrmojo.condTx.ActionRow({alias:"actionRow",slot:"conditionNode",idx:actionRow.idx,action:action,editable:false,onclick:mstrmojo.emptyFn});walk.addChildren(row);row.render();walk.set("objectBrowsingEnabled",editor.objectBrowsingEnabled);walk.set("target",editor.target);walk.set("source",editor.source);walk.set("actionType",action.actionType);walk.set("condition",widget);walk.set("model",$H.clone(data));editor.setRowPanelVisibility(false);$C.toggleClass(editor.content.domNode,"no-overflow",true);walk.set("visible",true);walk.doLayout();editor.toggleButtonStatus(false);this.updateScrollbars();},onConditionWalkClose:function onConditionWalkClose(){$C.toggleClass(this.content.domNode,"no-overflow",false);this.setRowPanelVisibility(true);},_set_model:function(n,v){var model=$H.make(v,mstrmojo.condTx.ActionModel);this.model=model;if(model){model.attachEventListener("modelEdit",this.id,"onmodelEdit");updateContent.call(this);}return true;},onmodelEdit:function onmodelEdit(){updateContent.call(this);},onsourceChange:function onsourceChange(){var source=this.source,fieldGroups=source&&source.fieldGroups||{};$H.forEach(fieldGroups,function(fg){var nk=fg.nk,fields=fg.fields||[];$H.forEach(fields,function(field){field.nk=field.nk||nk;field.dn=field.dn||field.n;field.did=field.nk+field.fk;});});var templates=source&&source.templates||{};$H.forEach(templates,function(tp){var nk=tp.nk,n=tp.n||"",atts=tp.atts||[],mxs=tp.mxs||[];$H.forEach(atts,function(at){at.nk=at.nk||nk;});$H.forEach(mxs,function(mx){mx.nk=mx.nk||nk;mx.dn=mx.dn||(n+":"+mx.n);});});},ontargetChange:function ontargetChange(){var t=this.target;if(t.nodeType===_NT.TEMPLATE_UNIT_CONTROL){if(this.editorNode){$C.addClass(this.editorNode,"templateUnit");}else{$C.addWidgetCssClass(this,"templateUnit");}}else{if(this.editorNode){$C.removeClass(this.editorNode,"templateUnit");}else{$C.removeWidgetCssClass(this,"templateUnit");}}if(t.txnObjs){var ts=t.txnObjs,i,len;for(i=0,len=ts.length;i<len;i++){ts[i].v=i;}}},setRowPanelVisibility:function toggleRowPanelVisibility(visible){var content=this.content;content.rowPanel.set("visible",visible);content.newAction.set("visible",visible);this.updateScrollbars();},openAndORPopup:function openAndORPopup(condition,targetNode){var menuCfg=new mstrmojo.ui.menus.MenuConfig();menuCfg.hostId=this.id;menuCfg.hostElement=targetNode;menuCfg.isHostedWithin=false;var update=function update(itemContext){var w=condition,did=itemContext.ctxt.did,not=did>21?true:null,fn=did-(not?21:0);var bq=w&&w.parent;if(bq&&bq.data&&bq.data.et===_ET.ANDOR){bq.edit(w,fn,not);}else{var d=w&&w.data;if(d&&(d.not!==not)){d.not=not;w.paint();}}};menuCfg.addMenuItem(_BF[19],"",update,{did:19});menuCfg.addMenuItem(_BF[20],"",update,{did:20});menuCfg.addMenuItem(_BF["19_21"],"",update,{did:19+21});menuCfg.addMenuItem(_BF["20_21"],"",update,{did:20+21});this.openPopup(menuCfg.newInstance());},toggleButtonStatus:function toggleButtonStatus(status){$A.forEach(this.buttonBar.children,function(button){button.set("enabled",status);});},openAdvEditor:function openAdvEditor(model,columnWalk){var content=this.content,advExpr=content.advExpr;advExpr.set("host",columnWalk);advExpr.set("model",model);content.conditionWalk.toggleVisibility(false);content.advExpr.toggleVisibility(true);content.advExpr.objBox.objList.updateScrollbars();},closeAdvEditor:function closeAdvEditor(){var content=this.content,advExpr=content.advExpr;advExpr.set("host",null);advExpr.set("model",null);content.conditionWalk.toggleVisibility(true);content.advExpr.toggleVisibility(false);},onUpdateBrowseElementsParams:function onUpdateBrowseElementsParams(params){var bwElements=this.source.bwElements||{};params.datasetID=params.attributeID&&bwElements[params.attributeID]||"";params.messageID=this.messageID;params.templateNodeKey=this.target.nodeKey;},children:[{scriptClass:"mstrmojo.Widget",markupString:'<div class="rulesTitles"><div class="reserved"></div><div class="target">'+mstrmojo.desc(4787,"Target")+'</div><div class="action">'+mstrmojo.desc(6016,"Action")+'</div><div class="condition">'+mstrmojo.desc(12305,"Conditions")+"</div></div>"},{scriptClass:"mstrmojo.Box",cssClass:"content",alias:"content",children:[{scriptClass:"mstrmojo.Box",alias:"rowPanel",children:[]},{scriptClass:"mstrmojo.HBox",alias:"newAction",children:[{scriptClass:"mstrmojo.Label",alias:"newButton",cssClass:"link",text:"",onclick:function onclick(){var p=this.parent,pas=p.actions,editor=p.parent.parent;addActionRow.call(editor,pas.options[pas.idx||0].v);}},{scriptClass:"mstrmojo.DropDownList",alias:"targetList",cssClass:"targetList",idx:0,bindings:{visible:function(){var target=this.parent.parent.parent.target;return target.nodeType===_NT.TEMPLATE_UNIT_CONTROL&&!target.ctlKey;},options:"this.parent.parent.parent.target.txnObjs"},onoptionsChange:function(){if(this.options){this.refresh();}}},{scriptClass:"mstrmojo.DropDownList",alias:"actions",cssClass:"actionList",idx:0,bindings:{options:function(){var target=this.parent.parent.parent.target,opts=$CC.ACTION_CANDIDATES,nt=target.nodeType,isEditable=!!target.ctlKey;if(nt===_NT.TEXT_FIELD&&!isEditable){return[$CC.ACTION_ITEMS[2]];}return opts[nt];}},onoptionsChange:function(){if(this.options){this.refresh();}}}]},{scriptClass:"mstrmojo.condTx.ConditionWalk",alias:"conditionWalk",height:"300px",width:"750px",visible:false,toggleVisibility:toggleVisibility},{scriptClass:"mstrmojo.condTx.AdvancedExpression",alias:"advExpr",cssClass:"AdvancedExpression disable",height:"300px",width:"750px",toggleVisibility:toggleVisibility}]},{scriptClass:"mstrmojo.Box",alias:"buttonBar",slot:"buttonNode",children:[$NWB(mstrmojo.desc(221,"Cancel"),function(){this.parent.parent.close();}),$NWB(mstrmojo.desc(1442,"OK"),function(){var editor=this.parent.parent;onSubmit.call(editor,function(res){if(editor.onsave){editor.onsave(res);}editor.close();});})]}]});}());