(function(){mstrmojo.requiresCls("mstrmojo.Pulldown");var KEYCODE={ENTER:13,LEFT:37,UP:38,TAB:9,RIGHT:39,DOWN:40,ESC:27};function filterList(pattern,items){var i,len,n,subItems=[],regPtn,matchTop;try{regPtn=new RegExp(pattern,"i");}catch(e){regPtn=new RegExp(mstrmojo.string.regEscape(pattern));}for(i=0,len=items.length;i<len;i++){if(regPtn.test(items[i][this.itemField])){subItems.push(items[i]);}}return subItems;}function isValidIndex(selectedIndex){return !(selectedIndex<0||selectedIndex===undefined||selectedIndex===null);}mstrmojo.SearchablePulldown=mstrmojo.declare(mstrmojo.Pulldown,null,{scriptClass:"mstrmojo.SearchablePulldown",popupCssClass:"mstrmojo-SearchablePulldown-Popup",searchEnabled:false,allowCustomInput:false,useItemCssOnInput:false,lastSearchPattern:"",isEditing:false,allItems:null,markupString:'<div id="{@id}" class="mstrmojo-SearchablePulldown mstrmojo-DropDownButton {@cssClass} {@direction}" style="{@cssText}"><div class="mstrmojo-SearchablePulldown-boxNode mstrmojo-DropDownButton-boxNode {@cssClass}-boxNode" title="{@title}" mstrAttach:mousedown><input class="mstrmojo-SearchablePulldown-inputNode" value="{@text}" mstrAttach:keyup,blur/><div class="mstrmojo-SearchablePulldown-iconNode mstrmojo-DropDownButton-iconNode {@cssClass}-iconNode" mstrAttach:mouseover,mouseout></div></div><div class="mstrmojo-DropDownButton-popupNode {@cssClass}-popupNode"></div></div>',markupSlots:{boxNode:function(){return this.domNode.firstChild;},inputNode:function(){return this.domNode.firstChild.firstChild;},iconNode:function(){return this.domNode.firstChild.children[1];},popupNode:function(){return this.domNode.lastChild;}},markupMethods:mstrmojo.hash.copy({ontextChange:function(){if(this.inputNode.value!==this.text){this.inputNode.value=this.text;}},onheightChange:function(){this.domNode.style.height=this.height||"";this.boxNode.style.height=this.height||"";},onsearchEnabledChange:function(){this.inputNode.readOnly=this.searchEnabled?false:true;this.items=this.allItems||this.items;},onallowCustomInputChange:function(){if(this.allowCustomInput){this.set("searchEnabled",true);}},onvalueChange:function onvalueChange(){if(this.useItemCssOnInput&&this.selectedItem){this.inputNode.className="mstrmojo-SearchablePulldown-inputNode "+(this.selectedItem[this.itemCSS]||"");}}},mstrmojo.hash.copy(mstrmojo.Pulldown.prototype.markupMethods)),prevalueChange:function(){this.synchronize();},synchronize:function(){var v=this.value,its=this.items||[],selItem=its[this.selectedIndex],idx=-1;if(selItem&&v===selItem[this.itemIdField]){this.selectedItem=selItem;this.set("text",selItem[this.itemField]);return ;}idx=mstrmojo.array.find(this.items,this.itemIdField,v);if(!isValidIndex(idx)&&this.allowCustomInput){this.selectedItem=undefined;this.selectedIndex=undefined;return ;}this.selectedIndex=isValidIndex(idx)?idx:this.defaultSelection;this.selectedItem=selItem=this.items[this.selectedIndex];this.value=selItem?selItem[this.itemIdField]:undefined;this.set("text",selItem?selItem[this.itemField]:(this.defaultText||""));},preBuildRendering:function preBuildRendering(){if(this._super){this._super();}this.allItems=this.allItems||this.items;this.synchronize();},premousedown:function(e){if(this.searchEnabled&&e.getTarget()===this.iconNode){this.set("items",this.allItems);}this._super(e);},onkeyup:function(evt){var pattern=mstrmojo.string.trim(this.inputNode.value),e=evt.e,keyCode=e.keyCode||e.which,idx=isValidIndex(this.selectedIndex)?this.selectedIndex:-1,custom=this.allowCustomInput,len=this.items.length;this.isEditing=true;switch(keyCode){case KEYCODE.ENTER:if(len>0&&!custom){this.set("selectedIndex",idx===-1?0:idx);this.synchronize();}this.closePopup();break;case KEYCODE.ESC:this.closePopup();this.synchronize();break;case KEYCODE.UP:if(this.popupRef.visible&&len>0){this.set("selectedIndex",(idx+len-1)%len);this.synchronize();}break;case KEYCODE.DOWN:if(!this.popupRef.visible&&len>0){this.togglePopup();}this.set("selectedIndex",(idx+1)%len);this.synchronize();break;default:if(pattern===this.lastSearchPattern){return ;}var items=[];if(pattern&&pattern.length>0&&pattern.indexOf(this.lastSearchPattern)>-1){items=filterList.apply(this,[pattern,this.items]);}else{items=filterList.apply(this,[pattern,this.allItems]);}this.set("items",items);if(items.length===0){this.closePopup();}else{if(!this.popupRef.visible){this.togglePopup();}}this.set("selectedIndex",undefined);if(pattern&&pattern.length){var index=mstrmojo.array.find(items,this.itemField,pattern);if(index!==-1){this.set("selectedIndex",index);}}}if(custom&&!isValidIndex(this.selectedIndex)){this.set("value",this.inputNode.value);}this.lastSearchPattern=pattern;},onblur:function(evt){this.isEditing=false;if(!this.searchEnabled){return ;}if(!this.allowCustomInput){this.items=this.allItems;this.synchronize();}}});}());