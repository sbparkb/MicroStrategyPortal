(function(){mstrmojo.requiresCls("mstrmojo.form","mstrmojo.hash","mstrmojo.Obj","mstrmojo.architect.ui.editors.NameEditor","mstrmojo.warehouse.EnumDataChangeEvents","mstrmojo.warehouse.obj.DBRole","mstrmojo.warehouse.dbroles.DBRoleEditor","mstrmojo.warehouse.ui.editors.CatalogSQLEditor","mstrmojo.DI.DIConstants");var $H=mstrmojo.hash,$WRAP=mstrmojo.func.wrapMethods,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents,DBTABLES_CHANGED=$ENUM_DATA_CHANGE_EVENTS.DBTABLES_CHANGED,$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,ENUM_OT_DBROLE=$ENUM_OT.DBROLE,constants=mstrmojo.DI.DIConstants,catalogSQLEditor,dbrEditor,DssXmlPrivilegesUseDatabaseInstanceManager=57;function getDBrole(data,createNew){var dbr;if(data){dbr=this.model.getDBRole(data.did);if(dbr){return dbr;}}if(createNew){dbr=new mstrmojo.warehouse.obj.DBRole({mdl:this.model});if(data&&data.did){dbr.did=data.did;}return dbr;}return null;}function getDataSourceHelp(){var help="creating_a_database_connection.htm";if(mstrApp.type===constants.xdaType.mdx){help="Creating_a_data_source_connection_to_an_OLAP_source.htm";}else{if(mstrApp.subtype===constants.sourceSubtype.searchOnSource){help="Creating_a_data_source_connection_to_search.htm";}}return help;}mstrmojo.warehouse.WHController=mstrmojo.declare(mstrmojo.Obj,null,{start:mstrmojo.emptyFn,getDataService:mstrmojo.emptyFn,loadDBRoles:function loadDBRoles(callback){this.model.loadDBRoles(callback);},isCloud:function isCloud(){return false;},isUsingCookieNamespace:function isUsingCookieNamespace(){return this.model.usingCookieNamespace;},getDBRoles:function getDBRoles(){return this.model.dbrs;},getAllDBRoleNames:function getAllDBRoleNames(){return this.model.allDBRoleNames;},loadDBObjects:function loadDBObjects(callback){this.model.loadDBObjects(callback);},getDBObjects:function getDBObjects(){return this.model.dbObjects;},setNameSpaceID:function setNameSpaceID(nsID){this.model.set("SelNameSpaceID",nsID);},getNameSpaceID:function getNameSpaceID(){return this.model.SelNameSpaceID;},getNameSpaces:function getNameSpaces(params){this.model.SelNameSpaceID=undefined;this.model.getNameSpaces(params);},getColumnsForDBTables:function getColumnsForDBTables(params,callback){var model=this.model,tables=params.tables,refresh=params.getFresh;$H.forEach(tables,function(table){model.getColumnsForDBTable({data:table,getFresh:refresh},$WRAP({success:function success(res){table.items=$H.clone(res.items);},complete:function complete(){model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBTABLE_UPDATED,item:table});}},callback));});},getColumnsForDBTable:function getColumnsForDBTable(params,callback){if(catalogSQLEditor&&catalogSQLEditor.visible){params.data.dbrole=catalogSQLEditor.dbRole.did;}this.model.getColumnsForDBTable(params,callback);},setSelectedDBRoleID:function setSelectedDBRoleID(newDBRole){this.model.set("SelDBRoleID",newDBRole.did);},handleDBTableRefresh:function handleDBTableRefresh(params){var model=this.model;model.catalogRefresh=true;this.availableTableSearch("",$H.copy(params,{sourceInfo:"tablesPanel"}));},sqls:undefined,getCurrentZIndex:function getCurrentZIndex(){if(mstrApp.sessionManager){return mstrApp.sessionManager.zIndex;}return undefined;},displayCatalogSQL:function displayCatalogSQL(dbrID){var rootController=this,model=this.model,dbRoleID=dbrID||model.SelDBRoleID;catalogSQLEditor=catalogSQLEditor||new mstrmojo.warehouse.ui.editors.CatalogSQLEditor({help:"defining_tables_are_retrieved_and_cached_for_a_data_source.htm"});rootController.getDataService().catalogAction({success:function success(res){catalogSQLEditor.options=res.options;catalogSQLEditor.SQLStatements=res.sqls;model.getDBRole(dbRoleID).populate(function successFn(dbRole){catalogSQLEditor.dbRole=dbRole;catalogSQLEditor.supportsNameSpaces=dbRole.supportsNameSpaces;catalogSQLEditor.onUpdateInfo=function onUpdateInfo(SQLOptions){rootController.getDataService().catalogAction({success:function success(){if(model.SelDBRoleID===dbRoleID&&model.SelNameSpaceID){rootController.availableTableSearch("",{sourceInfo:"tablesPanel"});}}},{dbrid:dbRoleID,info:JSON.stringify(SQLOptions.options),flags:10003});};var zIndex=rootController.getCurrentZIndex(),cfg={};if(zIndex){cfg.zIndex=zIndex+1;}catalogSQLEditor.open(null,cfg);});}},{dbrid:dbRoleID,flags:10002});},attachDataChangeListeners:function attachDataChangeListeners(eventsConfig){var model=this.model;$H.forEach(eventsConfig,function(config,id){$H.forEach(config,function(callback,eventName){model.attachEventListener(eventName,id,callback);});});},editDBRole:function editDBRole(data,callback){var $this=this;getDBrole.call(this,data,true).populate(function(dbr){$this.loadDBObjects({success:function success(){dbrEditor=dbrEditor||new mstrmojo.warehouse.dbroles.DBRoleEditor({help:getDataSourceHelp()});dbrEditor.config=$this.model.dbRoleEditorCfg;dbrEditor.config.showAddDriver=$this.model.showAddDriver;dbrEditor.callback=callback||mstrmojo.emptyFn;dbrEditor.dbrole=dbr;dbrEditor.container.dsninfo.clear();dbrEditor.open();}});});},renameDBRole:function renameDBRole(data){getDBrole.call(this,data,false).populate(function(dbr){if(!dbr){return ;}var renameEditor=new mstrmojo.architect.ui.editors.NameEditor({data:dbr,tp:ENUM_OT_DBROLE,zIndex:9999,isNew:false,help:getDataSourceHelp(),onOK:function onOK(name){dbr.rename(name);}});renameEditor.open();});},duplicateDBRole:function duplicateDBRole(data){var $this=this;getDBrole.call($this,data,false).populate(function(dbr){if(!dbr){return ;}dbr.duplicate();});},deleteDBRole:function deleteDBRole(data){var $this=this;getDBrole.call($this,data,false).populate(function(dbr){var $NIB=mstrmojo.Button.newInteractiveButton;if(!dbr){return ;}mstrmojo.confirm(mstrmojo.desc(10073,"Are you sure you want to delete the Database Connection")+" "+dbr.n+"?",null,{buttons:[$NIB(mstrmojo.desc(219,"Yes"),function yes(){$this.model.deleteDBRole(dbr.mdDBRole.did,{success:function success(){}});},null,{iconClass:"mstrmojo-Editor-button-Yes"}),$NIB(mstrmojo.desc(218,"no"),null,null,{iconClass:"mstrmojo-Editor-button-No"})],title:mstrmojo.desc(3169,"delete"),zIndex:9999});});},setProjectPrimaryDBRole:function setProjectPrimaryDBRole(data,callback){var model=this.model;model.SelDBRoleID=data.did;model.setProjectPrimaryDBRole(true,callback);},getProjectPrimaryDBRoleID:function getprojectPrimaryDBRoleID(){return this.model.projPrimaryDBRoleID;},saveDBRole:function saveDBRole(dbRole,isNew,callback){var $this=this;$this.model.saveDBRole(dbRole.mdDBRole,isNew,$WRAP(callback,{success:function success(res){var did=res.dbr.did,n=res.dbr.n,dbr=getDBrole.call($this,{did:did},true);dbr.populated=false;dbr.n=n;}}));},populateDBRole:function populateDBRole(dbRoleID,callback){this.model.populateDBRole(dbRoleID,callback);},navigateProject:function navigateProject(projectinfo){if(projectinfo){mstrmojo.form.send({evt:3010,Server:projectinfo.sname,Project:projectinfo.pname,Port:projectinfo.port,loginReq:true},mstrApp.name,"POST",null,null,false);}else{mstrmojo.form.send({evt:3010},mstrApp.name,"POST",null,null,false);}},navigateArchitect:function navigateArchitect(projectinfo){mstrmojo.form.send({evt:3176,Server:projectinfo.sname,Project:projectinfo.pname,Port:projectinfo.port,loginReq:true},mstrApp.name,"POST",null,null,false);},availableTableSearch:function availableTableSearch(searchValue,params){this.model.getSelectedDBRoleTables($WRAP({blockBegin:0,blockCount:1000,filterText:searchValue},params||{}));},getPrimaryDBRoleTablesAndColumns:function getPrimaryDBRoleTablesAndColumns(callback){this.model.getDBRoleTablesAndColumns({dbRoleID:this.model.projPrimaryDBRoleID},callback);},hasPrivilege:function hasPrivilege(privilege){return mstrApp.isSingleTier||this.model.privileges[privilege]||false;},validateName:function validateName(type,newName,oldName,list){return this.model.validateName(type,newName,oldName,list);},findNextName:function findNextName(name,list,prop){return this.model.findNextName(name,list,prop);},findinArray:function findinArray(arr,n,v){return this.model.findinArray(arr,n,v);},getObjectCount:function getObjectCount(list){if(Object.keys){return Object.keys(list).length;}var key,listKeys=[];for(key in list){if(list.hasOwnProperty(key)){listKeys.push(key);}}return listKeys.length;},destroy:function destroy(ignoreDOM){if(dbrEditor){dbrEditor.destroy(ignoreDOM);dbrEditor=null;}this._super(ignoreDOM);},cleanError:function cleanError(msg){msg=msg.replace("com.microstrategy.webapi.MSTRWebAPIException:","");msg=msg.replace("Internal Error:","");return mstrmojo.string.trim(msg);},launchOneTierFileBrowser:function launchOneTierFileBrowser(callback){window.FormWrapper.openFileDialog(callback);},launchOneTierAccessFileBrowser:function launchOneTierFileBrowser(callback){window.FormWrapper.openAccessDialog(callback);},oneTierFileUploader:function oneTierFileUploader(callback,params){mstrApp.serverRequest($H.copy(params,{taskId:"addDriver"}),callback,true);},clearDBTables:function clearDBTables(){this.model.raiseEvent({name:DBTABLES_CHANGED,items:[],selectedItems:[]});},canDisplayCatalogSQL:function canDisplayCatalogSQL(dbTypes,dbType){var dbTypesArr=mstrmojo.hash.valarray(dbTypes),index=mstrmojo.array.find(dbTypesArr,"v",dbType),dbTypeObj=dbTypesArr[index];if(mstrApp.isSingleTier){return false;}if((dbTypeObj.disp&2)===2||(dbTypeObj.disp&4)===4){return false;}if(!this.hasPrivilege(DssXmlPrivilegesUseDatabaseInstanceManager)){return false;}return true;}});}());