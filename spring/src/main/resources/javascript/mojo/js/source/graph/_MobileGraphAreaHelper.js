(function(){mstrmojo.requiresCls("mstrmojo.array");var MAX_TOOLTIPS=10,TOOLTIP_PADDING=20,tooltipPositionChanged=false,rightTooltipPositionChanged=false,maxAreasToShow=MAX_TOOLTIPS,tooltipsToPosition=[],$ARR=mstrmojo.array,hasLargeTooltip=false,TOOLTIP_PADDING_LEFT_RIGHT,topTitleHeight;var AreaShapePolygon=6,AreaShapeRectangle=7,AreaShapeCircle=100,AreaShapeRingSector=101,AreaShapeNormalSector=102,AreaShapeCylinder=103;function drawPoly(ctx,pointsArray,clr){var startX=pointsArray[0],startY=pointsArray[1],j;ctx.beginPath();ctx.moveTo(startX,startY);for(j=2;j<pointsArray.length-1;j=j+2){ctx.lineTo(pointsArray[j],pointsArray[j+1]);}ctx.lineTo(startX,startY);ctx.fillStyle=clr;ctx.stroke();ctx.fill();}function drawRectangle(ctx,pointsArray,clr){var x=pointsArray[0],y=pointsArray[1],width=pointsArray[2]-x,height=pointsArray[3]-y;ctx.fillStyle=clr;ctx.strokeRect(x,y,width,height);ctx.fillRect(x,y,width,height);}function drawRingSector(ctx,pointsArray,clr){var centerX=pointsArray[0],centerY=pointsArray[1],innerRadius=pointsArray[2],outerRadius=pointsArray[3],startAngle=pointsArray[4],endAngle=pointsArray[5];ctx.beginPath();ctx.arc(centerX,centerY,outerRadius,startAngle,endAngle,false);ctx.lineTo(centerX+innerRadius*Math.cos(endAngle),centerY+innerRadius*Math.sin(endAngle));ctx.arc(centerX,centerY,innerRadius,endAngle,startAngle,true);ctx.closePath();ctx.fillStyle=clr;ctx.stroke();ctx.fill();}function drawNormalSector(ctx,pointsArray,clr){var centerX=pointsArray[0],centerY=pointsArray[1],radius=pointsArray[2],startAngle=pointsArray[3],endAngle=pointsArray[4],scale=pointsArray[5];ctx.scale(1,scale);ctx.beginPath();ctx.arc(centerX,centerY,radius,startAngle,endAngle,false);ctx.lineTo(centerX,centerY);ctx.arc(centerX,centerY,0,endAngle,startAngle,true);ctx.closePath();ctx.fillStyle=clr;ctx.stroke();ctx.fill();ctx.scale(1,1/scale);}function drawCylinder(ctx,pointsArray,clr){var centerX=pointsArray[0],centerY=pointsArray[1],radius=pointsArray[2],startAngle=pointsArray[3],endAngle=pointsArray[4],depth=pointsArray[5],scale=pointsArray[6];ctx.scale(1,scale);ctx.beginPath();ctx.arc(centerX,centerY,radius,startAngle,endAngle,false);ctx.lineTo(centerX+radius*Math.cos(endAngle),centerY+radius*Math.sin(endAngle)-depth);ctx.arc(centerX,centerY-depth,radius,endAngle,startAngle,true);ctx.closePath();ctx.fillStyle=clr;ctx.stroke();ctx.fill();ctx.scale(1,1/scale);}function drawCircle(ctx,pointsArray,clr){ctx.fillStyle=clr;ctx.beginPath();ctx.arc(pointsArray[0],pointsArray[1],pointsArray[2],0,Math.PI*2,true);ctx.stroke();ctx.fill();}function sortAreaElements(a,b){return a.Point.X-b.Point.X;}function setTooltipInfo(area,ep,tooltipPosition){var tooltip=this.tooltipArr[tooltipPosition],ttl=area.Text,borderColor=area.SC,style=tooltip.style,zoom=this.model.getZoomFactor(),deviceDPI=mstrMobileApp.getDeviceDPI()/160,padding=2*deviceDPI,tooltipMaxWidth=mstrApp.getScreenDimensions().w-(TOOLTIP_PADDING_LEFT_RIGHT*2);if(mstrApp.isTablet()){zoom=(zoom*deviceDPI)+"em";}else{if(mstrMobileApp.getDeviceDPI()>240){zoom=(zoom*1.5)+"em";}else{zoom+="em";}}var cssText="font-size:"+zoom+";";cssText+="padding:"+padding+"px;";cssText+="maxWidth:"+tooltipMaxWidth+"px;";if(borderColor){cssText+="border-color:#"+borderColor;}tooltip.innerHTML=ttl;style.cssText=cssText;style.display="block";var top=0,left=0;var offsetHeight=tooltip.offsetHeight,offsetWidth=tooltip.offsetWidth;top=ep.y-offsetHeight-6;left=ep.x-offsetWidth-6;tooltipsToPosition.push({x:area.Point.X,y:area.Point.Y,clr:borderColor||"#000000",top:top,left:left,width:offsetWidth,height:offsetHeight});}function setSingleTooltipPosition(graph,tooltip,posElement){var left=posElement.left,top=Math.max(posElement.top,topTitleHeight+TOOLTIP_PADDING);width=posElement.width,style=tooltip.style,newLeft=left+width+12;if(newLeft+width<=mstrApp.getScreenDimensions().w){left=newLeft;}else{if(left<0){left=TOOLTIP_PADDING_LEFT_RIGHT;}}style.left=left+"px";style.top=top+"px";graph.showAreaMarker(posElement.x,posElement.y,posElement.clr);}function positionLeftColumnTooltip(graph,position){var posElement=tooltipsToPosition[position],tooltipArr=graph.tooltipArr,style=tooltipArr[position].style,left=posElement.left,top=posElement.top,width=posElement.width,height=posElement.height,screenWidth=mstrApp.getScreenDimensions().w,i,newLeft;if(position>0){var prevPosElem=tooltipsToPosition[position-1],prevTop=prevPosElem.top,prevLeft=prevPosElem.left,prevRight=prevLeft+prevPosElem.width,currRight=prevLeft+width,prevTooltip;left=prevLeft;if(currRight>prevRight){left-=(currRight-prevRight);}else{if(currRight<prevRight){left+=(prevRight-currRight);}}if(left<0){if((width*2)+12>screenWidth){tooltipPositionChanged=false;hasLargeTooltip=true;left=TOOLTIP_PADDING_LEFT_RIGHT;for(i=0;i<position;i++){prevTooltip=tooltipArr[i];prevPosElem=tooltipsToPosition[i];newLeft=left+width-prevPosElem.width;prevPosElem.left=newLeft;prevTooltip.style.left=left+width-prevPosElem.width+"px";}}else{tooltipPositionChanged=true;}}top=prevTop-TOOLTIP_PADDING-height;if(top<topTitleHeight){var pushHeight=Math.abs(top)+topTitleHeight+TOOLTIP_PADDING;for(i=0;i<position;i++){prevTooltip=tooltipArr[i];prevPosElem=tooltipsToPosition[i];prevTop=prevPosElem.top+pushHeight;prevPosElem.top=prevTop;prevTooltip.style.top=prevTop+"px";}top+=pushHeight;}}else{if(left<0){if((width*2)+12>screenWidth){hasLargeTooltip=true;left=TOOLTIP_PADDING_LEFT_RIGHT;}else{tooltipPositionChanged=true;}}if(top<topTitleHeight){top=topTitleHeight+TOOLTIP_PADDING;}}if(!tooltipPositionChanged){style.left=left+"px";posElement.left=left;}style.top=top+"px";posElement.top=top;graph.showAreaMarker(posElement.x,posElement.y,posElement.clr);}function positionRightColumnTooltip(graph,position,adjustCount,left){var style=graph.tooltipArr[position].style,posElement=tooltipsToPosition[position],top=tooltipsToPosition[position-adjustCount].top,width=posElement.width;if(left+width>mstrApp.getScreenDimensions().w){rightTooltipPositionChanged=true;style.display="none";return ;}style.left=left+"px";style.top=top+"px";graph.showAreaMarker(posElement.x,posElement.y,posElement.clr);}function setMultiTooltipPositions(graph){var tooltipsSize=tooltipsToPosition.length,tooltipArr=graph.tooltipArr,halfTooltipsSize=Math.ceil(tooltipsSize/2),i=0,adjustCount=1,maxColTooltipSize=Math.min(tooltipsSize,MAX_TOOLTIPS/2),screenWidth=mstrApp.getScreenDimensions().w,posElement,left,currTooltip,rightMostPositon;for(i=0;i<halfTooltipsSize;i++){positionLeftColumnTooltip(graph,i);}if(tooltipPositionChanged||hasLargeTooltip){for(i;i<maxColTooltipSize;i++){positionLeftColumnTooltip(graph,i);}if(!hasLargeTooltip){var j=i-1,rightMostPosition=0,tempPosition=0,biggestPosElement,currentPosElementWidth;posElement=tooltipsToPosition[j];left=posElement.left+posElement.width+12;for(j=i-1;j>=0;j--){currTooltip=tooltipArr[j];currentPosElementWidth=tooltipsToPosition[j].width;if(left+currentPosElementWidth>screenWidth){tempPosition=TOOLTIP_PADDING_LEFT_RIGHT+currentPosElementWidth;if(tempPosition>rightMostPosition){rightMostPositon=tempPosition;biggestPosElement=tooltipsToPosition[j];}}currTooltip.style.left=left+"px";}if(rightMostPosition>0){for(j=0;j<i;j++){currTooltip=tooltipArr[j];currTooltip.style.left=(TOOLTIP_PADDING_LEFT_RIGHT+biggestPosElement.width-tooltipsToPosition[j].width)+"px";}}}}else{posElement=tooltipsToPosition[tooltipsSize-1];left=posElement.left+posElement.width+12;for(i;i<tooltipsSize;i++){positionRightColumnTooltip(graph,i,adjustCount,left);adjustCount+=2;if(rightTooltipPositionChanged){break;}}if(rightTooltipPositionChanged&&i<=maxColTooltipSize){for(i=halfTooltipsSize;i<tooltipsSize;i++){positionLeftColumnTooltip(graph,i);tooltipArr[i].style.display="block";}}}}function setTooltipPositions(){var me=this,numTooltips=tooltipsToPosition.length;if(numTooltips===0){return ;}topTitleHeight=mstrApp.rootView.getTitleHeight();if(numTooltips===1){setSingleTooltipPosition(me,me.tooltipArr[0],tooltipsToPosition[0]);}else{setMultiTooltipPositions(me);}}function drawShape(shapeType,ctx,coords,color){switch(shapeType){case AreaShapeRectangle:drawRectangle(ctx,coords,color);break;case AreaShapeCircle:drawCircle(ctx,coords,color);break;case AreaShapeRingSector:drawRingSector(ctx,coords,color);break;case AreaShapeNormalSector:drawNormalSector(ctx,coords,color);break;case AreaShapeCylinder:drawCylinder(ctx,coords,color);break;default:drawPoly(ctx,coords,color);}}mstrmojo.graph._MobileGraphAreaHelper=mstrmojo.provide("mstrmojo.graph._MobileGraphAreaHelper",{highlightArea:function highlightArea(animationCanvas,areas){var me=this,ctx=animationCanvas.getContext("2d"),color="rgba(255, 255, 255, 0.5)";me.clearHighlightArea(animationCanvas);ctx.strokeStyle="#FFFFFF";$ARR.forEach(areas,function(area){drawShape(area.Shape,ctx,area.Coords,color);});},highlightAreaInInit:function highlightAreaInInit(animationCanvas,selected){var ctx=animationCanvas.getContext("2d"),allAreas=this.graphData.Areas,color="rgba(255, 255, 255, 0.5)";ctx.clearRect(0,0,animationCanvas.width,animationCanvas.height);ctx.strokeStyle="#FFFFFF";var numAreas=allAreas.length,DssGraphRiser=286,DssGraphDataMarker=259,DssGraphPieSlice=341;var numOfSelected=selected.length/2,j,i;for(i=0;i<numAreas;i++){var area=allAreas[i],areaOID=parseInt(area.OID,10);if(areaOID!==DssGraphRiser&&areaOID!==DssGraphDataMarker&&areaOID!==DssGraphPieSlice){continue;}if(area.SID<0||area.GID<0){continue;}for(j=0;j<numOfSelected;j++){if(area.SID!==selected[2*j]||area.GID!==selected[2*j+1]){continue;}drawShape(area.Shape,ctx,area.Coords,color);}}},clearHighlightArea:function clearHighlightArea(animationCanvas){if(animationCanvas){var ctx=animationCanvas.getContext("2d");ctx.clearRect(0,0,animationCanvas.width,animationCanvas.height);animationCanvas.width=animationCanvas.width;}},showAreaMarker:function showAreaMarker(x,y,clr){if(x>=0&&y>=0){var ctx=this.highlightNode.getContext("2d");ctx.save();ctx.fillStyle="#FFFFFF";ctx.strokeStyle=clr||"#000000";ctx.lineWidth=2;ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2,true);ctx.stroke();ctx.fill();ctx.fillStyle=clr||"#000000";ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2,true);ctx.stroke();ctx.fill();ctx.restore();}},displayTooltips:function displayTooltips(areas,adjustX,adjustY){areas.sort(sortAreaElements);var tooltipArr=this.tooltipArr,i;tooltipPositionChanged=false;rightTooltipPositionChanged=false;tooltipsToPosition=[];this.clearHighlightArea(this.highlightNode);if(!tooltipArr){TOOLTIP_PADDING_LEFT_RIGHT=8*(mstrMobileApp.getDeviceDPI()/160);tooltipArr=[];for(i=0;i<MAX_TOOLTIPS;i++){var divEl=document.createElement("div");divEl.id="mstrmojo-mobileGraph-tooltip";divEl.className=mstrmojo.GraphBase.tooltipCLS;document.body.appendChild(divEl);tooltipArr[i]=divEl;}this.tooltipArr=tooltipArr;}maxAreasToShow=Math.min(areas.length,MAX_TOOLTIPS);var touchManager=mstrmojo.touchManager;if(maxAreasToShow===0&&this._touchListener){touchManager.detachEventListener(this._touchListener);delete this._touchListener;}else{if(maxAreasToShow>0&&!this._touchListener){this._touchListener=touchManager.attachEventListener("touchesBegin",this.id,function(evt){var sourceWidget=mstrmojo.all[evt.srcId];if(!(sourceWidget instanceof mstrmojo.android.ui.ActionToolbarButtons||sourceWidget instanceof mstrmojo.android.ui.Menu)){this.displayTooltips([],0,0);}});}}var area=null,ep={},style;hasLargeTooltip=false;for(i=0;i<MAX_TOOLTIPS;i++){style=tooltipArr[i].style;style.left=-9999;style.display="none";}for(i=0;i<maxAreasToShow;i++){area=areas[i];ep.x=area.Point.X+adjustX;ep.y=area.Point.Y+adjustY;setTooltipInfo.call(this,area,ep,i);}setTooltipPositions.call(this);window.setTimeout(function(){mstrMobileApp.forceRepaint();},0);},destroy:function dst(skipCleanup){$ARR.forEach(this.tooltipArr,function(tooltip){document.body.removeChild(tooltip);});delete this.tooltipArr;if(this._super){this._super(skipCleanup);}}});}());