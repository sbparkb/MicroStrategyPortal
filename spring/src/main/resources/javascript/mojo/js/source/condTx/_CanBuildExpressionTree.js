(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.Obj","mstrmojo.expr","mstrmojo.condTx.CommonComponent");mstrmojo.condTx.Stack=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.condTx.Stack",isVectorCase:false,init:function init(size){this.list=new Array(size||0);this.idx=0;this.containSize=size||0;},pop:function pop(){var item=null;if(this.idx>0){item=this.list[this.idx-1];--this.idx;}else{var sc=this.scriptClass,id=this.id;throw"Stack(class: "+sc+"id: "+id+") is Empty.";}return item;},size:function size(){return this.idx;},top:function top(){return(this.idx>0)?this.list[this.idx-1]:null;},push:function push(item){if(item){var list=this.list;if(this.idx===this.containSize){++this.idx;++this.containSize;list.push(item);}else{list[this.idx]=item;++this.idx;}}},isEmpty:function isEmpty(){return this.idx===0;},destroy:function destroy(){this.list=null;this._super();}});var $FREE=mstrmojo.Obj.free,$CC=mstrmojo.condTx.CommonComponent,$EXPR=mstrmojo.expr,_AOP=$CC.ADV_OPERATION,_ET=$EXPR.ET,$H=mstrmojo.hash;function getOperatonPrecedence(op){var fn=op.fn;switch(fn){case _AOP.PLUS.fn:case _AOP.MINUS.fn:return 1;case _AOP.MULTI.fn:case _AOP.DIVIDE.fn:return 2;case _AOP.UNARYMINUS.fn:return 3;case _AOP.SUM.fn:return 4;default:return -1;}}function _isOperation(item){return item&&item.fn;}function _isRightParenthesis(item){return item&&item.fn&&item.fn===_AOP.RIGHTPARENTHESIS.fn;}function _isLeftParenthesis(item){return item&&item.fn&&item.fn===_AOP.LEFTPARENTHESIS.fn;}function _isParenthesis(item){return _isLeftParenthesis(item)||_isRightParenthesis(item);}function getItemPropertyName(item){if(!item){return"";}if(_isOperation(item)){return"exp";}if(item.t===4){return"m";}if(item.isNumeric){return"cs";}return"tx";}function _isOneNodeOperation(op){return op&&op.fn&&(op.fn===_AOP.SUM.fn||op.fn===_AOP.UNARYMINUS.fn);}function _buildOperationNode(nodeStack,op,isVectorCase){var opns=op.nc||0;for(var i=0;i<opns;i++){var item=nodeStack.pop();if(item){if(!isVectorCase&&item.t===4&&op.fn!==_AOP.SUM.fn){throw"Invalid Expression";}var propName=getItemPropertyName(item);if(i===0&&opns===2){propName+="2";}if(item.isNumeric){op.cs=op.cs?[item].concat(op.cs):[item];}else{op[propName]=("exp"===propName||"exp2"===propName)?{nd:item}:item;}}}nodeStack.push(op);}var validPropertyName=["m","tx","exp","cs"],vpNameLength=validPropertyName.length;function _traversalNodeProperty(node,suffix){if(!!node){var i,child,pName,vpName;for(i=0;i<vpNameLength;++i){vpName=validPropertyName[i];pName=(!!suffix&&vpName!=="cs")?vpName+suffix:vpName;child=node[pName];if(!!child&&vpName!=="cs"){delete node[pName];return(vpName==="exp")?child.nd:child;}else{if(!!child&&child.length>0){if(child.length===1){child=child[0];delete node.cs;}else{child=child.shift();}return child;}}}}return null;}function getLeftChild(node){var child=null;if(_isOperation(node)&&!_isOneNodeOperation(node)){child=_traversalNodeProperty(node);if(!child){throw"Invalid Expression";}}return child;}function getRightChild(node){var child=null;if(_isOperation(node)){child=_traversalNodeProperty(node,(_isOneNodeOperation(node)?"":"2"));if(!child){throw"Invalid Expression";}}return child;}mstrmojo.condTx._CanBuildExpressionTree=mstrmojo.provide("mstrmojo.condTx._CanBuildExpressionTree",{_mixinName:"mstrmojo.condTx._CanBuildExpressionTree",buildExpressionTree:function buildExpressionTree(){var root=null,items=this.items||[],len=items.length;if(len>0){var nodeStack=mstrmojo.insert(mstrmojo.condTx.Stack),opStack=mstrmojo.insert(mstrmojo.condTx.Stack);try{for(var idx=0;idx<len;++idx){var item=items[idx];if(_isOperation(item)){if(!_isParenthesis(item)){while(!opStack.isEmpty()&&getOperatonPrecedence(item)<=getOperatonPrecedence(opStack.top())){_buildOperationNode(nodeStack,opStack.pop(),this.isVectorCase);}opStack.push(item);}else{if(_isLeftParenthesis(item)){opStack.push(item);}else{while(!_isLeftParenthesis(opStack.top())){_buildOperationNode(nodeStack,opStack.pop(),this.isVectorCase);}opStack.pop();}}}else{nodeStack.push(item);}}while(!opStack.isEmpty()){_buildOperationNode(nodeStack,opStack.pop(),this.isVectorCase);}if(nodeStack.size()!==1){throw"Invalid Expression";}root=nodeStack.pop();}catch(ex){throw"Invalid Expression";}finally{$FREE(nodeStack);$FREE(opStack);}}return root;},serializeExpressionTree:function serializeExpressionTree(expTree){var items=[],child,p=$H.clone(expTree&&expTree.nd),nodeStack=mstrmojo.insert(mstrmojo.condTx.Stack);try{while(!!p||!nodeStack.isEmpty()){while(!!p){nodeStack.push(p);child=getLeftChild(p);if(_isOperation(p)&&_isOperation(child)&&getOperatonPrecedence(p)>getOperatonPrecedence(child)){items.push($H.clone(_AOP.LEFTPARENTHESIS));nodeStack.push($H.clone(_AOP.RIGHTPARENTHESIS));}p=child;}if(!nodeStack.isEmpty()){p=nodeStack.pop();items.push(p);if(_isRightParenthesis(p)){p=null;}else{child=getRightChild(p);if(_isOperation(p)&&_isOperation(child)&&getOperatonPrecedence(p)>=getOperatonPrecedence(child)){items.push($H.clone(_AOP.LEFTPARENTHESIS));nodeStack.push($H.clone(_AOP.RIGHTPARENTHESIS));}p=child;}}}}catch(ex){throw"Invalid Expression";}finally{$FREE(nodeStack);}return items;}});}());