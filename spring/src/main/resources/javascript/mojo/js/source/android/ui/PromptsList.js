(function(){mstrmojo.requiresCls("mstrmojo.android.SimpleList","mstrmojo._HasLayout","mstrmojo._SupportsEllipsisText","mstrmojo.date","mstrmojo.string","mstrmojo.num","mstrmojo.hash","mstrmojo.expr","mstrmojo.StringBuffer","mstrmojo.android.ui.ElementsSearchBar","mstrmojo.GeoLocation","mstrmojo.android.ui.Button","mstrmojo.android.ui.TextInput","mstrmojo.ui.MobileSlider","mstrmojo.MobileCalendar","mstrmojo.android.ui.Calendar","mstrmojo.android.ui.ElementsPicker","mstrmojo.android._HasLingeringListSelections","mstrmojo.locales.datetime","mstrmojo.prompt.WebPrompt","mstrmojo.ui.MobileDateTimePicker","mstrmojo.ui.MobileReviewList","mstrmojo.array","mstrmojo.BarcodeReader","mstrmojo.string");mstrmojo.requiresDescs(189,221,1442,6149,8382,8383,8384,8397,8761);var $D=mstrmojo.date,$DESC=mstrmojo.desc,$STYLES=mstrmojo.prompt.WebPrompt.STYLES,$TYPES=mstrmojo.prompt.WebPrompt.TYPES,$NUM=mstrmojo.num,$BTN=mstrmojo.android.ui.Button.newButton,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$TRANS_DURATION=mstrmojo.dom.CSS3_TRANSITION_DURATION,$EXPR=mstrmojo.expr,anchorOffset={160:10,213:10,240:15,320:20};var requiredText="<em>*</em>",iconItemCls="item-icon",choiceMainCls="main-btn",choiceItemCls="item-btn",displayStyleBarCode="Barcode",displayStyleGeo="GeoLocation";var itemMarkupCache={};var stepperDown=' onclick="mstrmojo.all.{@wid}.clickStepper({@idx}, false);"',stepperUp=stepperDown.replace("false","true");function setAnswer(item,idx,vals){try{item.setAnswerValue.apply(item,vals);}catch(e){mstrmojo.alert(e.message||e);return false;}this.updateItem(idx);return true;}function consolidateAnswers(original,toAdd){var hashArray=[],tempArray=[];$ARR.forEach(original,function(item){hashArray[item.v]=item;tempArray.push(item);});$ARR.forEach(toAdd,function(item){if(hashArray[item.v]){return ;}tempArray.push(item);});return tempArray;}function getExistingItems(items,actualReviewItems){var existingItems=[],len=actualReviewItems.length,i=0,j=0,lastMatchPosition=0,itemsLength=items.length;for(i=0;i<itemsLength;i++){for(j=lastMatchPosition;j<len;j++){if(items[i].v===actualReviewItems[j].dssid){existingItems.push(actualReviewItems[j]);lastMatchPosition=j+1;break;}}}return existingItems;}function showReviewList(picker,items,actualReviewItems,displayKeypadView,list,idx,item,isMultiSelect){var callback=this,dialogConfig={title:$DESC(9755,"Prompt Values")},dialogChildren=[],fnOk,fnCancel,dialog,reviewList,fnShowDialog=function(){dialogConfig.children=dialogChildren;fnOk=function(){if(dialog.deleteAction){var index,loopVariant=0,x;var newItems=[].concat(items);for(x in reviewList.selectedIndices){index=parseInt(x,10)-loopVariant++;actualReviewItems.splice(index,1);newItems.splice(index,1);}reviewList.set("items",newItems);items=newItems;reviewList.set("height","auto");dialog.resizeDialog();dialog.setDeleteActions("done");return false;}setAnswer.call(list,item,idx,[consolidateAnswers.call(this,item.answer.items||[],reviewList.items)]);dialog.close();};fnCancel=function(){dialog.close();mstrmojo.BarcodeReader.readBarcodes({attributeID:picker.browseElements.source.did,searchForms:item.prs.LookupForm,multiSelect:isMultiSelect},callback,null,getExistingItems(reviewList.items,actualReviewItems),displayKeypadView);};var dBtn=$BTN($DESC(8473,"Done"),fnOk);dBtn.alias="deleteBtn";dialogConfig.buttons=[$BTN($DESC(221,"Cancel"),fnCancel),dBtn];dialog=mstrApp.showDialog(dialogConfig);dialog.setDeleteActions=function(actionStr){if(actionStr==="delete"){this.selectionHidden=false;this.deleteAction=true;this.titleNode.lastChild.style.display="block";this.btnHbox.deleteBtn.set("text",$DESC(629,"Delete"));mstrmojo.css.removeClass(reviewList.domNode,"hidden");}else{this.selectionHidden=true;this.deleteAction=false;this.titleNode.lastChild.style.display="none";this.btnHbox.deleteBtn.set("text",$DESC(8473,"Done"));}};dialog.updateTitleBarButtonClass=function(clsName){dialog.titleNode.lastChild.className="mstrmojo-Editor-titlebar-button "+clsName;};dialog.createTitleBarButton("mstrmojo-Editor-titlebar-button btnCheckSemi",function(){reviewList.selectAll();});dialog.setDeleteActions("done");return dialog;};reviewList=new mstrmojo.ui.MobileReviewList({controller:this.controller,isElastic:true,multiSelect:true,itemIdField:"v"});dialogConfig.useMenu=false;dialogChildren.push(reviewList);reviewList.set("items",items);fnShowDialog();}function wasBtnClicked(){return(this._clkTarget.className===iconItemCls);}function isIconStyle(item,style,displayStyle){var prs=item.prs;return(item.getStyle()===style||(prs&&prs.DisplayStyle===displayStyle));}function getIconClass(item){if(isIconStyle(item,$STYLES.BARCODE,displayStyleBarCode)||isIconStyle(item,$STYLES.GEO,displayStyleGeo)){return(wasBtnClicked.call(this))?choiceItemCls:choiceMainCls;}return"";}function getAnswerCount(item){if(parseInt(item.promptType,10)===$TYPES.ELEMENTS_PROMPT&&item.answer){return" ("+item.getAnswersCount()+")";}return"";}function ellipsizeItem(node,idx){var item=this.items[idx];if(item.isTtl){return ;}var childNodes=node.firstChild.childNodes,promptName=childNodes[0],promptAnswer=childNodes[1],isRequired=!!item.req,answerCnt=getAnswerCount(item),ellipsisText=this.ellipsisText,innerHTML;if(isRequired){promptName.innerHTML=requiredText+promptName.innerHTML.replace(requiredText,"");}var h3=this.ellipsize("h3",promptName,false);if(isRequired){innerHTML=promptName.innerHTML.replace(requiredText,"");promptName.innerHTML=h3?innerHTML.replace(innerHTML.slice(-1),requiredText+ellipsisText):innerHTML+requiredText;}var h4=this.ellipsize("h4",promptAnswer,true);if(h4&&answerCnt){promptAnswer.innerHTML=mstrmojo.string.trim(promptAnswer.innerHTML.slice(0,-(answerCnt.length+3)))+ellipsisText+answerCnt;}}function getDialogCssClass(cls){var css=["prompts-dialog"];if(mstrApp.isTablet()&&mstrApp.isLandscape()){css.push("prompts-landscape");}if(cls){css.push(cls);}return css.join(" ");}function getDefaultDialogConfig(props){var id=this.id;return $HASH.copy(props,{cssClass:getDialogCssClass(),onClose:function(){var list=mstrmojo.all[id];list.parent.closePrompt();list.clearSelect();}});}function showDialog(config,children,idx,fnOk,hideCancel,viewName){config.children=children;var btns=[];if(!hideCancel){btns.push($BTN($DESC(221,"Cancel")));}if(fnOk){btns.push($BTN($DESC(1442,"OK"),fnOk));}config.buttons=btns;if(mstrApp.isTablet()){config.anchor=this._getItemNode(idx);config.anchorOrientation="h";config.autoClose=true;config.anchorOffset=anchorOffset[mstrMobileApp.getDeviceDPI()];}this.parent.openPrompt(function(){mstrApp.showDialog(config,viewName);});}function selectBarCodePrompt(item,idx){var id=this.id;mstrmojo.BarcodeReader.readBarcodes(null,{success:function(val){if(item.promptType===$TYPES.CONSTANT_PROMPT&&item.dataType===mstrmojo.mstr.EnumDataType.DataTypeBigDecimal){var li=mstrApp.getLocaleInfo();val=val.substr(0,1)+((li&&li.number.DECIMALSEPARATOR)||".")+val.substr(1);}if(!setAnswer.call(mstrmojo.all[id],item,idx,[val])){return false;}},failure:function(ex){item.setError(ex);mstrmojo.all[id].updateItem(idx);}});}function selectTextPrompt(item,idx){var id=this.id,txtId="plTxtInputxz";showDialog.call(this,getDefaultDialogConfig.call(this,{title:item.title}),[{scriptClass:"mstrmojo.android.ui.TextInput",id:txtId,alias:"textInput",textValue:item.getDisplayValue(false,false)||"",onEnter:function(value){if(!setAnswer.call(mstrmojo.all[id],item,idx,[value])){return ;}mstrApp.closeDialog();}}],idx,function(){if(!setAnswer.call(mstrmojo.all[id],item,idx,[mstrmojo.all[txtId].getValue()])){return false;}});}function selectElementPrompt(item,idx){var id=this.id,answerItems=item.answer.items||[],availableAnswers=item.getAvailable(),isBarCode=isIconStyle(item,$STYLES.BARCODE,displayStyleBarCode),isBtn=wasBtnClicked.call(this),prs=item.prs,isMultiSelect=(item.max===""||parseInt(item.max,10)>1)&&prs.DisplayStyle!=="Option button",sr=prs.SearchRequired,searchRequired=sr&&sr!=="0";availableAnswers.concat=true;var fnSetPickerAndShowDialog=function(){var list=mstrmojo.all[id];if(isBarCode&&isBtn){mstrmojo.BarcodeReader.readBarcodes({attributeID:availableAnswers.source.did,searchForms:item.prs.LookupForm,multiSelect:isMultiSelect},{success:function(val){var res=JSON.parse(val),items=availableAnswers.convertElems(res.items);if(res.review){var picker=new mstrmojo.android.ui.ElementsPicker({isElastic:true,itemIdField:"v",multiSelect:true});picker.set("browseElements",availableAnswers);picker.addSelectedItems(items);showReviewList.call(this,picker,items,res.items,res.displayKeypadView,list,idx,item,isMultiSelect);}else{setAnswer.call(list,item,idx,[consolidateAnswers.call(this,answerItems,availableAnswers.convertElems(JSON.parse(val).items))]);}}});}else{var picker=new mstrmojo.android.ui.ElementsPicker({isElastic:true,itemIdField:"v",multiSelect:isMultiSelect});picker.set("browseElements",availableAnswers);picker.addSelectedItems(answerItems);var searchBar=new mstrmojo.android.ui.ElementsSearchBar({slot:"titleNode",target:picker,browseElements:availableAnswers,searchForms:isBarCode?item.prs.LookupForm:undefined,searchRequired:searchRequired,canSearch:item.canSearch(),title:item.title});var fnDisplayPicker=function(){var fnOk;if(isMultiSelect){fnOk=function(){picker.syncSelection();return setAnswer.call(list,item,idx,[picker.getSelectedItems()]);};}else{var mySuper=picker.singleSelect;picker.singleSelect=function(index,suppressEv){mySuper.call(this,index,suppressEv);if(index!=-1&&!suppressEv){setAnswer.call(list,item,idx,[picker.getSelectedItems()]);this.parent.close();return true;}};}showDialog.call(list,getDefaultDialogConfig.call(list,{title:$DESC(6149,"Select Elements"),cssClass:getDialogCssClass("edtElementPicker"),goBack:function(){return searchBar.goBack();}}),[searchBar,picker],idx,fnOk,false);};if(isIconStyle(item,$STYLES.GEO,displayStyleGeo)&&isBtn){item.getGeoTargetValue({success:function(result){var searchTarget=item.searchTarget,searchBox=searchBar.search.box;searchBar.initSearchValue=result;searchBar.canSearch=true;if(searchTarget){searchBar.initSearchValue='in "'+result+'"';searchBar.searchTarget=searchTarget;searchBox.searchValue=result;}fnDisplayPicker();}});}else{fnDisplayPicker();}}};if(availableAnswers.browseConfig){availableAnswers.getItems(1,{success:fnSetPickerAndShowDialog});}else{fnSetPickerAndShowDialog();}}function selectSliderPrompt(item,idx){var config=getDefaultDialogConfig.call(this,{title:item.title,cssClass:getDialogCssClass("edtSlider")}),v=item.getDisplayValue(true,false),valueField=new mstrmojo.Label({text:v,cssClass:"value"}),labelField=new mstrmojo.Label({text:item.mn,cssClass:"title"}),id=this.id;var slider=new mstrmojo.ui.MobileSlider({value:$NUM.parseNumeric(v),max:item.max,min:item.min,interval:item.interval,onvalueChange:function(){valueField.set("text",$NUM.toLocaleString(this.value));},onslidingValueChange:function(){valueField.set("text",$NUM.toLocaleString(this.slidingValue));},onRender:function(){this.parent.attachEventListener("resizeCurtain",this.id,this.resize);}});showDialog.call(this,config,[valueField,labelField,slider],idx,function(){if(!setAnswer.call(mstrmojo.all[id],item,idx,[String(slider.value)])){return false;}});}function selectDateTimePrompt(item,idx,dtp){var config=getDefaultDialogConfig.call(this,{title:item.title}),dateUtil=mstrmojo.date,formats=mstrmojo.locales.datetime,answer=item.answer,min=item.min,max=item.max,timePicker=new mstrmojo.ui.MobileDateTimePicker({value:dateUtil.parseDateAndOrTime(answer||""),min:dateUtil.parseDateAndOrTime(min||""),max:dateUtil.parseDateAndOrTime(max||""),minuteInterval:item.interval,hideSwitchers:dtp==$EXPR.DTP.DATE,dtp:dtp||$EXPR.DTP.TIMESTAMP}),id=this.id;showDialog.call(this,config,[timePicker],idx,function(){var v=timePicker.getDateTime(),dateInfo=v&&v.date,timeInfo=v&&v.time,date=(dateInfo&&dateUtil.formatDateInfo(dateInfo,formats.DATEOUTPUTFORMAT))||"",time=(timeInfo&&dateUtil.formatTimeInfo(timeInfo,formats.TIMEOUTPUTFORMAT))||"",answer=[date+" "+time];if(item.promptType===$TYPES.ELEMENTS_PROMPT){answer=[answer];}if(!setAnswer.call(mstrmojo.all[id],item,idx,answer)){return false;}});}function selectCalenderPrompt(item,idx){var calendar={alias:"calendar"},max=item.max,id=this.id,fnOk,calendarWidget,isSingleSelectPrompt=false,promptsFiltersNode=this.parent.domNode,config=$HASH.copy(getDefaultDialogConfig.call(this,{cssClass:getDialogCssClass()}),{targetListHeight:promptsFiltersNode.clientHeight,targetListWidth:promptsFiltersNode.clientWidth});switch(item.promptType){case $TYPES.CONSTANT_PROMPT:isSingleSelectPrompt=true;break;case $TYPES.ELEMENTS_PROMPT:if(1===parseInt(max,10)){isSingleSelectPrompt=true;break;}config.title=$DESC(8383,"Select Dates");calendar.min=$D.parseDate(item.prs.LocalizedMinDate||"");calendar.max=$D.parseDate(item.prs.LocalizedMaxDate||"");calendar.selectedDates=item.getAnswerAsDateArray();calendar.isMultiSelect=true;fnOk=function(){try{item.setAnswerValue(calendarWidget.getSelectedDates());}catch(e){mstrmojo.alert(e.message||e);return false;}item.syncDateAnswer({success:function(){mstrApp.closeDialog();var list=mstrmojo.all[id];list.updateItem(idx);setAnswer.call(list,item,idx,[calendarWidget.getSelectedDates()]);},failure:function(msg){window.setTimeout(function(){mstrmojo.alert(msg);},0);}});return false;};break;default:throw new Error($DESC(8397,"Error: Unknown prompt type."));}if(isSingleSelectPrompt){selectDateTimePrompt.call(this,item,idx,$EXPR.DTP.DATE);}else{calendarWidget=new mstrmojo.android.ui.Calendar(calendar);showDialog.call(this,config,[calendarWidget],idx,fnOk,false,"CalendarDialog");}}function selectGeoPrompt(item,idx){var id=this.id;mstrmojo.confirm($DESC(8384,'"MicroStrategy" Would Like to use Your Current Location.'),[$BTN($DESC(221,"Cancel")),$BTN($DESC(1442,"OK"),function(){mstrmojo.GeoLocation.getCurrentLocation({success:function(la,lo,al){setAnswer.call(mstrmojo.all[id],item,idx,[la,lo]);},failure:function(ex){item.setError(ex);mstrmojo.all[id].updateItem(idx);}});})]);}function selectSwitchPrompt(item,idx){item.toggleSwitch();this.updateItem(idx);}var promptFnMap={};promptFnMap[$STYLES.BARCODE]=selectBarCodePrompt;promptFnMap[$STYLES.TEXT]=selectTextPrompt;promptFnMap[$STYLES.LIST]=selectElementPrompt;promptFnMap[$STYLES.SLIDER]=selectSliderPrompt;promptFnMap[$STYLES.CALENDAR]=selectCalenderPrompt;promptFnMap[$STYLES.TIME]=selectDateTimePrompt;promptFnMap[$STYLES.GEO]=selectGeoPrompt;promptFnMap[$STYLES.SWITCH]=selectSwitchPrompt;mstrmojo.android.ui.PromptsList=mstrmojo.declare(mstrmojo.android.SimpleList,[mstrmojo._SupportsEllipsisText,mstrmojo.android._HasLingeringListSelections],{scriptClass:"mstrmojo.android.ui.PromptsList",listHooks:{select:function(el,item,idx){var cls=getIconClass.call(this,item);if(cls){mstrmojo.css.addClass(el,cls);}el.style[$TRANS_DURATION]=0;this.setClearHandler(200);},unselect:function(el,item,idx){var cls=getIconClass.call(this,item);if(cls){mstrmojo.css.removeClass(el,cls);}el.style[$TRANS_DURATION]="300ms";}},getItemMarkup:function(item){if(item.isTtl){return'<div class="item {@cls}" idx="{@idx}">{@ttl}</div>';}var style=item.getStyle(),showIcon=isIconStyle(item,$STYLES.GEO,displayStyleGeo)||isIconStyle(item,$STYLES.BARCODE,displayStyleBarCode),cacheKey=style+String(item.req)+(showIcon?"ic":""),markup=itemMarkupCache[cacheKey];if(!markup){var sb=new mstrmojo.StringBuffer();sb.append('<div class="item {@cls}" idx="{@idx}"><div><h3>{@ttl}'+requiredText+"</h3><h4>{@val}</h4>");if(style===$STYLES.STEPPER){sb.append('<div class="step"><div'+stepperDown+"></div><div>{@v}</div><div"+stepperUp+"></div></div>");}else{if(showIcon||style===$STYLES.SWITCH){sb.append('<div class="'+iconItemCls+'"><div></div></div>');}}markup=itemMarkupCache[cacheKey]=sb.toString()+"</div></div>";}return markup;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx);props.ttl=item.title;if(item.isTtl){props.addCls("ttl");return props;}var style=item.getStyle(),isStepperOrSwitch=(style===$STYLES.STEPPER||style===$STYLES.SWITCH),displayValue=item.getDisplayValue(isStepperOrSwitch,isStepperOrSwitch);if(isIconStyle(item,$STYLES.BARCODE,displayStyleBarCode)){props.addCls("bar");}else{if(isIconStyle(item,$STYLES.GEO,displayStyleGeo)){props.addCls("geo");}}props.wid=this.id;props.val=displayValue||"";props.addCls("st"+style);if(item.req){props.addCls("req");}switch(style){case $STYLES.STEPPER:if(!item.canStepUp()){props.addCls("max");}if(!item.canStepDown()){props.addCls("min");}props.v=displayValue;props.val=item.mn||"";break;case $STYLES.SWITCH:props.val=item.mn||"";if(displayValue){props.addCls("on");}break;case $STYLES.GEO:if(!item.displayLoc){item.getDisplayLocation(this,displayValue);}break;}if(props.val){props.addCls("has-ans");}return props;},updateItem:function updateItem(idx){ellipsizeItem.call(this,this._super(idx),idx);},allowTouchBubble:false,onRender:function onRender(){if(this._super){this._super();}var items=this.itemsContainerNode.childNodes,cnt=items.length,i;for(i=0;i<cnt;i++){ellipsizeItem.call(this,items[i],i);}},clickStepper:function clickStepper(idx,isUp){this.items[idx]["step"+(isUp?"Up":"Down")]();this.updateItem(idx);},postselectionChange:function postselectionChange(evt){var added=evt.added;if(!added){return ;}var idx=added[0],item=this.items[idx],style=item.getStyle();if(style===$STYLES.BARCODE&&!wasBtnClicked.call(this)){style=$STYLES.TEXT;}var fnPrompt=promptFnMap[style];if(fnPrompt){fnPrompt.call(this,item,idx);}},rootOrientationChange:function rootOrientationChange(){this.refresh();},touchSelectBegin:function touchSelectBegin(touch){var idx=this.getItemIdxTouch(touch);if(idx>-1){var item=this.items[idx],style=item.getStyle(),msg=[];var description=item.mn||"";if(description){msg.push(description);}if(!(style===$STYLES.SWITCH)&&!(style===$STYLES.STEPPER)){var answer=item.getDisplayValue(false,false);if(answer){msg.push(answer);}}if(item.req){msg.push($DESC(475,"This prompt is required and must be answered."));}if(msg.length){mstrmojo.alert(msg.join("<br /><br />"),null,$DESC(189,"Details"));}return false;}return true;},touchTap:function touchTap(evt){var item=this.items[this.getItemIdxTouch(evt)];if(item&&item.isTtl){return ;}this._clkTarget=evt.target;this._super(evt);}});}());