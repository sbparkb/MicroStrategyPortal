(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.HTMLButton","mstrmojo.Button","mstrmojo.Pulldown","mstrmojo.ui.Pulldown","mstrmojo.CheckBox","mstrmojo.HBox","mstrmojo.Label","mstrmojo.MenuButton","mstrmojo.Table","mstrmojo.string");var $ARR=mstrmojo.array;var _TZ=[{n:"(GMT-12:00)International Date Line West",v:"-12_0"},{n:"(GMT-11:00)Midway Island, Samoa",v:"-11_0"},{n:"(GMT-10:00)Hawaii",v:"-10_0"},{n:"(GMT-09:00)Alaska",v:"-9_1"},{n:"(GMT-08:00)Pacific Time (US & Canada)",v:"-8_1"},{n:"(GMT-07:00)Arizona",v:"-7_0"},{n:"(GMT-07:00)Mountain Time (US & Canada)",v:"-7_1"},{n:"(GMT-06:00)Central America, Saskatchewan",v:"-6_0"},{n:"(GMT-06:00)Central Time (US & Canada), Guadalajara, Mexico city",v:"-6_1"},{n:"(GMT-05:00)Indiana, Bogota, Lima, Quito, Rio Branco",v:"-5_0"},{n:"(GMT-05:00)Eastern time (US & Canada)",v:"-5_1"},{n:"(GMT-04:00)Caracas, La Paz",v:"-4_0"},{n:"(GMT-04:00)Atlantic time (Canada), Manaus, Santiago",v:"-4_1"},{n:"(GMT-03:00)Buenos Aires, Georgetown",v:"-3_0"},{n:"(GMT-03:00)Greenland, Brasilia, Montevideo",v:"-3_1"},{n:"(GMT-02:00)Mid-Atlantic",v:"-2_1"},{n:"(GMT-01:00)Azores, Cape Verde Is.",v:"-1_1"},{n:"(GMT 00:00)Casablanca, Monrovia, Reykjavik",v:"0_0"},{n:"(GMT 00:00)GMT: Dublin, Edinburgh, Lisbon, London",v:"0_1"},{n:"(GMT+01:00)West Central Africa",v:"1_0"},{n:"(GMT+01:00)Amsterdam, Berlin, Rome, Vienna, Prague, Brussels",v:"1_1"},{n:"(GMT+02:00)Harare, Pretoria",v:"2_0"},{n:"(GMT+02:00)Amman, Athens, Istanbul, Beirut, Cairo, Jerusalem",v:"2_1"},{n:"(GMT+03:00)Kuwait, Riyadh, Nairobi, Tbilisi",v:"3_0"},{n:"(GMT+03:00)Baghdad, Moscow, St. Petersburg, Volgograd",v:"3_1"},{n:"(GMT+04:00)Abu Dhadi, Muscat",v:"4_0"},{n:"(GMT+04:00)Baku, Yerevan",v:"4_1"},{n:"(GMT+05:00)Islamabad, Karachi, Tashkent",v:"5_0"},{n:"(GMT+05:00)Ekaterinburg",v:"5_1"},{n:"(GMT+06:00)Astana, Dhaka",v:"6_0"},{n:"(GMT+06:00)Almaty, Nonosibirsk",v:"6_1"},{n:"(GMT+07:00)Bangkok, Hanoi, Jakarta",v:"7_0"},{n:"(GMT+07:00)Krasnoyarsk",v:"7_1"},{n:"(GMT+08:00)Beijing, Hong Kong, Singapore, Taipei",v:"8_0"},{n:"(GMT+08:00)Irkutsk, Ulaan Bataar, Perth",v:"8_1"},{n:"(GMT+09:00)Seoul, Osaka, Sapporo, Tokyo",v:"9_0"},{n:"(GMT+09:00)Yakutsk",v:"9_1"},{n:"(GMT+10:00)Brisbane, Guam, Port Moresby",v:"10_0"},{n:"(GMT+10:00)Canberra, Melbourne, Sydney, Hobart, Vladivostok",v:"10_1"},{n:"(GMT+11:00)Magadan, Solomon Is., New Caledonia",v:"11_0"},{n:"(GMT+12:00)Fiji, Kamchatka, Marshall Is.",v:"12_0"},{n:"(GMT+12:00)Auckland, Wellington",v:"12_1"},{n:"(GMT+13:00)Nuku'alofa",v:"13_0"}];function generateTime(){var t=[],i,n;t.push({n:"12:00AM",v:"12:00AM"});for(i=1;i<=11;i++){n=i+":00AM";t.push({n:n,v:n});}t.push({n:"12:00PM",v:"12:00PM"});for(i=1;i<=11;i++){n=i+":00PM";t.push({n:n,v:n});}return t;}var _DOW=[mstrmojo.desc(9380),mstrmojo.desc(9381),mstrmojo.desc(9382),mstrmojo.desc(9383),mstrmojo.desc(9384),mstrmojo.desc(9385),mstrmojo.desc(9379)];function generateDay(){var d=[],i=0,n;for(;i<7;i++){n=_DOW[i];d.push({n:n,v:i});}return d;}function generateDate(){return[{n:"1st",v:"1"},{n:"15th",v:"15"}];}function getMachineTZ(){var now=new Date(),jan1=new Date(now.getFullYear(),0,1,0,0,0,0),june1=new Date(now.getFullYear(),6,1,0,0,0,0),temp=jan1.toGMTString(),jan2=new Date(temp.substring(0,temp.lastIndexOf(" ")-1));temp=june1.toGMTString();var june2=new Date(temp.substring(0,temp.lastIndexOf(" ")-1)),stdOffset=(jan1-jan2)/(1000*60*60),daylightOffset=(june1-june2)/(1000*60*60),dst=(stdOffset==daylightOffset)?"0":"1";if(stdOffset-daylightOffset>=0){stdOffset=daylightOffset;}return stdOffset+"_"+dst;}function getPreviewText(e,stp,time,tz){var r=mstrmojo.desc(10155)+' <span class="mstrmojo-SREditor-timeHilight">',rebaseTime=function(t,tz){var tn=parseInt(t),dd=0;if(t=="12:00AM"){tn=0;}else{if(t=="12:00PM"){tn=12;}else{if(t.contains("PM")){tn+=12;}}}tn+=parseInt(tz);if(tn>36){t=(tn-36)+":00PM";dd=1;}else{if(tn==36){t="12:00PM";dd=1;}else{if(tn>24&&tn<36){t=(tn-24)+":00AM";dd=1;}else{if(tn==24){t="12:00AM";dd=1;}else{if(tn>12&&tn<24){t=(tn-12)+":00PM";}else{if(tn==12){t="12:00PM";}else{if(tn>0&&tn<12){t=tn+":00AM";}else{if(tn==0){t="12:00AM";}else{if(tn>-12&&tn<0){t=(12+tn)+":00PM";dd=-1;}else{if(tn==-12){t="12:00PM";dd=-1;}else{if(tn>-24&&tn<-12){t=(-12-tn)+":00AM";dd=-1;}}}}}}}}}}}return{t:t,dd:dd};},rbt=rebaseTime(time,tz);switch(stp){case"Daily":r+=mstrmojo.desc(9386,"every day");break;case"Weekday":r+=mstrmojo.desc(9387,"every weekday");break;case"Weekly":r+=mstrmojo.desc(10156)+" "+_DOW[(e.schedules.wday.selectedItem.v+rbt.dd+7)%7];break;case"Monthly":var md=parseInt(e.schedules.mday.selectedItem.v)+rbt.dd,mdStr={"0":"last","1":"1st","2":"2nd","14":"14th","15":"15th","16":"16th"}[md];r+=mstrmojo.desc(9688)+" "+mdStr+" "+mstrmojo.desc(10157);break;}if(tz>0){tz="+"+tz;}tz+=":00";r+=" at "+rbt.t+"</span> "+mstrmojo.desc(10158)+":";return r;}var _MTZ=getMachineTZ(),_TM=generateTime(),_DAY=generateDay(),_DATE=generateDate(),_SCHEDULE={DAILY:"Daily",WEEKDAY:"Weekday",WEEKLY:"Weekly",MONTHLY:"Monthly"};function getPreviewBox(slot,stp){return{slot:slot,scriptClass:"mstrmojo.VBox",cssClass:"mstrmojo-SREditor-tzPrev",bindings:{visible:function(){var estp=this.parent.parent.stp;return estp==stp;}},children:[{scriptClass:"mstrmojo.Label",cssClass:"preview-text",bindings:{text:function(){var e=this.parent.parent.parent,stp=this.parent.parent.parent.stp,time=this.parent.parent.parent.time,day=this.parent.parent.parent.day,date=this.parent.parent.parent.date,tz=this.parent.parent.parent.rrtz||mstrApp.rrtz||_MTZ;return getPreviewText(e,stp,time,parseInt(tz));}}},{alias:"timezone",scriptClass:"mstrmojo.Pulldown",popupCssClass:"timezone-pulldown",items:null,itemIdField:"v",bindings:{value:function(){return this.parent.parent.parent.rrtz||mstrApp.rrtz||_MTZ;}},onvalueChange:function(){this.parent.parent.parent.set("rrtz",this.value);},onRender:function(){var a=this.value;this.set("items",_TZ);this.set("value",a);}}]};}function filterCubes(srcCubeList){return mstrmojo.array.filter(srcCubeList,function(item){return item.isSubscribable;});}mstrmojo.SREditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.SREditor",cssClass:"rrEditor rrEditor-defaultTitleSpacer mstrmojo-SREditor",cssText:"position:absolute;",zIndex:10,title:mstrmojo.desc(10160),cubeID:"",stp:"",day:"",date:"",time:"1:00AM",trgNm:null,showNote:true,subsID:null,obj:null,children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(11245,"Please note that only <# of # dataset> can be scheduled."),cssClass:"rrEditor-cubeType",alias:"sWarning",visible:false,cubes:[],setScheduleWarningText:function(){if(this.parent.obj===null){return ;}this.set("visible",false);var e=this,obj=e.parent.obj,cubes=obj.ds,setText=function(){var supportList=filterCubes(cubes);if(supportList.length!==cubes.length){var srcText=mstrmojo.desc(11245,"Please note that only <# of # dataset> can be scheduled.");srcText=srcText.replace("#",supportList.length).replace("#",cubes.length);srcText=srcText.replace(">","</a>");srcText=srcText.replace("<",'<a href="#" onclick="return false;" style="font-weight: bold;">');e.set("text",srcText);e.set("visible",true);}};if(cubes===undefined||cubes.length===0){var cb={success:function(res){obj.ds=transDatasets(res.ds);cubes=obj.ds;setText();},failure:function(res){rrAlert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mstrmojo.xhr.request("POST",mstrApp.taskURL,cb,{taskId:"getDashboardRefreshHistory",docID:obj.did,recentN:5});}else{setText();}},onclick:function(event){if(event.e.target.tagName==="A"){var datasetList=this.parent.obj.ds,rdID="datasetDetail",_M=mstrmojo.all,datasetDetail=_M[rdID];if(datasetDetail){datasetDetail.set("datasets",datasetList);}else{datasetDetail=new mstrmojo.RRDatasetDetail({datasets:datasetList});}datasetDetail.open();}}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-SREditor-header",bindings:{text:"this.parent.headerText"}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-SREditor-note",text:mstrmojo.desc(11373,"NOTE: All schedules are defined in <Greenwich Mean Time (GMT)>. Once you select a schedule, a preview box displays the equivalent time in your local time zone.").replace(/<(.*?)>/,'<span class="mstrmojo-SREditor-timeHilight">$1</span>'),bindings:{visible:"this.parent.showNote"}},{alias:"schedules",scriptClass:"mstrmojo.Table",cssClass:"mstrmojo-SREditor-scheduleTable",layout:[{cells:[{cssClass:"schedule-type"},{colSpan:2}],cssClass:"mstrmojo-SREditor-rowSpace"},{cells:[{colSpan:3}]},{cells:[{cssClass:"schedule-type"},{colSpan:2}],cssClass:"mstrmojo-SREditor-rowSpace"},{cells:[{colSpan:3}]},{cells:[{cssClass:"schedule-type"},{cssText:"width:143px"},{}],cssClass:"mstrmojo-SREditor-rowSpace"},{cells:[{colSpan:3}]},{cells:[{cssClass:"schedule-type"},{cssText:"width:143px"},{}],cssClass:"mstrmojo-SREditor-rowSpace"},{cells:[{colSpan:3}]},{cells:[{colSpan:3}]}],children:[{alias:"daily",slot:"0,0",scriptClass:"mstrmojo.RadioButton",cssClass:"mstrmojo-SREditor-radio",label:mstrmojo.desc(10639,"Daily"),tp:_SCHEDULE.DAILY,bindings:{checked:function(){var stp=this.parent.parent.stp,tp=this.tp;return stp==tp;}},oncheckedChange:function(){if(this.checked){this.parent.parent.set("stp",this.tp);}}},{alias:"dtime",slot:"0,1",scriptClass:"mstrmojo.ui.Pulldown",hostedCSSClass:"hour-pulldown",popupCssClass:"hour-pulldown",cssText:"width:123px;",items:_TM,bindings:{visible:function(){return this.parent.daily.checked;}},preBuildRendering:function(){var idx=$ARR.find(this.items,this.itemIdField,this.parent.parent.time);if(idx>=0){this.set("selectedIndex",idx);}},itemIdField:"v",postselectedIndexChange:function(evt){var item=this.items[evt.value];this.parent.parent.set("time",item.v);}},getPreviewBox("1,0",_SCHEDULE.DAILY),{alias:"weekday",slot:"2,0",scriptClass:"mstrmojo.RadioButton",cssClass:"mstrmojo-SREditor-radio",label:mstrmojo.desc(10159,"Weekday"),tp:_SCHEDULE.WEEKDAY,bindings:{checked:function(){var stp=this.parent.parent.stp,tp=this.tp;return stp==tp;}},oncheckedChange:function(){if(this.checked){this.parent.parent.set("stp",this.tp);}}},{alias:"wdtime",slot:"2,1",scriptClass:"mstrmojo.ui.Pulldown",popupCssClass:"hour-pulldown",cssText:"width:123px;",items:_TM,bindings:{visible:function(){return this.parent.weekday.checked;}},preBuildRendering:function(){var idx=$ARR.find(this.items,this.itemIdField,this.parent.parent.time);if(idx>=0){this.set("selectedIndex",idx);}},itemIdField:"v",postselectedIndexChange:function(evt){var item=this.items[evt.value];this.parent.parent.set("time",item.v);}},getPreviewBox("3,0",_SCHEDULE.WEEKDAY),{alias:"weekly",slot:"4,0",scriptClass:"mstrmojo.RadioButton",cssClass:"mstrmojo-SREditor-radio",label:mstrmojo.desc(9705,"Weekly"),tp:_SCHEDULE.WEEKLY,bindings:{checked:function(){var stp=this.parent.parent.stp,tp=this.tp;return stp==tp;}},oncheckedChange:function(){if(this.checked){this.parent.parent.set("stp",this.tp);}}},{alias:"wday",slot:"4,1",scriptClass:"mstrmojo.ui.Pulldown",cssText:"width:123px;",items:_DAY,bindings:{visible:"this.parent.weekly.checked"},preBuildRendering:function(){var idx=$ARR.find(this.items,this.itemIdField,this.parent.parent.day);if(idx>=0){this.set("selectedIndex",idx);}},itemIdField:"v",postselectedIndexChange:function(evt){var item=this.items[evt.value];this.parent.parent.set("day",item.v);}},{alias:"wtime",slot:"4,2",scriptClass:"mstrmojo.ui.Pulldown",popupCssClass:"hour-pulldown",cssText:"width:123px;",items:_TM,bindings:{visible:"this.parent.weekly.checked"},preBuildRendering:function(){var idx=$ARR.find(this.items,this.itemIdField,this.parent.parent.time);if(idx>=0){this.set("selectedIndex",idx);}},itemIdField:"v",postselectedIndexChange:function(evt){var item=this.items[evt.value];this.parent.parent.set("time",item.v);}},getPreviewBox("5,0",_SCHEDULE.WEEKLY),{alias:"monthly",slot:"6,0",scriptClass:"mstrmojo.RadioButton",cssClass:"mstrmojo-SREditor-radio",label:mstrmojo.desc(9704,"Monthly"),tp:_SCHEDULE.MONTHLY,bindings:{checked:function(){var stp=this.parent.parent.stp,tp=this.tp;return stp==tp;}},oncheckedChange:function(){if(this.checked){if(this.domNode){this.parent.parent.set("stp",this.tp);}}}},{alias:"mday",slot:"6,1",scriptClass:"mstrmojo.ui.Pulldown",cssText:"width:123px;",items:_DATE,bindings:{visible:"this.parent.monthly.checked"},itemIdField:"v",preBuildRendering:function(){var idx=$ARR.find(this.items,this.itemIdField,this.parent.parent.date);if(idx>=0){this.set("selectedIndex",idx);}},postselectedIndexChange:function(evt){var item=this.items[evt.value];this.parent.parent.set("date",item.v);}},{alias:"mtime",slot:"6,2",scriptClass:"mstrmojo.ui.Pulldown",popupCssClass:"hour-pulldown",cssText:"width:123px;",items:_TM,visible:false,bindings:{visible:"this.parent.monthly.checked"},itemIdField:"v",preBuildRendering:function(){var idx=$ARR.find(this.items,this.itemIdField,this.parent.parent.time);if(idx>=0){this.set("selectedIndex",idx);}},postselectedIndexChange:function(evt){var item=this.items[evt.value];this.parent.parent.set("time",item.v);}},getPreviewBox("7,0",_SCHEDULE.MONTHLY),{alias:"daylightLabel",slot:"8,0",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-DayLightLabel",text:mstrmojo.desc(10163),bindings:{visible:function(){var stp=this.parent.parent.stp;return stp===_SCHEDULE.DAILY||stp===_SCHEDULE.WEEKDAY||stp===_SCHEDULE.WEEKLY||stp===_SCHEDULE.MONTHLY;},}}]},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-buttonBox",slot:"buttonNode",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton ok hot",text:mstrmojo.desc(1442,"OK"),bindings:{enabled:"this.parent.parent.stp"},onclick:function(evt){var rrtz=this.parent.parent.rrtz;if(rrtz&&(rrtz!=mstrApp.rrtz)){if(typeof rrCreateCookie==="function"){rrCreateCookie("rrtz",rrtz);}mstrApp.rrtz=rrtz;}this.parent.parent.onOK();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton cancel",text:mstrmojo.desc(221,"Cancel"),onclick:function(evt){var e=this.parent.parent;if(e.onCancel){e.onCancel();}e.close();}}]}],onOpen:function(){this.sWarning.setScheduleWarningText();var tks=this.trgNm&&mstrmojo.string.trim(this.trgNm.toUpperCase()).split(" ");if(tks&&tks.length>=2){switch(tks[0]){case"DAILY":this.set("stp",_SCHEDULE.DAILY);this.set("time",tks[1]);break;case"WEEKDAY":this.set("stp",_SCHEDULE.WEEKDAY);this.set("time",tks[1]);break;case"WEEKLY":var getDayIndex=function(n){var i=0,sz=_DOW.length;for(;i<sz;i++){if(_DOW[i].toUpperCase()==n){break;}}return i;};this.set("stp",_SCHEDULE.WEEKLY);this.set("day",getDayIndex(tks[1]));this.set("time",tks[2]);break;case"MONTHLY":this.set("stp",_SCHEDULE.MONTHLY);this.set("date",tks[1]);this.set("time",tks[2]);break;default:rrAlert(mstrmojo.desc(10164));this.close();}}},onOK:function(){var e=this,obj=e.obj,dataset=obj.ds,params={taskId:"saveRefreshSchedule",triggerName:this.getTrgName()};var genParam=function(list,name,sep){var ret=[];mstrmojo.array.forEach(list,function(item){ret.push(item[name]);});return ret.join(sep);};var callSaveTask=function(){waitCurtain.open();mstrmojo.xhr.request("POST",mstrApp.taskURL,{success:function(res){e.obj.set("af",res.subs);e.close();},failure:function(res){e.close();if(res.getResponseHeader("X-MSTR-TaskErrorCode")==="-2147050197"){rrAlert(mstrmojo.desc(11605,"In order to set a schedule for automatically refreshing this dashboard please click on the Refresh Now option under Refresh Data menu. Once you have finished refreshing all your datasets, please click on the Set Schedule option again."));}else{rrAlert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},complete:function(){waitCurtain.close();}},params);};if(obj.af&&obj.af.length>0){params.subscriptionID=genParam(obj.af,"subID",",");callSaveTask();}else{if(obj.ds&&obj.ds.length>0){params.contentID=genParam(filterCubes(obj.ds),"cubeID",",");callSaveTask();}else{var cb={success:function(res){obj.ds=transDatasets(res.ds);params.contentID=genParam(filterCubes(obj.ds),"cubeID",",");callSaveTask();},failure:function(res){rrAlert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mstrmojo.xhr.request("POST",mstrApp.taskURL,cb,{taskId:"getDashboardRefreshHistory",docID:obj.did,recentN:1});}}},onClose:function(){var removeParams=new Array(),urlOrig=window.location.href;removeParams[0]="state";removeParams[1]="code";url=removeUrlParams(urlOrig,removeParams);if(urlOrig!=url){window.location.href=url;}},getTrgName:function(){var schs=this.schedules;switch(this.stp){case"Daily":return mstrmojo.desc(10639,"Daily")+" "+schs.dtime.items[schs.dtime.selectedIndex].v;case"Weekday":return mstrmojo.desc(10159,"Weekday")+" "+schs.wdtime.items[schs.wdtime.selectedIndex].v;case"Weekly":return mstrmojo.desc(9310,"Weekly")+" "+schs.wday.items[schs.wday.selectedIndex].n+" "+schs.wtime.items[schs.wtime.selectedIndex].v;case"Monthly":return mstrmojo.desc(9704,"Monthly")+" "+schs.mday.items[schs.mday.selectedIndex].v+" "+schs.mtime.items[schs.mtime.selectedIndex].v;default:return this.stp;}},getTrgDefinition:function(){var schs=this.schedules;switch(this.stp){case"Daily":return this.stp+" "+schs.dtime.selectedIndex;case"Weekday":return this.stp+" "+schs.wdtime.selectedIndex;case"Weekly":return this.stp+" "+schs.wday.selectedIndex+" "+schs.wtime.selectedIndex;case"Monthly":return this.stp+" "+schs.mday.selectedIndex+" "+schs.mtime.selectedIndex;default:return this.stp;}}});})();