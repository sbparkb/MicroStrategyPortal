(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.AndroidVis","mstrmojo.VisChartUtils","mstrmojo.url","mstrmojo.WidgetMatrixManagerForAndroid");var $CSS=mstrmojo.css;function isOwnEmpty(obj){var name;for(name in obj){if(obj.hasOwnProperty(name)){return false;}}return true;}function createSingleXhrCfg(widget,xhrCfgs,i){return{success:function(res){console.log("i: "+i);console.log("server request received success of map index: "+widget.firstSuccessLoadedMapFileIndex);if(!res){return ;}if(i>widget.firstSuccessLoadedMapFileIndex){return ;}var coords=res.coords;if(coords){widget.prepareCoordsName(coords);widget.mapFilePool[widget.requestParams.coordinatesFile]=coords;}widget.drawMultiLayouts(coords);},failure:function(res){console.log("i: "+i);console.log("server request received failed of map index: "+widget.firstSuccessLoadedMapFileIndex);widget.firstSuccessLoadedMapFileIndex+=1;if(widget.firstSuccessLoadedMapFileIndex<widget.totalSubWidgetCount){widget.xhrCfg=xhrCfgs[widget.firstSuccessLoadedMapFileIndex];widget.requestParams.coordinatesFile=widget.getMapFilePath(widget.firstSuccessLoadedMapFileIndex);mstrApp.serverRequest(widget.requestParams,widget.xhrCfg,widget.requestConfig);console.log("server request send of map index: "+widget.firstSuccessLoadedMapFileIndex);}else{widget.aspectRatio=1;widget.drawMultiLayoutsWithAspectRatio();}}};}function createXhrCfgs(widget){var xhrCfgs=[],N=widget.totalSubWidgetCount,i;for(i=0;i<N;i++){xhrCfgs.push(null);}for(i=0;i<N;i++){xhrCfgs[i]=createSingleXhrCfg(widget,xhrCfgs,i);}return xhrCfgs;}mstrmojo.AndroidBaseMultipleImageLayoutPrototype=mstrmojo.declare(mstrmojo.AndroidVis,[],{scriptClass:"AndroidBaseMultipleImageLayoutPrototype",utils:mstrmojo.VisChartUtils,model:null,modelData:null,CONSTANTS:{MIN_WIDTH_OR_HEIGHT:150,MIN_DRAWING_INTERVAL:40,CHART_BORDER_WIDTH:1,SUB_TITLE_HEIGHT:25,SCROLL_BAR_WIDTH_HEIGHT:15,SCROLL_BAR_STATUS:{NONE:0,VERTICAL:1,HORIZONTAL:2,BOTH:4},DISPLAY_MODE:{AUTOMATIC:"0",AREA:"1",BUBBLE:"2"},MARKER_TYPE:{UNDEFINED:0,IMAGE:1,BUBBLE:2},MAX_IMAGE_ICON_SIZE:{HEIGHT:40,WIDTH:32},SHAPE_FILE_TYPE:{UNDEFINED:0,POLYGON:1,POINT:2},DEBUG:{PERFORMANCE:false,LOG:false,TOUCH_WHILE_LOADING:false},THRESHOLD_TYPE:{UNDEFINED:0,COLOR:1,IMAGE:2},SIZE_MODE:{AUTOMATIC:"0",MANUAL:"1"},MAX_RATIO_LIMIT:{UP_LIMIT:1,LOW_LIMIT:0.01},MAX_SIZE_DEFAULT_RATIO:{SCATTER:0.3,AUTOMATIC:0.3,MANUAL:0.3},THEME:{DARK:0,LIGHT:1},DEFAULT_BG_COLOR:"#FFFFFF",ACTION_TYPE:{DRILLING:1,SELECTOR:2,HYPERLINK:4},POLYGON_COLOR:{NO_ALT_DARK_THEME:"RGBA(139,139,139,0.8)",NO_COLORBY_DARK_THEME:"RGBA(33,195,255,0.8)",NO_ALT_LIGHT_THEME:"RGBA(195,195,195,0.8)",NO_COLORBY_LIGHT_THEME:"RGBA(112,168,207,0.8)",STROKE_COLOR_DARK_THEME:"#4C4C4C",STROKE_COLOR_LIGHT_THEME:"#FFFFFF",STROKE_COLOR_HOVER_DARK_THEME:"#FFFFFF",STROKE_COLOR_HOVER_LIGHT_THEME:"#000000",STROKE_COLOR_LINKDRILL_DARK_THEME:"#FFFFFF",STROKE_COLOR_LINKDRILL_LIGHT_THEME:"#000000",STROKE_COLOR_SELECTED_DARK_THEME:"#FFFFFF",STROKE_COLOR_SELECTED_LIGHT_THEME:"#000000",STROKE_COLOR_SELECTED_HOVER_DARK_THEME:"RGBA(0,0,0,0)",STROKE_COLOR_SELECTED_HOVER_LIGHT_THEME:"RGBA(0,0,0,0)"},POLYGON_OPACITY:{NORMAL:0.8,ABOVE_BG:0.7,UNDER_BUBBLE:1,HOVER:0.5,LINKDRILL:0.5,SELECTED_WITHOUT_BG:1,SELECTED_WITH_BG:0.7,UNSELECTED:0.5,SELECTED_HOVER_WITH_BG:0.7,SELECTED_HOVER_WITHOUT_BG:1},BUBBLE_COLOR:{NO_COLORBY_DARK_THEME:"RGBA(33,195,255,0.8)",NO_COLORBY_LIGHT_THEME:"RGBA(31,119,180,0.8)",STROKE_COLOR_DARK_THEME:"RGBA(129,129,129,0.8)",STROKE_COLOR_LIGHT_THEME:"RGBA(129,129,129,0.8)",STROKE_COLOR_HOVER_DARK_THEME:"RGBA(129,129,129,0.8)",STROKE_COLOR_HOVER_LIGHT_THEME:"RGBA(129,129,129,0.8)",STROKE_COLOR_LINKDRILL_DARK_THEME:"RGBA(129,129,129,0.8)",STROKE_COLOR_LINKDRILL_LIGHT_THEME:"RGBA(129,129,129,0.8)",STROKE_COLOR_SELECTED_DARK_THEME:"RGBA(255,255,255,0.8)",STROKE_COLOR_SELECTED_LIGHT_THEME:"RGBA(0,0,0,0.8)",HIGHLIGHT_STROKE_COLOR_DARK_THEME:"#FFFFFF",HIGHLIGHT_STROKE_COLOR_LIGHT_THEME:"#000000"},BUBBLE_OPACITY:{NORMAL:0.8,HOVER:0.5,SELECTED:1,LINKDRILL:0.8},ERROR_MSG_FONT_COLOR:{DARK_THEME:"#FFF",LIGHT_THEME:"#000"},AXIS:{ROW_AXIS:1,COL_AXIS:2},DP_IN_VP:{SIZE_BY:"SizeBy",COLOR_BY:"ColorBy",TOOLTIP:"Tooltip",GEO_ATTRIBUTE:"ga",LAYOUT_ATTRIBUTE:"PathToMap"},RENDERING_TIME:300},bgColor:"#FFFFFF",themeMode:0,miniCharts:null,attrFormIndices:null,aspectRatio:1,finalRowCnt:1,finalColCnt:1,miniChartCount:1,cellWidth:150,cellHeight:150,hasMultiAttr:false,layoutAttrIndex:-1,layoutAttrFormCount:0,shapeFileFormIndex:-1,subTitleFormIndex:-1,areaBubbleAttrIndex:-1,areaBubbleAttrFormCount:0,firstSuccessLoadedMapFileIndex:0,sbwh:0,currSelectedObj:null,currSelectedObjMiniChart:null,currSelectedObjBackup:null,currLinkObj:null,currLinkObjMiniChart:null,currHoverObj:null,currHoverObjMiniChart:null,touchedMiniChart:null,defaultSelectedObjs:null,realtimeInfowindowOn:false,tooltipOn:false,serverRequestPool:null,mapFilePool:null,mapLineScopes:null,hoverBubbleRadiusLarger:5,bubbleStrokeWidth:2,baseMaxBubbleSizeAuto:12,baseMaxBubbleSizeManual:24,polygonStrokeWidth:1,highlightPolygonStrokeWidth:2,borderSpace:5,tooltipFontSize:12,tooltipBorderWidth:1,tooltipBorderRadius:5,errMsgFontSize:16,loadingIndicatorFontSize:24,loadingIndicatorDivHeight:40,loadingIndicatorDivWidth:120,bias:30,tooltipRightShadowWidth:4,subTitleHeight:25,subTitleFontSize:11,subTitlePadding:5,serverRequestCount:0,showLoadingIndicatorFlag:false,scrollBarStatus:0,hasIfwTarget:undefined,hasNonifwTarget:undefined,hasAdjustedOffsets:false,init:function init(props){this.miniCharts={};this.mapFilePool={};this.serverRequestPool=[];this.mapLineScopes=[];this.attrFormIndices=[];this.modelData={};this.currSelectedObj=null;this.defaultSelectedObjs={};this.currHoverObj=null;this.currLinkObj=null;this.currSelectedObjBackup=null;this.currHoverObjMiniChart=null;this.currSelectedObjMiniChart=null;this.currLinkObjMiniChart=null;this.touchedMiniChart=null;if(this._super){this._super(props);}},getMapFilePath:function getMapFilePath(mapFileIndex){var defString="";var pathString=this.getLayoutAttrElemString(mapFileIndex,this.shapeFileFormIndex,defString);if(!!pathString&&pathString.charAt(0)!="/"){pathString="/"+pathString;}return pathString;},initParas:function(){var me=this;me.themeMode=0;me.mapLineScopes=[];me.attrFormIndices=[];me.aspectRatio=1;me.finalRowCnt=1;me.finalColCnt=1;me.miniChartCount=1;me.cellWidth=150;me.cellHeight=150;me.hasMultiAttr=false;me.layoutAttrIndex=-1;me.layoutAttrFormCount=0;me.shapeFileFormIndex=-1;me.subTitleFormIndex=-1;me.areaBubbleAttrIndex=-1;me.areaBubbleAttrFormCount=0;me.subTitleHeight=me.CONSTANTS.SUB_TITLE_HEIGHT;me.subTitleFontSize=11;me.subTitlePadding=5;me.serverRequestCount=0;me.showLoadingIndicatorFlag=false;me.scrollBarStatus=0;me.hasIfwTarget=undefined;me.hasNonifwTarget=undefined;this.hasAdjustedOffsets=false;me.currSelectedObjMiniChart=null;},preBuildRendering:function(){this.initParas();if(this._super){this._super();}},postBuildRendering:function postBR(){console.log("AndroidBaseMultipleImageLayoutPrototype render");var me=this;if(this._super){this._super();}me.setModelData();me.setBgColorTheme();if(me.modelData.hasOwnProperty("eg")){var errorMessage=me.modelData.eg,wrongTemplateStr="The Image Layout requires:";if(errorMessage.match(wrongTemplateStr)){var string1=window.getLocaleString?window.getLocaleString("IMAGELAYOUT_INVALID_DATESET_FORMAT1","The Image Layout requires:"):"",string2=window.getLocaleString?window.getLocaleString("IMAGELAYOUT_INVALID_DATESET_FORMAT1","-at least one attribute on the row axis"):"",string3=window.getLocaleString?window.getLocaleString("IMAGELAYOUT_INVALID_DATESET_FORMAT3","-all metrics to be placed on the column axis."):"";var localeString=(string1===""||string2===""||string3==="")?mstrmojo.desc(9853,errorMessage):(string1+"\n"+string2+"\n"+string3);me.renderErrorMessage(localeString);}else{me.renderErrorMessage(errorMessage);}mstrMobileTransport.onRenderComplete();return ;}me.setWidgetParas();me.layoutSubwidgets();me.attachListeners();},adjustOffsets:function(){if(!this.hasAdjustedOffsets){this.hasAdjustedOffsets=true;this.adjustWidgetOffsets();}},setModelData:function(){this.modelData=this.model;if(this.model.data){this.modelData=this.model.data;}this.model=this.xtabModel;},getThemeMode:function getThemeMode(color){if(this.utils.isLightColor(color)){return this.CONSTANTS.THEME.LIGHT;}return this.CONSTANTS.THEME.DARK;},getWebServerUrl:function getWebServerUrl(isTablet){var webServerUrl=null;if(isTablet){if(mstrApp!==undefined&&mstrApp.getConfiguration){webServerUrl=mstrApp.getConfiguration().getCurrentProjectWebServerUrl();}}else{var href=document.location&&document.location.href;if(href){var hrefLowerCase=href.toLowerCase();var servletReg="/servlet/",aspReg="/asp/";var servletIndex=hrefLowerCase.indexOf(servletReg),aspIndex=hrefLowerCase.indexOf(aspReg);if(servletIndex>=0){if(aspIndex<0){webServerUrl=href.substr(0,servletIndex+1);}else{if(aspIndex>=0){var index=(servletIndex>aspIndex)?aspIndex:servletIndex;webServerUrl=href.substr(0,index+1);}}}else{if(servletIndex<0){if(aspIndex>=0){webServerUrl=href.substr(0,aspIndex+1);}else{if(aspIndex<0){}}}}}}return webServerUrl;},getFullPath:function getFullPath(path){var fullPath="";var reg=/^[A-z]:\/\//;if(reg.test(path)){fullPath=path;}else{var tempReg1=/^(..\/|..\\)/;var tempReg2=/^(.\/|.\\)/;var tempReg3=/^(\/|\\)/;path=path.replace(tempReg1,"");path=path.replace(tempReg2,"");path=path.replace(tempReg3,"");if(mstrApp!==undefined&&mstrApp.getConfiguration){fullPath=mstrmojo.url.getAbsoluteURL(path,this.getWebServerUrl(this.isTablet));}}return fullPath;},setLoadingIndicatorFormat:function setLoadingIndicatorFormat(){var me=this,indicator=me.loadingIndicator,indicatorStyle=indicator.style,indicatorTextDiv=me.loadingIndicatorTextDiv;var wh=me.getHeight(),ww=me.getWidth();var th=me.loadingIndicatorDivHeight,tw=me.loadingIndicatorDivWidth;var padding=0;if(ww<tw){indicatorTextDiv.style.width=ww+"px";}else{if(ww>=tw){padding=Math.floor((ww-tw)/2);indicatorStyle.paddingLeft=padding+"px";indicatorStyle.paddingRight=padding+"px";}}if(wh>th){padding=Math.floor((wh-th)/2);indicatorStyle.paddingTop=padding+"px";indicatorStyle.paddingBottom=padding+"px";}},renderErrorMessage:function renderErrorMessage(errorMessage){var me=this,msgDiv=me.errorMessage,newErrorMessage=errorMessage.replace(/-/g,"<br />-");msgDiv.innerHTML=newErrorMessage;msgDiv.style.width=me.getWidth()+"px";msgDiv.style.fontSize=me.errMsgFontSize+"px";msgDiv.style.fontFamily="Tahoma";msgDiv.style.backgroundColor="RGBA(0,0,0,0)";msgDiv.style.color=me.CONSTANTS.ERROR_MSG_FONT_COLOR.DARK_THEME;if(me.themeMode===me.CONSTANTS.THEME.LIGHT){msgDiv.style.color=me.CONSTANTS.ERROR_MSG_FONT_COLOR.LIGHT_THEME;}msgDiv.style.display="block";},attachListeners:function attachListeners(){var me=this,manager=me.manager;if(manager){this.chartResizeListener=manager.attachEventListener("MiniChartResized",this.id,function(evt){this.miniChartResizedCallback(evt);});}var xtabModel=me.xtabModel,docModel=(xtabModel&&xtabModel.docModel);if(docModel){me.docModelListener=me.xtabModel.docModel.attachEventListener("infoWindowClosed",this.id,function(evt){me.realtimeInfowindowOn=false;if(!me.hasNonifwTarget&&me.currSelectedObj){window.setTimeout(function(){me.currSelectedObj=null;me.currSelectedObjMiniChart=null;me.highlightMiniCharts();},10);}});}},isTouchedOnWidget:function isTouchedOnWidget(touch){if(!touch){return false;}var me=this,touchPointOnWidget=me.utils.getTouchXYOnWidget(touch.pageX,touch.pageY,me),x=touchPointOnWidget.touchX,y=touchPointOnWidget.touchY;if(x>0&&x<me.getWidth()&&y>0&&y<me.getHeight()){return true;}return false;},miniChartResizedCallback:function mrcb(evt){var me=this;if(me.imageLayoutTable&&me.imageLayoutTable.updateScrollerConfig){me.imageLayoutTable.updateScrollerConfig();}},getDefaultSelectedObjs:function getDefaultSelectedObjs(){var me=this,modelData=me.modelData,idxs=modelData&&modelData.ghs&&modelData.ghs.rhs&&modelData.ghs.rhs.items,gts_rows=modelData&&modelData.gts&&modelData.gts.row,attrFormIndices=me.attrFormIndices,areaBubbleAttrIndex=me.areaBubbleAttrIndex,itemIndex=0,i,name,idx,item;if(areaBubbleAttrIndex<attrFormIndices.length){itemIndex=attrFormIndices[areaBubbleAttrIndex][0];}me.defaultSelectedObjs={};if(idxs&&gts_rows&&gts_rows.length>0){for(i in idxs){if(idxs.hasOwnProperty(i)){item=idxs[i].items[itemIndex];if(item&&item.hasOwnProperty("cet")){idx=item.idx;name=gts_rows[areaBubbleAttrIndex].es[idx].n;if(!(me.defaultSelectedObjs.hasOwnProperty(i))){me.defaultSelectedObjs[i]={nodeName:name,headerIndex:idx};}}}}}},createTooltipTable:function createTooltipTable(){var me=this,modelData=me.modelData,table=me.imageLayoutTable&&me.imageLayoutTable.tooltip&&me.imageLayoutTable.tooltip.childNodes[0],rows=modelData&&modelData.gts&&modelData.gts.row,cols=modelData&&modelData.gts&&modelData.gts.col&&modelData.gts.col[0]&&modelData.gts.col[0].es,i;if(table&&table.childNodes.length===0&&rows&&rows.length>0){var trNum=rows.length+(cols?cols.length:0);for(i=0;i<trNum;i++){var tr=document.createElement("tr");var tdLeft=document.createElement("td");tdLeft.align="right";tdLeft.style.color="#545462";tr.appendChild(tdLeft);var tdRight=document.createElement("td");tdRight.align="left";tdRight.style.color="#000000";tr.appendChild(tdRight);table.appendChild(tr);}}},setBgColorTheme:function setBgColorTheme(){var me=this;var bgColor=me.CONSTANTS.DEFAULT_BG_COLOR;if(me.modelData.vp&&me.modelData.vp.bc&&me.modelData.vp.bc!==""){bgColor="#"+me.modelData.vp.bc;}else{bgColor=me.utils.getAncestorBgColor(me)||me.CONSTANTS.DEFAULT_BG_COLOR;}me.domNode.style.backgroundColor=bgColor;me.themeMode=me.getThemeMode(bgColor);me.bgColor=bgColor;if(me.themeMode===me.CONSTANTS.THEME.DARK){$CSS.addClass(this.domNode,["mil-dark"]);}else{if(me.themeMode===me.CONSTANTS.THEME.LIGHT){$CSS.addClass(this.domNode,["mil-light"]);}}},initImageLayoutTable:function initImageLayoutTable(props){var me=this;if(1){me.imageLayoutTable=me.createWidgetMatrix(props);me.imageLayoutTable.API.createUnitChart=me.createUnitChart;me.imageLayoutTable.API.handleDroppedChart=me.handleDroppedChart;me.imageLayoutTable.API.updateUnitChart=me.updateUnitChart;me.imageLayoutTable.API.lassoSelected=me.lassoSelected;me.imageLayoutTable.render();me.imageLayoutTable.manager.setDimensions(props.nRows,props.nCols,props.chartW,props.chartH);me.imageLayoutTable.manager.master=me.imageLayoutTable;me.imageLayoutTable.manager.binding();me.imageLayoutTable.parent=me;me.manager.drawCharts();if(me.imageLayoutTable.getMapsAndDraw){me.imageLayoutTable.getMapsAndDraw();}me.imageLayoutTable.domCanvas.style.backgroundColor="rgba(0,0,0,0)";}else{var i;for(i in props){if(props.hasOwnProperty(i)){me.imageLayoutTable[i]=props[i];}}me.imageLayoutTable.refresh();me.imageLayoutTable.manager.drawCharts();if(me.imageLayoutTable.getMapsAndDraw){me.imageLayoutTable.getMapsAndDraw();}me.imageLayoutTable.domCanvas.style.backgroundColor="rgba(0,0,0,0)";}},layoutSubwidgets:function layoutSubwidgets(){var me=this;if(!me.manager){me.manager=new mstrmojo.WidgetMatrixManagerForAndroid();}if(me.hasMultiAttr){if(mstrApp!==undefined&&mstrApp.serverRequest){me.xhrCfgs=createXhrCfgs(me);me.xhrCfg=me.xhrCfgs[0];me.firstSuccessLoadedMapFileIndex=0;me.requestParams={taskId:"getMapCoordinates",coordinatesFile:me.getMapFilePath(me.firstSuccessLoadedMapFileIndex)};me.requestConfig={src:"postBuildRendering",noErrorMessage:true,showProgress:false,hideProgress:false,progressStateText:["Loading Map File for Aspect Ratio"],silent:true};var coords=me.mapFilePool[me.requestParams.coordinatesFile];if(coords){me.drawMultiLayouts(coords);}else{mstrApp.serverRequest(me.requestParams,me.xhrCfg,me.requestConfig);console.log("server request send of map index: "+me.firstSuccessLoadedMapFileIndex);}}}else{me.finalRowCnt=1;me.finalColCnt=1;me.cellWidth=me.getWidth();me.cellHeight=me.getHeight();me.resizeCellFromStoration();var props=me.createPropsForImageLayoutTable();me.initImageLayoutTable(props);}},showLoadingIndicator:function showLoadingIndicator(){var me=this;if(me.showLoadingIndicatorFlag){if(me.serverRequestCount===0){me.loadingIndicator.style.display="block";}me.serverRequestCount+=1;}},hideLoadingIndicator:function hideLoadingIndicator(){var me=this;if(me.showLoadingIndicatorFlag){me.serverRequestCount-=1;if(me.serverRequestCount===0){me.loadingIndicator.style.display="none";}}},createPlaceholder:function(){var ph,nodes=this.domNode.childNodes,oriDomLength=this.oriDomLength;if(nodes&&nodes.length>oriDomLength){var node=nodes[nodes.length-1];this.domNode.removeChild(node);}ph=document.createElement("div");this.domNode.appendChild(ph);return ph;},drawMultiLayouts:function drawMultiLayouts(coords){if(!coords){return ;}var me=this;var bgImgPath=coords.bgImage;if(0){if(me.bgImg){me.aspectRatio=(me.bgImg.height)/me.bgImg.width;me.drawMultiLayoutsWithAspectRatio();}else{me.bgImg=new Image();me.bgImg.onload=function(){me.aspectRatio=(this.height)/this.width;me.drawMultiLayoutsWithAspectRatio();};me.bgImg.onerror=function(){me.getAspectRatioFromPolygon(coords);me.drawMultiLayoutsWithAspectRatio();};me.bgImg.src=me.getFullPath(bgImgPath);}}else{me.getAspectRatioFromPolygon(coords);me.drawMultiLayoutsWithAspectRatio();}},drawMultiLayoutsWithAspectRatio:function drawMultiLayoutsWithAspectRatio(){var me=this;me.getLayoutParasWithAspectRatio();var props=me.createPropsForImageLayoutTable();me.initImageLayoutTable(props);},getLayoutParasWithAspectRatio:function getLayoutParasWIthAspectRatio(){var me=this,aspectRatio=me.aspectRatio;var w=me.getWidth(),h=me.getHeight(),subTitleHeight=me.subTitleHeight,minWH=Math.min(w,h-subTitleHeight,me.CONSTANTS.MIN_WIDTH_OR_HEIGHT);var maxCols=1,maxRows=1;if(aspectRatio>=1){maxCols=Math.floor(w/minWH);maxRows=Math.floor(h/(minWH*aspectRatio+subTitleHeight));}else{if(aspectRatio<1){maxCols=Math.floor(w/(minWH/aspectRatio));maxRows=Math.floor(h/(minWH+subTitleHeight));}}var maxN=maxCols*maxRows;var N=me.totalSubWidgetCount;me.miniChartCount=N;if(N>0&&N>maxN){me.scrollBarStatus=me.CONSTANTS.SCROLL_BAR_STATUS.VERTICAL;var sbwh=me.sbwh;if(aspectRatio>=1){maxCols=Math.floor((w-sbwh)/minWH);}else{if(aspectRatio<1){maxCols=Math.floor((w-sbwh)/(minWH/aspectRatio));}}maxCols=(maxCols===0)?1:maxCols;me.finalColCnt=maxCols;me.finalRowCnt=Math.ceil(N/maxCols);me.cellWidth=Math.floor((w-sbwh)/maxCols);me.cellHeight=Math.round(me.cellWidth*aspectRatio+subTitleHeight);}else{if(N>0&&N<=maxN){me.scrollBarStatus=me.CONSTANTS.SCROLL_BAR_STATUS.NONE;me.getLayoutParasByMinimizingEmptySpace(w,h,maxCols,maxRows,N,aspectRatio,subTitleHeight);if(me.finalRowCnt===1){me.cellWidth=Math.floor(w/me.finalColCnt);}if(me.finalColCnt===1){me.cellHeight=Math.floor(h/me.finalRowCnt);}}else{}}me.resizeCellFromStoration();},resizeCellFromStoration:function(){var me=this,modelData=me.modelData,vp=modelData.vp,hrStr=vp&&vp.hr,vrStr=vp&&vp.vr;if(hrStr){var hr=parseFloat(hrStr,10);this.cellWidth*=hr;}if(vrStr){var vr=parseFloat(vrStr,10);this.cellHeight*=vr;}},getLayoutParasByMinimizingEmptySpace:function getLayoutParasByMinimizingEmptySpace(w,h,maxCols,maxRows,N,aspectRatio,subTitleHeight){var me=this;var realMaxRows=Math.min(maxRows,N);var nR,nC;var finalColCnt=1,finalRowCnt=1,cellWidth=w,cellHeight=h;var emptySpace=Number.MAX_VALUE;for(nR=1;nR<=realMaxRows;nR++){nC=Math.ceil(N/nR);if(nC>maxCols){continue;}var tempEmptySpace=me.getEmptySpace(w,h,nC,nR,N,aspectRatio,subTitleHeight);if(emptySpace>tempEmptySpace){emptySpace=tempEmptySpace;me.finalColCnt=nC;me.finalRowCnt=nR;me.cellWidth=Math.floor(w/nC);me.cellHeight=Math.floor(h/nR);}}},getEmptySpace:function getEmptySpace(w,h,nC,nR,N,aspectRatio,subTitleHeight){var widgetWidth=this.CONSTANTS.MIN_WIDTH_OR_HEIGHT,widgetHeight=this.CONSTANTS.MIN_WIDTH_OR_HEIGHT;var cellWidth=w/nC,cellHeight=h/nR,mapHeight=cellHeight-subTitleHeight,cellRatio=mapHeight/cellWidth;var paddingSpaceInOneCell=0;if(cellRatio>aspectRatio){paddingSpaceInOneCell=cellWidth*(mapHeight-cellWidth*aspectRatio);}else{paddingSpaceInOneCell=mapHeight*(cellWidth-mapHeight/aspectRatio);}return w*h-N*(cellWidth*cellHeight-paddingSpaceInOneCell);},prepareDataForSubWidget:function prepareDataForSubWidget(){var areaBubbleAttrElems={},me=this,modelData=me.modelData,attrFormIndices=me.attrFormIndices,layoutAttrIndex=me.layoutAttrIndex,areaBubbleAttrIndex=me.areaBubbleAttrIndex,rhsItems=modelData&&modelData.ghs&&modelData.ghs.rhs&&modelData.ghs.rhs.items,gtsRows=modelData&&modelData.gts&&modelData.gts.row,allAreaBubbleAttrElems=gtsRows&&gtsRows.length>areaBubbleAttrIndex&&gtsRows[areaBubbleAttrIndex].es,areaBubbleAttrFirstFormIndexIdx,areaBubbleAttrFirstFormName,i,mapLineScopes=me.mapLineScopes,mapLineScope,preLayoutAttrFirstFormIndexIdx,curLayoutAttrFirstFormIndexIdx;if(layoutAttrIndex>-1&&areaBubbleAttrIndex>-1){var layoutAttrFormIndices=attrFormIndices.length>layoutAttrIndex&&attrFormIndices[layoutAttrIndex];var areaBubbleAttrFormIndices=attrFormIndices.length>areaBubbleAttrIndex&&attrFormIndices[areaBubbleAttrIndex];if(layoutAttrFormIndices&&areaBubbleAttrFormIndices){var layoutAttrFirstFormIndex=layoutAttrFormIndices[0],areaBubbleAttrFirstFormIndex=areaBubbleAttrFormIndices[0];if(rhsItems&&rhsItems.length>0&&allAreaBubbleAttrElems){mapLineScope={startLine:0,endLine:0,areaBubbleAttrElems:null};areaBubbleAttrFirstFormIndexIdx=(rhsItems[0].items&&rhsItems[0].items.length>areaBubbleAttrFirstFormIndex)?rhsItems[0].items[areaBubbleAttrFirstFormIndex].idx:-1;areaBubbleAttrFirstFormName=(allAreaBubbleAttrElems.length>areaBubbleAttrFirstFormIndexIdx)?allAreaBubbleAttrElems[areaBubbleAttrFirstFormIndexIdx].n:null;if(areaBubbleAttrFirstFormName!==undefined&&areaBubbleAttrFirstFormIndexIdx>-1){areaBubbleAttrElems[areaBubbleAttrFirstFormName.toLowerCase()]={headerIndex:areaBubbleAttrFirstFormIndexIdx,lineIndex:0};}var firstLineItems=rhsItems[0].items;preLayoutAttrFirstFormIndexIdx=firstLineItems&&firstLineItems.length>layoutAttrFirstFormIndex&&firstLineItems[layoutAttrFirstFormIndex].idx;for(i=1;i<rhsItems.length;i++){var lineItems=rhsItems[i].items;curLayoutAttrFirstFormIndexIdx=lineItems[layoutAttrFirstFormIndex].idx;if(preLayoutAttrFirstFormIndexIdx===curLayoutAttrFirstFormIndexIdx){mapLineScope.endLine=i;areaBubbleAttrFirstFormIndexIdx=(rhsItems[i].items&&rhsItems[i].items.length>areaBubbleAttrFirstFormIndex)?rhsItems[i].items[areaBubbleAttrFirstFormIndex].idx:-1;areaBubbleAttrFirstFormName=(allAreaBubbleAttrElems.length>areaBubbleAttrFirstFormIndexIdx)?allAreaBubbleAttrElems[areaBubbleAttrFirstFormIndexIdx].n:null;if(areaBubbleAttrFirstFormName!==undefined&&areaBubbleAttrFirstFormIndexIdx>-1){areaBubbleAttrElems[areaBubbleAttrFirstFormName.toLowerCase()]={headerIndex:areaBubbleAttrFirstFormIndexIdx,lineIndex:i};}}else{preLayoutAttrFirstFormIndexIdx=curLayoutAttrFirstFormIndexIdx;mapLineScope.areaBubbleAttrElems=areaBubbleAttrElems;mapLineScopes.push(mapLineScope);mapLineScope={startLine:i,endLine:i,areaBubbleAttrElems:null};areaBubbleAttrElems={};areaBubbleAttrFirstFormIndexIdx=(rhsItems[i].items&&rhsItems[i].items.length>areaBubbleAttrFirstFormIndex)?rhsItems[i].items[areaBubbleAttrFirstFormIndex].idx:-1;areaBubbleAttrFirstFormName=(allAreaBubbleAttrElems.length>areaBubbleAttrFirstFormIndexIdx)?allAreaBubbleAttrElems[areaBubbleAttrFirstFormIndexIdx].n:null;if(areaBubbleAttrFirstFormName!==undefined&&areaBubbleAttrFirstFormIndexIdx>-1){areaBubbleAttrElems[areaBubbleAttrFirstFormName.toLowerCase()]={headerIndex:areaBubbleAttrFirstFormIndexIdx,lineIndex:i};}}}mapLineScope.areaBubbleAttrElems=areaBubbleAttrElems;mapLineScopes.push(mapLineScope);}}}else{if(layoutAttrIndex===-1&&areaBubbleAttrIndex>-1){mapLineScope={startLine:0,endLine:0,areaBubbleAttrElems:null};if(rhsItems&&allAreaBubbleAttrElems){for(i=0;i<rhsItems.length;i++){areaBubbleAttrFirstFormIndexIdx=(rhsItems[i].items&&rhsItems[i].items.length>0)?rhsItems[i].items[0].idx:-1;areaBubbleAttrFirstFormName=(allAreaBubbleAttrElems.length>areaBubbleAttrFirstFormIndexIdx)?allAreaBubbleAttrElems[areaBubbleAttrFirstFormIndexIdx].n:null;if(areaBubbleAttrFirstFormName&&areaBubbleAttrFirstFormIndexIdx>-1){mapLineScope.endLine=i;areaBubbleAttrElems[areaBubbleAttrFirstFormName.toLowerCase()]={headerIndex:areaBubbleAttrFirstFormIndexIdx,lineIndex:i};}}}mapLineScope.areaBubbleAttrElems=areaBubbleAttrElems;mapLineScopes.push(mapLineScope);}}},getSubWidgetCount:function getSubWidgetCount(){return this.mapLineScopes.length;},getAspectRatioFromPolygon:function getAspectRatioFromPolygon(coords){var maxX=0,maxY=0,minX=Number.MAX_VALUE,minY=Number.MAX_VALUE,rgn,c,i,j,k;for(i in coords){if(coords.hasOwnProperty(i)){rgn=coords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];for(k=0;k<c.length;k++){if(c[k]>maxX){maxX=c[k];}if(c[k]<minX){minX=c[k];}k++;if(c[k]>maxY){maxY=c[k];}if(c[k]<minY){minY=c[k];}}}}}}if(maxX>minX&&maxY>minY){this.aspectRatio=(maxY-minY)/(maxX-minX);}else{this.aspectRatio=1;}},getAttrFormIndices:function getAttrFormIndices(){var me=this,modelData=me.modelData,rows=modelData&&modelData.gts&&modelData.gts.row,i,j;if(rows){var attrFormIndices=me.attrFormIndices=[],idx=0;for(i=0;i<rows.length;i++){var fs=rows[i]&&rows[i].fs;attrFormIndices.push([]);if(fs){for(j=0;j<fs.length;j++){attrFormIndices[i].push(idx++);}}}}},calculateBubbleSizeParas:function calculateBubbleSizeParas(){var me=this,modelData=me.modelData,gvs=modelData.gvs,gts=modelData.gts,gts_row=gts&&gts.row,gts_es=gts_row&&gts_row.length>0&&gts_row[gts_row.length-1].es,i,lineIndex,maxRadius=0,bubbleSizeParas={},sizeByIndex=me.sizeByIndex;var ratio=1,ty=modelData.vp.ty||"0";if(ty==="0"){if(sizeByIndex<0){ratio=me.CONSTANTS.MAX_SIZE_DEFAULT_RATIO.SCATTER;}else{if(sizeByIndex>=0){ratio=me.CONSTANTS.MAX_SIZE_DEFAULT_RATIO.AUTOMATIC;}}}else{if(ty==="1"){if(modelData.vp.hasOwnProperty("val")&&modelData.vp.val!==null&&modelData.vp.val!==""){ratio=parseFloat(modelData.vp.val);if(ratio>me.CONSTANTS.MAX_RATIO_LIMIT.UP_LIMIT){ratio=me.CONSTANTS.MAX_RATIO_LIMIT.UP_LIMIT;}if(ratio<me.CONSTANTS.MAX_RATIO_LIMIT.LOW_LIMIT){ratio=me.CONSTANTS.MAX_RATIO_LIMIT.LOW_LIMIT;}}else{if(sizeByIndex<0){ratio=me.CONSTANTS.MAX_SIZE_DEFAULT_RATIO.SCATTER;}else{if(sizeByIndex>=0){ratio=me.CONSTANTS.MAX_SIZE_DEFAULT_RATIO.MANUAL;}}}}else{if(sizeByIndex<0){ratio=me.CONSTANTS.MAX_SIZE_DEFAULT_RATIO.SCATTER*2;}else{if(sizeByIndex>=0){ratio=me.CONSTANTS.MAX_SIZE_DEFAULT_RATIO.MANUAL*2;}}}}var maxMaxSize=me.baseMaxBubbleSizeAuto;if(sizeByIndex>=0){maxMaxSize=me.baseMaxBubbleSizeManual;}var baseSize=0.15*Math.min(me.getMiniWidth(),me.getMiniHeight());if(ty==="0"){maxRadius=Math.min(ratio*baseSize,maxMaxSize);}else{if(ty==="1"){maxRadius=ratio*baseSize;}else{maxRadius=ratio*baseSize;}}if(maxRadius<=2){maxRadius=3;}bubbleSizeParas.maxRadius=maxRadius;var maxValue=0,minValue=Number.MAX_VALUE;if(sizeByIndex>=0){for(i=0;i<gvs.items.length;i++){var tempVal=Math.abs(parseFloat(gvs.items[i].items[sizeByIndex].rv));if(maxValue<tempVal){maxValue=tempVal;}if(minValue>tempVal){minValue=tempVal;}}}bubbleSizeParas.maxValue=maxValue;bubbleSizeParas.minValue=minValue;modelData.bubbleSizeParas=bubbleSizeParas;return bubbleSizeParas;},getBubbleSizeParas:function getBubbleSizeParas(){var me=this,modelData=me.modelData;if(modelData.bubbleSizeParas===undefined){return me.calculateBubbleSizeParas();}else{return modelData.bubbleSizeParas;}},getColCount:function(){var modelData=this.modelData,colCount=0;if(modelData.hasOwnProperty("gvs")&&modelData.gvs.hasOwnProperty("items")&&modelData.gvs.items.length>0&&modelData.gvs.items[0].hasOwnProperty("items")&&modelData.gvs.items[0].items.length>0){colCount=modelData.gvs.items[0].items.length;}return colCount;},getIndexFromVP:function(type,prop){var index=-1,me=this,modelData=me.modelData,vp=modelData&&modelData.vp,id=vp&&vp[prop];function getColIndexFromVP(prop){var colIndex=-1;var gtsCol=modelData.gts&&modelData.gts.col,gtsColEle=null,i;if(id&&gtsCol&&gtsCol.length>0&&gtsCol[0].hasOwnProperty("es")){gtsColEle=gtsCol[0].es;for(i=0;i<gtsColEle.length;i++){if(gtsColEle[i].oid===id){colIndex=i;}}}return colIndex;}function getRowIndexFromVP(prop){var rowIndex=-1;var gtsRow=modelData.gts&&modelData.gts.row,i;if(id&&gtsRow&&gtsRow.length>0){for(i=0;i<gtsRow.length;i++){if(gtsRow[i].id===id){rowIndex=i;}}}return rowIndex;}if(type==="ROW"){index=getRowIndexFromVP(prop);}else{if(type==="COL"){index=getColIndexFromVP(prop);}else{index=getRowIndexFromVP(prop);index=index===-1?getColIndexFromVP(prop):index;}}return index;},calculateSizeByIndex:function calculateSizeByIndex(){var me=this;sizeByIndex=me.getIndexFromVP("COL",me.CONSTANTS.DP_IN_VP.SIZE_BY);if(sizeByIndex<0){sizeByIndex=0;}me.sizeByIndex=sizeByIndex;return sizeByIndex;},calculateSizeByIndexForVI:function calculateSizeByIndexForVI(){var me=this,sizeByIndex=me.getIndexFromVP("COL",me.CONSTANTS.DP_IN_VP.SIZE_BY);me.sizeByIndex=sizeByIndex;return sizeByIndex;},getSizeByIndex:function getSizeByIndex(){var me=this;if(me.sizeByIndex===undefined){return me.calculateSizeByIndex();}else{return me.sizeByIndex;}},getSizeByIndexForVI:function getSizeByIndexForVI(){var me=this;if(me.sizeByIndex===undefined){return me.calculateSizeByIndexForVI();}else{return me.sizeByIndex;}},calculateAreaColorByIndex:function calculateAreaColorByIndex(){var me=this,areaColorByIndex=me.getIndexFromVP("COL",me.CONSTANTS.DP_IN_VP.COLOR_BY);var colCount=me.getColCount();if(areaColorByIndex<0){if(colCount===1){areaColorByIndex=0;}else{if(colCount>1){areaColorByIndex=1;}}}me.areaColorByIndex=areaColorByIndex;return areaColorByIndex;},calculateAreaColorByIndexForVI:function calculateAreaColorByIndexForVI(){var me=this,areaColorByIndex=me.getIndexFromVP("COL",me.CONSTANTS.DP_IN_VP.COLOR_BY);me.areaColorByIndex=areaColorByIndex;return areaColorByIndex;},getAreaColorByIndex:function getAreaColorByIndex(){var me=this;if(me.areaColorByIndex===undefined){return me.calculateAreaColorByIndex();}else{return me.areaColorByIndex;}},getAreaColorByIndexForVI:function getAreaColorByIndexForVI(){var me=this;if(me.areaColorByIndex===undefined){return me.calculateAreaColorByIndexForVI();}else{return me.areaColorByIndex;}},calculateAllBubblesColor:mstrmojo.emptyFn,getAllBubblesColor:function getAllBubblesColor(colorByIndex){var me=this,modelData=me.modelData;if(colorByIndex===undefined){colorByIndex=-1;}if(modelData.hasOwnProperty("allBubblesColor")){return modelData.allBubblesColor;}else{return me.calculateAllBubblesColor(colorByIndex);}},getThresholdType:function getThresholdType(colIndex){if(colIndex<-1){return me.CONSTANTS.THRESHOLD_TYPE.UNDEFINED;}var me=this,modelData=me.modelData,th=modelData&&modelData.th,subTh=th&&th[colIndex],gvs=me.modelData&&me.modelData.gvs,gts_row=modelData&&modelData.gts&&modelData.gts.row,gts_es=gts_row&&gts_row.length>0&&gts_row[gts_row.length-1].es,elem,i,cellData,lineIndex;if(subTh&&gts_es&&gvs.items.length>0){if(colIndex>=gvs.items[0].items.length||colIndex<0||subTh.length===0){return me.CONSTANTS.THRESHOLD_TYPE.UNDEFINED;}for(i=0;i<gvs.items.length;i++){cellData=gvs.items[i].items[colIndex];if(cellData.hasOwnProperty("ty")&&parseInt(cellData.ty,10)===4){return me.CONSTANTS.THRESHOLD_TYPE.IMAGE;}}var isImgReg=/(jpg|jpeg|png|gif|tiff|bmp)$/i;for(elem in subTh){if(subTh.hasOwnProperty(elem)&&isImgReg.test(subTh[elem].n)){return me.CONSTANTS.THRESHOLD_TYPE.IMAGE;}}for(i=0;i<gvs.items.length;i++){cellData=gvs.items[i].items[colIndex];if(cellData.hasOwnProperty("ty")&&parseInt(cellData.ty,10)===2){return me.CONSTANTS.THRESHOLD_TYPE.COLOR;}}return me.CONSTANTS.THRESHOLD_TYPE.UNDEFINED;}else{return me.CONSTANTS.THRESHOLD_TYPE.UNDEFINED;}return me.CONSTANTS.THRESHOLD_TYPE.UNDEFINED;},setWidgetParas:function setWidgetParas(){var me=this,modelData=me.modelData,rows=modelData&&modelData.gts&&modelData.gts.row;me.oriDomLength=me.domNode.childNodes.length;me.setLoadingIndicatorFormat();me.getAttrFormIndices();if(me.isVI){me.layoutAttrIndex=me.getIndexFromVP("ROW",me.CONSTANTS.DP_IN_VP.LAYOUT_ATTRIBUTE);me.areaBubbleAttrIndex=me.getIndexFromVP("ROW",me.CONSTANTS.DP_IN_VP.GEO_ATTRIBUTE);if(rows){var rowCnt=rows.length;if(rowCnt>1){me.hasMultiAttr=true;}else{if(rowCnt===1){me.hasMultiAttr=false;me.subTitleHeight=0;}}}}else{if(rows){var rowCnt=rows.length;if(rowCnt>1){me.hasMultiAttr=true;me.layoutAttrIndex=rowCnt-2;me.areaBubbleAttrIndex=rowCnt-1;}else{if(rowCnt===1){me.hasMultiAttr=false;me.subTitleHeight=0;me.layoutAttrIndex=-1;me.areaBubbleAttrIndex=0;}}}}var areaBubbleAttrIndex=me.areaBubbleAttrIndex,attrFormIndices=me.attrFormIndices;if(areaBubbleAttrIndex>-1){me.areaBubbleAttrFormCount=(attrFormIndices&&attrFormIndices.length>areaBubbleAttrIndex)?attrFormIndices[areaBubbleAttrIndex].length:0;}me.setLayoutAttrFormParas();me.prepareDataForSubWidget();me.totalSubWidgetCount=me.getSubWidgetCount();if(me.totalSubWidgetCount>1){me.showLoadingIndicatorFlag=true;}me.getDefaultSelectedObjs();me.hasIfwTarget=me.hasInfowindowTarget();me.hasNonifwTarget=me.hasNoninfowindowTarget();me.shouldHighlightDefaultSelectedNodes=me.getShouldHighlightDefaultSelectedNodes();},setLayoutAttrFormParas:function(){var me=this,layoutAttrIndex=me.layoutAttrIndex,attrFormIndices=me.attrFormIndices,i,n;if(layoutAttrIndex>-1){me.layoutAttrFormCount=(attrFormIndices&&attrFormIndices.length>layoutAttrIndex)?attrFormIndices[layoutAttrIndex].length:0;}if(me.layoutAttrFormCount>0){this.shapeFileFormIndex=me.layoutAttrFormCount-1;this.subTitleFormIndex=0;var modelData=me.modelData,row=modelData&&modelData.gts&&modelData.gts.row;if(row&&layoutAttrIndex>-1&&me.layoutAttrFormCount>0&&row.length>layoutAttrIndex){var fs=row[layoutAttrIndex].fs;if(fs){for(i=0;i<fs.length;i++){n=fs[i].n;n=n!==undefined?n:"";if(n.toLowerCase()==="shapefile"){this.shapeFileFormIndex=i;break;}}for(i=0;i<fs.length;i++){if(i!==this.shapeFileFormIndex){this.subTitleFormIndex=i;break;}}}}}},getShouldHighlightDefaultSelectedNodes:function(){return(!isOwnEmpty(this.defaultSelectedObjs)&&this.hasNonifwTarget);},getSubTitle:function getSubTitle(r,c){var mapFileIndex=r*this.finalColCnt+c,defString="No Title Found!";return this.getLayoutAttrElemString(mapFileIndex,this.subTitleFormIndex,defString);},getLayoutAttrElemString:function(mapFileIndex,formIndex,defString){if(mapFileIndex<0){return defString;}var me=this,modelData=me.modelData,attrFormIndices=me.attrFormIndices,layoutAttrIndex=me.layoutAttrIndex,layoutAttrFormIndices=attrFormIndices.length>layoutAttrIndex&&attrFormIndices[layoutAttrIndex],layoutAttrFirstFormIndex=layoutAttrFormIndices&&layoutAttrFormIndices[0],layoutAttrFormCount=me.layoutAttrFormCount,rhsItems=modelData&&modelData.ghs&&modelData.ghs.rhs&&modelData.ghs.rhs.items,row=modelData&&modelData.gts&&modelData.gts.row,mapLineScopes=me.mapLineScopes;if(row){if(layoutAttrIndex>-1&&layoutAttrFormCount>0&&row.length>layoutAttrIndex){var mapLineScope=mapLineScopes&&mapLineScopes[mapFileIndex],startLine=mapLineScope&&mapLineScope.startLine,es=row[layoutAttrIndex].es,esIndex=0;if(startLine!==undefined&&startLine>-1){var lineItems=rhsItems[startLine].items;esIndex=lineItems[layoutAttrFirstFormIndex+formIndex].idx;}return es.length>esIndex?es[esIndex].n:defString;}else{return defString;}}else{return defString;}},getMiniWidth:function(){return Math.floor(this.cellWidth*this.manager.widthScale);},getMiniHeight:function(){return Math.floor(this.cellHeight*this.manager.heightScale-this.imageLayoutTable.getSubTitleHeight());},handleDroppedChart:function handleDroppedChart(domCanvas,node){},hideTooltip:function(){var me=this,tooltip=me.imageLayoutTable&&me.imageLayoutTable.tooltip;if(tooltip&&me.tooltipOn){me.tooltipOn=false;me.currHoverObj=null;me.currHoverObjMiniChart=null;tooltip.style.visibility="hidden";me.highlightMiniCharts();}},highlightMiniCharts:function(curWidget){var me=this,tooltip=me.imageLayoutTable&&me.imageLayoutTable.tooltip,miniCharts=me.miniCharts,rowIdx,rowMCs,colIdx,miniChart;if(curWidget===undefined){curWidget=null;}for(rowIdx in miniCharts){if(miniCharts.hasOwnProperty(rowIdx)){rowMCs=miniCharts[rowIdx];if(rowMCs){for(colIdx in rowMCs){if(rowMCs.hasOwnProperty(colIdx)){miniChart=rowMCs[colIdx];if(miniChart!==curWidget){miniChart.highlightPoint();}}}}}}},getMiniChart:function(rowIndex,colIndex){var me=this,miniChart=null,miniCharts=me.miniCharts;var rowStr=rowIndex.toString(),colStr=colIndex.toString();if(miniCharts){if(miniCharts.hasOwnProperty(rowStr)){var rowMiniCharts=miniCharts[rowStr];if(rowMiniCharts&&rowMiniCharts.hasOwnProperty(colStr)){miniChart=rowMiniCharts[colStr];}}}return miniChart;},hasInfowindowTarget:function hasInfowindowTarget(){var me=this,modelData=me.modelData,gts=modelData.gts,row=gts&&gts.row,rowH=row&&row.length>me.areaBubbleAttrIndex&&row[me.areaBubbleAttrIndex],tks=rowH&&rowH.sc&&rowH.sc.tks;var xtabModel=this.xtabModel,docModel=(xtabModel&&xtabModel.docModel);if(docModel){var layouts=docModel.defn&&docModel.defn.layouts,layout=null,i;if(layouts){for(i in layouts){if(layouts.hasOwnProperty(i)&&layouts[i].loaded){layout=layouts[i];break;}}}var units=layout&&layout.units;if(units&&tks){var tksList=tks.split("\x1E"),j;for(j=0;j<tksList.length;j++){var unit=units[tksList[j]];if(unit){if(unit.ifw){return true;}}}}}return false;},hasNoninfowindowTarget:function hasNoninfowindowTarget(){var me=this,modelData=me.modelData,gts=modelData.gts,row=gts&&gts.row,rowH=row&&row.length>0&&row[row.length-1],tks=rowH&&rowH.sc&&rowH.sc.tks;var xtabModel=this.xtabModel,docModel=(xtabModel&&xtabModel.docModel);if(docModel){var layouts=docModel.defn&&docModel.defn.layouts,layout=null,i;if(layouts){for(i in layouts){if(layouts.hasOwnProperty(i)){if(layouts[i].loaded){layout=layouts[i];break;}}}}var units=layout&&layout.units;if(units&&tks){var tksList=tks.split("\x1E"),j;for(j=0;j<tksList.length;j++){var unit=units[tksList[j]];if(unit){if(!unit.ifw){return true;}}}}}return false;},pointCanBeSelected:function pointCanBeSelected(touchObj){var me=this,m=me.modelData,gts=m.gts,colHeaders=gts.col,colHL=colHeaders.length,rowHeaders=gts.row,rowHL=rowHeaders.length,i;for(i=0;i<rowHL;i++){var rowH=rowHeaders[i];if(rowH.sc&&rowH.sc.tks){return true;}if(rowH.lm&&rowH.lm[0]&&rowH.lm[0].links&&rowH.lm[0].hasOwnProperty("di")){return true;}}return false;},getActionObj:function getActionObj(touchedObj,selectedAll,sameAsCurrSelectedPoint){var scObjList=[],actionType=0,actionObjList=[],linkDrillNode=null;var me=this,modelData=me.modelData,gts=modelData.gts,row=gts&&gts.row,rowH=row&&row.length>0&&row[row.length-1];var actionObj=null;if(rowH&&rowH.sc&&rowH.sc.tks&&(!touchedObj||touchedObj.hdrIndex>=0)){if(selectedAll&&(rowH.sc.all==="false"||rowH.sc.all===false)){return null;}var scObj={};scObj.sc=rowH.sc;if(touchedObj&&touchedObj>=0){scObj.es=rowH.es[touchedObj.hdrIndex].n;}else{scObj.es=null;}scObj.eid=selectedAll?"OA:(All)":rowH.es[touchedObj.hdrIndex].id;scObjList.push(scObj);actionType=rowH.at||0;}else{if(rowH.lm&&rowH.lm[0]&&rowH.lm[0].links&&!linkDrillNode&&touchedObj&&touchedObj.hdrIndex>=0){linkDrillNode={};linkDrillNode.titleInfo=rowH;linkDrillNode._e=rowH.es[touchedObj.hdrIndex];}}var colH=gts.col&&gts.col.length>0&&gts.col[0];if(scObjList.length>0){actionType=actionType|me.CONSTANTS.ACTION_TYPE.SELECTOR;if(touchedObj&&touchedObj.hdrIndex>=0){if(!sameAsCurrSelectedPoint){if(this.hasIfwTarget){this.getAnchorStyle(touchedObj);this.realtimeInfowindowOn=true;actionObj={at:actionType,k:this.getModelK(),scObjList:scObjList,anchor:this.touchedMiniChart.infowinAnchor};}else{actionObj={at:actionType,k:this.getModelK(),scObjList:scObjList};}}else{actionObj={at:actionType,k:this.getModelK(),scObjList:scObjList};}}else{if(touchedObj&&touchedObj.hdrIndex<0){actionObj={at:actionType,k:this.getModelK(),scObjList:scObjList};}else{if(!touchedObj){actionObj={at:actionType,k:this.getModelK(),scObjList:scObjList};}}}}else{if(!linkDrillNode&&touchedObj&&touchedObj.hdrIndex>=0){var metricH=colH,metricHL=metricH&&metricH.es&&metricH.es.length,i;if(metricH&&metricHL>0){for(i=metricHL-1;i>=0;i--){var metric=metricH.es[i],lm=metricH.lm[i];if(lm&&lm.links){linkDrillNode={};linkDrillNode.titleInfo=metricH;linkDrillNode.mix=i;var currNode=linkDrillNode,nodeLP={};nodeLP.titleInfo=rowH;nodeLP._e=rowH.es[touchedObj.hdrIndex];currNode._lp=nodeLP;currNode.axis=me.CONSTANTS.AXIS.ROW_AXIS;}}}}}if(linkDrillNode){actionType=actionType|me.CONSTANTS.ACTION_TYPE.HYPERLINK;actionObj={at:actionType,k:this.getModelK(),node:linkDrillNode};}return actionObj;},getModelK:function getModelK(){return this.modelData&&this.modelData.k;},getAnchorStyle:function getAnchorStyle(touchedObj){if(!touchedObj){return ;}var me=this,touchVal=touchedObj.touchVal,touchedMiniChart=me.touchedMiniChart,infowinAnchor=touchedMiniChart.infowinAnchor,coords=touchedMiniChart.coords,i,j;if(!infowinAnchor){return ;}infowinAnchor.style.left=(touchedObj.point.x-9)+"px";infowinAnchor.style.top=(touchedObj.point.y-9)+"px";if(touchedMiniChart.displayMode===me.CONSTANTS.DISPLAY_MODE.AREA){var minX=Number.POSITIVE_INFINITY,maxX=0,minY=Number.POSITIVE_INFINITY,maxY=0;if(coords.hasOwnProperty(touchVal)){var rgn=coords[touchVal];for(i in rgn){if(!rgn.hasOwnProperty(i)){continue;}var c=rgn[i];for(j=0;j<c.length;j++){if(minX>c[j]){minX=c[j];}if(maxX<c[j]){maxX=c[j];}j++;if(minY>c[j]){minY=c[j];}if(maxY<c[j]){maxY=c[j];}}}infowinAnchor.style.left=(minX+touchedMiniChart.leftOffset)+"px";infowinAnchor.style.top=(minY+touchedMiniChart.topOffset)+"px";infowinAnchor.style.width=(maxX-minX)+"px";infowinAnchor.style.height=(maxY-minY)+"px";}}else{if(touchedMiniChart.displayMode===me.CONSTANTS.DISPLAY_MODE.BUBBLE){if(touchedMiniChart.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){coords=touchedMiniChart.polygonCenters;}if(coords.hasOwnProperty(touchVal)){var ct=coords[touchVal][0];if(touchedMiniChart.markerType===me.CONSTANTS.MARKER_TYPE.BUBBLE){var rd=touchedMiniChart.getRadiusFromName(touchVal);infowinAnchor.style.left=(ct[0]+touchedMiniChart.leftOffset-rd)+"px";infowinAnchor.style.top=(ct[1]+touchedMiniChart.topOffset-rd)+"px";infowinAnchor.style.width=(2*rd)+"px";infowinAnchor.style.height=(2*rd)+"px";}else{if(touchedMiniChart.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){var _image=touchedMiniChart["imageIcon_"+touchVal],_width=0,_height=0;if(_image){_width=_image.width;_height=_image.height;}infowinAnchor.style.left=(ct[0]+touchedMiniChart.leftOffset-_width/2)+"px";infowinAnchor.style.top=(ct[1]+touchedMiniChart.topOffset-_height/2)+"px";infowinAnchor.style.width=_width+"px";infowinAnchor.style.height=_height+"px";}}}}}},showInfowindow:function(touchedObj){var me=this,actionObj;if(touchedObj&&touchedObj.hdrIndex>=0){var canBeSelected=me.pointCanBeSelected(touchedObj),sameAsCurrSelectedPoint=me.currSelectedObj&&(touchedObj.touchVal===me.currSelectedObj.touchVal)&&(me.touchedMiniChart===me.currSelectedObjMiniChart);if(canBeSelected){if(!sameAsCurrSelectedPoint){me.hideTooltip();actionObj=me.getActionObj(touchedObj);if(actionObj&&actionObj.scObjList){me.currSelectedObj=touchedObj;}me.highlightMiniCharts();me.performAction([actionObj]);}else{if(me.currHoverObj&&me.currSelectedObj&&me.currHoverObj.touchVal===me.currSelectedObj.touchVal&&me.currHoverObjMiniChart===me.currSelectedObjMiniChart){me.hideTooltip();}else{me.hideTooltip();actionObj=me.getActionObj(touchedObj,true,true);if(actionObj){me.performAction([actionObj]);me.currSelectedObj=null;me.highlightMiniCharts();}}}}else{}}else{if((touchedObj&&touchedObj.hdrIndex<0)||!touchedObj){me.hideTooltip();if(me.currSelectedObj){actionObj=me.getActionObj(touchedObj,true);if(actionObj){me.performAction([actionObj]);me.currSelectedObj=null;me.highlightMiniCharts();}}}}},closeInfowindow:function(){var me=this;me.getFirstInfowindow();if(me.realtimeInfowindowOn&&me.infowindow){me.realtimeInfowindowOn=false;me.infowindow.close();if(me.infowindow._tchHandler&&mstrmojo.touchManager!==undefined){mstrmojo.touchManager.detachEventListener(me.infowindow._tchHandler);delete me.infowindow._tchHandler;}}},openInfowindow:function(){var me=this;me.getFirstInfowindow();if(!me.realtimeInfowindowOn&&me.infowindow){me.realtimeInfowindowOn=true;me.infowindow.open();}},getFirstInfowindow:function getFirstInfowindow(){if(this.infowindow){return ;}var me=this,modelData=me.modelData,xtabModel=me.xtabModel,docModel=(xtabModel&&xtabModel.docModel),row=modelData&&modelData.gts&&modelData.gts.row,areaBubbleAttrIndex=me.areaBubbleAttrIndex,tks=null;if(row&&row.length>0){tks=row[areaBubbleAttrIndex]&&row[areaBubbleAttrIndex].sc&&row[areaBubbleAttrIndex].sc.tks;}if(docModel&&tks){var ifws=docModel.getTargetInfoWin(tks);if(ifws&&ifws.length>0){var ifwunit=docModel.infoWinByKey[ifws[0]],id=ifwunit&&(ifwunit.id+"_ifw");me.infowindow=mstrmojo.all[id];}}},prepareCoordsName:function pcn(coords){if(coords!==null&&coords!==undefined){var i,key,value;for(i in coords){if(i.indexOf("&")>=0||i.indexOf("<")>=0||i.indexOf(">")>=0){value=coords[i];key=i.replace(/&/g,"&amp;");key=key.replace(/</g,"&lt;");key=key.replace(/>/g,"&gt;");delete coords[i];coords[key]=value;}}}},hasSelectedObj:function(){return(this.currSelectedObj!==null&&this.currSelectedObj.hasOwnProperty("touchVal")&&this.currSelectedObj.touchVal!==""&&this.currSelectedObj.touchVal!==null);},hasHoverObj:function(){return(this.currHoverObj!==null&&this.currHoverObj.hasOwnProperty("touchVal")&&this.currHoverObj.touchVal!==""&&this.currHoverObj.touchVal!==null);},hasLinkObj:function(){return(this.currLinkObj!==null&&this.currLinkObj.hasOwnProperty("touchVal")&&this.currLinkObj.touchVal!==""&&this.currLinkObj.touchVal!==null);},deleteSubWidgets:function deleteSubWidgets(){var me=this,i,j;if(me.miniCharts){for(i in me.miniCharts){if(me.miniCharts.hasOwnProperty(i)){for(j in me.miniCharts[i]){if(me.miniCharts[i].hasOwnProperty(j)){me.miniCharts[i][j].destroy();delete me.miniCharts[i][j];}}delete me.miniCharts[i];}}delete me.miniCharts;}},deleteImageLayoutTable:function(){if(this.imageLayoutTable){this.imageLayoutTable.destroy();delete this.imageLayoutTable;}},deleteImageLayoutTableManager:function(){if(this.manager){this.manager.destroy();delete this.manager;}},detachListeners:function detachListeners(){var me=this,manager=me.manager,chartResizeListener=me.chartResizeListener;if(chartResizeListener&&manager){manager.detachEventListener(chartResizeListener);delete me.chartResizeListener;}if(me.docModelListener){if(me.xtabModel&&me.xtabModel.docModel){me.xtabModel.docModel.detachEventListener(me.docModelListener);}delete me.docModelListener;}},unrender:function unrender(ignoreDom){this.detachListeners();this.deleteSubWidgets();this.deleteImageLayoutTable();this.deleteImageLayoutTableManager();if(this._super){this._super(ignoreDom);}},destroy:function destroy(){this.detachListeners();if(this.manager){this.manager.destroy();delete this.manager;}if(this.imageLayoutTable){this.imageLayoutTable.destroy();delete this.imageLayoutTable;}if(this._super){this._super();}}});}());