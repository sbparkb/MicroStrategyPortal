(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.array","mstrmojo.hash","mstrmojo.css","mstrmojo.dom","mstrmojo.ui.Pulldown","mstrmojo.DI.DIDatabaseHelper");mstrmojo.requiresDescs(14455,14456,14457);var $A=mstrmojo.array,$H=mstrmojo.hash,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$HELPER=mstrmojo.DI.DIDatabaseHelper;var DBRoleItemCfg={scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-DI-DIDBRoleAdmin-Item cf",markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass} {@mode}" style="{@cssText}" mstrAttach:click><div class="mstrmojo-DI-DIDBRoleAdmin-Item-Text">{@n}</div><div class="mstrmojo-DI-DIDBRoleAdmin-Item-Img"></div></div>',onmodeChange:function(evt){var vWas=evt.valueWas,v=evt.value;if(this.hasRendered){$CSS.toggleClass(this.domNode,vWas,false);$CSS.toggleClass(this.coverNode,vWas,false);$CSS.toggleClass(this.domNode,v,true);$CSS.toggleClass(this.coverNode,v,true);}},onclick:function(evt){var target=evt.getTarget();if(this.mode==="remove"){if(this.domNode.children[1]===target){this.parent.raiseEvent({name:"selectChange",item:this});}}else{if(this.mode==="add"){if($DOM.contains(this.domNode,target,true)){this.parent.raiseEvent({name:"selectChange",item:this});}}}}};var DBRoleItemBoxItemsFn=function(){var items=this.items||[];this.destroyChildren();this.addChildren(items);};mstrmojo.DI.DIDBRoleAdmin=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.DI.DIDBRoleAdmin",selectedDBRole:null,topLabel:mstrmojo.desc(14455,"Commonly used for"),bottomLabel:mstrmojo.desc(14456,"Not commonly used"),adminConfig:null,markupString:'<div id="{@id}" class="mstrmojo-DI-DIDBRoleAdmin {@cssClass}" style="{@cssText}"><div class="mstrmojo-DI-DIDBRoleAdmin-Label top cf"><div class="mstrmojo-DI-DIDBRoleAdmin-Label-Text">{@topLabel}</div></div><div class="mstrmojo-DI-DIDBRoleAdmin-Content top"></div><div class="mstrmojo-DI-DIDBRoleAdmin-Label bottom">{@bottomLabel}</div><div class="mstrmojo-DI-DIDBRoleAdmin-Content bottom"></div></div>',markupSlots:{containerNode:function(){return this.domNode;},headerContainerNode:function(){return this.domNode.children[0];},topContainerNode:function(){return this.domNode.children[1];},bottomContainerNode:function(){return this.domNode.children[3];}},children:[{scriptClass:"mstrmojo.Box",alias:"topBox",slot:"topContainerNode",cssClass:"mstrmojo-DI-DIDBRoleAdmin-Box top cf",onitemsChange:function(){DBRoleItemBoxItemsFn.call(this);},onselectChange:function(evt){this.parent.onselectChange(evt);}},{scriptClass:"mstrmojo.Box",alias:"bottomBox",slot:"bottomContainerNode",cssClass:"mstrmojo-DI-DIDBRoleAdmin-Box bottom cf",onitemsChange:function(){DBRoleItemBoxItemsFn.call(this);},onselectChange:function(evt){this.parent.onselectChange(evt);}}],preBuildRendering:function(){var model;if(this._super){this._super();}model=mstrApp.getRootController().getModel();if(model.supportDBObjects&&model.supportDBObjects.supportDBType){this.populateDBRoles();}else{if(mstrApp.diParams.ImportDatabase){mstrApp.showProgress();model.attachEventListener("dbTypeFetched",this.id,"populateDBRoles");}else{this.set("topLabel",mstrmojo.desc(14457,"You do not have the right privilege to import from databases. Contact your administrator."));this.set("bottomLabel","");this.topBox.set("visible",false);this.bottomBox.set("visible",false);}}},populateDBRoles:function(evt){var me=this,model=mstrApp.getRootController().getModel(),sources,cfg;if(evt){mstrApp.hideProgress();}this.adminConfig={};sources=$A.filter(model.sourceItems,function(item){return item.showDBList;});sources=$A.map(sources,function(item){return{did:item.sid,n:item.n,dbObjectsDisplayOptions:item.dbObjectsDisplayOptions,dbIdExcludeFilter:item.dbIdExcludeFilter,dbRolesAdminConfig:item.dbRolesAdminConfig};});$A.forEach(sources,function(source){var sid=source.did,dbTypes,items;if(!me.adminConfig[sid]){dbTypes=model.supportDBObjects&&model.supportDBObjects.supportDBType;dbTypes=$HELPER.filterDBByDispOption(dbTypes,source.dbObjectsDisplayOptions,source.dbIdExcludeFilter);items=$A.map(dbTypes,function(db){return $H.copy(DBRoleItemCfg,{n:db.n,dbId:db.id,dbType:db.dbType,selected:true});});if(source.dbRolesAdminConfig){$A.forEach(items,function(item){var idx=$A.indexOf(source.dbRolesAdminConfig,item.dbId);if(idx>=0){item.selected=false;}});}me.adminConfig[sid]=items;}});if(!this.typePulldown){cfg=mstrmojo.ui.Pulldown.newPulldown(sources,function(item,oldItem){me.onselectSourceItemChange(item,oldItem);},0,{alias:"typePulldown",slot:"headerContainerNode",isHostedWithin:true},true);this.addChildren([cfg]);this.onselectSourceItemChange(sources[0]);}else{this.typePulldown.set("items",sources);this.typePulldown.set("selectedIndex",this.typePulldown.selectedIndex||0);}},onselectSourceItemChange:function(item){var items,selectedItems,unselectedItems;if(!item||!this.adminConfig[item.did]){return ;}items=$A.map(this.adminConfig[item.did],function(db){return $H.copy(db,{mode:db.selected?"remove":"add"});});selectedItems=$A.filter(items,function(v){return v.selected;});unselectedItems=$A.filter(items,function(v){return !v.selected;});this.topBox.set("items",selectedItems);this.bottomBox.set("items",unselectedItems);},onselectChange:function(evt){var dbItem=evt.item,mode=dbItem.mode,source,items,idx;source=this.typePulldown.getSelectedItem();if(!source){return ;}items=this.adminConfig[source.did];if(!items){return ;}idx=$A.find(items,"dbId",dbItem.dbId);if(idx>=0){if(mode==="remove"){items[idx].selected=false;}else{if(mode==="add"){items[idx].selected=true;}}}this.onselectSourceItemChange(source);},getAdminConfig:function(){var config=null;if(this.hasRendered&&this.adminConfig){config={};$H.forEach(this.adminConfig,function(items,sid){var unselected=$A.filter(items,function(item){return item.selected!==true;});unselected=$A.map(unselected,function(item){return item.dbId;});config[sid]=unselected;});}return config;}});}());