(function(){mstrmojo.requiresCls("mstrmojo.DocSelector","mstrmojo.vi.ui.rw.selectors.AttrQualInputBox","mstrmojo.array","mstrmojo.expr","mstrmojo.date","mstrmojo.VisChartUtils","mstrmojo.locales","mstrmojo.elementHelper","mstrmojo.vi.ui.DatasetUnitMenuUtils");var $EXPR=mstrmojo.expr,$BFTP=$EXPR.BFTP,$DATE=mstrmojo.date,$VCU=mstrmojo.VisChartUtils,$ARR=mstrmojo.array,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$LOCALE=mstrmojo.locales;function getFormatDateStr(millis,dt){if(!millis){return ;}var dateInfo=$DATE.getDateJson(new Date($VCU.convertRawValueToMilliseconds(millis))),formatStr=$DATE.formatDateInfo(dateInfo,$LOCALE.datetime.DATEOUTPUTFORMAT);if(dt===$EXPR.DTP.TIMESTAMP){formatStr+=" "+$DATE.formatTimeInfo(dateInfo,$LOCALE.datetime.TIMEOUTPUTFORMAT);}return formatStr;}mstrmojo.AttrQualDocSelector=mstrmojo.declare(mstrmojo.DocSelector,null,{scriptClass:"mstrmojo.AttrQualDocSelector",getWidgetClass:function getWidgetClass(selectorContainer,selectorStyle,isHoriz){return"vi.ui.rw.selectors.AttrQualInputBox";},newAndInitWidget:function newAndInitWidget(selectorContainer){var selectorWidget=this._super(selectorContainer);selectorContainer.attachEventListener("includeChange",selectorWidget.id,function(evt){this.set("include",evt.value);});return selectorWidget;},_buildEvent:function _buildEvent(rEvt,widget){rEvt.f=widget.f;rEvt.ft=widget.ft;rEvt.fid=widget.fid;rEvt.ckey=this.ckey;rEvt.srcid=widget.srcid;rEvt.srct=widget.srct;var dt=widget.dt,cs=[];$ARR.forEach(widget.cs,function(c){if(!mstrmojo.string.isEmpty(c.v)){cs.push(c.v);}});if(cs.length){rEvt.cs=cs.join(mstrmojo.elementHelper.ELEM_SEPARATOR);}rEvt.dtp=dt;rEvt.unset=widget.unset;if(rEvt.unset||mstrmojo.string.isEmpty(rEvt.cs)){delete rEvt.fid;}},getCekEvtListener:function getCekEvtListener(selectorContainer,selectorControl){return function(evt){selectorContainer.handleActionInSyncPhase(function(){selectorControl.update(evt.value);});};},updateWidget:function updateWidget(selectorContainer){var selectorWidget=this._super(selectorContainer),node=selectorContainer.node,data=node.data;if(selectorWidget.update){var props={cs:data.cs,f:data.f,ft:data.ft,fid:data.fid,min:getFormatDateStr(data.min,data.dt),max:getFormatDateStr(data.max,data.dt)};selectorWidget.update(props);}return selectorWidget;},getWidgetConfig:function getWidgetConfig(selectorContainer,selectorStyle,defn,elements){var model=selectorContainer.model,fmts=selectorContainer.getFormats(),data=selectorContainer.node.data,cfg=this._super(selectorContainer,selectorStyle,defn,elements);cfg={scriptClass:cfg.scriptClass,cssText:fmts.height?"height: "+fmts.height:"",srcid:defn.srcid||"",srct:defn.srct||"",cs:data.cs,min:getFormatDateStr(data.min,data.dt),max:getFormatDateStr(data.max,data.dt),showAdvanced:true,canSelectDisabledDate:true,f:data.f,ft:data.ft||1,fid:data.fid,dt:data.dt,onchange:function(){if(!selectorContainer._inSyncPhase){selectorContainer.selectorControlChange(this);}}};if(!cfg.fid||!cfg.dt){var attrUnit=$DU.getUnitFromDataset(model.datasets,defn.srcid,12),fs=(attrUnit&&attrUnit.fs)||[],i,fnGetFormInfo=function(fm){if(!cfg.fid){cfg.fid=fm.fid;}if(!cfg.dt){switch(fm.bftp){case $BFTP.TEXT:cfg.dt=$EXPR.DTP.CHAR;break;case $BFTP.DATE:cfg.dt=$EXPR.DTP.DATE;break;case $BFTP.DATETIME:cfg.dt=$EXPR.DTP.TIMESTAMP;break;default:cfg.dt=$EXPR.DTP.CHAR;}}};if(fs[0]){fnGetFormInfo(fs[0]);}for(i=0;i<fs.length;i++){if(fs[i].iidx){fnGetFormInfo(fs[i]);break;}}}var dt=cfg.dt;if(cfg.f===undefined){if(dt===$EXPR.DTP.CHAR){cfg.f=$EXPR.FN.SEARCH;}else{if(dt===$EXPR.DTP.DATE||dt===$EXPR.DTP.TIMESTAMP){cfg.f=defn.include?$EXPR.FN.BETWEEN:$EXPR.FN.NOT_BETWEEN;}}}return cfg;},isValidSelection:function isValidSel(){var data=this.node.data,model=this.model;return !model.isSelWarnFlagOn(this.k)||data.cs&&data.cs.length;},isSelectAll:function isSelectAll(){var widget=this.children&&this.children[0];if(widget===undefined){return true;}var dateFormat=$LOCALE.datetime.DATEOUTPUTFORMAT,timeFormat=$LOCALE.datetime.TIMEOUTPUTFORMAT,parseDateTime=$DATE.parseDateAndOrTime;var minDateTime=parseDateTime.call($DATE,widget.min,dateFormat,timeFormat),fromDateTime=parseDateTime.call($DATE,widget.fromBox.fromPicker.value),isFromDateMin=$DATE.compareDate(fromDateTime&&fromDateTime.date,minDateTime&&minDateTime.date);if(isFromDateMin>0){return false;}if(isFromDateMin===0){if($DATE.compareTime(fromDateTime&&fromDateTime.time,minDateTime&&minDateTime.time)>0){return false;}}var maxDateTime=parseDateTime.call($DATE,widget.max,dateFormat,timeFormat),toDateTime=parseDateTime.call($DATE,widget.toBox.toPicker.value),isToDateMax=$DATE.compareDate(toDateTime&&toDateTime.date,maxDateTime&&maxDateTime.date);if(isToDateMax<0){return false;}if(isToDateMax===0){if($DATE.compareTime(toDateTime&&toDateTime.time,maxDateTime&&maxDateTime.time)<0){return false;}}return true;}});}());