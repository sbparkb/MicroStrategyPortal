(function(){mstrmojo.requiresCls("mstrmojo.dom");var _loaded=false,_D=mstrmojo.dom,SCROLLBAR_WIDTH=16;mstrmojo._HasContextMenu=mstrmojo.provide("mstrmojo._HasContextMenu",{cm:null,cmPos:null,itemField:"n",itemIdField:"did",itemChildrenField:"items",dynamicUpdate:false,queryChecked:function(item){return false;},queryEnabled:function(item){return true;},queryVisible:function(item){return true;},executeCommand:function executeCommand(item){},item2textCss:function item2textCss(item){return item.cssClass||item.cmdId||("cmd"+item[this.itemIdField]);},showContextMenu:function showContextMenu(){if(!_loaded){mstrmojo.requiresCls("mstrmojo.ContextMenu");_loaded=true;}var cm=this._subMenu,pos=this.getMenuPosition();if(!cm){var zi=(this.menuZIndex||this.zIndex||10)+1,cfg={left:pos.x+"px",top:pos.y+"px",zIndex:zi,visible:false,dynamicUpdate:this.dynamicUpdate,itemField:this.itemField,itemIdField:this.itemIdField,itemChildrenField:this.itemChildrenField,_cmSource:this.getContextMenuSource(),items:this.getContextMenuItems(),cssClass:this.getContextMenuCssClass(),placeholder:document.body.appendChild(document.createElement("div")),parent:this};cm=new mstrmojo.ContextMenu(cfg);cm.render();this._subMenu=cm;}else{cm.set("left",pos.x+"px");cm.set("top",pos.y+"px");}if(this.dynamicUpdate){var cmws=cm.ctxtBuilder.itemWidgets,len=cmws&&cmws.length,i,w,t=this.getContextMenuSource();for(i=0;i<len;i++){w=cmws[i];if(t.queryVisible){w.set("visible",t.queryVisible(w.data));}if(t.queryChecked){w.set("checked",t.queryChecked(w.data));}if(t.queryEnabled){w.set("enabled",t.queryEnabled(w.data));}}}cm.set("visible",true);this.callOnContextMenuOpen();this.adjustMenuPosition();this.attachMousedownEvent();},hideContextMenu:function hideContextMenu(){var sm=this._subMenu;if(sm&&sm.visible){this._subMenu.set("visible",false);this.callOnContextMenuClose();}},adjustMenuPosition:function adjustMenuPosition(){var cm=this._subMenu,cmd=this._subMenu.domNode,h=cmd.offsetHeight,w=cmd.offsetWidth,wDim=_D.windowDim(),pos=_D.position(cmd,false),posX=_D.position(cmd,true);if((pos.x+w+SCROLLBAR_WIDTH)>wDim.w){cm.set("left",(wDim.w-w-SCROLLBAR_WIDTH+(posX.x-pos.x))+"px");}if((pos.y+h+SCROLLBAR_WIDTH)>wDim.h){cm.set("top",(wDim.h-h-SCROLLBAR_WIDTH+(posX.y-pos.y))+"px");}},attachMousedownEvent:function attachMousedownEvent(){var me=this;if(!this._close_handler){this._close_handler=function(e){me.closeMenuHandler(e);};}_D.attachEvent(document.body,"mousedown",this._close_handler);},closeMenuHandler:function closeMenuHandler(e){if(!this.isOnMySubmenu(_D.eventTarget(self,e))){this.closeMenuTree();}},isOnMySubmenu:function isOnMySubmenu(t){var cm=this._subMenu;if(!cm){return false;}if(_D.contains(cm.domNode,t,true,document.body)){return true;}var cmws=cm.ctxtBuilder.itemWidgets,len=cmws&&cmws.length,i,w;for(i=0;i<len;i++){w=cmws[i];if(w.isOnMySubmenu(t)){return true;}}return false;},callOnContextMenuOpen:function callOnContextMenuOpen(){if(this.onContextMenuOpen){this.onContextMenuOpen();}},callOnContextMenuClose:function callOnContextMenuClose(){if(this.onContextMenuClose){this.onContextMenuClose();}},getContextMenuItems:function getContextMenuItems(){return this.cm;},getContextMenuCssClass:function getContextMenuCssClass(){return this.cmCssClass||"";},getContextMenuSource:function getContextMenuSource(){return this;},getMenuPosition:function getMenuPosition(){if(this.cmPos){return this.cmPos;}var pos=_D.position(this.domNode,true);return{x:Math.round(pos.x),y:Math.round(pos.y+pos.h)};},isSeparatorItem:function isSeparatorItem(item){return item[this.itemIdField]===-1||item[this.itemField]==="-";},hasSubmenu:function hasSubmenu(item){return !!item[this.itemChildrenField];},closeMenuTree:function closeMenuTree(newActive){var wasActive=this.activeMenuItem,t=this._cmSource||this;if(!wasActive){if(newActive){this.activeMenuItem=newActive;}else{t.hideContextMenu();}return ;}if(wasActive===newActive){return ;}if(newActive){this.activeMenuItem=newActive;if(newActive.parent.parent===wasActive){return ;}if(newActive.parent===wasActive.parent){wasActive.hideContextMenu();return ;}}else{newActive=t;this.activeMenuItem=null;}wasActive.hideContextMenu();while(wasActive!==t){wasActive=wasActive.parent.parent;if(wasActive!==newActive||t===newActive){wasActive.hideContextMenu();if(t===newActive){_D.detachEvent(document.body,"mousedown",this._close_handler);}}if(wasActive.parent===newActive.parent){break;}}}});}());