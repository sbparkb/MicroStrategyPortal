(function(){mstrmojo.requiresCls("mstrmojo.ME.TokenInputBox","mstrmojo.hash","mstrmojo.css","mstrmojo.dom","mstrmojo.range","mstrmojo.ME.MetricToken","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.ME.AttributeEditBox");var $DOM=mstrmojo.dom,RANGE=mstrmojo.range,EDGE=RANGE.EDGE,$HASH=mstrmojo.hash,$CSS=mstrmojo.css,DSS_OBJ_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes,prepareInsertToken=mstrmojo.ME.AttributeEditBox.prepareInsertToken;var DEL_LIST=["{","}"],DEL_MAP=null;function isDelimiter(c){if(!DEL_MAP){DEL_MAP={};var i,len;for(i=0,len=DEL_LIST.length;i<len;i++){DEL_MAP[DEL_LIST[i]]=true;}}return DEL_MAP.hasOwnProperty(c);}mstrmojo.ME.DynamicLinkTokenInputBox=mstrmojo.declare(mstrmojo.ME.TokenInputBox,[],{isDelimiter:isDelimiter,itemFunction:function itemFunction(item,idx,w){return new mstrmojo.ME.MetricToken({data:item,parent:w,isDelimiter:function(){return this.data.isDelimiter||(this.length()===1&&isDelimiter(this.data.v));}});},ondrop:function(c){var data=c.src.data,dataItem=data&&data.item;if(!dataItem){return ;}var oi=$HASH.copyProps(["did","n","t","fs"],dataItem);var token=prepareInsertToken(oi);var tokens=[token];if(oi.t===DSS_OBJ_TYPE.Attribute&&token.ift&&token.exv){tokens=[{v:"{",isDelimiter:true,isNew:true}].concat(tokens).concat([{v:"}",isDelimiter:true,isNew:true}]);}var lastTokenIdx=this.insertTokens(tokens);if(this.parent.ontokensModify){this.parent.ontokensModify();}this.set("dropCuePos",null);if(oi.t===DSS_OBJ_TYPE.Attribute&&token.ift&&!token.exv){var widgets=this.ctxtBuilder.itemWidgets||[],iw=widgets[lastTokenIdx];if(iw){this.startTokenSuggestion(iw);}}this.clearSelect(true);$CSS.removeClass(this.domNode,"unselectable");},insertLeftCurlyBraces:function insertLeftCurlyBraces(timeout){var me=this;window.setTimeout(function(){var lastTokenIdx=me.insertTokens([{v:"{",isDelimiter:true,isNew:true}]);me._delaySetCaretPos(me.itemsContainerNode.childNodes[lastTokenIdx+1],false);},timeout||50);},insertRightCurlyBraces:function insertRightCurlyBraces(timeout){var me=this;window.setTimeout(function(){var lastTokenIdx=me.insertTokens([{v:"}",isDelimiter:true,isNew:true}]);me._delaySetCaretPos(me.itemsContainerNode.childNodes[lastTokenIdx],false);me._delaySetTextCaretPos(me.itemsContainerNode.childNodes[lastTokenIdx],1);},timeout||50);},onSuggestionItemSelect:function onSuggestionItemSelect(it){var ow=this._saveActiveToken;var needAddCurlyBaces=true;this.endTokenSuggestion();if(ow){if(ow.data.ift&&it.t===DSS_OBJ_TYPE.AttributeForm){var idx=this.itemIndex(ow.data);if(this.items[idx-1]&&this.items[idx-1].v==="{"&&this.items[idx+1]&&this.items[idx+1].v==="}"){needAddCurlyBaces=false;}ow.setFormInfo(it);if(needAddCurlyBaces){this.insertLeftCurlyBraces();this._delaySetCaretPos(ow.domNode,true);var me=this;window.setTimeout(function(){me._delaySetCaretPos(ow.domNode,false);me.insertRightCurlyBraces();},50);}else{this._delaySetCaretPos(ow.domNode,false);}}else{ow.setItemInfo(it);this._delaySetCaretPos(ow.domNode,false);}}this.closePopup();},handlemouseup:function handlemouseup(e){this.raiseEvent({name:"tokenInputBoxSelected"});this._super(e);},widgetHandleInput:function widgetHandleInput(rInfo,c){if(!rInfo.collapsed){this.widgetDeleteTokens(rInfo);rInfo=RANGE.getRangeInfo();}var edge,ew,idx,t,aw,so,itws=this.ctxtBuilder.itemWidgets;if(!$DOM.contains(this.editNode,rInfo.startContainer,false,document.body)){this.add([{v:c,isDelimiter:this.isDelimiter(c),isNew:true}],0);ew=itws[0];RANGE.collapseOnTextNode(ew.domNode,1);return ;}edge=RANGE.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);ew=$DOM.findWidget(rInfo.startContainer);idx=this.itemIndex(ew.data);if(this.isDelimiter(c)){t={v:c,isDelimiter:true,isNew:true};if(edge===EDGE.EDGE_MIDDLE){var ts=ew.split2Tokens(rInfo.startOffset);this.remove(idx);if(c==="{"){this.add([ts[0],t,{v:"}",isDelimiter:true,isNew:true},ts[1]],idx);}else{this.add([ts[0],t,ts[1]],idx);}idx=idx+1;}else{idx=(edge===EDGE.EDGE_BEGIN)?idx:idx+1;if(c==="{"){this.add([t,{v:"}",isDelimiter:true,isNew:true}],idx);}else{this.add([t],idx);}}ew=itws[idx];RANGE.collapseOnNode(ew.domNode,false);}else{so=rInfo.startOffset;if(ew.isDelimiter()){aw=itws[(edge===EDGE.EDGE_BEGIN)?idx-1:idx+1];if(aw&&!aw.isDelimiter()){ew=aw;so=(edge===EDGE.EDGE_BEGIN)?ew.length():0;}}if(!ew.isDelimiter()){ew.spliceContent(so,0,c);RANGE.collapseOnTextNode(ew.domNode,so+1);}else{this.add([{v:c,isNew:true}],(edge===EDGE.EDGE_BEGIN)?idx:idx+1);ew=itws[(edge===EDGE.EDGE_BEGIN)?idx:idx+1];RANGE.collapseOnNode(ew.domNode,false);}}}});}());