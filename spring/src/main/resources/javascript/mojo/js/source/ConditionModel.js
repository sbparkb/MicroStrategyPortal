(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.Obj","mstrmojo.string","mstrmojo.hash","mstrmojo.expr","mstrmojo.mstr.EnumNodeDimty");var A=mstrmojo.array,E=mstrmojo.expr,ET=E.ET,TP=E.TP,DMT=mstrmojo.mstr.EnumNodeDimty,ET2TGT=E.ET2TGT,ET2COND=E.ET2COND,MTP=mstrmojo.meta.TP;function _updateFn(me,fnItem){var did=(fnItem&&fnItem.did)?fnItem.did.split(E.FN_SEP):null,fnt=did&&parseInt(did[0],10),fn=did&&parseInt(did[1],10),et=me.et;me.fnt=fnt;me.fn=fn;if(et!=ET.AE&&E.fn_List(fn,fnt)){me.et=ET.AL;me.a2=null;me.cs=null;}else{if(et==ET.AL&&!E.fn_List(fn,fnt)){me.et=ET.AQ;me.cs=null;}else{if(et==ET.MC&&!E.fn_AC_MC(fn,fnt)){me.et=ET.MQ;me.m2=null;}else{if(et==ET.AC&&!E.fn_AC_MC(fn,fnt)){me.et=ET.AQ;me.a2=null;}}}}switch(fn){case E.FN.IS_NULL:case E.FN.IS_NOT_NULL:me.a2=null;me.a3=null;me.fm2=null;me.fm3=null;me.m2=null;me.m3=null;me.cs=null;break;case E.FN.BETWEEN:case E.FN.NOT_BETWEEN:break;default:me.a3=null;me.fm3=null;me.m3=null;while(me.cs&&me.cs.length>1){me.cs.pop();}}}function _setCst(me,idx,v){var raiseEvent=true,_midx=2+idx;switch(v.t){case TP.PROMPT:var cs=me.cs,c;if(!cs){cs=[];me.cs=cs;}cs[idx]={};c=cs[idx];c.p=v;me["a"+_midx]=null;me["m"+_midx]=null;switch(me.et){case ET.AC:me.et=ET.AQ;break;case ET.MC:me.et=ET.MQ;break;}break;case TP.METRIC:me["a"+_midx]=null;me.cs=null;me.et=ET.MC;me["m"+_midx]=v;break;case TP.ATTR:me["m"+_midx]=null;me.cs=null;me.et=ET.AC;me["a"+_midx]=v;me["fm"+_midx]=null;break;default:me["a"+_midx]=null;me["m"+_midx]=null;var cs=me.cs;if(!cs){cs=[];me.cs=cs;}if("did" in v){me["a"+_midx]=null;me["fm"+_midx]=null;me["m"+_midx]=null;if(cs[idx]&&cs[idx].p){cs[idx].p=null;}}else{if(v&&v.v!=null){cs[idx]=v;}else{if(cs[idx]){cs=cs.splice(idx,1);}}raiseEvent=false;}if(!v.skipET){switch(me.et){case ET.MC:me.et=ET.MQ;break;case ET.AC:me.et=ET.AQ;break;case ET.AL:if(!("did" in v)&&v.v){var ca,dtp=v.dtp,cs=[];ca=v.v.split(mstrConfig.listSep);for(var i=0,len=ca.length;i<len;i++){cs.push({v:mstrmojo.string.trim(ca[i]),dtp:dtp});}me.cs=cs;}break;}}}return raiseEvent;}var REQ={};REQ[ET.AQ]={target:1,fm:1,fn:1,cs:1};REQ[ET.AL]={target:1,fm:1,fn:1,cs:1};REQ[ET.AE]={target:1,fn:1,es:1};REQ[ET.AC]={target:1,a2:1,a3:1,fm:1,fm2:1,fm3:1,fn:1};REQ[ET.MQ]={target:1,fn:1,cs:1,dmy:1};REQ[ET.MC]={target:1,fn:1,m2:1,m3:1,dmy:1};REQ[ET.F]={target:1};REQ[ET.R]=REQ[ET.F];REQ[ET.XML]={target:1};var _isV=function(v){return v!==null&&v!==undefined;};var _completed=function(me){if(!me||!_isV(me.et)){return false;}var _c=true,r=REQ[me.et],cs=me.cs,i;_c=_c&&(!r.target||me[ET2TGT[me.et]]);_c=_c&&(!r.fm||me.fm);_c=_c&&(!r.fn||_isV(me.fn));var cstCont=E.fnCstCount(me.fn,me.fnt);if(_c&&r.cs){for(i=0;i<cstCont;i++){_c=_c&&cs&&_isV(cs[i]);}}if(_c){var tgt2=[ET2TGT[me.et],"fm"];for(var ti=0;ti<2;ti++){for(i=0;i<cstCont;i++){var fn=tgt2[ti]+(2+i);_c=_c&&(!r[fn]||me[fn]);}}}_c=_c&&(!r.es||me.es&&(me.es.length>0));var dmts=me.dimtyTypes;_c=_c&&(!r.dmy||dmts[DMT.NodeDimtyUnspecified]||dmts[DMT.NodeDimtyNone]||(dmts[DMT.NodeDimtyOutputLevel]&&me.dmy&&me.dmy.uts&&(me.dmy.uts.length>0)));return _c;};mstrmojo.ConditionModel=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.ConditionModel",completed:false,init:function(props){if(this._super){this._super(props);}this._updateCompleted();},edit:function(n,v){var vWas=this[n],re=true;this.etWas=this.et;switch(n){case"not":v=!!(v&&v.did===E.FN.NOT);vWas=!!this.not;if(v===vWas){return ;}this.not=!!v||null;break;case"target":var et=this.et;if(v){switch(v[MTP]){case TP.ATTR:case TP.CONS:vWas=this.a;if(et!==ET.AQ&&et!==ET.AE){this.et=ET.AQ;this.m=null;this.m2=null;this.m3=null;this.r=null;this.f=null;}if(et!==ET.AE){this.fn=null;this.fnt=null;}this.fm=null;this.fm2=null;this.fm3=null;this.cs=null;break;case TP.METRIC:vWas=this.m;if((et!==ET.MQ)&&(et!==ET.MC)){this.et=ET.MQ;this.fm=null;this.fm2=null;this.fm3=null;this.fn=null;this.fnt=null;this.a=null;this.a2=null;this.a3=null;this.r=null;this.f=null;this.cs=null;this.dmt=DMT.NodeDimtyUnspecified;}this.m2=null;break;case TP.REPORT:vWas=this.r;if(et!==ET.R){this.et=ET.R;this.fm=null;this.fm2=null;this.fm3=null;this.fn=null;this.fnt=null;this.a=null;this.a2=null;this.a3=null;this.m=null;this.m2=null;this.m3=null;this.f=null;}break;case TP.FILTER:vWas=this.f;if(et!==ET.F){this.et=ET.F;this.fm=null;this.fm2=null;this.fm3=null;this.fn=null;this.fnt=null;this.a=null;this.a2=null;this.a3=null;this.m=null;this.m2=null;this.m3=null;this.r=null;}break;case TP.PROMPT:vWas=this.prms&&this.prms[0];if(et!==ET.XML){this.et=ET.XML;this.fm=null;this.fm2=null;this.fm3=null;this.fn=null;this.fnt=null;this.a=null;this.a2=null;this.a3=null;this.m=null;this.m2=null;this.m3=null;this.r=null;this.f=null;}break;}}this.es=null;this[ET2TGT[this.et]]=v;break;case"fm":if(v&&v[MTP]==="fn"){this.et=ET.AE;this.fm=null;_updateFn(this,v);}else{this.fm=v;if(v&&(this.et==ET.AE)){this.et=ET.AQ;}this.fnt=null;this.fn=null;this.cs=null;this.a2=null;this.fm2=null;}break;case"fm2":case"fm3":this[n]=v;break;case"fn":_updateFn(this,v);break;case"es":var es=this.es;if(v&&v.removed&&es){A.removeItems(es,v.itemIdField,v.removed);}if(v&&v.added){if(!es){es=v.added.concat();this.es=es;}else{A.insert(es,es.length,v.added);}}break;case"c0":re=_setCst(this,0,v);break;case"c1":re=_setCst(this,1,v);break;case"dmy":var dmy=this.dmy;if(!dmy){dmy={cc:true,fres:true,uts:[]};this.dmy=dmy;}var uts=dmy&&dmy.uts;if(!uts){uts=[];dmy.uts=uts;this.dmt=DMT.NodeDimtyOutputLevel;}var CUSTOM={};CUSTOM[E.TP.ATTR]=true;CUSTOM[E.TP.DIM]=true;if(v&&v.removed){var toRem=[],bRem=false,toRemCust=[],bRemCust=false;for(var r=0,rArr=v.removed,rLen=rArr.length;r<rLen;r++){var ur=rArr[r],b=ur[MTP] in CUSTOM;if(b){bRemCust=true;}else{bRem=true;}var arrRem=b?toRemCust:toRem;arrRem.push(ur);}if(bRem){A.removeItems(uts,"did",toRem);}if(bRemCust){var map={};for(var u=0,uLen=uts&&uts.length;u<uLen;u++){var uo=uts[u];if(uo&&uo.utgt){map[uo.utgt.did]=u;}}var idxs=[];for(var c=0,cLen=toRemCust.length;c<cLen;c++){var idx=map[toRemCust[c].did];if(idx>-1){idxs.push(idx);}}idxs.sort(A.numSorter);for(var i=idxs.length-1;i>-1;i--){uts.splice(idxs[i],1);}}}if(v&&v.added){var toAdd=[],DD=E.DMY_TP.DIM,DA=E.DMY_TP.ATTR;for(var a=0,aArr=v.added,aLen=aArr.length;a<aLen;a++){var ua=aArr[a];toAdd.push((ua[MTP] in CUSTOM)?{utgt:ua,utp:ua[MTP]===TP.DIM?DD:DA,agg:1,flt:2,gb:true,rps:0,n:ua.n}:ua);}A.insert(uts,uts.length,toAdd);}break;}this._updateCompleted();if(re){this.raiseEvent({name:"edit",prop:n,value:v,valueWas:vWas});}},get:function gt(){var ps=ET2COND[this.et]||[];ps.push("et");return mstrmojo.hash.copyProps(ps,this);},_updateCompleted:function(){this.set("completed",_completed(this));}});})();