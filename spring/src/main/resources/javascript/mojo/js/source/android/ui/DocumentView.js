(function(){mstrmojo.requiresCls("mstrmojo.android.ui.ViewSlider","mstrmojo._HasBuilder","mstrmojo._IsRwDocument","mstrmojo.android.ui.LayoutSelector","mstrmojo.Label","mstrmojo.hash","mstrmojo.array","mstrmojo.func","mstrmojo.android.EnumOrientationTypes");mstrmojo.requiresDescs(4174);var $ARR=mstrmojo.array,$AFE=$ARR.forEach,$HASH=mstrmojo.hash,EnumOrientationTypes=mstrmojo.android.EnumOrientationTypes,OR_PORTRAIT=EnumOrientationTypes.PORTRAIT,OR_LANDSCAPE=EnumOrientationTypes.LANDSCAPE;function isInfoWindowLayout(l){return(l.defn.iw!==undefined&&l.defn.iw);}function getLoadingPlaceholder(view){return new mstrmojo.Label({cssClass:"pre-loader",n:view.n,k:view.k,isPreloader:true});}function updateLayoutSelector(currentLayout,noItems){var layoutSelector=this.layoutSelector,supportedLayouts=this.getSupportedLayouts();if(!noItems){layoutSelector.set("items",supportedLayouts);}layoutSelector.setCurrentTab($ARR.find(supportedLayouts,"k",currentLayout.k));layoutSelector.set("visible",!!noItems);if(noItems){layoutSelector.initiateFade();}}function findNextLayout(index,direction){var allLayouts=this._layouts,orientation=mstrMobileApp.getOrientation(),wrapIdx=allLayouts.length-1-index,hasWrapped=false,layout;var layouts=allLayouts.slice(index+1);if(index){layouts=layouts.concat(allLayouts.slice(0,index));}if(!direction){layouts.reverse();wrapIdx=index;}$AFE(layouts,function(l,idx){hasWrapped=(idx>=wrapIdx);if(((l.defn.or&orientation)>0)&&!isInfoWindowLayout(l)){layout=l;return false;}});if(!layout){return null;}return{wrap:hasWrapped,layout:layout};}function hasDifferentViewsOrientation(){var views=this.model.defn.views,len=(views&&views.length)||0,i;if(len){var orientation=views[0].orientation;for(i=1;i<len;i++){if(orientation!==views[i].orientation){return true;}}}return false;}function checkLayoutOrientation(key){var layouts=this._layouts,orientationInfo=this._orientationInfo;if(!orientationInfo){orientationInfo=this._orientationInfo={};var portraitInfo=orientationInfo[OR_PORTRAIT]={lyts:[]};var landscapeInfo=orientationInfo[OR_LANDSCAPE]={lyts:[]};$ARR.forEach(layouts,function(layout){var or=layout.defn.or,info=orientationInfo[or];if(!isInfoWindowLayout(layout)&&info!==undefined){info.lyts.push(layout.k);}});if(portraitInfo.lyts.length||landscapeInfo.lyts.length){orientationInfo.specific=true;}}var selectedLayout=layouts[$ARR.find(layouts,"k",key)],selectedOrientation=selectedLayout.defn.or,selectedOrInfo=orientationInfo[selectedOrientation],deviceOrientation=mstrMobileApp.getOrientation(),rtn={isSupported:true,currentLayout:selectedLayout,specific:!!orientationInfo.specific};if(isInfoWindowLayout(selectedLayout)||((selectedOrientation&deviceOrientation)===0)){rtn.isSupported=false;var deviceOrInfo=orientationInfo[deviceOrientation];if(selectedOrInfo===undefined||deviceOrInfo===undefined){return rtn;}var targetLayoutKey=deviceOrInfo.lyts[$ARR.indexOf(selectedOrInfo.lyts,key)];if(targetLayoutKey){rtn.newLayout=layouts[$ARR.find(layouts,"k",targetLayoutKey)];}else{var lastLayout=deviceOrInfo.last;if(lastLayout){rtn.newLayout=lastLayout;}else{$ARR.forEach(layouts,function(layout){if(!isInfoWindowLayout(layout)&&(layout.defn.or&deviceOrientation)>0){rtn.newLayout=layout;return false;}});}}selectedOrInfo.last=selectedLayout;if(!rtn.newLayout){rtn.isStale=true;}}else{rtn.needNewLayout=hasDifferentViewsOrientation.call(this);}return rtn;}function getScrollLayoutInfo(touch){var nextLayoutInfo=findNextLayout.call(this,$ARR.find(this._layouts,"k",this.model.getCurrentLayoutKey()),(touch.delta.x<0));return(nextLayoutInfo&&!nextLayoutInfo.wrap)?nextLayoutInfo:null;}function getImageWatermark(){var model=this.model,watermark=model&&model.wm;if(watermark&&watermark.tp===3&&watermark.imgSrc){return watermark;}return null;}function insertWatermark(wm){var img=document.createElement("img"),style=img.style;this.watermarkNode=img;style.position="absolute";style.top=0;style.left=0;style.visibility="hidden";var me=this;img.onload=function(){var iw=img.width,ih=img.height;if(wm.imgScale<=0){var dn=me.domNode;if(dn){img.width=dn.clientWidth;img.height=dn.clientHeight;}}else{var r=wm.imgScale/100;img.width=iw*r;img.height=ih*r;}img.style.visibility="visible";};this.domNode.insertBefore(img,this.domNode.firstChild);var ds=this.model.getDataService();var imgSrcUrl=wm&&wm.imgSrc;img.src=(imgSrcUrl&&ds&&ds.getDocImage&&ds.getDocImage(imgSrcUrl))||imgSrcUrl;}function tabSelected(item){this.parent.showLayout(item);}mstrmojo.android.ui.DocumentView=mstrmojo.declare(mstrmojo.android.ui.ViewSlider,[mstrmojo._HasBuilder,mstrmojo._IsRwDocument],{scriptClass:"mstrmojo.android.ui.DocumentView",postBuildRendering:function postBuildRendering(){var rtn=this._super(),watermark=getImageWatermark.call(this);if(watermark){insertWatermark.call(this,watermark);}return rtn;},buildChildren:function buildChildren(noAddChildren){this._layouts=this._super(true);},beforeViewHidden:function beforeViewHidden(isBack){this._stale=true;var lyt=this.getCurrentLayout();if(lyt&&lyt.beforeViewHidden){lyt.beforeViewHidden(isBack);}},getViewController:function getViewController(view){return null;},unrender:function unrender(ignoreDom){delete this._stale;this._super(ignoreDom);},reloadLayout:function reloadLayout(){var view=this.getCurrentView(),id=this.id,params={layoutKey:view.k,reload:true,executionOrientation:mstrMobileApp.getOrientation()};this.getNewLayout(params,this._layouts,true,{success:function(newLayout){var doc=mstrmojo.all[id];doc.replaceView(newLayout,view,true);doc.resetSliderNodes();}});},rootOrientationChange:function rootOrientationChange(){if(this._stale){return ;}var watermark=getImageWatermark.call(this);if(watermark&&watermark.imgScale<=0){var watermarkNode=this.watermarkNode;watermarkNode.width=parseInt(this.width,10);watermarkNode.height=parseInt(this.height,10);}var view=this.getCurrentView();if(view.isPreloader){return ;}var layoutsCollection=this._layouts,viewKey=view.k,layoutInfo=checkLayoutOrientation.call(this,viewKey),layout=layoutInfo.newLayout;if(layoutInfo.isStale){return ;}if(layoutInfo.specific){updateLayoutSelector.call(this,view);}var needNewDocumentView=!!layoutInfo.needNewLayout,needNewOrientationLayout=!needNewDocumentView&&(!layoutInfo.isSupported&&layout),needNewFitLayout=!needNewOrientationLayout&&(this.model.zt&&!view.isFullScreenWidget);if(needNewDocumentView||needNewOrientationLayout||needNewFitLayout){mstrApp.closeAllDialogs();var id=this.id,me=this,params={layoutKey:viewKey,reload:true,executionOrientation:mstrMobileApp.getOrientation()},fnSuccess=function(newLayout){mstrmojo.all[id].replaceView(newLayout,me.getCurrentView());me.resetSliderNodes();};if(needNewOrientationLayout){view=this.replaceView(getLoadingPlaceholder(layout),view,true);params.layoutKey=layout.k;delete params.reload;fnSuccess=mstrmojo.func.composite([function(newLayout){updateLayoutSelector.call(mstrmojo.all[id],newLayout);},fnSuccess]);}this.getNewLayout(params,layoutsCollection,true,{success:fnSuccess});}this.controller.generateActionToolbar();},onRender:function onRender(){if(!this.layoutSelector){this.addChildren([{scriptClass:"mstrmojo.android.ui.LayoutSelector",slot:"overlayNode",alias:"layoutSelector",visible:false,tabSelected:tabSelected}]);}var lyt=this.getCurrentLayout();var layoutInfo=checkLayoutOrientation.call(this,this.model.getCurrentLayoutKey()),currentLayout=layoutInfo.currentLayout,me=this,fnShow=function(lyt){if(lyt&&!lyt.domNode){me.switchView(lyt);}else{me.stackViews(lyt.slot);}return lyt;};if(layoutInfo.needNewLayout&&this.controller.isBack){fnShow(currentLayout);var params={layoutKey:currentLayout.k,reload:true,executionOrientation:mstrMobileApp.getOrientation()};this.getNewLayout(params,this._layouts,true,{success:function(newLayout){me.replaceView(newLayout,currentLayout);}});}else{if(layoutInfo.isSupported){fnShow(currentLayout);updateLayoutSelector.call(this,currentLayout);}else{var layout=layoutInfo.newLayout;if(layout){currentLayout.defn.loaded=false;layout=fnShow(this.selectLayout(getLoadingPlaceholder(layout),false));this.getNewLayout({layoutKey:layout.k},this._layouts,true,{success:function(newLayout){updateLayoutSelector.call(me,newLayout);me.replaceView(newLayout,layout);}});}else{this._ignoreOrientation=true;fnShow(currentLayout);}}}},showLayout:function showLayout(layout){var key=layout.k,doc=this;if(key!==this.model.getCurrentLayoutKey()){var params={layoutKey:key};if(hasDifferentViewsOrientation.call(this)){params.executionOrientation=mstrMobileApp.getOrientation();params.reload=true;}this.getNewLayout(params,this._layouts,true,{success:function(newLayout){doc.switchView(newLayout);}});return true;}return false;},afterSwitch:function afterSwitch(layout){this._super(layout);this.selectLayout(layout,(layout.k!==this.model.getCurrentLayoutKey()));},selectLayout:function selectLayout(layout,updateServer,callback){var _layout=this._super(layout,updateServer,callback);this.controller.getPageByTree(true);if(!layout.defn||!layout.defn.iw){updateLayoutSelector.call(this,_layout,true);}return _layout;},replaceLayout:function replaceLayout(oldLayout,newLayoutNode){var layouts=this._layouts||[],idx=$ARR.find(layouts,"k",oldLayout.k);if(idx>=0){oldLayout.unrender();oldLayout.destroy();}var c=this.builder.build([newLayoutNode],this.model)[0];if(idx>=0){layouts[idx]=c;}else{layouts.push(c);}this._layouts=layouts;return c;},onLayoutRebuilt:function onLayoutRebuilt(layout){this.replaceView(layout,this.getCurrentView());},canScroll:function canScroll(touch){return !!getScrollLayoutInfo.call(this,touch);},beginScroll:function beginScroll(touch,view){if(this.isAnimating()){return false;}delete this._scrollInfo;if(!view){var layouts=this._layouts,nextLayoutInfo=getScrollLayoutInfo.call(this,touch),id=this.id;if(!nextLayoutInfo){return ;}view=nextLayoutInfo.layout;var orientation=mstrMobileApp.getOrientation(),docLayout=view.docLayout,needNewLayout=hasDifferentViewsOrientation.call(this)||(this.model.zt&&docLayout&&orientation!==docLayout.defn.lastOrientation);if(!view.defn.loaded||needNewLayout){view=getLoadingPlaceholder(view);var params={layoutKey:view.k};if(needNewLayout){params.executionOrientation=orientation;params.reload=true;}this.getNewLayout(params,layouts,false,{success:function(newLayout){var me=mstrmojo.all[id],scrollInfo=me._scrollInfo;if(scrollInfo){scrollInfo.view=newLayout;}me.replaceView(newLayout,view);}});}}if(view){this._super(touch,view);}},scrollStarted:function scrollStarted(){var layoutSelector=this.layoutSelector;layoutSelector.set("visible",true);layoutSelector.enterScroll();},scrollProgress:function scrollProgress(info,delta){this.layoutSelector.scroll(delta);},scrollStopped:function scrollStopped(info,isComplete){var layoutSelector=this.layoutSelector,idx=layoutSelector.selectedIndex;if(isComplete){idx+=(info.isForward?1:-1);}layoutSelector.exitScroll(idx);},scrollCanceled:function scrollCanceled(info){this._super(info);var layout=info.oldView;this.model.getDataService().setCurrentDocLayout(layout.k);this.selectLayout(layout,false);this.layoutSelector.initiateFade();},scrollComplete:function scrollComplete(info){this._super(info);var layout=info.newView;this.selectLayout(layout,(layout.k!==this.model.getCurrentLayoutKey()));this.controller.generateActionToolbar();},renderInfoWindow:function renderInfoWindow(infoWindow){infoWindow.autoCloses=infoWindow.locksHover=false;if(mstrApp.isTablet()){this._super(infoWindow);return ;}var controller=this.controller,rootCtrl=controller.rootCtrl,oldTitle=rootCtrl.getTitle(),fnUpdateTitle=function(title){rootCtrl.updateContent(null,title);},shouldReleaseOrientation=false;this.fullScreenInfoWindow=true;controller.generateActionToolbar();var id=this.id;mstrApp.showDialog({cssClass:"FSInfoWindow",children:infoWindow,resizeDialog:function resizeDialog(){var rootView=mstrApp.rootView,availableSpace=rootView.getContentDimensions(),ens=this.editorNode&&this.editorNode.style,infoWindow=this.children[0],iwn=infoWindow&&infoWindow.infoNode;if(ens){ens.top=(parseInt(rootView.getBrowserDimensions().h,10)-availableSpace.h+3)+"px";ens.left="5px";}if(iwn){var iwns=iwn.style;iwns.height=availableSpace.h+"px";iwns.width=availableSpace.w+"px";mstrmojo.all[infoWindow.psId].setInfoWindowDimensions(availableSpace);}},onClose:function onClose(){fnUpdateTitle(oldTitle);delete mstrmojo.all[id].fullScreenInfoWindow;controller.generateActionToolbar();if(shouldReleaseOrientation){mstrMobileApp.releaseOrientation();}var infoWindow=this.children[0];infoWindow.model.raiseEvent({name:"infoWindowClosed",psKey:infoWindow.psKey});if(infoWindow&&infoWindow.clearAnchorHilites){infoWindow.clearAnchorHilites();}},positionDialog:mstrmojo.emptyFn});var panelStack=infoWindow.children[0];fnUpdateTitle(panelStack.getTitle());if(mstrMobileApp.getLockedOrientation()===0){mstrMobileApp.lockOrientation(mstrMobileApp.getOrientation());shouldReleaseOrientation=true;}panelStack.attachEventListener("titleChange",this.id,function(evt){fnUpdateTitle(evt.value);});},updateInfoWindowPS:function updateInfoWindowPS(psID,psKey){if(!mstrApp.isTablet()){mstrmojo.all[psID].setInfoWindowDimensions(mstrApp.getContentDimensions());}},destroy:function destroy(ignoreDom){$AFE(this._layouts,function(lyt){lyt.destroy(ignoreDom);});this.builder.destroy();this._super(ignoreDom);},getLayouts:function(){return this._layouts;},getSelectedLayoutWidget:function getSelectedLayout(){return this.getCurrentView();},getNewLayout:function getNewLayout(params,layouts,isSelected,callback){var controller=this.controller,desired;if(controller&&controller.getDesiredElements){desired=controller.getDesiredElements();if(desired){params.desiredElements=desired;}}callback.success=mstrmojo.func.composite([callback.success,function(){controller.generateActionToolbar();}]);$HASH.forEach(this.ifwMap,function(infoWindow){if(infoWindow.visible){infoWindow.close();}});return this._super(params,layouts,isSelected,callback);},unloadLayouts:function unloadLayouts(keys,gbFlag){var layouts=this._layouts,curKey=this.model.getCurrentLayoutKey(),i,cnt=(layouts&&layouts.length)||0,lyt,gbys,defn,iKey;for(i=0;i<cnt;i++){lyt=layouts[i];defn=lyt.defn;if(lyt.k!==curKey&&defn&&defn.loaded){if(gbFlag){gbys=(lyt.gb&&lyt.gb.groupbys);if(gbys&&gbys.length){defn.loaded=false;}}else{if(keys){for(iKey=0;iKey<keys.length;iKey++){if(lyt.k===keys[iKey]){defn.loaded=false;break;}}}else{defn.loaded=false;}}}}},getSupportedLayouts:function getSupportedLayouts(){var layouts=[],orientation=mstrMobileApp.getOrientation();$AFE(this._layouts,function(l){if(((l.defn.or&orientation)>0)&&(!isInfoWindowLayout(l))){layouts.push(l);}});return layouts;},getCurrentLayout:function getCurrentLayout(){var layouts=this._layouts;return layouts[$ARR.find(layouts,"k",this.model.getCurrentLayoutKey())];},getCaptureDimensions:function getCaptureDimensions(){var layout=this.getCurrentLayout();return layout.getCaptureDimensions&&layout.getCaptureDimensions();},closeInfoWindowsOnTablet:function closeInfoWindowsOnTablet(){if(mstrApp.isTablet()){$HASH.forEach(this.ifwMap,function(infoWindow){if(infoWindow.visible){infoWindow.closeOnTablet();}});}}});}());