(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo._HasPopup","mstrmojo._HasOwnAvatar","mstrmojo.css","mstrmojo.dom","mstrmojo.vi.ui.TitleBar","mstrmojo.ui.menus.MenuConfig","mstrmojo.ui.menus.ToolbarConfig");mstrmojo.requiresDescs(629,1388,11477,11478);var DOM=mstrmojo.dom;var STR=mstrmojo.string;var EMPTYTITLE="emptyTitle";var dropOnLeft=function(e,tgtNode){var mouseX=e.clientX,pos=mstrmojo.dom.position(tgtNode);return mouseX<pos.x+tgtNode.offsetWidth/2;};var isDragDataValid=function isDragValid(ctxt){var src=ctxt&&ctxt.src,data=src&&src.data;return data&&data.id&&mstrmojo.all[data.id];};mstrmojo.home.ui.Card=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._HasPopup,mstrmojo._HasOwnAvatar],{scriptClass:"mstrmojo.home.ui.Card",markupString:'<div id="{@id}" class="mstrmojo-Card {@cssClass}" style="{@cssText} {@domNodeCssText}" mstrAttach:mouseover,mouseout,mouseup,click,contextmenu><div class="mstrmojo-Card-container"><div class="mstrmojo-Card-titlebar" style="{@titlebarNodeCssText}"></div><div class="mstrmojo-Card-content"></div><div class="mstrmojo-DND-mask"></div></div></div>',markupSlots:{titlebarNode:function(){return this.domNode.firstChild.firstChild;},containerNode:function(){return this.domNode.firstChild.childNodes[1];},maskNode:function(){return this.domNode.firstChild.lastChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,ontopChange:mstrmojo.Widget.topMarkupMethod,onleftChange:mstrmojo.Widget.leftMarkupMethod,onzIndexChange:function(){this.domNode.style.zIndex=this.zIndex||1;},ondraggableChange:function(){},ontitleChange:function(){if(this.hasRendered){mstrmojo.css.toggleClass(this.domNode,EMPTYTITLE,STR.isEmpty(this.title));}}},layoutConfig:{h:{titlebarNode:"auto",containerNode:"100%"},w:{titlebarNode:"100%",containerNode:"100%"},xt:true},titleBarCss:"",parent:null,model:null,title:"",titleBar:null,bubbleMouseOver:true,draggable:true,onClickTitleBar:mstrmojo.emptyFn,init:function init(props){this._super(props);this.cssClass=this.cssClass+" "+this.getTitleBarCss();this.addChildren([this.getTitleBarCfg()],0);},preBuildRendering:function preBuildRendering(){this.generateToolbar();return this._super();},postBuildRendering:function postBuildRendering(){this.titleBar.setToolbarVisibility(false);return this._super();},generateToolbar:function generateToolbar(){var titleBar=this.titleBar,toolbarCfg=titleBar.toolbarCfg;if(toolbarCfg){toolbarCfg.destroy();}titleBar.set("toolbarCfg",this.updateToolbar(new mstrmojo.ui.menus.ToolbarConfig()));},getTitleBarCfg:function getTitleBarCfg(){return{scriptClass:"mstrmojo.vi.ui.TitleBar",slot:"titlebarNode",alias:"titleBar",title:this.title,editTitleOnDoubleClick:false,close:function(){this.parent.deleteSelf();},getLayoutOffsets:function getLayoutOffsets(){return{h:1,w:0};},onclick:this.onClickTitleBar};},getTitleBarCss:function getTitleBarCss(){return STR.isEmpty(this.title)?EMPTYTITLE:"";},getDisplayName:function getDisplayName(){return this.title;},ontitleChange:function ontitleChange(){this.titleBar.set("title",this.title);if(this.title!==this.cardDef.title){this.updateCardDef({title:this.title});}},oncontextmenu:function oncontextmenu(evt){if(this.shouldShowCustomizeContextMenu(evt)){var menuConfig=this.addContextMenuItems(new mstrmojo.ui.menus.MenuConfig({position:mstrmojo.dom.getMousePosition(evt.e,evt.hWin),isHostedWithin:false}),evt);if(menuConfig.hasMenuItems()){DOM.preventDefault(window,evt.e);this.openPopup(menuConfig.newInstance());}}evt.cancel();},switchToEditMode:function switchToEditMode(){},shouldShowCustomizeContextMenu:function(evt){var target=evt.getTarget(),nodeName=target&&target.nodeName.toLowerCase();return nodeName&&!(nodeName==="textarea"||(nodeName==="input"&&target.type.toLowerCase()==="text"));},addContextMenuItems:function addContextMenuItems(menuCfg,evt){return menuCfg;},updateToolbar:function updateToolbar(cfg){var me=this;var view=this.parent,controller=view.controller;var corners=cfg.ENUM_CORNERS;cfg.setAlignment(corners.BOTTOM_RIGHT,corners.TOP_RIGHT);cfg.isHostedWithin=false;cfg.addSeparator();cfg.addPopupMenuItem(mstrmojo.desc(531,"Add"),this.id,function(){return controller.getAddMenuCfg();},"mstrmojo-CardMenu-add");if(this.getEditorConfig){this.getEditorConfig(this.cardDef,cfg);}cfg.addMenuItem(mstrmojo.desc(629,"Delete"),"cls",this.deleteSelf.bind(this));return cfg;},deleteSelf:function deleteSelf(){var card=this,view=card.parent;view.removeCard(card);},onmouseover:function onmouseover(evt){if(!mstrApp.isInteractive()){return ;}if(!this.bubbleMouseOver){evt.cancel();}var tmr=this._tmr;if(tmr){window.clearTimeout(tmr);delete this._tmr;}this.titleBar.setToolbarVisibility(true);},onmouseout:function onmouseout(){var id=this.id;this._tmr=window.setTimeout(function(){var card=mstrmojo.all[id];if(card){card.titleBar.setToolbarVisibility(false);}},200);},dropZone:true,allowDrop:function(ctxt){return ctxt.src.data&&ctxt.src.data.id!==this.id;},getDragData:function(){return{id:this.id};},isDragValid:function isDragValid(context){var node=context&&context.src.node;return context&&context.src&&context.src.data&&(mstrmojo.dom.contains(this.titlebarNode,node,true));},createAvatar:function(){var cloneNode=this.domNode.cloneNode(true);cloneNode.id="homeCardAvatar";cloneNode.style.cssText="z-index:1999; position:absolute; transition: none;";mstrmojo.css.removeClass(cloneNode,"drag");mstrmojo.css.addClass(cloneNode,"avatar");return cloneNode;},ondragstart:function(ctxt){if(!(ctxt&&ctxt.src&&ctxt.src.data)){return false;}this._super(ctxt);if(isDragDataValid(ctxt)){var view=this.parent;mstrmojo.css.addClass(view.domNode,"dragging");mstrmojo.css.addClass(this.domNode,"drag");}},ondragenter:function(ctxt){if(isDragDataValid(ctxt)){mstrmojo.css.addClass(this.domNode,"dragover");}},ondragover:function(ctxt){if(isDragDataValid(ctxt)){mstrmojo.css.toggleClass(this.domNode,"right",!dropOnLeft(ctxt.tgt.e,this.domNode));}},ondragleave:function(ctxt){mstrmojo.css.removeClass(this.domNode,["dragover","right"]);},ondragend:function(ctxt){this._super(ctxt);mstrmojo.css.removeClass((ctxt.tgt.widget||this).domNode,["dragover","right"]);mstrmojo.css.removeClass(this.domNode,["drag"]);var view=this.parent;window.setTimeout(function(){mstrmojo.css.removeClass(view.domNode,"dragging");},10);},ondrop:function ondrop(ctxt){var tgt=ctxt.tgt.widget.domNode,cardsContainer=tgt.parentNode,srcId=ctxt.src.data.id,widget=mstrmojo.all[srcId];if(!isDragDataValid(ctxt)){return ;}var srcNode=widget.domNode;var onLeft=dropOnLeft(ctxt.tgt.e,ctxt.tgt.node);if(onLeft){cardsContainer.insertBefore(srcNode,tgt);}else{if(tgt.nextSibling){cardsContainer.insertBefore(srcNode,tgt.nextSibling);}else{cardsContainer.appendChild(srcNode);}}var card=mstrmojo.all[srcId];if(card.htmlbox){card.htmlbox.refresh();}this.parent.model.switchCards(mstrmojo.all[srcId].cardDef,this.cardDef,onLeft);},updateCardDef:function updateCardDef(cardDef){this.cardDef=mstrmojo.hash.copy(cardDef,this.cardDef);this.parent.model.updateCard(this.cardDef);}});}());