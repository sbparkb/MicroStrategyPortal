(function(){mstrmojo.requiresCls("mstrmojo.Button","mstrmojo.DataGrid","mstrmojo.dom","mstrmojo.Editor","mstrmojo.RadioButton","mstrmojo.architect.ui.SQLInputBox","mstrmojo.warehouse.EnumNamespaceMode","mstrmojo.warehouse.ui.AvailableTablesTree","mstrmojo.warehouse.ui.NameSpacePullDown");var $A=mstrmojo.array,$H=mstrmojo.hash,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,catalogModeSQL="1",catalogModeODBC="2",cacheModeFull="0",cacheModeTables="2",cacheModeNone="4",nsModeAll=mstrmojo.warehouse.EnumNamespaceMode.ALL,nsModeCurrent=mstrmojo.warehouse.EnumNamespaceMode.CURRENT,CSS_PREFIX="mstrmojo-ar-catSQL",STR_TITLE=mstrmojo.desc(12261,"Catalog Options"),STR_CATALOG_MODE=mstrmojo.desc(12262,"Catalog mode"),STR_SQL=mstrmojo.desc(12263,"Data source SQL"),STR_ODBC=mstrmojo.desc(12264,"ODBC calls"),STR_CACHING=mstrmojo.desc(8368,"Caching"),STR_CACHING_TABLES=mstrmojo.desc(12265,"Table names only"),STR_CACHING_FULL_CATALOG=mstrmojo.desc(12266,"Table and column names"),STR_CACHING_NONE=mstrmojo.desc(2057,"None"),STR_CACHING_NOT_GUARANTEED=mstrmojo.desc(12267,"Cannot guarantee caching when using non-default SQL"),STR_CLOSE=mstrmojo.desc(2177,"Close"),STR_NS=mstrmojo.desc(12268,"Namespaces"),STR_NS_ALL=mstrmojo.desc(3524,"All"),STR_NS_CURRENT=mstrmojo.desc(12269,"Current only"),STR_SQL_FULL=mstrmojo.desc(12270,"SQL statement to retrieve table and column names for this data source"),STR_SQL_TABLES=mstrmojo.desc(12271,"SQL statement to retrieve tables available in the data source"),STR_SQL_COLUMNS=mstrmojo.desc(12272,"SQL statement to retrieve columns for the selected tables"),STR_PREVIEW=mstrmojo.desc(3389,"Preview"),STR_APPLY=mstrmojo.desc(134,"Apply"),STR_APPLY_DEFAULT=mstrmojo.desc(12273,"Use default value"),sqlSectionTexts={full:STR_SQL_FULL,table:STR_SQL_TABLES,column:STR_SQL_COLUMNS};var OPEN_SIZE;var sqlSectionArray;function trimSQL(sql){return sql.replace(/[ \n\r\t]/g,"");}function addSQLSection(defaultSQLs,currentSQLs,type){var sqlSection=new mstrmojo.Box({alias:"sqlBox",cssClass:CSS_PREFIX+"-sqlBox",defaultSQL:"",useDefaultSQL:function useDefaultSQL(){return(trimSQL(this.defaultSQL)===trimSQL(this.currentSQL));},currentSQL:"",resize:function resize(){var sqlInputNode=this.sqlText.domNode,h=$DOM.position(sqlInputNode).h,t=sqlInputNode.offsetTop,w=$DOM.position(sqlInputNode).w,c=this.curtain;c.domNode.style.height=h+"px";c.domNode.style.width=w+"px";c.domNode.style.top=t+"px";},children:[{scriptClass:"mstrmojo.HBox",alias:"sqlHead",cssClass:"sqlSection-box",children:[{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"-sqlLabel",text:sqlSectionTexts[type]},{scriptClass:"mstrmojo.CheckBox",cssClass:CSS_PREFIX+"-check",alias:"sqlCheck",index:type,label:STR_APPLY_DEFAULT,oncheckedChange:function oncheckedChange(){var box=this.parent.parent,editor=box.parent.parent.parent,str;box.curtain.set("visible",this.checked);if(this.checked){box.sqlText.setSQLStatement(box.defaultSQL);}else{if(!editor.loadingPanel){switch(editor.options.cacheMode.value){case cacheModeFull:str=STR_CACHING_FULL_CATALOG;break;case cacheModeTables:if(this.index==="column"){return ;}str=STR_CACHING_TABLES;break;case cacheModeNone:return ;}mstrmojo.alert(STR_CACHING_NOT_GUARANTEED,undefined,STR_CACHING+": "+str);}}}}]},{scriptClass:"mstrmojo.architect.ui.SQLInputBox",cssClass:"mstrmojo-ar-sqlInput-inputbox visible "+CSS_PREFIX,alias:"sqlText"},{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"-curtain",alias:"curtain"}]});this.contents.rightPanel.addChildren([sqlSection]);var sqlInput=sqlSection.sqlText;$CSS.toggleClass(sqlInput.domNode,"full",(this.options.cacheMode.value===cacheModeFull));sqlSection.resize();sqlSection.defaultSQL=defaultSQLs[$A.find(defaultSQLs,"tp",type)].sql;sqlSection.currentSQL=currentSQLs[$A.find(currentSQLs,"tp",type)].sql;sqlInput.setSQLStatement(sqlSection.currentSQL);sqlSection.sqlHead.sqlCheck.checked=!sqlSection.useDefaultSQL();sqlSection.sqlHead.sqlCheck.set("checked",sqlSection.useDefaultSQL());return sqlSection;}function getSQL(defaultSQLs,currentSQLs,type,index){var editor=this,currentSQL,defaultSQL,sql;defaultSQL=defaultSQLs[$A.find(defaultSQLs,"tp",type)];currentSQL=currentSQLs[$A.find(currentSQLs,"tp",type)];sql=editor.contents.rightPanel.children[index].sqlText.getSQLStatement();if(sql===defaultSQL.sql){sql="";}currentSQL.sql=sql;return currentSQL;}function chooseSQLs(editor,nsMode,cacheMode,getCurrent){var currentSQLs,defaultSQLs;if((nsMode.value===nsModeAll)){currentSQLs=$H.cloneArray(editor.SQLStatements.currentSQLs.allNS);defaultSQLs=$H.cloneArray(editor.SQLStatements.defaultSQLs.allNS);if(cacheMode.value===cacheModeNone){if(editor.supportsNameSpaces){currentSQLs=$H.cloneArray(editor.SQLStatements.currentSQLs.currentNS);defaultSQLs=$H.cloneArray(editor.SQLStatements.defaultSQLs.currentNS);}}else{if(cacheMode.value===cacheModeTables){if(editor.supportsNameSpaces){var currentColSQL=editor.SQLStatements.currentSQLs.currentNS,defaultColSQL=editor.SQLStatements.defaultSQLs.currentNS;currentSQLs[$A.find(currentSQLs,"tp","column")]=currentColSQL[$A.find(currentColSQL,"tp","column")];defaultSQLs[$A.find(defaultSQLs,"tp","column")]=defaultColSQL[$A.find(defaultColSQL,"tp","column")];}}}}else{currentSQLs=$H.cloneArray(editor.SQLStatements.currentSQLs.currentNS);defaultSQLs=$H.cloneArray(editor.SQLStatements.defaultSQLs.currentNS);}if(getCurrent){return currentSQLs;}return defaultSQLs;}function addPreview(){var editor=this,sqlSection=new mstrmojo.Box({alias:"sqlPreviewBox",cssClass:CSS_PREFIX+"-sqlBox",children:[{scriptClass:"mstrmojo.Box",cssClass:CSS_PREFIX+"-preview",alias:"sqlPreviewContents",children:[{scriptClass:"mstrmojo.Table",alias:"sqlPreviewTable",rows:1,cols:3,children:[{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"-sqlPreviewLabel",slot:"0,0",text:STR_PREVIEW},{scriptClass:"mstrmojo.warehouse.ui.NameSpacePullDown",alias:"nameSpaces",sourceInfo:"CatSQL",slot:"0,1",onItemSelectedCallback:function onItemSelectedCallback(item){editor.selectedNS=item.n;}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton "+CSS_PREFIX+"-button",slot:"0,2",text:STR_APPLY,onclick:function onclick(){var options=editor.options,catalogMode=options.catalogMode,nsMode=options.nsMode,cacheMode=options.cacheMode,currentSQLs,defaultSQLs,SQLOptions=[];SQLOptions.push(catalogMode);SQLOptions.push(nsMode);SQLOptions.push(cacheMode);if(options.catalogMode.value===catalogModeSQL){currentSQLs=chooseSQLs(editor,nsMode,cacheMode,true);defaultSQLs=chooseSQLs(editor,nsMode,cacheMode,false);switch(cacheMode.value){case cacheModeFull:SQLOptions.push(getSQL.call(editor,defaultSQLs,currentSQLs,"full",0));break;case cacheModeTables:SQLOptions.push(getSQL.call(editor,defaultSQLs,currentSQLs,"table",0));SQLOptions.push(getSQL.call(editor,defaultSQLs,currentSQLs,"column",1));break;case cacheModeNone:SQLOptions.push(getSQL.call(editor,defaultSQLs,currentSQLs,"table",0));SQLOptions.push(getSQL.call(editor,defaultSQLs,currentSQLs,"column",1));break;}}editor.onUpdateInfo({options:SQLOptions});if((editor.supportsNameSpaces&&editor.selectedNS)||(!editor.supportsNameSpaces)){mstrApp.rootController.availableTableSearch("",{dbRoleID:editor.dbRole.did,nameSpace:editor.selectedNS||"",getFresh:true,sourceInfo:"CatSQL"});}}}]}]},{scriptClass:"mstrmojo.warehouse.ui.AvailableTablesTree",alias:"dbTableTree",cssClass:"mstrmojo-wh-AvailableTablesTree "+CSS_PREFIX+"-dbTablesTree",sourceInfo:"CatSQL",editor:editor,postCreate:function postCreate(){if(this.editor.options.catalogMode.value===catalogModeODBC){this.cssClass+="-none";}}}]});this.contents.rightPanel.addChildren([sqlSection]);}function radioButtonClick(){var i,count=this.parent.count,prefix=this.parent.prefix;if(this.checked){for(i=0;i<count;i++){this.parent[prefix+i].set("checked",false);}this.set("checked",true);}}function populateRightPanel(){var editor=this,options=editor.options,rightPanel=editor.contents.rightPanel,currentSQLs,defaultSQLs,sqlSection;if(editor.loading){return ;}this.loadingPanel=true;rightPanel.removeChildren();if(options.catalogMode.value===catalogModeSQL){currentSQLs=chooseSQLs(editor,options.nsMode,options.cacheMode,true);defaultSQLs=chooseSQLs(editor,options.nsMode,options.cacheMode,false);sqlSectionArray=[];switch(options.cacheMode.value){case cacheModeFull:sqlSection=addSQLSection.call(editor,defaultSQLs,currentSQLs,"full");sqlSectionArray.push(sqlSection);break;case cacheModeTables:sqlSectionArray.push(addSQLSection.call(editor,defaultSQLs,currentSQLs,"table"));sqlSectionArray.push(addSQLSection.call(editor,defaultSQLs,currentSQLs,"column"));break;case cacheModeNone:sqlSectionArray.push(addSQLSection.call(editor,defaultSQLs,currentSQLs,"table"));sqlSectionArray.push(addSQLSection.call(editor,defaultSQLs,currentSQLs,"column"));break;}}addPreview.call(editor);editor.contents.rightPanel.sqlPreviewBox.sqlPreviewContents.sqlPreviewTable.nameSpaces.domNode.style.visibility=(editor.supportsNameSpaces?"":"hidden");if(editor.supportsNameSpaces){mstrApp.rootController.getNameSpaces({dbRoleID:editor.dbRole.did,sourceInfo:"CatSQL"});}this.loadingPanel=false;}mstrmojo.warehouse.ui.editors.CatalogSQLEditor=mstrmojo.declare(mstrmojo.Editor,[mstrmojo._FillsBrowser,mstrmojo._HasLayout],{scriptClass:"mstrmojo.warehouse.ui.editors.CatalogSQLEditor",cssClass:CSS_PREFIX,title:STR_TITLE,options:{},SQLStatements:[],onUpdateInfo:undefined,supportsNameSpaces:false,dbRole:undefined,sql:"",curtain:undefined,useDefaultSQL:undefined,contents:undefined,rightPanel:undefined,sqlPreviewBox:undefined,sqlPreviewContents:undefined,sqlPreviewTable:undefined,leftPanel:undefined,currentSQLs:undefined,defaultSQLs:undefined,catalogModeRBBox:undefined,catalogModeRB0:undefined,catalogModeRB1:undefined,cacheMode:undefined,nsMode:undefined,catalogMode:undefined,sqlCheck:undefined,allNS:undefined,currentNS:undefined,cacheModeRBBox:undefined,nsModeRBBox:undefined,nsModeRB1:undefined,browserResized:function browserResized(size){var width=parseInt(size.w,10);OPEN_SIZE=size;if(isNaN(width)||width<0||!this.domNode){return ;}if(width<800){width=760;}else{if(width>1063){width=1010;}else{width=Math.ceil(width*0.95);}}this.domNode.children[0].style.width=width+"px";this.contents.rightPanel.domNode.style.width=(width-219)+"px";$A.forEach(sqlSectionArray,function(sqlSection){sqlSection.resize();});},onOpen:function onOpen(){var leftPanel=this.contents.leftPanel,index,node,top;this.loading=true;var supportsDataSourceSQL=($A.find(mstrApp.rootController.getDBObjects().catalogDbTypes,"v",this.dbRole.mdDBRole.db_type)>=0);leftPanel.catalogModeRBBox.catalogModeRB0.set("enabled",supportsDataSourceSQL);if((this.options.catalogMode.value===catalogModeSQL)&&supportsDataSourceSQL){index=0;}else{index=1;}leftPanel.catalogModeRBBox["catalogModeRB"+index].set("checked",true);leftPanel.catalogModeRBBox["catalogModeRB"+index].onclick();leftPanel.nsModeRBBox.nsModeRB1.set("enabled",this.supportsNameSpaces);if(this.supportsNameSpaces){if(this.options.nsMode.value===cacheModeFull){index=0;}else{index=1;}}else{index=0;}leftPanel.nsModeRBBox["nsModeRB"+index].set("checked",true);leftPanel.nsModeRBBox["nsModeRB"+index].onclick();if(this.options.cacheMode.value===cacheModeFull){index=0;}else{if(this.options.cacheMode.value===cacheModeTables){index=1;}else{if(this.options.cacheMode.value===cacheModeNone){index=2;}}}leftPanel.cacheModeRBBox["cacheModeRB"+index].set("checked",true);leftPanel.cacheModeRBBox["cacheModeRB"+index].onclick();this.selectedNS=undefined;this.loading=false;populateRightPanel.call(this);node=this.domNode.children[0];top=parseInt(node.style.top,10);if(top<0){node.style.top="0px";}if(OPEN_SIZE){this.browserResized(OPEN_SIZE);$DOM.center(node);}},children:[{scriptClass:"mstrmojo.HBox",alias:"contents",cssClass:"catsql-hbox",children:[{scriptClass:"mstrmojo.Box",cssClass:CSS_PREFIX+"-leftPanel",alias:"leftPanel",children:[{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"-sectionTitle",text:STR_CATALOG_MODE},{scriptClass:"mstrmojo.Box",cssClass:CSS_PREFIX+"-sectionBox",count:2,prefix:"catalogModeRB",alias:"catalogModeRBBox",children:[{scriptClass:"mstrmojo.RadioButton",cssClass:CSS_PREFIX+"-option",label:STR_SQL,index:0,alias:"catalogModeRB0",onclick:function onclick(){radioButtonClick.call(this);},oncheckedChange:function oncheckedChange(){}},{scriptClass:"mstrmojo.RadioButton",cssClass:CSS_PREFIX+"-option",label:STR_ODBC,index:1,alias:"catalogModeRB1",onclick:function onclick(){radioButtonClick.call(this);},oncheckedChange:function oncheckedChange(){var editor=this.parent.parent.parent.parent;editor.options.catalogMode.value=(this.checked?catalogModeODBC:catalogModeSQL);populateRightPanel.call(editor);}}]},{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"-sectionTitle",text:STR_NS},{scriptClass:"mstrmojo.Box",cssClass:CSS_PREFIX+"-sectionBox",count:2,alias:"nsModeRBBox",prefix:"nsModeRB",children:[{scriptClass:"mstrmojo.RadioButton",cssClass:CSS_PREFIX+"-option",label:STR_NS_ALL,index:0,alias:"nsModeRB0",onclick:function onclick(){radioButtonClick.call(this);},oncheckedChange:function oncheckedChange(){if(!this.checked){return ;}var editor=this.parent.parent.parent.parent;editor.options.nsMode.value=nsModeAll;populateRightPanel.call(editor);}},{scriptClass:"mstrmojo.RadioButton",cssClass:CSS_PREFIX+"-option",label:STR_NS_CURRENT,index:1,alias:"nsModeRB1",onclick:function onclick(){radioButtonClick.call(this);},oncheckedChange:function oncheckedChange(){if(!this.checked){return ;}var editor=this.parent.parent.parent.parent;editor.options.nsMode.value=nsModeCurrent;populateRightPanel.call(editor);}}]},{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"-sectionTitle",text:STR_CACHING},{scriptClass:"mstrmojo.Box",cssClass:CSS_PREFIX+"-sectionBox",count:3,alias:"cacheModeRBBox",prefix:"cacheModeRB",children:[{scriptClass:"mstrmojo.RadioButton",cssClass:CSS_PREFIX+"-option",label:STR_CACHING_FULL_CATALOG,index:0,alias:"cacheModeRB0",onclick:function onclick(){radioButtonClick.call(this);},oncheckedChange:function oncheckedChange(){if(!this.checked){return ;}var editor=this.parent.parent.parent.parent;editor.options.cacheMode.value=cacheModeFull;populateRightPanel.call(editor);}},{scriptClass:"mstrmojo.RadioButton",cssClass:CSS_PREFIX+"-option",label:STR_CACHING_TABLES,index:1,alias:"cacheModeRB1",onclick:function onclick(){radioButtonClick.call(this);},oncheckedChange:function oncheckedChange(){if(!this.checked){return ;}var editor=this.parent.parent.parent.parent;editor.options.cacheMode.value=cacheModeTables;populateRightPanel.call(editor);}},{scriptClass:"mstrmojo.RadioButton",cssClass:CSS_PREFIX+"-option",label:STR_CACHING_NONE,index:2,alias:"cacheModeRB2",onclick:function onclick(){radioButtonClick.call(this);},oncheckedChange:function oncheckedChange(){if(!this.checked){return ;}var editor=this.parent.parent.parent.parent;editor.options.cacheMode.value=cacheModeNone;populateRightPanel.call(editor);}}]}]},{scriptClass:"mstrmojo.Box",cssClass:CSS_PREFIX+"-rightPanel",alias:"rightPanel",children:[]}]}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton "+CSS_PREFIX+"-closeBtn",text:STR_CLOSE,onclick:function onclick(){var editor=this.parent.parent;$A.forEach(editor.contents.rightPanel.sqlPreviewBox.dbTableTree.items,function(dbTable){delete dbTable.items;});editor.close();}}]});}());