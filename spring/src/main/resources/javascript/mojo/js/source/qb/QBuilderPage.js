(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo._HasPopup","mstrmojo._FillsBrowser","mstrmojo.Box","mstrmojo.Table","mstrmojo.Image","mstrmojo.Button","mstrmojo.qb.SplitPanel","mstrmojo.qb.VSplitPanel","mstrmojo.qb.QBuilderModel","mstrmojo.qb.QBPanel","mstrmojo.qb.QBMappings","mstrmojo.qb.MissingColumnWarning","mstrmojo.form","mstrmojo.hash","mstrmojo.array","mstrmojo.qb.Toolbar","mstrmojo.qb.QBPageLayout","mstrmojo.qb.Footer","mstrmojo.DI.DIExitOptions");mstrmojo.requiresDescs(531,1143,3377,12408,12484);var $H=mstrmojo.hash,$DESC=mstrmojo.desc;var EXPR_EDITOR_ID="qbexpr",exprEditorConfig={scriptClass:"mstrmojo.qb.ExpressionEditor",id:EXPR_EDITOR_ID};var SPACE_SEP=" ",PERIOD_SEP=".";var DIFF_DB_INST_TABLE_ERR_MSG=$DESC(12408,"Please add tables from the same DB connection.");function processName(input,pattern){if(!pattern){return input;}return(input.indexOf(SPACE_SEP)>-1||input.indexOf(PERIOD_SEP)>-1)?pattern.replace("#0",input):input;}function composeSQLTokens(namespace,tablename,columns){var tokens=[],ff=mstrmojo.all.FFsql,existingcount,count,len=columns.length,items=ff.items,notLastColumn,whtree=this.main.WHTableTree,columnpattern=whtree.getDBRole(whtree.getDBRoleID()).cpat;existingcount=count=ff.itemCount;tokens.push({isNew:true,v:"select",oi:{n:"select",sta:100,t:100},did:count++},{isNew:true,v:" ",isDelimiter:true,did:count++});mstrmojo.array.forEach(columns,function(column,idx){tokens.push({isNew:true,v:processName(column.cln,columnpattern),did:count++});notLastColumn=idx<len-1;if(notLastColumn){tokens.push({isNew:true,v:",",isDelimiter:true,did:count++});}tokens.push({isNew:true,v:"\n",isDelimiter:true,did:count++});if(notLastColumn){tokens.push({isNew:true,v:" ",isDelimiter:true,did:count++});}});tablename=processName(tablename,columnpattern);tokens.push({isNew:true,v:"from",oi:{n:"from",sta:100,t:100},did:count++},{isNew:true,v:" ",isDelimiter:true,did:count++},{isNew:true,v:(namespace?processName(namespace,columnpattern)+PERIOD_SEP+tablename:tablename),did:count++},{isNew:true,v:";",did:count++});if(existingcount>0&&items[existingcount-1]!=="\n"){items.push({isNew:true,v:"\n",isDelimiter:true,did:count++});}items=items.concat(tokens);ff.itemCount=count;ff.set("items",items);ff.parent.updatepasses();}mstrmojo.qb.QBuilderPage=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._HasPopup],{scriptClass:"mstrmojo.qb.QBuilderPage",markupString:'<div id="{@id}" class="mstrmojo-qb {@cssClass}" style="{@cssText}"><div class="mstrmojo-qb-layout"></div></div>',markupSlots:{layout:function(){return this.domNode.firstChild;}},layoutConfig:{h:{layout:"100%"},w:{layout:"100%"}},id:"QBuilderPage",onError:mstrmojo.emptyFn,renderPageLoadError:function renderPageLoadError(){var err=this.error,message=err.message,title=err.title,buttons=err.btns;this.onError(err);if(!buttons||!buttons.length){mstrmojo.alert(message,null,title);}else{mstrmojo.confirm(message,null,{buttons:buttons,title:title});}},render:function render(){if(this.error){this.renderPageLoadError();}else{this._super();}},saveasRef:{scriptClass:"mstrmojo.SaveAsEditor",typeDesc:mstrmojo.desc(3377,"Object"),browsableTypes:"3,8",showCompletePath:false,onObjectSaved:function(o){var p=this.opener,oi=p&&p.oi;if(p&&oi){oi.did=o.did;oi.n=o.name;oi.desc=o.desc;p.set("title","QBReport: "+o.name);}}},children:[{scriptClass:"mstrmojo.qb.QBPageLayout",slot:"layout",alias:"main"}],init:function init(props){this._super(props);var evtConfig={},tableConfig=evtConfig[this.id]={};tableConfig.directDataAccessTableError=this.onTableAdded;tableConfig.diffDBInstTableError=this.onTableAdded;tableConfig.windowSizeChanged=this.adjustSize;mstrApp.getRootController().attachDataChangeListeners(evtConfig);var dbRoleSelector=this.getDBRoleSelector(),availableTablesPanel=this.main.children[0].bottomPanel;dbRoleSelector.getLayoutOffsets=function(){return{h:9,w:0};};availableTablesPanel.getLayoutOffsets=function(){return{h:16,w:0};};availableTablesPanel.searchBox.widthOffset=10;availableTablesPanel.nameSpaces.heightOffset=30;dbRoleSelector.heightOffset=38;availableTablesPanel.heightOffset=73;this.main.workPanel.getLayoutOffsets=function(){return{h:16,w:12};};dbRoleSelector.newDBBtn.set("text",mstrmojo.desc(531,"Add")+"...");},getDBRoleSelector:function getDBRoleSelector(){return this.main.children[0].topPanel;},getDBConnectionList:function getDBConnectionList(){return this.getDBRoleSelector().dbConnections;},onTableAdded:function onTableAdded(evt){var errorMsg="";switch(evt.name){case"diffDBInstTableError":errorMsg=DIFF_DB_INST_TABLE_ERR_MSG;break;case"directDataAccessTableError":errorMsg=DIFF_DB_INST_TABLE_ERR_MSG;break;}mstrmojo.qb.alert(errorMsg);},openDialog:function openDialog(config){this.openPopup(config);},openExpressionEditor:function openExpressionEditor(obj,zIndex){var exprEditor=mstrmojo.all[EXPR_EDITOR_ID]||mstrmojo.insert(exprEditorConfig);exprEditor.set("oi",$H.copy(obj,{mhfts:{},mvfts:{}}));exprEditor.open(null,{zIndex:zIndex||50});},addSQLFromColumn:function addSQLFromColumn(column){composeSQLTokens.call(this,column.ns,column.tbn,[column]);},addSQLFromTable:function addSQLFromTable(ns,tbn,its){composeSQLTokens.call(this,ns,tbn,its);},getSQLStatement:function getSQLStatement(){return mstrmojo.all.FFsql.getSQLstmt();},toggleDatabaseView:function toggleDatabaseView(show){this.main.toggleDatabaseView(show);},toggleDataPreview:function toggleDataPreview(show){this.main.toggleDataPreview(show);},loadView:function loadView(){this.toggleDataPreview(true);this.toggleDataPreview(false);},showRedirectionPage:function showRedirectionPage(reportID,path){this.set("children",[{scriptClass:"mstrmojo.Label",slot:"toolbar",text:mstrmojo.desc(12484,"Data Imported"),cssClass:"mstrmojo-qb-title"},{scriptClass:"mstrmojo.Image",cssClass:"mstrmojo-qb-toolbarIcon help",slot:"toolbar",title:mstrmojo.desc(1143,"help"),onclick:function(){var url=(mstrApp.helpUrl||"../help/")+"WebUser/WebHelp/Lang_"+(mstrApp.helpLocaleId?mstrApp.helpLocaleId:mstrApp.localeId)+"/"+(mstrApp.userHelpPage||"MicroStrategy_Web_Help.htm")+"#"+((mstrApp.helpTopics&&mstrApp.helpTopics.general)||"About_importing_data.htm");window.open(url);}},{scriptClass:"mstrmojo.DI.DIExitOptions",privileges:{CreateViewReport:mstrConfig.canCreateReport,CreateReportServices:mstrConfig.canCreateDocument,CreateAnalysis:mstrConfig.canCreateAnalysis},model:{cubeID:reportID,path:path,operationMode:mstrApp.getRootController().getOperationMode()},slot:"layout"},{scriptClass:"mstrmojo.qb.Footer",slot:"footer",alias:"footerWidget"}]);this.footerWidget.hidePublish();},adjustSize:function(evt){var size=evt.size,isCloud=mstrApp.isCloudPro,widthDelta=isCloud?40:0,heightDelta=isCloud?180:101;var width,height;height=parseInt(size.h,10)-heightDelta+"px";width=parseInt(size.w,10)-widthDelta+"px";if(this.height&&height!==this.height){this.set("height",height);}else{this.height=height;}if(this.width&&width!==this.width){this.set("width",width);}else{this.width=width;}return true;},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.adjustSize({size:mstrApp.size});}});})();