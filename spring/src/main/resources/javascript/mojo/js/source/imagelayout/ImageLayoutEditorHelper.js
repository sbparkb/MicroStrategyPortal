(function(){mstrmojo.requiresCls("mstrmojo.vi.models.editors.BaseEditorModel","mstrmojo.chart.enums.EnumFontStyle");mstrmojo.requiresClsP("mstrmojo.ui.editors.controls","CharacterGroup","ContainerGroup","TwoColumnContainer","ColorPickerButton","LineStyleButton","ValidationTextBox");var $HASH=mstrmojo.hash,$EF=mstrmojo.emptyFn,$ARR=mstrmojo.array,$CHARACTER_CTRL_FLAGS=mstrmojo.ui.editors.controls.CharacterGroup.CTRL_FLAGS,$ENUM_FONT_STYLE_VALUE=mstrmojo.chart.enums.EnumFontStyle,$ENUM_FORMAT_PROPERTIES=mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES,$GM=mstrmojo.gm,$DTP=mstrmojo.expr.DTP;var PREFIX_ALL_TEXT="allTxt",PREFIX_LEGEND="lg",CTRL_TYPE_CHARACTER_GROUP=0,CTRL_TYPE_CHECK_BOX=1;var enableDebug=false;function debugLog(msg){if(enableDebug&&window.console){window.console.log(msg);}}function getFmtControlSharedProperties(broker,smartNames){return{broker:broker,smartNames:smartNames,controlName:smartNames[0],reInitDefault:function(){(this.listenFormatProps).forEach(function(smartName){this.onFmtPropsChanged(smartName,this.broker.getFormatPropertyValue(smartName));},this);},reInit:function(){this.reInitDefault();},preBuildRendering:function(){this.reInit();},syncControl:function(fnSync){var currentSync=this._sync;this._sync=true;var rst=fnSync.call(this);this._sync=currentSync;return rst;},onFmtPropsChangedDefault:$EF,onFmtPropsChanged:function(smartName,value,opt){this.onFmtPropsChangedDefault(smartName,value,opt);},onSelectorsValueChangedDefault:function(){this.reInit();},onSelectorsValueChanged:function(selName,value){this.onSelectorsValueChangedDefault(selName,value);},destroy:function destroy(ignoreDom){this.broker.removeRegisterFormatControl(this);return this.constructor.prototype.destroy.call(this,ignoreDom);}};}function doControlPostCreating(control,labelText,controlType,columnSizes){if(!control){return ;}function removeDuplicate(arr){return Object.keys($ARR.hash($ARR.ensureArray(arr)));}var listenFormatProps=control.listenFormatProps||[],listenSelector=control.listenSelector||[];(control.smartNames||[]).forEach(function(sn){$ARR.insert(listenFormatProps,null,sn);$ARR.insert(listenSelector,null,control.broker.getDependingSelectorNames(sn));});control.listenFormatProps=removeDuplicate(listenFormatProps);control.listenSelector=removeDuplicate(listenSelector);control.broker.registerFormatControl(control);var result=control;if(typeof labelText==="string"){var isCheckbox=(controlType===CTRL_TYPE_CHECK_BOX),labelWidth=isCheckbox?"20px":"30%",controlWidth=isCheckbox?"100%":"70%";if(columnSizes){labelWidth=columnSizes[0];controlWidth=columnSizes[1];}result=this.getLabelAndControl(labelText,control,labelWidth,controlWidth,isCheckbox);control.label=result.getLabel();if(isCheckbox){result.cssClass="checkLabel multiLine";control.label.onclick=function onclick(){control.onclick();};control.label.cssDisplay="inline-block";}else{if(controlType===CTRL_TYPE_CHARACTER_GROUP){result.cssClass="characterGroup";}}}control.getCtrlContainer=function(){return result;};return result;}function getTextBoxPropsWithEmptyVal(broker,snVal){var snValPropValue=broker.getFormatPropertyValue(snVal);function isConflictState(validationTextBox){var val=validationTextBox.value;return(val===undefined||val==="")&&snValPropValue===undefined;}return{onInvalid:function onInvalid(){if(isConflictState(this)){if(this.hasRendered){this.clearValidation();}return ;}else{if(this.hasRendered){mstrmojo.ui.editors.controls.ValidationTextBox.prototype.onInvalid.call(this);}}},onRender:function(){if(isConflictState(this)){this.clearValidation();}}};}function getUpdatedFontFormats(broker,snMap){var formats={},fontStyleVal=broker.getFormatPropertyValue(snMap.fontStyle),fontColorVal=broker.getFormatPropertyValue(snMap.fontColor),fontFamilyVal=broker.getFormatPropertyValue(snMap.fontFamily),fontSizeVal=broker.getFormatPropertyValue(snMap.fontSize);if(fontStyleVal!==undefined){formats[$ENUM_FORMAT_PROPERTIES.FONT_WEIGHT]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_BOLD)>0));formats[$ENUM_FORMAT_PROPERTIES.FONT_STYLE]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_ITALIC)>0));formats[$ENUM_FORMAT_PROPERTIES.UNDERLINE]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_UNDERLINE)>0));formats[$ENUM_FORMAT_PROPERTIES.LINE_THROUGH]=(!isNaN(fontStyleVal)&&((fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_STRIKETHROUGH)>0));}formats[$ENUM_FORMAT_PROPERTIES.COLOR]=fontColorVal!==undefined?fontColorVal:-1;formats[$ENUM_FORMAT_PROPERTIES.FONT_SIZE]=fontSizeVal!==undefined?fontSizeVal:-1;formats[$ENUM_FORMAT_PROPERTIES.FONT_FAMILY]=fontFamilyVal!==undefined?fontFamilyVal:-1;return formats;}mstrmojo.imagelayout.ImageLayoutEditorHelper=mstrmojo.provide("mstrmojo.imagelayout.ImageLayoutEditorHelper",{getFillConfigComp:function getFillConfigComp(widget,label,smartNamesMap,overrides){var broker=widget.propertyManager,smartNames=$HASH.valarray(smartNamesMap),props=getFmtControlSharedProperties(broker,smartNames);$HASH.copy({smartNamesMap:smartNamesMap,onGroupValueChange:function(smartName,value){if(!this._sync){broker.setFormatPropertyValue(smartName,value);}},onFmtPropsChangedDefault:function(smartName,value){this.syncControl(function(){var me=this;if($ARR.filterOne(this.propNames,function(name){return(name===smartName);})){me.setChildValue(smartName,value);}else{this.propNames.forEach(function(name){me.setChildValue(name,broker.getFormatPropertyValue(name));});}});}},props);$HASH.copy(overrides,props);var control=widget.addDisposable(new mstrmojo.ui.editors.controls.FillConfigGroup(props));control.iniChildrenComp(smartNames);return doControlPostCreating.call(this,control,label);},getLineConfigComp:function getLineConfigComp(widget,label,smartNamesMap,overrides){var broker=widget.propertyManager,smartNames=$HASH.valarray(smartNamesMap),props=getFmtControlSharedProperties(broker,smartNames);$HASH.copy({smartNamesMap:smartNamesMap,onGroupValueChange:function(smartName,value){if(!this._sync){broker.setFormatPropertyValue(smartName,value);}},onFmtPropsChangedDefault:function(smartName,value){this.syncControl(function(){this.setChildValue(smartName,value);});}},props);$HASH.copy(overrides,props);var control=widget.addDisposable(new mstrmojo.ui.editors.controls.LineConfigGroup(props));control.iniChildrenComp(smartNames);return doControlPostCreating.call(this,control,label);},getCharacterConfigComp:function getCharacterConfigComp(widget,label,smartNamesMap,overrides){var broker=widget.propertyManager,smartNames=$HASH.valarray(smartNamesMap),props=getFmtControlSharedProperties(broker,smartNames),fontStyleValueMap={},propNameToSmartName={};propNameToSmartName[$ENUM_FORMAT_PROPERTIES.FONT_SIZE]=smartNamesMap.fontSize;propNameToSmartName[$ENUM_FORMAT_PROPERTIES.COLOR]=smartNamesMap.fontColor;propNameToSmartName[$ENUM_FORMAT_PROPERTIES.FONT_FAMILY]=smartNamesMap.fontFamily;propNameToSmartName[$ENUM_FORMAT_PROPERTIES.FONT_WEIGHT]=propNameToSmartName[$ENUM_FORMAT_PROPERTIES.FONT_STYLE]=propNameToSmartName[$ENUM_FORMAT_PROPERTIES.UNDERLINE]=propNameToSmartName[$ENUM_FORMAT_PROPERTIES.LINE_THROUGH]=smartNamesMap.fontStyle;fontStyleValueMap[$ENUM_FORMAT_PROPERTIES.FONT_WEIGHT]=$ENUM_FONT_STYLE_VALUE.FS_BOLD;fontStyleValueMap[$ENUM_FORMAT_PROPERTIES.FONT_STYLE]=$ENUM_FONT_STYLE_VALUE.FS_ITALIC;fontStyleValueMap[$ENUM_FORMAT_PROPERTIES.UNDERLINE]=$ENUM_FONT_STYLE_VALUE.FS_UNDERLINE;fontStyleValueMap[$ENUM_FORMAT_PROPERTIES.LINE_THROUGH]=$ENUM_FONT_STYLE_VALUE.FS_STRIKETHROUGH;$HASH.copy({smartNamesMap:smartNamesMap,syncWithAllText:false,onGroupValueChange:function(propName,value){var sn=propNameToSmartName[propName];if(sn===smartNamesMap.fontStyle){var curFontStyle=broker.getFormatPropertyValue(sn),selFontStyleVal=fontStyleValueMap[propName],isSelected=value;value=isSelected?(curFontStyle|selFontStyleVal):(curFontStyle&(~selFontStyleVal));}else{if(sn===smartNamesMap.fontSize){if(this.visibleControls&$CHARACTER_CTRL_FLAGS.FONT_SIZE_USE_STEPPER){value=value[0];}value=parseInt(value,10)+"pt";}}this.broker.setFormatPropertyValue(sn,value);},onFmtPropsChangedDefault:function(smartName){this.syncControl(function(){var snMap=this.smartNamesMap,keyOfChanged=$ARR.filterOne($HASH.keyarray(snMap),function(key){return snMap[key]===smartName;});if(keyOfChanged||this.syncWithAllText){if(!keyOfChanged&&smartName.indexOf(PREFIX_ALL_TEXT)===-1){debugLog("[CharacterGroup] Unnecessary refresh which might be due to incorrect listenFormatProps.");}this.refreshValues();}});},refreshValues:function(){this.syncControl(function(){var fontFmts=getUpdatedFontFormats(this.broker,this.smartNamesMap);if(this.visibleControls&$CHARACTER_CTRL_FLAGS.FONT_SIZE_USE_STEPPER){fontFmts[$ENUM_FORMAT_PROPERTIES.FONT_SIZE]=[parseInt(fontFmts[$ENUM_FORMAT_PROPERTIES.FONT_SIZE],10)];}this.setFormatSource(fontFmts);});}},props);$HASH.copy(overrides,props);if(props.syncWithAllText){var snsAllText=$HASH.valarray(broker.getSmartNamesMapForFontGroup(PREFIX_ALL_TEXT));props.listenFormatProps=(props.listenFormatProps||[]).concat(snsAllText);}var control=widget.addDisposable(new mstrmojo.ui.editors.controls.CharacterGroup(props));return doControlPostCreating.call(this,control,label);},getPropertyCheckBox:function getPropertyCheckBox(widget,label,smartName,overrides){var broker=widget.propertyManager,smartNames=[smartName],props=getFmtControlSharedProperties(broker,smartNames);$HASH.copy({oncheckedChange:function(){if(this._sync){return ;}broker.setFormatPropertyValue(this.smartNames[0],this.checked);},onFmtPropsChangedDefault:function(smartName,value){this.syncControl(function(){this.set("checked",!!value);});}},props);$HASH.copy(overrides,props);var control=widget.addDisposable(new mstrmojo.ui.Checkbox(props));return doControlPostCreating.call(this,control,label,CTRL_TYPE_CHECK_BOX);},getPropertyPulldown:function getPropertyPulldown(widget,label,items,smartName,overrides){overrides=overrides||{};var broker=widget.propertyManager,smartNames=[smartName],props=getFmtControlSharedProperties(broker,smartNames),fnChange=overrides.fnChange||function(value){if(this._sync){return ;}broker.setFormatPropertyValue(this.smartNames[0],value);};$HASH.copy({onFmtPropsChangedDefault:function(smartName,value){this.syncControl(function(){if(typeof value==="undefined"){this.set("selectedIndex",-1);}else{this.selectItemByField("v",value);}});}},props);$HASH.copy(overrides,props);var control=widget.addDisposable(this.getPulldown(items,fnChange,0,props));return doControlPostCreating.call(this,control,label,null,["40%","60%"]);},getPropertyButtonBar:function getPropertyButtonBar(widget,label,items,smartName,overrides){var broker=widget.propertyManager,smartNames=[smartName],props=getFmtControlSharedProperties(broker,smartNames);$HASH.copy({showIcon:false,items:items,onFmtPropsChangedDefault:function(smartName,value){this.syncControl(function(){if(this.multiSelect){this.select((this.items||[]).map(function(item,idx){return(value&item.v)>0?idx:null;}).filter(function(elem){return elem!==null;}));}else{if(typeof value==="undefined"){this.clearSelect();}else{this.singleSelectByField(value,"v");}}});},postselectionChange:function(evt){if(this._sync){return ;}var value=evt.added&&this.items[evt.added[0]].v;if(this.multiSelect){if(!items||!items.length){return debugLog("[ImageLayoutEditorModel getBitwiseValFromMultiSelection] no items in caller");}value=items.reduce(function(value,item,idx){return this.selectedIndices[idx]?value|=item.v:value;}.bind(this),0);}broker.setFormatPropertyValue(this.smartNames[0],value);}},props);$HASH.copy(overrides,props);var control=widget.addDisposable(new mstrmojo.ui.ButtonBar(props));return doControlPostCreating.call(this,control,label);},getPropertyValidationTextBox:function getPropertyValidationTextBox(widget,label,smartName,overrides){var broker=widget.propertyManager,smartNames=[smartName],props=getFmtControlSharedProperties(broker,smartNames);$HASH.copy({dtp:$DTP.FLOAT,required:true,onValid:function(){if(this._sync){return ;}broker.setFormatPropertyValue(this.smartNames[0],this.value);},onFmtPropsChangedDefault:function(smartName,value){this.syncControl(function(){this.set("value",value);this.validate();});}},props);$HASH.copy(overrides,$HASH.copy(getTextBoxPropsWithEmptyVal(broker,smartName),props));var control=widget.addDisposable(new mstrmojo.ui.editors.controls.ValidationTextBox(props));return doControlPostCreating.call(this,control,label);},getPulldown:function getPulldown(items,fnChange,selectedIndex,props,skipInstantiation){$HASH.copy({_set_selectedIndex:function _set_selectedIndex(n,v){if(v===-1){this.selectedIndex=v;this.getPopupList().clearSelect();var selectedNode=this.selectedNode;if(selectedNode){selectedNode.innerHTML="";}return false;}return this.constructor.prototype._set_selectedIndex.call(this,n,v);}},props);return mstrmojo.ui.Pulldown.newPulldown(items,function(newItem,oldItem){fnChange.call(this,newItem.v,oldItem&&oldItem.v);},selectedIndex,props,skipInstantiation);},getLabelAndControl:function getLabelAndControl(labelText,control,col1Width,col2Width,reverseOrder,props){var label=new mstrmojo.Label({text:labelText,setDimensions:function(h,w){var domNode=this.domNode;if(domNode){domNode.style.width=w;}}}),ctrl1=label,ctrl2=control;if(reverseOrder){ctrl1=control;ctrl2=label;}ctrl1.slot="col1Node";ctrl2.slot="col2Node";return new mstrmojo.ui.editors.controls.TwoColumnContainer($HASH.copy(props,{col1Width:col1Width||"40%",col2Width:col2Width||"60%",children:[ctrl1,ctrl2],getLabel:function(){return label;},getCtrl:function(){return this.children.filter(function(child){return child!==label;})[0];}}));}});}());