(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.hash","mstrmojo.XtabDataService");var INFO="info";function getInfo(me,data){var pid=mstrApp.getCurrentProjectId(),visName=me.delegate.visName;info={obId:me.delegate.dssId,obTp:me.getObjectType(),prId:pid,server:mstrApp.getConfiguration().getServerByProjectId(pid).nm};if(visName){info.visName=visName;}return info;}function addLinkKeys(me,keys,params,obId){var hasLink=false,l=params.link,key;if(l){hasLink=true;var prms=l.prms,prmCnt=prms&&prms.length,cacheble=true;if(prmCnt){for(var i=0;i<prmCnt&&cacheble;i++){var am=prms[i].am;switch(am){case l.DO_NOT_ANSWER:case l.SAME_PROMPT:cacheble=false;break;}}}if(cacheble){key="a:"+l.toXml();}}else{var i,param,urlLinkParams=me.delegate.urlLinkParams();for(i=0;i<urlLinkParams.length;i++){param=params[urlLinkParams[i]];if(param){hasLink=true;if(!key){key="a:";}key+=param;}}}if(key){keys.push(key);}if(hasLink){me.promptLevel=me.obLevel+1;me.levelCount=me.promptLevel+1;}return hasLink&&!key;}mstrmojo.ResSetCachedDataService=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.ResSetCachedDataService",STATUS_ONLY_PARAM:{statusOnly:true},delegate:null,store:null,levelCount:2,obLevel:1,promptLevel:0,layoutLevel:0,pbLevel:0,pbLength:0,init:function init(props){this._super(props);if(!this.store){this.store=mstrApp.getResSetStore();}},execute:function execute(params,callback){this.levelCount=this.obLevel+1;var me=this,delegate=me.delegate,store=me.store,obId=(params&&(params.dssId||params.objectID))||me.dssId,keys=["r:"+obId],uncachebleLink=addLinkKeys(me,keys,params,obId),cachedStr,onCacheHit=function(){var cachedData=JSON.parse(cachedStr),obInfoStr=store.getValue(INFO,me.obLevel),obInfo=JSON.parse(obInfoStr),prompts=obInfo.prompts;if(prompts){me.promptLevel=me.obLevel+1;me.levelCount=me.promptLevel+1;var answerInfo=JSON.parse(store.getValue(INFO,me.promptLevel));delegate.prompts=prompts;delegate.answers=answerInfo.answers;}if(obInfo.visName){delegate.visName=obInfo.visName;}me.processData(cachedData,"exec",false);callback.success(cachedData);},myCallback={success:function(res){me.processData(res,"exec",true);me.addLayoutCacheKey(keys,res);me.addPbCacheKeys(keys,res);var info=getInfo(me,res),ci=res.ci,prompts=delegate.prompts,curAnswers=delegate.answers;if(prompts){info.prompts=delegate.prompts;}else{if(ci){info.ci=ci;}}var extras=[{l:me.obLevel,n:INFO,v:JSON.stringify(info)}];if(prompts&&(ci||curAnswers)){var linkInfo={};if(ci){linkInfo.ci=ci;}if(curAnswers){linkInfo.answers=curAnswers;}extras.push({l:me.promptLevel,n:INFO,v:JSON.stringify(linkInfo)});}me.putData(store,me.obLevel,keys,res,false,extras);callback.success(res);},prompts:callback.prompts,failure:callback.failure};delegate.dssId=obId;if(uncachebleLink){delegate.execute(params,{success:function(res){var answer=delegate.answers;if(answer){keys.push("a"+JSON.stringify(answer));cachedStr=store.getData(me.obLevel,keys);if(cachedStr){onCacheHit();}else{delegate.getResults(params,myCallback);}}},prompts:callback.prompts,failure:callback.failure},me.STATUS_ONLY_PARAM);}else{cachedStr=store.getData(me.obLevel,keys);if(cachedStr){onCacheHit();}else{delegate.execute(params,myCallback);}}},getResults:function getResults(params,callback){this.delegate.getResults(params,callback);},answerPrompts:function answerPrompts(prompts,callback){var me=this;me.promptLevel=me.obLevel+1;me.levelCount=me.promptLevel+1;var delegate=me.delegate,store=me.store,data=null,answer=prompts.buildAnswerObject(),answerXml=prompts.getAnswerXML(),answerKey="a:"+answerXml,v=store.getData(me.promptLevel,[answerKey]);if(v){data=JSON.parse(v);var obInfoStr=store.getValue(INFO,me.obLevel),obInfo=JSON.parse(obInfoStr);if(obInfo.visName){delegate.visName=obInfo.visName;}me.processData(data,"answer",false);delegate.answers=answer;store.setAsDefault(me.promptLevel);callback.success(data);return ;}var myCallback={success:function(res){me.processData(res,"answer",true);var keys=["r:"+me.delegate.dssId,answerKey];me.addLayoutCacheKey(keys,res);me.addPbCacheKeys(keys,res);var extras=[];if(!store.hasNode(me.obLevel)){var info=getInfo(me,res);info.prompts=delegate.prompts;extras.push({l:me.obLevel,n:INFO,v:JSON.stringify(info)});}var answerInfo={answers:answer};if(res.ci){answerInfo.ci=res.ci;}extras.push({l:me.promptLevel,n:INFO,v:JSON.stringify(answerInfo)});me.putData(store,me.obLevel,keys,res,true,extras);delegate.answers=answer;callback.success(res);},prompts:callback.prompts,failure:callback.failure};if(delegate.msgId){delegate.answerPrompts(prompts,myCallback);}else{var keys=JSON.parse(store.getKeys()),execParams={dssId:keys[me.obLevel].substr(2),promptsAnswerXML:answerXml};delegate.execute(execParams,myCallback);}},loadPrompts:function loadPrompts(callback){this.delegate.loadPrompts(callback);},linkToObject:function linkToObject(params,callback){this.execute(params,callback,true);},getPrompts:function getPrompts(){return this.delegate.getPrompts();},getImage:function getImage(url){var me=this,store=me.store,dataLevel=me.levelCount-1,hostUrl=mstrApp.getConfiguration().getHostUrlByProject(mstrApp.getCurrentProjectId());if(url&&url.indexOf("://")===-1){url=hostUrl+url;}return""+store.getImage(url,dataLevel);},resetLevelCount:function resetLevelCount(){var me=this;me.pbLevel=0;me.layoutLevel=0;me.levelCount=(me.promptLevel||me.obLevel)+1;},putData:function putData(store,level,keys,data,updateParent,extras){var d={level:level,keys:keys,data:JSON.stringify(data),updateParent:updateParent};if(extras){d.extras=extras;}store.putData(JSON.stringify(d));},reexecParams:function reexecParams(store){var me=this,delegate=me.delegate,webPrompt=delegate.getPrompts(),keys=JSON.parse(store.getKeys()),execParams={dssId:keys[me.obLevel].substr(2)};if(webPrompt){execParams.promptsAnswerXML=webPrompt.getAnswerXML();}return execParams;}});})();