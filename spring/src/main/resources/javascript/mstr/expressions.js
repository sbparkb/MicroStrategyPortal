mstr.views.Qualifier=(function(){mstr.$O.extendsClass(Q,mstr.views.BaseView);Q.prototype.setModel=function Q_setModel(m){var em=m&&m.get("selected"),et=this.props.expressionType;this._updateEditNode(m);this.toggleExprTypeView(m);var bShowImport=false;var bShowBrowse=false;if(em&&(em.get("allowFileImport")!=false)){switch(et){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:bShowImport=true;bShowBrowse=true;break;}}mstr.controllers.Factory.setPath("visible",this.props.import1View,bShowImport,false);bShowBrowse=bShowBrowse&&!!(em&&(em.get("allowElementBrowse")));mstr.controllers.Factory.setPath("visible",this.props.browse1View,bShowBrowse,false);mstr.controllers.Factory.setPath("visible",this.props.browse2View,bShowBrowse,false);mstr.views.BaseView.prototype.setModel.apply(this,[m]);};Q.prototype._updateEditNode=function Q_updateEditNode(m){var em=m&&m.get("selected"),allowEts=m&&m.get("allowedExpressionTypes");allowEts=(allowEts&&allowEts.split)?allowEts.split(","):[];if(m.props.defaultExpressionType){allowEts.push(m.props.defaultExpressionType);}if(this.props.expressionType){allowEts.push(this.props.expressionType);}var root=em.get("rootNode"),node=em.get("editNode"),etFound;if(node&&node.value){if(mstr.utils.Arrays.find(allowEts,node.value.expressionType)>-1){etFound=node.value.expressionType;}node=etFound?node:null;}if(!etFound&&root){for(var i=0,len=allowEts.length;i<len;i++){if(!allowEts[i]){continue;}node=mstr.utils.Trees.findByForm(root,allowEts[i],"expressionType");if(node){etFound=allowEts[i];break;}}}if(node){if(!this.props.formView){switch(parseInt(etFound)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:node.isAllFormQual=true;break;}}em.execCommand("EditNode",node);}else{var et=(m&&m.get("defaultExpressionType"))||this.props.expressionType;var targetListModel=m&&m.getTargetListModel();var targetItems=targetListModel&&targetListModel.getItems();var target=targetItems&&mstr.$A.len(targetItems)&&targetItems[0];var o={expressionType:et,autoGeneratedByView:this.props.id};if(target&&target.dssid!="0"){o.target=target;if(!this.props.formView&&(et==mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL)){o.form=mstr.$H.clone(mstr.Enum.Form.ALL);o.form.dtp=(mstr.utils.FormShortcutNode.getFormDataTypes(target)||[mstr.Enum.Nodes.DATATYPE.VARCHAR]).join(",");}}node=em.execCommand("AddCondition",o);if(!this.props.formView){switch(parseInt(et)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:node.isAllFormQual=true;break;}}em.execCommand("EditNode",node);}if(node){node.editedByQualifier=true;}};Q.prototype.onInsertNode=function Q_onInsertNode(evt){var path=evt&&evt.memo&&evt.memo.path;if(path=="0"){var m=this.getModel();this._updateEditNode(m);}};Q.prototype._attachLayoutHandlers=function Q_attLHs(){mstr.views.BaseView.prototype._attachLayoutHandlers.apply(this);var model=this.props.model;model=model&&model.get("selected");if(model&&model.attachEventListener){model.attachEventListener(this,"set_editNode","onSetEditNode");model.attachEventListener(this,"edit_condition","onEditCondition");model.attachEventListener(this,"insert_ANDOR","onInsertNode");model.attachEventListener(this,"insert_NOT","onInsertNode");model.attachEventListener(this,"insert_condition","onInsertNode");}};Q.prototype._detachLayoutHandlers=function Q_detLHs(){mstr.views.BaseView.prototype._detachLayoutHandlers.apply(this);var model=this.props.model;model=model&&model.get("selected");if(model&&model.attachEventListener){model.detachEventListener(this,"set_editNode");model.detachEventListener(this,"edit_condition");model.detachEventListener(this,"insert_ANDOR");model.detachEventListener(this,"insert_NOT");model.detachEventListener(this,"insert_condition");}};Q.prototype.render=function Q_render(){var formView=this.props.formView;if(formView&&((formView.props&&formView.props.visible==false)||(formView.visible==false))){this.props.formView=null;}mstr.views.BaseView.prototype.render.apply(this);this.onSetEditNode();};Q.prototype.onSetEditNode=function Q_onSetEditNode(){var m=this.props.model,em=m&&m.get("selected");if(m._updateTargetListModel){m._updateTargetListModel();}if(m._updateFormListModel){m._updateFormListModel();}if(m._updateFunctionListModel){m._updateFunctionListModel();}if(m._updateElementsFunctionListModel){m._updateElementsFunctionListModel();}if(m._updateCachedConstantModel){m._updateCachedConstantModel(1);}if(m._updateCachedConstantModel){m._updateCachedConstantModel(2);}if(m._updateElementsListModel){m._updateElementsListModel();}if(m._updateLevelListModel){m._updateLevelListModel();}if(m._updateExprTypeListModel){m._updateExprTypeListModel();}switch(parseInt(this.props.expressionType)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:var editNode=em&&em.props.editNode;if(!this.props.functionView&&!this.props.listFunctionView){if(editNode&&!(editNode.value&&editNode.value["function"])){var defaultFunc=m.props.defaultFunction;defaultFunc=defaultFunc&&defaultFunc.split(",")||[];em&&em.execCommand("EditConditionFunction",{id:defaultFunc[0],tp:defaultFunc[1]});}}break;}var et=this._getEditNodeExprType();this.toggleExprTypeViews(et);switch(et){case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:this.toggleListChildViewsEnabled();break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:default:this.toggleQualChildViewsEnabled();this.toggleQualConstantViews();break;}};Q.prototype._getEditNodeExprType=function Q_getEditNodeExprType(){var m=this.props.model,em=m&&m.get("selected"),editNode=em&&em.get("editNode"),et=mstr.utils.QualNode.getExpressionType(editNode);return et||parseInt(this.props.expressionType)||null;};Q.prototype.toggleExprTypeView=function Q_toggleExprTypeView(m){if(!m){var m=this.props.model;}var exprTypeView=this.props.exprTypeView;if(exprTypeView){var etlm=m&&m.getExprTypeListModel();if(mstr.$A.len(etlm&&etlm.getItems())<2){this.execHideChild("exprTypeView");}else{this.execShowChild("exprTypeView");}}};Q.prototype.toggleExprTypeViews=function Q_toggleExprTypeViews(et){var listViews=["listFunctionView","elementsView","editElementsView"];var qualViews=["formView","functionView","constant1View","constant2View"];var m=this.props.model,em=m&&m.get("selected");if(em&&(em.get("allowElementBrowse")!=false)){qualViews.push("browse1View","browse2View");}if(em&&(em.get("allowFileImport")!=false)){qualViews.push("import1View");}var hiddenViews=listViews,shownViews=qualViews;if(et==mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL){hiddenViews=qualViews;shownViews=listViews;}for(var i=0,len=hiddenViews.length;i<len;i++){this.execHideChild(hiddenViews[i]);}for(var i=0,len=shownViews.length;i<len;i++){this.execShowChild(shownViews[i]);}};Q.prototype.onEditCondition=function Q_onEditCondition(evt){if(!evt||!evt.memo){return ;}if(evt.memo.changedTarget){this.toggleExprTypeView();}var et=this._getEditNodeExprType();if(evt.memo.changedExprType){this.toggleExprTypeViews(et);}switch(et){case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:this.toggleListChildViewsEnabled();break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:default:if(evt.memo.changedTarget||evt.memo.changedExprType){this.toggleQualChildViewsEnabled();}if(evt.memo.changedExprType||evt.memo.changedTarget||evt.memo.changedForm){this.toggleQualBrowseViewsEnabled();}if(evt.memo.changedExprType||evt.memo.changedTarget||evt.memo.changedFunction){this.toggleQualConstantViews();}}};Q.prototype.toggleQualChildViewsEnabled=function Q_toggleQualChildViewsEnabled(){var bEnabled=true;var exprType=this._getEditNodeExprType();if(exprType){var em=this.props.model&&this.props.model.get("selected");var editNode=em&&em.get("editNode");var target=editNode&&mstr.utils.QualNode.getTarget(editNode);var targetType=parseInt(target&&target.tp);var isNone=target&&(target.dssid==0);switch(exprType){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:bEnabled=!isNone&&((targetType==mstr.Enum.MSTRFolderItem.TYPE.METRIC)||(targetType==mstr.Enum.MSTRFolderItem.TYPE.AGGMETRIC));break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:bEnabled=!isNone&&(targetType==mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTE);break;}}var childNames=["formView","functionView","constant1View","import1View","constant2View","levelView"];for(var i=0;i<childNames.length;i++){var childView=this.props[childNames[i]];if(childView){mstr.controllers.Factory.setPath("enabled",childView,bEnabled,false);}}if(bEnabled){this.toggleQualBrowseViewsEnabled();}else{mstr.controllers.Factory.setPath("enabled",this.props.browse1View,false,false);mstr.controllers.Factory.setPath("enabled",this.props.browse2View,false,false);}};Q.prototype.toggleQualBrowseViewsEnabled=function Q_toggleQualBrowseViewsEnabled(){var bEnabled=false,et=this._getEditNodeExprType();switch(et){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:var em=this.props.model&&this.props.model.get("selected"),editNode=em&&em.get("editNode"),target=editNode&&mstr.utils.QualNode.getTarget(editNode),form=editNode&&mstr.utils.QualNode.getForm(editNode);bEnabled=!!(target&&!target.locked)&&!!(form&&form.isBrowseForm);break;}mstr.controllers.Factory.setPath("enabled",this.props.browse1View,bEnabled,false);mstr.controllers.Factory.setPath("enabled",this.props.browse2View,bEnabled,false);};Q.prototype.toggleListChildViewsEnabled=function Q_toggleListChildViewsEnabled(){var bEnabled=false,et=this._getEditNodeExprType();switch(et){case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:var em=this.props.model&&this.props.model.get("selected"),editNode=em&&em.get("editNode"),target=editNode&&mstr.utils.QualNode.getTarget(editNode);bEnabled=!!(target)&&target.dssid!="0";break;}var childNames=["listFunctionView","elementsView","editElementsView"];for(var i=0;i<childNames.length;i++){var childView=this.props[childNames[i]];if(childView){mstr.controllers.Factory.setPath("enabled",childView,bEnabled,false);}}};Q.prototype.toggleQualConstantViews=function Q_toggleQualConstantViews(){var funcObj=null;var funcView=this.props.functionView;if(funcView){var m=funcView.props?funcView.props.model:funcView.model;funcObj=m&&m.getSelectedItem();}else{funcObj=mstr.utils.QualNode.getFunction(this.props.model.props.selected.props.editNode);}var iVisible=mstr.utils.QualNode.computeFunctionConstantsRequired(funcObj&&funcObj.id,this.props.expressionType);var childView;var m=this.props.model,em=m&&m.get("selected");var editNode=em&&em.get("editNode");var target=editNode&&mstr.utils.QualNode.getTarget(editNode);var isNone=target&&(target.dssid==0);for(var i=1;i<=2;i++){this.execCommand((iVisible>=i)?"ShowChild":"HideChild","constant"+i+"View");if(em&&(em.get("allowElementBrowse")!=false)){this.execCommand((iVisible>=i)?"ShowChild":"HideChild","browse"+i+"View");}if(iVisible>=i){var childView=this.props["constant"+i+"View"];if(childView){mstr.controllers.Factory.setPath("enabled",childView,target&&!isNone,false);}}}if(em&&(em.get("allowFileImport")!=false)){this.execCommand((iVisible>=1)?"ShowChild":"HideChild","import1View");}};function Q(props){mstr.views.BaseView.apply(this,[props]);}return Q;})();mstr.views.ExpressionEditor=(function(){mstr.$O.extendsClass(EE,mstr.views.BaseView);EE.prototype._attachLayoutHandlers=function EE_attachLayoutHandlers(){mstr.views.BaseView.prototype._attachLayoutHandlers.apply(this);var model=this.props.model;if(model&&model.attachEventListener){model.attachEventListener(this,"insert_condition","onInsertCondition");model.attachEventListener(this,"insert_ANDOR","onInsertANDOR");model.attachEventListener(this,"insert_NOT","onInsertNOT");model.attachEventListener(this,"remove_condition","onRemoveNonNOTNode");model.attachEventListener(this,"remove_ANDOR","onRemoveNonNOTNode");model.attachEventListener(this,"remove_NOT","onRemoveNOT");model.attachEventListener(this,"edit_condition","onEditCondition");model.attachEventListener(this,"edit_ANDOR","onEditANDOR");model.attachEventListener(this,"hashadd_selections","onAddSelections");model.attachEventListener(this,"hashremove_selections","onRemoveSelections");}};EE.prototype._detachLayoutHandlers=function EE_detachLayoutHandlers(){mstr.views.BaseView.prototype._detachLayoutHandlers.apply(this);var model=this.props.model;if(model&&model.detachEventListener){model.detachEventListener(this,"insert_condition");model.detachEventListener(this,"remove_condition");model.detachEventListener(this,"edit_condition");model.detachEventListener(this,"insert_ANDOR");model.detachEventListener(this,"remove_ANDOR");model.detachEventListener(this,"edit_ANDOR");model.detachEventListener(this,"insert_NOT");model.detachEventListener(this,"remove_NOT");model.detachEventListener(this,"hashadd_selections");model.detachEventListener(this,"hashremove_selections");}};EE.prototype.onInsertNOT=function EE_onInsertNOT(evt){if(evt&&evt.memo&&evt.memo.node){return this.refreshPreceedingANDORValue(evt.memo.node.children&&evt.memo.node.children[0],evt.memo.path+mstr.models.AbstractTreeBase.PATHDELIM+"0",true);}};EE.prototype.onRemoveNOT=function EE_onRemoveNOT(evt){if(evt&&evt.memo&&evt.memo.path!=null){var m=this.props.model;if(m){return this.refreshPreceedingANDORValue(m.getNodeAt(evt.memo.path),evt.memo.path,false);}}};EE.prototype.onEditANDOR=function EE_onEditANDOR(evt){var node=evt&&evt.memo&&evt.memo.node;if(!node){return ;}var m=this.props.model,path=m&&m.getNodePath(node);var loc=this._findElementForPath(path);var elBQContainer=loc&&loc.element;var elChildrenContainer=elBQContainer&&elBQContainer.childNodes&&elBQContainer.childNodes[1];var cNodes=elChildrenContainer&&elChildrenContainer.childNodes;if(!cNodes){return false;}var c=node.children;var len=mstr.$A.len(c);var itemRenderer=mstr.utils.ListViewHelper.getItemRenderer(this),doc=this.props.document;var child,elExisting,elNew;for(var i=1;i<len;i++){child=mstr.utils.ExprNode.findNonNOTChild(node,i);if(!child){continue;}elExisting=cNodes[i*2-1];if(!elExisting){continue;}var elNew=this.paintPreceedingANDORValue(child,mstr.utils.ExprNode.isNOTNode(child.parent),itemRenderer,doc);elExisting.style.display="none";mstr.utils.Dom.insertNode(elNew,elChildrenContainer,elExisting);elChildrenContainer.removeChild(elExisting);}};EE.prototype.onEditCondition=function EE_onEditCondition(evt){if(evt&&evt.memo&&evt.memo.node){var node=evt.memo.node,m=this.props.model,path=m&&m.getNodePath(node);this.refreshPreceedingANDORValue(node,path,mstr.utils.ExprNode.isNOTNode(node.parent));this.refreshCondition(node,path);return true;}return false;};EE.prototype.refreshCondition=function EE_refreshCondition(node,path){var loc=this._findElementForPath(path);if(!loc||!loc.parent){return ;}var elExisting=loc.parent.childNodes[loc.childIndex];if(!elExisting){return ;}var itemRenderer=mstr.utils.ListViewHelper.getItemRenderer(this),m=this.props.model,rootTag=this.props.element;var sel=m&&m.get("selections"),selInstance=m&&m.get("selectedInstanceChild");var elCond=this.paintCondition(node,this.props.document,itemRenderer);elExisting.style.display="none";mstr.utils.Dom.insertNode(elCond,loc.parent,elExisting);loc.parent.removeChild(elExisting);if(sel&&sel[node.id]&&!selInstance){itemRenderer.markAsSelected(this,m,this.props.element,{node:node,path:path,el:elCond});}};EE.prototype.refreshPreceedingANDORValue=function EE_refPrecANDORValue(node,path,isNOT){if(!node||(path==null)){return false;}var loc=this._findElementForPath(path);if(!loc||!loc.parent||loc.childIndex<1){return false;}var elExisting=loc.parent.childNodes[loc.childIndex-1];if(!elExisting){return false;}var elANDOR=this.paintPreceedingANDORValue(node,isNOT,mstr.utils.ListViewHelper.getItemRenderer(this),this.props.document);if(elANDOR){elExisting.style.display="none";mstr.utils.Dom.insertNode(elANDOR,loc.parent,elExisting);loc.parent.removeChild(elExisting);return true;}return false;};EE.prototype.onInsertCondition=function EE_onInsertCond(evt){if(evt&&evt.memo&&evt.memo.path&&evt.memo.node){return this._onInsertNonNOT(evt.memo.node,evt.memo.path,"paintCondition",true);}};EE.prototype.onInsertANDOR=function EE_onInsertANDOR(evt){if(evt&&evt.memo&&evt.memo.path&&evt.memo.node){return this._onInsertNonNOT(evt.memo.node,evt.memo.path,"paintANDORContainer",true);}};EE.prototype._onInsertNonNOT=function EE_onInsertNonNOT(node,path,paintMethodName,bPaintSucceedingANDOR){if(!node){return ;}var loc=this._findElementForPath(path);if(!loc||!loc.parent){return ;}var elExisting=loc.parent.childNodes[loc.childIndex];var elExistingPrevious=elExisting&&elExisting.previousSibling;var itemRenderer=mstr.utils.ListViewHelper.getItemRenderer(this),m=this.props.model,rootTag=this.props.element;var sel=m&&m.get("selections"),selInstance=m&&m.get("selectedInstanceChild");var parentInfo=mstr.utils.ExprNode.findNonNOTParentInfo(node);var bIsFirst=!parentInfo||!parentInfo.parent||!parentInfo.childIndex;if(!bIsFirst){var elANDOR=this.paintPreceedingANDORValue(node,mstr.utils.ExprNode.isNOTNode(node.parent),itemRenderer,this.props.document);mstr.utils.Dom.insertNode(elANDOR,loc.parent,elExistingPrevious||elExisting);if(selInstance==node){itemRenderer.markAsSelected(this,m,rootTag,{el:elANDOR});}}var elCond=this[paintMethodName](node,this.props.document,itemRenderer);mstr.utils.Dom.insertNode(elCond,loc.parent,elExistingPrevious||elExisting);if(sel&&sel[node.id]&&!selInstance){itemRenderer.markAsSelected(this,m,this.props.element,{node:node,path:path,el:elCond});}if(bPaintSucceedingANDOR){if(bIsFirst){var nextSiblingNode=parentInfo&&parentInfo.parent&&mstr.utils.ExprNode.findNonNOTChild(parentInfo.parent,parentInfo.childIndex+1);if(nextSiblingNode){var elANDORAfter=this.paintPreceedingANDORValue(nextSiblingNode,mstr.utils.ExprNode.isNOTNode(parentInfo.parent.children[parentInfo.childIndex+1]),itemRenderer,this.props.document);mstr.utils.Dom.insertNode(elANDORAfter,loc.parent,elCond.nextSibling);if(selInstance==nextSiblingNode){itemRenderer.markAsSelected(this,m,rootTag,{el:elANDORAfter});}}}}if(paintMethodName=="paintANDORContainer"){var c=node.children;var childInfo;for(var i=0,len=mstr.$A.len(c);i<len;i++){childInfo=mstr.utils.ExprNode.findNonNOTChildInfo(node,i);if(childInfo&&childInfo.child){paintMethodName=mstr.utils.ExprNode.isANDORNode(childInfo.child)?"paintANDORContainer":"paintCondition";this._onInsertNonNOT(childInfo.child,path+mstr.models.AbstractTreeBase.PATHDELIM+i+childInfo.path,paintMethodName,false);}}}};EE.prototype.onRemoveNonNOTNode=function EE_onRemoveNonNOTNode(evt){var path=evt&&evt.memo&&evt.memo.path;if(!path){return ;}if(evt.memo.wasNOT){path=path.substring(0,Math.max(path.length-2,0));}var loc=this._findElementForPath(path);if(!loc||!loc.parent){return ;}var elNode=loc.parent.childNodes[loc.childIndex];var elPreceedingANDOR=elNode&&elNode.previousSibling;var elNextANDOR=elNode&&elNode.nextSibling;if(elNode){loc.parent.removeChild(elNode);}if(elPreceedingANDOR){loc.parent.removeChild(elPreceedingANDOR);}else{if(elNextANDOR){loc.parent.removeChild(elNextANDOR);}}};EE.prototype.onAddSelections=function EE_onAddSelections(evt){return this._toggleSelections(evt,"markAsSelected");};EE.prototype.onRemoveSelections=function EE_onRmvSelections(evt){return this._toggleSelections(evt,"markAsUnselected");};EE.prototype._toggleSelections=function EE_onAddSelections(evt,methodName){var nodes=evt&&evt.memo&&evt.memo.at;if(!nodes){return ;}var v=this,m=this.props.model,rt=this.props.element,itemRenderer=mstr.utils.ListViewHelper.getItemRenderer(this);if(!m||!itemRenderer||!itemRenderer[methodName]){return ;}var node,path,elInfo;if(m.props.selectedInstanceChild){node=m.props.selectedInstanceChild;path=m.getNodePath(node);elInfo=this._findElementForPath(path);var el=elInfo&&elInfo.element&&elInfo.element.previousSibling;if(el){itemRenderer[methodName](v,m,rt,{node:node,path:path,el:el});}}else{for(var id in nodes){node=nodes[id];if(!node){continue;}path=m.getNodePath(node);elInfo=this._findElementForPath(path);if(!elInfo||!elInfo.element){continue;}itemRenderer[methodName](v,m,rt,{node:node,path:path,el:elInfo.element});}}};EE.prototype.render=function EE_render(){mstr.views.BaseView.prototype.render.apply(this);var el=this.execLayoutHandler("treeRootParent");this.props.treeRootParent=el;if(el){var m=this.getModel();var root=m&&m.get("rootNode");if(root){this._renderSubTree(root,[0],mstr.utils.ListViewHelper.getItemRenderer(this),el,el.ownerDocument);}}mstr.timers.renderStop=new Date();mstr.timers.render=mstr.timers.renderStop-mstr.timers.renderStart;};EE.prototype._renderSubTree=function EE_renderSubTree(node,pathIndices,itemRenderer,elParent,doc){if(!itemRenderer){retrun;}var nodeToPaint=node,pathIndicesToPaint=[].concat(pathIndices),bFoundNOT=false;while(mstr.utils.ExprNode.isNOTNode(nodeToPaint)){bFoundNOT=!bFoundNOT;nodeToPaint=nodeToPaint.children[0];pathIndicesToPaint.push(0);}if(!nodeToPaint){return ;}if(pathIndices[pathIndices.length-1]){elParent.appendChild(this.paintPreceedingANDORValue(nodeToPaint,bFoundNOT,itemRenderer,doc));}if(mstr.utils.ExprNode.isANDORNode(nodeToPaint)||mstr.utils.ExprNode.isTUPLENode(nodeToPaint)){var el=this.paintANDORContainer(nodeToPaint,doc);elParent.appendChild(el);var c=nodeToPaint.children;for(var i=0,len=mstr.$A.len(c);i<len;i++){this._renderSubTree(c[i],pathIndicesToPaint.concat(i),itemRenderer,el.childNodes[1],doc);}}else{elParent.appendChild(this.paintCondition(nodeToPaint,doc,itemRenderer));}};EE.prototype.paintANDORContainer=function EE_paintANDORContainer(node,doc,itemRenderer){if(!doc){return null;}var css=(this.props.cssPrefix||"")+(this.props.cssClass||"");var el=doc.createElement("div");el.className=css+"BranchQual";var elP=doc.createElement("div");el.appendChild(elP);elP.className=css+"BranchQualPrefix";var elC=doc.createElement("div");el.appendChild(elC);elC.className=css+"BranchQualContent";var elS=doc.createElement("div");el.appendChild(elS);elS.className=css+"BranchQualSuffix";return el;};EE.prototype.paintCondition=function EE_paintCondition(node,doc,itemRenderer){if(!doc||!itemRenderer){return null;}var css=(this.props.cssPrefix||"")+(this.props.cssClass||"");var el=doc.createElement("div");el.className=css+"ConditionContainer";el.mstrExprNodeInfo=node.id+",0";if(!this.props.readOnly){el.onmouseover=itemRenderer.hover;el.onmouseout=itemRenderer.unhover;}var methodName="renderUnknownCondition",context={node:node,el:el};switch(mstr.utils.QualNode.getExpressionType(node)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:methodName="renderMetricQualifier";context={node:node,el:el,metric:mstr.utils.QualNode.getTarget(node),"function":mstr.utils.QualNode.getFunction(node,true),level:mstr.utils.QualNode.getLevel(node,true)};var constCount=mstr.utils.QualNode.computeFunctionConstantsRequired(context["function"]&&context["function"]["id"],mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL);var constNode;for(var i=1;i<=constCount;i++){constNode=mstr.utils.QualNode.getConstantNode(node,i);context["constant"+i]=constNode&&constNode.value;}break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:methodName="renderAttributeQualifier";context={node:node,el:el,attribute:mstr.utils.QualNode.getTarget(node),form:mstr.utils.QualNode.getForm(node),"function":mstr.utils.QualNode.getFunction(node,true),exprType:mstr.utils.QualNode.getExprType(node)};var constCount=mstr.utils.QualNode.computeFunctionConstantsRequired(context["function"]&&context["function"]["id"],mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL);var constNode;for(var i=1;i<=constCount;i++){constNode=mstr.utils.QualNode.getConstantNode(node,i);context["constant"+i]=constNode&&constNode.value;}break;case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:methodName="renderAttributeElementList";context={node:node,el:el,attribute:mstr.utils.QualNode.getTarget(node),"function":mstr.utils.QualNode.getFunction(node,true),elements:mstr.utils.QualNode.getElements(node),exprType:mstr.utils.QualNode.getExprType(node)};break;}var elCond=itemRenderer[methodName]&&itemRenderer[methodName](this,this.props.model,this.props.element,context);elCond&&el.appendChild(elCond);return el;};EE.prototype.paintPreceedingANDORValue=function EE_paintPreceedingANDORValue(node,bNOT,itemRenderer,doc){if(!doc||!itemRenderer){return null;}var andOrNode=mstr.utils.ExprNode.findNonNOTParent(node);if(andOrNode){var css=(this.props.cssPrefix||"")+(this.props.cssClass||"");var el=doc.createElement("div");el.className=css+"ANDORContainer";el.mstrExprNodeInfo=node.id+",1";el.onmouseover=itemRenderer.hover;el.onmouseout=itemRenderer.unhover;var elValue=itemRenderer.renderANDORValue(this,this.props.model,this.props.element,{node:andOrNode,el:el,funcId:parseInt(andOrNode.value["function"]),isNOT:!!bNOT});elValue&&el.appendChild(elValue);return el;}};EE.prototype.execClickExprNode=function EE_execClickExprNode(cmdValue){var m=this.props.model;if(!m){return false;}var bMulti=!!this.props.multiSelect;var node=cmdValue&&cmdValue.nodeId&&this.props.model.findByNodeId(cmdValue.nodeId);if(!node){if(bMulti){m.execCommand("ClearSelect");}return false;}else{if(cmdValue.isANDOR){var andOrNode=node.parent;var instanceChild=node;while(mstr.utils.ExprNode.isNOTNode(andOrNode)){instanceChild=andOrNode;andOrNode=andOrNode.parent;}if(andOrNode){m.execCommand("SingleSelect",{node:andOrNode,instanceChild:node});}else{if(bMulti){m.execCommand("ClearSelect");}}}else{var cmdId=null;if(cmdValue.ctrl&&bMulti){cmdId="ToggleSelect";}else{if(cmdValue.shift&&bMulti){cmdId="RangeSelect";}else{cmdId="SingleSelect";}}m.execCommand(cmdId,node);return true;}}};EE.prototype.execEditExprNode=function EE_execEditExprNode(cmdValue){if(cmdValue&&cmdValue.popup&&cmdValue.nodeId!=null){var m=this.props.model;var node=m&&m.findByNodeId(cmdValue.nodeId);if(node){var popup=mstr.$obj(cmdValue.popup);if(popup){if(m.execCommand("EditNode",node)){return this.execCommand("OpenPopup",{popup:popup,x:cmdValue.x,y:cmdValue.y,orientation:1});}}}}return false;};EE.prototype._findElementForPath=function EE_findElementForPath(path){var m=this.props.model;if(!m){return null;}var parts=m._pathParts(path);var len=mstr.$A.len(parts);if(!len){return null;}var node=m.get("rootNode");var parent=this.props.treeRootParent;var childIndex=0;var el=parent.childNodes[childIndex];var nextPathIndex;for(var i=1;i<len;i++){nextPathIndex=parts[i];node=node.children[nextPathIndex];while(node&&mstr.utils.ExprNode.isNOTNode(node)){i++;node=node.children[0];}parent=el&&el.childNodes[1];childIndex=nextPathIndex*2;el=parent.childNodes[childIndex];if(!node){break;}}return{parent:parent,childIndex:childIndex,element:el};};function EE(props){mstr.views.BaseView.apply(this,[props]);}return EE;})();mstr.models.ExpressionPromptAnswer=(function(){mstr.$O.extendsClass(EPA,mstr.models.PromptAnswer);EPA.prototype.reloadAnswer=function EPA_reloadAnswer(newAnswer){this.set("isComplex",newAnswer.props.isComplex);var em=newAnswer&&newAnswer.get("selected"),newRoot=em&&em.get("rootNode");if(newRoot){var sel=this.props.selected;if(sel){sel.props.editNode=null;sel.insertRoot(mstr.utils.Trees.cloneSubTree(newRoot));}if(this.props.dualListCart){this.props.dualListCart._updateSelectedIncludesModel();this.props.dualListCart._updateSelectedExcludesModel();}}};EPA.prototype.getListCartModel=function EPA_getListCartModel(){if(!this.props.listCart){this._initListCartModel();}return this.props.listCart;};EPA.prototype._initListCartModel=function EPA_initListCartModel(){var props={parent:this,type:this.props.type,min:this.props.min||Math.abs(!!this.props.required),max:this.props.max,available:this.props.available,selected:this.props.selected,defaultExpressionType:this.props.defaultExpressionType,allowedExpressionTypes:this.props.allowedExpressionTypes,allowedFunctions:this.props.allowedFunctions,allowedItemFormName:this.props.allowedItemFormName,allowedItemFormValues:this.props.allowedItemFormValues,prohibitedItemFormValues:this.props.prohibitedItemFormValues,defaultBranchQualId:this.props.defaultBranchQualId,maxElementsAllowed:this.props.maxElementsAllowed,allowGrouping:this.props.allowGrouping,allowAddAlways:this.props.allowAddAlways};var lc=this.props.listCart=new mstr.models.ExpressionListCart(props);mstr.controllers.Factory.add(lc);lc&&lc.init&&lc.init();lc.set("answer",this);};EPA.prototype.getDualListCartModel=function EPA_getDualListCartModel(){if(!this.props.dualListCart){this._initDualListCartModel();}return this.props.dualListCart;};EPA.prototype._initDualListCartModel=function EPA_initDualListCartModel(){var props={parent:this,type:this.props.type,min:this.props.min||Math.abs(!!this.props.required),max:this.props.max,available:this.props.available,selected:this.props.selected,defaultExpressionType:this.props.defaultExpressionType,allowedExpressionTypes:this.props.allowedExpressionTypes,allowedFunctions:this.props.allowedFunctions,allowedItemFormName:this.props.allowedItemFormName,allowedItemFormValues:this.props.allowedItemFormValues,prohibitedItemFormValues:this.props.prohibitedItemFormValues,defaultBranchQualId:this.props.defaultBranchQualId,maxElementsAllowed:this.props.maxElementsAllowed,allowGrouping:this.props.allowGrouping,allowAddAlways:this.props.allowAddAlways};var lc=this.props.dualListCart=new mstr.models.DualExpressionListCart(props);mstr.controllers.Factory.add(lc);lc&&lc.init&&lc.init();lc.set("answer",this);};EPA.prototype.getTreeModel=function EPA_getTreeModel(){if(!this.props.availableTree){this._initTreeModel();}return this.props.availableTree;};EPA.prototype._initTreeModel=function EPA_initTreeModel(){if(this.props.available){var tm=this.props.availableTree=new mstr.models.TreeModel({parent:this,valueForm:this.props.available.get("valueForm")});mstr.controllers.Factory.add(tm);tm.importListModel(this.props.available);tm&&tm.init&&tm.init();}};EPA.prototype.getTreeCartModel=function EPA_getTreeCartModel(){if(!this.props.treeCart){this._initTreeCartModel();}return this.props.treeCart;};EPA.prototype._initTreeCartModel=function EPA_initTreeCartModel(){var props={parent:this,type:this.props.type,min:this.props.min||Math.abs(!!this.props.required),max:this.props.max,available:this.getTreeModel(),selected:this.props.selected,defaultExpressionType:this.props.defaultExpressionType,allowedExpressionTypes:this.props.allowedExpressionTypes,allowedFunctions:this.props.allowedFunctions,allowedItemFormName:this.props.allowedItemFormName,allowedItemFormValues:this.props.allowedItemFormValues,prohibitedItemFormValues:this.props.prohibitedItemFormValues,allowAddAlways:this.props.allowAddAlways};var tc=this.props.treeCart=new mstr.models.ExpressionTreeCart(props);mstr.controllers.Factory.add(tc);tc&&tc.init&&tc.init();tc.set("answer",this);};EPA.prototype.getIncludeListModel=function EPA_getIncludeListModel(exprModel){var m=this.props["includeListModel"+((exprModel&&exprModel.getId())||"")];if(!m){m=new mstr.models.ListModel({parent:this,valueForm:"dssid"});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props["includeListModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateIncludeListModel(exprModel);return m;};EPA.prototype._updateIncludeListModel=function EPA_updateIncludeListModel(exprModel){var m=this.props["includeListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}m.setItems(mstr.Settings.Functions.Include);var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var incState=mstr.utils.ExprNode.getInclude(node);var index=incState?m.indexOfItem(incState):-1;if(index>-1){m.execCommand("SingleSelect",index);}};EPA.prototype.getExprTypeListModel=function EPA_getExprTypeListModel(exprModel){var m=this.props["exprTypeListModel"+((exprModel&&exprModel.getId())||"")];if(!m){m=new mstr.models.ListModel({parent:this,valueForm:"dssid",items:[]});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props["exprTypeListModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateExprTypeListModel(exprModel);return m;};EPA.prototype._updateExprTypeListModel=function EPA_updateExprTypeListModel(exprModel){var m=this.props["exprTypeListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var arrMaster=mstr.Settings.Functions.ExprType,arrFiltered=[];var arrAllowed=mstr.utils.Expr.getAllowedExprTypesArray(sel);var lenAllowed=mstr.$A.len(arrAllowed);if(lenAllowed){var index;for(var i=0;i<lenAllowed;i++){index=mstr.$A.findByForm(arrMaster,parseInt(arrAllowed[i]),"dssid");arrFiltered.push(arrMaster[index]);}}else{arrFiltered=arrFiltered.concat(arrMaster);}m.props.items=arrFiltered;var index=m.indexOfValue(mstr.utils.QualNode.getExpressionType(node));if(index>-1){m.execCommand("SingleSelect",index);}else{m.execCommand("ClearSelect");}};EPA.prototype.getRootOperatorListModel=function EPA_getRootOperatorListModel(exprModel){if(!exprModel){exprModel=this.get("selected");}var m=this.props["rootOperatorListModel"+((exprModel&&exprModel.getId())||"")];if(!m){m=new mstr.models.ListModel({parent:this,valueForm:"dssid",items:mstr.Settings.Functions.RootOperator});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props["rootOperatorListModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateRootOperatorListModel(exprModel);return m;};EPA.prototype._updateRootOperatorListModel=function EPA_updateRootOpListModel(exprModel){var m=this.props["rootOperatorListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}var sel=exprModel||this.props.selected;var node=sel&&sel.get("rootNode");var bq=mstr.utils.ExprNode.isANDORNode(node)?node.value["function"]:mstr.utils.Expr.getDefaultRootOperator(this);var index=bq?m.indexOfValue(bq):-1;if(index>-1){m.execCommand("SingleSelect",index);}};EPA.prototype.getBranchQualListModel=function EPA_getBranchQualListModel(exprModel){var m=this.props["branchQualListModel"+((exprModel&&exprModel.getId())||"")];if(!m){m=new mstr.models.ListModel({parent:this,valueForm:"dssid"});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props["branchQualListModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateBranchQualListModel(exprModel);return m;};EPA.prototype._updateBranchQualListModel=function EPA_updateBQListModel(exprModel){var m=this.props["branchQualListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}m.setItems(mstr.Settings.Functions.BranchQual);var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var bq=mstr.utils.ExprNode.getBranchQual(node);var index=bq?m.indexOfItem(bq):-1;if(index>-1){m.execCommand("SingleSelect",index);}};EPA.prototype.getTargetListModel=function EPA_getTargetListModel(exprModel){var m=this.props["targetListModel"+((exprModel&&exprModel.getId())||"")];if(!m){m=this.props.available&&this.props.available.clone();if(!m){return ;}this.props["targetListModel"+((exprModel&&exprModel.getId())||"")]=m;}this._updateTargetListModel(exprModel);return m;};EPA.prototype._updateTargetListModel=function EPA_updateTargetListModel(exprModel){var m=this.props["targetListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var target=mstr.utils.QualNode.getTarget(node);var arrAllowed=mstr.utils.Expr.getAllowedExprTypesArray(sel);if(mstr.$A.find(arrAllowed,mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL)==-1){m.set("allowedItemFormName","icon");m.set("prohibitedItemFormValues",mstr.Enum.MSTRFolderItem.ICON.ELEMENT);}else{if(mstr.$A.find(arrAllowed,mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL)==-1){m.set("allowedItemFormName","locked");m.set("prohibitedItemFormValues","true");}else{m.set("allowedItemFormName","");m.set("prohibitedItemFormValues","");}}var index=target?m.indexOfItem(target):-1;if(index>-1){m.execCommand("SingleSelect",index);}else{var items=m.get("items"),firstItem=items&&items[0];if(firstItem&&firstItem.dssid=="0"){m.execCommand("SingleSelect",0);}else{m.execCommand("ClearSelect");}}};EPA.prototype.getFormListModel=function EPA_getFormListModel(exprModel){var m=this.props["formListModel"+((exprModel&&exprModel.getId())||"")];if(!m){var dataSourcesXML=this.props.available&&this.props.available.get("dataSourcesXML");m=new mstr.models.ListModel({parent:this,valueForm:"dssid",keepSelectionsAfterRequest:true,dataSourcesXML:dataSourcesXML});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props["formListModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateFormListModel(exprModel);return m;};EPA.prototype._updateFormListModel=function EPA_updateFormListModel(exprModel){var m=this.props["formListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var target=mstr.utils.QualNode.getTarget(node),isTargetAttribute=target&&target.dssid&&target.dssid!="0"&&(parseInt(target.tp)==mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTE),form=(isTargetAttribute&&mstr.utils.QualNode.getForm(node))||null,formsFound=false;if(isTargetAttribute){var contNode=m.getContainer();if(contNode&&contNode.value&&contNode.value.dssid==target.dssid){formsFound=true;}else{var forms=target.dssforms;formsFound=!!mstr.$A.len(forms);if(formsFound){m.setContainerTree({value:target});m.setItems([].concat(target.dssforms));}}}if(formsFound){var index=form?m.indexOfItem(form):-1;if(index>-1){m.execCommand("SingleSelect",index);}else{m.execCommand("ClearSelect");}}else{m.setContainerTree(null);m.setItems([]);if(isTargetAttribute){if(form){m.setItems([form]);m.execCommand("SingleSelect",0);}m.execCommand("BrowseForms",{attributeId:target.dssid,formCategory:this.props.formCategory});}else{m.execCommand("CancelRequest");m.set("readyState",mstr.Enum.Widget.READYSTATE.IDLE);}}};EPA.prototype.getFunctionListModel=function EPA_getFunctionListModel(exprModel){var m=this.props["functionListModel"+((exprModel&&exprModel.getId())||"")];if(!m){m=new mstr.models.ListModel({parent:this,valueForm:"dssid"});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props["functionListModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateFunctionListModel(exprModel);return m;};EPA.prototype._updateFunctionListModel=function EPA_updateFunctionListModel(exprModel){var m=this.props["functionListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var arr=sel.get("allowedFunctions");if(!mstr.$A.len(arr)){arr=mstr.utils.QualNode.getAvailableFunctions(this.props.functionCategory,node);}m.setItems(arr);var func=mstr.utils.QualNode.getFunction(node);var index=func?m.indexOfItem(func):-1;if(index>-1){m.execCommand("SingleSelect",index);}};EPA.prototype.getElementsFunctionListModel=function EPA_getElemsFunctionListModel(exprModel){var m=this.props["elementsFunctionListModel"+((exprModel&&exprModel.getId())||"")];if(!m){m=new mstr.models.ListModel({parent:this,valueForm:"dssid",items:[].concat(mstr.Settings.Functions.Element)});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props["elementsFunctionListModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateElementsFunctionListModel(exprModel);return m;};EPA.prototype._updateElementsFunctionListModel=function EPA_updateElemsFunctionListModel(exprModel){var m=this.props["elementsFunctionListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var func=mstr.utils.QualNode.getFunction(node);var index=func?m.indexOfItem(func):-1;if(index>-1){m.execCommand("SingleSelect",index);}};EPA.prototype.getConstant1Model=function EPA_getConstant1Model(exprModel){return this._getConstantModel(1,exprModel,false);};EPA.prototype.getConstant1CloneModel=function EPA_getConstant1CloneModel(exprModel){return this._getConstantModel(1,exprModel,true);};EPA.prototype.getConstant2Model=function EPA_getConstant2Model(exprModel){return this._getConstantModel(2,exprModel,false);};EPA.prototype.getConstant2CloneModel=function EPA_getConstant2CloneModel(exprModel){return this._getConstantModel(2,exprModel,true);};EPA.prototype._getConstantModel=function EPA_getConstantModel(num,exprModel,bClone){var m=this._getCachedConstantModel(num,exprModel,bClone);this._updateCachedConstantModel(num,exprModel,bClone);return m;};EPA.prototype._getCachedConstantModel=function EPA_getCachedConstantModel(num,exprModel,bClone){var cacheKey="constant"+num+"Model"+((exprModel&&exprModel.getId())||"")+(bClone?"Clone":""),m=this.props[cacheKey];if(!m){var props=this.props;m=new mstr.models.ConstantPromptAnswer({parent:this,dateFormat:props.dateFormat||mstr.Settings.Locale.DATEOUTPUTFORMAT,timeFormat:props.timeFormat||mstr.Settings.Locale.TIMEOUTPUTFORMAT,firstDayOfWeek:(props.firstDayOfWeek!=null)?props.firstDayOfWeek:1,TwoDigitStart:mstr.Settings.Locale.TWODIGITYEARSTART,monthDescs:this.props.monthDescs||mstr.Settings.Locale.MONTHNAME_FULL,dayDescs:this.props.dayDescs,timeDescs:this.props.timeDescs});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props[cacheKey]=m;}}return m;};EPA.prototype._updateCachedConstantModel=function EPA_updateCachedConstantModel(num,exprModel,bClone){var cacheKey="constant"+num+"Model"+((exprModel&&exprModel.getId())||"")+(bClone?"Clone":""),m=this.props[cacheKey];if(!m){return ;}var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var constNode=mstr.utils.QualNode.getConstantNode(node,num,false,this.getId());if(bClone){m.set("validationStatus",null);m.set("message",null);}m.set("dataType",mstr.utils.QualNode.getDataType(node,false));m.set("multiSelect",num!=2&&mstr.utils.QualNode.isINQual(node));var constVal=mstr.utils.ConstNode.getValue(constNode);m.set("valueString",constVal);if(this.props.descriptors){m.set("descriptors",this.props.descriptors);}};EPA.prototype.getLevelListModel=function EPA_getLevelListModel(exprModel){var m=this.props["levelListModel"+((exprModel&&exprModel.getId())||"")];if(!m){m=new mstr.models.ListModel({parent:this,valueForm:"dssid"});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props["levelListModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateLevelListModel(exprModel);return m;};EPA.prototype._updateLevelListModel=function EPA_updateLevelListModel(exprModel){var m=this.props["levelListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}m.setItems([].concat(mstr.Settings.DimtyLevels));var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var level=mstr.utils.QualNode.getLevel(node);var index=level?m.indexOfItem(level):-1;if(index>-1){m.execCommand("SingleSelect",index);}else{if(level){index=m.insertItemsAt([level]);m.execCommand("SingleSelect",index);}else{m.execCommand("ClearSelect");}}};EPA.prototype.getLevelCartModel=function EPA_getLevelCartModel(exprModel){var m=this.props["levelCartModel"+((exprModel&&exprModel.getId())||"")];if(!m){var dataSourcesXML=this.props.available&&this.props.available.get("dataSourcesXML");var rootFolderName=mstr.Enum.App.EnumDSSXMLFolderNames.DssXmlFolderNameSchemaAttributes;var rootFolder=mstr.Settings.App.namedFolders[rootFolderName];m=new mstr.models.ListCart({parent:this,valueForm:"dssid",scriptClass:"mstr.models.ListCart",available:{scriptClass:"mstr.models.ListModel",valueForm:"dssid",hierarchical:!dataSourcesXML,allowedItemFormName:"tp",allowedItemFormValues:"12",dataSourcesXML:dataSourcesXML,objectType:"12",keepFolders:true,containerTree:mstr.$H.deepClone(mstr.Settings.App.LevelPopupContainerTree)},selected:{scriptClass:"mstr.models.ListModel",valueForm:"dssid"}});if(m){mstr.controllers.Factory.add(m);if(m.init){m.init();}m.get("available").execCommand("FetchData");this.props["levelCartModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateLevelCartModel(exprModel);return m;};EPA.prototype._updateLevelCartModel=function EPA_updateLevelCartModel(exprModel){var m=this.props["levelCartModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var level=mstr.utils.QualNode.getLevel(node),attrs=level&&level.attributes||[];m.get("selected").setItems([].concat(attrs));};EPA.prototype.getElementsCartModel=function EPA_getElementsCartModel(exprModel){var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var selectedItems=mstr.utils.QualNode.getElements(node);return this._getElementsCartModel(node,selectedItems,false);};EPA.prototype.getFormValues1CartModel=function EPA_getFV1CartModel(exprModel){return this._getFormValuesCartModel(1,exprModel);};EPA.prototype.getFormValues2CartModel=function EPA_getFV2CartModel(exprModel){return this._getFormValuesCartModel(2,exprModel);};EPA.prototype._getFormValuesCartModel=function EPA_getFormValuesCartModel(num,exprModel){var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var constValues=mstr.utils.QualNode.getConstNodeValuesArray(node,num,sel.props.type);var selectedItems=[];for(var i=0,len=mstr.$A.len(constValues);i<len;i++){selectedItems.push({dssid:"dummyid"+i,n:constValues[i],tp:mstr.Enum.MSTRFolderItem.TYPE.ELEMENT,icon:mstr.Enum.MSTRFolderItem.ICON.ELEMENT,isDummy:true});}var attribute=mstr.utils.QualNode.getTarget(node);if(!attribute.dssforms){var formsModel=this.getFormListModel(exprModel);attribute.dssforms=formsModel&&formsModel.getItems();}return this._getElementsCartModel(node,selectedItems,true);};EPA.prototype._getElementsCartModel=function EPA_getElementsCartModel(editNode,selectedItems,bIncludeFormValues){var bcMap=this.props.available&&this.props.available.get("blockCountMap");var attribute=mstr.utils.QualNode.getTarget(editNode);var dataSourcesXML=this.props.available&&this.props.available.get("dataSourcesXML");var dimensionId=this.props.available&&this.props.available.get("dimensionId");var almProps={scriptClass:"mstr.models.ListModel",valueForm:"dssid",container:mstr.$H.deepClone(attribute),blockCountMap:bcMap,dataSourcesXML:dataSourcesXML,dimensionId:dimensionId,includeFormValues:!!bIncludeFormValues,collectForms:!!bIncludeFormValues,elementSearchDisabled:this.props.available&&this.props.available.get("elementSearchDisabled"),displayedForms:(this.props.type=="SAP_CHAR_VARIABLE"||this.props.type=="SAP_HIER_NODE_VARIABLE")?mstr.Enum.Widget.DISPLAYEDFORMS.SAP_QUAL:mstr.Enum.Widget.DISPLAYEDFORMS.BROWSE};var slmProps={scriptClass:"mstr.models.ListModel",valueForm:"dssid",items:[].concat(selectedItems)};var maxElems=-1;var selEM=this.props.selected;var et=mstr.utils.QualNode.getExpressionType(editNode);switch(et){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:if(!mstr.utils.QualNode.isINQual(editNode)){maxElems=1;}break;case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:maxElems=this.props.maxElementsAllowed;break;}var cm=new mstr.models.ListCart({parent:this,valueForm:"dssid",available:almProps,selected:slmProps,blockCountMap:bcMap,max:maxElems,keepAvailableItems:this.props.keepAvailableItems,keepAvailableSorted:this.props.keepAvailableSorted});if(cm){mstr.controllers.Factory.add(cm);cm.init&&cm.init();var alm=cm.get("available");if(alm&&alm.execCommand&&attribute&&attribute.dssid!="0"){alm.execCommand("BrowseAttribute",attribute.dssid);}}return cm;};EPA.prototype.getElementsListModel=function EPA_getElementsListModel(exprModel){var m=this.props["elementsListModel"+((exprModel&&exprModel.getId())||"")];if(!m){m=new mstr.models.ListModel({parent:this,scriptClass:"mstr.models.ListModel",valueForm:"dssid"});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();this.props["elementsListModel"+((exprModel&&exprModel.getId())||"")]=m;}}this._updateElementsListModel(exprModel);return m;};EPA.prototype._updateElementsListModel=function EPA_updateElementsListModel(exprModel){var m=this.props["elementsListModel"+((exprModel&&exprModel.getId())||"")];if(!m){return ;}var sel=exprModel||this.props.selected;var node=sel&&sel.get("editNode");var elems=mstr.utils.QualNode.getElements(node);elems=elems?[].concat(elems):[];m.setItems(elems);};EPA.prototype.execFetchData=function EPA_execFetchData(){var av=this.props.available;if(av&&av.shouldFetchData()){var rs,retVal;var avt=this.props.availableTree;if(avt){rs=avt.get("readyState");if(rs==null||rs==mstr.Enum.Widget.READYSTATE.IDLE){retVal=avt.execCommand("FetchFirst",avt.getSelectedNode());}}else{rs=av.get("readyState");if(rs==null||rs==mstr.Enum.Widget.READYSTATE.IDLE){retVal=av.execCommand("FetchFirst");}}if(retVal){var tlm=this.props.targetListModel;if(tlm){tlm.execCommand("FetchFirst");}}return retVal;}return false;};EPA.prototype.autoValidateCheck=function EPA_autoValidateCheck(evt){var skip=evt&&(evt.name=="insert_condition")&&evt.memo&&evt.memo.node&&evt.memo.node.autoGeneratedByView;if(skip){return ;}if(mstr.Settings.Prompts.VALIDATIONLEVEL>=mstr.Enum.Prompts.VALIDATIONLEVEL.AFTERANSWEREACH){this.validate({stage:mstr.Enum.Validation.Prompt.Stage.CHANGEANSWER});}};EPA.prototype.init=function EPA_init(){mstr.models.BaseModel.prototype.init.apply(this);this._initSelectedModel();var m=this.props.selected;if(m&&m.attachEventListener){m.attachEventListener(this,"edit_condition","onEditCondition");m.attachEventListener(this,"edit_ANDOR","onEditANDOR");m.attachEventListener(this,"insert_ANDOR","onEditANDOR");m.attachEventListener(this,"remove_ANDOR","onEditANDOR");m.attachEventListener(this,"insert_condition","autoValidateCheck");m.attachEventListener(this,"remove_condition","autoValidateCheck");}this.getTargetListModel();var av=this.props.available;if(av){av.set("keepFolders",av.get("keepFolders")||(this.get("allowNavAboveSearchRoot")!=3));}};EPA.prototype._initSelectedModel=function EPA_iSM(){if(this.props.selected){var sel=this.props.selected;var ps=["type","defaultMetricLevel","defaultFunction","defaultAttributeFunction","defaultListFunction","defaultMetricFunction","defaultExpressionType","allowedExpressionTypes","allowedFunctions","defaultAttributeExpressionType","defaultBranchQualId","maxElementsAllowed","allowGrouping"];for(var i=0;i<ps.length;i++){sel.props[ps[i]]=this.props[ps[i]];}sel.props.answer=this;return ;}var props={parent:this,type:this.props.type,defaultFunction:this.props.defaultFunction,defaultAttributeFunction:this.props.defaultAttributeFunction,defaultListFunction:this.props.defaultListFunction,defaultMetricFunction:this.props.defaultMetricFunction,defaultMetricLevel:this.props.defaultMetricLevel,defaultExpressionType:this.props.defaultExpressionType,allowedExpressionTypes:this.props.allowedExpressionTypes,defaultAttributeExpressionType:this.props.defaultAttributeExpressionType,allowedFunctions:this.props.allowedFunctions,defaultBranchQualId:this.props.defaultBranchQualId,maxElementsAllowed:this.props.maxElementsAllowed,allowGrouping:this.props.allowGrouping,valueForm:this.props.available&&this.props.available.get("valueForm")};var em=this.props.selected=new mstr.models.ExpressionModel(props);if(!em){return ;}mstr.controllers.Factory.add(em);em.init&&em.init();em.props.answer=this;};EPA.prototype.onEditCondition=function EPA_onEditCondition(evt){var memo=evt&&evt.memo;if(!memo){return ;}var bUpdateElementListModel,bUpdateIncludeListModel,bUpdateTargetListModel,bUpdateFormListModel,bUpdateFunctionListModel,bUpdateConstantModels,bUpdateExprTypeListModel,bUpdateLevelListModel,bUpdateElementsFunctionListModel;if(memo.changedTarget){bUpdateTargetListModel=true;bUpdateExprTypeListModel=true;bUpdateFormListModel=true;bUpdateFunctionListModel=true;bUpdateElementsFunctionListModel=true;bUpdateElementListModel=true;bUpdateConstantModels=true;}if(memo.changedExprType||memo.changedForm){bUpdateFormListModel=true;bUpdateFunctionListModel=true;bUpdateElementsFunctionListModel=true;bUpdateElementListModel=true;bUpdateConstantModels=true;}if(memo.changedFunction){bUpdateFunctionListModel=true;bUpdateElementsFunctionListModel=true;bUpdateConstantModels=true;}if(memo.changedConstant1||memo.changedConstant2){bUpdateConstantModels=true;}if(memo.changedElements){bUpdateElementListModel=true;}if(memo.changedInclude){bUpdateIncludeListModel=true;}if(memo.changedLevel){bUpdateLevelListModel=true;}bUpdateTargetListModel&&this._updateTargetListModel();bUpdateExprTypeListModel&&this._updateExprTypeListModel();bUpdateFormListModel&&this._updateFormListModel();bUpdateFunctionListModel&&this._updateFunctionListModel();bUpdateElementsFunctionListModel&&this._updateElementsFunctionListModel();bUpdateConstantModels&&this._updateCachedConstantModel(1);bUpdateConstantModels&&this._updateCachedConstantModel(2);bUpdateElementListModel&&this._updateElementsListModel();bUpdateIncludeListModel&&this._updateIncludeListModel();bUpdateLevelListModel&&this._updateLevelListModel();var em=this.getSelected();var editNode=em&&em.get("editNode");if(editNode&&editNode.autoGeneratedByView){editNode.autoGeneratedByView=null;}this.autoValidateCheck();};EPA.prototype.onEditANDOR=function EPA_onEditANDOR(evt){var memo=evt&&evt.memo,node=memo&&memo.node;if(node&&!node.parent){this._updateRootOperatorListModel(this.get("selected"));}};EPA.prototype.getValueString=function EPA_getValueString(){if(this.props.isComplex){return null;}var em=this.getSelected();var editNode=em&&em.get("editNode");if(editNode&&editNode.editedByQualifier){var target=mstr.utils.QualNode.getTarget(editNode);if(!target||target.dssid=="0"){em.removeCondition(editNode);}}if(editNode&&editNode.autoGeneratedByView){var et=mstr.utils.QualNode.getExpressionType(editNode);switch(et){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:var target=mstr.utils.QualNode.getTarget(editNode);if(!target||target.dssid=="0"&&editNode.editedByQualifier){em.removeCondition(editNode);break;}var nodeFunction=mstr.utils.QualNode.getFunction(editNode,false);var numConstants=mstr.utils.QualNode.computeFunctionConstantsRequired(nodeFunction["function"],et);if(numConstants){var constValues=mstr.utils.QualNode.getConstantValues(editNode);for(var i=0;i<numConstants;i++){if(!constValues[i]){return null;}}}break;case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:var elems=mstr.utils.QualNode.getElements(editNode);if(!elems||!elems.length){return null;}}}var root=em&&em.get("rootNode");if(root){em.cleanupConstants(root);root=em.cleanupAllForm(root);}return mstr.utils.UpdateManagerHelper.serializeExpression(this,root,em&&em.props.type,true);};EPA.prototype.getSelected=function EPA_getSelected(){if(this.props.dualListCart){return this.props.dualListCart.buildSelectedModel();}else{return this.props.selected;}};EPA.prototype.isEmpty=function EPA_isEmpty(){if(this.props.isComplex){switch(this.props.complexString){case"":case null:case undefined:return true;default:return false;}}else{if(this.props.dualListCart){var dlc=this.props.dualListCart,selI=dlc&&dlc.get("selectedIncludes"),selE=dlc&&dlc.get("selectedExcludes");if((selI&&!selI.isEmpty())||(selE&&!selE.isEmpty())){return false;}return true;}else{var sel=this.props.selected;return(sel&&!sel.isEmpty())?false:true;}}};EPA.prototype._validateInternally=function EPA_validateInternally(context,bFormat){var status={statusCode:mstr.Enum.Validation.STATUSCODE.VALID,context:context&&context.stage};if(!this.props.isComplex){var sel=this.getSelected();if(this.props.required||this.props.min||this.props.max){var minEffective=this.props.min||(this.props.required?1:0);var count=sel&&sel.count()||0;if(!count||(count==1&&sel.isEmpty())){if(this.props.required||minEffective){status.statusCode=mstr.Enum.Validation.STATUSCODE.NO_INPUT;}}else{if(minEffective||this.props.max){var sc=mstr.utils.Math.inNumericRange(count,minEffective,this.props.max);if(sc){status.statusCode=(sc>0)?mstr.Enum.Validation.STATUSCODE.EXCEEDS_MAX_COUNT:mstr.Enum.Validation.STATUSCODE.EXCEEDS_MIN_COUNT;}}}}if(status.statusCode==mstr.Enum.Validation.STATUSCODE.VALID&&this.getSelected()){status.statusCode=this.getSelected().validate(null,context,bFormat);if(status.statusCode==mstr.Enum.Validation.STATUSCODE.INCOMPLETE_CONDITION_ON_AUTO_NODE){if(!mstr.utils.Math.inNumericRange(sel&&sel.count()-1,minEffective,this.props.max)){status.statusCode=mstr.Enum.Validation.STATUSCODE.VALID;}}}var checkingSavedAnswer=this.get("parent")&&this.get("parent").get("savingAnswer");if(status.statusCode==mstr.Enum.Validation.STATUSCODE.VALID&&checkingSavedAnswer){status.statusCode=this.validateSavedAnswer();}}return status;};function EPA(props){mstr.models.PromptAnswer.apply(this,[props]);}return EPA;})();mstr.models.ExpressionCartBase=(function(){mstr.$O.extendsClass(ECB,mstr.models.BaseModel);ECB.prototype._addItemsToSelectedModel=function ECB_addItemsToSel(container,items,selectedModel){var m=selectedModel||this.props.selected;if(!m){return ;}var len=mstr.$A.len(items);if(!len){return false;}var dimensionId=null;if(container&&container.isWithinHierarchy==null){container.isWithinHierarchy=!!mstr.utils.ListViewHelper.isWithinHierarchy(container);}if(container&&container.isWithinHierarchy&&container.value){dimensionId=mstr.utils.ListViewHelper.getHierarchyId(container);container.value.dimensionId=dimensionId;}if(items[0]&&parseInt(items[0]["tp"])==mstr.Enum.MSTRFolderItem.TYPE.ELEMENT){return m.execCommand("AddElements",{target:container&&container.value,elements:items});}else{var bAddedSome=false;var args,bSuccess;for(var i=0;i<len;i++){bSuccess=false;args=null;switch(items[i]&&parseInt(items[i]["tp"])){case mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTE:if(dimensionId){items[i]["dimensionId"]=dimensionId;}args={target:items[i],expressionType:items[i]["locked"]?mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:null};break;case mstr.Enum.MSTRFolderItem.TYPE.FORM:args={expressionType:mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL,target:container,form:items[i]};break;case mstr.Enum.MSTRFolderItem.TYPE.METRIC:args={expressionType:mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL,target:items[i]};break;}bSuccess=args?m.execCommand("AddCondition",args):false;if(bSuccess){bAddedSome=true;}}return bAddedSome;}};ECB.prototype.onInsertOrRemove=function ECB_onInsertOrRemove(evt){this.updateCommandEnabledAdd(evt);this.set("lastInsertOrRemove",new Date());};ECB.prototype.updateCommandEnabledAdd=function ECB_upCEAdd(evt){var bAddEnabled=true;if(!this.props.allowAddAlways&&this._hasMetAddMax()){bAddEnabled=false;}else{var av=this.props.available;if(!av||!this._findAddableItem(av.getSelectedItems())){bAddEnabled=false;}}this.set("CommandEnabledAdd",bAddEnabled);};ECB.prototype._hasMetAddMax=function ECB_hasMetAddMax(){var max=this.props.max;if(max){var sel=this.props.selected;var count=(sel&&sel.count())||0;return(count>=max);}return false;};ECB.prototype._computeAllowedAddCount=function ECB_compAllowedAddCount(){var sel=this.props.selected;if(!sel){return 0;}if(!this.props.allowAddAlways){var max=parseInt(this.props.max);if(max){max-=sel.count();return Math.max(0,max);}}return -1;};ECB.prototype._findAddableItem=function ECB_findAddableItem(items){if(items){for(var i=0,len=items.length;i<len;i++){if(this.canAdd(items[i])){return items[i];}}}return null;};ECB.prototype.canAdd=function ECB_canAdd(item){if(!item){return false;}var hashAllowed=mstr.utils.Expr.getAllowedExprTypesHash(this);if(hashAllowed&&!mstr.$H.isEmpty(hashAllowed)){switch(item.tp){case mstr.Enum.MSTRFolderItem.TYPE.ELEMENT:if(!hashAllowed[mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL]&&!hashAllowed[mstr.Enum.Nodes.EXPRESSIONTYPE.JOINTLISTQUAL]){return false;}break;case mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTE:if(!hashAllowed[mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL]&&!hashAllowed[mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL]&&!hashAllowed[mstr.Enum.Nodes.EXPRESSIONTYPE.LISTFORMQUAL]&&!hashAllowed[mstr.Enum.Nodes.EXPRESSIONTYPE.JOINTLISTQUAL]){return false;}break;case mstr.Enum.MSTRFolderItem.TYPE.FORM:if(!hashAllowed[mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL]&&!hashAllowed[mstr.Enum.Nodes.EXPRESSIONTYPE.LISTFORMQUAL]){return false;}break;case mstr.Enum.MSTRFolderItem.TYPE.METRIC:if(!hashAllowed[mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL]){return false;}break;default:}}var n=this.props.allowedItemFormName;if(n!=null){if(this.props.allowedItemFormValues){if(!this.props.allowedItemFormValuesHash){this.props.allowedItemFormValuesHash=mstr.$A.toHash(this.props.allowedItemFormValues&&this.props.allowedItemFormValues.split(","));}return !!this.props.allowedItemFormValuesHash[item[n]];}else{if(this.props.prohibitedItemFormValues){if(!this.props.prohibitedItemFormValuesHash){this.props.prohibitedItemFormValuesHash=mstr.$A.toHash(this.props.prohibitedItemFormValues&&this.props.prohibitedItemFormValues.split(","));}return !this.props.prohibitedItemFormValuesHash[item[n]];}}}return true;};ECB.prototype.init=function ECB_init(){mstr.models.BaseModel.prototype.init.apply(this);this.onInsertOrRemove();var sel=this.props.selected;if(sel){sel.attachEventListener(this,"insert_condition","onInsertOrRemove");sel.attachEventListener(this,"remove_condition","onInsertOrRemove");sel.attachEventListener(this,"insert_ANDOR","onInsertOrRemove");sel.attachEventListener(this,"remove_ANDOR","onInsertOrRemove");}};function ECB(props){mstr.models.BaseModel.apply(this,[props]);}return ECB;})();mstr.models.ExpressionListCart=(function(){mstr.$O.extendsClass(ELC,mstr.models.ExpressionCartBase);ELC.prototype.execAdd=function ELC_execAdd(model){var allowedCount=this._computeAllowedAddCount();if(!allowedCount){return ;}var avModel=this.props.available;if(!avModel){return ;}var avIndices=avModel.getSelectedIndices();var avCount=mstr.$H.len(avIndices);if(!avCount){return ;}var addableInfo=this._findAddableItemsInIndices(mstr.$A.sortNumericArray(mstr.$A.fromHashKeys(avIndices,true)),allowedCount);if(addableInfo.count){var container=this.props.available&&this.props.available.getContainer();if(container&&container.value&&container.value.tp&&container.value.tp==mstr.Enum.MSTRFolderItem.TYPE.FILTER){container=container.parent;}var bSuccess=this._addItemsToSelectedModel(container,addableInfo.itemsToAdd,model);if(bSuccess){var nextAvIndex=addableInfo.indicesToAdd.pop()+1;nextAvIndex=Math.min(nextAvIndex,mstr.$A.len(avModel.getItems())-1);if(nextAvIndex>-1){avModel.execCommand("SingleSelect",nextAvIndex);}}}};ELC.prototype._findAddableItemsInIndices=function ELC_findAddableItemsInIndices(indices,maxCount){var result={indicesToAdd:[],itemsToAdd:[],count:0};var av=this.props.available;var items=av&&av.getItems();if(!items){return result;}for(var i=0,len=mstr.$A.len(indices);i<len;i++){var index=indices[i];var item=items[index];if(this.canAdd(item)){result.indicesToAdd[result.count]=index;result.itemsToAdd[result.count]=item;result.count++;if(result.count==maxCount){break;}}}return result;};ELC.prototype.init=function ELC_init(){mstr.models.ExpressionCartBase.prototype.init.apply(this);var av=this.props.available;if(av){av.attachEventListener(this,"hashadd_selectedIndices","updateCommandEnabledAdd");av.attachEventListener(this,"hashremove_selectedIndices","updateCommandEnabledAdd");av.attachEventListener(this,"insert_ANDOR","onInsertOrRemove");av.attachEventListener(this,"remove_ANDOR","onInsertOrRemove");if(av.getSelectedIndex&&av.getSelectedIndex()==-1){av.execCommand("SingleSelect",0);}}};function ELC(props){mstr.models.ExpressionCartBase.apply(this,[props]);}return ELC;})();mstr.models.DualExpressionListCart=(function(){mstr.$O.extendsClass(DELC,mstr.models.ExpressionListCart);DELC.prototype._hasMetAddMax=function DELC_hasMetAddMax(){var max=this.props.max;if(max){var count=0,selI=this.props.selectedIncludes,selE=this.props.selectedExcludes;if(selI||selE){count=(selI&&selI.count())||0;if(count<max){count+=(selE&&selE.count())||0;}}else{var sel=this.props.selected;count=(sel&&sel.count())||0;}return(count>=max);}return false;};DELC.prototype._computeAllowedAddCount=function DELC_compAllowedAddCount(){if(!this.props.allowAddAlways){var max=parseInt(this.props.max);if(max){var count=0,selI=this.props.selectedIncludes,selE=this.props.selectedExcludes;if(selI||selE){max-=(selI&&selI.count())||0;if(max>0){max-=(selE&&selE.count())||0;}}else{var sel=this.props.selected;if(!sel){return 0;}max-=sel.count();}return Math.max(0,max);}}return -1;};DELC.prototype.getSelectedIncludesModel=function DELC_getSelectedIncludesModel(){var m=this.props.selectedIncludes;if(!m){m=new mstr.models.ExpressionModel({parent:this.props.parent||this,type:this.props.type,defaultFunction:this.props.defaultFunction,defaultAttributeFunction:this.props.defaultAttributeFunction,defaultListFunction:this.props.defaultListFunction,defaultMetricFunction:this.props.defaultMetricFunction,defaultMetricLevel:this.props.defaultMetricLevel,defaultExpressionType:this.props.defaultExpressionType,allowedExpressionTypes:this.props.allowedExpressionTypes,defaultAttributeExpressionType:this.props.defaultAttributeExpressionType,allowedFunctions:this.props.allowedFunctions,defaultBranchQualId:this.props.defaultBranchQualId,maxElementsAllowed:this.props.maxElementsAllowed,allowGrouping:this.props.allowGrouping,valueForm:this.props.available&&this.props.available.get("valueForm")});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();m.set("answer",this.props.answer);this.props.selectedIncludes=m;if(this.props.max){m.attachEventListener(this,"insert_condition","onInsertOrRemove");m.attachEventListener(this,"remove_condition","onInsertOrRemove");m.attachEventListener(this,"insert_ANDOR","onInsertOrRemove");m.attachEventListener(this,"remove_ANDOR","onInsertOrRemove");var sel=this.props.selectedAttached;if(sel){sel.detachEventListener(this,"insert_condition");sel.detachEventListener(this,"remove_condition");sel.dettachEventListener(this,"insert_ANDOR");sel.dettachEventListener(this,"remove_ANDOR");this.props.selectedAttached=null;}}}this._updateSelectedIncludesModel();}return m;};DELC.prototype._updateSelectedIncludesModel=function DELC_updateSelectedIncludesModel(){var m=this.props.selectedIncludes;if(!m){return ;}var sel=this.props.selected;var root=sel&&sel.get("rootNode");if(root){if(mstr.utils.ExprNode.isTUPLENode(root)||mstr.utils.ExprNode.isANDORNode(root)){var ch=root.children,child,nonNOTChildren=[];for(var i=mstr.$A.len(ch)-1;i>-1;i--){child=ch[i];if(!mstr.utils.ExprNode.isNOTNode(child)){mstr.utils.Trees.removeChildNodeAt(root,i);nonNOTChildren.push(child);}}var lenNonNOTs=nonNOTChildren.length;if(lenNonNOTs){var clone={value:root.value};mstr.utils.Trees.insertChildNodes(clone,nonNOTChildren.reverse(),0);m.insertANDORAt(clone,"0");}else{m.removeANDOR(m.get("rootNode"));}}else{if(!mstr.utils.ExprNode.isNOTNode(root)){sel.removeCondition(root);m.insertConditionAt(root,"0");}}}else{m.removeANDOR(m.get("rootNode"));}};DELC.prototype.getSelectedExcludesModel=function DELC_getSelectedExcludesModel(){var m=this.props.selectedExcludes;if(!m){m=new mstr.models.ExpressionModel({parent:this.props.parent||this,type:this.props.type,defaultFunction:this.props.defaultFunction,defaultAttributeFunction:this.props.defaultAttributeFunction,defaultListFunction:this.props.defaultListFunction,defaultMetricFunction:this.props.defaultMetricFunction,defaultMetricLevel:this.props.defaultMetricLevel,defaultExpressionType:this.props.defaultExpressionType,allowedExpressionTypes:this.props.allowedExpressionTypes,defaultAttributeExpressionType:this.props.defaultAttributeExpressionType,allowedFunctions:this.props.allowedFunctions,defaultBranchQualId:this.props.defaultBranchQualId,maxElementsAllowed:this.props.maxElementsAllowed,allowGrouping:this.props.allowGrouping,valueForm:this.props.available&&this.props.available.get("valueForm")});if(m){mstr.controllers.Factory.add(m);m.init&&m.init();m.set("answer",this.props.answer);this.props.selectedExcludes=m;if(this.props.max){m.attachEventListener(this,"insert_condition","onInsertOrRemove");m.attachEventListener(this,"remove_condition","onInsertOrRemove");m.attachEventListener(this,"insert_ANDOR","onInsertOrRemove");m.attachEventListener(this,"remove_ANDOR","onInsertOrRemove");var sel=this.props.selectedAttached;if(sel){sel.detachEventListener(this,"insert_condition");sel.detachEventListener(this,"remove_condition");sel.detachEventListener(this,"insert_ANDOR");sel.detachEventListener(this,"remove_ANDOR");this.props.selectedAttached=null;}}}this._updateSelectedExcludesModel();}return m;};DELC.prototype._updateSelectedExcludesModel=function DELC_updateSelectedExcludesModel(){var m=this.props.selectedExcludes;if(!m){return ;}var sel=this.props.selected;var root=sel&&sel.get("rootNode");if(root){if(mstr.utils.ExprNode.isANDORNode(root)||mstr.utils.ExprNode.isTUPLENode(root)){var ch=root.children,child,NOTChildren=[];for(var i=mstr.$A.len(ch)-1;i>-1;i--){child=ch[i];if(mstr.utils.ExprNode.isNOTNode(child)){child=child.children&&child.children[0];if(child){mstr.utils.Trees.removeChildNodeAt(child.parent,0);NOTChildren.push(child);}}}var lenNOTs=NOTChildren.length;if(lenNOTs){var clone={value:root.value};mstr.utils.Trees.insertChildNodes(clone,NOTChildren.reverse(),0);m.insertANDORAt(clone,"0");}else{m.removeANDOR(m.get("rootNode"));}}else{if(mstr.utils.ExprNode.isNOTNode(root)){var NOTChild=root.children&&root.children[0];if(NOTChild){mstr.utils.Trees.removeChildNodeAt(root,0);m.insertConditionAt(NOTChild,"0");}}}}else{m.removeANDOR(m.get("rootNode"));}};DELC.prototype.buildSelectedModel=function DELC_buildSelectedModel(){var isTUPLE=(mstr.utils.Expr.getDefaultRootOperator(this)==mstr.Enum.Nodes.FUNCTION.TUPLE);var root=isTUPLE?mstr.utils.Expr.newTUPLE():mstr.utils.Expr.newBranchQual(mstr.Enum.Nodes.FUNCTION.AND);var excludeRoot=this.props.selectedExcludes&&this.props.selectedExcludes.get("rootNode");if(excludeRoot){excludeRoot=mstr.utils.Trees.cloneSubTree(excludeRoot);var newNOT;if(mstr.utils.ExprNode.isTUPLENode(excludeRoot)||mstr.utils.ExprNode.isANDORNode(excludeRoot)){var excludes=mstr.utils.Trees.removeAllChildNodes(excludeRoot);for(var i=0,len=mstr.$A.len(excludes);i<len;i++){newNOT=isTUPLE?mstr.utils.Expr.newTUPLENOT():mstr.utils.Expr.newBranchQual(mstr.Enum.Nodes.FUNCTION.NOT);mstr.utils.Trees.insertChildNodes(root,[newNOT],0);mstr.utils.Trees.insertChildNodes(newNOT,[excludes[i]],0);}}else{newNOT=isTUPLE?mstr.utils.Expr.newTUPLENOT():mstr.utils.Expr.newBranchQual(mstr.Enum.Nodes.FUNCTION.NOT);mstr.utils.Trees.insertChildNodes(root,[newNOT],0);mstr.utils.Trees.insertChildNodes(newNOT,[excludeRoot],0);}}var includeRoot=this.props.selectedIncludes&&this.props.selectedIncludes.get("rootNode");if(includeRoot){includeRoot=mstr.utils.Trees.cloneSubTree(includeRoot);if(mstr.utils.ExprNode.isTUPLENode(includeRoot)||mstr.utils.ExprNode.isANDORNode(includeRoot)){var includes=mstr.utils.Trees.removeAllChildNodes(includeRoot);includes&&mstr.utils.Trees.insertChildNodes(root,includes,0);}else{mstr.utils.Trees.insertChildNodes(root,[includeRoot],0);}}var m=new mstr.models.ExpressionModel({parent:this,rootNode:root,type:this.props.type,defaultFunction:this.props.defaultFunction,defaultAttributeFunction:this.props.defaultAttributeFunction,defaultListFunction:this.props.defaultListFunction,defaultMetricFunction:this.props.defaultMetricFunction,defaultMetricLevel:this.props.defaultMetricLevel,defaultExpressionType:this.props.defaultExpressionType,allowedExpressionTypes:this.props.allowedExpressionTypes,defaultAttributeExpressionType:this.props.defaultAttributeExpressionType,allowedFunctions:this.props.allowedFunctions,defaultBranchQualId:this.props.defaultBranchQualId,maxElementsAllowed:this.props.maxElementsAllowed,allowGrouping:this.props.allowGrouping,valueForm:this.props.available&&this.props.available.get("valueForm")});m&&m.init();m.set("answer",this.props.answer);return m;};DELC.prototype.on_set_selected=function DELC_on_set_selected(evt){var sel=this.props.selectedAttached;if(sel){sel.detachEventListener(this,"insert_condition");sel.detachEventListener(this,"remove_condition");this.props.selectedAttached=null;}sel=this.props.selected;if(this.props.max&&sel){sel.attachEventListener(this,"insert_condition","onInsertOrRemove");sel.attachEventListener(this,"remove_condition","onInsertOrRemove");sel.attachEventListener(this,"insert_ANDOR","onInsertOrRemove");sel.attachEventListener(this,"remove_ANDOR","onInsertOrRemove");this.props.selectedAttached=sel;}this._updateSelectedIncludesModel();this._updateSelectedExcludesModel();};DELC.prototype.init=function DELC_init(){mstr.models.BaseModel.prototype.init.apply(this);this.updateCommandEnabledAdd();var av=this.props.available;if(av){av.attachEventListener(this,"hashadd_selectedIndices","updateCommandEnabledAdd");av.attachEventListener(this,"hashremove_selectedIndices","updateCommandEnabledAdd");}this.on_set_selected(null);};function DELC(props){mstr.models.ExpressionListCart.apply(this,[props]);}return DELC;})();mstr.models.ExpressionTreeCart=(function(){mstr.$O.extendsClass(ETC,mstr.models.ExpressionCartBase);ETC.prototype.execAdd=function ETC_execAdd(){var allowedCount=this._computeAllowedAddCount();if(!allowedCount){return ;}var avModel=this.props.available;if(!avModel){return ;}var avNodes=avModel.getSelectedNodes();var avCount=mstr.$H.len(avNodes);if(!avCount){return ;}var addableInfo=this._findAddableNodes(mstr.$A.fromHashValues(avNodes),allowedCount);if(addableInfo.count){var container=addableInfo.container;if(container&&container.value&&container.value.tp&&container.value.tp==mstr.Enum.MSTRFolderItem.TYPE.FILTER){container=container.parent;}var bSuccess=this._addItemsToSelectedModel(container,addableInfo.itemsToAdd);if(bSuccess){var nextNode=mstr.utils.Trees.nextSibling(addableInfo.nodesToAdd.pop());if(nextNode){avModel.execCommand("SingleSelect",nextNode);}}}};ETC.prototype._findAddableNodes=function ELC_findAddableNodes(nodes,maxCount){var result={nodesToAdd:[],itemsToAdd:[],count:0,container:null};var av=this.props.available;var item;for(var i=0,len=mstr.$A.len(nodes);i<len;i++){item=nodes[i]&&nodes[i].value;if(this.canAdd(item)){result.nodesToAdd[result.count]=nodes[i];result.itemsToAdd[result.count]=item;if(result.count==0){result.container=nodes[i].parent;}result.count++;if(result.count==maxCount){break;}}}return result;};ETC.prototype.init=function ETC_init(){mstr.models.ExpressionCartBase.prototype.init.apply(this);var av=this.props.available;if(av){av.attachEventListener(this,"hashadd_selections","updateCommandEnabledAdd");av.attachEventListener(this,"hashremove_selections","updateCommandEnabledAdd");}};function ETC(props){mstr.models.ExpressionCartBase.apply(this,[props]);}return ETC;})();mstr.models.ExpressionModel=(function(){mstr.$O.extendsClass(EM,mstr.models.AbstractTreeBase);EM.prototype.DEFAULTS=mstr.$H.clone(mstr.models.AbstractTreeBase.prototype.DEFAULTS);EM.prototype.DEFAULTS.CommandEnabledEditConditionInclude=EM.prototype.DEFAULTS.CommandEnabledEditConditionTarget=EM.prototype.DEFAULTS.CommandEnabledEditConditionForm=EM.prototype.DEFAULTS.CommandEnabledEditConditionFunction=EM.prototype.DEFAULTS.CommandEnabledEditConditionConstant1=EM.prototype.DEFAULTS.CommandEnabledEditConditionConstant2=EM.prototype.DEFAULTS.CommandEnabledEditConditionLevel=true;EM.prototype.insertRoot=function EM_insertRoot(node){if(!node){return false;}var nonNOT=mstr.utils.ExprNode.findNonNOTChild(node,null);if(nonNOT){var root=this.get("rootNode");if(root){this.removeRoot();}if(mstr.utils.ExprNode.isANDORNode(nonNOT)||mstr.utils.ExprNode.isTUPLENode(nonNOT)){return this.insertANDORAt(nonNOT,"0");}else{return this.insertConditionAt(nonNOT,"0");}}};EM.prototype.removeRoot=function EM_removeRoot(){var root=this.get("rootNode");if(!root){return false;}var nonNOTRoot=mstr.utils.ExprNode.findNonNOTChild(root,null);if(!nonNOTRoot){return this._silentRemoveNode(root);}else{if(mstr.utils.ExprNode.isANDORNode(nonNOTRoot)||mstr.utils.ExprNode.isTUPLENode(nonNOTRoot)){return this.removeANDOR(nonNOTRoot);}else{return this.removeCondition(nonNOTRoot);}}};EM.prototype.insertConditionAt=function EM_insertConditionAt(node,path){return this._insertNonNOTAt(node,path,"condition");};EM.prototype.insertANDORAt=function EM_insertANDORAt(node,path){return this._insertNonNOTAt(node,path,"ANDOR");};EM.prototype._insertNonNOTAt=function EM_insertNonNOTAt(node,path,nodeTypeString){if(!node){return false;}if(path=="0"){var root=this.props.rootNode;if(root&&this._silentRemoveNode(root)){this.raiseEvent("remove_"+this._getNodeTypeString(root),{path:"0"});}}if(this._silentInsertNodesAt([node],path)){this.raiseEvent("insert_"+nodeTypeString,{node:node,path:path});return true;}return false;};EM.prototype.removeCondition=function EM_removeCondition(node){return this._removeNonNOT(node,"condition");};EM.prototype.removeANDOR=function EM_removeANDOR(node){return this._removeNonNOT(node,"ANDOR");};EM.prototype._removeNonNOT=function EM_removeNonNOT(node,nodeTypeString){if(!node){return false;}var path=this.getNodePath(node);var bWasNOT=mstr.utils.ExprNode.isNOTNode(node.parent);if(bWasNOT){node=node.parent;}if(this._silentRemoveNode(node)){this.raiseEvent("remove_"+nodeTypeString,{path:path,wasNOT:bWasNOT});return true;}return false;};EM.prototype.insertNOTAbove=function EM_insertNOTAbove(node){if(!node){return false;}var newNOT=mstr.utils.Expr.newBranchQual(mstr.Enum.Nodes.FUNCTION.NOT,this.getId());if(!newNOT){return false;}this._validateNodeId(newNOT);var path=this.getNodePath(node);if(this._silentRemoveNode(node)&&this._silentInsertNodesAt([newNOT],path)&&this._silentInsertNodesAt([node],path+"/0")){this.raiseEvent("insert_NOT",{node:newNOT,path:path});return true;}return false;};EM.prototype.removeNOT=function EM_removeNOT(node){if(!node){return false;}var path=this.getNodePath(node);var child=mstr.utils.Trees.removeChildNodeAt(node,0);if(this._silentRemoveNode(node)&&(!child||this._silentInsertNodesAt([child],path))){this.raiseEvent("remove_NOT",{path:path});return true;}return false;};EM.prototype.execSingleSelect=function EM_exSingleSelect(nodeInfo){var node=nodeInfo&&nodeInfo.node?nodeInfo.node:nodeInfo;var instanceChild=nodeInfo&&nodeInfo.node?nodeInfo.instanceChild:null;if((this.props.selectedInstanceChild==instanceChild)&&this._isNodeSelected(node)&&!this._hasMultiSelections()){return false;}this.execClearSelect();this.props.selectedInstanceChild=instanceChild;this.props.anchorNode=node;return this._selectNodes([node]);};EM.prototype.execToggleSelect=function EM_exToggleSelect(node){if(this._isNodeSelected(node)){return this._unselectNodes([node]);}else{if(mstr.utils.ExprNode.areNonNOTSiblings(node,mstr.$H.firstItem(this.props.selections))){this.props.anchorNode=node;return this._selectNodes([node]);}else{return this.execSingleSelect({node:node});}}};EM.prototype.execRangeSelect=function EM_exRangeSelect(node){var anchor=this.props.anchorNode;var nodes=this._buildConditionNodeRange(node,anchor);if(mstr.$A.len(nodes)){var retVal=this.execSelect(nodes);this.props.anchorNode=anchor;return retVal;}else{return this.execSingleSelect({node:node});}};EM.prototype._buildConditionNodeRange=function EM_buildCNRange(node1,node2){if(node1&&node2&&!mstr.utils.ExprNode.isANDORNode(node1)&&!mstr.utils.ExprNode.isANDORNode(node2)){var info1=mstr.utils.ExprNode.findNonNOTParentInfo(node1);var info2=mstr.utils.ExprNode.findNonNOTParentInfo(node2);if(info1&&info2&&(info1.parent==info2.parent)){var nodes=[],p=info1.parent,start=Math.min(info1.childIndex,info2.childIndex),fin=Math.max(info1.childIndex,info2.childIndex);var child;for(var i=start;i<=fin;i++){child=mstr.utils.ExprNode.findNonNOTChild(p,i);if(child&&!mstr.utils.ExprNode.isANDORNode(child)){nodes.push(child);}}return nodes;}}return null;};EM.prototype.on_hashadd_selections=EM.prototype.on_hashremove_selections=function(evt){this.updateCommandEnabledDelete();this.updateCommandEnabledGroup();this.updateCommandEnabledUngroup();this.updateCommandEnabledUp();this.updateCommandEnabledDown();this.updateCommandEnabledImportFile();};EM.prototype.execDelete=function EM_execDelete(){if(this.props.selectedInstanceChild){return false;}var nodes=this.props.selections;var node,p,sib;for(var id in nodes){sid=null;node=nodes[id];if(!node){continue;}if(!p){p=mstr.utils.ExprNode.findNonNOTParent(node);}sib=mstr.utils.ExprNode.findNonNOTNextSibling(node);if(!sib){sib=mstr.utils.ExprNode.findNonNOTPreviousSibling(node);}this.removeCondition(node);}p&&this.consolidateNode(p);if(sib){this.execSingleSelect({node:sib});}else{this.execClearSelect();}};EM.prototype.consolidateNode=function EM_consolidateNode(node){if(!node){return ;}var c=node.children;var len=mstr.$A.len(c);if(!len){this.removeANDOR(node);return ;}else{if(len==1&&!mstr.utils.ExprNode.isTUPLENode(node)){var nonNOTChild=mstr.utils.ExprNode.findNonNOTChild(node,0);if(nonNOTChild){var insertPath;var parentInfo=mstr.utils.ExprNode.findNonNOTParentInfo(node);if(!parentInfo||!parentInfo.parent){insertPath="0";}else{insertPath=this.getNodePath(parentInfo.parent)+mstr.models.AbstractTreeBase.PATHDELIM+parentInfo.childIndex;}if(mstr.utils.ExprNode.isANDORNode(nonNOTChild)){this.removeANDOR(nonNOTChild);this.insertANDORAt(nonNOTChild,insertPath);}else{this.removeCondition(nonNOTChild);this.insertConditionAt(nonNOTChild,insertPath);}}this.removeANDOR(node);}}var child;for(var i=0,len=mstr.$A.len(c);i<len;i++){child=c[i];if(mstr.utils.ExprNode.isNOTNode(child)&&child.children&&mstr.utils.ExprNode.isNOTNode(child.children[0])){this.removeNOT(child.children[0]);this.removeNOT(child);}}};EM.prototype.updateCommandEnabledDelete=function EM_upCEDelete(){var bDeleteEnabled=false;if(!this.props.selectedInstanceChild){bDeleteEnabled=!mstr.$H.isEmpty(this.props.selections);}this.set("CommandEnabledDelete",bDeleteEnabled);};EM.prototype.updateCommandEnabledImportFile=function EM_upCEImportFile(){var bImportFileEnabled=false;if(!this.props.selectedInstanceChild){var sel=this.props.selections;var node=mstr.$H.firstItem(this.props.selections);if(node&&!mstr.$H.lenGreaterThan(sel,1)){if(node&&node.value&&(node.value.expressionType==mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL)&&mstr.utils.QualNode.getTarget(node)&&mstr.utils.QualNode.getForm(node)){bImportFileEnabled=true;}}}this.set("CommandEnabledImportFile",bImportFileEnabled);};EM.prototype.execImportFile=function EM_importFile(){var sel=this.props.selections;var node=mstr.$H.firstItem(this.props.selections);this.execEditNode(node);return true;};EM.prototype.execAddQualify=function EM_execAddQualify(item){var condArgs={};condArgs.target=item;condArgs.expressionType=null;return this.execCommand("AddCondition",condArgs);};EM.prototype.queryEnabledAddQualify=function EM_queryEnabledAddQualify(){if(!this.props.allowAddAlways){var max=this.props.parent.props.max;if(max){var count=this.count()||0;return(count>=max);}}return true;};EM.prototype.execAddCondition=function EM_execAddCondition(condArgs){if(!condArgs){condArgs={};}condArgs.treeId=this.getId();if(!condArgs.expressionType){var et=this.props.defaultExpressionType||mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL;if(condArgs.form){et=mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL;}else{if(condArgs.target){switch(parseInt(condArgs.target.tp)){case mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTE:et=this.props.defaultAttributeExpressionType||this.props.defaultExpressionType;if(et!=mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL&&et!=mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL){et=mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL;}break;case mstr.Enum.MSTRFolderItem.TYPE.METRIC:et=mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL;break;}}}condArgs.expressionType=et;}var hashAllowed=mstr.utils.Expr.getAllowedExprTypesHash(this);if(hashAllowed&&!mstr.$H.isEmpty(hashAllowed)){if(!hashAllowed[condArgs.expressionType]){return null;}}if(condArgs.target&&!condArgs.form&&parseInt(condArgs.target.tp)==mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTE){condArgs.form=condArgs.target.dssforms&&condArgs.target.dssforms[0]||null;}if(!condArgs.func){condArgs.func=this._getDefaultFunction(condArgs.expressionType);}var node=mstr.utils.Expr.createCondition(condArgs);node.autoGeneratedByView=condArgs.autoGeneratedByView;var path=this._makeInsertionPath();return this.insertConditionAt(node,path)?node:null;};EM.prototype._getDefaultFunction=function EM_getDefaultFunction(exprType){var defaultFuncStr;var func;switch(exprType){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:defaultFuncStr=this.props.defaultMetricFunction||this.props.defaultFunction;break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:defaultFuncStr=this.props.defaultAttributeFunction||this.props.defaultFunction;break;case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:defaultFuncStr=this.props.defaultListFunction||this.props.defaultFunction;if(defaultFuncStr!=(mstr.Enum.Nodes.FUNCTION.NOTIN+","+mstr.Enum.Nodes.FUNCTIONTYPE.DEFAULT)){defaultFuncStr=mstr.Enum.Nodes.FUNCTION.IN+","+mstr.Enum.Nodes.FUNCTIONTYPE.DEFAULT;}break;default:defaultFuncStr=this.props.defaultFunction;break;}if(defaultFuncStr){if(this.isFunctionAllowed(defaultFuncStr)){var defaultFuncArr=defaultFuncStr.split(",");if(defaultFuncArr&&defaultFuncArr[0]&&defaultFuncArr[1]){func={tp:parseInt(defaultFuncArr[1]),id:parseInt(defaultFuncArr[0])};}else{func=this.get("allowedFunctions")[0];}}else{func=this.get("allowedFunctions")[0];}}return func;};EM.prototype.execAddElements=function EM_execAddElements(condArgs){if(!condArgs){return false;}if(!condArgs.expressionType){condArgs.expressionType=mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL;}var node=this._findConditionForNewElements(condArgs);if(node){return this._appendElementsToCondition(node,condArgs.elements);}else{var max=Math.max(0,parseInt(this.props.maxElementsAllowed)||0);if(max){var newElementsCount=mstr.$A.len(condArgs.elements);if(newElementsCount>max){condArgs.elements.splice(max,newElementsCount-max);}}return this.execAddCondition(condArgs);}};EM.prototype._findConditionForNewElements=function EM_findCFNEls(condArgs){var root=this.props.rootNode;if(!root){return null;}var node;if(this.props.selectedInstanceChild){node=mstr.utils.ExprNode.findNonNOTPreviousSibling(this.props.selectedInstanceChild);if(node&&node.value&&(node.value.expressionType==mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL)&&mstr.utils.QualNode.targetsMatch(node,condArgs.target)){return node;}}else{var nodes=this.props.selections;for(var id in nodes){node=nodes[id];if(node&&node.value&&(node.value.expressionType==mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL)&&mstr.utils.QualNode.targetsMatch(node,condArgs.target)){return node;}}var firstSelNode=mstr.utils.Hash.firstItem(nodes);if(firstSelNode){node=mstr.utils.ExprNode.findNonNOTPreviousSibling(firstSelNode);if(node&&node.value&&(node.value.expressionType==mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL)&&mstr.utils.QualNode.targetsMatch(node,condArgs.target)){return node;}}}node=null;var andOrNode=mstr.utils.Expr.findANDORNode(root,true);if(!andOrNode&&mstr.utils.ExprNode.isTUPLENode(this.props.rootNode)){andOrNode=this.props.rootNode;}if(andOrNode){var c=andOrNode.children;for(var i=mstr.$A.len(c)-1;i>-1;i--){node=mstr.utils.ExprNode.findNonNOTChild(andOrNode,i);if(node&&node.value&&(node.value.expressionType==mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL)&&mstr.utils.QualNode.targetsMatch(node,condArgs.target)){return node;}}}else{node=mstr.utils.ExprNode.isNOTNode(root)?root.children&&root.children[0]:root;if(node&&node.value&&(node.value.expressionType==mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL)&&mstr.utils.QualNode.targetsMatch(node,condArgs.target)){return node;}}return null;};EM.prototype._appendElementsToCondition=function EM_appendElementsToCondition(node,elements){if(!node||!elements){return false;}var arr=mstr.utils.QualNode.getElements(node);var max=Math.max(0,parseInt(this.props.maxElementsAllowed)||0);if(max){max-=mstr.$A.len(arr);if(max<=0){return false;}}if(arr){elements=mstr.$A.removeItemsByForm(elements,arr,"dssid");}if(!elements.length){return false;}var newElementsCount=mstr.$A.len(elements);if(newElementsCount>max){elements=elements.splice(max,newElementsCount-max);}var newArr=arr?[].concat(arr):[];newArr=newArr.concat(elements);if(mstr.utils.QualNode.setElements(node,newArr)){this.raiseEvent("edit_condition",{node:node,changedElements:true});return true;}return false;};EM.prototype._makeInsertionPath=function EM_makeInsertionPath(){var andOrNode=mstr.utils.Expr.findANDORNode(this.props.rootNode,true);if(!andOrNode&&mstr.utils.ExprNode.isTUPLENode(this.props.rootNode)){andOrNode=this.props.rootNode;}if(!andOrNode){var branchQualId=mstr.utils.Expr.getDefaultRootOperator(this);andOrNode=(branchQualId==mstr.Enum.Nodes.FUNCTION.TUPLE)?mstr.utils.Expr.newTUPLE(this.getId()):mstr.utils.Expr.newBranchQual(branchQualId,this.getId());var oldRoot=this.props.rootNode;var wasRootNOT=false;while(mstr.utils.ExprNode.isNOTNode(oldRoot)){wasRootNOT=!wasRootNOT;oldRoot=oldRoot.children&&oldRoot.children[0];}if(oldRoot){this.removeCondition(oldRoot);}this.insertANDORAt(andOrNode,"0");if(oldRoot){this.insertConditionAt(oldRoot,"0"+mstr.models.AbstractTreeBase.PATHDELIM+"0");if(wasRootNOT){this.insertNOTAbove(oldRoot);}}}if(this.props.selectedInstanceChild){var sel=this.props.selectedInstanceChild;while(mstr.utils.ExprNode.isNOTNode(sel&&sel.parent)){sel=sel.parent;}return this.getNodePath(sel);}else{var arrPaths=this.getSelectedPaths(true);if(arrPaths&&arrPaths[0]){return arrPaths[0];}}if(andOrNode){var path=this.getNodePath(andOrNode);var len=mstr.$A.len(andOrNode.children);return path+mstr.models.AbstractTreeBase.PATHDELIM+len;}};EM.prototype.execUp=function EM_execUp(){var retVal=false;if(!this.props.selectedInstanceChild){if(!mstr.$H.lenGreaterThan(this.props.selections,1)){var node=mstr.$H.firstItem(this.props.selections);if(node){retVal=this.moveUp(node);}}}this.on_hashadd_selections();return retVal;};EM.prototype.execDown=function EM_execDown(){var retVal=false;if(!this.props.selectedInstanceChild){if(!mstr.$H.lenGreaterThan(this.props.selections,1)){var node=mstr.$H.firstItem(this.props.selections);if(node){node=mstr.utils.ExprNode.findNonNOTNextSibling(node);if(node){retVal=this.moveUp(node);}}}}this.on_hashadd_selections();return retVal;};EM.prototype.moveUp=function EM_moveUp(node){if(!node){return false;}var pInfo=mstr.utils.ExprNode.findNonNOTParentInfo(node);if(!pInfo||!pInfo.parent||(pInfo.childIndex<1)){return false;}var prevInfo=mstr.utils.ExprNode.findNonNOTChildInfo(pInfo.parent,pInfo.childIndex-1);if(!prevInfo||!prevInfo.child){return false;}var isPrevNOT=mstr.utils.ExprNode.isNOTNode(prevInfo.child.parent);var isNOT=mstr.utils.ExprNode.isNOTNode(node.parent);var isANDOR=mstr.utils.ExprNode.isANDORNode(node);if(isANDOR){this.removeANDOR(node);}else{this.removeCondition(node);}var insertPath=this.getNodePath(pInfo.parent)+mstr.models.AbstractTreeBase.PATHDELIM+(pInfo.childIndex-1);if(isANDOR){this.insertANDORAt(node,insertPath);}else{this.insertConditionAt(node,insertPath);}if(isPrevNOT){this.insertNOTAbove(node);}if(isNOT&&!isPrevNOT){this.insertNOTAbove(prevInfo.child);}else{if(!isNOT&&isPrevNOT){this.removeNOT(prevInfo.child);}}return true;};EM.prototype.updateCommandEnabledUp=function EM_upCEUp(){var bUpEnabled=false;if(mstr.$H.firstItem(this.props.selections)&&!mstr.$H.lenGreaterThan(this.props.selections,1)){bUpEnabled=!!mstr.utils.ExprNode.findNonNOTPreviousSibling(mstr.$H.firstItem(this.props.selections));}this.set("CommandEnabledUp",bUpEnabled);};EM.prototype.updateCommandEnabledDown=function EM_upCEDown(){var bDownEnabled=false;if(mstr.$H.firstItem(this.props.selections)&&!mstr.$H.lenGreaterThan(this.props.selections,1)){bDownEnabled=!!mstr.utils.ExprNode.findNonNOTNextSibling(mstr.$H.firstItem(this.props.selections));}this.set("CommandEnabledDown",bDownEnabled);};EM.prototype.execGroup=function EM_execGroup(){var retVal=false;var child=this.props.selectedInstanceChild;if(child){var previous=mstr.utils.ExprNode.findNonNOTPreviousSibling(child);if(previous){retVal=this.groupConditions([previous,child]);}}else{retVal=this.groupConditions(mstr.$A.fromHashValues(this.props.selections));}this.on_hashadd_selections();return retVal;};EM.prototype.groupConditions=function EM_groupConds(nodes){var len=mstr.$A.len(nodes);if(len<2){return false;}var p=mstr.utils.ExprNode.findNonNOTParent(nodes[0]);if(!p){return false;}var paths=[];for(var i=0;i<len;i++){paths[i]=this.getNodePath(nodes[i]);}paths=this._sortPaths(paths);var nodesRemoved=new Array(len),node,isANDOR,isNOT;for(var i=len-1;i>-1;i--){node=this.getNodeAt(paths[i]);if(!node){continue;}isNOT=mstr.utils.ExprNode.isNOTNode(node.parent);isANDOR=mstr.utils.ExprNode.isANDORNode(node);if(isANDOR){this.removeANDOR(node);}else{this.removeCondition(node);}nodesRemoved[i]={node:node,isANDOR:isANDOR,isNOT:isNOT};}var pClone=mstr.utils.ExprNode.clone(p);var insertPath=paths[0];if(nodesRemoved[0].isNOT){insertPath=insertPath.substring(0,Math.max(insertPath.length-2,0));}this.insertANDORAt(pClone,insertPath);insertPath+=mstr.models.AbstractTreeBase.PATHDELIM+"0";for(var i=nodesRemoved.length-1;i>-1;i--){if(nodesRemoved[i].isANDOR){this.insertANDORAt(nodesRemoved[i].node,insertPath);}else{this.insertConditionAt(nodesRemoved[i].node,insertPath);}if(nodesRemoved[i].isNOT){this.insertNOTAbove(nodesRemoved[i].node);}}this.consolidateNode(pClone);this.consolidateNode(p);return true;};EM.prototype.execUngroup=function EM_execUngoup(){var retVal=false;var child=this.props.selectedInstanceChild;if(child){var previous=mstr.utils.ExprNode.findNonNOTPreviousSibling(child);if(previous){retVal=this.ungroupConditions([previous,child]);}}else{retVal=this.ungroupConditions(mstr.$A.fromHashValues(this.props.selections));}this.on_hashadd_selections();return retVal;};EM.prototype.ungroupConditions=function EM_ungroupConds(nodes){var len=mstr.$A.len(nodes);if(len<2){return false;}var p=mstr.utils.ExprNode.findNonNOTParent(nodes[0]);if(!p){return false;}var pInfo=mstr.utils.ExprNode.findNonNOTParentInfo(p);if(!pInfo||!pInfo.parent){return false;}var insertPath=this.getNodePath(pInfo.parent)+mstr.models.AbstractTreeBase.PATHDELIM+pInfo.childIndex;var paths=[];for(var i=0;i<len;i++){paths[i]=this.getNodePath(nodes[i]);}paths=this._sortPaths(paths);var nodesRemoved=new Array(len),node,isANDOR;for(var i=len-1;i>-1;i--){node=this.getNodeAt(paths[i]);if(!node){continue;}isANDOR=mstr.utils.ExprNode.isANDORNode(node);if(isANDOR){this.removeANDOR(node);}else{this.removeCondition(node);}nodesRemoved[i]={node:node,isANDOR:isANDOR};}var bIsNOT=mstr.utils.ExprNode.isNOTNode(p.parent);for(var i=nodesRemoved.length-1;i>-1;i--){if(nodesRemoved[i].isANDOR){this.insertANDORAt(nodesRemoved[i].node,insertPath);}else{this.insertConditionAt(nodesRemoved[i].node,insertPath);}if(bIsNOT){this.insertNOTAbove(nodesRemoved[i].node);}}this.consolidateNode(pInfo.parent);this.consolidateNode(p);return true;};EM.prototype.updateCommandEnabledGroup=function EM_upCEGroup(){var bGroupEnabled=false,andOrNode=null,count=0;if(this.props.allowGrouping!=false){if(this.props.selectedInstanceChild){bGroupEnabled=true;andOrNode=mstr.$H.firstItem(this.props.selections);count=2;}else{count=mstr.$H.len(this.props.selections);if(count>1){bGroupEnabled=true;andOrNode=mstr.utils.ExprNode.findNonNOTParent(mstr.$H.firstItem(this.props.selections));}}if(bGroupEnabled){bGroupEnabled=(mstr.$A.len(andOrNode&&andOrNode.children)>count);}}this.set("CommandEnabledGroup",bGroupEnabled);};EM.prototype.updateCommandEnabledUngroup=function EM_upCEUngroup(){var bUngroupEnabled=false;if(this.props.allowGrouping!=false){if(this.props.selectedInstanceChild){bUngroupEnabled=!!mstr.utils.ExprNode.findNonNOTParent(mstr.$H.firstItem(this.props.selections));}else{if(mstr.$H.lenGreaterThan(this.props.selections,1)){bUngroupEnabled=!!mstr.utils.ExprNode.findNonNOTParent(mstr.utils.ExprNode.findNonNOTParent(mstr.$H.firstItem(this.props.selections)));}}}this.set("CommandEnabledUngroup",bUngroupEnabled);};EM.prototype.execEditConditionInclude=function EM_editConditionInclude(incState){var node=this.props.editNode;if(!node){return false;}var wasIncState=mstr.utils.ExprNode.getInclude(node);if((incState&&incState.dssid)!=(wasIncState&&wasIncState.dssid)){var bChanged=false;switch(parseInt(incState&&incState.dssid)){case mstr.Enum.Nodes.INCLUDESTATE.INCLUDE:bChanged=this.removeNOT(node.parent);break;case mstr.Enum.Nodes.INCLUDESTATE.EXLUCDE:bChanged=this.insertNOTAbove(node);break;}if(bChanged){this.raiseEvent("edit_condition",{node:node,changedInclude:true});return true;}}return false;};EM.prototype.execEditRootOperator=function EM_editRootOperator(branchQual){var newBQ=branchQual&&parseInt(branchQual.dssid);if(!newBQ){return false;}this.props.defaultBranchQualId=newBQ;var root=this.props.rootNode;if(mstr.utils.ExprNode.isANDORNode(root)){if(mstr.utils.ExprNode.setScalarProp(root,"function",newBQ)){this.raiseEvent("edit_ANDOR",{node:root});return true;}}return true;};EM.prototype.execEditConditionBranchQual=function EM_editConditionBranchQual(branchQual){var node=this.props.editNode;if(!node){return false;}var newBQ=branchQual&&parseInt(branchQual.dssid);if(!newBQ){return false;}var oldBQ=mstr.utils.ExprNode.getBranchQual(node);oldBQ=oldBQ&&parseInt(oldBQ.dssid);if(newBQ!=oldBQ){var bChangedNOT=false;if((oldBQ==mstr.Enum.BranchQual.DSSID.AND&&newBQ==mstr.Enum.BranchQual.DSSID.ANDNOT)||(oldBQ==mstr.Enum.BranchQual.DSSID.AND&&newBQ==mstr.Enum.BranchQual.DSSID.ORNOT)||(oldBQ==mstr.Enum.BranchQual.DSSID.OR&&newBQ==mstr.Enum.BranchQual.DSSID.ORNOT)||(oldBQ==mstr.Enum.BranchQual.DSSID.OR&&newBQ==mstr.Enum.BranchQual.DSSID.ANDNOT)){bChangedNOT=this.insertNOTAbove(node);}else{if((oldBQ==mstr.Enum.BranchQual.DSSID.ANDNOT&&newBQ==mstr.Enum.BranchQual.DSSID.AND)||(oldBQ==mstr.Enum.BranchQual.DSSID.ANDNOT&&newBQ==mstr.Enum.BranchQual.DSSID.OR)||(oldBQ==mstr.Enum.BranchQual.DSSID.ORNOT&&newBQ==mstr.Enum.BranchQual.DSSID.OR)||(oldBQ==mstr.Enum.BranchQual.DSSID.ORNOT&&newBQ==mstr.Enum.BranchQual.DSSID.AND)){bChangedNOT=this.removeNOT(node.parent);}}var bChangedANDOR=false;if((oldBQ==mstr.Enum.BranchQual.DSSID.AND&&newBQ==mstr.Enum.BranchQual.DSSID.OR)||(oldBQ==mstr.Enum.BranchQual.DSSID.AND&&newBQ==mstr.Enum.BranchQual.DSSID.ORNOT)||(oldBQ==mstr.Enum.BranchQual.DSSID.ANDNOT&&newBQ==mstr.Enum.BranchQual.DSSID.OR)||(oldBQ==mstr.Enum.BranchQual.DSSID.ANDNOT&&newBQ==mstr.Enum.BranchQual.DSSID.ORNOT)){bChangedANDOR=this._toggleANDORAbove(node,mstr.Enum.Nodes.FUNCTION.OR);}else{if((oldBQ==mstr.Enum.BranchQual.DSSID.OR&&newBQ==mstr.Enum.BranchQual.DSSID.AND)||(oldBQ==mstr.Enum.BranchQual.DSSID.OR&&newBQ==mstr.Enum.BranchQual.DSSID.ANDNOT)||(oldBQ==mstr.Enum.BranchQual.DSSID.ORNOT&&newBQ==mstr.Enum.BranchQual.DSSID.AND)||(oldBQ==mstr.Enum.BranchQual.DSSID.ORNOT&&newBQ==mstr.Enum.BranchQual.DSSID.ANDNOT)){bChangedANDOR=this._toggleANDORAbove(node,mstr.Enum.Nodes.FUNCTION.AND);}}return bChangedNOT||bChangedANDOR;}return false;};EM.prototype._toggleANDORAbove=function EM_toggleANDORAbove(node,funcId){var pInfo=mstr.utils.ExprNode.findNonNOTParentInfo(node);var nodeToToggle=pInfo&&pInfo.parent;if(!nodeToToggle){return false;}if(mstr.$A.len(pInfo.parent.children)>2){var prev=mstr.utils.ExprNode.findNonNOTChild(nodeToToggle,pInfo.childIndex-1);if(!this.groupConditions([prev,node])){return false;}pInfo=mstr.utils.ExprNode.findNonNOTParentInfo(node);nodeToToggle=pInfo&&pInfo.parent;}if(nodeToToggle){if(mstr.utils.ExprNode.setScalarProp(nodeToToggle,"function",funcId)){this.raiseEvent("edit_ANDOR",{node:nodeToToggle});return true;}}return false;};EM.prototype.execEditConditionTarget=function EM_execEditConditionTarget(target){var node=this.props.editNode;if(!node){return false;}if(target&&parseInt(target.tp)==mstr.Enum.MSTRFolderItem.TYPE.ELEMENT){this.execEditConditionExprType({dssid:mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL});var attr;var tlm=this.props.answer&&this.props.answer.props["targetListModel"+((this&&this.getId())||"")];if(tlm){attr=tlm.getContainer();attr=attr&&attr.value;}this._editConditionTarget(node,attr);return this._appendElementsToCondition(node,[target]);}else{return this._editConditionTarget(node,target);}};EM.prototype._editConditionTarget=function EM_editConditionTarget(node,target){if(mstr.utils.QualNode.setTarget(node,target)){var bChangedForm=false,bChangedExprType=false,bChangedElems=false;if(target&&target.tp==mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTE&&target.locked&&mstr.utils.QualNode.getExpressionType(node)!=mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL){var index=mstr.$A.findByForm(mstr.Settings.Functions.ExprType,mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL,"dssid"),expr=index>-1&&mstr.Settings.Functions.ExprType[index];if(expr){mstr.utils.QualNode.setExprType(node,expr,this._getDefaultFunction(mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL));bChangedExprType=true;}}switch(mstr.utils.QualNode.getExpressionType(node)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:var forms=target&&target.dssforms,newForm;if(node.isAllFormQual){newForm=mstr.$H.clone(mstr.Enum.Form.ALL);newForm.dtp=(mstr.utils.FormShortcutNode.getFormDataTypes(target)||[mstr.Enum.Nodes.DATATYPE.VARCHAR]).join(",");}else{newForm=forms&&forms[0]||null;}bChangedForm=mstr.utils.QualNode.setForm(node,newForm);if(bChangedForm){this._updateConstantDataType(node,newForm);}break;case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:bChangedElems=mstr.utils.QualNode.setElements(node,[]);break;}this.updateCommandEnabledImportFile();this.raiseEvent("edit_condition",{node:node,changedTarget:true,changedExprType:bChangedExprType,changedForm:bChangedForm,changedElements:bChangedElems});return true;}return false;};EM.prototype.execEditConditionForm=function EM_editConditionForm(form){var node=this.props.editNode;if(!node){return false;}if(mstr.utils.QualNode.setForm(node,form)){this._updateConstantDataType(node,form);this.updateCommandEnabledImportFile();this.raiseEvent("edit_condition",{node:node,changedForm:true});return true;}return false;};EM.prototype._updateConstantDataType=function EM_updateConstantDataType(node,form,clearValues){var dataType=(form&&form.dtp)||mstr.Settings.Expression.DEFAULTFORMDATATYPE;var id=this.getId();var constNodes=[mstr.utils.QualNode.getConstantNode(node,1,true,id),mstr.utils.QualNode.getConstantNode(node,2,true,id)];for(var i=0;i<=1;i++){if(!constNodes[i]){continue;}mstr.utils.ConstNode.setDataType(constNodes[i],dataType);if(clearValues!==false){mstr.utils.ConstNode.setValue(constNodes[i],"");}}};EM.prototype.execUpdateInListFunction=function EM_updateInListFunction(){var node=this.props.editNode;if(!node){return false;}if(!mstr.utils.QualNode.isINQual(node)){mstr.utils.QualNode.setFunction(node,{id:mstr.Enum.Nodes.FUNCTION.IN,tp:mstr.Enum.Nodes.FUNCTIONTYPE.DEFAULT});}};EM.prototype.execEditConditionFunction=function EM_editConditionFunction(func){var node=this.props.editNode;if(!node){return false;}if(mstr.utils.QualNode.setFunction(node,func)){var count=mstr.utils.QualNode.computeFunctionConstantsRequired(node.value["function"],node.value.expressionType);var constNode,constValue;for(var i=1;i<=count;i++){constNode=mstr.utils.QualNode.getConstantNode(node,i,true,this.getId());}this.raiseEvent("edit_condition",{node:node,changedFunction:true});return true;}return false;};EM.prototype.execEditConditionConstant1=function EM_execECC1(constValue){return this._editConditionConstantNum(1,constValue,true);};EM.prototype.execEditConditionConstant2=function EM_execECC2(constValue){return this._editConditionConstantNum(2,constValue,true);};EM.prototype._editConditionConstantNum=function EM_editCondConstNum(num,constValue,bCheckMetricDataType){var node=this.props.editNode;if(!node){return false;}var constNode=mstr.utils.QualNode.getConstantNode(node,num,true,this.getId());if(mstr.utils.ConstNode.setValue(constNode,constValue)){if(bCheckMetricDataType&&mstr.utils.QualNode.isMetricQual(node)){mstr.utils.ConstNode.setDataType(constNode,mstr.utils.QualNode.getDataType(node,false));}var bChangedForm=false;if(mstr.utils.QualNode.getExpressionType(node)==mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL&&node.isAllFormQual){var target=mstr.utils.QualNode.getTarget(node),newForm;newForm=mstr.$H.clone(mstr.Enum.Form.ALL);newForm.dtp=(mstr.utils.FormShortcutNode.getFormDataTypes(target)||[mstr.Enum.Nodes.DATATYPE.VARCHAR]).join(",");bChangedForm=mstr.utils.QualNode.setForm(node,newForm);if(bChangedForm){this._updateConstantDataType(node,newForm,false);}}this.raiseEvent("edit_condition",{node:node,changedForm:bChangedForm,changedConstant1:num==1,changedConstant2:num==2});return true;}return false;};EM.prototype.isFunctionAllowed=function EM_isFunctionAllowed(functionStr){var allowedFunctions=this.get("allowedFunctions");if(mstr.$A.len(allowedFunctions)){var index=mstr.$A.findByForm(allowedFunctions,functionStr,"dssid");return(index>-1);}return true;};EM.prototype.execEditConditionFormValues1=function EM_execEditCondFV1(cartModel){return this._editConditionFormValues(1,cartModel);};EM.prototype.execEditConditionFormValues2=function EM_execEditCondFV2(cartModel){return this._editConditionFormValues(2,cartModel);};EM.prototype._editConditionFormValues=function EM_editCondFV(num,cartModel){var sel=cartModel&&cartModel.get("selected"),items=sel&&sel.getItems(),len=mstr.$A.len(items);if(len){var node=this.props.editNode;if(!node){return false;}var form=mstr.utils.QualNode.getForm(node);var prop=(form&&cartModel.get("available")&&cartModel.get("available").getPropertyNameForForm(form.dssid))||"n";var arrValues=[];for(var i=0;i<len;i++){arrValues[i]=items[i]["isDummy"]?items[i]["n"]:items[i][prop];}var constValue=mstr.utils.QualNode.constArray2Value(arrValues,this.props.type);}return this._editConditionConstantNum(num,constValue);};EM.prototype.execEditConditionLevel=function execEditConditionLevel(level){var node=this.props.editNode;if(!node){return false;}if(mstr.utils.QualNode.setLevel(node,level)){this.raiseEvent("edit_condition",{node:node,changedLevel:true});return true;}return false;};EM.prototype.execEditConditionLevelAttributes=function execEditCondLvlAttrs(attrs){var node=this.props.editNode;if(!node){return false;}var level={dssid:mstr.Enum.Nodes.NODEDIMTYLEVEL.ATTRIBUTES,attributes:attrs};if(mstr.utils.QualNode.setLevel(node,level)){this.raiseEvent("edit_condition",{node:node,changedLevel:true});return true;}return false;};EM.prototype.execEditConditionElements=function execEditConditionElements(arr){var node=this.props.editNode;if(!node){return false;}if(mstr.utils.QualNode.setElements(node,arr)){this.raiseEvent("edit_condition",{node:node,changedElements:true});return true;}return false;};EM.prototype.execEditConditionExprType=function execEditConditionType(exprType){var node=this.props.editNode;if(!node){return false;}if(mstr.utils.QualNode.setExprType(node,exprType,this._getDefaultFunction(exprType&&parseInt(exprType.dssid)))){this.updateCommandEnabledImportFile();this.raiseEvent("edit_condition",{node:node,changedExprType:true});return true;}return false;};EM.prototype.validate=function EM_validate(node,context,bFormat){var status=mstr.Enum.Validation.STATUSCODE.VALID;if(!node){node=this.props.rootNode;}if(!node){return status;}var enET=mstr.Enum.Nodes.EXPRESSIONTYPE,UQ=mstr.utils.QualNode,exprType=parseInt(node.value&&node.value.expressionType);switch(exprType){case enET.SINGLEMETRICQUAL:case enET.SINGLEBASEFORMQUAL:case enET.LISTQUAL:var target=UQ.getTarget(node);if(!target||target.dssid=="0"){break;}var func=UQ.getFunction(node,true);if(!func){if(node.autoGeneratedByView){status=mstr.Enum.Validation.STATUSCODE.INCOMPLETE_CONDITION_ON_AUTO_NODE;}else{status=mstr.Enum.Validation.STATUSCODE.INCOMPLETE_CONDITION;}break;}if(status==mstr.Enum.Validation.STATUSCODE.VALID&&exprType==enET.SINGLEBASEFORMQUAL){var form=UQ.getForm(node);if(!form){if(node.autoGeneratedByView){status=mstr.Enum.Validation.STATUSCODE.INCOMPLETE_CONDITION_ON_AUTO_NODE;}else{status=mstr.Enum.Validation.STATUSCODE.INCOMPLETE_CONDITION;}break;}}if(exprType==enET.LISTQUAL){var elems=UQ.getElements(node);if(mstr.$A.len(elems)==0){if(node.autoGeneratedByView){status=mstr.Enum.Validation.STATUSCODE.INCOMPLETE_CONDITION_ON_AUTO_NODE;}else{status=mstr.Enum.Validation.STATUSCODE.INCOMPLETE_CONDITION;}break;}}else{var count=UQ.computeFunctionConstantsRequired(node.value["function"],node.value.expressionType);var blankCount=0,UC=mstr.utils.ConstNode,US=mstr.utils.String,LP=mstr.utils.LocaleParser,lastDtp=null,isINQual=UQ.isINQual(node),isDateOrTimeDataType=function(dt){return(dt==14||dt==15||dt==16);},exprModelType=this.props.type;for(var i=1;i<=count;i++){var constNode=UQ.getConstantNode(node,i,false),txt=UC.getValue(constNode);if(!txt){blankCount++;}else{var dtps=US.smartSplit(UC.getDataType(constNode),","),vals=UQ.constValue2Array(txt,isINQual,exprModelType),valsFormatted=bFormat?[].concat(vals):null;for(var j=0,jLen=vals.length;j<jLen;j++){var parseResult=LP.whichDataType(vals[j],dtps,bFormat),thisDtp=bFormat?parseResult&&parseResult.dataType:parseResult;if(bFormat&&parseResult&&parseResult.formatted!=null){valsFormatted[j]=parseResult.formatted;}if(!thisDtp||((thisDtp!=lastDtp)&&(lastDtp!=null)&&!(isDateOrTimeDataType(thisDtp)&&isDateOrTimeDataType(lastDtp)))){status=mstr.Enum.Validation.STATUSCODE.INVALID_DATATYPE;break;}if(!lastDtp){lastDtp=thisDtp;}}if(!bFormat&&isINQual){valsFormatted=vals;bFormat=true;}if(bFormat){this.execEditNode(node);this._editConditionConstantNum(i,UQ.constArray2Value(valsFormatted,exprModelType));}}}if((status==mstr.Enum.Validation.STATUSCODE.VALID)&&(blankCount>0)){if(node.autoGeneratedByView&&blankCount==count){status=mstr.Enum.Validation.STATUSCODE.INCOMPLETE_CONDITION_ON_AUTO_NODE;}else{status=mstr.Enum.Validation.STATUSCODE.INCOMPLETE_CONDITION;}break;}}break;case enET.BRANCHQUAL:default:var c=node.children;for(var i=0,len=mstr.$A.len(c);i<len;i++){status=this.validate(c[i],context,bFormat);if(status!=mstr.Enum.Validation.STATUSCODE.VALID){break;}}break;}return status;};EM.prototype.cleanupConstants=function EM_cleanupConstants(node){if(!node){return ;}var enET=mstr.Enum.Nodes.EXPRESSIONTYPE,et=parseInt(node.value&&node.value.expressionType);switch(et){case enET.SINGLEMETRICQUAL:case enET.SINGLEBASEFORMQUAL:var UQ=mstr.utils.QualNode,count=UQ.computeFunctionConstantsRequired(node.value["function"],node.value.expressionType);var constNode;for(var i=2;i>count;i--){constNode=UQ.getConstantNode(node,i,false);if(constNode){mstr.utils.Trees.removeChildNode(node,constNode);}}var bIsPercent=UQ.isRankPercentQual(node),UC=mstr.utils.ConstNode,US=mstr.utils.String,resolvedDataType;for(var j=1;j<=count;j++){constNode=UQ.getConstantNode(node,j,false);if(!constNode){continue;}if(et==enET.SINGLEMETRICQUAL){var constDtp=UC.getDataType(constNode);if(!constDtp||String(constDtp).match(/\,/)){if(!resolvedDataType){resolvedDataType=UQ.resolveMQConstantsDataType(node,this.props.type);}UC.setDataType(constNode,resolvedDataType);}}if(bIsPercent){var constValue=UC.getValue(constNode);if((typeof (constValue)=="string")&&!US.isEmpty(constValue)){UC.setValue(constNode,constValue.replace(/\%/g,"")+"%");}}}break;case mstr.Enum.Nodes.EXPRESSIONTYPE.BRANCHQUAL:default:var c=node.children;for(var i=0,len=mstr.$A.len(c);i<len;i++){this.cleanupConstants(c[i]);}break;}};EM.prototype.cleanupAllForm=function EM_cleanupAllForm(root){var allFormNode=mstr.utils.Expr.findAllFormNode(root);if(!allFormNode){return root;}var conds=this._buildAllFormsConditions(allFormNode);var count=conds&&conds.length||0;if(!count){return null;}var qualNode=allFormNode.parent,bIsNOT=mstr.utils.ExprNode.isNOTNode(qualNode.parent),newNOT;if(count>1){var newOR=mstr.utils.Expr.newBranchQual(mstr.Enum.Nodes.FUNCTION.OR);if(bIsNOT){for(var i=0;i<count;i++){newNOT=mstr.utils.Expr.newBranchQual(mstr.Enum.Nodes.FUNCTION.NOT);mstr.utils.Trees.insertChildNodes(newOR,[newNOT],0);mstr.utils.Trees.insertChildNodes(newNOT,[conds[i]],0);}}else{mstr.utils.Trees.insertChildNodes(newOR,conds,0);}return newOR;}else{if(count==1){if(bIsNOT){newNOT=mstr.utils.Expr.newBranchQual(mstr.Enum.Nodes.FUNCTION.NOT);mstr.utils.Trees.insertChildNodes(newNOT,conds,0);return newNOT;}else{return conds[0];}}}};EM.prototype._buildAllFormsConditions=function EM_buildAFConds(allFormNode){var qualNode=allFormNode&&allFormNode.parent;if(!qualNode){return null;}if(mstr.utils.QualNode.isINQual(qualNode)){return this._buildAllFormsINConditions(allFormNode);}else{return this._buildAllFormsStandardConditions(allFormNode);}};EM.prototype._buildAllFormsINConditions=function EM_buildAFINConds(allFormNode){var UQ=mstr.utils.QualNode,qualNode=allFormNode.parent,constNode=UQ.getConstantNode(qualNode,1,false),constValue=mstr.utils.ConstNode.getValue(constNode);var arrValues=mstr.utils.QualNode.constValue2Array(constValue,true,this.props.type);var UA=mstr.utils.Arrays,UM=mstr.utils.Math,LP=mstr.utils.LocaleParser,exprModelType=this.props.type,constValueBuckets={STRING:constValue,INTEGER:UQ.constArray2Value(UA.filter(arrValues,LP,"isInteger"),exprModelType),NUMERIC:UQ.constArray2Value(UA.filter(arrValues,LP,"isNumeric"),exprModelType),DATE:UQ.constArray2Value(UA.filter(arrValues,LP,"isDateAndOrTime"),exprModelType)};var conds=[];var attr=mstr.utils.FormShortcutNode.getAttribute(allFormNode),forms=attr&&attr.dssforms;for(var i=0,len=forms&&forms.length||0;i<len;i++){var form=forms[i],formDtp=form&&form.dtp,newCondition=null,bucket=null;if(UM.isDataTypeInteger(formDtp)){bucket="INTEGER";}else{if(UM.isDataTypeNumeric(formDtp)){bucket="NUMERIC";}else{if(UM.isDataTypeDateTime(formDtp)){bucket="DATE";}else{bucket="STRING";}}}if(bucket&&constValueBuckets[bucket]!=null&&constValueBuckets[bucket]!=""){newCondition=this._buildCloneAQ(qualNode,form,formDtp,constValueBuckets[bucket]);if(newCondition){conds.push(newCondition);}}}return conds;};EM.prototype._buildAllFormsStandardConditions=function EM_buildAFStConds(allFormNode){var conds=[];var qualNode=allFormNode.parent,enDT=mstr.Enum.Nodes.DATATYPE,dtps=[enDT.INTEGER,enDT.NUMERIC,enDT.DATE,enDT.VARCHAR],dtp=mstr.utils.QualNode.guessAQConstantsDataType(qualNode,dtps,this.props.type);var attr=mstr.utils.FormShortcutNode.getAttribute(allFormNode),forms=attr&&attr.dssforms,UM=mstr.utils.Math;for(var i=0,len=forms&&forms.length||0;i<len;i++){var form=forms[i],formDtp=form&&form.dtp,newCondition=null;if(UM.canCastDataType(dtp,formDtp)){newCondition=this._buildCloneAQ(qualNode,form,formDtp);if(newCondition){conds.push(newCondition);}}}return conds;};EM.prototype._buildCloneAQ=function EM_buildCloneAQ(qualNode,form,dataType,constValue1){var qualNodeClone=mstr.utils.Trees.cloneSubTree(qualNode);if(form!=null){var shortcutNodeClone=mstr.utils.QualNode.getFormShortcutNode(qualNodeClone);if(shortcutNodeClone){shortcutNodeClone.value=mstr.$H.clone(shortcutNodeClone.value);mstr.utils.FormShortcutNode.setForm(shortcutNodeClone,form);}}if(dataType!=null){for(var j=1;j<=2;j++){var constNodeClone=mstr.utils.QualNode.getConstantNode(qualNodeClone,j,false);if(constNodeClone){constNodeClone.value=mstr.$H.clone(constNodeClone.value);mstr.utils.ConstNode.setDataType(constNodeClone,dataType);if((j==1)&&arguments.length>3){mstr.utils.ConstNode.setValue(constNodeClone,constValue1);}}}}return qualNodeClone;};EM.prototype.count=function EM_count(){return mstr.utils.Expr.countConditions(this.props.rootNode);};EM.prototype.isEmpty=function EM_isEmpty(){return mstr.utils.Expr.isEmpty(this.props.rootNode);};EM.prototype._compressListFormQuals=function EM_compressListFormQuals(node){switch(node&&node.value&&parseInt(node.value.expressionType)){case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTFORMQUAL:node.value.expressionType=mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL;var constNodesInfo=mstr.utils.QualNode.getConstantNodesInfo(node);var arr=[];for(i=0;i<constNodesInfo.length;i++){var constNode=constNodesInfo[i].node;if(constNode){arr.push(mstr.utils.ConstNode.getValue(constNode));}}var len=mstr.$A.len(arr),UQ=mstr.utils.QualNode,UT=mstr.utils.Trees;if(len>1){var constNode;for(var i=len;i>=2;i--){UT.removeChildNodeAt(node,constNodesInfo[i-1].childIndex);}}constNode=UQ.getConstantNode(node,1,false);if(constNode){mstr.utils.ConstNode.setValue(constNode,UQ.constArray2Value(arr,this.props.type));}break;case mstr.Enum.Nodes.EXPRESSIONTYPE.BRANCHQUAL:var c=node.children;for(var i=0,len=mstr.$A.len(c);i<len;i++){this._compressListFormQuals(c[i]);}break;}};EM.prototype.init=function EM_init(){mstr.models.AbstractTreeBase.prototype.init.apply(this);this._compressListFormQuals(this.props.rootNode);};EM.prototype._getNodeTypeString=function EM_getNodeTypeString(node){if(node){if(mstr.utils.ExprNode.isANDORNode(node)){return"ANDOR";}else{if(mstr.utils.ExprNode.isNOTNode(node)){return"NOT";}else{return"condition";}}}return"";};function EM(props){mstr.models.AbstractTreeBase.apply(this,[props]);}return EM;})();mstr.utils.Expr=(function(){var E={};E.createCondition=function E_createCondition(args){switch(args.expressionType){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:return this.createMetricQualifier(args.target,args.func,args.level,args.levelAttributes,args.treeId);case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:return this.createAttributeQualifier(args.target,args.form,args.func,args.treeId);case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:return this.createAttributeElementsList(args.target,args.elements,args.func,args.treeId);}};E.createAttributeQualifier=function E_createAttrQual(attr,form,func,treeId){var qualNode=mstr.utils.QualNode.newNode(mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL,null);qualNode.treeId=treeId;var fsNode=mstr.utils.FormShortcutNode.newNode(attr,form);var dataType=form&&form.dtp||mstr.Settings.Expression.DEFAULTFORMDATATYPE;var const1Node=mstr.utils.ConstNode.newNode(null,dataType);var const2Node=mstr.utils.ConstNode.newNode(null,dataType);mstr.utils.Trees.insertChildNodes(qualNode,[fsNode,const1Node,const2Node],0,treeId);if(func){mstr.utils.QualNode.setFunction(qualNode,func);}return qualNode;};E.createMetricQualifier=function E_createMetricQual(metric,func,level,levelAttributes,treeId){var qualNode=mstr.utils.QualNode.newNode(mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL,level,levelAttributes);qualNode.treeId=treeId;var sNode=mstr.utils.ShortcutNode.newNode(metric);var dataType=mstr.utils.QualNode.getDataType(qualNode,false);var const1Node=mstr.utils.ConstNode.newNode(null,dataType);var const2Node=mstr.utils.ConstNode.newNode(null,dataType);mstr.utils.Trees.insertChildNodes(qualNode,[sNode,const1Node,const2Node],0,treeId);if(func){mstr.utils.QualNode.setFunction(qualNode,func);}return qualNode;};E.createAttributeElementsList=function E_createAttrElList(attr,elems,func,treeId){var qualNode=mstr.utils.QualNode.newNode(mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL,null);qualNode.treeId=treeId;qualNode.value["function"]=(func&&func.id)||mstr.Enum.Nodes.FUNCTION.IN;var sNode=mstr.utils.ShortcutNode.newNode(attr);var elemsNode=mstr.utils.ElementsObjectNode.newNode(attr,elems);mstr.utils.Trees.insertChildNodes(qualNode,[sNode,elemsNode],0,treeId);return qualNode;};E.newBranchQual=function E_newBranchQual(functionId,treeId){return{value:{nodeType:mstr.Enum.Nodes.NODETYPE.NODEOPERATOR,expressionType:mstr.Enum.Nodes.EXPRESSIONTYPE.BRANCHQUAL,nodeDimtyType:mstr.Enum.Nodes.NODEDIMTYTYPE.NONE,dataType:mstr.Enum.Nodes.DATATYPE.UNKNOWN,"function":functionId},treeId:treeId};};E.newTUPLE=function E_newTUPLE(treeId){return{value:{nodeType:mstr.Enum.Nodes.NODETYPE.NODEOPERATOR,expressionType:mstr.Enum.Nodes.EXPRESSIONTYPE.MDXSAPVARIABLE,nodeDimtyType:mstr.Enum.Nodes.NODEDIMTYTYPE.NONE,dataType:mstr.Enum.Nodes.DATATYPE.UNKNOWN,"function":mstr.Enum.Nodes.FUNCTION.TUPLE},treeId:treeId};};E.newTUPLENOT=function E_newTUPLENOT(treeId){return this.newBranchQual(mstr.Enum.Nodes.FUNCTION.NOT);};E.newRankNode=function E_newRankNode(treeId){return{value:{nodeType:mstr.Enum.Nodes.NODETYPE.NODEOPERATOR,expressionType:mstr.Enum.Nodes.EXPRESSIONTYPE.GENERIC,nodeDimtyType:mstr.Enum.Nodes.NODEDIMTYTYPE.NONE,dataType:mstr.Enum.Nodes.DATATYPE.UNKNOWN,"function":mstr.Enum.Nodes.FUNCTION.RANK},treeId:treeId};};E.findANDORNode=function E_findANDORNode(node,bInclusive){if(!node){return null;}if(bInclusive!=false){if(mstr.utils.ExprNode.isANDORNode(node)){return node;}}if(node.children){var c=node.children;var len=c.length||0;for(var i=0;i<len;i++){var match=this.findANDORNode(c[i],true);if(match){return match;}}}return null;};E.findAllFormNode=function E_findAllFormNode(node,bInclusive){if(!node){return null;}if(bInclusive!=false){if(node.value&&node.value.form&&(node.value.form["dssid"]==mstr.Enum.Form.ALL.dssid)){return node;}}if(node.children){var c=node.children;var len=c.length||0;for(var i=0;i<len;i++){var match=this.findAllFormNode(c[i],true);if(match){return match;}}}return null;};E.countConditions=function E_countConditions(node){var count=0;if(!node){return count;}switch(mstr.utils.QualNode.getExpressionType(node)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:count++;break;case mstr.Enum.Nodes.EXPRESSIONTYPE.BRANCHQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.MDXSAPVARIABLE:if(node.children){var c=node.children;var len=c.length||0;for(var i=0;i<len;i++){count+=this.countConditions(c[i]);}}break;}return count;};E.isEmpty=function E_isEmpty(node){if(!node){return true;}switch(mstr.utils.QualNode.getExpressionType(node)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:var target=mstr.utils.QualNode.getTarget(node);return !target||target.dssid=="0";case mstr.Enum.Nodes.EXPRESSIONTYPE.BRANCHQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.MDXSAPVARIABLE:if(node.children){var c=node.children;var len=c.length||0;for(var i=0;i<len;i++){if(!this.isEmpty(c[i])){return false;}}}break;}return true;};E.getAllowedExprTypesArray=function E_getAllowedExprTypesArray(model){if(!model){return null;}var arrAllowed=model.get("allowedExpressionTypesArray");if(!arrAllowed){var arrAllowed=model.get("allowedExpressionTypes");arrAllowed=(arrAllowed&&arrAllowed.split(","))||[];model.set("allowedExpressionTypesArray",arrAllowed);for(var i=0,len=arrAllowed.length;i<len;i++){arrAllowed[i]=parseInt(arrAllowed[i]);}}var idx=mstr.$A.find(arrAllowed,mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL);var node=model&&model.get("editNode");var target=node&&mstr.utils.QualNode.getTarget(node);if(idx>-1&&target&&target.tp==mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTE&&target.locked){arrAllowed=arrAllowed.slice(idx,idx+1);}return arrAllowed;};E.getAllowedExprTypesHash=function E_getAllowedExprTypesHash(model){if(!model){return null;}var hashAllowed=model.get("allowedExpressionTypesHash");if(!hashAllowed){var hashAllowed=model.get("allowedExpressionTypes");hashAllowed=mstr.$A.toHash(hashAllowed&&hashAllowed.split(",")||[]);model.set("allowedExpressionTypesHash",hashAllowed);}return hashAllowed;};E.getDefaultRootOperator=function E_getDefaultRootOperator(model){if(!model){return null;}switch(model&&model.get("type")){case"SAP_CHAR_VARIABLE":case"SAP_HIER_NODE_VARIABLE":return mstr.Enum.Nodes.FUNCTION.TUPLE;default:return model.get("defaultBranchQualId")||mstr.Enum.Nodes.FUNCTION.AND;}};return E;})();mstr.utils.ExprNode=(function(){var EN={};EN.isANDORNode=function E_isANDORNode(node){var funcIds={};funcIds[mstr.Enum.Nodes.FUNCTION.AND]=true;funcIds[mstr.Enum.Nodes.FUNCTION.OR]=true;return this.isNodeOperator(node,funcIds);};EN.isTUPLENode=function E_isTUPLENode(node){var nv=node&&node.value;return !!(nv&&(nv[mstr.Props.Nodes.EXPRESSIONTYPE]==mstr.Enum.Nodes.EXPRESSIONTYPE.MDXSAPVARIABLE)&&(nv[mstr.Props.Nodes.FUNCTION]==mstr.Enum.Nodes.FUNCTION.TUPLE));};EN.isNOTNode=function E_isNOTNode(node){var funcIds={};funcIds[mstr.Enum.Nodes.FUNCTION.NOT]=true;return this.isNodeOperator(node,funcIds);};EN.isRankNode=function E_isRankNode(node){var nv=node&&node.value;if(nv&&nv["function"]==mstr.Enum.Nodes.FUNCTION.RANK&&nv.nodeType==mstr.Enum.Nodes.NODETYPE.NODEOPERATOR){return true;}return false;};EN.isNodeOperator=function EN_isNodeOperator(node,funcIds){var funcId=node&&node.value&&node.value["function"];if(funcIds&&funcIds[funcId]){return node.value.nodeType==mstr.Enum.Nodes.NODETYPE.NODEOPERATOR;}return false;};EN.findNonNOTChild=function EN_findNonNOTChild(parent,childIndex){if(!parent){return null;}var child=(childIndex!=null)?parent.children&&parent.children[childIndex]:parent;while(this.isNOTNode(child)){child=child.children&&child.children[0];}return child;};EN.findNonNOTChildInfo=function EN_findNonNOTChildInfo(parent,childIndex){if(parent&&(childIndex>-1)){var child=parent&&parent.children&&parent.children[childIndex];var path="";while(this.isNOTNode(child)){child=child.children&&child.children[0];path+=mstr.models.AbstractTreeBase.PATHDELIM+"0";}return{child:child,path:path};}return null;};EN.findNonNOTParent=function EN_findNonNOTParent(node){while(node){if(!this.isNOTNode(node.parent)){return node.parent;}node=node.parent;}return null;};EN.findNonNOTParentInfo=function EN_findNonNOTParentInfo(node){while(node){if(!this.isNOTNode(node.parent)){return{parent:node.parent,childIndex:mstr.utils.Trees.findChildIndex(node.parent,node),child:node};}node=node.parent;}return info;};EN.findNonNOTPreviousSibling=function EN_findNonNOTPS(node){var parentInfo=this.findNonNOTParentInfo(node);if(parentInfo&&parentInfo.parent&&(parentInfo.childIndex>0)){return this.findNonNOTChild(parentInfo.parent,parentInfo.childIndex-1);}return null;};EN.findNonNOTNextSibling=function EN_findNonNOTNS(node){var parentInfo=this.findNonNOTParentInfo(node);if(parentInfo&&parentInfo.parent){return this.findNonNOTChild(parentInfo.parent,parentInfo.childIndex+1);}return null;};EN.areNonNOTSiblings=function EN_findNonNOTSiblings(node1,node2){if(node1&&node2){var p1=this.findNonNOTParent(node1);return !!(p1&&(p1==this.findNonNOTParent(node2)));}return false;};EN.isFirstCondition=function EN_isFirstCondition(node){if(!node){return true;}var p=node.parent;if(!p){return true;}while(this.isNOTNode(p)){node=p;p=node.parent;if(!p){return true;}}var first=p.children&&p.children[0];return first==node;};EN.getBranchQual=function EN_getBranchQual(node){if(!node){return null;}var bNOT=mstr.utils.ExprNode.isNOTNode(node.parent);var p=mstr.utils.ExprNode.findNonNOTParent(node);if(p){var dssid;switch(p&&p.value&&parseInt(p.value["function"])){case mstr.Enum.Nodes.FUNCTION.AND:dssid=bNOT?mstr.Enum.BranchQual.DSSID.ANDNOT:mstr.Enum.BranchQual.DSSID.AND;break;case mstr.Enum.Nodes.FUNCTION.OR:dssid=bNOT?mstr.Enum.BranchQual.DSSID.ORNOT:mstr.Enum.BranchQual.DSSID.OR;break;default:return null;}return{dssid:dssid};}return null;};EN.getInclude=function EN_getInclude(node){var dssid=mstr.utils.ExprNode.isNOTNode(node&&node.parent)?mstr.Enum.Nodes.INCLUDESTATE.EXCLUDE:mstr.Enum.Nodes.INCLUDESTATE.INCLUDE;return{dssid:dssid};};EN.setScalarProp=function EN_setScalarProp(node,propName,propValue){if(node&&node.value){var oldValue=node.value[propName];if(oldValue!=propValue){node.value[propName]=propValue;return true;}}return false;};EN.setObjectProp=function EN_setObjectProp(node,propName,propValue,valueForm){if(node&&node.value){var oldValue=node.value[propName];if(!valueForm||((oldValue&&oldValue[valueForm])!=(propValue&&propValue[valueForm]))){node.value[propName]=propValue;return true;}}return false;};EN.clone=function EN_clone(node){if(node){return{value:mstr.utils.Hash.clone(node.value)};}return null;};return EN;})();mstr.utils.DimtyObject=(function(){var DO={};DO.newObject=function DO_newObject(levelId,attributes){var dimtyObject={canContinue:true,filterRest:true};if(parseInt(levelId)==mstr.Enum.Nodes.NODEDIMTYLEVEL.ATTRIBUTES){dimtyObject[mstr.Props.DimtyObject.UNITS]=this._buildDimtyUnits(attributes);}return dimtyObject;};DO._buildDimtyUnits=function DO_buildDimtyUnits(attributes){var len=mstr.$A.len(attributes);if(len){var arr=new Array(len);for(var i=0;i<len;i++){arr[i]=mstr.utils.DimtyUnit.newAttributeUnit(attributes[i]);}return arr;}return null;};DO._parseDimtyUnits=function DO_parseDimtyUnits(units){var len=mstr.$A.len(units);if(len){var arr=[];for(var i=0;i<len;i++){var attr=units[i]&&units[i][mstr.Props.DimtyUnit.TARGET];if(attr){arr.push(attr);}}return arr;}return null;};return DO;})();mstr.utils.DimtyUnit=(function(){var DU={};DU.newAttributeUnit=function DU_newAttrUnit(attribute){return{target:attribute,unitType:mstr.Enum.DimtyUnit.UNITTYPE.ATTRIBUTE,aggregation:1,filtering:2,groupBy:1,relativePosition:0};};return DU;})();mstr.utils.ConstNode=(function(){var CN={};CN.newNode=function CN_newNode(constValue,constDataType,treeId){return{value:{nodeType:mstr.Enum.Nodes.NODETYPE.CONSTANT,expressionType:mstr.Enum.Nodes.EXPRESSIONTYPE.GENERIC,dataType:constDataType||mstr.Enum.Nodes.DATATYPE.UNKNOWN,nodeDimtyType:mstr.Enum.Nodes.NODEDIMTYTYPE.NONE,constantValue:constValue,constantDataType:this.dataTypeToVariantType(constDataType)||mstr.Enum.Nodes.DATATYPE.UNKNOWN},treeId:treeId};};CN.getValue=function CN_getValue(node){return node&&node.value&&node.value.constantValue;};CN.setValue=function CN_setValue(node,constValue){return mstr.utils.ExprNode.setScalarProp(node,"constantValue",constValue);};CN.guessDataType=function CN_guessDataType(constValue,defaultType,delim){if(constValue==null||constValue==""){return defaultType;}if(delim){constValue=constValue.split(delim)[0];}var trimmedValue=mstr.utils.String.trimDelimited(constValue);if(this.isValidDate(trimmedValue)){return mstr.Enum.Nodes.DATATYPE.TIMESTAMP;}if(this.isBigDec(trimmedValue)){return mstr.Enum.Nodes.DATATYPE.BIGDECIMAL;}if(this.isPercentNumber(trimmedValue)||this.isNumber(trimmedValue)){return mstr.Enum.Nodes.DATATYPE.REAL;}return defaultType;};CN.isValidDate=function CN_isValidDate(v){if(!v){return false;}var fmts=mstr.Settings.Locale.DATEINPUTFORMATS;for(i in fmts){if(mstr.models.Calendar.isPatternValid(fmts[i],v)){return true;}}return false;};CN.isBigDec=function CN_isBigDec(v){var vv=v.match(/^#([^#]+)#$/);return(vv&&vv.length>1&&this.isNumber(vv[1]));};CN.isPercentNumber=function CN_isPercentNumber(v){if(v.match(/\%$/)){var val=v.replace(/\%$/gm,"");return this.isNumber(val);}return false;};CN.isNumber=function CN_isNumber(v){var formattedV=microstrategy.number.toString(v,true);return !isNaN(formattedV);};CN.getDataType=function CN_getDataType(node){var dtp=node&&node.value&&node.value.constantDataType;if(typeof (dtp)=="string"&&!dtp.match(/\,/)){return parseInt(dtp);}else{return dtp;}};CN.setDataType=function CN_setDataType(node,dataType){if(node&&node.value){node.value.dataType=dataType;switch(parseInt(dataType)){case mstr.Enum.Nodes.DATATYPE.DATE:case mstr.Enum.Nodes.DATATYPE.TIME:case mstr.Enum.Nodes.DATATYPE.TIMESTAMP:node.value[mstr.Props.Nodes.NODETYPE]=mstr.Enum.Nodes.NODETYPE.TIME;break;default:node.value[mstr.Props.Nodes.NODETYPE]=mstr.Enum.Nodes.NODETYPE.CONSTANT;break;}}return mstr.utils.ExprNode.setScalarProp(node,"constantDataType",this.dataTypeToVariantType(dataType));};CN.dataTypeToVariantType=function dataTypeToVariantType(dataType){switch(dataType){case mstr.Enum.Nodes.DATATYPE.REAL:return mstr.Enum.Nodes.VariantType.VT_R8;case mstr.Enum.Nodes.DATATYPE.LONG:return mstr.Enum.Nodes.VariantType.VT_INT;case mstr.Enum.Nodes.DATATYPE.INT64:return mstr.Enum.Nodes.VariantType.VT_I8;default:return dataType;}};return CN;})();mstr.utils.QualNode=(function(){var QN={};QN.newNode=function QN_newNode(expressionType,level,levelAttributes){var nv={nodeType:mstr.Enum.Nodes.NODETYPE.NODEOPERATOR,dataType:mstr.Enum.Nodes.DATATYPE.UNKNOWN,expressionType:expressionType,nodeDimtyType:mstr.Enum.Nodes.NODEDIMTYTYPE.NONE};if(expressionType==mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL){nv.nodeDimtyType=mstr.Enum.Nodes.NODEDIMTYTYPE.UNSPECIFIED;if(level){nv.nodeDimtyType=this.mapLevelToDimtyType(level.dssid);nv.dimtyObject=mstr.utils.DimtyObject.newObject(level.dssid,levelAttributes);}}return{value:nv};};QN.mapLevelToDimtyType=function QN_mapLevelToDimtyType(levelId){switch(parseInt(levelId)){case mstr.Enum.Nodes.NODEDIMTYLEVEL.METRIC:return mstr.Enum.Nodes.NODEDIMTYTYPE.NONE;case mstr.Enum.Nodes.NODEDIMTYLEVEL.REPORT:case mstr.Enum.Nodes.NODEDIMTYLEVEL.ATTRIBUTES:return mstr.Enum.Nodes.NODEDIMTYTYPE.OUTPUTLEVEL;case mstr.Enum.Nodes.NODEDIMTYLEVEL.DEFAULT:default:return mstr.Enum.Nodes.NODEDIMTYTYPE.UNSPECIFIED;}};QN.getExpressionType=function QN_getExpressionType(node){return node&&node.value&&parseInt(node.value.expressionType);};QN.getExprType=function QN_getExprType(node){var et=this.getExpressionType(node);switch(et){case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:var index=mstr.$A.findByForm(mstr.Settings.Functions.ExprType,et,"dssid");if(index>-1){return mstr.Settings.Functions.ExprType[index];}break;}return null;};QN.isMetricQual=function QN_isMetricQual(node){return this.getExpressionType(node)==mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL;};QN.setExprType=function QN_setExprType(node,exprType,defaultFunc){if(!node){return false;}var oldET=this.getExpressionType(node);var newET=exprType&&parseInt(exprType.dssid);if(oldET==newET){return false;}mstr.utils.ExprNode.setScalarProp(node,"expressionType",newET);switch(newET){case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:var fsNode=this.getFormShortcutNode(node);var attr=fsNode&&mstr.utils.FormShortcutNode.getAttribute(fsNode);var sNode=mstr.utils.ShortcutNode.newNode(attr);fsNode&&mstr.utils.Trees.removeChildNode(node,fsNode);sNode&&mstr.utils.Trees.insertChildNodes(node,[sNode],0,node.treeId);this.setFunction(node,{tp:(defaultFunc&&defaultFunc.tp)||mstr.Enum.Nodes.FUNCTIONTYPE.DEFAULT,id:(defaultFunc&&defaultFunc.id)||mstr.Enum.Nodes.FUNCTION.IN});var constNode;for(var i=1;i<=2;i++){constNode=this.getConstantNode(node,1,false);if(!constNode){break;}mstr.utils.Trees.removeChildNode(node,constNode);}var elemsNode=mstr.utils.ElementsObjectNode.newNode(attr,[]);elemsNode&&mstr.utils.Trees.insertChildNodes(node,[elemsNode],node.children.length,node.treeId);break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:var sNode=this.getShortcutNode(node);var attr=sNode&&mstr.utils.ShortcutNode.getTarget(sNode);var firstForm=attr&&attr.dssforms&&attr.dssforms[0]||null;var fsNode=mstr.utils.FormShortcutNode.newNode(attr,firstForm);sNode&&mstr.utils.Trees.removeChildNode(node,sNode);fsNode&&mstr.utils.Trees.insertChildNodes(node,[fsNode],0,node.treeId);this.setFunction(node,{tp:(defaultFunc&&defaultFunc.tp)||mstr.Enum.Nodes.FUNCTIONTYPE.DEFAULT,id:(defaultFunc&&defaultFunc.id)||mstr.Enum.Nodes.FUNCTION.EQUALS});var elemsNode=this.getElementsObjectNode(node);elemsNode&&mstr.utils.Trees.removeChildNode(node,elemsNode);var dataType=(firstForm&&firstForm.dtp)||mstr.Settings.Expression.DEFAULTFORMDATATYPE;var const1Node=mstr.utils.ConstNode.newNode(null,dataType);var const2Node=mstr.utils.ConstNode.newNode(null,dataType);mstr.utils.Trees.insertChildNodes(node,[const1Node,const2Node],node.children.length,node.treeId);break;}return true;};QN.getDataType=function QN_getDataType(node,bUnknownMetricOK){switch(this.getExpressionType(node)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:var dtp=mstr.Settings.Expression.DEFAULTMETRICDATATYPE;if((bUnknownMetricOK===false)&&dtp==mstr.Enum.Nodes.DATATYPE.UNKNOWN){return this.getAllowedMetricDataTypes();}return dtp;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:var formShortcutNode=this.getFormShortcutNode(node);var form=mstr.utils.FormShortcutNode.getForm(formShortcutNode);return(form&&form.dtp!=null)?form.dtp:mstr.Settings.Expression.DEFAULTFORMDATATYPE;break;default:return mstr.Enum.Nodes.DATATYPE.UNKNOWN;}};QN.guessAQConstantsDataType=function QN_guessAQConstsDTP(qualNode,dtps,exprModelType){var constNode1=this.getConstantNode(qualNode,1,false),enDT=mstr.Enum.Nodes.DATATYPE;if(!constNode1){return enDT.UNKNOWN;}var val1=mstr.utils.ConstNode.getValue(constNode1);if(this.isINQual(qualNode)){var arrVals=this.constValue2Array(val1,true,exprModelType);val1=arrVals&&arrVals[0];}if(!dtps){dtps=[enDT.INTEGER,enDT.NUMERIC,enDT.DATE,enDT.VARCHAR];}var LP=mstr.utils.LocaleParser,dtp1=LP.whichDataType(val1,dtps);if(!this.isBETWEENQual(qualNode)){return dtp1||enDT.UNKNOWN;}var constNode2=this.getConstantNode(qualNode,2,false),val2=constNode2&&mstr.utils.ConstNode.getValue(constNode2),dtp2=LP.whichDataType(val2,dtps);return mstr.utils.Math.getCommonDataType(dtp1,dtp2);};QN.resolveMQConstantsDataType=function QN_resMQConstsDTP(qualNode,exprModelType){var constNode1=this.getConstantNode(qualNode,1,false),dtps=mstr.utils.ConstNode.getDataType(constNode1),arrDtps=mstr.utils.String.smartSplit(dtps,",");return this.guessAQConstantsDataType(qualNode,arrDtps,exprModelType);};QN.getAllowedMetricDataTypes=function QN_getAllwMQTypes(bAsArray){var enDT=mstr.Enum.Nodes.DATATYPE;switch(parseInt(mstr.Settings.Expression.METRICVALIDATIONLEVEL)){case 1:return bAsArray?[enDT.REAL]:enDT.REAL;case 2:var arr2=[enDT.DATE,enDT.REAL,enDT.CHAR];return bAsArray?arr2:arr2.join(",");case 0:default:var arr0=[enDT.DATE,enDT.REAL];return bAsArray?arr0:arr0.join(",");}};QN.getShortcutNode=function QN_getSNode(node){var nodeTypes={};nodeTypes[mstr.Enum.Nodes.NODETYPE.SHORTCUT]=true;var info=this._getChildNodeByType(node,nodeTypes,1);if(!(info&&info.node)){var rankNode=this.getRankNode(node);if(rankNode){info=this._getChildNodeByType(rankNode,nodeTypes,1);}}return info&&info.node;};QN.getElementsObjectNode=function QN_getElementsObjectNode(node){var nodeTypes={};nodeTypes[mstr.Enum.Nodes.NODETYPE.ELEMENTSOBJECT]=true;var info=this._getChildNodeByType(node,nodeTypes,1);return info&&info.node;};QN.getFormShortcutNode=function QN_getFSNode(node){var nodeTypes={};nodeTypes[mstr.Enum.Nodes.NODETYPE.FORMSHORTCUT]=true;var info=this._getChildNodeByType(node,nodeTypes,1);if(!(info&&info.node)){var rankNode=this.getRankNode(node);if(rankNode){info=this._getChildNodeByType(rankNode,nodeTypes,1);}}return info&&info.node;};QN.getConstantNodesInfo=function QN_getConstantNodes(node){var nodeTypes={};nodeTypes[mstr.Enum.Nodes.NODETYPE.CONSTANT]=true;nodeTypes[mstr.Enum.Nodes.NODETYPE.BIGDECIMAL]=true;nodeTypes[mstr.Enum.Nodes.NODETYPE.TIME]=true;return this._getChildNodesByType(node,nodeTypes);};QN.getConstantNode=function QN_getConstantNode(node,num,bCreate,treeId){var nodeTypes={};nodeTypes[mstr.Enum.Nodes.NODETYPE.CONSTANT]=true;nodeTypes[mstr.Enum.Nodes.NODETYPE.BIGDECIMAL]=true;nodeTypes[mstr.Enum.Nodes.NODETYPE.TIME]=true;var info=this._getChildNodeByType(node,nodeTypes,num);if(!info.node&&bCreate){var newNodes=[];var dataType=mstr.utils.QualNode.getDataType(node,false);for(var i=info.found+1;i<=num;i++){newNodes.push(mstr.utils.ConstNode.newNode(null,dataType));}mstr.utils.Trees.insertChildNodes(node,newNodes,mstr.$A.len(node.children),treeId);return newNodes[newNodes.length-1];}return info.node;};QN.getConstantValue=function QN_getConstantValue(node,num){var constNode=this.getConstantNode(node,num);if(constNode){return mstr.utils.ConstNode.getValue(constNode);}return null;};QN.getConstantValues=function QN_getConstantValues(node){var arr=[];var constNode;var i=1;do{constNode=this.getConstantNode(node,i);if(constNode){arr.push(mstr.utils.ConstNode.getValue(constNode));}i++;}while(constNode);return arr;};QN.getConstNodeValuesArray=function CN_getConstNodeValsArr(qualNode,constNum,exprModelType){var constValue=mstr.utils.QualNode.getConstantValue(qualNode,constNum);return this.constValue2Array(constValue,(constNum==1)&&this.isINQual(qualNode),exprModelType);};QN.constValue2Array=function QN_constVal2Arr(val,isINList,exprModelType){if(!val){return[];}var DELIM=mstr.Settings.Expression.QUALIFICATIONDELIMITER;var arr;if(isINList){arr=mstr.utils.String.smartSplit(val,DELIM,!mstr.Settings.Expression.PRESERVEWHITESPACE);arr=mstr.utils.Arrays.removeInstances(arr,"");}else{arr=[val];}return arr;};QN.constArray2Value=function QN_constArr2Val(arr,exprModelType){var len=arr&&arr.length||0;if(!len){return null;}var DELIMS=mstr.Settings.Expression.QUALIFICATIONDELIMITER,DELIM=(DELIMS&&DELIMS[0])||DELIMS;var constValue;if(len>1){if(!mstr.Settings.Expression.PRESERVEWHITESPACE){DELIM+=" ";}constValue=arr.join(DELIM);}else{constValue=arr[0];}return constValue;};QN.addConstValue2List=function QN_addConstVal2Lst(listVal,addVal,exprModelType){var arr=this.constValue2Array(listVal,true,exprModelType);arr.push(addVal);return this.constArray2Value(arr,exprModelType);};QN._getChildNodesByType=function QN_getChildNodesByType(node,nodeTypes){var ch=node&&node.children,found=[];for(var i=0,len=mstr.$A.len(ch);i<len;i++){var c=ch[i];if(c&&c.value&&nodeTypes[c.value.nodeType]){found.push({node:c,childIndex:i});}}return found;};QN._getChildNodeByType=function QN_getChildNodeByType(node,nodeTypes,count){count=count||1;var countFound=0;var ch=node&&node.children;for(var i=0,len=mstr.$A.len(ch);i<len;i++){var c=ch[i];if(c&&c.value&&nodeTypes[c.value.nodeType]){countFound++;if(countFound==count){return{node:ch[i],found:countFound,childIndex:i};}}}return{found:countFound};};QN.getLevel=function QN_getLevel(node,bIncludeName){var attrs,name,dssid=mstr.Enum.Nodes.NODEDIMTYLEVEL.DEFAULT;switch(parseInt(node&&node.value&&node.value.nodeDimtyType)){case mstr.Enum.Nodes.NODEDIMTYTYPE.UNSPECIFIED:dssid=mstr.Enum.Nodes.NODEDIMTYLEVEL.DEFAULT;break;case mstr.Enum.Nodes.NODEDIMTYTYPE.NONE:dssid=mstr.Enum.Nodes.NODEDIMTYLEVEL.METRIC;break;case mstr.Enum.Nodes.NODEDIMTYTYPE.OUTPUTLEVEL:var dimtyObject=node.value.dimtyObject;attrs=dimtyObject&&mstr.utils.DimtyObject._parseDimtyUnits(dimtyObject[mstr.Props.DimtyObject.UNITS]);var len=mstr.$A.len(attrs);if(len){var customId=new Array(len+1),customName=new Array(len);customId[0]=mstr.Enum.Nodes.NODEDIMTYLEVEL.ATTRIBUTES;for(var i=0;i<len;i++){customId[i+1]=attrs[i]["dssid"];customName[i]=attrs[i]["n"];}dssid=customId.join(",");name=customName.join(", ");}else{dssid=mstr.Enum.Nodes.NODEDIMTYLEVEL.REPORT;}break;}if(bIncludeName&&!name&&(dssid!=null)){var index=mstr.$A.findByForm(mstr.Settings.DimtyLevels,dssid,"dssid");if(index>-1){name=mstr.Settings.DimtyLevels[index]["n"];}}return{dssid:dssid,n:name,attributes:attrs};};QN.setLevel=function QN_setLevel(node,levelInfo){if(!node){return ;}var nv=node.value;if(!nv){nv=node.value={};}nv.nodeDimtyType=this.mapLevelToDimtyType(levelInfo&&levelInfo.dssid);nv.dimtyObject=mstr.utils.DimtyObject.newObject(levelInfo&&levelInfo.dssid,levelInfo&&levelInfo.attributes);return true;};QN.getFunction=function QN_getFunction(node,bIncludeName){var mrpInfo=this.convertNodeFunctionToMRPFunction(node);if(bIncludeName&&mrpInfo&&mrpInfo.mrpFunction){var arrs=[];switch(this.getExpressionType(node)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:arrs=[mstr.Settings.Functions.Metric,mstr.Settings.Functions.MDXMetric];break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:arrs=[mstr.Settings.Functions.Attribute,mstr.Settings.Functions.MDXAttribute,mstr.Settings.Functions.SAPAttribute];break;case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:arrs=[mstr.Settings.Functions.Element];break;}for(var i=0;i<arrs.length;i++){var index=mstr.$A.findByForm(arrs[i],mrpInfo.functionType+","+mrpInfo.mrpFunction,"dssid");if(index>-1){mrpInfo.functionName=arrs[i][index]["n"];break;}}}return{dssid:mrpInfo&&(mrpInfo.functionType+","+mrpInfo.mrpFunction),tp:mrpInfo&&mrpInfo.functionType,id:mrpInfo&&mrpInfo.mrpFunction,"function":node&&node.value["function"],propertyStr:node&&node.value.propertyStr,n:mrpInfo&&mrpInfo.functionName};};QN.isINQual=function QN_isINQual(node){if(!node||!node.value){return false;}var nv=node.value;return(nv["function"]==mstr.Enum.Nodes.FUNCTION.IN||nv["function"]==mstr.Enum.Nodes.FUNCTION.NOTIN)&&(nv.expressionType==mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL||nv.expressionType==mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL);};QN.isBETWEENQual=function QN_isBETWEENQual(node){if(!node||!node.value){return false;}var nv=node.value;return(nv["function"]==mstr.Enum.Nodes.FUNCTION.BETWEEN||nv["function"]==mstr.Enum.Nodes.FUNCTION.NOTBETWEEN);};QN.setFunction=function QN_setFunction(node,func){if(!node){return ;}var nodeInfo=func&&this.convertMRPFunctionToNodeFunction(func.id,func.tp);var bChangedId=mstr.utils.ExprNode.setScalarProp(node,"function",nodeInfo&&nodeInfo["function"]);var bNeedsRank=func&&(parseInt(func.tp)!=mstr.Enum.Nodes.FUNCTIONTYPE.DEFAULT);var rankNode=this.getRankNode(node);var bChangedPropStr=false,bToggledRankNode=(!!rankNode!=!!bNeedsRank);if(rankNode&&!bNeedsRank){var child=mstr.utils.Trees.removeChildNodeAt(rankNode,0);if(child){mstr.utils.Trees.insertChildNodes(node,[child],1,node.treeId);}mstr.utils.Trees.removeChildNode(node,rankNode);}else{if(!rankNode&&bNeedsRank){rankNode=mstr.utils.Expr.newRankNode(node.treeId);mstr.utils.Trees.insertChildNodes(node,[rankNode],0,node.treeId);var sNode;switch(this.getExpressionType(node)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:sNode=this.getShortcutNode(node);break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:sNode=this.getFormShortcutNode(node);break;}if(sNode){mstr.utils.Trees.removeChildNode(node,sNode)&&mstr.utils.Trees.insertChildNodes(rankNode,[sNode],0,node.treeId);}}}if(bNeedsRank){bChangedPropStr=mstr.utils.ExprNode.setScalarProp(rankNode,"propertyStr",nodeInfo&&nodeInfo.propertyStr);}return bChangedId||bToggledRankNode||bChangedPropStr;};QN.computeFunctionConstantsRequired=function QN_cFCR(funcId,exprType){switch(parseInt(exprType)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:switch(parseInt(funcId)){case mstr.Enum.Nodes.FUNCTION.BETWEEN:case mstr.Enum.Nodes.FUNCTION.NOTBETWEEN:return 2;case mstr.Enum.Nodes.FUNCTION.ISNULL:case mstr.Enum.Nodes.FUNCTION.ISNOTNULL:return 0;default:return 1;}break;}return 0;};QN.getTarget=function QN_getTarget(node){switch(this.getExpressionType(node)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:var sNode=this.getShortcutNode(node);return sNode&&mstr.utils.ShortcutNode.getTarget(sNode);break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:var fsNode=this.getFormShortcutNode(node);return fsNode&&mstr.utils.FormShortcutNode.getAttribute(fsNode);break;}};QN.setTarget=function QN_setTarget(node,target){switch(this.getExpressionType(node)){case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEMETRICQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL:var sNode=this.getShortcutNode(node);return sNode&&mstr.utils.ShortcutNode.setTarget(sNode,target);break;case mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL:case mstr.Enum.Nodes.EXPRESSIONTYPE.LISTFORMQUAL:var fsNode=this.getFormShortcutNode(node);return fsNode&&mstr.utils.FormShortcutNode.setAttribute(fsNode,target);break;}};QN.targetsMatch=function QN_targetsMatch(qualNode,target){if(qualNode&&target&&target.dssid){var t=this.getTarget(qualNode);return !!t&&(t.dssid==target.dssid);}return false;};QN.getForm=function QN_getForm(node){var fsNode=this.getFormShortcutNode(node);return fsNode&&mstr.utils.FormShortcutNode.getForm(fsNode);};QN.setForm=function QN_setForm(node,form){var fsNode=this.getFormShortcutNode(node);return fsNode&&mstr.utils.FormShortcutNode.setForm(fsNode,form);};QN.getElements=function QN_getElements(node){var elemsNode=this.getElementsObjectNode(node);return elemsNode&&mstr.utils.ElementsObjectNode.getElements(elemsNode);};QN.setElements=function QN_setElements(node,arr){var elemsNode=this.getElementsObjectNode(node);return elemsNode&&mstr.utils.ElementsObjectNode.setElements(elemsNode,arr);};QN.getAvailableFunctions=function QN_getAvailableFunctions(functionCategory,node){if(this.getExpressionType(node)==mstr.Enum.Nodes.EXPRESSIONTYPE.LISTQUAL){functionCategory="Element";}var arr=functionCategory?[].concat(mstr.Settings.Functions[functionCategory]):[];var dataType=this.getDataType(node,true);var prohib;switch(dataType){case mstr.Enum.Nodes.DATATYPE.INTEGER:case mstr.Enum.Nodes.DATATYPE.UNSIGNED:case mstr.Enum.Nodes.DATATYPE.NUMERIC:case mstr.Enum.Nodes.DATATYPE.DECIMAL:case mstr.Enum.Nodes.DATATYPE.REAL:case mstr.Enum.Nodes.DATATYPE.DOUBLE:case mstr.Enum.Nodes.DATATYPE.FLOAT:case mstr.Enum.Nodes.DATATYPE.BIGDECIMAL:prohib=mstr.Settings.Functions.Prohibited.Numeric;break;case mstr.Enum.Nodes.DATATYPE.CHAR:case mstr.Enum.Nodes.DATATYPE.VARCHAR:case mstr.Enum.Nodes.DATATYPE.LONGVARCHAR:prohib=mstr.Settings.Functions.Prohibited.String;break;case mstr.Enum.Nodes.DATATYPE.DATE:case mstr.Enum.Nodes.DATATYPE.TIME:case mstr.Enum.Nodes.DATATYPE.TIMESTAMP:prohib=mstr.Settings.Functions.Prohibited.Date;break;}return prohib?mstr.$A.removeItemsByForm(arr,prohib,"dssid"):arr;};QN.getRankNode=function QN_getRankNode(node){if(!node){return null;}var c=node.children;for(var i=0,len=mstr.$A.len(c);i<len;i++){if(mstr.utils.ExprNode.isRankNode(c[i])){return c[i];}}return null;};QN.convertNodeFunctionToMRPFunction=function QN_convertNodeFunctionToMRPFunction(node){if(!node){return{};}var rankNode=this.getRankNode(node);var bRank=!!rankNode;var bPercent=bRank&&this.isRankNodeFunctionPercent(rankNode);var nodeFuncId=node.value&&parseInt(node.value["function"]);var mrpInfo={};mrpInfo[mstr.Props.Nodes.FUNCTIONTYPE]=bRank?(bPercent?mstr.Enum.Nodes.FUNCTIONTYPE.RANKPERCENT:mstr.Enum.Nodes.FUNCTIONTYPE.RANK):mstr.Enum.Nodes.FUNCTIONTYPE.DEFAULT;mrpInfo[mstr.Props.Nodes.MRPFUNCTION]=bRank?this.convertNodeFuncIdToRankFuncId(nodeFuncId,rankNode.value.propertyStr):nodeFuncId;return mrpInfo;};QN.isRankNodeFunctionPercent=function QN_isRNFuncPerc(rankNode){return !!(/pr ix="5" v="0"/.test(rankNode.value.propertyStr));};QN.isRankPercentQual=function QN_isRankPerc(node){if(!node){return false;}var rankNode=this.getRankNode(node);var bRank=!!rankNode;return bRank&&this.isRankNodeFunctionPercent(rankNode);};QN.convertNodeFuncIdToRankFuncId=function QN_convertNFItoRFI(nodeFuncId,propertyStr){var mrpFuncId;switch(nodeFuncId){case mstr.Enum.Nodes.FUNCTION.LESSTHANEQUALS:mrpFuncId=/pr ix="4" v="-1"/.test(propertyStr)?mstr.Enum.Nodes.MRPFUNCTION.BOTTOM:mstr.Enum.Nodes.MRPFUNCTION.TOP;break;case mstr.Enum.Nodes.FUNCTION.GREATERTHAN:mrpFuncId=/pr ix="4" v="-1"/.test(propertyStr)?mstr.Enum.Nodes.MRPFUNCTION.EXCLUDEBOTTOM:mstr.Enum.Nodes.MRPFUNCTION.EXCLUDETOP;break;case mstr.Enum.Nodes.FUNCTION.NOTEQUALS:mrpFuncId=mstr.Enum.Nodes.MRPFUNCTION.DIFFERENTFROM;break;default:mrpFuncId=nodeFuncId;}return mrpFuncId;};QN.convertMRPFunctionToNodeFunction=function QN_convertMRPFunctionToNodeFunction(mrpFuncId,mrpFuncType){var nodeFuncId=mrpFuncId,mrpFuncType=parseInt(mrpFuncType),propertyStr="";if(mrpFuncType==mstr.Enum.Nodes.FUNCTIONTYPE.RANKPERCENT){propertyStr=mstr.Enum.Nodes.PROPERTYSTR.PERCENT;}else{if(mrpFuncType==mstr.Enum.Nodes.FUNCTIONTYPE.RANK){propertyStr=mstr.Enum.Nodes.PROPERTYSTR.NONPERCENT;}}switch(mrpFuncType){case mstr.Enum.Nodes.FUNCTIONTYPE.RANKPERCENT:case mstr.Enum.Nodes.FUNCTIONTYPE.RANK:switch(parseInt(mrpFuncId)){case mstr.Enum.Nodes.MRPFUNCTION.TOP:nodeFuncId=mstr.Enum.Nodes.FUNCTION.LESSTHANEQUALS;propertyStr=mstr.Enum.Nodes.PROPERTYSTR.RANKTOP+propertyStr;break;case mstr.Enum.Nodes.MRPFUNCTION.BOTTOM:nodeFuncId=mstr.Enum.Nodes.FUNCTION.LESSTHANEQUALS;propertyStr=mstr.Enum.Nodes.PROPERTYSTR.RANKBOTTOM+propertyStr;break;case mstr.Enum.Nodes.MRPFUNCTION.EXCLUDETOP:nodeFuncId=mstr.Enum.Nodes.FUNCTION.GREATERTHAN;propertyStr=mstr.Enum.Nodes.PROPERTYSTR.RANKTOP+propertyStr;break;case mstr.Enum.Nodes.MRPFUNCTION.EXCLUDEBOTTOM:nodeFuncId=mstr.Enum.Nodes.FUNCTION.GREATERTHAN;propertyStr=mstr.Enum.Nodes.PROPERTYSTR.RANKBOTTOM+propertyStr;break;case mstr.Enum.Nodes.MRPFUNCTION.DIFFERENTFROM:nodeFuncId=mstr.Enum.Nodes.FUNCTION.NOTEQUALS;propertyStr="";break;default:propertyStr="";break;}break;}var info={};info[mstr.Props.Nodes.FUNCTION]=nodeFuncId;info[mstr.Props.Nodes.PROPERTYSTR]=propertyStr;return info;};return QN;})();mstr.utils.ShortcutNode=(function(){var SN={};SN.newNode=function SN_newNode(target){return{value:{nodeType:mstr.Enum.Nodes.NODETYPE.SHORTCUT,expressionType:mstr.Enum.Nodes.EXPRESSIONTYPE.GENERIC,dataType:mstr.Enum.Nodes.DATATYPE.UNKNOWN,nodeDimtyType:mstr.Enum.Nodes.NODEDIMTYTYPE.NONE,target:target}};};SN.getTarget=function SN_getTarget(node){return node&&node.value&&node.value.target;};SN.setTarget=function SN_setTarget(node,target){return mstr.utils.ExprNode.setObjectProp(node,"target",target,"dssid");};return SN;})();mstr.utils.FormShortcutNode=(function(){var FSN={};FSN.newNode=function FSN_newNode(attr,form){return{value:{nodeType:mstr.Enum.Nodes.NODETYPE.FORMSHORTCUT,expressionType:mstr.Enum.Nodes.EXPRESSIONTYPE.GENERIC,dataType:mstr.Enum.Nodes.DATATYPE.UNKNOWN,nodeDimtyType:mstr.Enum.Nodes.NODEDIMTYTYPE.NONE,attribute:attr,form:form}};};FSN.getAttribute=function FSN_getAttribute(node){return node&&node.value&&node.value.attribute;};FSN.setAttribute=function FSN_setAttribute(node,attribute){return mstr.utils.ExprNode.setObjectProp(node,"attribute",attribute,"dssid");};FSN.getForm=function FSN_getForm(node){return node&&node.value&&node.value.form;};FSN.setForm=function FSN_setForm(node,form){return mstr.utils.ExprNode.setObjectProp(node,"form",form,null);};FSN.getFormDataTypes=function FSN_getFormDtps(attr){var forms=attr&&attr.dssforms,len=(forms&&forms.length)||0;if(!len){return null;}var dtps=[];for(var i=0;i<len;i++){dtps.push(forms[i].dtp);}return dtps;};return FSN;})();mstr.utils.ElementsObjectNode=(function(){var EON={};EON.newNode=function EON_newNode(attr,elems,treeId){return{value:{nodeType:mstr.Enum.Nodes.NODETYPE.ELEMENTSOBJECT,expressionType:mstr.Enum.Nodes.EXPRESSIONTYPE.GENERIC,dataType:mstr.Enum.Nodes.DATATYPE.UNKNOWN,nodeDimtyType:mstr.Enum.Nodes.NODEDIMTYTYPE.NONE,source:attr,elementsCollection:elems||[]},treeId:treeId};};EON.getSource=function EON_getSource(node){return node&&node.parent&&mstr.utils.QualNode.getTarget(node.parent);};EON.getElements=function EON_getElements(node){return node&&node.value&&node.value.elementsCollection;};EON.setElements=function EON_setElements(node,arr){mstr.utils.ExprNode.setScalarProp(node,"elementsCollection",arr);return true;};return EON;})();mstr.xml={};mstr.xml.Node=(function(){Node.prototype.addChild=function Node_addChild(nodeName){var child=new mstr.xml.Node(nodeName);return this.appendNode(child);};Node.prototype.appendNode=function Node_appendNode(node){if(node){if(!this.children){this.children=[];}this.children.push(node);}return node;};Node.prototype.addAttribute=function Node_addAttribute(name,value){if(name!=null){if(!this.attributes){this.attributes={};}this.attributes[name]=value;}return this;};Node.prototype.addText=function Node_addText(text){this._addToStringMember("text",text);return this;};Node.prototype.addRawXML=function Node_addRawXML(xml){this._addToStringMember("rawXML",xml);return this;};Node.prototype.buildXMLString=function Node_buildXMLString(){return"<"+this.nodeName+" "+this._buildAttributesXMLString()+">"+((this.text!=null)?this._escapeString(this.text):"")+((this.rawXML!=null)?this.rawXML:"")+this._buildChildrenXMLString()+"</"+this.nodeName+">";};Node.prototype._buildAttributesXMLString=function Node_buildAttributesXMLString(){var attrs=this.attributes;if(attrs){var arr=[];for(var id in attrs){if(attrs[id]!=null){var v=String(attrs[id]);switch(id){case"et":case"nt":case"dmt":case"ddt":case"fnt":case"tp":case"stp":break;default:v=this._escapeString(v);}arr.push(id+'="'+v+'"');}}return arr.join(" ");}return"";};Node.prototype._escapeString=function Node_escapeString(v){return mstr.utils.String.escape4HTMLText(v);};Node.prototype._buildChildrenXMLString=function Node_buildChildrenXMLString(){var c=this.children;var len=c&&c.length;if(len){var arr=[];for(var i=0;i<len;i++){var s=c[i]&&c[i].buildXMLString&&c[i].buildXMLString();if(s!=null){arr.push(s);}}return arr.join("");}return"";};Node.prototype._addToStringMember=function Node_addToStringMember(memberName,str){var val=this[memberName];if(val==null){this[memberName]=str;}else{this[memberName]=val+str;}};function Node(nodeName){this.nodeName=nodeName;}return Node;})();mstr.xml.Builder=(function(){Builder.buildResolution=function Builder_buildResolution(exprPromptAnswerDef,exprRootNode,exprModelType,bNullRootIsEmpty){var xmlNode=new mstr.xml.Node("rsl");if(xmlNode){xmlNode.addAttribute("lcl",mstr.Settings.Locale.ID);xmlNode.appendNode(this.buildAnswer(exprPromptAnswerDef,exprRootNode,exprModelType,bNullRootIsEmpty));}return xmlNode;};Builder.buildAnswer=function Builder_buildAnswer(answerDef,exprRootNode,exprModelType,bNullRootIsEmpty){var xmlNode=new mstr.xml.Node("pa");var eps=answerDef&&answerDef.get("extendedProperties");if(xmlNode&&eps){if(eps[mstr.Props.Answer.PRIMELOCKEY]!=null){xmlNode.addAttribute("key",eps[mstr.Props.Answer.PRIMELOCKEY]);}else{xmlNode.addAttribute("pt",eps[mstr.Props.Answer.PROMPTTYPE]).addAttribute("pin",eps[mstr.Props.Answer.PRIMELOCPIN]).addAttribute("did",eps[mstr.Props.Answer.PRIMELOCID]).addAttribute("tp",eps[mstr.Props.Answer.PRIMELOCTYPE]);}if(!exprRootNode){if(!bNullRootIsEmpty){var em=answerDef.getSelected();exprRootNode=em&&em.get("rootNode");}}xmlNode.appendNode(this.buildExpression(exprRootNode,exprModelType));}return xmlNode;};Builder.buildExpression=function Builder_buildExpression(rootExprNode,exprModelType){var xmlNode=new mstr.xml.Node("exp");if(rootExprNode){xmlNode&&xmlNode.appendNode(this.buildExprNode(rootExprNode,exprModelType));}return xmlNode;};Builder.buildExprNode=function Builder_buildExprNode(exprNode,exprModelType){var xmlNode=this.buildCommonXML(exprNode);if(xmlNode){xmlNode.appendNode(this.buildDimtyNode(exprNode));this.buildExprNodeChildren(exprNode,xmlNode,exprModelType);var nodes=this.buildTypeSpecificXML(exprNode);if(typeof (nodes)=="string"){xmlNode.addText(nodes);}else{nodes=mstr.$A.toArray(nodes);for(var i=0,len=mstr.$A.len(nodes);i<len;i++){xmlNode.appendNode(nodes[i]);}}}return xmlNode;};Builder.buildExprNodeChildren=function Builder_buildExprNodeChildren(exprNode,xmlNode,exprModelType){if(!exprNode||!xmlNode){return ;}var c=exprNode.children;if(mstr.utils.QualNode.isINQual(exprNode)){c=this.splitINChildren(exprNode,exprModelType);}for(var i=0,len=mstr.$A.len(c);i<len;i++){xmlNode.appendNode(this.buildExprNode(c[i]));}};Builder.splitINChildren=function Builder_splitINChildren(exprNode,exprModelType){var c=exprNode&&exprNode.children;if(!c){return null;}var nodeTypes={};nodeTypes[mstr.Enum.Nodes.NODETYPE.CONSTANT]=true;nodeTypes[mstr.Enum.Nodes.NODETYPE.BIGDECIMAL]=true;nodeTypes[mstr.Enum.Nodes.NODETYPE.TIME]=true;var constInfo=mstr.utils.QualNode._getChildNodeByType(exprNode,nodeTypes,1);if(constInfo&&constInfo.node){var constVal=mstr.utils.ConstNode.getValue(constInfo.node),arr=mstr.utils.QualNode.constValue2Array(constVal,true,exprModelType),hasDelim=(arr&&arr.length>1);if(hasDelim){var clones=[];var clone,v;for(var j=0,lenVals=arr.length;j<lenVals;j++){v=arr[j];if(v==null||v==""){continue;}clone=mstr.utils.ExprNode.clone(constInfo.node);mstr.utils.ConstNode.setValue(clone,v);clones.push(clone);}c=[].concat(c);c.splice(constInfo.childIndex,1);c=mstr.$A.insert(c,clones,constInfo.childIndex);}}return c;};Builder.buildTypeSpecificXML=function Builder_buildTypeSpecificXML(exprNode){switch(parseInt(exprNode&&exprNode.value&&exprNode.value[mstr.Props.Nodes.NODETYPE])){case mstr.Enum.Nodes.NODETYPE.NODEOPERATOR:return this.buildOperatorNode(exprNode);case mstr.Enum.Nodes.NODETYPE.SHORTCUT:return this.buildShortcutNode(exprNode);case mstr.Enum.Nodes.NODETYPE.FORMSHORTCUT:return this.buildFormShortcutNode(exprNode);case mstr.Enum.Nodes.NODETYPE.ELEMENTSOBJECT:return this.buildElementsObjectNode(exprNode);case mstr.Enum.Nodes.NODETYPE.CONSTANT:case mstr.Enum.Nodes.NODETYPE.TIME:case mstr.Enum.Nodes.NODETYPE.BIGDECIMAL:return this.buildConstantNode(exprNode);default:break;}};Builder.buildCommonXML=function Builder_buildCommonXML(exprNode){var xmlNode;var nv=exprNode&&exprNode.value;if(nv){var et=nv.expressionType;if(et==mstr.Enum.Nodes.EXPRESSIONTYPE.SINGLEBASEFORMQUAL){if(nv["function"]==mstr.Enum.Nodes.FUNCTION.IN||nv["function"]==mstr.Enum.Nodes.FUNCTION.NOTIN){et=mstr.Enum.Nodes.EXPRESSIONTYPE.LISTFORMQUAL;}}var nt=nv[mstr.Props.Nodes.NODETYPE];if(nt==mstr.Enum.Nodes.NODETYPE.CONSTANT){switch(nv[mstr.Props.Nodes.DATATYPE]){case mstr.Enum.Nodes.DATATYPE.DATE:case mstr.Enum.Nodes.DATATYPE.TIME:case mstr.Enum.Nodes.DATATYPE.TIMESTAMP:nt=mstr.Enum.Nodes.NODETYPE.TIME;break;case mstr.Enum.Nodes.DATATYPE.BIGDECIMAL:nt=mstr.Enum.Nodes.NODETYPE.BIGDECIMAL;break;}}xmlNode=new mstr.xml.Node("nd").addAttribute("et",et).addAttribute("nt",nt).addAttribute("dmt",nv[mstr.Props.Nodes.NODEDIMTYTYPE]).addAttribute("ddt",nv[mstr.Props.Nodes.DATATYPE]).addAttribute("disp_n",nv[mstr.Props.Nodes.DISPLAYNAME]);}return xmlNode;};Builder.buildDimtyNode=function Builder_buildDimtyNode(exprNode){var dimtyObj=exprNode&&exprNode.value&&exprNode.value[mstr.Props.Nodes.DIMTYOBJECT];if(dimtyObj){var xmlNode=new mstr.xml.Node("dmy").addAttribute("cct",dimtyObj[mstr.Props.DimtyObject.CANCONTINUE]?1:0).addAttribute("fr",dimtyObj[mstr.Props.DimtyObject.FILTERREST]?1:0);var units=dimtyObj[mstr.Props.DimtyObject.UNITS];for(var i=0,len=mstr.$A.len(units);i<len;i++){xmlNode.appendNode(this.buildDimtyUnitNode(units[i]));}return xmlNode;}};Builder.buildDimtyUnitNode=function Builder_buildDimtyUnitNode(dimtyUnit){if(!dimtyUnit){return null;}var unitType=dimtyUnit[mstr.Props.DimtyUnit.UNITTYPE];var xmlNode=new mstr.xml.Node("du");xmlNode.addAttribute("agg",dimtyUnit[mstr.Props.DimtyUnit.AGGREGATION]).addAttribute("flt",dimtyUnit[mstr.Props.DimtyUnit.FILTERING]).addAttribute("gb",dimtyUnit[mstr.Props.DimtyUnit.GROUPBY]).addAttribute("rps",dimtyUnit[mstr.Props.DimtyUnit.RELATIVEPOSITION]).addAttribute("ut",unitType);if((unitType!=mstr.Enum.DimtyUnit.UNITTYPE.ATTRIBUTE)&&(unitType!=mstr.Enum.DimtyUnit.UNITTYPE.DIMENSION)){xmlNode.addAttribute("disp_n",dimtyUnit[mstr.Props.DimtyUnit.DISPLAYNAME]);}if((unitType==mstr.Enum.DimtyUnit.UNITTYPE.ATTRIBUTE)||(unitType==mstr.Enum.DimtyUnit.UNITTYPE.DIMENSION)){xmlNode.appendNode(this.buildObjectInfo(dimtyUnit[mstr.Props.DimtyUnit.TARGET]));}return xmlNode;};Builder.buildConstantNode=function Builder_buildConstantNode(exprNode){var nv=exprNode&&exprNode.value;if(nv!=null){var dataType=mstr.utils.ConstNode.getDataType(exprNode);switch(dataType){case mstr.Enum.Nodes.DATATYPE.DATE:case mstr.Enum.Nodes.DATATYPE.TIME:case mstr.Enum.Nodes.DATATYPE.TIMESTAMP:case mstr.Enum.Nodes.DATATYPE.BIGDECIMAL:return nv[mstr.Props.Nodes.CONSTANTVALUE];break;default:return new mstr.xml.Node("cst").addAttribute("ddt",nv[mstr.Props.Nodes.CONSTANTDATATYPE]).addText(nv[mstr.Props.Nodes.CONSTANTVALUE]);}}};Builder.buildShortcutNode=function Builder_buildShortcutNode(exprNode){var target=mstr.utils.ShortcutNode.getTarget(exprNode);if(target!=null){return this.buildObjectInfo(target);}return null;};Builder.buildFormShortcutNode=function Builder_buildFormShortcutNode(exprNode){return[this.buildObjectInfo(mstr.utils.FormShortcutNode.getAttribute(exprNode)),this.buildObjectInfo(mstr.utils.FormShortcutNode.getForm(exprNode))];};Builder.buildElementsObjectNode=function Builder_buildElementsObjectNode(exprNode){if(exprNode){var xmlNode=new mstr.xml.Node("mi");var esNode=xmlNode.addChild("es");esNode.appendNode(this.buildObjectInfo(mstr.utils.ElementsObjectNode.getSource(exprNode)));var elems=mstr.utils.ElementsObjectNode.getElements(exprNode);var len=elems&&elems.length;for(var i=0;i<len;i++){esNode.addChild("e").addAttribute("ei",elems[i][mstr.Props.MSTRElement.DSSID]).addAttribute("emt",elems[i][mstr.Props.MSTRElement.TYPE]).addAttribute("art",elems[i][mstr.Props.MSTRElement.ARITY]).addAttribute("disp_id",elems[i][mstr.Props.MSTRElement.DISPLAYID]).addAttribute("disp_n",elems[i][mstr.Props.MSTRFolderItem.NAME]);}return xmlNode;}return null;};Builder.buildOperatorNode=function Builder_buildOperatorNode(exprNode){var nv=exprNode&&exprNode.value;if(nv){var xmlNode=new mstr.xml.Node("op").addAttribute("fnt",nv[mstr.Props.Nodes.FUNCTION]);var str=nv[mstr.Props.Nodes.PROPERTYSTR];if((str!=null)&&str.length){return[xmlNode,new mstr.xml.Node("prs").addRawXML(str)];}else{return xmlNode;}}return null;};Builder.buildObjectInfo=function Builder_buildObjectInfo(obj){var nodeName=this.getObjectNodeName(obj);if(nodeName&&obj){return new mstr.xml.Node(nodeName).addAttribute("did",obj.dssid).addAttribute("tp",obj.tp).addAttribute("stp",obj.stp).addAttribute("n",obj.n).addAttribute("disp_n",obj[mstr.Props.MSTRFolderItem.DISPLAYNAME]||obj.n);}return null;};Builder.getObjectNodeName=function Builder_getObjectNodeName(obj){var nodeName;var tp=obj&&parseInt(obj.tp);if(!isNaN(tp)){nodeName=Builder.OBJNODENAME[tp];}if(nodeName==null){nodeName=Builder.OBJNODENAME._DEFAULT_;}return nodeName;};Builder.OBJNODENAME={};Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.FILTER]="f";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.TEMPLATE]="tm";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.REPORTDEFINITION]="rd";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.METRIC]="mt";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.AGGMETRIC]="amt";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.PROMPT]="p";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTE]="at";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.FACT]="fc";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.DIMENSION]="dm";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.ATTRIBUTEFORM]="fm";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.CONSOLIDATION]="con";Builder.OBJNODENAME[mstr.Enum.MSTRFolderItem.TYPE.CONSOLIDATIONELEMENT]="ce";Builder.OBJNODENAME._DEFAULT_="resv";function Builder(){}return Builder;})();