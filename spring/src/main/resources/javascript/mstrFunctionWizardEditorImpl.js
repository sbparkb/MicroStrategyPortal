mstrFunctionWizardEditorImplScript=true;mstrFunctionWizardEditorImpl.prototype=new mstrEditorImpl();mstrFunctionWizardEditorImpl.prototype.step=1;mstrFunctionWizardEditorImpl.prototype.argObj=null;mstrFunctionWizardEditorImpl.prototype.CATEGORY_PULLDOWN_ID="";mstrFunctionWizardEditorImpl.prototype.FUNCTIONS_LISTBOX_ID="";mstrFunctionWizardEditorImpl.STEP_ONE_FUNCTION_SYNTAX="fe1_functionSyntax";mstrFunctionWizardEditorImpl.STEP_ONE_FUNCTION_DESC="fe1_functionDes";mstrFunctionWizardEditorImpl.STEP_TWO_ARG_DESC="fe2_argumentDescription";mstrFunctionWizardEditorImpl.STEP_TWO_ARG_NAME="fe2_argumentName";mstrFunctionWizardEditorImpl.STEP_TWO_FUNCTION_FORMULA="fe2_fmlaResult";mstrFunctionWizardEditorImpl.STEP_TWO_SORTBY_RADIO="fe2_sort";mstrFunctionWizardEditorImpl.STEP_TWO_SORTBY_SELECT="sortby";mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST="ValueList";mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST_SORT_OPTION="SortValueList";mstrFunctionWizardEditorImpl.prototype.selectedCategoryIndex=null;mstrFunctionWizardEditorImpl.prototype.selectedFunctionIndex=null;mstrFunctionWizardEditorImpl.prototype.categoryFuncs=null;mstrFunctionWizardEditorImpl.prototype.functionExpression="";mstrFunctionWizardEditorImpl.prototype.curFunctionName="";mstrFunctionWizardEditorImpl.prototype.breakbyExp="";mstrFunctionWizardEditorImpl.prototype.sortbyExp="";mstrFunctionWizardEditorImpl.prototype.paramExp=null;mstrFunctionWizardEditorImpl.prototype.propExp=null;mstrFunctionWizardEditorImpl.prototype.orderedParamNames=null;mstrFunctionWizardEditorImpl.prototype.sortedFunctions=null;mstrFunctionWizardEditorImpl.INPUT_TYPE_BREAKBY=1;mstrFunctionWizardEditorImpl.INPUT_TYPE_SORTBY=2;mstrFunctionWizardEditorImpl.INPUT_TYPE_PROP=3;mstrFunctionWizardEditorImpl.INPUT_TYPE_PARAM=4;mstrFunctionWizardEditorImpl.prototype.divStepOne=null;mstrFunctionWizardEditorImpl.prototype.divStepTwo=null;mstrFunctionWizardEditorImpl.prototype.formulaMode=null;mstrFunctionWizardEditorImpl.prototype.activeViewID=null;mstrFunctionWizardEditorImpl.prototype.activeDatasetID=null;mstrFunctionWizardEditorImpl.prototype.localeId=null;mstrFunctionWizardEditorImpl.prototype.listSeparator=",";mstrFunctionWizardEditorImpl.prototype.onload=function(){try{this.divStepOne=document.getElementById("step1");this.divStepTwo=document.getElementById("step2");this.initializing=true;this.path="microstrategy.bone('"+this.id+"')";this.verifiedPath=microstrategy.getEventHandlerString(this.path);this.initEditor();this.initSettings();this.initializing=false;this.dblClick=document.getElementById("fe1_functions");if(this.dblClick){this.dblClick.ondblclick=new Function("return microstrategy.bone('"+this.id+"').okChanges();");}}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.closeEditor=function(){if(this.step==1){mstrEditorImpl.prototype.closeEditor.call(this);}else{this.initStepOne();this.step=1;}};mstrFunctionWizardEditorImpl.prototype.initSettings=function(){try{this.initStepOne();if(this.step==2){this.initStepTwo();}}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.initStepOne=function(){try{this.settings=new Object();var categoryPulldown=document.getElementById(this.CATEGORY_PULLDOWN_ID);if(categoryPulldown){categoryPulldown.onchange=new Function("e",this.verifiedPath+" { return "+this.path+".onchangeCategoryDropDown(e); }");this.settings[this.CATEGORY_PULLDOWN_ID]=categoryPulldown;}var functionsListBox=document.getElementById(this.FUNCTIONS_LISTBOX_ID);if(functionsListBox){functionsListBox.onchange=new Function("e",this.verifiedPath+" { return "+this.path+".onchangeFunctionListBox(e); }");this.settings[this.FUNCTIONS_LISTBOX_ID]=functionsListBox;}this.settings[mstrFunctionWizardEditorImpl.STEP_ONE_FUNCTION_SYNTAX]=document.getElementById(mstrFunctionWizardEditorImpl.STEP_ONE_FUNCTION_SYNTAX);this.settings[mstrFunctionWizardEditorImpl.STEP_ONE_FUNCTION_DESC]=document.getElementById(mstrFunctionWizardEditorImpl.STEP_ONE_FUNCTION_DESC);if(this.selectedCategoryIndex!=null){this.settings[this.CATEGORY_PULLDOWN_ID].options[this.selectedCategoryIndex].selected=true;}else{this.settings[this.CATEGORY_PULLDOWN_ID].options[0].selected=true;}this.onchangeCategoryDropDown();this.divStepOne.style.display="block";this.divStepTwo.style.display="none";this.listSeparator=mstr.Settings.Locale.LISTSEP;}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.initStepTwo=function(){try{this.settings=new Object();this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_ARG_NAME]=document.getElementById(mstrFunctionWizardEditorImpl.STEP_TWO_ARG_NAME);this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_ARG_DESC]=document.getElementById(mstrFunctionWizardEditorImpl.STEP_TWO_ARG_DESC);this.initParamExp();this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_FUNCTION_FORMULA]=document.getElementById(mstrFunctionWizardEditorImpl.STEP_TWO_FUNCTION_FORMULA);var allInputs=this.elem.getElementsByTagName("input");var allPulldowns=this.elem.getElementsByTagName("select");for(var i=0;allPulldowns&&i<allPulldowns.length;i++){allPulldowns[i].onclick=new Function("e",this.verifiedPath+" { return "+this.path+".onfocusArgs(e); }");allPulldowns[i].onchange=new Function("e",this.verifiedPath+" { return "+this.path+".onchangeArgsPulldown(e); }");if(allPulldowns[i].getAttribute("id")=="sortby"){this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_SORTBY_SELECT]=document.getElementById(mstrFunctionWizardEditorImpl.STEP_TWO_SORTBY_SELECT);if(this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST]){var valueListIndex=this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST].selectedIndex;this.changeSortOption(this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST].options[valueListIndex]);}}if(allPulldowns[i].name==mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST){this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST]=allPulldowns[i];}var selectedIdx=allPulldowns[i].selectedIndex;if(selectedIdx>=0){this.buildPreviewFormula(allPulldowns[i],(allPulldowns[i].options[selectedIdx]).value);}}for(var i=0;allInputs&&i<allInputs.length;i++){allInputs[i].onfocus=new Function("e",this.verifiedPath+" { return "+this.path+".onfocusArgs(e); }");allInputs[i].onchange=new Function("e",this.verifiedPath+" { return "+this.path+".onchangeArgs(e); }");if(allInputs[i].type=="radio"){allInputs[i].onchange=new Function("e",this.verifiedPath+" { return "+this.path+".onchangeArgs(e); }");continue;}this.buildPreviewFormula(allInputs[i],allInputs[i].value);}this.repaintPreviewFormula();this.divStepOne.style.display="none";this.divStepTwo.style.display="block";}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.initParamExp=function(){try{if(this.orderedParamNames!=null&&this.orderedParamNames.length>0){this.paramExp=new Object();for(var i=0;i<this.orderedParamNames.length;i++){this.paramExp[this.orderedParamNames[i]]="";}}}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.onchangeCategoryDropDown=function(e){try{if(!this.categoryFuncs){return ;}var categoryIndex=this.settings[this.CATEGORY_PULLDOWN_ID].selectedIndex;var selectedCategoryName=(this.settings[this.CATEGORY_PULLDOWN_ID].options[categoryIndex]).value;while(this.settings[this.FUNCTIONS_LISTBOX_ID].options&&this.settings[this.FUNCTIONS_LISTBOX_ID].options.length>0){this.settings[this.FUNCTIONS_LISTBOX_ID].removeChild(this.settings[this.FUNCTIONS_LISTBOX_ID].options[0]);}if(selectedCategoryName&&selectedCategoryName.length>0){var allFunctions=this.categoryFuncs[selectedCategoryName];var sortedFunctionNameArray=this.getSortedFunctionNameArray(selectedCategoryName);for(var i=0;i<sortedFunctionNameArray.length;i++){var tOption=document.createElement("option");tOption.text=sortedFunctionNameArray[i];tOption.value=this.categoryFuncs[selectedCategoryName][sortedFunctionNameArray[i]].funcId;this.settings[this.FUNCTIONS_LISTBOX_ID].options.add(tOption);}if(this.step==2&&this.selectedFunctionIndex!=null){this.settings[this.FUNCTIONS_LISTBOX_ID].options[this.selectedFunctionIndex].selected=true;this.onchangeFunctionListBox(e);}else{if(this.settings[this.FUNCTIONS_LISTBOX_ID].options[0]){this.settings[this.FUNCTIONS_LISTBOX_ID].options[0].selected=true;this.onchangeFunctionListBox(e);}}}}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.onchangeFunctionListBox=function(e){try{if(!this.categoryFuncs){return ;}var functionIndex=this.settings[this.FUNCTIONS_LISTBOX_ID].selectedIndex;var selectedFunctionName=(this.settings[this.FUNCTIONS_LISTBOX_ID].options[functionIndex]).text;var categoryIndex=this.settings[this.CATEGORY_PULLDOWN_ID].selectedIndex;var selectedCategoryName=(this.settings[this.CATEGORY_PULLDOWN_ID].options[categoryIndex]).value;if(selectedFunctionName&&selectedFunctionName.length>0){var selectedfunction=this.categoryFuncs[selectedCategoryName][selectedFunctionName];if(selectedfunction){var syntax=encode(selectedfunction.funcSyntax,false);this.settings[mstrFunctionWizardEditorImpl.STEP_ONE_FUNCTION_SYNTAX].innerHTML=this.toLocaleString(syntax);this.settings[mstrFunctionWizardEditorImpl.STEP_ONE_FUNCTION_DESC].innerHTML=selectedfunction.funcDesc;}}try{this.settings[this.FUNCTIONS_LISTBOX_ID].focus();}catch(err){}return true;}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.onfocusArgs=function(e){try{if(!e){e=window.event;}var target=getEventTarget(e);if(target==null){return true;}var inputName="";var targetNodeName=target.nodeName.toLowerCase();switch(targetNodeName){case"option":inputName=target.parentNode.getAttribute("name");break;case"select":case"input":inputName=target.getAttribute("name");break;}var desc=this.argObj[inputName];if(desc!=null&&typeof (desc)!="undefined"){this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_ARG_NAME].innerHTML=inputName;this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_ARG_DESC].innerHTML=desc;}return true;}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.repaintPreviewFormula=function(){try{var text=encode(this.functionExpression,false);text=text.replace(/&nbsp;/gi," ");this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_FUNCTION_FORMULA].innerHTML=text;}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.onchangeArgsPulldown=function(e){try{if(!e){e=window.event;}var target=getEventTarget(e);if(target==null){return true;}var nodeType=target.nodeName.toLowerCase();var selectTag=null;if(nodeType=="option"){selectTag=target.parentNode;}else{if(nodeType=="select"){selectTag=target;}}if(selectTag){var selectedValue=(selectTag.options[selectTag.selectedIndex]).value;if(selectTag.name==mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST){this.changeSortOption(selectTag.options[selectTag.selectedIndex]);}this.buildPreviewFormula(selectTag,selectedValue);this.repaintPreviewFormula();}}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.onchangeArgs=function(e){try{if(!e){e=window.event;}var target=getEventTarget(e);if(target==null||target.nodeName.toLowerCase()!="input"){return true;}if(target){if(target.type&&target.type=="radio"){target=this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_SORTBY_SELECT];}var selectedValue=target.value;this.buildPreviewFormula(target,selectedValue);this.repaintPreviewFormula();}}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.getInputType=function(inputTag){try{var _result=-1;var name=inputTag.getAttribute("name");if(name=="breakby"){_result=mstrFunctionWizardEditorImpl.INPUT_TYPE_BREAKBY;}else{if(name=="sortby"){_result=mstrFunctionWizardEditorImpl.INPUT_TYPE_SORTBY;}else{var type=inputTag.getAttribute("type");if(type!=null){if(type=="prop"){_result=mstrFunctionWizardEditorImpl.INPUT_TYPE_PROP;}else{if(type=="param"){_result=mstrFunctionWizardEditorImpl.INPUT_TYPE_PARAM;}}}}}return _result;}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.buildPreviewFormula=function(inputTag,value){try{var type=this.getInputType(inputTag);var name=inputTag.getAttribute("name");switch(type){case mstrFunctionWizardEditorImpl.INPUT_TYPE_BREAKBY:this.breakbyExp=value;break;case mstrFunctionWizardEditorImpl.INPUT_TYPE_SORTBY:this.sortbyExp=value;var sortBtns=document.getElementsByName(mstrFunctionWizardEditorImpl.STEP_TWO_SORTBY_RADIO);for(var i=0;i<sortBtns.length;i++){if(sortBtns[i].checked){var rValue=sortBtns[i].value;if(rValue!=null){this.sortbyExp+=rValue;}}}break;case mstrFunctionWizardEditorImpl.INPUT_TYPE_PARAM:this.paramExp[name]=value;break;case mstrFunctionWizardEditorImpl.INPUT_TYPE_PROP:this.propExp[name]=value;break;}this.functionExpression=this.getFormula();}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.getFormula=function(){try{var propString="";for(var i in this.propExp){if(this.propExp[i]!=null&&this.propExp[i].length>0){propString+=i+" = "+this.propExp[i]+", ";}}var paramString="";for(var i=0;this.paramExp!=null&&this.orderedParamNames!=null&&i<this.orderedParamNames.length;i++){var paramValue=this.paramExp[this.orderedParamNames[i]];if(paramValue!=null&&paramValue!=""){paramString+=paramValue+this.listSeparator+" ";}}if(paramString.length>0&&paramString.indexOf(this.listSeparator)>0){paramString=paramString.substr(0,paramString.length-2);}var result=this.curFunctionName;if(propString.length>0||this.breakbyExp.length>0||this.sortbyExp.length>0){result+="<"+propString;if(this.breakbyExp.length>0){result+="BreakBy = {"+this.breakbyExp+"}, ";}if(this.sortbyExp.length>0){result+="SortBy = ("+this.sortbyExp+"), ";}if(result.indexOf(",")>0){result=result.substr(0,result.length-2);}result+=">";}result+="("+paramString+")";return result;}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.okChanges=function(){try{if(this.targetBoneId){var tb=microstrategy.bones[this.targetBoneId];if(tb&&tb.handleFunctionWizardSelect){var select=this.settings[this.FUNCTIONS_LISTBOX_ID],func=select.options[select.selectedIndex];tb.handleFunctionWizardSelect({id:func.value,n:func.text});mstrEditorImpl.prototype.closeEditor.call(this);}return ;}if(this.step==1){var evtArg="activeViewID="+this.activeViewID;evtArg+="&activeDatasetID="+this.activeDatasetID;evtArg+="&formulaMode="+this.formulaMode;evtArg+="&selectedFunctionId="+(this.settings[this.FUNCTIONS_LISTBOX_ID].options[this.settings[this.FUNCTIONS_LISTBOX_ID].selectedIndex]).value;evtArg+="&selectedCategoryIndex="+this.settings[this.CATEGORY_PULLDOWN_ID].selectedIndex;evtArg+="&selectedFunctionIndex="+this.settings[this.FUNCTIONS_LISTBOX_ID].selectedIndex;toggleShowBean("functionWizard",true,evtArg);}else{if(this.step==2){if(mstrEditorImpl.validateInputs(this.elem,true)){var formula=this.getFormula();var formulaTextField=getObj("fbFormula");if(formulaTextField!=null){formulaTextField.focus();if(document.selection&&document.selection.createRange){var sel=document.selection.createRange();sel.text=formula;}else{formulaTextField.value+=formula;}}else{var docViewerBone=microstrategy.bone("rwb_viewer");if(docViewerBone!=null&&docViewerBone.commands!=null){var activeField=docViewerBone.commands.queryState("selectedTextField");if(activeField!=null){docViewerBone.doc.appendToTextField("{"+formula+"}",activeField);}}}mstrEditorImpl.prototype.closeEditor.call(this);}}}}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.getSortedFunctionNameArray=function(categoryName){try{if(this.sortedFunctions[categoryName]!=null){return this.sortedFunctions[categoryName];}if(this.sortedFunctions==""){this.sortedFunctions=new Object();}this.sortedFunctions[categoryName]=new Array();var allFunctions=this.categoryFuncs[categoryName];for(var i in allFunctions){this.sortedFunctions[categoryName].push(i);}this.sortedFunctions[categoryName]=this.sortedFunctions[categoryName].sort();return this.sortedFunctions[categoryName];}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.changeSortOption=function(valueListOption){try{if(this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_SORTBY_SELECT]==null){return ;}if(this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST_SORT_OPTION]==null){var sortValueOption=document.createElement("option");this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_SORTBY_SELECT].options.add(sortValueOption);this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST_SORT_OPTION]=sortValueOption;}this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST_SORT_OPTION].value=valueListOption.value;this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST_SORT_OPTION].text="Value ("+valueListOption.text+")";this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_VALUE_LIST_SORT_OPTION].selected=true;this.buildPreviewFormula(this.settings[mstrFunctionWizardEditorImpl.STEP_TWO_SORTBY_SELECT],valueListOption.value);}catch(err){microstrategy.errors.log(err);return false;}};mstrFunctionWizardEditorImpl.prototype.toLocaleString=function(text){var idx=text.indexOf("(");if(idx>=0){var propStr=text.substr(0,idx);var paramStr=text.substr(idx,text.length-1);text=propStr+paramStr.replace(/,/g,this.listSeparator);}return text;};function mstrFunctionWizardEditorImpl(id){this.inherits=mstrEditorImpl;this.inherits(id);delete this.inherits;return this;}