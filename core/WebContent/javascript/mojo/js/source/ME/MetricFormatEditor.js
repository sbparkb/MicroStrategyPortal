(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.fx","mstrmojo.Box","mstrmojo.Editor","mstrmojo.Button","mstrmojo._FormatDefinition","mstrmojo.TabListContainer","mstrmojo.TabNameList","mstrmojo.StackContainer","mstrmojo.FontFormatter","mstrmojo.NumberFormatter","mstrmojo.AlignmentFormatter","mstrmojo.PaddingFormatter","mstrmojo.FillFormatter","mstrmojo.BorderFormatter");var _A=mstrmojo.array,_H=mstrmojo.hash,_FD=mstrmojo._FormatDefinition,_B=mstrmojo.Button,MAP=_FD.MetricFormatTarget;var btnClr="#999",btnCls="mstrmojo-Editor-button mstrButton",DEF_FORMAT=_H.clone(_FD.DefaultFormat);DEF_FORMAT.FormattingPatternsChart={FillColor:"16777215",FillStyle:"0",GradientColor:"16777215",GradientAngle:"0",GradientXOffset:"0",GradientYOffset:"0"};DEF_FORMAT.FormattingPatterns=_H.clone(DEF_FORMAT.FormattingPatternsChart);var nmPnl={n:mstrmojo.desc(3434,"Number"),scriptClass:"mstrmojo.NumberFormatter",visible:false,pr:"FormattingNumber"},algnPnl={n:mstrmojo.desc(3435),scriptClass:"mstrmojo.Box",visible:false,pr:["FormattingAlignment","FormattingPadding"],cssClass:"alignmentPanel",children:[{scriptClass:"mstrmojo.AlignmentFormatter",bindings:{model:"this.parent.FormattingAlignment"}},{scriptClass:"mstrmojo.PaddingFormatter",bindings:{model:"this.parent.FormattingPadding"}}]},fntPnl={n:mstrmojo.desc(3433,"Font"),scriptClass:"mstrmojo.FontFormatter",visible:false,pr:"FormattingFont",cssClass:"mstrmojo-FormatEditor-fontTable",cellPadding:5},brdrPnl={n:mstrmojo.desc(2886,"Borders"),scriptClass:"mstrmojo.BorderFormatter",visible:false,pr:"FormattingBorder"},bgPnl={n:mstrmojo.desc(3905,"Background"),scriptClass:"mstrmojo.FillFormatter",visible:false,pr:"FormattingPatterns"},chtPnl={n:mstrmojo.desc(3479,"Graph"),scriptClass:"mstrmojo.FillFormatter",visible:false,isChart:true,pr:"FormattingPatternsChart"};mstrmojo.ME.MetricFormatEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.ME.MetricFormatEditor",cssClass:"mstrmojo-FormatEditor",title:mstrmojo.desc(2116,"Format"),model:null,obModel:null,_initModel:function(){if(!this.model){this.model={};for(var i=0;i<MAP.length;i++){this.model[MAP[i].p]={};}}if(!this.obModel){this.obModel=new mstrmojo.Model({onlevelNameChange:function(evt){var was=evt.valueWas;if(was){this._updateModel(was);}this._setCurrentFormat();},onmodelChange:function(){return this.model?this._setCurrentFormat():false;},_updateModel:function(ln){var cf=_H.copy(this.currentFormat),ln=ln||this.levelName,mf=this.model[ln];if(!mf){mf=this.model[ln]={};}_FD.extractModel(cf,mf,DEF_FORMAT);this.model.set(ln,mf);},_setCurrentFormat:function(){var cf=this.model?_H.copy(this.model[this.levelName||MAP[0].p]):{};cf=_FD.getStandardFormat(cf,DEF_FORMAT);this.set("currentFormat",cf);}});}},init:function(props){this._initModel();this._super(props);},onmodelChange:function(){this._initModel();var fem=this.obModel,tm=_H.clone(this.model)||{};if(tm){var cht={};if(tm&&tm[MAP[0].p]){var ptns=tm[MAP[0].p].FormattingPatterns;if(ptns){for(pr in ptns){if(pr.match(/^Series\w+/gi)){cht[pr.substring(6,pr.length)]=ptns[pr];}}}tm[MAP[0].p].FormattingPatternsChart=cht;}}if(tm&&!tm.attachEventListener){_H.make(tm,mstrmojo.Obj);}fem.set("model",tm);fem.set("levelName",fem.levelName||MAP[0].p);},promptOnClearFormatRef:{scriptClass:"mstrmojo.Editor",cssText:"width:350px;",title:"",showTitle:false,children:[{scriptClass:"mstrmojo.Label",cssText:"margin:5px 5px 20px;",bindings:{text:function(){return mstrmojo.desc(9564,"Clear all formatting?");}}},{scriptClass:"mstrmojo.HBox",cssText:"float:right; margin-bottom:5px;",alias:"buttonBar",slot:"buttonNode",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(1442,"Ok"),onclick:function(){var me=this.parent.parent;me.opener.onClearFormat();me.close();}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var me=this.parent.parent;me.close();}}]}]},prompt2ClearFormat:function(){this.openPopup("promptOnClearFormatRef",{zIndex:this.zIndex+1});},onClearFormat:function(){var obm=this.obModel;for(var i=0;i<MAP.length;i++){delete obm.model[MAP[i].p];}obm._setCurrentFormat();},onOK:function(){var obm=this.obModel;obm._updateModel();var hfmt=obm.model[MAP[0].p];if(hfmt){var ptn=hfmt.FormattingPatterns,cht=hfmt.FormattingPatternsChart;if(cht){for(pr in DEF_FORMAT.FormattingPatternsChart){if(cht[pr]!=null){ptn["Series"+pr]=cht[pr];}}delete cht;}}var originModel=mstrmojo.hash.clone(this.model);_FD.saveFormatModel(obm.model,this.model,[MAP[0].p,MAP[1].p],_FD.DefaultFormat);this.model.dirty=!mstrmojo.hash.equals(originModel,this.model);},children:[{scriptClass:"mstrmojo.VBox",children:[{scriptClass:"mstrmojo.HBox",alias:"btns",children:[{scriptClass:"mstrmojo.Pulldown",alias:"which",items:MAP,itemIdField:"v",bindings:{value:function(){var idx=_A.find(this.items,"p",this.parent.parent.parent.obModel.levelName);return this.items[idx!=-1?idx:0][this.itemIdField];}},cssClass:" mstrmojo-FormatEditor-DropDownButton",popupZIndex:100,value:MAP[0].v,onvalueChange:function(){var editor=this.parent.parent.parent,fp=this.parent.parent.formatPanels,stck=fp&&fp.stck,it=this.selectedItem;if(editor&&editor.obModel&&stck){editor.obModel.set("levelName",it?it.p:MAP[0].p);var idx=_A.find(stck.children,"pr",chtPnl.pr);if(it==null||it.p==MAP[0].p){if(idx==-1){stck.addChildren(chtPnl);stck.onchildRenderingChange(chtPnl);}}else{stck.removeChildren(stck.children[idx]||[]);}}}},new _B.newInteractiveButton(mstrmojo.desc(5976),function(evt){var editor=this.parent.parent.parent;editor.prompt2ClearFormat();},btnClr,{alias:"btnClear",cssClass:btnCls+" clear"})]},{scriptClass:"mstrmojo.TabListContainer",alias:"formatPanels",listCssClass:"mstrmojo-FormatEditor-leftPanel",bindings:{currentModel:"this.parent.parent.obModel.currentFormat"},oncurrentModelChange:function(){this.parent.btns.which.onvalueChange();var lst=this.lst;if(lst.selectedIndex==0){lst.onchange();}else{lst.set("selectedIndex",0);}},children:[{scriptClass:"mstrmojo.TabNameList",alias:"lst",slot:"top",cssClass:"mstrmojo-FormatEditor-formatList",itemMarkup:'<div class="mstrmojo-FormatEditor-bullet"><div class="mstrmojo-text">{@n}</div></div>',onchange:function(){var pnls=this.parent,sidx=this.selectedIndex;if(pnls.stck&&sidx!=null&&sidx!=-1){var it=this.items[sidx],w=it&&it.target;var pr=w&&w.pr;if(pr){if(pr.constructor===Array){for(var i=0;i<pr.length;i++){w.set(pr[i],pnls.currentModel[pr[i]]);}}else{w.set("model",pnls.currentModel[pr]);}}}}},{scriptClass:"mstrmojo.StackContainer",cssClass:"mstrmojo-FormatEditor-rightPanel-container mstrmojo-FormatEditor-rightPanel",alias:"stck",slot:"stack",children:[nmPnl,algnPnl,fntPnl,brdrPnl,bgPnl,chtPnl]}]}]},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-buttonBar",children:[new _B.newInteractiveButton(mstrmojo.desc(2397),function(){var editor=this.parent.parent;editor.close();editor.onOK&&editor.onOK();},btnClr,{alias:"btnOk",cssClass:btnCls}),new _B.newInteractiveButton(mstrmojo.desc(2399),function(){var editor=this.parent.parent;editor.close();},btnClr,{alias:"btnCancel",cssClass:btnCls})]}]});})();