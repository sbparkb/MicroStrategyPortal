(function(){mstrmojo.requiresCls("mstrmojo.ME.MetricIDE","mstrmojo.ME.DerivedAttributeEditor","mstrmojo.ME.DynamicLinkEditor","mstrmojo.ME.AttributeEditBox","mstrmojo.ME.BandingDAEditor","mstrmojo.ME.MetricDataService");mstrmojo.requiresDescs(11404,2870,11616,11618,12199,9826,9571);var $DESC=mstrmojo.desc,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$E=mstrmojo.expr,OBJECTBROWSERS_ID="daObjectBrowsers",DA_OBJECTBROWSERS_DS=1,DA_OBJECTBROWSERS_THIS=0;function _getDocumentDatasets(me){return me.action.datasets||me.view.docModel.datasets;}function _getDefaultFuncCategory(att){var fs=att.fs||[],textFms=0,numFms=0,dateFms=0,BFT_DATETIME=1,BFT_DATE=8,BFT_TEXT=3,BFT_NUM=2,$DAIDE=mstrmojo.ME.DerivedAttributeIDE;mstrmojo.array.forEach(fs,function(fm){switch(fm.bftp){case BFT_DATETIME:case BFT_DATE:dateFms++;break;case BFT_TEXT:textFms++;break;case BFT_NUM:numFms++;break;}});if(dateFms){return $DAIDE.FUNC_CATEGORY_DATE;}if(numFms&&fs.length===numFms){return $DAIDE.FUNC_CATEGORY_BASIC;}return $DAIDE.FUNC_CATEGORY_STRING;}function _selectFuncCategory(me){var $IDE=mstrmojo.ME.DerivedAttributeIDE,$MDS=mstrmojo.ME.MetricDataService,funcBrowser=me.browsersContainer.funcBrowser;if(funcBrowser){funcBrowser.postfunctionsChange=function(){var act=me.action||{},fc=act.funccat||$IDE.FUNC_CATEGORY_STRING,funcs=this.functions,selIdx;switch(fc){case $IDE.FUNC_CATEGORY_BASIC:selIdx=$MDS.getBasicCategoryIndex(funcs);break;case $IDE.FUNC_CATEGORY_DATE:selIdx=$MDS.getDateTimeCategoryIndex(funcs);break;default:selIdx=$MDS.getStringCategoryIndex(funcs);break;}this.set("selectedCategory",selIdx+1);};}}function _isObjectVisible(itm,editingId){return !(itm.um||itm.rdm||itm.t===48||(itm.t===47&&itm.st===12033)||itm.did===editingId);}function _getDocCandidates(me,excludeAttrForms,excludeMetrics){var datasets=_getDocumentDatasets(me),items={},act=me.action,editingId=act.did,dataset,dsdid,dsn,hasCGorCon=function(dataset){var _result=false;$ARR.forEach(dataset.att,function(unit){var isCGorConsolidation=(unit.t===1||unit.t===47),isNDE=(unit.t===47&&unit.st===12033),isOldDE=(unit.t===12&&unit.de);_result=(isCGorConsolidation&&!isNDE||isOldDE);if(_result){return false;}});return _result;},filterCans=function(itm){if(!_isObjectVisible(itm,editingId)){return ;}itm.dsdid=dsdid;itm.path=dsn;items[itm.did]=itm;if(!excludeAttrForms){$ARR.forEach(itm.fs,function(fm){if(fm.obf||itm.da){fm.path=dsn;fm.attid=itm.did;fm.attn=itm.n;fm.did=fm.fmdid=fm.fid;fm.n=fm.fnm;items[fm.attid+"@"+fm.did]=fm;}});}};var allItems=[];var dsItems;for(dsdid in datasets){dataset=datasets[dsdid];if(hasCGorCon(dataset)||(dataset.isMDX&&dataset.isDDA)){continue;}dsn=dataset.name;dsItems=[].concat((excludeMetrics||dataset.isMDX)?[]:dataset.mx).concat(dataset.att);allItems=allItems.concat(dsItems);$ARR.forEach(dsItems,filterCans);}return{all:allItems,items:$HASH.valarray(items),isComplete:true,bc:-1};}function _getDescFormCandidates(excludeAttrForms){var cds={isComplete:true,items:[]};cds.items.push({n:"This",did:"This",t:12,fs:[{fnm:"ID",fid:"ID",t:21}]});if(!excludeAttrForms){cds.items.push({n:"ID",did:"ID",attid:"This",attn:"This",fnm:"ID",t:21});}return cds;}function _createObjectBrowsers(me){var dsob=me.datasetsObjects,obs=mstrmojo.insert({scriptClass:"mstrmojo.StackContainer",cssClass:"mstrmojo-DA-obContainer",id:OBJECTBROWSERS_ID,alias:"ob",children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-DA-obDESC",visible:false,initWarning:function initWarning(){var me=this;me.thisid.showInfo(document.getElementById("DA_THIS_ID"));window.setTimeout(function(){me.thisid.hideInfo();},3000);},children:[{scriptClass:"mstrmojo.Label",text:$DESC(2870,"Objects")},{scriptClass:"mstrmojo.ListBase",cssClass:"mstrmojo-VIUnitList",alias:"thisid",draggable:true,itemField:"n",items:[{n:"This@ID"}],ondblclick:function(){me.onObjectInsert(this.items[0]);},getDragData:function getDragData(){var it=this.items[0],ithtml='<div class="mstrmojo-VIUnitList"><div class="item unit ic21" ><span>'+it.n+"</span></div></div>";return{item:it,html:ithtml};},showInfo:function showInfo(el){var pos=mstrmojo.dom.position(el,false),me=this,fn=me._autoCloseFn=function(e){var hWin=self,tp=me.tooltip;if(tp&&!$DOM.contains(tp.domNode,$DOM.eventTarget(hWin,e),true,document.body)){me.hideInfo();}};me.richTooltip={posType:mstrmojo.tooltip.POS_TOPRIGHT,content:$DESC(11618,"You can define this and additional DESC forms based on the current attribute ID."),contentNodeCssClass:"dae-desc-info me-tooltip-content regular up",left:pos.x+32,top:pos.y+20};me.hasOpenTooltip=false;me.showTooltip();$DOM.attachEvent(document.body,"mousedown",fn,true);},hideInfo:function hidenInfo(){me.hideTooltip();if(this._autoCloseFn){$DOM.detachEvent(document.body,"mousedown",this._autoCloseFn,true);delete this._autoCloseFn;}},itemRenderer:{render:function(item,idx,w){return'<div class="item unit ic21" ><span>'+item.n+'</span><div id="DA_THIS_ID" class="tidinfo" onclick="mstrmojo.all[\''+w.id+"'].showInfo(this)\" ></div></div>";}}}]}]});if(dsob){obs.addChildren([dsob]);obs.set("selected",dsob);}return obs;}function _validateAndSave(dsid,attrid,attrn,formid,tks,fn){var valcb=function(res){if(res.vs!==0){mstrmojo.alert(mstrmojo.desc(9826,"The metric definition has an error. Please correct before proceeding."),null,mstrmojo.desc(9571,"Syntax Error!"));return ;}var param;if(attrid){param={act:"updateDA",name:attrn,dsid:dsid,attrId:attrid,isTokenStream:true,update:[{did:formid,formula:res.tokenXML}]};}else{param={act:"addDAToDataset",dsid:dsid,name:attrn,isTokenStream:true,forms:[{n:"ID",formula:res.tokenXML}]};}fn(param);};mstrmojo.ME.AttributeEditBox.validateSyntax(attrid,tks,true,valcb);}mstrmojo.ME.DerivedAttributeIDE=mstrmojo.declare(mstrmojo.ME.MetricIDE,null,{scriptClass:"mstrmojo.ME.DerivedAttributeIDE",id:"mstrDerivedAttrIDE",noCache:false,isDME:true,title:$DESC(11616,"Attribute Editor"),formulaEditorId:"mstrDAE",nameLabel:$DESC(12199,"Attribute Name:"),hasFunctionBrowser:true,getEditorScriptClass:function getEditorScriptClass(editorId){return{mstrFE:"mstrmojo.ME.DerivedFunctionWizard",mstrSME:"mstrmojo.ME.SimpleMetricEditor",mstrDAE:"mstrmojo.ME.DerivedAttributeEditor",mstrBDAE:"mstrmojo.ME.BandingDAEditor",mstrDLE:"mstrmojo.ME.DynamicLinkEditor"}[editorId];},isBanding:function isBanding(did){return mstrmojo.ME.MetricDataService.isBanding(did);},isObjectVisible:_isObjectVisible,filterFunctions:function filterFunctions(fcts){var dm_cat_index=mstrmojo.ME.MetricDataService.getDataMiningCatIndex(fcts),dm_cat_did=dm_cat_index>-1?fcts[dm_cat_index].did:"";return mstrmojo.array.filter(fcts,function(fct){if(fct.did!==dm_cat_did){var fns=fct.fns;fct.fns=mstrmojo.array.filter(fns,function(fn){return(!fn.idbo&&fn.ip&&fn.sqt===3);});return fct.fns.length>0;}});},getTokenInputBox:function getTokenInputBox(){return mstrmojo.all.mstrDAE.attrEditBox.inputBox;},onObjectInsert:function(items){mstrmojo.all.mstrDAE.onObjectInsert(items);},onOpen:function onOpen(){this.set("datasets",_getDocumentDatasets(this));this.set("dsUnits",_getDocCandidates(this,true));this.set("candidates",_getDocCandidates(this));this.set("feParamItemsPath","mstrmojo.all.mstrDerivedAttrIDE.dsUnits.items");this.set("funcsPath","mstrmojo.all.mstrDerivedAttrIDE.functions");this.set("candidatesPath","mstrmojo.all.mstrDerivedAttrIDE.candidates");this.browsersContainer.funcBrowser.set("includeFakeFuncs",false);if(!this.hasFunctionBrowser){this.set("attrCandidates",_getDocCandidates(this,false,true));this.browsersContainer.funcBrowser.set("visible",false);this.funcSyntaxDesc.set("visible",false);}var ob=this.browsersContainer.ob,obds=ob&&ob.children[DA_OBJECTBROWSERS_DS];if(obds){ob.set("selected",obds);obds.refresh();if(obds.doLayout){window.setTimeout(function(){obds.doLayout();},50);}}if(this._super){this._super();}if(this.editorId==="mstrDLE"){this.set("title",mstrmojo.desc(14718,"Link Editor")+" - "+(this.action.n||"New Link"));}else{this.set("title",mstrmojo.desc(11616,"Attribute Editor")+" - "+(this.action.n||mstrmojo.desc(11404,"New Attribute")));}},renderObjectsBrowser:function renderObjectsBrowser(){var obs=mstrmojo.all[OBJECTBROWSERS_ID]||_createObjectBrowsers(this);this.getBrowsersContainer().addChildren([obs]);},onformsTabSwitch:function ontabSwitch(e){var obs=this.browsersContainer.ob,fmidx=(e&&e.nidx)||0,selob=obs&&obs.children[fmidx>=1?DA_OBJECTBROWSERS_THIS:DA_OBJECTBROWSERS_DS];mstrmojo.css.toggleClass(obs.domNode," show-all",fmidx>0);if(selob){obs.set("selected",selob);if(e.toNewTab){selob.initWarning();}}this.set("dsUnits",fmidx===0?_getDocCandidates(this,true):_getDescFormCandidates(true));},isExpEditor:function isExpEditor(editorId){return editorId==="mstrDAE";},configInlineEditor:function configInlineEditor(c){var act=this.action;c.paramItemsPath=this.feParamItemsPath;c.oncreate=act.oncreate;c.onupdate=act.onupdate;},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}_selectFuncCategory(this);mstrmojo.css.addClass(this.editorNode,"mstrmojo-DA-IDE");if(!this.hasFunctionBrowser){mstrmojo.css.addClass(this.editorNode,"hideFuncBrowser");}},setRefOi:function(cfg){cfg.refOi=this.action&&this.action.refOi;},getEditorId:function getEditorId(cfg){var oi=cfg.oi,fmlen=oi.forms&&oi.forms.length,dfm,met,editorId;if(fmlen===1){dfm=oi.forms[0];met=dfm.met;oi.tks={items:dfm.ftk,met:dfm.met};}if(!cfg.id&&mstrmojo.ME.BandingDAEditor.showAsBandingEditor(oi)){editorId="mstrBDAE";}else{editorId=cfg.id||{65536:"mstrDAE",196608:"mstrFE"}[met]||"mstrDAE";}cfg.id=editorId;return editorId;},getEditorHelpTopic:function getEditorHelpTopic(editorId){var helpTopics=mstrApp.isSingleTier?{mstrDLE:"creating_a_grid_visualization.htm"}:{mstrDLE:"creating_a_grid_visualization_html5.htm#dynamic-link"};return helpTopics[editorId]||"derived_attribute_editor.htm";},showAsSimpleIDE:function showAsSimpleIDE(oi){var fmlen=oi.forms&&oi.forms.length;return(fmlen===1||mstrmojo.ME.BandingDAEditor.showAsBandingEditor(oi))&&parseInt(oi.forms[0].met,10)!==mstrmojo.ME.ENUM.METRIC_EDIT_TYPES.ADVANCED;},oneditorConfigChange:function oneditorConfigChange(){var editorConfig=this.editorConfig,cfg=editorConfig.cfg,oi=cfg.oi||{},fmlen=oi.forms&&oi.forms.length;if(oi.tks&&fmlen===1){oi.forms[0].ftk=oi.tks.items;}this._super();},getValidFuncParamTypes:function getValidFuncParamTypes(fctOi){var pts=[$E.TP.METRIC];if(!fctOi||fctOi.sqt===1||fctOi.sqt===3){pts.push($E.TP.ATTR);}return pts;},validateAndSave:function validateAndSave(oi,fn){var me=this,act=me.action,dsid=act.dsid,dfm=(oi.forms&&oi.forms[0])||{},savefn=function(param){fn();me.close();var actfn=oi.did?act.onupdate:act.oncreate;if(actfn){actfn(param);}};_validateAndSave(dsid,oi.did,oi.n,dfm.did,oi.tks,savefn);},loadObjectDefn:function(callback){var act=this.action,dan=act.n,daid=act.did,fms,idx=0,pfms=[],msgID=act.msgID,itfn=function(res){var fm=fms[idx-1];if(res&&res.tks&&fm){pfms.push({did:fm.fid,n:fm.fnm,k:fm.fid,ftk:res.tks.items,met:res.tks.met,vs:1,is:""});}if(idx===fms.length){callback.success({n:dan,did:daid,forms:pfms,dsid:act.dsid,alias:act.alias});return ;}fm=fms[idx++];mstrmojo.ME.MetricDataService.validateMetric({metricId:daid,formID:fm.fid,objectType:12,tokenStreamXML:"",metricXML:"",msgID:msgID},{success:itfn});};if(daid){fms=act.forms;itfn();}else{callback.success({n:dan||mstrmojo.desc(11404,"New Attribute"),dsid:act.dsid});}}});mstrmojo.ME.DerivedAttributeIDE.FUNC_CATEGORY_BASIC=1;mstrmojo.ME.DerivedAttributeIDE.FUNC_CATEGORY_DATE=2;mstrmojo.ME.DerivedAttributeIDE.FUNC_CATEGORY_STRING=3;mstrmojo.ME.DerivedAttributeIDE.getDefaultFunctionCategory=_getDefaultFuncCategory;}());