(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.tabs.TabStrip","mstrmojo.vi.ui.tabs.Tab","mstrmojo.ME.MetricEditBox","mstrmojo.array","mstrmojo.hash");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$BKTS=mstrmojo.ME.MetricToken.brackets,$DOM=mstrmojo.dom,$CSS=mstrmojo.css,ENUM_ACTIONS=mstrmojo.vi.ui.tabs.Tab.ACTIONS,MENU_ACTIONS=ENUM_ACTIONS.DELETE+ENUM_ACTIONS.RENAME,_VSTATUS=mstrmojo.ME.MetricEditBox.VALIDATION_STATUS,_S=mstrmojo.string,THIS_ID="This@ID",ID_FORM_GUID="45C11FA478E745FEA08D781CEA190FE5";function _newEmptyForm(nn){return{n:nn,k:nn,ftk:[],vs:1,is:""};}function _switchTab(me,oidx,nidx,toNewTab){var ofm=me.forms[oidx]||{},nfm=me.forms[nidx],ib=me.inputBox;if(oidx!==nidx){ofm.vs=me.vStatus;ofm.is=me.iStatus;ofm.ftk=ib.items;me.set("vStatus",_VSTATUS.UNKNOWN);}me.set("vStatus",nfm.vs);me.set("iStatus",nfm.is);me.updateInputBoxItems({items:nfm.ftk});if(me.curFormIdx!==nidx){me.curFormIdx=nidx;me.tabstrip.setSelectedTab(nfm.k);}me.raiseEvent({name:"tabSwitch",tks:nfm.ftk,vs:nfm.vs,is:nfm.is,oidx:oidx,nidx:nidx,toNewTab:toNewTab});}function _saveCurrentForm(me){var cfm=me.forms[me.curFormIdx];if(cfm){cfm.ftk=me.inputBox.items;cfm.vs=me.vStatus;cfm.is=me.iStatus;}}var _curSuffix=0;function _adjustCurSuffix(curForms){_curSuffix=Math.max(curForms.length-1,_curSuffix);}function _resetCurSuffix(){_curSuffix=0;}function _calNewDescFormName(forms){var nn="DESC"+(_curSuffix?" "+_curSuffix:"");_curSuffix++;if($ARR.find(forms,"n",nn)>=0){return _calNewDescFormName(forms);}return nn;}function _prepareInsertToken(oi){var t={v:$BKTS(oi.n),oi:oi,isNew:true},flen,dfm;if(oi.t===12){flen=$ARR.filter(oi.fs,function(fm){return fm.obf||oi.da;}).length;if(flen===1){dfm=oi.fs[0];t=$HASH.copy({v:$BKTS(oi.n)+"@"+$BKTS(dfm.fnm),ift:true,exv:dfm.fid,extp:8},t);}else{t=$HASH.copy({v:$BKTS(oi.n)+"@",ift:true},t);}}return t;}function _wait(btn,v){btn.set("enabled",!v);var waitIconClass="mstrmojo-InlineWaitIcon";if(btn.iconClass){btn.set("iconClass",btn.iconClass.replace(new RegExp(waitIconClass),"")+" "+(v?waitIconClass:""));}else{mstrmojo.css.toggleClass(btn.domNode,waitIconClass,v);}}var _postprocessTokenStream=function(tks){var its=tks.items,len=its.length,last=its[its.length-1],i,it,newItems=[],newV="",fnarr;if(its[0]&&its[0].tp!==33){newItems.push({v:"!",tp:33,lv:4,sta:2});}for(i=0;i<len;i++){it=its[i];if(it.isNew&&!it.oi){newV+=it.v;}else{if(!_S.isEmpty(newV)){newItems.push({v:newV,tp:2,lv:1});newV="";}if(it.v&&it.v.indexOf(THIS_ID)>=0){it.v=it.v.replace("["+THIS_ID+"]",THIS_ID);it.exv=ID_FORM_GUID;it.extp=8;delete it.oi;}newItems.push(it);}}if(!_S.isEmpty(newV)){newItems.push({v:newV,tp:2,lv:1});newV="";}if(last&&last.tp!==-1){newItems.push({v:"",tp:-1,lv:4,sta:2});}return{items:newItems};},_preprocessTokenStream=function(tks){var its=tks.items||[],last=its[its.length-1];if(last&&last.tp===-1){its.pop();}if(its[0]&&(its[0].tp===33||its[0].tp===37)){its.splice(0,1);}$ARR.forEach(its,function(it){if(it.v&&it.v.indexOf(THIS_ID)>=0){$HASH.copy({extp:8,exv:ID_FORM_GUID,oi:{n:"This",did:"This",t:12}},it);}});},_mapErrorCode=function(code){if(!code){return _VSTATUS.VALID;}return{"-2147214845":_VSTATUS.ERROR,"-2147214846":_VSTATUS.AMBIGUITY}[code]||_VSTATUS.ERROR;},_getTokenStreamXML=function(tks){tks=_postprocessTokenStream(tks);var props={items:true,v:true,tp:true,lv:true,oi:true,n:true,did:true,t:true,st:true,exv:true,extp:true,asc:true,vtp:true},config={getArrItemName:function(){return"tkn";},isSerializable:function(nodeName){return(props[nodeName])?true:false;}};return _S.json2xml("tknstrm",tks,config);},_validateSyntax=function(attrid,tks,isIDForm,fn){var tksXML=_getTokenStreamXML(tks),success=function(res){if(res&&res.tks){var tksret=res.tks;_preprocessTokenStream(tksret);tksret.vs=_mapErrorCode(tksret.rjec);tksret.tokenXML=tksXML;if(fn){fn(tksret);}}},failure=function(res){mstrmojo.alert(res.message||res.getResponseHeader&&res.getResponseHeader("X-MSTR-TaskFailureMsg"));};mstrmojo.ME.MetricDataService.validateMetric({tokenStreamXML:tksXML,localSymbolFolderXML:"",metricXML:"",metricId:attrid||"",isNew:true,objectType:12,isIDForm:isIDForm,msgID:mstrApp.getMsgID()},{success:success,failure:failure});};mstrmojo.ME.DerivedAttributeFormTab=mstrmojo.declare(mstrmojo.vi.ui.tabs.Tab,null,{scriptClass:"mstrmojo.ME.DerivedAttributeFormTab",valid:true,editable:true,postBuildRendering:function postBuildRendering(){if(this._super){this._super();}var me=this,lbl=me.lbl;lbl.editOnDoubleClick=this.editable;lbl.onTextEditComplete=function(textChanged,oldText){if(me.validate(lbl.text)){me.titleEdited(lbl.text,oldText);}};},onclick:function onclick(evt){var target=mstrmojo.dom.eventTarget(evt.hWin,evt.e);if(target===this.menuBtnNode){this.tabDeleted();}else{if(!this.isSelected){this.tabSelected();}}},validate:function(v){var val=!/[\[\]\"\\]/g.test(v);if(!val){this.lbl.set("isEditing",true);}this.set("valid",val);return val;},showErrTooltip:function showTooltip(msg,offsetLen){var position=mstrmojo.dom.position(this.domNode),me=this,tp=me.errTooltip;if(!tp){me.errTooltip=tp=new mstrmojo.Tooltip({contentNodeCssClass:"me-tooltip-content up me-err",updatePopupConfig:null});this.addDisposable(tp);}tp.set("top",position.y+position.h+2);tp.set("left",position.x+position.w/2-offsetLen);tp.set("content",'<div class="content"><span>'+msg+"</span></div>");tp.open();window.setTimeout(function(){tp.close();},2500);},onvalidChange:function(){if(this.valid){this.hideTooltip();}else{this.showErrTooltip(mstrmojo.desc(11569,"Input contains invalid character"),95);}}});function _getTabCfg(me,allTabObjects,currentTabObject){var curIdx=$ARR.find(allTabObjects,"k",currentTabObject.k);return{scriptClass:"mstrmojo.ME.DerivedAttributeFormTab",title:currentTabObject.n,draggable:false,editable:curIdx!==0,cssClass:"mstrmojo-AEB-Tab "+(curIdx===0?"mstrmojo-AEB-IDTab":""),getMenuActions:function(){return MENU_ACTIONS;},tabSelected:function(){_switchTab(me,me.curFormIdx,curIdx);},titleEdited:function editTitle(titleText,oldText){if(titleText!==oldText){if($ARR.find(me.forms,"n",titleText)>=0){this.showErrTooltip(mstrmojo.desc(7209,"Name already exists"),69);}var cfm=me.forms[curIdx];cfm.n=titleText;}},tabDeleted:function tabDelete(){var len=me.forms.length,nsel=(me.curFormIdx===len-1)?0:me.curFormIdx,nfms=me.forms.slice(0),delfm=nfms[curIdx];if(delfm&&delfm.did){me.delForms.push({n:delfm.n,did:delfm.did});}nfms.splice(curIdx,1);me.curFormIdx=nsel;me.set("forms",nfms);_switchTab(me,-1,nsel);me.set("dirty",true);}};}mstrmojo.ME.AttributeEditBox=mstrmojo.declare(mstrmojo.ME.MetricEditBox,null,{scriptClass:"mstrmojo.ME.AttributeEditBox",markupString:'<div id="{@id}" class="mstrmojo-MEBox {@cssClass}" style="{@cssText}"><div class="mstrmojo-AEB-TabStrip"></div><div class="mstrmojo-MEBox-edit mstrmojo-AEB-edit"></div><div class="mstrmojo-MEBox-status {@statusCssClass}"><div class="mstrmojo-MEBox-vStatus"></div><div class="mstrmojo-MEBox-iStatus"></div></div></div>',markupSlots:{tabstripNode:function(){return this.domNode.firstChild;},editNode:function(){return this.domNode.childNodes[1];},statusNode:function(){return this.domNode.lastChild;},iStatusNode:function(){return this.domNode.lastChild.lastChild;},vStatusNode:function(){return this.domNode.lastChild.firstChild;}},forms:null,delForms:[],curFormIdx:0,attrid:null,absorbAmbiguity:false,init:function init(props){var me=this;me.children=[{scriptClass:"mstrmojo.vi.ui.tabs.TabStrip",alias:"tabstrip",position:"top",slot:"tabstripNode",isAlignRight:false,getTabCfg:function getTabCfg(allTabObjects,currentTabObject,cfg){return $HASH.copy(_getTabCfg(me,allTabObjects,currentTabObject),cfg);},addTab:function addTab(){var fms=me.forms,len=fms.length,nn=_calNewDescFormName(fms),nfms=fms.slice(0);nfms.push(_newEmptyForm(nn));me.set("forms",nfms);_switchTab(me,me.curFormIdx,len,true);me.set("dirty",true);},clear:function clear(){$ARR.forEach(this.children,function(tab){tab.hideTooltip();});}},{scriptClass:"mstrmojo.Button",alias:"clearBtn",slot:"tabstripNode",text:mstrmojo.desc(1763,"Clear All"),cssClass:"mstrmojo-WebHoverButton mstrmojo-AEB-clearAll",onclick:function(){me.inputBox.clearTokens([]);}},{scriptClass:"mstrmojo.Button",alias:"validateBtn",slot:"tabstripNode",text:mstrmojo.desc(11897,"Validate"),cssClass:"mstrmojo-WebHoverButton mstrmojo-AEB-validate",onclick:function(){me.validateCurrentForm();}}].concat(this.children);this._super(props);},item2textCss:function item2textCss(data){return this._super(data)||{21:"afm"}[data.t]||"";},onformsChange:function onformsChange(){var fms=this.forms,selKey=fms[this.curFormIdx].k;$ARR.forEach(fms,function(fm){_preprocessTokenStream({items:fm.ftk});});this.tabstrip.setTabs(fms,selKey);_adjustCurSuffix(fms);},selectFormTab:function selectFormTab(idx){_switchTab(this,this.curFormIdx,idx);},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.clear();var me=this;this.inputBox.ondrop=function(c){if(!c.src.data||!c.src.data.item){return ;}var tib=me.inputBox,widgets=tib.ctxtBuilder.itemWidgets,oi=$HASH.copyProps(["did","n","t","fs"],c.src.data.item),tk=_prepareInsertToken(oi),sel,idx,iw;c.src.data=tk;mstrmojo.ListBase2.prototype.ondrop.call(this,c);if(me.ontokensModify){me.ontokensModify();}sel=this.selectedIndices;if(oi.t===12&&tk.ift&&!tk.exv){for(idx in sel){iw=widgets[idx];if(iw){tib.startTokenSuggestion(iw);}}}tib.clearSelect(true);$CSS.removeClass(tib.domNode,"unselectable");};},clear:function clear(){this.curFormIdx=0;this.delForms=[];this.attrid=null;_resetCurSuffix();this.set("forms",[_newEmptyForm("ID")]);this.inputBox.set("items",[]);this.inputBox.resetTokensCache();this.set("vStatus",_VSTATUS.UNKNOWN);this.set("iStatus","");this.tabstrip.clear();},validateCurrentForm:function validateCurrentForm(fn){var me=this,valBtn=this.validateBtn,valcallback=function(tks){_wait(valBtn,false);me.set("vStatus",tks.vs);me.set("iStatus",tks.rjed||"");me.updateInputBoxItems({items:tks.items});me.statusNode.style.display="block";me.handleValidation(tks);if(fn){fn(tks.items,tks.vs===_VSTATUS.VALID);}};me.set("vStatus",_VSTATUS.VALIDATING);_wait(valBtn,true);_validateSyntax(this.attrid,{items:this.inputBox.items},me.curFormIdx===0,valcallback);},validateAllForms:function validateAllForms(fn){var me=this,fms=me.forms,idx=0,itfn=function(tks){var isIDForm=(idx===0);if(tks){var f=fms[idx-1];f.ftk=tks.items;f.vs=tks.vs;f.is=tks.rjed||"";f.tokenXML=_getTokenStreamXML({items:tks.items});if(tks.vs!==_VSTATUS.VALID){me.selectFormTab(idx-1);me.handleValidation(tks);if(fn){fn(null,false);}return ;}}if(idx===fms.length){if(fn){fn(fms,true);}return ;}_validateSyntax(me.attrid,{items:fms[idx++].ftk},isIDForm,itfn);};_saveCurrentForm(me);itfn();},continueValidataion:function continueValidation(){this.validateCurrentForm();},getStatusDesc:function _getStatusDesc(s){return{0:mstrmojo.desc(11655,"Valid Formula.")}[s];},onvStatusChange:function onvStatusChange(){this.statusNode.style.display=this.vStatus>=_VSTATUS.VALIDATING?"block":"none";},onObjectInsert:function onObjectInsert(oi){var tib=this.inputBox,tk=_prepareInsertToken(oi),idx=tib.insertTokens([tk]),iw;if(oi.t===12&&tk.ift&&!tk.exv){iw=tib.ctxtBuilder.itemWidgets[idx];if(iw){tib.startTokenSuggestion(iw);}}}});mstrmojo.ME.AttributeEditBox.preprocessTokenStream=_preprocessTokenStream;mstrmojo.ME.AttributeEditBox.postprocessTokenStream=_postprocessTokenStream;mstrmojo.ME.AttributeEditBox.mapErrorCode=_mapErrorCode;mstrmojo.ME.AttributeEditBox.getTokenStreamXML=_getTokenStreamXML;mstrmojo.ME.AttributeEditBox.validateSyntax=_validateSyntax;mstrmojo.ME.AttributeEditBox.prepareInsertToken=_prepareInsertToken;}());