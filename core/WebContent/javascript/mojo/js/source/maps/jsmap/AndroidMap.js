(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.array","mstrmojo.hash","mstrmojo.android.EnumMenuOptions","mstrmojo.GeoLocation","mstrmojo._TouchGestures","mstrmojo.android.DropDownList","mstrmojo.Label","mstrmojo._ImageHelper");mstrmojo.requiresDescs(7736,8068,8069,8102,8395,8954);var $A=mstrmojo.array,$M=mstrmojo.android.EnumMenuOptions,REPROMPT=$M.REPROMPT,MAX_MARKERS=1000;function CustomMarker(lbl,latlng,rad,index,color){this.title=lbl;this._latlng=latlng;this._rad=rad;this._ix=index;this._color=color;}function initCustomMarker(){CustomMarker.prototype=new google.maps.OverlayView();CustomMarker.prototype.draw=function(){var div=this.div_;if(!div){div=this.div_=document.createElement("DIV");var sty=div.style,rad=this._rad,radD2=rad/2,radD2Px=radD2+"px "+radD2+"px",panes=this.getPanes(),me=this;sty.position="absolute";sty.paddingLeft="0px";sty.cursor="pointer";sty.backgroundColor=this._color;sty.opacity=".65";sty.borderRadius=radD2Px;sty.height=sty.width=rad+"px";sty.border="2px solid black";google.maps.event.addDomListener(div,"click",function(event){google.maps.event.trigger(me,"click");});panes.overlayMouseTarget.appendChild(div);}var point=this.getProjection().fromLatLngToDivPixel(this._latlng);if(point){div.style.left=(point.x-this._rad/2)+"px";div.style.top=(point.y-this._rad/2)+"px";}};CustomMarker.prototype.remove=function(){var dv=this.div_;if(dv){dv.parentNode.removeChild(dv);this.div_=null;}};CustomMarker.prototype.getPosition=function(){return this._latlng;};}var getBounds=function getBounds(markers){var bnds;if(markers.length>0){bnds=new google.maps.LatLngBounds();for(var i in markers){var m=markers[i],p=m.getPosition();bnds.extend(p);}}return bnds;};function getFromPoint(laOrln,value){return value.replace(/POINT[ ]?\(|\)/g,"").split(" ")[laOrln=="lat"?1:0];}function _getMapType(){return this._mapTypeToGoogleMapTypeId[this.mapType];}mstrmojo.maps.jsmap.AndroidMap=mstrmojo.declare(mstrmojo.Vis,[mstrmojo._TouchGestures,mstrmojo._ImageHelper],{scriptClass:"mstrmojo.maps.jsmap.AndroidMap",cssClass:"mstr-googleMapView",markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" style="{@domNodeCssText}"><div></div><div class="androidMap-metricSelector"><span class="androidMap-toggleHeader"></span></div><div class="mstr-googleMap" id="map_canvas_{@id}"></div></div>',reRenderOnDimensionChg:false,noMapsMsg:mstrmojo.desc(8954,"Google Maps have not been configured for this device. Please check with your mobile administrator to enable Google Maps in the mobile configuration."),selMetricIx:0,markerArr:[],googleMap:null,bubblesMaxInfo:[],maxBubbleSize:50,minBubbleSize:20,markupSlots:{msg:function(){return this.domNode.childNodes[0];},metricSelector:function(){return this.domNode.childNodes[1];},map:function(){return this.domNode.childNodes[2];}},markupMethods:{onheightChange:function(){this.domNode.style.height=this.getHeight()+"px";},onwidthChange:function(){this.domNode.style.width=this.getWidth()+"px";}},layoutConfig:{h:{metricSelector:"32px",map:"100%"},w:{metricSelector:"200px",map:"100%"}},children:[{scriptClass:"mstrmojo.android.DropDownList",slot:"metricSelector",options:null,onidxChange:function(evt){this._super(evt);this.parent.onselMetricIxChange(evt);this.set("value",this.options[evt.value].v);},visible:false,alias:"metricSel"},{scriptClass:"mstrmojo.Box",slot:"map"},{scriptClass:"mstrmojo.Label",cssClass:"androidMap-errorMsg",visible:true,alias:"errorMsg",slot:"msg"}],setModel:function setModel(model){this.set("model",model);this.xtabModel=model;if(model.data){this.set("gridData",model.data);}},ongridDataChange:function(){this.parser=new mstrmojo.Vis.DataParser(this.gridData);},update:function update(node){node=node||this.node;if(node){if(node.data){this.set("gridData",node.data);var gd=this.gridData;if(gd.layoutModel){this.layoutModel=gd.layoutModel;}if(gd.layoutNode){this.layoutNode=gd.layoutNode;}}var fmts=node.defn.fmts||node.defn.units[this.xtabModel.k].fmts;this.width=parseInt(fmts.width,10);this.height=parseInt(fmts.height,10);this.top=parseInt(fmts.top,10);this.left=parseInt(fmts.left,10);this.fmts=fmts;}if(this.xtabModel){this.initFromVisProps(this.gridData.vp);}this.updated=true;},getMapModel:function(){return this.xtabModel;},initFromVisProps:function initFromVisProps(vp){if(!vp){return ;}if(vp.dv){this.mapType=parseInt(vp.dv,10);}this.usePt=(vp.gr=="1");this.useAttributes=(vp.af==="0");this.geoAttr=vp.ga;this.markerType=vp.mtp;this.attrThresholds=vp.at;this.flong=vp.flong;this.flat=vp.flat;this.fpt=vp.fpt;this.mstyl=vp.mstyl;this.maxBubbleSize=vp.mbs||50;},showErrorMsg:function showErrorMsg(show,msg){this.errorMsg.set("text",msg);this.metricSelector.style.display=show?"none":"block";this.map.style.display=show?"none":"block";this.msg.style.display=show?"block":"none";},postBuildRendering:function postBuildRendering(){console.log("JSMAP:androiMap:postBuildRendering");this._super();if(typeof this.gridData.eg!=="undefined"){this.showErrorMsg(true,this.gridData.eg);}else{if(typeof google==="undefined"||(google&&typeof google.maps==="undefined")){this.showErrorMsg(true,this.noMapsMsg);}else{this.showErrorMsg(false);var selectorCtrl=this.children[0];selectorCtrl.idx=0;selectorCtrl.unset=true;selectorCtrl.options=[{v:"-1",n:""}];if((typeof google!=="undefined"&&google.maps)){if(!mstrApp.isInfoWindow){this.markerArr=[];this.bubblesMaxInfo=[];}this._mapTypeToGoogleMapTypeId=[google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.TERRAIN];initCustomMarker();if(this.gridData){var showSelector=this.buildMetricSelector(),selectorHeight=showSelector?parseInt(this.layoutConfig.h.metricSelector,10):0;this.metricSel.set("visible",showSelector);this.map.style.height=this.getHeight()+"px";this.map.style.width=(this.getWidth()-1)+"px";this.metricSelector.style.height=selectorHeight+"px";this.metricSelector.style.display=showSelector?"block":"none";this.initMap();if(this.map.firstChild){this.map.firstChild.style.zIndex=1;}}}}}},gup:function gup(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var rxs="[\\?&]"+n+"=([^&#]*)",rx=new RegExp(rxs),r=rx.exec(window.location.href);return r==null?"":r[1];},onselMetricIxChange:function(evt){var f=function(map,mks){for(var i in mks){if(mks[i].setMap){mks[i].setMap(map);}}};if(this.openedInfoWindow){this.openedInfoWindow.close();}var mks=this.getMarkers(evt.value),oldMks=this.getMarkers(evt.valueWas);this.selMetricIx=evt.value;f(null,oldMks);f(this.googleMap,mks);},buildMetricSelector:function buildMetricSelector(){var col=this.gridData.gts.col,useSelector=false;if(col.length>0){var metrics=col[0].es;if(metrics.length>1){var items=[],x=-1;$A.forEach(metrics,function(m,idx){items[++x]={n:m.n,v:x,id:m.id};});var selector=this.children[0];selector.set("options",items);selector.set("value",0);useSelector=true;}}return useSelector;},initMap:function(){var map,gm=google.maps,gme=gm.event,mapType=_getMapType.call(this)||gm.MapTypeId.ROADMAP,mapOptions={mapTypeControl:true,mapTypeControlOptions:{position:gm.ControlPosition.TOP_LEFT,style:gm.MapTypeControlStyle.HORIZONTAL_BAR},streetViewControl:false,mapTypeId:mapType,navigationControlOptions:{position:gm.ControlPosition.RIGHT_BOTTOM,style:gm.NavigationControlStyle.ANDROID},zoomControlOptions:{style:gm.ZoomControlStyle.LARGE},tilt:0};this.googleMap=map=new gm.Map(this.map,mapOptions);this.selMetricIx=this.selMetricIx;var markers=this.getMarkers(this.selMetricIx);if(markers.length>0){var bnds=this.mapBounds;if(bnds){map.fitBounds(bnds);map.setCenter(bnds.getCenter());}}else{var mstrHQ=new gm.LatLng(38.893444,77.221648);map.setCenter(mstrHQ);}var INTERVAL=30,t=0,mz=map.getZoom(),ti=setInterval(function(){mz=map.getZoom();t+=INTERVAL;if(mz!==undefined){if(mz>20){map.setZoom(15);}else{if(mz<2){map.setZoom(2);}}clearTimeout(ti);}else{if(t>10*INTERVAL){clearTimeout(ti);map.setZoom(2);}}},INTERVAL);},getMarkers:function getMarkers(metricIx){if(!!this.markerArr[metricIx]){return this.markerArr[metricIx];}var map=this.googleMap,d=this.gridData,vp=d.vp,gts=d.gts,row=gts.row,usePt=this.usePt,minVals=(usePt?1:2),useAttributes=this.useAttributes,geoAttr=this.geoAttr,longs,lats,labels,longIdx=-1,latIdx=-1,labelIdx=-1,mks=[],tIcon=null;for(var r=0,numRows=row.length,totalForms=0;r<numRows;++r){var curRow=row[r],rid=curRow.id;if(usePt){if(rid==this.fpt){longs=lats=curRow;longIdx=latIdx=totalForms;}}else{if(rid==this.flong){longs=curRow;longIdx=totalForms;}else{if(rid==this.flat){lats=curRow;latIdx=totalForms;}}}for(var f=0,numForms=curRow.fs.length;f<numForms;++f){var curForm=curRow.fs[f],fid=curForm.id;if(usePt){if(fid==this.fpt){longs=lats=curRow;longIdx=latIdx=totalForms+f;}}else{if(fid==this.flong){longs=curRow;longIdx=totalForms+f;}else{if(fid==this.flat){lats=curRow;latIdx=totalForms+f;}}}if(labelIdx<0){labels=curRow;labelIdx=totalForms+f;}}totalForms+=numForms;}if(Math.min(longIdx,latIdx,labelIdx)<0){throw new Error(mstrmojo.desc(8395,"Not enough data to display map."));}var rhs=d.ghs.rhs.items,numMarkers=Math.min(rhs.length,MAX_MARKERS),lat_hi=-90,lat_lo=90,lng_hi=-180,lng_lo=180;for(var i=0;i<numMarkers;i++){var vals=rhs[i].items;if(vals.length<minVals){continue;}var longV=longs.es[vals[longIdx].idx].n,lon=parseFloat(usePt?getFromPoint("long",longV):longV),lat=parseFloat(usePt?getFromPoint("lat",longV):lats.es[vals[latIdx].idx].n),lbl=labels.es[vals[labelIdx].idx].n,marker,metricItem=d.gvs.items[i];if(isNaN(lat)||isNaN(lon)){continue;}lat_lo=(lat<lat_lo)?lat:lat_lo;lat_hi=(lat>lat_hi)?lat:lat_hi;lng_lo=(lon<lng_lo)?lon:lng_lo;lng_hi=(lon>lng_hi)?lon:lng_hi;latLng=new google.maps.LatLng(lat,lon);if(this.markerType=="2"){marker=this.getMetricBubble(d.gvs.items[i],lbl,latLng,i,metricIx);}else{tIcon="../"+this.mstyl;var gvsItem=d.gvs.items[i];if(gvsItem){var mitems=gvsItem.items;if(mitems){var mi=mitems[metricIx];if(mi&&(mi.ts==4)&&(this.attrThresholds=="1")){tIcon=this.getImage(mi.v);}}}marker=new google.maps.Marker({position:latLng,title:lbl,_ix:i,icon:tIcon,zIndex:i});}marker.eid=labels.es[vals[labelIdx].idx].id;marker.attrid=labels.id;marker.setMap(map);google.maps.event.addListener(marker,"click",function(ths,m){return function(){ths.handleMarkerClick(map,m);};}(this,marker));mks[mks.length]=marker;}this.mapBounds=new google.maps.LatLngBounds(new google.maps.LatLng(lat_lo,lng_lo),new google.maps.LatLng(lat_hi,lng_hi));this.markerArr[metricIx]=mks;return mks;},handleMarkerClick:function(map,marker){if(this.openedInfoWindow){this.openedInfoWindow.close();this.openedInfoWindow=null;}this.openInfoWindow(map,marker);this.postHandleMarkerClick(map,marker);},postHandleMarkerClick:mstrmojo.emptyFn,getMetricBubble:function getMetricBubble(metricItem,lbl,latLng,index,metricIx){var d=this.gridData,mValues=d.gvs.items,maxVal=this.bubblesMaxInfo[metricIx],mv=parseFloat(metricItem.items[metricIx].rv),color="red",bubbleRange=Math.abs(this.maxBubbleSize-this.minBubbleSize);if(!maxVal){for(var i in mValues){var item=mValues[i].items[metricIx],v=parseFloat(item.rv)||0;if(!maxVal){maxVal=v;}maxVal=Math.max(maxVal,v);}this.bubblesMaxInfo[metricIx]=maxVal;}if(this.attrThresholds=="1"&&(typeof metricItem.items[metricIx].ty!=="undefined")){var ty=metricItem.items[metricIx].ty;if(ty==2){color=d.th[metricItem.items[metricIx].ti].n;}else{color="#FFF";}}return new CustomMarker(lbl,latLng,this.minBubbleSize+Math.round((mv/maxVal)*bubbleRange),index,color);},openInfoWindow:function(map,marker){var ix=marker._ix,w=this.getInfoWindow(map,marker);if(w){this.openedInfoWindow=w;w.open(map,marker);}},getInfoWindow:function(map,marker){return this.getDefaultInfoWindow(this.gridData,marker);},getDefaultInfoWindow:function getDefaultInfoWindow(d,marker){var ix=marker._ix,mLabels=[],mValues=d.gvs.items,res=document.createElement("div"),innerHTML='<table><tbody><tr><td colspan="2" class="androidMap-infoWindowTitle" style="padding-right: 20px">'+marker.title+"</td></tr>";if(d.gts.col.length!=0){mLabels=d.gts.col[0].es;}for(var i in mLabels){var item=mValues[ix].items[i];if(item.ts==4){var path=item.v;if(path.indexOf("http")!==0){path="../"+path;}innerHTML+='<tr><td class="androidMap-infoWindowText">'+mLabels[i].n+'</td><td><img src="'+path+'"></td></tr>';}else{var fColor="black",bColor="white";if(d.th&&this.attrThresholds=="1"&&(typeof item.ti!=="undefined")){fColor=d.th[item.ti].n;}innerHTML+='<tr><td class="androidMap-infoWindowText">'+mLabels[i].n+'</td><td style="background-color:'+bColor+";color:"+fColor+';">'+item.v+"</td></tr>";}}innerHTML+="</tbody></table>";res.innerHTML=innerHTML;return new google.maps.InfoWindow({content:res});},touchBegin:function(touch){touch.stop();return false;},rebuildLayout:mstrmojo.emptyFn,setDimensions:function setDimensions(h,w){var map=this.googleMap,center=map?map.getCenter():null,dimensionChanged=this._super(h,w);if(map){this.map.style.height=this.getHeight()+"px";this.map.style.width=(this.getWidth()-1)+"px";map.setCenter(center);}return dimensionChanged;},unrender:function unrn(ignoreDom){if(this.googleMap){delete this.googleMap;}this._super(ignoreDom);},destroy:function destroy(){if(this.googleMap){delete this.googleMap;}this._super();}});})();