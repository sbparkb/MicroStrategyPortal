(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.Container","mstrmojo.Label","mstrmojo.hash","mstrmojo.func","mstrmojo.dom","mstrmojo.maps.jsmap.InfoWindow","mstrmojo.maps.jsmap.InfoWindowController","mstrmojo.MobileDoc","mstrmojo.MobileDocBuilder","mstrmojo.DocModel","mstrmojo.android.ViewFactory","mstrmojo.MobileConfiguration","mstrmojo._CanMakeServerProxyRequests");var $DOM=mstrmojo.dom;function handleError(res,app){var msg=[],map={name:"Exception",message:"Error",sourceURL:"Source URL",fileName:"File",lineNumber:"Line",line:"Line",method:"Method"};res=res||{};mstrmojo.hash.forEach(map,function(v,n){if(n in res){msg.push(v+": "+res[n]);}});if(res.getResponseHeader){msg.push("XHR: "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}msg=msg.join("\n");if(app&&app.rootView){app.rootView.hideMessage();}if(!res.handledError&&msg.length>0){mstrmojo.alert(msg);res.handledError=true;}mstrmojo.dbg(res.stack||msg);}function onWindowError(errMsg,fName,lineNum){handleError({message:errMsg,fileName:fName,lineNumber:lineNum});}function _getDocParams(dd){return{ab:dd.ab,did:dd.did,st:dd.st,ttl:dd.ttl};}function _getDocModel(dd){return{mid:dd.mid,bs:dd.bs,defn:dd.defn,data:dd.data};}mstrmojo.maps.jsmap.InfoWindowApp=mstrmojo.declare(mstrmojo.Obj,[mstrmojo._CanMakeServerProxyRequests],{scriptClass:"mstrmojo.maps.jsmap.InfoWindowApp",init:function init(props){this._super(props);var fn=window.onerror;window.onerror=(fn)?mstrmojo.func.composite([onWindowError,fn]):onWindowError;this.handleError=handleError;},start:function start(){if(!this.onMobileDevice()){mstrMobileApp.saveConfiguration(mstrMobileApp.getConfiguration());}mstrMobileApp.setBinaryFormat(this.getConfiguration().getBinaryMode());this.useBinaryFormat=mstrMobileApp.useBinaryFormat();var vw=this.rootView=new mstrmojo.Container({id:"rootView",placeholder:this.placeholder,markupString:'<div id="{@id}" style="{@cssText}"><div></div><div></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;},msgNode:function(){return this.domNode.lastChild;}},children:[{scriptClass:"mstrmojo.Container",slot:"containerNode",alias:"rootContainer",markupString:"<div></div>"},{scriptClass:"mstrmojo.Label",alias:"msg",slot:"msgNode",text:"Loading...",visible:true}],showMessage:function(text){var msg=text||this.msg.text,msgNode=msg.domNode,msgNodeStyle=msgNode.style;msgNode.innerText=msg;msgNodeStyle.display="block";msgNodeStyle.opacity=1;},hideMessage:function hideMessage(){this.msg.domNode.style.opacity=0;}});vw.render();var ctlr=this.rootController=new mstrmojo.maps.jsmap.InfoWindowRootController({id:"rootController",firstView:vw}),docParams,docModel;if(this.isDoc){var dd=this.getDocData();docParams=_getDocParams(dd);docModel=_getDocModel(dd);}ctlr.start({placeholder:this.placeholder,rowIndex:this.rowIndex,isDoc:this.isDoc,docParams:docParams,docModel:docModel,model:this.getModel(),sc:this.sc});},loadNewDoc:function(rowIndex){var dd=this.getDocData(),docParams=_getDocParams(dd),docModel=_getDocModel(dd);this.rootController.nextController.restart({placeholder:this.placeholder,rowIndex:rowIndex,isDoc:true,docParams:docParams,docModel:docModel,model:this.getModel()});},getDocData:function(){return eval("("+mapDataObj.getDocData()+")");},getModel:function(){return eval("("+mapDataObj.getGridData()+")");},getConfiguration:function getConfiguration(){if(!this._cfg){this._cfg=new mstrmojo.MobileConfiguration();}return this._cfg;},showMessage:function showMessage(msg){this.rootView.showMessage(msg);},hideMessage:function hideMessage(){this.rootView.hideMessage();},update:function(rowIndex){this.rootController.nextController.update(rowIndex);},onMobileDevice:function onMobileDevice(){return !mstrApp.isHosted();},isTouchApp:function isTouchApp(){return($DOM.isIPad||$DOM.isAndroid||mstrApp.onMobileDevice());},onerror:function onerror(res){handleError(res,this);},isHosted:function isHosted(){return mstrMobileApp.isProxy;}});}());