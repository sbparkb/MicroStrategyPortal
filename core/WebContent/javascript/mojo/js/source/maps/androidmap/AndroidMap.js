(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.hash","mstrmojo.GeoLocation","mstrmojo._TouchGestures");var GD_SEP="\u001F",GR_SEP="\u001E",GC_SEP="\u001D",GI_SEP="\u001C",GV_SEP="\u001B";function togglePreviewCtrl(preview,opacity){if(!!preview&&!!preview.imgNode){var imgNodeStyle=preview.imgNode.style;imgNodeStyle.opacity=opacity;}}var PREVIEW_CLS_NAME=mstrmojo.Image.baseCssClass+"-prv";mstrmojo.maps.androidmap.AndroidMap=mstrmojo.declare(mstrmojo.Vis,null,{scriptClass:"mstrmojo.maps.androidmap.AndroidMap",cssClass:"mstr-googleMapView",markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" style="{@domNodeCssText}" mstrAttach:touchstart></div>',reRenderOnDimensionChg:false,mapRendered:false,firstScreen:true,children:[{scriptClass:"mstrmojo.Image",alias:"imgPreview",cssClass:"prv",cssText:"position:absolute;left:0;top:0;",firstLoad:false,onload:function(){togglePreviewCtrl(this,1);var ths=this;window.setTimeout(function(){ths.parent.postImageProcessing(ths.firstLoad);ths.firstLoad=false;},300);}}],markupSlots:{containerNode:function(){return this.domNode;}},markupMethods:{onheightChange:function(){this.domNode.style.height=this.getHeight()+"px";},onwidthChange:function(){this.domNode.style.width=this.getWidth()+"px";}},setModel:function setModel(model){this.set("model",model);this.xtabModel=model;if(model.data){this.set("gridData",model.data);}},postImageProcessing:function postImageProcessing(firstLoad){if(firstLoad&&this.controller&&this.controller.takeScreenShot){this.controller.takeScreenShot();}if(this.imgPreview.src!=""&&mstrMobileApp&&mstrMobileApp.hideMapView){window.setTimeout(function(){mstrMobileApp.hideMapView(0);},100);}},ongridDataChange:function(){this.parser=new mstrmojo.Vis.DataParser(this.gridData);delete this.dataMap;},update:function update(node){node=node||this.node;if(node){if(node.data){this.set("gridData",node.data);var gd=this.gridData;if(gd.layoutModel){this.layoutModel=gd.layoutModel;}if(gd.layoutNode){this.layoutNode=gd.layoutNode;}delete gd.layoutModel;delete gd.layoutNode;}var fmts=node.defn.fmts||node.defn.units[this.xtabModel.k].fmts;this.width=parseInt(fmts.width,10);this.height=parseInt(fmts.height,10);this.top=parseInt(fmts.top,10);this.left=parseInt(fmts.left,10);this.fmts=fmts;}if(this.xtabModel){this.initFromVisProps(this.gridData.vp);}this.updated=true;},getMapModel:function(){var pid=mstrApp.getCurrentProjectId(),sessions=mstrApp.serverProxy.getSessions();return{pid:pid,sessions:sessions,mapId:this.id,hasTarget:false,hostUrl:mstrApp.getConfiguration().getHostUrlByProject(pid)};},getGridModel:function(){var gridModel=mstrmojo.hash.copy(this.gridData,{});return gridModel;},initFromVisProps:function initFromVisProps(vp){this.vp=vp;},dispatchMapData:function dispatchMapData(){var mapModel=this.getMapModel(),gd=this.simplifyGridData();mstrMobileApp.loadMap(JSON.stringify(mstrmojo.hash.copy(mapModel,{gdProp:gd.prop,infoWindow:{dft:true}})),gd.es,gd.data,"");this.mapRendered=true;},simplifyGridData:function simplifyGridData(){if(this.dataMap){return this.dataMap;}var gd=this.gridData,ghs=[],gvs=[],gts={row:[],col:[]},o,row,col,ges=[],res=[],ces=[],rd=[],items=[],cv,ritems,citems,i,iLen,j,jLen;if(typeof (gd.ghs)=="undefined"||(gd.gts.row.length==0)){gd.eg="no data returned";}if(gd.eg){this.dataMap={prop:{},data:"",es:""};}else{for(i=0,ritems=gd.ghs.rhs.items,iLen=ritems.length;i<iLen;i++){for(j=0,citems=ritems[i].items,jLen=citems.length;j<jLen;j++){rd.push(citems[j].idx);}ghs.push(rd.join(GC_SEP));rd=[];}for(i=0,ritems=gd.gvs.items,iLen=ritems.length;i<iLen;i++){for(j=0,citems=ritems[i].items,jLen=citems.length;j<jLen;j++){items.push(citems[j].v);items.push(citems[j].rv||0);if(citems[j].ti!==undefined||citems[j].ts!==undefined){v="";if(citems[j].ti!==undefined){gd.th[citems[j].ti].ty=citems[j].ty;v=citems[j].ti;}v+=GV_SEP;if(citems[j].ts!==undefined){v+=citems[j].ts;}items.push(v);}rd.push(items.join(GI_SEP));items=[];}gvs.push(rd.join(GC_SEP));rd=[];}row=gd.gts.row;mstrmojo.array.forEach(row,function(v){o={};mstrmojo.hash.copyProps(["n","id","fid","fs","sc"],v,o);gts.row.push(o);rd=[];mstrmojo.array.forEach(v.es,function(elem){rd.push(elem.n);});res.push(rd.join(GI_SEP));});ges.push(res.join(GR_SEP));col=gd.gts.col;mstrmojo.array.forEach(col,function(v){o={};mstrmojo.hash.copyProps(["n","id","fid"],v,o);gts.col.push(o);rd=[];mstrmojo.array.forEach(v.es,function(elem){rd.push(elem.n);});ces.push(rd.join(GI_SEP));});ges.push(ces.join(GR_SEP));this.dataMap={prop:{vp:gd.vp,th:gd.th,gts:gts},es:ges.join(GD_SEP),data:ghs.join(GR_SEP)+GD_SEP+gvs.join(GR_SEP)};}return this.dataMap;},getModel:function getModel(){return this.gridData;},handleMarkerSelection:mstrmojo.emptyFn,postBuildRendering:function postBuildRendering(){this.dispatchMapData();this._super();},rebuildLayout:mstrmojo.emptyFn,resetLayout:mstrmojo.emptyFn,setDimensions:function setDimensions(h,w){var map=this.googleMap,center=map?map.getCenter():null,dimensionChanged=this._super(h,w);if(map){this.map.style.height=this.getHeight()+"px";this.map.style.width=(this.getWidth()-1)+"px";map.setCenter(center);}return dimensionChanged;},unrender:function unrender(){this.imgPreview.src="";if(this.mapRendered){this.removeMap();this.mapRendered=false;}this._super();},removeMap:function removeMap(){mstrMobileApp.hideMapView("1");},switchToImage:function switchToImage(src,width,height){var imgPreview=this.imgPreview;imgPreview.firstLoad=this.firstScreen;this.firstScreen=false;if(src&&imgPreview.hasRendered){if(imgPreview.src!==src){togglePreviewCtrl(imgPreview,0);imgPreview.domNode.className=PREVIEW_CLS_NAME;imgPreview.set("src",src);imgPreview.set("width",width);imgPreview.set("heihgt",height);}else{if(mstrMobileApp&&mstrMobileApp.hideMapView){togglePreviewCtrl(this.imgPreview,1);this.postImageProcessing(false);}}}else{mstrMobileApp.hideMapView(0);}},hidePreview:function hidePreview(){togglePreviewCtrl(this.imgPreview,0);},showPreview:function showPreview(){togglePreviewCtrl(this.imgPreview,1);},closeInfoWindow:function closeInfoWindow(){do{mstrApp.closeDialog();}while(mstrmojo.all.mstrMapInfoWindow);},ontouchstart:function ontouchstart(){if(this.mapRendered){mstrMobileApp.showMapView(0);}},destroy:function destroy(){var p=this.parent;while(p){if(p._scroller&&p.scrollMoveListener){}p=p.parent;}this._super();if(this.mapRendered){mstrMobileApp.navigateAway();}}});}());