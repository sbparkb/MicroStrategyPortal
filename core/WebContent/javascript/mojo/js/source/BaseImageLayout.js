(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo._ShowDataLabel","mstrmojo.color","mstrmojo.array","mstrmojo.css","mstrmojo.url","mstrmojo.dom","mstrmojo.num","mstrmojo.imagelayout.ImageLayoutPropertyManager","mstrmojo.gm.GMEnums");var $DOM=mstrmojo.dom,$NUM=mstrmojo.num,$ARRAY=mstrmojo.array,browserSupportsHtml5=true,$ENUM_LINE_STYLE=mstrmojo.gm.EnumCombinedLineStyle,PROPERTIES_TYPE=mstrmojo.VisEnum.IMAGELAYOUT_PROPERTIES;function getTime(){var a=new Date(),y=a.getYear()+"-",m=a.getMonth()+"-",d=a.getDay()+"-",h=a.getHours()+"-",x=a.getMinutes()+"-",s=a.getSeconds()+"-",ms=a.getMilliseconds();return(y+m+d+h+x+s+ms);}function getLighterColor(c){var rgb=mstrmojo.color.hex2rgb(c);$ARRAY.forEach(rgb,function(v,idx){rgb[idx]=Math.floor(v*0.75);});return"rgb("+rgb.join(",")+")";}function positionTooltip(tooltip,touchX,touchY){var tooltipStyle=tooltip.style,translateValue="translate("+touchX+"px, "+touchY+"px)",translateValue3d=translateValue.replace("late(","late3d(").replace("px)","px, 0)");tooltipStyle.MozTransform=translateValue;tooltipStyle.msTransform=translateValue;tooltipStyle.webkitTransform=translateValue3d;tooltipStyle.transform=translateValue3d;}function drawPoly(ctx,coordsArray,offset,strokeColor,strokeWidth,fillColor,lineDashArray){try{var offsetX=offset?offset.x:0,offsetY=offset?offset.y:0;var pointsArray;var getPointAt=function(j){var offset=j%2?offsetY:offsetX;return pointsArray[j]+offset;};var i,j;for(i=0;i<coordsArray.length;i++){pointsArray=coordsArray[i];ctx.beginPath();ctx.moveTo(getPointAt(0),getPointAt(1));for(j=2;j<pointsArray.length-1;j=j+2){var xx=getPointAt(j),yy=getPointAt(j+1);ctx.lineTo(xx,yy);}var x=getPointAt(0),y=getPointAt(1),fillStyle=fillColor;ctx.lineTo(x,y);ctx.fillStyle=fillStyle;ctx.fill();ctx.strokeStyle=strokeColor;ctx.lineWidth=strokeWidth;if(ctx.setLineDash){ctx.setLineDash(lineDashArray||[]);}if(strokeWidth>0){ctx.stroke();}}}catch(e){}}function drawBubble(context,pt,offset,color,radius){context.fillStyle=color;context.beginPath();context.arc(pt[0]+offset.x,pt[1]+offset.y,radius,0,Math.PI*2,true);context.closePath();context.fill();}function drawStroke(context,pt,offset,color,radius,strokeWidth,lineDashArray){context.strokeStyle=color;context.lineWidth=strokeWidth;if(context.setLineDash){context.setLineDash(lineDashArray||[]);}context.beginPath();context.arc(pt[0]+offset.x,pt[1]+offset.y,radius,0,Math.PI*2,true);context.closePath();if(strokeWidth>0){context.stroke();}}function getPolygonCenter(pointsArr){var sumX=0,sumY=0,i;for(i=0;i<pointsArr.length;i++){sumX=sumX+pointsArr[i];i++;sumY=sumY+pointsArr[i];}var centerX=sumX/(pointsArr.length*2),centerY=sumY/(pointsArr.length*2),center1=[centerX,centerY],center2=[];center2.push(center1);return center2;}function getCentroidOfPolygon(points){if(points===null||points.length<4){return null;}var area=0,len=points.length,i,px,py,p2x,p2y;for(i=0;i<len-2;i+=2){px=points[i];py=points[i+1];p2x=points[i+2];p2y=points[i+3];area+=(px*p2y-p2x*py);}px=points[len-2];py=points[len-1];p2x=points[0];p2y=points[1];area+=(px*p2y-p2x*py);area=Math.abs(area/2);if(area<=0){return null;}var centroid=[0,0];for(i=0;i<len-2;i+=2){px=points[i];py=points[i+1];p2x=points[i+2];p2y=points[i+3];centroid[0]+=((px+p2x)*(px*p2y-p2x*py));centroid[1]+=((py+p2y)*(px*p2y-p2x*py));}px=points[len-2];py=points[len-1];p2x=points[0];p2y=points[1];centroid[0]+=((px+p2x)*(px*p2y-p2x*py));centroid[1]+=((py+p2y)*(px*p2y-p2x*py));centroid=[Math.abs(centroid[0]/(area*6)),Math.abs(centroid[1]/(area*6))];var two_dim_centroid=[];two_dim_centroid.push(centroid);return two_dim_centroid;}function calcPolygonCenters(coords){var polygonCenters={},i;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}polygonCenters[i]=getCentroidOfPolygon(coords[i][0]);}}return polygonCenters;}function getOpacityColor(color,opacity){var opacityColor,i;var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(color){var colorNew;if(/^(rgba|RGBA)/.test(color)){var tempColor=color.replace(/rgba\(|RGBA\(/,"");tempColor=tempColor.replace(")","");colorNew=tempColor.split(",");opacityColor="RGBA("+colorNew[0]+","+colorNew[1]+","+colorNew[2]+","+opacity+")";}else{if(/^(rgb|RGB)/.test(color)){colorNew=color.replace(/rgb\(|RGB\(/,"");colorNew=colorNew.replace(")","");opacityColor="RGBA("+colorNew+","+opacity+")";}else{if(reg.test(color)){if(color.length===4){colorNew="#";for(i=1;i<4;i++){colorNew+=color.slice(i,i+1).concat(color.slice(i,i+1));}color=colorNew;}var colorChange=[];for(i=1;i<7;i+=2){colorChange.push(parseInt("0x"+color.slice(i,i+2),16));}colorChange.push(opacity);opacityColor="RGBA("+colorChange.join(",")+")";}else{opacityColor=color;}}}}else{opacityColor=null;}return opacityColor;}function drawWhiteRectCorner(hlContext,xOffset,yOffset,width,height){hlContext.strokeStyle="#FFF";hlContext.lineWidth=2;hlContext.beginPath();hlContext.moveTo(xOffset+width*0.25,yOffset);hlContext.lineTo(xOffset,yOffset);hlContext.lineTo(xOffset,yOffset+height*0.25);hlContext.moveTo(xOffset,yOffset+height*0.75);hlContext.lineTo(xOffset,yOffset+height);hlContext.lineTo(xOffset+width*0.25,yOffset+height);hlContext.moveTo(xOffset+width*0.75,yOffset+height);hlContext.lineTo(xOffset+width,yOffset+height);hlContext.lineTo(xOffset+width,yOffset+height*0.75);hlContext.moveTo(xOffset+width,yOffset+height*0.25);hlContext.lineTo(xOffset+width,yOffset);hlContext.lineTo(xOffset+width*0.75,yOffset);hlContext.stroke();hlContext.closePath();}function getWebServerUrl(isTablet){var webServerUrl=null;if(isTablet){if(mstrApp!==undefined&&mstrApp.getConfiguration){webServerUrl=mstrApp.getConfiguration().getCurrentProjectWebServerUrl();}}else{var href=document.location&&document.location.href;if(href){var hrefLowerCase=href.toLowerCase();var servletReg="/servlet/",aspReg="/asp/";var servletIndex=hrefLowerCase.indexOf(servletReg),aspIndex=hrefLowerCase.indexOf(aspReg);if(servletIndex>=0){if(aspIndex<0){webServerUrl=href.substr(0,servletIndex+1);}else{if(aspIndex>=0){var index=(servletIndex>aspIndex)?aspIndex:servletIndex;webServerUrl=href.substr(0,index+1);}}}else{if(servletIndex<0){if(aspIndex>=0){webServerUrl=href.substr(0,aspIndex+1);}}}}}return webServerUrl;}mstrmojo.BaseImageLayout=mstrmojo.declare(mstrmojo.Widget,[mstrmojo._ShowDataLabel],{scriptClass:"mstrmojo.BaseImageLayout",model:null,controller:null,xtabModel:null,mapScaleFactor:1,width:700,height:500,top:0,left:0,totalWidget:null,mapFileIndex:-1,areaBubbleAttrElems:null,startLine:-1,endLine:-1,browserSupportsHtml5:true,hasDrawnMap:undefined,markupString:'<div id="{@id}" class="mstrmojo-Chart {@cssClass}" style="position:absolute;width:{@width}px;height:{@height}px;top:{@top}px;left:{@left}px;overflow:hidden;"  ><div id="{@id}-scroll-element" style="position:absolute;left:0;top:0;width:{@width};height={@height}"><canvas id="{@id}-highlightCanvas" style="position:absolute;left:0;top:0;z-index:1" width="{@width}" height="{@height}"></canvas><canvas id="{@id}-animationCanvas" style="position:absolute;left:0;top:0" width="{@width}" height="{@height}"></canvas></div><div id="{@id}-tooltip" style="z-index:2" class="mstrmojo-BaseImageLayout-tooltip" clk="clk"><table style="margin:5px 7px"></table></div><div id="{@id}-infowindow-anchor" style="position:absolute;width:18px;height:18px;display:block;z-index:-1;"></div><div id="{@id}-css" style="display:none"></div><div id="{@id}-errMsg"></div></div>',markupSlots:{scrollableCanvasDiv:function(){return this.domNode.childNodes[0];},highlightCanvas:function(){return this.domNode.childNodes[0].firstChild;},animationCanvas:function(){return this.domNode.childNodes[0].lastChild;},tooltip:function(){return this.domNode.childNodes[1];},infowinAnchor:function(){return this.domNode.childNodes[2];},cssDiv:function(){return this.domNode.childNodes[3];},errorMessage:function(){return this.domNode.childNodes[4];}},init:function init(props){this.areaBubbleAttrElems={};if(this._super){this._super(props);}},preBuildRendering:function(){this.start=new Date();this.renderTime=0;if(this._super){this._super();}},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}var me=this;browserSupportsHtml5=me.highlightCanvas.getContext;if(!browserSupportsHtml5){me.renderErrorMessage(mstrmojo.desc(8126,"Your browser does not support HTML5"));return ;}me.newRenderFlag=true;me.prepareAreaBubbleAttrElems();me.highlightContext=me.highlightCanvas.getContext("2d");me.animationContext=me.animationCanvas.getContext("2d");this.end=new Date();this.renderTime=this.end-this.start;this.hasDrawnMap=false;},getMapAndDraw:function(){var me=this,beforeSvRqt,xhrCfg,DebugFlag=me.CONSTANTS.DEBUG;if(!me.coords){if(DebugFlag.LOG){console.log("\ndownload new coords");}if(DebugFlag.PERFORMANCE){beforeSvRqt=new Date();}var totalWidget=me.totalWidget,propertyManager=totalWidget.propertyManager,mapFileName,mapFilePool=totalWidget.mapFilePool;if(totalWidget&&totalWidget.hasMultiAttr){mapFileName=totalWidget.getMapFilePath(me.mapFileIndex);}else{mapFileName=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.MAP_FILE_PATH);}if(!mapFileName){var selectCorrectMap=function(){if(me.areaBubbleAttrElems){var mapFilePool=totalWidget.mapFilePool,mapFile,mapFilePath,mapFileElems,attrElems=$ARRAY.ensureArray(Object.keys(me.areaBubbleAttrElems)),match=function(attrElems,mapFileElems){var len=(attrElems&&attrElems.length)||0,i,attrElem;for(i=0;i<len;i++){attrElem=attrElems[i];if(mapFileElems.indexOf(attrElem)===-1){return false;}}return true;};if(attrElems.length>0){for(mapFilePath in mapFilePool){mapFile=mapFilePool[mapFilePath];mapFileElems=$ARRAY.map($ARRAY.ensureArray(Object.keys(mapFile)),function(mapFileElem){return mapFileElem.toLowerCase();});if(match(attrElems,mapFileElems)){window.setTimeout(function(){propertyManager.setFormatPropertyValue(PROPERTIES_TYPE.MAP_FILE_PATH,mapFilePath);},0);return ;}}}}me.renderMessage(mstrmojo.desc(14667,me.CONSTANTS.MESSAGE.NO_SHAPE_FILE));};if(totalWidget.allShapeFileLoaded){selectCorrectMap();}else{xhrCfg={failure:function(res){me.renderMessage(mstrmojo.desc(14667,me.CONSTANTS.MESSAGE.NO_SHAPE_FILE));},success:function(res){selectCorrectMap();}};totalWidget.getAllShapeFileCoordsWithXHR(xhrCfg);}}else{me.mapFileName=mapFileName;if(mapFilePool.hasOwnProperty(mapFileName)){me.coords=mapFilePool[mapFileName];me.initDrawMapWithCoords();}else{if(me.mapFileIndex>=me.totalWidget.firstSuccessLoadedMapFileIndex){xhrCfg={success:function(res){if(!me.hasRendered){return ;}if(DebugFlag.TOUCH_WHILE_LOADING){console.log("mapFileIndex: "+me.mapFileIndex+" receive success Time: "+getTime());}me.isMapLoadFailed=false;if(DebugFlag.PERFORMANCE){var afterSvRqt=new Date();console.log("\nSvRqt time: "+(afterSvRqt-beforeSvRqt));}var coords=mapFilePool[me.mapFileName];if(coords){me.coords=coords;me.initDrawMapWithCoords();}else{me.isMapLoadFailed=true;me.renderErrorMessage(mstrmojo.desc(9854,me.CONSTANTS.MESSAGE.SHAPE_FILE_NOT_FOUNT));}},failure:function(res){if(!me.hasRendered){return ;}me.isMapLoadFailed=true;me.renderErrorMessage(mstrmojo.desc(9854,me.CONSTANTS.MESSAGE.SHAPE_FILE_NOT_FOUNT));}};totalWidget.getShapeFileCoordsWithXHR(mapFileName,xhrCfg);}else{me.isMapLoadFailed=true;me.renderErrorMessage(mstrmojo.desc(9854,me.CONSTANTS.MESSAGE.SHAPE_FILE_NOT_FOUNT));}}}}else{me.drawMap();me.highlightPoint();}this.hasDrawnMap=true;},initDrawMapWithCoords:function(){var me=this;me.totalWidget.adjustOffsets();window.setTimeout(function(){me.drawMap();if(!me.mapDataScreenshotTaken&&me.isTablet){me.mapDataScreenshotTaken=true;me.localTakeScreenshot(me.CONSTANTS.RENDERING_TIME);}},0);},getFullPath:function getFullPath(path){var fullPath="",reg=/^[A-z]:\/\//,baseUrl,baseUrlIdx;if(reg.test(path)){fullPath=path;}else{var tempReg1=/^(\.\.\/|\.\.\\)/;var tempReg2=/^(\.\/|\.\\)/;var tempReg3=/^(\/|\\)/;path=path.replace(tempReg1,"");path=path.replace(tempReg2,"");path=path.replace(tempReg3,"");if(mstrApp&&mstrApp.getConfiguration){if(mstrApp.isSingleTier){baseUrl=document.location&&document.location.href;baseUrlIdx=baseUrl&&baseUrl.indexOf("html/index.html");if(baseUrlIdx<0){console.log("error when get baseUrl: can't find html/index.html in href");return path;}fullPath=baseUrl.substr(0,baseUrlIdx)+path;}else{fullPath=mstrmojo.url.getAbsoluteURL(path,getWebServerUrl(this.isTablet));}}}return fullPath;},prepareAreaBubbleAttrElems:function prepareAreaBubbleAttrElems(){var me=this,mapFileIndex=me.mapFileIndex,totalWidget=me.totalWidget,mapLineScopes=totalWidget.mapLineScopes,layoutAttrIndex=totalWidget.layoutAttrIndex,areaBubbleAttrIndex=totalWidget.areaBubbleAttrIndex;function prepareData(mapFileIndex){if(mapLineScopes.length>mapFileIndex){var mapLineScope=mapLineScopes[mapFileIndex];me.startLine=mapLineScope.startLine;me.endLine=mapLineScope.endLine;me.areaBubbleAttrElems=mapLineScope.areaBubbleAttrElems;}}if(layoutAttrIndex>-1&&areaBubbleAttrIndex>-1){prepareData(mapFileIndex);}else{if(layoutAttrIndex===-1&&areaBubbleAttrIndex>-1){mapFileIndex=0;prepareData(mapFileIndex);}}},getWidth:function getWidth(){return parseInt(this.width,10);},getHeight:function getHeight(){return parseInt(this.height,10);},touchSwipeBegin_mouseDown:function touchSwipeBegin_mouseDown(touch){this.hideTooltip();},getLastHighlightPoint:function gtLstHighlightPnt(){return this.totalWidget.currHoverObj||null;},getTouchedObj:function getTouchedObj(isTap,touchX,touchY){var me=this,touchedObj=null,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,displayMode=me.displayMode;if(displayMode===DISPLAY_MODE.AREA){touchedObj=this.getAreaOrNearestBubble(isTap,touchX,touchY);}else{if(displayMode===DISPLAY_MODE.BUBBLE){touchedObj=this.getLastHighlightPoint();var touchPointInHighlightArea=false,tx=0,ty=0;if(touchedObj){tx=touchedObj.point.x;ty=touchedObj.point.y;touchPointInHighlightArea=this.totalWidget.tooltipOn&&(tx-touchX)*(tx-touchX)+(ty-touchY)*(ty-touchY)<=this.totalWidget.bias*this.totalWidget.bias;}if(touchPointInHighlightArea){me.hideTooltip();touchedObj=this.getLastHighlightPoint();}else{touchedObj=this.getAreaOrNearestBubble(isTap,touchX,touchY);}}}return touchedObj;},inPoly:function inPoly(poly,px,py){var npoints=poly.length,inside=false,xnew,ynew,xold,yold,x1,y1,x2,y2,i;if(npoints/2<3){return false;}if(npoints%2===1){npoints-=1;}xold=poly[npoints-2];yold=poly[npoints-1];for(i=0;i<npoints;i=i+2){xnew=poly[i];ynew=poly[i+1];if(xnew>xold){x1=xold;x2=xnew;y1=yold;y2=ynew;}else{x1=xnew;x2=xold;y1=ynew;y2=yold;}if((xnew<px)===(px<=xold)&&((py-y1)*(x2-x1)<(y2-y1)*(px-x1))){inside=!inside;}xold=xnew;yold=ynew;}return inside;},localTakeScreenshot:function localTakeScreenshot(_time){var me=this;window.setTimeout(function(){var ctrlID=me.controller.id;var ctrl=mstrmojo.all[ctrlID];if(ctrl&&ctrl.rootCtrl.getCurrent()===ctrl){ctrl.takeScreenShot();}},_time);},renderErrorMessage:function renderErrorMessage(errorMessage){var me=this,msgDiv=me.errorMessage,newErrorMessage=errorMessage.replace(/-/g,"<br />-");msgDiv.className="mstrmojo-imagelayout-errmsg";msgDiv.innerHTML=newErrorMessage;msgDiv.style.width=me.getWidth()+"px";msgDiv.style.fontSize=me.totalWidget.errMsgFontSize+"px";msgDiv.style.fontFamily="Tahoma";msgDiv.style.color=me.CONSTANTS.ERROR_MSG_FONT_COLOR.DARK_THEME;msgDiv.style.backgroundColor="RGBA(0,0,0,0)";me.themeMode=me.totalWidget?me.totalWidget.themeMode:me.CONSTANTS.THEME.DARK;if(me.themeMode===me.CONSTANTS.THEME.LIGHT){msgDiv.style.color=me.CONSTANTS.ERROR_MSG_FONT_COLOR.LIGHT_THEME;}},renderMessage:function renderMessage(errorMessage){var me=this,msgDiv=me.errorMessage,newErrorMessage=errorMessage.replace(/-/g,"<br />-");msgDiv.className="mstrmojo-imagelayout-msg";msgDiv.innerHTML=newErrorMessage;},getLineIndexFromTouchValue:function getLineIndexFromTouchValue(touchValue){var lineIndex=-1,areaBubbleAttrElems=this.areaBubbleAttrElems;if(touchValue&&areaBubbleAttrElems){touchValue=touchValue.toLowerCase();if(areaBubbleAttrElems.hasOwnProperty(touchValue)){lineIndex=areaBubbleAttrElems[touchValue].lineIndex;}}return lineIndex;},drawMap:function drawMap(){var me=this,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE;me.animationCanvas.width=me.animationCanvas.width;me.highlightCanvas.width=me.highlightCanvas.width;if(!me.hasOwnProperty("markerType")){me.markerType=me.CONSTANTS.MARKER_TYPE.UNDEFINED;}if(!me.hasOwnProperty("shapeFileType")){me.shapeFileType=me.CONSTANTS.SHAPE_FILE_TYPE.UNDEFINED;}if(!me.hasOwnProperty("colorByIndex")){me.colorByIndex=-1;}if(!me.hasOwnProperty("sizeByIndex")){me.sizeByIndex=-1;}if(!me.hasOwnProperty("drawBgImageFlag")){me.drawBgImageFlag=false;}if(!me.hasOwnProperty("thresholdType")){me.thresholdType=me.CONSTANTS.THRESHOLD_TYPE.UNDEFINED;}if(!me.hasOwnProperty("curPolygonOpacity")){me.curPolygonOpacity=me.CONSTANTS.POLYGON_OPACITY.NORMAL;}if(!me.hasOwnProperty("touchSelectWithIfw")){me.touchSelectWithIfw=false;}if(me.totalWidget){me.themeMode=me.totalWidget.themeMode;me.bgColor=me.totalWidget.bgColor;}else{me.themeMode=me.CONSTANTS.THEME.DARK;me.bgColor=me.CONSTANTS.DEFAULT_BG_COLOR;}me.setDisplayParas();if(me.displayMode===DISPLAY_MODE.AREA){me.drawAreaMap();}else{if(me.displayMode===DISPLAY_MODE.BUBBLE){me.drawBubbleMap();}}},getIndexById:function getIndexById(id){var me=this,gtsCol=me.totalWidget.getGtsCol(),gtsColEle=null,i;if(gtsCol&&gtsCol.length>0&&gtsCol[0].hasOwnProperty("es")){gtsColEle=me.totalWidget.getFirstColElems();for(i=0;i<gtsColEle.length;i++){if(gtsColEle[i].oid===id){return i;}}}return -1;},getShapeFileType:function getShapeFileType(coords){var me=this,shapeFileType=me.CONSTANTS.SHAPE_FILE_TYPE.UNDEFINED;if(coords){var elem;for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}if(coords[elem][0]){if(coords[elem][0].length===2){shapeFileType=me.CONSTANTS.SHAPE_FILE_TYPE.POINT;}else{if(coords[elem][0].length>2){shapeFileType=me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON;}}}}}}return shapeFileType;},setDisplayParas:mstrmojo.emptyFn,scalePolygonCoords:function scalePolygonCoords(){var me=this,coords=me.coords,oriCoords=me.oriCoords;var maxX=0,maxY=0,rgn,oriRgn,c,oriC,i,j,k;for(i in oriCoords){if(oriCoords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=oriCoords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];for(k=0;k<c.length;k++){if(c[k]>maxX){maxX=c[k];}k++;if(c[k]>maxY){maxY=c[k];}}}}}}var xRatio=maxX/(this.getWidth()-10),yRatio=maxY/(this.getHeight()-10),ratio=Math.max(yRatio,xRatio);this.topOffset=(this.getHeight()-maxY/ratio)/2;this.leftOffset=(this.getWidth()-maxX/ratio)/2;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=coords[i];oriRgn=oriCoords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];oriC=oriRgn[j];for(k=0;k<c.length;k++){c[k]=parseInt(oriC[k]/ratio,10);}}}}}},getBubbleColorFromName:function getBubbleColorFromName(elem,noColorByColor){var me=this,model=me.model,allBubblesColor=model.allBubblesColor,lineIndex=me.getLineIndexFromTouchValue(elem),color;if(lineIndex>-1&&allBubblesColor&&allBubblesColor.hasOwnProperty(lineIndex)){color=allBubblesColor[lineIndex];}else{color=noColorByColor;}return color;},drawPolygonInMap:function drawPolygonInMap(opacity,isBGMap){var me=this,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,DebugFlag=me.CONSTANTS.DEBUG,vp=me.totalWidget.getVp(),coords=me.coords,context=this.animationContext,elem,lineIndex=-1;me.animationCanvas.width=me.animationCanvas.width;if(me.drawBgImageFlag&&me.bgImg){me._drawBgImage(context);}me.curPolygonOpacity=opacity;var noAltColor=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.BLANK_MAP_COLOR),noColorByColor=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.SHAPE_FILL_COLOR),strokeColor=isBGMap?propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.BLANK_MAP_BORDER_COLOR):propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.SHAPE_BORDER_COLOR);if(vp&&vp.npc&&!mstrApp.isVI){noAltColor=getOpacityColor("#"+vp.npc,me.CONSTANTS.POLYGON_OPACITY.NORMAL);}for(elem in coords){if(DebugFlag.PERFORMANCE){var begin=new Date();}if(!coords.hasOwnProperty(elem)){continue;}var clr=noAltColor;if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}clr=noAltColor;if(me.displayMode===DISPLAY_MODE.AREA){if(DebugFlag.PERFORMANCE){var beforeGHI=new Date();}var hdrIndex=this.getHeaderIndexFromTouchValue(elem);if(DebugFlag.PERFORMANCE){var afterGHI=new Date();}if(hdrIndex>=0){if(me.colorByIndex>=0){lineIndex=me.getLineIndexFromTouchValue(elem);clr=me.getBgColor(lineIndex,noColorByColor);if(me.drawBgImageFlag){clr=getOpacityColor(clr,me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG);}else{clr=getOpacityColor(clr,me.CONSTANTS.POLYGON_OPACITY.NORMAL);}}else{clr=noColorByColor;}}else{clr=noAltColor;}if(DebugFlag.PERFORMANCE){var afterGC=new Date();}}else{if(me.displayMode===DISPLAY_MODE.BUBBLE){clr=noAltColor;}}}clr=getOpacityColor(clr,opacity);if(DebugFlag.PERFORMANCE){var afterGO=new Date();}drawPoly(context,coords[elem],{x:this.leftOffset,y:this.topOffset},strokeColor,propertyManager.getFormatPropertyValue("shapeBorderWidth"),clr,propertyManager.getFormatPropertyValue("shapeBorderLineDash"));}},getRadiusFromName:function getRadiusFromName(name){var me=this;var radius=-1;if(me.coords.hasOwnProperty(name)){var bubbleSizeParas=me.totalWidget.getBubbleSizeParas();var maxRadius=bubbleSizeParas?bubbleSizeParas.maxRadius:0;if(me.hasOwnProperty("oriBubbleSize")){var oriBubbleSize=me.oriBubbleSize;var lineIndex=me.getLineIndexFromTouchValue(name);radius=(oriBubbleSize.hasOwnProperty(lineIndex)?oriBubbleSize[lineIndex]:maxRadius)*me.mapScaleFactor;}else{if(me.hasOwnProperty("maxRadius")){radius=maxRadius*me.mapScaleFactor;}else{radius=2;}}}return radius;},shouldDrawThisBubble:function(bubbleNodeName){var me=this,totalWidget=me.totalWidget,isDftSltObj=false;var lineIndex=me.getLineIndexFromTouchValue(bubbleNodeName);isDftSltObj=me.totalWidget.getShouldHighlightDefaultSelectedNodes()&&totalWidget.defaultSelectedObjs.hasOwnProperty(lineIndex);return bubbleNodeName!=="bgImage"&&(bubbleNodeName!==(totalWidget.currHoverObj&&totalWidget.currHoverObj.touchVal)||totalWidget.currHoverObjMiniChart!==me)&&(bubbleNodeName!==(totalWidget.currSelectedObj&&totalWidget.currSelectedObj.touchVal)||totalWidget.currSelectedObjMiniChart!==me)&&(bubbleNodeName!==(totalWidget.currLinkObj&&totalWidget.currLinkObj.touchVal)||totalWidget.currLinkObjMiniChart!==me)&&(!isDftSltObj);},getImageIconHeight:function(height){return height>this.CONSTANTS.MAX_IMAGE_ICON_SIZE.HEIGHT?this.CONSTANTS.MAX_IMAGE_ICON_SIZE.HEIGHT:height;},getImageIconWidth:function(width){return width>this.CONSTANTS.MAX_IMAGE_ICON_SIZE.WIDTH?this.CONSTANTS.MAX_IMAGE_ICON_SIZE.WIDTH:width;},drawBubblesInMap:function drawBubblesInMap(){var me=this,propertyManager=me.totalWidget.propertyManager,gvs=me.totalWidget.getGvs(),coords=me.coords,elem,hdrIndex,lineIndex=-1;if(me.hasOwnProperty("polygonCenters")){coords=me.polygonCenters;}me.highlightCanvas.width=me.highlightCanvas.width;var noColorByColor=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.SHAPE_FILL_COLOR),strokeColor=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.SHAPE_BORDER_COLOR);var defRadius=Math.max(2,Math.min(12,me.CONSTANTS.MAX_SIZE_DEFAULT_RATIO.SCATTER*0.15*Math.min(me.getWidth(),me.getHeight())));defRadius=defRadius*me.mapScaleFactor;var ths=me.totalWidget.getTh(),th=ths&&ths[me.colorByIndex];if(me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){var notFoundImageIconPath=me.getFullPath("images/image_not_found.jpg"),defaultImageIconPath=me.getFullPath("images/roundedpp.png");var drawImageIcon=function drawImageIcon(){var xOffset=coords[this.id][0][0]-me.getImageIconWidth(this.width)/2+me.leftOffset,yOffset=coords[this.id][0][1]-me.getImageIconHeight(this.height)/2+me.topOffset;me.animationContext.drawImage(this,xOffset,yOffset,me.getImageIconWidth(this.width),me.getImageIconHeight(this.height));};var setImageIconProps=function setImageIconProps(propName,elem,fullIconPath){me[propName]=new Image();me[propName].id=elem;me[propName].onload=function(){if(me.getImageIconWidth(this.width)<me.getWidth()&&me.getImageIconHeight(this.height)<me.getHeight()){drawImageIcon.call(this);if(me.totalWidget.getShouldHighlightDefaultSelectedNodes()&&me.totalWidget.defaultSelectedObjs.hasOwnProperty(me.getLineIndexFromTouchValue(this.id))){me.highlightCanvas.width=me.highlightCanvas.width;var dftSltObjLineIndex,dftSltObjs=me.totalWidget.defaultSelectedObjs;for(dftSltObjLineIndex in dftSltObjs){if(dftSltObjs.hasOwnProperty(dftSltObjLineIndex)){if(me.inThisWidget(dftSltObjLineIndex)){me.highlightImageIcon(me.highlightContext,coords,dftSltObjs[dftSltObjLineIndex].touchVal,0);}}}}}};me[propName].onerror=function(){var meIcon=this;window.setTimeout(function(){me["imageIcon_"+meIcon.id].src=notFoundImageIconPath;},0);};me[propName].src=fullIconPath;};for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}hdrIndex=me.getHeaderIndexFromTouchValue(elem);var propName="imageIcon_"+elem;if(me.hasOwnProperty(propName)){if(hdrIndex>-1){var _image=me[propName];if(_image&&_image.width&&_image.height&&me.getImageIconWidth(_image.width)<me.getWidth()&&me.getImageIconHeight(_image.height)<me.getHeight()){drawImageIcon.call(_image);}}else{delete me[propName];}}else{if(th&&hdrIndex>=0&&me.colorByIndex>=0&&me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.IMAGE){lineIndex=me.getLineIndexFromTouchValue(elem);var cellData=lineIndex>-1?gvs.items[lineIndex].items[me.colorByIndex]:null;if(cellData&&cellData.hasOwnProperty("ty")&&parseInt(cellData.ty,10)===4){var iconPath=th.length>cellData.ti&&th[cellData.ti].n;if(iconPath){var fullIconPath=me.getFullPath(iconPath);setImageIconProps(propName,elem,fullIconPath);}else{setImageIconProps(propName,elem,defaultImageIconPath);}}else{setImageIconProps(propName,elem,defaultImageIconPath);}}else{delete coords[elem];}}}}if(!me.imageIconScreenshotTaken&&me.isTablet){me.imageIconScreenshotTaken=true;me.localTakeScreenshot(me.CONSTANTS.RENDERING_TIME);}}else{if(me.markerType===me.CONSTANTS.MARKER_TYPE.BUBBLE){for(elem in coords){if(!coords.hasOwnProperty(elem)){continue;}if(!me.shouldDrawThisBubble(elem)){continue;}var bubbleColor=noColorByColor,bubbleRadius=defRadius;hdrIndex=me.getHeaderIndexFromTouchValue(elem);if(hdrIndex>=0){if(me.sizeByIndex>=0){bubbleRadius=me.getRadiusFromName(elem);}if(me.colorByIndex>=0&&me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.COLOR){bubbleColor=me.getBubbleColorFromName(elem,noColorByColor);}bubbleColor=getOpacityColor(bubbleColor,propertyManager.getFormatPropertyValue("shapeFillOpacity"));var offset={x:me.leftOffset,y:me.topOffset};drawBubble(me.highlightContext,coords[elem][0],offset,bubbleColor,bubbleRadius);drawStroke(me.highlightContext,coords[elem][0],offset,strokeColor,bubbleRadius,propertyManager.getFormatPropertyValue("shapeBorderWidth"),propertyManager.getFormatPropertyValue("shapeBorderLineDash"));}else{delete coords[elem];}}}}},inThisWidget:function inThisWidget(lineIndex){return lineIndex>=this.startLine&&lineIndex<=this.endLine;},getOriPolygonCoords:function getOriPolygonCoords(){var me=this,coords=me.coords,oriPolygonCoords={},i,j,k,rgn,c;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){oriPolygonCoords[i]=coords[i];continue;}var arr2=[];rgn=coords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];var arr1=[];for(k=0;k<c.length;k++){arr1.push(c[k]);}arr2.push(arr1);}}oriPolygonCoords[i]=arr2;}}return oriPolygonCoords;},getOriPointCoords:function getOriPointCoords(){var coords=this.coords,oriPointCoords={},point,newPoint,elem;for(elem in coords){if(elem==="bgImage"){oriPointCoords[elem]=coords[elem];continue;}if(coords.hasOwnProperty(elem)){point=coords[elem][0];newPoint=[point[0],point[1]];oriPointCoords[elem]=[newPoint];}}return oriPointCoords;},saveOriCoords:function saveOriCoords(){var me=this;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(!me.hasOwnProperty("oriCoords")||me.oriCoords===undefined){me.oriCoords=me.getOriPolygonCoords();}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){if(!me.hasOwnProperty("oriCoords")||me.oriCoords===undefined){me.oriCoords=me.getOriPointCoords();}}}var mapFileName=this.mapFileName,mapFilePool=this.totalWidget.mapFilePool;if(mapFileName&&mapFilePool.hasOwnProperty(mapFileName)){mapFilePool[mapFileName]=me.oriCoords;}},getOriBubbleSize:function getOriBubbleSize(){var me=this,gvs=me.totalWidget.getGvs(),propertyManager=me.totalWidget.propertyManager,EnumMinSizeType=propertyManager.CONSTANTS.EnumMinSizeType,i,sizeByIndex=me.sizeByIndex;if(me.markerType!==me.CONSTANTS.MARKER_TYPE.BUBBLE){return ;}var bubbleSizeParas=me.totalWidget.getBubbleSizeParas(),maxRadius=bubbleSizeParas.maxRadius,maxValue=bubbleSizeParas.maxValue,minValue=bubbleSizeParas.minValue,minSizeType=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.MIN_SIZE_TYPE),minRadius,minSizeValue=$NUM.parseNumeric(propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.MIN_SIZE_VALUE));var oriBubbleSize={};if(sizeByIndex>=0){var startLine=me.startLine,endLine=me.endLine;if(maxValue>minValue){if(minSizeType===EnumMinSizeType.PROPORTIONAL){minRadius=maxRadius*minValue/maxValue;}else{if(minSizeType===EnumMinSizeType.AUTO){minRadius=2;}else{if(minSizeType===EnumMinSizeType.MANUAL){minRadius=maxRadius*minSizeValue;}}}if(minRadius<2){minRadius=2;}var step=(maxRadius-minRadius)/(maxValue-minValue),radius;for(i=startLine;i<endLine+1;i++){if(i>-1){radius=(Math.abs(parseFloat(gvs.items[i].items[sizeByIndex].rv))-minValue)*step+minRadius;oriBubbleSize[i]=radius;}}}else{for(i=startLine;i<endLine;i++){if(i>-1){oriBubbleSize[i]=maxRadius;}}}}me.oriBubbleSize=oriBubbleSize;},drawBubbleMap:function drawBubbleMap(){var me=this,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,DebugFlag=me.CONSTANTS.DEBUG,context=me.animationContext,coords=me.coords,i,pt,oriCoords;me.totalWidget.getAllBubblesColor(me.colorByIndex);me.getOriBubbleSize();if(DebugFlag.LOG){if(me.hasOwnProperty("bgImg")){console.log("\nbgImg exists.");if(me.bgImg.hasOwnProperty("src")){console.log("\nbgImg src: "+me.bgImg.src);}else{console.log("\nbgImg src not exists.");}}else{console.log("\nbgImg not exists.");}}function drawBubbleMapWithBgImage(){me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=this.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=this.height;}var xRatio=this.width/(me.getWidth()-me.totalWidget.borderSpace*2),yRatio=this.height/(me.getHeight()-me.totalWidget.borderSpace*2),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()-me.oriBgImageWidth/ratio)/2;me.animationCanvas.width=me.animationCanvas.width;context.drawImage(this,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);me.saveOriCoords();oriCoords=me.oriCoords;var i;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){var polygonCenters={};for(i in oriCoords){if(oriCoords.hasOwnProperty(i)){if(i==="bgImage"){continue;}polygonCenters[i]=getCentroidOfPolygon(oriCoords[i][0]);polygonCenters[i][0][0]/=ratio;polygonCenters[i][0][1]/=ratio;}}me.polygonCenters=polygonCenters;}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}pt=coords[i][0];pt[0]=parseInt(oriCoords[i][0][0]/ratio,10);pt[1]=parseInt(oriCoords[i][0][1]/ratio,10);}}}}if(me.displayMode===DISPLAY_MODE.BUBBLE&&me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){me.drawBubblesInMap();}me.highlightPoint();me.showDataLabel();}if(me.isBgImgDownloaded){if(DebugFlag.LOG){console.log("\nusing existing bg image.");}drawBubbleMapWithBgImage.call(me.bgImg);}else{if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(me.isBgImgDownloaded!==undefined&&me.isBgImgDownloaded===false&&me.bgImg&&me.bgImg.onerror){me.bgImg.onerror();}else{if(me.isBgImgDownloaded===undefined){if(DebugFlag.LOG){console.log("\ndownloading new bg image.");}me.bgImg=new Image();me.bgImg.onerror=function(){me.isBgImgDownloaded=false;me.renderErrorMessage(mstrmojo.desc(9856,me.CONSTANTS.MESSAGE.IMAGE_NOT_FOUND));};me.bgImg.onload=function(){me.isBgImgDownloaded=true;var bgImgLoaded,bgImgBegin;if(DebugFlag.PERFORMANCE){bgImgLoaded=new Date();console.log("\nbgImg load time: "+(bgImgLoaded-bgImgBegin));}drawBubbleMapWithBgImage.call(this);if(!me.bgImageScreenshotTaken&&me.isTablet){me.bgImageScreenshotTaken=true;me.localTakeScreenshot(me.CONSTANTS.RENDERING_TIME);}if(DebugFlag.PERFORMANCE){var drawOver=new Date();console.log("\ndraw BG and bubble time: "+(drawOver-bgImgLoaded));}};}}}}if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(me.isBgImgDownloaded===undefined){if(DebugFlag.PERFORMANCE){var bgImgBegin=new Date();}me.bgImg.src=me.getFullPath(coords.bgImage);if(DebugFlag.LOG){console.log("\nresetting the src of me.bgImg.");}}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){me.drawBgImageFlag=false;me.saveOriCoords();me.scalePolygonCoords();me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.UNDER_BUBBLE,true);me.polygonCenters=calcPolygonCenters(coords);if(me.displayMode===DISPLAY_MODE.BUBBLE&&me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){me.drawBubblesInMap();}me.highlightPoint();me.showDataLabel();}}},drawAreaMap:function drawAreaMap(){var me=this,propertyManager=me.totalWidget.propertyManager,DebugFlag=me.CONSTANTS.DEBUG;if(DebugFlag.PERFORMANCE){var drawBegin=new Date();}var context=me.animationContext,coords=me.coords,i,j,k,rgn,c,oriC;me.saveOriCoords();var oriCoords=me.oriCoords;context.save();context.lineWidth=2;context.strokeStyle="#AAAAAA";function drawAreaMapWithBgImage(){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){me.drawBgImageFlag=false;}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=this.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=this.height;}var xRatio=this.width/(me.getWidth()-me.totalWidget.borderSpace*2),yRatio=this.height/(me.getHeight()-me.totalWidget.borderSpace*2),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()-me.oriBgImageWidth/ratio)/2;context.drawImage(this,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);var oriRgn;var i;var j;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=coords[i];oriRgn=oriCoords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];oriC=oriRgn[j];for(k=0;k<c.length;k++){c[k]=parseInt(oriC[k]/ratio,10);}}}}}var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}polygonCenters[i]=getCentroidOfPolygon(coords[i][0]);}}me.polygonCenters=polygonCenters;me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG);me.highlightPoint();me.showDataLabel();}}}if(me.isBgImgDownloaded){drawAreaMapWithBgImage.call(me.bgImg);}else{if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(me.isBgImgDownloaded!==undefined&&me.isBgImgDownloaded===false&&me.bgImg&&me.bgImg.onerror){me.bgImg.onerror();}else{if(me.isBgImgDownloaded===undefined){me.bgImg=new Image();me.bgImg.onerror=function(){me.isBgImgDownloaded=false;me.renderErrorMessage(mstrmojo.desc(9856,me.CONSTANTS.MESSAGE.IMAGE_NOT_FOUND));};me.bgImg.onload=function(){me.isBgImgDownloaded=true;drawAreaMapWithBgImage.call(this);if(!me.bgImageScreenshotTaken&&me.isTablet){me.bgImageScreenshotTaken=true;me.localTakeScreenshot(me.CONSTANTS.RENDERING_TIME);}};}}}}if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(me.isBgImgDownloaded===undefined){me.bgImg.src=me.getFullPath(coords.bgImage);}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(DebugFlag.PERFORMANCE){var drawPolyBegin=new Date();}me.drawBgImageFlag=false;this.scalePolygonCoords();if(DebugFlag.PERFORMANCE){var scalePolyEnd=new Date();}me.polygonCenters=calcPolygonCenters(coords);if(DebugFlag.PERFORMANCE){var polyCenterEnd=new Date();}this.drawPolygonInMap(propertyManager.getFormatPropertyValue("shapeFillOpacity"));this.highlightPoint();this.showDataLabel();}}context.restore();},getHeaderIndexFromTouchValue:function getHeaderIndexFromTouchValue(touchValue){var hdrIndex=-1,areaBubbleAttrElems=this.areaBubbleAttrElems;if(touchValue&&areaBubbleAttrElems){touchValue=touchValue.toLowerCase();if(areaBubbleAttrElems.hasOwnProperty(touchValue)){hdrIndex=areaBubbleAttrElems[touchValue].hdrIndex;}}return hdrIndex;},getNewColorForOpacityChange:function getNewColorForOpacityChange(bgColor,haveBgImage,curColor,curOpacity,destOpacity){var newColor=curColor;if(curOpacity>1||curOpacity<0||destOpacity>1||destOpacity<0){newColor=curColor;}var eps=0.0001,newBgColor=bgColor;if(!bgColor||haveBgImage){newBgColor="#FFFFFF";}if(destOpacity>=curOpacity){if(curOpacity+eps>1){newColor=curColor;}else{newColor=getOpacityColor(curColor,(destOpacity-curOpacity)/(1-curOpacity));}}else{if(destOpacity<curOpacity){if(curOpacity-eps<0){newColor=getOpacityColor(curColor,0);}else{newColor=getOpacityColor(newBgColor,(curOpacity-destOpacity)/curOpacity);}}}return newColor;},_drawBgImage:function(context){var me=this,xRatio=me.oriBgImageWidth/(me.getWidth()-me.totalWidget.borderSpace*2),yRatio=me.oriBgImageHeight/(me.getHeight()-me.totalWidget.borderSpace*2),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()-me.oriBgImageWidth/ratio)/2;context.drawImage(me.bgImg,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);},drawPartOpacityBG:function drawPartOpacityBG(ctx,coordsArray,bgOpacity){ctx.save();var me=this,pointsArray,offsetX=me.leftOffset||0,offsetY=me.topOffset||0;var getPointAt=function(j){var offset=j%2?offsetY:offsetX;return pointsArray[j]+offset;};ctx.beginPath();var i,j;for(i=0;i<coordsArray.length;i++){pointsArray=coordsArray[i];var minX=getPointAt(0),minY=getPointAt(1),maxY=getPointAt(1),x,y;ctx.moveTo(getPointAt(0),getPointAt(1));for(j=2;j<pointsArray.length-1;j=j+2){x=getPointAt(j);y=getPointAt(j+1);ctx.lineTo(x,y);maxY=Math.max(y,maxY);minY=Math.min(y,minY);minX=Math.min(x,minX);}x=getPointAt(0);y=getPointAt(1);ctx.lineTo(x,y);}ctx.clip();ctx.globalAlpha=bgOpacity;this._drawBgImage(ctx);ctx.restore();},highlightImageIcon:function highlightImageIcon(hlContext,coords,touchVal,radiusLarger){var me=this,fillColor="RGBA(255,255,255,0.5)",iconName="imageIcon_"+touchVal;if(me.hasOwnProperty(iconName)){var imgIcon=me[iconName],width=me.getImageIconWidth(imgIcon.width)+radiusLarger*2,height=me.getImageIconHeight(imgIcon.height)+radiusLarger*2,xOffset=coords[touchVal][0][0]-width/2+me.leftOffset,yOffset=coords[touchVal][0][1]-height/2+me.topOffset;hlContext.fillStyle=fillColor;hlContext.fillRect(xOffset,yOffset,width,height);drawWhiteRectCorner(hlContext,xOffset,yOffset,width,height);}},shouldHighlightSelector:function(){var totalWidget=this.totalWidget,currSelectedObj=totalWidget.currSelectedObj,currSelectedObjMiniChart=totalWidget.currSelectedObjMiniChart;return totalWidget.hasSelectedObj()&&(currSelectedObjMiniChart===this||(currSelectedObjMiniChart===null&&this.getHeaderIndexFromTouchValue(currSelectedObj.touchVal)>-1))&&(!totalWidget.hasHoverObj()||totalWidget.currHoverObj.touchVal!==currSelectedObj.touchVal||totalWidget.currHoverObjMiniChart!==currSelectedObjMiniChart);},getBgColor:function getBgColor(lineIndex,noColorByColor){var me=this,gvs=me.totalWidget.getGvs(),colorByCellData=lineIndex>-1?gvs.items[lineIndex].items[me.colorByIndex]:null,fillColor=me.totalWidget.getBgColorFromCss(colorByCellData,me.colorByIndex);if(!fillColor){fillColor=noColorByColor;}return fillColor;},highlightPoint:function highlightPoint(){var me=this,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,vp=me.totalWidget.getVp(),hlContext=me.highlightContext,hdrIndex,fillColor,lineIndex=-1,shouldHighlightDefaultSelectedNodes=me.totalWidget.getShouldHighlightDefaultSelectedNodes();var bgColor,selectedStrokeColor,hoverStrokeColor,selectedHoverStrokeColor,noAltColor,noColorByColor;var linkdrillStrokColor,highlightStrokeColor;var polyUnselectedOpc;var i;var dftSltObjs;var sltCoord;var sltBubbleRadius;var coords=me.coords;var touchVal;me.highlightCanvas.width=me.highlightCanvas.width;if(me.totalWidget.currSelectedObj===null&&!shouldHighlightDefaultSelectedNodes&&me.displayMode===DISPLAY_MODE.AREA){if(me.drawBgImageFlag){if(me.curPolygonOpacity!==me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG){me.drawPolygonInMap(me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG);}}else{if(me.curPolygonOpacity!==me.CONSTANTS.POLYGON_OPACITY.NORMAL){me.drawPolygonInMap(propertyManager.getFormatPropertyValue("shapeFillOpacity"));}}}function renderTooltipInBubbleMode(){if(this.newRenderFlag){this.newRenderFlag=false;var lCenter;if(this.shapeFileType===this.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){lCenter=this.polygonCenters&&this.polygonCenters[this.totalWidget.currHoverObj.touchVal]&&this.polygonCenters[this.totalWidget.currHoverObj.touchVal][0];}else{if(this.shapeFileType===this.CONSTANTS.SHAPE_FILE_TYPE.POINT){lCenter=this.coords&&this.coords[this.totalWidget.currHoverObj.touchVal]&&this.coords[this.totalWidget.currHoverObj.touchVal][0];}}if(lCenter){var xOnWidget=lCenter[0]+this.leftOffset;var yOnWidget=lCenter[1]+this.topOffset;this.renderTooltip(this.totalWidget.currHoverObj.touchVal,xOnWidget,yOnWidget,this.totalWidget.currHoverObj.hdrIndex);}}else{this.renderTooltip(this.totalWidget.currHoverObj.touchVal,this.totalWidget.currHoverObj.point.x,this.totalWidget.currHoverObj.point.y,this.totalWidget.currHoverObj.hdrIndex);}}function renderTooltipInAreaMode(){if(this.newRenderFlag){this.newRenderFlag=false;var polygonCenter=this.polygonCenters&&this.polygonCenters[this.totalWidget.currHoverObj.touchVal]&&this.polygonCenters[this.totalWidget.currHoverObj.touchVal][0];if(polygonCenter){var xOnWidget=polygonCenter[0]+this.leftOffset;var yOnWidget=polygonCenter[1]+this.topOffset;this.renderTooltip(this.totalWidget.currHoverObj.touchVal,xOnWidget,yOnWidget,this.totalWidget.currHoverObj.hdrIndex);}}else{this.renderTooltip(this.totalWidget.currHoverObj.touchVal,this.totalWidget.currHoverObj.point.x,this.totalWidget.currHoverObj.point.y,this.totalWidget.currHoverObj.hdrIndex);}}if(me.displayMode===DISPLAY_MODE.AREA){bgColor=me.bgColor;selectedStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_SELECTED_DARK_THEME;hoverStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_HOVER_DARK_THEME;selectedHoverStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_SELECTED_HOVER_DARK_THEME;noAltColor=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.BLANK_MAP_COLOR);noColorByColor=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.SHAPE_FILL_COLOR);if(me.themeMode===me.CONSTANTS.THEME.LIGHT){selectedStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_SELECTED_LIGHT_THEME;hoverStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_HOVER_LIGHT_THEME;selectedHoverStrokeColor=me.CONSTANTS.POLYGON_COLOR.STROKE_COLOR_SELECTED_HOVER_LIGHT_THEME;}if(vp&&vp.npc&&!mstrApp.isVI){noAltColor=getOpacityColor("#"+vp.npc,me.CONSTANTS.POLYGON_OPACITY.NORMAL);}fillColor=noAltColor;dftSltObjs=me.totalWidget.defaultSelectedObjs;if(shouldHighlightDefaultSelectedNodes){polyUnselectedOpc=propertyManager.getFormatPropertyValue("polygonUnselectedOpacity");if(me.curPolygonOpacity!==polyUnselectedOpc){me.drawPolygonInMap(polyUnselectedOpc);}for(i in dftSltObjs){if(dftSltObjs.hasOwnProperty(i)&&me.inThisWidget(i)){if(me.totalWidget.hasHoverObj()&&parseInt(me.totalWidget.currHoverObj.lineIndex,10)===parseInt(i,10)){continue;}else{var hIndex=dftSltObjs[i].hdrIndex;if(hIndex>=0){if(me.colorByIndex>=0&&me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.COLOR){lineIndex=i;fillColor=me.getBgColor(lineIndex,noColorByColor);}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,propertyManager.polygonUnselectedOpacity,me.CONSTANTS.POLYGON_OPACITY.SELECTED_WITH_BG);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,propertyManager.polygonUnselectedOpacity,me.CONSTANTS.POLYGON_OPACITY.SELECTED_WITHOUT_BG);}drawPoly(hlContext,me.coords[dftSltObjs[i].touchVal],{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}}}fillColor=noAltColor;}else{if(me.totalWidget.hasSelectedObj()){polyUnselectedOpc=propertyManager.getFormatPropertyValue("polygonUnselectedOpacity");if(me.curPolygonOpacity!==polyUnselectedOpc){me.drawPolygonInMap(polyUnselectedOpc);}if(me.shouldHighlightSelector()){hdrIndex=me.getHeaderIndexFromTouchValue(me.totalWidget.currSelectedObj.touchVal);if(me.colorByIndex>=0){lineIndex=me.getLineIndexFromTouchValue(me.totalWidget.currSelectedObj.touchVal);fillColor=me.getBgColor(lineIndex,noColorByColor);}else{fillColor=noColorByColor;}if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,propertyManager.polygonUnselectedOpacity,me.CONSTANTS.POLYGON_OPACITY.SELECTED_WITH_BG);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,propertyManager.polygonUnselectedOpacity,me.CONSTANTS.POLYGON_OPACITY.SELECTED_WITHOUT_BG);}drawPoly(hlContext,me.coords[me.totalWidget.currSelectedObj.touchVal],{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}}else{if(me.totalWidget.hasLinkObj()&&me.totalWidget.currLinkObjMiniChart===me){if(me.totalWidget.currLinkObj.hasOwnProperty("hdrIndex")){hdrIndex=me.totalWidget.currLinkObj.hdrIndex;}else{hdrIndex=me.getHeaderIndexFromTouchValue(me.totalWidget.currLinkObj.touchVal);}if(hdrIndex>=0){if(me.colorByIndex>=0&&me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.COLOR){lineIndex=me.getLineIndexFromTouchValue(me.totalWidget.currLinkObj.touchVal);fillColor=me.getBgColor(lineIndex,noColorByColor);}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG,me.CONSTANTS.POLYGON_OPACITY.LINKDRILL);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.NORMAL,me.CONSTANTS.POLYGON_OPACITY.LINKDRILL);}drawPoly(hlContext,me.coords[me.totalWidget.currLinkObj.touchVal],{x:me.leftOffset,y:me.topOffset},hoverStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}}}if(me.totalWidget.hasHoverObj()&&me.totalWidget.currHoverObjMiniChart===me){var hvObj=me.totalWidget.currHoverObj;if(hvObj.hasOwnProperty("hdrIndex")){hdrIndex=hvObj.hdrIndex;}else{hdrIndex=me.getHeaderIndexFromTouchValue(hvObj.touchVal);}if(hdrIndex>=0){if(me.colorByIndex>=0&&me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.COLOR){lineIndex=me.getLineIndexFromTouchValue(hvObj.touchVal);fillColor=me.getBgColor(lineIndex,noColorByColor);}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.totalWidget.currSelectedObj!==null||shouldHighlightDefaultSelectedNodes){if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,propertyManager.polygonUnselectedOpacity,me.CONSTANTS.POLYGON_OPACITY.SELECTED_HOVER_WITH_BG);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,propertyManager.polygonUnselectedOpacity,me.CONSTANTS.POLYGON_OPACITY.SELECTED_HOVER_WITHOUT_BG);}drawPoly(hlContext,me.coords[me.totalWidget.currHoverObj.touchVal],{x:me.leftOffset,y:me.topOffset},selectedHoverStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}else{if(me.drawBgImageFlag){var bgOpacity=(me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG-propertyManager.getFormatPropertyValue("hoverOpacity"))/me.CONSTANTS.POLYGON_OPACITY.ABOVE_BG;this.drawPartOpacityBG(hlContext,me.coords[me.totalWidget.currHoverObj.touchVal],bgOpacity);fillColor="RGBA(0,0,0,0)";drawPoly(hlContext,me.coords[me.totalWidget.currHoverObj.touchVal],{x:me.leftOffset,y:me.topOffset},hoverStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,me.CONSTANTS.POLYGON_OPACITY.NORMAL,propertyManager.getFormatPropertyValue("hoverOpacity"));drawPoly(hlContext,me.coords[me.totalWidget.currHoverObj.touchVal],{x:me.leftOffset,y:me.topOffset},hoverStrokeColor,me.totalWidget.highlightPolygonStrokeWidth,fillColor);}}renderTooltipInAreaMode.call(this);}}else{if(me.displayMode===DISPLAY_MODE.BUBBLE){selectedStrokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_SELECTED_DARK_THEME;hoverStrokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_HOVER_DARK_THEME;linkdrillStrokColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_LINKDRILL_DARK_THEME;highlightStrokeColor=me.CONSTANTS.BUBBLE_COLOR.HIGHLIGHT_STROKE_COLOR_DARK_THEME;noColorByColor=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.SHAPE_FILL_COLOR);if(me.themeMode===me.CONSTANTS.THEME.LIGHT){selectedStrokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_SELECTED_LIGHT_THEME;hoverStrokeColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_HOVER_LIGHT_THEME;linkdrillStrokColor=me.CONSTANTS.BUBBLE_COLOR.STROKE_COLOR_LINKDRILL_LIGHT_THEME;highlightStrokeColor=me.CONSTANTS.BUBBLE_COLOR.HIGHLIGHT_STROKE_COLOR_LIGHT_THEME;}if(me.markerType===me.CONSTANTS.MARKER_TYPE.BUBBLE){me.drawBubblesInMap();dftSltObjs=me.totalWidget.defaultSelectedObjs;if(shouldHighlightDefaultSelectedNodes){for(i in dftSltObjs){if(dftSltObjs.hasOwnProperty(i)&&me.inThisWidget(i)){var nodeName=dftSltObjs[i].touchVal;sltBubbleRadius=me.getRadiusFromName(nodeName);fillColor=me.getBubbleColorFromName(nodeName,noColorByColor);fillColor=getOpacityColor(fillColor,me.CONSTANTS.BUBBLE_OPACITY.SELECTED);if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(me.hasOwnProperty("polygonCenters")){sltCoord=me.polygonCenters[nodeName][0];}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){sltCoord=me.coords[nodeName][0];}}drawBubble(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},fillColor,sltBubbleRadius);drawStroke(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,sltBubbleRadius,me.totalWidget.bubbleStrokeWidth);}}fillColor=noColorByColor;}else{if(me.shouldHighlightSelector()){sltBubbleRadius=me.getRadiusFromName(me.totalWidget.currSelectedObj.touchVal);fillColor=me.getBubbleColorFromName(me.totalWidget.currSelectedObj.touchVal,noColorByColor);fillColor=getOpacityColor(fillColor,me.CONSTANTS.BUBBLE_OPACITY.SELECTED);if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(me.hasOwnProperty("polygonCenters")){sltCoord=me.polygonCenters[me.totalWidget.currSelectedObj.touchVal][0];}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){sltCoord=me.coords[me.totalWidget.currSelectedObj.touchVal][0];}}drawBubble(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},fillColor,sltBubbleRadius);drawStroke(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,sltBubbleRadius,me.totalWidget.bubbleStrokeWidth);}else{if(me.totalWidget.hasLinkObj()&&me.totalWidget.currLinkObjMiniChart===me){var linkCoord,linkBubbleRadius;linkBubbleRadius=me.getRadiusFromName(me.totalWidget.currLinkObj.touchVal);fillColor=me.getBubbleColorFromName(me.totalWidget.currLinkObj.touchVal,noColorByColor);fillColor=getOpacityColor(fillColor,me.CONSTANTS.BUBBLE_OPACITY.LINKDRILL);if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(me.hasOwnProperty("polygonCenters")){linkCoord=me.polygonCenters[me.totalWidget.currLinkObj.touchVal][0];}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){linkCoord=me.coords[me.totalWidget.currLinkObj.touchVal][0];}}drawBubble(hlContext,linkCoord,{x:me.leftOffset,y:me.topOffset},fillColor,linkBubbleRadius);drawStroke(hlContext,linkCoord,{x:me.leftOffset,y:me.topOffset},linkdrillStrokColor,linkBubbleRadius,me.totalWidget.bubbleStrokeWidth);drawStroke(hlContext,linkCoord,{x:me.leftOffset,y:me.topOffset},highlightStrokeColor,linkBubbleRadius+me.totalWidget.hoverBubbleRadiusLarger,me.totalWidget.bubbleStrokeWidth);}}}if(me.totalWidget.hasHoverObj()&&me.totalWidget.currHoverObjMiniChart===me){var hoverCoord,hoverBubbleRadius,hoverTouchVal=me.totalWidget.currHoverObj.touchVal;hoverBubbleRadius=me.getRadiusFromName(hoverTouchVal);fillColor=me.getBubbleColorFromName(hoverTouchVal,noColorByColor);var nodeStrokeColor=hoverStrokeColor;if((me.totalWidget.currSelectedObj&&me.totalWidget.currSelectedObj.touchVal===hoverTouchVal&&me.totalWidget.currSelectedObjMiniChart===me.totalWidget.currHoverObjMiniChart)||(shouldHighlightDefaultSelectedNodes&&me.totalWidget.defaultSelectedObjs.hasOwnProperty(me.getLineIndexFromTouchValue(hoverTouchVal)))){fillColor=getOpacityColor(fillColor,me.CONSTANTS.BUBBLE_OPACITY.SELECTED);nodeStrokeColor=selectedStrokeColor;}else{fillColor=getOpacityColor(fillColor,propertyManager.getFormatPropertyValue("hoverOpacity"));}if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){if(me.hasOwnProperty("polygonCenters")){hoverCoord=me.polygonCenters[me.totalWidget.currHoverObj.touchVal][0];}}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){hoverCoord=me.coords[me.totalWidget.currHoverObj.touchVal][0];}}drawBubble(hlContext,hoverCoord,{x:me.leftOffset,y:me.topOffset},fillColor,hoverBubbleRadius);drawStroke(hlContext,hoverCoord,{x:me.leftOffset,y:me.topOffset},nodeStrokeColor,hoverBubbleRadius,me.totalWidget.bubbleStrokeWidth);drawStroke(hlContext,hoverCoord,{x:me.leftOffset,y:me.topOffset},highlightStrokeColor,hoverBubbleRadius+me.totalWidget.hoverBubbleRadiusLarger,me.totalWidget.bubbleStrokeWidth);renderTooltipInBubbleMode.call(this);}}else{if(me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){if(me.hasOwnProperty("polygonCenters")){coords=me.polygonCenters;}dftSltObjs=me.totalWidget.defaultSelectedObjs;if(shouldHighlightDefaultSelectedNodes){for(i in dftSltObjs){if(dftSltObjs.hasOwnProperty(i)&&me.inThisWidget(i)){me.highlightImageIcon(hlContext,coords,dftSltObjs[i].touchVal,0);}}}else{if(me.shouldHighlightSelector()){touchVal=me.totalWidget.currSelectedObj.touchVal;me.highlightImageIcon(hlContext,coords,touchVal,0);}else{if(me.totalWidget.hasLinkObj()&&me.totalWidget.currLinkObjMiniChart===me){touchVal=me.totalWidget.currLinkObj.touchVal;me.highlightImageIcon(hlContext,coords,touchVal,me.totalWidget.hoverBubbleRadiusLarger);}}}if(me.totalWidget.hasHoverObj()&&me.totalWidget.currHoverObjMiniChart===me){touchVal=me.totalWidget.currHoverObj.touchVal;fillColor="RGBA(255,255,255,0.5)";var iconName="imageIcon_"+touchVal;if(me.hasOwnProperty(iconName)){var imgIcon=me[iconName],width=me.getImageIconWidth(imgIcon.width)+me.totalWidget.hoverBubbleRadiusLarger*2,height=me.getImageIconHeight(imgIcon.height)+me.totalWidget.hoverBubbleRadiusLarger*2,xOffset=coords[touchVal][0][0]-width/2+me.leftOffset,yOffset=coords[touchVal][0][1]-height/2+me.topOffset;hlContext.fillStyle=fillColor;hlContext.fillRect(xOffset,yOffset,width,height);var sltObj=me.totalWidget.currSelectedObj,hvTouchVal=me.totalWidget.currHoverObj.touchVal;if(!((sltObj!==null&&sltObj.hasOwnProperty("hdrIndex")&&sltObj.hdrIndex>=0&&sltObj.touchVal===hvTouchVal)||(shouldHighlightDefaultSelectedNodes&&me.totalWidget.defaultSelectedObjs.hasOwnProperty(me.getLineIndexFromTouchValue(hvTouchVal))))){drawWhiteRectCorner(hlContext,xOffset,yOffset,width,height);}}renderTooltipInBubbleMode.call(this);}}}}}},getTouchValue:function getTouchValue(x,y){var me=this,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,coords=me.coords,elem,i,result;if(me.displayMode===DISPLAY_MODE.AREA){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}var coordsArray=coords[elem],l=coordsArray.length;for(i=0;i<l;i++){if(me.inPoly(coordsArray[i],x,y)){result=elem;}}}}return result;}}else{if(me.displayMode===DISPLAY_MODE.BUBBLE){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON&&me.hasOwnProperty("polygonCenters")){coords=me.polygonCenters;}var minDistance=Number.MAX_VALUE,touchName="";for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}var coord=coords[elem][0],distance=Math.sqrt((x-coord[0])*(x-coord[0])+(y-coord[1])*(y-coord[1]));if(distance<minDistance){minDistance=distance;touchName=elem;}}}if(minDistance<this.totalWidget.bias){return touchName;}}}return null;},getAttributeElement:function(lineIndex,attributeIndex){return"California "+lineIndex+" "+attributeIndex;},getNodeName:function(lineIndex){var me=this,totalWidget=me.totalWidget,attrFormIndices=totalWidget.attrFormIndices,areaBubbleAttrIndex=totalWidget.areaBubbleAttrIndex,rhsItems=totalWidget.getGhsItems(),gtsRows=totalWidget.getGtsRow(),allAreaBubbleAttrElems=gtsRows&&gtsRows.length>areaBubbleAttrIndex&&gtsRows[areaBubbleAttrIndex].es,areaBubbleAttrFirstFormIndexIdx,areaBubbleAttrFirstFormName,areaBubbleAttrFormIndices=attrFormIndices.length>areaBubbleAttrIndex&&attrFormIndices[areaBubbleAttrIndex],areaBubbleAttrFirstFormIndex=areaBubbleAttrFormIndices[0];areaBubbleAttrFirstFormIndexIdx=(rhsItems[lineIndex].items&&rhsItems[lineIndex].items.length>areaBubbleAttrFirstFormIndex)?rhsItems[lineIndex].items[areaBubbleAttrFirstFormIndex].idx:-1;areaBubbleAttrFirstFormName=(allAreaBubbleAttrElems.length>areaBubbleAttrFirstFormIndexIdx)?allAreaBubbleAttrElems[areaBubbleAttrFirstFormIndexIdx].n:null;return areaBubbleAttrFirstFormName;},getCellValues:function(lineIndex){var me=this,gtsCol=me.totalWidget.getGtsCol(),gvs=me.totalWidget.getGvs(),i,units,cells,mv,v,values="";if(gtsCol&&gtsCol.length>0){units=me.totalWidget.getFirstColElems();cells=gvs.items[lineIndex].items;for(i=0;i<units.length;i++){mv=cells[i];v=mv.v;values+=v;if(i<units.length-1){values+="<br>";}}}return values;},getAreaOrNearestBubble:function(isTap,touchX,touchY){var me=this,coords=me.coords,DebugFlag=me.CONSTANTS.DEBUG;if(DebugFlag.LOG){console.log("oritouchX:"+touchX+"  oritouchY:"+touchY);}var x=touchX-me.leftOffset,y=touchY-me.topOffset,touchVal;if(isTap&&me.totalWidget.tooltipOn&&me.totalWidget.currHoverObj!==null){var crHP=null;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){crHP=me.polygonCenters&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal]&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal][0];}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){crHP=coords[me.totalWidget.currHoverObj.touchVal]&&coords[me.totalWidget.currHoverObj.touchVal][0];}}if(crHP){var dis=Math.sqrt((x-crHP[0])*(x-crHP[0])+(y-crHP[1])*(y-crHP[1]));if(dis<me.totalWidget.bias){touchVal=me.totalWidget.currHoverObj.touchVal;}else{touchVal=me.getTouchValue(x,y);}}else{touchVal=me.getTouchValue(x,y);}}else{touchVal=me.getTouchValue(x,y);}if(!touchVal){return null;}var hdrIndex=me.getHeaderIndexFromTouchValue(touchVal);var lineIndex=me.getLineIndexFromTouchValue(touchVal);return{touchVal:touchVal,hdrIndex:hdrIndex,lineIndex:lineIndex,point:{x:touchX,y:touchY}};},renderTooltip:function renderTooltip(touchVal,touchX,touchY,hdrIndex){var me=this,gvs=me.totalWidget.getGvs(),totalWidget=me.totalWidget,tooltip=totalWidget&&totalWidget.tooltip,i,leftHtml,rightHtml;if(totalWidget.currHoverObjMiniChart!==this){return ;}var lineIndex=me.getLineIndexFromTouchValue(touchVal),tooltipInfo=[];tooltip.toggle(true);if(!me.totalWidget.tooltipOn){me.totalWidget.tooltipOn=true;}if(hdrIndex>=0){var gtsRows=me.totalWidget.getGtsRow(),ghsRhsItems=me.totalWidget.getGhsItems(),attrFormIndices=totalWidget?totalWidget.attrFormIndices:[],afiLength=attrFormIndices.length,idx;for(i=0;i<gtsRows.length;i++){if(totalWidget&&totalWidget.layoutAttrFormCount===1&&totalWidget.layoutAttrIndex===i){continue;}leftHtml=gtsRows[i].n;rightHtml="";var _indices=i<afiLength?attrFormIndices[i]:null;if(_indices){for(j=0;j<_indices.length;j++){if(totalWidget&&totalWidget.hasMultiAttr&&i===totalWidget.layoutAttrIndex&&j===totalWidget.shapeFileFormIndex){continue;}idx=ghsRhsItems[lineIndex].items[_indices[j]].idx;rightHtml+=gtsRows[i].es[idx].n;if(j!==_indices.length-1){rightHtml+=" ";}}}tooltipInfo.push({n:leftHtml,v:rightHtml});}var gtsCol=me.totalWidget.getGtsCol();if(gtsCol&&gtsCol.length>0){var units=me.totalWidget.getFirstColElems(),values=gvs.items[lineIndex].items;for(i=0;i<units.length;i++){var mv=values[i];leftHtml=units[i].n;rightHtml=mv.v;tooltipInfo.push({n:leftHtml,v:rightHtml});}}}else{if(hdrIndex<0){leftHtml="";rightHtml=touchVal;tooltipInfo.push({n:leftHtml,v:rightHtml});}}if(totalWidget){var subPosition=$DOM.position(this.domNode);if(subPosition){touchX=touchX+subPosition.x;touchY=touchY+subPosition.y;}tooltip.displayInfo(tooltipInfo,{x:touchX,y:touchY});}},hideTooltip:function hideTooltip(){this.totalWidget.hideTooltip();},reRender:function reRender(){this.unrender();this.render();},deleteListners:function deleteListners(){var me=this;},unrender:function unrender(ignoreDom){var me=this;me.hasDrawnMap=undefined;if(this._super){this._super(ignoreDom);}me.deleteListners();if(me.highlightContext){delete me.highlightContext;}if(me.animationContext){delete me.animationContext;}if(me._tn){delete me._tn;}},destroy:function destroy(){this.deleteListners();if(this._super){this._super();}}});}());