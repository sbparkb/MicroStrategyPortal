(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo._TouchGestures","mstrmojo.TouchScroller");var $FOREACHARRAY=mstrmojo.array.forEach,$FOREACHHASH=mstrmojo.hash.forEach,$D=mstrmojo.dom;function translate(node,c){var i;for(i in node){$D.translate(node[i],c[0],c[1],c[2]);}}function preventMove(t){var abs=Math.abs;return{x:(abs(t.accelDelta.x)<abs(t.accelDelta.y)),y:(abs(t.accelDelta.y)<abs(t.accelDelta.x))};}function raiseScrolledOutEvent(scroller,e){scroller.raiseEvent({name:"scrolledOut",value:e.value,axis:e.axis,direction:e.direction});}function setupScroller(el,offset,v,h,frameRate,showBar,friction,indEl){var scroller=new mstrmojo.TouchScroller({scrollEl:el,vScroll:v,hScroll:h,frameRate:frameRate,showScrollbars:showBar,offset:offset,origin:{x:0,y:0},bounces:false,useTranslate3d:false,indicatorEl:indEl});if(friction){scroller.friction=friction;}return scroller;}function stopDeceleration(scroller){var i;for(i in scroller){if(scroller[i].decelerating){scroller[i].stopDeceleration();}}}var PREVENT_MOVEMENT={x:false,y:false};function getAxis(){var prevent=PREVENT_MOVEMENT;if(!prevent.x){return"x";}if(!prevent.y){return"y";}return null;}var isContainerScrollElement={x:false,y:false};function syncScrollEl(xtab,d){var currentAxis=getAxis(),scrollPast=xtab.scrollerConfig.scrollPast;if(!currentAxis||!scrollPast){return !!currentAxis&&!scrollPast;}function syncHelper(axis){var container=xtab.viewport,node=xtab._TSN[axis],scroller=xtab._scroller[axis],curPosition=xtab.tPos[axis],newPosition=d[axis],isCntrScrllEl=isContainerScrollElement[axis],otherAxis=(axis==="x")?"y":"x",otherScroller=xtab._scroller[otherAxis],isContainerOnOtherAxis=isContainerScrollElement[otherAxis],i;if(!otherScroller[0].decelerating&&isContainerOnOtherAxis){syncHelper(otherAxis);}if(curPosition<=0&&newPosition>0){if(!isCntrScrllEl){if(isContainerOnOtherAxis){return false;}translate(node,[0,0,0]);for(i in scroller){scroller[i].scrollEl=container;}isContainerScrollElement[axis]=true;}}else{if(isCntrScrllEl){translate([container],[0,0,0]);for(i in scroller){scroller[i].scrollEl=node[i];}isContainerScrollElement[axis]=false;}}return true;}return syncHelper(currentAxis);}function handleScrollEvents(xtab,evt){var axis=evt.axis,incRender=xtab.scrollboxHeightFixed,evtName=evt.name;if(xtab.ss){var rowInfo=xtab.zones._BR.getRowInfoByPosition(evt[axis]);rowInfo.position=evt[axis];xtab.ss.onMove(rowInfo);}xtab.tPos[axis]=evt[axis];if(evtName==="scrollDone"){$FOREACHHASH(xtab._scroller,function(scrollers){$FOREACHARRAY(scrollers,function(scroller){scroller.toggleScrollBars(false);});});if(!syncScrollEl(xtab,evt)){return true;}}if(axis==="y"){var fnEnd=function(newPosition){if(!xtab._isDownloading&&(-newPosition<=xtab._TMAX[axis])){if(xtab.onScrolledToLastRow){xtab.onScrolledToLastRow();}}};if(evtName==="scrollDone"){delete xtab._isDecelerating;if(xtab._cachedDownload){xtab.dataDownloaded();}else{fnEnd(evt.y);}if(incRender){var newPosition=evt.y;xtab.notifyScrollListeners({x:evt.x,y:Math.max(newPosition,0)});}}else{if(evtName==="scrollDecel"){xtab._isDecelerating=true;fnEnd(evt.fY);if(incRender){xtab.notifyScrollListeners({x:evt.fX,y:evt.fY});}}else{if(evtName==="scrollOut"){xtab._isDecelerating=true;fnEnd(evt.y.position);}}}}}function getScrollerOffsets(widget,axis){var abs=Math.abs,offset={};var axisOffset=offset[axis]={start:widget._TMIN[axis],end:abs(widget._TMAX[axis])};offset.scrollPast=widget.scrollerConfig.scrollPast;if(axis==="y"){if(widget.useSeamlessIncFetch){axisOffset.incFetch=!widget.endFetching;axisOffset.pageSize=widget.scrollboxHeight-((parseInt(widget.gridData.rh,10)||25)*4);}}return offset;}function createScrollers(widget){widget._scroller={x:[],y:[]};var viewportCoords=widget._viewportCoords;$FOREACHHASH(widget._TSN,function(nodes,axis){var offset=getScrollerOffsets(widget,axis),isY=(axis==="y"),isX=(axis==="x"),len=nodes.length;$FOREACHARRAY(nodes,function(node,idx){var scroller=setupScroller(node,offset,isY,isX,widget.frameRate,(idx===len-1)&&widget.scrollerConfig.showScrollbars,widget.scrollerFriction,widget.domNode);scroller.updateScrollBars(viewportCoords,widget.domNode);widget._scroller[axis][idx]=scroller;});var zeroScroller=widget._scroller[axis][0],evts=["scrollDone","scrollMoved"];if(zeroScroller){if(isY){evts=evts.concat(["scrollDecel","scrollOut"]);}$FOREACHARRAY(evts,function(evtName){zeroScroller.attachEventListener(evtName,widget.id,function(evt){evt.axis=axis;handleScrollEvents(widget,evt);});});}});}function updateOffsets(dimension){if(this.hasRendered){this[dimension+"Limit"]=parseInt(this[dimension],10);if(this.zones){var me=this;window.setTimeout(function(){if(me.hasRendered){me.setOffsets(true);me.setupScrollers();}},0);}}}mstrmojo._HasXtabTouchScroll=mstrmojo.provide("mstrmojo._HasXtabTouchScroll",{noScrolling:false,useTouchScrolling:true,scrollerConfig:{showScrollbars:false,scrollPast:false},_TSN:null,tPos:{x:0,y:0},_TMIN:{x:0,y:0},setupTNs:function setupTNs(){this._TSN.x=this._TSN.y=[this.domNode];},touchBegin:function touchBegin(touch){if(!this.noScrolling){touch.stop();if(!this._isDownloading){if(this.toolbarMgr){this.toolbarMgr.closeToolbar();}var scrollers=this._scroller,min=this._TMIN,max=this._TMAX;$FOREACHHASH(this.tPos,function(position,axis){if(position>=min[axis]&&position<=Math.abs(max[axis])){stopDeceleration(scrollers[axis]);}});}var xScrollers=this._scroller.x;$FOREACHHASH(xScrollers,function(scroller){scroller.origin.x=xScrollers[0].origin.x;});}return true;},touchSwipeBegin:function touchSwipeBegin(touch){if(this.noScrolling){return this.bubbleTouchEvent(touch);}if(this._isDownloading){return false;}PREVENT_MOVEMENT=preventMove(touch);var axis=PREVENT_MOVEMENT.y?"x":"y",scroller=this._scroller[axis][0],offset=scroller.offset,offsetVal=offset[axis][touch.direction[axis]?"end":"start"];if(!offset.scrollPast&&offsetVal===scroller.origin[axis]){var bubbleTouchEvent=this.bubbleTouchEvent(touch);if(bubbleTouchEvent!==undefined){return bubbleTouchEvent;}}var s=this._scroller;if(!syncScrollEl(this,touch.delta)){return true;}if(!PREVENT_MOVEMENT.x){stopDeceleration(s.x);}if(!PREVENT_MOVEMENT.y){stopDeceleration(s.y);}$FOREACHHASH(this._scroller,function(scrollers,axis){if(!PREVENT_MOVEMENT[axis]){$FOREACHARRAY(scrollers,function(scroller){scroller.toggleScrollBars(true);});}});return true;},touchSwipeMove:function touchSwipeMove(touch){if(!syncScrollEl(this,touch.delta)){return true;}var scrollers=this._scroller;$FOREACHARRAY(["x","y"],function(axis){if(!PREVENT_MOVEMENT[axis]){$FOREACHHASH(scrollers[axis],function(scroller){scroller.scroll(touch);});}});},touchSwipeEnd:function touchSwipeEnd(touch){var prevent=PREVENT_MOVEMENT,axis=null,delta=touch.delta,direction=touch.direction;if(!prevent.x&&delta.x!==0){axis="x";direction=direction.x?"left":"right";}if(!prevent.y&&delta.y!==0){axis="y";direction=direction.y?"up":"down";}if(axis){raiseScrolledOutEvent(this,{axis:axis,value:this.tPos[axis],direction:direction});var scroller=this._scroller[axis],i;if(!prevent[axis]){for(i in scroller){scroller[i].scrollEnd(touch);}}}},gridPagesRendered:function gridPagesRendered(){if(this._super){this._super();}this.setOffsets(true);},renderEmptyGrid:function renderEmptyGrid(){if(this._super){this._super();}this.noScrolling=true;},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}if(this.zones&&!this.gridData.eg){var me=this;window.setTimeout(function(){if(me.hasRendered){me._TSN={x:[],y:[]};me.setupTNs();me.setupScrollers();}},0);}},setOffsets:function setOffsets(){var me=this,domNode=this.domNode,zones=this.zones,TR=zones._TR,BL=zones._BL,isDocNotFullScreen=(!this.isFullScreenWidget&&this.isDocXtab),viewportCoords=this._viewportCoords={top:TR?TR.cp.rc*parseInt(this.gridData.rh,10):0,right:isDocNotFullScreen?this.widthLimit:parseInt(this.width,10),bottom:isDocNotFullScreen?this.heightLimit:parseInt(this.height,10),left:BL?BL.totalColWidth:0};$FOREACHHASH(this._scroller,function(scrollers,axis){$FOREACHARRAY(scrollers,function(scroller){scroller.offset=getScrollerOffsets(me,axis);scroller.updateScrollBars(viewportCoords,domNode);var origin=scroller.origin;if(origin){scroller.scrollTo(origin.x,origin.y);}});});},setupScrollers:function setupScrollers(){var gd=this.gridData,MAX_OFFSETS=this._TMAX,noScrolling=this.noScrolling=((gd&&gd.co)||(!this.scrollerConfig.scrollPast&&MAX_OFFSETS.x===0&&MAX_OFFSETS.y===0));if(!noScrolling&&!this._scroller){isContainerScrollElement={x:false,y:false};translate(this._TSN.x,[0,0,0]);translate(this._TSN.y,[0,0,0]);createScrollers(this);}},onwidthChange:function onwidthChange(){updateOffsets.call(this,"width");if(this._super){this._super();}},onheightChange:function onheightChange(){updateOffsets.call(this,"height");if(this._super){this._super();}},unrender:function unrender(ignoreDom){$FOREACHHASH(this._scroller,function(scrollers){$FOREACHARRAY(scrollers,function(scroller){scroller.destroy();});});delete this._scroller;if(this._super){this._super(ignoreDom);}}});}());