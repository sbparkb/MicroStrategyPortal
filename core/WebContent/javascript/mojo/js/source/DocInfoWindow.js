(function(){mstrmojo.requiresCls("mstrmojo.Popup","mstrmojo._HasBuilder","mstrmojo._IsAnchorable","mstrmojo.hash","mstrmojo.array","mstrmojo.dom");var BASE_TIP_CLS="mstrmojo-DocInfoWindow-tip",DARK_BORDER_WIDTH=1,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash,$ARR=mstrmojo.array;$D=mstrmojo.dom,$A=mstrmojo.array;function _config(config){var anchor=this.anchor,w=$DOM.findWidget(anchor)||(anchor&&anchor.w),config=config||{};config.lockIW=w;return config;}function getContent(me){var model=me.model;return model.getLayoutDataCache(model.getCurrentLayoutKey())[me.psId];}mstrmojo.DocInfoWindow=mstrmojo.declare(mstrmojo.Popup,[mstrmojo._HasBuilder,mstrmojo._IsAnchorable,mstrmojo._HasPopup],{scriptClass:"mstrmojo.DocInfoWindow",markupString:'<div class="mstrmojo-DocInfoWindow-wrapper @{waitState}"><div id="{@id}" class="mstrmojo-DocInfoWindow"></div><div class="'+BASE_TIP_CLS+' top"></div><div class="mstrmojo-DocInfoWindow-curtain" mstrAttach:click></div></div>',markupSlots:{infoNode:function(){return this.domNode.firstChild;},tipNode:function(){return this.domNode.childNodes[1];},curtainNode:function(){return this.domNode.lastChild;},containerNode:function(){return this.domNode.firstChild;}},boundaryNodeName:"boundary",popupNodeName:"infoNode",baseTipClass:BASE_TIP_CLS,anchorOffset:1,anchorOrientation:"h",anchor:null,boundary:null,closeOnClick:true,autoCloseLocks:null,autoScrollCloseLocks:null,tipNodeColor:"",ontouchstart:function ontouchstart(){this.close();},close:function close(){if(this.isAutoCloseLocked()){return ;}this.model.raiseEvent({name:"infoWindowClosed",psKey:this.psKey});if(this._super){this._super();}if(this.anchor&&this.anchor.lockInfoWinId&&mstrmojo.all[this.anchor.lockInfoWinId]){mstrmojo.all[this.anchor.lockInfoWinId].releaseLock(this);}this.clearAnchorHilites();$DOM.detachEvent(document,$DOM.isFF?"DOMMouseScroll":"mousewheel",this.mw);$DOM.detachEvent(document,"scroll",this.mw);$DOM.detachEvent(window,"resize",this._resizeHandler);},clearAnchorHilites:function clearAnchorHilites(){var zn=mstrmojo.dom.findWidget(this.anchor);if(zn&&zn.clearHilites){zn.clearHilites(zn.hiliteKey);delete zn.hiliteKey;}},prepareAnchor:function prepareAnchor(){if(this.children&&this.children[0]){var infoNodeStyle=this.infoNode.style,contentChild=this.children[0],contentChildNode=contentChild.dimNode||contentChild.domNode,ifwWidth=contentChildNode.offsetWidth,ifwHeight=contentChildNode.offsetHeight;infoNodeStyle.width=(ifwWidth+2*DARK_BORDER_WIDTH)+"px";infoNodeStyle.height=(ifwHeight+2*DARK_BORDER_WIDTH)+"px";}},nudge:function nudge(){this.positionDialog();this.model.raiseEvent({name:"infoWindowRendered",id:this.id});},onRender:function onRender(){this.open(this.opener);},open:function open(opener,config){var ps=mstrmojo.all[this.psId];if(ps){var showFirstPanel=ps.defn.sfp,currentPanelIdx=ps.selectedIdx;if(showFirstPanel&&currentPanelIdx!==0){ps.switchToPanel(0,0);ps.children[currentPanelIdx].set("selected",false);}}if(this._super){this._super(opener,_config.call(this,config));}var refreshFP=function refreshFP(comp){if(!comp){return ;}if(comp.defn&&comp.defn.ifp){comp.refresh();}$ARR.forEach(comp.children||[],function(child){refreshFP(child);});};refreshFP(ps);if(mstrApp.isTablet&&mstrApp.isTablet()){var touchManager=mstrmojo.touchManager,id=this.id,infoWindowNode=this.domNode;this._tchHandler=touchManager.attachEventListener("touchesBegin",id,function(evt){if(this.isAutoCloseLocked()){return ;}var isTappingOnInfoWindow=mstrmojo.dom.contains(infoWindowNode,evt.touch.target,true);var infoboxes=document.getElementsByClassName("heatmap-infobox"),len=(infoboxes&&infoboxes.length)||0,i,target=evt.touch.target,isTappingOnHeatMapTooltip=false;for(i=0;i<len;i++){if(mstrmojo.dom.contains(infoboxes[i],target,true)){isTappingOnHeatMapTooltip=true;break;}}if(!isTappingOnInfoWindow&&!mstrApp.hasOpenDialog()&&!isTappingOnHeatMapTooltip){this.closeOnTablet();}});}var me=this;me.mw=me.mw||function(e){if(me.isAutoScrollCloseLocked()){return ;}if(me.autoCloses&&!$DOM.contains(me.domNode,$DOM.eventTarget(self,e),true,document.body)){me.close();}};me._resizeHandler=function(e){me.positionDialog(true);};$DOM.attachEvent(document,$DOM.isFF?"DOMMouseScroll":"mousewheel",me.mw);$DOM.attachEvent(document,"scroll",me.mw);$DOM.attachEvent(window,"resize",me._resizeHandler);},getChildren:function getChildren(){return[getContent(this)];},preBuildRendering:function preBuildRendering(){var c=getContent(this),f=c.defn.fmts;f.left=DARK_BORDER_WIDTH+"px";f.top=DARK_BORDER_WIDTH+"px";if(f.border){var tmp=f.border.split(" ");if(tmp.length>=3){this.tipNodeColor=tmp[2];}}if(this._super){this._super();}},postBuildRendering:function postBuildRendering(){this.set("visible",true);if(this._super){this._super();}if(!this.closeOnClick){this.curtainNode.style.display="none";}},closeOnTablet:function closeOnTablet(){this.close();if(this._tchHandler){this._tchHandler.clear();}},postwaitStateChange:function(){var contentChild=this.children[0],contentChildNode=contentChild.dimNode||contentChild.domNode;if(!this.waitState&&!contentChildNode){this.refresh();}},renderChildren:function(){if(!this.waitState){this._super();}},registerLock:function(lock){var locks=this.autoCloseLocks||[];if($ARR.indexOf(locks,lock.id)===-1){locks.push(lock.id);this.autoCloseLocks=locks;}},releaseLock:function(lock){$ARR.removeItem(this.autoCloseLocks,lock.id);},isAutoCloseLocked:function(){this.autoCloseLocks=$ARR.filter(this.autoCloseLocks,function(id){return !!mstrmojo.all[id];});return this.autoCloseLocks.length>0;},openPopupMenu:function(referencePropertyName,cfg){this.openPopup(referencePropertyName,cfg);},registerScrollLock:function(lock){var locks=this.autoScrollCloseLocks||[];if($A.indexOf(locks,lock.id)===-1){locks.push(lock.id);this.autoScrollCloseLocks=locks;}},releaseScrollLock:function(lock){$A.removeItem(this.autoScrollCloseLocks,lock.id);},isAutoScrollCloseLocked:function(){this.autoScrollCloseLocks=$A.filter(this.autoScrollCloseLocks,function(id){return !!mstrmojo.all[id];});return this.autoScrollCloseLocks.length>0;}});mstrmojo.DocInfoWindow.PLACEMENT={AUTO:1,FIXED:2,ABOVE:3,BELOW:4,LEFT:5,RIGHT:6};}());