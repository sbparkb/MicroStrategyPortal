(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.func","mstrmojo.Obj");var $HASH=mstrmojo.hash;var cnt=0;var requestQueue=[];var graphRequests={};var holdForGraphs=false;function handleSubmission(request){var callback=request.callback;if(callback.submission){callback.submission(request.id,this.userInteractionRequired(request),request);}this.submitRequest(request);}function submitNextInQueue(){if(requestQueue.length&&!holdForGraphs){handleSubmission.call(this,requestQueue.shift());}}mstrmojo.ServerProxy=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.ServerProxy",transport:null,cnt:0,request:function request(callback,params,override,config){if(override){this.cancelRequests();}var proxyId=this.id,transport=this.transport,requestId=mstrmojo.now()+params.taskId+cnt++,callbackCancel=callback.canceled||mstrmojo.emptyFn;callback.canceled=function(id){callbackCancel();callback.complete(true);return transport.cancelRequest(id);};callback=mstrmojo.func.wrapMethods(callback,{complete:function(id){mstrmojo.all[proxyId].deleteRequest(id);}});var existingRequests=!$HASH.isEmpty(this._requests),newRequest=this.createRequest(requestId,callback,params,config),holdRequests=(holdForGraphs||existingRequests)&&!config.doNotHold;if(holdRequests){requestQueue.push(newRequest);}else{handleSubmission.call(this,newRequest);}return requestId;},hasRequests:function hasRequests(){return !$HASH.isEmpty(this._requests)||holdForGraphs;},createRequest:function createRequest(requestId,callback,params,config){var reqsCollection=this._requests;if(!reqsCollection){reqsCollection=this._requests={};}reqsCollection[requestId]={id:requestId,callback:callback,params:params,config:config};return reqsCollection[requestId];},submitRequest:function submitRequest(request){this.transport.serverRequest(this.id,request.id,request);},cancelRequests:function cancelRequests(){var didCancel=false;$HASH.forEach(this._requests,function(request){if(request.gotResponse===undefined){didCancel|=request.callback.canceled(request.id);}});this._requests={};requestQueue=[];return didCancel;},cancelRequest:function cancelRequest(requestId){var didCancel=false,request=this._requests[requestId],i,l=requestQueue.length;for(i=0;i<l;i++){if(requestQueue[i]===request){break;}}if(i<l){requestQueue.splice(i,1);delete this._requests[requestId];didCancel|=request.callback.canceled(request.id);}return didCancel;},response:function response(requestId,status,res){$MAPF(false,"AndroidServerTransport","transportRequest");var request=this.getRequest(requestId);if(request){request.gotResponse=true;var callback=request.callback,methodName=(status&&!res.mstrerr)?"success":"failure";try{if(callback[methodName]){callback[methodName](res,request);}}finally{callback.complete(requestId);}}submitNextInQueue.call(this);},deleteRequest:function deleteRequest(requestId){var requestCollection=this._requests;delete requestCollection[requestId];},getRequest:function getRequest(requestId){var requestCollection=this._requests;return requestCollection&&requestCollection[requestId];},userInteractionRequired:function userInteractionRequired(request){return false;},addLoadingGraph:function addLoadingGraph(key){graphRequests[key]=true;holdForGraphs=true;},removeLoadingGraph:function removeLoadingGraph(key){delete graphRequests[key];if($HASH.isEmpty(graphRequests)){holdForGraphs=false;submitNextInQueue.call(this);}}});}());