(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo.BaseImageLayout","mstrmojo.VisEnum");function containPoint(x1,x2,y1,y2,ox,oy){return(ox>=x1&&ox<=x2&&oy>=y1&&oy<=y2);}function checkIntesection(x1,x2,y1,y2,coord){if(!coord){return false;}var nShape=coord.length,shapeIndex,shape,nPoint,pIndex,x,y;if(nShape===1&&coord[0].length===2){shape=coord[0];if(containPoint(x1,x2,y1,y2,shape[0],shape[1])){return true;}}else{for(shapeIndex=0;shapeIndex<nShape;shapeIndex++){shape=coord[shapeIndex];nPoint=shape.length;if(nPoint>2){if(nPoint%2===1){nPoint-=1;}for(pIndex=0;pIndex<nPoint-1;pIndex++){x=shape[pIndex];y=shape[pIndex+1];pIndex+=1;if(containPoint(x1,x2,y1,y2,x,y)){return true;}}}}for(shapeIndex=0;shapeIndex<nShape;shapeIndex++){shape=coord[shapeIndex];if(this.inPoly(shape,x1,y1)){return true;}}}return false;}mstrmojo.HtmlBaseImageLayout=mstrmojo.declare(mstrmojo.BaseImageLayout,null,{scriptClass:"mstrmojo.HtmlBaseImageLayout",isTablet:false,postBuildRendering:function(){if(this._super){this._super();}this.getMapAndDraw();},getTouchedObj:function getTouchedObj(isTap,touchX,touchY){var me=this,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,touchedObj=null,touchPointInHighlightArea,tx,ty;if(me.displayMode===DISPLAY_MODE.AREA){touchedObj=this.getAreaOrNearestBubble(isTap,touchX,touchY);}else{if(me.displayMode===DISPLAY_MODE.BUBBLE){touchedObj=this.getLastHighlightPoint();touchPointInHighlightArea=false;tx=0;ty=0;if(touchedObj){tx=touchedObj.point.x;ty=touchedObj.point.y;touchPointInHighlightArea=this.totalWidget.tooltipOn&&(tx-touchX)*(tx-touchX)+(ty-touchY)*(ty-touchY)<=this.totalWidget.bias*this.totalWidget.bias;}if(touchPointInHighlightArea){touchedObj=this.getLastHighlightPoint();}else{touchedObj=this.getAreaOrNearestBubble(isTap,touchX,touchY);}}}return touchedObj;},getTopPoint:function(touchedObj){var me=this,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,touchVal=touchedObj.touchVal,coords=me.coords,topPoint={x:0,y:0},i,j,maxY,curX,rgn,c,ct,rd,_image,_width,_height;if(!touchedObj){return topPoint;}if(me.displayMode===DISPLAY_MODE.AREA){maxY=Number.POSITIVE_INFINITY;curX=0;if(coords.hasOwnProperty(touchVal)){rgn=coords[touchVal];for(i in rgn){if(rgn.hasOwnProperty(i)){c=rgn[i];for(j=1;j<c.length;j+=2){if(maxY>c[j]){maxY=c[j];curX=c[j-1];}}}}topPoint={x:curX+me.leftOffset,y:maxY+me.topOffset};}}else{if(me.displayMode===DISPLAY_MODE.BUBBLE){if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){coords=me.polygonCenters;}if(coords.hasOwnProperty(touchVal)){ct=coords[touchVal][0];if(me.markerType===me.CONSTANTS.MARKER_TYPE.BUBBLE){rd=me.getRadiusFromName(touchVal);topPoint.x=ct[0]+me.leftOffset;topPoint.y=ct[1]+me.topOffset-rd;}else{if(me.markerType===me.CONSTANTS.MARKER_TYPE.IMAGE){_image=me["imageIcon_"+touchVal];_width=0;_height=0;if(_image){_width=_image.width;_height=_image.height;}topPoint.x=ct[0]+me.leftOffset+_width/2;topPoint.y=ct[1]+me.topOffset-_height/2;}}}}}return topPoint;},getAreaOrNearestBubble:function(isTap,touchX,touchY){var me=this,coords=me.coords,x,y,crHP,dis,touchVal,hdrIndex,lineIndex;if(me.CONSTANTS.DEBUG.LOG){console.log("oritouchX:"+touchX+"  oritouchY:"+touchY);}x=touchX-me.leftOffset;y=touchY-me.topOffset;if(isTap&&me.totalWidget.tooltipOn&&me.totalWidget.currHoverObj!==null){crHP=null;if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POLYGON){crHP=me.polygonCenters&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal]&&me.polygonCenters[me.totalWidget.currHoverObj.touchVal][0];}else{if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){crHP=coords[me.totalWidget.currHoverObj.touchVal]&&coords[me.totalWidget.currHoverObj.touchVal][0];}}if(crHP){dis=Math.sqrt((x-crHP[0])*(x-crHP[0])+(y-crHP[1])*(y-crHP[1]));if(dis<me.totalWidget.bias){touchVal=me.totalWidget.currHoverObj.touchVal;}else{touchVal=me.getTouchValue(x,y);}}else{touchVal=me.getTouchValue(x,y);}}else{touchVal=me.getTouchValue(x,y);}if(!touchVal){return null;}hdrIndex=me.getHeaderIndexFromTouchValue(touchVal);lineIndex=me.getLineIndexFromTouchValue(touchVal);return{touchVal:touchVal,hdrIndex:hdrIndex,lineIndex:lineIndex,point:{x:touchX,y:touchY}};},setDisplayParas:function setDisplayParas(){var me=this,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,PROPERTIES_TYPE=mstrmojo.VisEnum.IMAGELAYOUT_PROPERTIES;if(!me.setDisplayParasFlag){me.setDisplayParasFlag=true;}else{return ;}me.shapeFileType=me.getShapeFileType(me.coords);me.sizeByIndex=me.totalWidget.getSizeByIndex();me.colorByIndex=me.totalWidget.getColorByIndex();me.thresholdType=me.totalWidget.getThresholdType(me.colorByIndex);me.displayMode=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.DISPLAY_MODE);if(me.shapeFileType===me.CONSTANTS.SHAPE_FILE_TYPE.POINT){me.displayMode=DISPLAY_MODE.BUBBLE;propertyManager.setFormatPropertyValue("enableDisplayMode",false);}else{propertyManager.setFormatPropertyValue("enableDisplayMode",true);}if(me.displayMode===DISPLAY_MODE.AUTOMATIC&&(me.sizeByIndex>-1||me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.IMAGE)){me.displayMode=DISPLAY_MODE.BUBBLE;}if(me.displayMode===DISPLAY_MODE.BUBBLE){me.setBubbleModeParasWithData();}else{me.displayMode=DISPLAY_MODE.AREA;}propertyManager.setFormatPropertyValue("calcDisplayMode",me.displayMode);},setBubbleModeParasWithData:function setBubbleModeParasWithData(){var me=this;if(me.sizeByIndex>-1){me.markerType=me.CONSTANTS.MARKER_TYPE.BUBBLE;}else{if(me.thresholdType===me.CONSTANTS.THRESHOLD_TYPE.IMAGE){me.markerType=me.CONSTANTS.MARKER_TYPE.IMAGE;}else{me.markerType=me.CONSTANTS.MARKER_TYPE.BUBBLE;}}},getLassoElements:function(selected,i,j,x1,x2,y1,y2){var me=this,propertyManager=me.totalWidget.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,domNode=me.domNode,parentNode=domNode&&domNode.parentNode,cx=0,cy=0,cw=0,ch=0,pcx=0,pcy=0,coords=me.coords,shape,elem,hdrIndex,lineIndex;if(me.displayMode===DISPLAY_MODE.BUBBLE&&me.polygonCenters){coords=me.polygonCenters;}if(domNode){cx=domNode.offsetLeft;cy=domNode.offsetTop;cw=domNode.offsetWidth;ch=domNode.offsetHeight;}if(parentNode){pcx=parentNode.offsetLeft;pcy=parentNode.offsetTop;}x1=Math.max(x1-pcx-cx-this.leftOffset,0);x2=Math.min(x2-pcx-cx-this.leftOffset,cw);y1=Math.max(y1-pcy-cy-this.topOffset,0);y2=Math.min(y2-pcy-cy-this.topOffset,ch);for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}hdrIndex=me.getHeaderIndexFromTouchValue(elem);lineIndex=me.getLineIndexFromTouchValue(elem);if(hdrIndex>-1&&lineIndex>-1){if(checkIntesection.call(me,x1,x2,y1,y2,coords[elem])){shape={rowIndex:i,colIndex:j,touchVal:elem,lineIndex:lineIndex,hdrIndex:hdrIndex};selected.push(shape);}}}}}});}());