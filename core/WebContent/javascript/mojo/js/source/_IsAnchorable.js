(function(){mstrmojo.requiresCls("mstrmojo.dom");var $D=mstrmojo.dom,$MATH=Math;var PLACEMENT_AUTO=1,PLACEMENT_FIXED=2,PLACEMENT_BELOW=4,PLACEMENT_LEFT=5,PLACEMENT_RIGHT=6;function anchorPopup(hasNewPosition){var anchor=this.anchor;if(!anchor){return false;}var baseTipCls=this.baseTipClass,tipNode=this[this.tipNodeName];tipNode.className=baseTipCls+" top";var boundary=this[this.boundaryNodeName],popupNode=this[this.popupNodeName],editorOffset=this.anchorOffset,defaultOrientation=this.anchorOrientation,hasScrollbars=this.hasScrollbars(),anchorPosition=mstrmojo.hash.copy(this.anchorPosition||$D.position(anchor,true)),boundaryPosition=$D.position(boundary,true),boundaryRight=boundaryPosition.w,boundaryBottom=boundaryPosition.h,popWidth=popupNode.offsetWidth,popHeight=popupNode.offsetHeight,halfPopWidth=popWidth/2,halfPopHeight=popHeight/2,tipPosition=$D.position(tipNode),tipDimensionShort=$MATH.min(tipPosition.h,tipPosition.w),tipHalfLong=$MATH.max(tipPosition.h,tipPosition.w)/2,plm=parseInt(this.placement,10);if(hasNewPosition){anchorPosition=$D.position(anchor,true);}if(hasScrollbars){boundaryRight-=15;boundaryBottom-=15;}var popupInsideBoundary=$D.contains(boundary,popupNode),offsetTop=popupInsideBoundary?0:boundaryPosition.y,popLeft=boundaryRight/2-halfPopWidth,popTop=boundaryBottom/2-halfPopHeight+offsetTop,tipLeft=-1000,tipTop=-1000,tipClass,tipBorderStyles=["borderBottomColor","borderTopColor","borderRightColor","borderLeftColor"],tipStyleIdx=0;if(popupInsideBoundary){anchorPosition.x=anchorPosition.x-boundaryPosition.x;anchorPosition.y=anchorPosition.y-boundaryPosition.y;}var anchorBottom=anchorPosition.y+anchorPosition.h,anchorRight=anchorPosition.x+anchorPosition.w,fitsRight=((anchorRight+popWidth)<boundaryRight),fitsAbove=anchorPosition.y>popHeight,fitsBottom=((anchorBottom+popHeight)<boundaryBottom),fnBounds=function(minVal,maxVal,desiredVal){return $MATH.min($MATH.max(minVal,desiredVal),$MATH.max(maxVal,0));},fnVertFit=function(){if((anchorPosition.x<boundaryRight)&&(fitsBottom||fitsAbove)){var anchorMidWidth=anchorPosition.x+(anchorPosition.w/2),posBottom=(plm===PLACEMENT_BELOW&&fitsBottom)||!fitsAbove;if(posBottom){tipClass="top";tipTop=anchorBottom;tipStyleIdx=0;popTop=anchorBottom+tipDimensionShort-editorOffset;}else{tipClass="bottom";tipTop=anchorPosition.y-tipDimensionShort;tipStyleIdx=1;popTop=tipTop-popHeight+editorOffset;}popLeft=fnBounds(0,boundaryRight-popWidth,anchorMidWidth-halfPopWidth);tipLeft=fnBounds(anchorPosition.x,anchorRight,anchorMidWidth)-tipHalfLong;return true;}return false;},fnHorizFit=function(){if((anchorPosition.y<boundaryBottom)&&(fitsRight||anchorPosition.x>popWidth)){var anchorMidHeight=anchorPosition.y+(anchorPosition.h/2),posRight=!(plm===PLACEMENT_LEFT&&anchorPosition.x>popWidth)&&fitsRight;if(posRight){tipClass="left";tipLeft=anchorRight;tipStyleIdx=2;popLeft=anchorRight+tipDimensionShort-editorOffset;}else{tipClass="right";tipLeft=anchorPosition.x-tipDimensionShort;tipStyleIdx=3;popLeft=tipLeft-popWidth+editorOffset;}popTop=fnBounds(offsetTop,boundaryBottom-popHeight,anchorMidHeight-halfPopHeight);tipTop=fnBounds(anchorPosition.y,anchorBottom,anchorMidHeight)-tipHalfLong;return true;}return false;},testFns=[fnVertFit,fnHorizFit],i=0;if(plm===PLACEMENT_FIXED){popTop=this.popPosition.top;popLeft=this.popPosition.left;tipTop=-1000;tipLeft=-1000;tipClass=null;}else{if(plm===PLACEMENT_LEFT||plm===PLACEMENT_RIGHT||(plm===PLACEMENT_AUTO&&defaultOrientation==="h")){testFns.reverse();}for(i;i<2;i++){if(testFns[i]()){break;}}popTop=$MATH.round(popTop);popLeft=$MATH.round(popLeft);tipTop=$MATH.round(tipTop);tipLeft=$MATH.round(tipLeft);}tipNode.className=baseTipCls+" "+(tipClass||"hidden");var tipNodeStyle=tipNode.style,popupNodeStyle=popupNode.style;tipNodeStyle.top=tipTop+"px";tipNodeStyle.left=tipLeft+"px";if(this.tipNodeColor){mstrmojo.array.forEach(tipBorderStyles,function(s){tipNodeStyle[s]="";});tipNodeStyle[tipBorderStyles[tipStyleIdx]]=this.tipNodeColor;}popupNodeStyle.top=popTop+"px";popupNodeStyle.left=popLeft+"px";return true;}mstrmojo._IsAnchorable={anchor:null,anchorPosition:null,boundaryNodeName:"curtainNode",popupNodeName:"editorNode",tipNodeName:"tipNode",baseTipClass:"mstrmojo-Editor-tip",anchorOffset:25,anchorOrientation:"v",placement:PLACEMENT_AUTO,popPosition:null,hasScrollbars:function hasScrollbars(){return(!mstrApp.isTouchApp||!mstrApp.isTouchApp());},prepareAnchor:mstrmojo.emptyFn,positionDialog:function positionDialog(hasNewPosition){this.prepareAnchor();if(!anchorPopup.apply(this,[hasNewPosition])){if(typeof this._super==="function"){this._super();}}}};}());