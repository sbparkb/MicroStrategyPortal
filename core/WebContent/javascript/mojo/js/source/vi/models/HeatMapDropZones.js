(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.func","mstrmojo.VisUtility","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.vi.models.DropZonesModel","mstrmojo.vi.models._DropZoneCommon","mstrmojo.vi.models.EnumDragSources","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.util.ThresholdUtils");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$FUNC=mstrmojo.func,$OBJ_TYPES=mstrmojo.chart.model.enums.EnumDSSObjectType,$TARGET_POS=mstrmojo.vi.models.DropZonesModel.ENUM_TARGET_POSITION,$THRESHOLD_UTILS=mstrmojo.vi.util.ThresholdUtils,$DUMU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$DZ=mstrmojo.vi.viz.EnumDSSDropZones,$EDS=mstrmojo.vi.models.EnumDragSources,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$VISUTIL=mstrmojo.VisUtility,GROUPING=$DZ.Grouping,SIZE_BY=$DZ.SizeBy,COLOR_BY=$DZ.ColorBy,TOOLTIP=$DZ.AdditionalMetrics,HEATMAP_THRESHOLD_COLORS=["#CC2525","#E34B4B","#E97D7D","#79D479","#57BA57","#2CA02C"],HEATMAP_THRESHOLD_BANDS=[0.1,0.3,0.5,0.7,0.9];mstrmojo.vi.models.HeatMapDropZones=mstrmojo.declare(mstrmojo.vi.models.DropZonesModel,[mstrmojo.vi.models._DropZoneCommon],{scriptClass:"mstrmojo.vi.models.HeatMapDropZones",getHostModel:function getHostModel(){return this.getHost().model.data;},getDropZones:function getDropZones(){var dzf=this.getDZFlatStruct(),zones=[this.getZone(mstrmojo.desc(2941,"Grouping"),GROUPING,dzf.Grp,false,{title:mstrmojo.desc(13828)}),this.getZone(mstrmojo.desc(11663,"Size By"),SIZE_BY,dzf.SizeBy,false,{allowSingle:true,title:mstrmojo.desc(13829)}),this.getZone(mstrmojo.desc(11662,"Color By"),COLOR_BY,dzf.ColorBy,false,{title:mstrmojo.desc(11668)}),this.getZone(mstrmojo.desc(2962,"Tooltip"),TOOLTIP,dzf.AdditionalMetrics,false,{title:mstrmojo.desc(13827)})];this.dropZones=zones;return{n:this.getHost().defn.ttl,zones:zones};},getUnitMenuItems:function getUnitMenuItems(cfg,zone,item,el){var me=this,dzid=this.id,isMetric=this.isMetric(item),isAttr=this.isAttribute(item),items=zone.items,cnt=items.length,itemContext={zone:zone,idx:$ARR.find(items,"id",item.id),cnt:cnt,item:item,useDropzone:true},isElemGroup=(item.t===47&&item.st===12033),dataset=$DU.getDatasetFromAttributeId(this.docModel.datasets,item.did);if(isElemGroup){cfg.addMenuItem(mstrmojo.desc(13296,"Edit Groups..."),"eg",this.getCreateOrEditElementGroupFunc(itemContext));cfg.addSeparator();}this.addSortMenu(itemContext,cfg,false);cfg.addSeparator();if(isMetric){if(item.um){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedMetric(itemContext,"edit");},itemContext);cfg.addSeparator();}if(this.docModel.findDatasetIdFromUnit(item.did)&&!this.docModel.isFromSolrCube(item.did)&&!this.docModel.isFromMDXCube(item.did)){cfg.addSubMenuItem(mstrmojo.desc(11806,"Aggregate By"),"",dzid,me.getAggregateByMetricSubMenu,itemContext);cfg.addSeparator();}cfg.addEditorMenuItem(mstrmojo.desc(5188,"Calculation"),dzid,me.getCalculationEditorCfg,itemContext);cfg.addMenuItem(mstrmojo.desc(13624,"Create Metric..."),"",function(){me.newDerivedMetric(itemContext);},itemContext);}else{if(isAttr){var isDynamicLinkAttr=this.isDynamicLink(item);if(!dataset||!this.docModel.isMDXDataset(dataset)){if(item.da){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedAttribute(itemContext);},itemContext);cfg.addSeparator();}if(isAttr&&(item.de!==true)&&this.allowInsertNewAttribute(zone)&&!$VISUTIL.hasCGorCon(this.getHost(),item)&&!isDynamicLinkAttr){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){me.newDerivedAttribute(itemContext);},itemContext);}}if(!$DU.hasOldDEOverDatasets(item.did,this.docModel.datasets)&&!this.isRecursiveAttribute(item)&&!isDynamicLinkAttr){cfg.addMenuItem(mstrmojo.desc(13295,"Create Groups..."),"eg",this.getCreateOrEditElementGroupFunc(itemContext));}}}cfg.addSeparator();if(this.showNumberFormat(item)){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),dzid,this.getNumberFormatEditorCfg,itemContext);}if(isMetric){if(zone.id===COLOR_BY){this.buildThresholdMenuOptions(cfg,itemContext,true);}}if(this.shouldShowDisplayFormsMenu(item)){cfg.addEditorMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),this.id,function(){return me.getDisplayFormsMenu(item);});}cfg.addSeparator();if(me.hasReplaceCandidates(itemContext)){cfg.addSubMenuItem(mstrmojo.desc(14003,"Replace With"),"",dzid,me.getReplaceSubMenu,itemContext);}cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"",function(){me.renameItem(el,item);});cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){me.deleteItem(zone,me.getUnitIndexInZone(zone,item));});},getAvatarIconClass:function getAvatarIconClass(){return"viHeatMap";},getAllowDropInfo:function getAllowDropInfo(zone,dragItems,idx,edge,context){var baseInfo=this._super(zone,dragItems,idx,edge,context),candidates=baseInfo.allowedItems,me=this,isReplacing=edge===$TARGET_POS.ON,wantMetric,allowOnlyOne=false,replaceOnly=false,filterCandidates=function(WantMetric,OnlyFirst){return $ARR.filter(candidates,function(item){var isMetric=me.isMetric(item);return WantMetric?isMetric:!isMetric;},OnlyFirst?{max:1}:null);};switch(zone.id){case GROUPING:wantMetric=false;break;case COLOR_BY:var hasAttr=!!filterCandidates(false,true).length,hasMetric=!!filterCandidates(true,true).length,isMetricZone=this.isMetricZone(zone.id);if(isMetricZone){wantMetric=hasMetric;}else{wantMetric=!hasAttr;}allowOnlyOne=wantMetric;replaceOnly=isMetricZone||wantMetric;break;case SIZE_BY:wantMetric=true;allowOnlyOne=true;replaceOnly=true;break;case TOOLTIP:wantMetric=true;candidates=candidates.filter(function(item){var zonesToCheck=[SIZE_BY,COLOR_BY],dragData=context.src.data;if(dragData.src===$EDS.VIZ_EDITOR){$ARR.removeItem(zonesToCheck,dragData.srcZoneId);}return zonesToCheck.every(function(ztcid){return me.getUnitIndexInZone(me.getZoneModelByZoneId(ztcid),item)===-1;});});break;}return $HASH.copy({allowedItems:(replaceOnly&&!(zone.items.length===0||isReplacing))?[]:filterCandidates(wantMetric,allowOnlyOne),removeReplaced:isReplacing&&(replaceOnly||$ARR.find(dragItems,"did",zone.items[idx].did)===-1)},baseInfo);},unitsDropped:function unitsDropped(zone,context,dropInfo,isPrimary,splitMetric){var dragData=context.src.data,actions=context.actions||[],idx=dropInfo.idx,edge=dropInfo.edge,allowedItems=dropInfo.allowedItems,replaceItem=(edge===$TARGET_POS.ON&&dropInfo.removeReplaced)?zone.items[idx]:null,me=this,cbFunc=function(){var templateActions=me.getAddItemActions(zone,allowedItems,me.getDropTargetIndex(zone,dropInfo),true,replaceItem,dragData.dsid);me.submitDropZoneUpdates(actions.concat(me.getUpdateTemplateAction(templateActions)),$FUNC.wrapMethods(context.callback,me.getHost().model.docModel.controller._getXtabCallback(me.getHost())));};if(zone.id===GROUPING||(!this.isMetric(allowedItems[0])&&zone.id===COLOR_BY)){this.checkAndWarnLargeItemsForAddUnits(allowedItems,cbFunc);return ;}cbFunc();},getAddItemActions:function addItem(zone,items,idx,isDND,replaceItem,datasetId){var zoneID=zone.id,isMetric=this.isMetric(items[0]),me=this,extras={datasetId:datasetId},actions=[],needToAddThresholds=false,checkAndAddToZone=function(zid){var otherZone=me.getZoneModelByZoneId(zid),itemsCount=otherZone.items.length,itemsToAdd=items.filter(function(itm){return isMetric?(isDND&&itemsCount===0):(me.getUnitIndexInZone(otherZone,itm)===-1);});if(itemsToAdd.length){$ARR.insert(actions,null,me.getAddDropZoneUnitsActions(otherZone,itemsToAdd,isMetric?0:itemsCount,extras));return true;}},removeDuplicateInZone=function(zid){var otherZone=me.getZoneModelByZoneId(zid);items.forEach(function(itm){if(me.getUnitIndexInZone(otherZone,itm)!==-1){actions.push(me.getRemoveDropZoneUnitAction(otherZone,itm,1));}});};switch(zoneID){case SIZE_BY:needToAddThresholds=checkAndAddToZone(COLOR_BY);removeDuplicateInZone(TOOLTIP);break;case COLOR_BY:if(isMetric||this.isMetricZone(zoneID)){zone.items.forEach(function(item){actions.push(me.getRemoveDropZoneUnitAction(zone,item));});idx=0;replaceItem=null;}checkAndAddToZone(isMetric?SIZE_BY:GROUPING);if(isMetric){removeDuplicateInZone(TOOLTIP);needToAddThresholds=true;}break;case TOOLTIP:removeDuplicateInZone(SIZE_BY);removeDuplicateInZone(COLOR_BY);break;}if(replaceItem){actions.push(this.getRemoveDropZoneUnitAction(zone,replaceItem));}$ARR.insert(actions,null,this.getAddDropZoneUnitsActions(zone,items,idx,extras));if(needToAddThresholds){this.checkAndAddThresholdAction(COLOR_BY,items[0],actions);}return actions;},checkAndAddThresholdAction:function checkAndAddThresholdAction(zoneID,item,actions){var host=this.getHost();if(zoneID===COLOR_BY&&this.isMetric(item)){$THRESHOLD_UTILS.addThresholds(host.model,host,host.node,item,actions,HEATMAP_THRESHOLD_COLORS,HEATMAP_THRESHOLD_BANDS,false);return true;}return false;},deleteItem:function deleteItem(zone,idx){this.submitDropZoneTemplateUpdates([this.getRemoveDropZoneUnitAction(zone,zone.items[idx])]);},deleteItems:function deleteItem(zone,items){var me=this;this.submitDropZoneTemplateUpdates(items.map(function(itm){return me.getRemoveDropZoneUnitAction(zone,itm);}));},getHighlightTargets:function getHighlightTargets(zonesSource,dropInfo){if(zonesSource.id===COLOR_BY&&zonesSource.items.length&&dropInfo.item.t!==zonesSource.items[dropInfo.idx].t){var res=[];zonesSource.items.forEach(function(item,ix){res.push({idx:ix,edge:dropInfo.edge});},this);return res;}return this._super(zonesSource,dropInfo);},getReplaceCandidates:function getReplaceCandidates(zone,item){var candidates=this._super(zone,item);if(zone.id===COLOR_BY){var diffTypeItems=this._super(zone,{t:item.t===4?12:4});candidates=candidates.concat(diffTypeItems);}return $DUMU.getSortedDatasetUnits(candidates);}});}());