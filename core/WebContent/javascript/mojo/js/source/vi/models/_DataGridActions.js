(function(){mstrmojo.requiresCls("mstrmojo.EnumRWUnitType","mstrmojo.DocDataService","mstrmojo.array","mstrmojo.hash");var $MOJO=mstrmojo,$HASH=$MOJO.hash,$ARRAY=$MOJO.array,$RW_UNIT_TYPES=$MOJO.EnumRWUnitType,REQUEST_DEFN_DATA=$MOJO.DocDataService.REQUEST_DEFN_DATA;mstrmojo.vi.models._DataGridActions=mstrmojo.provide("mstrmojo.vi.models._DataGridActions",{_mixinName:"mstrmojo.vi.models._DataGridActions",createViewDataGrid:function createViewDataGrid(units,targetKey,filterData,callback,dsId,template,dropZones){var move=false,dataService=this.dataService,sourceKey=function(){if(template){return template.k;}var copyKey="K51";try{var blankTemplateKey=this.getCurrentLayoutDef().btsd;if(blankTemplateKey){copyKey=blankTemplateKey;move=true;}else{if(this.getTargetDefn("K48").K48){copyKey="K48";move=true;}}}catch(e){}return copyKey;}.call(this),node=this.createNewUnitNode(function(data){data.gsi={cols:[],rows:[],mx:[]};return data;},function(defn){defn.t=$RW_UNIT_TYPES.GRID;var formats=defn.fmts;formats.height="350px";formats.width="600px";return new mstrmojo.Model(defn);},null,move?sourceKey:this.getNextKey()),newGridKey=node.k,docModelId=this.id,newGrid=this.getDocBuilder().build([node],this,{pk:targetKey,isViewDataGrid:true})[0],templateActions=[{act:"changeXtabColWidthScenario",value:2}],update=this.getDataService().newUpdate(),rai=0,cai=0,formatUnitsArr=[],pivotActions=[],fakeData=template&&$HASH.copy(template.model.data);if(fakeData){fakeData.gsi=$HASH.clone(template.model.data.gsi);mstrmojo.vi.util.ThresholdUtils.addClearAllThresholdsActions(template.model,{data:fakeData},templateActions);}(units||[]).forEach(function(item){templateActions.push(newGrid.model.getAddTemplateUnitAction(item,item.dsId||dsId,item.t===4?2:1,item.t===4?cai++:rai++));});if(template&&dropZones){pivotActions.push({act:"pivot",unitId:"",unitType:"",axis:2,unitPos:1});$ARRAY.forEach(dropZones.zones,function(zone){if(zone.id!==1){$ARRAY.forEach(zone.items,function(item){if(item.t===12){pivotActions.push({act:"pivot",unitId:item.did,unitType:12,axis:1,unitPos:1});}});}$ARRAY.forEach(zone.items,function(item){if(item.t===4&&item.did!=="-1"){formatUnitsArr.push({unitId:item.did,unitType:4,regions:["g"]});}});});if(!move){if(formatUnitsArr.length>0){templateActions.push({act:"formatGridZone",nodeKey:newGridKey,props:{FormattingPatterns:{FillColor:16777215,FillStyle:0},FormattingFont:{Color:6974058},FormattingAlignment:{Horizontal:4}},units:formatUnitsArr,axis:[{axis:1,regions:["sg"]},{axis:2,regions:["sg"]}]});}templateActions.push({act:"formatGridZone",nodeKey:newGridKey,props:{FormattingPatterns:{FillColor:16777215,FillStyle:0},FormattingFont:{Color:6974058},FormattingAlignment:{Horizontal:2}},units:[],axis:[{axis:1,regions:["g","sh"]}]},{act:"formatGridZone",nodeKey:newGridKey,props:{FormattingPatterns:{FillColor:15461355,FillStyle:0},FormattingFont:{Color:6974058},FormattingAlignment:{Horizontal:2}},units:[],axis:[{axis:1,regions:["h"]},{axis:2,regions:["h","g","sh"]}]},{act:"formatGridZone",nodeKey:newGridKey,props:{FormattingAlignment:{Horizontal:4}},units:[],axis:[{axis:2,regions:["h","g","sh"]}]});}templateActions=templateActions.concat(pivotActions);templateActions.push({act:"advancedProperties",props:{"Template Formatting":{MergeCells:"0",MergeColumnCells:"0",LockColumnHeaders:"-1"}}});}update.addActions(move?dataService.getMoveNodeAction(node,targetKey):{act:"copyUnit",unitKey:sourceKey,unitType:521,newKey:newGridKey,toKey:targetKey});update.addActions({act:"updateTemplate",keyContext:newGridKey,partialRetrieval:dataService.newRetrievalKeysConfig().addNode(newGridKey,{data:{exclude:{vfexpr:true}}}),actions:templateActions});update.addActions(this.getUnitFormatAction(node,1,{FormattingSize:{Height:0,Width:0}}));if(template&&dropZones){update.addActions({act:"format",unitKey:newGridKey,unitType:521,formatType:1,format:{Visualization:{VisualizationsEnabled:0,ViewMode:0,SelectedVisualization:"",IPhoneVisualization:"",IPadVisualization:"",APhoneVisualization:"",ATabletVisualization:""},FormattingIncrementalFetch:{EnableIFOnGrid:-1},FormattingWidget:{ClassName:"",Enable:0,WidgetProps:""}}});}if(!$HASH.isEmpty(filterData)){update.addActions(this.getKeepOnlyOrExcludeAction(newGridKey,filterData));}if(dsId){update.addActions({act:"editNode",nodeKey:newGridKey,datasetId:dsId});}if(template&&dropZones){var docRelPanel=template.parent.parent;$ARRAY.forEach(docRelPanel.getTargetKeysByType([$RW_UNIT_TYPES.SELECTOR]),function(selectorKey){var sdef=docRelPanel.getUnitByKey(selectorKey).defn,sourceType=sdef.srct,sourceSubType=sdef.srcst,isUC=((sourceType===47&&sourceSubType!==12033)||sourceType===1),action;if((sdef.tks||"").indexOf(template.k)>-1){action=this.dataService.getAddCtrlTargetAction(sdef.ck,newGridKey,null,isUC,true,true);delete action.partialRetrieval;update.addActions(action);}},this);var newCGB=true,cgbKey,separateFilter=template.getFilterType()===1;$ARRAY.forEach(docRelPanel.getTargetKeysByType([$RW_UNIT_TYPES.GRID,$RW_UNIT_TYPES.GRAPH,$RW_UNIT_TYPES.MOJOVISUALIZATION]),function(vizKey){var vis=docRelPanel.getUnitByKey(vizKey).boxContent,an=vis.defn.an,isTargetSrcViz=$ARRAY.find(an,"k",template.k)!==-1,sc;if(isTargetSrcViz){if(newCGB){cgbKey=this.getNextKey();}sc=vis.findSelectorControl();if(sc){update.addActions({act:"addVisToFilter",parentKey:vizKey,targetKey:newGridKey,ctrlKey:sc.ckey,newCGB:newCGB,cgbKey:cgbKey});if(!separateFilter){newCGB=false;}}}},this);}update.addActions({act:"changeGridDisplayMode",nodeKey:newGridKey,displayMode:1});update.addCallbacks({success:function success(res){var model=mstrmojo.all[docModelId];model.partialUpdate(res.data,model.getTargetDefn(newGridKey),res.defn,res.pukeys&&res.pukeys.split("\u001E"),res.puFilters);callback.success(newGrid);},failure:callback.failure});update.addExtras(REQUEST_DEFN_DATA);this.execute({execute:function execute(){this.submitUpdate(update,mstrmojo.all[docModelId].cmdMgr().CMD_PHASE.FIRST);}});return move;},removeViewDataGrid:function removeViewDataGrid(grid,copy,moved,callbacks){var cmd=this.cmdMgr().getInterimCmd();if(!copy){cmd.cancel();}else{var ds=this.getDataService(),docModelId=this.id,removeActions=[],actions=[],zones=grid.zonesModel.getDropZones().zones,panelKey,node,layoutKey,viPanel,newItem,update=ds.newUpdateWithoutCmd();update.addCallbacks(callbacks);if(copy){node=this.createNewVizNode({title:mstrmojo.desc(11693,"Visualization")});layoutKey=this.getCurrentLayoutKey();viPanel=this.getPanel(null,layoutKey);panelKey=viPanel.k;newItem=this.getDocBuilder().build([node],this,{pk:panelKey})[0];update.addActions([{act:"macroCopyUnit",unitKey:grid.k,unitType:521,newKey:newItem.k,toKey:panelKey},mstrmojo.all[docModelId].getUnitFormatAction(node,1,{FormattingView:{Title:mstrmojo.desc(11693,"Visualization")}})]);viPanel.insertNewBoxAndSaveDeferred(update,newItem);update.actions.forEach(function(i){delete i.partialRetrieval;});update.actions[0].partialRetrieval=ds.newRetrievalKeysConfig().addNode(newItem.k);}if(moved){zones.forEach(function(zone){zone.items.forEach(function(unit){if(parseInt(unit.did,10)!==-1){removeActions.push(grid.model.getRemoveTemplateUnitAction(unit));}});});if(removeActions.length>0){actions.push({act:"updateTemplate",keyContext:grid.k,actions:removeActions});}actions.push(ds.getMoveNodeAction(grid,"K12"));}else{actions.push({act:"removeUnit",unitKey:grid.k,unitType:grid.defn.t});}update.addActions(actions);update.addCallbacks({success:function success(res){var dm=mstrmojo.all[docModelId];dm.partialUpdate(res.data,dm.getTargetDefn(newItem.k),res.defn);dm.updateDataCache(dm.data,dm.getTargetDefn(panelKey));dm.selectVIUnit(viPanel.rebuildChild(newItem).id);}});update.addExtras(REQUEST_DEFN_DATA);cmd.urInfo.extraPuKeys=[viPanel.k];cmd.submit(update.actions,update.callback,update.extras,this.cmdMgr().CMD_PHASE.LAST);}}});}());