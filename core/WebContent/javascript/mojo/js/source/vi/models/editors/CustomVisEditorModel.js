(function(){mstrmojo.requiresCls("mstrmojo.vi.models.editors.BaseEditorModel","mstrmojo.vi.models.editors.ControlsViewFactory","mstrmojo.vi.models.editors.EditorModel","mstrmojo.models.FormatModel","mstrmojo.CustomVisBase","mstrmojo.ui.CheckList","mstrmojo.gm.GMUtility","mstrmojo.ui.editors.controls.Stepper","mstrmojo.NumGroupStepperContentProvider","mstrmojo.VisUtility","mstrmojo.gm.GMEnums");mstrmojo.requiresClsP("mstrmojo.ui.editors.controls","ComboBox","PreviewButton","CharacterGroup","FillConfigGroup","LineConfigGroup");var EMPTY_FN=mstrmojo.emptyFn,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$VIS_UTILITY=mstrmojo.VisUtility,$GM_UTIL=mstrmojo.gm.GMUtility,FN_ENSURE_ARRAY=$ARR.ensureArray,$ENUM_FORMAT_PROPERTIES=mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES,$CHARACTER_CTRL_FLAGS=mstrmojo.ui.editors.controls.CharacterGroup.CTRL_FLAGS,$NWB=mstrmojo.Button.newWebButton,FILL_CONFIG_CONTROL=mstrmojo.ui.editors.controls.FillConfigGroup.CTRL_FLAGS,COL1_WIDTH="30%",COL2_WIDTH="70%";function findSelectedIndex(items,selectedValue){var ret=null,lastItem;if(typeof selectedValue==="number"){$ARR.forEach(items,function(item,i){if(!lastItem){ret=i;}else{if((selectedValue-item.value)*(selectedValue-lastItem.value)<=0){ret=Math.abs(selectedValue-item.value)<Math.abs(selectedValue-lastItem.value)?i:i-1;return false;}}lastItem=item;});}else{if(typeof selectedValue==="string"){$ARR.forEach(items,function(item,i){if(item.value.toString()===selectedValue){ret=i;return false;}});}}return ret;}function mapNameAndValue(items){return FN_ENSURE_ARRAY(items).map(function(item){return{n:item.name,v:item.value};});}function savePropertyAndUpdateWidget(propName,newValue,config){var host=this.getHost(),docModel=this.docModel;if(!config||config.suppressData===undefined){config=$HASH.copy({suppressData:true},config);}host.setProperty(propName,newValue,config);if(config.suppressData){var fn=config.callback instanceof Function?config.callback:host.renderVisualization.bind(host);fn();var selectedIndex=this._targetPulldown.selectedIndex;docModel.selectVIUnit(host.parent.id,true);this._targetPulldown.set("selectedIndex",selectedIndex);}}function saveObjectProperty(propName,subPropName,newValue,config){var host=this.getHost(),savedProperties=$HASH.clone(host.getProperty(propName))||{};savedProperties[subPropName]=newValue;savePropertyAndUpdateWidget.call(this,propName,savedProperties,config);}function handleControlDisabled(control,props){control.set("enabled",!props.disabled);var disabledChildren=FN_ENSURE_ARRAY(props.items);if(disabledChildren.length>0&&control.getChildControl instanceof Function){disabledChildren.forEach(function(childConfig){var childControl=control.getChildControl(childConfig.childName),disabled=childConfig.disabled;if(childControl&&disabled!==undefined){childControl.set("enabled",!disabled);}});}}function getTwoColumnContainer(controls,col1Width,col2Width,config){controls.forEach(function(ctrl,idx){ctrl.slot="col"+(idx+1)+"Node";});config=$HASH.copy(config,{col1Width:col1Width,col2Width:col2Width,children:controls});var control=new mstrmojo.ui.editors.controls.TwoColumnContainer(config);handleControlDisabled(control,config);return control;}function getPullDownControl(propItem){var me=this,host=me.getHost(),propertyName=propItem.propertyName,index=findSelectedIndex.call(this,propItem.items,host.getProperty(propertyName));var control=this.getPulldown(mapNameAndValue(propItem.items),function(newValue){savePropertyAndUpdateWidget.call(me,propertyName,newValue,propItem.config);},index||0);handleControlDisabled(control,propItem);return control;}function getSelectedIndices(items,values){var selected={};if(values){items.forEach(function(item,index){var value=values[item.propertyName];if(value==="true"||value===true){selected[index]=true;}});}return selected;}function getCheckBoxAndLabelControl(propItem){var me=this,host=me.getHost(),propertyName=propItem.propertyName,propValue=host.getProperty(propertyName),isChecked=propValue==="true"?true:(propValue==="false"?false:propItem.value);var control=this.getCheckboxAndLabel(isChecked,propItem.labelText,function(newValue){savePropertyAndUpdateWidget.call(me,propertyName,newValue.toString(),propItem.config);});handleControlDisabled(control,propItem);return control;}function getListControl(propItem,constructor,extraProps){var me=this,host=me.getHost(),propertyName=propItem.propertyName,items=FN_ENSURE_ARRAY(propItem.items).map(function(item){return{n:item.labelText,propertyName:item.propertyName};});var props={items:items,multiSelect:propItem.multiSelect,selectedIndices:getSelectedIndices(items,host.getProperty(propertyName)),postselectionChange:function(evt){var added=evt.added,targetItem=this.items[added?added[0]:evt.removed[0]],isSelected=!!added,newValues=$HASH.clone(host.getProperty(propertyName))||{};if(this.multiSelect){newValues[targetItem.propertyName]=isSelected.toString();}else{this.items.forEach(function(item){newValues[item.propertyName]=(item===targetItem?isSelected:!isSelected).toString();});}savePropertyAndUpdateWidget.call(me,propertyName,newValues,propItem.config);}};$HASH.copy(extraProps,props);var control=new constructor(props);handleControlDisabled(control,propItem);return control;}function getButtonBarControl(propItem){return getListControl.call(this,propItem,mstrmojo.ui.ButtonBar,{showIcon:false});}function getCheckListControl(propItem){return getListControl.call(this,propItem,mstrmojo.ui.CheckList,{cssClass:"selectors",orientation:propItem.orientation});}function getTwoColumnControl(propItem){var me=this,controls=[];$ARR.forEach(propItem,function(prop){controls.push(getSpecicControl.call(me,prop));});return controls;}function getLabelControl(label){return new mstrmojo.Label({text:label});}function getTextBoxControl(propItem){var me=this,host=me.getHost(),propertyName=propItem.propertyName,config=propItem.config;var props={value:host.getProperty(propertyName),onValid:function(){savePropertyAndUpdateWidget.call(me,propertyName,this.value,config);}};var control=new mstrmojo.ui.editors.controls.ValidationTextBox(props);handleControlDisabled(control,propItem);return control;}function getStepperControl(propItem){var me=this,host=me.getHost(),propertyName=propItem.propertyName;var props={provider:new mstrmojo.NumStepperContentProvider({item:{interval:1,value:Number(host.getProperty(propertyName))||propItem.min||0},min:propItem.min,max:propItem.max,container:this,onTraverse:function(){savePropertyAndUpdateWidget.call(me,propertyName,this.curVal,propItem.config);}})};var control=new mstrmojo.ui.editors.controls.Stepper(props);handleControlDisabled(control,propItem);return control;}function getPreviewButtonControl(propItem){var me=this,host=me.getHost(),propertyName=propItem.propertyName;var props={selectedValue:host.getProperty(propertyName),items:mapNameAndValue(propItem.items),isHostedWithin:false,postselectedValueChange:function(evt){savePropertyAndUpdateWidget.call(me,propertyName,evt.value,propItem.config);}};var control=new mstrmojo.ui.editors.controls.ComboBox(props);handleControlDisabled(control,propItem);return control;}function getGroupControl(propItem,constructor,childPropertyNames,getChildComp){var me=this,host=this.getHost(),propertyName=propItem.propertyName,control;var props={getChildComp:getChildComp,onGroupValueChange:function(childPropertyName,value){saveObjectProperty.call(me,propertyName,childPropertyName,value,propItem.config);},getChildControl:function(childName){return this.getChildComp(childName);}};$HASH.copyProps(["showGradient","showNoFill","showAutomatic"],propItem,props);control=new constructor(props);if(constructor===mstrmojo.ui.editors.controls.LineConfigGroup){var lineStyleCtrl=control.lineColorAndStyle.lineStyle;lineStyleCtrl.showNoneOption=control.showNoneOption;lineStyleCtrl.postInit();}var savedProperties=host.getProperty(propertyName)||{};childPropertyNames.forEach(function(childPropertyName){control.setChildValue(childPropertyName,savedProperties[childPropertyName]);});control.iniChildrenComp(childPropertyNames);handleControlDisabled(control,propItem);return control;}function reverseNameMap(map){var reversedMap={};$HASH.forEach(map,function(value,key){reversedMap[value]=key;});return reversedMap;}function getFormatSource(savedProperties,propertyNameMap){var formatSource={};if(savedProperties){$HASH.forEach(propertyNameMap,function(value,key){formatSource[value]=savedProperties[key];});}return formatSource;}function getCharacterGroupControl(propItem){var me=this,host=this.getHost(),config=propItem&&propItem.config,propertyName=propItem.propertyName,visibleControls=0,control,PROPERTY_NAME_MAP={fontSize:$ENUM_FORMAT_PROPERTIES.FONT_SIZE,fontColor:$ENUM_FORMAT_PROPERTIES.COLOR,fontFamily:$ENUM_FORMAT_PROPERTIES.FONT_FAMILY,fontWeight:$ENUM_FORMAT_PROPERTIES.FONT_WEIGHT,fontItalic:$ENUM_FORMAT_PROPERTIES.FONT_STYLE,fontUnderline:$ENUM_FORMAT_PROPERTIES.UNDERLINE,fontLineThrough:$ENUM_FORMAT_PROPERTIES.LINE_THROUGH};if(propItem){if(propItem.showFontFamily!==false){visibleControls=visibleControls|$CHARACTER_CTRL_FLAGS.FONT_FAMILY;}if(propItem.showFontStyle!==false){visibleControls=visibleControls|$CHARACTER_CTRL_FLAGS.FONT_STYLE;}if(propItem.showFontSizeAndColor!==false){visibleControls=visibleControls|$CHARACTER_CTRL_FLAGS.FONT_SIZE_AND_COLOR;}if(propItem.isFontSizeStepper===true){visibleControls=visibleControls|$CHARACTER_CTRL_FLAGS.FONT_SIZE_USE_STEPPER;}}var props={visibleControls:visibleControls,onGroupValueChange:function(propName,value){if(propName===$ENUM_FORMAT_PROPERTIES.FONT_SIZE){if(this.visibleControls&$CHARACTER_CTRL_FLAGS.FONT_SIZE_USE_STEPPER){value=value[0];}value=parseInt(value,10)+"pt";}saveObjectProperty.call(me,propertyName,reverseNameMap(PROPERTY_NAME_MAP)[propName],value,config);},getChildControl:function(childName){return this[childName];}};control=new mstrmojo.ui.editors.controls.CharacterGroup(props);var savedProperties=host.getProperty(propertyName),formats=getFormatSource(savedProperties,PROPERTY_NAME_MAP),fontSize=formats[$ENUM_FORMAT_PROPERTIES.FONT_SIZE];if(propItem.isFontSizeStepper&&fontSize){formats[$ENUM_FORMAT_PROPERTIES.FONT_SIZE]=[parseInt(fontSize,10)];}control.setFormatSource(formats);handleControlDisabled(control,propItem);return control;}function getFillGroupControl(propItem){var childColor="fillColor",childFillAlpha="fillAlpha";return getGroupControl.call(this,propItem,mstrmojo.ui.editors.controls.FillConfigGroup,[childColor,childFillAlpha],function(propName){if(propName===childColor){return this.fillColorAndTrans.fillColor;}if(propName===childFillAlpha){return this.fillColorAndTrans.fillAlpha.fillAlphaText;}return undefined;});}function getLineGroupControl(propItem){var childColor="lineColor",childStyle="lineStyle";return getGroupControl.call(this,propItem,mstrmojo.ui.editors.controls.LineConfigGroup,[childColor,childStyle],function(propName){if(propName===childColor){return this.lineColorAndStyle.lineColor;}if(propName===childStyle){return this.lineColorAndStyle.lineStyle;}return undefined;});}function getColorByGroupControl(){var host=this.getHost();function setColorAndOpacity(idx){function set(){if(idx===undefined){idx=0;}else{selectedIdx=idx;}var item=cbElements[idx];this.setChildValue(SHAPE_FILL,item.color);}this.syncControls(set);}function getColorByZoneItems(){var zonesModel=host.zonesModel,zones=zonesModel.getCustomDropZones(),zoneItems=[];$ARR.forEach(zones,function(zone,idx){if(zone.isColorBy===true){zoneItems=zonesModel.dropZones[idx].items;}});return zoneItems;}function getShapeItems(cbElements){return cbElements.map(function(item,idx){return{n:item.text,title:item.text,v:idx};});}var cbElements=host.getColorByAttInfo(getColorByZoneItems.call(this)),shapeItems=getShapeItems(cbElements),SHAPE_FILL="ShapeClr",SHAPE_OPACITY="ShapeFillTrans",selectedIdx,itemPulldown,index=0,color,realIndexes=$VIS_UTILITY.range(1,shapeItems.length);color=new mstrmojo.ui.editors.controls.FillConfigGroup({visibleControls:FILL_CONFIG_CONTROL.FILL_COLOR,onGroupValueChange:function(name,newVal){var indexArray=[].concat(!selectedIdx?realIndexes:selectedIdx),isShapeFill=name===SHAPE_FILL,newValues=[],combList=[],elem,comb;indexArray.forEach(function(idx){elem=cbElements[idx];comb=elem&&elem.comb;combList.push(comb);if(isShapeFill){newValues.push($GM_UTIL.encodeColor(newVal));elem.color=newVal;}});if(isShapeFill){host.updateColorMap(combList,newValues);}}});if(color){color.iniChildrenComp([SHAPE_FILL]);setColorAndOpacity.call(color,selectedIdx);}itemPulldown=this.getPulldown(shapeItems,setColorAndOpacity.bind(color),index||0);return this.getEditorGroup([this.getGroupTitle(mstrmojo.desc(13753,"Shape Color")),itemPulldown,color]);}function inputValidation(props,duplicate,exist,invalid){var style=props.style,propName=props.propertyName,$WT=mstrmojo.vi.models.editors.CustomVisEditorModel.WIDGET_TYPE,reg=/^[a-z A-Z\u4e00-\u9fa5:]{1}([\w]|[\u4e00-\u9fa5]|[-.:_]){1,}$/;if(style&&props.style!==$WT.TWOCOLUMN&&props.style!==$WT.EDITORGROUP){if(!!propName&&exist.indexOf(propName)!==-1&&duplicate.indexOf(propName)===-1){duplicate.push(propName);}else{if(!!propName&&exist.indexOf(propName)===-1){exist.push(propName);}}if(!reg.test(propName)&&invalid.indexOf(propName)===-1){invalid.push(propName);}return ;}else{if(style&&(props.style===$WT.TWOCOLUMN||props.style===$WT.EDITORGROUP)){inputValidation(FN_ENSURE_ARRAY(props.items),duplicate,exist,invalid);}}$ARR.forEach(props,function(prop){inputValidation(prop,duplicate,exist,invalid);});}function getSpecicControl(propItem){switch(propItem.style){case $WT.TWOCOLUMN:var props=FN_ENSURE_ARRAY(propItem.items),prop0=props[0],prop1=props[1];COL1_WIDTH=(prop0&&prop0.width)||COL1_WIDTH;COL2_WIDTH=(prop1&&prop1.width)||COL2_WIDTH;return getTwoColumnContainer.call(this,getTwoColumnControl.call(this,props),COL1_WIDTH,COL2_WIDTH,propItem);case $WT.PULLDOWN:return getPullDownControl.call(this,propItem);case $WT.LABEL:return getLabelControl.call(this,propItem.labelText);case $WT.BUTTONBAR:return getButtonBarControl.call(this,propItem);case $WT.CHECKBOXANDLABEL:return getCheckBoxAndLabelControl.call(this,propItem);case $WT.CHECKLIST:return getCheckListControl.call(this,propItem);case $WT.TEXTBOX:return getTextBoxControl.call(this,propItem);case $WT.STEPPER:return getStepperControl.call(this,propItem);case $WT.COMBOBOX:return getPreviewButtonControl.call(this,propItem);case $WT.CHARACTERGROUP:return getCharacterGroupControl.call(this,propItem);case $WT.FILLGROUP:return getFillGroupControl.call(this,propItem);case $WT.LINEGROUP:return getLineGroupControl.call(this,propItem);case $WT.COLORBYGROUP:return getColorByGroupControl.call(this,propItem);}}function getEditorGroupChilrenControl(propItems){var me=this,controls=[];$ARR.forEach(FN_ENSURE_ARRAY(propItems),function(prop){controls.push(getSpecicControl.call(me,prop));});return controls;}function getPropertyControl(property,dynamicCtrlGroup){var controls=[],props,me=this;$ARR.forEach(property,function(prop){props=FN_ENSURE_ARRAY(prop.items);switch(prop.style){case"EditorGroup":if(props&&props.length){controls.push(me.getEditorGroup(getEditorGroupChilrenControl.call(me,props)));}break;default:controls.push(getSpecicControl.call(me,prop));}});this.replaceChildControls(dynamicCtrlGroup,controls);}mstrmojo.vi.models.editors.CustomVisEditorModel=mstrmojo.declare(mstrmojo.vi.models.editors.BaseEditorModel,null,{scriptClass:"mstrmojo.vi.models.editors.CustomVisEditorModel",getTargetPulldownItems:function getTargetPulldownItems(dynamicCtrlGroup){var pulldownItems=this._super(dynamicCtrlGroup),items,me=this,props=[],duplicated=[],exist=[],invalid=[],dupLen,invalidLen;items=mapNameAndValue(this.getCustomProperty());$ARR.forEach(items,function(item){if(!!item.v){props=props.concat(item.v);}});if(!!props.length){inputValidation(props,duplicated,exist,invalid);}dupLen=duplicated&&duplicated.length;invalidLen=invalid&&invalid.length;if(dupLen||invalidLen){var duplicateDesc="The following property name are repeated: ##.",invalidDesc="The following property name are invalid: **.",desc=(dupLen&&invalidLen)?duplicateDesc+invalidDesc:(dupLen?duplicateDesc:invalidDesc);mstrmojo.warn(mstrmojo.desc(null,desc).replace("##",duplicated).replace("**",invalid),{},{buttons:[$NWB(mstrmojo.desc(1442,"OK"),mstrmojo.emptyFn)]});}else{if(items.length){pulldownItems=(FN_ENSURE_ARRAY(pulldownItems)).concat(items);$ARR.forEach(pulldownItems,function(item){if(item.v){item.h=getPropertyControl.bind(me,FN_ENSURE_ARRAY(item.v),dynamicCtrlGroup);}});}}return pulldownItems;},getCustomProperty:EMPTY_FN});var $WT=mstrmojo.vi.models.editors.CustomVisEditorModel.WIDGET_TYPE={PULLDOWN:"PullDown",BUTTONBAR:"ButtonBar",CHECKLIST:"CheckList",STEPPER:"Stepper",COMBOBOX:"ComboBox",TEXTBOX:"TextBox",CHECKBOXANDLABEL:"CheckBoxAndLabel",EDITORGROUP:"EditorGroup",TWOCOLUMN:"TwoColumn",LABEL:"Label",CHARACTERGROUP:"CharacterGroup",FILLGROUP:"FillGroup",LINEGROUP:"LineGroup",COLORBYGROUP:"ColorByGroup"};mstrmojo.vi.models.editors.CustomVisEditorModel.ENUM_LINE_STYLE=mstrmojo.gm.EnumCombinedLineStyle;}());