(function(){mstrmojo.requiresCls("mstrmojo.vi.models.editors.BaseEditorModel","mstrmojo.imagelayout.ImageLayoutEditorHelper","mstrmojo.locales");mstrmojo.requiresClsP("mstrmojo.ui.editors.controls","CharacterGroup","ContainerGroup","TwoColumnContainer","ColorPickerButton","LineStyleButton","FillConfigGroup");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$FUNC=mstrmojo.func,$LOCALES=mstrmojo.locales,PROPERTIES_TYPE=mstrmojo.VisEnum.IMAGELAYOUT_PROPERTIES,$GM=mstrmojo.gm,$ENUM_IDENTITY_TYPE=$GM.EnumIdentityType,$EDITOR_HELPER=mstrmojo.imagelayout.ImageLayoutEditorHelper,$FILL_CTRL_FLAGE=mstrmojo.ui.editors.controls.FillConfigGroup.CTRL_FLAGS;var CATEGORIES_DATA_EXPLORATION="de",CATEGORIES_LEGEND="lgd",CATEGORIES_ROWS_COLUMNS="rcl",CATEGORIES_SHAPES_AND_DATA_LABELS="dl";var PREFIX_ALL_TEXT="allTxt",PREFIX_DATA_LABELS="dl",PREFIX_LEGEND="lg",PREFIX_LEGEND_BACKGROUND=PREFIX_LEGEND+"Bg",PREFIX_SHAPE_FORMATTING="shape",PREFIX_SHAPE_BORDER="shapeBorder",LEVEL_SEPARATOR="@",NAME_BORDER_METRICS_LINE_FOR="selBdrMtxLn4";function getTwoControlContainer(control1,control2,col1Width,col2Width){control1.slot="col1Node";control2.slot="col2Node";return this.addDisposable(new mstrmojo.ui.editors.controls.TwoColumnContainer({col1Width:col1Width||"40%",col2Width:col2Width||"60%",children:[control1,control2]}));}function getTargetSelector(selectorName,items,edtMgr,overrides){var control=this.addDisposable($EDITOR_HELPER.getPulldown(items,overrides.fnChange||function(value){edtMgr.onTargetSelectionChanged(selectorName,value);if(this._sync){return ;}},0,overrides));edtMgr.registerSelector(selectorName,control);return control;}function getShapeColorThresholdEditorLink(){var vis=this.broker.vis,metricsInColorByDropZone=vis.zonesModel.getZoneModelByZoneId(mstrmojo.vi.viz.EnumDSSDropZones.ColorBy).items;return this.getLabelAndControl(mstrmojo.desc(6242,"Color"),this.addDisposable(new mstrmojo.Label({text:mstrmojo.desc(13174,"Select color ranges..."),cssText:"text-decoration: underline;cursor: pointer;",onclick:function(){vis.model.openThresholdEditor(metricsInColorByDropZone[0],true,false);}})),"30%","70%");}function getShapeFormattingControls(){var host=this.getHost(),broker=this.broker,shapeFormattingTitle=this.getGroupTitle(mstrmojo.desc(13751,"Shape Formatting")),thresholdEditor,shapeFillOpacityCtrl,shapeBorderStyleCtrl,groupContents=[shapeFormattingTitle],fillSmartNames=broker.getSmartNamesMapForColorFormat(PREFIX_SHAPE_FORMATTING),lineSmartNames=broker.getSmartNamesMapForLineGroup(PREFIX_SHAPE_BORDER);if(host.getColorByIndex()>=0){thresholdEditor=getShapeColorThresholdEditorLink.call(this);shapeFillOpacityCtrl=this.addDisposable(this.getLabelAndControl(mstrmojo.desc(13658,"Fill Opacity"),$EDITOR_HELPER.getFillConfigComp(host,null,fillSmartNames,{visibleControls:$FILL_CTRL_FLAGE.FILL_TRANSPARENCY}),"60%","40%"));shapeBorderStyleCtrl=this.addDisposable(this.getLabelAndControl(mstrmojo.desc(3538,"Border Style"),$EDITOR_HELPER.getLineConfigComp(host,null,lineSmartNames,{hideColorControl:true,showNoFillInColor:false,showAutomaticInColor:true}),"60%","40%"));groupContents=groupContents.concat([thresholdEditor,shapeFillOpacityCtrl,shapeBorderStyleCtrl]);}else{shapeFillOpacityCtrl=$EDITOR_HELPER.getFillConfigComp(host,mstrmojo.desc(13601,"Fill:"),fillSmartNames,{controlName:"shapeFormattingFillGroup",showGradient:false});shapeBorderStyleCtrl=$EDITOR_HELPER.getLineConfigComp(host,null,lineSmartNames,{lineTitle:mstrmojo.desc(9736,"Border")});groupContents=groupContents.concat([shapeFillOpacityCtrl,shapeBorderStyleCtrl]);}return groupContents;}function getDisplayModeControls(){var host=this.getHost(),propertyManager=host.propertyManager,DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,snDisplayMode=PROPERTIES_TYPE.DISPLAY_MODE,displayModeGroupTitle=this.getGroupTitle(mstrmojo.desc(4963,"Display Mode")),displayModePullDown=$EDITOR_HELPER.getPropertyPulldown(host,null,[{n:mstrmojo.desc(6019,"Automatic"),v:DISPLAY_MODE.AUTOMATIC},{n:mstrmojo.desc(9738,"Area"),v:DISPLAY_MODE.AREA},{n:mstrmojo.desc(348,"Bubble"),v:DISPLAY_MODE.BUBBLE}],snDisplayMode,{listenFormatProps:["enableDisplayMode"],onFmtPropsChanged:function(smartName,value){if(smartName==="enableDisplayMode"){this.set("enabled",value);}else{this.onFmtPropsChangedDefault(smartName,value);}}}),groupContents=[displayModeGroupTitle,displayModePullDown];return groupContents;}function getShapeFileControls(){var host=this.getHost(),propertyManager=host.propertyManager,snShapeFile=PROPERTIES_TYPE.MAP_FILE_PATH,shapeFileGroupTitle=this.getGroupTitle(mstrmojo.desc(14446,"Shape File")),shapeFilePullDown=$EDITOR_HELPER.getPropertyPulldown(host,null,$ARR.map(host._shapeFileList,function(shapeFileInfo){var descWeb=shapeFileInfo.descWeb,shapeFileName=descWeb?mstrmojo.desc(parseInt(descWeb.slice(descWeb.indexOf(".")+1),10),shapeFileInfo.name):shapeFileInfo.name;return{n:shapeFileName,v:shapeFileInfo.shapeFile};}),snShapeFile,{listenFormatProps:["isMultipleIL"],onFmtPropsChanged:function(smartName,value){if(smartName==="isMultipleIL"){this.set("enabled",!value);}else{this.onFmtPropsChangedDefault(smartName,value);}}}),groupContents=[shapeFileGroupTitle,shapeFilePullDown];return groupContents;}function getDataLabelsControls(dynamicCtrlGroup){var host=this.getHost(),propertyManager=host.propertyManager,DATA_LABEL=propertyManager.CONSTANTS.DATA_LABEL,dataLabelTypeItems=[{n:mstrmojo.desc(1013,"Text"),v:DATA_LABEL.SHOW_TEXT},{n:mstrmojo.desc(2175,"Values"),v:DATA_LABEL.SHOW_VALUE},{n:mstrmojo.desc(2057,"None"),v:DATA_LABEL.NONE}],snDataLabelType=PROPERTIES_TYPE.DATA_LABEL_SWITCH,broker=this.broker,dataLabelGroupTitle=this.getGroupTitle(mstrmojo.desc(11993,"Data Labels")),dataLabelTypeCtrl=$EDITOR_HELPER.getPropertyButtonBar(host,null,dataLabelTypeItems,snDataLabelType,{multiSelect:true,cssClass:"dataLabel "+("itemsCnt"+dataLabelTypeItems.length),onFmtPropsChangedDefault:function(smartName,value){this.syncControl(function(){if(value===DATA_LABEL.NONE){this.singleSelectByField(value,"v");}else{this.select((this.items||[]).map(function(item,idx){return(value&item.v)>0?idx:null;}).filter(function(elem){return elem!==null;}));}});},postselectionChange:function(evt){if(this._sync){return ;}var value=evt.added&&this.items[evt.added[0]].v,tryToAddNone=(value===DATA_LABEL.NONE),tryToRemoveNone=evt.removed&&(this.items[evt.removed[0]].v===DATA_LABEL.NONE),noSelectedItems=!this.selectedIndices||(this.selectedIndices&&!this.selectedIndices[0]&&!this.selectedIndices[1]);if(tryToRemoveNone){if(noSelectedItems){if(!this.selectedIndices[2]){this.addSelect(2);}}return ;}if(tryToAddNone){$ARR.forEach([0,1],function(idx){if(this.selectedIndices[idx]){this.removeSelect(idx);}}.bind(this));}else{if(noSelectedItems){if(!this.selectedIndices[2]){this.addSelect(2);}}else{if(this.selectedIndices[2]){this.removeSelect(2);}}value=dataLabelTypeItems.reduce(function(value,item,idx){return this.selectedIndices[idx]?value|=item.v:value;}.bind(this),0);}this.broker.setFormatPropertyValue(this.smartNames[0],value);}}),dataLabelFontCtrl=$EDITOR_HELPER.getCharacterConfigComp(host,null,broker.getSmartNamesMapForFontGroup(PREFIX_DATA_LABELS),{controlName:"DataLabelFontGroup",listenFormatProps:[snDataLabelType],onFmtPropsChanged:function(smartName,value){if(smartName===snDataLabelType){this.set("enabled",value!==DATA_LABEL.NONE);}else{this.onFmtPropsChangedDefault(smartName,value);}}}),groupContents=[dataLabelGroupTitle,dataLabelTypeCtrl,dataLabelFontCtrl];return groupContents;}function getMaxMinSizeControls(){var host=this.getHost(),propertyManager=host.propertyManager,EnumMaxSizeType=propertyManager.CONSTANTS.EnumMaxSizeType,EnumMinSizeType=propertyManager.CONSTANTS.EnumMinSizeType,hasSizeBy=(host.calculateSizeByIndex()>-1),decimal=$LOCALES.number.DECIMALSEPARATOR,txtConstraints={trigger:mstrmojo.validation.TRIGGER.ONBLUR,min:0.01,max:1,regExp:new RegExp("^\\d+("+decimal+"\\d{1,2})?$")},maxSizeText=this.addDisposable(new mstrmojo.Label({text:mstrmojo.desc(13918,"Max size (0.01 - 1.0):")})),minSizeText=this.addDisposable(new mstrmojo.Label({text:mstrmojo.desc(13917,"Min size (0.01 - 1.0):")})),informativeText=this.addDisposable(new mstrmojo.Label()),manualRangeInfoText=mstrmojo.desc(13740,"The smallest element's size is ## of the largest element's size");var DISPLAY_MODE=propertyManager.CONSTANTS.DISPLAY_MODE,isBubbleMode=propertyManager.getFormatPropertyValue(PROPERTIES_TYPE.DISPLAY_MODE)===DISPLAY_MODE.BUBBLE;var snMaxSizeType=PROPERTIES_TYPE.MAX_SIZE_TYPE,snMinSizeType=PROPERTIES_TYPE.MIN_SIZE_TYPE,maxSizeContainer=getTwoControlContainer.call(this,$EDITOR_HELPER.getPropertyPulldown(host,null,[{n:mstrmojo.desc(6019,"Automatic"),v:EnumMaxSizeType.AUTO},{n:mstrmojo.desc(8262,"Manual"),v:EnumMaxSizeType.MANUAL}],snMaxSizeType,{listenFormatProps:["calcDisplayMode"],onFmtPropsChanged:function(smartName,value){if(smartName==="calcDisplayMode"){this.parent&&this.parent.set("enabled",value!==DISPLAY_MODE.AREA&&hasSizeBy);}else{this.onFmtPropsChangedDefault(smartName,value);}}}),$EDITOR_HELPER.getPropertyValidationTextBox(host,null,PROPERTIES_TYPE.MAX_SIZE_VALUE,{constraints:txtConstraints,listenFormatProps:[snMaxSizeType],onFmtPropsChanged:function(smartName,value){if(smartName===snMaxSizeType){this.set("enabled",value===EnumMaxSizeType.MANUAL);}else{this.onFmtPropsChangedDefault(smartName,value);}}}),"75%","25%"),minSizeContainer=getTwoControlContainer.call(this,$EDITOR_HELPER.getPropertyPulldown(host,null,[{n:mstrmojo.desc(11990,"Proportional"),v:EnumMinSizeType.PROPORTIONAL},{n:mstrmojo.desc(13741,"Full Range"),v:EnumMinSizeType.AUTO},{n:mstrmojo.desc(14118,"Adjusted Range"),v:EnumMinSizeType.MANUAL}],snMinSizeType,{listenFormatProps:["calcDisplayMode"],onFmtPropsChanged:function(smartName,value){if(smartName==="calcDisplayMode"){this.parent&&this.parent.set("enabled",value!==DISPLAY_MODE.AREA&&hasSizeBy);}else{this.onFmtPropsChangedDefault(smartName,value);if(value===EnumMinSizeType.PROPORTIONAL){informativeText.set("text",mstrmojo.desc(13743,"The smallest element's size is proportional to its data element"));}else{if(value===EnumMinSizeType.AUTO){informativeText.set("text",mstrmojo.desc(13744,"The smallest element's size is fixed, independent of its data value"));}}}}}),$EDITOR_HELPER.getPropertyValidationTextBox(host,null,PROPERTIES_TYPE.MIN_SIZE_VALUE,{constraints:txtConstraints,listenFormatProps:[snMinSizeType],onFmtPropsChanged:function(smartName,value){if(!hasSizeBy){this.set("enabled",false);return ;}if(smartName===snMinSizeType){var enabled=value===EnumMinSizeType.MANUAL;this.set("enabled",enabled);if(enabled){informativeText.set("text",manualRangeInfoText.replace("##",this.value*100+"%"));}}else{this.onFmtPropsChangedDefault(smartName,value);if(this.enabled){informativeText.set("text",manualRangeInfoText.replace("##",value*100+"%"));}}}}),"75%","25%");this.addDisposable([maxSizeContainer,minSizeContainer]);return[maxSizeText,maxSizeContainer,minSizeText,minSizeContainer,informativeText];}function getMatrixLinesControls(){var host=this.getHost(),propertyManager=host.propertyManager,broker=this.broker,selName=NAME_BORDER_METRICS_LINE_FOR,prx=selName+LEVEL_SEPARATOR;var matrixLinesGroupTitle=this.getGroupTitle(mstrmojo.desc(12050,"Matrix Lines"));return[matrixLinesGroupTitle,getTargetSelector.call(this,selName,[{n:mstrmojo.desc(11998,"All Matrix Lines"),prefix:"allMatrixLn",identity:($ENUM_IDENTITY_TYPE.H_MATRIX_LINE|$ENUM_IDENTITY_TYPE.V_MATRIX_LINE),v:0},{n:mstrmojo.desc(11999,"Horizontal Matrix Lines"),prefix:"hMatrixLn",identity:$ENUM_IDENTITY_TYPE.H_MATRIX_LINE,v:1},{n:mstrmojo.desc(12000,"Vertical Matrix Lines"),prefix:"vMatrixLn",identity:$ENUM_IDENTITY_TYPE.V_MATRIX_LINE,v:2}],propertyManager,{highlightObjects:[($ENUM_IDENTITY_TYPE.H_MATRIX_LINE|$ENUM_IDENTITY_TYPE.V_MATRIX_LINE),$ENUM_IDENTITY_TYPE.H_MATRIX_LINE,$ENUM_IDENTITY_TYPE.V_MATRIX_LINE],groupTitle:matrixLinesGroupTitle}),$EDITOR_HELPER.getLineConfigComp(host,null,broker.getSmartNamesMapForLineGroup(selName+LEVEL_SEPARATOR),{listenSelector:[selName],listenFormatProps:["allMatrixLnClr","allMatrixLnCmbStyle"],lineTitle:mstrmojo.desc(13927,"Line:"),controlName:"MatrixLineGroup",groupTitle:matrixLinesGroupTitle,showNoFillInColor:false,showGradient:false})];}function getDataExplorationControls(dynamicCtrlGroup){var controls=[this.getEditorGroup(getDisplayModeControls.call(this)),this.getEditorGroup(getShapeFileControls.call(this)),this.getEditorGroup(getMaxMinSizeControls.call(this))];this.replaceChildControls(dynamicCtrlGroup,controls);}function getRowsAndColumnsControls(dynamicCtrlGroup){var controls=[this.getEditorGroup(getMatrixLinesControls.call(this))];this.replaceChildControls(dynamicCtrlGroup,controls);}function getShapesAndLabelsControls(dynamicCtrlGroup){var controls=[this.getEditorGroup(getShapeFormattingControls.call(this)),this.getEditorGroup(getDataLabelsControls.call(this))];this.replaceChildControls(dynamicCtrlGroup,controls);}function initColorPickerBtnWithGradientDir(colorPickerBtn,vis){$FUNC.override({showPickerForCurrentMode:function showPickerForCurrentMode(){this._super();if(this.pickerMode===2&&typeof this.color!=="object"){var gradientDir=this.gradientOrientation;gradientDir.set("selectedIndex",$ARR.find(gradientDir.items,"id",0));}}},colorPickerBtn.colorPicker);}function getLegendControls(dynamicCtrlGroup){var host=this.getHost(),snLegendShown=PROPERTIES_TYPE.LEGEND_SHOW,broker=this.broker,legendCtrlOnPropValueChangeFn=function(smartName,value){if(smartName===snLegendShown){var parent=this.parent,enabledCtrl=this;if(parent&&parent.scriptClass==="mstrmojo.ui.editors.controls.TwoColumnContainer"){enabledCtrl=parent;}enabledCtrl.set("enabled",!!value);}else{this.onFmtPropsChangedDefault(smartName,value);}},legendShownCtrl=$EDITOR_HELPER.getPropertyCheckBox(host,mstrmojo.desc(13600,"Show legend"),snLegendShown),legendFontGroupCtrl=$EDITOR_HELPER.getCharacterConfigComp(host,null,broker.getSmartNamesMapForFontGroup(PREFIX_LEGEND),{controlName:"LegendFontGroup",listenFormatProps:[snLegendShown],onFmtPropsChanged:legendCtrlOnPropValueChangeFn}),txtFillGroup=this.addDisposable(new mstrmojo.Label({text:mstrmojo.desc(13601,"Fill:")})),legendBackgroundFillGroup=$EDITOR_HELPER.getFillConfigComp(host,null,broker.getSmartNamesMapForColorFormat(PREFIX_LEGEND_BACKGROUND),{controlName:"LegendBackgroundFillGroup",listenFormatProps:[snLegendShown],onFmtPropsChanged:legendCtrlOnPropValueChangeFn});mstrmojo.css.addWidgetCssClass(legendShownCtrl,"title");this.replaceChildControls(dynamicCtrlGroup,[this.getEditorGroup([legendShownCtrl,legendFontGroupCtrl,txtFillGroup,legendBackgroundFillGroup])]);}mstrmojo.vi.models.editors.ImageLayoutEditorModel=mstrmojo.declare(mstrmojo.vi.models.editors.BaseEditorModel,null,{scriptClass:"mstrmojo.vi.models.ImageLayoutEditorModel",help:"dashboard_editor_image_layout_html5_properties.htm",broker:null,init:function(props){this._super(props);this.broker=this.getHost().propertyManager;var host=this.getHost();host.switchToPanelListener=host.attachEventListener("switchToPanel",this.id,function(evt){var panelID=evt.panelID;if(panelID!==undefined){this.switchPanelByValue(panelID);}});host.switchTargetSelectorListener=host.attachEventListener("switchTargetSelector",this.id,function(evt){var selName=evt.selName,value=evt.value;this.switchTargetSelector(selName,value);});},getInitialTarget:function getInitialTarget(){return CATEGORIES_DATA_EXPLORATION;},getTargetPulldownItems:function getTargetPulldownItems(dynamicCtrlGroup){var pulldownItems=this._super(dynamicCtrlGroup),host=this.getHost(),fnGetHandler=function(fn){this.broker.clearRegisterFormatControl();return fn.bind(this,dynamicCtrlGroup);}.bind(this),fnGetHandlerWithShapeFileList=function(fn){this.broker.clearRegisterFormatControl();return function(){var host=this.getHost();host.getShapeFileListWithXHR(fn.bind(this,dynamicCtrlGroup));}.bind(this);}.bind(this);pulldownItems.unshift({n:mstrmojo.desc(11974,"Data Exploration"),v:CATEGORIES_DATA_EXPLORATION,h:fnGetHandlerWithShapeFileList(getDataExplorationControls)});pulldownItems.push({n:mstrmojo.desc(11978,"Rows and Columns"),v:CATEGORIES_ROWS_COLUMNS,h:fnGetHandler(getRowsAndColumnsControls)});pulldownItems.push({n:mstrmojo.desc(13757,"Shapes and Data Labels"),v:CATEGORIES_SHAPES_AND_DATA_LABELS,h:fnGetHandler(getShapesAndLabelsControls)});if(host.hasSizeByOrColorByThs()){pulldownItems.push({n:mstrmojo.desc(2403,"Legend"),v:CATEGORIES_LEGEND,h:fnGetHandler(getLegendControls)});}return pulldownItems;},getEditorGroup:function getEditorGroup(children,props){if(!this._super){return new mstrmojo.vi.ui.editors.EditorGroup($HASH.copy(props,{children:children}));}return this.addDisposable(this._super(children,props));},switchPanelByValue:function(newValue){if(this.initializing){return ;}this.selectTargetByValue(newValue);},switchTargetSelector:function(selName,value){if(this.initializing){return ;}var propertyManager=this.broker,control=propertyManager.getTargetSelector(selName);if(control.selectItemByField){control.selectItemByField("v",value);}},detachListeners:function detachListeners(){var host=this.getHost();if(host.switchToPanelListener){host.detachEventListener(host.switchToPanelListener);delete host.switchToPanelListener;}if(host.switchTargetSelectorListener){host.detachEventListener(host.switchTargetSelectorListener);delete host.switchTargetSelectorListener;}},destroy:function destroy(ignoreDOM){this.detachListeners();if(this._super){this._super(ignoreDOM);}delete this.broker;}});}());