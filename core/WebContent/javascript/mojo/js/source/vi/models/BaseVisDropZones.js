(function(){mstrmojo.requiresCls("mstrmojo.vi.models.TemplateBasedDropZones","mstrmojo.vi.models.EnumDragSources","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.array","mstrmojo.hash","mstrmojo.func");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,TEMPLATE_METRICS_ID="-1",ENUM_TARGET=mstrmojo.vi.models.DropZonesModel.ENUM_TARGET_POSITION;function getHostStructure(){var modelData=this.getHostModel();return modelData?modelData.gsi:null;}function pivotUnit(item,zone,axis,idx,isDrag){var host=this.getHost(),controller=host.controller,id,type;id=item.did;type=item.t;if(isDrag){var itemIdx=this.getUnitIndexInZone(zone,item);if(itemIdx!==-1){if(itemIdx<idx){idx--;}}}controller.submitUndoRedoUpdates(this.getUpdateTemplateAction([host.model.getPivotUnitAction(axis,idx,id,type)]),null,mstrmojo.func.wrapMethods(controller._getXtabCallback(host),this.getUpdateCallback()));}function addUnit(params){var item=params.item,zone=params.zone,dsid=params.dsid,idx=params.index,edge=params.edge,isPivot=params.isPivot;var host=this.getHost(),controller=host.controller,srcItems=zone.items,model=host.model,axis=zone.id,actions=[];if(srcItems.length){if(edge===ENUM_TARGET.ON){var tgtItem=srcItems[idx];actions.push(model.getRemoveTemplateUnitAction(tgtItem));}else{if(edge===ENUM_TARGET.BELOW){idx++;}}}else{idx=0;}if(isPivot&&edge!==ENUM_TARGET.ON){pivotUnit.call(this,item,zone,axis,idx,true);return ;}actions.push(model.getAddTemplateUnitAction(item,dsid,axis,idx));controller.submitUndoRedoUpdates((params.actions||[]).concat(this.getUpdateTemplateAction(actions)),null,mstrmojo.func.wrapMethods(controller._getXtabCallback(host),this.getUpdateCallback()));}function isPivot(context){return context.src.data.src===mstrmojo.vi.models.EnumDragSources.VIZ_EDITOR;}mstrmojo.vi.models.BaseVisDropZones=mstrmojo.declare(mstrmojo.vi.models.TemplateBasedDropZones,null,{scriptClass:"mstrmojo.vi.models.BaseVisDropZones",addZoneItem:function addZoneItem(item,zoneItems,extraParas){var mx=extraParas.mx,metric;if(item.did===TEMPLATE_METRICS_ID){$ARR.forEach(mx,function(u){metric={did:u.did,n:u.n,t:4};zoneItems.push(metric);});}else{this._super(item,zoneItems);}},getDropZones:function getDropZones(){var xtabStructure=getHostStructure.call(this),host=this.getHost();return xtabStructure?{n:host.defn.ttl,zones:[this.getZone(mstrmojo.desc(3581,"Attributes"),1,xtabStructure.rows,false,{mx:xtabStructure.mx,title:mstrmojo.desc(13828)}),this.getZone(mstrmojo.desc(3582,"Metrics"),-1,xtabStructure.mx,false,{mx:xtabStructure.mx,title:mstrmojo.desc(13827)})]}:{n:host.defn.ttl,zones:[]};},getAvatarIconClass:function getAvatarIconClass(){return"viXtab";},getAllowDropInfo:function getAllowDropInfo(zone,dragItems,idx,edge,context){var baseInfo=this._super(zone,dragItems,idx,edge,context),wantMetric=zone.id===-1;return $HASH.copy({allowedItems:baseInfo.allowedItems.filter(function(item){var isMetric=item.t===4;return wantMetric?isMetric:!isMetric;})},baseInfo);},unitsDropped:function unitsDropped(zone,context,dropInfo,isPrimary,splitMetric){var allowedItem=dropInfo.allowedItems[0];addUnit.call(this,{item:allowedItem,zone:zone,dsid:context.src.data.dsid,index:dropInfo.idx,edge:dropInfo.edge,isPivot:isPivot(context),actions:context.actions});},deleteItem:function deleteItem(zone,idx){this.deleteItems(zone,[zone.items[idx]]);},deleteItems:function deleteItems(zone,items){var host=this.getHost(),controller=host.controller,actions=[];(items||[]).forEach(function(item){actions.push(host.model.getRemoveTemplateUnitAction(item));});if(actions.length){controller.submitUndoRedoUpdates(this.getUpdateTemplateAction(actions),null,mstrmojo.func.wrapMethods(controller._getXtabCallback(host),this.getUpdateCallback()));}},getExtraUnitMenuItems:function getExtraUnitMenuItems(cfg,zone,item,el){this._super(cfg,zone,item,el);if(item.t===mstrmojo.mstr.EnumDSSXMLObjectTypes.Metric&&this.getHost().showThreshold){cfg.addSeparator();this.buildThresholdMenuOptions(cfg,{item:item},true);}},getHostModel:function(){return this.getHost().model.data;}});}());