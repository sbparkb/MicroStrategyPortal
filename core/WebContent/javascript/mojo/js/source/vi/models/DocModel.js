(function(){mstrmojo.requiresCls("mstrmojo.DocModel","mstrmojo.func","mstrmojo.array","mstrmojo.hash","mstrmojo.num","mstrmojo.elementHelper","mstrmojo.EnumRWUnitType","mstrmojo.boxmodel","mstrmojo.models.FormatModel","mstrmojo.DocDataService","mstrmojo.mstr.EnumDataType","mstrmojo.DI.DIConstants.xdaType","mstrmojo.vi.models._LayoutActions","mstrmojo.vi.models._PanelActions","mstrmojo.vi.models._FilterStackActions","mstrmojo.vi.models._VisActions","mstrmojo.vi.models._FieldActions","mstrmojo.vi.models._DataGridActions","mstrmojo.Button","mstrmojo.mstr.EnumWebAPIErrorCodes","mstrmojo.mstr.EnumDSSXMLBaseFormType","mstrmojo.DocSelector");mstrmojo.requiresClsP("mstrmojo.vi.models","PanelFormatSaver","EnumPanelTypes","VIComponentMap");mstrmojo.requiresClsP("mstrmojo.vi.ui","DatasetObjects","DocDatasetObjects","DatasetUnitMenuUtils");var $MOJO=mstrmojo,$FUNC=$MOJO.func,$ARR=$MOJO.array,$BOX=$MOJO.boxmodel,$HASH=$MOJO.hash,$NUM=$MOJO.num,$EH=$MOJO.elementHelper,$ERR=$MOJO.mstr.EnumWebAPIErrorCodes,$DUMU=$MOJO.vi.ui.DatasetUnitMenuUtils,$FORMAT_MODEL=mstrmojo.models.FormatModel,$GET_FORMAT_OBJ=$FORMAT_MODEL.getFormatUpdate,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$RW_UNIT_TYPES=$MOJO.EnumRWUnitType,$CTRL_STYLE=mstrmojo.DocSelector.STYLES,$BASE_TYPE=mstrmojo.mstr.EnumDSSXMLBaseFormType,$DT=$MOJO.mstr.EnumDataType,ITEM_SEPARATOR="\u001E",$VI_MODELS=$MOJO.vi.models,$PANEL_TYPES=$VI_MODELS.EnumPanelTypes,$VI_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,VI_MAIN_STACK=$VI_TYPES.MAIN_CONTENT,VI_VIZ_STACK=$VI_TYPES.VIZ_CONTENT,VI_PAGE_PANEL=$VI_TYPES.PAGEBY_PANEL,VI_STATE_SEQUENCE=[VI_VIZ_STACK],constantsXdaType=mstrmojo.DI.DIConstants.xdaType,constantsDSM=mstrmojo.DI.DIConstants.datasetServeMode;var TP_ATTRIBUTE=12,TP_METRIC=4;var STP_RECURSIVE_ATTRIBUTE=3076;var DOC_UNIT_PROP_HIDE=2;var DEFAULT_ROWS_COUNT=8;mstrmojo.vi.models.DatasetInfoType=null;mstrmojo.vi.models.DEObjectType=null;function getFeature(name){return mstrApp.rootCtrl.resolveFeature(name);}function isGroupBySelector(sourceType,sourceSubType){return(sourceType===47&&sourceSubType!==12033)||sourceType===1;}function unloadLayouts(definitionsToo){var layouts=this.controller.view.getLayouts(),layoutCount=layouts.length,i;for(i=0;i<layoutCount;i++){this.data.layouts[i].loaded=false;if(definitionsToo){layouts[i].defn.loaded=false;}}}function updateDisplayName(newValue,oldValue,unitKey,layoutKey,propName,formatPropName,callback){layoutKey=layoutKey||this.currlaykey;var layoutDefinition=this.defn.layouts.filter(function(layout){return layout.k===layoutKey;})[0],definition=unitKey===layoutKey?layoutDefinition:layoutDefinition.units[unitKey],getFormatUpdateFn=function getFormatUpdateFn(displayName){return $FORMAT_MODEL.getFormatUpdate(formatPropName,displayName);},unit={k:unitKey,defn:definition},successFn;if(propName){callback=$FUNC.wrapMethods({success:function(appliedTitle){definition[propName]=appliedTitle;}},callback);}successFn=callback.success;callback.success=function(appliedFormat){successFn($FORMAT_MODEL.getValueFromUpdate(formatPropName,appliedFormat)||newValue);};this.updateUnitFormatWithUndo(unit,1,getFormatUpdateFn(newValue),getFormatUpdateFn(oldValue),callback);}var REQUEST_DEFN_DATA=mstrmojo.DocDataService.REQUEST_DEFN_DATA;var REQUEST_ONLY_DATASETS=mstrmojo.DocDataService.REQUEST_ONLY_DATASETS;function createNewUnitNode(fnData,fnDefn,fnNode,key,layoutKey){key=key||this.getNextKey();layoutKey=layoutKey||this.getCurrentLayoutKey();var data={k:key,wid:1},node={k:key,id:this.getWidgetId(data,layoutKey),defn:{fmts:{top:"0px",left:"0px",height:"100px",width:"100px"},_lkz:layoutKey},data:data};if(fnData){node.data=fnData(data,node);}if(fnDefn){node.defn=fnDefn(node.defn,node);}if(fnNode){node=fnNode(node);}return node;}function markDirtyLayout(layoutKey){var lvs=this.controller.view.getLayouts();lvs.forEach(function(lv){if(lv.k===layoutKey){lv.defn.loaded=false;}});this.data.layouts.forEach(function(l){if(l.k===layoutKey){l.loaded=false;}});}function createUnit(node,panelKey){var controller=this.controller,builder=controller.view.builder,viPanel=this.getPanel(panelKey);panelKey=viPanel.k;return builder.build([node],this,{pk:panelKey})[0];}function getShowVIStackAction(viType){var stackKey=this.getVIPanelKeyFromUnits(viType),stackDefinition=this.getTargetDefn(stackKey)[stackKey];return this.getUnitFormatAction({defn:stackDefinition,k:stackKey},1,{FormattingAppearance:{Visible:1}});}function buildLoadedVIStack(viType,stackPath,response,builder){var stackKey=this.getVIPanelKeyFromUnits(viType),targetDefinitionsObj=this.getTargetDefn(stackKey),responseData=response.data;var layoutKey=this.getCurrentLayoutKey(),stackDataNode=$HASH.walk(stackPath,responseData.layouts.filter(function(layout){return layout.k===layoutKey;})[0]);this.updateDataCache(responseData,targetDefinitionsObj);builder.build(this.getChildren({data:stackDataNode,defn:targetDefinitionsObj[stackKey],id:this.getWidgetId(stackDataNode),k:stackKey}).filter(function(ch){return ch.k===stackKey;}),this);}function loadHiddenVIStack(viType,stackPath,builder,fnCallback){var id=this.id;this.getDataService().submitUpdates(getShowVIStackAction.call(this,viType),{success:function(res){buildLoadedVIStack.call(mstrmojo.all[id],viType,stackPath,res,builder);fnCallback();}},{preserveUndo:true});}function buildKeyContext(nodeKey,ctrlKey){return"1"+ITEM_SEPARATOR+nodeKey+ITEM_SEPARATOR+ctrlKey;}function splitKeyContext(keyContext){var parts=keyContext.split(ITEM_SEPARATOR);return{nodeKey:parts[1],ctrlKey:parts[2]};}function findDefKeys(node,targetKeys,inTarget,defnKeys){defnKeys=defnKeys||{};var me=this,chNodes=(node&&this.extractChildren(node))||[],chKey;chNodes.forEach(function(ch){chKey=ch.k;inTarget=inTarget||targetKeys.hasOwnProperty(chKey);if(inTarget){defnKeys[chKey]=true;}findDefKeys.call(me,ch,targetKeys,inTarget,defnKeys);});return defnKeys;}function sortDatasetsUnits(datasets){$HASH.forEach(datasets,function(dataset){dataset.att=$DUMU.getSortedDatasetUnits(dataset.att);dataset.mx=$DUMU.getSortedDatasetUnits(dataset.mx);if(dataset.tables&&!this.isMDXDataset(dataset)){dataset.tables.forEach(function(table){table.att=$DUMU.getSortedDatasetUnits(table.att);table.mx=$DUMU.getSortedDatasetUnits(table.mx);});}},this);}function processRawDatasetsSettings(datasetsSettings){var model=this;if(typeof datasetsSettings==="string"){if(datasetsSettings.indexOf("{")===0){datasetsSettings=JSON.parse(datasetsSettings);}}datasetsSettings=$HASH.copy({dataset:function(dsid){var initSettingNode=function(settingNode,defaultSet){settingNode.getCollapsed=function(){return this.isCollapsed===undefined?defaultSet.isCollapsed:this.isCollapsed;};};var createSettingNode=function(nodeName,nodeId,defaultSet){this[nodeName]=this[nodeName]||{};var settingNode=this[nodeName][nodeId]=this[nodeName][nodeId]||{};initSettingNode(settingNode,defaultSet);return settingNode;};var getDatasetModel=function(){return model.datasets[dsid];};if(!getDatasetModel()){return null;}var dataset=createSettingNode.call(this,"datasets",dsid,{isCollapsed:false});dataset.hasCollapsedChildNodes=function(isCollapsed,recursion){var result=false,me=this;$HASH.forEach(getDatasetModel().tableMap,function(table,key){var tableInfo=me.table(key);if(tableInfo.getCollapsed()===isCollapsed||(recursion&&tableInfo.hasCollapsedChildNodes(isCollapsed,recursion))){result=true;return false;}});return result;};if(!dataset.table){dataset.table=function(tbid){var getTableModel=function(){return getDatasetModel().tableMap[tbid];};if(!getTableModel()){return null;}var table=createSettingNode.call(this,"tables",tbid,{isCollapsed:false});table.hasCollapsedChildNodes=function(){return false;};if(model.isMDXTable(getTableModel())){table.hasCollapsedChildNodes=function(isCollapsed,recursion){var result=false,me=this;$HASH.forEach(getTableModel().dimensionMap,function(dimension,key){var dimensionInfo=me.dimension(key);if(dimensionInfo.getCollapsed()===isCollapsed||(recursion&&dimensionInfo.hasCollapsedChildNodes(isCollapsed,recursion))){result=true;return false;}});if(result){return result;}var rootMetricFolderInfo=me.rootMetricFolder;if(rootMetricFolderInfo.getCollapsed()===isCollapsed||(recursion&&rootMetricFolderInfo.hasCollapsedChildNodes(isCollapsed,recursion))){result=true;}return result;};if(!table.dimension){table.dimension=function(dimid){var getDimensionModel=function(){return getTableModel().dimensionMap[dimid];};if(!getDimensionModel()){return null;}var dimension=createSettingNode.call(this,"dimensions",dimid,{isCollapsed:true});dimension.hasCollapsedChildNodes=function(isCollapsed){var result=false,me=this;$HASH.forEach(getDimensionModel().hierarchyMap,function(hierarchy,key){var hierarchyInfo=me.hierarchy(key);if(hierarchyInfo.getCollapsed()===isCollapsed){result=true;return false;}});return result;};if(!dimension.hierarchy){dimension.hierarchy=function(hieid){var getHierarchyModel=function(){return getDimensionModel().hierarchyMap[hieid];};if(!getHierarchyModel()){return null;}return createSettingNode.call(this,"hierarchies",hieid,{isCollapsed:true});};}return dimension;};}var generateMetricFolderTree=function(folder,folderModelFn){if(!folder.hasCollapsedChildNodes){folder.hasCollapsedChildNodes=function(isCollapsed,recursion){var me=this,result=false;$HASH.forEach(folderModelFn().folderMap,function(folder,key){var folderInfo=me.folder(key);if(folderInfo.getCollapsed()===isCollapsed||(recursion&&folderInfo.hasCollapsedChildNodes(isCollapsed,recursion))){result=true;return false;}});return result;};}if(!folder.folder){folder.folder=function(name){var subfolderModelFn=function(){return folderModelFn().folderMap[name];};if(!subfolderModelFn()){return null;}var subfolder=createSettingNode.call(this,"folders",name,{isCollapsed:true});generateMetricFolderTree(subfolder,subfolderModelFn);return subfolder;};}};var rootMetricFolderModelFn=function(){return getTableModel().metricFolder;},rootMetricFolder=table.rootMetricFolder=table.rootMetricFolder||{};initSettingNode(rootMetricFolder,{isCollapsed:false});generateMetricFolderTree(rootMetricFolder,rootMetricFolderModelFn);}return table;};}return dataset;},getSaveActions:function(){var dsoSettings=this;$HASH.forEach(this.datasets,function(dsInfo,dsid){var datasetModel=model.datasets[dsid];if(!datasetModel){delete dsoSettings.datasets[dsid];return ;}if(!datasetModel.tables){delete dsInfo.tables;return ;}$HASH.forEach(dsInfo.tables,function(tableInfo,tbid){var tableModel=datasetModel.tableMap[tbid];if(!tableModel){delete dsInfo.tables[dsid];return ;}if(model.isMDXTable(tableModel)){var consolidateFolderContent=function(folderInfo,folderModel){$HASH.forEach(folderInfo.folders,function(subfolderInfo,subfolderName){if(!folderModel.folderMap[subfolderName]){delete folderInfo.folders[subfolderName];return ;}consolidateFolderContent(subfolderInfo,folderModel.folderMap[subfolderName]);});if($HASH.isEmpty(folderInfo.folders)){delete folderInfo.folders;}};$HASH.forEach(tableInfo.dimensions,function(dimensionInfo,dimid){var dimensionModel=tableModel.dimensionMap[dimid];if(!dimensionModel){delete tableInfo.dimensions[dimid];return ;}$HASH.forEach(dimensionInfo.hierarchies,function(hierarchyInfo,hieid){var hierarchyModel=dimensionModel.hierarchyMap[hieid];if(!hierarchyModel){delete dimensionInfo.hierarchies[hieid];}});if($HASH.isEmpty(dimensionInfo.hierarchies)){delete dimensionInfo.hierarchies;}});if($HASH.isEmpty(tableInfo.dimensions)){delete tableInfo.dimensions;}consolidateFolderContent(tableInfo.rootMetricFolder,tableModel.metricFolder);delete tableInfo.metricFolders;}});});var propValue=JSON.stringify(this);return[model.getUnitFormatAction(model.getRootNode(),1,{FormattingAnalysis:{DatasetsSettings:propValue}})];},save:function(){model.execute({execute:function(){this.submit(datasetsSettings.getSaveActions(),{},mstrmojo.DocDataService.SUPPRESS_DATA);},urInfo:{callback:model.getDatasetsUpdateCallback()}});},unitOpr:function(srcId,prop,flag){var unit,res;this.units=this.units||{};this.units[srcId]=this.units[srcId]||{};unit=this.units[srcId];if(flag!==undefined){if(flag){res=unit[prop]=flag;}else{delete unit[prop];if($HASH.isEmpty(unit)){delete this.units[srcId];}}}else{res=unit[prop];}return res;}},datasetsSettings);return datasetsSettings;}function applyRawDatasets(datasets,datasetsSettings){this.datasetsSettings=processRawDatasetsSettings.call(this,datasetsSettings);$HASH.forEach(datasets,function(ds,dsid){ds.did=dsid;if(ds.tables){var unitFinder=function(units){return function(ref){return units.filter(function(u){return u.did===ref.did;})[0]||null;};},attFinder=unitFinder(ds.att),mxFinder=unitFinder(ds.mx);ds.tableMap={};ds.tables.forEach(function(table){ds.tableMap[table.did]=table;if(this.isMDXTable(table)){var processMetricFolder=function(metricFolder){metricFolder.folderMap={};metricFolder.mxRefs=metricFolder.mxRefs||[];metricFolder.folders=metricFolder.folders||[];metricFolder.mx=metricFolder.mxRefs.map(mxFinder);metricFolder.folders.forEach(function(folder){metricFolder.folderMap[folder.n]=folder;processMetricFolder(folder);});};table.dimensionMap={};var firstHierarchy=table.dimensions[0].hierarchies[0],tmpRA=!firstHierarchy.attRefs&&attFinder(firstHierarchy);if(tmpRA&&tmpRA.t===TP_ATTRIBUTE&&tmpRA.st===STP_RECURSIVE_ATTRIBUTE){table.dimensions.forEach(function(dimension){table.dimensionMap[dimension.did]=dimension;dimension.recursiveAtt=[];dimension.hierarchies.forEach(function(hierarchy){dimension.recursiveAtt.push(attFinder(hierarchy));});});}else{table.dimensions.forEach(function(dimension){table.dimensionMap[dimension.did]=dimension;dimension.hierarchyMap={};dimension.hierarchies.forEach(function(hierarchy){dimension.hierarchyMap[hierarchy.did]=hierarchy;hierarchy.att=hierarchy.attRefs.map(attFinder);});});}table.metricFolder=table.metricFolder||{};processMetricFolder(table.metricFolder);}else{table.attRefs=table.attRefs||[];table.att=table.attRefs.map(attFinder);table.mxRefs=table.mxRefs||[];table.mx=table.mxRefs.map(mxFinder);}},this);}},this);delete this.deMap;sortDatasetsUnits.call(this,datasets);this.set("datasets",datasets);}function findAndUpdateNewObjects(oDatasets,nDatasets){$HASH.forEach(nDatasets,function(nDs,dsid){var oDs=oDatasets[dsid],oItems=oDs&&oDs.att.concat(oDs.mx),nItems=nDs.att.concat(nDs.mx);if(oItems){$ARR.forEach(nItems,function(nItem){var index=$ARR.find(oItems,"did",nItem.did);if(index<0){nItem.ne=true;}if(nItem.t===47&&nItem.st===12033){var oItem=index<0?null:oItems[index];$ARR.forEach(nItem.des,function(elem){if(!oItem||$ARR.find(oItem.des,"id",elem.id)<0){elem.ne=true;}});}});}});}function getPageByRebuildFn(refreshTarget,refreshKeys){var pageByPanel=this.getVIComponent(VI_PAGE_PANEL),pageByPanelId=pageByPanel.id,targetKeys=[pageByPanel.k];if(refreshTarget){targetKeys.push(this.getVIComponentKey(VI_MAIN_STACK));}return function(response){this.partialUpdate(response.data,this.getTargetDefn(targetKeys.join(ITEM_SEPARATOR)),response.defn,refreshKeys);var panel=mstrmojo.all[pageByPanelId];panel.parent.rebuildChild(panel);}.bind(this);}function getTypeCounter(objectType){var cntr,layoutKey=this.getCurrentLayoutKey();this.obCntrs=this.obCntrs||{};this.obCntrs[layoutKey]=this.obCntrs[layoutKey]||{};cntr=this.obCntrs[layoutKey][objectType];if(isNaN(cntr)){cntr=0;$HASH.forEach(this.getCurrentLayoutDef().units,function(unit){if(unit.t===objectType){cntr++;}});this.obCntrs[layoutKey][objectType]=cntr;}return cntr;}mstrmojo.vi.models.DocModel=mstrmojo.declare(mstrmojo.DocModel,[mstrmojo.vi.models._LayoutActions,mstrmojo.vi.models._PanelActions,mstrmojo.vi.models._FilterStackActions,mstrmojo.vi.models._VisActions,mstrmojo.vi.models._FieldActions,mstrmojo.vi.models._DataGridActions],{scriptClass:"mstrmojo.vi.models.DocModel",datasets:null,deObjectMap:null,controller:null,lastSavedStid:0,_selectedUnitId:null,_latestSelectedViUnitKey:null,init:function init(props){this._super(props);applyRawDatasets.call(this,this.datasets,this.datasetsSettings);},getVIMap:function getVIMap(layoutKey){return this.getDocBuilder().getLayoutVIMap(layoutKey||this.getCurrentLayoutKey());},getVIComponent:function getVIComponent(type,layoutKey){return this.getVIMap(layoutKey).getComponent(type);},getVIComponentKey:function getVIComponentKey(type,layoutKey){return this.getVIMap(layoutKey).getComponentKey(type);},buildKeyContext:buildKeyContext,loadHiddenVIStack:loadHiddenVIStack,buildLoadedVIStack:buildLoadedVIStack,getShowVIStackAction:getShowVIStackAction,getVIPanelKeyFromUnits:function getVIPanelKeyFromUnits(viType,layoutKey){var layoutUnits=this.getLayoutDefn(layoutKey||this.getCurrentLayoutKey()).units;return Object.keys(layoutUnits).filter(function(key){return layoutUnits[key].psType===viType;})[0];},updateTitle:function updateTitle(title,oldTitle,key,layoutKey,titlePropName,callback){updateDisplayName.call(this,title,oldTitle,key,layoutKey,titlePropName,$ENUM_FORMAT_PROPERTIES.TITLE,callback);},createNewUnitNode:createNewUnitNode,getPanel:function getPanel(panelKey,layoutKey){return panelKey?mstrmojo.all[this.getWidgetId({k:panelKey,wid:1},layoutKey)]:this.getVizContentPanel(layoutKey);},createUnit:createUnit,deferredInsertUnit:function deferredInsertUnit(update,newItem,panelKey,targetBox,edge){var unitKey=newItem.k;update.setTreesToRender(3);update.addCallbacks({success:function(response){var layoutKey=newItem.defn._lkz,currLayout=response.defn.layouts.filter(function(l){return l.k===layoutKey&&l.loaded;})[0],layoutRetrieved=!$HASH.isEmpty(currLayout);if(!layoutRetrieved){markDirtyLayout.call(this,layoutKey);return ;}var vizPanel=this.getPanel(panelKey),nk=newItem.nk,newUnit,tree,lk=this.currlaykey;this.controller.view.updateXtabStyles(layoutKey,response.data.layouts[$ARR.find(response.data.layouts,"k",layoutKey)].xtabStyles);this.updateDefnCache(response.defn,[unitKey,vizPanel.k]);this.updateDataCache(response.data,this.getTargetDefn(unitKey));if(this.getLayoutDataCache(lk)[vizPanel.id]){tree=$ARR.filterOne(this.data.layouts,function(l){return(l.k===lk);});this.updateDataCache({layouts:[tree]},this.getTargetDefn(vizPanel.k));}vizPanel.update(vizPanel.node);var unitOnResponse=layoutRetrieved&&(!!this.getChildrenByKey(vizPanel.node,false,[unitKey])[0]);if(unitOnResponse){newUnit=vizPanel.rebuildChild(vizPanel.getUnitByKey(unitKey));this.selectVIUnit(newUnit.id,true,{isAddAction:true});}if(nk){newUnit.nk=nk;}}.bind(this)});this.getPanel(panelKey).addUnit(newItem,targetBox,edge,update,true);},markDirtyLayout:markDirtyLayout,getVizContentPanel:function getVizContentPanel(layoutKey){return this.getVIComponent(VI_VIZ_STACK,layoutKey).getSelectedPanel();},getSelectedViUnit:function getSelectedViUnit(){return mstrmojo.all[this._selectedUnitId];},getRootNode:function getRootNode(){var root=this.defn.root;return{k:root.k,defn:root};},getHighLightNDECallback:function getHightLightNDECallback(){var me=this;return this.newCallback({method:"hightLightNDE",success:function(res){var datasets=res.datasets,newElems=[];$HASH.forEach(datasets,function(dataset){$ARR.forEach(dataset.att,function(item){if(item.t===47&&item.st===12033){$ARR.forEach(item.des,function(elem){if(elem.ne&&elem.t!==4){newElems.push({id:elem.id,n:elem.n,es:elem.es,attId:item.attId,unitId:item.did});}});}});});if(newElems.length>0){me.callOnNDECreated(newElems);}}});},callOnNDECreated:function(groupArr){var currVizPanel=this.getPanel();$ARR.forEach(currVizPanel.children,function(child){if(child.boxContent&&child.boxContent.onNDECreated){child.boxContent.onNDECreated(groupArr);}});},getRebuildCallback:function getRebuildCallback(){var me=this;return this.newCallback({method:"rebuild",success:function(res){if(!me.checkStatus(res)){return ;}var data=res.data,defn=res.defn,puKeysStr=res.pukeys,puKeys=puKeysStr&&puKeysStr.split(ITEM_SEPARATOR),defnKeys={},targetKeys;if(puKeys&&puKeys.length){if(defn){var oldLayoutDefn=me.getLayoutDefn(me.getCurrentLayoutKey()),oldLayoutUnits=oldLayoutDefn&&oldLayoutDefn.units,newLayouts=defn.layouts,newLayoutDefn=newLayouts&&newLayouts[$ARR.find(newLayouts,"k",me.getCurrentLayoutKey())],newLayoutUnits=newLayoutDefn&&newLayoutDefn.units,getAdditionalTargetKeys=function(tgtKeys){var keys=[];tgtKeys.forEach(function(key){if(!oldLayoutUnits[key]&&newLayoutUnits&&newLayoutUnits[key]){var parentNodeKey=newLayoutUnits[key].pnk;if(parentNodeKey){keys.push(parentNodeKey);}}});return keys;},additionalTargetKeys=getAdditionalTargetKeys(puKeys);while(additionalTargetKeys.length){puKeys=puKeys.concat(additionalTargetKeys);additionalTargetKeys=getAdditionalTargetKeys(additionalTargetKeys);}targetKeys=$ARR.hash(puKeys);defnKeys=findDefKeys.call(me,data,targetKeys,false);}else{targetKeys=$ARR.hash(puKeys);}me.partialUpdate(data,targetKeys,defn,$HASH.keyarray(defnKeys));}else{if(me.updateLayouts(res)){me.controller.view.updateLayouts(res);}}}});},buildSliceUrInfo:function buildSliceUrInfo(evt){var events=evt.events||{K0:evt},puKeys=[],treesToRender=2;Object.keys(events).forEach(function(key){var event=events[key],ck=event.ck;if(ck){var keyInfo=splitKeyContext(ck);puKeys.push(keyInfo.nodeKey,keyInfo.ctrlKey);}if(event.changeInclude||event.changeQual){treesToRender=3;}});return{extraPuKeys:puKeys,treesToRender:treesToRender};},getUIState:function getUIState(){var state={};VI_STATE_SEQUENCE.forEach(function(cType){state[cType]=this.getVIComponent(cType).getUIState();},this);return state;},restoreUIState:function restoreUIState(state){VI_STATE_SEQUENCE.forEach(function(cType){this.getVIComponent(cType).restoreUIState(state[cType]);},this);},cmdMgr:function cmdMgr(){return this.controller.cmdMgr;},execute:function execute(cmd){return this.controller.cmdMgr.execute(cmd);},slice:function slice(evt){var model=this;this.execute({execute:function(){var update=model.getDataService().newUpdate(this);model.sliceDeferred(update,evt);if(update.actions&&update.actions.length>0){this.submitUpdate(update);}},urInfo:model.buildSliceUrInfo(evt)});},insertNewFilter:function insertNewFilter(){var id=this.id,model=mstrmojo.all[id],dataService=model.getDataService(),panelKey=model.getVizContentPanel().k,nodeKey=model.getNextKey(),node=model.createNewUnitNode(null,function(defn,node){defn.t=$RW_UNIT_TYPES.SELECTOR;defn.ck=buildKeyContext(nodeKey,node.k);defn.ckey=node.k;return new mstrmojo.Model(defn);});this.execute({execute:function(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),unit=model.createUnit(node,panelKey),ctrlKey=unit.k;update.addActions([dataService.getAddCtrlAction(panelKey,nodeKey,ctrlKey,[ctrlKey]),model.getUnitFormatAction(node,5,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.SHOW_TITLE_BAR,false)),model.getUnitFormatAction(node,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_ITEM_WIDTH_MODE,0)),model.getUnitFormatAction(node,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_EXPORT_AS_SHOWN_ON_WEB,1))]);model.deferredInsertUnit(update,unit,panelKey,null,null);this.submitUpdate(update);},urInfo:{undo:function(){this.urInfo.callback={};var vizPanel=model.getPanel(panelKey),filter=vizPanel.getUnitByKey(node.k);if(filter){vizPanel.deleteBoxAndSubmitDeferred(model.getDataService().newUpdate(),filter,null,true);filter.destroy();}},redo:function(){if(node){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),unit=model.createUnit(node,panelKey);model.deferredInsertUnit(update,unit,panelKey,null,null);if(this.urInfo){this.urInfo.callback=update.callback;}}},extraPuKeys:[panelKey],treesToRender:3}});},insertExistingFilter:function insertExistingFilter(filterNode,targetBox,edge){var model=this,panelKey=this.getPanel().k,dataService=this.getDataService(),filterDefn=filterNode.defn,oldTargetKeys=filterNode.defn.tks.split(ITEM_SEPARATOR),newTargetKeys=this.getVizContentPanel().getTargetKeysByType([$RW_UNIT_TYPES.GRID,$RW_UNIT_TYPES.GRAPH,$RW_UNIT_TYPES.MOJOVISUALIZATION]),filterPanel=model.getVIComponent($VI_TYPES.FILTER_PANEL),updateFilterPanelScrollBars=function(filterPanel){filterPanel.raiseEvent({name:"filterPanelUpdated"});};model.execute({execute:function(){var update=dataService.newUpdate(this);var unit=model.createUnit(filterNode,panelKey),keyContext=filterDefn.ck,sourceType=filterDefn.srct,sourceSubType=filterDefn.srcst,actions=[],isFilterUpdated=false;oldTargetKeys.forEach(function(tgtKey){var updateNodes=mstrmojo.array.ensureArray(tgtKey);if(!isFilterUpdated){updateNodes.push(filterDefn.pnk);isFilterUpdated=true;}actions.push(dataService.getRemoveCtrlTargetAction(keyContext,tgtKey,updateNodes));});newTargetKeys.forEach(function(tgtKey){actions.push(dataService.getAddCtrlTargetAction(keyContext,tgtKey,tgtKey,isGroupBySelector(sourceType,sourceSubType)));});actions.push(dataService.getMoveControlAction(keyContext,panelKey));if(edge==="Top"||edge==="Bottom"){actions.push(model.getUnitFormatAction(filterNode,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_ORIENTATION,1)));}actions.push(model.getUnitFormatAction(filterNode,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.FILL_STYLE,0)));actions.push(model.getUnitFormatAction(filterNode,5,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.FILL_STYLE,0)));actions.push(model.getUnitFormatAction(filterNode,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.BORDER_COLOR,"#fefefe")));update.addActions(actions);model.deferredInsertUnit(update,unit,panelKey,targetBox,edge);var tgtKeys=oldTargetKeys.join(ITEM_SEPARATOR);update.callback={success:function(response){var vizPanel=model.getPanel(panelKey),filter=vizPanel.getUnitByKey(filterNode.k);if(filter&&filter.clearFormats){filter.clearFormats();}filterPanel.refreshFP();model.partialUpdate(response.data,model.getTargetDefn(tgtKeys),response.defn,[filterNode.k,panelKey,filterDefn.pnk]);updateFilterPanelScrollBars(filterPanel);}};this.submitUpdate(update);},urInfo:{undo:function(){this.urInfo.callback={};var vizPanel=model.getPanel(panelKey),filter=vizPanel.getUnitByKey(filterNode.k);if(filter){vizPanel.removeChildren(filter);filter.destroy();mstrApp.rootCtrl.docCtrl.selectViPanel("filterPanel");}updateFilterPanelScrollBars(filterPanel);},redo:function(){var filter=(filterPanel.children||[]).filter(function(child){return child.k===filterNode.k;})[0];if(filter){filterPanel.removeChildren(filter);filter.destroy();}delete filterNode.defn.iifp;var update=dataService.newUpdate(this),unit=model.createUnit(filterNode,panelKey);if(!targetBox.parent){model.getPanel(panelKey).children.forEach(function(boxChild){if(boxChild.k===targetBox.k){targetBox=boxChild;}});}model.deferredInsertUnit(update,unit,panelKey,targetBox,edge);var tgtKeys=oldTargetKeys.join(ITEM_SEPARATOR);update.callback={success:function(response){var vizPanel=model.getPanel(panelKey),filter=vizPanel.getUnitByKey(filterNode.k);if(filter&&filter.clearFormats){filter.clearFormats();}model.partialUpdate(response.data,model.getTargetDefn(tgtKeys),response.defn,[filterNode.k,panelKey,filterDefn.pnk]);updateFilterPanelScrollBars(filterPanel);}};if(this.urInfo){this.urInfo.callback=update.callback;}},extraPuKeys:[model.getVIComponent($VI_TYPES.FILTER_PANEL).k,panelKey]}});},selectVIUnit:function selectVIUnit(id,forceSelection,evtProps){if(forceSelection||id!==this._selectedUnitId){this._selectedUnitId=id;this._latestSelectedViUnitKey=id&&mstrmojo.all[id].k;this.raiseEvent($HASH.copy({name:"viUnitSelected",id:id},evtProps));}},getLatestSelectedViUnitKey:function getLatestSelectedViUnitKey(){return this._latestSelectedViUnitKey;},getDocDatasetsPanel:function getDocDatasetsPanel(){var rootNode=this.getRootNode(),rootDef=rootNode.defn,id=this.id,panel=new mstrmojo.vi.ui.DocDatasetObjects({data:this.datasets,visible:!!rootDef.dsv,width:rootDef.dsw,model:this,unit:rootNode,settings:this.datasetsSettings,getPanelSaver:function(){var model=mstrmojo.all[id];return $VI_MODELS.PanelFormatSaver.getPanelSaver(model,{size:{set:"FormattingAnalysis",name:"DatasetObjectsWidth",convert:true},visible:{set:"FormattingAnalysis",name:"DatasetObjectsVisible"}});}});this.attachEventListener("updateDatasets",panel.id,function(evt){panel.set("data",evt.datasets);panel.set("settings",evt.datasetsSettings);});this.attachEventListener("viUnitSelected",panel.id,function(evt){var vizbox=mstrmojo.all[evt.id];panel.set("gridSource",vizbox&&vizbox.boxContent.model.data.datasetId);});return panel;},getDatasetsPanel:function getDatasetsPanel(width,fnFilter,dsFnFilter,filterNodeCfg){var panel=new mstrmojo.vi.ui.DatasetObjects({data:(!dsFnFilter?this.datasets:dsFnFilter(this.datasets)),width:width||"200px",model:this,useTableView:this.datasetsSettings.useTableView,title:mstrmojo.desc(2870,"Objects"),filterFunc:fnFilter,filterNodeConfig:filterNodeCfg||{att:true,mx:true}});this.attachEventListener("updateDatasets",panel.id,function(evt){panel.set("useTableView",evt.datasetsSettings.useTableView);panel.set("data",!dsFnFilter?evt.datasets:dsFnFilter(evt.datasets));});this.attachEventListener("updateUseTableView",panel.id,function(evt){this.set("useTableView",evt.useTableView);});return panel;},updateDatasets:function updateDatasets(datasets,datasetsSettings){if(!datasets){return ;}findAndUpdateNewObjects(this.datasets,datasets);applyRawDatasets.call(this,datasets,datasetsSettings);this.raiseEvent({name:"updateDatasets",datasets:this.datasets,datasetsSettings:this.datasetsSettings});},getDatasetsUpdateCallback:function getDatasetsUpdateCallback(){var me=this;return{success:function(res){me.als=res.als;me.updateDatasets(res.datasets,res.datasetsSettings);}};},renameDataset:function renameDataset(did,name,callback){this.getDataService().submitUpdates([{act:"renameDataset",datasetID:did,name:name}],callback,REQUEST_ONLY_DATASETS);},renameEmmaSrcTable:function renameEmmaSrcTable(did,dsid,name,callback){this.getDataService().submitUpdates([{act:"renameEmmaSrcTable",dsid:dsid,did:did,n:name}],callback,REQUEST_DEFN_DATA);},addDataset:function addDataset(items,interimCallback){if(!items||!items.length){return ;}var me=this,controller=me.controller;function checkCubesAndSubmit(cubeInfos){var actions=[],unpublished=[];function submit(){var cmdMgr=controller.cmdMgr,interimCmd=cmdMgr.getInterimCmd();if(actions.length>0){var refreshCallback={success:function(response){controller.getRefreshCallback().success(response);controller.datasetsPanel.set("allObjectBrowserOpened",false);},failure:function(res){window.setTimeout(function(){var urInfo=interimCmd.urInfo;urInfo.callback={success:mstrmojo.emptyFn};interimCmd.cancel(true);},0);}},phase=cmdMgr.CMD_PHASE;interimCmd.urInfo.callback=refreshCallback;interimCmd.submit(actions,$FUNC.wrapMethods(refreshCallback,interimCallback),{skipUICmdMgrOnFailure:[$ERR.DOCDATA_PREPARE_TASK_REPORT_INCOMP],style:{params:{treesToRender:3}}},interimCallback?phase.MIDDLE:phase.LAST);}else{interimCmd.cancel();}}items.forEach(function(item){var cubeInfo=cubeInfos[item.did];actions.push({act:"addDataset",did:item.did,t:item.t,g:$HASH.keyarray(controller.datasetsPanel.data).length===1?1:0,disablePU:true});if(cubeInfo&&!cubeInfo.published){if(!(cubeInfo.dda===1&&cubeInfo.ddam===constantsDSM.dda)&&cubeInfo.dda!==3){actions.pop();unpublished.push(item);}}});if(actions.length){actions=actions.concat(me.getOpenDatasetPanelAction());}if(unpublished.length>0){mstrmojo.alert(mstrmojo.desc(13762,"The following datasets will not be added. You need to publish them first.")+" "+unpublished.map(function(item){return"<br/>- "+item.n;}).join(""),submit,null,null,null,{allowHTML:true});}else{submit();}}var cubeIds=items.map(function(item){return item.did;});if(mstrApp.isSingleTier){checkCubesAndSubmit({});}else{this.getDataService().getUserDICubeInfo(cubeIds,{success:function(cubeInfos){checkCubesAndSubmit(cubeInfos);}});}},getReloadLayoutModelCallback:function getReloadLayoutModelCallback(callback){var me=this;return $FUNC.wrapMethods({success:function(res){unloadLayouts.call(me,true);me.loadLayout(res);}},callback);},getRemoveUnitUpdate:function getRemoveUnitUpdate(params){var unit=params.unit,partialRetrievalKeys=params.partialRetrievalKeys,actions=[{act:"removeUnit",unitKey:unit.k,unitType:unit.defn.t,clearTargets:params.clearTargets}];if(partialRetrievalKeys){actions[0].partialRetrieval={nodes:partialRetrievalKeys};}return this.getDataService().newUpdate(null,{actions:actions});},getCopyEmptyTemplateAction:function getCopyEmptyTemplateAction(newKey,toKey){return{act:"copyUnit",unitKey:this.getCurrentLayoutDef().btn,unitType:521,newKey:newKey,toKey:toKey,partialRetrieval:{nodes:[newKey]}};},getToggleHiddenObjectAction:function getToggleHiddenObjectAction(dsid,unit,isHidden){return{act:"editDocUnitProp",dsid:dsid,unitId:unit.did,unitType:unit.t,prop:DOC_UNIT_PROP_HIDE,value:isHidden?"1":"0"};},updateUnitFormatWithUndo:function updateUnitFormatWithUndo(unit,formatType,format,undoFormat,callback){var dataService=this.getDataService(),that=this,handleActions=function(){var cmd=this,update=dataService.newUpdate(cmd,{actions:[that.getUnitFormatAction(unit,formatType,cmd.getStateValue(format,undoFormat))],callback:$HASH.copy({success:function(){callback.success(format);}},$HASH.copy(callback)),extras:mstrmojo.DocDataService.SUPPRESS_DATA});update.submit();};this.execute({execute:handleActions,urInfo:{silent:true,undo:function(){callback.success(undoFormat);},redo:function(){callback.success(format);}}});},renameRWUnitTitle:function renameRWUnitTitle(title,oldTitle,key,callback){this.updateTitle(title,oldTitle,key,this.currlaykey,null,callback);},renameRWUnit:function renameRWUnit(name,oldName,unitKey,callback){updateDisplayName.call(this,name,oldName,unitKey,this.currlaykey,"n",$ENUM_FORMAT_PROPERTIES.NAME,callback);},getRemoveControlUpdate:function getRemoveControlUpdate(ctrlKey,parentKey,targetKeys){var dataService=this.getDataService(),update=dataService.newUpdate(),updateNodeKeys=[parentKey].concat(targetKeys.split(ITEM_SEPARATOR)),action=dataService.getRemoveCtrlAction(ctrlKey,updateNodeKeys),that=this,cbs={success:function(res,req){var params=JSON.parse(req.params.params),prs=params.partialRetrieval,retKeysStr=(prs&&prs.nodes)?prs.nodes.join(ITEM_SEPARATOR):"";that.partialUpdate(res.data,that.getTargetDefn(retKeysStr),res.defn);}};update.addActions(action);update.addCallbacks(cbs);return update;},findKeyMap:function findKeyMap(node){var mapLayoutKeys=this.mapLayKeys;if(!mapLayoutKeys){return null;}var oldKey=mapLayoutKeys.oldKey,newKey=mapLayoutKeys.newKey,oldLayout=oldKey?this.getLayoutDefn(oldKey):null,newLayout=newKey?this.getLayoutDefn(newKey):null,newK=node.k,map={},path,oldND,newND,i;var fnBuildTree=function(defn){var tree={};Object.keys(defn.units).forEach(function(key){var unit=defn.units[key],pnk=unit.pnk;if(pnk){var tnd=tree[pnk]=tree[pnk]||[];tnd[unit.chdidx]=key;}});return tree;};var fnSearchNodePath=function(root,key,tree,units){if(root===key||!key){return[];}var pnk=units[key].pnk,idx=units[key].chdidx;path=fnSearchNodePath(root,pnk,tree,units).concat(idx);return path;};var fnGetNodeByPath=function(tree,path,me){var lookin=tree[me];if(path.length>0&&lookin){var head=path.shift();return fnGetNodeByPath(tree,path,lookin[head]);}return lookin;};var newtree=fnBuildTree(newLayout);if(oldLayout){if(!oldLayout.loaded){return null;}var oldtree=fnBuildTree(oldLayout);path=fnSearchNodePath(newKey,newK,newtree,newLayout.units);oldND=fnGetNodeByPath(oldtree,path,oldKey);newND=newtree[newK];for(i=0;oldND&&i<oldND.length;i++){if(oldND[i]){map[oldND[i]]=newND[i];}}}else{map["default"]=$ARR.filterOne(newtree[newK],function(key){return !!key;});}return map;},loadHiddenPageByStack:function loadHiddenPageByStack(builder,fnCallback){loadHiddenVIStack.call(this,$PANEL_TYPES.PAGEBY,"sections.0.subsections.0.objects.0.panels.0",builder,fnCallback);},getCtrlStyleFromDatasetUnit:function getCtrlStyleFromDatasetUnit(unit,isInFilterPanel){if(unit.um&&unit.isTopRank){return $CTRL_STYLE.METRIC_QUAL;}var unitType=unit.t,eleCount=unit.card||0,textBasedStyle=eleCount<=15?(isInFilterPanel?$CTRL_STYLE.CHECKBOX:$CTRL_STYLE.LINK):eleCount<=100?$CTRL_STYLE.CHECKBOX:$CTRL_STYLE.SEARCH_BOX,numberDateBasedStyle=eleCount<=50?$CTRL_STYLE.SCROLLER:eleCount<=1000?$CTRL_STYLE.CHECKBOX:$CTRL_STYLE.SEARCH_BOX,ctrlStyle={12:{3:textBasedStyle,2:numberDateBasedStyle,8:$CTRL_STYLE.ATTR_QUAL,1:$CTRL_STYLE.ATTR_QUAL,9:numberDateBasedStyle,11:numberDateBasedStyle,"default":textBasedStyle},4:{1:$CTRL_STYLE.METRIC_SLIDER,6:$CTRL_STYLE.METRIC_SLIDER,9:$CTRL_STYLE.METRIC_QUAL,16:$CTRL_STYLE.METRIC_QUAL,30:$CTRL_STYLE.METRIC_QUAL,31:$CTRL_STYLE.METRIC_SLIDER,"default":$CTRL_STYLE.METRIC_SLIDER},1:$CTRL_STYLE.CHECKBOX,47:$CTRL_STYLE.CHECKBOX}[unitType];if(unitType===TP_ATTRIBUTE){if(unit.lock){return $CTRL_STYLE.ATTR_QUAL;}if(unit.st===STP_RECURSIVE_ATTRIBUTE){return $CTRL_STYLE.CHECKBOX;}if(unit.de&&ctrlStyle[unit.formType]===$CTRL_STYLE.ATTR_QUAL){return ctrlStyle["default"];}if(!eleCount){var datasets=this.datasets,dsId,dataset,attrFormType,attrInDataSet,seenAttribute=false,fnHasNoCard=function(attribute){attrFormType=attribute.formType;attrInDataSet=attribute.did===unit.did&&!attribute.card;seenAttribute=seenAttribute||attrInDataSet;return attrInDataSet;};for(dsId in datasets){dataset=datasets[dsId];if(dataset.att.some(fnHasNoCard)&&(dataset.dsm===2||dataset.idd)){if(attrFormType===$BASE_TYPE.DssXmlBaseFormDate||attrFormType===$BASE_TYPE.DssXmlBaseFormDateTime){return ctrlStyle[attrFormType]||ctrlStyle["default"];}return $CTRL_STYLE.SEARCH_BOX;}}if(!seenAttribute){attrFormType=unit.formType;if(attrFormType&&(attrFormType===$BASE_TYPE.DssXmlBaseFormDate||attrFormType===$BASE_TYPE.DssXmlBaseFormDateTime)){return ctrlStyle[attrFormType]||ctrlStyle["default"];}return $CTRL_STYLE.SEARCH_BOX;}}return ctrlStyle[unit.formType]||ctrlStyle["default"];}if(unitType===TP_METRIC){return ctrlStyle[unit.dt||"default"]||ctrlStyle["default"];}return ctrlStyle;},getCtrlHeightByStyle:function getCtrlHeightByStyle(ctrlStyle,displayRowsCount){var widgetHeightMap={"default":140,4:200,9:140,1:80,3:200,0:80,7:100,8:80,11:100};if((ctrlStyle===3||ctrlStyle===4)&&displayRowsCount<=8){return 22*Math.max(displayRowsCount,2)+24;}return widgetHeightMap[ctrlStyle]||widgetHeightMap["default"];},getICSCtrlMoveHeightByStyle:function getICSCtrlMoveHeightByStyle(ctrlStyle){var widgetHeightMap={"default":20,4:20,9:40,1:60,3:20,0:60,7:60,8:60,11:60};return widgetHeightMap[ctrlStyle]||widgetHeightMap["default"];},getCtrlActionsByStyle:function getCtrlActionsByStyle(unit,keyContext,ctrlStyle,orientation,height,width,zIndex,sec){var fmt={FormattingSize:{HeightMode:"0"}},fmtSize=fmt.FormattingSize,keyContextParts=splitKeyContext(keyContext),nodeKey=keyContextParts.nodeKey,ctrlKey=keyContextParts.ctrlKey,actions=[],zoomProps=this.getZoomProps(),eleCount=unit.card||0;$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_STYLE,ctrlStyle,fmt);if(unit.t===TP_METRIC&&unit.dt&&unit.dt!==$DT.DataTypeDouble&&unit.dt!==$DT.DataTypeInteger&&unit.dt!==$DT.DataTypeCellFormatData){$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_METRIC_CONDITION_TYPE,1,fmt);}if(orientation){$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_ORIENTATION,orientation,fmt);}if(height){fmtSize.Height=$NUM.toLocaleString($BOX.px2Inches(zoomProps,height));}if(width){fmtSize.Width=$NUM.toLocaleString($BOX.px2Inches(zoomProps,width));}if(zIndex!==undefined){$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.Z_INDEX,zIndex,fmt);}if(eleCount===0||eleCount>50){$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_ITEM_WIDTH_MODE,1,fmt);}if(sec!==undefined){$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_SHOW_ELEMENT_COUNT,sec,fmt);}$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_EXPORT_AS_SHOWN_ON_WEB,1,fmt);actions.push({act:"format",unitType:$RW_UNIT_TYPES.SELECTOR,keyContext:keyContext,formatType:1,format:fmt});if(unit.isTopRank){actions.push(this.getDataService().getSelectorExpressionAction({ck:keyContext,ckey:ctrlKey,srcid:unit.did,srct:unit.t,f:1,ft:2,cs:unit.cs,dtp:$DT.DataTypeReal,type:1,include:true,changeQual:true,qt:unit.qt,unset:false}));}if(ctrlStyle!==3){actions.push({act:"setControlShowAll",nodeKey:nodeKey,controlKey:ctrlKey,showAll:true});}return actions;},clearMapLayout:function clearMapLayout(){delete this.mapLayKeys;delete this.replaceKeyBoxes;},isInDataset:function isInDataset(datasetId,unitId,config){config=config||["att","mx"];var dataset=this.datasets[datasetId]||{};foundIt=false;$ARR.forEach(config,function(type){$HASH.forEach(dataset[type]||{},function(it){foundIt=it.did===unitId;return !foundIt;});return !foundIt;});return foundIt;},findDatasetIdFromUnit:function(unitId){var dsId=null;$HASH.forEach(this.datasets,function(ds,id){$HASH.forEach((ds.att||[]).concat(ds.mx),function(mc){if(mc.did===unitId){dsId=id;return false;}});if(!!dsId){return false;}});return dsId;},findUnitNameInDataSetFromUnit:function(unitId){var unitName=null;$HASH.forEach(this.datasets,function(ds,id){$HASH.forEach((ds.att||[]).concat(ds.mx),function(mc){if(mc.did===unitId){unitName=mc.n;return false;}});if(!!unitName){return false;}});return unitName;},addShortcutMetric:function(data,callback){var dataItems=data.items,me=this;me.execute({execute:function(){this.submit($HASH.copyProps(["dsid","nodeKey","treeType","funcType","funcType2","prs","breakBys"],data,{act:"addShortcutMetric",units:dataItems&&dataItems.length?dataItems.map(function(item){return{id:item.did,type:item.t};}):[]}),callback,{style:{params:{treesToRender:1}}});},urInfo:{callback:callback}});},submitDataDefnUpdate:function submitDataDefnUpdate(actions,callback){this.getDataService().submitUpdates(actions,callback,REQUEST_DEFN_DATA);},rebuildUnitFromDataCache:function rebuildUnitFromDataCache(unitId,parentKey,builder){return builder.build([this.getLayoutDataCache(this.getCurrentLayoutKey())[unitId]],this,{pk:parentKey})[0];},getDocBuilder:function getDocBuilder(){return this.controller.view.builder;},submitUndoRedoFormatChange:function submitUndoRedoFormatChange(unit,execFormats,undoFormats,callback,extras){var model=this,unitKey=unit.k,unitId=unit.id,panel=unit.parent,fnGetActions=function(formats){var actions=[];$HASH.keyarray(formats).forEach(function(formatType){actions.push(model.getUnitFormatAction(unit,formatType,formats[formatType]));});return actions;},hasSuccessFn=!!(callback&&callback.success);this.controller.submitUndoRedoUpdates(fnGetActions(execFormats),{},$FUNC.wrapMethods({success:function success(res){model.partialUpdate(res.data,model.getTargetDefn(unitKey),res.defn,[unitKey]);if(!hasSuccessFn){var rebuildUnit=mstrmojo.all[unitId];panel.selectVIUnit(panel.rebuildChild(rebuildUnit),true);}}},callback),extras||REQUEST_DEFN_DATA);},removePageByUnit:function removePageByUnit(panel,unit){var dataService=this.getDataService(),model=this,showPageBy=false,callback={success:function success(res){getPageByRebuildFn.call(model,true)(res);panel.setOpenStatus(showPageBy,true);showPageBy=!showPageBy;}};this.cmdMgr().execute({execute:function(){var pageByPanel=model.getVIComponent(VI_PAGE_PANEL),update=dataService.newUpdate(this,{actions:[dataService.getRemoveCtrlAction(unit.ckey,[pageByPanel.k,model.getVIComponentKey(VI_VIZ_STACK)]),model.getUnitFormatAction(pageByPanel,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.VISIBLE,false))],callback:callback});this.submitUpdate(update);},urInfo:{callback:callback}});},changePageByStyle:function changePageByStyle(selector,newStyle){var selectorKey=selector.ckey,action=this.getUnitFormatAction(selector.node,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_ORIENTATION,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_STYLE,newStyle)));this.controller.submitUndoRedoUpdates(action,null,{success:getPageByRebuildFn.call(this,false,[selectorKey])},REQUEST_DEFN_DATA);},changeFilterTargets:function changeFilterTargets(filterCtrl,existingTargets,newTargets,disablePU,noTargetUpdate){var dataService=this.getDataService(),filterDefn=filterCtrl.defn,keyContext=filterDefn.ck,sourceType=filterDefn.srct,sourceSubType=filterDefn.srcst,filterKey=filterCtrl.k,addedTgtKeys=newTargets.filter(function(key){return existingTargets.indexOf(key)<0;}),removedTgtKeys=existingTargets.filter(function(key){return newTargets.indexOf(key)<0;}),fnConvertCtrlKeyToNodeKey=function(key){var unitDefinition=this.getTargetDefn(key)[key],targetKeyContext=unitDefinition.ck;if(targetKeyContext){key=splitKeyContext(targetKeyContext).nodeKey;}return key;}.bind(this),actions=removedTgtKeys.map(function(key){key=fnConvertCtrlKeyToNodeKey(key);return dataService.getRemoveCtrlTargetAction(keyContext,key,key,disablePU);}).concat(addedTgtKeys.map(function(key){var isGBSel=isGroupBySelector(sourceType,sourceSubType),disablePU=disablePU;key=fnConvertCtrlKeyToNodeKey(key);disablePU=(key&&isGBSel)?false:disablePU;return dataService.getAddCtrlTargetAction(keyContext,key,key,isGBSel,disablePU,noTargetUpdate);}.bind(this)));if(actions.length===0){return ;}this.controller.submitUndoRedoUpdates(actions,null,{success:function(response){var unit=this.getVizContentPanel().getUnitByKey(filterKey),tgtKeys=[filterKey].concat(addedTgtKeys).concat(removedTgtKeys).join(ITEM_SEPARATOR);this.partialUpdate(response.data,this.getTargetDefn(tgtKeys),response.defn,[filterKey]);if(unit){unit.parent.rebuildChild(unit);}}.bind(this)},REQUEST_DEFN_DATA);},changeFilterStyle:function changeFilterStyle(docSelector,newStyle,bMulti){var isInFilterPanel=docSelector.isInFilterPanel(),oldStyle=docSelector.style,filterKey=docSelector.k,selectorType=docSelector.defn.srct,ces=docSelector.node.data.ces||[],formatObj=$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_STYLE,newStyle),changeMultiSelect=bMulti?1:(bMulti===false?-1:0),$SELECTOR_STYLES=mstrmojo.DocSelector.STYLES,unit=this.getDatasetUnits(["att","mx"],function(unit){return unit.did===docSelector.defn.srcid;})[0],orientation,requestDef={style:{params:{treesToRender:1}}};if(!changeMultiSelect){switch(newStyle){case $SELECTOR_STYLES.RADIO:changeMultiSelect=-1;break;case $SELECTOR_STYLES.PULLDOWN:case $SELECTOR_STYLES.BUTTON:case $SELECTOR_STYLES.LINK:case $SELECTOR_STYLES.LIST:changeMultiSelect=ces.length<=1?-1:1;break;case $SELECTOR_STYLES.CHECKBOX:case $SELECTOR_STYLES.SCROLLER:case $SELECTOR_STYLES.SEARCH_BOX:changeMultiSelect=1;break;}}if(changeMultiSelect){$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_MULTISELECT,changeMultiSelect>0,formatObj);}if(isInFilterPanel){var fnGetOrientation=function(style){return(style===$SELECTOR_STYLES.SCROLLER||style===$SELECTOR_STYLES.METRIC_QUAL||style===$SELECTOR_STYLES.METRIC_SLIDER)?1:0;};orientation=fnGetOrientation(newStyle);if(fnGetOrientation(oldStyle)!==orientation){$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_ORIENTATION,orientation,formatObj);}$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.HEIGHT,mstrmojo.boxmodel.px2Inches(this.getZoomProps(),this.getCtrlHeightByStyle(newStyle,unit.card||((newStyle===$SELECTOR_STYLES.RADIO||newStyle===$SELECTOR_STYLES.CHECKBOX)?DEFAULT_ROWS_COUNT:0)+(docSelector.showall?1:0))),formatObj);}else{orientation=(docSelector.parent.orientation==="h")?1:0;$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.CONTROL_ORIENTATION,orientation,formatObj);}if((selectorType===TP_METRIC)||(oldStyle===$SELECTOR_STYLES.SEARCH_BOX&&docSelector.defn.sos)||(oldStyle===$SELECTOR_STYLES.ATTR_QUAL)||(newStyle===$SELECTOR_STYLES.ATTR_QUAL)){requestDef=REQUEST_DEFN_DATA;}var fnSubmitStyleChange=function(){var me=this,controller=me.controller,cmdmgr=controller.cmdMgr;this.controller.submitUndoRedoUpdates(this.getUnitFormatAction(docSelector,1,formatObj),null,{failure:function(response,request){var fn=null;if(response.code==$ERR.DFC_QRYENG_RES_TRUNC){fn=function(){cmdmgr.cmds.pop();cmdmgr.pos--;docSelector.skipUR=true;me.changeFilterStyle(docSelector,$SELECTOR_STYLES.SEARCH_BOX);};}mstrmojo.error({longDesc:response.message},fn,{onClose:fn,title:"Error"});},success:function(response){this.updateDefnCache(response.defn,[filterKey]);this.updateDataCache(response.data,this.getTargetDefn(filterKey));if(docSelector.skipUR){docSelector.skipUR=false;cmdmgr.cmds.pop();cmdmgr.pos--;}if(isInFilterPanel){var filterPanel=this.getVIComponent($VI_TYPES.FILTER_PANEL);filterPanel.rebuildChild(filterPanel.children.filter(function(child){return child.k===filterKey;})[0]);}else{var unitContainer=this.getVizContentPanel().getUnitByKey(filterKey);unitContainer.parent.rebuildChild(unitContainer);}}.bind(this)},requestDef);}.bind(this);if(requestDef===REQUEST_DEFN_DATA&&newStyle!==$SELECTOR_STYLES.SEARCH_BOX&&unit&&unit.card>2000){mstrmojo.warn(mstrmojo.desc(13140,"This attribute has ## distinct values. Changing the display style may take a long time or potentially cause instability. Are you sure you want to continue?").replace("##",unit.card),{confirmBtn:{fn:fnSubmitStyleChange}},{cssClass:"filterPanel-confirm"});}else{fnSubmitStyleChange();}},changeUnitFormatProperty:function changeUnitFormatProperty(unit,formats){var panel=unit.parent,unitKey=unit.k,model=this;this.saveUnitFormatProperty(unit,formats,{success:function(res){model.partialUpdate(res.data,model.getTargetDefn(unitKey),res.defn,[unitKey]);panel.selectVIUnit(panel.rebuildChild(panel.getUnitByKey(unitKey)),true);}},mstrmojo.DocDataService.REQUEST_ONLY_DEFINITION);},saveUnitFormatProperty:function saveUnitFormatProperty(unit,formats,callback,extras,urInfo){var dataService=this.getDataService(),panel=unit.parent,unitKey=unit.k,model=this;urInfo=urInfo||{callback:callback};this.execute({execute:function(){var update=dataService.newUpdate(this,{extras:extras});[].concat(formats).forEach(function(formatInfo){update.addActions(model.getUnitFormatAction(panel.getUnitByKey(unitKey),formatInfo.formatType,$GET_FORMAT_OBJ(formatInfo.propertyName,this.getStateValue(formatInfo.newValue,formatInfo.oldValue))));},this);update.addCallbacks(callback);update.submit();},urInfo:urInfo});},getKeepOnlyOrExcludeAction:function getKeepOnlyOrExcludeAction(key,selectorData){var me=this,isDeMap={},tid;$ARR.forEach(selectorData,function(o){$ARR.forEach(o.data,function(d){$ARR.forEach(d,function(e){if($EH.isNonGroupNull(e)){e.eid="h"+$EH.TERSE_NULL+";"+e.tid;}else{tid=e.tid;if(isDeMap[tid]===undefined){isDeMap[tid]=!!me.getDEObject(tid);}e.isDe=isDeMap[tid];}});});});return{act:"keepOnly",keyContext:key,selectorObjects:[].concat(selectorData),partialRetrieval:{nodes:[key].concat(this.getSourceFilterKeys(key))}};},partialUpdateAndRebuildChild:function partialUpdateAndRebuildChild(child,response,refreshKeys){if(!response.data&&!response.defn){return ;}var updateParams=[response.data,this.getTargetDefn(child.k)];if(refreshKeys){updateParams=updateParams.concat([response.defn,refreshKeys]);}this.partialUpdate.apply(this,updateParams);if(child.clearCache){child.clearCache();}return child.parent.rebuildChild(child);},getUpdateHiddenPanelsCallback:function getUpdateHiddenPanelsCallback(){var docModel=this;return{success:function(res){if(res.pukeys){var unitDefns=docModel.getUnitDefinitions(res.pukeys),updatedDataCache=docModel.partialUpdate(res.data,unitDefns),unitsNotUpdated=Object.keys(unitDefns).filter(function(unitKey){return Object.keys(updatedDataCache.def).indexOf(unitKey)===-1;});unitsNotUpdated.forEach(function(unitKey){var widgetId=docModel.getWidgetId({k:unitKey,wid:1}),widget=widgetId&&mstrmojo.all[widgetId],defn;while(widget){defn=widget.defn;if(defn&&defn.t===mstrmojo.EnumRWUnitType.PANEL&&widget.setDirty){widget.setDirty(true);break;}widget=widget.parent;}});}}};},getUpdateHiddenLayoutsCallback:function getUpdateHiddenLayoutsCallback(){var model=this;return{success:function(res){var puKeys=res.pukeys&&res.pukeys.split("\u001E");if(puKeys&&puKeys.length>0){var targetDefinitions=model.getUnitDefinitions(puKeys);var fnMarkLayoutDirty=function(layout){var defn=layout.defn;if(defn.units[def]!==undefined){defn.loaded=false;}};for(var def in targetDefinitions){if(targetDefinitions[def]===undefined){(model.controller.view.getLayouts()||[]).forEach(fnMarkLayoutDirty);}}}}};},submitSelectorPropsChange:function submitSelectorPropsChange(unitContainer,props){var model=this,keyContext=unitContainer.defn.ck,unitKey=unitContainer.k,panel=unitContainer.parent;this.controller.submitUndoRedoUpdates($HASH.copy(props,{act:"editSelectorProps",keyContext:keyContext,ctrlKey:unitContainer.k,partialRetrieval:{nodes:[this.getDataService().getNodeKeyFromKeyContext(keyContext)]}}),{},{success:function success(res){model.partialUpdate(res.data,model.getTargetDefn(unitKey),res.defn,[unitKey]);var rebuildUnit=panel.getUnitByKey(unitKey);panel.selectVIUnit(panel.rebuildChild(rebuildUnit),true);}},REQUEST_DEFN_DATA);},getDEObject:function getDEObject(id){var deMap=this.deMap=this.deMap||{},res=deMap[id],i;if(!res){$HASH.forEach(this.datasets,function(ds,dsId){i=$ARR.find(ds.att,"did",id);var unit=ds.att[i];if(i>=0&&unit.t===47&&unit.st===12033){res=unit;res.dsId=dsId;deMap[id]=res;return false;}});}return res;},getBrowseFormTypes:function getBrowseFormTypes(id){var types=[],index;$HASH.forEach(this.datasets,function(ds){index=$ARR.find(ds.att,"did",id);if(index>=0){$ARR.forEach(ds.att[index].fs,function(form){if(form.isbf){types.push(form.bftp);}});return false;}});return types;},isOldDEObject:function isOldDEObject(id){var exists=false,index;$HASH.forEach(this.datasets,function(ds){index=$ARR.find(ds.att,"did",id);if(index>=0&&ds.att[index].de){exists=true;return false;}});return exists;},changeCurrLytTabTtl:function changeCurrLytTabTtl(text,oldText){this.controller.view.changeCurrLytTabTtl(text,oldText);},updateRootDefn:function updateRootDefn(newDefn){$HASH.copy(newDefn&&newDefn.root,this.getRootNode().defn);this.raiseEvent({name:"updateRootDefn"});},addUpdateObjects:function addUpdateObjects(action,objects){if(action){action.partialUpdate=action.partialUpdate||{};action.partialUpdate.objects=mstrmojo.array.ensureArray(objects);}return action;},updateTypeCounter:function updateTypeCounter(objectType){var counter=getTypeCounter.call(this,objectType)+1;this.obCntrs[this.getCurrentLayoutKey()][objectType]=counter;return counter;},getNumberFormatAction:function getNumberFormatAction(id,type,data){var filterPanelStack=this.getVIComponent($VI_TYPES.FILTER_STACK),selector=filterPanelStack&&filterPanelStack.getFilterBySrcId(id),action=$HASH.copy({act:"numberFormat",unitId:id,unitType:type},this.createNumberFormatParams(data));if(type===4&&selector){action.partialRetrieval={nodes:[selector.k]};}return action;},isFromSolrCube:function isFromSolrCube(id){var ds=this.datasets[this.findDatasetIdFromUnit(id)],table=ds&&ds.tables&&ds.tables.length===1&&ds.tables[0];return table&&table.dict===131078;},isFromMDXCube:function isFromMDXCube(id){return this.isMDXDataset(this.datasets[this.findDatasetIdFromUnit(id)]);},isMDXDataset:function isMDXDataset(dataset){return dataset.tables&&dataset.tables[0]&&dataset.tables[0].xdaType===2;},isDatasetHasRecursiveAttribute:function isDatasetHasRecursiveAttribute(dataset){return dataset&&dataset.att&&dataset.att[0]&&dataset.att[0].t===TP_ATTRIBUTE&&dataset.att[0].st===STP_RECURSIVE_ATTRIBUTE;},hasMDXRADataset:function hasMDXRADataset(datasets){var res=false;datasets=datasets||this.datasets;$HASH.forEach(datasets,function(dataset){if(this.isMDXDataset(dataset)&&this.isDatasetHasRecursiveAttribute(dataset)){res=true;return false;}},this);return res;},hasNonRADataset:function hasNonRADataset(datasets){var res=false;datasets=datasets||this.datasets;$HASH.forEach(datasets,function(dataset){if(!(this.isMDXDataset(dataset)&&this.isDatasetHasRecursiveAttribute(dataset))){res=true;return false;}},this);return res;},isMDXTable:function isMDXTable(table){return table.xdaType===2;},isDDADataset:function isDDADataset(dataset){return dataset.st===779&&dataset.dsm===constantsDSM.dda;},isDataImportRemoteDataSource:function isDataImportRemoteDataSource(dataset){return dataset.tables&&dataset.tables[0]&&dataset.tables[0].xdaType===400;},createNumberFormatParams:function createNumberFormatParams(data){var category=data.category,action={c:category,f:data.format};var ndp=data.decimalPlaces,nnn=data.negativeNumbers;switch(category){case 0:action.ndp=ndp;action.nth=data.thousandSeparator;action.nnn=nnn;break;case 1:action.ndp=ndp;action.ncs=data.currencySymbol;action.ncp=data.currencyPosition;action.nnn=nnn;break;case 4:action.ndp=ndp;action.nnn=nnn;break;case 6:action.ndp=ndp;break;}return action;},_selsWarningFlags:null,openSelWarnFlag:function openSelWarnFlag(selectorKey){var wfs=this._selsWarningFlags=this._selsWarningFlags||{};wfs[selectorKey]=true;},closeSelWarnFlag:function closeSelWarnFlag(selectorKey){var wfs=this._selsWarningFlags=this._selsWarningFlags||{};wfs[selectorKey]=false;},isSelWarnFlagOn:function isSelWarnFlagOn(selectorKey){var wfs=this._selsWarningFlags;if(wfs){return !!wfs[selectorKey];}return false;},allowManageDocumentDataset:function allowManageDocumentDataset(){return !getFeature("web-disable-manage-document-dataset");},allowNewOrEditRolapDS:function allowNewOrEditRolapDS(){return !getFeature("vi-unsupport-create-edit-rolap-report");},allowNewOrEditDummyDS:function allowNewOrEditDummyDS(){return !getFeature("vi-unsupport-create-edit-dummy-dataset");},allowSaveDataset:function allowSaveDataset(){return !getFeature("disable-save-dataset");},allowAccessDataFromFile:function allowAccessFiles(){return !getFeature("disable-access-data-from-file");},allowAccessDataFromDatabase:function allowAccessData(){return !getFeature("disable-access-data-from-database");},allowAccessDataFromCloudApp:function allowAccessCloudApp(){return !getFeature("disable-access-data-from-cloud-app");},allowImportData:function allowImportData(){return this.allowAccessDataFromFile()||this.allowAccessDataFromDatabase()||this.allowAccessDataFromCloudApp();},allowReExecuteRegularReport:function allowReExecuteRegularReport(){return !getFeature("disable-reexecute-regular-report");},allowReExecuteViewReport:function allowReExecuteViewReport(){return !getFeature("disable-reexecute-view-report");},allowReExecuteCubeReport:function allowReExecuteCubeReport(){return !getFeature("disable-reexecute-cube-report");},isSchemaDefined:function isSchemaDefined(){return !!getFeature("web-is-schema-defined");},hasPrivilegesForAllTables:function hasPrivilegesForAllTables(tables){var privilege=true;tables.forEach(function(table){switch(table.xdaType){case constantsXdaType.text:case constantsXdaType.excel:case constantsXdaType.refine:case constantsXdaType.dataImportOAuthGDrive:case constantsXdaType.dataImportOAuthDropbox:if(!this.allowAccessDataFromFile()){privilege=false;return ;}break;case constantsXdaType.dataImportOAuthGBigQuery:case constantsXdaType.dataImportOAuthGBigQueryFFSQL:case constantsXdaType.dataImportOAuthGBigQuerySingleTable:case constantsXdaType.qbSingleTable:case constantsXdaType.ffsql:case constantsXdaType.querybuilder:case constantsXdaType.mdx:if(!this.allowAccessDataFromDatabase()){privilege=false;return ;}break;case constantsXdaType.salesforce:case constantsXdaType.dataImportOAuthGAnalytics:case constantsXdaType.twitter:case constantsXdaType.facebook:if(!this.allowAccessDataFromCloudApp()){privilege=false;return ;}break;}},this);return privilege;},getOpenDatasetPanelAction:function openDatasetPanel(){var datasetPanel=this.controller.rootCtrl.datasetsPanel;if(datasetPanel.getOpenStatus()!==true){datasetPanel.setOpenStatus(true,true);return[this.getUnitFormatAction(this.getRootNode(),1,{FormattingAnalysis:{DatasetObjectsVisible:true}},true)];}return[];},populateAttributeIdLinkInfo:function populateAttributeIdLinkInfo(){var als=this.als;if(!als){return ;}if(!als.idLinks){als.idLinks={};var idLinks=als.idLinks;$ARR.forEach(als,function(pair){$HASH.forEach(pair,function(p2,p1){var p1Pair=p1.split(" "),p2Pair=p2.split(" "),attId1=p1Pair[0],attId2=p2Pair[0],arr1,arr2;idLinks[attId1]=idLinks[attId1]||[];arr1=idLinks[attId1];$ARR.forEach(arr1,function(arr1Id){idLinks[arr1Id]=idLinks[arr1Id]||[];idLinks[arr1Id].push(attId2);});idLinks[attId1].push(attId2);if(!!idLinks[attId2]){var appendListFor1=idLinks[attId2];$ARR.forEach(appendListFor1,function(item){if(item!==attId1&&idLinks[attId1].indexOf(item)===-1){idLinks[attId1].push(item);}});}idLinks[attId2]=idLinks[attId2]||[];arr2=idLinks[attId2];$ARR.forEach(arr2,function(arr2Id){idLinks[arr2Id]=idLinks[arr2Id]||[];idLinks[arr2Id].push(attId1);});idLinks[attId2].push(attId1);if(!!idLinks[attId1]){var appendListFor2=idLinks[attId1];$ARR.forEach(appendListFor2,function(item){if(item!==attId2&&idLinks[attId2].indexOf(item)===-1){idLinks[attId2].push(item);}});}});});}},warnForEditStandaloneDS:function(dataset,cb,cancelFn){if(!dataset.mngd){mstrmojo.confirm(mstrmojo.desc(13525,"Modifications to this dataset will affect other reports, documents, and dashboards that share the dataset. Do you want to continue?"),{confirmBtn:{fn:function(){cb();}},cancelBtn:{t:mstrmojo.desc(221,"Cancel"),fn:cancelFn}});}else{cb();}}});mstrmojo.vi.models.DocModel.DatasetUnitType=null;mstrmojo.vi.models.DocModel.UnitFormatInfo=null;}());