(function(){mstrmojo.requiresCls("mstrmojo.DocXtabModel","mstrmojo.vi.ui._CanDropFromSchema","mstrmojo.models.template.DataInterface","mstrmojo.vi.models.EnumDragSources","mstrmojo.array","mstrmojo.expr","mstrmojo.func","mstrmojo.hash","mstrmojo.DocDataService","mstrmojo.vi.ui.DatasetUnitMenuUtils");var $EXP=mstrmojo.expr,$ENUM_FUNCTION=$EXP.FN,$ENUM_EXPR_TYPE=$EXP.ET,$HASH=mstrmojo.hash,$ENUM_DRAG_SOURCES=mstrmojo.vi.models.EnumDragSources,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$A=mstrmojo.array,$S=mstrmojo.string;var TYPE_METRIC=4,TYPE_ATTRIBUTE=12,TEMPLATE_METRICS_ID="-1";var TYPE_BOOLEAN=3;function getCmdMgr(me){return me.docModel.controller.cmdMgr;}function getPartialRetrievalKeys(me,action){var xtabKey=me.xtab.k;return[xtabKey].concat(me.docModel.getSourceFilterKeys(xtabKey,true));}function addClearActions(vis,templateThresholds,metricId,actions,objectType){templateThresholds.reverse().forEach(function(thresholdData){actions.push(vis.model.getClearThresholdAction(metricId,objectType,thresholdData.tid));});}mstrmojo.vi.models.DocXtabModel=mstrmojo.declare(mstrmojo.DocXtabModel,[mstrmojo.vi.ui._CanDropFromSchema],{scriptClass:"mstrmojo.vi.models.DocXtabModel",getUnHiddenDrillPathsForCell:function getUnHiddenDrillPathsForCell(cell,title){var allDrillPaths=this.getAllDrillPathsForCell(cell,title),datasets=this.docModel.datasets,fnShowInUnits=function(units,drillPath){var i=$A.find(units,"did",drillPath.id),unit=units[i];if(unit&&!unit.hide){drillPath.n=unit.n;return true;}return false;};return $A.filter(allDrillPaths,function(drillPath){var key;for(key in datasets){var ds=datasets[key];if(fnShowInUnits(ds.att,drillPath)){return true;}}return false;});},getAllDrillWithinPathsForCell:function getAllDrillWithinPathsForCell(cell,title,excludeHidden){var allDrillPaths=excludeHidden?this.getUnHiddenDrillPathsForCell(cell,title):this.getAllDrillPathsForCell(cell,title);return allDrillPaths.filter(function(drillPath){return !!drillPath.within;});},sort:function sort(params,callback){var me=this;getCmdMgr(this).execute({execute:function execute(){var nodeKey=me.xtab.k;this.submit(me.docModel.getDataService().getUpdateTemplateAction(nodeKey,{act:"sort",sorts:params.sorts,nodeKey:nodeKey,subTotalsPos:params.stp||me.getSubTotalsPos(),stt:params.stt||-1}),callback);}});},drillGrid:function drillGrid(params,callback){var me=this;getCmdMgr(this).execute({execute:function execute(){this.submit(me.docModel.getDataService().getDrillGridAction(params),callback);}});},getClearThresholdAction:function getThresholdAction(unitId,unitType,thresholdIndex){return{act:"clearThreshold",unitId:unitId,unitType:unitType,tid:thresholdIndex};},getCreateSimpleThresholdAction:function getCreateSimpleThresholdAction(thresholds,nodeKey,objectId,thresholdType,basedOnId,objectType){return{act:"threshold",nodeKey:nodeKey,thresholds:thresholds,thresholdType:thresholdType,basedOnId:basedOnId||objectId,did:objectId,objType:objectType};},getZoneFormatAction:function getZoneFormatAction(zone,formats,nodeKey){var units=[],axis=[],header="h",grid="g",subtotalHeader="sh",subtotalGrid="sg",fnAddAxis=function(axisId,regions){axis.push({axis:axisId,regions:regions});};if(zone==="ch"){fnAddAxis(1,[header]);fnAddAxis(2,[header,grid,subtotalHeader]);}else{if(zone==="rh"){fnAddAxis(1,[grid,subtotalHeader]);}else{if(zone==="va"){this.data.gsi.mx.forEach(function(unit){units.push({unitId:unit.did,unitType:4,regions:[grid]});});fnAddAxis(1,[subtotalGrid]);fnAddAxis(2,[subtotalGrid]);}}}return{act:"formatGridZone",nodeKey:nodeKey,props:formats,units:units,axis:axis};},getSelectorDataFromViewFilter:function getSelectorDataFromViewFilter(viewFilterExpr){var result=[],UNSUPPORTED_VF_ERROR="The expression is not supported by the View Filter Exception Parser.",isKeepOnlyTree=function isKeepOnlyTree(currentNode){var result=null;if([$ENUM_EXPR_TYPE.AE,$ENUM_EXPR_TYPE.ANDOR].indexOf(currentNode.et)>-1||(currentNode.et===$ENUM_EXPR_TYPE.AQ&&currentNode.fn===$ENUM_FUNCTION.IS_NULL)){if(!currentNode){return true;}var nodes=currentNode.nds;result=!(currentNode.not||currentNode.fn===$ENUM_FUNCTION.NOT||currentNode.fn===$ENUM_FUNCTION.NOT_IN_LIST);if(nodes){nodes.every(function(node){result=result&&isKeepOnlyTree(node);});}}else{throw UNSUPPORTED_VF_ERROR;}return result;},buildData=function buildData(currentNode,data){var childNodes=currentNode&&currentNode.nds,isORNode=currentNode.fn===$ENUM_FUNCTION.OR;if(childNodes&&childNodes.length){var childData=data;childNodes.forEach(function(childNode){if(isORNode){childData=[];}buildData(childNode,childData);if(isORNode){data.push(childData);}});}else{if(currentNode.fn===$ENUM_FUNCTION.IS_NULL){var attributeInfo=currentNode.a=currentNode.a||{n:"Null Attribute",did:""};data.push({tn:attributeInfo.n,tid:attributeInfo.did,eid:null,v:""});}else{if(currentNode.et===$ENUM_EXPR_TYPE.AE){var elements=currentNode.es;elements.forEach(function(element){if($S.isEmpty(element.n)){throw UNSUPPORTED_VF_ERROR;}data.push({tn:currentNode.a.n,tid:currentNode.a.did,eid:element.v,v:element.n});});}}}return data;};try{if(viewFilterExpr){(viewFilterExpr.nds||[]).forEach(function(rootNode){result.push({keepOnly:isKeepOnlyTree(rootNode),data:buildData(rootNode,[])});});}}catch(err){if(err!==UNSUPPORTED_VF_ERROR){console.error("vi.models.DocXtabModel: Encountered a problem parsing the view filter expression ("+err+")");}else{return[];}}return result;},getRemoveMetricLimitsAction:function getRemoveMetricLimitsAction(limitExpr){var metricIds=[],actions=[],addLimitMetricIds=function addLimitMetricIds(currentNode,metricIds){if(!currentNode){return ;}var nodes=currentNode.nds;if(nodes){nodes.forEach(function(node){var metricInfo=node.m;if(metricInfo!==undefined){metricIds.push(metricInfo.did);}else{addLimitMetricIds(node,metricIds);}});}};if(limitExpr){addLimitMetricIds(limitExpr,metricIds);metricIds.forEach(function(metricId){actions.push({act:"removeMetricLimits",unitId:metricId});});}return actions;},getAddTemplateUnitAction:function getAddTemplateUnitAction(item,dsid,axis,idx){var rtn=this._super(item,dsid,axis,idx),prKeys=getPartialRetrievalKeys(this,rtn);if(prKeys.length>0){rtn.partialRetrieval={nodes:prKeys};}return rtn;},getRemoveTemplateUnitAction:function getRemoveTemplateUnitAction(unit){var rtn=this._super(unit),prKeys=getPartialRetrievalKeys(this,rtn);if(prKeys.length>0){rtn.partialRetrieval={nodes:prKeys};}return rtn;},getAdvancedPropertiesAction:function getCreateSimpleThresholdAction(props){return{act:"advancedProperties",props:props};},canShowCellMenu:function canShowCellMenu(cell){var isSubtotalValue,union=this.getCellDataUnion(cell);isSubtotalValue=!cell.stt&&union.some(function(item){return !!item.isSubtotal;});return !isSubtotalValue;},getKeepOnlyActionsForAssociatedNodes:function getKeepOnlyActionsForAssociatedNodes(selectorData,callback,xtab){var docModel=this.docModel,actions=[docModel.getKeepOnlyOrExcludeAction(this.xtab.k,selectorData)],visualization=!!xtab?xtab:this.xtab,associatedNodes=(visualization.getAssociatedNodes&&visualization.getAssociatedNodes())||[];callback=mstrmojo.func.wrapMethods(callback,{success:function success(){$A.forEach(associatedNodes,function(node){docModel.getPanel().getUnitByKey(node.k).boxContent.raiseEvent({name:"regenerateToolbar"});});}});$A.forEach(associatedNodes,function(node){actions.push(docModel.getKeepOnlyOrExcludeAction(node.k,selectorData));});return{actions:actions,callback:callback};},getObjectInfo:function getObjectInfo(objectId){var zonesModel=this.xtab.zonesModel,oi=null;if(zonesModel){(zonesModel.getDropZones().zones||[]).some(function(zone){return !!zone.items.some(function(item){if(item.did===objectId){oi=item;return true;}});});}else{oi=this._super(objectId);}return oi;},getObjectInfoFromDataset:function getObjectInfo(objectId){var objectInfo;$HASH.forEach(this.docModel.datasets,function(dataset){if(!objectInfo){objectInfo=(dataset.mx.concat(dataset.att)).filter(function(metric){return metric.did===objectId;})[0];}});return objectInfo;},hasDerivedElements:function hasDerivedElements(objectId){var objectInfo=this.getObjectInfo(objectId);return !!(objectInfo&&objectInfo.de);},isRecursiveAttribute:function isRecursiveAttribute(objectId){var objectInfo=this.getObjectInfoFromDataset(objectId);return objectInfo&&objectInfo.t===12&&objectInfo.st===3076;},supportsViewFilterActions:function supportsViewFilterActions(objectId){var objectInfo=this.getObjectInfo(objectId);return objectInfo&&!objectInfo.de&&(objectInfo.t!==1)&&(objectInfo.t!==47||objectInfo.st===12033);},addEditNodeForDatasetAction:function addEditNodeForDatasetAction(context,key){this.augmentDropContextForSchema(context,this.docModel);var dragData=context.getCtxtDragData(),dragSrc=dragData.src;if(dragSrc===$ENUM_DRAG_SOURCES.DATASETS||dragSrc===$ENUM_DRAG_SOURCES.ALL_OBJECT_LIST){var datasetId=context.getCtxtDragData().dsid,actions=context.actions||[];if(datasetId){actions.push({act:"editNode",nodeKey:key,datasetId:datasetId});}context.actions=actions;}},getCurrentUnitAxisAndPosition:function getCurrentUnitAxisAndPosition(id){return new mstrmojo.models.template.DataInterface(this.data).getUnitById(id)||null;},getNumberFormatEditorCfg:function getNumberFormatEditorCfg(itemContext){var model=this,vis=model.xtab,data=model.data,nfArr=(data.gnf||[]).concat(data.gnfu),item=itemContext.item,idx=$A.find(nfArr,"id",item.did),formatValues=idx===-1?{}:nfArr[idx],isXtab=vis&&(!vis.defn.vis||!vis.defn.vis.ve);var NFEditor=$DU.getNumberFormatEditor(itemContext.item,formatValues,function(data){var numberFormatAction=model.docModel.getNumberFormatAction(item.did,item.t,data),hasPartialRetrieval=!!numberFormatAction.partialRetrieval,extras,urInfo;if(hasPartialRetrieval){extras=mstrmojo.DocDataService.REQUEST_DEFN_DATA;urInfo={treesToRender:3};}vis.controller.submitUndoRedoTemplateUpdates(vis,numberFormatAction,model.docModel.controller._getXtabCallback(vis,undefined,hasPartialRetrieval),extras,urInfo);});return NFEditor;},showNumberFormat:function(item){var applicableFormTypes=[1,2,8,9,11],showForAttribute;if(item.t===12){var dataInterface=new mstrmojo.models.template.DataInterface(this.xtab.node.data),titles=dataInterface.getRowTitles().titles.concat(dataInterface.getColTitles().titles),templateItem=$A.filterOne(titles,function(unit){return item.did===unit.id;}),shownForms=((templateItem&&templateItem.fs)||[]).map(function(shownform){return shownform.id;});showForAttribute=(item.fs||[]).some(function(form){return applicableFormTypes.indexOf(form.bftp)!==-1&&shownForms.indexOf(form.fid||form.id)!==-1;});}return(item.t===4&&item.did!==TEMPLATE_METRICS_ID)||showForAttribute;},openThresholdEditor:function(item,isColorBy,canSupportImage){var model=this,vis=model.xtab,docModel=model.docModel,gridData=model.data,gridStructureInfo=gridData.gsi,itemId=item.did,titleString=mstrmojo.desc(3647,"Thresholds");if(item.t===TYPE_METRIC||item.t===TYPE_ATTRIBUTE){var metricsArray=$HASH.clone(gridStructureInfo.mx),targetArr;metricsArray.forEach(function(mx){mx.t=4;});targetArr=gridStructureInfo.rows.concat(gridStructureInfo.cols,metricsArray).filter(function(item){var type=item.t,subType=item.st,did=item.did;return !((type===1&&subType===257)||(type===47&&subType===12032)||(model.hasDerivedElements(did))||(did==="-1")||(type===14));});targetArr.forEach(function(item){if(item.t===12){var oi=this.getObjectInfo(item.did);item.da=oi?oi.da:undefined;}else{if(item.t===4){var metric=this.getObjectInfoFromDataset(item.did);item.dt=metric&&metric.dt;}}},this);if(itemId!==TEMPLATE_METRICS_ID){titleString+=" - "+item.n;}var FEATURES=mstrmojo.threshold.ThresholdModel.FEATURES,thresholdController=new mstrmojo.threshold.ThresholdController({metricId:itemId,objectType:item.t,title:titleString,data:gridData,targets:targetArr,messageId:docModel.mid,datasets:docModel.datasets,dataService:docModel.getDataService(),supportsFeature:function supportsFeature(featureId){switch(featureId){case FEATURES.SHOW_ADVANCED_EDITOR:return !isColorBy;case FEATURES.SHOW_BASED_ON:return !isColorBy;case FEATURES.SHOW_IMAGE:return canSupportImage;case FEATURES.SHOW_VALUE_ITEM:var metricObject=model.getObjectInfoFromDataset(this.model.basedOnId),metricType=metricObject&&metricObject.dt,nonSupportedType=[8,9,10,14,15,16,30];return !metricType||nonSupportedType.indexOf(metricType)===-1;}},onSubmitActions:function(newThresholds,templateThresholds,metricId,basedOnId,type,isApply,objectType){var controller=this,actions=[];if(templateThresholds){addClearActions(vis,templateThresholds,metricId,actions,objectType);}actions.push(model.getCreateSimpleThresholdAction(newThresholds,vis.k,metricId,type,basedOnId,objectType));vis.controller.submitUndoRedoTemplateUpdates(vis,actions,{success:function(){if(isApply){controller.set("data",model.data);controller.openEditor();isApply=false;}}});},onSaveThresholds:function(thresholds,basedOnId,thresholdType,saveAsParam,callback){this.dataService.saveThresholds($HASH.copy(saveAsParam,{thresholds:JSON.stringify(thresholds),basedOnId:basedOnId,thresholdType:thresholdType}),callback,{hideFailureErr:true});},onLoadThresholds:function(metricId,thresholdsId){var thModel=this.model;this.dataService.getThresholds({thresholdsID:thresholdsId},{success:function(res){var ths=res.thresholds,validThs=[],targets,isValid,tgtsNotOnTemp={};$A.forEach(ths||[],function(th){targets=$EXP.findTargets(th.expr,"did");isValid=true;$HASH.forEach(targets,function(t,did){if(!model.getObjectInfo(did)){tgtsNotOnTemp[did]=t.n;isValid=false;}});if(isValid){validThs.push(th);}});if(!$HASH.isEmpty(tgtsNotOnTemp)){var tgtsArr=$HASH.valarray(tgtsNotOnTemp);mstrmojo.alert(mstrmojo.desc(null,"The following objects: '#' are not on the template, so some thresholds will not be loaded...").replace("#",tgtsArr.join(",")));}thModel.addThresholds(validThs);}});}});if(item.t===TYPE_ATTRIBUTE){thresholdController.model.editorMode=mstrmojo.threshold.ThresholdModel.EDITOR_TYPES.ADVANCED_EDITOR;}thresholdController.openEditor();}},buildThresholdMenuOptions:function buildThresholdMenuOptions(cfg,itemContext,isColorBy,canSupportImage){var model=this,vis=model.xtab,gridData=model.data,gridStructureInfo=gridData.gsi,threshold=gridStructureInfo.thresholds,item=itemContext.item,itemId=item.did,hasThresholds=threshold&&threshold[itemId],STR_CLEAR=mstrmojo.desc(13261,"Clear Thresholds");if(item.t===TYPE_METRIC||item.t===TYPE_ATTRIBUTE&&!model.docModel.isOldDEObject(itemId)){cfg.addMenuItem(mstrmojo.desc(6050,"Thresholds..."),"",function(){model.openThresholdEditor(item,isColorBy,canSupportImage);},this);if(itemId!==TEMPLATE_METRICS_ID){if(hasThresholds){cfg.addMenuItem(STR_CLEAR,"",function(){var actions=[];addClearActions(vis,hasThresholds,itemId,actions,item.t);vis.controller.submitUndoRedoTemplateUpdates(vis,actions);},this);}}}},moveSubTotals:function moveSubTotals(cell,positions){var me=this,sorts=this.xtab.gridInfo.sorts,axis=cell.data.axis,axisSort=sorts[axis-1],hasSorts=!!(axisSort.length&&axisSort[0].key!==("0!00000000000000000000000000000000!!!!"+axis));getCmdMgr(this).execute({execute:function execute(){var xtab=me.xtab,nodeKey=xtab.k;this.submit(me.docModel.getDataService().getUpdateTemplateAction(nodeKey,{act:"moveSubTotal",nodeKey:nodeKey,sorts:hasSorts?sorts:[],subTotalsPos:positions,stt:-1,axis:axis}),xtab.controller._getXtabCallback(xtab));}});},getAttributeFormsInTemplate:function(attrId){var gts=this.data.gts,attrForms=[];(gts.row||[]).concat(gts.col||[]).forEach(function(obj){if(obj.id===attrId){attrForms=attrForms.concat(obj.fs);}});return attrForms;},getPivotFormAction:function(cell,btn){var titleInfo=this.getCellTitleInfo(cell),title=titleInfo.title,formsUnderHeader=title.fs,formsUnderHeaderCount=(formsUnderHeader&&formsUnderHeader.length)||0,attrId=title.id,formsInTemplate=this.getAttributeFormsInTemplate(attrId),formIdx=formsUnderHeaderCount>1?(cell.idx%formsInTemplate.length):(title.fix-1),form=formsInTemplate[formIdx],toIdx;if(btn==="l"){toIdx=formIdx-1;}else{if(btn==="r"){toIdx=formIdx+1;}}return{act:"pivot",unitPos:toIdx+1,attFormId:form.id,unitId:attrId};},getValuesDefaultFormatGridZoneAction:function(units){var currProps={},xTabFM=mstrmojo.models.FormatModel,vaFmtAction,xtab=this.xtab,gridInfoFmts=xtab.gridInfo.fmts,newFmtUnits=[];$HASH.forEach(units,function(item){newFmtUnits.push({unitId:item.did,unitType:TYPE_METRIC,regions:["g"]});});var dInfo;$HASH.forEach(gridInfoFmts&&gridInfoFmts.va,function(item,key){dInfo=xTabFM.getFormatPropertyInfo(key);if(dInfo){currProps=$HASH.mergeHashes(currProps,xTabFM.getFormatUpdate(key,(dInfo.pt==TYPE_BOOLEAN)?item:xTabFM.decodeValue(key,item)));}});vaFmtAction=xtab.model.getZoneFormatAction.call(xtab.model,"va",currProps,xtab.k);vaFmtAction.units=[].concat(newFmtUnits);return vaFmtAction;},isRecursiveAttribute:function isRecursiveAttribute(objectId){var objectInfo=this.getObjectInfoFromDataset(objectId);return objectInfo&&objectInfo.t===12&&objectInfo.st===3076;},getRAExpandAction:function getRAExpandAction(cell,sliceId,isExpandDescendants){var titleInfo=this.getCellTitleInfo(cell).title,result={act:"raExpandCollapse",unitId:titleInfo.id,sliceId:sliceId,depth:cell.dpt,ordinal:(cell.o!==undefined)?cell.o:cell._ei,isExpand:isExpandDescendants?1:(cell.epd?0:1)};if(isExpandDescendants){result.expand_dsts=1;}return result;},getRAExpandAllAction:function getRAExpandAllAction(unitId,isExpandAll){return{act:"raExpandCollapseAll",unitId:unitId,isExpandAll:isExpandAll?1:0};},getUnitNameInDataSet:function(unitId){return this.docModel.findUnitNameInDataSetFromUnit(unitId);}});}());