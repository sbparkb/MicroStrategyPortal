(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.func","mstrmojo.DocDataService");var $COPY=mstrmojo.hash.copy,$AFE=mstrmojo.array.forEach,$FUNC=mstrmojo.func,$WRAP=$FUNC.wrapMethods;var STATE_BUSY=2,STATE_IDLE=1,CMD_ACT_UNDO=1,CMD_ACT_EXEC=2,CMD_ACT_REDO=3;var CMD_PHASE={FIRST:1,MIDDLE:2,LAST:3};var CMD_STATE={BUSY:1,INTERIM:2,DONE:3,SILENT:4,CANCELED:5};var SILENT_EXTRAS=$COPY(mstrmojo.DocDataService.SUPPRESS_DATA,{preserveUndo:true,config:{silent:true}});function clearDelayRemovedCmds(){$AFE(this._delayRemovedCmds,function(cmd){cmd.discard();});this._delayRemovedCmds=null;}function restoreDelayRemovedCmds(){this.cmds=this.cmds.concat(this._delayRemovedCmds);this._delayRemovedCmds=null;}function addCmd(cmd){var commands=this.cmds,pos=this.pos;this._delayRemovedCmds=commands.splice(pos+1);if(pos>=this.size-1){commands.shift().discard();}commands.push(cmd);this.pos=commands.length-1;}function handleError(cmdManager,message){cmdManager.reset();throw new Error(message||"Invalid state.");}mstrmojo.vi.controllers.UICmdMgr=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.vi.controllers.UICmdMgr",cmds:null,pos:-1,size:20,_delayRemovedCmds:null,controller:null,dataService:null,model:null,state:STATE_IDLE,STATE:{EXECUTING:STATE_BUSY,IDLE:STATE_IDLE},CMD_PHASE:CMD_PHASE,init:function init(props){$COPY(props,this);this.cmds=[];},execute:function execute(params){if(this.state===STATE_BUSY){handleError(this);}try{params=$COPY(params,{mgr:this,undoUIState:this.model.getUIState(),action:CMD_ACT_EXEC});var cmd=this.curCmd=new mstrmojo.vi.controllers.UICmd(params);addCmd.call(this,cmd);this.state=STATE_BUSY;cmd.execute();}catch(e){this.reset();throw e;}},getInterimCmd:function getInterimCmd(){if(this.state===STATE_BUSY){var cmd=this.cmds[this.pos];if(cmd.state===CMD_STATE.INTERIM){return cmd;}}return null;},undo:function undo(killJob){if(this.canUndo()){this.state=STATE_BUSY;try{var cmd=this.curCmd=this.cmds[this.pos--];cmd.action=CMD_ACT_UNDO;cmd.redoUIState=this.model.getUIState();cmd.undoRedo(killJob);}catch(e){this.reset();throw e;}}},redo:function redo(){if(this.canRedo()){this.state=STATE_BUSY;try{var cmd=this.curCmd=this.cmds[++this.pos];cmd.action=CMD_ACT_REDO;cmd.undoUIState=this.model.getUIState();cmd.undoRedo();}catch(e){this.reset();throw e;}}},onSuccess:function onSuccess(cmd){if(this.state===STATE_IDLE){handleError(this);}if(cmd!==this.curCmd){handleError(this,"Wrong command");}this.state=STATE_IDLE;clearDelayRemovedCmds.call(this);this.controller.onCmdMgrChanged();},onFailure:function onFailure(){clearDelayRemovedCmds.call(this);this.reset();},onCancel:function onCancel(cmd,killJob){this.state=STATE_IDLE;var submittedRequest=!!cmd.submitCount;if(submittedRequest){this.undo(killJob);}else{this.pos--;}this.cmds.pop();cmd.discard();if(submittedRequest){clearDelayRemovedCmds.call(this);}else{restoreDelayRemovedCmds.call(this);}this.controller.onCmdMgrChanged();},reset:function reset(){$AFE(this.cmds,function(cmd){cmd.discard();});this.cmds.length=0;this.pos=-1;this.state=STATE_IDLE;this.controller.onCmdMgrChanged();},resetState:function resetState(){this.state=STATE_IDLE;},canUndo:function canUndo(){return this.state===STATE_IDLE&&this.pos>=0;},canRedo:function canRedo(){return this.state===STATE_IDLE&&this.pos<this.cmds.length-1;},onSubmitUpdates:function onSubmitUpdates(){if(this.state===STATE_IDLE){this.cmds.splice(this.pos+1);this.controller.onCmdMgrChanged();}},isUndoRedo:function isUndoRedo(){var currentCommand=this.curCmd||{};if(this.state===STATE_BUSY&&(currentCommand.action===CMD_ACT_UNDO||currentCommand.action===CMD_ACT_REDO)){return true;}return false;}});function addSubmissionCallback(me,update,callback){if(update.stid==="undefined"){callback.submission=function(reqId,flag,request){var p=request.params,upd=JSON.parse(p.params);upd.actions[0].stid=me.action===CMD_ACT_UNDO?me.undoStateId:me.redoStateId;p.params=JSON.stringify(upd);};}return callback;}function submitSilentUr(me,update){var cmdMgr=me.mgr;update.disablePU=true;var callback=addSubmissionCallback(me,update,{success:function success(){me.state=CMD_STATE.DONE;},failure:function failure(){cmdMgr.onFailure();}});me.state=CMD_STATE.SILENT;cmdMgr.dataService.submitUpdates(update,callback,SILENT_EXTRAS);cmdMgr.onSuccess(me);}function submitUr(me,action){var urInfo=me.urInfo,puKeys=urInfo.puKeys,puObjs=urInfo.puObjs,puFilters=urInfo.puFilters,cmdMgr=me.mgr,model=cmdMgr.model,dataService=cmdMgr.dataService;if(puKeys||puObjs){if(puKeys){action.partialRetrieval={nodes:puKeys,filters:puFilters};}if(puObjs){model.addUpdateObjects(action,puObjs);}}else{action.disablePU=true;}var cmdMgrCallback=addSubmissionCallback(me,action,{success:function success(){me.state=CMD_STATE.DONE;cmdMgr.onSuccess(me);model.restoreUIState(me.action===CMD_ACT_UNDO?me.undoUIState:me.redoUIState);},failure:function failure(){cmdMgr.onFailure();},complete:function complete(){cmdMgr.resetState();}}),userCallback=urInfo.callback||model.getRebuildCallback(),callback=$WRAP(userCallback,cmdMgrCallback),extras=$COPY(urInfo.extras);if(action.act==="undo"&&extras!==undefined){extras.hideCancel=true;if(action.killJob){extras.message=mstrmojo.desc(14586,"Canceling...");}}me.state=CMD_STATE.BUSY;dataService.submitUpdates(action,callback,extras);}function calculateTreesToRender(cmd){var urInfo=cmd.urInfo,model=cmd.mgr.model;if(!urInfo.extras){var treesToRender=(urInfo.treesToRender!==undefined)?urInfo.treesToRender:cmd._treesFromRes;if(!urInfo.disablePU&&!cmd._hasFullUpdate&&(!urInfo.puKeys||!urInfo.puKeys.length)){treesToRender=0;urInfo.callback=$WRAP(model.getDatasetsUpdateCallback(),urInfo.callback);}urInfo.extras={style:{params:{treesToRender:treesToRender}}};}}mstrmojo.vi.controllers.UICmd=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.vi.controllers.UICmd",mgr:null,redoStateId:null,undoStateId:null,execute:mstrmojo.getMissingFn(),discard:mstrmojo.emptyFn,action:null,state:CMD_STATE.INTERIM,urInfo:null,getStateValue:function getStateValue(execValue,undoValue){return this.action===CMD_ACT_UNDO?undoValue:execValue;},init:function init(props){$COPY(props,this);this._treesFromRes=0;this.urInfo=this.urInfo||{};this.submitCount=0;},undoRedo:function undoRedo(killJob){var me=this,action,urInfo=this.urInfo,silent=urInfo.silent,preUndoRedo,cmdMgr=this.mgr,dataService=cmdMgr.dataService;if(me.action===CMD_ACT_REDO){action={act:"redo",stid:me.redoStateId};preUndoRedo=urInfo.redo;}else{if(me.action===CMD_ACT_UNDO){action={act:"undo",stid:me.undoStateId,killJob:killJob};preUndoRedo=urInfo.undo;}else{handleError(this.mgr);}}if(preUndoRedo){dataService.blockRequests=true;try{silent=!!preUndoRedo.call(me)||silent;}finally{dataService.blockRequests=false;}}if(silent){submitSilentUr(me,action);}else{submitUr(me,action);}},submitUpdate:function submitUpdate(update,phase){this.submit(update.actions,update.callback,update.extras,phase);},submit:function submit(actions,callback,extras,phase){var me=this,cmdMgr=me.mgr,model=cmdMgr.model,dataService=cmdMgr.dataService,actionsArray=mstrmojo.array.ensureArray(actions);callback=callback?$COPY(callback):model.getRebuildCallback();me.state=CMD_STATE.BUSY;function isEmpty(parent,child){return !(parent&&parent[child]&&parent[child].length);}if(me._hasFullUpdate||actionsArray.some(function(action){return action.disablePU;})||actionsArray.every(function(action){var pr=action.partialRetrieval,pu=action.partialUpdate;return isEmpty(pr,"nodes")&&isEmpty(pu,"nodes")&&isEmpty(pu,"selectors")&&isEmpty(pu,"objects");})){me._hasFullUpdate=true;}$FUNC.override({submission:function submission(){if(me.submitCount===0){me.undoStateId=dataService.stid;}me.submitCount++;},success:function success(res,request){if(me.action!==CMD_ACT_EXEC){handleError(cmdMgr);}me.redoStateId=res.stid;var lastSubmit=!phase||phase===CMD_PHASE.LAST;if(lastSubmit){me.state=CMD_STATE.DONE;}else{me.state=CMD_STATE.INTERIM;}var urInfo=me.urInfo;if(!urInfo.disablePU){var puKeys=urInfo.puKeys||[],resPuKeys=res.pukeys&&res.pukeys.split("\u001E");if(resPuKeys&&resPuKeys.length){puKeys=puKeys.concat(resPuKeys);var extraPuKeys=urInfo.extraPuKeys;if(extraPuKeys){puKeys=puKeys.concat(extraPuKeys);delete urInfo.extraPuKeys;}}if(puKeys.length){urInfo.puKeys=puKeys;}}me._treesFromRes|=(res.defn?1:0)|(res.data?2:0);if(this._super){this._super(res,request);}if(lastSubmit){me.completeSubmit();}},failure:function failure(res,xhr){var skipUICmdMgrOnFailureCodes=(extras&&extras.skipUICmdMgrOnFailure)||[],errorCode=parseInt(res.code||(res.getResponseHeader&&res.getResponseHeader("X-MSTR-TaskErrorCode"),10));if(skipUICmdMgrOnFailureCodes.indexOf(errorCode)===-1&&skipUICmdMgrOnFailureCodes.indexOf(mstrmojo.mstr.EnumWebAPIErrorCodes.E_UNUSED)===-1){cmdMgr.onFailure();}if(this._super){this._super(res,xhr);}},canceled:function canceled(res){if(this._super){this._super(res);}window.setTimeout(function(){me.cancel(true);},0);},complete:function complete(){if(!phase||phase===CMD_PHASE.LAST){cmdMgr.resetState();}if(this._super){this._super();}}},callback);dataService.submitUpdates(actions,callback,extras);},submitInterim:function submitInterim(actions,callback,extras){this.submit(actions,callback,extras,CMD_PHASE.MIDDLE);},resetCmdMgrOnComplete:function resetCmdMgrOnComplete(){this._resetMgr=true;},completeSubmit:function completeSubmit(){var me=this,cmdMgr=me.mgr,model=cmdMgr.model;if(!me.completed){me.completed=true;me.state=CMD_STATE.DONE;cmdMgr.onSuccess(me);calculateTreesToRender(me);me.redoUIState=model.getUIState();if(me._resetMgr){cmdMgr.reset();}}},cancel:function cancel(killJob){this.state=CMD_STATE.CANCELED;calculateTreesToRender(this);this.mgr.onCancel(this,killJob);},submitSilent:function submitSilent(actions){var me=this,cmdMgr=me.mgr,model=cmdMgr.model,dataService=cmdMgr.dataService;me.state=CMD_STATE.SILENT;cmdMgr.onSuccess(me);me.redoUIState=model.getUIState();var callback={submission:function submission(){me.undoStateId=dataService.stid;me.submitCount++;},success:function success(res){me.state=CMD_STATE.DONE;me.redoStateId=res.stid;},failure:function failure(){cmdMgr.onFailure();}};dataService.submitUpdates(actions,callback,SILENT_EXTRAS);}});mstrmojo.vi.controllers.UICmd.CMD_PHASE=CMD_PHASE;mstrmojo.vi.controllers.UICmd.STATES={BUSY:STATE_BUSY,IDLE:STATE_IDLE};}());