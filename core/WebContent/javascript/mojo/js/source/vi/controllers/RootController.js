(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.dom","mstrmojo.hash","mstrmojo.func","mstrmojo.array","mstrmojo.color","mstrmojo.vi.ui.RootView","mstrmojo.vi.ui.toolbars.RootToolbar","mstrmojo._DocToolbarActions","mstrmojo.ui.pathbar.PathBar","mstrmojo.vi.models.VIComponentMap","mstrmojo.vi.controllers.DocumentController","mstrmojo.vi.ui.Annotations","mstrmojo.mstr.EnumDSSXMLObjectTypes");mstrmojo.requiresClsP("mstrmojo.vi.ui.editors","OpenVIEditor","ImportVIEditor","DocPropsEditor","DashboardStylesEditor");mstrmojo.requiresClsP("mstrmojo.ui.menus","ToolbarConfig","MenuConfig");mstrmojo.requiresClsP("mstrmojo.vi.ui.tutorial","TutorialView","WelcomeEditor");var $MOJO=mstrmojo,$HASH=$MOJO.hash,$DOM=$MOJO.dom,$DECODE=$MOJO.color.decodeColor,$FUNC=$MOJO.func,$ARR=$MOJO.array;mstrmojo.vi.controllers.ToolbarButton=null;function addViewToRoot(view,propName,methodName){this[propName]=view;this.view[methodName](view);return view;}function getPanel(type){var panel=this[type];if(panel){return panel;}return this.docCtrl.getViPanel(type);}function hasTbToggleHandler(cmd){return["DisplayPanel","addPanel","togglePathbar","togglePresentationMode","toggleAutoRefresh"].indexOf(cmd)>-1;}function getTbToggleHandler(cmd,cmdId,state){var $this=this;switch(cmd){case"DisplayPanel":return function(){$this.setPanelDisplay(cmdId,state);};case"addPanel":return function(){var view=$this.docCtrl.view,lk=view.model.getCurrentLayoutKey();view.builder.getLayoutVIMap(lk).getComponent(mstrmojo.vi.models.VIComponentMap.TYPES.VIZ_CONTENT).addPanel();};case"togglePathbar":return function(){this.view.togglePathbar();};case"togglePresentationMode":return function(ctxt){this.togglePresentationMode(ctxt);};case"toggleAutoRefresh":return function(ctxt){$this.docCtrl.toggleAutoRefresh(ctxt);$this.generateToolbar();console.log(JSON.stringify(ctxt));};}return mstrmojo.emptyFn;}function getTbToggleTooltip(menuItem,menuItemCmd){var tooltipOn=menuItem.ttp,tooltipOff=menuItem.ttpOff;if(menuItemCmd==="toggleAutoRefresh"){tooltipOn=tooltipOn.replace("##",this.docCtrl.model.rf);}return{on:tooltipOn,off:tooltipOff};}function getTbToggleState(cmd,cmdId){var docModel=this.docCtrl.model;switch(cmd){case"DisplayPanel":var panel=getPanel.call(this,cmdId);return panel&&panel.getOpenStatus();case"togglePathbar":return this.view.getPathbarState();case"togglePresentationMode":return mstrApp.isAppStatePresentation()&&!mstrApp.enhancedPrensetation;case"SwitchPalette":return docModel.plt?docModel.plt.did:"";case"SwitchTheme":return docModel.thm?docModel.thm.did:"";case"toggleAutoRefresh":return !!this.docCtrl.isAutoRefreshStarted();}}function getTbEnabledState(cmd){var cmdMgr=this.docCtrl.cmdMgr;switch(cmd){case"undo":return cmdMgr.canUndo();case"redo":return cmdMgr.canRedo();case"addtoHistoryList":return mstrApp.isSingleTier||!this.resolveFeature("auto-add-history-list");default:return true;}}function getToolbarVisibleState(command,commandId){var docModel=this.docCtrl.model,isPresentation=mstrApp.isAppStatePresentation(),isAutoRefresh=this.docCtrl.isAutoRefreshEnabled();if(command==="DisplayPanel"){if(commandId==="pageByPanel"){var stackKey=docModel.getVIPanelKeyFromUnits(mstrmojo.vi.models.EnumPanelTypes.PAGEBY);return !docModel.getTargetDefn(stackKey)[stackKey].empty;}else{if(commandId==="galleryPanel"||commandId==="propertiesPanel"){return mstrApp.allowWebDashboardDesign();}}}else{if(commandId==="help"){return !mstrApp.isSingleTier;}else{if(command==="importFile"){return !this.resolveFeature("single-workingset")&&(!this.resolveFeature("disable-access-data-from-file")||!this.resolveFeature("disable-access-data-from-database")||!this.resolveFeature("disable-access-data-from-cloud-app"));}else{if(command==="convertToDoc"){return !!this.resolveFeature("documents-design-mode");}else{if(command==="dSave"){return !isPresentation||isPresentation&&mstrApp.enhancedPrensetation&&!mstrApp.isShare;}else{if(commandId==="addDS"){return !this.resolveFeature("web-disable-manage-document-dataset")&&!this.datasetsPanel.model.hasMDXRADataset();}else{if(commandId==="newDS"){return !this.resolveFeature("vi-unsupport-create-edit-rolap-report")&&!!this.resolveFeature("web-is-schema-defined");}else{if(commandId==="insertVI"||commandId==="insert"||commandId==="dashboardStyles"||commandId==="formatObject"){return mstrApp.allowWebDashboardDesign();}else{if(commandId==="refresh"){return !isPresentation||(isPresentation&&!isAutoRefresh);}else{if(commandId==="refreshPulldown"||commandId==="autoRefreshOn"){return !!isAutoRefresh;}else{if(commandId==="autoRefreshOff"){return !isAutoRefresh;}else{if(commandId==="annotationMode"){return !isPresentation;}else{if(commandId==="download"){return !this.datasetsPanel.model.hasMDXRADataset();}}}}}}}}}}}}}return true;}function getCurrentProject(callback){mstrApp.serverRequest({taskId:"IsCurrentProj",gpjn:true},{success:function(res){callback.success(res);},failure:function(res){}},{silent:true});}function modifyMenuState(menuItemId,menuItemDesc,menuItemCmd,menuCfg){switch(menuItemId){case"importCube":getCurrentProject({success:function(res){if(res!==null){var projName=res.pn;if(!projName){menuItemDesc=(mstrApp.isSingleTier)?mstrmojo.desc(14304,"Dataset from Server..."):mstrmojo.desc(13573,"Existing Dataset...");}else{menuItemDesc=mstrmojo.desc(14329,"Dataset from ##...").replace("##",projName);}}var menuItem=menuCfg.getMenuItem(menuItemId);if(menuItem){menuItem.n=menuItemDesc;}}});break;}}function setThemeCssClass(themeID){this.view.set("themeClassName",themeID==="F1FED8AC42B57AC1B0E9518FED0F89D6"?"mojo-theme-dark":"mojo-theme-light");}function submitThemePaletteUpdate(action){var docCtrl=this.docCtrl;docCtrl.submitUndoRedoUpdates([action],null,$FUNC.wrapMethods(docCtrl.model.getUpdateThemePaletteCallback(),{success:function(res){setThemeCssClass.call(this,res.thm.did);this.generateToolbar();}.bind(this)},docCtrl.getRefreshCallback()),mstrmojo.DocDataService.REQUEST_DEFN_DATA);}function tbRadioMenuValueChangeHandler(v,vWas,option){var wasChanged=v!==vWas;if(wasChanged){switch(option.cmd){case"SwitchTheme":this.setTheme(v);break;case"SwitchPalette":this.setPalette(v);break;}}return wasChanged;}function getToolbarContext(cmd){if(!cmd){return null;}var $this=this;return $this[cmd]?$this:$this.docCtrl;}function getToolbarButtonFunction(cmd){if(!cmd){return null;}var cmdContext=getToolbarContext.call(this,cmd);return function(item,widget){cmdContext[cmd](item,widget);};}function getMenuConfig(menuItems){if(!menuItems){return null;}var menuCfg=new mstrmojo.ui.menus.MenuConfig();menuItems.forEach(function(menuItem,menuItemIndex){var menuItemCmd=menuItem.cmd,menuItemId=menuItem.n,menuItemDesc=menuItem.desc,subMenuItems=menuItem.items,getCustomItemMarkupFunc=null,isMenuItemDisabled=!getTbEnabledState.call(this,menuItemId);if(getToolbarVisibleState.call(this,menuItemCmd,menuItemId)===false){return ;}if(menuItemId==="SwitchTheme"){if(mstrConfig.paletteThemes.themes){subMenuItems=menuItem.items=mstrConfig.paletteThemes.themes.map(function(thm){return{n:thm.did,desc:thm.n,cmd:menuItemId};});}}else{if(menuItemId==="SwitchPalette"){var themeId=getTbToggleState.call(this,"SwitchTheme"),paletteThemes=mstrConfig.paletteThemes,themeObj=$ARR.filterOne(mstrConfig.paletteThemes.themes,function(theme){return theme.did===themeId;});subMenuItems=menuItem.items=(themeObj?themeObj.sup:[]).map(function(pltRef){var plt=$ARR.filterOne(paletteThemes.palettes,function(palette){return palette.pltid===pltRef.did;});if(plt){return{n:plt.pltid,desc:plt.n,colors:plt.colors.map(function(c){return $DECODE(c);}),cmd:menuItemId};}return null;});getCustomItemMarkupFunc=function getCustomItemMarkupFunc(radio,radioIdx){return function getItemMarkup(){var colors=subMenuItems[radioIdx].colors,pm='<div class="paletteColors">',len=Math.min(colors.length,9),i;for(i=0;i<len;i++){pm+='<div class="colorIcon" style="background-color: '+colors[i]+'"></div>';}pm+="</div>";return'<{@tag} class="item {@cls} hasPaletteColors" idx="{@idx}" style="{@style}">'+pm+"{@n}</{@tag}>";};};}}if(hasTbToggleHandler(menuItemCmd)){var toggleState=getTbToggleState.call(this,menuItemCmd,menuItemId),toggleTooltip=getTbToggleTooltip.call(this,menuItem,menuItemCmd);menuCfg.addToggleMenuItem({on:menuItemDesc,off:menuItem.descOff||menuItemDesc,ttpOn:toggleTooltip.on,ttpOff:toggleTooltip.off},menuItemId+" tg",getTbToggleHandler.call(this,menuItemCmd,menuItemId,true),getTbToggleHandler.call(this,menuItemCmd,menuItemId,false),this.id,toggleState);}else{if(subMenuItems){if(menuItem.hasRadioGroup){if(menuItemDesc){menuCfg.addMenuItem(menuItemDesc,"lbl",function(){return false;});}var radios=[];subMenuItems.forEach(function(item){if(item){radios.push({text:item.desc,value:item.n,cmd:item.cmd,cls:item.n});}});menuCfg.addRadioMenuGroup(getTbToggleState.call(this,menuItemId),tbRadioMenuValueChangeHandler,radios,menuItemId+" tg",this,true,getCustomItemMarkupFunc);}else{menuCfg.addSubMenuItem(menuItemDesc,menuItemId,this.id,function(){return getMenuConfig.call(this,subMenuItems);});}}else{if(menuItemCmd){if(isMenuItemDisabled){menuCfg.addNonInteractiveMenuItem(menuItemDesc,"",isMenuItemDisabled);}else{menuCfg.addMenuItem(menuItemDesc,menuItemId,getToolbarButtonFunction.call(this,menuItemCmd),getToolbarContext.call(this,menuItemCmd));modifyMenuState.call(this,menuItemId,menuItemDesc,menuItemCmd,menuCfg);}}else{if(menuItemDesc){menuCfg.addMenuItem(menuItemDesc,"lbl",function(){return false;});}else{var shouldAddSeparator=menuItems.slice(menuItemIndex).some(function(item){return item.n!=="dlmt"&&getToolbarVisibleState.call(this,item.cmd,item.n);},this);if(shouldAddSeparator){menuCfg.addSeparator();}}}}}},this);return menuCfg;}var ENUM_PRESENTATION_STATE_OFF=0,ENUM_PRESENTATION_STATE_EXCLUSIVEON=2;function getButtonTooltipStr(button){if(button.n==="refreshPulldown"){var docCtrl=this.docCtrl;if(docCtrl.isAutoRefreshEnabled()){if(docCtrl.isAutoRefreshStarted()){return mstrmojo.desc(14281,"Auto refresh every ## seconds. Use dropdown option to pause.").replace("##",docCtrl.model.rf);}return mstrmojo.desc(14282,"Auto refresh is paused. Use dropdown option to resume.");}}return button.desc||"";}function toggleTutorial(){if(mstrApp.getShowVITutorial()&&!mstrApp.tutorialShown){mstrApp.rootCtrl.showTutorial({cls:"initial"});mstrApp.tutorialShown=true;}else{mstrApp.rootCtrl.hideTutorial();}}function showWelcomeEditor(samples,isInitialRun){(mstrmojo.all.mstrVIWelcome||new mstrmojo.vi.ui.tutorial.WelcomeEditor({title:mstrmojo.desc(13406,"Getting Started"),id:"mstrVIWelcome",samplesData:samples,isInitialRun:isInitialRun,hasSamples:samples&&(samples.length>0),toggleTutorial:toggleTutorial})).open();}function toggleEnhancedPresentationMode(toggleFlag){if(toggleFlag){mstrApp.enhancedPrensetation=!mstrApp.enhancedPrensetation;}mstrmojo.css.toggleClass(this.view.domNode,"enhanced",mstrApp.enhancedPrensetation);}function stdFullScreenEventHandler(){var winDoc=window.document;if(this.resolveFeature("edit-ive")&&mstrApp.isAppStatePresentation()&&!winDoc.fullscreenElement&&!winDoc.mozFullScreenElement&&!winDoc.webkitFullscreenElement&&!winDoc.msFullscreenElement){this.togglePresentationMode();}}function ieFullScreenEventHandler(evt){if(evt.keyCode===122){if(mstrApp.isAppStatePresentation()&&!this.skipFullScreenEvent){this.skipFullScreenEvent=true;this.togglePresentationMode();}delete this.skipFullScreenEvent;}}function showDataImport(config){var di;if(this.dataImportId){di=mstrmojo.all[this.dataImportId];}if(!di){di=mstrmojo.insert(mstrmojo.DI.DIContainer);}this.dataImportId=di.id;$HASH.copy(config.cfg,di.dataImportParams);di.dataImportCallback=config.callback;di.open();}function openDIForMultipleCubeRefresh(datasets,docId,rwb,closeInfo){var ds=[];$HASH.forEach(datasets,function(dataset){ds.push({cube_id:dataset.did,cname:dataset.cubename,ddam:dataset.ddam,mdt:dataset.mdt,sz:"0",st:dataset.st});});showDataImport({cfg:{isEdit:false,datasets:{cubes:{cube:ds}},StatusCode:2,refreshMultipleCubes:true,rwb:rwb},callback:function(publishedDataset){var orignDS=$HASH.keyarray(datasets)||[];publishedDataset=publishedDataset||[];if(publishedDataset.length>=orignDS.length){mstrmojo.form.send({evt:3140,src:mstrApp.name+".3140",documentID:docId});}else{mstrmojo._DocToolbarActions.close.call({model:{isnew:false,pfid:closeInfo.pfid,sysFolder:closeInfo.sysFolderId}});}}});}function getCubesInfo(cubeIds,callback){mstrApp.serverRequest({taskId:"getUserDICubeInfo",cubeIds:cubeIds.join(",")},{success:function(cubesInfo){callback(cubesInfo);}});}function sendGetUserDICubeInfoTask(cubesInfo,docId,rwb,closeInfo){var cubeIds=[];$HASH.forEach(cubesInfo,function(cubeInfo){cubeIds.push(cubeInfo.did);});getCubesInfo(cubeIds,function(res){$HASH.forEach(cubesInfo,function(cubeInfo){if(res&&res[cubeInfo.did]){res[cubeInfo.did].cubename=cubeInfo.n;res[cubeInfo.did].st=cubeInfo.st;}});openDIForMultipleCubeRefresh(res,docId,rwb,closeInfo);});}function getAllowItems(res){var currLayoutKey=res.currlaykey,layouts=$ARR.filter(res.data.layouts,function(lyt){return currLayoutKey===lyt.k;}),currentLayout=layouts[0],model=new mstrmojo.vi.models.DocModel(res),paneKey=model.getVIPanelKeyFromUnits(mstrmojo.vi.models.EnumPanelTypes.VISUALIZATION);var fnGetAllowItems=function(currentLayout,paneKey,model){var curr,panel,curObj;var fnSearchCurrPanel=function(des){if(des.k===paneKey){curr=des;return ;}$ARR.forEach(model.extractChildren(des||{})||[],function(item){fnSearchCurrPanel(item);if(curr){return ;}});};var fnSearchTemplateUnits=function(des){if(des&&des.gts){curObj=des;return ;}$ARR.forEach(model.extractChildren(des)||[],function(item){fnSearchTemplateUnits(item);if(curObj){return ;}});};var fnSearchAttr=function(des,currPanelKey){if(des.k===currPanelKey){panel=des;return ;}$ARR.forEach(model.extractChildren(des)||[],function(item){fnSearchAttr(item,currPanelKey);if(panel){return ;}});};fnSearchCurrPanel(currentLayout);var currPanelKey=curr.selKey;fnSearchAttr(curr,currPanelKey);fnSearchTemplateUnits(panel);return((curObj&&curObj.gts&&curObj.gts.row)||[]).concat((curObj&&curObj.gts&&curObj.gts.col)||[]);};var allowItems=fnGetAllowItems.call(this,currentLayout,paneKey,model);var fnBuildTree=function(defn){var tree={},k;for(k in defn.units){var unit=defn.units[k],pnk=unit.pnk;if(pnk){var tnd=tree[pnk]=tree[pnk]||[];tnd[unit.chdidx]={key:k,type:unit.t,id:unit.srcid||""};}}return tree;},fnSearchTree=function(tree,node,type,srcId){if(node!==undefined){for(var i=0;i<node.length;i++){var nodeItem=node[i];if(nodeItem&&nodeItem.type&&nodeItem.type===type&&!!nodeItem.id){srcId[nodeItem.id]=true;}}}for(var idx=0;idx<node.length;idx++){var item=node[idx];if(item!==undefined&&tree[item.key]){fnSearchTree(tree,tree[item.key],type,srcId);}}return srcId;},tree=fnBuildTree.call(this,model.getCurrentLayoutDef()),hashAttrSrcId={};fnSearchTree.call(this,tree,tree[model.currlaykey],mstrmojo.EnumRWUnitType.SELECTOR,hashAttrSrcId);if(!$HASH.isEmpty(hashAttrSrcId)){allowItems=[];}return allowItems;}mstrmojo.vi.controllers.RootController=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.vi.controllers.RootController",view:null,docCtrl:null,document:null,datasetsPanel:null,dataProvider:null,galleryPanel:null,installedEventListeners:null,hideTutorial:function hideTutorial(){var tutorial=mstrmojo.all.tutorial;if(tutorial){tutorial.destroy();}},handleFirstTimeUserHelp:function handleFirstTimeUserHelp(data){var datasets=data.datasets,hasDatasets=datasets&&(Object.keys(datasets).length>0);if(!hasDatasets&&mstrApp.getShowVIWelcome()){this.showWelcome({cls:"initial"});}else{if(data.isnew){toggleTutorial();}}},start:function start(startParams){var data=startParams.data,mstrErr=data.mstrerr;var view=this.view=new mstrmojo.vi.ui.RootView({id:"rootView",placeholder:startParams.placeholder,controller:this});this.addDisposable([view]);view.render();if(!mstrApp.allowWebDashboardDesign()){var domNode=view.domNode,clsNoWebDashDesign="nowebdashdesign";mstrmojo.css.addClass(domNode,clsNoWebDashDesign);}if(mstrErr){if(mstrErr.cubeinfo){mstrmojo.error({longDesc:mstrErr.message},null,{buttons:[mstrmojo.Button.newWebButton(mstrmojo.desc(9242,"Republish"),function(){sendGetUserDICubeInfoTask(mstrErr.cubeinfo,data.docId,data.rwb,{pfid:mstrErr.pfid,sysFolderId:mstrErr.sysfolderid});},true)]});view.showErrMsg(mstrmojo.desc(14112,"This document contains unpublished cubes."));}else{mstrmojo.err({name:mstrErr.title||"",message:mstrErr.message||""});}}if(!mstrApp.error){this.loadDataAndStartController(startParams);}},loadDataAndStartController:function loadDataAndStartController(startParams){if(!mstrApp.isSingleTier){mstrmojo._FormatDefinition.getAvailableFonts();}mstrmojo.locales.load(function(){this.startControllerOnDataReady(startParams);}.bind(this));},startControllerOnDataReady:function startControllerOnDataReady(startParams){var data=startParams.data,view=this.view,me=this;if(!data.mstrerr){var fnDataAvailable=function(res){mstr_profile.timeEnd("Document Data");res.bp=mstrApp.rwbBeanPath||res.bp;setThemeCssClass.call(this,res.thm&&res.thm.did);var docCtrl=this.docCtrl=new mstrmojo.vi.controllers.DocumentController({rootCtrl:this});var allowItems=getAllowItems.call(this,res);this.addDisposable([docCtrl]);mstrmojo.vi.models._CheckDataCards.checkAndWarnLargeItemsForAddUnits(allowItems,function(){docCtrl.start(res);me.generateToolbar();},null,false,null,true);var winDoc=window.document,hasAttachedEvent=false,standardFullScreenEventHandler=stdFullScreenEventHandler.bind(this),inetExplorerFullScreenEventHandler=ieFullScreenEventHandler.bind(this);var fullScreenChangeEvents=["fullscreenchange","mozfullscreenchange","webkitfullscreenchange","MSFullscreenChange"];fullScreenChangeEvents.forEach(function(eventName){if(winDoc["on"+eventName.toLowerCase()]!==undefined){$DOM.attachEvent(winDoc,eventName,standardFullScreenEventHandler);this.installedEventListeners.push({evt:eventName,fn:standardFullScreenEventHandler});hasAttachedEvent=true;}},this);if(!hasAttachedEvent){var keyDown="keydown";$DOM.attachEvent(winDoc,keyDown,inetExplorerFullScreenEventHandler);this.installedEventListeners.push({evt:keyDown,fn:inetExplorerFullScreenEventHandler});}this.handleFirstTimeUserHelp(res);var hasNoEditPrivilege=!this.resolveFeature("edit-ive"),isShare=mstrApp.isShare;if(hasNoEditPrivilege||isShare){this.togglePresentationMode();this.isFullScreen=hasNoEditPrivilege&&isShare;}}.bind(this);mstr_profile.log("Document data requested");mstr_profile.timeStart("Document Data");if(data.nsj){var windowDim=$DOM.windowDim(),params={innerWidth:windowDim.w,innerHeight:windowDim.h},callback={success:fnDataAvailable,failure:function(res){mstrmojo.alert((res.mstrerr&&res.mstrerr.message)||res.message||res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mstrApp.serverRequest($HASH.copy(params,{taskId:"getServerJSONResults",rwb:data.bs,messageID:data.mid,resFlags:data.ibx?16777216:0,styleName:"ServerJsonRWDStyle",compress:1}),callback,{src:"startControllerOnDataReady",showProgress:true,hideProgress:true,progressStateText:[mstrmojo.desc(8445,"Loading")],waitBoxCfg:{showCancel:true}});}else{fnDataAvailable(data);}}else{view.togglePathbar();}},init:function init(props){this._super(props);this.installedEventListeners=[];},destroy:function destroy(ignoreDOM){this.installedEventListeners.forEach(function(h){$DOM.detachEvent(window.document,h.evt,h.fn);});this._super(ignoreDOM);delete this.document;delete this.view;delete this.docCtrl;},generateToolbar:function generateToolbar(){var app=mstrApp,modelArr=[{modelData:app.tbModelData,bar:this.toolbar}];if(!mstrApp.isAppStatePresentation()||mstrApp.enhancedPrensetation){modelArr.push({modelData:app.menubarModelData,bar:this.menubar});}modelArr.forEach(function(model){var modelData=model.modelData;if(!modelData){return ;}var tbCfg=new mstrmojo.ui.menus.ToolbarConfig();modelData.items.forEach(function(button){var isInPresentationMode=mstrApp.isAppStatePresentation();if((isInPresentationMode&&(!button.pm||ENUM_PRESENTATION_STATE_OFF===button.pm))||(!isInPresentationMode&&ENUM_PRESENTATION_STATE_EXCLUSIVEON===button.pm)){return ;}var cmd=button.cmd,buttonId=button.n,buttonDesc=button.desc,menuItems=button.items,itemContext=getToolbarContext.call(this,cmd),cmdFn=getToolbarButtonFunction.call(this,cmd),menuCfg=getMenuConfig.call(this,menuItems),label=button.label;if(menuCfg){tbCfg.addDisposable(menuCfg);}if(getToolbarVisibleState.call(this,cmd,buttonId)===false){return ;}if(button.n==="addDS"&&this.docCtrl.model.hasMDXRADataset()){return ;}if(hasTbToggleHandler(cmd)){tbCfg.addToggleToolbarButton({on:buttonDesc,off:button.descOff},buttonId,getTbToggleHandler.call(this,cmd,buttonId,true),getTbToggleHandler.call(this,cmd,buttonId,false),this.id,getTbToggleState.call(this,cmd,buttonId));}else{if(!getTbEnabledState.call(this,cmd)){tbCfg.addDisabledToolbarBtn(buttonDesc,"btn "+buttonId);}else{if(cmd&&menuItems){tbCfg.addToolbarPickerBtn(buttonDesc,"pb "+buttonId,cmdFn,menuCfg,itemContext);}else{if(cmd){tbCfg.addToolbarBtn(buttonDesc,"btn "+buttonId,cmdFn,itemContext,undefined,label);}else{if(menuItems){tbCfg.addMenuToolbarBtn(getButtonTooltipStr.call(this,button),"mb "+buttonId,menuCfg);}else{tbCfg.addToolbarBtn("","dlmt",mstrmojo.emptyFn);}}}}}},this);model.bar.set("toolbarCfg",tbCfg);},this);},resolveFeature:function resolveFeature(feature){var features=mstrApp.features;return features&&features[feature];},setDatasetObjectsPanel:function setDatasetObjectsPanel(panel){return addViewToRoot.call(this,panel,"datasetsPanel","setDatasetObjectsPanel");},setDocumentView:function setDocumentView(doc){mstr_profile.log("View construction started");mstr_profile.timeStart("View construction");var result=addViewToRoot.call(this,doc,"document","setDocumentView");mstr_profile.timeEnd("View construction");return result;},setGalleryView:function setGalleryView(gallery){return addViewToRoot.call(this,gallery,"galleryPanel","setGalleryView");},closePanels:function closePanels(panelNames){var oldPanelState=this.oldPanelState=[];panelNames.forEach(function(panelName){var panel=getPanel.call(this,panelName),openState=panel&&panel.visible;if(openState){panel.setOpenStatus(false,true,undefined,true);}oldPanelState.push(openState);},this);},restorePanels:function restorePanels(panelNames){panelNames.forEach(function(panelName,idx){if(this.oldPanelState[idx]){var panel=getPanel.call(this,panelName);panel.setOpenStatus(true,true,undefined,true);}},this);delete this.oldPanelState;},togglePresentationMode:function togglePresentationMode(ctxt){if(mstrApp.isAppStatePrintPreview()){return ;}var $this=this,winDoc=document,hasNoEditPrivilege=!this.resolveFeature("edit-ive"),isOn=hasNoEditPrivilege||!mstrApp.isAppStatePresentation(),appStates=mstrmojo.vi.VisualInsightApp.APP_STATES,toggleFullScreen=function toggleFullScreen(){var domNode=winDoc.documentElement,requestFSC=domNode.requestFullscreen||domNode.mozRequestFullScreen||domNode.webkitRequestFullscreen||domNode.msRequestFullscreen,cancelFSC=winDoc.exitFullscreen||winDoc.mozCancelFullScreen||winDoc.webkitCancelFullScreen||winDoc.msExitFullscreen,isFullScreen=!$this.isFullScreen;if((hasNoEditPrivilege&&isFullScreen)||(!hasNoEditPrivilege&&isOn)){if(requestFSC){requestFSC.call(domNode);}else{$this.skipFullScreenEvent=true;try{new ActiveXObject("Wscript.shell").SendKeys("{F11}");}catch(e){}}}else{if(cancelFSC){cancelFSC.call(winDoc);}else{if(!$this.skipFullScreenEvent){$this.skipFullScreenEvent=true;try{new ActiveXObject("Wscript.shell").SendKeys("{F11}");}catch(ex){}}else{delete $this.skipFullScreenEvent;}}}if(hasNoEditPrivilege){$this.isFullScreen=isFullScreen;}};var isShare=mstrApp.isShare;if(mstrApp.enhancedPrensetation===undefined&&(!isShare||isShare&&!isOn)){mstrApp.enhancedPrensetation=hasNoEditPrivilege;}var panelNames=["datasetsPanel","galleryPanel"];if(isOn){this.closePanels(panelNames);}else{this.restorePanels(panelNames);}if(!mstrApp.isSingleTier&&hasNoEditPrivilege){toggleEnhancedPresentationMode.call(this,ctxt);}if(isOn&&$this.docCtrl){$this.docCtrl.startAutoRefresh();}else{$this.docCtrl.stopAutoRefresh();}mstrApp.set("appState",isOn?appStates.PRESENTATION:appStates.DEFAULT);this.generateToolbar();if(!mstrApp.isSingleTier){toggleFullScreen();}else{var isAppStatePresentation=mstrApp.isAppStatePresentation(),presentationNotify=mstrmojo.all[this._presentationNotifyId];if(ctxt!=="host"){window.FormWrapper.togglePresentationMode();}if(isAppStatePresentation){this._presentationNotifyId=mstrmojo.notify(mstrmojo.desc(13915,"Press Esc to exit Presentation Mode"),null,{forceClose:true}).id;}if(!isAppStatePresentation&&presentationNotify){presentationNotify.close();}}window.setTimeout(function(){this.view.doLayout();}.bind(this),200);},togglePrintPreview:function togglePrintPreview(turnOn){var isInPrintPreviewState=mstrApp.isAppStatePrintPreview();if(turnOn===isInPrintPreviewState||mstrApp.isAppStatePresentation()){return ;}var isOff=!isInPrintPreviewState,appStates=mstrmojo.vi.VisualInsightApp.APP_STATES;var panelNames=["datasetsPanel","galleryPanel"];if(isOff){this.closePanels(panelNames);}else{this.restorePanels(panelNames);}mstrApp.set("appState",isOff?appStates.PRINT_PREVIEW:appStates.DEFAULT);this.generateToolbar();this.view.toggleMenuToolbar(true);this.view.doLayout();},showHelpTopic:function showHelpTopic(topic){return mstrApp.showHelpTopic("about_visual_insight_with_html5.htm");},showTutorial:function showTutorial(ctxt){var tutorial=mstrmojo.all.tutorial||this.addDisposable(new mstrmojo.vi.ui.tutorial.TutorialView({id:"tutorial",isFirstTime:ctxt&&ctxt.cls==="initial",controller:this}));tutorial.render();},showWelcome:function showWelcome(context){var samples;mstrApp.serverRequest({folderID:mstrApp.viWelcomeData.samplesFolderID,taskId:"folderBrowse",styleName:"MojoFolderStyle",includeObjectDesc:true,objectType:"55"},{success:function success(res){samples=res.items=$ARR.filter(res.items,function(item){return(item.dvm===2048||item.dvm===8192);});},complete:function complete(){if(mstrApp.isVI){showWelcomeEditor(samples,!!(context&&context.cls==="initial"));}}},{silent:true});},newVI:function newVI(){mstrApp.onNavigateOut({href:"?evt=3187&src="+mstrApp.name+".3187"},function(){mstrmojo.form.send({evt:3187,src:mstrApp.name+".3187"},null,"post");});},openVI:function openVI(){var model=this.docCtrl.view.model,pfid=model.isnew?null:model.pfid,openVIEditor=new mstrmojo.vi.ui.editors.OpenVIEditor({startingFolder:pfid,title:mstrmojo.desc(13620,"Open Dashboard")});openVIEditor.open();},importMSTR:function importMSTR(){var model=this.docCtrl.view.model,pfid=model.isnew?null:model.pfid,importVIEditor=new mstrmojo.vi.ui.editors.ImportVIEditor({startingFolder:pfid,title:mstrmojo.desc(14725,"Import Dashboard")});importVIEditor.open();},importDashboard:function importDashboard(documentID,documentType){var docView=this.docCtrl.view,model=docView.model,doid=documentID,rebuildCallBack=model.getRebuildCallback(),updateCallback=model.getDatasetsUpdateCallback();model.execute({execute:function execute(){var update=model.getDataService().newUpdate(this);docView.importDashboard(update,-1,null);if(documentType==mstrmojo.mstr.EnumDSSXMLObjectTypes.DocumentDefinition){update.actions[0].doid=doid;}else{if(documentType==mstrmojo.mstr.EnumDSSXMLObjectTypes.ReportDefinition){update.actions[0].rid=doid;}}this.submitUpdate(update);},urInfo:{disablePU:true,treesToRender:3,callback:$FUNC.wrapMethods(rebuildCallBack,updateCallback),extras:mstrmojo.DocDataService.REQUEST_DEFN_DATA}});},reOpenVI:function reOpenVI(){mstrmojo.alert("OpenRecent... is under development...");},docProps:function docProps(){(new mstrmojo.vi.ui.editors.DocPropsEditor({docModel:this.docCtrl.model})).open();},togglePanel:function togglePanel(cmdId){this.setPanelDisplay(cmdId,!getTbToggleState.call(this,"DisplayPanel",cmdId));},setPanelDisplay:function setPanelDisplay(panelType,isVisible){var panel=getPanel.call(this,panelType),docController=this.docCtrl;if(panel){if(panel.getOpenStatus()!==isVisible){var update=docController.model.getDataService().newUpdateWithoutCmd();update.addExtras(mstrmojo.DocDataService.SUPPRESS_DATA);panel.setOpenStatus(isVisible,false,update);var actions=update.actions;if(actions&&actions.length){update.submit();}}}else{if(isVisible){docController.openViPanel(panelType);}}},executeCommand:function executeCommand(cmdId,cmdValue){this.hideTutorial();switch(cmdId){case"togglePresentationMode":cmdValue="host";}(function(){if(hasTbToggleHandler(cmdId)){return getTbToggleHandler;}return getToolbarButtonFunction;}()).call(this,cmdId).call(this,cmdValue);},setTheme:function setTheme(thmid){submitThemePaletteUpdate.call(this,{act:"setPreferredTheme",thmid:thmid});},setPalette:function setPalette(pltid){submitThemePaletteUpdate.call(this,{act:"setPreferredPalette",pltid:pltid});},dashboardStyles:function dashboardStyles(){var editorId="mstrDSE";if(!mstrmojo.all[editorId]){this.addDisposable([mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.editors.DashboardStylesEditor",id:editorId,controller:this.docCtrl})]);}mstrmojo.all[editorId].open();},formatObject:function formatObject(){this.docCtrl.model.getSelectedViUnit().onFormat();},resetCmdMgr:function resetCmdMgr(){this.docCtrl.cmdMgr.reset();},showPrefsEditor:function showPrefsEditor(preferencesData){mstrmojo.onetier.controllers.RootController.prototype.showPrefsEditor.call(this,preferencesData);},showOrHideProgressBar:function showOrHideProgressBar(title,show){mstrmojo.onetier.controllers.RootController.prototype.showOrHideProgressBar.call(this,title,show);},updateProgressBar:function updateProgressBar(data){mstrmojo.onetier.controllers.RootController.prototype.updateProgressBar.call(this,data);},confirmLogout:function confirmLogout(){mstrmojo.onetier.controllers.RootController.prototype.confirmLogout.call(this);},loginToWebserver:function loginToWebserver(params){mstrmojo.onetier.controllers.RootController.prototype.loginToWebserver.call(this,params);},loginToProxy:function loginToProxy(params){mstrmojo.onetier.controllers.RootController.prototype.loginToProxy.call(this,params);},loginToProject:function loginToProject(params){mstrmojo.onetier.controllers.RootController.prototype.loginToProject.call(this,params);},openSaveToServerBrowser:function openSaveToServerBrowser(){mstrmojo.onetier.controllers.RootController.prototype.openSaveToServerBrowser.call(this);},openFromProjectBrowser:function openFromProjectBrowser(){mstrmojo.onetier.controllers.RootController.prototype.openFromProjectBrowser.call(this);},openCubeBrowser:function openCubeBrowser(callback){mstrmojo.onetier.controllers.RootController.prototype.openCubeBrowser.call(this,callback);},loadDataProvider:function loadDataProvider(callback){if(!this.dataProvider){this.set("dataProvider",new mstrmojo.ObjectBrowserDataProvider());}callback(this.dataProvider);},saveToCloud:function saveToCloud(){mstrmojo.onetier.controllers.RootController.prototype.saveToCloud.call(this);}});}());