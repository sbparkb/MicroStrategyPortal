(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.vi.viz.DropZoneHelper");var $MOJO=mstrmojo,$ARR=$MOJO.array,$EDZ=$MOJO.vi.viz.EnumDSSDropZones,$HASH=$MOJO.hash,$MH;function getFirstUnitInZone(w,zoneId){var items=w.getDropZoneItems(zoneId);return items[0];}function getFirstUnitId(w,zoneId){var item=getFirstUnitInZone(w,zoneId);return item?item.id:"";}mstrmojo.vi.viz.MapHelper=mstrmojo.declare(mstrmojo.vi.viz.DropZoneHelper,null,{scriptClass:"mstrmojo.vi.viz.MapHelper",widget:null,data:null,vp:null,geoAttribute:null,latitude:null,longitude:null,angle:null,colorBy:null,sizeBy:null,tooltip:null,mapType:null,useAttributeForm:null,supportAreaMap:true,defaultView:null,init:function init(props){this._super(props);this.tooltip=[];this.data=this.data||{};this.vp=this.data.vp||{};},setWidget:function setWidget(w){this.widget=w;var vp=w.model.data.vp;this.geoAttribute=getFirstUnitId(w,$EDZ.GeoAttribute);this.latitude=getFirstUnitId(w,$EDZ.Latitude);this.longitude=getFirstUnitId(w,$EDZ.Longitude);this.angle=getFirstUnitId(w,$EDZ.Angle);this.colorBy=getFirstUnitId(w,$EDZ.ColorBy);this.sizeBy=getFirstUnitId(w,$EDZ.SizeBy);this.tooltip=w.getDropZoneItems($EDZ.AdditionalMetrics).map(function(item){return item.id;});this.mapType=vp.mtp;this.useAttributeForm=vp.af;this.defaultView=vp.dv;},getGeoUnit:function getGeoUnit(){return getFirstUnitInZone(this.widget,$EDZ.GeoAttribute);},getLatitudeUnit:function getLatitudeUnit(){return getFirstUnitInZone(this.widget,$EDZ.Latitude);},getLongitudeUnit:function getLongitudeUnit(){return getFirstUnitInZone(this.widget,$EDZ.Longitude);},getAngleUnit:function getAngleUnit(){return getFirstUnitInZone(this.widget,$EDZ.Angle);},getColorByUnit:function getColorByUnit(){return getFirstUnitInZone(this.widget,$EDZ.ColorBy);},getSizeByUnit:function getSizeByUnit(){return getFirstUnitInZone(this.widget,$EDZ.SizeBy);},getTooltipUnits:function getTooltipUnits(){return this.widget.getDropZoneItems($EDZ.AdditionalMetrics);},setMapType:function(mtp){this.mapType=mtp;},setUseAttributeForm:function setUseAttributeForm(af){this.useAttributeForm=af?$MH.USE_ATTRIBUTE_FORM:$MH.USE_ATTRIBUTE;},getGeoForm:function getGeoForm(item,fn){var fs=item&&item.fs,r=null;if(!fn){fn=function(){return true;};}if((item.otp===12||item.t===12)&&fs){$ARR.forEach(fs,function(f){if(fn(f)){r=f;return false;}});}return r;},getLatitudeForm:function getLatitudeForm(item){return this.getGeoForm(item,function(f){return $MH.isLatitude(f.fnm,f.fgr)&&f.obf;});},getLongitudeForm:function getLongitudeForm(item){return this.getGeoForm(item,function(f){return $MH.isLongitude(f.fnm,f.fgr)&&f.obf;});},getXml:function getXml(){return $MH.getXmlFromJson(this.vp);}});$MH=mstrmojo.vi.viz.MapHelper;$MH.USE_ATTRIBUTE="0";$MH.USE_ATTRIBUTE_FORM="1";$MH.MTP_MARKER="1";$MH.MTP_BUBBLE="2";$MH.MTP_AREA="3";$MH.MTP_DENSITY="4";$MH.MTP_PATH="5";$MH.canShowColorByZone=function(mtp){return mtp===$MH.MTP_MARKER||mtp===$MH.MTP_BUBBLE||mtp===$MH.MTP_AREA||mtp===$MH.MTP_PATH;};$MH.canShowSizeByZone=function(mtp){return mtp===$MH.MTP_BUBBLE;};$MH.supportImageThreshold=function(mtp){return mtp!==$MH.MTP_BUBBLE&&mtp!==$MH.MTP_AREA;};$MH.isLatitude=function isLatitude(n,gr){return gr===5||(n&&n.toLowerCase().indexOf("latitude")>-1);};$MH.isLongitude=function isLongitude(n,gr){return gr===6||(n&&n.toLowerCase().indexOf("longitude")>-1);};$MH.getXmlFromJson=function getXmlFromJson(vp){var xml=new mstrmojo.XMLBuilder();xml.addChild("widgetProps");xml.addChild("fmt");$HASH.forEach(vp,function(v,n){xml.addChild(n);xml.addAttribute("value",v);xml.closeElement();});xml.closeElement();xml.closeElement();return xml.toString();};$MH.getMapTypeByElementCount=function getMapTypeByElementCount(count){return count>500?$MH.MTP_DENSITY:$MH.MTP_MARKER;};$MH.isGeoRoleSupportArea=function isGeoRoleSupportArea(gr){var CITY=1,COUNTRY=3,STATE=2,ZIPCODE=8,COUNTY=9,OTHER=7;return gr===COUNTRY||gr===STATE||gr===ZIPCODE||gr===COUNTY||gr===CITY||gr===OTHER;};}());