(function(){mstrmojo.requiresClsP("mstrmojo.vi.viz","BaseVisualizationTransition","KnownVisualizations");mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.chart.model.enums.EnumDSSGraphMarkerShape");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,KNOWN_VIZ=mstrmojo.vi.viz.KnownVisualizations,ENUM_OBJECT_TYPE=mstrmojo.chart.model.enums.EnumDSSObjectType,SHAPE_PIE=201,METRIC_TYPE=ENUM_OBJECT_TYPE.DssTypeMetric;function getDropZoneMap(vizId,subType,isMetric){switch(vizId){case KNOWN_VIZ.GRID:return[];case KNOWN_VIZ.HEATMAP:if(isMetric){return["ColorBy","SizeBy","AdditionalMetrics"];}else{return["Grp"];}case KNOWN_VIZ.GRAPHMATRIX:switch(subType){case SHAPE_PIE:if(isMetric){return["AngleBy","XAxis","YAxis","ColorBy","SizeBy","AdditionalMetrics"];}else{return["SliceBy","Rows","YAxis","BreakBy","Columns","XAxis"];}default:if(isMetric){return["XAxis","YAxis","ColorBy","SizeBy","AdditionalMetrics"];}else{return["Rows","YAxis","BreakBy","Columns","XAxis"];}}case KNOWN_VIZ.ESRIMAP:case KNOWN_VIZ.GOOGLEMAP:if(isMetric){return["ColorBy","SizeBy","AdditionalMetrics"];}else{return["Geo","AdditionalMetrics","Lat","Long"];}case KNOWN_VIZ.NETWORK:if(isMetric){return["ColorBy","SizeBy","itemsz"];}else{return["from","to"];}default:return["XAxis","YAxis","BreakBy","SliceBy","ColorBy","SizeBy","AdditionalMetrics","AngleBy","Grp","Geo","layout","from","to","itemsz","Lat","Long"];}}function getRawObjectArray(arr,src,isMetric){var rets=[],source=src.concat();$ARR.forEach(arr,function(outer){$ARR.forEach(source,function(inner,index){if(outer.id===inner.did||outer.did===inner.did){inner.fromZone=outer.fromZone;if(isMetric){inner.t=METRIC_TYPE;}rets.push(inner);source.splice(index,1);return false;}});});return rets;}function getCustomTransitionAction(vis,zoneModel){var node=vis.node,data=node.data,dz=data.dz,gsi=data.gsi,sourceUnits=(gsi.rows||[]).concat(gsi.cols||[]),sourceMetrics=data.gsi.mx||[],templateUnits=[],templateMetrics=[];var visId=KNOWN_VIZ.getDefinition(data.visName||"Grid").id,visSubType=(visId===KNOWN_VIZ.GRAPHMATRIX&&vis.GMController.isPie)?SHAPE_PIE:null;var fnGetCustomDropZones=vis.zonesModel.getCustomDropZones,hasCustomDropZone=fnGetCustomDropZones&&fnGetCustomDropZones instanceof Function,customDropZone=hasCustomDropZone?vis.zonesModel.getCustomDropZones():null;var getTemplateObjects=function getTemplateObjects(isMetric){$ARR.forEach(getDropZoneMap(visId,visSubType,isMetric),function(zone,index){var zoneData=dz[zone]||{};$ARR.forEach((isMetric?zoneData.TemplateMetric:zoneData.TemplateUnit),function(unit){unit.fromZone=hasCustomDropZone?customDropZone[index].name:zone;if(isMetric){templateMetrics.push(unit);}else{templateUnits.push(unit);}});});};getTemplateObjects(false);if(templateUnits.length>0){templateUnits=getRawObjectArray(templateUnits,sourceUnits,false);}else{templateUnits=$ARR.filter(gsi.rows,function(unit){unit.fromZone="Rows";return unit.did!=="-1";}).concat($ARR.filter(gsi.cols,function(unit){unit.fromZone="Columns";return unit.did!=="-1";}));}getTemplateObjects(true);if(templateMetrics.length>0){templateMetrics=getRawObjectArray(templateMetrics,sourceMetrics,true);}else{templateMetrics=sourceMetrics.concat();$ARR.forEach(templateMetrics,function(metric){metric.t=METRIC_TYPE;metric.fromZone="Metrics";});}var transitions=zoneModel.transitionDropZones(templateUnits,templateMetrics);return transitions.map(function(info){var obj=info.obj;return{act:"addDropZoneUnit",zoneId:info.toZoneId,unitId:obj.did,unitType:obj.t};});}mstrmojo.vi.viz.CustomVisualizationTransition=mstrmojo.declare(mstrmojo.vi.viz.BaseVisualizationTransition,null,{scriptClass:"mstrmojo.vi.viz.CustomVisualizationTransition",transitionDropZones:function transitionDropZones(actions,vt){var newVizInfo=this.newVizInfo,style=newVizInfo.s,dropZone=newVizInfo.dz,vis=this.vis,node=vis.node,key=node.k,data=node.data;if(style===data.visName){return{wp:"",handled:true};}else{if(!dropZone){return this._super(actions,vt);}}mstrmojo.requiresCls("mstrmojo."+dropZone);var constructor=$HASH.walk(dropZone,mstrmojo),zonesModel=new constructor({getDZFlatStruct:function getDZFlatStruct(){return{};}}),customDropZones=zonesModel.getCustomDropZones&&zonesModel.getCustomDropZones();if(!customDropZones||customDropZones.length===0){var lastAction=actions[actions.length-1],actArr=lastAction&&lastAction.actions,createDefaultDropZonesAction=actArr&&actArr[0];if(createDefaultDropZonesAction&&createDefaultDropZonesAction.act==="createDefaultDropZones"){createDefaultDropZonesAction.widgetType=0;}return this._super(actions,vt);}var fnCustomDropZonesTransition=zonesModel.customDropZonesTransition;if(fnCustomDropZonesTransition&&fnCustomDropZonesTransition instanceof Function){var customTransitionAction=getCustomTransitionAction(this.vis,zonesModel);if(customTransitionAction){actions.push({act:"updateTemplate",keyContext:key,partialRetrieval:{nodes:[key]},actions:customTransitionAction});}}return{wp:"<props><widgetProps /></props>",handled:false};}});}());