(function(){mstrmojo.requiresClsP("mstrmojo.chart.model.enums","EnumDSSObjectType","EnumDSSAxisName");mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.VisUtility");mstrmojo.requiresClsP("mstrmojo.vi.viz","KnownVisualizations","EnumVisualizationTemplates","VisualizationTransition","HeatMapVisualizationHelper","NetworkVisualizationHelper","ImageLayoutHelper","ESRIMapHelper","GoogleMapHelper");var $MOJO=mstrmojo,$HASH=$MOJO.hash,$ARR=$MOJO.array,$VIZ=$MOJO.vi.viz,$KNOWN_VIZ=$VIZ.KnownVisualizations,$VIZTEMPLATES=$VIZ.EnumVisualizationTemplates,$CHART_ENUMS=$MOJO.chart.model.enums,$DSSOBJ_TYPES=$CHART_ENUMS.EnumDSSObjectType,$AXIS_NAMES=$CHART_ENUMS.EnumDSSAxisName,$GRID="Grid",$UTIL=$MOJO.VisUtility,THRESHOLD_BANDS=[0.1,0.3,0.5,0.7,0.9],BAND_COLORS=["#CC2525","#E34B4B","#E97D7D","#79D479","#57BA57","#2CA02C"];function getTemplateInfo(node){var gsi=$HASH.copy(node.data.gsi),whichMetricsAxis=gsi.tma===1?"rows":"cols",metricsAxis=gsi[whichMetricsAxis],mx=gsi.mx;gsi[whichMetricsAxis]=metricsAxis.filter(function(unit){return unit.t!==-1&&unit.did!=="-1";});if(mx){mx.forEach(function(m){m.t=4;});}return gsi;}function isMetricsUnit(u){return u.did==="-1"||u.t===4;}function combineDropZoneActions(node,heatmapHelper,actions,templateActions,thresholdActions){var dzActions=heatmapHelper.getAddDropZonesAction();if(heatmapHelper.colorBy.length>0){var cbUnit=heatmapHelper.colorBy[0];if(isMetricsUnit(cbUnit)){this.addThresholds(node,cbUnit,thresholdActions,BAND_COLORS,THRESHOLD_BANDS);}}dzActions.actions=templateActions.concat(dzActions.actions).concat(thresholdActions);if(dzActions.actions.length){actions.push(dzActions);}return heatmapHelper.getXml();}function pivotMetricNamesToColumnsIfNecessary(heatmapHelper,templateActions,gsi){var i,len,rows=gsi.rows,columns=gsi.cols;for(i=0,len=rows.length;i<len;i++){var row=rows[i];if(isMetricsUnit(row)){templateActions.push({act:"pivot",axis:$AXIS_NAMES.DssAxisColumns,unitPos:columns.length});}else{if(row.t!==$DSSOBJ_TYPES.DssTypeMetric&&!isMetricsUnit(row)){heatmapHelper.groupingObjects.push(row);}}}}function addNonMetricUnitsToGrouping(heatmapHelper,gsi){var i,len,columns=gsi.cols;for(i=0,len=columns.length;i<len;i++){var col=columns[i];if(col.t!==$DSSOBJ_TYPES.DssTypeMetric&&!isMetricsUnit(col)){heatmapHelper.groupingObjects.push(col);}}}function transitionGridToHeatMap(actions,node,thresholdActions){var templateActions=[],heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),i,gsi=getTemplateInfo(node);pivotMetricNamesToColumnsIfNecessary(heatmapHelper,templateActions,gsi);addNonMetricUnitsToGrouping(heatmapHelper,gsi);var metrics=gsi.mx,mlen=metrics.length;if(mlen>0){heatmapHelper.sizeByMetric=metrics[0];if(mlen>1){heatmapHelper.colorBy.push(metrics[1]);}else{heatmapHelper.colorBy.push(metrics[0]);}for(i=2;i<mlen;i++){if((metrics[i].did!==heatmapHelper.sizeByMetric.did)&&(metrics[i].did!==heatmapHelper.colorBy[0].did)){heatmapHelper.tooltipMetrics.push(metrics[i]);}}}return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}function addRemainingMetrics(gsi,heatmapHelper){var i,len,metrics=gsi.mx;if(metrics.length>0){for(i=0,len=metrics.length;i<len;i++){var m=metrics[i];if(heatmapHelper.colorBy.length===0){heatmapHelper.colorBy.push(m);}else{if(!heatmapHelper.sizeByMetric){heatmapHelper.sizeByMetric=m;}else{if((m.did!==heatmapHelper.sizeByMetric.did)&&(m.did!==heatmapHelper.colorBy[0].did)&&m.t===$DSSOBJ_TYPES.DssTypeMetric){heatmapHelper.tooltipMetrics.push(m);}}}}}}function transitionNetworkToHeatMap(actions,node,thresholdActions){var templateActions=[],heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),networkHelper=new $VIZ.NetworkVisualizationHelper({node:node}),gsi=getTemplateInfo(node);networkHelper.setData(node.data.dz);var groupingObjects=heatmapHelper.groupingObjects;if(networkHelper.fromItemAttribute){groupingObjects.push(networkHelper.fromItemAttribute);}if(networkHelper.toItemAttribute){groupingObjects.push(networkHelper.toItemAttribute);}var networkEdgeColor=networkHelper.edgeColorMetric;if(networkEdgeColor){heatmapHelper.colorBy.push(networkEdgeColor);}if(networkHelper.nodeSizeMetric){heatmapHelper.sizeByMetric=networkHelper.nodeSizeMetric;}else{if(networkHelper.edgeSizeMetric){heatmapHelper.sizeByMetric=networkHelper.edgeSizeMetric;}}addRemainingMetrics.call(this,gsi,heatmapHelper);return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}function transitionGraphMatrixToHeatMap(actions,node,thresholdActions){var templateActions=[],heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),graphMatrixHelper=new $VIZ.GraphMatrixHelper({node:node}),gsi=getTemplateInfo(node);gsi.mx=this.filterGMTrainingMetric(node.data.dz,gsi.mx);graphMatrixHelper.setData(node.data.dz);pivotMetricNamesToColumnsIfNecessary(heatmapHelper,templateActions,gsi);addNonMetricUnitsToGrouping(heatmapHelper,gsi);$ARR.forEach(graphMatrixHelper.sizeByObjects,function(obj){if(heatmapHelper.isMetric(obj)){heatmapHelper.sizeByMetric=obj;return false;}});$ARR.forEach(graphMatrixHelper.colorByObjects,function(obj){heatmapHelper.colorBy.push(obj);if(heatmapHelper.isMetric(obj)){return false;}});addRemainingMetrics.call(this,gsi,heatmapHelper);return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}function transitionImageLayoutToHeatMap(actions,node,thresholdActions){var templateActions=[],heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),imageLayoutHelper=new $VIZ.ImageLayoutHelper({node:node}),gsi=getTemplateInfo(node);imageLayoutHelper.setData(node.data.dz);var metrics=gsi.mx;if(imageLayoutHelper.geoAttribute){heatmapHelper.groupingObjects.push(imageLayoutHelper.geoAttribute);}if(imageLayoutHelper.colorByMetric){heatmapHelper.colorBy.push(imageLayoutHelper.colorByMetric);}if(imageLayoutHelper.sizeByMetric){heatmapHelper.sizeByMetric=imageLayoutHelper.sizeByMetric;}addRemainingMetrics.call(this,gsi,heatmapHelper);return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}function transitionMapToHeatMap(actions,node,oldVisId,thresholdActions){var oldHelper,anObj,helperCls=(oldVisId===$VIZTEMPLATES.ESRIMAP)?$VIZ.ESRIMapHelper:$VIZ.GoogleMapHelper,heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),templateActions=[];oldHelper=new helperCls({data:node.data});oldHelper.setWidget(this.vis);anObj=oldHelper.getGeoUnit();if(anObj){heatmapHelper.groupingObjects.push(anObj);}var colorBy=oldHelper.getColorByUnit(),sizeBy=oldHelper.getSizeByUnit(),tooltips=oldHelper.getTooltipUnits();anObj=colorBy||sizeBy||tooltips.pop();if(anObj){heatmapHelper.colorBy.push(anObj);}colorBy=(colorBy&&colorBy.t===$DSSOBJ_TYPES.DssTypeMetric)?colorBy:undefined;anObj=sizeBy||colorBy||tooltips.pop();if(anObj){heatmapHelper.sizeByMetric=anObj;}addRemainingMetrics.call(this,{mx:tooltips},heatmapHelper);return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}mstrmojo.vi.viz.HeatMapVisualizationTransition=mstrmojo.declare(mstrmojo.vi.viz.VisualizationTransition,null,{scriptClass:"mstrmojo.vi.viz.HeatMapVisualizationTransition",transitionDropZones:function transitionDropZones(actions,vt){var newWidgetProp="";var vis=this.vis,data=vis.node.data,curVisName=data.visName?data.visName:$GRID,curVisId=$KNOWN_VIZ.getDefinition(curVisName).id,ii,th,thresholdActions=[],colorThresholds=$UTIL.getPropertyByPath(vis,"node.data.gsi.thresholds");this.clearImageThreshold(colorThresholds,thresholdActions);switch(curVisId){case $KNOWN_VIZ.GRAPHMATRIX:newWidgetProp=transitionGraphMatrixToHeatMap.call(this,actions,vis.node,thresholdActions);break;case $KNOWN_VIZ.GOOGLEMAP:newWidgetProp=transitionMapToHeatMap.call(this,actions,vis.node,curVisId,thresholdActions);break;case $KNOWN_VIZ.ESRIMAP:newWidgetProp=transitionMapToHeatMap.call(this,actions,vis.node,curVisId,thresholdActions);break;case $KNOWN_VIZ.IMAGELAYOUT:newWidgetProp=transitionImageLayoutToHeatMap.call(this,actions,vis.node,thresholdActions);break;case $KNOWN_VIZ.NETWORK:newWidgetProp=transitionNetworkToHeatMap.call(this,actions,vis.node,thresholdActions);break;case $KNOWN_VIZ.HEATMAP:break;default:newWidgetProp=transitionGridToHeatMap.call(this,actions,vis.node,thresholdActions);break;}return{wp:newWidgetProp,handled:false};}});}());