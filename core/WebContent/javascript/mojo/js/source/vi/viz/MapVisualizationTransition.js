(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.vi.util.TemplateUtils");mstrmojo.requiresClsP("mstrmojo.vi.viz","EnumDSSDropZones","VisualizationTransition","GraphMatrixHelper","HeatMapVisualizationHelper","ImageLayoutHelper","NetworkVisualizationHelper");var $MOJO=mstrmojo,$ARR=$MOJO.array,$TEMPLATE_UTILS=$MOJO.vi.util.TemplateUtils,$VIZ=$MOJO.vi.viz,$EDZ=$VIZ.EnumDSSDropZones,$MH=$VIZ.MapHelper,$KNOWN_VIZ=$VIZ.KnownVisualizations,TEMPLATE_METRICS_ID="-1";function add2DropZone(did,t,zoneId,data,mapHelper,actions){if(did){actions.push(getUpdateTemplateAction([{act:"addDropZoneUnit",zoneId:zoneId,unitId:did,unitType:t}],data));}switch(zoneId){case $EDZ.GeoAttribute:mapHelper.geoAttribute=did;break;case $EDZ.Latitude:mapHelper.latitude=did;break;case $EDZ.Longitude:mapHelper.longitude=did;break;case $EDZ.ColorBy:mapHelper.colorBy=did;break;case $EDZ.SizeBy:mapHelper.sizeBy=did;break;case $EDZ.AdditionalMetrics:mapHelper.tooltip.push(did);break;}}function removeFromDropZone(did,t,zoneId,data,mapHelper,actions,isDisableOnly){if(did){actions.push(getUpdateTemplateAction([{act:"removeDropZoneUnit",zoneId:zoneId,unitId:did,unitType:t,is_disableonly:isDisableOnly}],data));}switch(zoneId){case $EDZ.GeoAttribute:mapHelper.geoAttribute="";break;case $EDZ.Latitude:mapHelper.latitude="";break;case $EDZ.Longitude:mapHelper.longitude="";break;case $EDZ.ColorBy:mapHelper.colorBy="";break;case $EDZ.SizeBy:mapHelper.sizeBy="";break;case $EDZ.AdditionalMetrics:mapHelper.tooltip=$ARR.filter(mapHelper.tooltip,function(tid){return tid!==did;},{max:mapHelper.tooltip.length});break;}}function getUpdateTemplateAction(templateActions,data){return{act:"updateTemplate",actions:templateActions,keyContext:data.k};}function isAdded(mapHelper,id){return mapHelper.geoAttribute===id||mapHelper.latitude===id||mapHelper.longitude===id||mapHelper.colorBy===id||mapHelper.sizeBy===id;}function getGeoAttributeFromOld(id,data){var ga=null;if(id===4){var imageLayoutHelper=new $VIZ.ImageLayoutHelper();imageLayoutHelper.setData(data.dz);ga=imageLayoutHelper.geoAttribute&&imageLayoutHelper.geoAttribute.did;}return ga;}function inheritColorBySizeByFromOld(id,data,mapHelper,actions){var add2SizeBy=function(did){if((mapHelper.mapType===$MH.MTP_MARKER)&&did){mapHelper.setMapType($MH.MTP_BUBBLE);}if(did&&mapHelper.showSizeByZone()){add2DropZone(did,4,$EDZ.SizeBy,data,mapHelper,actions);}},add2ColorBy=function(did){if(did&&mapHelper.showColorByZone()){add2DropZone(did,4,$EDZ.ColorBy,data,mapHelper,actions);}};switch(id){case 3:var graphHelper=new $VIZ.GraphMatrixHelper({data:data});graphHelper.setData(data.dz);if(mapHelper.showColorByZone()){$ARR.forEach(graphHelper.colorByObjects,function(o){if(graphHelper.isMetric(o)){add2ColorBy(o.did);return false;}});}$ARR.forEach(graphHelper.sizeByObjects,function(o){if(graphHelper.isMetric(o)){add2SizeBy(o.did);return false;}});break;case 16:var heatmapHelper=new $VIZ.HeatMapVisualizationHelper({data:data});heatmapHelper.setData(data.dz);var cbUnit=heatmapHelper.getFirstColorByUnit(true);add2ColorBy(cbUnit&&cbUnit.did);add2SizeBy(heatmapHelper.sizeByMetric&&heatmapHelper.sizeByMetric.did);break;case 18:var netVisHelper=new $VIZ.NetworkVisualizationHelper();netVisHelper.setData(data.dz);add2ColorBy(netVisHelper.edgeColorMetric&&netVisHelper.edgeColorMetric.did);add2SizeBy(netVisHelper.nodeSizeMetric&&netVisHelper.nodeSizeMetric.did);break;case 4:var imageLayoutHelper=new $VIZ.ImageLayoutHelper();imageLayoutHelper.setData(data.dz);add2ColorBy(imageLayoutHelper.colorByMetric&&imageLayoutHelper.colorByMetric.did);add2SizeBy(imageLayoutHelper.sizeByMetric&&imageLayoutHelper.sizeByMetric.did);break;default:break;}}function updateColorBySizeByFromMetrics(mx,data,mapHelper,actions){if(mx.length){if(mapHelper.showColorByZone()&&!mapHelper.colorBy){$ARR.forEach(mx,function(m){if(m.did!==mapHelper.sizeBy){add2DropZone(m.did,4,$EDZ.ColorBy,data,mapHelper,actions);return false;}});}if(mapHelper.showSizeByZone()&&!mapHelper.sizeBy){$ARR.forEach(mx,function(m){if(m.did!==mapHelper.colorBy){add2DropZone(m.did,4,$EDZ.SizeBy,data,mapHelper,actions);return false;}});}}}function addGeoAttributes(data,actions,mapHelper,geoId,datasets){var gts=data.gts,gsi=data.gsi,row=gts.row,col=gts.col,all=(row||[]).concat(col||[]),geo=null,lat=null,lng=null,card=0,itemFound=false,findAreaGeoInDataSet=function(){var areaGeo,areaForm,latForm,lngForm,areaGeoInDataset;$ARR.forEach(all,function(item){$ARR.forEach(item.fs,function(f){if($MH.isGeoRoleSupportArea(f.fgr)){areaForm=f;areaGeo=item;}else{if($MH.isLatitude(f.n,f.fgr)){latForm=f;}else{if($MH.isLongitude(f.n,f.fgr)){lngForm=f;}}}});if(!!areaGeo){return false;}});if(!!areaForm&&!latForm&&!lngForm){Object.keys(datasets).every(function(datasetId){(datasets[datasetId].att||[]).every(function(attribute){if(attribute.did===areaGeo.id){itemFound=true;areaGeoInDataset=attribute;}return !itemFound;});return !itemFound;});}return areaGeoInDataset;},findAndAdd=function(cb){$ARR.forEach(all,function(o){var _rtn;$ARR.forEach(o.fs,function(f){return _rtn=cb(o,f);});return _rtn;});},isLatForm=function(f){return $MH.isLatitude(f.n,f.fgr);},isLngForm=function(f){return $MH.isLongitude(f.n,f.fgr);},addForm=function(unitId,formId,data){actions.push(getUpdateTemplateAction([{act:"addForm",unitId:unitId,attFormId:formId,unitPos:1}],data));};if(mapHelper.supportAreaMap){if(geoId){findAndAdd(function(o,f){if(o.id===geoId&&$MH.isGeoRoleSupportArea(f.fgr)){geo=o;return false;}});}if(!geo){findAndAdd(function(o,f){if($MH.isGeoRoleSupportArea(f.fgr)){geo=o;return false;}});}if(geo){add2DropZone(geo.id,12,$EDZ.GeoAttribute,data,mapHelper,actions);mapHelper.setMapType($MH.MTP_AREA);return ;}}if(!geo){$ARR.forEach((gsi.rows||[]).concat(gsi.cols||[]),function(item){var did=item.did;findAndAdd(function(o,f){if(o.id===did&&isLatForm(f)){lat=f.id;card=o.card;}if(o.id===did&&isLngForm(f)&&f.id!==lat){lng=f.id;card=o.card;}});if(lat&&lng){geo={id:item.did};return false;}lat=null;lng=null;});if(geo){add2DropZone(geo.id,12,$EDZ.GeoAttribute,data,mapHelper,actions);add2DropZone(lat,21,$EDZ.Latitude,data,mapHelper,actions);add2DropZone(lng,21,$EDZ.Longitude,data,mapHelper,actions);mapHelper.setMapType($MH.getMapTypeByElementCount(card));mapHelper.setUseAttributeForm(true);return ;}}if(!geo){findAndAdd(function(o,f){if(isLatForm(f)||$MH.isLatitude(o.n)){lat=o.id;card=o.card;}if((isLngForm(f)||$MH.isLongitude(o.n))&&(lat!==o.id)){lng=o.id;card=o.card;}});if(lat&&lng){add2DropZone(lat,12,$EDZ.Latitude,data,mapHelper,actions);add2DropZone(lng,12,$EDZ.Longitude,data,mapHelper,actions);mapHelper.setMapType($MH.getMapTypeByElementCount(card));mapHelper.setUseAttributeForm(false);return ;}}if(!geo&&!lat&&!lng){var areaItem=findAreaGeoInDataSet();if(!!areaItem){$ARR.forEach(areaItem.fs,function(f){if($MH.isLatitude(f.fnm,f.fgr)){lat=f.fid;}else{if($MH.isLongitude(f.fnm,f.fgr)){lng=f.fid;}}if(lat&&lng){return false;}});if(lat&&lng){geo={id:areaItem.did};add2DropZone(geo.id,12,$EDZ.GeoAttribute,data,mapHelper,actions);add2DropZone(lat,21,$EDZ.Latitude,data,mapHelper,actions);add2DropZone(lng,21,$EDZ.Longitude,data,mapHelper,actions);addForm(geo.id,lat,data);addForm(geo.id,lng,data);mapHelper.setMapType($MH.getMapTypeByElementCount(areaItem.card));mapHelper.setUseAttributeForm(true);return ;}}}mapHelper.setMapType($MH.MTP_MARKER);}function transitionRemainings(data,mx,actions,mapHelper){var gsi=data.gsi,rows=gsi.rows||[],cols=gsi.cols||[];$ARR.forEach(rows.concat(cols).concat(mx),function(item){if(item.did!==TEMPLATE_METRICS_ID){if(!isAdded(mapHelper,item.did)){add2DropZone(item.did,item.t||4,$EDZ.AdditionalMetrics,data,mapHelper,actions);}}});}mstrmojo.vi.viz.MapVisualizationTransition=mstrmojo.declare(mstrmojo.vi.viz.VisualizationTransition,null,{scriptClass:"mstrmojo.vi.viz.MapVisualizationTransition",transitionDropZones:function transitionDropZones(actions,vt){var data=this.vis.model.data,curVisName=data.visName||"Grid",mapHelper=this.newMapHelper(),visId=$KNOWN_VIZ.getDefinition(curVisName).id,gsi=data.gsi,mx=gsi.mx,datasets=this.vis.model.docModel.datasets;addGeoAttributes(data,actions,mapHelper,getGeoAttributeFromOld(visId,data),datasets);inheritColorBySizeByFromOld(visId,data,mapHelper,actions);if(data.visName==="GraphMatrixVisualizationStyle"){mx=this.filterGMTrainingMetric(data.dz,mx);}mx=mx||[];updateColorBySizeByFromMetrics(mx,data,mapHelper,actions);transitionRemainings(data,mx,actions,mapHelper);this.setDefaultView(mapHelper);if(mapHelper.colorBy){actions.push(getUpdateTemplateAction(this.addThresholds({data:data},{did:mapHelper.colorBy,t:4},[]),data));}return mapHelper.getXml();},setDefaultView:function setDefaultView(helper){},transitionBetweenESRIAndGoogle:function transitionBetweenESRIAndGoogle(data,actions,fromHelper,toHelper){var getUnitType=function(did){var unit=$TEMPLATE_UTILS.findUnitsById(data.gsi,did)[0];return(unit&&unit.t)||21;};fromHelper.setWidget(this.vis);add2DropZone(fromHelper.geoAttribute,12,$EDZ.GeoAttribute,data,toHelper,actions);add2DropZone(fromHelper.latitude,getUnitType(fromHelper.latitude),$EDZ.Latitude,data,toHelper,actions);add2DropZone(fromHelper.longitude,getUnitType(fromHelper.longitude),$EDZ.Longitude,data,toHelper,actions);add2DropZone(fromHelper.colorBy,4,$EDZ.ColorBy,data,toHelper,actions);add2DropZone(fromHelper.sizeBy,4,$EDZ.SizeBy,data,toHelper,actions);fromHelper.tooltip.forEach(function(did){add2DropZone(did,getUnitType(did),$EDZ.AdditionalMetrics,data,toHelper,actions);});toHelper.useAttributeForm=fromHelper.useAttributeForm;toHelper.setMapType(fromHelper.mapType);var geoId=toHelper.geoAttribute;if(!toHelper.supportAreaMap&&toHelper.mapType===$MH.MTP_AREA){var gts=data.gts,lat=null,lng=null,card=0;if(geoId){$ARR.forEach((gts.row||[]).concat(gts.col||[]),function(o){$ARR.forEach(o.fs,function(f){if(o.id===geoId&&$MH.isLatitude(f.n,f.fgr)){lat=f.id;card=o.card;}if(o.id===geoId&&$MH.isLongitude(f.n,f.fgr)){lng=f.id;card=o.card;}});});toHelper.setMapType($MH.getMapTypeByElementCount(card));if(lat||lng){toHelper.setUseAttributeForm(true);if(lat&&lng){add2DropZone(lat,21,$EDZ.Latitude,data,toHelper,actions);add2DropZone(lng,21,$EDZ.Longitude,data,toHelper,actions);}else{if(lat&&!lng){removeFromDropZone(geoId,12,$EDZ.GeoAttribute,data,toHelper,actions,1);add2DropZone(geoId,12,$EDZ.Latitude,data,toHelper,actions);}else{removeFromDropZone(geoId,12,$EDZ.GeoAttribute,data,toHelper,actions,1);add2DropZone(geoId,12,$EDZ.Longitude,data,toHelper,actions);}}}else{removeFromDropZone(geoId,12,$EDZ.GeoAttribute,data,toHelper,actions,1);add2DropZone(geoId,12,$EDZ.AdditionalMetrics,data,toHelper,actions);}}else{toHelper.setMapType($MH.MTP_MARKER);}}this.setDefaultView(toHelper);return toHelper.getXml();}});}());