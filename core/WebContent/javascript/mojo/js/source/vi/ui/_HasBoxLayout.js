(function(){mstrmojo.requiresCls("mstrmojo.util.ui._HostsSplitter","mstrmojo.models.FormatModel","mstrmojo.DocDataService","mstrmojo.dom","mstrmojo.array","mstrmojo.hash","mstrmojo.css");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$FORMAT_MODEL=mstrmojo.models.FormatModel,$GET_FORMAT_OBJ=$FORMAT_MODEL.getFormatUpdate,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,POSITION_MAP={h:{dimension:{shared:"width",full:"height"},position:{shared:"left",full:"top"}},v:{dimension:{shared:"height",full:"width"},position:{shared:"top",full:"left"}}},SUPPRESS_DATA=mstrmojo.DocDataService.SUPPRESS_DATA;mstrmojo.vi.ui.BoxLayoutDimensionsType=null;function addUnits(dimensions){var rtn=$HASH.copy(dimensions);var px="px";rtn.left=Math.max(rtn.left,0)+px;rtn.top=Math.max(rtn.top,0)+px;rtn.height=Math.max(rtn.height,0)+px;rtn.width=Math.max(rtn.width,0)+px;return rtn;}function getBoxLayoutDimensions(orientation,childLength,dimensions,origin){var dimension=POSITION_MAP[orientation].dimension,position=POSITION_MAP[orientation].position,layoutDimensions={};layoutDimensions[dimension.shared]=childLength;layoutDimensions[dimension.full]=dimensions[dimension.full];layoutDimensions[position.shared]=origin;layoutDimensions[position.full]=dimensions[position.full];return layoutDimensions;}function getMinBoxSizes(orientation,boxChildren,padding,boxCfg){var oppositeOrientation=orientation==="v"?"h":"v",minBoxSizes=[],fnAggregate=function(propertyName){if(propertyName===orientation){return minBoxSizes.reduce(function(sum,item){return sum+item[orientation];},0);}return Math.max.apply(null,minBoxSizes.map(function(item){return item[oppositeOrientation];}));};boxChildren.forEach(function(boxChild,i){var boxSizeCfg={};if(boxChild.t===this.componentType){boxSizeCfg=mstrmojo.vi.ui.BoxLayoutConfig.getMinimumChildSizes(boxChild,orientation,boxCfg);}else{boxSizeCfg=getMinBoxSizes.call(this,boxChild.o,boxChild.children,padding,boxCfg);}if(i!==boxChildren.length-1){boxSizeCfg[orientation]+=padding;}minBoxSizes.push(boxSizeCfg);},this);return{sizes:minBoxSizes.map(function(box){return box[orientation];}),v:fnAggregate("v"),h:fnAggregate("h")};}function getAdjustedBoxSizes(orientation,boxChildren,dimensions,padding,boxCfg){var minimumBoxSizes=getMinBoxSizes.call(this,orientation,boxChildren,padding,boxCfg),availableLength=dimensions[POSITION_MAP[orientation].dimension.shared],outerLength=availableLength,lastBoxIdx=boxChildren.length-1,totalPercentageLength=0,fnAddPadding=function(length,idx){return idx===lastBoxIdx?length:length+padding;},overage=0,fixed={},resize={},useOrginialHeight=false,getUnitHeight=function(unitKey){var unit=this.getUnitByKey&&this.getUnitByKey(unitKey);return unit&&unit.height&&parseInt(unit.height,10)||0;};boxChildren.forEach(function(child,idx){var boxLength=parseFloat(child.l);if(child.f){availableLength-=fnAddPadding(boxLength,idx);}else{totalPercentageLength+=boxLength;}});if(totalPercentageLength>100){useOrginialHeight=true;}boxChildren.forEach(function(boxChild,idx){var childLength=boxChild.l;if(boxChild.f){fixed[idx]=fnAddPadding(childLength,idx);return ;}var calculatedLength=useOrginialHeight&&boxChild.type===this.componentType?getUnitHeight.call(this,boxChild.k):Math.round(availableLength*(childLength/totalPercentageLength)),minimumLength=minimumBoxSizes.sizes[idx];if(minimumLength>calculatedLength){fixed[idx]=minimumLength;overage+=minimumLength-calculatedLength;return ;}resize[idx]={c:calculatedLength,m:minimumLength};}.bind(this));if(overage){var fnReduceChildren=function(){var resizeKeys=Object.keys(resize),childDelta=overage/resizeKeys.length,complete=true;resizeKeys.forEach(function(idx){var child=resize[idx];if(child.m>child.c-childDelta){fixed[idx]=child.m;overage-=child.c-child.m;complete=false;delete resize[idx];}});if(complete){resizeKeys.forEach(function(idx){fixed[idx]=resize[idx].c-childDelta;});resize={};return ;}fnReduceChildren();};fnReduceChildren();}Object.keys(resize).forEach(function(idx){fixed[idx]=resize[idx].c;});var boxSizes=Object.keys(fixed).sort().map(function(key,idx){return fixed[key]-(idx<lastBoxIdx?padding:0);}),delta=outerLength-boxSizes.reduce($ARR.fnReduceNumber,0)-(lastBoxIdx*padding);if(delta!==0){boxSizes[lastBoxIdx]+=delta;}return boxSizes;}var splitterSrc=document.createElement("div");splitterSrc.setAttribute("unselectable","on");splitterSrc.className="splitter";mstrmojo.vi.ui._HasBoxLayout=mstrmojo.provide("mstrmojo.vi.ui._HasBoxLayout",{_mixinName:"mstrmojo.vi.ui._HasBoxLayout",boxType:"b",componentType:"c",boxLayoutConfig:null,firstBoxId:null,splitterCache:null,isInteractive:true,allowPanelEdgeTargeting:false,postBuildBoxLayout:mstrmojo.emptyFn,getBoxLayoutSaveAction:function getBoxLayoutSaveAction(boxLayout,skipPartialRetrieval){return this.model.getUnitFormatAction(this,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.LAYOUT_XML,boxLayout),skipPartialRetrieval);},getBoxLayoutSaveCallback:function getBoxLayoutSaveCallback(){return null;},getChildPositionActions:function getChildPositionActions(skipPartialRetrieval){return[];},saveBoxLayout:function saveBoxLayout(cmd,stage,callback,update,skipPartialRetrieval,extra){var cfg=this.boxLayoutConfig,model=this.model,dataService=model.getDataService(),actions=[].concat(this.getBoxLayoutSaveAction(cfg.getBoxState(),skipPartialRetrieval)).concat(this.getChildPositionActions(skipPartialRetrieval)),extras=$HASH.copy(extra,$HASH.copy(SUPPRESS_DATA,{preserveUndo:true}));callback=callback||{success:mstrmojo.emptyFn};if(!update){if(cmd){cmd.submit(actions,callback,extras,stage);}else{dataService.submitUpdates(actions,callback,extras);}}else{update.add(actions,callback);}},buildBoxLayout:function buildBoxLayout(animate,newBoxState){var boxLayoutConfig=this.boxLayoutConfig;if(!boxLayoutConfig||(this.height===undefined&&this.width===undefined)){return ;}if(newBoxState){boxLayoutConfig.box=newBoxState;}var splittersCache=this.splitterCache=this.splitterCache||[],calculationDimension={height:parseInt(this.height,10),width:parseInt(this.width,10),top:0,left:0},boxInfo=this.calculateBoxLayout(boxLayoutConfig,calculationDimension),boxChildrenInfo=boxInfo.box,splittersInfo=boxInfo.splitter,splitterHost=this.getSplitterHost(),childIdentifier=boxLayoutConfig.identifier,children=this.children,boxPaths=boxLayoutConfig.boxPaths={};this.firstBoxId=null;Object.keys(boxChildrenInfo).forEach(function(childKey){var childWidget=children[$ARR.find(children,childIdentifier,childKey)];if(childWidget){var childInfo=boxChildrenInfo[childKey],childId=childWidget.id;if(childInfo.first){this.firstBoxId=childId;}childInfo.boxChild.id=childId;boxPaths[childKey]=childInfo.boxLevel;childWidget.updateLayout(childInfo.dim,animate);}},this);splittersInfo.forEach(function(splitterInfo,index){var splitterDimensions=splitterInfo.dim;var splitter=splittersCache[index];if(!splitter){splitter=splittersCache[index]=splitterSrc.cloneNode(false);this.registerSplitter(splitter);}splitter.path=splitterInfo.boxLevel;splitter.orientation=splitterInfo.orientation;var splitterStyle=splitter.style;$HASH.copy(addUnits(splitterDimensions),splitterStyle);splitterStyle.display="block";$CSS.toggleClass(splitter,"v",splitterInfo.orientation==="h");if(!splitter.parentNode){splitterHost.appendChild(splitter);}},this);splittersCache.slice(splittersInfo.length).forEach(function(splitter){splitter.style.display="none";});var hostStyle=splitterHost.style,dimensions=boxInfo.size;hostStyle.height=dimensions.height+"px";hostStyle.width=dimensions.width+"px";if(this.updateScrollbars){this.updateScrollbars();}this.postBuildBoxLayout();delete boxLayoutConfig.dirty;},calculateBoxLayout:function calculateBoxLayout(boxLayoutConfig,outerDimensions){var padding=boxLayoutConfig.padding||0,boxLevels=[],boxChildrenInfo={},splitterInfo=[];var fnBuildLayout=function(boxCfg,dimensions,level){var orientation=boxCfg.o,dimension=POSITION_MAP[orientation].dimension,position=POSITION_MAP[orientation].position,sharedDimName=dimension.shared,posName=position.shared,origin=dimensions[posName],boxChildren=boxCfg.children,lastChildIndex=boxChildren.length-1,boxSizes=getAdjustedBoxSizes.call(this,orientation,boxChildren,dimensions,padding,boxLayoutConfig);if(boxLevels.length===level){boxLevels[level]=-1;}boxChildren.forEach(function(boxChild,i){var type=boxChild.t,childLength=boxSizes[i],layoutDimensions=getBoxLayoutDimensions.call(this,orientation,childLength,dimensions,origin);boxChild.h=layoutDimensions.height;boxChild.w=layoutDimensions.width;boxLevels[level]=boxLevels[level]+1;var boxPath=boxLevels.join("|");if(type===this.componentType){boxChildrenInfo[boxChild[boxLayoutConfig.identifier]]={boxLevel:boxPath,boxChild:boxChild,dim:addUnits(layoutDimensions),first:(layoutDimensions.top===0&&layoutDimensions.left===0)};}else{if(type===this.boxType){fnBuildLayout.call(this,boxChild,layoutDimensions,level+1);boxLevels.splice(level+1);}}if(this.isInteractive&&!boxChild.r&&i<lastChildIndex){var splitterDimensions=(JSON.parse(JSON.stringify(layoutDimensions)));splitterDimensions[posName]+=childLength;splitterDimensions[sharedDimName]=padding;splitterInfo.push({boxLevel:boxPath,dim:splitterDimensions,orientation:orientation});}origin+=childLength+padding;},this);};var layoutCfg=boxLayoutConfig.box||boxLayoutConfig.useDefaultBox(this.children),minimumBoxSizes=getMinBoxSizes.call(this,layoutCfg.o,layoutCfg.children,padding,boxLayoutConfig);outerDimensions.height=Math.max(outerDimensions.height,minimumBoxSizes.v);outerDimensions.width=Math.max(outerDimensions.width,minimumBoxSizes.h);fnBuildLayout.call(this,layoutCfg,outerDimensions,0);return{box:boxChildrenInfo,splitter:splitterInfo,size:{height:outerDimensions.height,width:outerDimensions.width}};},updateBoxPaths:function updateBoxPaths(){var boxLevels=[],boxLayoutConfig=this.boxLayoutConfig,boxPaths=this.boxLayoutConfig.boxPaths={};var fnCalculatePath=function(boxCfg,level){if(boxLevels.length===level){boxLevels[level]=-1;}boxCfg.children.forEach(function(boxChild){var type=boxChild.t;boxLevels[level]=boxLevels[level]+1;var boxPath=boxLevels.join("|");if(type===this.componentType){boxPaths[boxChild[boxLayoutConfig.identifier]]=boxPath;}else{if(type===this.boxType){fnCalculatePath.call(this,boxChild,level+1);boxLevels.splice(level+1);}}},this);};fnCalculatePath.call(this,boxLayoutConfig.box,0);},getBoxLayoutChild:function getBoxLayoutChild(boxChild){var id=boxChild.id;if(id){return mstrmojo.all[id];}return null;},setDimensions:function setDimensions(h,w){if(this.height!==h||this.width!==w){this.height=h;this.width=w;if(this.hasRendered){var domNodeStyle=this.domNode.style;domNodeStyle.height=h;domNodeStyle.width=w;}this.buildBoxLayout();}},onAppStateChange:function onAppStateChange(evt){this.isInteractive=mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION!==evt.value;},getSplitterInfo:function getSplitterInfo(splitter){var path=splitter.path,orientation=splitter.orientation,resizeBoundaries=this.boxLayoutConfig.getResizeBoundaries(path,orientation),maxValue=parseInt(orientation==="v"?this.height:this.width,10);return{path:path,min:resizeBoundaries.min,max:maxValue-resizeBoundaries.max};},shouldSaveSplitterMoves:function shouldSaveSplitterMoves(){return true;},splitterMoved:function splitterMoved(position,info){var box=this,cfg=box.boxLayoutConfig,model=box.model,ds=mstrmojo.DocDataService,fnExecute=function(cmd){cfg.resizeBox(info.path,position);box.buildBoxLayout();box.saveBoxLayout(cmd);};if(this.shouldSaveSplitterMoves()){model.execute({execute:function(){fnExecute(this);},urInfo:{callback:ds.EMPTY_CALLBACK,extras:ds.SUPPRESS_DATA}});}else{fnExecute();}},insertNewBox:function insertNewBox(box,targetBox,edge,update){var cfg=this.boxLayoutConfig;if(update){update.oldBoxState=cfg.getBoxState();}if(targetBox){cfg.addDropBox(targetBox,edge,{box:{boxId:box.id}});}else{cfg.insertNewRootChild(box,edge);this.buildBoxLayout(true);}},insertNewBoxAndSaveDeferred:function(update,box,actions,callback,targetBox,edge){this.insertNewBox(box,targetBox,edge);this.saveBoxLayout(undefined,-1,callback,update);},deleteBoxAndSubmitDeferred:function(update,boxChild,callback,skipPartialRetrieval,skipRelayout){this.deleteBox(boxChild,skipRelayout);this.saveBoxLayout(undefined,-1,callback,update,skipPartialRetrieval);},deleteBox:function deleteBox(boxChild,skipReLayout){this.boxLayoutConfig.deleteBox(boxChild,skipReLayout);this.removeChildren(boxChild);},deleteBoxAndSubmit:function deleteBoxAndSubmit(boxChild,callback,extra){var dataService=this.model.getDataService(),$this=this;this.model.execute({execute:function(){var cmd=this,update=dataService.newUpdate(cmd,callback);$this.deleteBoxAndSubmitDeferred(update,boxChild);update.addExtras($HASH.copy(SUPPRESS_DATA,extra));update.submit();}});},getBoxOrientation:function getBoxOrientation(boxChild){var boxLayoutConfig=this.boxLayoutConfig;return boxLayoutConfig.getBoxOrientation(boxLayoutConfig.getBoxPath(boxChild));},hasBoxLayoutChild:function hasBoxLayoutChild(widget){var cfg=this.boxLayoutConfig,idProp=cfg.identifier,searchId=widget[idProp],fnHasChild=function(box){if(!box){return false;}if(box.t===this.componentType){return box[idProp]===searchId;}return(box.children||[]).some(fnHasChild);}.bind(this);return widget.parent===this&&fnHasChild(cfg.box);},beginBoxMove:function beginBoxMove(context,boxChild,noDelete){this.boxLayoutConfig.beginBoxMove(context,boxChild,noDelete);},dropBox:function dropBox(context,targetBox,edge,saveLayout){var outerEdge=this.getPanelTargetEdge(context),panel=this,boxLayoutConfig=this.boxLayoutConfig;if(outerEdge){boxLayoutConfig.insertExistingRootChild(context,outerEdge.substr(1));}else{boxLayoutConfig.addDropBox(targetBox,edge,context);}panel.buildBoxLayout();if(saveLayout){this.saveBoxLayout();}},cancelBoxMove:function cancelBoxMove(context){var boxWidget=context.src.widget;if(!boxWidget.cancelBoxMove(context)){this.boxLayoutConfig.cancelBoxMove(context);}},endBoxMove:mstrmojo.emptyFn,getPanelTargetEdge:function getPanelTargetEdge(context){if(!this.allowPanelEdgeTargeting){return"";}var panelPosition=context.panelPos;if(!panelPosition){var pp=$DOM.position(this.domNode);panelPosition=context.panelPos={p:pp,q:{Top:pp.y,Right:pp.x+pp.w,Bottom:pp.y+pp.h,Left:pp.x}};}var mousePosition=context.tgt.pos,edge=mstrmojo.boxmodel.getEdgeQuadrantByPoint(panelPosition.p,mousePosition),mousePoint=edge==="Left"||edge==="Right"?mousePosition.x:mousePosition.y;return Math.abs(panelPosition.q[edge]-mousePoint)<=12?"p"+edge:"";},updateDropCue:function updateDropCue(edge,context,boxPosition){var cue=this._dropCue;if(!cue){cue=this._dropCue=document.body.appendChild(document.createElement("div"));cue.className="mstrmojo-vi-hbl-cue";}var cueStyle=cue.style;if(edge===""){cueStyle.display="none";cueStyle.top="-10000px";return ;}if(edge.charAt(0)==="p"){edge=edge.substr(1);boxPosition=context.panelPos.p;}var isAll=edge==="All",position={top:boxPosition.y-3,left:boxPosition.x-3,height:boxPosition.h+6,width:boxPosition.w+6};if(!isAll){var isHorizontal=true;if(edge==="Bottom"){position.top=boxPosition.y+boxPosition.h+1;}else{if(edge==="Right"){position.left=boxPosition.x+boxPosition.w+1;isHorizontal=false;}else{isHorizontal=edge==="Top";}}position[isHorizontal?"height":"width"]=2;}$CSS.toggleClass(cue,"all",isAll);cueStyle.cssText=Object.keys(position).map(function(cssProperty){return cssProperty+":"+position[cssProperty]+"px";}).join(";");cueStyle.display="block";},unrender:function unrender(ignoreDom){var cue=this._dropCue;if(cue){cue.parentNode.removeChild(cue);delete this._dropCue;}return this._super(ignoreDom);},getSplitterHost:function getSplitterHost(){throw new Error(this.scriptClass+" must implement getSplitterHost.");},getBoxState:function getBoxState(){return this.boxLayoutConfig.getBoxState();},restoreBoxState:function restoreBoxState(state){this.boxLayoutConfig.revertBoxState(state);}});var $HBL=mstrmojo.vi.ui._HasBoxLayout;$HASH.forEach(mstrmojo.util.ui._HostsSplitter,function(member,key){if(!$HBL.hasOwnProperty(key)){$HBL[key]=member;}});}());