(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array");mstrmojo.vi.ui.rw.SelectionType={EMPTY:"empty",ATTS:"att",METRICS:"metric",COL_HEADERS:"col-headers",ROW_HEADERS:"row-headers",METRIC_VALUES:"metric-values"};var getCacheKey=function(obj){var mid=(mstrApp.docModelData&&mstrApp.docModelData.mid)||"";return obj.k+"-"+mid;},selectionCache={},$H=mstrmojo.hash,$A=mstrmojo.array,_getSelectionHash=function(candidate){var attIds=$H.keyarray(candidate).sort(),hashes=[],attValIds;$A.forEach(attIds,function(attId){attValIds=[];$A.forEach(candidate[attId],function(attVal){attValIds.push(this.model.getNormalizedFormElementId(attVal.id));},this);hashes.push(attId+"-"+attValIds.sort().join("@"));},this);return hashes.join("#");},addSelection=function(candidate){var hash=_getSelectionHash.call(this,candidate);if(!this._viSelections[hash]){this._viSelections[hash]=candidate;selectionCache[getCacheKey(this)]={_selectionType:this.getSelectionType(),_viSelections:this.getSelectionHash()};}},removeSelection=function(candidate){var hash=_getSelectionHash.call(this,candidate),res=this._viSelections[hash];if(res){delete this._viSelections[hash];selectionCache[getCacheKey(this)]={_selectionType:this.getSelectionType(),_viSelections:this.getSelectionHash()};}return res;},getNormalSelection=function(attId,vId,value){var s={};s[attId]=[{id:vId,n:value}];return s;},st=mstrmojo.vi.ui.rw.SelectionType;mstrmojo.vi.ui.rw._HasVisSelections=mstrmojo.provide("mstrmojo.vi.ui.rw._HasVisSelections",{_mixinName:"mstrmojo.vi.ui.rw._HasVisSelections",init:function(props){if(this._super){this._super(props);}this._viSelections={};},update:function update(node){var continueUpdate=true;if(this._super){continueUpdate=this._super(node);}$H.copy(selectionCache[getCacheKey(this)],this);return continueUpdate;},onSelectionChange:function onSelectionChange(data){if(this._super){this._super(data);}},_viSelections:{},_selectionType:st.EMPTY,getSelectionType:function(){return this._selectionType;},isSingleAttrSelection:function(){var aid=null,selections;if(this.getSelectionType()===st.ATTS){selections=this.getSelections();if(selections.length>1){return !selections.some(function(sel){if(!aid){aid=sel[0].tid;return false;}return aid!=sel[0].tid;},this);}return true;}return false;},isSingleSelection:function(){return(this._viSelections&&$H.keyarray(this._viSelections).length===1);},getSelectionSize:function getSelectionSize(){return(this._viSelections&&$H.keyarray(this._viSelections).length)||0;},getSelectionHash:function getSelectionHash(){return this._viSelections;},getSelections:function getSelections(){var res=[],node;$H.forEach(this._viSelections,function(sel){node=[];res.push(node);$H.forEach(sel,function(ee,aid){$A.forEach(ee,function(e){node.push({tid:aid,eid:e.id,v:e.n});});});});return res;},isMetricValueSelected:function isSelected(sel){return !!this._viSelections[_getSelectionHash.call(this,sel)];},isAttSelected:function isAttSelected(attId,elementId){return this.isMetricValueSelected(getNormalSelection(attId,elementId));},addAttributeSelection:function addAttributeSelection(attId,elementId,value){if(this._selectionType!==st.ATTS){this.clearSelections();this._selectionType=st.ATTS;}var p=getNormalSelection.call(this,attId,elementId,value);addSelection.call(this,p);return p[attId];},removeAttributeSelection:function removeAttributeSelection(attId,elementId){return removeSelection.call(this,getNormalSelection.call(this,attId,elementId));},addMetricValueSelection:function addMetricValueSelection(candidate){if(this._selectionType!==st.METRICS){this.clearSelections();this._selectionType=st.METRICS;}addSelection.call(this,candidate);},removeMetricValueSelection:function removeMetricValueSelection(candidate){return removeSelection.call(this,candidate);},clearSelections:function clearSelections(){if(this._super){this._super();}this._viSelections={};this._selectionType=st.EMPTY;},clearSelectionsCache:function clearSelectionsCache(){selectionCache={};},clearUnitSelections:function clearSelections(unitId){if(this._super){this._super();}var newSelections={};$H.forEach(this._viSelections,function(sel,k){if($H.keyarray(sel)[0]!==unitId){newSelections[k]=sel;}});this._viSelections=newSelections;},endSelections:function endSelections(){selectionCache[getCacheKey(this)]={_selectionType:this.getSelectionType(),_viSelections:this.getSelectionHash()};this.onSelectionChange(this.getSelectionHash());},addSelectionsFromExpression:function addSelectionsFromExpression(exp){this.clearSelections();this._selectionType=exp.type;var that=this,fill=function(node){var OR=20,AND=19,qual=function(n){return n.nds.length===1?OR:n.fn;},isLastNode=function(n){return parseInt(n.et,10)===5||parseInt(qual(n),10)===AND;},addToAttributes=function(node){$A.forEach(node.es,function(elem){that.addAttributeSelection(node.a.did,elem.v,elem.n);});},addToMetrics=function(node){var candidate={},addElements=function(n){$A.forEach(n.es,function(elem){$H.copy(getNormalSelection.call(that,n.a.did,elem.v,elem.n),candidate);});};if(node.nds){$A.forEach(node.nds,addElements);}else{if(node.es){addElements(node);}}that.addMetricValueSelection(candidate);};if(isLastNode(node)){node={nds:[node]};}$A.forEach(node.nds,function(n){if(isLastNode(n)){if(exp.type===st.ATTS){addToAttributes(n);}else{addToMetrics(n);}}else{fill(n);}});};fill(exp.data);}});mstrmojo.vi.ui.rw._HasVisSelections.VisSelectionType=null;}());