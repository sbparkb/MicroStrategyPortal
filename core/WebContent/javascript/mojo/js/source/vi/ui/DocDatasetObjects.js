(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.vi.ui.DatasetObjects","mstrmojo.vi.ui.DocDatasetUnitList","mstrmojo.vi.ui.toolbars._HasToolbar","mstrmojo.util.ui._HostsSplitter","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.vi.ui.toolbars._HasToolbar","mstrmojo.ui.menus.MenuConfig","mstrmojo.ui.menus.ToolbarConfig","mstrmojo.IVEDatasetPicker","mstrmojo.vi.ui.PanelContents","mstrmojo.vi.ui.PanelPortlet","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.ui.SelectDatasetWizardEditor","mstrmojo.vi.ui.ReplaceObjectEditor","mstrmojo.ui.ScrollableContainer","mstrmojo.fe.FilterEditor","mstrmojo.fe.FilterUtils","mstrmojo.array","mstrmojo.hash","mstrmojo.form","mstrmojo.func","mstrmojo.dom","mstrmojo.Button","mstrmojo.mstr.EnumFunction","mstrmojo.SaveAsEditor","mstrmojo.vi.ui.ViewDataDialog","mstrmojo.vi.ui.DatasetEditor","mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy","mstrmojo.onetier.vi.prefs.HostedDesktopConnectivityProxy","mstrmojo.vi.ui.AllObjectsBrowser","mstrmojo.vi.enums.EnumDSSAccessRightFlags");var $HASH=mstrmojo.hash,$CSS=mstrmojo.css,$ARR=mstrmojo.array,$FUNC=mstrmojo.func,$DOM=mstrmojo.dom,$DUMU=mstrmojo.vi.ui.DatasetUnitMenuUtils,DSM={IN_MEMORY:1,DIRECT_ACCESS:2},SDA={SupportDDAOrInMemory:1,SupportInMemoryOnly:2,SupportDDAOnly:3},onlyDefExtras={style:{params:{treesToRender:1}}},$WARN=mstrmojo.warn,$ACG=mstrmojo.vi.enums.EnumDSSAccessRightFlags,ALL_OBJ_BROWSER_TOP=30,ALL_OBJ_BROWSER_HEIGHT=30;function getConnectivityProxy(){return mstrApp.isSingleTier?new mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy():new mstrmojo.onetier.vi.prefs.HostedDesktopConnectivityProxy();}function executeDynamic(exeFunc){this.model.cmdMgr().execute({execute:function(){exeFunc(this);}});}function getFeature(name){return mstrApp.rootCtrl.resolveFeature(name);}function allowMultipleWorkingsets(){return !getFeature("single-workingset");}function isDownLoadDatasetEditable(dataset){return(!dataset.hcs||dataset.idd)&&!(dataset.tables&&dataset.tables[0]&&dataset.tables[0].xdaType===400);}function getDatasetPicker(config){var id=config.id||"mstrIVE_DS",editor=mstrmojo.all[id];if(!editor){editor=new mstrmojo.IVEDatasetPicker({id:id,onOk:mstrmojo.emptyFn,onCancel:mstrmojo.emptyFn,onPreClose:function(){this.onCancel();return true;},onRender:function onRender(){var importVisible=false;this.btnImport.set("visible",importVisible);this.newLabel.set("visible",importVisible);this.useExistingLabel.set("visible",importVisible);this.ob.set("scrollableIncFetch",true);this.btnHBox.destroyChildren();var btnOk=mstrmojo.Button.newWebButton(mstrmojo.desc(547,"Select"),function(){if(this.enabled){editor.onOk();editor.close();}},true);btnOk.bindings={enabled:function(){return this.parent.parent.multiSelect?!!this.parent.parent.selectedItems.length:!!this.parent.parent.item;}};this.btnHBox.addChildren([btnOk,mstrmojo.Button.newWebButton(mstrmojo.desc(221,"Cancel"),function(){editor.onCancel();editor.close();},false)]);}});if(config.title){editor.set("title",config.title);}}$HASH.forEach(config,function(value,key){editor.set(key,value);});return editor;}function insertNewMetric(dsid,docModel){var view=this;return function(){mstrApp.rootCtrl.docCtrl.openDME(view,{metricId:"",editorId:"mstrME",action:{cmd:"editNew"}},docModel.getDataService().getAddNewDerivedMetricToDatasetSubmitFunc({dsid:dsid}));};}function insertNewDerivedAttr(dsid,datasets){var view=this;return function(){mstrApp.rootCtrl.docCtrl.openDAE(view,{dsid:dsid,datasets:datasets},mstrmojo.emptyFn);};}function setJoinBehavior(model,dataset){var setPrimJBCfg=new mstrmojo.ui.menus.MenuConfig(),options=[{n:mstrmojo.desc(14476,"Primary (outer join)"),v:1},{n:mstrmojo.desc(14477,"Secondary (inner join)"),v:0}];options.forEach(function(opt){setPrimJBCfg.addMenuItem(opt.n,opt.v===dataset.ipm?"on":"",function(){var ctrl=model.controller,callback=ctrl.getRefreshCallback();ctrl.cmdMgr.execute({execute:function(){this.submit([{act:"setJoinBehavior",dsid:dataset.did,dst:dataset.type,prm:opt.v}],callback,{style:{params:{treesToRender:3}}});},urInfo:{callback:callback}});});});return setPrimJBCfg;}function getManifest(dsPanel,docModel,callback,dsid){var params={taskId:"mojoGetDocumentManifest"},getDatasetInfo=function(indexArray){var datasets=[],index=1;$HASH.forEach(dsPanel.data,function(dataset){indexArray.forEach(function(inx){if(index===parseInt(inx,10)){datasets.push(dataset);}});index++;});return datasets;};if(dsid){params.dsid=dsid;}docModel.getDataService().submitUpdates({},{success:function(manifest){var units=[],all_units={},all_manifest_units={};$HASH.forEach(dsPanel.data,function(dataset){dataset.att.concat(dataset.mx).forEach(function(unit){all_units[unit.did]=unit;});});manifest.manifest_objects.forEach(function(obj){if(all_units[obj.did]){obj.cubes=getDatasetInfo(obj.cube_ids||[]);units.push($HASH.copy(all_units[obj.did],obj));all_manifest_units[obj.did]=obj;}});manifest.manifest_objects.forEach(function(obj){if(obj.dependents){obj.dependentObjects=[];obj.dependents.forEach(function(objID){obj.dependentObjects.push(all_manifest_units[objID]);});}});units=$DUMU.getSortedDatasetUnits(units);callback(units);},failure:function(){docModel.cmdMgr().onFailure();}},{params:params,preserveUndo:true});}function getWorkingSet(docModel,dsid,callback){var targetDataset=docModel.datasets[dsid];if(targetDataset){callback(targetDataset);}else{docModel.getDataService().submitUpdates({},{success:function(workingset){callback(workingset);},failure:function(){docModel.cmdMgr().onFailure();}},{params:{taskId:"mojoGetReportWorkingSet",reportId:dsid,chkViewReport:1},preserveUndo:true});}}function generateWorkingSetObjects(dataset){var workingSet=$HASH.clone(dataset.att.concat(dataset.mx));workingSet.forEach(function(unit){if(unit.hc){unit.cont_did=dataset.did;unit.cont_tp=dataset.type;}});return $ARR.filter(workingSet,function(obj){return !obj.um;});}function getApplyReconciliationFunction(dsPanel,docModel,replaceAll,config,extraActions,extraCallback){return function applyReconciliation(members,clearaf){var actions=[{act:"applyReconciliation",clr_af:clearaf,members:members,disablePU:true}].concat(extraActions);if(!!config.isOneTierCubeImport){actions[0].sourceId=(replaceAll?"all":config.source.did);}if(replaceAll){$HASH.forEach(dsPanel.data,function(dataset,did){members.unshift({srcid:did,srct:3,tgtid:config.target.did,tgtt:3});});}else{members.unshift({srcid:config.source.did,srct:3,tgtid:config.target.did,tgtt:3});}var cmdMgr=docModel.cmdMgr(),interimCmd=cmdMgr.getInterimCmd(),refreshCallback=docModel.controller.getRefreshCallback(),cb=$FUNC.wrapMethods(refreshCallback,(extraCallback||mstrmojo.emptyFn));if(interimCmd){interimCmd.urInfo.callback=refreshCallback;interimCmd.submit(actions,cb,mstrmojo.DocDataService.REQUEST_DEFN_DATA,cmdMgr.CMD_PHASE.LAST);}else{cmdMgr.execute({execute:function(){this.submit(actions,cb,mstrmojo.DocDataService.REQUEST_DEFN_DATA);},urInfo:{callback:refreshCallback}});}};}function getReplaceDatasetMenuHandler(dsPanel,replaceAll){var docModel=dsPanel.model,ROEDITOR_ID="mstrReconReplaceEditor",roEditor=null,cancelProcess=function cancelProcess(){var cmd=docModel.cmdMgr().getInterimCmd();if(cmd){var urInfo=cmd.urInfo;urInfo.callback={success:mstrmojo.emptyFn};urInfo.treesToRender=0;cmd.cancel();}},openReplaceObjectEditor=function(config){if(!roEditor){roEditor=mstrmojo.all[ROEDITOR_ID]||mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.ReplaceObjectEditor",id:ROEDITOR_ID});}roEditor.set("showUnitTooltip",replaceAll);roEditor.setUnits({source:config.source,target:config.target});updateDatasetsCollapsed($HASH.keyarray(docModel.datasets).filter(function(dsid){return dsid===config.target.did;}).map(function(dsid){return{dsid:dsid,collapsed:false};}),dsPanel);roEditor.onOk=getApplyReconciliationFunction(dsPanel,docModel,replaceAll,config,dsPanel.settings.getSaveActions(),{success:function(){dsPanel.set("allObjectBrowserOpened",false);},failure:function(){roEditor.open();}});roEditor.onCancel=cancelProcess;roEditor.set("onBack",config.onBack||mstrmojo.emptyFn);roEditor.open();},openDIDialog=function(callback){dsPanel.showDataImport({isEdit:false,AnalysisId:docModel.mid,callback:function onDataImportSuccess(datasets){if(datasets){var dataset=datasets[0];if(dataset.mngd){if(!mstrApp.isSingleTier){docModel.cmdMgr().getInterimCmd().resetCmdMgrOnComplete();}callback(dataset);}else{getWorkingSet(docModel,dataset.did,callback);}}else{cancelProcess();}}});},openDatasetEditor=function(callback){dsPanel.openDatasetEditor({modifiedItems:{create:{act:"createDataset",mgo:true,prm:true,noRowCount:1,newObjectIds:["$GUID_141"]},add:[],del:[],fs:{add:[],del:[]},filter:null},title:mstrmojo.desc(13362,"Report Editor")+" - "+mstrmojo.desc(11636,"New Dataset"),docModel:docModel,okBtnText:mstrmojo.desc(4447,"Add"),onOk:function(actions){docModel.cmdMgr().getInterimCmd().submitInterim(actions,{success:function(res){$HASH.forEach(res.datasets,function(v,n){if(!docModel.datasets[n]){res.datasets[n].did=n;callback(res.datasets[n]);}});}});},onCancel:cancelProcess});},openDatasetPicker=function(callback){var editor=getDatasetPicker({id:"mstrReconDatasetPicker",title:mstrmojo.desc(11940,"Select Existing Dataset"),onOk:function(){getWorkingSet(docModel,editor.item.did,callback);},onCancel:cancelProcess});editor.open();},openCubeBrowser=function(callback){docModel.controller.openCubeBrowser({success:function(res){getWorkingSet(docModel,res.did,callback);},failure:function(){cancelProcess();}});},processReplaceObject=function(config){var sdid=config.sourceDatasetId,isOneTierCubeImport=!!config.isOneTierCubeImport,open=config.openDialog;getManifest(dsPanel,docModel,function(units){function start(){executeDynamic.call(dsPanel,function(){open(function(workingset){var workingSetObjects=generateWorkingSetObjects(workingset);openReplaceObjectEditor({isOneTierCubeImport:isOneTierCubeImport,source:{did:sdid,all:!!replaceAll,units:units},target:{did:workingset.did,units:workingSetObjects},onBack:$FUNC.composite([cancelProcess||mstrmojo.emptyFn,start])});});});}start();},replaceAll?null:sdid);};return function(){var cfg=new mstrmojo.ui.menus.MenuConfig({supportsScroll:true,menuCssClass:"reconsoliationMenu"}),dsid=this.did,manifestId=replaceAll?null:dsid,numOfDatasets=Object.keys(dsPanel.data).length;if(allowMultipleWorkingsets()){var isOneTierApp=mstrApp.isSingleTier;if(docModel.allowImportData()){cfg.addMenuItem((isOneTierApp)?mstrmojo.desc(14303,"New Data..."):mstrmojo.desc(13569,"External Data..."),"",function(){processReplaceObject({sourceDatasetId:dsid,openDialog:openDIDialog});});}if(!isOneTierApp&&!dsPanel.hasUnsubmitDataset&&docModel.allowNewOrEditRolapDS()&&docModel.isSchemaDefined()){cfg.addMenuItem(mstrmojo.desc(13572,"New Report..."),"",function(){processReplaceObject({sourceDatasetId:dsid,openDialog:openDatasetEditor});});}cfg.addMenuItem((isOneTierApp)?mstrmojo.desc(14304,"Dataset from Server..."):mstrmojo.desc(13573,"Existing Dataset..."),"",function(){processReplaceObject({sourceDatasetId:dsid,isOneTierCubeImport:isOneTierApp,openDialog:isOneTierApp?openCubeBrowser:openDatasetPicker});});}if(numOfDatasets>1){cfg.addSeparator();$HASH.forEach(dsPanel.data,function(dataset2,id2){if(id2===dsid){return true;}cfg.addMenuItem(dataset2.name,"",function(){executeDynamic.call(dsPanel,function(){getManifest(dsPanel,docModel,function(units){getWorkingSet(docModel,id2,function(workingset){openReplaceObjectEditor({source:{did:dsid,all:!!replaceAll,units:units},target:{did:id2,units:generateWorkingSetObjects(workingset)}});});},manifestId);});});});}return cfg;};}function getOpenImportDataMenu(){var me=this,model=me.model,ds=[];$HASH.forEach(model.datasets,function(dataset){if(dataset.st===779&&model.hasPrivilegesForAllTables(dataset.tables)){ds.push(dataset);}});return function(){me.showDataImport({isEdit:false,datasets:ds,AnalysisId:me.model.mid,needDefn:true});};}function openDIForMultipleCubeRefresh(){var me=this,model=me.model,ds=[];$HASH.forEach(model.datasets,function(dataset){if(dataset.st===779&&model.hasPrivilegesForAllTables(dataset.tables)){ds.push({cube_id:dataset.did,cname:dataset.name,ddam:dataset.dsm,mdt:"2014-12-10 20:57:25",sz:421,st:dataset.st});}else{if(dataset.st===776){ds.push({cube_id:dataset.did,cname:dataset.name,ddam:dataset.dsm,mdt:"2014-12-10 20:57:25",sz:421,st:dataset.st});}}});return function(){me.showDataImport({isEdit:false,datasets:{cubes:{cube:ds}},AnalysisId:me.model.mid,StatusCode:2,refreshMultipleCubes:true,rwb:model.getDataService().rwb});};}function getAddDatasetMenu(dsPanel){return function(){var cfg=new mstrmojo.ui.menus.MenuConfig(),$this=this;var isOneTierApp=mstrApp.isSingleTier;if(allowMultipleWorkingsets()&&$this.model.allowImportData()){cfg.addMenuItem((isOneTierApp)?mstrmojo.desc(14303,"New Data..."):mstrmojo.desc(13569,"External Data..."),"",getOpenImportDataMenu.call($this));}if(!isOneTierApp&&!dsPanel.hasUnsubmitDataset&&$this.model.allowNewOrEditRolapDS()&&$this.model.isSchemaDefined()){cfg.addMenuItem(mstrmojo.desc(13572,"New Report..."),"",function(){dsPanel.openDatasetEditor({title:mstrmojo.desc(13362,"Report Editor")+" - "+mstrmojo.desc(11636,"New Dataset"),okBtnText:mstrmojo.desc(4447,"Add"),docModel:$this.model});});}if(!isOneTierApp){cfg.addMenuItem(mstrmojo.desc(13573,"Existing Dataset..."),"",dsPanel.getShowDatasetPicker());}return cfg;};}function hasHiddenObjects(docModel){var datasets=docModel&&docModel.datasets,units=(docModel.datasetsSettings&&docModel.datasetsSettings.units)||{},fnFilterHide=function(unit){return unit.hide&&!(units[unit.n]&&units[unit.n].completeHide);},dataset,did;for(did in datasets){dataset=datasets[did];if($ARR.filterOne(dataset&&dataset.att,fnFilterHide)||$ARR.filterOne(dataset&&dataset.mx,fnFilterHide)){return true;}}return false;}function showHiddenObjects(docModel){var datasets=docModel&&docModel.datasets,hiddenObjectList=[],addEditorChild=function(dataset,did){var units=(docModel.datasetsSettings&&docModel.datasetsSettings.units)||{},atts=$ARR.filter(dataset.att,function(att){return att.hide&&!(units[att.n]&&units[att.n].completeHide);}),mxs=$ARR.filter(dataset.mx,function(mx){return mx.hide&&!(units[mx.n]&&units[mx.n].completeHide);}),items=atts.concat(mxs);if(items.length===0){return ;}var list=new mstrmojo.ui.CheckList({cssClass:"units",items:items.map(function(item){item.tt=item.n;item.css=$DUMU.getUnitCssClass(item);return item;})});hiddenObjectList.push({scriptClass:"mstrmojo.vi.ui.PanelPortlet",title:dataset.name,dsid:did,children:[list],getSelectedItems:function(){return list.getSelectedItems()||[];},markupMethods:$FUNC.override({onisCollapsedChange:function(){this._super();this.parent.updateScrollbars();}},$HASH.copy(mstrmojo.vi.ui.PanelPortlet.prototype.markupMethods))});},did;for(did in datasets){addEditorChild(datasets[did],did);}return new mstrmojo.ui.menus.EditorConfig({data:{},cssClass:"mstrmojo-ShowHiddenEditor",contents:{scriptClass:"mstrmojo.ui.ScrollableContainer",alias:"scrollableContainer",children:hiddenObjectList},onOpen:function opOpen(){this.scrollableContainer.updateScrollbars();},fnOk:function(){var actions=[];hiddenObjectList.forEach(function(portlet){var selectedItems=portlet.getSelectedItems();selectedItems.forEach(function(item){actions.push(docModel.getToggleHiddenObjectAction(portlet.dsid,item,false));});});var callback=docModel.getDatasetsUpdateCallback();docModel.controller.cmdMgr.execute({execute:function(){this.submit(actions,callback,onlyDefExtras);},urInfo:{callback:callback}});}});}function updateDatasetsCollapsed(datasetCollapsedStatusArray,panel){$ARR.forEach(datasetCollapsedStatusArray,function(item){var dsid=item.dsid,dsInfo=panel.settings.dataset(dsid);dsInfo.isCollapsed=!!item.isCollapsed;});}function submitDatasetsCollapsed(datasetCollapsedStatusArray,panel){updateDatasetsCollapsed(datasetCollapsedStatusArray,panel);panel.saveSettings();}function removeDataset(datasetPanel,did){return function(){var model=datasetPanel.model,controller=model&&model.controller,actions=[{act:"removeDataset",did:did,disablePU:true}],callback=controller.getRefreshCallback();if(datasetPanel.getDatasetCount()===2){updateDatasetsCollapsed($HASH.keyarray(model.datasets).filter(function(dsid){return dsid!==did;}).map(function(dsid){return{dsid:dsid,collapsed:false};}),datasetPanel);actions=actions.concat(datasetPanel.settings.getSaveActions());}controller.cmdMgr.execute({execute:function(){this.submit(actions,callback,{style:{params:{treesToRender:3}}});},urInfo:{callback:callback}});};}function replaceOneTierCube(dsPanel,docModel,dataset,dsid,mode){var connProxy=getConnectivityProxy(),onError=mstrmojo.onetier.vi.prefs.handleErrorMessage,isRepublish=dataset.dsm===mode,message,getPollingStataus=function getPollingStatus(data,callback){connProxy.getPollingStatus({id:data.id},{success:function success(res){switch(res.status){case 1:case 2:mstrApp.getRootController().showOrHideProgressBar(mstrmojo.desc(13568,"Download from server"),false);if(res.status===2){if(callback.failure){callback.failure(res.data);}}else{connProxy.refreshNativeDialogMenu();callback.success(res.data);}break;case 4:mstrApp.getRootController().showOrHideProgressBar(mstrmojo.desc(13568,"Download from server"),false);return ;default:mstrApp.getRootController().updateProgressBar({pct:res.pct,msg:res.msg,requestID:data.id,canCancel:res.status===0});getPollingStataus(res,callback);}},failure:function failure(){mstrApp.getRootController().showOrHideProgressBar("Download from server",false);}});},replaceCube=function(){connProxy.loadCube({objectID:dsid,addDatasetToDocument:false,dda:mode===DSM.DIRECT_ACCESS},{success:function(res){mstrApp.getRootController().showOrHideProgressBar("Download from server",true);getPollingStataus({id:res.id},{success:function(){getManifest(dsPanel,docModel,function(units){getWorkingSet(docModel,dataset.did,function(workingset){var workingSetObjects=generateWorkingSetObjects(workingset),members=[],member;workingSetObjects.forEach(function(wso){if(mstrmojo.array.find(units,"did",wso.did)!==-1){member={tgtid:wso.did,tgtt:wso.t,srcid:wso.did,srct:wso.t};if(wso.cont_did&&wso.cont_tp){member.cont_did=wso.cont_did;member.cont_tp=wso.cont_tp;}members.push(member);}});getApplyReconciliationFunction(dsPanel,docModel,false,{isOneTierCubeImport:true,source:{did:dsid,units:units},target:{did:workingset.did,units:workingSetObjects},onBack:mstrmojo.emptyFn})(members,false);});},dsid);}});}});};connProxy.getCubeInfo({cubeIds:dsid},{success:function(cubeInfo){if(mode===DSM.IN_MEMORY){if(cubeInfo.hsf){mstrmojo.alert(mstrmojo.desc(14171,"You can not download the data because a security filter has been defined for you in this project."));}else{if(cubeInfo.acld){mstrmojo.alert(mstrmojo.desc(14172,"You can not download the data because you do not have access to all the objects in the selected Intelligent cube."));}else{if(cubeInfo.dda){message=isRepublish?mstrmojo.desc(14079,"Data Access Mode for the corresponding Intelligent Cube on the MicroStrategy Server has changed from In-Memory to Connect Live. Due to this change, you will not be able to continue in In-Memory mode. Do you want to switch to Live Connection?"):mstrmojo.desc(14080,"Data Access Mode for the corresponding Intelligent Cube on the MicroStrategy Server has changed from In-Memory to Connect Live. Due to this change, you will not be able to switch to In-Memory mode.");mstrmojo.confirm(message,{confirmBtn:{fn:function(){mode=DSM.DIRECT_ACCESS;replaceCube();}}});}else{var getSizeLabel=function(sizeInKB){return"{"+(sizeInKB>=1048576?(sizeInKB/1048576).toFixed(2)+"GB":(Math.round((sizeInKB||0)*100/1024)/100).toFixed(2)+"MB")+"}";},maxFileSize=cubeInfo.maxcs*1024,cubeSize=cubeInfo.cs,bigCube=cubeSize>maxFileSize;if(bigCube){mstrmojo.alert(mstrmojo.desc(14081,"The size of the Intelligent Cube #  is more than the download limit ## set by the administrator. Therefore, you can only Connect Live to the selected Intelligent Cube.").replace("##",getSizeLabel(maxFileSize)).replace("#",getSizeLabel(cubeSize)));}else{replaceCube();}}}}}else{replaceCube();}},failure:function(res){onError(res);}});}function disconnectDataset(dataset,dsid,model,ignoreExecution,callback){if(mstrApp.isSingleTier&&dataset.hcs){var message=dataset.dsm===DSM.DIRECT_ACCESS?"You are using Live connection to an Intelligent Cube residing on a MicroStrategy Server. In order to continue, you need to first convert the cube to a local cube. Do you want to continue?":"You are using an Intelligent Cube from a MicroStrategy Server. In order to continue, you need to first convert the cube to a local cube. Do you want to continue?";mstrmojo.confirm(message,{confirmBtn:{fn:function(){model.getDataService().submitUpdates({act:"disconnectDataset",dsid:dsid,dsm:DSM.IN_MEMORY,ignoreExecution:ignoreExecution},$FUNC.wrapMethods(callback,{failure:mstrApp.onerror}),{style:{params:{treesToRender:0}}});}}});}}function getDataAccessModelSubMenu(dsPanel,dataset,dsid,model){function toggleDatasetServeMode(mode){var docModel=dsPanel.model,executeToggleServeMode=function(){if(mode===dataset.dsm){return ;}if(dataset.hcs){replaceOneTierCube(dsPanel,docModel,dataset,dsid,mode);}else{function executeCommand(){model.controller.cmdMgr.execute({execute:function(){this.submit({act:"toggleDatasetServeMode",dsid:dsid,dsm:mode},model.controller.getRefreshCallback(),{style:{params:{treesToRender:3}}});},urInfo:{callback:model.controller.getRefreshCallback()}});}function checkCredentials(){docModel.getDataService().checkMissingCredentials({dsid:dsid},{success:function(res){if(res.success){executeCommand();}else{mstrmojo.confirm(mstrmojo.desc(14396,"Some credentials are missing for the selected dataset. You will have to enter these credentials in order to proceed. Do you want to continue?"),{confirmBtn:{fn:function(){window.setTimeout(function(){if(dsPanel&&dsPanel.showDataImport){dsPanel.showDataImport({documentModel:res,StatusCode:4,callback:function(){checkCredentials();}});}},0);return true;}},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:mstrmojo.emptyFn}},{title:mstrmojo.desc(1695,"Warning")});}},failure:function(res){mstrmojo.alert(res);}});}if(mstrApp.isSingleTier){checkCredentials();}else{executeCommand();}}};return function(){model.warnForEditStandaloneDS(dataset,executeToggleServeMode);};}return function DataAccessModelSubMenu(){var cfg=new mstrmojo.ui.menus.MenuConfig();cfg.addMenuItem(mstrmojo.desc(11921,"In-Memory"),dataset.dsm===DSM.IN_MEMORY?"on":"",toggleDatasetServeMode(DSM.IN_MEMORY));cfg.addMenuItem(mstrmojo.desc(12726,"Connect Live"),dataset.dsm===DSM.DIRECT_ACCESS?"on":"",toggleDatasetServeMode(DSM.DIRECT_ACCESS));return cfg;};}function datasetSaveAs(params,callback,datasetPanel){var action={act:"datasetSaveAs",managed:params.managed,nonDelta:true,dsID:params.dsID,rptName:params.rptName,rptDesc:params.rptDesc,saveAsOverwrite:params.saveAsOverwrite};if(!params.managed){action.folderID=params.folderID;}datasetPanel.model.getDataService().submitUpdates([action],$FUNC.wrapMethods(datasetPanel.model.getDatasetsUpdateCallback(),callback),{config:{showProgress:true,hideProgress:true,progressStateText:[mstrmojo.desc(8445,"Loading")],silent:true}});}function getShowDatasetSaveasEditorFunc(datasetPanel,dsid){var id="mstrIVE_DS_SAVER";return function ShowDatasetSaveasEditor(){var editor=mstrmojo.all[id];if(!dsid){return ;}if(!editor){editor=new mstrmojo.SaveAsEditor({id:id,folderLinksContextId:32,showCompletePath:false,saveParams:{},saveAs:function(overwrite){var panel=this.contPanel;this.name=panel.name.value;this.desc=panel.desc.value;if(!this.name){mstrmojo.alert(mstrmojo.desc(3380,"Please enter valid name"));return ;}var params=this.saveParams||{};params.managed=false;params.folderID=this.ob.currentFolder.did;params.rptName=this.name||"";params.rptDesc=this.desc||"";params.saveAsOverwrite=!!overwrite;var saveAsCB=this.saveAsCallback();saveAsCB.failure=function(res){var ec=res.code,p=this.parent;if(ec==="-2147217373"||ec==="-2147216857"){$WARN(mstrmojo.desc(7986,"The ## '###' already exists. Do you want to replace the existing one?").replace("##",p.typeDesc||"Object").replace("###",p.name),{confirmBtn:{fn:function(){p.saveAs(true);}}},{title:mstrmojo.desc(3179,"Confirm Overwrite")});}else{if(ec==="-2147202302"){mstrmojo.alert(mstrmojo.desc(11642,"Cannot save report ## to overwrite report ###, because report #### is also used by the document.").replace("##",datasetPanel.data[dsid].name).replace("###",p.name).replace("####",p.name),null,mstrmojo.desc(11643,"Dataset Overwrite Error"));}else{mstrmojo.alert(mstrmojo.desc(7985,"Error while saving: ")+res.message);}}};saveAsCB.complete=$FUNC.wrapMethods(saveAsCB.complete,function(){mstrApp.hideWait();});saveAsCB.parent=this;datasetSaveAs(params,saveAsCB,datasetPanel);mstrApp.showWait({message:mstrmojo.desc(10492,"Saving...")});editor.close();}});editor.render();}editor.saveParams.dsID=dsid;editor.open();};}function addShowTableRowCountMenuItem(menuConfig,docModel,dataset){var tablesInfo=dataset.tables.map(function(table){var metricRef=table.mxRefs[$ARR.find(table.mxRefs,"rm",true)],metric=metricRef&&dataset.mx[$ARR.find(dataset.mx,"did",metricRef.did)];return $HASH.copy(table,{rowCountMetric:metric});}).filter(function(tableInfo){return tableInfo.rowCountMetric&&tableInfo.rowCountMetric.hide;});if(!tablesInfo.length){return ;}var subMenuConfig=new mstrmojo.ui.menus.MenuConfig();tablesInfo.forEach(function(tableInfo){subMenuConfig.addMenuItem(tableInfo.n,"",function(){var actions=[docModel.getToggleHiddenObjectAction(dataset.did,tableInfo.rowCountMetric,false)];var callback=docModel.getDatasetsUpdateCallback();docModel.controller.cmdMgr.execute({execute:function(){this.submit(actions,callback,onlyDefExtras);},urInfo:{callback:callback}});});});menuConfig.addSubMenuItem(mstrmojo.desc(13228,"Show Row Count"),"",null,function(){return subMenuConfig;});}function getVisibleDatasets(){var result=[];$ARR.forEach(this.contents.children,function(item){if(item.visible){result.push(item);}});return result;}function getRefreshDatasetFunc(datasetPanel,did){return function(){var docModel=datasetPanel.model;docModel.getDataService().submitUpdates([{act:"refreshReport",dsID:did}],docModel.controller.getRefreshCallback());};}function getAdvRefreshDatasetFunc(datasetPanel,dsid,dataset){return function(){var model=datasetPanel.model;function showDataImport(missingCredentialsData){datasetPanel.showDataImport({AnalysisId:model.mid,ReportId:dsid,CubeName:dataset.name,CubeDesc:dataset.dsc,isManagedCube:dataset.mngd,StatusCode:2,missingCredentialsData:missingCredentialsData});}function checkCredentials(){model.getDataService().checkMissingCredentials({dsid:dsid},{success:function(res){if(res.success){showDataImport();}else{showDataImport(res);}},failure:function(res){mstrmojo.alert(res);}});}if(mstrApp.isSingleTier){checkCredentials();}else{showDataImport();}};}function updateUseTableView(){var dsoSettings=this.settings;this.set("useTableView",!!(dsoSettings&&dsoSettings.useTableView));}function checkAllDatasetsExpandedOrCollapsed(menuFlag){var dsoSettings=this.settings,hasSingleDataset=(this.contents.children||[]).length===1;if(menuFlag){if(hasSingleDataset){var singleChild=this.contents.children[0],view=singleChild.tableView||singleChild.mdxView;return view&&view.setting.hasCollapsedChildNodes(false,false);}else{return(this.contents.children||[]).some(function(child){var dsInfo=dsoSettings.dataset(child.did);return dsInfo.getCollapsed()===false;});}}else{return(this.contents.children||[]).some(function(child){var dsInfo=dsoSettings.dataset(child.did),view=child.tableView||child.mdxView;if(dsInfo.getCollapsed()===true){return true;}else{return view&&view.setting&&view.setting.hasCollapsedChildNodes(true,true);}});}}function adjustPosition4AOB(isOpen){var bns=this.browserNode.style,bnTop=isOpen?(ALL_OBJ_BROWSER_TOP+"px"):((parseInt(this.height,10)-ALL_OBJ_BROWSER_HEIGHT)+"px");bns.top=bnTop;}function adjustSize4AOB(isOpen){var bns=this.browserNode.style,ob=this.objectBrowser&&this.objectBrowser.domNode,bnHeight=isOpen?((parseInt(this.height,10)-ALL_OBJ_BROWSER_TOP)+"px"):(ALL_OBJ_BROWSER_HEIGHT+"px");bns.height=bnHeight;if(ob){ob.style.height=bnHeight;if(isOpen){this.objectBrowser.height=bnHeight;this.objectBrowser.doLayout();}ob.style.overflow=isOpen?"":"hidden";}}function adjustVisibility4AOB(){var ob=this.objectBrowser&&this.objectBrowser.domNode,visText;if(ob){visText=shouldShowAllObjectBrowser.call(this)&&!this.model.hasMDXRADataset()?"":"hidden";ob.style.visibility=visText;}}function shouldShowAllObjectBrowser(){return mstrApp.isSingleTier||(allowMultipleWorkingsets()&&this.model.isSchemaDefined()&&this.model.allowNewOrEditDummyDS());}function toggleAOB(isOpen){var me=this,switchClass=function(className){$CSS.removeClass(me.browserNode,["opened","toggling"]);$CSS.addClass(me.browserNode,className);},adjustDSPanel=function(isOpen){$CSS.toggleClass(me.searchNode,"allObjOpened",isOpen);$CSS.toggleClass(me.dividerNode,"allObjOpened",isOpen);};if(isOpen){switchClass("toggling");adjustPosition4AOB.call(me,true);adjustSize4AOB.call(me,true);setTimeout(function(){switchClass("opened");adjustDSPanel.call(me,true);},500);}else{switchClass("toggling");adjustPosition4AOB.call(me,false);adjustDSPanel.call(me,false);setTimeout(function(){$CSS.removeClass(me.browserNode,["opened","toggling"]);adjustSize4AOB.call(me,false);},500);}}mstrmojo.vi.ui.DocDatasetObjects=mstrmojo.declare(mstrmojo.vi.ui.DatasetObjects,[mstrmojo.util.ui._HostsSplitter,mstrmojo.vi.ui.toolbars._HasToolbar],{scriptClass:"mstrmojo.vi.ui.DocDatasetObjects",cssClass:"mstrmojo-VIDocDatasetObjects",datasetUnitListScriptClass:"mstrmojo.vi.ui.DocDatasetUnitList",settings:null,allObjectBrowserOpened:false,loadOBDataprovider:function(callback){var dsPanel=mstrApp.rootCtrl.datasetsPanel;dsPanel.model.controller.rootCtrl.loadDataProvider(function(dataProvider){dsPanel.objectBrowser.set("dataProvider",dataProvider);callback();});},onLogout:function(sessionState){var controller=mstrApp.rootCtrl,dsPanel=controller.datasetsPanel,ob=dsPanel.objectBrowser,dpSession=ob.dataProvider&&ob.dataProvider.sessionState;if(!sessionState||(dpSession&&dpSession===sessionState)){controller.set("dataProvider",null);ob.set("dataProvider",null);dsPanel.set("allObjectBrowserOpened",false);}},onallObjectBrowserOpenedChange:function(){var dsPanel=mstrApp.rootCtrl.datasetsPanel,openAllObjectFunc=function(isOpen){dsPanel.objectBrowser.set("opened",isOpen);toggleAOB.call(dsPanel,isOpen);};if(dsPanel.allObjectBrowserOpened){openAllObjectFunc(true);}else{if(dsPanel.objectBrowser){openAllObjectFunc(false);}}},clickOnCollapsibleTitleBar:function(){if(this.allObjectBrowserOpened){this.set("allObjectBrowserOpened",false);}},init:function init(props){this._super(props);this.model.attachEventListener("updateUseTableView",this.id,function(){updateUseTableView.call(this);});updateUseTableView.call(this);},onsettingsChange:function(){updateUseTableView.call(this);},widgetResized:function(){if(this.browserNode){adjustPosition4AOB.call(this,this.allObjectBrowserOpened);adjustSize4AOB.call(this,this.allObjectBrowserOpened);adjustVisibility4AOB.call(this);}this._super();},toggleAllObjectsBrowser:function toggleAllObjectsBrowser(){if(!this.allObjectBrowserOpened){if(mstrApp.browseAllObjects===false){mstrmojo.alert(mstrmojo.desc(14332,"You do not have the privileges to browse the objects in this project."));}else{this.set("allObjectBrowserOpened",!this.allObjectBrowserOpened);}}else{this.set("allObjectBrowserOpened",!this.allObjectBrowserOpened);}},getLinksForEmptyData:function getImportDataBoxChildren(){var isOneTierApp=mstrApp.isSingleTier;var linkNewReport={scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13570,"Create New Report"),onclick:function(){this.model.controller.createDataset();}.bind(this)},linkExistDataset={scriptClass:"mstrmojo.Label",text:isOneTierApp?mstrmojo.desc(14306,"Add Dataset from Server"):mstrmojo.desc(13571,"Add Existing Dataset"),onclick:function(){this.model.controller.addDataset();}.bind(this)},linkCube={scriptClass:"mstrmojo.Label",text:isOneTierApp?mstrmojo.desc(14306,"Add Dataset from Server"):mstrmojo.desc(13571,"Add Existing Dataset"),onclick:function(){this.model.controller.openCubeBrowser();}.bind(this)},linkImport={scriptClass:"mstrmojo.Label",text:isOneTierApp?mstrmojo.desc(14305,"Add New Data"):mstrmojo.desc(13836,"Add External Data"),onclick:function(){this.model.controller.importFile();}.bind(this)},linkSchema={scriptClass:"mstrmojo.Label",text:isOneTierApp?mstrmojo.desc(14307,"Browse Objects on Server"):mstrmojo.desc(14082,"Add Existing Schema"),onclick:function(){var me=this;this.loadOBDataprovider(function(){if(mstrApp.browseAllObjects===false){mstrmojo.alert(mstrmojo.desc(14332,"You do not have the privileges to browse the objects in this project."));}else{me.set("allObjectBrowserOpened",true);}});}.bind(this)},linkAllObjects={scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13941,"Browse All Objects"),onclick:function(){var me=this;this.loadOBDataprovider(function(){if(mstrApp.browseAllObjects===false){mstrmojo.alert(mstrmojo.desc(14332,"You do not have the privileges to browse the objects in this project."));}else{me.set("allObjectBrowserOpened",true);}});}.bind(this)},children=[];if(this.model.allowImportData()){children.push(linkImport);}if(mstrApp.isSingleTier){children.push(linkCube);children.push(linkSchema);}else{if(this.model.allowNewOrEditRolapDS()&&this.model.isSchemaDefined()){children.push(linkNewReport);}if(this.model.allowManageDocumentDataset()){children.push(linkExistDataset);}if(shouldShowAllObjectBrowser.call(this)){children.push(linkAllObjects);}}return children;},getDatasetTableView:function getDatasetTableView(dataset,dsid){var me=this,dsoSettings=this.settings;return mstrmojo.mixin({setting:dsoSettings.dataset(dsid),onTableCollapsedChange:function(tableId,isCollapsed){this._super();if(!me.isSearching){this.setting.table(tableId).isCollapsed=isCollapsed;me.saveSettings();}}},this._super(dataset,dsid));},getDatasetMDXView:function getDatasetMDXView(dataset,dsid){var me=this,tableId=dataset.tables&&dataset.tables[0]&&dataset.tables[0].did;return mstrmojo.mixin({setting:this.settings.dataset(dsid).table&&this.settings.dataset(dsid).table(tableId),onNodeCollapsedChange:function(node){this._super();if(!me.isSearching){node.setting.isCollapsed=node.isCollapsed;me.saveSettings();}}},this._super(dataset,dsid));},getDatasetPortlet:function getDatasetPortlet(dataset,dsid,panel,panelId){var me=this,model=me.model,panelConfig=this._super(dataset,dsid,panel,panelId),isReportCube=dataset.st===776,isEmmaDataCube=dataset.st===779,setting=this.settings&&this.settings.dataset(dsid);$HASH.copy({isCollapsed:setting?!!(setting.getCollapsed()):false,onclick:function(evt){var tgt=evt.getTarget(),pp=this;if(mstrmojo.dom.contains(pp.titleBar.leftToolNode,tgt,true,pp.domNode)){me.updateScrollbars();if(!me.isSearching){submitDatasetsCollapsed([{dsid:pp.did,isCollapsed:pp.isCollapsed}],panel);}}},addMenuItems:function addMenuItems(cfg){cfg.hostId=this.id;cfg.isHostedWithin=false;if(!(model.isMDXDataset(dataset)&&!isEmmaDataCube)&&!isReportCube&&dataset.rt!==8&&isDownLoadDatasetEditable(dataset)&&((isEmmaDataCube&&model.hasPrivilegesForAllTables(dataset.tables))||(!isEmmaDataCube&&((!dataset.idd&&!dataset.mngd&&model.allowManageDocumentDataset())||(!dataset.idd&&dataset.mngd&&model.allowNewOrEditRolapDS())||(dataset.idd&&model.allowNewOrEditDummyDS()))))){cfg.addMenuItem(mstrmojo.desc(11923,"Edit Dataset..."),"",function(){var controller=model.controller,confirmEdit=function(okFn){mstrmojo.confirm(mstrmojo.desc(13955,"Re-running this report may take some time. Do you want to run it anyway?"),{confirmBtn:{t:mstrmojo.desc(13954,"Run"),fn:okFn},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:mstrmojo.emptyFn}},{title:mstrmojo.desc(1695,"Warning")});},rolapDatasetEditorCfg={dataset:$HASH.clone(dataset),docModel:model,title:mstrmojo.desc(13362,"Report Editor")+" - "+dataset.name,okBtnText:mstrmojo.desc(13954,"Run"),onOk:function(actions){var refreshCallBack=controller.getRefreshCallback();if(actions.length){confirmEdit(function(){controller.cmdMgr.execute({execute:function(){this.submit(actions,refreshCallBack);},urInfo:{callback:refreshCallBack}});});}}},emmaCubeDatasetEditorCfg={isEdit:true,isNewAnalysis:false,isManagedCube:dataset.mngd,AnalysisId:model.mid,ReportId:dsid,CubeName:dataset.name,CubeDesc:dataset.dsc,StatusCode:1,needDefn:true};if(!dataset.mngd){$WARN(mstrmojo.desc(13363,"Editing this dataset will immediately affect other documents and dashboards that share the dataset.  Do you want to edit the stand-alone dataset or keep your changes local to this dashboard?"),{},{buttons:[mstrmojo.Button.newWebButton(mstrmojo.desc(1442,"OK"),function(){if(isEmmaDataCube){me.showDataImport(emmaCubeDatasetEditorCfg);}else{var editCfg=$HASH.copy(rolapDatasetEditorCfg);editCfg.onOk=function(actions){if(actions.length){confirmEdit(function(){model.getDataService().submitUpdates(actions,model.controller.getRefreshCallback());});}};panel.openDatasetEditor(editCfg);}}),mstrmojo.Button.newWebButton(mstrmojo.desc(2140,"Cancel"),mstrmojo.emptyFn),mstrmojo.Button.newWebButton(mstrmojo.desc(13364,"Keep Changes Local"),function(){var oldDatasets=model.datasets,convertDatasetActions={act:"convertDatasetToManaged",dsID:dsid};if(isEmmaDataCube){executeDynamic.call(me,function(){var cmd=controller.cmdMgr.getInterimCmd();cmd.urInfo.callback=controller.model.getDatasetsUpdateCallback();cmd.submitInterim(convertDatasetActions,{success:function(res){var newManagedDataset=null,newDatasetId=null;$HASH.forEach(res.datasets,function(datasetItem,datasetId){if(!oldDatasets[datasetId]){newManagedDataset=datasetItem;newManagedDataset.did=newDatasetId=datasetId;return false;}});me.showDataImport({isEdit:true,isNewAnalysis:false,isManagedCube:newManagedDataset.mngd,AnalysisId:model.mid,ReportId:newDatasetId,CubeName:newManagedDataset.name,CubeDesc:newManagedDataset.dsc,StatusCode:1,callback:function(datasets){var cmdMgr=me.model.cmdMgr(),interimCmd=cmdMgr.getInterimCmd();if(datasets){var refreshCallback=me.model.controller.getRefreshCallback();interimCmd.urInfo.callback=refreshCallback;interimCmd.resetCmdMgrOnComplete();interimCmd.submit([],refreshCallback,null,cmdMgr.CMD_PHASE.LAST);}else{var urInfo=interimCmd.urInfo;urInfo.callback={success:mstrmojo.emptyFn};urInfo.treesToRender=0;interimCmd.cancel();}}});}});});}else{panel.openDatasetEditor($HASH.copy(rolapDatasetEditorCfg,{modifiedItems:{convert:convertDatasetActions,add:[],del:[],fs:{add:[],del:[]},filter:null}}));}},true)]});}else{if(isEmmaDataCube){me.showDataImport(emmaCubeDatasetEditorCfg);}else{panel.openDatasetEditor(rolapDatasetEditorCfg);}}});}if(dataset.dsm===DSM.IN_MEMORY&&!model.isMDXDataset(dataset)){if(!dataset.tables||dataset.tables.length===1){cfg.addMenuItem(mstrmojo.desc(13537,"Show Data..."),"shwd",function(){mstrmojo.vi.ui.ViewDataDialog.openDS(model,dataset,dsid);});}else{cfg.addPopupMenuItem(mstrmojo.desc(11476,"Show Data"),"",function(){var subMenuCfg=new mstrmojo.ui.menus.MenuConfig(),tables=dataset.tables;tables.forEach(function(tb,ix){subMenuCfg.addMenuItem(tb.n,"",function(){mstrmojo.vi.ui.ViewDataDialog.openDSTable(model,dataset,dsid,ix);});});return subMenuCfg;});}}cfg.addSubMenuItem(mstrmojo.desc(4571,"Join Behavior"),"",this.id,function(){return setJoinBehavior(model,dataset);});cfg.addSeparator();if(!model.isDataImportRemoteDataSource(dataset)||mstrApp.isSingleTier){if(dataset.hcs){if(dataset.idd!==true){cfg.addMenuItem(mstrmojo.desc(773,"Refresh"),"",function(){replaceOneTierCube(panel,panel.model,dataset,dsid,dataset.dsm);});}}else{if((dataset.rt===1&&model.allowReExecuteRegularReport())||(dataset.rt===8&&model.allowReExecuteViewReport())){cfg.addMenuItem(mstrmojo.desc(13609,"Re-run Report..."),"",function(){mstrmojo.confirm(mstrmojo.desc(13955,"Re-running this report may take some time. Do you want to run it anyway?"),{confirmBtn:{t:mstrmojo.desc(13954,"Run"),fn:getRefreshDatasetFunc(panel,dataset.did)},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:mstrmojo.emptyFn}},{title:mstrmojo.desc(2914,"Warning")});});}else{if(isReportCube&&model.allowManageDocumentDataset()&&model.allowReExecuteCubeReport()&&!dataset.localbin){cfg.addMenuItem(mstrmojo.desc(13610,"Republish Cube..."),"",function(){mstrmojo.confirm(mstrmojo.desc(13956,"Publishing time depends on your dataset. Are you sure you want to republish?"),{confirmBtn:{t:mstrmojo.desc(13953,"Republish"),fn:getRefreshDatasetFunc(panel,dataset.did)},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:mstrmojo.emptyFn}},{title:mstrmojo.desc(2914,"Warning")});});}else{if(isEmmaDataCube&&dataset.sda!==SDA.SupportDDAOnly&&dataset.dsm!==DSM.DIRECT_ACCESS&&model.allowManageDocumentDataset()&&model.allowReExecuteCubeReport()&&model.hasPrivilegesForAllTables(dataset.tables)){cfg.addMenuItem(mstrmojo.desc(13610,"Republish Cube..."),"",getAdvRefreshDatasetFunc(panel,dsid,dataset));}}}}}if(dataset.sda===SDA.SupportDDAOrInMemory&&dataset.rt===7&&model.allowManageDocumentDataset()&&dataset.acg&$ACG.DssAccessRightWriteFlag){cfg.addSubMenuItem(mstrmojo.desc(11922,"Data Access Mode"),"",this.id,getDataAccessModelSubMenu(panel,dataset,dsid,model));}if((allowMultipleWorkingsets()||me.getDatasetCount()>1)&&model.allowManageDocumentDataset()&&!(this.mdxView&&this.mdxView.docModel.isDatasetHasRecursiveAttribute(this.dataset))){cfg.addSubMenuItem(mstrmojo.desc(11484,"Replace Dataset with"),"",this.id,getReplaceDatasetMenuHandler(panel));}cfg.addSeparator();if(isEmmaDataCube&&this.useTableView){addShowTableRowCountMenuItem(cfg,model,dataset);}cfg.addMenuItem(mstrmojo.desc(13624,"Create Metric..."),"",insertNewMetric.call(this,this.did,model));if(!(model.isMDXDataset(dataset)&&model.isDDADataset(dataset))&&!$DUMU.hasCGorCon(dataset)){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",insertNewDerivedAttr.call(this,this.did,me.data));}cfg.addSeparator();if(!mstrApp.isSingleTier&&!dataset.idd&&model.allowSaveDataset()){if(((dataset.att||[]).length+(dataset.mx||[]).length)>0){cfg.addMenuItem(mstrmojo.desc(13239,"Save Dataset..."),"",getShowDatasetSaveasEditorFunc(panel,this.did));}}if(dataset.mngd&&model.allowManageDocumentDataset()){if(((dataset.att||[]).length+(dataset.mx||[]).length)>0){if(!(mstrApp.isSingleTier&&dataset.hcs&&!dataset.idd)){cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"rnm",function(){this.ctxt.titleBar.editTitle();},this);}}}if(model.allowManageDocumentDataset()){cfg.addMenuItem(mstrmojo.desc(629,"Delete"),"",removeDataset(this.parent.parent,this.did));}if(panel.gridSource===this.did){cfg.addToolbarBtn(mstrmojo.desc(11647,"This is the primary dataset."),"default-set",mstrmojo.emptyFn);}var highlight=$DUMU.getHighlightElementHandler;cfg.addPopupHandlers(this.id,highlight(true,this.titlebarNode),highlight(false,this.titlebarNode));if(isEmmaDataCube&&model.allowManageDocumentDataset()&&model.hasPrivilegesForAllTables(dataset.tables)){var tables=dataset.tables;if(tables&&tables.length>1&&!(mstrApp.isSingleTier&&dataset.dsm===DSM.DIRECT_ACCESS)){cfg.addSubMenuItem(mstrmojo.desc(11924,"Delete Table"),"","",function(){var subMenuCfg=new mstrmojo.ui.menus.MenuConfig();tables.forEach(function(tb){subMenuCfg.addMenuItem(tb.n,"",function(){var deleteEMMATable=function(){model.warnForEditStandaloneDS(dataset,function(){model.getDataService().submitUpdates({act:"deleteEMMATable",dsid:dsid,tbid:tb.did},$FUNC.override({success:function(res){this._super.call(model,res);model.controller.cmdMgr.reset();}},model.controller.getRefreshCallback()));});};if(mstrApp.isSingleTier&&dataset.hcs){disconnectDataset(dataset,dsid,model,true,{success:function(){deleteEMMATable();}});}else{deleteEMMATable();}});});return subMenuCfg;});}}return cfg;}},panelConfig);return panelConfig;},getDatasetTitleBarCfg:function(datasetPortlet){var cfg=this._super(datasetPortlet),me=this,dataset=datasetPortlet.dataset;$HASH.copy({editTitleOnDoubleClick:me.model.allowManageDocumentDataset()&&!!dataset.mngd&&((dataset.att||[]).length+(dataset.mx||[]).length)>0,useRichTooltip:true,titleEdited:function titleEdited(titleText,textChanged,oldText){if(textChanged){var fnCancel=function(){datasetPortlet.titleBar.set("title",oldText);},fnOk=function(){me.model.renameDataset(datasetPortlet.did,titleText.trim(),$FUNC.wrapMethods(me.model.getDatasetsUpdateCallback()),{failure:function(err){mstrApp.onerror(err);datasetPortlet.titleBar.set("title",oldText);}});};var duplicateDatasetName=false;$HASH.forEach(me.model.datasets,function(v){if(v.name===titleText.trim()){duplicateDatasetName=true;return false;}});if(duplicateDatasetName){$WARN(mstrmojo.desc(13365,"Another dataset with same name exists. Do you want to keep this name?"),{},{buttons:[mstrmojo.Button.newWebButton(mstrmojo.desc(1442,"OK"),function(){$DUMU.validateName(titleText,fnOk,fnCancel);},true),mstrmojo.Button.newWebButton(mstrmojo.desc(2140,"Cancel"),function(){fnCancel();})]});}else{$DUMU.validateName(titleText,fnOk,fnCancel);}}},updateTooltipConfig:function updateTooltipConfig(evt){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e);if((target.scrollWidth<=target.clientWidth)&&!this.getDatasetConnectivityTooltipText()){this.richTooltip=null;}else{var position=$DOM.position(this.domNode);this.richTooltip={content:this.getTooltipContent(evt),posType:mstrmojo.tooltip.POS_TOPLEFT,cssClass:"vi-regular vi-tooltip-C",top:position.y-2,left:position.x+position.w+6};}},shouldShowTooltip:function(evt,win){var f=this._super(evt,win);f=f||!!this.getDatasetConnectivityTooltipText();return f;},getTooltipContent:function getTooltipContent(evt){var target,content="",connectivityTooltip=this.getDatasetConnectivityTooltipText();target=evt.target||$DOM.eventTarget(evt.hWin,evt.e);if(target.scrollWidth>target.clientWidth){content=this.constructor.prototype.getTooltipContent.call(this,evt);}if(!!connectivityTooltip){content=content+" "+connectivityTooltip;}return content;},getDatasetConnectivityTooltipText:function getDatasetConnectivityTooltipText(){var ds=datasetPortlet.dataset,connectivityTooltip=function(tooltip){return"<span class = 'dataset-connection-status-tooltip'>"+tooltip+"</span>";};if(mstrApp.isSingleTier){if(!ds.hcs&&!ds.connInfo){if(ds.dsm==2){return connectivityTooltip(mstrmojo.desc(13575,"(Live)"));}}else{if(!!ds.hcs&&!!ds.connInfo){if(ds.dsm==2&&(ds.sdsm==1||ds.sdsm==2)){return connectivityTooltip(mstrmojo.desc(14400,"Live (Server)"));}}}}else{if(ds.dsm===2){return connectivityTooltip(mstrmojo.desc(13575,"(Live)"));}}return null;}},cfg);return cfg;},saveSettings:function(){if(this.settings){this.settings.save();this.generateToolbar();}},ongridSourceChange:function(){this._super();var me=this,updateToolbar=function(){$HASH.forEach(me.data,function(ds,did){var portlet=me.getDatasetPanel(did);if(portlet){portlet.generateToolbar();}});};if(this.visible){updateToolbar();}else{if(!this.updateToolbarHandle){this.updateToolbarHandle=this.attachEventListener("showPanel",this.id,function(){me.updateToolbarHandle.clear();delete me.updateToolbarHandle;updateToolbar();});}}},handleNode:null,unit:null,gridSource:null,postBuildRendering:function postBuildRendering(){var handleNode=this.handleNode;handleNode.style.display="block";this.registerSplitter(handleNode);return this._super();},setDimensions:function setDimensions(h,w){this._super(h,w);var handleNode=this.handleNode,handleStyle=handleNode&&handleNode.style;if(handleStyle){handleStyle.top=0;handleStyle.left=w;handleStyle.height=h;handleStyle.width="6px";}},getSplitterInfo:function getSplitterInfo(){return{min:120,max:Math.max(parseInt(this.parent&&this.parent.width,10)/2,330)};},postCreate:function postCreate(){var min=this.getSplitterInfo().min,halfWindowWidth=$DOM.windowDim().w/2;if(parseInt(this.width,10)<min){this.set("width",min);}if((halfWindowWidth>=min&&parseInt(this.width,10)>halfWindowWidth)||parseInt(this.width,10)>2000){this.set("width","168px");}},initChildren:function(){if(shouldShowAllObjectBrowser.call(this)){var me=this;this.layoutConfig=$HASH.clone(this.layoutConfig);this.children.push({scriptClass:"mstrmojo.vi.ui.AllObjectsBrowser",alias:"objectBrowser",slot:"browserNode",model:this.model,bindings:{opened:"this.parent.allObjectBrowserOpened"},close:function(){if(!me.allObjectBrowserOpened){if(this.dataProvider===null||this.dataProvider!==mstrApp.rootCtrl.dataProvider){this.reset();}me.loadOBDataprovider(function(){if(mstrApp.browseAllObjects===false){mstrmojo.alert(mstrmojo.desc(14332,"You do not have the privileges to browse the objects in this project."));}else{me.set("allObjectBrowserOpened",true);}});}else{me.set("allObjectBrowserOpened",false);}}});this.layoutConfig.h.browserNode="30px";this.layoutConfig.w.browserNode="100%";}this._super();},splitterMoved:function splitterMoved(position){var prop="width",value=parseInt(this[prop],10)+position;this.set(prop,value+"px");this.parent.doLayout();this.getPanelSaver().saveProperty("size",value);},passToolbarCfg:function passToolbarCfg(cfg){var existingToolbarCfg=this.titleBar.toolbarCfg;if(existingToolbarCfg){existingToolbarCfg.destroy();}this.titleBar.set("toolbarCfg",cfg);},updateToolbar:function updateToolbar(cfg){var isOneTierApp=mstrApp.isSingleTier;var id=this.id,me=this,datasets=this.contents.children,visibleDatasets=getVisibleDatasets.call(this),addDatasetLabel=(isOneTierApp)?mstrmojo.desc(14305,"Add New Data"):mstrmojo.desc(11780,"Add Data");cfg.hostId=this.id;cfg.isHostedWithin=false;if(isOneTierApp&&me.model.allowImportData()){cfg.addPopupMenuItem(addDatasetLabel,id,function(){var cfg=new mstrmojo.ui.menus.MenuConfig();cfg.addMenuItem(mstrmojo.desc(14303,"New Data..."),"",getOpenImportDataMenu.call(me));cfg.addMenuItem(mstrmojo.desc(14304,"Dataset from Server..."),"",function(){mstrApp.rootCtrl.openCubeBrowser();});return cfg;},"");}else{if(me.model.allowManageDocumentDataset()&&!me.model.hasMDXRADataset(me.model.datasets)){cfg.addPopupMenuItem(addDatasetLabel,id,getAddDatasetMenu(me),"");}}if((allowMultipleWorkingsets()||me.getDatasetCount()>1)&&me.model.allowManageDocumentDataset()&&!me.model.hasMDXRADataset()){cfg[(me.getDatasetCount()>0)?"addSubMenuItem":"addDisabledMenuItem"](mstrmojo.desc(11485,"Replace All Datasets"),"",this.id,getReplaceDatasetMenuHandler(me,true));}cfg.addSeparator();if(hasHiddenObjects(me.model)){cfg.addEditorMenuItem(mstrmojo.desc(11612,"Show Hidden Objects"),this.id,function(){return showHiddenObjects(me.model);});}cfg.addSeparator();var hasMultiTableDatasets=$HASH.valarray(me.data).some(function(dataset){return dataset.tables&&dataset.tables.length>1;});var hasMultiMDXNodes=$HASH.valarray(me.data).some(function(dataset){if(me.model.isMDXDataset(dataset)){var table=dataset.tables[0];return(table.dimensions&&table.dimensions.length>0)||(table.metricFolder&&table.metricFolder.folders&&table.metricFolder.folders.length>0);}return false;});if(hasMultiTableDatasets){cfg.addSeparator();cfg.addRadioMenuGroup(!!me.settings.useTableView,function(v){var dsoSettings=me.settings;dsoSettings.useTableView=v;me.model.raiseEvent({name:"updateUseTableView",useTableView:v});me.saveSettings();},[{value:false,text:mstrmojo.desc(11925,"Flat View")},{value:true,text:mstrmojo.desc(11926,"Table View")}],"",null,true);}if(datasets&&(datasets.length>1||(hasMultiTableDatasets&&me.settings.useTableView)||hasMultiMDXNodes)){cfg.addSeparator();var enableExpandAll=true,enableCollapseAll=true;if(visibleDatasets.length<datasets.length){enableExpandAll=false;enableCollapseAll=false;}else{enableExpandAll=checkAllDatasetsExpandedOrCollapsed.call(me,false);enableCollapseAll=checkAllDatasetsExpandedOrCollapsed.call(me,true);}if(!enableExpandAll){cfg.addDisabledMenuItem(mstrmojo.desc(11816,"Expand All"),"expand-all");}else{cfg.addMenuItem(mstrmojo.desc(11816,"Expand All"),"expand-all",function(){me.toggleAllNodesCollapsed(false,true);});}if(!enableCollapseAll){cfg.addDisabledMenuItem(mstrmojo.desc(11817,"Collapse All"),"collapse-all");}else{cfg.addMenuItem(mstrmojo.desc(11817,"Collapse All"),"collapse-all",function(){me.toggleAllNodesCollapsed(true,true);});}}cfg.addSeparator();cfg.addMenuItem(mstrmojo.desc(1143,"Help"),"help",function(){mstrApp.showHelpTopic("dashboard_editor_dataset_panel.htm");});return cfg;},getShowDatasetPicker:function(){var me=this;return function(){var editor=getDatasetPicker({id:"mstrIVE_DS",multiSelect:true,onOk:function(){executeDynamic.call(me,function(){me.model.addDataset(editor.selectedItems);});}});editor.open();};},openDatasetEditor:function(props){if(mstrApp.isSingleTier&&(mstrApp.browseAllObjects===false)){mstrmojo.alert(mstrmojo.desc(14332,"You do not have the privileges to browse the objects in this project."));return ;}var controller=props.docModel.controller,me=this,config=$HASH.copy(props,{onOk:function(actions){var refreshCallBack=$FUNC.wrapMethods(controller.getRefreshCallback(),{success:function(){me.set("allObjectBrowserOpened",false);}});if(actions.length){controller.cmdMgr.execute({execute:function(){this.submit(actions,refreshCallBack,{style:{params:{treesToRender:3}}});},urInfo:{callback:refreshCallBack}});}}});this.model.controller.rootCtrl.loadDataProvider(function(dataProvider){config.dataProvider=dataProvider;var editor=new mstrmojo.vi.ui.DatasetEditor(config);me.datasetEditorId=editor.id;editor.open();});},onDatasetFilterChange:function(datasetId){if(datasetId&&this.settings.dataset(datasetId).isCollapsed){submitDatasetsCollapsed([{dsid:datasetId,isCollapsed:false}],this);}this.generateToolbar();this.updateScrollbars();},showDataImport:function showDataImport(config){config.hasNonRADataset=this.model.hasNonRADataset();var di;if(this.dataImportId){di=mstrmojo.all[this.dataImportId];}if(!di){di=mstrmojo.insert(mstrmojo.DI.DIContainer);}this.dataImportId=di.id;var me=this,openDI=function(){$HASH.copy(config,di.dataImportParams);di.open();};if(config.callback){di.dataImportCallback=function(datasets){config.callback(datasets);};openDI();}else{di.dataImportCallback=function(datasets){var newStandAloneDS=[],cmdMgr=me.model.cmdMgr(),interimCmd=cmdMgr.getInterimCmd();if(datasets){newStandAloneDS=(datasets||[]).filter(function(ds){return !me.model.datasets[ds.did]&&!ds.mngd;});if(newStandAloneDS.length){me.model.addDataset(newStandAloneDS,{success:function(){interimCmd.completeSubmit();}});}else{var refreshCallback=$FUNC.wrapMethods(me.model.controller.getRefreshCallback(),{success:function(){me.set("allObjectBrowserOpened",false);}}),extras=config.needDefn?mstrmojo.DocDataService.REQUEST_DEFN_DATA:null;interimCmd.urInfo.callback=refreshCallback;if(!mstrApp.isSingleTier){interimCmd.resetCmdMgrOnComplete();}interimCmd.submit(me.model.getOpenDatasetPanelAction(),refreshCallback,extras,cmdMgr.CMD_PHASE.LAST);}}else{var urInfo=interimCmd.urInfo;urInfo.callback={success:mstrmojo.emptyFn};urInfo.treesToRender=0;interimCmd.cancel();}};executeDynamic.call(me,openDI);}}});}());