(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.Box","mstrmojo.Button","mstrmojo.Container","mstrmojo.dom","mstrmojo.Editor","mstrmojo.hash","mstrmojo.Label","mstrmojo.DynamicClassFactory","mstrmojo.vi.ui._IsDropTarget","mstrmojo.vi.models.EnumDragSources","mstrmojo.vi.ui.AllObjectsBrowser","mstrmojo.vi.ui.DatasetUnitList","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.ui.CheckList","mstrmojo.ui.menus.EditorConfig");var $HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$ARR=mstrmojo.array,ENUM_SOURCE=mstrmojo.vi.models.EnumDragSources,$DUMU=mstrmojo.vi.ui.DatasetUnitMenuUtils,NEWDATASET={id:"",att:[],mx:[]};function checkModifiedItems(modifiedItems,item,isAdd){var pushArr=isAdd?modifiedItems.add:modifiedItems.del,delArr=isAdd?modifiedItems.del:modifiedItems.add;var delidx=$ARR.find(delArr,"did",item.did);if(delidx===-1){pushArr.push(item);}else{$ARR.removeIndices(delArr,delidx,1);}if(!isAdd){modifiedItems.fs.add=$ARR.filter(modifiedItems.fs.add,function(it){return item.did!==it.unitId;});modifiedItems.fs.del=$ARR.filter(modifiedItems.fs.del,function(it){return item.did!==it.unitId;});}}function checkModifiedForms(modifiedItems,action,isAdd){var pushArr=isAdd?modifiedItems.fs.add:modifiedItems.fs.del,delArr=isAdd?modifiedItems.fs.del:modifiedItems.fs.add,delidx=-1,idx;for(idx=0;idx<delArr.length;idx++){if(delArr[idx].unitId===action.unitId&&delArr[idx].attFormId===action.attFormId){delidx=idx;}}if(delidx===-1){pushArr.push(action);return true;}$ARR.removeIndices(delArr,delidx,1);return false;}function addItemsToListOnBox(items,targetDataset,modifiedItems){$ARR.forEach(items,function(item){var addedItems=item.t===4?targetDataset.mx:targetDataset.att,idx=addedItems.length;$ARR.forEach(addedItems,function(v,n){if(v.n>item.n){idx=n;return false;}});checkModifiedItems(modifiedItems,item,true);item.isNew=true;$ARR.insert(addedItems,idx,[item]);});}function removeItemsFromDataset(items){var targetItems,editor=this;$ARR.forEach(items,function(item){targetItems=item.t===4?editor.dataset.mx:editor.dataset.att;checkModifiedItems(editor.modifiedItems,item,false);$ARR.removeIndices(targetItems,$ARR.find(targetItems,"did",item.did),1);});editor.set("dataset",$HASH.copy(editor.dataset));editor.updateScrollbars();}function serverRequest(taskParams,callback,config){if(mstrApp.serverRequest){mstrApp.serverRequest(taskParams,callback,config);}else{window.$MAPF=function(){return false;};this.getServerProxy().request(callback,taskParams,false,config);}}function getAllowItems(items,mx,att){var allowItems=[];$ARR.forEach(items,function(item){if((item.t===4&&$ARR.find(mx,"did",item.did)===-1)||(item.t!==4&&$ARR.find(att,"did",item.did)===-1)){allowItems.push(item);}});return allowItems;}function getsubMenuCfg(me,item){return function(){var selectedIndices=[],oldFormSelectedIndices=null,submenu=new mstrmojo.ui.menus.EditorConfig({data:{item:item},contents:[{alias:"fs",scriptClass:"mstrmojo.ui.CheckList",selectedIndices:selectedIndices,postBuildRendering:function(){var itemNodes=this.itemsContainerNode.childNodes;$ARR.forEach(this.items,function(item,idx){if(item.idf){mstrmojo.css.addClass(itemNodes[idx],"disableOption");return false;}});},preselectionChange:function preselectionChange(evt){var removeIdx=evt.removed&&evt.removed[0];if(evt.removed&&this.items[removeIdx].idf){this.selectedIndices[removeIdx]=true;return false;}return true;}}],okBtnText:mstrmojo.desc(1442,"Ok"),setAllItems:function(allItems){this.contents[0].items=allItems;this.set("contents",this.contents);},fnOk:function fnOk(data,editor){var formList=editor.fs,selected=formList.selectedIndices,fs=formList.items,pos=1;$HASH.forEach(oldFormSelectedIndices,function(v,n){if(v){checkModifiedForms(me.parent.parent.parent.modifiedItems,{act:"removeAttrFormFromDataset",unitId:item.did,attFormId:fs[n].id},false);item.fs[n].obf=false;}});$HASH.forEach(selected,function(v,n){if(v){var addToActions=checkModifiedForms(me.parent.parent.parent.modifiedItems,{act:"addAttrFormToDataset",unitId:item.did,attFormId:fs[n].id,unitPos:pos},true);if(addToActions){pos++;}item.fs[n].obf=true;}});}});var all=[];$ARR.forEach(item.fs,function(form){all.push({id:form.fid,n:form.fnm,idf:form.idf});if(form.obf||form.idf){selectedIndices[all.length-1]=true;}});if(!oldFormSelectedIndices){oldFormSelectedIndices=$HASH.cloneArray(selectedIndices);}submenu.setAllItems(all);return submenu;};}function getUnitListCfg(objName){return{scriptClass:"mstrmojo.vi.ui.DatasetUnitList",alias:objName+"List",cssClass:objName+"Unitlist",cssDisplay:"inline-block",multiSelect:true,draggable:false,useListModKeys:true,postCreate:function(){this.avatarCssClass+=" noIcon";},doItemSelect:function(item,evt){var me=this,isMetaKey=$DOM.isMetaKey(evt.hWin,evt.e);if(!isMetaKey){$ARR.forEach(this.parent.allList,function(list){if(list!==me.alias){me.parent[list].clearSelect();}});}this.constructor.prototype.doItemSelect.call(this,item,evt);},onItemContextMenu:function onItemContextMenu(item,evt){var e=evt.e,itemNode=this.getItemNodeFromTarget(evt.getTarget()),hWin=evt.hWin,targetSelected=this.getSelectedItems().some(function(obj){return obj.itemNode===itemNode;});if(item&&!targetSelected){this.doItemSelect(item,evt);}var target=evt.getTarget(),items=this.parent.getSelectedItems();if(items.length){this.closePopup();var multi=items&&items.length>1,method=multi?"showMultiSelectionMenu":"showItemMenu";this[method](multi?items:item,this.getItemNodeFromTarget(target),mstrmojo.dom.getMousePosition(e,hWin));return true;}},getItemProps:function getItemProps(item,idx){var props=this.constructor.prototype.getItemProps.call(this,item,idx),dataset=this.parent.parent.parent.dataset,index=$ARR.find(dataset[objName],"did",item.did);props.addCls(item.isNew?"hilight":"");dataset[objName][index].isNew=false;return props;},getAttributeForms:function getAttributeForms(attDid,callback){serverRequest.call(this,{taskId:"getAttributeForms",styleName:"VIMojoAttributeStyle",attributeID:attDid,displayedForms:0},callback,{showProgress:false});},showItemMenu:function showItemMenu(item,el,position){var menuCfg=new mstrmojo.ui.menus.MenuConfig({position:position,isHostedWithin:false}),datasetEditor=this.parent.parent.parent;menuCfg.addMenuItem(mstrmojo.desc(629,"Delete"),"",function(){removeItemsFromDataset.call(datasetEditor,[item]);});if(item.t===12){var forms=item.fs,fnAddAttributeForms=function(){if(forms.length>1){menuCfg.addPopupMenuItem(mstrmojo.desc(14327,"Available Attribute Forms"),"",getsubMenuCfg(this,item));}}.bind(this);if(!forms){var requestForms=function requestForms(){this.getAttributeForms(item.did,{success:function(res){var datasetAttributes=datasetEditor.dataset.att;forms=item.fs=datasetAttributes[$ARR.find(datasetAttributes,"did",item.did)].fs=(res.fms||[]).map(function(form){return{fid:form.did,fnm:form.n,obf:!!form.obf,idf:!!form.idf};});fnAddAttributeForms();this.openPopup(menuCfg.newInstance());}.bind(this),failure:function(res){mstrmojo.alert(res.message);}});}.bind(this);if(mstrApp.isSingleTier){datasetEditor.editorContainer.objectBrowser.dataProvider.loadObjects([item],{success:function(){requestForms();}});}else{requestForms();}return ;}fnAddAttributeForms();}this.openPopup(menuCfg.newInstance());},showMultiSelectionMenu:function showMultiSelectionMenu(items,el,position){var menuCfg=new mstrmojo.ui.menus.MenuConfig({position:position,isHostedWithin:false}),datasetEditor=this.parent.parent.parent;menuCfg.addMenuItem(mstrmojo.desc(629,"Delete"),"",function(){removeItemsFromDataset.call(datasetEditor,items);});this.openPopup(menuCfg.newInstance());},getAllItems:function(){return this.dataset&&$ARR.filter(this.dataset[objName],function(item){return !item.um&&!item.da&&item.st!==12033;});},filterItems:function(items){return items;},bindings:{dataset:"this.parent.parent.parent.dataset"}};}mstrmojo.vi.ui.DatasetEditorContent=mstrmojo.DynamicClassFactory.newComponent(mstrmojo.Box,[mstrmojo.vi.ui._IsDropTarget,mstrmojo.vi.ui._HasUnitListAvatar],{allowDrop:function(context){var dragData=context.src.data,items=dragData.items,dataset=this.dataset,mx=dataset.mx,att=dataset.att;return getAllowItems(items,mx,att).length&&dragData.src===ENUM_SOURCE.ALL_OBJECT_LIST;},isDragValid:function isDragValid(context){return !isNaN(parseInt(context.src.node.getAttribute("idx"),10))||this._super(context)||false;},ondragstart:function ondragstart(context){var list=null,me=this,inList=function(tulist){return $DOM.contains(tulist.domNode,context.src.node,true,tulist.domNode);};$ARR.forEach(this.allList,function(listName){if(inList(me[listName])){list=me[listName];return false;}});if(list){list.selectDragNode(context);}this._super(context);}});var okBtn=mstrmojo.Button.newWebButton(mstrmojo.desc(118,"Save"),function(){var datasetEditor=this.parent.parent,dataset=datasetEditor.dataset,datasets=datasetEditor.docModel.datasets,actions=[],otherActions=datasetEditor.modifiedItems.fs.add.concat(datasetEditor.modifiedItems.fs.del),addUnit={act:"addUnitToDataset"},removeUnit={act:"removeBaseUnitFromDataset"},addFilter={act:"setDatasetFilter",useJson:false},GUIDforNewDS="$GUID_141",idx=0;if(datasetEditor.modifiedItems.convert){actions.push(datasetEditor.modifiedItems.convert);idx=$ARR.indexOf($HASH.keyarray(datasets),dataset.did)+1;addUnit.dsidx=removeUnit.dsidx=addFilter.dsidx=idx;$ARR.forEach(otherActions,function(formAction){formAction.dsidx=idx;});}else{if(!dataset.did&&datasetEditor.modifiedItems.add.length){actions.push(datasetEditor.modifiedItems.create||{act:"createDataset",prm:true,mgo:true,newObjectIds:[GUIDforNewDS]});var dropZoneModel=datasetEditor.docModel.getSelectedViUnit().getZonesModel();if(dropZoneModel){actions.push({act:"editNode",nodeKey:dropZoneModel.getHost().k,datasetId:GUIDforNewDS});}actions=actions.concat(datasetEditor.docModel.getOpenDatasetPanelAction());addUnit.dsid=addFilter.dsid=GUIDforNewDS;$ARR.forEach(otherActions,function(formAction){formAction.dsid=GUIDforNewDS;});}else{if(dataset){var datasetId=dataset.did;addUnit.dsid=removeUnit.dsid=addFilter.dsid=datasetId;$ARR.forEach(otherActions,function(formAction){formAction.dsid=datasetId;});}}}$ARR.forEach(datasetEditor.modifiedItems.add,function(item){actions.push($HASH.copy(addUnit,{unitId:item.did,unitType:item.t}));});$ARR.forEach(datasetEditor.modifiedItems.del,function(item){actions.push($HASH.copy(removeUnit,{unitId:item.did,unitType:item.t}));});actions=actions.concat(otherActions);if((datasetEditor.modifiedItems.filter||null)!==(dataset.filter||null)){actions.push($HASH.copy(addFilter,{expr:mstrmojo.fe.FilterUtils.getExprXml(datasetEditor.modifiedItems.filter)}));}if(actions.length){if(!dataset.mngd&&!!dataset.did&&!datasetEditor.modifiedItems.convert){actions.push({act:"datasetSaveAs",managed:false,nonDelta:true,dsID:dataset.did,rptName:dataset.name,rptDesc:"",folderID:dataset.pfid,saveAsOverwrite:true});}}if(datasetEditor.modifiedItems.add.length){datasetEditor.editorContainer.objectBrowser.dataProvider.loadObjects(datasetEditor.modifiedItems.add,{success:function(){datasetEditor.onOk(actions);}});}else{datasetEditor.onOk(actions);}datasetEditor.close();},true,{bindings:{enabled:"!!this.parent.parent.editorContainer.unitListContainer.attList.items.length || !!this.parent.parent.editorContainer.unitListContainer.mxList.items.length"}}),cancelBtn=mstrmojo.Button.newWebButton(mstrmojo.desc(221,"Cancel"),function(){var editor=this.parent.parent;if(editor.onCancel){editor.onCancel();}editor.close();});mstrmojo.vi.ui.DatasetEditor=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.vi.ui.DatasetEditor",cssClass:"mstrmojo-VIDatasetEditor",dataset:NEWDATASET,docModel:null,dataProvider:null,modifiedItems:{add:[],del:[],fs:{add:[],del:[]},filter:undefined},init:function(config){this.buttons=[okBtn,cancelBtn];this._super(config);okBtn.text=this.okBtnText||mstrmojo.desc(118,"Save");},onOpen:function(){if(!this.dataset.did){this.dataset=$HASH.clone(NEWDATASET);}else{this.updateScrollbars();}this.modifiedItems.add=[];this.modifiedItems.del=[];this.modifiedItems.fs.add=[];this.modifiedItems.fs.del=[];this.modifiedItems.filter=this.dataset.filter;},onPreClose:function onPreClose(){if(this.onCancel){this.onCancel();}return this._super();},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.editorContainer.containNode;},children:[{scriptClass:"mstrmojo.Container",alias:"editorContainer",markupString:'<div class="mstrmojo-VIDatasetEditorContents"><div class="objbrowserContainer"></div><div class="datasetEditorContainer"><div class="datasetEditorTopContainer"><div class="filterLink"></div></div><div class="datasetEditorContent"><div mstrAttach:mouseout,mouseover></div></div></div></div>',markupSlots:{browserNode:function(){return this.domNode.firstChild;},filterNode:function(){return this.domNode.childNodes[1].firstChild.firstChild;},containNode:function(){return this.domNode.childNodes[1].childNodes[1].firstChild;}},onmouseout:function(){mstrmojo.css.removeClass(this.containNode.parentNode,"entered");},onmouseover:function(){mstrmojo.css.addClass(this.containNode.parentNode,"entered");},children:[{scriptClass:"mstrmojo.vi.ui.AllObjectsBrowser",alias:"objectBrowser",cssClass:"datasetEditorobjbrowser",slot:"browserNode",bindings:{model:"this.parent.parent.docModel"},dblClickOnNodes:function(evt){var target=evt.getTarget(),item=$DOM.findWidget(target).data,editor=this.parent.parent,dataset=editor.dataset;if(item&&$ARR.indexOf([4,12,1,47],item.t)!==-1){if((item.t===4&&$ARR.find(dataset.mx,"did",item.did)===-1)||(item.t!==4&&$ARR.find(dataset.att,"did",item.did)===-1)){addItemsToListOnBox.call(this,[item],dataset,editor.modifiedItems);}editor.set("dataset",$HASH.copy(dataset));}},postBuildRendering:function(){this.set("dataProvider",this.parent.parent.dataProvider);this.set("opened",true);this.constructor.prototype.postBuildRendering.call(this);},allowDrop:function(context){var dragData=context.src.data;return dragData&&dragData.src!==ENUM_SOURCE.ALL_OBJECT_LIST;},getDropAvatarIcon:function getDropAvatarIcon(){return"hasIcon remove";},ondrop:function ondrop(context){if(context.src.data.onRemove){context.src.data.onRemove(context.src.data.items);}}},{scriptClass:"mstrmojo.Button",slot:"filterNode",text:mstrmojo.desc(13402,"Edit Filter..."),cssClass:"filterButton",bindings:{visible:"!this.parent.parent.dataset.idd"},onclick:function(){var editor=this.parent.parent,dataset=editor.dataset,filter=editor.modifiedItems.filter,fnOk=function(filterModel){editor.modifiedItems.filter=filterModel.expr;};if(dataset){$DUMU.getFilterEditor({datasetName:"- "+(dataset.name||mstrmojo.desc(11636,"New Dataset")),datasetFilter:filter||dataset.filter,att:editor.editorContainer.unitListContainer.attList.items,mx:editor.editorContainer.unitListContainer.mxList.items,fnOk:fnOk,browseParam:mstrmojo.emptyFn,zIndex:editor.zIndex+1});}}},{scriptClass:"mstrmojo.vi.ui.DatasetEditorContent",alias:"unitListContainer",slot:"containNode",bindings:{dataset:"this.parent.parent.dataset",cssClass:function(){return"datasetEditorUnitlistContainer"+(this.dataset.idd?" noFilter":"");}},ondrop:function ondrop(context){var me=this,editor=me.parent.parent,targetDataset=editor.dataset,allowItems=getAllowItems(context.src.data.items,editor.dataset.mx,editor.dataset.att);addItemsToListOnBox.call(this,allowItems,targetDataset,me.parent.parent.modifiedItems);editor.set("dataset",$HASH.copy(targetDataset));editor.updateScrollbars();},allList:["attList","mxList"],getDragData:function getDragData(context){var info=this.constructor.prototype.getDragData.call(this,context),me=this,editor=me.parent.parent;info.onRemove=function(items){removeItemsFromDataset.call(editor,items);};return info;},getSelectedItems:function(){var me=this,result=[];this.allList.forEach(function(listName){result=result.concat(me[listName].getSelectedItems());});return result;},children:[getUnitListCfg.call(this,"att"),getUnitListCfg.call(this,"mx"),{scriptClass:"mstrmojo.Label",cssClass:"dragObjectMsg",bindings:{visible:"!this.parent.attList.items.length && !this.parent.mxList.items.length"},text:mstrmojo.desc(11668,"Drag objects here.")}]}]}]});}());