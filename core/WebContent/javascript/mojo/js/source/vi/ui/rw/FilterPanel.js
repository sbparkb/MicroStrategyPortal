(function(){mstrmojo.requiresCls("mstrmojo.DocPanel","mstrmojo.vi.ui._IsDropTarget","mstrmojo.vi.models.EnumDragSources","mstrmojo.models.FormatModel","mstrmojo.vi.ui._CanDropFromSchema","mstrmojo.css","mstrmojo.hash","mstrmojo.array","mstrmojo.vi.ui.DatasetUnitMenuUtils");var DRAG_SRC=mstrmojo.vi.models.EnumDragSources,$FORMAT_MODEL=mstrmojo.models.FormatModel,$GET_FORMAT_OBJ=$FORMAT_MODEL.getFormatUpdate,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$ARR=mstrmojo.array,$HASH=mstrmojo.hash;function cascadeWidth(children){var w=this.width;children.forEach(function(child){var layoutOffsets=child.getLayoutOffsets&&child.getLayoutOffsets(),offset=(layoutOffsets&&layoutOffsets.w)||0,childWidth=w;if(offset){childWidth=parseInt(childWidth,10)-offset+"px";}if(child.setDimensions){child.setDimensions(child.height,childWidth);}});}function resetDividers(){this._dividers.forEach(function(d){d.style.height=0;});}function removeDividers(){var containerNode=this.containerNode;this._dividers.forEach(function(d){containerNode.removeChild(d);});this._dividers=[];}function reorderPortlets(){var orderedSelectors=this._orderedSelectors=(this.getPanelChildren()||[]).filter(function(c){return !!c.togglePortlet;}).sort(function(a,b){var getZIndex=function(a){return(a&&a.selector&&a.selector.defn&&a.selector.defn.fmts&&a.selector.defn.fmts["z-index"])||0;};return(parseInt(getZIndex(a))>parseInt(getZIndex(b)))?1:-1;});this.set("empty",!orderedSelectors.length);removeDividers.call(this);var portlets=orderedSelectors.map(function(portlet){var selector=portlet.selector;return{node:portlet.domNode,selector:selector,fmts:selector.defn.fmts};}),containerNode=this.containerNode,model=this.model,dividers=this._dividers=[],zIndex="z-index",actions=[];while(containerNode.lastChild){containerNode.removeChild(containerNode.lastChild);}portlets.forEach(function(portlet,idx){if(parseInt(portlet.fmts[zIndex],10)!==idx){actions.push(model.getUnitFormatAction(portlet.selector,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.Z_INDEX,idx)));}portlet.fmts[zIndex]=idx;var divider=document.createElement("div");divider.className="fp-divider";containerNode.appendChild(divider);dividers.push(divider);containerNode.appendChild(portlet.node);});var emptyMsgBox=this.emptyMsgBoxNode;if(emptyMsgBox){containerNode.appendChild(emptyMsgBox);}if(actions.length){var cmdMgr=model.controller.cmdMgr,cmd=cmdMgr.getInterimCmd(),callback,extras=mstrmojo.DocDataService.SUPPRESS_DATA;if(cmd){callback={success:mstrmojo.emptyFn};cmd.submit(actions,callback,extras,cmdMgr.CMD_PHASE.LAST);}else{var ds=model.getDataService();callback={success:function(){var currentStateId=model.getDataService().stid||0,lastSavedStateId=model.lastSavedStid||0;if(currentStateId-lastSavedStateId===1){model.lastSavedStid=currentStateId;}}};ds.submitUpdates(actions,callback,$HASH.copy(extras,{preserveUndo:true}));}}}function isValidDragSource(dragData){var dragSrc=dragData&&dragData.src;return dragSrc&&(dragSrc===DRAG_SRC.DATASETS||dragSrc===DRAG_SRC.VIZ_EDITOR||dragSrc===DRAG_SRC.ALL_OBJECT_LIST);}function computeTargetIndex(context){var targetData=context.tgtData,yPosition=context.tgt.pos.y,map=targetData.map,tgtIdx=map&&map.length;if(!map){var baseY=mstrmojo.dom.position(this.domNode).y;map=context.tgtData.map=(this._orderedSelectors||[]).map(function(filter){var filterNode=filter.domNode;return baseY+filterNode.offsetTop+Math.round(filterNode.offsetHeight/2);});tgtIdx=map&&map.length;}(targetData.map||[]).every(function(filterMidPoint,idx){if(yPosition<filterMidPoint){tgtIdx=idx;return false;}return true;});if(targetData.tgtIdx===tgtIdx){return ;}targetData.tgtIdx=tgtIdx;resetDividers.call(this);var tgtDivider=this._dividers[tgtIdx],src=context.src.data,avatarHeight=(src&&src.dim&&src.dim.h)||null;if(tgtDivider){tgtDivider.style.height=(avatarHeight||"48")+"px";}}function isValidDropItem(item){var model=this.model;return item.did!=="-1"&&item.t!==14&&$DU.isValidAddToFP(model,item);}mstrmojo.vi.ui.rw.FilterPanel=mstrmojo.declare(mstrmojo.DocPanel,[mstrmojo.vi.ui._IsDropTarget,mstrmojo.vi.ui._CanDropFromSchema],{scriptClass:"mstrmojo.vi.ui.rw.FilterPanel",markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,onwidthChange:function(){cascadeWidth.call(this,this.children||[]);},onemptyChange:function(){mstrmojo.css.toggleClass(this.emptyMsgBoxNode,"hide",!this.empty);}},width:null,model:null,subPanelCssText:"background-color: transparent;",empty:true,init:function init(props){this._super(props);mstrmojo.css.addWidgetCssClass(this,"mstrmojo-VIFilterPanel");this._dividers=[];this.attachEventListener("childrenRendered",this.id,reorderPortlets);},postBuildRendering:function postBuildRendering(){var containerNode=this.containerNode;if(containerNode&&!this.emptyMsgBoxNode){var emptyMsgBox=document.createElement("div");emptyMsgBox.className="fp-empty-msgbox";emptyMsgBox.innerHTML=mstrmojo.desc(13258,"Drag objects here.");containerNode.appendChild(emptyMsgBox);this.addSlots({emptyMsgBoxNode:emptyMsgBox});}return this._super();},isEmpty:function isEmpty(){return this.empty;},updateForPU:function updateForPU(newNode){var newControlKeys=newNode.defn&&newNode.defn.ck;this.node.data.objects=this.node.data.objects.filter(function(obj){if(newControlKeys[obj.k]){return true;}return false;});if(newNode.data&&newNode.data.objects){var objs=this.node.data.objects;$ARR.forEach(newNode.data.objects,function(obj){if($ARR.find(objs,"k",obj.k)<0){objs.push(obj);}});}this.update(newNode);},refresh:function refresh(postUnrender,isPartial){var cw=this.domNode.clientWidth-2*2;this.contentWidth=(cw>0)?cw:0;this._super(postUnrender,isPartial);},refreshFP:function refreshFP(){reorderPortlets.call(this);},unrender:function unrender(ignoreDom){removeDividers.call(this);this._super(ignoreDom);},addChildren:function addChildren(children,idx,silent){var parent=this.parent;if(children&&children.constructor!==Array){children=[children];}cascadeWidth.call(this,children);this._super(children,idx,silent);if(!children||!children.length){reorderPortlets.call(this);}if(parent&&parent.scrollNode){parent.updateScrollbars();}},toggleFilters:function toggleFilters(isCollapsed){var me=this,model=me.model,ws=isCollapsed?1:0,ds=mstrmojo.DocDataService,callback=ds.EMPTY_CALLBACK,extras=ds.SUPPRESS_DATA,oldBCollapsed=isCollapsed,updateFilterPanelScrollBars=function(){me.raiseEvent({name:"filterPanelUpdated"});};var fnUpdatePortlet=function(){oldBCollapsed=!oldBCollapsed;(me.children||[]).forEach(function(child){child.set("_onCollapseAll",true);child.togglePortlet(oldBCollapsed);child.set("_onCollapseAll",false);});updateFilterPanelScrollBars();};model.execute({execute:function(){var update=model.getDataService().newUpdate(this);(me.children||[]).forEach(function(child){if(child.togglePortlet){child.set("_onCollapseAll",true);child.togglePortlet(isCollapsed);child.set("_onCollapseAll",false);update.addActions(model.getUnitFormatAction(child.selector,1,{FormattingView:{WindowState:ws}}));}});update.addCallbacks({success:updateFilterPanelScrollBars});update.addExtras(ds.REQUEST_ONLY_DEFINITION);update.submit();},urInfo:{undo:function(){fnUpdatePortlet();},redo:function(){fnUpdatePortlet();},callback:callback,extras:extras}});},getContextDragData:function(context){var dragData=this._super(context);if(dragData.src===DRAG_SRC.ALL_OBJECT_LIST){this.augmentDropContextForSchema(context,this.model);context.preInfo={actions:context.actions,callback:context.callback};}return dragData;},allowDrop:function allowDrop(context){var dragData=this.getContextDragData(context);if(dragData){var dragSrc=dragData.src;if(isValidDragSource(dragData)){var me=this;return dragData.items.some(function(item){return isValidDropItem.call(me,item);});}if(dragSrc===DRAG_SRC.FILTERS){return true;}}return false;},ondragenter:function ondragenter(context){this._super(context);context.tgtData={tgtIdx:999};computeTargetIndex.call(this,context);},ondragover:function ondragover(context){computeTargetIndex.call(this,context);},ondrop:function ondrop(context){var tgtData=context.tgtData;if(!tgtData){return this._super(context);}var dragData=context.src&&context.src.data,dragSource=dragData&&dragData.src,model=this.model,me=this,fnGetTargetZIdx=function(){return tgtData.tgtIdx;};if(isValidDragSource(dragData)){var allowedItems=[];dragData.items.forEach(function(item){if(isValidDropItem.call(me,item)){allowedItems.push(item);}});var add2FP=function(allowedItems){model.addFilterStackSelectors(allowedItems,fnGetTargetZIdx(),{preInfo:context.preInfo,postInfo:context.postInfo});};if(dragSource===DRAG_SRC.ALL_OBJECT_LIST){var widget=context.src.widget,dp=widget&&widget.dataProvider;if(dp){dp.loadObjects(allowedItems,{success:function(res){add2FP((res&&res.objects)||allowedItems);}},true,true);}}else{add2FP(allowedItems);}}else{if(dragSource===DRAG_SRC.FILTERS){var fromZIdx=parseInt(dragData.idx,10),toZIdx=fnGetTargetZIdx();if(fromZIdx<toZIdx){toZIdx--;}if(fromZIdx!==toZIdx){model.pivotFilterStackSelector(this._orderedSelectors[fromZIdx].selector,fromZIdx,toZIdx);}}}this._super(context);},getDropAvatarIcon:function getDropAvatarIcon(context){var dragData=context.src.data,dragSrc=dragData&&dragData.src,iconCls="unselectable";if(isValidDragSource(dragData)){iconCls="add";}else{if(dragSrc===DRAG_SRC.FILTERS){iconCls="move";}}return iconCls;},cleanUpAfterTarget:function cleanUpAfterTarget(context){resetDividers.call(this);this._super(context);},clearAllFilter:function clearAllFilter(){(this.children||[]).forEach(function(child){if(child.clearFilters){child.clearFilters();}});}});}());