(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.dom","mstrmojo.css");var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$ARR=mstrmojo.array,selectedRows=[],lastSelectedRow=null,getTotalRows=function(gd){return(gd&&gd.rw&&gd.rw.row&&gd.rw.row.tc)||0;},getRowsText=function(totalRows,selectedRowsLen){if(selectedRowsLen){if(totalRows===1){return mstrmojo.desc(11944,"1 of 1 Row selected");}return mstrmojo.desc(11945,"# of ## Rows selected").replace("##",totalRows).replace("#",selectedRowsLen);}return totalRows===1?mstrmojo.desc(11946,"1 Row"):mstrmojo.desc(11947,"## Rows").replace("##",totalRows);},updateHiddenField=function(){var text="",i,it,header=selectedRows[0]&&selectedRows[0].parentNode.firstChild,hiddenField=this.hiddenField,selectedRowLen=selectedRows.length,totalRows=getTotalRows(this.gridData);for(i=0;header&&i<header.childNodes.length;i++){it=header.childNodes[i].innerText||header.childNodes[i].textContent;text+=it?(it+"\t"):"";}text+="\n";selectedRows.forEach(function(row){for(i=0;i<row.childNodes.length;i++){it=row.childNodes[i].innerText||row.childNodes[i].textContent;text+=it?(it+"\t"):"";}text+="\n";});hiddenField.value=text;hiddenField.focus();hiddenField.select();text=getRowsText(totalRows,selectedRowLen);this.viewDataDialog.tools.rowCount.set("text",text);},submitInterim=function submitInterim(actions,cb){var controller=this.controller,cmdMgr=controller.cmdMgr;cmdMgr.getInterimCmd().submitInterim(actions,controller._getXtabCallback(this,cb||{}),{preserveUndo:true});},submitUpdate=function submitUpdate(action,cb){submitInterim.call(this,this.controller.dataService().getUpdateTemplateAction(this.k,action),cb);},toggleSel=function(_tr,sel){var ix=$ARR.indexOf(selectedRows,_tr),found=ix>-1;if(found||sel===false){selectedRows.splice(ix,1);}if(!found||sel===true){selectedRows.push(_tr);lastSelectedRow=_tr;}$CSS.toggleClass(_tr,"selected",!found||sel===true);},clearSelections=function clearSelections(){selectedRows.forEach(function(elem){$CSS.removeClass(elem,"selected");});selectedRows=[];};mstrmojo.vi.ui.rw._IsViewDataGrid=mstrmojo.provide("mstrmojo.vi.ui.rw._IsViewDataGrid",{_mixinName:"mstrmojo.vi.ui.rw._IsViewDataGrid",submitUndoRedoActionsWithCallback:function submitUndoRedoActionsWithCallback(actions,callback){submitInterim.call(this,actions,callback);},doSelection:function doSelection(e,hWin,td){if(td.getAttribute("r")==="0"){var data=this.getCellForNode(td);if(data.at&8&&$DOM.getButton(hWin,e)!==$DOM.MOUSE_BUTTON.RIGHT){this.sort(data);}return ;}if(td&&~td.className.indexOf("xtab-td")){var ctrl=$DOM.isMetaKey(hWin,e),shift=$DOM.shiftKey(hWin,e),justSelectedRow=$DOM.findAncestorByName(td,"tr",true,this.domNode),trTBody=$DOM.findAncestorByName(td,"tbody",true,this.domNode);if(ctrl||(shift&&!lastSelectedRow)){toggleSel(justSelectedRow);}else{if(shift&&trTBody){var lsTBody=$DOM.findAncestorByName(lastSelectedRow,"tbody",true,this.domNode),rpp=this.zone.rowsPerPage,getPos=function(info){return info.tBodyN*rpp+info.index;},getTBody=function(index){return this.zone.tableNode.childNodes[index+1].childNodes;}.bind(this),lsInfo={row:lastSelectedRow,tBodyN:parseInt(lsTBody.getAttribute("n")||0),index:$ARR.indexOf(lsTBody.childNodes,lastSelectedRow),body:lsTBody},trInfo={row:justSelectedRow,tBodyN:parseInt(trTBody.getAttribute("n")||0),index:$ARR.indexOf(trTBody.childNodes,justSelectedRow),body:trTBody},from,to,i,j,cn;if(getPos(lsInfo)<getPos(trInfo)){from=lsInfo;to=trInfo;}else{from=trInfo;to=lsInfo;}toggleSel(from.row,true);if(from.tBodyN===to.tBodyN){cn=from.body.childNodes;for(j=from.index+1;j<to.index;j++){toggleSel(cn[j]);}}else{for(i=from.tBodyN;i<=to.tBodyN;i++){if(i===from.tBodyN){cn=from.body.childNodes;for(j=from.index+1;j<cn.length;j++){toggleSel(cn[j]);}}else{if(i===to.tBodyN){cn=to.body.childNodes;for(j=0;j<to.index;j++){toggleSel(cn[j]);}}else{cn=getTBody(i);for(j=0;j<cn.length;j++){toggleSel(cn[j]);}}}}}toggleSel(to.row,true);}else{clearSelections();toggleSel(justSelectedRow,true);}}}else{clearSelections();}updateHiddenField.call(this);},onclick:function onclick(e,hWin){if(!this.interactiveCellsArray.length){return ;}e=e.e||e;var $D=mstrmojo.dom,target=$D.eventTarget(hWin,e),clickedCell=target&&$D.findAncestorByName(target,"td",true,this.viewport);if(clickedCell){this.doSelection(e,hWin,clickedCell);$D.clearBrowserHighlights();}},changeColumnWidth:function changeColumnWidth(unitId,unitType,width,formIndex,isExtraColumn){submitUpdate.call(this,this._super(unitId,unitType,width,formIndex,isExtraColumn,true));},postBuildRendering:function postBuildRendering(){this._super();var trc=getTotalRows(this.gridData);this.viewDataDialog.tools.rowCount.set("text",getRowsText(trc));},lastSortedCell:[],sort:function sort(cell,isAsc){var ix=cell._ei,toggle=isAsc===undefined,asc=toggle?true:!!isAsc,lsc=this.lastSortedCell,cb={success:function(){try{var cn=this.tableContainerNode.lastElementChild.firstChild.firstChild.firstChild.lastChild.firstChild.childNodes,cn_data=this.tableContainerNode.childNodes[1].firstChild.firstChild.lastChild.firstChild.childNodes,i;for(i=0;i<cn.length;i++){if(ix===Number(cn[i].getAttribute("ei"))){$CSS.addClass(cn[i],asc?"asc":"desc");$CSS.addClass(cn_data[i],asc?"asc":"desc");}}}catch(e){}}.bind(this)};if(lsc){if(lsc[0]===ix){asc=toggle?!lsc[1]:isAsc;}}lsc[0]=ix;lsc[1]=asc;var controller=this.controller,s=controller.getSorts(this.model.getSortAction(cell,asc)),action={act:"sort",sorts:s.sorts,nodeKey:this.k,subTotalsPos:s.subTotalsPos};submitUpdate.call(this,action,cb);},pivot:function pivot(cell,btn){var action=this.model.getPivotAction(cell,btn);submitUpdate.call(this,action);},selectAll:function selectAll(){var zone=this.zone,nodes=zone.tableNode.childNodes,i,j,node,idx,rows,first=true;clearSelections();for(i=0;i<nodes.length;i++){node=nodes[i];if(node.tagName.toLowerCase()==="tbody"){idx=node.getAttribute("n")||0;if(!zone.pageStatus[idx].isOnDemand()){rows=node.childNodes;for(j=0;j<rows.length;j++){if(!first){toggleSel(rows[j],true);}first=false;}}}}updateHiddenField.call(this);},isMultiSelect:false,onHandleDblClick:function onHandleDblClick(){var action={act:"changeXtabColWidthScenario",value:2};submitUpdate.call(this,action);}});}());