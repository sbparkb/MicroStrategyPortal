(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.dom","mstrmojo.string","mstrmojo.Label","mstrmojo.vi.ui.rw.UnitContainer","mstrmojo.vi.ui.ScrollableDocTextfield","mstrmojo.DocHTMLContainer","mstrmojo.ui.ScrollableTextArea");var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$STR=mstrmojo.string;var TYPE_IFRAME=0,TYPE_HTML_TEXT=1;var STR_IFRAME="url",STR_HTML_TEXT="htmlText";var STR_URL_HINT="http://",STR_TEXT_HINT=null,TYPE_BUTTON_ITEMS=[{n:mstrmojo.desc(4555,"iFrame"),v:TYPE_IFRAME,id:0},{n:mstrmojo.desc(4554,"Html Text"),v:TYPE_HTML_TEXT,id:1}];function editHtmlContainer(htmlType,value,callback){this.model.editHtmlContainer(this,htmlType,value,callback);}function applyOverlayDimension(height,width){var ctrlOverlay=this.ctrlOverlay,widthInt=parseInt(width.match(/\d+/),10);if(ctrlOverlay&&ctrlOverlay.visible){$CSS.toggleClass(ctrlOverlay.domNode,"v",widthInt<310||parseInt(height.match(/\d+/),10)>widthInt);}}function getUpdateHTMLBoxFn(htmlType,value,nodeId){return function(){var valueType=htmlType?STR_HTML_TEXT:STR_IFRAME,boxContent=mstrmojo.all[nodeId],htmlBox=boxContent.parent,node=boxContent.node,defn=htmlBox.defn,hasHtmlTypeChanged=htmlBox.htmlType!==htmlType;if(hasHtmlTypeChanged){htmlBox.htmlType=htmlType;var newContent={scriptClass:htmlType===TYPE_IFRAME?"mstrmojo.DocHTMLContainer":"mstrmojo.vi.ui.ScrollableDocTextfield",id:node.id,node:node,slot:"containerNode",alias:"boxContent",controller:boxContent.controller,model:boxContent.model,k:node.k,defn:node.defn,builder:boxContent.builder,tooltip:boxContent.tooltip,formatHandlers:{domNode:["D"]},edtModel:boxContent.edtModel};htmlBox.removeAndDestroyChild(boxContent);htmlBox.addChildren(newContent);htmlBox.boxContent.render();boxContent=htmlBox.boxContent;}if(hasHtmlTypeChanged||defn[valueType]!==value){defn[valueType]=value;node.data.v=node.data.rv=value;if(htmlBox.htmlType===TYPE_HTML_TEXT){boxContent.updateScrollbars();}}boxContent.update(node);boxContent.refresh();htmlBox.selectVIUnit(true);var ctrlOverlay=htmlBox.ctrlOverlay;if(ctrlOverlay&&ctrlOverlay.visible&&!mstrmojo.string.isEmpty(value)){htmlBox.hideControlOverlay();}};}function hasCreateHTMLPrivilege(){return mstrApp.isSingleTier||this.model.controller.rootCtrl.resolveFeature("create-html-container");}mstrmojo.vi.ui.rw.HtmlBox=mstrmojo.declare(mstrmojo.vi.ui.rw.UnitContainer,null,{scriptClass:"mstrmojo.vi.ui.rw.HtmlBox",htmlType:TYPE_IFRAME,textArea:undefined,typeBtn:undefined,init:function init(props){this._super(props);var defn=this.defn,data=this.boxContent.node.data;this.htmlType=defn.ht?TYPE_HTML_TEXT:TYPE_IFRAME;defn[this.htmlType?STR_HTML_TEXT:STR_IFRAME]=$STR.decodeHtmlString(data.rv||data.v);$CSS.addWidgetCssClass(this,"mstrmojo-HtmlBox");},postBuildRendering:function postBuildRendering(){this._super();this.addDragHandle();if(!this.boxContent.node.data.v&&mstrApp.allowWebDashboardDesign()&&hasCreateHTMLPrivilege.call(this)){this.showControlOverlay(this.getEditOverlayControls());}},applyBoxSize:function applyBoxSize(height,width,top,left){this._super(height,width,top,left);var boxContent=this.boxContent,childFormats=boxContent&&boxContent.getFormats();if(childFormats){boxContent.clearCache();childFormats.height=height;childFormats.width=width;boxContent.refresh();}applyOverlayDimension.call(this,height,width);},getAvatarCls:function getAvatarCls(){return this._super().concat(["htmlAvatar"]);},getDisplayName:function getDisplayName(){return this.defn.n||mstrmojo.desc(4538,"HTML Container");},createDeleteUpdate:function createDeleteUpdate(){return this.model.getRemoveFieldUpdate(this);},updateHtmlBox:function updateHtmlBox(htmlType,value){var oldHtmlType=this.htmlType,oldValue=this.defn[oldHtmlType?STR_HTML_TEXT:STR_IFRAME],nodeId=this.boxContent.node.id;if(oldHtmlType!==htmlType||oldValue!==value){editHtmlContainer.call(this,htmlType,value,{success:getUpdateHTMLBoxFn(htmlType,value,nodeId),undo:getUpdateHTMLBoxFn(oldHtmlType,oldValue,nodeId),redo:getUpdateHTMLBoxFn(htmlType,value,nodeId)});}},setDefaultTextCaretPosition:function positionDefaultTextCaret(inputNode,defaultText){if(inputNode.value===defaultText){window.setTimeout(function(){var caretPosition=defaultText===STR_TEXT_HINT?(defaultText.indexOf("</body>")-1):(defaultText.indexOf("//")+2);$DOM.setCaret(inputNode,caretPosition);},0);}},getHintText:function getHintText(){return[STR_URL_HINT,STR_TEXT_HINT];},isDragValid:function isDragValid(context){if(!this._super(context)){return false;}var evtSource=context.src,ctrlOverlay=this.ctrlOverlay,textArea=ctrlOverlay&&ctrlOverlay.textArea;return !(textArea&&$DOM.contains(textArea.domNode,$DOM.eventTarget(evtSource.hWin,evtSource.e)));},getEditOverlayControls:function getOverlayControls(){var $this=this,htmlType=this.htmlType,editorModel=this.boxContent.edtModel;return[{scriptClass:"mstrmojo.Label",cssClass:"icn"},{scriptClass:"mstrmojo.Label",cssClass:"title",text:mstrmojo.desc(13623,"HTML container:")},editorModel.getButtonBar(TYPE_BUTTON_ITEMS,htmlType,function(newItem){var newHTMLType=newItem.v,textArea=this.parent.textArea;textArea.set("emptyText",$this.getHintText()[newHTMLType]);textArea.set("value","");textArea.refresh();},{alias:"typeBtn",showIcon:false,cssClass:"htmlTypeBtn"}),{scriptClass:"mstrmojo.ui.ScrollableTextArea",emptyText:this.getHintText()[htmlType],maxLength:undefined,alias:"textArea",cssClass:"htmlText",keepEmpty:true,onfocus:function onfocus(){$this.setDefaultTextCaretPosition(this.inputNode,this.emptyText);if(this.inputNode.value===this.emptyText){this.scrollNode.scrollTop=35;}},postvalueChange:function postvalueChange(){this.parent.ctrlOkBtn.set("enabled",!!this.value);}},mstrmojo.Button.newWebButton(mstrmojo.desc(8708,"OK"),function(){var controlOverlay=this.parent;$this.updateHtmlBox(controlOverlay.typeBtn.selectedItem.v,controlOverlay.textArea.value);$this.hideControlOverlay();},true,{alias:"ctrlOkBtn",enabled:false})];},showControlOverlay:function showControlOverlay(controls){this.toggleDragHandleVisibility(false);this._super(controls);this.boxContent.set("visible",false);},hideControlOverlay:function hideControlOverlay(){this._super();this.toggleDragHandleVisibility(true);this.boxContent.set("visible",true);},switchToEditMode:function switchToEditMode(){var d=this.boxContent.node.data,v=d.rv||d.v,ctrlOverlay=this.ctrlOverlay,textArea=ctrlOverlay.textArea;if(ctrlOverlay.visible){textArea.focus();return ;}this._super();$CSS.toggleClass(ctrlOverlay.domNode,"v",parseInt(this.height.match(/\d+/),10)>parseInt(this.width.match(/\d+/),10));textArea=ctrlOverlay.textArea;textArea.set("value",v);textArea.refresh();textArea.focus();},canShowDesignMenuItems:function canShowDesignMenuItems(){return this._super()&&hasCreateHTMLPrivilege.call(this);}});mstrmojo.vi.ui.rw.HtmlBox.boxConfiguration={f:{h:150,v:140},minSize:{h:150,v:40},o:"v"};}());