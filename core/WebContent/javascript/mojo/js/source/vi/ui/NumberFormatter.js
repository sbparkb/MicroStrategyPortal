(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.array","mstrmojo.num","mstrmojo.date","mstrmojo.Container","mstrmojo.VBox","mstrmojo.Button","mstrmojo.locales","mstrmojo._FormatDefinition","mstrmojo.mstr.EnumFunction","mstrmojo.ui.editors.controls.ComboBox");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$NUM=mstrmojo.num,$FD=mstrmojo._FormatDefinition,$CSS=mstrmojo.css,$EF=mstrmojo.mstr.EnumFunction,$LC=mstrmojo.locales,$NIB=mstrmojo.Button.newIconButton,$DATE=mstrmojo.date,categoryValue=$FD.NumberFormatCategory,fixedNegative=$FD.FixedNegative,currencyNegative=$FD.CurrencyNegative,percentNegative=$FD.PercentNegative,defaultValue=$FD.DefaultFormat.FormattingNumber,localeDate,localeTime,getItemProps=function getItemProps(option,idx){return{cls:this.value===option.v?"selected":"",v:option.v||"",n:option.n||"",style:option.r?"color:red;":"color:#fff;",sel:parseInt(this.idx,10)===idx?"selected":""};},CURRENCY_POSITION={RIGHT:1,LEFT_WITH_SPACE:2,RIGHT_WITH_SPACE:3};var CATEGORY_ITEM=[{n:mstrmojo.desc(4531,"Automatic"),v:-3}].concat($FD.Category.slice(2)),CURRENCY_SYMBOL_ITEM=[{n:"$"},{n:"£"},{n:"€"},{n:"¥"},{n:"fr."}];function getNegativeFormat(items,negativeNumbers){var idx=$ARR.find(items,"v",negativeNumbers);return idx===-1?"":items[idx].f;}function onNegativeDDLValueChange(item){var myData=this.parent.parent.parent.myData,value=item.v;myData.set("format",getNegativeFormat(this.items,value));myData.set("negativeNumbers",value);$CSS.toggleClass(this.selectedNode,"red",item.r);}function getDropDownListCfg(items,propName,needUpdatePreview){return{scriptClass:"mstrmojo.ui.Pulldown",items:items,onitemSelected:function onitemSelected(item){var dataParent=this.parent;while(dataParent&&(!dataParent.data||typeof dataParent.data[propName]==="undefined")){dataParent=dataParent.parent;}if(dataParent){dataParent.data.set(propName,item.v);if(needUpdatePreview){dataParent.children[0].preview.preview_label.set("text",item.n);}}}};}function getNegativeList(items,decimalPlaces,removeSeparator,currencyPosition,currencySymbol){var newItems=$HASH.clone(items),digits=decimalPlaces>0?".":"",zeros=digits,formattingNumber=$FD.DefaultFormat.FormattingNumber,i;for(i=0;i<decimalPlaces;i++){digits+=i%9;zeros+="0";}for(i=0;i<newItems.length;i++){var newItem=newItems[i];if(removeSeparator){newItem.n=newItem.n.replace(/,/g,"");newItem.f=newItem.f.replace(/,/g,"");}if(currencyPosition&&currencyPosition!==formattingNumber.CurrencyPosition){switch(currencyPosition){case CURRENCY_POSITION.RIGHT:newItem.n=newItem.n.replace(/\$/g,"").replace(/\.\d{2}/g,".12$");newItem.f=newItem.f.replace(/"\$"/g,"").replace(/\.\d{2}/g,'.00"$"');break;case CURRENCY_POSITION.LEFT_WITH_SPACE:newItem.n=newItem.n.replace(/\$/g,"$ ");newItem.f=newItem.f.replace(/\$/g,"$ ");break;case CURRENCY_POSITION.RIGHT_WITH_SPACE:newItem.n=newItem.n.replace(/\$/g,"").replace(/\.\d{2}/g,".12 $");newItem.f=newItem.f.replace(/"\$"/g,"").replace(/\.\d{2}/g,'.00" $"');break;default:}}newItem.n=newItem.n.replace(/\.\d{2}/g,digits);newItem.f=newItem.f.replace(/\.\d{2}/g,zeros);if(currencySymbol&&currencySymbol!==formattingNumber.CurrencySymbol){var newSymbol=currencySymbol.replace(/\$/g,"$$$$");newItem.n=newItem.n.replace(/\$/g,newSymbol);newItem.f=newItem.f.replace(/\$/g,newSymbol);}newItem.cls=newItem.r?"red":null;}return newItems;}function getScientificFormat(decimalPlaces){var v="1"+(decimalPlaces>0?".":"").toString(),f="0"+(decimalPlaces>0?".":"").toString(),i;for(i=0;i<decimalPlaces;i++){v+=i%10;f+="0";}return[v+"E+03",f+"E+0#"];}function getCustomFormat(format,decimalDiff){var ph="\u00A4",qt=/"[^"]*"/g,strInQuote=format.match(qt),ph2="\u0091",sb=/\[[^\]]*\]/g,strInSquareBracket=format.match(sb),pf,result;pf=format.replace(qt,ph);pf=pf.replace(sb,ph2);var decimalPointPosition=format.indexOf("."),oldDecimalLength=$NUM.getDecimalLength(format),decimalLength=Math.max(0,oldDecimalLength+decimalDiff),noDicimalLastDigit=format.match(/\d(?!((\d)|(,\d)))/g),firstDigit=decimalPointPosition!==-1?format.charAt(decimalPointPosition-1):noDicimalLastDigit&&noDicimalLastDigit[0],f=(firstDigit||"0")+(decimalLength>0?".":"").toString();for(var i=0;i<decimalLength;i++){f+="0";}pf=pf.replace(oldDecimalLength===0?/\d(?!((\d)|(,\d)))/g:/\d\.\d+/g,f);pf=pf.split(ph);result=pf[0];$ARR.forEach(strInQuote,function(str,idx){result+=str+pf[idx+1];});pf=result.split(ph2);result=pf[0];$ARR.forEach(strInSquareBracket,function(str,idx){result+=str+pf[idx+1];});return result;}function resetNegativeListToDDL(ddl,items,data,removeSeparator,currencyPosition,currencySymbol){var editor=ddl.parent.parent.parent,negativeList=getNegativeList(items,data.decimalPlaces,removeSeparator,currencyPosition,currencySymbol);data.set("format",getNegativeFormat(negativeList,data.negativeNumbers.toString()));ddl.set("items",negativeList);ddl.set("selectedIndex",$ARR.find(negativeList,"v",data.negativeNumbers.toString()));editor.preview.preview_label.set("text",getFormatPreview(editor.myData.format));}function onMovePointButtonsClick(){var editor=this.parent.parent,myData=editor.myData,formatterContainer=editor.formatterContainer,category=CATEGORY_ITEM[editor.categoryPicker.selectedIndex].v,decimalDiff=this.funcType===$EF.FunctionLeftStr?1:-1,negativeDDL=null,pullDownList=null,removeSeparator=false,currencyPosition=0,currencySymbol=null,isScientific=false,isCustom;switch(category){case categoryValue.Fixed:negativeDDL=formatterContainer.fixed_hBox.negativeDDL;pullDownList=fixedNegative;removeSeparator=!myData.thousandSeparator;break;case categoryValue.Currency:negativeDDL=formatterContainer.currency_hBox2.negativeDDL;pullDownList=currencyNegative;currencyPosition=myData.currencyPosition;currencySymbol=myData.currencySymbol;break;case categoryValue.Percentage:negativeDDL=formatterContainer.percentage_hBox.negativeDDL;pullDownList=percentNegative;break;case categoryValue.Scientific:isScientific=true;break;case categoryValue.Custom:isCustom=true;break;default:return ;}if(isCustom){var customFormat=getCustomFormat(myData.format,decimalDiff);editor.preview.preview_label.set("text",getFormatPreview(customFormat));editor.formatterContainer.custom_text.set("value",customFormat);return ;}var decimalPlaces=myData.decimalPlaces,decimalValue=decimalPlaces+decimalDiff;decimalValue=Math.max(0,decimalValue);decimalValue=Math.min($FD.MaxNegativeDidigts,decimalValue);myData.set("decimalPlaces",decimalValue);if(isScientific){var scientificFormat=getScientificFormat(decimalValue);myData.set("format",scientificFormat[1]);editor.preview.preview_label.set("text",scientificFormat[0]);}else{resetNegativeListToDDL(negativeDDL,pullDownList,myData,removeSeparator,currencyPosition,currencySymbol);}}function getFormatPreview(format){var ph="\u00A4",qt=/"[^"]*"/g,strInQuote=format.match(qt),pf=format.replace(qt,ph),dateOrTimeStr=["m","y","d","h","s"],isDateOrTime=false,date=new Date(),year=date.getFullYear(),month=date.getMonth(),weekDay=date.getDay(),lcDateTime=$LC.datetime,result;$ARR.forEach(dateOrTimeStr,function(str){isDateOrTime=isDateOrTime||pf.indexOf(str,0)!==-1;});if(isDateOrTime){pf=pf.replace(/y{3,}/g,year).replace(/y{1,2}/g,year.toString().slice(2,4));pf=pf.replace(/m{4,}/g,lcDateTime.MONTHNAME_FULL[month-1]).replace(/m{3}/g,lcDateTime.MONTHNAME_SHORT[month-1]).replace(/mm/g,"07").replace(/m/g,"7").replace(/7ber/g,"mber");pf=pf.replace(/d{4,}/g,lcDateTime.dayNames[weekDay-1]).replace(/d{3}/g,"Mon").replace(/dd/g,"10").replace(/d/g,"1").replace(/1ay/g,"day");pf=pf.replace(/hh/g,"08").replace(/h/g,"8");pf=pf.replace(/ss/g,"04").replace(/s/g,"4");pf=pf.split(ph);result=pf[0];$ARR.forEach(strInQuote,function(str,idx){result+=str+pf[idx+1];});return result;}return $NUM.formatByMask(format,1234.12);}function findIndex(items,value){return Math.max($ARR.find(items,"v",value),0);}function switchCategory(category){var categoryPicker=this.parent.parent.categoryPicker,idx=CATEGORY_ITEM.map(function(item){return item.v;}).indexOf(category);categoryPicker.set("selectedIndex",idx);}function getShortcutButton(cssClass,onclickFn,content,props){return $NIB(undefined,cssClass,onclickFn,undefined,$HASH.copy(props,{useRichTooltip:true,updateTooltipConfig:function(){this.richTooltip={cssClass:"vi-regular vi-tooltip-A A-center",content:content,refNode:this.domNode,posType:mstrmojo.tooltip.POS_TOPCENTER,left:15,top:33};}}));}function initLocaleDatetimeSamples(){if(mstrApp.isSingleTier){var formatterContainer=this.formatterContainer,datetime=$LC.datetime,sampleDate={day:7,month:4,year:1998},sampleTime={hour:15,min:41,sec:46},dateFormats=datetime&&datetime.DATEINPUTFORMATS,timeFormats=datetime&&datetime.TIMEINPUTFORMATS;localeDate=[];localeTime=[];dateFormats.forEach(function(item){localeDate.push({v:item,n:$DATE.formatDateInfo(sampleDate,item)});});timeFormats.forEach(function(item){localeTime.push({v:item,n:$DATE.formatTimeInfo(sampleTime,item)});});formatterContainer.date_ddl.set("items",localeDate);formatterContainer.time_ddl.set("items",localeTime);}else{localeDate=$FD.Date;localeTime=$FD.Time;}}mstrmojo.vi.ui.NumberFormatter=mstrmojo.declare(mstrmojo.VBox,null,{scriptClass:"mstrmojo.vi.ui.NumberFormatter",cssClass:"NumberFormatter-content",formatValue:null,myData:null,oldData:null,categoryPicker:null,formatterContainer:null,preview:null,shortcutRow:null,adjustAfterCategoryChange:mstrmojo.emptyFn,preBuildRendering:function(){if(this._super){this._super();}initLocaleDatetimeSamples.call(this);var formatterContainer=this.formatterContainer;if(this.formatValue){formatterContainer.currency_hBox1.currency_symbol.selectedValue=this.formatValue.currencySymbol;formatterContainer.fixed_btn.checked=!!this.formatValue.thousandSeparator;$CSS.addWidgetCssClass(formatterContainer.fraction_ddl,percentNegative[$ARR.find(percentNegative,"v",this.formatValue.negativeNumbers)].r?" red":"");}},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}if(this.formatValue){this.categoryPicker.set("selectedIndex",findIndex(this.categoryPicker.items,this.formatValue.category.toString()));}},children:[$HASH.copy({alias:"categoryPicker",cssClass:"nf-category",onitemSelected:function onitemSelected(item){if(!this.hasRendered){return ;}var $this=this,parent=$this.parent,formatterContainer=parent.formatterContainer,shortcutRow=parent.shortcutRow,previewLabel=parent.preview.preview_label,value=item.v,isAutomatic=value===categoryValue.Automatic,visibleWidgets=[],myData=parent.myData;$ARR.forEach(formatterContainer.children,function(child){child.set("visible",false);});parent.border.set("visible",!isAutomatic);parent.preview.set("visible",!isAutomatic);["border","moveLeftBtn","moveRightBtn"].forEach(function(childAlias){shortcutRow[childAlias].set("visible",!isAutomatic);});myData.set("category",value);myData.set("thousandSeparator",value?defaultValue.ThousandSeparator:parent.formatValue.thousandSeparator);switch(value){case categoryValue.Currency:resetNegativeListToDDL(formatterContainer.currency_hBox2.negativeDDL,currencyNegative,myData,false,myData.currencyPosition,myData.currencySymbol);formatterContainer.currency_hBox1.currency_position.set("selectedIndex",findIndex($FD.CurrencyPosition,myData.currencyPosition.toString()));visibleWidgets=["currency_hBox1","currency_hBox2"];break;case categoryValue.Date:formatterContainer.date_ddl.set("selectedIndex",findIndex(localeDate,myData.format));visibleWidgets=["date_ddl"];break;case categoryValue.Time:formatterContainer.time_ddl.set("selectedIndex",findIndex(localeTime,myData.format));visibleWidgets=["time_ddl"];break;case categoryValue.Percentage:resetNegativeListToDDL(formatterContainer.percentage_hBox.negativeDDL,percentNegative,myData,false,0,null);visibleWidgets=["percentage_hBox"];break;case categoryValue.Fraction:formatterContainer.fraction_ddl.set("selectedIndex",findIndex($FD.Fraction,myData.format));visibleWidgets=["fraction_ddl"];break;case categoryValue.Scientific:var scientificFormat=getScientificFormat(myData.decimalPlaces||0);myData.set("format",scientificFormat[1]);previewLabel.set("text",scientificFormat[0]);break;case categoryValue.Custom:var customText=myData.customText||myData.format,textBox=formatterContainer.custom_text;myData.set("format",customText);textBox.value=customText;textBox.refresh();previewLabel.set("text",getFormatPreview(customText));visibleWidgets=["custom_condense","custom_text"];break;case categoryValue.Fixed:resetNegativeListToDDL(formatterContainer.fixed_hBox.negativeDDL,fixedNegative,myData,!myData.thousandSeparator,0,null);visibleWidgets=["fixed_hBox","fixed_btn"];break;}$ARR.forEach(visibleWidgets,function(childAlias){formatterContainer[childAlias].set("visible",true);});parent.adjustAfterCategoryChange();}},getDropDownListCfg(CATEGORY_ITEM,"category")),{scriptClass:"mstrmojo.Box",cssClass:"nf-MiddleRow nf-shortcut",alias:"shortcutRow",border:null,moveLeftBtn:null,moveRightBtn:null,children:[getShortcutButton("nf-shortcut-currency",function onclick(){switchCategory.call(this,categoryValue.Currency);},mstrmojo.desc(2051,"Currency"),undefined),getShortcutButton("nf-shortcut-percentage",function onclick(){switchCategory.call(this,categoryValue.Percentage);},mstrmojo.desc(2053,"Percentage"),undefined),getShortcutButton("nf-shortcut-fixed",function onclick(){switchCategory.call(this,categoryValue.Fixed);this.parent.parent.formatterContainer.fixed_btn.set("checked",true);},mstrmojo.desc(2050,"Fixed"),undefined),{scriptClass:"mstrmojo.Label",cssClass:"shortcut-border",alias:"border"},getShortcutButton("nf-MoveDecimalPoint left",function onclick(){onMovePointButtonsClick.call(this);},mstrmojo.desc(2189,"Increase Decimal"),{funcType:$EF.FunctionLeftStr,alias:"moveLeftBtn"}),getShortcutButton("nf-MoveDecimalPoint right",function onclick(){onMovePointButtonsClick.call(this);},mstrmojo.desc(2188,"Decrease Decimal"),{funcType:$EF.FunctionRightStr,alias:"moveRightBtn"})]},{scriptClass:"mstrmojo.Label",alias:"border",cssClass:"nf-border"},{scriptClass:"mstrmojo.Container",alias:"formatterContainer",cssClass:"nf-buttons",markupString:'<div id="{@id}" class="{@cssClass}" style="{@cssText}"></div>',fixed_hBox:null,fixed_btn:null,currency_hBox1:null,currency_hBox2:null,date_ddl:null,time_ddl:null,percentage_hBox:null,fraction_ddl:null,custom_condense:null,custom_text:null,markupSlots:{containerNode:function containerNode(){return this.domNode;}},children:[{scriptClass:"mstrmojo.HBox",alias:"fixed_hBox",cssClass:"nf-MiddleRow",negativeDDL:null,children:[{scriptClass:"mstrmojo.Label",cssClass:"negative-label",text:mstrmojo.desc(13891,"Negative:")},$HASH.copy({alias:"negativeDDL",cssClass:"nf-NegativePullDown",getOptionProps:getItemProps,onitemSelected:function onitemSelected(item){onNegativeDDLValueChange.call(this,item);}},getDropDownListCfg([],"format"))]},{scriptClass:"mstrmojo.CheckBox",alias:"fixed_btn",cssClass:"nf-MiddleRow",label:mstrmojo.desc(13898,"Use 1000 Separator(#)").replace("#",$LC.number.THOUSANDSEPARATOR),onclick:function onclick(){var p=this.parent.parent;p.myData.set("thousandSeparator",this.checked?-1:0);resetNegativeListToDDL(this.parent.fixed_hBox.negativeDDL,fixedNegative,p.myData,!this.checked,0,null);}},{scriptClass:"mstrmojo.HBox",alias:"currency_hBox1",cssClass:"nf-MiddleRow",visible:true,currency_symbol:null,currency_position:null,children:[{scriptClass:"mstrmojo.ui.editors.controls.ComboBox",alias:"currency_symbol",cssClass:"nf-CurrencySymbol",selectedValue:"$",items:CURRENCY_SYMBOL_ITEM,postselectedValueChange:function postselectedValueChange(evt){var $this=this,p=$this.parent.parent.parent,value=evt.value,myData=p.myData;myData.set("currencySymbol",value);resetNegativeListToDDL(this.parent.parent.currency_hBox2.negativeDDL,currencyNegative,myData,false,parseInt(myData.currencyPosition,10),value);}},$HASH.copy({cssClass:"nf-CurrencyPosition align-right",alias:"currency_position",onitemSelected:function onitemSelected(item){var $this=this,p=$this.parent.parent.parent,value=item.v;p.myData.set("currencyPosition",parseInt(value,10));resetNegativeListToDDL(this.parent.parent.currency_hBox2.negativeDDL,currencyNegative,p.myData,false,parseInt(value,10),p.myData.currencySymbol);}},getDropDownListCfg($FD.CurrencyPosition,"currencyPosition"))]},{scriptClass:"mstrmojo.HBox",alias:"currency_hBox2",cssClass:"nf-MiddleRow",negativeDDL:null,children:[{scriptClass:"mstrmojo.Label",cssClass:"negative-label",text:mstrmojo.desc(13891,"Negative:")},$HASH.copy({alias:"negativeDDL",cssClass:"nf-NegativePullDown",getOptionProps:getItemProps,onitemSelected:function onitemSelected(item){onNegativeDDLValueChange.call(this,item);}},getDropDownListCfg([],"format"))]},$HASH.copy({alias:"date_ddl",cssClass:"nf-MiddleRow"},getDropDownListCfg($FD.Date,"format",true)),$HASH.copy({alias:"time_ddl",cssClass:"nf-MiddleRow"},getDropDownListCfg($FD.Time,"format",true)),{scriptClass:"mstrmojo.HBox",alias:"percentage_hBox",cssClass:"nf-MiddleRow",negativeDDL:null,children:[{scriptClass:"mstrmojo.Label",cssClass:"negative-label",text:mstrmojo.desc(13891,"Negative:")},$HASH.copy({alias:"negativeDDL",cssClass:"nf-NegativePullDown",getOptionProps:getItemProps,onitemSelected:function onitemSelected(item){onNegativeDDLValueChange.call(this,item);}},getDropDownListCfg([],"format"))]},$HASH.copy({alias:"fraction_ddl",cssClass:"nf-MiddleRow"},getDropDownListCfg($FD.Fraction,"format",true)),mstrmojo.Button.newWebButton(mstrmojo.desc(13893,"Condense (e.g.10M)"),function(){this.parent.custom_text.set("value",'[>=1000000]#,##0,,"M";[>=1000]#,##0,"K";0');},false,{cssClass:"nf-condense",alias:"custom_condense"}),{scriptClass:"mstrmojo.TextBox",alias:"custom_text",cssClass:"nf-custom",onvalueChange:function onvalueChange(){var $this=this,p=$this.parent.parent,value=$this.value;p.myData.set("format",value);p.myData.set("customText",value);$this.parent.parent.preview.preview_label.set("text",getFormatPreview(value).replace(/\s/g,"&nbsp;"));}}]},{scriptClass:"mstrmojo.HBox",alias:"preview",cssClass:"nf-MiddleRow",preview_label:null,children:[{scriptClass:"mstrmojo.Label",cssClass:"preview_lable",text:mstrmojo.desc(13892,"Preview:")},{scriptClass:"mstrmojo.Label",cssClass:"align-right",alias:"preview_label"}]}]});}());