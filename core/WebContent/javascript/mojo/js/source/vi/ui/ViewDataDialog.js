(function(){mstrmojo.requiresCls("mstrmojo.Dialog","mstrmojo.dom","mstrmojo.array","mstrmojo.hash","mstrmojo.Box","mstrmojo.vi.ui.toolbars._HasToolbar","mstrmojo.vi.ui.toolbars.Toolbar","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.ui.rw._IsViewDataGrid","mstrmojo.vi.ui.rw.xtab.ViewDataXtabMenuConfig");var $A=mstrmojo.array,$H=mstrmojo.hash,$D=mstrmojo.dom,$NWB=mstrmojo.Button.newWebButton,$DS_UTILS=mstrmojo.vi.ui.DatasetUnitMenuUtils,EXCEL_EXPORT=4,PDF_EXPORT=3,CSV_EXPORT=10,move,isPopupAllowed=function isPopupAllowed(name,context){var xtab=context&&context.xtab;if(xtab){var cell=context.xtab.getCellForNode(context.td),axis=cell.axis;if((axis===2&&cell.hasOwnProperty("mix"))||(axis===1&&cell.es)){cell.at=cell.at&24;return true;}return false;}return true;},getDZUnits=function getDZUnits(mod,dzm){var units=[],dataSetUnits=mod.getDatasetUnits(["mx","att"]),dropZones=dzm&&dzm.getDropZones();if(dropZones&&dropZones.zones){dropZones.zones.forEach(function(zone){zone.items.forEach(function(item){if(parseInt(item.did,10)!==-1){units.push(dataSetUnits[$A.find(dataSetUnits,"did",item.did)]);}});});}return units;},getAvailUnits=function(mod,originalDZ,dsid){var originalUnits=getDZUnits(mod,originalDZ);return mod.getDatasetUnits(["mx","att"],null,dsid).filter(function(unit){return $A.find(originalUnits,"did",unit.did)===-1&&!unit.hide;});},createAddUnitsEditorConfig=function createAddUnitsEditorConfig(){var myGrid=this.grid,mod=this.model,selVi=mod.getSelectedViUnit(),dsid=selVi.boxContent.model.data.datasetId,originalDZ=selVi.getZonesModel(),unitCheckLists=[],mapper=function(unit){unit.tooltip=unit.n+" ("+unit.ds+")";return unit;},availUnits=getAvailUnits(mod,originalDZ,dsid),atts=(availUnits.filter(function(unit){return unit.t!==4;})).map(mapper),mx=(availUnits.filter(function(unit){return unit.t===4;})).map(mapper),getSelectedIndices=function(items){var selected={};(items||[]).forEach(function(item,idx){if($A.find(getDZUnits(mod,myGrid.zonesModel),"did",item.did)>-1){selected[idx]=true;}});return selected;},removeHiddenItems=function(items){return(items||[]).filter(function(item){return !item.hide||item.usedInDropZones;});},addSelectAllItem=function(items){items.unshift({t:"All",formType:3,n:mstrmojo.desc(4928,"All"),tooltip:"Select All Objects"});return items;};function addEditorChild(title,items){items=removeHiddenItems(items);items=addSelectAllItem(items);if(items.length){var list=new mstrmojo.ui.CheckList({cssClass:"units",allIdx:0,items:items.map(function(item){item.tt=item.n+" ("+item.ds+")";item.css=$DS_UTILS.getUnitCssClass(item);return item;}),selectedIndices:getSelectedIndices(items)});unitCheckLists.push({scriptClass:"mstrmojo.vi.ui.PanelPortlet",title:title,children:[list],getSelectedItems:function(){var selectedItems=list.getSelectedItems();if(selectedItems.length>0&&selectedItems[0].t=="All"){selectedItems.shift();}return selectedItems||[];}});}}addEditorChild(mstrmojo.desc(3581,"Attributes"),$DS_UTILS.getSortedDatasetUnits(atts));addEditorChild(mstrmojo.desc(3582,"Metrics"),$DS_UTILS.getSortedDatasetUnits(mx));return new mstrmojo.ui.menus.EditorConfig({data:{},cssClass:"mstrmojo-ui-Menu visible datasetObjects",contents:unitCheckLists,hostId:this.id,fnOk:function(){var selectedItems=[],add,remove,myDZM=myGrid.zonesModel,zones=myDZM.getDropZones().zones,cols=zones[1],rows=zones[0],actions=[],colLen=cols.items.length+1,rowLen=rows.items.length+1,ou=getDZUnits(myDZM.docModel,myDZM),originalUnits=getDZUnits(mod,originalDZ);unitCheckLists.forEach(function(portlet){selectedItems=selectedItems.concat(portlet.getSelectedItems());});add=(selectedItems||[]).filter(function(unit){return $A.find(ou,"did",unit.did)===-1;});remove=(ou||[]).filter(function(unit){if(unit.did==="-1"){return false;}return $A.find(selectedItems,"did",unit.did)===-1&&$A.find(originalUnits,"did",unit.did)===-1;});add.forEach(function(unit){actions.push(myGrid.model.getAddTemplateUnitAction(unit,dsid,(unit.t===4?cols:rows).id,unit.t===4?colLen++:rowLen++));});remove.forEach(function(unit){actions.push(myGrid.model.getRemoveTemplateUnitAction(unit));});myGrid.controller.onSubmitTemplateUpdates(myGrid,actions);}});},getCallBack=function(model,fromGrid,showUnits){return{success:function success(newGrid){var w=mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.ViewDataDialog",grid:newGrid,model:model,isViewFilter:fromGrid,showUnits:showUnits});w.set("visible",true);w.render();},failure:function failure(res){throw {message:"Couldn't open view data dialog <br>("+(res.message||"")+")",name:"Something went wrong"};}};},getTargetKey=function(model){return mstrApp.rootCtrl.docCtrl.view.builder.getLayoutVIMap(model.getCurrentLayoutKey()).getComponent(5).selectedKey;},grid,keydown=function keydown(e){if(e&&mstrmojo.dom.isMetaKey(null,e)&&e.keyCode===65&&grid){grid.selectAll();return false;}return true;},addExportOptions=function addExportOptions(exportItems){var isSingleTier=mstrApp.isSingleTier;if(isSingleTier||!!mstrApp.features["web-export-to-excel-privilege"]){exportItems.push({n:mstrmojo.desc(3958,"Excel"),v:EXCEL_EXPORT});}if(isSingleTier||!!mstrApp.features["web-export-to-pdf-privilege"]){exportItems.push({n:mstrmojo.desc(1877,"PDF"),v:PDF_EXPORT});}if(isSingleTier||!!mstrApp.features["web-export-to-csv-privilege"]){exportItems.push({n:mstrmojo.desc(11807,"Data"),v:CSV_EXPORT});}};mstrmojo.vi.ui.ViewDataDialog=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.vi.ui.toolbars._HasToolbar],{scriptClass:"mstrmojo.vi.ui.ViewDataDialog",title:mstrmojo.desc(11476,"Show Data"),help:"show_data_dialog_box_for_html5_dashboards.htm",cssClass:"mstrmojo-ViewDataDialog",modal:true,visible:false,btnAlignment:"right",init:function init(props){var newGrid=props.grid,that=this,oo,exportArray=[];if(!newGrid.openPopup){newGrid.requiresCls(["mstrmojo._HasPopup"]);}this.grid=newGrid;newGrid.viewDataDialog=this;grid=newGrid;oo=newGrid.openPopup;newGrid.openPopup=function(){if(isPopupAllowed.apply(newGrid,arguments)&&oo){oo.apply(newGrid,arguments);}};newGrid.model.canShowCellMenu=function(cell){var union=newGrid.model.getCellDataUnion(cell);return !!cell&&(union.length===0||(union.length===1&&!union[0].eid));};this.set("buttons",[$NWB(mstrmojo.desc(2177,"Close"),function(){that.close();})]);addExportOptions.call(this,exportArray);props.children=[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-toolBox",alias:"tools",children:[{scriptClass:"mstrmojo.vi.ui.toolbars.Toolbar",alias:"toolbar",useRichTooltip:true,visible:props.showUnits},{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"mstrmojo-export-type",alias:"exportType",value:mstrmojo.desc(13287,"Export Data"),isHostedWithin:true,items:exportArray,visible:exportArray.length>0,onitemSelected:function(item){this.selectedNode.innerHTML=mstrmojo.desc(121,"Export Data");that.xport(item.v);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-addGridButton mstrmojo-WebHoverButton",text:mstrmojo.desc(11893,"Add as Grid"),onclick:function(){that.close(true);},bindings:{visible:function(){return mstrApp.allowWebDashboardDesign();}}},{scriptClass:"mstrmojo.Label",alias:"rowCount",cssClass:"mstrmojo-rowcount",text:""}],slot:"containerNode"},{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-gridBox",children:[newGrid],slot:"containerNode"}];$D.attachEvent(document.body,"keydown",keydown);this._super(props);},postBuildRendering:function postBuildRendering(){this._super();var exportType=this.tools.exportType;if(exportType.visible){exportType.list.popupConfig.clear();}else{this.tools.rowCount.domNode.className+=" no-export";}var hiddenField=document.createElement("textarea");hiddenField.className="hiddenArea";hiddenField.onblur=function(){hiddenField.focus();hiddenField.select();};this.editorNode.appendChild(hiddenField);this.grid.hiddenField=hiddenField;},openXtabCellMenu:function openXtabCellMenu(cfg){var dl=mstrApp.rootCtrl.document,menuConfig=new mstrmojo.vi.ui.rw.xtab.ViewDataXtabMenuConfig({isHostedWithin:false,position:cfg.cmPos||$D.position(cfg.btn.domNode),hostId:this.id});menuConfig.buildXtabMenuConfig($H.copy({tabularGrid:true,hideAdvancedSort:true},cfg));if(menuConfig.hasMenuItems()){cfg.opener=this;dl.openPopup(menuConfig.newInstance(),cfg);}},closePopup:function(){var dl=mstrApp.rootCtrl.document;if(dl){dl.closePopup();}},close:function close(copy){var that=this;$D.detachEvent(document.body,"keyup",keydown);grid=null;this.model.controller.startAutoRefresh();this.model.removeViewDataGrid(this.grid,!!copy,move,{failure:function failure(res){throw {name:"Something went wrong.",message:"Couldn't close view data dialog <br>("+(res.message||"")+")"};}});that.destroy();},xport:function xport(mode){var controller=this.model.controller;switch(mode){case CSV_EXPORT:controller.exportCSV(this.grid.k);break;default:controller.exportVisualization(this.grid,mode);}},updateToolbar:function updateToolbar(cfg){var $this=this,mod=this.model,selVi=mod.getSelectedViUnit(),dsid=selVi.boxContent.model.data.datasetId,originalDZ=selVi.getZonesModel(),availUnits=getAvailUnits(mod,originalDZ,dsid);cfg.btns.push({n:mstrmojo.desc(11780,"Add Data"),cls:"add mojo-theme-dark mstrmojo-Button mstrmojo-WebButton"+(availUnits.length===0?" disabled":""),fn:function(item,toolbar){if(availUnits.length!==0){toolbar.openMenu(createAddUnitsEditorConfig.call($this),item);}}});return cfg;},passToolbarCfg:function passToolbarCfg(cfg){this.tools.toolbar.set("toolbarCfg",cfg);},oncontextmenu:function(evt){$D.preventDefault(window,evt.e);return false;}});mstrmojo.vi.ui.ViewDataDialog.openDS=function(model,dataset,datasetId){move=model.createViewDataGrid(model.getDatasetUnits(["mx","att"],null,datasetId),model.getCurrentLayoutKey(),null,getCallBack(model,false,false),datasetId);};mstrmojo.vi.ui.ViewDataDialog.openDSTable=function(model,dataset,datasetId,tableIx){move=model.createViewDataGrid(model.getDatasetUnits(["mx","att"],null,datasetId,tableIx),model.getCurrentLayoutKey(),null,getCallBack(model,false,false),datasetId);};mstrmojo.vi.ui.ViewDataDialog.open=function(vizBox,fromGrid){var model=vizBox.getDocModel(),controller=model.controller;if(controller.autoRefReqSent){mstrApp.serverProxy.cancelRequest(controller.autoRefReqId);}controller.pauseAutoRefresh();vizBox.selectVIUnit();var boxContent=vizBox.boxContent,mdata=boxContent.model.data,gm=boxContent.model,selections=(boxContent.getSelections&&boxContent.getSelections())||{},selectorData,createVDGrid=function createVDGrid(){move=model.createViewDataGrid(null,getTargetKey(model),selectorData,getCallBack(model,fromGrid,true),null,boxContent,vizBox.getZonesModel().getDropZones());};if(fromGrid){selectorData=gm.getSelectorDataFromViewFilter(mdata.vfexpr)||[];selectorData=selectorData.concat({keepOnly:true,data:selections});createVDGrid();}else{createVDGrid();}};}());