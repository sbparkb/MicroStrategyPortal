(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.UnitList","mstrmojo.vi.ui.PanelPortlet","mstrmojo.vi.ui._HasUnitListAvatar","mstrmojo.vi.models.EnumDragSources","mstrmojo._HasMarkup","mstrmojo._HasLayout","mstrmojo.dom","mstrmojo.hash","mstrmojo.array","mstrmojo.vi.ui.DatasetUnitMenuUtils");var $HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$FUNC=mstrmojo.func,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,addMarkupMethods=mstrmojo._HasMarkup.addMarkupMethods,ALIAS_DIMENSIONS="dimensions",ALIAS_ROOT_METRIC_FOLDER="metricFolder",ALIAS_FOLDERS="folders",ALIAS_METRICS="metrics",ALIAS_LEVELS="levels",ALIAS_DERIVED_OBJECTS="derivedObjects",ALIAS_MULTI_LEVEL_HIERARCHIES="multiLevelHierarchies",ALIAS_SINGLE_LEVEL_HIERARCHIES="singleLevelHierarchies",ALIAS_RECURSIVE_ATTRIBUTES="recursiveAttributes",ALIAS_EMPTY_INDICATOR="_emptyIndicator";function unitListCfg(treeContext,cfg){var fullConfig=$HASH.copy(cfg,{scriptClass:treeContext.unitListScriptClass,treeContext:treeContext,docModel:treeContext.docModel,panelId:treeContext.datasetsPanelId,_isUnitList:true,draggable:false,postCreate:function postCreate(){this.doubleClickItem=$FUNC.composite([this.doubleClickItem,treeContext.doubleClickItemHandler]);},onallItemsChange:function onallItemsChange(){this.reloadItems();},getAllItems:function getAllItems(){return this.allItems||[];},isEmpty:function isEmpty(){return !(this.items&&this.items.length);}});fullConfig.bindings=$HASH.copy(cfg.bindings,{dataset:function(){var dataset=this.treeContext.dataset;return dataset&&{id:dataset.did,set:dataset};},filterScope:"this.treeContext.filterScope",filterExpr:"this.treeContext.filterExpr",filterFunc:"this.treeContext.filterFunc",level:"this.parent.level + 1"});return fullConfig;}function nodeListCfg(treeContext,cfg){return $HASH.copy(cfg,{scriptClass:"mstrmojo.vi.ui.MDXTreeNodeList",treeContext:treeContext});}function portletCfg(treeContext,cfg){return $HASH.copy(cfg,{treeContext:treeContext});}mstrmojo.vi.ui._IsMDXTreeComponent=mstrmojo.provide("mstrmojo.vi.ui._IsMDXTreeComponent",{treeContext:null,data:null,setting:null,isEmpty:function isEmpty(){return this.getRealChildren().every(function(child){return child.isEmpty();});},isRealChild:function isRealChild(child){return !child.ignoredChild;},getRealChildren:function getRealChildren(){return(this.children||[]).filter(this.isRealChild,this);},getSelectedItems:function getSelectedItems(){return this.getRealChildren().reduce(function(items,child){return items.concat(child.getSelectedItems());},[]);},clearSelect:function clearSelect(){this.getRealChildren().forEach(function(child){child.clearSelect();});}});mstrmojo.vi.ui.MDXTreePortletNode=mstrmojo.declare(mstrmojo.vi.ui.PanelPortlet,[mstrmojo.vi.ui._IsMDXTreeComponent],{scriptClass:"mstrmojo.vi.ui.MDXTreePortletNode",ignoreLayout:false,getLayoutOffsets:function(){return{h:0,w:0};},handleDataChange:mstrmojo.emptyFn,init:function init(props){var me=this;this._super(props);this.treeContext.view.attachEventListener("toggleAllCollapsed",this.id,function(evt){if(evt.isRecover){me.togglePortlet(me.setting?me.setting.getCollapsed():me.defaultCollapsed?me.defaultCollapsed:false);}else{if(evt.changeSetting){me.setting.isCollapsed=evt.isCollapsed;}me.togglePortlet(evt.isCollapsed);}});},isRealChild:function isRealChild(child){return child.alias!=="titleBar"&&this._super(child);},onCollapsedChange:function(){this.treeContext.view.onNodeCollapsedChange(this);}});addMarkupMethods(mstrmojo.vi.ui.MDXTreePortletNode,{ondataChange:function ondataChange(){this.handleDataChange();}});mstrmojo.vi.ui.MDXTreeNodeList=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasLayout,mstrmojo.vi.ui._IsMDXTreeComponent],{scriptClass:"mstrmojo.vi.ui.MDXTreeNodeList",treeContext:null,data:null,createChildConfig:null,layoutConfig:{w:{containerNode:"100%"},xt:true}});addMarkupMethods(mstrmojo.vi.ui.MDXTreeNodeList,{ondataChange:function ondataChange(){this.destroyChildren();this.addChildren((this.data||[]).map(this.createChildConfig,this));}});mstrmojo.vi.ui.MDXDimension=mstrmojo.declare(mstrmojo.vi.ui.MDXTreePortletNode,null,{scriptClass:"mstrmojo.vi.ui.MDXDimension",handleDataChange:function handleDataChange(){var data=this.data,recursiveAttributes=[],multiLevelHierarchies=[];if(data.recursiveAtt&&data.recursiveAtt.length>0){data.recursiveAtt.forEach(function(ra){recursiveAttributes.push(ra);});}else{data.hierarchies.forEach(function(hierarchy){multiLevelHierarchies.push(hierarchy);});}this[ALIAS_MULTI_LEVEL_HIERARCHIES].set("data",multiLevelHierarchies);this[ALIAS_RECURSIVE_ATTRIBUTES].set("allItems",recursiveAttributes);},init:function init(props){var me=this;this._super(props);this.addChildren([nodeListCfg(this.treeContext,{alias:ALIAS_MULTI_LEVEL_HIERARCHIES,createChildConfig:function(hierarchyData){var setting=me.setting&&me.setting.hierarchy&&me.setting.hierarchy(hierarchyData.did);return portletCfg(this.treeContext,{scriptClass:"mstrmojo.vi.ui.MDXHierarchy",title:hierarchyData.n,data:hierarchyData,setting:setting,defaultCollapsed:true,isCollapsed:setting?!!(setting.getCollapsed()):true,level:me.level+1});}}),unitListCfg(this.treeContext,{alias:ALIAS_RECURSIVE_ATTRIBUTES})]);}});mstrmojo.vi.ui.MDXHierarchy=mstrmojo.declare(mstrmojo.vi.ui.MDXTreePortletNode,null,{scriptClass:"mstrmojo.vi.ui.MDXHierarchy",init:function init(props){this._super(props);this.addChildren([unitListCfg(this.treeContext,{alias:ALIAS_LEVELS,bindings:{allItems:"this.parent.data.att"}})]);}});mstrmojo.vi.ui.MDXMetricFolder=mstrmojo.declare(mstrmojo.vi.ui.MDXTreePortletNode,null,{scriptClass:"mstrmojo.vi.ui.MDXMetricFolder",init:function init(props){var me=this;this._super(props);this.addChildren([nodeListCfg(this.treeContext,{alias:ALIAS_FOLDERS,bindings:{data:"this.parent.data && this.parent.data.folders"},createChildConfig:function(folderData){var setting=me.setting&&me.setting.folder&&me.setting.folder(folderData.n);return portletCfg(this.treeContext,{scriptClass:"mstrmojo.vi.ui.MDXMetricFolder",title:folderData.n,data:folderData,setting:setting,defaultCollapsed:true,isCollapsed:setting?!!(setting.getCollapsed()):true,level:me.level+1});}}),unitListCfg(this.treeContext,{alias:ALIAS_METRICS,bindings:{allItems:"this.parent.data.mx"}})]);}});function updateChildrenVisible(){var setChildVisible=function(){if(this.isEmpty){var isEmpty=this.isEmpty();this.set("visible",!isEmpty);if(!isEmpty){var children=this.getRealChildren&&this.getRealChildren();if(children&&children.length){children.forEach(function(child){setChildVisible.call(child);});}}}};this[ALIAS_EMPTY_INDICATOR].set("visible",this.isEmpty());this.getRealChildren().forEach(function(child){setChildVisible.call(child);});}mstrmojo.vi.ui.DatasetMDXView=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasLayout,mstrmojo.vi.ui._HasUnitListAvatar,mstrmojo.vi.ui._IsMDXTreeComponent],{scriptClass:"mstrmojo.vi.ui.DatasetMDXView",draggable:true,avatarCssClass:"mstrmojo-VIUnitList",data:null,unitListScriptClass:"",docModel:null,datasetsPanelId:"",layoutConfig:{w:{containerNode:"100%"},xt:true},onNodeCollapsedChange:mstrmojo.emptyFn,init:function init(props){this._super(props);var me=this;var treeContext=this.treeContext=new mstrmojo.Model({view:this,docModel:this.docModel,datasetsPanelId:this.datasetsPanelId,unitListScriptClass:this.unitListScriptClass,bindings:{dataset:"this.view.data",table:"this.dataset && this.dataset.tables && this.dataset.tables[0]",filterExpr:"this.view.filterExpr",filterScope:"this.view.filterScope",filterFunc:"this.view.filterFunc"},doubleClickItemHandler:mstrmojo.all[this.datasetsPanelId].doubleClickItemHandler});var rootMetricFolderSetting=me.setting&&me.setting.rootMetricFolder;this.addChildren([nodeListCfg(treeContext,{alias:ALIAS_DIMENSIONS,bindings:{data:"this.treeContext.table && this.treeContext.table.dimensions",visible:'this.treeContext.filterScope !== "mx"'},createChildConfig:function(dimensionData){var setting=me.setting&&me.setting.dimension&&me.setting.dimension(dimensionData.did);return portletCfg(this.treeContext,{scriptClass:"mstrmojo.vi.ui.MDXDimension",data:dimensionData,title:dimensionData.n,setting:setting,defaultCollapsed:true,isCollapsed:setting?!!(setting.getCollapsed()):true,level:me.level+1});}}),portletCfg(this.treeContext,{alias:ALIAS_ROOT_METRIC_FOLDER,scriptClass:"mstrmojo.vi.ui.MDXMetricFolder",bindings:{data:"this.treeContext.table && this.treeContext.table.metricFolder",visible:'this.treeContext.filterScope !== "att"'},title:mstrmojo.desc(14007,"Measures"),setting:rootMetricFolderSetting,isCollapsed:rootMetricFolderSetting?!!(rootMetricFolderSetting.getCollapsed()):false,level:me.level+1}),unitListCfg(treeContext,{alias:ALIAS_DERIVED_OBJECTS,bindings:{allItems:function(){var dataset=this.treeContext.dataset;return dataset&&[].concat(dataset.att).concat(dataset.mx).filter(function(item){return $DU.isDocumentLevelItem(item);})||[];}}})]);},markupMethods:{onfilterExprChange:function(){if(this.hasRendered){updateChildrenVisible.call(this);}}},onRender:function(){this._super();updateChildrenVisible.call(this);},toggleAllNodesCollapsed:function toggleAllNodesCollapsed(isCollapsed,changeSetting,isRecover){this.raiseEvent({name:"toggleAllCollapsed",isCollapsed:isCollapsed,changeSetting:changeSetting,isRecover:isRecover});},children:[{alias:ALIAS_EMPTY_INDICATOR,cssClass:"emptyIndicator",scriptClass:"mstrmojo.Label",ignoredChild:true,bindings:{text:function(){if(!this.visible){return"";}return this.parent.filterExpr?mstrmojo.desc(11904,"No matched object"):mstrmojo.desc(11905,"No object");}}}],isDragValid:function isDragValid(context){return !isNaN(parseInt(context.src.node.getAttribute("idx"),10))||this._super(context)||false;},ondragstart:function ondragstart(context){var srcNode=context.src.node;var widget=$DOM.findWidget(srcNode);while(widget&&widget!==this){if(widget._isUnitList&&widget.treeContext===this.treeContext){widget.selectDragNode(context);break;}widget=widget.parent;}return this._super(context);},getDragData:function getDragData(context){var info=this._super(context);info.item=info.items&&info.items[0];info.dsid=this.data.id||this.data.did;info.src=mstrmojo.vi.models.EnumDragSources.DATASETS;return info;}});}());