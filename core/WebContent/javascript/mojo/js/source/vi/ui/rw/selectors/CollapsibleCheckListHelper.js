(function(){mstrmojo.requiresCls("mstrmojo.Base","mstrmojo.hash");var $HASH=mstrmojo.hash,JSON_ATTRIBUTE_TYPE="t",JSON_TYPE_VALUE_ALL=14;mstrmojo.vi.ui.rw.selectors.CollapsibleCheckListHelper=mstrmojo.declare(mstrmojo.Base,null,{scriptClass:"mstrmojo.vi.ui.rw.selectors.CollapsibleCheckListHelper",init:function init(props){if(!props.checkList){throw new Error(this.scriptClass+" must be initialized with a CollapsibleCheckList instance.");}this._super(props);this.preDataProcess();},preDataProcess:function preDataProcess(){var checkList=this.checkList,nodeData=checkList.docSelector.node.data,items=nodeData.elms,item,nItems=items.length,rootIndices=checkList.rootIndices,p_relation=nodeData.p_relation,i,pIdx;if(!rootIndices||!items[0].childrenIndices){rootIndices=checkList.rootIndices=[];this.resetChildrenIndices();for(i=0;i<nItems;i++){pIdx=p_relation[i].p_index;if(pIdx<0){if(items[i][JSON_ATTRIBUTE_TYPE]!==JSON_TYPE_VALUE_ALL){rootIndices.push(i);}else{items[i]._renderIdx=0;}}else{items[pIdx].childrenIndices.push(i);}}this.setHasChildren();this.initItemExpandStatus();}},resetChildrenIndices:function initChildrenIndices(){var items=this.checkList.items,nItems=items.length,i;for(i=0;i<nItems;i++){items[i].childrenIndices=[];}},setHasChildren:function setHasChildren(){var items=this.checkList.items,nItems=items.length,i;for(i=0;i<nItems;i++){items[i].hcd=items[i].childrenIndices.length>0;}},initItemExpandStatus:function initItemExpandStatus(){var items=this.checkList.items,p_relation=this.checkList.docSelector.node.data.p_relation,nItems=items.length,i;for(i=0;i<nItems;i++){items[i].epd=false;items[i].isCollapsedHidden=p_relation[i].p_index>=0;}},updateCachedSelectedDescendantsCount:function updateCachedSelectedDescendantsCount(){var rootIndices=this.checkList.rootIndices,i,rootCount=rootIndices.length;for(i=0;i<rootCount;i++){this.getAndCacheSelectedDescendantsCount(rootIndices[i],false);}},getAndCacheSelectedDescendantsCount:function getAndCacheSelectedDescendantsCount(index,useCache){var item=this.checkList.docSelector.node.data.elms[index],nChildren,i;if(item.nSelectedDescendants===undefined||!useCache){item.nSelectedDescendants=this.getAndCacheSelectedChildrenCount(index,useCache);nChildren=item.childrenIndices.length;for(i=0;i<nChildren;i++){item.nSelectedDescendants+=this.getAndCacheSelectedDescendantsCount(item.childrenIndices[i],useCache);}}return item.nSelectedDescendants;},getAndCacheSelectedChildrenCount:function getAndCacheSelectedChildrenCount(index,useCache){var item=this.checkList.docSelector.node.data.elms[index],nChildren,i;if(item.nSelectedChildren===undefined||!useCache){item.nSelectedChildren=0;nChildren=item.childrenIndices.length;for(i=0;i<nChildren;i++){if(this.checkList.selectedIndices[item.childrenIndices[i]]){item.nSelectedChildren+=1;}}}return item.nSelectedChildren;},getAndCacheDescendantsCount:function getAndCacheDescendantsCount(index){var item=this.checkList.docSelector.node.data.elms[index],nChildren,i;if(item.nDescendants===undefined){nChildren=item.childrenIndices.length;item.nDescendants=nChildren;for(i=0;i<nChildren;i++){item.nDescendants+=this.getAndCacheDescendantsCount(item.childrenIndices[i]);}}return item.nDescendants;},isAllItemsSelected:function isAllItemsSelected(){var checkList=this.checkList,selectedIndices=checkList.selectedIndices,i,selectedCount,itemsCount=checkList.items.length-1;selectedCount=0;for(i in selectedIndices){if(i==="0"){continue;}selectedCount++;}return selectedCount===itemsCount;},getLevelCount:function getLevelCount(){var count,checkList=this.checkList;if(isNaN(checkList.levelCount)){count=0;$HASH.forEach(checkList.items,function(v,k,obj){if(!isNaN(v.lv)&&count<v.lv){count=v.lv;}});checkList.levelCount=count+1;}return checkList.levelCount;},isBranchSelected:function isBranchSelected(idx){var checkList=this.checkList,childrenIndices=checkList.items[idx].childrenIndices;if(checkList.selectedIndices[idx]){for(var c in childrenIndices){if(!isBranchSelected.call(this,childrenIndices[c])){return false;}}return true;}return false;},isLevelSelected:function isLevelSelected(levelNumber,levelIndices){var checkList=this.checkList,selectedIndices=checkList.selectedIndices;if(selectedIndices[0]){return true;}else{var i,lvlIndices=levelIndices||this.getLevelIndices(levelNumber),n=lvlIndices.length;for(i=0;i<n;i++){if(!selectedIndices[lvlIndices[i]]){return false;}}}return true;},getBranchIndices:function getBranchIndices(idx){var indices=[],items=this.checkList.items;function fn(items,idx){var childrenIndices=items[idx].childrenIndices;indices.push(idx);for(var c in childrenIndices){fn(items,childrenIndices[c]);}}fn(items,idx);return indices;},getLevelIndices:function getLevelIndices(levelNumber){var indices=[];$HASH.forEach(this.checkList.items,function fn(v,k,hash){if(v.lv===levelNumber){indices.push(parseInt(k,10));}});return indices;}});}());