(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.hash","mstrmojo.array","mstrmojo.Box","mstrmojo.MenuItem","mstrmojo.express.ui.SubmenuEditor","mstrmojo.vi.ui.CalculationMenuEditor","mstrmojo.vi.ui.rw.DrillMenuList","mstrmojo.XtabCellMenu","mstrmojo.vi.enums.EnumDerivedElementType","mstrmojo.vi.ui.NumberFormatterEditor","mstrmojo.vi.ui.SubtotalMenuEditor","mstrmojo.vi.ui.DatasetUnitMenuUtils");mstrmojo.requiresDescs(1018,1388,1911,3573,5188,12193,12194,12195,12196);var $ID="mstrXtabCellMenu",$COMP=mstrmojo.func.composite,$H=mstrmojo.hash,$A=mstrmojo.array,$BOXC="mstrmojo-Menu-Box",$BOX="mstrmojo.Box",$DET=mstrmojo.vi.enums.EnumDerivedElementType,$DESC=mstrmojo.desc,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,ACTION_GROUP=64,ACTION_CALCULATION=128,ACTION_GROUP_EDIT=256,ACTION_KEEP_ONLY=512,ACTION_TOTAL_HEADER=1024;function fnClick(method,args){var p=mstrmojo.all[$ID],xtab=p.xtab,newArgs=[p.selectedData].concat(args||[]);p.close();xtab[method].apply(xtab,newArgs);}function createNewGroupButton(t,newArgs){return{scriptClass:"mstrmojo.MenuItem",text:t,cssClass:"mstrmojo-InteractiveButton",onclick:function(){fnClick("derivedElementGroup",newArgs);}};}function createUngroupButton(t,newArgs){return{scriptClass:"mstrmojo.MenuItem",text:t,cssClass:"mstrmojo-InteractiveButton",onclick:function(){fnClick("separateOthers",newArgs);}};}function createEditGroupButton(newArgs){return[{scriptClass:"mstrmojo.MenuItem",text:$DESC(13395,"Edit Group..."),cssClass:"mstrmojo-InteractiveButton",onclick:function(){fnClick("derivedElementsEdit",newArgs);}},{scriptClass:"mstrmojo.MenuItem",text:$DESC(12195,"Ungroup"),cssClass:"mstrmojo-InteractiveButton",onclick:function(){fnClick("removeQuickDE",newArgs);}},{scriptClass:"mstrmojo.MenuItem",text:$DESC(1388,"Rename"),cssClass:"mstrmojo-InteractiveButton",onclick:function(){fnClick("renameDEList",newArgs);}}];}function createNewCalculationButton(t,alias,config){return $H.copy(config,{scriptClass:"mstrmojo.express.ui.SubmenuEditor",text:t,cssClass:"mstrmojo-InteractiveButton",alias:alias,contentScriptClass:"mstrmojo.vi.ui.CalculationMenuEditor",parentID:$ID});}function createFormatCalculationButton(t,config){var formatValue=$DU.generateNumberFormat(config&&config.de&&config.de.nf),myData=$H.clone(formatValue),oldData=$H.clone(formatValue);$H.make(myData,mstrmojo.Obj);$H.make(oldData,mstrmojo.Obj);return $H.copy(config,{scriptClass:"mstrmojo.express.ui.SubmenuEditor",data:myData,text:t,cssClass:"mstrmojo-InteractiveButton mojo-theme-dark",contentScriptClass:"mstrmojo.vi.ui.NumberFormatterEditor",parentID:$ID,contentConfig:{formatValue:formatValue,myData:myData,oldData:oldData,onOk:function(){fnClick("editQuickDECalculationNumberFormat",$H.copy(this.parent.data,{de:config.de}));}}});}function createEditCalculationButton(t,alias,config){return[createNewCalculationButton(t,alias,config),{scriptClass:"mstrmojo.MenuItem",text:"Remove Calculation",cssClass:"mstrmojo-InteractiveButton",onclick:function(){fnClick("removeQuickDE");}},{scriptClass:"mstrmojo.MenuItem",text:$DESC(1388,"Rename"),cssClass:"mstrmojo-InteractiveButton",onclick:function(){fnClick("editDECalculation");}}];}function createDrillMapButton(){return{scriptClass:"mstrmojo.express.ui.SubmenuEditor",text:"Drill",cssClass:"mstrmojo-InteractiveButton",alias:"drillMapButton",drillMapButton:undefined,contentScriptClass:"mstrmojo.vi.ui.rw.DrillMenuList",parentID:$ID};}function createGroupEditorButton(t,newArgs){return{scriptClass:"mstrmojo.MenuItem",text:t,iconClass:"mstrmojo-oivmSprite tbGroup",cssClass:"mstrmojo-InteractiveButton",onclick:function(){fnClick("derivedElementsEdit",newArgs);}};}function isActionSupported(data,action){return !!(((data&&data.at)||0)&action);}function isGroupActionSupported(xtab){return !xtab.selCells.some(function(cell){var cellInfo=xtab.getCellForNode(cell);return !isActionSupported(cellInfo,ACTION_GROUP)||cellInfo.dei!==undefined;});}function isCalculationActionSupported(xtab){return !xtab.selCells.some(function(cell){return(!isActionSupported(xtab.getCellForNode(cell),ACTION_CALCULATION));});}function doSelectionsSupportViewFilterActions(){var xtab=this.xtab,model=xtab.model,data=this.selectedData,selections=xtab.getSelections(),supportsViewFilterAction=!data.olap;if(selections.length>0){selections.forEach(function(selectionsArray){selectionsArray.forEach(function(selectionInfo){supportsViewFilterAction=supportsViewFilterAction&&model.supportsViewFilterActions(selectionInfo.tid);});});}else{supportsViewFilterAction=supportsViewFilterAction&&model.supportsViewFilterActions(model.getCellTitleInfo(data).title.id);}if(data.mix!==undefined){supportsViewFilterAction=supportsViewFilterAction&&model.getCellDataUnion(data).every(function(headerInfo){return model.supportsViewFilterActions(headerInfo.tid);});}return supportsViewFilterAction;}mstrmojo.vi.ui.XtabCellMenu=$H.copy({keepOnly:undefined,exclude:undefined,groupOptions:undefined,groupEditor:undefined,calculationOptions:undefined,editCalculationOptions:undefined,formatCalculationOption:undefined,showData:undefined,removeTotals:undefined,updatePopupConfig:$COMP([mstrmojo.XtabCellMenu.updatePopupConfig,function(cfg){this.selectedData=cfg.data||(cfg.xtab&&cfg.td&&cfg.xtab.getCellForNode(cfg.td));var xtab=this.xtab,model=xtab.model,menuOption,data=this.selectedData,sameCol=xtab.isSingleAttrSelection(),isValueCellClick=cfg.singleCellClick,newCalBtnAlias="newCalculationBtn",editCalBtnAlias="editCalculationBtn",deInfo=xtab.getDEInfo(data),deObject=deInfo&&deInfo.deObject,de=deInfo&&deInfo.de,othersDE=deObject&&xtab.getOthersDEInfo(deObject),drillPaths,supportsViewFilterActions=doSelectionsSupportViewFilterActions.call(this),sel=xtab.getSelections(),canDoCalculation=true;menuOption=this.drillOptions;drillPaths=model.getAllDrillPathsForCell(data).length>1;if(drillPaths){menuOption.set("children",[createDrillMapButton.call(this)]);var drillMapButton=menuOption.drillMapButton;drillMapButton.set("xtab",xtab);drillMapButton.set("cell",data);}menuOption.set("visible",drillPaths&&supportsViewFilterActions);menuOption=this.groupOptions;menuOption.set("visible",(isValueCellClick||sameCol)&&isActionSupported(data,ACTION_GROUP)&&isGroupActionSupported(xtab));menuOption.set("children",[createNewGroupButton.call(this,$DESC(1911,"Group"))]);menuOption=this.editGroupOptions;menuOption.set("visible",xtab.isSingleSelection()&&de&&de.t===$DET.LIST);menuOption.set("children",createEditGroupButton.call(this,deInfo));menuOption=this.ungroupOption;menuOption.set("visible",xtab.isSingleSelection()&&de&&de.t===$DET.RESIDUE);menuOption.set("children",[createUngroupButton.call(this,$DESC(12195,"Ungroup"),[de])]);menuOption=this.calculationOptions;if(othersDE&&!xtab.isSingleSelection()&&sameCol){$A.forEach(sel,function(es){if(es[0]&&es[0].eid.indexOf(othersDE.id)>-1){canDoCalculation=false;return false;}});}menuOption.set("visible",!(xtab.isSingleSelection()&&de&&de.t===$DET.RESIDUE)&&(isValueCellClick||sameCol)&&isActionSupported(data,ACTION_CALCULATION)&&isCalculationActionSupported(xtab)&&canDoCalculation);menuOption.set("children",[createNewCalculationButton.call(this,$DESC(5188,"Calculation"),newCalBtnAlias,{cellsNum:xtab.getSelectionSize(),node:data,td:cfg.td,singleClick:isValueCellClick,isEdit:false})]);var newCalculationBtn=menuOption[newCalBtnAlias];newCalculationBtn.set("xtab",xtab);newCalculationBtn.set("cell",[data]);menuOption=this.editCalculationOptions;menuOption.set("visible",xtab.isSingleSelection()&&de&&de.t===$DET.CALCULATION);menuOption.set("children",createEditCalculationButton.call(this,$DESC(12196,"Edit Calculation"),editCalBtnAlias,{de:de,node:data,td:cfg.td,singleClick:isValueCellClick,isEdit:true}));var editCalculationBtn=menuOption[editCalBtnAlias];editCalculationBtn.set("xtab",xtab);editCalculationBtn.set("cell",[data]);menuOption=this.formatCalculationOption;if(xtab.isSingleSelection()&&de&&de.t===$DET.CALCULATION){menuOption.set("visible",true);menuOption.set("children",[createFormatCalculationButton.call(this,$DESC(3573,"Number Format..."),{de:de,node:data,td:cfg.td,singleClick:isValueCellClick,isEdit:true})]);}else{menuOption.set("visible",false);}if(!mstrApp.isSingleTier){menuOption=this.groupEditor;menuOption.set("visible",isActionSupported(data,ACTION_GROUP_EDIT));menuOption.set("children",[createGroupEditorButton.call(this,deObject?$DESC(13296,"Edit Groups..."):$DESC(13295,"Create Groups..."),[deInfo])]);}else{this.groupEditor.set("visible",false);}var supportsKeepOnly=!data.stt&&isActionSupported(data,ACTION_KEEP_ONLY)&&supportsViewFilterActions;menuOption=this.keepOnly;menuOption.set("visible",supportsKeepOnly);menuOption=this.showData;menuOption.set("visible",supportsKeepOnly);menuOption=this.removeTotals;menuOption.set("visible",isActionSupported(data,ACTION_TOTAL_HEADER)&&data.mix===undefined);this.cfg=cfg;}]),getSubtotalMenuCfg:function getSubtotalMenuCfg(t){return{scriptClass:"mstrmojo.express.ui.SubmenuEditor",text:t,cssClass:"mstrmojo-InteractiveButton",alias:"showSubtotalsBtn",contentScriptClass:"mstrmojo.vi.ui.SubtotalMenuEditor",parentID:$ID};},onOpen:function onOpen(){this.set("visible",this.children.some(function(childWidget){return childWidget.visible;}));}},mstrmojo.XtabCellMenu);mstrmojo.XtabCellMenu.addChildren([{id:$ID+"KeepOnly",alias:"keepOnly",scriptClass:$BOX,cssClass:$BOXC,children:[{scriptClass:"mstrmojo.MenuItem",text:"Keep Only",iconClass:"mstrmojo-oivmSprite tbKeepOnly",cssClass:"mstrmojo-InteractiveButton",onclick:function onclick(){fnClick("keepOnlyOrExclude",[true]);}},{scriptClass:"mstrmojo.MenuItem",text:"Exclude",iconClass:"mstrmojo-oivmSprite tbKeepOnly",cssClass:"mstrmojo-InteractiveButton",onclick:function onclick(){fnClick("keepOnlyOrExclude",[false]);}}]},{id:$ID+"ShowData",alias:"showData",scriptClass:$BOX,cssClass:$BOXC+" showDataMOP",children:[{scriptClass:"mstrmojo.MenuItem",text:"Show Data",cssClass:"mstrmojo-InteractiveButton",onclick:function onclick(){var p=mstrmojo.all[$ID],xtab=p.xtab;p.close();mstrmojo.vi.ui.ViewDataDialog.open(xtab.parent,true);}}]},{id:$ID+"RemoveTotals",alias:"removeTotals",scriptClass:$BOX,cssClass:$BOXC,children:[{scriptClass:"mstrmojo.MenuItem",text:mstrmojo.desc(11928,"Remove Total"),cssClass:"mstrmojo-InteractiveButton",onclick:function onclick(){fnClick("removeTotal");}}]},{id:$ID+"Group",alias:"groupOptions",scriptClass:$BOX,cssClass:$BOXC},{id:$ID+"EditGroup",alias:"editGroupOptions",scriptClass:$BOX,cssClass:$BOXC},{id:$ID+"Ungroup",alias:"ungroupOption",scriptClass:$BOX,cssClass:$BOXC},{id:$ID+"Calculation",alias:"calculationOptions",scriptClass:$BOX,cssClass:$BOXC},{id:$ID+"editCalculation",alias:"editCalculationOptions",scriptClass:$BOX,cssClass:$BOXC},{id:$ID+"formatCalculation",alias:"formatCalculationOption",scriptClass:$BOX,cssClass:$BOXC},{id:$ID+"GroupEditor",alias:"groupEditor",scriptClass:$BOX,cssClass:$BOXC}]);}());