(function(){mstrmojo.requiresCls("mstrmojo.base64","mstrmojo.func","mstrmojo.hash");mstrmojo.XhrCallbackType=null;function decodeHeader(value){var rEncoded=/\=\?UTF-8\?B\?(.+?)\?\=/g;if(value&&value.indexOf("=?UTF-8?B?")===0){var decMsg="",result;while((result=rEncoded.exec(value))!==null){decMsg+=mstrmojo.base64.decode(result[1]);}return decMsg;}return value;}function encodeParams(params){var x=-1,url=[],p;if(params){for(p in params){url[++x]=p+"="+encodeURIComponent(params[p]);}}return url.join("&");}function appendUrlParams(method,baseUrl,params){if(method!=="GET"||!params){return baseUrl;}return baseUrl+"?"+encodeParams(params);}function sendXhr(xhr,method,baseUrl,params){method=method.toUpperCase();var app=mstrApp,m=window.microstrategy;if(this.isTask){params=mstrmojo.addCSRFTokenToTaskParams(params);params.taskContentType=params.taskContentType||"json";params.taskEnv=params.taskEnv||"xhr";params.xts=new Date().getTime();params[mstrApp.name]=mstrApp.servletState||"";baseUrl=baseUrl||mstrConfig.taskURL;}var ptp=app.persistTaskParams||(m&&m.persistParams);if(ptp){mstrmojo.requiresCls("mstrmojo.hash");mstrmojo.hash.copy(ptp,params);}xhr.open(method,appendUrlParams(method,baseUrl,params),this.async);if(method!=="POST"){xhr.send(null);}else{xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");xhr.send(encodeParams(params));}if(this.async===false){xhr.onreadystatechange();}}function createXhr(){var methods=[function(){return new XMLHttpRequest();},function(){return new ActiveXObject("Msxml2.XMLHTTP");},function(){return new ActiveXObject("Microsoft.XMLHTTP");}],cnt=methods.length,i;for(i=0;i<cnt;i++){var xhr;try{xhr=methods[i]();}catch(e){continue;}createXhr=methods[i];return xhr;}throw new Error("mstrmojo.SimpleXHR: Could not create an XHR object.");}function evalResponse(rt){var rtn=null;try{rtn=eval("("+rt+")");}catch(ex){rtn=rt&&mstrmojo.string.trim(rt);}return rtn;}var MSI_SERVER_NAME_NOT_INITIALIZED=2147760371,MSI_INVALID_SESSION_ID=2147760372,E_MSI_USERMGR_USER_NOTFOUND=2147758245,E_MSI_CONNECT_FAILED=2147759877;function isSessionExpiredError(res){var c=res&&res.getResponseHeader("X-MSTR-TaskErrorCode");c=(c<0)?(4294967296+parseInt(c,10)):c;switch(c){case MSI_SERVER_NAME_NOT_INITIALIZED:case MSI_INVALID_SESSION_ID:case E_MSI_USERMGR_USER_NOTFOUND:case E_MSI_CONNECT_FAILED:return true;}return false;}function xhrSupportsProgress(xhr){return !!(xhr&&xhr.upload&&xhr.upload.onprogress);}mstrmojo.SimpleXHR=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.SimpleXHR",isTask:true,async:true,init:function init(props){mstrmojo.hash.copy(props,this);},onreadystatechange:function onreadystatechange(xhr,callback,prevRequest){if(xhr.readyState!==4){return ;}if(typeof callback!=="object"){return ;}try{if((xhr.status===200)||(xhr.status===304)){this.response=callback.textResponse?xhr.responseText:evalResponse(xhr.responseText);if(typeof callback.success==="function"){callback.success(this.response);}}else{if(xhr.status!==0){var app=mstrApp,sessionExp=app&&app.onSessionExpired;if(sessionExp&&isSessionExpiredError(xhr)){sessionExp.call(app,prevRequest);}else{var orig=xhr.getResponseHeader;xhr.getResponseHeader=function(name){return decodeHeader(orig.apply?orig.apply(xhr,[name]):orig(name));};if(typeof callback.failure==="function"){callback.failure(xhr);}}}}}catch(ex){mstrmojo.err(ex);throw ex;}finally{if(typeof callback.complete==="function"){callback.complete();}if(!isSessionExpiredError(xhr)&&!prevRequest.params.notRestartSessionManager){var sm=mstrApp.sessionManager;if(sm&&sm.restart){sm.restart();}}}},cancel:function(){var didCancel=false;var xhr=this.xhr;if(xhr){delete xhr.onreadystatechange;xhr.isAborted=true;if(xhr.readyState<4){xhr.abort();didCancel=true;}this.xhr=null;}return didCancel;},request:function request(method,baseUrl,callback,params,webSvrUrl,useResFeed,webSrvParams){if(webSvrUrl){if(useResFeed===true){if(!params){params={};}params.srcURL=appendUrlParams("POST",webSvrUrl,webSrvParams);this.request(method,baseUrl,callback,params);}else{mstrmojo.jsonp.request(webSvrUrl,params,callback);}}else{var xhr=createXhr();xhr.onreadystatechange=(function(me,x,c,pr){return function(){me.onreadystatechange(x,c,pr);};}(this,xhr,callback,{method:method,baseUrl:baseUrl,callback:callback,params:params}));if(xhrSupportsProgress(xhr)&&callback.progress){xhr.onprogress=(function(me,x,c){return function(evt){c.progress.call(me,evt);};}(this,xhr,callback));}this.xhr=xhr;sendXhr.call(this,xhr,method,baseUrl,params);}}});mstrmojo.QueuedXHR=mstrmojo.declare(mstrmojo.SimpleXHR,null,{scriptClass:"mstrmojo.QueuedXHR",queue:null,requestCount:0,retryDelay:1,lookup:null,cancel:function cancel(){var didCancel=this._super();while(this.queue.length){var x=this.queue.pop();var cb=x.callback;if(cb&&cb.complete){cb.complete();}}this.queue=[];this.requestCount--;return didCancel;},init:function init(){this.queue=[];this.lookup=[];},request:function request(method,baseUrl,callback,params,override,webSvrUrl,useResFeed,webSrvParams,useCache){if(webSvrUrl){if(useResFeed===true){if(!params){params={};}params.srcURL=appendUrlParams("POST",webSvrUrl,webSrvParams);this.request(method,baseUrl,callback,params);}else{mstrmojo.jsonp.request(webSvrUrl,params,callback);}}else{if(this.requestCount>0&&!override){this.queue.push({method:method,baseUrl:baseUrl,callback:callback,params:params});}else{if(this.requestCount>0){this.cancel();}this.requestCount++;var lu=null,oriParams=null;if(useCache){lu=this._searchForCacheRequest(params);oriParams=mstrmojo.hash.copy(params);}if(lu){try{if(callback.success){window.setTimeout(function(){callback.success(lu.res);},10);}}catch(ex){mstrmojo.err(ex);throw ex;}finally{if(callback.complete){callback.complete();}this.advanceQueue();}}else{var xhr=this.xhr=createXhr();callback=mstrmojo.func.wrapMethods(callback,{complete:(function(ths){return function(){ths.advanceQueue();};}(this)),success:(function(ths){return function(){if(useCache){ths.lookup.push({params:oriParams,res:ths.response});}};}(this))});xhr.onreadystatechange=(function(me,x,c,pr){return function(){me.onreadystatechange(x,c,pr);};}(this,xhr,callback,{method:method,baseUrl:baseUrl,callback:callback,params:params}));if(xhrSupportsProgress(xhr)&&callback.progress){xhr.onprogress=(function(me,x,c){return function(evt){c.progress.call(me,evt);};}(this,xhr,callback));}sendXhr.call(this,xhr,method,baseUrl,params);}}}},upload:function upload(method,baseUrl,callback,params,data,config,override,webSrvParams,useCache){if(this.isTask){params=mstrmojo.addCSRFTokenToTaskParams(params);}if(this.requestCount>0&&!override){this.queue.push({method:method,baseUrl:baseUrl,callback:callback,params:params,data:data,config:config});}else{if(this.requestCount>0){this.cancel();}this.requestCount++;var lu=null,oriParams=null;if(useCache){lu=this._searchForCacheRequest(params);oriParams=mstrmojo.hash.copy(params);}if(lu){try{if(callback.success){window.setTimeout(function(){callback.success(lu.res);},10);}}catch(ex){mstrmojo.err(ex);throw ex;}finally{if(callback.complete){callback.complete();}this.advanceQueue();}}else{var xhr=this.xhr=createXhr();var self=this;callback=mstrmojo.func.wrapMethods(callback,{complete:(function(ths){return function(){ths.advanceQueue.call(ths);};}(this)),success:(function(ths){return function(){if(useCache){ths.lookup.push({params:oriParams,res:ths.response});}};}(this))});var handleProgress=function(event){callback.progress(event,config);};var url=baseUrl;xhr.open("POST",url,false);var formData=new FormData();var a;for(a in params){formData.append(a,params[a]);}if(data){if(params.fileName){formData.append("myFile",data,params.fileName);}else{formData.append("myFile",data);}}if(xhrSupportsProgress(xhr)&&callback.progress){xhr.upload.onprogress=handleProgress;}xhr.onreadystatechange=(function(me,x,c,pr){return function(){me.onreadystatechange(x,c,pr);};}(self,xhr,callback,{method:method,baseUrl:baseUrl,callback:callback,params:params}));xhr.send(formData);}}},advanceQueue:function advanceQueue(){this.requestCount--;if(this.queue.length===0){this.requestCount=0;return ;}var req=this.queue.shift();if(req.params.taskId==="importFile"){this.upload(req.method,req.baseUrl,req.callback,req.params,req.data,req.config);}else{this.request(req.method,req.baseUrl,req.callback,req.params,true);}},_searchForCacheRequest:function _searchForCacheRequest(params){var i;for(i in this.lookup){if(mstrmojo.hash.equals(params,this.lookup[i].params)){return this.lookup[i];}}return null;},hasRequests:function hasRequests(){return this.requestCount>0||mstrmojo.jsonp.hasRequests();}});mstrmojo.xhr=new mstrmojo.QueuedXHR();mstrmojo.jsonp={jsc:new Date().getTime(),timeToWait:20000,requestCount:0,request:function(url,params,callback){var head=document.getElementsByTagName("head")[0]||document.documentElement,jsonp="jsonp"+(this.jsc++),script=document.createElement("script");params.jsonp=jsonp+"(@R@);";params.taskContentType="jsonp";params.taskEnv="jsonp";params.xts=new Date().getTime();window[jsonp]=function(response){mstrmojo.jsonp.requestCount--;if(!response){if(callback.timeout){callback.timeout();}}else{if(response.status===200){callback.success(response.content);}else{var res={status:response.status,getResponseHeader:function(name){switch(name){case"X-MSTR-TaskFailureMsg":return response.errorMsg;case"X-MSTR-TaskErrorCode":return response.errorCode;}}};if(mstrApp.onSessionExpired&&isSessionExpiredError(res)){if(callback.onSessionExpired){callback.onSessionExpired();}else{mstrApp.onSessionExpired();}}else{callback.failure(res);}}}if(window[jsonp]){if(callback.complete){callback.complete();}window[jsonp]=undefined;try{delete window[jsonp];}catch(e){}head.removeChild(script);}};head.insertBefore(script,head.firstChild);this.requestCount++;script.src=appendUrlParams("GET",url,params);setTimeout(function(){var fn=window[jsonp];if(fn){fn();}},this.timeToWait);},hasRequests:function(){return this.requestCount>0;}};}());