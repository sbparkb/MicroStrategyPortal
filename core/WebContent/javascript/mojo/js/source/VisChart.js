(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.VisChartUtils","mstrmojo.VisChartData","mstrmojo.boxmodel");function getTooltipName(ch,s){var nm="",l=ch.length;if(l!==s.hi.length){return ch[0].items[s.hi[0]].n;}for(var i=0;i<l;i++){nm+=(i>0?" ":"")+ch[i].items[s.hi[i]].n;}return nm;}mstrmojo.VisChart=mstrmojo.declare(mstrmojo.Vis,null,{scriptClass:"mstrmojo.VisChart",utils:mstrmojo.VisChartUtils,data:mstrmojo.VisChartData,model:null,prevYLabel:{x:0,y:0,h:0},prevXLabel:{x:0,y:0,w:0},context:null,themeColor:"#000000",highlightColor:"#ff8833",margin:{t:50,r:2,b:30,l:2},offsetLeft:null,xLabelPadding:10,yLabelPadding:10,isDrawAxis:true,drawXAxisLabels:true,drawYAxisLabels:true,isHighlightOnTouch:true,isLinearChart:true,showHighlightLine:true,browserSupportsHtml5:true,multiLine:true,drawGridLines:3,drawHorizontalGridLines:1,drawVerticalGridLines:2,switchSeriesOnTouch:true,seriesIndex:-1,displayMode:0,markupString:'<div id="{@id}" class="mstrmojo-Chart {@cssClass}" style="width:{@width};height:{@height};top:{@top};left:{@left};position:relative;"  mstrAttach:mousedown,mouseup,mousemove,click ><canvas width="{@width}" height="{@height}"></canvas><canvas style="position:absolute;left:0;top:0" width="{@width}" height="{@height}"></canvas><canvas style="position:absolute;left:0;top:0" width="{@width}" height="{@height}"></canvas><div id="{@id}-tooltip" class="mstrmojo-Chart-tooltip"></div></div>',markupSlots:{canvas:function(){return this.domNode.firstChild;},animationCanvas:function(){return this.domNode.childNodes[1];},highlightCanvas:function(){return this.domNode.childNodes[2];},tooltip:function(){return this.domNode.childNodes[3];}},postBuildRendering:function postBR(){if(this._super){this._super();}this.browserSupportsHtml5=this.canvas.getContext;if(!this.browserSupportsHtml5){this.renderErrorMessage(mstrmojo.desc(8126,"Your browser does not support HTML5"));return ;}if(!this.model){this.renderErrorMessage(mstrmojo.desc(8426,"No model provided"));return ;}if(this.model.err||this.model.eg){this.renderErrorMessage(this.model.err||this.model.eg);return ;}if(this.isLinearChart){this.data.processLinearData(this);}else{this.data.process(this);}this.windowSize=this.model.series[0].rv.length;this.context=this.canvas.getContext("2d");this.highlightContext=this.highlightCanvas.getContext("2d");this.animationContext=this.animationCanvas.getContext("2d");this.utils.fillBackground(this);if(this.windowSize<=1){return ;}this.plot();},getMaxValue:function getMaxV(){var vals=this.model.mvalues;return vals&&vals[vals.length-1];},getMinValue:function getMinV(){var vals=this.model.mvalues;return vals&&vals[0];},plot:function plt(){this.drawChart();if(this.model.err||this.model.eg){return ;}if(this.isDrawAxis){if(this.isTimeSeries||!(this.isAnimateLines&&(!this.multiLine||this.model.series.length===1))){this.drawLabels();}else{this.drawAxis();}}},drawChart:function drwchrt(){},drawAxis:function drwAxs(){var utils=this.utils,margin=this.margin,width=this.getWidth(),height=this.canvas.height,context=this.context;context.save();context.strokeStyle=utils.getColor(this);context.lineWidth=2;context.globalAlpha=0.3;utils.drawRectangle(this,margin.l,margin.t,width-margin.l-margin.r,height-margin.t-margin.b);context.restore();},drawLabels:function drwlbls(){if(!this.isDrawAxis||!this.drawYAxisLabels){return ;}var model=this.model,utils=this.utils,margin=this.margin,v=model.mvalues,ylbls=model.ylbls,l=v.length,dgl=this.drawGridLines;this.prevYLabel.x=0;this.prevYLabel.y=0;this.prevYLabel.h=0;for(var i=0;i<l;i++){var y=utils.getYValue(this,v[i]);var lbl=utils.addDataLabel(this,ylbls[i],y,this.prevYLabel);var yPos=Math.floor(y)+0.5;if(lbl&&(dgl&this.drawHorizontalGridLines)&&i>0&&i<l-1){utils.drawHighlightLine(this,yPos);}if(i==l-1&&this.isTimeSeries&&lbl&&(dgl&this.drawHorizontalGridLines)){utils.drawHighlightLine(this,yPos);}}},renderTooltip:function rndrttp(valIndex,touchX,touchY){if(valIndex<0){this.tooltip.style.display="none";return ;}var m=this.model,s=m.series,utils=this.utils,l=s.length,si=this.seriesIndex,ch=m.colHeaders,ttp=this.tooltip;var sn="";if(!this.multiLine){sn=getTooltipName(ch,s[0])+": "+s[0].v[valIndex];}else{if(this.showHighlightLine){for(var i=0;i<l;i++){sn+=(i===0?"":"<br/>")+getTooltipName(ch,s[i])+": "+s[i].v[valIndex];}}else{sn=getTooltipName(ch,s[si])+": "+s[si].v[valIndex];}}var rVal=this.model.categories.items[valIndex];ttp.innerHTML=rVal+"<br/>"+sn;ttp.style.display="block";var tooltipWidth=ttp.offsetWidth;var toolx=touchX-tooltipWidth/2;var margin=this.margin;if(toolx<margin.l){toolx=margin.l;}else{if(toolx>this.getWidth()-margin.r-tooltipWidth){toolx=this.getWidth()-margin.r-tooltipWidth;}}if(this.showHighlightLine){utils.translateCSS(toolx,0,false,ttp);}else{var yPos=utils.getYValue(this,s[si].rv[valIndex])-ttp.offsetHeight-20;if(yPos<0){yPos=utils.getYValue(this,s[si].rv[valIndex]);}utils.translateCSS(toolx,yPos,false,ttp);}},getTouchValue:function gtvlindx(x,y){var md=this.model,m=this.margin;var sz=md.rne-md.rns>0?md.rne-md.rns>1?md.rne-md.rns:2:this.windowSize;var touchVal=Math.round(((x-m.l)*(sz-1))/(this.getWidth()-m.l-m.r-1));return(touchVal<sz)?touchVal:null;},highlightPoint:function hghlghtpnt(x,touchY){},handleTouchBegin:function handleTouchBegin(touchX,touchY){if(!this.isHighlightOnTouch||!this.browserSupportsHtml5){return ;}this.tooltipOn=true;this.adjustWidgetOffsets();this.handleTouchMove(touchX,touchY);},handleTouchMove:function handleTouchMove(touchX,touchY){var me=this,m=me.model;if(!me.tooltipOn||!me.isHighlightOnTouch||!this.browserSupportsHtml5||this.windowSize<=1){return ;}var touchPointOnWidget=me.utils.getTouchXYOnWidget(touchX,touchY,me);touchX=touchPointOnWidget.touchX;touchY=touchPointOnWidget.touchY;var margin=me.margin;if(touchX<margin.l||touchY<margin.t||touchY>me.canvas.height-margin.b){return ;}var touchVal=me.getTouchValue(touchX,touchY);if(touchVal!==null){var rns=(m.rne-m.rns>1)?m.rns:m.rns-1;if(me.seriesIndex===-1||me.switchSeriesOnTouch){me.seriesIndex=me.utils.getSeriesIndexAndYValue(me,rns+touchVal,touchY).si;}if(m.series[me.seriesIndex].rv[rns+touchVal]===""){return ;}me.prevHighlight=me.currentHighlight;me.currentHighlight=touchVal;me.renderTooltip(touchVal,touchX,touchY);if(this.isTimeSeries){me.highlightPoint(touchVal,touchX,touchY);}else{me.highlightPoint(touchVal,touchY);}}},handleTouchEnd:function handleTouchEnd(){if(!this.browserSupportsHtml5){return ;}var me=this;if(me.model.err||this.model.eg){return ;}me.tooltipOn=false;me.seriesIndex=-1;me.currentHighlight=null;me.highlightCanvas.height=me.highlightCanvas.height;me.tooltip.style.display="none";},onmousedown:function(evt){if(!this.isAndroid){this.handleTouchBegin(evt.e.pageX,evt.e.pageY);}},onmouseup:function(evt){if(!this.isAndroid){this.handleTouchEnd();}},onmousemove:function(evt){if(!this.isAndroid){this.handleTouchMove(evt.e.pageX,evt.e.pageY);}}});})();