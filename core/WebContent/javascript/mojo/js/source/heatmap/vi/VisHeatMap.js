(function(){mstrmojo.requiresCls("mstrmojo.VisBase","mstrmojo.dom","mstrmojo.array","mstrmojo.num","mstrmojo.hash","mstrmojo.color","mstrmojo.css","mstrmojo.VisEnum","mstrmojo.chart.enums.EnumFontStyle","mstrmojo.VisUtility","mstrmojo.util.ui._LassoSelector","mstrmojo.ui.menus._HasMenuPopup","mstrmojo._colorPalette","mstrmojo._VizSelectionHelper","mstrmojo.VisTooltip","mstrmojo.vi._MonitorsAppState","mstrmojo.heatmap.vi._HasHeatmapContextMenu","mstrmojo.netviz.ObservableModel","mstrmojo.chart.model.enums.EnumDSSDefaultFormats","mstrmojo.util.color","mstrmojo.vi.ui._IsDropTarget","mstrmojo.gm._SupportDndAsBlackBox","mstrmojo.ui.PopupConfig","mstrmojo.netviz.PropertyParser","mstrmojo.vi.viz.EnumDSSDropZones");mstrmojo.requiresClsP("mstrmojo.gm","GMLegend","EnumLegendSlot","GMUtility");mstrmojo.requiresClsP("mstrmojo.vi.ui.rw","_HasVisSelections","selectors._IsMultiUnitControl","selectors._BrushesAndHighlights","_XtabDE");mstrmojo.requiresClsP("mstrmojo.heatmap.vi","_SupportHeatmapBrushesAndHighlights","VisHeatMapColorTheme","VisHeatMapCanvas","VisHeatMapHighlightCanvas");var $MOJO=mstrmojo,$CSS=$MOJO.css,$ARRAY=$MOJO.array,$UTIL=$MOJO.VisUtility,$GM=$MOJO.gm,$LEGEND=$GM.GMLegend,PRP_LEGEND_SLOT=$GM.EnumLegendSlot,$GMU=$GM.GMUtility,LEGEND_DATA_TYPE=$MOJO.VisEnum.GMLegendDataType,ENUM_FONT_SYLTE=$MOJO.chart.enums.EnumFontStyle,$VIS_ENUMS=$MOJO.VisEnum,LEGEND_FORMATTING_TYPE=$VIS_ENUMS.GMLegendFormatingPropertyTag,LEGEND_PROPERTY=$VIS_ENUMS.LegendPropertyTag,ENUM_LEGEND_MODE=$VIS_ENUMS.EnumLegendMode,FORM_NAME_DISPLAY_TYPE=$VIS_ENUMS.FormNameDisplayType,ENUM_COLOR_RANKMODE=$VIS_ENUMS.EnumColorRankMode,$HASH=mstrmojo.hash,$DOM=$MOJO.dom,$CLRUTIL=$MOJO.util.color,$CLR=$MOJO.color,PROPERTIES_TYPE=mstrmojo.VisEnum.HEATMAP_PROPERTIES,$DROP_ZONES=mstrmojo.vi.viz.EnumDSSDropZones;var ERROR_TYPE=$VIS_ENUMS.SERVER_JSON_ERROR_TYPE;var GROUP_SUPPORTING_TAGS=["at","dei","dpt","o","tui","ui"],GROUP_SUPPORTING_TAGS_LENGTH=GROUP_SUPPORTING_TAGS.length;var HM_ATTACHED_EVENTS=["mousedown","mouseup","mousemove","mouseout","click","contextmenu"];var LEGEND_PADDING=5;var LegendPropDefault={lgdBgFillClr:[15461355,1710618],lgdBgFillStyle:[0,0],lgdBgFillEff:[1,1],lgdBgFillTrans:[0,100],lgdFntSz:["8pt","8pt"],lgdFntFml:["Arial","Arial"],lgdFntStyle:[0,0],lgdFntClr:[6710886,16777215],lgdBdrShw:[false,false],lgdBdrClr:[11579568,5855577],lgdBdrThk:[1,1],lgdBdrStyle:[0,0],lm:[1,1],lwr:[undefined,undefined]},TOOLTIP_WIN;var LEGEND_DOCK_POS=[{pos:PRP_LEGEND_SLOT.LEFT_TOP},{pos:PRP_LEGEND_SLOT.LEFT_MIDDLE},{pos:PRP_LEGEND_SLOT.LEFT_BOTTOM},{pos:PRP_LEGEND_SLOT.RIGHT_TOP},{pos:PRP_LEGEND_SLOT.RIGHT_MIDDLE},{pos:PRP_LEGEND_SLOT.RIGHT_BOTTOM}];var LEGEND_TYPE={VERTICAL:0,HORIZONTAL:1};var STR_ABS_VALUE_OF="Absolute value of ";var INVALID_METRIC_VALUE="-";var SHOW_FAKE_METRIC_IN_TOOLTIP=false;function getSizeByMinMaxValues(){var m=this.modelData,mx=m.gsi.mx,sizeMetricId=this.props.sizeMetricID,sizeMetricIndex=$UTIL.findInArray(mx,function(m){return m.did===sizeMetricId;}),hasValue=false,invalidMinMax={min:-Infinity,max:Infinity},minMaxSoFar={min:Infinity,max:-Infinity};if(sizeMetricIndex===-1){return invalidMinMax;}this.dfs(this.root,function(entity){if(entity.entityChildren!==undefined){return ;}var aggValues=entity.aggValues||[],agg=aggValues[sizeMetricIndex],val=agg.value;if(agg.count===0||isNaN(val)){return ;}hasValue=true;if(val<0){minMaxSoFar.hasNegativeValue=true;val=Math.abs(val);}minMaxSoFar.min=Math.min(minMaxSoFar.min,val);minMaxSoFar.max=Math.max(minMaxSoFar.max,val);});return hasValue?minMaxSoFar:invalidMinMax;}function isHeaderColorModified(headerColors){if(!headerColors||headerColors.length!==3){return true;}var firstColor=headerColors[0];return headerColors.slice(1).every(function(color){return $HASH.equals(firstColor,color);});}function getCanvasConfig(){var _this=this;return{colorTheme:this.colorTheme,alias:"canvasObject",slot:"canvasSlot",root:this.root,width:this.heatMapSize.w,height:this.heatMapSize.h,attributes:this.levelAttributes,showMetric:this.props.showMetricValues,labelSetting:this.props.labelSize,isHeaderOnTop:this.props.isHeaderOnTop,fonts:this.props.fonts,bgColor:this.getSingleBackgroundColor(),isHeaderColorsModified:function(){return isHeaderColorModified(_this.props.headerColors);}};}function isSelectionEqual(a,b){if(!Array.isArray(a)||!Array.isArray(b)){return false;}if(a===b){return true;}if(a.length!==b.length){return false;}return a.every(function(item){return b.indexOf(item)!==-1;});}function raiseSelectionChangeEvent(selected){selected=selected||[];var event={name:"selectionChange",type:[],selectedEntities:selected},colorbyELements;if(isSelectionAllLeaves.call(this)){colorbyELements=getColorbyElementsFromEntities(selected);if(colorbyELements.length>0){event.type.push("shapeColor");event.colorbyElements=colorbyELements;}this.edtModelCbInitSelection=colorbyELements;}this.raiseEvent(event);}function getColorbyElementsFromEntities(entityList){var elements=entityList.filter(function(e){var tids=e.colorByAttributeIds,eids=e.colorByElementIds;return tids&&eids&&tids.length===eids.length;}).map(function(e){var tids=e.colorByAttributeIds,eids=e.colorByElementIds;return tids.map(function(tid,idx){return{tid:tid,eid:eids[idx]};});});return $UTIL.arrayUnique(elements,function(x,y){x=$HASH.clone(x);y=$HASH.clone(y);return $GMU.isEqualComb(x,y);});}function getAttrColorByOpacity(tid,eid){var opacities=this.getPropsInfo().attrColorByOpacity||{},strtid,streid,attr,opacity;tid=tid||[];eid=eid||[];strtid=tid.join("|");streid=eid.join("|");attr=opacities[strtid]||{};opacity=attr[streid];if(opacity===undefined){opacity=100;}return opacity;}function getLegendDockPosIdx(pos){var i,n=LEGEND_DOCK_POS.length;for(i=0;i<n;i++){if(pos===LEGEND_DOCK_POS[i].pos){return i;}}return -1;}function sliceDefaultsLegendProp(idx){var rtn={};$HASH.keyarray(LegendPropDefault).forEach(function(prop){rtn[prop]=LegendPropDefault[prop][idx];});return rtn;}var LabelSize=$VIS_ENUMS.HEATMAP_LABEL_SIZE;var AggregationType={Sum:0,Avg:1,Cnt:2,Max:3,Min:4,GeoAvg:5,AESum:6};var LayoutAlgorithm={Squarified:0,PivotByMiddle:1,SliceAndDice:2};var LayoutProperties={Padding:5,headerOnTopPadding:5,MaxLegendHeight:60,AttributeColorByLegendWidth:140,LegendMenuEditorWidth:0,LegendMinWidth:15,LegendTickLength:4,LegendMaxBandWidth:400,LegendWidthPercent:0.9,LegendMinPadding:15,LegendBottomPadding:3,LegendGutter:5,LegendBandAspect:10,MinShowLabelDimension:6,DeletedListHeight:500,EditorDialogWidth:565,EditorDialogHeight:574,EditButtonWidth:0,EditButtonHeight:0,EditButtonRight:0,HeaderPixels:19};function isValidColorStructure(color){return color&&color.value!==undefined&&color.opacity!==undefined;}var HEADER_COLORS=[{value:"#efefef",opacity:1},{value:"#e4e4e4",opacity:1},{value:"#e4e4e4",opacity:0.7}];var FONT_GROUP_NAMES=["headerOnMiddle","headerOnTop.header","headerOnTop.cell"];var FONTS=(function(){var default_fonts={headerOnMiddle:{scale:1,family:"Arial","heatmap-one-level-1":"14pt","heatmap-multi-level-1":"24pt","heatmap-two-level-2":"14pt","heatmap-multi-level-2":"20pt","heatmap-multi-level-3":"10pt"},headerOnTop:{header:{scale:1,family:"Arial","heatmap-level-1-header-on-top":"12pt","heatmap-level-2-header-on-top":"11pt","heatmap-level-3-header-on-top":"11pt"},cell:{scale:1,family:"Arial","heatmap-level-1-header-on-top":"12pt","heatmap-level-2-header-on-top":"12pt","heatmap-level-3-header-on-top":"12pt"}}};var fonts=$HASH.clone(default_fonts);FONT_GROUP_NAMES.forEach(function(path){var obj=$UTIL.getPropertyByPath(fonts,path,{});Object.keys(obj).filter(function(k){return $UTIL.strStartsWith(k,"heatmap-");}).forEach(function(k){obj[k]=$UTIL.psPt2CssPt(obj[k]);});});return fonts;}());var FONTS_SCALE_LIMITS={headerOnTop:{header:{max:16/12,min:8/11},cell:{max:16/12,min:8/11}},headerOnMiddle:{max:36/24,min:8/10}};var Fake_Metric_ID="--";var Background_Color=16119287;function limitFontScale(fonts,callbacks){FONT_GROUP_NAMES.forEach(function(name){var val=$UTIL.getPropertyByPath(fonts,name,{}),limits=$UTIL.getPropertyByPath(FONTS_SCALE_LIMITS,name),cb=$UTIL.getPropertyByPath(callbacks,name,mstrmojo.emptyFn);var scale,max,min,desc;if(limits){scale=val.scale;max=limits.max;min=limits.min;desc={valid:true,min:"gt",max:"lt"};if(scale>=max){scale=max;desc.valid=false;desc.max=scale===max?"eq":"gt";}if(scale<=min){scale=min;desc.valid=false;desc.min=scale===min?"eq":"lt";}cb(desc,scale);}});}function inflatePathToObject(schema,getCallback){return schema.reduce(function(obj,path){var nodes=path.split("."),nodeCnt=nodes.length,current=obj;nodes.forEach(function(node,idx){if(idx===nodeCnt-1){current[node]=getCallback(path);}if(current[node]===undefined){current[node]={};}current=current[node];});return obj;},{});}function notifyFontScaleLimitReached(fonts){var limits=inflatePathToObject(FONT_GROUP_NAMES,function(){return false;}),notify=inflatePathToObject(FONT_GROUP_NAMES,function(path){return function(desc,newVal){var nodes=path.split("."),lastIndex=nodes.length-1,prop=nodes[lastIndex],obj=lastIndex===0?limits:$UTIL.getPropertyByPath(limits,nodes.slice(0,lastIndex).join("."));if(obj!==undefined){obj[prop]=desc;}};});limitFontScale(fonts,notify);this.raiseEvent({name:"fontScaleChange",type:"*",limits:limits});}function updateDropZoneInDrill(drillUnit,params){var me=this,updateTemplateActions={act:"updateTemplate",keyContext:me.k,actions:[]},tplActArr=updateTemplateActions.actions,dzModel=me.zonesModel,unitItem=[$UTIL.pick(drillUnit,["did","t"])],argumentZone={id:$DROP_ZONES.Grouping},selections=me.getSelections(),datasetId=me.modelData.datasetId,METRIC_NAMES_ID="00000000000000000000000000000000",METRIC_NAMES_UNIT_TYPE=0,DATASET_TYPE=3,headerDrill=params.headerDrill,keepParent=params.keepParent;var extras={datasetId:datasetId,datasetType:datasetId===METRIC_NAMES_ID?METRIC_NAMES_UNIT_TYPE:DATASET_TYPE};var push=Array.prototype.push;if(headerDrill&&selections.length>0){var fromUnitItem=null,zone=dzModel.getZoneModelByZoneId(argumentZone.id),fromUnitID=selections[selections.length-1][0].tid;zone.items.forEach(function(it){if(it.did===fromUnitID){fromUnitItem=it;return false;}});if(keepParent){push.apply(tplActArr,dzModel.getAddDropZoneUnitsActions(argumentZone,unitItem,fromUnitItem?fromUnitItem.idx+1:0));}else{if(fromUnitItem){tplActArr.push(dzModel.getRemoveDropZoneUnitAction(argumentZone,fromUnitItem));push.apply(tplActArr,dzModel.getAddDropZoneUnitsActions(argumentZone,unitItem,fromUnitItem.idx));}}}else{var posIdx=dzModel.getItemCountInZone(argumentZone.id);push.apply(tplActArr,dzModel.getAddDropZoneUnitsActions(argumentZone,unitItem,posIdx,extras));}return updateTemplateActions;}function updateEntityAggValue(ev,rawValue,params){var needsCopy=params.needsCopy,invalidReplacement=params.invalidReplacement;if(needsCopy&&ev.total===undefined){ev.avgTotal=ev.total=ev.geomProduct=ev.max=ev.min=ev.value;ev.positiveCount=ev.value>0?1:0;}var isRawValueValid=!isNaN(rawValue);ev.value=isRawValueValid?rawValue:invalidReplacement;ev.count+=isRawValueValid?1:0;ev.allValueCount+=1;this.aggregated=isRawValueValid;if(isRawValueValid){if(isNaN(ev.total)){ev.total=rawValue;}else{ev.total+=rawValue;}if(isNaN(ev.avgTotal)){ev.avgTotal=rawValue;}else{ev.avgTotal+=rawValue;}if(isNaN(ev.max)){ev.max=rawValue;}else{ev.max=Math.max(ev.max,rawValue);}if(isNaN(ev.min)){ev.min=rawValue;}else{ev.min=Math.min(ev.min,rawValue);}if(isNaN(ev.geomProduct)){if(rawValue>0){ev.geomProduct=rawValue;ev.positiveCount++;}}else{if(rawValue>0){ev.geomProduct*=rawValue;ev.positiveCount++;}}ev.count++;}}function decodeXML(s){return s.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');}var delStatus={dftUnDel:0,dftDel:1,usrDel:2};var isParseError=(function(){var parser=new window.DOMParser(),errorneousParse,parsererrorNS;try{errorneousParse=parser.parseFromString("<","text/xml");parsererrorNS=errorneousParse.getElementsByTagName("parsererror")[0].namespaceURI;return function(parsedDoc){return parsedDoc.getElementsByTagNameNS(parsererrorNS,"parsererror").length>0;};}catch(e){return null;}}());function parseDeletedList(s){if(s.trim()===""){return{};}var parser=new window.DOMParser(),parseFailed=false,doc;try{doc=parser.parseFromString(decodeXML(s),"text/xml");parseFailed=isParseError&&isParseError(doc);}catch(ex){parseFailed=true;}if(parseFailed){return{};}var ce=doc.childNodes[0]||{},len=doc.childNodes[0].childElementCount||0,cr=ce.firstElementChild,at=cr&&cr.attributes,al=at&&at.length||0,ret={},i=0,dict,key,j;while(i<len){dict=ret;at=cr.attributes;for(j=0;j<al;j++){key=at[j].value;if(j===(al-1)){dict[key]=delStatus.dftDel;}else{if(!dict[key]){dict[key]={};}dict=dict[key];}}i++;cr=cr.nextElementSibling;}return ret;}function getIntValue(string){return parseInt(string,10);}function getBooleanValue(string){return !!(string&&string.toString()==="true");}function loadDropZone(){var dz=this.modelData.dz,props=this.props;if(dz){if(dz.ColorBy&&dz.ColorBy.TemplateMetric&&dz.ColorBy.TemplateMetric[0]&&dz.ColorBy.TemplateMetric[0].id){props.colorMetricID=dz.ColorBy.TemplateMetric[0].id;this.setColorByType("metric");}else{props.colorMetricID=Fake_Metric_ID;if(dz.ColorBy&&dz.ColorBy.TemplateUnit){loadColorByAttributes.call(this,props,dz.ColorBy.TemplateUnit,getAttributeIndex);this.setColorByType("attribute");}}if(dz.SizeBy&&dz.SizeBy.TemplateMetric&&dz.SizeBy.TemplateMetric[0]&&dz.SizeBy.TemplateMetric[0].id){props.sizeMetricID=dz.SizeBy.TemplateMetric[0].id;}else{props.sizeMetricID=Fake_Metric_ID;}}}function getMetrics(modelData){return $UTIL.getPropertyByPath(modelData,"ghs.chs.items.0.items",[]);}function getMetricID(idx){var str="",m=this.modelData,col=m.ghs.chs.items,cnt=col.length,ml=col[0].items.length,coln=m.gts.col,i;if(idx<0||idx>=ml){return"";}for(i=0;i<cnt;i++){var index=col[i].items[idx].idx;var temp=coln[i].es[index];var id=(temp.oid!==undefined)?temp.oid:temp.id;str+=id+" ";}return str.slice(0,str.length-1);}function resetMetricIndices(){var m=this.modelData,l=getMetrics(m).length,sid=this.props.sizeMetricID,cid=this.props.colorMetricID,a=[],i;this.metricArray=a;for(i=0;i<l;i++){a.push(getMetricID.call(this,i));}a.push(Fake_Metric_ID);l++;this.sizeMetricIndex=0;this.colorMetricIndex=l>2?1:0;for(i=0;i<l;i++){if(sid===a[i]){this.sizeMetricIndex=i;}if(cid===a[i]){this.colorMetricIndex=i;}}if(sid===undefined){sid=a[this.sizeMetricIndex];this.props.sizeMetricID=sid;}if(cid===undefined){cid=a[this.colorMetricIndex];this.props.colorMetricID=cid;}if(this.props.sizeMetricID===Fake_Metric_ID){this.props.sizeMetricEnabled=false;}if(this.props.colorMetricID===Fake_Metric_ID){this.props.colorMetricEnabled=false;this.colorTheme.hasNoColorMetric=true;}if($UTIL.isOnExpressMode()&&this.props.colorMetricEnabled){this.setColorByType("metric");var threasholds=m.gsi.thresholds;if(!threasholds||Object.keys(m.gsi.thresholds).length===0){m.gsi.thresholds=$UTIL.getMockUpThresholds(this.props.colorMetricID,this.getMetricName(this.colorMetricIndex));}}this.props.hasColorInThresholds=false;if(this.isMetricColorByType()&&m.gsi.thresholds[this.props.colorMetricID]!==undefined){var thresholds=m.gsi.thresholds[this.props.colorMetricID];for(i=0;i<thresholds.length;i++){var oneThreshold=thresholds[i];if(oneThreshold&&oneThreshold.fmt){var tmp=oneThreshold.fmt;if(tmp.bc===undefined&&typeof tmp.fc=="string"){oneThreshold.fmt.bc=tmp.fc;oneThreshold.fmt.bgs=oneThreshold.fmt.bgs||0;this.props.hasColorInThresholds=true;}else{if(tmp.bc){this.props.hasColorInThresholds=true;break;}}}}}if(this.isMetricColorByType()&&this.props.sizeMetricEnabled===false&&this.props.hasColorInThresholds===false){this.props.showLegend=false;}}function getAttributeIndexById(id,startIndex){return this.getAttributeIndex({id:id},startIndex);}function getAttributeIndex(attribute,startIndex){var model=this.modelData,gridTitles=model&&model.gts,attributeList=gridTitles&&gridTitles.row,id=attribute.id,name=$UTIL.isHierarchyObject(attribute)?"hid":"id";return $UTIL.findInArray(attributeList,function(a){return a[name]===id;},startIndex);}function loadColorByAttributes(props,attributes,finder){var len=(attributes||[]).length,i,is=[],as=[],attrs=this.modelData&&this.modelData.gts&&this.modelData.gts.row,index;for(i=0;i<len;i++){index=-1;while(true){index=finder.call(this,attributes[i],index+1);if(index!==-1){is.push(index);}else{break;}}}is.sort();for(i=0,len=is.length;i<len;i++){as.push(attrs[is[i]]);}props.colorAttributeIndexes=is;props.colorAttributes=as;}function loadProps(){var PropertyParser=mstrmojo.netviz.PropertyParser,BooleanProperty=PropertyParser.BooleanProperty,IntegerProperty=PropertyParser.IntegerProperty,FloatProperty=PropertyParser.FloatProperty,StringProperty=PropertyParser.StringProperty,JsonProperty=PropertyParser.JsonProperty;var propValue=this.getProperties(),schema={deletedList:{key:PROPERTIES_TYPE.deletedList,type:JsonProperty.preset({}),preSet:function(value,prop,raw,key){return value===undefined?value:parseDeletedList(value);}},showMetricValues:{key:PROPERTIES_TYPE.showMetricValues,type:BooleanProperty.preset(false)},labelSize:{key:PROPERTIES_TYPE.labelSize,type:IntegerProperty.preset(LabelSize.On),preSet:function(value,prop,raw,key){return LabelSize[value];},postGet:function(value,prop,raw,key){var keyFound="On";Object.keys(LabelSize).some(function(k){if(LabelSize[k]===parseInt(value,10)){keyFound=k;return true;}return false;});return keyFound;}},showLegend:{key:PROPERTIES_TYPE.showLegend,type:BooleanProperty.preset(true)},layout:{key:PROPERTIES_TYPE.layout,type:IntegerProperty.preset(LayoutAlgorithm.Squarified)},isHeaderOnTop:{key:PROPERTIES_TYPE.headerType,type:BooleanProperty.preset(true),preSet:function(value,prop,raw,key){if(value===undefined){return ;}var str=value.toString();if(str==="true"||str==="false"){return str==="true";}return getIntValue(value)!==0;},postGet:function(value,prop,raw,key){return value==="true"?1:0;}},themeType:{key:PROPERTIES_TYPE.themeType,type:StringProperty.preset("light"),preSet:function(value,prop,raw,key){return getIntValue(value)!==0?"light":"dark";},postGet:function(value,prop,raw,key){return value==="dark"?0:1;}},headerColors:{key:PROPERTIES_TYPE.headerColors,type:JsonProperty.preset($HASH.clone(HEADER_COLORS)),postSet:function(value,prop,raw,key){var isValidColor=true;if(value){if(!(value instanceof Array)){value=[value,value,value];}$ARRAY.forEach(value,function(color){if(!isValidColorStructure(color)){if(color&&color.color!==undefined){color.value=$CLRUTIL.getCSSColorString(color.color);color.opacity=1;color.color=undefined;}else{isValidColor=false;return false;}}});}else{isValidColor=false;}var colors=isValidColor?value:$HASH.clone(HEADER_COLORS);this.isDefaultHeaderColor=isHeaderColorModified(colors)===false;return colors;}},fonts:{key:PROPERTIES_TYPE.fonts,type:JsonProperty.preset($HASH.clone(FONTS)),postSet:function(value,prop,raw,key){return $HASH.mergeHashes($HASH.clone(FONTS),value);}},attrColorByOpacity:{key:PROPERTIES_TYPE.attrColorByOpacity,type:JsonProperty.preset({})},metricColorByOpacity:{key:PROPERTIES_TYPE.metricColorByOpacity,type:FloatProperty.preset(1)},lgdBgFillClr:{key:LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR,type:JsonProperty.preset(undefined)},lgdBgFillStyle:{key:LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_STYLE,type:StringProperty.preset(undefined)},lgdBgFillEff:{key:LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_EFFECT,type:StringProperty.preset(undefined)},lgdBgFillTrans:{key:LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY,type:StringProperty.preset(undefined)},lgdFntSz:{key:LEGEND_FORMATTING_TYPE.LEGEND_FONT_SIZE,type:StringProperty.preset(undefined)},lgdFntFml:{key:LEGEND_FORMATTING_TYPE.LEGEND_FONT_FAMILY,type:StringProperty.preset(undefined)},lgdFntStyle:{key:LEGEND_FORMATTING_TYPE.LEGEND_FONT_STYLE,type:IntegerProperty.preset(undefined)},lgdFntClr:{key:LEGEND_FORMATTING_TYPE.LEGEND_FONT_COLOR,type:IntegerProperty.preset(undefined)},lgdBdrShw:{key:LEGEND_FORMATTING_TYPE.LEGEND_BORDER_SHOW,type:BooleanProperty.preset(undefined)},lgdBdrClr:{key:LEGEND_FORMATTING_TYPE.LEGEND_BORDER_COLOR,type:StringProperty.preset(undefined)},lgdBdrStyle:{key:LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE,type:StringProperty.preset(undefined)},lgdBdrThk:{key:LEGEND_FORMATTING_TYPE.LEGEND_BORDER_THICKNESS,type:StringProperty.preset(undefined)},lm:{key:LEGEND_PROPERTY.LEGEND_MODE,type:IntegerProperty.preset(undefined)},LegendPosition:{key:LEGEND_PROPERTY.LEGEND_POSITION,type:IntegerProperty.preset(2)},lwr:{key:LEGEND_PROPERTY.SCALE_LEGEND_WIDTH,type:FloatProperty.preset(undefined)}};var w=mstrmojo.heatmap.vi.VisHeatMapColorTheme.newInstance();w.initialize();this.colorTheme=w;this.props=new PropertyParser().parse(propValue,schema)||{};var props=this.props;w.style=props.themeType;if(props.showLegend&&!props.colorByType&&props.sizeMetricID===Fake_Metric_ID){props.showLegend=false;}props.sizeMetricEnabled=true;props.colorMetricEnabled=true;props.legendAsc=true;props.headerPixels=LayoutProperties.HeaderPixels;var defaultColorByType="metric",dz=this.modelData.dz,temp;if($UTIL.isValidDropZone(dz)){loadDropZone.call(this);}else{if(propValue[PROPERTIES_TYPE.metricList]){temp=propValue[PROPERTIES_TYPE.metricList].split(",");if(temp.length>=2){props.sizeMetricID=temp[0]||Fake_Metric_ID;if(getIntValue(propValue[PROPERTIES_TYPE.colorByType])===1){this.setColorByType("attribute");temp.splice(0,1);props.colorAttributeIDs=temp;loadColorByAttributes.call(this,props,temp,getAttributeIndexById);}else{this.setColorByType(defaultColorByType);props.colorMetricID=temp[1];}}else{props.sizeMetricID=Fake_Metric_ID;}}}if(propValue.rlp==="false"&&propValue[PROPERTIES_TYPE.absoluteFixed]){w.convertAbsoluteToBlend(this,propValue);}w.isBlend=true;if(propValue[PROPERTIES_TYPE.blendColor]){w.isBlend=getBooleanValue(propValue[PROPERTIES_TYPE.blendColor]);}if(propValue.gradientColors&&propValue.bandColors){w.createDataProviderFromString(propValue.gradientColors,propValue.bandColors);}if(propValue.rlp==="false"&&propValue[PROPERTIES_TYPE.absoluteFixed]){this.colorTheme.convertAbsoluteToBlend(this,propValue);this.colorTheme.createDataProviderFromString(propValue.gradientColors,propValue.bandColors);}this.bgColor=this.getFormats()["background-color"]||w.getBackgroundColor();this.background={value:this.bgColor,opacity:1};resetMetricIndices.call(this);}function loadMetricsInfo(){this.aggFunctions=[];var props=this.props,cid=props.colorMetricID,af=this.aggFunctions,m=this.modelData,propValue=m.vp||{},ar=this.metricArray,l=ar.length-1,i;if(cid!==Fake_Metric_ID){var mlEnabled=propValue["mle"+cid]==="true";if(mlEnabled){var val=parseFloat(propValue["mlma"+cid]);if(!isNaN(val)){this.mlmax=val;}val=parseFloat(propValue["mlmi"+cid]);if(!isNaN(val)){this.mlmin=val;}}}for(i=0;i<l;i++){var id="agf"+ar[i];if(propValue[id]!==undefined){af.push(parseInt(propValue[id],10));}else{af.push(AggregationType.AESum);}}}function convertDataToModels(){loadMetricsInfo.call(this);var m=this.modelData,deletedList=this.props.deletedList,att=(m.gts&&m.gts.row)||[],atl=att.length,mv=(m.gvs&&m.gvs.items)||[],rhs=(m.ghs&&m.ghs.rhs&&m.ghs.rhs.items)||[],rl=rhs.length,ml=getMetrics(m).length,metricHasValue=$UTIL.range(0,ml).map($UTIL.hasValidValueInMetric.bind(this,this)),cbmIndex=this.colorMetricIndex,colorMetricValueRange={max:-Infinity,min:Infinity};if(atl<=0&&!$UTIL.isOnExpressMode()){this.setError(null,ERROR_TYPE.NO_TEMPLATE_UNIT);return ;}if($UTIL.isOnExpressMode()&&(!$UTIL.hasOnlyMetricsOnColumn(m)||!$UTIL.hasNoMetricOnRow(m))){this.setError(mstrmojo.desc(13685,"The Heat Map requires at least one attribute on the row axis to render properly; it is recommended that two metrics be placed on the column axis as well"));return ;}if($UTIL.hasMergedRowCells(m)){this.setError(mstrmojo.desc(13686,"The HeatMap doesn't support grid data with merged row cell. Please disable cell merge and retry"));return ;}if($UTIL.isOnExpressMode()&&this.props.colorMetricEnabled&&metricHasValue[cbmIndex]){$ARRAY.forEach(mv,function(row){var v=row&&row.items&&row.items[cbmIndex];if(v){colorMetricValueRange.max=Math.max(colorMetricValueRange.max,v.rv);colorMetricValueRange.min=Math.min(colorMetricValueRange.min,v.rv);}});}this.hasNegativeSizeValue=false;this.levelAttributes=[];this.root={aggValues:[],entityChildren:[],level:0};var i,allSupportsViewFilter=true,supportsViewFilter,xtabModel=this.model;for(i=0;i<atl;i++){supportsViewFilter=xtabModel.supportsViewFilterActions(att[i].id);allSupportsViewFilter=allSupportsViewFilter&&supportsViewFilter;this.levelAttributes[i]={index:i,order:i+1,isInLOA:i+1>0,supportsViewFilter:supportsViewFilter,name:att[i].n,id:att[i].id};}this.allSupportsViewFilter=allSupportsViewFilter;var hashDict={},attSpan=[];for(i=0;i<atl;i++){var o=att[i].fs;attSpan[i]=Math.max(1,o?o.length:1);}this.attSpan=attSpan;var isAllSelectable=true,lastSerialRowIndex,serialEntity,highestLevelEntity,highestLevelIndex,tagIdx,tag,elem,attribute,span,form,formSeen,max=colorMetricValueRange.max,min=colorMetricValueRange.min,p;for(i=0;i<rl;i++){var rowHeaderData=rhs[i].items,j,k;var levelID="",delDict=deletedList,parent=this.root,entityContainer,cur=0,entity,str,id,serialEndIndex=-1,hasCG;for(j=0;j<atl;j++){var rawValue,ev,aggValues,len=1;if(!(m.gts.row[j].otp===47&&m.gts.row[j].ost===12033)&&!!m.gts.row[j].cs){len=m.gts.row[j].cs;hasCG=true;}if(rowHeaderData[cur].etk===-1||rowHeaderData[cur].etk==="-1"){if(parent){aggValues=parent.aggValues;for(k=0;k<ml;k++){rawValue=parseFloat($UTIL.getPropertyByPath(mv,i+".items."+k+".rv"));if(isNaN(rawValue)){continue;}aggValues[k]={AETotal:rawValue};}}break;}else{var index,newEntity;str="";id="";attribute=att[j];span=attSpan[j];formSeen=[];for(k=0;k<span;k++,cur+=len){index=rowHeaderData[cur].idx;if(index===-1){continue;}form=attribute.es[index];if(formSeen.indexOf(form)===-1){str+=form.n+" ";if(k===0){id=form.id;levelID+=index;}formSeen.push(form);}}str=str.substring(0,str.length-1);if(delDict){delDict=delDict[decodeXML(str)];}var childrenArray;if(j!==atl-1){if(hashDict[levelID]!==undefined){parent=hashDict[levelID];}else{entityContainer={aggValues:[],entityChildren:[],parentEntity:parent};childrenArray=parent.entityChildren;childrenArray.push(entityContainer);hashDict[levelID]=entityContainer;parent=entityContainer;entityContainer.deleted=false;entityContainer.text=str;entityContainer.label=str;entityContainer.id=id;entityContainer.level=j;entityContainer.index=i;elem=rowHeaderData[cur-len];for(tagIdx=0;tagIdx!==GROUP_SUPPORTING_TAGS_LENGTH;tagIdx+=1){tag=GROUP_SUPPORTING_TAGS[tagIdx];entityContainer[tag]=elem[tag];}}levelID+=":";newEntity=entityContainer;}else{var indice;if(hashDict[levelID]!==undefined){entity=hashDict[levelID];indice=entity.indices;indice.push(i);for(k=0;k<ml+1;k++){ev=entity.aggValues[k];rawValue=parseFloat(k===ml?1:mv[i].items[k].rv);if(!hasCG){updateEntityAggValue.call(this,ev,rawValue,{needsCopy:true,invalidReplacement:metricHasValue[k]?0:1});}}}else{entity={indices:[],aggValues:[],parentEntity:parent};indice=entity.indices;indice.push(i);aggValues=entity.aggValues;for(k=0;k<ml+1;k++){ev={};aggValues[k]=ev;rawValue=parseFloat(k===ml?1:mv[i].items[k].rv);if(isNaN(rawValue)){ev.value=metricHasValue[k]?0:1;ev.count=0;}else{ev.value=rawValue;ev.count=1;}ev.allValueCount=1;}this.aggregated=false;if(delDict){entity.deleted=true;this.colorTheme.useDefault=false;}if(this.isMetricColorByType()&&this.props.colorMetricID!==Fake_Metric_ID&&metricHasValue[cbmIndex]){var v=mv[i].items[cbmIndex],ti=v.ti,rv=parseFloat(v.rv);if(rv===""||rv===undefined||rv===null){ti=-1;}else{if(ti===undefined){if($UTIL.isOnExpressMode()){if(max===min){p=0;}else{p=(rv-min)/(max-min);}if(p<0.1){ti=0;}else{if(p>=0.1&&p<0.3){ti=1;}else{if(p>=0.3&&p<0.5){ti=2;}else{if(p>=0.5&&p<0.7){ti=3;}else{if(p>=0.7&&p<0.9){ti=4;}else{if(p>=0.9){ti=5;}}}}}}}else{ti=-1;}}}entity.thrColorIndex=ti;}else{entity.thrColorIndex=-1;}childrenArray=parent.entityChildren;childrenArray.push(entity);entity.level=atl-1;entity.text=str;entity.label=str;entity.id=id;hashDict[levelID]=entity;elem=rowHeaderData[cur-len];for(tagIdx=0;tagIdx!==GROUP_SUPPORTING_TAGS_LENGTH;tagIdx+=1){tag=GROUP_SUPPORTING_TAGS[tagIdx];entity[tag]=elem[tag];}}newEntity=entity;}if(rowHeaderData[j].cet!==undefined){if(j-serialEndIndex!==1||(!isNaN(lastSerialRowIndex)&&lastSerialRowIndex!==i)){isAllSelectable=false;}if(isAllSelectable){serialEntity=newEntity;serialEndIndex=j;lastSerialRowIndex=i;}if(isNaN(highestLevelIndex)||highestLevelIndex<j){highestLevelIndex=j;highestLevelEntity=newEntity;}}}}}function calculateRemainSumValueForContainer(node){var aggValues=[];var i;if(node.entityChildren){for(i=0;i<ml+1;i++){if(!aggValues[i]){aggValues[i]={AETotal:0,isAETotalFaked:false};}}$ARRAY.forEach(node.entityChildren,function(childNode){var values=calculateRemainSumValueForContainer(childNode);var cv,val,leafTotal,leafHasValidValue;for(i=0;i<ml+1;i++){val=aggValues[i];cv=values[i];if(childNode.entityChildren){val.AETotal+=cv.AETotal;val.isAETotalFaked|=cv.isAETotalFaked;}else{leafTotal=cv.total;if(leafTotal===undefined){leafTotal=cv.value;}leafHasValidValue=cv.allValueCount!==0&&cv.count!==0;aggValues[i].AETotal+=leafTotal;aggValues[i].isAETotalFaked|=!leafHasValidValue;}}});for(i=0;i<ml+1;i++){if(!node.aggValues[i]){node.aggValues[i]=aggValues[i];}}}return node.aggValues;}calculateRemainSumValueForContainer(this.root);if(isAllSelectable&&serialEntity){this.previousSelected=[serialEntity];}else{if(highestLevelEntity){this.previousSelected=[highestLevelEntity];}}}function getAggValue(e,i,w){var agg=e.aggValues;if(i>=agg.length){return NaN;}var ev=agg[i];if(e.entityChildren===undefined&&ev.allValueCount===1){return ev.value;}else{return ev.AETotal;}}function getSizeValue(e,w){var idx=w.sizeMetricIndex,val=getAggValue(e,idx,w);if(val<0){w.hasNegativeSizeValue=true;return Math.abs(val);}return val;}function copyRect(a){var b={};b.x=a.x;b.y=a.y;b.w=a.w;b.h=a.h;return b;}function getRectangleGap(e){var level=e.level,l=this.levelAttributes.length,ret;switch(l){case 1:ret={v:1,h:1};break;case 2:switch(level){case 0:ret={v:1,h:3};break;default:ret={v:1,h:1};}break;case 3:switch(level){case 0:ret={v:1,h:6};break;case 1:ret={v:1,h:3};break;default:ret={v:1,h:1};}break;default:switch(level){case 0:ret={v:1,h:8};break;case 1:ret={v:1,h:4};break;case 2:ret={v:1,h:2};break;default:ret={v:1,h:1};}}if(!this.props.isHeaderOnTop){ret.v=ret.h;}return ret;}function rectIsValid(a){return a.w>0&&a.h>0;}function getValidRect(a){var ret=copyRect(a);if(!rectIsValid(a)){ret.w=0;ret.h=0;}return ret;}function swapRect(a){var temp=a.x;a.x=a.y;a.y=temp;temp=a.w;a.w=a.h;a.h=temp;return a;}function rectIntersection(a,b){var x=Math.max(a.x,b.x);var y=Math.max(a.y,b.y);var w=Math.min(a.x+a.w,b.x+b.w)-x;var h=Math.min(a.y+a.h,b.y+b.h)-y;if(w<0||h<0){return{x:NaN,y:NaN,w:NaN,h:NaN};}return{x:x,y:y,w:w,h:h};}function setSizeRect(e,size){var validSize=getValidRect(size);e.size=validSize;if(this.props.isHeaderOnTop&&e.entityChildren){var hp=this.props.headerPixels,gv=getRectangleGap.call(this,e).v;e.headerSize=getValidRect({x:validSize.x,y:validSize.y,w:validSize.w,h:Math.min(hp,validSize.h)});e.contentSize=getValidRect({x:validSize.x,y:validSize.y+hp+gv,w:validSize.w,h:validSize.h-hp-gv});e.size=copyRect(e.contentSize);size.y=e.contentSize.y;size.h=e.contentSize.h;}else{delete e.headerSize;delete e.contentSize;}}function layoutRow(r,c,n,sum,swapped){var width,height,ch=r.r||[],l=ch.length,w,h,tmpc,localSwapped=false;if(l===0){return ;}if(n<c.h){w=n;h=c.h;tmpc=c;}else{w=c.h;h=n;tmpc=copyRect(c);swapRect(tmpc);localSwapped=true;}var x=tmpc.x,y=tmpc.y,bound={x:x,y:y,w:w,h:h};var gap=getRectangleGap.call(this,ch[0]),i,hm=this;var localGap={v:gap.v,h:gap.h};if((swapped===true&&localSwapped!==true)||(swapped===false&&localSwapped===true)){localGap={v:gap.h,h:gap.v};}var sortEntity=function sortEntity(s,t){var vs=getSizeValue(s,hm),vt=getSizeValue(t,hm),ret;if(isNaN(vs)){if(isNaN(vt)){ret=0;}else{ret=1;}}else{if(isNaN(vt)){ret=-1;}else{ret=vs<vt?1:-1;}}return ret;};var getHeight=function(e,hm,i){if(allOne){return 1;}var value=getSizeValue(e,hm),tmp=h*value/sum;var height=(sum<=0||e.deleted)?0:Math.ceil(tmp);if(height>0){carry+=height-tmp;}if(value<sum){if(i===0&&l>1){if(lv>1){if(height>(lv>>1)){height-=(lv>>1);}}else{if(height>1){height--;}}if(height+(l-1)*(lv+1)>=h){height=h-(l-1)*(lv+1);allOne=true;}}else{if(i<l-1){if(lv>1){if(height>(lv>>1)){height-=lv;}else{height=1;}}else{if(height>1){height--;}}if(carry>1&&height>1){height--;carry-=1;}}else{height=Math.max(h+tmpc.y-y,1);}}}return height;};var ll=0,e,j,lv=localGap.v,lll=Math.max(1,Math.floor((h+lv)/(1+lv)));if(l>lll){for(i=0;i<l;i++){e=ch[i];if(e.deleted){continue;}ll++;}}for(j=l-1,i=ll-lll;i>0;j--){e=ch[j];if(!e.deleted){sum-=getSizeValue(e,this);i--;}}var carry=0,allOne=false;for(j=0,i=0,ll=ch.length,l=Math.min(l,lll);i<ll;j++){var rect,minDim;e=ch[j];if(e.deleted){continue;}if(i>=l){height=0;}else{height=getHeight(e,this,i);}i++;width=w;var nc={x:x,y:y,w:width,h:height};rect=rectIntersection(nc,bound);if((swapped===true&&localSwapped!==true)||(swapped===false&&localSwapped===true)){swapRect(rect);}setSizeRect.call(this,e,rect);y+=height+lv;if(e.entityChildren!==undefined){minDim=Math.min(rect.w,rect.h);var arr=e.entityChildren.slice(0);arr.sort(sortEntity);squarify.call(this,arr,{r:[]},minDim,rect);}}}function setLayoutOrder(r,c){var sum=0,arr=r.r,l=arr.length;if(l===0){return ;}var ra,p=arr[0].parentEntity,ch=p.entityChildren,ll=ch.length;var i,e,v;for(i=0;i<l;i++){e=arr[i];v=getSizeValue(e,this);if(!e.deleted&&v>0){sum+=v;}}if(r.t===undefined){var t=0;for(i=0;i<ll;i++){e=ch[i];v=getSizeValue(e,this);if(!e.deleted&&v>0){t+=v;}}r.t=t;}e=arr[0];var gap=getRectangleGap.call(this,e),bound={x:0,y:0,w:0,h:0};if(e===this.root){ra=this.heatMapSize.w*this.scaleFactor*this.heatMapSize.h*this.scaleFactor;bound.w=this.heatMapSize.w*this.scaleFactor;bound.h=this.heatMapSize.h*this.scaleFactor;}else{if(p===this.root){ra=this.heatMapSize.w*this.scaleFactor*this.heatMapSize.h*this.scaleFactor;bound.w=this.heatMapSize.w*this.scaleFactor;bound.h=this.heatMapSize.h*this.scaleFactor;}else{var pSize=p.size;ra=pSize.w*pSize.h;bound=copyRect(pSize);}if(r.t===0){ra=0;}else{ra*=sum/r.t;}}var aw=c.w,ah=c.h,swapped=false;if(c.h>=c.w){swapped=true;swapRect(c);swapRect(bound);var temp=aw;aw=ah;ah=temp;gap={h:gap.v,v:gap.h};}if((bound.x<c.x)||(bound.x+bound.w>c.x+c.w)){if(gap.h>1){aw+=(gap.h>>1);}}if((bound.y<c.y)||(bound.y+bound.h>c.y+c.h)){if(gap.v>1){ah+=(gap.v>>1);}}var width=ah===0?0:Math.min(c.w,Math.ceil(ra/ah));if(sum<r.t&&sum>0){if(c.x+width<bound.x+bound.w){if(gap.h>1){if(width>gap.h>>1){width-=(gap.h>>1);}}else{if(width>1){width--;}}}}layoutRow.call(this,r,c,width,sum,swapped);var newX=c.x+width,newWidth=c.w-width;if(sum<r.t&&sum>0){if(c.x+width<bound.x+bound.w){if(gap.h>1){if(newWidth>gap.h){newX+=gap.h;newWidth-=gap.h;}}else{if(newWidth>1){newX++;newWidth--;}}}}c.x=newX;c.w=Math.max(0,newWidth);if(swapped){swapRect(c);}}function worstAspect(r,m,a){var worst,arr=r.r,l=arr.length;if(l>0&&a>0){var e=arr[0];var pval=0,_this=this;if(r.t===undefined){$ARRAY.forEach(e.parentEntity.entityChildren,function(e){if(!e.deleted){pval+=getSizeValue(e,_this);}});r.t=pval;}else{pval=r.t;}if(isNaN(pval)||pval<=0){return -1;}var min,max,sum=0,val,inited=false,i;for(i=0;i<l;i++){e=arr[i];if(!e.deleted){val=getSizeValue(e,this);if(!isNaN(val)){if(inited===false){max=min=val;inited=true;}else{max=Math.max(val,max);min=Math.min(val,min);}sum+=val;}}}var suba=a*sum/pval,otherMin=suba/m,newMin=(m<otherMin)?m:otherMin;max=a*max/pval;min=a*min/pval;var e1=max/(newMin*newMin);var e2=min/(newMin*newMin);e1=(e1>1)?e1:(1/e1);e2=(e2>1)?e2:(1/e2);worst=Math.max(e1,e2);}else{worst=-1;}return worst;}function squarify(t,r,m,c,a){var params=[[this,t,r,m,c,a]];while(params.length){var param=params.pop();var _this=param.shift();t=param.shift();r=param.shift();m=param.shift();c=param.shift();a=param.shift();if(t.length===0){setLayoutOrder.call(_this,r,c);}else{var area=c.w*c.h;var cwa;if(a!==undefined){cwa=a;}else{cwa=worstAspect.call(_this,r,m,area);}var data=t[0],arr=r.r;arr.push(data);var fwa=worstAspect.call(_this,r,m,area);if(cwa>=fwa||cwa===-1){t.shift();params.push([_this,t,r,m,c,fwa]);}else{r.r.pop();setLayoutOrder.call(_this,r,c);m=Math.min(c.w,c.h);params.push([_this,t,{r:[],t:r.t},m,c]);}}}}function getVisibleEntities(a){if(a===null){return[];}var arr=a.slice(0),total=0,l=arr.length,i;arr.t=[];for(i=0;i<l;i++){var e=arr[i],val=getSizeValue(e,this);if(e.deleted||isNaN(val)||val<=0){arr.splice(i,1);i--;l--;continue;}total+=val;arr.t[i]=total;}return arr;}function layoutEntityByMiddle(e,c,swapped,params){var size=copyRect(c);if(swapped===true){swapRect(size);}setSizeRect.call(this,e,size);var ch=e.entityChildren;if(ch!==undefined){var arr=getVisibleEntities.call(this,ch),l=arr.length;if(l>0&&params){params.push([this,arr,0,l-1,size]);}}}function pivotByMiddle(t,l,r,c){var params=[[this,t,l,r,c]];while(params.length){var param=params.pop();var _this=param[0];t=param[1];l=param[2];r=param[3];c=param[4];var e=t[0],gap=getRectangleGap.call(_this,e),lc,rc,lv,rv,lp,swapped=false,n=r-l+1,pivot=(n>2?((n-1)>>1):(n>>1))+l,cc;cc=copyRect(c);if(cc.w<=cc.h){swapRect(cc);gap={v:gap.h,h:gap.v};swapped=true;}lc=copyRect(cc);rc=copyRect(cc);if(l===r){e=t[l];layoutEntityByMiddle.call(_this,e,cc,swapped,params);continue;}if(l+1===r){e=t[l];lv=getSizeValue(e,_this);e=t[r];rv=getSizeValue(e,_this);}else{if(l===0){lv=t.t[pivot-1];}else{lv=t.t[pivot-1]-t.t[l-1];}if(pivot===0){rv=t.t[r];}else{rv=t.t[r]-t.t[pivot-1];}}lp=lv/(lv+rv);lc.w=Math.ceil(lc.w*lp);if(lc.w<c.w){if(gap.h>1){if(lc.w>(gap.h>>1)){lc.w-=(gap.h>>1);}}else{if(lc.w>1){lc.w--;}}}if(l+1===r){rc.w-=lc.w+gap.h;rc.x+=lc.w+gap.h;e=t[l];layoutEntityByMiddle.call(_this,e,lc,swapped,params);e=t[r];layoutEntityByMiddle.call(_this,e,rc,swapped,params);continue;}var mc=copyRect(cc),as,pap,cv=0,pi=-1,la=1,pv;if(pivot>l){var llc=copyRect(lc);if(swapped){swapRect(llc);}params.push([_this,t,l,pivot-1,llc]);}mc.w-=lc.w+gap.h;mc.x+=lc.w+gap.h;rc.w=mc.w;rc.x=mc.x;as=mc.w/mc.h;e=t[pivot];pv=getSizeValue(e,_this);pap=pv/rv;var i;for(i=pivot;i<=r;i++){e=t[i];cv+=getSizeValue(e,_this);if(i===r-1){continue;}var pwp=cv/rv,php=pv/cv,a=pwp/php*as;if(a>=1){if(la<1&&la*a>1){pi=(i===r)?i-2:i-1;}else{pi=i;}break;}la=a;}pi=pi<0?r:pi;var mv,pw,ph;if(pivot===0){mv=t.t[pi];}else{mv=t.t[pi]-t.t[pivot-1];}pw=Math.min(Math.ceil(mc.w*(mv/rv)),mc.w);ph=Math.min(Math.ceil(mc.h*(pv/mv)),mc.h);if(pw<mc.w){if(gap.h>1){if(pw>(gap.h>>1)){pw-=(gap.h>>1);}}else{if(pw>1){pw--;}}}if(ph<mc.h){if(gap.v>1){if(ph>(gap.v>>1)){ph-=(gap.v>>1);}}else{if(ph>1){ph--;}}}var pc={x:mc.x,y:mc.y,w:pw,h:ph};e=t[pivot];layoutEntityByMiddle.call(_this,e,pc,swapped,params);if(pivot<pi){mc.y+=ph+gap.v;mc.w=pw;mc.h-=ph+gap.v;if(swapped){swapRect(mc);}params.push([_this,t,pivot+1,pi,mc]);}if(pi<r){rc.x+=pw+gap.h;rc.w-=pw+gap.h;if(swapped){swapRect(rc);}params.push([_this,t,pi+1,r,rc]);}}}function sliceAndDice(r,c){var params=[[this,r,c]];while(params.length){var param=params.pop();var _this=param[0];r=param[1];c=param[2];if(r===null||r.length===0){continue;}var t=0,e=r[0],val,gap=getRectangleGap.call(_this,e),swapped=false,l=r.length,x,y,w,h;var i;for(i=0;i<l;i++){e=r[i];val=getSizeValue(e,_this);if(!e.deleted&&val>0){t+=val;}}if(c.w>=c.h){swapped=true;swapRect(c);gap={h:gap.v,v:gap.h};}w=c.w;h=c.h;x=c.x;y=c.y;for(i=0;i<l;i++){e=r[i];val=getSizeValue(e,_this);if(!e.deleted&&val>0){var width,height;height=t<=0?0:Math.ceil(val/t*h);width=w;if(val<t){if(i===0||i===l-1){if(gap.v>1){if(height>(gap.v>>1)){height-=(gap.v>>1);}}else{if(height>1){height--;}}}else{if(height>gap.v){height-=gap.v;}}}width=Math.max(0,width);height=Math.max(0,height);var nc={x:x,y:y,w:width,h:height},rect=rectIntersection(nc,c);y+=height+gap.v;if(y>=c.y+h){rect.h=c.y+h-rect.y;}if(swapped){swapRect(rect);}setSizeRect.call(_this,e,rect);if(e.entityChildren!==undefined){params.push([_this,e.entityChildren,rect]);}}else{var size={x:x,y:y,w:0,h:0};if(swapped){swapRect(size);}setSizeRect.call(_this,e,size);continue;}}if(swapped){swapRect(c);}}}function layoutEntities(){var legendHeight=0;if(this.props.showLegend){legendHeight=Math.min(Math.floor(0.2*(parseInt(this.height,10)-2*this.LayoutProperties.Padding)),this.LayoutProperties.MaxLegendHeight);}var hm=this,area=copyRect(this.heatMapSize);area.x=0;var min=Math.min(area.w,area.h);var ch=this.root.entityChildren;var arr;switch(this.props.layout){case LayoutAlgorithm.Squarified:arr=ch.slice(0);arr.sort(function sortEntity(s,t){var vs=getSizeValue(s,hm);var vt=getSizeValue(t,hm);if(isNaN(vs)){if(isNaN(vt)){return 0;}return 1;}if(isNaN(vt)){return -1;}return vs<vt?1:-1;});squarify.call(this,arr,{r:[]},min,area);break;case LayoutAlgorithm.SliceAndDice:sliceAndDice.call(this,ch,area);break;case LayoutAlgorithm.PivotByMiddle:arr=getVisibleEntities.call(this,ch);var l=arr.length;if(l>0){pivotByMiddle.call(this,arr,0,l-1,area);}break;}}function tooltipMacro(n,t){var macro=mstrmojo.desc(14109,"Total of")+" {0}";return macro.replace("{0}",n);}function getTooltipMetricInfo(e,w,metricIndex,info){var index=(e.index===undefined)?e.indices[0]:e.index;var mv=$UTIL.getPropertyByPath(w,"modelData.gvs.items",[]);var title=w.getMetricName(metricIndex);var value,aggFn,ev,mxInfo;if(metricIndex===-1){value=INVALID_METRIC_VALUE;}else{if(e.entityChildren!==undefined||w.aggregated){aggFn=w.aggFunctions[metricIndex];title=tooltipMacro(title,aggFn);value=getAggValue(e,metricIndex,w);ev=$UTIL.getPropertyByPath(e,"aggValues."+metricIndex);if(ev.isAETotalFaked||isNaN(value)){value=INVALID_METRIC_VALUE;}else{var fs=w.getFormatString(metricIndex);value=w.nf.formatByMask(fs,value);}}else{value=$UTIL.getPropertyByPath(mv,index+".items."+metricIndex+".v");if(value===""||value===undefined||value===null){value=INVALID_METRIC_VALUE;}}}mxInfo={n:title,v:value};if(info){info.push(mxInfo);}return mxInfo;}function sortMetricsForEntity(widget,entity){var metricCount=$UTIL.getPropertyByPath(widget,"modelData.gts.col.0.es.length",0);var sortedMetricIndex=[];var si=widget.sizeMetricIndex,ci=widget.colorMetricIndex;if(si!==undefined&&si!==metricCount){sortedMetricIndex.push(si);}if(!widget.isAttributeColorByType()&&entity.entityChildren===undefined&&ci!==undefined&&ci!==metricCount&&ci!==si){sortedMetricIndex.push(ci);}$UTIL.range(0,metricCount).forEach(function(idx){if(sortedMetricIndex.indexOf(idx)===-1){sortedMetricIndex.push(idx);}});return sortedMetricIndex;}function getTooltipInfo(e,w){var level=e.level,index=(e.index===undefined)?e.indices[0]:e.index,st=0,ar=w.attSpan,rhs=w.modelData.ghs.rhs.items,rowHeaderData=rhs[index].items,attr=w.modelData.gts.row,att;var title="",value="",attrId,eid;var info=[];var i,idx,j,len,form,formSeen;for(i=0;i<=level;i++){if(i>0&&i===level){info.push(null);}att=attr[i];var attLen=!!attr[i].cs?attr[i].cs:1;if(w.modelData.lnm===FORM_NAME_DISPLAY_TYPE.OFF){title=att.n;attrId=att.id;value="";formSeen=[];for(j=st,len=st+ar[i];j<len;j++){idx=rowHeaderData[j].idx;if(idx===-1){continue;}form=att.es[idx];if(formSeen.indexOf(form)===-1){value+=form.n+" ";if(j===st){eid=form.id;}formSeen.push(form);}}value=value.substring(0,value.length-1);info.push({n:title,v:value,tid:attrId,eid:eid});}else{for(j=st,len=st+ar[i];j!==len;j++){idx=rowHeaderData[j].idx;if(idx===-1){continue;}info.push({n:att.fs[j-st].n,v:att.es[idx].n});}}st+=attLen>1?attLen:ar[i];}var sortedMetricIndex=sortMetricsForEntity(w,e);if(SHOW_FAKE_METRIC_IN_TOOLTIP){sortedMetricIndex.push(-1);}sortedMetricIndex.forEach(function(idx){getTooltipMetricInfo(e,w,idx,info);});return info;}function wrapMojoEventToTouchEvent(e){return{evt:e,target:e.getTarget(),pageX:e.e.pageX,pageY:e.e.pageY,clientX:e.e.clientX,clientY:e.e.clientY};}var showSelectionMenu=function(e,formatHandler){if($UTIL.isOnExpressMode()){return ;}var evt=e.e||e,cfg=this.getSelectionMenuConfig();if(!mstrApp.isAppStatePresentation()&&mstrApp.allowWebDashboardDesign()&&formatHandler){var me=this;cfg.addSeparator();cfg.addMenuItem(mstrmojo.desc(1918,"Format"),"xt",function(){mstrApp.rootCtrl.docCtrl.selectViPanel("propertiesPanel");me.parent.selectVIUnit();formatHandler(e);});}if(cfg.hasMenuItems()){this.showMenu(cfg,evt);}};function showBlankSpaceMenu(e){if($UTIL.isOnExpressMode()||mstrApp.isAppStatePresentation()||!mstrApp.allowWebDashboardDesign()){return ;}e=e.e||e;this.showMenu(this.getBlankSpaceMenuConfig(e),e);}var COMPONENT_TYPES={BACKGROUND:"background",RECTANGLE:"rectangle",RECTANGLE_LABEL:"rectangleLabel",LEGEND_BACKGROUND:"legendBackground"};function generateObservableModel(){function updateData(propName,val,modelConfig){var props=this.props,updateModel=modelConfig.updateModel,toModelValue=modelConfig.toModelValue,toModelPropName=modelConfig.toModelPropName,newValue;props.unmarshal(propName,val);newValue=props[propName];if(updateModel){if(toModelValue instanceof Function){newValue=toModelValue.call(this,propName,newValue);}if(toModelPropName instanceof Function){propName=toModelPropName.call(this,propName);}this.observableModel[propName].setValue(newValue,true);}return newValue;}var getLegendBackground=function(){var props=this.props,idx=props.themeType==="light"?0:1,lgdBackground={value:this.bgColor,opacity:LegendPropDefault.lgdBgFillTrans[idx]/100};if(props.lgdBgFillClr){lgdBackground.value=$GMU.decodeColor(props.lgdBgFillClr);}if(props.lgdBgFillTrans){lgdBackground.opacity=props.lgdBgFillTrans/100;}return lgdBackground;};var updateLegendProperty=function(propertyName,newValue,vpName,refreshWidget){function update(val,updateModel){var lgd=this.attributeColorByLegend;if(!lgd||!lgd.hasRendered){return ;}updateData.call(this,propertyName,val,{updateModel:updateModel,toModelPropName:function(prop){if(prop===LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR||prop===LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY){return"legendBackground";}return prop;},toModelValue:function(prop,val){if(prop===LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR||prop===LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY){return getLegendBackground.call(this);}return val;}});this.initHTML5Props(this.HTML5PROPS);lgd.updateStyle(this.HTML5PROPS.LEGEND);if(refreshWidget){lgd.updateTitleLineHeight();this.hEvalSize4Legend();this.updateLegend();lgd.updateSplitter();this.updateCanvasAfterAttributeLegendChanged(LEGEND_DOCK_POS[lgd.currDockedPositionIdx].pos,this.legendW);}}update.call(this,newValue);this.setProperty(vpName,this.props.marshal(propertyName),{suppressData:true,clientUndoRedoCallback:update});}.bind(this);function getRefreshWidgetCallback(vpName,propsName,config){return function(){function update(newValue,updateModel){updateData.call(this,propsName,newValue,$HASH.copy(modelConfig,{updateModel:updateModel}));this.refreshWidget();if(updateModel&&refreshPropertyPanel){this.parent.selectVIUnit(true);}}config=$HASH.copy(config,{refreshPropertyPanel:true});var refreshPropertyPanel=config.refreshPropertyPanel;var modelConfig=config.modelConfig;update.call(this,om[propsName].getValue(),false);this.setProperty(vpName,this.props.marshal(propsName),{suppressData:true,clientUndoRedoCallback:update});};}var themeColors=this.props.headerColors,props=this.getPropsInfo(),colorByKey=this.isAttributeColorByType()?"attrColorByOpacity":"metricColorByOpacity",om=new mstrmojo.netviz.ObservableModel({isHeaderOnTop:props.isHeaderOnTop,labelSize:props.labelSize,showMetricValues:props.showMetricValues,layout:props.layout,background:this.background,headerColors:themeColors[0],fonts:props.fonts,legendBackground:getLegendBackground.call(this),showLegend:props.showLegend,colorByOpacity:props[colorByKey],lgdFntSz:props.lgdFntSz,lgdFntFml:props.lgdFntFml,lgdFntClr:props.lgdFntClr,lgdFntStyle:props.lgdFntStyle}),id=this.id;om.isHeaderOnTop.attachEventListener("valueChanged",id,getRefreshWidgetCallback(PROPERTIES_TYPE.headerType,"isHeaderOnTop"));om.labelSize.attachEventListener("valueChanged",id,getRefreshWidgetCallback(PROPERTIES_TYPE.labelSize,"labelSize"));om.showMetricValues.attachEventListener("valueChanged",id,getRefreshWidgetCallback(PROPERTIES_TYPE.showMetricValues,"showMetricValues"));om.layout.attachEventListener("valueChanged",id,getRefreshWidgetCallback(PROPERTIES_TYPE.layout,"layout"));om.headerColors.attachEventListener("valueChanged",id,getRefreshWidgetCallback(PROPERTIES_TYPE.headerColors,"headerColors",{refreshPropertyPanel:false,modelConfig:{toModelValue:function(propName,colors){return colors&&colors[0];}}}));om.background.attachEventListener("valueChanged",id,function(evt){this.background=om.background.getValue();var bgc=this.getSingleBackgroundColor();this.canvasObject.bgColor=bgc;this.highlightCanvas.backgroundColor=bgc;var fbgc=$CLR.encodeColor(this.getFormats()["background-color"],10),ebgc=$CLR.encodeColor(evt.newValue,10);if(fbgc!==ebgc){$UTIL.changeWidgetBackground(this,evt.newValue,evt.oldValue);}this.canvasObject.removeLabels();this.canvasObject.drawLabels();});om.fonts.attachEventListener("valueChanged",id,function(){var propertyName="fonts";function update(newValue,updateModel){function limitScale(path){return function(desc,newVal){if(desc.valid){return ;}var obj=$UTIL.getPropertyByPath(val,path),model=$UTIL.getPropertyByPath(om.fonts,path);if(obj&&model){obj.scale=newVal;model.scale.setValue(newVal,true);}};}var val=updateData.call(this,propertyName,newValue,{updateModel:updateModel});limitFontScale(val,inflatePathToObject(FONT_GROUP_NAMES,limitScale));notifyFontScaleLimitReached.call(this,val);this.canvasObject.fonts=this.props.fonts;this.refreshWidget();}update.call(this,om.fonts.getValue(),false);this.setProperty(PROPERTIES_TYPE.fonts,this.props.marshal(propertyName),{suppressData:true,clientUndoRedoCallback:update});});om.legendBackground.attachEventListener("valueChanged",id,function(e){var propName,newValue=e.newValue;if(isNaN(newValue)){newValue=$GMU.encodeColor(newValue);propName=LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR;}else{newValue*=100;propName=LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY;}updateLegendProperty(propName,newValue,propName,false);});om.lgdFntSz.attachEventListener("valueChanged",id,function(e){updateLegendProperty("lgdFntSz",e.newValue,LEGEND_FORMATTING_TYPE.LEGEND_FONT_SIZE,true);});om.lgdFntFml.attachEventListener("valueChanged",id,function(e){updateLegendProperty("lgdFntFml",e.newValue,LEGEND_FORMATTING_TYPE.LEGEND_FONT_FAMILY,true);});om.lgdFntClr.attachEventListener("valueChanged",id,function(e){updateLegendProperty("lgdFntClr",e.newValue,LEGEND_FORMATTING_TYPE.LEGEND_FONT_COLOR,false);});om.lgdFntStyle.attachEventListener("valueChanged",id,function(e){updateLegendProperty("lgdFntStyle",e.newValue,LEGEND_FORMATTING_TYPE.LEGEND_FONT_STYLE,true);});om.showLegend.attachEventListener("valueChanged",id,function(evt){var propName="showLegend";function update(newValue,updateModel){var show=updateData.call(this,propName,newValue,{updateModel:updateModel});var legend=this.attributeColorByLegend;if(!legend){this.reRender();return ;}this.toggleLegend(show);this.updateCanvasAfterAttributeLegendChanged(LEGEND_DOCK_POS[legend.currDockedPositionIdx].pos,(show?this.legendW:0));}update.call(this,evt.newValue,false);this.setProperty(PROPERTIES_TYPE.showLegend,this.props.marshal(propName),{suppressData:true,clientUndoRedoCallback:update});});om.colorByOpacity.attachEventListener("valueChanged",id,function(evt){function update(newValue,updateModel){updateData.call(this,colorByKey,newValue,{updateModel:updateModel,toModelPropName:function(prop){return"colorByOpacity";}});this.refreshWidget();}update.call(this,evt.newValue,false);this.setProperty(PROPERTIES_TYPE[colorByKey],this.props.marshal(colorByKey),{suppressData:true,clientUndoRedoCallback:update});});return om;}function isSelectionAtLevel(selection,levelPredicate){if(selection===undefined||selection===null||selection.length===0){return false;}return selection.every(function(entity){return levelPredicate(entity.level);});}function isSelectionAllSameHeaderLevel(){var leafLevel=this.levelAttributes.length-1,selectedLevel;return isSelectionAtLevel(this.previousSelected,function(level){if(level===leafLevel){return false;}if(selectedLevel===undefined){selectedLevel=level;}return selectedLevel===level;});}function isSelectionAllHeaders(){var leafLevel=this.levelAttributes.length-1;return isSelectionAtLevel(this.previousSelected,function(level){return level!==leafLevel;});}function isSelectionAllLeaves(){var leafLevel=this.levelAttributes.length-1;return isSelectionAtLevel(this.previousSelected,function(level){return level===leafLevel;});}function uniqueEntity(entities){var seen={},uniq=[],e,id,i,len;for(i=0,len=entities.length;i!==len;i+=1){e=entities[i];id=e&&e.id;if(id!==undefined&&!seen.hasOwnProperty(id)){seen[id]=true;uniq.push(e);}}return uniq;}function entitySupportsViewFilter(entity,attrs){var isCell=(entity.level===attrs.length-1),curr=entity,supported=attrs[entity.level].supportsViewFilter;if(isCell){while(supported&&curr.parentEntity){curr=curr.parentEntity;supported=attrs[curr.level].supportsViewFilter;}}return supported;}function selectionSupportsViewFilter(entities,attrs){var i,len;for(i=0,len=entities.length;i!==len;i++){if(!entitySupportsViewFilter(entities[i],attrs)){return false;}}return true;}function makeComb(tids,eids){return eids.map(function(eid,idx){return{eid:eid,tid:tids[idx]};});}function selectSameColorByEntities(comb){comb=$HASH.clone(comb);this.dfs(this.root,function(entity){var tids=entity.colorByAttributeIds||[],eids=entity.colorByElementIds||[],entityComb=makeComb(tids,eids);if($GMU.isEqualComb(entityComb,comb)){this.addToSelection(entity);}}.bind(this));}function showMetricColorByEditorMenuDescriptor(){return{type:"metricColorByOpacity",model:this.observableModel.colorByOpacity};}function showAttrColorByEditorMenuDescriptor(){var cbSel=this.edtModelCbInitSelection,cbElements=this.getColorByElements(),widget=this,len,elem,comb,itemIdx,cbItem,callback;if(cbSel===undefined||cbSel.length===0){return ;}len=cbSel.length;if(len>1){elem=cbElements[0];}else{comb=$HASH.clone(cbSel[0]);itemIdx=$UTIL.findInArray(cbElements,function(item){return $GMU.isEqualComb(comb,$HASH.clone(item.comb));});if(itemIdx===-1){return ;}elem=cbElements[itemIdx];}cbItem={color:elem.color,opacity:elem.opacity,showAutomatic:cbSel.some(function(comb){return $UTIL.isColorManuallySet(widget,comb);})};callback={onFillChanged:function(newValue,toolbarCallback){var rawValue=newValue,isAutomatic=rawValue==="automatic",sub;if(isAutomatic){newValue="default";}else{newValue=$GMU.encodeColor(newValue);}sub=widget.listenToUpdateColorMap(function(){var color="#ffffff",selectionLength=cbSel.length;if(isAutomatic){if(selectionLength===1){color=$GMU.decodeColor($UTIL.getCombColor(widget,elem.comb));}if(toolbarCallback instanceof Function){toolbarCallback(color);}rawValue=color;}widget.raiseEvent({name:"colorByColorChange",type:"invalidateCache"});widget.raiseEvent({name:"colorByColorChange",type:"fill",fill:rawValue,showAutomatic:!isAutomatic});widget.detachUpdateColorMapListener(sub);});widget.updateColorMap(cbSel,$UTIL.repeat(newValue,cbSel.length));},onOpacityChanged:function(newValue){widget.updateColorByOpacity(cbSel,$UTIL.repeat(newValue,cbSel.length));widget.raiseEvent({name:"colorByColorChange",type:"opacity",opacity:newValue});}};cbSel.forEach(selectSameColorByEntities.bind(this));this.refreshHighlights();return{type:"attributeColorBy",model:cbItem,callback:callback};}function showHeaderFillEditorMenuDescriptor(){return{type:"headerFill",model:this.observableModel.headerColors,label:mstrmojo.desc(12105,"Header Fill")};}function showRectangleEditor(entity,e){var attributes=this.levelAttributes,_this=this,isHeader=function(e){return _this.props.isHeaderOnTop&&e.level!==attributes.length-1;},isEntityHeader=isHeader(entity),fontModel,affectedModelPath;if(this.props.isHeaderOnTop){var fontGroup=this.observableModel.fonts.headerOnTop;if(isEntityHeader){fontModel=fontGroup.header;affectedModelPath="headerOnTop.header";}else{fontModel=fontGroup.cell;affectedModelPath="headerOnTop.cell";}}else{fontModel=this.observableModel.fonts.headerOnMiddle;affectedModelPath="headerOnMiddle";}var root=this.root;this.preorderTraverse(root,function(entity){var labelDomNode=entity.labelDomNode;if(labelDomNode&&isHeader(entity)===isEntityHeader){labelDomNode._oldTextDecoration=labelDomNode.style.textDecoration;labelDomNode.style.textDecoration="underline";var square=labelDomNode.parentNode.querySelector(".heatmap-label-square"),color=getComputedStyle(labelDomNode).color;if(square){square.style.background=color;square.style.display="block";}}});var descriptors=[];if(this.props.isHeaderOnTop&&entity.entityChildren&&entity.headerColor){descriptors.push(showHeaderFillEditorMenuDescriptor.call(this));}if(!entity.entityChildren&&this.isAttributeColorByType()){descriptors.push(showAttrColorByEditorMenuDescriptor.call(this));}var disableStepper=this.props.labelSize===LabelSize.Proportional;if(this.props.isHeaderOnTop&&isEntityHeader){disableStepper=false;}descriptors.push({type:"font",model:fontModel,disableFontSize:disableStepper,modelPath:affectedModelPath});var alignment,evt=e.e||e,colorByMetric=$UTIL.getMetricsInDropZone(this.zonesModel,$DROP_ZONES.ColorBy)[0]||null,isMetricColorBy=this.isMetricColorByType()&&colorByMetric;if(isMetricColorBy&&!isHeader(entity)){var CONFIG_ENUM_CORNERS=mstrmojo.ui.PopupConfig.ENUM_CORNERS;evt={pageX:evt.pageX,pageY:evt.pageY-6};alignment={host:CONFIG_ENUM_CORNERS.TOP_LEFT,popup:CONFIG_ENUM_CORNERS.BOTTOM_LEFT};descriptors.unshift(showMetricColorByEditorMenuDescriptor.call(this));}this.closePopup();this.showContextMenu(descriptors,evt,alignment);this._lastOpened.onClose=function(){_this.preorderTraverse(root,function(entity){var labelDomNode=entity.labelDomNode;if(labelDomNode&&isHeader(entity)===isEntityHeader){labelDomNode.style.textDecoration=labelDomNode._oldTextDecoration;labelDomNode._oldTextDecoration=undefined;var square=labelDomNode.parentNode.querySelector(".heatmap-label-square");if(square){square.style.display="none";}}});};if(isMetricColorBy&&!isHeader(entity)){var toolbar=this._lastOpened;this._lastOpened=null;var cfg=new mstrmojo.ui.menus.MenuConfig();cfg.addMenuItem(mstrmojo.desc(13174,"Select color ranges..."),"",function(){_this.model.openThresholdEditor(colorByMetric,true,false);});this.showMenu(cfg,e);var menu=this._lastOpened,_unlockHoverCheck=menu._unlockHoverCheck;menu._unlockHoverCheck=function(e,hWin){if(!$DOM.contains(toolbar.domNode,$DOM.eventTarget(hWin,e),true)){menu._unlockHoverCheck=_unlockHoverCheck;menu._unlockHoverCheck(e,hWin);}};}this.raiseEvent({name:"formatclick",type:"format",formatValue:affectedModelPath});$UTIL.selectPropertyPanel(this,"de");}function getRectangleHandler(action){return function(e){var touch=wrapMojoEventToTouchEvent(e),entity=this.getEntityByTouch(touch);if(this.isOnFormattingMode){action.call(this,entity,e);}else{showSelectionMenu.call(this,e,action.bind(this,entity));}};}function blankSpaceMenuHandler(e){var me=this;me.showContextMenu({type:"background",model:me.observableModel.background,noOpacity:true,showNoFill:false},e);$UTIL.selectPropertyPanel(me,0);}var rightClickHandlers={};rightClickHandlers[COMPONENT_TYPES.BACKGROUND]=function(e){if(this.isOnFormattingMode){blankSpaceMenuHandler.call(this,e);}else{showBlankSpaceMenu.call(this,e);}};var rectangleHandler=getRectangleHandler(showRectangleEditor);rightClickHandlers[COMPONENT_TYPES.RECTANGLE_LABEL]=rectangleHandler;rightClickHandlers[COMPONENT_TYPES.RECTANGLE]=rectangleHandler;function getSelectionDataMenuConfig(){var showDataMenu=this.allSupportsViewFilter||selectionSupportsViewFilter(this.previousSelected,this.levelAttributes),filterCfg=new mstrmojo.ui.menus.MenuConfig(),showDataCfg=new mstrmojo.ui.menus.MenuConfig(),cfg={filter:filterCfg,showData:showDataCfg};if(!showDataMenu){return cfg;}var attributeListFactory=$UTIL.getDrillMenuItemsCallback.bind($UTIL,this),isAllHeaders=isSelectionAllHeaders.call(this),isAllLeaves=isSelectionAllLeaves.call(this),getDrillSubMenu;if(isAllHeaders){getDrillSubMenu=attributeListFactory(this.getMenuHandler("headerDrill"));}if(isAllLeaves){getDrillSubMenu=attributeListFactory(this.getMenuHandler("rectangleDrill"));}filterCfg.addMenuItem(mstrmojo.desc(11701,"Keep only"),"xt",this.getMenuHandler("keepOnly"));filterCfg.addMenuItem(mstrmojo.desc(3946,"Exclude"),"xt",this.getMenuHandler("exclude"));showDataCfg.addMenuItem(mstrmojo.desc(13537,"Show Data..."),"xt",this.getMenuHandler("showData"));if(getDrillSubMenu&&getDrillSubMenu().hasMenuItems()){filterCfg.addPopupMenuItem(mstrmojo.desc(145,"Drill"),this.id,getDrillSubMenu,"xt");}else{filterCfg.addNonInteractiveMenuItem(mstrmojo.desc(145,"Drill"),"",true);}return cfg;}function getSelectionGroupMenuConfig(){var cfg={};if(mstrApp.isAppStatePresentation()){return cfg;}var showElementGroupMenu=isSelectionAllSameHeaderLevel.call(this),showDataPointGroupMenu=isSelectionAllLeaves.call(this),selection=this.previousSelected,fnCellName=function(cell){return cell.label;},me=this,data;if(showElementGroupMenu){data=this.getCellForNode(selection[0]);cfg=$UTIL.getGroupAndCalculationContextMenu(this,data,{skipSingleAttrCheck:true,selection:uniqueEntity(selection),fnCellName:fnCellName});}if(showDataPointGroupMenu){cfg=$UTIL.getGroupAndCalculationContextMenuForDataPoints(this,{selection:selection,fnCellName:fnCellName,fnUnique:function(selection){var uniqueElements=[],root=me.root,currLevel=selection,len=currLevel.length,i,entity,parentEntity,nextLevel,seen,id;while(len>0){if(len===1){entity=currLevel[0];while(entity!==root){uniqueElements.push(entity);entity=entity.parentEntity;}len=0;}else{nextLevel=[];seen={};for(i=0;i!==len;i+=1){entity=currLevel[i];parentEntity=entity.parentEntity;id=entity.id;if(!seen.hasOwnProperty(id)){seen[id]=true;uniqueElements.push(entity);}if(nextLevel.indexOf(parentEntity)===-1){nextLevel.push(parentEntity);}}currLevel=nextLevel;len=currLevel.length;}}return uniqueElements;},fnMakeNode:function(x){return x;}});}return cfg;}function formatByValidation(formatMask,nm){var fm=formatMask;if(!this.nf.validateFormat(fm)){fm="#,##0.00;(#,##0.00)";}return this.nf.formatByMask(fm,nm);}mstrmojo.heatmap.vi.VisHeatMap=mstrmojo.declare(mstrmojo.VisBase,[mstrmojo.util.ui._LassoSelector,mstrmojo.ui.menus._HasMenuPopup,mstrmojo._colorPalette,mstrmojo._VizSelectionHelper,mstrmojo.vi.ui.rw._HasVisSelections,mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl,mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights,mstrmojo.heatmap.vi._SupportHeatmapBrushesAndHighlights,mstrmojo.heatmap.vi._HasHeatmapContextMenu,mstrmojo.vi._MonitorsAppState,mstrmojo.vi.ui.rw._XtabDE,mstrmojo.vi.ui._IsDropTarget,mstrmojo.gm._SupportDndAsBlackBox],{scriptClass:"mstrmojo.heatmap.vi.VisHeatMap",selectedStyle:"background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #058CF5), color-stop(1, #015DE6));color:#FFFFFF;",selectedClass:"",insertedStyles:[],LayoutProperties:{},normalizedIdCache:{},highlightBoxWidth:3,waitIconString:mstrmojo.desc("8445","Loading"),markupString:'<div id="{@id}" class="heatmap-{@themeType}-theme mil-{@themeType} gm-{@themeType}-theme" style="width:{@width}px;height:{@height}px; left:{@left}px; top:{@top}px; z-index: {@zIndex}; position:absolute;" mstrAttach:'+HM_ATTACHED_EVENTS.join(",")+'><div class="heatmap-canvas-outer-container" style="padding: {@LayoutProperties.Padding}px; height:{@heatMapSize.h}px; width:{@heatMapSize.w}px; left: {@heatMapSize.x}px;"><div id ="{@id}-heatmap-canvas-container" class="heatmap-canvas-container" style="left: {@LayoutProperties.Padding}px; top: {@LayoutProperties.Padding}px; height:{@heatMapSize.h}px; width:{@heatMapSize.w}px"><div style="z-index: 1;"><div></div><div style="width: {@heatMapSize.w}px; height: {@heatMapSize.h}px;"></div></div></div></div><div></div><div style="width: {@legendSize.w}px; height: {@legendSize.h}px"></div></div>',markupSlots:{canvasSlot:function(){return this.domNode.childNodes[0].childNodes[0].childNodes[0].childNodes[0];},highlightCanvasPlaceholder:function(){return this.domNode.childNodes[0].childNodes[0].childNodes[0].childNodes[1];},canvasContainer:function(){return this.domNode.childNodes[0].childNodes[0];},canvasOuterContainer:function(){return this.domNode.childNodes[0];},containerNode:function(){return this.domNode;},scrollNode:function(){return this.domNode.childNodes[0].childNodes[0].childNodes[0];},textSpan:function(){return this.domNode.childNodes[1];},infoBoxPuppet:function(){return this.domNode.childNodes[1];},attributeColorByLegendPlaceHolder:function(){return this.domNode.childNodes[2];}},onAppStateChange:function onAppStateChange(evt){this._super(evt);if(!this.selectorControl){this.removeAllSelections();this.clearSelections();}this.isOnFormattingMode=(evt.value===mstrmojo.vi.VisualInsightApp.APP_STATES.FORMATTING);},getProperties:function(){var model=this.modelData;return(model&&model.vp)||{};},getPropsInfo:function(){return this.props||{};},init:function(e){this.props={};this.previousSelected=[];this._super(e);var canvas=document.createElement("canvas");var browserSupportsHtml5=canvas.getContext;this.nf=mstrmojo.num;if(!browserSupportsHtml5){this.browserSupportsHtml5=false;}else{this.browserSupportsHtml5=true;}this.HTML5PROPS={};if(!TOOLTIP_WIN){TOOLTIP_WIN=new mstrmojo.VisTooltip();TOOLTIP_WIN.render();}this.legendType=LEGEND_TYPE.VERTICAL;this.isOnFormattingMode=false;},update:function(node){$GMU.startTimer({functionName:"VisHeatMap.update",purpose:"JSON loading and consuming, generate the labels and colors"});var continueUpdate=this._super(node),egt,eg,err;if(continueUpdate!==false){this.clearError();egt=$UTIL.getPropertyByPath(this,"model.data.egt");eg=$UTIL.getPropertyByPath(this,"model.data.eg");err=$UTIL.getPropertyByPath(this,"model.data.err");if(egt!==undefined||eg!==undefined){this.setError(eg,egt);}if(err!==undefined){this.setError(err);}if(!this.browserSupportsHtml5){this.setError(mstrmojo.desc(8126,"Your browser does not support HTML5"));}this.modelData=this.model.data;if(!this.modelData){this.setError(mstrmojo.desc(8426,"No model provided"));}if(this.hasError()){$GMU.endTimer();return continueUpdate;}delete this.verticalLegendColorByElements;delete this.verticalLegendSizeByElements;delete this.colorByMetricThreshold;loadProps.call(this);convertDataToModels.call(this);if(this.hasError()){$GMU.endTimer();return continueUpdate;}this.loadDefinedFormat();this.observableModel=this.addDisposable(generateObservableModel.call(this));this.refreshLabelInTree();this.refreshColorInTree();}$GMU.endTimer();return continueUpdate;},preBuildRendering:function(){if(this.hasError()||this.waitingForData){return ;}this._super();var propsInfo=this.getPropsInfo(),showLegend=propsInfo.showLegend;if(showLegend&&this.legendType===LEGEND_TYPE.VERTICAL){this.defaultsLegendPop=sliceDefaultsLegendProp.call(this,(this.props.themeType==="light"?0:1));this.initHTML5Props(this.HTML5PROPS);}this.LayoutProperties=LayoutProperties;this.zIndex=null;$GMU.startTimer({functionName:"VisHeatMap.preBuildRendering",purpose:"layout of the rectangles"});if(showLegend){if(this.isAttributeColorByType()||propsInfo.hasColorInThresholds){this.getVerticalLegendColorByInfo();}if(propsInfo.sizeMetricEnabled){this.getVerticalLegendSizeByInfo();}}this.setLayout();layoutEntities.call(this);$GMU.endTimer();},setModel:function setModel(model){this._super(model);this.listenToUpdateColorMap(this.refreshWidget);},setError:function(msg,type){var translatedError=$UTIL.translateGridError(msg,type);this.error=translatedError.msg;this.errorType=translatedError.type;},clearError:function(){this.error=undefined;this.errorType=undefined;},hasError:function(){return this.error!==undefined||this.errorType!==undefined;},isEmpty:function(){return this.hasError();},getVisEmptyMsgControls:function(){var msg=this.error,type=this.errorType,rv;if(!this.hasError()){return ;}switch(type){case ERROR_TYPE.NO_DATASET:case ERROR_TYPE.NO_TEMPLATE_UNIT:rv=[{scriptClass:"mstrmojo.Label",cssClass:"dropMsg",text:msg}];break;case ERROR_TYPE.AE_ERROR:rv=[{scriptClass:"mstrmojo.Container",cssClass:"error-msg",markupString:$UTIL.getVisEmptyMsg("AE_ERROR"),markupSlots:{containerNode:function(){return this.domNode;}}}];break;default:rv=[{scriptClass:"mstrmojo.Container",cssClass:"error-msg",markupString:'<div class="{@cssClass}"><div class="error-content">'+msg+"</div></div>",markupSlots:{containerNode:function(){return this.domNode;}}}];break;}return rv;},postBuildRendering:function postBuildRendering(){if(this.waitingForData){return ;}if(this.isEmpty()){if($UTIL.isOnExpressMode()){$UTIL.renderWidgetErrorRSD(this,this.error,HM_ATTACHED_EVENTS);}else{this._super();}return ;}$GMU.startTimer({functionName:"VisHeatMap.postBuildRendering",purpose:"Rendering of HeatMap"});this.initCanvas();this.renderLegend();this.hInitListeners();this.registerLassoSelector(this.canvasOuterContainer,[],false);this.lassoSelectorEnabled=true;var exp=this.getExp(),gtsModel=this.getRowsAndCols();$UTIL.modifyScExp(exp,gtsModel,this.model,this.normalizedIdCache);var ret=this._super();var selected=this.previousSelected;if(selected&&selected.length>0){this.edtModelCbInitSelection=getColorbyElementsFromEntities(selected);}$GMU.endTimer();return ret;},hasSizebyOrColorby:function(){var props=this.getPropsInfo();return props.colorByType||props.sizeMetricID!==Fake_Metric_ID;},hInitListeners:function(){var id=this.id;if(this.attributeColorByLegend){this.legendResizeListener=this.attributeColorByLegend.attachEventListener("gm-legend-resized",id,function(evt){this.onLegendResized(evt.position);});this.legendClickListener=this.attributeColorByLegend.attachEventListener("gm-legend-clicked",id,function(evt){this.onLegendClicked(evt);});}},onLegendResized:function(distance){function refresh(){var lgd=this.attributeColorByLegend;if(lgd){this.hEvalSize4Legend();this.updateLegend();lgd.updateAfterResize();this.updateCanvasAfterAttributeLegendChanged(LEGEND_DOCK_POS[lgd.currDockedPositionIdx].pos,this.legendW);}}function update(scale,reRender){if(reRender){this.legendScale=scale;this.legendResized=true;this.legendFixedW=undefined;refresh.call(this);}}if(this.attributeColorByLegend){this.legendFixedW=this.legendW+distance;this.legendScale=(this.legendFixedW)/(this.legendW/this.legendScale);this.legendResized=true;this.writeGlobalAttriLegndProperty(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH,this.legendScale,{success:update});refresh.call(this);}},onLegendClicked:function(evt){var action=evt.action,legend=this.attributeColorByLegend,callback={success:function(){this.hEvalSize4Legend();this.updateLegend();this.updateCanvasAfterAttributeLegendChanged(LEGEND_DOCK_POS[legend.currDockedPositionIdx].pos,this.legendW);}};if(action==="close"){this.observableModel.showLegend.setValue(false);return ;}if(action==="minimize"){this.writeGlobalAttriLegndProperty(LEGEND_PROPERTY.LEGEND_MODE,ENUM_LEGEND_MODE.MINIMIZED,callback);}else{if(action==="restore"){this.writeGlobalAttriLegndProperty(LEGEND_PROPERTY.LEGEND_MODE,ENUM_LEGEND_MODE.RESTORED,callback);}}},unrender:function(){this.previousSelected=[];var $DDE=$DOM.detachEvent,TOUCHSTART=$DOM.TOUCHSTART;$DDE(this._tn,TOUCHSTART,this._tsCallback);this.hideInfoBox();if(this.attributeColorByLegend){this.attributeColorByLegend.unrender();delete this.attributeColorByLegend;}if(this.legendResizeListener){this.legendResizeListener.clear();}if(this.legendClickListener){this.legendClickListener.clear();}if(this.menuAnchor){document.body.removeChild(this.menuAnchor);this.menuAnchor=undefined;}this.destroyCanvas();this._super();},loadDefinedFormat:function(){if(this.defn&&this.defn.fmts){var fmts=this.defn.fmts;if(fmts["z-index"]){this.zIndex=fmts["z-index"];}}},refreshLabelInTree:function(){var getLabel=function(e,idx){if(e===this.root){return ;}e.text=this.getLabelForEntity(e);e.idx=idx;};this.dfs(this.root,getLabel,"");},getColorByAttrsByID:function(attrs,colorByAttr,colorByAttId){var pn=$UTIL.isHierarchyObject(colorByAttr)?"hid":"id",cid=colorByAttr.id,itemName="";$ARRAY.forEach(attrs,function(item){if(item[pn]===cid){colorByAttId.push(item.id);itemName+=(item.dn||item.n)+" ";}});return itemName;},getVerticalLegendColorByInfo:function(){if(this.isAttributeColorByType()){var colorByElementsTemp=this.attributeColorByElementsTemp;if(colorByElementsTemp===undefined){return ;}var i,j,tempId,idx,itm,text,elements,levels,e,tempAttrOrder,itemName="",res=[],attrs=this.props.colorAttributes,cbAttrLen=attrs.length,elementsLen=colorByElementsTemp.length,colorByAttrs=this.modelData.dz.ColorBy.TemplateUnit,colorByAttr,attributesLen=(colorByAttrs&&colorByAttrs.length)||0,colorByAttId=[];for(i=0;i<attributesLen;i++){colorByAttr=colorByAttrs[i];itemName+=this.getColorByAttrsByID(attrs,colorByAttr,colorByAttId);}itemName=itemName.substring(0,itemName.length-1);for(i=0;i<elementsLen;i++){itm={};text="";elements=[];levels=[];e=colorByElementsTemp[i];tempAttrOrder=[];itm.color=e.color.value;itm.decodedColor=itm.color;itm.encodedColor=$GMU.encodeColor(itm.color);itm.isDefaultColor=e.isDefaultColor;while(e&&e.parentEntity){if(this.props.colorAttributeIndexes.indexOf(e.level)!==-1){tempId=e.id.split(";")[1];tempAttrOrder.push({id:tempId,text:e.label});elements.splice(0,0,e.id);}e=e.parentEntity;}for(j=0;j<tempAttrOrder.length;j++){idx=$ARRAY.find(tempAttrOrder,"id",colorByAttId[j]);text=text+tempAttrOrder[idx].text+" ";}tempAttrOrder=[];text=text.substring(0,text.length-1);itm.label=text;for(j=0;j<cbAttrLen;j++){levels.push(attrs[j].id);}itm.token={elements:elements,levels:levels};res.push(itm);}delete this.attributeColorByElementsTemp;this.verticalLegendColorByElements={item:itemName,elements:res};}else{if(this.props.hasColorInThresholds){var colorByMetricThresholds=this.getColorByMetricThreshold(),metricName;if(colorByMetricThresholds){metricName=$UTIL.getColorByTitle(this.getMetricName(this.colorMetricIndex),colorByMetricThresholds.rankMode);this.verticalLegendColorByElements={item:metricName,elements:colorByMetricThresholds.items};}else{this.verticalLegendColorByElements=undefined;}}}},getVerticalLegendSizeByInfo:function(){var range=getSizeByMinMaxValues.call(this);if(range.max===Infinity&&range.min===-Infinity){this.verticalLegendSizeByElements=undefined;return ;}var sfs=this.getFormatString(this.sizeMetricIndex);var sizeByValueStrings=[],i,start=range.min,end=range.max,delta=(end-start)/4;for(i=0;i<5;i++){sizeByValueStrings.push(formatByValidation.call(this,sfs,end-i*delta));}var res={},elements;var mxName=this.getMetricName(this.sizeMetricIndex);if(range.hasNegativeValue){mxName=STR_ABS_VALUE_OF+mxName;}res.item=mxName;if(sizeByValueStrings.length>1){elements=res.elements=[];$ARRAY.forEach(sizeByValueStrings,function(szByValue){elements.push({sign:"<",v:szByValue});});if(elements.length===5){elements[0].sign="=";elements[4].sign="=";}res.caseFlag=0;}if(sizeByValueStrings.length===1){res.elements=[{diameter:12,shape:"rect",sign:"=",v:sizeByValueStrings[0]}];res.caseFlag=2;}this.verticalLegendSizeByElements=res;},getHeaderColor:function(e){var headerColor=$HASH.clone(this.props.headerColors[Math.min(e.level,2)]);if(e.level!==0&&!this.props.isDefaultHeaderColor){headerColor.opacity*=0.7;}return headerColor;},refreshColorInTree:function(){var processedElementIds=[],thrColors=[];var updateAttributeColorByData=function(e){if(e===this.root){return ;}var indexes=this.props.colorAttributeIndexes,lastAttriColorByLevel=indexes[indexes.length-1];if(e.level===lastAttriColorByLevel){var j,len=indexes.length,attributes=this.modelData.gts.row,curNode,allParentNodes=[],colorByAttributeIds=[],colorByElementIds=[],elementIdsPath="";curNode=e;for(j=0;j<=lastAttriColorByLevel;j++){allParentNodes.splice(0,0,curNode);curNode=curNode.parentEntity;}for(j=0;j<len;j++){colorByAttributeIds.push(attributes[indexes[j]].id);elementIdsPath+=allParentNodes[indexes[j]].id+":";colorByElementIds.push(allParentNodes[indexes[j]].id);}if(processedElementIds.indexOf(elementIdsPath)===-1){this.attributeColorByElementsTemp.push(e);processedElementIds.push(elementIdsPath);}this.preorderTraverse(e,function(node){node.colorByAttributeIds=colorByAttributeIds;node.colorByElementIds=colorByElementIds;});}};if(this.isAttributeColorByType()){this.attributeColorByElementsTemp=[];this.preorderTraverse(this.root,updateAttributeColorByData);}else{var m=this.modelData;if(this.props.colorMetricID!==Fake_Metric_ID&&m.gsi.thresholds[this.props.colorMetricID]!==undefined){var thresholds=m.gsi.thresholds[this.props.colorMetricID],ii;for(ii=0;ii<thresholds.length;ii++){if(thresholds[ii].fmt&&thresholds[ii].fmt.bc){thrColors[ii]=thresholds[ii].fmt.bc;}else{thrColors[ii]=$CLRUTIL.getCSSColorString(Background_Color);}}}}var paintColor=function(e){if(e===this.root){return ;}var color,colorTheme=this.colorTheme,opacity=1,colorBy,tids,eids;if(this.isAttributeColorByType()&&e.colorByAttributeIds&&e.colorByElementIds){tids=e.colorByAttributeIds;eids=e.colorByElementIds;colorBy=this.model.docModel.getColorBy(tids,eids);color=$GMU.decodeColor(colorBy.color);opacity=getAttrColorByOpacity.call(this,tids,eids)/100;e.isDefaultColor=!colorBy.isManual;}else{if(this.props.colorMetricID!==Fake_Metric_ID&&thrColors.length>0&&e.thrColorIndex>=0){color=$CLRUTIL.getCSSColorString(thrColors[e.thrColorIndex]);opacity=this.getPropsInfo().metricColorByOpacity;}else{color=$CLRUTIL.getCSSColorString(Background_Color);}}e.color={value:color,opacity:opacity};if(this.props.isHeaderOnTop){e.headerColor=this.getHeaderColor(e,colorTheme.style==="light");}};this.dfs(this.root,paintColor,"");},dfs:function(root,f,indexString){if(!root||root.deleted){return ;}if(indexString===undefined){f.call(this,root);}else{f.call(this,root,indexString);}if(root.entityChildren===undefined){return ;}var arr=root.entityChildren,l=arr.length,i;for(i=0;i<l;i++){var e=arr[i];if(indexString===undefined){this.dfs(e,f);}else{var param=indexString;if(!param){param=i.toString();}else{param=param+":"+i;}this.dfs(e,f,param);}}},preorderTraverse:function(root,f){if(root){var ret=f.call(this,root);if(ret===false){return ;}var children=root.entityChildren||[],len=children.length,i;for(i=0;i<len;i++){this.preorderTraverse(children[i],f);}}},getSingleBackgroundColor:function(){return this.background&&this.background.value&&(this.background.value.c1||this.background.value);},initCanvas:function(){var _this=this,props=getCanvasConfig.call(this);this.destroyCanvas();this.addChildren(new mstrmojo.heatmap.vi.VisHeatMapCanvas(props));this.highlightCanvas=this.canvasObject.addDisposable(new mstrmojo.heatmap.vi.VisHeatMapHighlightCanvas({placeholder:this.highlightCanvasPlaceholder,isOnSelectionMode:function(){return _this.previousSelected.length>0;},themeType:this.props.themeType,backgroundColor:this.getSingleBackgroundColor()}));this.highlightCanvas.render();this.highlightCanvas.parent=this;},destroyCanvas:function destroyCanvas(){var canvas=this.canvasObject;if(canvas){this.highlightCanvas=null;this.removeChildren(canvas);canvas.destroy();}},scaleFactor:1,renderRectangles:function(){this.canvasObject.clearFontCache();this.refreshLabelInTree();this.refreshColorInTree();this.canvasObject.isHeaderOnTop=this.props.isHeaderOnTop;this.canvasObject.render();},renderLegend:function renderLegend(){if(!this.props.showLegend){if(this.attributeColorByLegendPlaceHolder){this.attributeColorByLegendPlaceHolder.style.display="none";}return ;}if(!this.attributeColorByLegend){var _this=this;var legend=this.canvasObject.addDisposable(new $GM.GMLegend({widget:this,model:this.model,placeholder:this.attributeColorByLegendPlaceHolder,currDockedPositionIdx:getLegendDockPosIdx(this.readGlobalAttriLegndProperty(LEGEND_PROPERTY.LEGEND_POSITION)),cutBy:this.legendCutBy,cssClass:"gm-legend",styles:this.HTML5PROPS.LEGEND,readGlobalProperty:function(propName){return _this.readGlobalAttriLegndProperty(propName);},writeGlobalProperty:function(propName,newValue){if(propName===LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR){_this.observableModel.legendBackground.value.setValue($GMU.decodeColor(newValue));}else{if(propName===LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY){_this.observableModel.legendBackground.opacity.setValue(newValue/100);}else{if(_this.observableModel[propName]){_this.observableModel[propName].setValue(newValue);}else{_this.writeGlobalAttriLegndProperty(propName,newValue,{success:function(){_this.reRender();}});}}}},configureLegendPopup:function(config,itemBtn){return _this.configureAttriLegendPopup(config,itemBtn);}}));legend.render();legend.parent=this;this.attributeColorByLegend=legend;this.attributeColorByLegendPlaceHolder=legend.domNode;}else{var lgd=this.attributeColorByLegend;lgd.currDockedPositionIdx=getLegendDockPosIdx(this.readGlobalAttriLegndProperty(LEGEND_PROPERTY.LEGEND_POSITION));this.initHTML5Props(this.HTML5PROPS);lgd.updateStyle(this.HTML5PROPS.LEGEND);lgd.updateTitleLineHeight();this.hEvalSize4Legend();this.updateLegend();lgd.updateSplitter();this.updateCanvasAfterAttributeLegendChanged(LEGEND_DOCK_POS[lgd.currDockedPositionIdx].pos,this.legendW);}this.attributeColorByLegend.cutBy=this.legendCutBy;this.attributeColorByLegend.minHeight=this.legendMinHeight;this.attributeColorByLegend.updateContainerSize(this.getWidth(),this.getHeight());this.attributeColorByLegend.feedData([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:this.verticalLegendColorByElements},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:this.verticalLegendSizeByElements}],(this.readGlobalAttriLegndProperty(LEGEND_PROPERTY.LEGEND_MODE)===ENUM_LEGEND_MODE.MINIMIZED));},getColorByMetricThreshold:function(){if(!this.props.hasColorInThresholds){return undefined;}var colorByMetricThreshold;if(this.colorByMetricThreshold){colorByMetricThreshold=this.colorByMetricThreshold;}else{var m=this.modelData,mx=m.gsi.mx,colorMetricID=this.props.colorMetricID,mxOfColorMetric={max:"",min:""},rankMode,colorByMetricThresholdItems;$ARRAY.forEach(mx,function(obj){if(obj.did===colorMetricID){mxOfColorMetric=obj;return false;}});if(mxOfColorMetric.max===""&&mxOfColorMetric.min===""){this.colorByMetricThreshold=undefined;return ;}if(m.gsi.thresholds[colorMetricID]&&mxOfColorMetric){var thresholds,fs;thresholds=m.gsi.thresholds[colorMetricID];rankMode=$UTIL.getRankMode(thresholds);fs=$UTIL.getColorByFormatStr(this.getFormatString(this.colorMetricIndex),rankMode);colorByMetricThresholdItems=$UTIL.getColorByItems(thresholds,rankMode,mxOfColorMetric.max,mxOfColorMetric.min,mxOfColorMetric.cnt,fs,$CLRUTIL.getCSSColorString(Background_Color));colorByMetricThresholdItems.sort(function(item1,item2){var r;if(item1.ceil>item2.ceil){r=1;}else{if(item1.ceil===item2.ceil){r=0;}else{r=-1;}}return r;});}else{if(mxOfColorMetric){colorByMetricThresholdItems=$UTIL.getDefaultColorByItems($CLRUTIL.getCSSColorString(Background_Color),mxOfColorMetric.max,mxOfColorMetric.min);}else{colorByMetricThresholdItems=$UTIL.getDefaultColorByItems($CLRUTIL.getCSSColorString(Background_Color),1,0);}rankMode=ENUM_COLOR_RANKMODE.VALUE;}colorByMetricThreshold={rankMode:rankMode,items:colorByMetricThresholdItems};this.colorByMetricThreshold=colorByMetricThreshold;}return colorByMetricThreshold;},render:function(e){if(this.hasRendered&&this.unrender){this.unrender();}this._super(e);},reRender:function reRender(){if(this.hasError()){return ;}this._super();},loadDeleteStatus:function(node,delDict){if(!node.entityChildren){if(delDict===delStatus.dftDel||delDict===delStatus.usrDel){node.deleted=true;}else{delete node.deleted;}return ;}if((!delDict||Object.keys(delDict).length===0)&&!node.hasChildDeleted){return ;}var children=node.entityChildren,i;for(i=0;i<children.length;i++){var child=children[i];var name=this.getEntityDisplayName(child);var thisDict=delDict&&delDict[name];this.loadDeleteStatus(child,thisDict);}},getFormatString:function getFormatString(idx){var m=this.modelData,nf=m.nf||[],len=nf.length,nfs;if(idx>=0&&idx<len){nfs=$UTIL.getNumberFormat(m,idx);return nfs.replace(/\'/g,'"');}return"";},checkMetricValid:function checkMetric(idx){var m=this.modelData,col=m.ghs.chs.items,ml=col[0]?col[0].items.length:0;return !(idx<0||idx>=ml);},getMetricName:function getMetricName(idx){var str="",m=this.modelData,col=m.ghs.chs.items,cnt=col.length,coln=m.gts.col,i;if(!this.checkMetricValid(idx)){return Fake_Metric_ID;}for(i=0;i<cnt;i++){var index=col[i].items[idx].idx;var name=coln[i].es[index].n;str+=name+" ";}return str.slice(0,str.length-1);},getEntityDisplayName:function getEntityDisplayName(e){var level=e.level,index=(e.index===undefined)?e.indices[0]:e.index,st=0,str="",ar=this.attSpan,rhs=this.modelData.ghs.rhs.items,rowHeaderData=rhs[index].items,att=this.modelData.gts.row[level],i,form,formSeen=[];for(i=0;i<level;i++){st+=!!this.modelData.gts.row[i].cs?this.modelData.gts.row[i].cs:ar[i];}for(i=st;i<st+ar[level];i++){var idx=rowHeaderData[i].idx;if(idx===-1){continue;}form=att.es[idx];if(formSeen.indexOf(form)===-1){str+=form.n+" ";formSeen.push(form);}}str=str.substring(0,str.length-1);return str;},previousTooltip:null,previousSelected:[],drawHighlight:function(entity){if(!entity){return null;}var isHovered=entity===this.previousTooltip,isHeaderOnTop=this.props.isHeaderOnTop,rect=entity.headerSize||entity.size,isHeader=!!entity.entityChildren,highlightCanvas=this.highlightCanvas;highlightCanvas.highlight(rect,entity.labelDomNode,{isHovered:isHovered,isSelected:this.previousSelected.indexOf(entity)!==-1,isEntityContainer:isHeader,isHeaderOnTop:isHeaderOnTop});return rect;},updateEntityHighlight:function(entity){if(!entity){return ;}this.drawHighlight(entity);var isHovered=entity===this.previousTooltip,isHeaderOnTop=this.props.isHeaderOnTop,highlightCanvas=this.highlightCanvas;if(!isHeaderOnTop){var containsEntity=function(p,c){while(c){c=c.parentEntity;if(c===p){return true;}}return false;};(this.previousSelected||[]).forEach(function(e){if(containsEntity(entity,e)){highlightCanvas.highlight(e.size,e.labelDomNode,{isHovered:isHovered,isSelected:true,isEntityContainer:!!e.entityChildren,isHeaderOnTop:false});}});}},refreshHighlights:function(entitySet){if(!this.highlightCanvas){return ;}entitySet=entitySet||this.previousSelected||[];if(!this.props.isHeaderOnTop){entitySet.sort(function(a,b){var la=a.level,lb=b.level;if(la<lb){return -1;}else{if(la>lb){return 1;}else{return 0;}}});}this.highlightCanvas.clear();entitySet.forEach(this.drawHighlight,this);},getLowestLevelRectangle:function(touch){var target=document.elementFromPoint(touch.pageX,touch.pageY);var hiddenStack=[];while(!this.isLowestLevelRectangle(target)){target.style.display="none";hiddenStack.push(target);target=document.elementFromPoint(touch.pageX,touch.pageY);}while(hiddenStack.length){hiddenStack.pop().style.display="block";}return target;},areaSelect:function(rect,info){var lastSelection=this.previousSelected.slice();if(!info.ctrlKey){this.removeAllSelections();}this.preorderTraverse(this.root,function(entity){if(entity===this.root||!entity.size){return ;}if(!entity.entityChildren&&!isNaN(rectIntersection(entity.size,rect).x)){this.addToSelection(entity);return false;}});this.doSelection();this.refreshHighlights();if(!isSelectionEqual(lastSelection,this.previousSelected)){raiseSelectionChangeEvent.call(this,this.previousSelected);}var offset,selected=this.previousSelected;if(selected&&selected.length>0){offset=$DOM.position(this.canvasObject.domNode,true);this._toolbarContext={type:COMPONENT_TYPES.RECTANGLE,pos:{e:{pageX:rect.x+offset.x,pageY:rect.y+offset.y},getTarget:function(){return undefined;}},entity:selected[0]};}},getEntityByTouch:function(touch,getLowest){var target=this.getElementBehindCurtains(touch.evt);if(!target){return null;}var pageX=touch.pageX,pageY=touch.pageY;if(getLowest){var lastLevel=target,backUps=[];while(target!==this.domNode&&target.tagName.toLowerCase()!=="img"){backUps.push(target);target.style.visibility="hidden";target=document.elementFromPoint(pageX,pageY);if(!target||target===lastLevel){break;}lastLevel=target;}while(backUps.length>0){var node=backUps.pop();node.style.visibility="visible";}}if(!target){return null;}var entity;if(target!==this.domNode){if(target.getAttribute("idx")&&!getLowest){entity=this.getIdxObjectByTarget(target);}else{var rectPosition=$DOM.position(this.canvasObject.domNode,true),offsetX=pageX-rectPosition.x,offsetY=pageY-rectPosition.y;var position={x:offsetX,y:offsetY};entity=this.canvasObject.getEntity(position);}}return entity;},getLabelForEntity:function(e){if(!this.props.showMetricValues||e.entityChildren!==undefined){return this.getEntityDisplayName(e);}var widget=this;var sortedMetricIndex=sortMetricsForEntity(this,e);var lines=sortedMetricIndex.map(function(idx){return getTooltipMetricInfo(e,widget,idx).v;});lines.unshift(this.getEntityDisplayName(e));var st="<span>"+lines.join("<br>")+"</span>";return st;},lassoSelecting:function(){$CSS.removeClass(this.lassoSelector,"lasso-selector-hasContent");},lassoSelected:function(params){this.areaSelect({x:params.left,y:params.top,w:params.width,h:params.height},params);if(this.previousSelected.length){$CSS.addClass(this.lassoSelector,"lasso-selector-hasContent");}},lassoSelectorResized:function(params){this.lassoSelecting();this.lassoSelected(params);},configurePopup:function(config,itemBtn){config.hostId=this.id;config.hostElement=itemBtn;},showMenu:function(menuCfg,evt){var anchor=this.menuAnchor,anchorStyle;if(!anchor){anchor=document.createElement("div");anchor.id=this.id+"-hm-menu-anchor";anchor.style.position="absolute";document.body.appendChild(anchor);this.menuAnchor=anchor;}anchorStyle=anchor.style;anchorStyle.left=evt.pageX+"px";anchorStyle.top=evt.pageY+"px";this.configurePopup(menuCfg,anchor);this.openPopup(menuCfg.newInstance());},getSelectionMenuConfig:function(){var cfg=$UTIL.mergeHashes(getSelectionDataMenuConfig.call(this),getSelectionGroupMenuConfig.call(this)),menuOrder=[{name:"filter"},{name:"editGroup"},{name:"editCalculation"},{name:"createDe"},{name:"showData"},{name:"renameDe"}];return $UTIL.mergeMenuConfigs(cfg,menuOrder);},getBlankSpaceMenuConfig:function(e){var cfg=new mstrmojo.ui.menus.MenuConfig(),me=this,props=me.props;cfg.addMenuItem(mstrmojo.desc(1918,"Format"),"xt",function(){blankSpaceMenuHandler.call(me,e);});if(this.hasSizebyOrColorby()){if(!props.showLegend){var legendDescriptor=mstrmojo.desc(12001,"Show Legend"),menuHandlerId="showLegend";cfg.addMenuItem(legendDescriptor,"xt",this.getMenuHandler(menuHandlerId));}}return cfg;},keepOnly:function(){this.updateAfterKeepOnly(true);},exclude:function(){this.updateAfterKeepOnly(false);},getMenuHandler:function(name){var handler=this._super(name);if(handler!==mstrmojo.emptyFn){return handler;}var _this=this,handlers={keepOnly:function selectionKeepOnly(){_this.keepOnly();_this.noHighlightAfterKeepOnlyExcludeDrill=true;},exclude:function selectionExclude(){_this.exclude();_this.noHighlightAfterKeepOnlyExcludeDrill=true;},showData:function showData(){_this.showData();},rectangleDrill:function cellDrill(menuItem){$UTIL.doDrill(_this,menuItem.ctxt.drillUnit,updateDropZoneInDrill,{headerDrill:false});_this.noHighlightAfterKeepOnlyExcludeDrill=true;},headerDrill:function headerDrill(menuItem){$UTIL.doDrill(_this,menuItem.ctxt.drillUnit,updateDropZoneInDrill,{headerDrill:true});_this.noHighlightAfterKeepOnlyExcludeDrill=true;},showLegend:function showLegend(){_this.observableModel.showLegend.setValue(true);},hideLegend:function hideLegend(){_this.observableModel.showLegend.setValue(false);}};if(handlers.hasOwnProperty(name)){return handlers[name];}return mstrmojo.emptyFn;},isClearAllEnabled:function(entity){var m=this.modelData||{},attributes=$UTIL.getPropertyByPath(m,"gts.row",[]),idx,attribute,sc=m.sc,eid;if(entity){eid=entity.id||"";idx=$UTIL.findInArray(attributes,function(att){return eid.indexOf(att.id)!==-1;});if(idx!==-1){attribute=attributes[idx];sc=attribute.sc||sc;}}return !!(sc===undefined||sc.showall);},addToSelection:function(entity){var ps=this.previousSelected||[];if(ps.indexOf(entity)===-1){ps.push(entity);}},removeFromSelection:function(entity){var ps=this.previousSelected||[],index=ps.indexOf(entity);if(index!==-1){ps.splice(index,1);return true;}return false;},removeAllSelections:function(slient){var selection=(this.previousSelected||[]).slice();this.previousSelected=[];if(!slient&&selection.length>0){this.raiseEvent({name:"selectionBatchRemove",entities:selection});}return selection;},onclick:function(e,dontRemoveSelection){delete this.noHighlightAfterKeepOnlyExcludeDrill;if(!dontRemoveSelection){this.dismissLassoSelector();}var target=e.getTarget(),selectionChanged=false,needsClear=false,isAdded=false,isRemoved=false,entity,pl,ps,wasEmpty,isInList,ctrlKey,isMultipleSelected,isPreSelLeave=isSelectionAllLeaves.call(this),isPreSelHead=isSelectionAllHeaders.call(this),isSelLeave;if(this.isRectangle(target)){entity=this.getEntityByTouch(wrapMojoEventToTouchEvent(e));if(entity){isSelLeave=entity.level===this.levelAttributes.length-1;ps=this.previousSelected;pl=ps.length;wasEmpty=pl===0;isInList=ps.indexOf(entity)!==-1;ctrlKey=e.e.ctrlKey||e.e.metaKey;isMultipleSelected=pl>1;if(isInList&&!isMultipleSelected){if(!dontRemoveSelection&&this.isClearAllEnabled(entity)){needsClear=true;this.removeAllSelections();}}if((isInList&&!ctrlKey&&isMultipleSelected&&!dontRemoveSelection)||(!isInList&&!ctrlKey)||(isPreSelLeave^isSelLeave&&!isInList&&ctrlKey)||(!(isPreSelLeave||isPreSelHead)&&isInList)){needsClear=true;isAdded=true;this.removeAllSelections();this.addToSelection(entity);}if(!isInList&&ctrlKey){isAdded=true;this.addToSelection(entity);}if(isInList&&ctrlKey&&isMultipleSelected){if(!dontRemoveSelection){isRemoved=true;this.removeFromSelection(entity);}}needsClear=needsClear||wasEmpty===(this.previousSelected.length>0);if(needsClear){this.highlightCanvas.clear();}if(isAdded||isRemoved){this.updateEntityHighlight(entity);}if(needsClear||isAdded||isRemoved){this.doSelection();selectionChanged=true;}if(!isInList){this.dismissLassoSelector();}}}var component=this.getComponentType(e),selected;if(!dontRemoveSelection){if(component.type===COMPONENT_TYPES.BACKGROUND||component.type===COMPONENT_TYPES.LEGEND_BACKGROUND){selected=(this.previousSelected||[]).filter(this.isClearAllEnabled,this);if(selected.length>0){selected.forEach(function(entity){this.removeFromSelection(entity);},this);this.doSelection();selectionChanged=true;this.refreshHighlights(selected);this.refreshHighlights();}}}if(this.attributeColorByLegend){this.attributeColorByLegend.hideToolbar();}if(selectionChanged){raiseSelectionChangeEvent.call(this,this.previousSelected);}this._toolbarContext={type:component.type,pos:e};},getElementBehindCurtains:function(e){var curtainNodes=[this.highlightCanvas.domNode,this.lassoSelector];$ARRAY.forEach(curtainNodes,function(curtain){curtain._visibility=curtain.style.visibility;curtain.style.visibility="hidden";});var target=document.elementFromPoint(e.e.pageX,e.e.pageY);$ARRAY.forEach(curtainNodes,function(curtain){curtain.style.visibility=curtain._visibility;curtain._visibility=undefined;});return target;},getComponentType:function(e){var ret;var target=this.getElementBehindCurtains(e);if(this.isRectangle(target)){if(target.getAttribute("idx")||(target.tagName==="SPAN"&&target.parentNode.getAttribute("idx"))){ret=COMPONENT_TYPES.RECTANGLE_LABEL;}else{var entity=this.getEntityByTouch(wrapMojoEventToTouchEvent(e));if(entity){ret=COMPONENT_TYPES.RECTANGLE;}else{ret=COMPONENT_TYPES.BACKGROUND;}}}else{if(this.attributeColorByLegend.domLegend===target){ret=COMPONENT_TYPES.LEGEND_BACKGROUND;}else{if(target===this.domNode){ret=COMPONENT_TYPES.BACKGROUND;}}}return{type:ret,target:target};},isRectangle:function(target){return $DOM.contains(this.canvasObject.domNode,target,true)||$DOM.contains(this.highlightCanvas.domNode,target,true)||$DOM.contains(this.lassoSelector,target,true);},isLowestLevelRectangle:function(target){return target.getAttribute&&target.getAttribute("idx")&&!(target.innerHTML);},toggleSelectAll:function(entity){var sc=this.modelData.gts.row[entity.level].sc;if((sc&&sc.all!=="false"&&sc.all!==false)||!this.hasGridTarget){this.selectAll=!this.selectAll;return true;}return false;},doSelection:function(){this.prepareSelectedNodesInfo();this.endSelections();},getObjectByIdx:function(idx){if(idx){var indexArray=idx.split(":");var obj=this.root,i;for(i=0;i<indexArray.length;i++){obj=obj.entityChildren[indexArray[i]];}return obj;}return null;},setColorByType:function(type){if(type==="attribute"){this.props.colorByType="attribute";this.colorTheme.colorByType="attribute";}else{this.props.colorByType="metric";delete this.colorTheme.colorByType;}},clearChildren:function(node){if(!node){return ;}while(node.firstChild){node.removeChild(node.firstChild);}},setLayout:function setLayout(slotPos){var widgetWidth=parseInt(this.width,10),widgetHeight=parseInt(this.height,10),padding=this.LayoutProperties.Padding,heatMapWidth=widgetWidth-2*padding,heatMapHeight=widgetHeight-2*padding,heatMapLeft=0;if(!this.legendSize){this.legendSize={};}var legendSize=this.legendSize;if(this.props.showLegend){if(this.legendType===LEGEND_TYPE.VERTICAL){if(!slotPos){if(this.attributeColorByLegend){slotPos=LEGEND_DOCK_POS[this.attributeColorByLegend.currDockedPositionIdx].pos;}else{slotPos=this.readGlobalAttriLegndProperty(LEGEND_PROPERTY.LEGEND_POSITION);}}this.hEvalSize4Legend();legendSize.w=this.legendW;legendSize.h=this.legendH;heatMapWidth-=legendSize.w;if(!this.isOnRight(slotPos)){heatMapLeft=legendSize.w;}}}this.heatMapSize={x:heatMapLeft,y:0,w:heatMapWidth,h:heatMapHeight};this.maxScale=10;},hEvalSize4Legend:function(){var rtn,cData=this.verticalLegendColorByElements,sData=this.verticalLegendSizeByElements,width=this.getWidth(),height=this.getHeight(),legendStyle=this.HTML5PROPS.LEGEND,scale;if(this.props.showLegend===false){this.legendW=this.legendH=this.legendP=0;}else{$LEGEND.applyHTML5Props(legendStyle);this.legendP=LEGEND_PADDING;if(!this.legendScale){scale=this.readGlobalAttriLegndProperty(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH);if(scale){this.legendScale=scale;this.legendResized=true;}}rtn=$LEGEND.getLegendSize([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:cData},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:sData}],this.legendResized?this.legendScale:undefined,width,height,legendStyle,this.legendFixedW);this.legendCutBy=rtn.cutBy;this.legendMinHeight=rtn.minHeight;this.legendFixedW=rtn.width;if(rtn.scale){this.legendScale=rtn.scale;}if(this.readGlobalAttriLegndProperty(LEGEND_PROPERTY.LEGEND_MODE)===ENUM_LEGEND_MODE.MINIMIZED||rtn.autoCollapse){rtn=$LEGEND.getLegendSize4MinMode(cData,height);this.legendCutBy=undefined;}this.legendW=rtn.width;this.legendH=rtn.height;}},applyLayout:function(){if(this.heatMapSize){if(this.canvasOuterContainer){var canvasOuterContainerStyle=this.canvasOuterContainer.style;canvasOuterContainerStyle.left=this.heatMapSize.x+"px";canvasOuterContainerStyle.top=this.heatMapSize.y+"px";canvasOuterContainerStyle.width=this.heatMapSize.w+"px";canvasOuterContainerStyle.height=this.heatMapSize.h+"px";}if(this.canvasContainer){var canvasContainerStyle=this.canvasContainer.style;canvasContainerStyle.width=this.heatMapSize.w+"px";canvasContainerStyle.height=this.heatMapSize.h+"px";}if(this.canvasObject){var canvasObject=this.canvasObject;canvasObject.width=this.heatMapSize.w;canvasObject.height=this.heatMapSize.h;}}},refreshWidget:function(){var props=getCanvasConfig.call(this);$HASH.copy(props,this.canvasObject);this.setLayout();this.applyLayout();layoutEntities.call(this);this.renderRectangles();this.refreshHighlights();if(this.props.showLegend){if(this.isAttributeColorByType()||this.props.hasColorInThresholds){this.getVerticalLegendColorByInfo();}if(this.props.sizeMetricEnabled){this.getVerticalLegendSizeByInfo();}}this.renderLegend();},hideInfoBox:function(){var win=TOOLTIP_WIN.domNode;if(win&&win.parentNode){var oldTooltip=this.previousTooltip;this.previousTooltip=undefined;this.updateEntityHighlight(oldTooltip);win.parentNode.removeChild(win);}},getIdxObjectByTarget:function(target){var ancestor=$DOM.findAncestorByAttr(target,"idx",true,this.domNode);var idx=ancestor&&ancestor.value;if(!idx){return null;}return this.getObjectByIdx(idx);},showInfoBox:function(entity,pos){if(!entity){return ;}TOOLTIP_WIN.toggle(true);if(entity===this.previousTooltip){TOOLTIP_WIN.moveTo(pos.x,pos.y);return ;}var lastHovered=this.previousTooltip;this.previousTooltip=entity;this.updateEntityHighlight(lastHovered);this.updateEntityHighlight(entity);var interRect=entity.headerSize||entity.size;if(!interRect||isNaN(interRect.x)){return ;}var tooltipInfo=getTooltipInfo(entity,this);if(tooltipInfo){if(!TOOLTIP_WIN.domNode.parentNode){document.body.appendChild(TOOLTIP_WIN.domNode);}TOOLTIP_WIN.displayInfo(tooltipInfo,pos);}},onmousedown:function(){this._isMouseDown=true;},onmousemove:function(e){if(!this._isMouseDown){var touch=wrapMojoEventToTouchEvent(e);var target=touch.target;if(!target||!this.isRectangle(target)){return ;}var entity=this.getEntityByTouch(touch);if(entity){this.showInfoBox(entity,{x:e.e.pageX,y:e.e.pageY});}}},onmouseup:function(){delete this._isMouseDown;},onmouseout:function onmouseout(e){var domNode=this.canvasContainer,toElement=e.e.toElement||e.e.relatedTarget;if(!$DOM.contains(domNode,toElement,true)){this.hideInfoBox();}},oncontextmenu:function oncontextmenu(evt){this.onclick(evt,true);this.hideInfoBox();var component=this.getComponentType(evt),handler=rightClickHandlers[component.type];if(handler){handler.call(this,evt,component.target);evt.cancel();}if(this.attributeColorByLegend){var target=evt.getTarget(),attributeColorByLegend=this.attributeColorByLegend;if($DOM.contains(attributeColorByLegend.domNode,target,true)){attributeColorByLegend.handleRMCOnLegend(evt);}else{attributeColorByLegend.hideToolbar();}}evt.preventDefault();return false;},destroy:function(skipCleanup){var attributeColorByLegend=this.attributeColorByLegend;if(attributeColorByLegend){attributeColorByLegend.hideToolbar();}this._super(skipCleanup);},readGlobalAttriLegndProperty:function readGlobalAttriLegndProperty(propName){var props=this.props,identity,itemValue;switch(propName){case LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR:itemValue=props.lgdBgFillClr;break;case LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_STYLE:itemValue=props.lgdBgFillStyle;break;case LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_EFFECT:itemValue=props.lgdBgFillEff;break;case LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY:itemValue=props.lgdBgFillTrans;break;case LEGEND_FORMATTING_TYPE.LEGEND_FONT_SIZE:itemValue=props.lgdFntSz;break;case LEGEND_FORMATTING_TYPE.LEGEND_FONT_FAMILY:itemValue=props.lgdFntFml;break;case LEGEND_FORMATTING_TYPE.LEGEND_FONT_STYLE:itemValue=props.lgdFntStyle;break;case LEGEND_FORMATTING_TYPE.LEGEND_FONT_COLOR:itemValue=props.lgdFntClr;break;case LEGEND_FORMATTING_TYPE.LEGEND_BORDER_SHOW:itemValue=props.lgdBdrShw;break;case LEGEND_FORMATTING_TYPE.LEGEND_BORDER_COLOR:itemValue=props.lgdBdrClr;break;case LEGEND_FORMATTING_TYPE.LEGEND_BORDER_THICKNESS:itemValue=props.lgdBdrThk;break;case LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE:itemValue=props.lgdBdrStyle;break;case LEGEND_FORMATTING_TYPE.COLOR_SQUARE_COLOR:identity=this.colorSqureIdentity;if(identity){itemValue={color:identity.decodedColor,isDefaultColor:identity.isDefaultColor};}else{itemValue={color:"#0000FF",isDefaultColor:true};}break;case LEGEND_PROPERTY.LEGEND_MODE:itemValue=props.lm;break;case LEGEND_PROPERTY.LEGEND_POSITION:itemValue=props.LegendPosition;break;case LEGEND_PROPERTY.SCALE_LEGEND_WIDTH:itemValue=props.lwr;break;}if(itemValue===undefined||((typeof itemValue)==="number"&&isNaN(itemValue))){itemValue=this.defaultsLegendPop&&this.defaultsLegendPop[propName];}return itemValue;},initHTML5Props:function(props){var LEGEND=props.LEGEND={},processFontStyle=function(obj,fs){obj.fontWeight=(fs&ENUM_FONT_SYLTE.FS_BOLD?"bold":"normal");obj.fontStyle=(fs&ENUM_FONT_SYLTE.FS_ITALIC?"italic":"normal");if((fs&ENUM_FONT_SYLTE.FS_STRIKETHROUGH)&&(fs&ENUM_FONT_SYLTE.FS_UNDERLINE)){obj.textDecoration="line-through underline";}else{if(fs&ENUM_FONT_SYLTE.FS_STRIKETHROUGH){obj.textDecoration="line-through";}else{if(fs&ENUM_FONT_SYLTE.FS_UNDERLINE){obj.textDecoration="underline";}else{obj.textDecoration="none";}}}},translateLineStyle=function(idx){var lsMap=["solid","dashed","dotted"];return lsMap[idx]||"none";};LEGEND.fontFamily=this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_FAMILY);LEGEND.fontSize=this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_SIZE);processFontStyle(LEGEND,this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_STYLE));LEGEND.color=$GMU.decodeColor(this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_COLOR));LEGEND.backgroundColor=$GMU.decodeColor(this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR));LEGEND.opacity=this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY)/100;if(this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_SHOW)){LEGEND.borderWidth=this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_THICKNESS);LEGEND.borderStyle=translateLineStyle(this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE));LEGEND.borderColor=$GMU.decodeColor(this.readGlobalAttriLegndProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_COLOR));}},configureAttriLegendPopup:function configureAttriLegendPopup(config,itemBtn){config.hostId=this.id;config.hostElement=itemBtn;},writeGlobalAttriLegndProperty:function(propName,newValue,callback){var hasCallback=!!(callback&&callback.success),update=function(val,updateModel){var props=this.props;props.unmarshal(propName,val);if(hasCallback){callback.success.call(this,props[propName],updateModel);}};if(propName===LEGEND_FORMATTING_TYPE.COLOR_SQUARE_COLOR){this.props.unmarshal(propName,newValue);this.setProperty(propName,newValue,{callback:callback});}else{update.call(this,newValue,false);this.setProperty(propName,this.props.marshal(propName),{suppressData:true,clientUndoRedoCallback:hasCallback?update:undefined});}},onLegendDropZoneChange:function onLegendDropZoneChange(dropZoneInfo,dockedPosIdx){this.setLegendSlot(dropZoneInfo,dockedPosIdx);},onLegendDropped:function(legendDockPos){this.writeGlobalAttriLegndProperty(LEGEND_PROPERTY.LEGEND_POSITION,legendDockPos,{success:function(pos,reRender){if(reRender){this.renderLegend();this.updateCanvasAfterAttributeLegendChanged(pos,this.legendW);}}});},setLegendSlot:function(dropZoneInfo,dockedPosIdx){var prevSlotIndex=this.attributeColorByLegend.currDockedPositionIdx,canvasOuterContainer=this.canvasOuterContainer;if(dockedPosIdx!==prevSlotIndex){var preOnRight=this.isOnRight(LEGEND_DOCK_POS[prevSlotIndex].pos),curOnRight=this.isOnRight(dropZoneInfo.pos);if(preOnRight!==curOnRight){canvasOuterContainer.style.left=curOnRight?"0px":this.legendW+"px";}}},isOnRight:function(slot){return(slot===PRP_LEGEND_SLOT.RIGHT_MIDDLE||slot===PRP_LEGEND_SLOT.RIGHT_TOP||slot===PRP_LEGEND_SLOT.RIGHT_BOTTOM);},updateLegend:function(){var legend=this.attributeColorByLegend;this.attributeColorByLegendPlaceHolder.style.width=this.legendW+"px";this.attributeColorByLegendPlaceHolder.style.height=this.legendH+"px";legend.width=this.legendW;legend.height=this.legendH;legend.cutBy=this.legendCutBy;legend.minHeight=this.legendMinHeight;legend.updateContainerSize(this.getWidth(),this.getHeight());legend.feedData([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:this.verticalLegendColorByElements},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:this.verticalLegendSizeByElements}],(this.readGlobalAttriLegndProperty(LEGEND_PROPERTY.LEGEND_MODE)===ENUM_LEGEND_MODE.MINIMIZED));legend.updateAfterResize();},toggleLegend:function(show){var legend=this.attributeColorByLegend,lds;lds=legend.domNode.style;if(!show){legend.hideToolbar();lds.display="none";}else{if(lds.display!=="block"){lds.display="block";}}},updateCanvasAfterAttributeLegendChanged:function(slotPos,legendW){var widgetWidth=parseInt(this.width,10),widgetHeight=parseInt(this.height,10),padding=this.LayoutProperties.Padding,heatMapWidth=widgetWidth-2*padding-legendW,heatMapHeight=widgetHeight-2*padding,heatMapLeft=0;if(this.props.showLegend&&!this.isOnRight(slotPos)){heatMapLeft=legendW;}this.heatMapSize={x:heatMapLeft,y:0,w:heatMapWidth,h:heatMapHeight};this.applyLayout();layoutEntities.call(this);this.renderRectangles();this.highlightCanvas.resetCanvasRect(this.heatMapSize);this.refreshHighlights();},getCellForNode:function getCellForNode(node){var attr=this.levelAttributes[node.level];return{at:node.at,dei:node.dei,dpt:node.dpt,o:node.o,n:attr.name,tui:node.tui,ui:node.ui,axis:1,v:node.label,tid:attr.id};},getCellUnitIndex:function getCellUnitIndex(cell){return cell.o;},getColorByElements:function getColorByElements(){var lgdcb=this.verticalLegendColorByElements,me=this,elements;if(lgdcb===undefined){this.getVerticalLegendColorByInfo();lgdcb=this.verticalLegendColorByElements||{};}elements=(lgdcb.elements||[]).map(function(e){var token=e.token,eids=token.elements||[],tids=token.levels||[];return{text:e.label,color:e.color,opacity:getAttrColorByOpacity.call(me,tids,eids),comb:makeComb(tids,eids)};});elements.unshift({text:mstrmojo.desc(2461,"All"),color:"#ffffff",opacity:100,comb:[]});return elements;},updateColorByOpacity:function(comb,newVal){comb=[].concat(comb);newVal=[].concat(newVal);if(comb.length!==newVal.length){throw new Error("comb and opacity number not match");}var props=this.getPropsInfo(),opacities=props.attrColorByOpacity||{};comb.forEach(function(cb,idx){var tid=cb.map(function(e){return e.tid;}).join("|"),eid=cb.map(function(e){return e.eid;}).join("|"),attr=opacities[tid];if(attr===undefined){attr={};opacities={};}attr[eid]=newVal[idx];opacities[tid]=attr;});this.observableModel.colorByOpacity.setValue(opacities);},execFormatHandler:function(){var selectTitleAndContainer=function(){$UTIL.selectPropertyPanel(this,0);}.bind(this);var selection=this.previousSelected;if(selection===undefined||selection.length===0){selectTitleAndContainer();return ;}var isLeaves=isSelectionAllLeaves.call(this),isHeaders=isSelectionAllHeaders.call(this),context=this._toolbarContext,pos,type,entity;if(!isLeaves&&!isHeaders){return ;}if(context===undefined){selectTitleAndContainer();return ;}pos=context.pos;type=context.type;entity=context.entity||this.getEntityByTouch(wrapMojoEventToTouchEvent(pos));switch(type){case COMPONENT_TYPES.RECTANGLE_LABEL:case COMPONENT_TYPES.RECTANGLE:showRectangleEditor.call(this,entity,pos);break;default:selectTitleAndContainer();break;}},onNDECreated:function(deItems){deItems.forEach(function(de){var deId=de.id,deUnitId=de.unitId;this.dfs(this.root,function(entity){var entityId=entity.id||"";if(entityId.indexOf(deId)!==-1&&entityId.indexOf(deUnitId)!==-1){this.addToSelection(entity);}}.bind(this));},this);this.doSelection();this.refreshHighlights();},triggerFontScaleChangeEvent:function(){notifyFontScaleLimitReached.call(this,this.props.fonts);},isAttributeColorByType:function(){return this.props.colorByType==="attribute";},isMetricColorByType:function(){return this.props.colorByType==="metric";},onselectionBatchRemove:function(evt){this.refreshHighlights(evt.entities);}});}());