(function(){mstrmojo.requiresCls("mstrmojo.DocXtabGraph","mstrmojo.TouchScroller","mstrmojo.graph._MobileGraphAreaHelper","mstrmojo._TouchGestures");var $DOM=mstrmojo.dom;function updateTooltip(graph,x,y){var dpos=mstrmojo.dom.position(graph.domNode,false),left=0,top=0,node=graph.node;if(dpos){left=dpos.x;top=dpos.y;}graph.model.getDataService().handleUserSingleTap(node.data.sid,node.k,x-left,y-top,false,{success:function(res){graph.displayTooltips(res.Areas,left,top);}});}function getGbKey(model){var gbkey="",gba=[],currKey,layouts,currlayout,l,index,gb;if(!model){return gbkey;}currKey=model.currlaykey;gbkey=currKey+"_";layouts=model.data&&model.data.layouts;for(index=0;index<(layouts.length||0);index++){l=layouts[index];if(l.k===currKey){currlayout=l;break;}}if(currlayout){if(currlayout.gbys){gba=currlayout.gbys.groupbys;for(index=0;index<(gba.length||0);index++){gb=gba[index];gbkey=gbkey+gb.k+":"+gb.lvl;if(gb.unit){gbkey=gbkey+":"+gb.unit.idx;}gbkey=gbkey+"_";}}}return gbkey;}function applySelectionChange(touch){this.displayTooltips([],0,0);var me=this,dataService=this.model.getDataService(),pos=mstrmojo.dom.position(this.domNode,true),x=touch.pageX-pos.x,y=touch.pageY-pos.y,anchor={getBoundingClientRect:function(){var left=touch.pageX,top=touch.pageY;return{left:left,top:top,right:left+1,bottom:top+1};}},callback={success:function(res){var areas=res.Areas,defn=me.defn,k=me.k,tks=res.tks,showLoadingIcon=false;if(areas&&areas.length>0){if(areas[0].Selectable===1){me.highlightArea(me.selectionNode,areas);}else{if(areas[0].Selectable===-1){me.highlightedAreas=[];me.clearHighlightArea(me.selectionNode);}}if(tks){me.showInfoWin(tks,anchor);}showLoadingIcon=areas[0].Selectable!==undefined;}else{showLoadingIcon=res.Selectable!==undefined;me.highlightedAreas=[];me.clearHighlightArea(me.selectionNode);}window.setTimeout(function(){mstrMobileApp.forceRepaint();me.model.slice({type:parseInt(defn.t,10)||mstrmojo.EnumRWUnitType.GRAPH,src:k,ck:defn.ck,gk:k,sid:me.node.data.sid,x:x,y:y,tks:tks,anchor:anchor,tty:res.tty,showLoadingIcon:showLoadingIcon});},0);}};dataService.handleUserSingleTap(me.node.data.sid,me.k,x,y,true,callback);}function setImageNodeSrc(src){var imgNode=this.imgNode;if(imgNode.src!==src){imgNode.src=src;$DOM.translate(imgNode,0,0,0);}}mstrmojo.MobileDocXtabGraph=mstrmojo.declare(mstrmojo.DocXtabGraph,[mstrmojo._TouchGestures,mstrmojo.graph._MobileGraphAreaHelper],{scriptClass:"mstrmojo.MobileDocXtabGraph",areaMarkup:'<area shape="{@shape}" coords="{@coords}" ttl="{@tooltip}" aid="{@aid}" {@extra}/>',retrieveGraphSrc:function retrieveGraphSrc(h,w){var id=this.id,model=this.model;if(parseInt(h,10)>0&&parseInt(w,10)>0){model.getDataService().getRWGraphImage({w:w,h:h,k:this.k,sid:this.node.data.sid,gbk:getGbKey(model)},model.newCallback({success:function(res){setImageNodeSrc.call(mstrmojo.all[id],res);}}));}},invalidate:function invalidate(){setImageNodeSrc.call(this,"");},showTooltip:function showTooltip(){},touchSelectBegin:function touchSelectBegin(touch){this.restoreDefaultTouches(false);updateTooltip(this,touch.pageX,touch.pageY);},touchSelectMove:function touchSelectMove(touch){this.restoreDefaultTouches(false);updateTooltip(this,touch.pageX,touch.pageY);},touchTap:function touchTap(touch){this.restoreDefaultTouches(false);applySelectionChange.call(this,touch);}});}());