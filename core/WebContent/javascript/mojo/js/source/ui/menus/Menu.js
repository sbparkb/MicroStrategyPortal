(function(){mstrmojo.requiresCls("mstrmojo.ListBase","mstrmojo._IsList","mstrmojo.ui.menus._HasMenuPopup","mstrmojo._CanAutoClose","mstrmojo._IsPopup","mstrmojo.ui.menus._IsMenuPopup","mstrmojo.ui.PopupConfig","mstrmojo.ui._HasScroller","mstrmojo.ui._HasUITheme","mstrmojo.dom","mstrmojo.css","mstrmojo.ui._HasListTooltip");var $DOM=mstrmojo.dom,$CSS=mstrmojo.css,$DIRCFG=mstrmojo.ui.PopupConfig.directionCfg;var itemMarkup={};var debug=false;function openSubMenu(item,isActionAreaClicked){if(item.pop){if(isActionAreaClicked&&item.ax){window.clearTimeout(this._popupAxTimeout);item.actionFn();this.closeAllMenus();}else{var popupConfig=item.fn.call(mstrmojo.all[item.scope],item.ctxt);var corners=popupConfig.ENUM_CORNERS;popupConfig.setAlignment(corners.TOP_RIGHT,corners.TOP_LEFT);popupConfig.hostId=this.id;popupConfig.hostElement=this._getItemNode(item._renderIdx);this.openPopup(popupConfig.newInstance());}}else{if(item.dsbld!==true){if(item.fn(item,this)!==false){this.closeAllMenus();}}}}function extractNumber(value){var n=parseInt(value);return n===null||isNaN(n)?0:n;}mstrmojo.ui.menus.Menu=mstrmojo.declare(mstrmojo.ListBase,[mstrmojo._IsList,mstrmojo.ui.menus._HasMenuPopup,mstrmojo._IsPopup,mstrmojo.ui.menus._IsMenuPopup,mstrmojo._CanAutoClose,mstrmojo.ui._HasListTooltip,mstrmojo.ui._HasScroller,mstrmojo.ui._HasUITheme],{scriptClass:"mstrmojo.ui.menus.Menu",selectionPolicy:"reselect",locksHover:true,closeOnClick:true,themeClassName:"mojo-theme-dark",icnCss:"mstrmojo-ui-Menu-item-container",popupConfig:null,tooltipCss:{leftCssClass:"menuTooltip",rightCssClass:"menuTooltip"},setupScrollNodes:function(){if(this.popupConfig&&this.popupConfig.supportsScroll){this.scrollNode=this.itemsContainerNode;this.scrollbarHostNode=this.domNode;}},updateScrollbars:function(){this._super();if(this.popupConfig&&this.popupConfig.supportsScroll&&this.hasCustomScrollbar){var scrollNode=this.scrollNode;if(!scrollNode){return ;}var style=(getComputedStyle&&getComputedStyle(scrollNode,null))||scrollNode.currentStyle,scrollbarWidth=scrollNode.offsetWidth-extractNumber(style.borderLeftWidth)-extractNumber(style.borderRightWidth)-scrollNode.clientWidth;scrollNode.style.marginRight=-scrollbarWidth+"px";scrollNode.style.paddingRight=0;}},onscroll:function(){this.closePopup();this._super();},init:function init(props){this._super(props);var menuConfig=this.popupConfig;this.items=menuConfig.getMenuItems();var css=["mstrmojo-ui-Menu","unselectable"],cfgCss=menuConfig.menuCssClass;if(cfgCss){css.push(cfgCss);}$CSS.addWidgetCssClass(this,css);if(menuConfig&&menuConfig.supportsScroll&&menuConfig.maxHeight>0){this.icnCssText=(this.icnCssText||"")+";max-height:"+menuConfig.maxHeight+"px";}this.useRichTooltip=!!menuConfig.useTooltip;this.tstid=menuConfig.tstid;},markupMethods:{onvisibleChange:function onvisibleChange(){var isVisible=this.visible;if(!debug||isVisible){$CSS.toggleClass(this.domNode,"visible",isVisible);}}},getItemMarkup:function getItemMarkup(item,idx){if(item.getItemMarkup){return item.getItemMarkup.apply(this,[item,idx]);}var isPopup=!!item.pop,type=isPopup?"submenu":"item",markup=itemMarkup[type];if(!markup){markup=this._super(item,idx).replace("{@en@n}",'<div class="micn"></div>{@en@n}');if(isPopup){markup=markup.replace("{@en@n}",'{@en@n}<div class="arw"></div>');}itemMarkup[type]=markup;}if(item.tstid){markup=markup.replace("{@tag}","{@tag} "+mstrmojo.tstid(item)+" ");}return markup;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx);props.tag="a";props.addCls("mstrmojo-ui-Menu-item");props.addCls(item.cls);return props;},adjustCornersForPopupOverflow:function adjustCornersForPopupOverflow(){var adjusted=this._super(),domNode=this.domNode,curPos,style,curY,cfg,hostPos;if(adjusted){curPos=$DOM.position(domNode);curY=curPos.y;style=domNode.style;cfg=this.popupConfig;hostPos=cfg.position||$DOM.position(cfg.hostElement);if(curY<0||(curY+curPos.h>$DOM.position(document.body).h)){style.top=(-hostPos.y+5)+"px";style.bottom="auto";}}return adjusted;},onmouseover:function onmouseover(evt){var target=evt.getTarget(),item=this.getItemFromTarget(target),me=this,lastOpened=me._lastOpened,lastOpenIndex=lastOpened&&this.getItemFromTarget(lastOpened.popupConfig.hostElement)._renderIdx,itemNode=this.getItemNodeFromTarget(target),within=(lastOpenIndex!==undefined&&$DOM.contains(this._getItemNode(lastOpenIndex),target,true,this.domNode));if(item){this._lastHoverIx=item._renderIdx;window.clearTimeout(this._popupTimeOut);window.clearTimeout(this._popupAxTimeout);if(this._lastHoverIx!==lastOpenIndex&&!within){this._popupTimeOut=window.setTimeout(function(){if(me._lastOpened&&me._lastOpened.visible){me.closePopup();}if(me.visible&&item.pop){if(item.ax){me._popupAxTimeout=window.setTimeout(function(){$CSS.removeClass(itemNode,"hlt-ax");openSubMenu.call(me,item);},0);}else{openSubMenu.call(me,item);}}},400);if(item.pop&&item.ax){$CSS.addClass(itemNode,"hlt-ax");}}}},onclick:function onclick(evt){this._evtTarget=evt.getTarget();this._super(evt);evt.cancel();},postselectionChange:function postselectionChange(evt){var added=evt.added;if(added){var item=this.items[added[0]];openSubMenu.call(this,item,!(item.ax&&this._evtTarget.className==="arw"));delete this._evtTarget;}},oncontextmenu:function oncontextmenu(evt){$DOM.preventDefault(window,evt.e);return false;},postBuildRendering:function postBuildRendering(props){this._super(props);if(this.popupConfig.supportsScroll){var me=this;window.setTimeout(function(){me.updateScrollbars();},10);}},showTooltip:function showTooltip(e,win){var target=$DOM.eventTarget(win,e),node=this.getItemNodeFromTarget(target),item=this.getItemFromTarget(target);if(node&&((item&&item.ttp)||(node.scrollWidth>node.clientWidth))){this._super(e,win);}},onClose:function onClose(config){if(this._super){this._super(config);}this.closePopup();}});}());