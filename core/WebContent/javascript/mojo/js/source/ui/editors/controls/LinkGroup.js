(function(){mstrmojo.requiresCls("mstrmojo.ui.editors.controls.ControlGroup","mstrmojo.Label","mstrmojo.Label","mstrmojo.ui.Pulldown","mstrmojo.ui.editors.controls.TwoColumnContainer","mstrmojo.TextBox","mstrmojo.Button","mstrmojo.hash","mstrmojo.ui.Checkbox");var linkTypes={DISABLED:-1,URL:0,LINK_MSTR:1},getXMLLink=function(linkType,link,objectLink,newWin,tooltip){var tag=function(tag,atts,inner){if(inner){return"<"+tag+atts+">"+inner+"</"+tag+">";}return"<"+tag+atts+"/>";},att=function(value,name){return(value!==undefined?" "+name+'="'+value+'"':"");},openInNewWindow=newWin?1:undefined,defaultAnswerMode=2,hyperlinkURL=(linkType===linkTypes.URL?(link||"").replace(/\&/g,"&amp;"):undefined),selectorOptions=0,targetID=(linkType===linkTypes.LINK_MSTR?objectLink.did:undefined),targetType=(linkType===linkTypes.LINK_MSTR?objectLink.t:undefined),targetSubType=(linkType===linkTypes.LINK_MSTR?objectLink.st:undefined),displayText=tooltip||"",isDefault=1;return tag("hls",att(openInNewWindow,"onw"),tag("hl",att(isDefault,"idf")+att(defaultAnswerMode,"aopam")+att(displayText,"dtxt")+att(hyperlinkURL,"url")+att(linkType,"lt")+att(targetType,"ttp")+att(targetID,"tid")+att(targetSubType,"tstp")+att(selectorOptions,"so")));},linkTySelIndex=0,linkObjInfo={},getSelectedTypeIndex=function getSelectedTypeIndex(host){if(host.linkType!==undefined){return host.linkType+1;}var ty=host.node.data.tid&&1,url=host.url||"";return ty!==undefined?++ty:!!url?1:0;},getTooltip=function getTooltip(w){return(w.defn.dl&&w.defn.dl.items&&w.defn.dl.items[0]&&w.defn.dl.items[0].n)||w.tooltip||"";},typeChanging=false,restoring=false,typeChange=function typeChange(_type){typeChanging=true;var all=[this.rwSelector,this.linkText,this.tooltip,this.openNewWin],url=[this.linkText,this.tooltip],link=[this.rwSelector,this.tooltip,this.openNewWin],hide=function hide(w){if(w){w.set("visible",false);}},show=function show(w){if(w){w.set("visible",true);}},toShow=_type===linkTypes.URL?url:_type===linkTypes.LINK_MSTR?link:[];all.forEach(hide);toShow.forEach(show);if(this.hasRendered){this.tooltip.text.set("value","");}typeChanging=false;},isValidURL=function isValidURL(url){return !!url&&(url.toLowerCase().indexOf("javascript:")===-1);},fieldChange=function fieldChange(field){if(this.hasRendered&&!typeChanging){var that=this,docModel=that.docModel,host=mstrmojo.all[this.hostId],type=this.linkType.getSelectedItem().v,newWin=type===linkTypes.URL?true:this.openNewWin&&this.openNewWin.check.checked,tooltip=this.tooltip.text.value,link=type!==linkTypes.URL?undefined:that.linkText.value,xml,undoState,redoState,clearTooltip,fnSelectVIUnit=function(){if(host&&host.model.getSelectedViUnit().k===host.parent.k&&host.parent.id){host.model.selectVIUnit(host.parent.id,true);}},restoreState=function(state){restoring=true;host.defn.dl=state.dl;host.target=state.target;host.url=state.url;host.tooltip=state.tooltip;host.linkType=state.linkTypeIndex-1;host.node.data.tnm=state.linkObjInfo.n;host.node.data.tid=state.linkObjInfo.did;host.node.data.ttp=state.linkObjInfo.t;host.node.data.tstp=state.linkObjInfo.st;that.linkType.set("selectedIndex",state.linkTypeIndex);that.rwSelector.text.set("value",state.linkObjInfo.n||"");that.linkText.set("value",state.url||"");that.tooltip.text.set("value",state.tooltip);if(that.openNewWin){that.openNewWin.check.set("checked",state.target==="_blank");}restoring=false;fnSelectVIUnit();},update=function update(){if(!restoring){if(type===linkTypes.DISABLED){xml="";clearTooltip=true;}else{if(link||linkObjInfo||newWin!==undefined){xml=getXMLLink(type,link,linkObjInfo,newWin,tooltip);}}undoState={dl:mstrmojo.hash.clone(host.defn.dl),target:host.target,url:host.url,tooltip:host.tooltip,linkTypeIndex:getSelectedTypeIndex(host),linkObjInfo:{n:host.node.data.tnm,did:host.node.data.tid,t:host.node.data.ttp,st:host.node.data.tstp}};if(tooltip!==undefined||clearTooltip!==undefined){host.tooltip=clearTooltip?"":tooltip;if(host.defn.dl){host.parent.defn.dl.items[0].n=clearTooltip?"":tooltip;}}docModel.editLink(host.parent,that.hostType,xml,{success:function(res){host.linkType=type;docModel.partialUpdate(res.data,docModel.getTargetDefn(host.k),res.defn);if(type===linkTypes.LINK_MSTR){that.rwSelector.text.set("value",linkObjInfo.n);that.linkText.set("value","");}if(type===linkTypes.URL){that.linkText.set("value",link);that.rwSelector.text.set("value","");}if(type===linkTypes.DISABLED){delete host.defn.dl;delete host.node.data.dl;delete host.target;delete host.url;that.linkText.set("value","");that.rwSelector.text.set("value","");}else{host.target=newWin?"_blank":"";that.tooltip.text.set("value",tooltip);if(that.openNewWin&&that.openNewWin.visible){that.openNewWin.check.set("checked",newWin);}}redoState={dl:mstrmojo.hash.clone(host.defn.dl),target:host.target,url:host.url,tooltip:host.tooltip,linkTypeIndex:that.linkType.selectedIndex,linkObjInfo:{n:host.node.data.tnm,did:host.node.data.tid,t:host.node.data.ttp,st:host.node.data.tstp}};fnSelectVIUnit();},undo:function(){restoreState(undoState);},redo:function(){restoreState(redoState);}});}},canCreateXML=function(){return(type===linkTypes.URL&&(!mstrmojo.string.isEmpty(link)&&link!=="http://"))||(type===linkTypes.LINK_MSTR&&!mstrmojo.hash.isEmpty(linkObjInfo));};if((field!=="type"&&canCreateXML())||type===linkTypes.DISABLED){update();}}};mstrmojo.ui.editors.controls.LinkGroup=mstrmojo.declare(mstrmojo.ui.editors.controls.ControlGroup,null,{scriptClass:"mstrmojo.ui.editors.controls.LinkGroup",init:function init(props){this._super(props);mstrmojo.css.addWidgetCssClass(this,"mstrmojo-ui-EditContainer");var controls=[],that=this,host=mstrmojo.all[this.hostId],url=host.url||"",getObjectName=function getObjectName(){return host.node.data.tnm;};linkTySelIndex=getSelectedTypeIndex(host);if(linkTySelIndex===2){linkObjInfo={n:host.node.data.tnm,did:host.node.data.tid,t:host.node.data.ttp,st:host.node.data.tstp};}controls.push(new mstrmojo.Label({cssClass:"edt-title",text:mstrmojo.desc(12064,"Link")}),new mstrmojo.ui.Pulldown({alias:"linkType",items:[{n:mstrmojo.desc(12065,"Disabled"),v:linkTypes.DISABLED},{n:mstrmojo.desc(12066,"Navigate to URL"),v:linkTypes.URL}].concat(mstrApp.isSingleTier?[]:[{n:mstrmojo.desc(13638,"Run this report or dashboard"),v:linkTypes.LINK_MSTR}]),selectedIndex:linkTySelIndex,onitemSelected:function(item){typeChange.call(that,item.v);fieldChange.call(that,"type",item.v);linkTySelIndex=this.items.indexOf(item);}}),new mstrmojo.ui.editors.controls.TwoColumnContainer({alias:"rwSelector",col1Width:"100%",col2Width:"30px",children:[new mstrmojo.TextBox({slot:"col1Node",alias:"text",readOnly:true,tooltip:getObjectName(),value:getObjectName()}),mstrmojo.Button.newWebButton("...",null,false,{slot:"col2Node",alias:"button",cssText:"height: 20px;min-width: 30px",onclick:function onclick(){mstrmojo.vi.ui.DatasetUnitMenuUtils.showObjectPicker(function OKFn(item){that.rwSelector.text.set("value",item.n);linkObjInfo=item;fieldChange.call(that,"obj",item);},[55,3])();}})]}),new mstrmojo.TextBox({alias:"linkText",valueChangeDelay:3000,hint:"http://",value:url||"http://",onkeydown:function(eventWrapper){if(eventWrapper.e.keyCode===13){this.blur();}},onvalueChange:function onvalueChange(){if(this.hasRendered){if(isValidURL(this.value)){this.cleanUp();fieldChange.call(that,"link",this.value);}else{this.setInvalidState(mstrmojo.desc(12068,"Invalid URL"));}}}}),new mstrmojo.ui.editors.controls.TwoColumnContainer({alias:"tooltip",col1Width:"30%",col2Width:"70%",children:[new mstrmojo.Label({alias:"label",slot:"col1Node",text:mstrmojo.desc(12069,"Tooltip:")}),new mstrmojo.TextBox({alias:"text",slot:"col2Node",valueChangeDelay:3000,value:getTooltip(host),hint:mstrmojo.desc(12070,"Hyperlink#").replace("#",""),onkeydown:function(eventWrapper){if(eventWrapper.e.keyCode===13){this.blur();}},onvalueChange:function onvalueChange(){fieldChange.call(that,"tooltip",this.value);}})]}));if(!mstrApp.isSingleTier){controls.push(new mstrmojo.ui.editors.controls.TwoColumnContainer({alias:"openNewWin",col1Width:"20px",col2Width:"100%",children:[new mstrmojo.ui.Checkbox({alias:"check",slot:"col1Node",checked:host.target==="_blank",oncheckedChange:function(){fieldChange.call(that,"newWin",this.checked);}}),new mstrmojo.Label({alias:"label",slot:"col2Node",text:mstrmojo.desc(3593,"Open in new window")})]}));}this.addChildren(controls);typeChange.call(this,host.linkType||this.linkType.items[this.linkType.selectedIndex].v);}});}());