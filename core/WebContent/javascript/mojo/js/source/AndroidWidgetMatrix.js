(function(){mstrmojo.requiresCls("mstrmojo.WidgetMatrix","mstrmojo._TouchGestures","mstrmojo._HasTouchScroller","mstrmojo.VisChartUtils");var DEBUG_TOUCH_WHILE_LOADING=false;function getTime(){var a=new Date();var y=a.getYear()+"-";var m=a.getMonth()+"-";var d=a.getDay()+"-";var h=a.getHours()+"-";var x=a.getMinutes()+"-";var s=a.getSeconds()+"-";var ms=a.getMilliseconds();return(y+m+d+h+x+s+ms);}mstrmojo.AndroidWidgetMatrix=mstrmojo.declare(mstrmojo.WidgetMatrix,[mstrmojo._TouchGestures,mstrmojo._HasTouchScroller],{scriptClass:"mstrmojo.AndroidWidgetMatrix",scrollerConfig:null,relScaleFactor:1,scaleFactor:1,multiTap:true,multiTouch:true,utils:mstrmojo.VisChartUtils,markupString:'<div class="{@cssClass}" style="position:absolute; left:{@left}px; top:{@top}px; width:{@width}px; height:{@height}px;"><div style="position:absolute; left:0px; bottom:0px; width:100%; height:100%; overflow:hidden"><div class="canvas" style="position:absolute; width:{@canvasW}px; height:{@canvasH}px"></div></div><div id="{@id}-tooltip" style="z-index:2" class="mstrmojo-ImageLayout-tooltip" clk="clk"><table style="margin:5px 7px"></table></div><span style="visibility:hidden"></span></div>',markupSlots:{domContainer:function(){return this.domNode.firstChild;},domCanvas:function(){return this.domNode.firstChild.firstChild;},tooltip:function(){return this.domNode.children[1];},domSpan:function(){return this.domNode.lastChild;}},updateScrollerAfterZooming:function(){var me=this,scl=me._scroller,offset=me.offset;offset.x.e=scl.offset.x.end;offset.y.e=scl.offset.y.end;me.updateOrigin(scl.origin);},initScrollerConfig:function(){var me=this,sclCfg=me.scrollerConfig;if(sclCfg){sclCfg.scrollEl=me.domCanvas;sclCfg.offset.x.end=Math.max(me.domCanvas.offsetWidth-me.width,0);sclCfg.offset.y.end=Math.max(me.domCanvas.offsetHeight-me.height,0);}},updateOrigin:function(_origin){var me=this,origin=me.origin;origin.x=_origin.x;origin.y=_origin.y;me.calculateBBox();},updateOffset:function(_offset){var me=this,offset=me.offset;offset.x.s=_offset.x.start;offset.x.e=_offset.x.end;offset.y.s=_offset.y.start;offset.y.e=_offset.y.end;},init:function(props){if(this._super){this._super(props);}this.scrollerConfig={bounces:false,showScrollbars:false,useTranslate3d:true,vScroll:true,hScroll:true,offset:{y:{start:0,end:0},x:{start:0,end:0}},origin:{x:0,y:0}};},postBuildRendering:function(){var me=this,apiOwner=me.APIOwner;me.initScrollerConfig();if(this._super){this._super();}if(!me.scrollDoneListener&&me._scroller){me.scrollDoneListener=me._scroller.attachEventListener("scrollDone",this.id,function(evt){me.beingScrolled=false;me.updateOrigin({x:evt.x,y:evt.y});me.manager.drawCharts();me.getMapsAndDraw();});}if(!me.scrollMovedListener&&me._scroller){me.scrollMovedListener=me._scroller.attachEventListener("scrollMoved",this.id,function(evt){if(me.beingScrolled===true){me.updateOrigin({x:evt.x,y:evt.y});me.manager.drawCharts();}});}if(this._tn&&apiOwner){var backup=this._tsCallback;this._tsCallback=function(e){apiOwner.savedInfowindowOn=apiOwner.realtimeInfowindowOn;apiOwner.currSelectedObjBackup=apiOwner.currSelectedObj;backup.call(this,e);};mstrmojo.dom.detachEvent(this._tn,mstrmojo.dom.TOUCHSTART,backup);mstrmojo.dom.attachEvent(this._tn,mstrmojo.dom.TOUCHSTART,this._tsCallback);}me.setFontByDPI();if(apiOwner){apiOwner.createTooltipTable();}},getMapsAndDraw:function(){var me=this,activeFlags=me.activeFlags,miniCharts=me.APIOwner&&me.APIOwner.miniCharts,miniChart,i,j,rowCharts,chart;for(i in activeFlags){rowCharts=activeFlags[i];for(j in rowCharts){chart=rowCharts[j];if(chart===true){miniChart=miniCharts&&miniCharts[i]&&miniCharts[i][j];if(miniChart&&miniChart.hasDrawnMap===false){miniChart.getMapAndDraw();}}}}},setFontByDPI:function(){var me=this,apiOwner=me.APIOwner;if(me.setFontByDPIFlag){return ;}me.setFontByDPIFlag=true;var xtabModel=apiOwner.xtabModel,docModel=(xtabModel&&xtabModel.docModel),fitToPage=false,microApp=false;if(docModel){fitToPage=docModel.zt&&(docModel.zt==2);var layouts=docModel.defn&&docModel.defn.layouts,layout,i;for(i in layouts){if(layouts.hasOwnProperty(i)&&layouts[i]&&layouts[i].loaded){layout=layouts[i];break;}}if(layout&&layout.hasOwnProperty("fch")){microApp=layout.fch;}}if(fitToPage&&microApp){var devicedpi=149;if(typeof mstrMobileApp!=="undefined"){devicedpi=mstrMobileApp.getDeviceDPIX();}var baseDpi=149;var ratio=1;if(devicedpi>0){ratio=devicedpi/baseDpi;}if(ratio>1){apiOwner.hoverBubbleRadiusLarger*=ratio;apiOwner.bubbleStrokeWidth*=ratio;apiOwner.baseMaxBubbleSizeAuto*=ratio;apiOwner.baseMaxBubbleSizeManual*=ratio;apiOwner.polygonStrokeWidth*=ratio;apiOwner.highlightPolygonStrokeWidth*=ratio;apiOwner.borderSpace*=ratio;apiOwner.tooltipFontSize*=ratio;apiOwner.tooltipBorderWidth*=ratio;apiOwner.tooltipBorderRadius*=ratio;apiOwner.loadingIndicatorFontSize*=ratio;apiOwner.loadingIndicatorDivHeight*=ratio;apiOwner.loadingIndicatorDivWidth*=ratio;apiOwner.errMsgFontSize*=ratio;apiOwner.bias*=ratio;apiOwner.tooltipRightShadowWidth*=ratio;apiOwner.subTitleHeight*=ratio;apiOwner.subTitleFontSize*=ratio;apiOwner.subTitlePadding*=ratio;var loadingIndicatorTextDiv=apiOwner.loadingIndicatorTextDiv;loadingIndicatorTextDiv.style.height=apiOwner.loadingIndicatorDivHeight+"px";loadingIndicatorTextDiv.style.lineHeight=apiOwner.loadingIndicatorDivHeight+"px";loadingIndicatorTextDiv.style.width=apiOwner.loadingIndicatorDivWidth+"px";loadingIndicatorTextDiv.style.fontSize=apiOwner.loadingIndicatorFontSize+"px";var tooltip=me.tooltip,table=tooltip.childNodes[0];tooltip.style.fontSize=apiOwner.tooltipFontSize+"px";tooltip.style.borderWidth=apiOwner.tooltipBorderWidth+"px";tooltip.style.borderRadius=apiOwner.tooltipBorderRadius+"px";tooltip.style.boxShadow=3*ratio+"px "+3*ratio+"px "+4*ratio+"px RGBA(0,0,0,0.45)";table.style.margin=5*ratio+"px "+7*ratio+"px";}}},getWidgetXY:function getWidgetXY(touch){var widgetXY=null;if(touch){widgetXY=this.utils.getTouchXYOnWidget(touch.pageX,touch.pageY,this.APIOwner);touch.widgetX=widgetXY.touchX;touch.widgetY=widgetXY.touchY;}return widgetXY;},setSubTitleStyle:function(){if(this.APIOwner.hasMultiAttr){this.setSubTitleHeight();this.setSubTitleFontSize();this.setSubTitlePadding();}},setSubTitlePadding:function(){this.APIOwner.subTitlePadding*=this.relScaleFactor;},getSubTitlePadding:function(){return this.APIOwner.subTitlePadding;},setSubTitleFontSize:function(){this.APIOwner.subTitleFontSize*=this.relScaleFactor;},getSubTitleFontSize:function(){return this.APIOwner.subTitleFontSize;},setSubTitleHeight:function(){this.APIOwner.subTitleHeight*=this.relScaleFactor;},getSubTitleHeight:function(){return this.APIOwner.subTitleHeight;},getMiniChartFromTouch:function(touch){var me=this;var widgetXY=me.getWidgetXY(touch);var pwx=widgetXY.touchX,pwy=widgetXY.touchY;var ori=me._scroller.origin;var cx=pwx+ori.x,cy=pwy+ori.y;var curChartH=me.chartH*me.manager.heightScale,curChartW=me.chartW*me.manager.widthScale;var rIdx=Math.floor(cy/curChartH),cIdx=Math.floor(cx/curChartW);var swx=cx%curChartW,swy=cy%curChartH-me.APIOwner.subTitleHeight;var miniChart=null;if(swy>0){miniChart=me.APIOwner.getMiniChart(rIdx,cIdx);touch.widgetX=swx;touch.widgetY=swy;}return miniChart;},touchSelectBegin:function touchSelectBegin(touch){var me=this,apiOwner=me.APIOwner;if(touch.evt.ctrlKey){me.touchMultiBegin(touch);return ;}var miniChart=me.getMiniChartFromTouch(touch);apiOwner.touchedMiniChart=miniChart;if(apiOwner.savedInfowindowOn){this.touchSelectWithIfw=true;me.handleTouchSelectWithIfw(touch.widgetX,touch.widgetY);}else{me.handleTouchSelectNoIfw(touch.widgetX,touch.widgetY);}},touchSelectMove:function touchSelectMove(touch){var me=this,apiOwner=me.APIOwner;if(touch.evt.ctrlKey){me.touchMultiMove(touch);return ;}var miniChart=me.getMiniChartFromTouch(touch);apiOwner.touchedMiniChart=miniChart;if(this.touchSelectWithIfw){me.handleTouchSelectWithIfw(touch.widgetX,touch.widgetY);}else{me.handleTouchSelectNoIfw(touch.widgetX,touch.widgetY);}},touchSelectEnd:function touchSelectEnd(touch){var me=this,apiOwner=me.APIOwner;if(touch.evt.ctrlKey){me.touchMultiEnd(touch);return ;}var miniChart=me.getMiniChartFromTouch(touch);apiOwner.touchedMiniChart=null;me.touchSelectWithIfw=false;},handleTouchSelectWithIfw:function handleTouchSelectWithIfw(touchX,touchY){var me=this,apiOwner=me.APIOwner,nearestObj=apiOwner.touchedMiniChart&&apiOwner.touchedMiniChart.getAreaOrNearestBubble(false,touchX,touchY);if(!nearestObj){apiOwner.closeInfowindow();}else{if(nearestObj.hdrIndex<0){apiOwner.closeInfowindow();}else{if(!apiOwner.currSelectedObj||nearestObj.touchVal!==apiOwner.currSelectedObj.touchVal||apiOwner.touchedMiniChart!==apiOwner.currSelectedObjMiniChart){apiOwner.showInfowindow(nearestObj);apiOwner.currSelectedObj=nearestObj;apiOwner.currSelectedObjMiniChart=apiOwner.touchedMiniChart;apiOwner.highlightMiniCharts();}else{}}}},handleTouchSelectNoIfw:function handleTouchSelectNoIfw(touchX,touchY){var me=this,apiOwner=me.APIOwner,nearestObj=apiOwner.touchedMiniChart&&apiOwner.touchedMiniChart.getAreaOrNearestBubble(false,touchX,touchY);if(!nearestObj){apiOwner.hideTooltip();}else{if(!apiOwner.currHoverObj||nearestObj.touchVal!==apiOwner.currHoverObj.touchVal){apiOwner.currHoverObj=nearestObj;apiOwner.currHoverObjMiniChart=apiOwner.touchedMiniChart;apiOwner.highlightMiniCharts();}else{apiOwner.touchedMiniChart.renderTooltip(nearestObj.touchVal,nearestObj.point.x,nearestObj.point.y,nearestObj.hdrIndex);}}},touchMultiBegin:function(touch){var me=this;me.beingScrolled=false;me.APIOwner.hideTooltip();var touch1,touch2;if(touch.evt.touches&&touch.evt.touches.length===2){touch1=touch.evt.touches[0];touch2=touch.evt.touches[1];}else{touch1=touch;touch2={pageX:200,pageY:200};}var touch1XYOnWidget=me.getWidgetXY(touch1),touch2XYOnWidget=me.getWidgetXY(touch2);var xDiff=touch1XYOnWidget.touchX-touch2XYOnWidget.touchX,yDiff=touch1XYOnWidget.touchY-touch2XYOnWidget.touchY;me.initDiffDiff=xDiff*xDiff+yDiff*yDiff;me.initCenterX=(touch1XYOnWidget.touchX+touch2XYOnWidget.touchX)/2;me.initCenterY=(touch1XYOnWidget.touchY+touch2XYOnWidget.touchY)/2;me.initScrollX=me._scroller.origin.x;me.initScrollY=me._scroller.origin.y;me.relScaleFactor=1;},touchMultiMove:function(touch){var me=this,touch1,touch2;if(touch.evt.touches&&touch.evt.touches.length===2){touch1=touch.evt.touches[0];touch2=touch.evt.touches[1];}else{touch1=touch;touch2={pageX:200,pageY:200};}var touch1XYOnWidget=me.getWidgetXY(touch1),touch2XYOnWidget=me.getWidgetXY(touch2);var xDiff=touch1XYOnWidget.touchX-touch2XYOnWidget.touchX,yDiff=touch1XYOnWidget.touchY-touch2XYOnWidget.touchY,curDiffDiff=xDiff*xDiff+yDiff*yDiff,curCenterX=(touch1XYOnWidget.touchX+touch2XYOnWidget.touchX)/2,curCenterY=(touch1XYOnWidget.touchY+touch2XYOnWidget.touchY)/2;var scale=Math.sqrt(curDiffDiff/this.initDiffDiff);var offset={x:scale*(me.initCenterX+me.initScrollX)-curCenterX,y:scale*(me.initCenterY+me.initScrollY)-curCenterY};var transform={scale:scale,offset:offset};me.relScaleFactor=scale;me.applyTransform(transform);},touchMultiEnd:function(touch){var me=this;if(me.relScaleFactor*me.scaleFactor<1){me.relScaleFactor=1/me.scaleFactor;me.applyTransform({scale:me.relScaleFactor},500,me.postScale);}else{if(me.relScaleFactor*me.scaleFactor>2){var scaleBack=me.relScaleFactor*me.scaleFactor/2;me.relScaleFactor=2/me.scaleFactor;me.applyTransform({scale:me.relScaleFactor,scaleBack:scaleBack},500,me.postScale);}else{me.postScale();}}},applyTransform:function(transform,duration,callback){var me=this,scl=me._scroller;if(duration===undefined){duration=0;}scl.scrollEl.style.webkitTransformOrigin="left top";scl.transform="scale("+transform.scale+","+transform.scale+")";var scrollX,scrollY;if(transform.offset){scrollX=transform.offset.x;scrollY=transform.offset.y;}else{var scaleBack=transform.scaleBack||1;scrollX=me._scroller.origin.x/scaleBack;scrollY=me._scroller.origin.y/scaleBack;}var tempFactor=me.scaleFactor*me.relScaleFactor;var tempDomCanvasWidth=me.nCols*me.chartW*tempFactor,tempDomCanvasHeight=me.nRows*me.chartH*tempFactor;var offsetXEnd=tempDomCanvasWidth-me.width,offsetYEnd=tempDomCanvasHeight-me.height;if(offsetXEnd<0){scl.offset.x.start=offsetXEnd;scl.offset.x.end=0;}else{scl.offset.x.start=0;scl.offset.x.end=offsetXEnd;}if(offsetYEnd<0){scl.offset.y.start=offsetYEnd;scl.offset.y.end=0;}else{scl.offset.y.start=0;scl.offset.y.end=offsetYEnd;}me._scroller.scrollTo(scrollX,scrollY,duration);if(callback){var that=me;setTimeout(function(){callback.apply(that);that=null;},duration);}},postScale:function(){var me=this;delete me._scroller.transform;me._scroller.scrollTo(me._scroller.origin.x,me._scroller.origin.y,0);me.scaleFactor*=me.relScaleFactor;me.setSubTitleStyle();me.refreshWidget();},refreshWidget:function(){var me=this,origin=me._scroller.origin;me.manager.resizeRowCol(this,0,me.scaleFactor);me.manager.scrollTo(origin.x,origin.y);me.manager.drawCharts();me.getMapsAndDraw();me.updateScrollerAfterZooming();},touchSwipeBegin:function(touch){var me=this;me.beingScrolled=true;me.APIOwner.hideTooltip();if(this._super){this._super(touch);}},touchTap:function(touch){if(DEBUG_TOUCH_WHILE_LOADING){console.log("touch tap time: "+getTime());}var me=this,apiOwner=me.APIOwner;if(touch.count===2){me.APIOwner.hideTooltip();me.relScaleFactor=1/me.scaleFactor;var widgetXY=me.getWidgetXY(touch);var sclOri=me._scroller&&me._scroller.origin;var offset=null;if(widgetXY&&sclOri){offset={x:me.relScaleFactor*(widgetXY.touchX+sclOri.x)-widgetXY.touchX,y:me.relScaleFactor*(widgetXY.touchY+sclOri.y)-widgetXY.touchY};}me.applyTransform({scale:me.relScaleFactor,offset:offset},500,me.postScale);}else{if(touch.count===1){var miniChart=me.getMiniChartFromTouch(touch);apiOwner.touchedMiniChart=miniChart;me.handleSingleTouchTap(touch);}}},handleSingleTouchTap:function handleSingleTouchTap(touch){var me=this,apiOwner=me.APIOwner,touchedMiniChart=apiOwner.touchedMiniChart;if(apiOwner&&apiOwner.tooltipOn){var item=mstrmojo.dom.findAncestorByAttr(touch.target,"clk",true,apiOwner.domNode)||null;if(item){var value=item.value;if(value==="clk"){apiOwner.hideTooltip();return ;}}}var touchedObj=touchedMiniChart&&touchedMiniChart.getTouchedObj(true,touch.widgetX,touch.widgetY),actionObj,sameAsLastHighlight;if(touchedObj&&touchedObj.hdrIndex>=0){var canBeSelected=apiOwner.pointCanBeSelected(touchedObj),sameAsCurrSelectedPoint=apiOwner.currSelectedObjBackup&&(touchedObj.touchVal===apiOwner.currSelectedObjBackup.touchVal)&&touchedMiniChart===apiOwner.currSelectedObjMiniChart;if(canBeSelected){if(!sameAsCurrSelectedPoint){apiOwner.defaultSelectedObjs={};apiOwner.shouldHighlightDefaultSelectedNodes=apiOwner.getShouldHighlightDefaultSelectedNodes();apiOwner.hideTooltip();actionObj=apiOwner.getActionObj(touchedObj);if(actionObj&&actionObj.scObjList){apiOwner.currSelectedObj=touchedObj;apiOwner.currSelectedObjMiniChart=touchedMiniChart;apiOwner.highlightMiniCharts();apiOwner.performAction([actionObj]);}else{if(actionObj&&actionObj.node){apiOwner.currLinkObj=touchedObj;apiOwner.currLinkObjMiniChart=touchedMiniChart;apiOwner.highlightMiniCharts();apiOwner.performAction([actionObj]);apiOwner.currLinkObj=null;apiOwner.currLinkObjMiniChart=null;}}}else{if(apiOwner.currHoverObj&&apiOwner.currSelectedObj&&apiOwner.currHoverObj.touchVal===apiOwner.currSelectedObj.touchVal){}else{if(apiOwner.hasNonifwTarget){actionObj=apiOwner.getActionObj(touchedObj,true,true);if(actionObj){apiOwner.performAction([actionObj]);apiOwner.currSelectedObj=null;apiOwner.currSelectedObjMiniChart=null;apiOwner.highlightMiniCharts();}else{apiOwner.getFirstInfowindow();if(!apiOwner.savedInfowindowOn&&apiOwner.infowindow){apiOwner.realtimeInfowindowOn=true;if(apiOwner.infowindow){apiOwner.infowindow.open();}}}}}apiOwner.hideTooltip();}}else{sameAsLastHighlight=apiOwner.currHoverObj&&(touchedObj.touchVal===apiOwner.currHoverObj.touchVal);if(!sameAsLastHighlight){apiOwner.currHoverObj=touchedObj;apiOwner.currHoverObjMiniChart=touchedMiniChart;apiOwner.highlightMiniCharts();}else{apiOwner.hideTooltip();}}}else{if(touchedObj&&touchedObj.hdrIndex<0){sameAsLastHighlight=apiOwner.currHoverObj&&(touchedObj.touchVal===apiOwner.currHoverObj.touchVal);if(!sameAsLastHighlight){apiOwner.currHoverObj=touchedObj;apiOwner.currHoverObjMiniChart=touchedMiniChart;apiOwner.highlightMiniCharts();}else{apiOwner.hideTooltip();}}else{if(!touchedObj){apiOwner.hideTooltip();if(apiOwner.currSelectedObjBackup&&apiOwner.hasNonifwTarget){actionObj=apiOwner.getActionObj(touchedObj,true);if(actionObj){apiOwner.performAction([actionObj]);apiOwner.currSelectedObj=null;apiOwner.currSelectedObjMiniChart=touchedMiniChart;apiOwner.highlightMiniCharts();}}}}}},unrender:function(ignoreDom){var me=this;this.chartsPool=[];this.activeCharts=[];this.activeFlags=[];if(me.scrollDoneListener){if(me._scroller){me._scroller.detachEventListener(me.scrollDoneListener);}delete me.scrollDoneListener;}if(me.scrollMovedListener){if(me._scroller){me._scroller.detachEventListener(me.scrollMovedListener);}delete me.scrollMovedListener;}if(this._super){this._super(ignoreDom);}}});}());