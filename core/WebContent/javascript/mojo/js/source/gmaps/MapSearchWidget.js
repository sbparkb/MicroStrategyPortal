(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.Label","mstrmojo.ui.List","mstrmojo.array","mstrmojo.css","mstrmojo.Popup");var $A=mstrmojo.array,$C=mstrmojo.css;function createSuggestion(suggestionBlocks,popup){var i,len,data,menuItems=[];for(i=0,len=suggestionBlocks.length;i<len;i++){data=suggestionBlocks[i];menuItems.push({scriptClass:"mstrmojo.Box",cssClass:"suggestionBlock",children:[{scriptClass:"mstrmojo.Label",text:data.label,cssClass:"layerLabel "+(data.label?"displayMenuTitle":"hideMenuTitle")},{scriptClass:"mstrmojo.ui.List",cssClass:"searchSuggestion "+(data.label?"sub":"top"),alias:"list",items:data.items,onchange:function(){if(!popup.opener){return ;}var q=popup.opener.suggestionSource;if(q&&q.onSuggestionItemSelected&&this.selectedItem){q.onSuggestionItemSelected(this.selectedItem);if(popup.opener&&popup.opener.search){popup.opener.search.inputNode.value=this.selectedItem.n;}popup.close();}}}]});}return{scriptClass:"mstrmojo.Box",alias:"suggestion",cssClass:"suggestionList",children:menuItems};}function totalItemCount(suggestionBlocks){var count=0;$A.forEach(suggestionBlocks,function(v){count+=v.items?v.items.length:0;});return count;}function getItemOfIndex(itemsBlock,itemsBlockProp,idx,itemFunc){var item,curIdx=idx,items;$A.forEach(itemsBlock,function(itemBlock){if(itemsBlockProp){items=itemBlock[itemsBlockProp]&&itemBlock[itemsBlockProp].items;}else{items=itemBlock.items;}if(!items){return true;}if(curIdx>=0&&curIdx<items.length){if(itemFunc){itemFunc.call(itemBlock,curIdx);}item=items[curIdx];return false;}else{curIdx-=items.length;}});return item;}function setSelectCSSOnItem(idx){var chds=this.suggestion.children,curIdx=idx,me=this;if(this.selectedNode){$C.removeClass(this.selectedNode,"selected");}getItemOfIndex(chds,"list",curIdx,function(idx){me.selectedNode=this.list._getItemNode(idx);$C.addClass(me.selectedNode,"selected");});}mstrmojo.gmaps.MapSearchWidget=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.gmaps.MapSearchWidget",markupString:'<div id="{@id}" class="mstrmojo-SearchWidget-WithSuggestion {@cssClass}"><div class="searchbox" mstrAttach:keydown></div><div class="suggestion"></div></div>',markupSlots:{searchNode:function(){return this.domNode.firstChild;},popupNode:function(){return this.domNode.lastChild;}},suggestionResults:null,popupOpenConfig:null,suggestionSource:null,displayResults:function(items){this.set("suggestionResults",items);this.openPopup("popupRef",this.popupOpenConfig);},clearResults:function(){this.set("suggestionResults",null);this.closePopup();},popupRef:{scriptClass:"mstrmojo.Popup",slot:"popupNode",autoCloses:false,autoClose:false,locksHover:true,closeOnClick:true,currentIdx:-1,onOpen:function onOpen(){var popupNode;this.destroyChildren();this.currentIdx=-1;this.addChildren(createSuggestion(this.opener.suggestionResults,this));this.refresh();popupNode=this.opener.domNode;if(popupNode&&popupNode.offsetWidth){this.domNode.style.width=popupNode+"px";}},selectNext:function selectNext(){var sr=this.opener.suggestionResults,totalCount=totalItemCount(sr),currentIdx=this.currentIdx;currentIdx=++currentIdx%totalCount;setSelectCSSOnItem.call(this,currentIdx);this.currentIdx=currentIdx;return getItemOfIndex(sr,null,currentIdx).n;},selectPrevious:function selectPrevious(){var sr=this.opener.suggestionResults,totalCount=totalItemCount(sr),currentIdx=this.currentIdx;currentIdx=(totalCount+currentIdx-1)%totalCount;setSelectCSSOnItem.call(this,currentIdx);this.currentIdx=currentIdx;return getItemOfIndex(sr,null,currentIdx).n;}},onkeydown:function onkeydown(evt){var hWin=evt.hWin,e=evt.e||hWin.event,k=e.keyCode;if(k===38||k===40){this.search.quickSearch=false;}else{var popup=this.popupRef,chds=popup.suggestion&&popup.suggestion.children,curIdx=popup.currentIdx;if(k===13&&chds){curIdx=curIdx<0?0:curIdx;getItemOfIndex(chds,"list",curIdx,function(idx){this.list.select(idx);});this.closePopup();this.search.quickSearch=false;}else{this.search.quickSearch=true;}}},children:[{scriptClass:"mstrmojo.SearchWidget",alias:"search",slot:"searchNode",quickSearch:true,onsearch:function onsearch(){var pattern=this.getSearchPattern(),p=this.parent,q=p.suggestionSource;if(this.quickSearch&&pattern.length>=3&&q&&q.getSuggestions){q.getSuggestions(pattern,function(items){if(items&&items.length>0){p.displayResults(items);}});}},onArrowUp:function onKeyUp(){var popup=this.parent.popupRef,n;if(popup.visible){n=popup.selectPrevious();if(n){this.inputNode.value=n;}}},onArrowDown:function onKeyDown(){var popup=this.parent.popupRef,n;if(popup.visible){n=popup.selectNext();if(n){this.inputNode.value=n;}}},onclear:function onclear(){this.parent.clearResults();}}],unrender:function unrender(ignoreDom){var pr=this.popupRef;if(this.popupToBody&&pr.hasRendered){pr.unrender(false);}if(this._super){this._super(ignoreDom);}},destroy:function destroy(ignoreDom){delete this.suggestionSource;this._super(ignoreDom);}});}());