(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.vi.ui.rw._HasVisSelections");var $H=mstrmojo.hash;var SELECTION_TYPE=mstrmojo.vi.ui.rw.SelectionType;function getCommonAttributes(attributeArray){var commonAttributes=[],i,j,titleIds=getTitleColumnIndices.call(this),attributeCount=!!attributeArray?attributeArray.length:0,attribute,linkedAttributes;for(i=0;i<attributeCount;i++){attribute=attributeArray[i];linkedAttributes=this.model.getLinkedAttributes(attribute)||[];linkedAttributes=[attribute].concat(linkedAttributes);for(j=0;j<linkedAttributes.length;j++){if(titleIds.hasOwnProperty(linkedAttributes[j])){commonAttributes.push({id:attribute,columnIndex:titleIds[linkedAttributes[j]]});break;}}}return commonAttributes;}function getTitleColumnIndices(){var gridData=this.primaryModel,titles=gridData.getRowTitles(),titleId,i,titleCount=titles.size(),titleIds={},title;if(titleCount>0){for(i=0;i<titleCount;i++){title=titles.getTitle(i);titleId=title.getUnitId();titleIds[titleId]=i;}}return titleIds;}function findSelectedGraphic(all,eid,columnIndex){var graphic,i,count=!!all?all.length:0;for(i=0;i<count;i++){graphic=all[i];if(isGraphicSelected.call(this,graphic,eid,columnIndex)){return graphic;}}return null;}function isGraphicSelected(graphic,eid,columnIndex){var rowIndex,priModel=this.primaryModel,rowHeaderElements,rowHeaderElement,elementId,attributes;if(!graphic){return false;}attributes=graphic.attributes;if(!!attributes&&(attributes.rowIndex===undefined)&&this.updatePolygonGraphicInfo){this.updatePolygonGraphicInfo(graphic);}rowIndex=!!attributes?attributes.rowIndex:-1;if(rowIndex!==-1){rowHeaderElements=priModel.getRowHeaders(rowIndex);rowHeaderElement=rowHeaderElements.getHeader(columnIndex);if(rowHeaderElement){elementId=rowHeaderElement.getElementId();if(this.model.compareElementsId(elementId,eid)){return true;}}}return false;}function selectWithMetrics(data){var dataAtts=data[$H.keyarray(data)[0]],attIds=$H.keyarray(dataAtts),resultGraphics=[],allGraphics=this.getAllGraphics(),commonAttributes=getCommonAttributes.call(this,attIds),commonAttribute,selectedGraphic,singleData,index,i,selectedElementId,isSelected;if(!commonAttributes||commonAttributes.length===0){return resultGraphics;}for(index in data){if(data.hasOwnProperty(index)){singleData=data[index];selectedGraphic=null;isSelected=false;for(i=0;i<commonAttributes.length;i++){commonAttribute=commonAttributes[i];if(singleData.hasOwnProperty(commonAttribute.id)){selectedElementId=singleData[commonAttribute.id][0].id;if(i===0){selectedGraphic=findSelectedGraphic.call(this,allGraphics,selectedElementId,commonAttribute.columnIndex);if(selectedGraphic){isSelected=true;}else{break;}}else{isSelected=isGraphicSelected.call(this,selectedGraphic,selectedElementId,commonAttribute.columnIndex);if(!isSelected){break;}}}}if(isSelected){resultGraphics.push(selectedGraphic);}}}return resultGraphics;}function selectWithAttributes(data){var index,singleData,attributeId,elements,element,elementCount,eid,selectedGraphic,allGraphics=this.getAllGraphics(),titleIds=getTitleColumnIndices.call(this),columnIndex,resultGraphics=[],i,j,linkedAttributes;for(index in data){if(data.hasOwnProperty(index)){singleData=data[index];for(attributeId in singleData){linkedAttributes=this.model.getLinkedAttributes(attributeId)||[];linkedAttributes=[attributeId].concat(linkedAttributes);if(singleData.hasOwnProperty(attributeId)){elements=singleData[attributeId];elementCount=elements.length;for(i=0;i<elementCount;i++){element=elements[i];eid=element.id;for(j=0;j<linkedAttributes.length;j++){if(titleIds.hasOwnProperty(linkedAttributes[j])){columnIndex=titleIds[linkedAttributes[j]];selectedGraphic=findSelectedGraphic.call(this,allGraphics,eid,columnIndex);if(!!selectedGraphic&&!selectedGraphic.addedToResult){selectedGraphic.addedToResult=true;resultGraphics.push(selectedGraphic);}break;}}}}}}}for(i=0;i<resultGraphics.length;i++){delete resultGraphics[i].addedToResult;}return resultGraphics;}mstrmojo.gmaps._SupportMapBrushesAndHighlights=mstrmojo.provide("mstrmojo.gmaps._SupportMapBrushesAndHighlights",{_mixinName:"mstrmojo.gmaps._SupportMapBrushesAndHighlights",_highlights:[],mapSelectionType:SELECTION_TYPE.METRICS,init:function init(props){if(this._super){this._super(props);}this._selectionType=this.mapSelectionType;},getDocModelForEvent:function getDocModelForEvent(){return this.parent.parent.model;},highlight:function highlight(selTy,data,fromExpression){if(this._super){this._super.apply(this,arguments);}var i,graphic,graphics,length,map=this.parent.esriMap,highlightedGraphics=this.getHighlightedGraphics(this.geoPosition);this.parent.doClearRectangle(true);if(!fromExpression){this.clearHighlights();this.parent.clearMarkerSelections();}if(selTy===SELECTION_TYPE.METRICS){graphics=selectWithMetrics.call(this,data);}else{if(selTy===SELECTION_TYPE.ATTS){graphics=selectWithAttributes.call(this,data);}}if(!!graphics&&graphics.length>0){length=graphics.length;for(i=0;i<length;i++){graphic=graphics[i];this.handleSelection(graphic,null,true);}}this._highlights=graphics||[];},clearSelections:function clearSelections(){if(this._super){this._super();}this._selectionType=this.mapSelectionType;this.clearHighlights();this.parent.clearMarkerSelections();},clearHighlights:function clearHighlights(){var i,graphic,length=this._highlights.length,selectionHash,key;if(length>0){for(i=0;i<length;i++){graphic=this._highlights[i];this.clearHighlight(graphic);}}if(!this.currentSelections||this.currentSelections.length===0){selectionHash=this.getSelectionHash();for(key in selectionHash){if(selectionHash.hasOwnProperty(key)){delete selectionHash[key];}}}this._highlights=[];}});}());