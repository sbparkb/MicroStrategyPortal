(function(){var SAME_PROMPT=1;var DO_NOT_ANSWER=2;var CLOSE=3;var DYNAMIC=4;var STATIC=5;var CURRENT_UNIT=6;var ALL_VALID_UNITS=7;var USE_DEFAULT_ANSWER=8;var DYNAMIC_OR_SAME_PROMPT=9;mstrmojo.gmaps.MapManipulation=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.gmaps.MapManipulation",viewerLayer:null,_key:null,model:null,init:function init(props){this._super(props);},addXmlAttr:function addXmlAttr(name,value){try{return" "+name+'="'+value+'"';}catch(err){return 0;}},addXmlAttrEncoded:function addXmlAttrEncoded(name,value){if(!value){return"";}var buf=[];var len=value.length;var ch;for(var i=0;i<len;i++){ch=value.charAt(i);switch(ch){case">":buf.push("&gt;");break;case"<":buf.push("&lt;");break;case"&":buf.push("&amp;");break;case"\u0009":buf.push("&#x09;");break;case"\n":buf.push("&#x0A;");break;case"\r":buf.push("&#x0D;");break;case'"':buf.push("&quot;");break;default:buf.push(ch);break;}}return" "+name+'="'+buf.join("")+'"';},getDocModel:function getDocModel(){if(!this.model){this.model=this.viewerLayer.getDocModel();}return this.model;},isOIVM:function isOIVM(){return mstrApp&&(mstrApp.isExpress||mstrApp.isVI);},getElementIDByIndex:function getElementIDByIndex(index,colIndex){var es=this.viewerLayer.data.gts.row[colIndex].es;if(index>=0&&index<es.length){return es[index].id;}return null;},getExecutionScope:function(){if(this.isOIVM()){return"2";}return microstrategy.EXECUTION_SCOPE;},getMsgId:function(){if(this.isOIVM()){return mstrApp.docModel.mid;}return this.viewerLayer.msgID;},getSelectionInfo:function(sliceInfo){var isEmptySelection=false;isEmptySelection=!sliceInfo||!sliceInfo.elementIndex||sliceInfo.elementIndex.length===0;var newIndicesKey=isEmptySelection?"":sliceInfo.elementIndex.sort().join("_");if(this.viewerLayer.currentSelectedIndex==newIndicesKey){return ;}this.viewerLayer.currentSelectedIndex=newIndicesKey;var geoColumnIndex=sliceInfo.pos[0],geoAttributeSelector=this.viewerLayer.data.gts.row[geoColumnIndex].sc;if(geoAttributeSelector===undefined){return ;}var geoAttribute=this.viewerLayer.getGeoColumnAttribute();var model=this.viewerLayer.model;if(!!mstrApp&&!!mstrApp.isVI&&model&&model.supportsViewFilterActions&&!model.supportsViewFilterActions(geoAttribute)){return ;}var targetKeys=geoAttributeSelector.tks,controlKeyContext=geoAttributeSelector.ck,controlKey=geoAttributeSelector.ckey,showAll=geoAttributeSelector.showall||geoAttributeSelector.all,elementsList,elementIDs=[],numElements=isEmptySelection?0:sliceInfo.elementIndex.length,itemSeparator="\x1e";if(mstrApp&&mstrApp.isVI&&!showAll&&isEmptySelection){return ;}var i;for(i=0;i<numElements;i++){elementIDs.push(this.viewerLayer.data.gts.row[geoColumnIndex].es[sliceInfo.elementIndex[i]].id);}elementsList=isEmptySelection?"OA:(All)":elementIDs.join(itemSeparator);return{targetKeys:targetKeys,elementsList:elementsList,controlKeyContext:controlKeyContext,controlKey:controlKey};},addAction:function addAction(elem,actId,bp,args,argv,ac){args=args||[];argv=argv||[];var a=microstrategy.updateManager.createActionObject(elem,actId,bp,args,argv,[]);if(ac){ac.push(a);}else{microstrategy.updateManager.add([a]);microstrategy.updateManager.flushAndSubmitChanges();}},applySelection:function applySelection(sliceInfo){if(this.isOIVM()){this.applySelectionOIVM(sliceInfo);}else{this.applySelectionIM(sliceInfo);}},applySelectionIM:function applySelectionIM(sliceInfo){var sInfo=this.getSelectionInfo(sliceInfo),ac=[],targetKeys=sInfo&&sInfo.targetKeys,elementsList=sInfo&&sInfo.elementsList,controlKey=sInfo&&sInfo.controlKey,controlKeyContext=sInfo&&sInfo.controlKeyContext;if(sInfo&&this.viewerLayer.isViewerSliceable()){this.addAction(null,mstrUpdateManager.SET_CUR_CTL_ELEMENTS,sliceInfo.beanPath,["2048130","2048127","2048137","2048138","2048018"],[controlKey,elementsList,controlKeyContext,"1","false"],ac);microstrategy.updateManager.add(ac);microstrategy.updateManager.flushAndSubmitChanges();}},applySelectionOIVM:function applySelectionOIVM(sliceInfo){var sInfo=this.getSelectionInfo(sliceInfo);if(sInfo&&!!sInfo.targetKeys){this.getDocModel().slice({type:mstrmojo.EnumRWUnitType.GRID,ck:sInfo.controlKeyContext,ctlKey:sInfo.controlKey,tks:sInfo.targetKeys,suppressIW:true,eid:sInfo.elementsList});}},execHL:function execHL(parentElemsIndex,linkIndex,columnIndex){try{var linkDetails=this.viewerLayer.data.gts.row[columnIndex].lm[0];var linkArray=linkDetails.links;if(!linkIndex){linkIndex=linkDetails.di;}var linkInfo=linkArray[linkIndex];if(linkInfo){this[!linkInfo.url?"execDynamiclLink":"execUrlLink"](linkDetails,linkInfo,parentElemsIndex,columnIndex);}}catch(err){microstrategy.errors.log(err);}},execDynamiclLink:function execDynamiclLink(linkDetails,linkInfo,parentElemsIndex,columnIndex){var xml=this.buildLinkXml(linkDetails,linkInfo,parentElemsIndex,columnIndex);console.log(xml);var onw=this.linkDrillTargetOpenInNewWindow();if(this.isOIVM()){this.execDynamiclLinkOIVM(linkInfo,xml,onw);}else{this.execDynamiclLinkIM(linkInfo,xml,onw);}},execDynamiclLinkOIVM:function execDynamiclLinkOIVM(linkInfo,answerXml,newWin){try{var target=linkInfo.target,tp=target&&target.t,params,oid=target.did;switch(parseInt(tp,10)){case 55:if(parseInt(target.st,10)===14081){params={evt:2048001,objectID:oid};}else{params={evt:32001,documentID:oid};}break;case 3:params={evt:4001,reportID:oid,reportViewMode:target.st==769?2:1};}if(params){if(answerXml){params.linkAnswers=answerXml;}this.linkDrill(params,linkInfo,newWin);}}catch(err){console.log(err);}},linkDrill:function linkDrill(params,linkInfo,newWin){mstrmojo.form.send(params,null,"POST",newWin?"_blank":null);},execDynamiclLinkIM:function execDynamiclLinkIM(linkInfo,xml,onw){try{var argNames=null;var argValues=[linkInfo.target.did];var event=null;if(linkInfo.target.t==microstrategy.DSSTYPE_RPT_DEFINITION){event=mstrUpdateManager.RUN_REPORT;argNames=["1001"];if(xml){argNames.push("4222");argValues.push(xml);}argNames.push("4115");argValues.push(microstrategy.getReportViewMode(linkInfo.target.st));}else{if(linkInfo.target.t==microstrategy.DSSTYPE_DOC_DEFINITION){if(linkInfo.target.st==microstrategy.DSSSUB_TYPE_RW){event=mstrUpdateManager.RUN_RW_DOCUMENT;argNames=["2048001"];if(xml){argNames.push("2048140");argValues.push(xml);}}else{event=mstrUpdateManager.RUN_DOCUMENT;argNames=["1001"];if(xml){argNames.push("32351");argValues.push(xml);}}}}var um=microstrategy.updateManager;var oldUseIframeSetting=um.useIframe;var oldNWSetting=um.newWindow;um.useIframe=false;um.newWindow=onw;if(um.hasChangesToSubmit()){um.add([um.createActionObject(null,mstrUpdateManager.APPLY_CHANGES,mstrUpdateManager.applyChangesBeanPath,[],[],[])]);}um.add([um.createActionObject(this.elem,event,"",argNames,argValues,[])]);um.flushAndSubmitChanges();um.acknowledgeRequest();um.newWindow=oldNWSetting;um.useIframe=oldUseIframeSetting;}catch(err){microstrategy.errors.log(err);}},execUrlLink:function execUrlLink(linkDetails,linkInfo,parentElemsIndex,columnIndex){try{var oForm=null;var url=linkInfo.url;if(url.indexOf("&CurrentElement")>-1&&parentElemsIndex){var eltId=this.getElementIDByIndex(parentElemsIndex.currAtt,parentElemsIndex);url=linkInfo.url.replace("&CurrentElement",eltId);}oForm=mstrmojo.form.createDynamicForm(url);if(this.linkDrillTargetOpenInNewWindow()){oForm.target="_blank";}oForm.submit();return ;}catch(err){if(microstrategy){microstrategy.errors.log(err);}else{console.log(err);}}},buildLinkXml:function buildLinkXml(linkDetails,linkInfo,parentElemsIndex,columnIndex){var i;try{var me=this,currentSelections=this.viewerLayer.getCurrentSelections(columnIndex);var axa=function(m,n){return me.addXmlAttr(m,n);};var axae=function(m,n){return me.addXmlAttrEncoded(m,n);};var xml="<hl"+axa("mid",this.getMsgId())+axa("srct",this.getExecutionScope())+axa("aopam",linkInfo.daMode)+">";var answers=linkInfo.ans;if(answers!==null){xml+="<prms>";for(i=0,cnt=answers.length;i<cnt;i++){var answer=answers[i];var pid=answer.pid;var aty=answer.m;var statValues=answer.values;var statDisplayNames=answer.dispNames;xml+="<prm"+axa("id",pid)+axa("am",aty);if(answer.po&&answer.po.did){xml+=axa("orid",answer.po.did)+axa("ortp",answer.po.t);}xml+=">";var ei=null,dynAttrs=null,attrI=null,attrInfo=null,statCt,j;switch(aty){case DO_NOT_ANSWER:case CLOSE:case USE_DEFAULT_ANSWER:case SAME_PROMPT:break;case STATIC:if(statValues!==null){xml+='<pa ia="1"><es>';for(statCt=0;statCt<statValues.length;statCt++){xml+="<e"+axa("ei",statValues[statCt])+axae("disp_n",statDisplayNames[statCt])+axa("emt","1")+"/>";}xml+="</es></pa>";}break;case DYNAMIC:case DYNAMIC_OR_SAME_PROMPT:xml+='<pa ia="1">';xml+="<es "+axa("dispForms","")+">";for(var j=0;j<currentSelections.length;j++){ei=this.getElementIDByIndex(currentSelections[j],columnIndex);if(!ei){continue;}xml+="<e"+axae("ei",ei)+axa("emt","1")+"/>";}xml+="</es></pa>";break;case ALL_VALID_UNITS:xml+='<pa ia="1"><attGroups><attGroup>';attrInfo=this.viewerLayer.data.gts.row[columnIndex];for(j=0;j<currentSelections.length;j++){ei=this.getElementIDByIndex(currentSelections[j],columnIndex);if(!ei){continue;}xml+="<a"+axa("id",attrInfo.id)+axae("n",attrInfo.n)+">";xml+="<es "+axa("dispForms","")+"><e"+axae("ei",ei)+axa("emt","1")+"/></es>";xml+="</a>";}xml+="</attGroup></attGroups></pa>";break;case CURRENT_UNIT:dynAttrs=answer.attrs;if(currentSelections!==null&&currentSelections.length>0){xml+='<pa ia="1">';attrI=this.viewerLayer.data.gts.row[this.geoPosition];ei=this.getElementIDByIndex(currentSelections[0],columnIndex);if(ei){attrInfo=this.attMap[attrI];xml+="<a"+axa("id",attrInfo.id)+axae("n",attrInfo.n)+"><es "+axa("dispForms",attrInfo.displayFormsMap)+"><e"+axae("ei",ei)+axa("emt","1")+"/></es></a>";}xml+="</pa>";}break;}xml+="</prm>";}xml+="</prms>";}xml+="</hl>";return xml;}catch(err){microstrategy.errors.log(err);return null;}},linkDrillTargetOpenInNewWindow:function linkDrillTargetOpenInNewWindow(){var linkDetails=this.viewerLayer.getLinkDetails();if(this.viewerLayer.isPrimaryGrid()){return linkDetails&&linkDetails.onw;}else{var primaryLinkDetails=this.viewerLayer.getPrimaryGridViewer().getLinkDetails();if(primaryLinkDetails&&primaryLinkDetails.onw){return linkDetails&&linkDetails.onw;}else{return true;}}}});})();