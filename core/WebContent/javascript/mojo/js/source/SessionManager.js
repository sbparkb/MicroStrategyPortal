(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.Dialog","mstrmojo.Button","mstrmojo.HTMLButton","mstrmojo.Label","mstrmojo.form","mstrmojo.LoginEditor");mstrmojo.requiresDescs(2699,7773,11812,11865,13380,13381,13382);var msg=mstrmojo.desc(13382,"Your user session will time out due to inactivity in # ##."),SECONDS_IN_ONE_MINUTE=60,isWarningPopup=false,timer=null,warningCountdownTick=null,checkSessionTimer=null;function getSessionState(){return mstrApp.sessionState||microstrategy.sessionState;}function setAriaAttributes(node,attrs){if(mstrApp.is508){for(var attr in attrs){node.setAttribute(attr,attrs[attr]);}}}mstrmojo.SessionManager=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.SessionManager",cssClass:"mstrmojo-SessionManager",width:"370px",title:mstrmojo.desc(11812,"Notification"),msgInterval:1,checkSessionInterval:20,zIndex:10000,maxSessionIdleTime:600,timeBeforeSessionTimeoutWarning:60,remainingTime:60,sessionTimedout:false,buttons:[mstrmojo.Button.newWebButton(mstrmojo.desc(13381,"Stay logged in"),function(){var sm=this.parent.parent;if(warningCountdownTick){sm.keepSessionAlive();}sm.hideMessage();},true,{onRender:function(){setAriaAttributes(this.domNode,{tabindex:0,role:"button","aria-label":mstrmojo.desc(13381,"Stay logged in")});}}),mstrmojo.Button.newWebButton(mstrmojo.desc(13380,"Log out"),function(){this.parent.parent.hideMessage();mstrmojo.form.send({evt:3019,src:mstrApp.name+".3019"});},null,{onRender:function(){setAriaAttributes(this.domNode,{tabindex:0,role:"button","aria-label":mstrmojo.desc(13380,"Log out")});}})],children:[{scriptClass:"mstrmojo.Label",alias:"message",cssClass:"mstrmojo-SessionManager-msg",text:"",allowHTML:true,ontextChange:function(){if(mstrApp.is508){this.refresh();var node=this.domNode;setAriaAttributes(node,{tabindex:-1,role:"alert"});window.setTimeout(function(){node.focus();},0);}}}],postBuildRendering:function(){this._super();if(mstrApp.is508){this.msgInterval=10;setAriaAttributes(this.editorNode,{role:"alertdialog",tabindex:-1});}},updateMsg:function updateMsg(time){var newmsg;if(time>60){newmsg=msg.replace("##",mstrmojo.desc(2699,"minutes")).replace("#","<b>"+Math.ceil(time/SECONDS_IN_ONE_MINUTE)+"</b>");}else{if(time>-1){newmsg=msg.replace("##",mstrmojo.desc(7773,"seconds")).replace("#","<b>"+time+"</b>");}else{newmsg=mstrmojo.desc(11865,"Your session is expired.");}}this.message.text="";this.message.set("text",newmsg);this.remainingTime=time;},showMessage:function showMessage(time){this.updateMsg(time);this.set("visible",true);isWarningPopup=true;},hideMessage:function hideMessage(){if(warningCountdownTick){window.clearInterval(warningCountdownTick);warningCountdownTick=null;window.clearInterval(checkSessionTimer);checkSessionTimer=null;}this.set("visible",false);isWarningPopup=false;},popupTimeoutWarning:function popupTimeoutWarning(time){if(isWarningPopup){return ;}var me=this,initialWarningTime=(typeof time==="number")?time:me.timeBeforeSessionTimeoutWarning,remainingTime=initialWarningTime,startTime=mstrmojo.now();if(mstrApp.enableWarningSessionTimeout){if(!this.hasRendered){this.render();}this.showMessage(remainingTime);}window.clearInterval(warningCountdownTick);warningCountdownTick=window.setInterval(function(){if(remainingTime<1){window.clearInterval(warningCountdownTick);warningCountdownTick=null;window.setTimeout(function(){if(mstrApp.enableWarningSessionTimeout){me.gotoLogoutPage();}else{me.sessionTimedout=true;me.closeSession();}},200);}var elapsedTime=Math.round((mstrmojo.now()-startTime)/1000);remainingTime=initialWarningTime-elapsedTime;me.updateMsg(remainingTime);},this.msgInterval*1000);window.clearInterval(checkSessionTimer);checkSessionTimer=window.setInterval(function(){me.isSessionAlive();},this.checkSessionInterval*1000);},warningTimeoutTimer:function warningTimeoutTimer(delay){var me=this;window.clearTimeout(timer);timer=window.setTimeout(function(){timer=null;me.isSessionAlive();},(delay-this.timeBeforeSessionTimeoutWarning)*1000);},isSessionAlive:function isSessionAlive(){var me=this,callback={success:function(res){var time=parseInt(res,10);if(time!==-1){if(time>me.remainingTime){me.hideMessage();}if(time>me.timeBeforeSessionTimeoutWarning){me.warningTimeoutTimer(time);}else{me.popupTimeoutWarning(time);}}else{window.clearInterval(checkSessionTimer);me.popupTimeoutWarning(0);}},failure:function(){mstrmojo.alert("Problems encountered during checking for whether session is alive. Connection is down or session already time out.");}},params={taskId:"isSessionAlive",notRestartSessionManager:true};mstrmojo.xhr.request("POST",mstrConfig.taskURL,callback,params);},keepSessionAlive:function keepSessionAlive(){var me=this,callback={success:function(res){if(res){me.warningTimeoutTimer(me.maxSessionIdleTime);}else{me.sessionTimedout=true;mstrmojo.alert("Your session is expired.");}},failure:function(){mstrmojo.alert("Problems encountered during activating session. Connection is down or session already time out.");}},params={taskId:"keepSessionAlive"};mstrmojo.xhr.request("POST",mstrConfig.taskURL,callback,params);},closeSession:function closeSession(){var me=this;mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(){me.sessionTimedout=true;}},{taskId:"closeSessions",sessionStates:getSessionState(),notRestartSessionManager:true});},restart:function(){this.sessionTimedout=false;this.hideMessage();if(this.maxSessionIdleTime>this.timeBeforeSessionTimeoutWarning){this.warningTimeoutTimer(this.maxSessionIdleTime);}},start:function start(){var msgKey=mstrConfig.lastMsgKey;if(this.maxSessionIdleTime>this.timeBeforeSessionTimeoutWarning){this.warningTimeoutTimer(this.maxSessionIdleTime);}var fnSetNotificationFlag=function(){window.localStorage.setItem("msg_recovery_notify"+msgKey,1);};if(window.addEventListener){window.addEventListener("beforeunload",fnSetNotificationFlag);}else{window.attachEvent("onbeforeunload",fnSetNotificationFlag);}var ss=window.sessionStorage;if(ss){ss.setItem("msg_browser_not_closed"+msgKey,1);ss.setItem("msg_user_login",0);}},openLoginEditor:function getLoginEditor(callback){var id="LoginEditor",editor=mstrmojo.all[id];if(!editor){editor=mstrmojo.insert({id:id,scriptClass:"mstrmojo.LoginEditor",config:{callback:{}},zIndex:10000});}editor.config.callback=callback;editor.open();},gotoLogoutPage:function gotoLogoutPage(){mstrmojo.form.send({evt:3008,src:mstrApp.name+".3008",autoLoggedout:true,Server:mstrConfig.serverName,Port:mstrConfig.serverPort,Project:mstrConfig.projectName,loginReq:true},null,"POST");}});}());