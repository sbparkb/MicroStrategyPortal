(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.dom","mstrmojo.css","mstrmojo.VisEnum","mstrmojo.VisUtility");var LOCAL_PROPS=mstrmojo.VisEnum.NETWORK_LOCAL_PROPS,DRAG_TYPE=mstrmojo.VisEnum.NETWORK_DRAG_MODE;var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$U=mstrmojo.VisUtility;mstrmojo.netviz.VisNetworkStageScaleBar=mstrmojo.declare(mstrmojo.Container,[],{scriptClass:"mstrmojo.netviz.VisNetworkStageScaleBar",markupString:'<div class="VisNetworkStageScaleBar" id="{@id}-networkStageScaleBar" style="position: absolute; top:{@top}px; left:{@left}px; height: {@height}px; width: {@width}px; z-index: 2;" mstrAttach:mousedown,click><div class="_label"></div><div style="position: relative"><div class="_zoomTool"><div class="_FTWTrigger"></div><div class="_zoomInButton"></div><div class="_scaleBar"><div class="_bar"></div><div class="_slider"></div></div><div class="_zoomOutButton"></div></div><div class="pan-select-tool"><input class="_inputPan" type="radio" id="{@id}-panButton" name="{@id}-sptype"><label for="{@id}-panButton" class="_panButton"></label><input class="_inputSelect" type="radio" id="{@id}-selectButton" name="{@id}-sptype"><label for="{@id}-selectButton" class="_selectButton"></label></div></div></div>',markupSlots:{label:function(){return this.domNode.childNodes[0];},fitToWindowTrigger:function(){return this.domNode.childNodes[1].childNodes[0].childNodes[0];},zoomInButton:function(){return this.domNode.childNodes[1].childNodes[0].childNodes[1];},zoomTool:function(){return this.domNode.childNodes[1].childNodes[0].childNodes[2].childNodes[0];},slider:function(){return this.domNode.childNodes[1].childNodes[0].childNodes[2].childNodes[1];},zoomOutButton:function(){return this.domNode.childNodes[1].childNodes[0].childNodes[3];},SPTrigger:function(){return this.domNode.childNodes[1].childNodes[1];},inputPan:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[0];},panButton:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[1];},inputSelect:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[2];},selectButton:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[3];}},init:function(config){if(this._super){this._super(config);}if(!this.placeholder){$U.visPrint("A placeholder is needed for set the position for the ScaleBar. Init failed.");return ;}this.left=this.placeholder.offsetLeft;this.top=this.placeholder.offsetTop;},postBuildRendering:function(){if(this._super){this._super();}var eventType=["mousedown","mouseup","mousemove","click","mousewheel"],i,len=eventType.length;for(i=0;i<len;i++){var type=eventType[i],handlerName="on"+type;if(this[handlerName]){this.attachEventListener(type,this.id,this[handlerName]);}}this.setScaleFactor(this.scaleFactor);this.initSPType();},initSPType:function(){var dragMode=this.dragMode,owner=this.owner;owner.dragMode=dragMode;if(dragMode===DRAG_TYPE.pan){this.inputPan.checked=true;this.owner.lassoSelectorEnabled=false;}else{if(dragMode===DRAG_TYPE.select){this.inputSelect.checked=true;this.owner.lassoSelectorEnabled=true;}}},onclick:function(e){e=e.e||e;e.stopPropagation();var target=e.target;var drageMode;if(target===this.fitToWindowTrigger){this.resetScene.call(this.owner);this.setScaleFactor(1);var _this=this;this._deActiveTimer=window.setTimeout(function(){_this.setScaleFactorDone();},1000);}else{if(target===this.zoomInButton){this.setScaleFactor(this.scaleFactor+0.1,false,true);}else{if(target===this.zoomOutButton){this.setScaleFactor(this.scaleFactor-0.1,false,true);}else{if(target===this.panButton){drageMode=DRAG_TYPE.pan;}else{if(target===this.selectButton){drageMode=DRAG_TYPE.select;}}}}}if(drageMode!==undefined){this.setSPType(drageMode);}},setSPType:function(type){if(this.hasInterface("setDragType")){this.setDragType.call(this.owner,type);}},onmousedown:function(e){e=e.e||e;this.owner.dismissLassoSelector();e.stopPropagation();var target=e.target;if(target===this.slider){$DOM.attachMouseMoveEvents(this.onmousemove.bind(this),this.onmouseup.bind(this));this._oldPageY=e.pageY;}},onmousemove:function(e){e=e.e||e;e.stopPropagation();var dY=e.pageY-this._oldPageY;this._oldPageY=e.pageY;var y=this.slider.offsetTop+this.slider.offsetHeight/2+dY-this.zoomTool.offsetTop,l=this.zoomTool.offsetHeight,scaleFactor;if(this.hasInterface("range")){var range=this.range;scaleFactor=(l-y)/l*(range.max-range.min)+range.min;}this.setScaleFactor(scaleFactor);},onmouseup:function(e){e=e.e||e;e.stopPropagation();this.setScaleFactorDone();},setScaleFactor:function(value,dontScale,dontApplyCss){if(isNaN(value)){$U.visPrint("Invalid scale factor");return ;}if(this.hasInterface("owner")&&this.hasInterface("scale")&&this.hasInterface("range")){var isZoomingIn,isZoomingOut;var scaleFactor;var range=this.range;var deltaScaleFactor=1;if(value<range.min){scaleFactor=range.min;}else{if(value>range.max){scaleFactor=range.max;}else{scaleFactor=value;}}if(scaleFactor>this.scaleFactor){isZoomingIn=true;}if(scaleFactor<this.scaleFactor){isZoomingOut=true;}deltaScaleFactor=scaleFactor/this.scaleFactor;this.scaleFactor=scaleFactor;this.slider.style.top=(range.max-this.scaleFactor)/(range.max-range.min)*this.zoomTool.offsetHeight+this.zoomTool.offsetTop-this.slider.offsetHeight/2+"px";var domNode,className;if(isZoomingIn){domNode=this.zoomInButton;className="_zoomInButtonActive";}if(isZoomingOut){domNode=this.zoomOutButton;className="_zoomOutButtonActive";}if(domNode){this.setScaleFactorDone();this._zoomButtonDomNode=domNode;this._zoomButtonActiveClassName=className;if(!dontApplyCss){$CSS.addClass(domNode,className);}}var label=this.label;label.innerHTML=Math.floor(this.scaleFactor*100)+"%";this.owner.setLocalProp(LOCAL_PROPS.ZOOM_FACTOR,this.scaleFactor);if(this.fadeLabelTimer){window.clearInterval(this.fadeLabelTimer);label.style.opacity=1;}var me=this;this.fadeLabelTimer=window.setInterval(function(){var opacity=label.style.opacity,delta=0.01;if(opacity>delta){opacity-=delta;}else{opacity=0;if(me.fadeLabelTimer){window.clearInterval(me.fadeLabelTimer);}}label.style.opacity=opacity;},10);if(!dontScale){this.scale.call(this.owner,deltaScaleFactor);}}},setScaleFactorDone:function(){if(this._zoomButtonActiveClassName&&this._zoomButtonDomNode){$CSS.removeClass(this._zoomButtonDomNode,this._zoomButtonActiveClassName);delete this._zoomButtonActiveClassName;delete this._zoomButtonDomNode;}if(this._deActiveTimer){window.clearTimeout(this._deActiveTimer);}},hasInterface:function(name){if(this[name]){return true;}$U.visPrint("warning: no interface found: "+name);return false;},scaleFactor:1,savedScaleFactor:1,range:null,scale:null,owner:null,dragMode:DRAG_TYPE.pan});})();