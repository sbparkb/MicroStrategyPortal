(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.vi.ui.rw._HasVisSelections","mstrmojo.VisUtility");var $ARRAY=mstrmojo.array;var $U=mstrmojo.VisUtility;var SELECTION_TYPE=mstrmojo.vi.ui.rw.SelectionType;var SELECTOR_ACTION=2;function getAttIndexFromId(attId){var attIndex=-1;var attrs=this.modelData.gts.row||[],len=attrs.length,i;for(i=0;i<len;i++){if(attrs[i].id===attId){attIndex=i;}}return attIndex;}mstrmojo.netviz._SupportNetworkBrushesAndHighlights=mstrmojo.provide("mstrmojo.netviz._SupportNetworkBrushesAndHighlights",{_mixinName:"mstrmojo.netviz._SupportNetworkBrushesAndHighlights",prepareSelectedNodesInfo:function(transformSelectionFn){this.clearSelections();var selection=this.getSelectedNodes();if(transformSelectionFn instanceof Function){selection=transformSelectionFn.call(this,selection);}$ARRAY.forEach(selection,function(node){var forms=node.attributeElements;this.addAttributeSelection(node.attribute.id,forms[0].id,$U.pluck(forms,"name").join(":"));},this);},highlight:function(selType,data){if(this._super){this._super.apply(this,arguments);}if(this.noHighlightAfterKeepOnlyExcludeDrill){return ;}var hash,dataUnit,attId,attIndex,attElems,circleSprites=[],circleSprite,edgeSprite,edgeSprites=[],stage=this.stage,spriteCollection=(stage&&stage.spriteCollection)||[],unit1,unit2,circleSprite1,circleSprite2,model=this.model;if(!this.stage){return ;}function addSprites(unit1,unit2){var circle,edges,edges1,edges2,units=[],len;if(unit1){units.push(unit1);}if(unit2){units.push(unit2);}$ARRAY.forEach(units,function(unit){circle=unit.sprite;if(circle&&circleSprites.indexOf(circle)===-1){circleSprites.push(circle);}});len=units.length;if(len===2){edges1=units[0].edges;edges2=units[1].edges;$ARRAY.forEach(edges1,function(edge){edgeSprite=edge&&edge.sprite;if(edges2.indexOf(edge)!==-1&&edgeSprites.indexOf(edgeSprite)===-1){edgeSprites.push(edgeSprite);}});}else{if(len===1){edges=units[0].edges;$ARRAY.forEach(edges,function(edge){edgeSprite=edge&&edge.sprite;if(edgeSprite&&edgeSprites.indexOf(edgeSprite)===-1){edgeSprites.push(edgeSprite);}});}}}function getCircleSprite(attElemName){var lSprite=null;$ARRAY.forEach(spriteCollection,function(sprite){if(sprite.type==="Circle"&&sprite.text===attElemName){lSprite=sprite;return false;}});return lSprite;}function getCircleSpriteByElementId(eid){var lSprite=null,node,attributeElements,secondaryAttributeElements=[];$ARRAY.forEach(spriteCollection,function(sprite){if(sprite.type==="Circle"){node=sprite.unit;attributeElements=node?node.attributeElements:[];if(node&&node.hasSelfLoop){secondaryAttributeElements=node.secondaryAttributeElements;}attributeElements=attributeElements.concat(secondaryAttributeElements);$ARRAY.forEach(attributeElements,function(attributeElement){if(model.compareElementsId(attributeElement.id,eid)){lSprite=sprite;return false;}});if(lSprite){return false;}}});return lSprite;}function highlightCircleSprites(circleSprites){$ARRAY.forEach(circleSprites,function(circleSprite){if(circleSprite){stage.addToSelection(circleSprite);}});}function highlightEdgeSprites(edgeSprites){$ARRAY.forEach(edgeSprites,function(edgeSprite){stage.addToSelection(edgeSprite);});}function highlightSprites(){highlightCircleSprites(circleSprites);highlightEdgeSprites(edgeSprites);stage.draw();}function getFormConbinedName(forms){var attElemName="";$ARRAY.forEach(forms||[],function(form){attElemName+=form.n+" ";});attElemName=attElemName.substring(0,attElemName.length-1);return attElemName;}if(selType===SELECTION_TYPE.ATTS){stage.clearSelection();for(hash in data){if(data.hasOwnProperty(hash)){dataUnit=data[hash];for(attId in dataUnit){if(dataUnit.hasOwnProperty(attId)){attIndex=getAttIndexFromId.call(this,attId);if(attIndex<0){continue;}attElems=dataUnit[attId];if(attElems&&attElems.length>0){circleSprite=getCircleSpriteByElementId.call(this,attElems[0].id);}if(circleSprite&&circleSprites.indexOf(circleSprite)===-1){circleSprites.push(circleSprite);}}}}}highlightSprites();}else{if(selType===SELECTION_TYPE.METRICS){stage.clearSelection();for(hash in data){if(!data.hasOwnProperty(hash)){continue;}dataUnit=data[hash];unit1=null;unit2=null;circleSprite1=null;circleSprite2=null;for(attId in dataUnit){if(!dataUnit.hasOwnProperty(attId)){continue;}attIndex=getAttIndexFromId.call(this,attId);if(attIndex<0||attIndex>1){continue;}else{if(attIndex===0){attElems=dataUnit[attId];if(attElems&&attElems.length>0){circleSprite1=getCircleSpriteByElementId.call(this,attElems[0].id);}unit1=circleSprite1&&circleSprite1.unit;}else{if(attIndex===1){attElems=dataUnit[attId];if(attElems&&attElems.length>0){circleSprite2=getCircleSpriteByElementId.call(this,attElems[0].id);}unit2=circleSprite2&&circleSprite2.unit;}}}}addSprites(unit1,unit2);}highlightSprites();}else{if(selType===SELECTION_TYPE.EMPTY){stage.clearSelection();stage.draw();}}}},singleUnitSelect:function singleUnitSelect(){var doAttributeSelection=this.getSelections().length>0||this.clearSelectionsFlag;if(this.clearSelectionsFlag){delete this.clearSelectionsFlag;}if(doAttributeSelection){var findUnitIdWithSC=function(){var scm=this.model.scm,scmKeys=Object.keys(scm||{}),unitId=(scmKeys&&scmKeys[0])||"",row=this.model.data.gts.row,col=this.model.data.gts.col;$ARRAY.forEach(row.concat(col),function(unit){if(scmKeys.indexOf(unit.id)!==-1){unitId=unit.id;return false;}});return unitId;};var prepareCell=function(){var selectionInfo={};selectionInfo.tid=findUnitIdWithSC.call(this);selectionInfo.eid="";selectionInfo.isClearAll=false;selectionInfo.anchor=this.domNode;selectionInfo.at=SELECTOR_ACTION;selectionInfo.selections=this.getSelections();selectionInfo.selectionType=this.getSelectionType();return selectionInfo;};var selctionInfo=prepareCell.call(this);this.performAction([selctionInfo]);}},clearSelections:function(flag){this.clearSelectionsFlag=true;if(this._super){this._super();}if(flag&&this.stage){this.stage.dismissLassoSelector();this.stage.clearSelection();this.stage.draw(false);}}});}());