(function(){var DEBUG=false;mstrmojo.requiresCls("mstrmojo.Base");mstrmojo.netviz.PropertyParser=mstrmojo.declare(mstrmojo.Base,null,{scriptClass:"mstrmojo.netviz.PropertyParser",methods:{unmarshal:function(prop,value){var me=this;me._withConfig({unmarshal:true},function(){me.parsedProps[prop]=value;});},marshal:function(prop){var me=this;return me._withConfig({marshal:true},function(){return me.parsedProps[prop];});}},init:function(cfg){if(this._super){this._super(cfg);}this.config={marshal:false,unmarshal:false};this.parsedProps={};},parse:function(raw,schema){var me=this,obj=this.parsedProps,methods=this.methods;this.raw=raw;this.schema=schema;Object.keys(methods).forEach(function(k){me.defineMethod(k,methods[k]);});Object.keys(schema).forEach(function(propertyName){var def=schema[propertyName];me.defineProperty(propertyName,def.type);obj.unmarshal(propertyName,raw[def.key]);});return obj;},defineProperty:function(prop,type){var me=this,config=me.config,obj=this.parsedProps,def=(this.schema||{})[prop]||{},preSet=def.preSet,postSet=def.postSet,preGet=def.preGet,postGet=def.postGet,key=def.key,raw=this.raw,_val;if(!hasPropertyInterface(type)){throw new TypeError("type does not implement required methods");}Object.defineProperty(obj,prop,{enumerable:true,get:function(){var value=_val;if(value!==undefined&&config.marshal){if(preGet instanceof Function){value=preGet.call(obj,value,prop,raw,key);}value=type.marshal(value);if(postGet instanceof Function){value=postGet.call(obj,value,prop,raw,key);}}return value;},set:function(val){var value=val;if(config.unmarshal){if(preSet instanceof Function){value=preSet.call(obj,value,prop,raw,key);}value=type.unmarshal(value);if(postSet instanceof Function){value=postSet.call(obj,value,prop,raw,key);}}if(value!==undefined&&!type.validate(value)){throw new TypeError("Invalid value in setter. Consider unmarshal(prop, val).");}_val=value;}});},defineMethod:function(prop,fn){var me=this,obj=me.parsedProps;if(!isString(prop)||!(fn instanceof Function)){return ;}Object.defineProperty(obj,prop,{enumerable:false,value:fn.bind(me)});},_withConfig:function(cfg,callback){var currentCfg=this.config,overrides=Object.keys(cfg||{}),oldValues=overrides.reduce(function(values,k){values[k]=currentCfg[k];return values;},{}),result;overrides.forEach(function(k){currentCfg[k]=cfg[k];});result=callback();overrides.forEach(function(k){currentCfg[k]=oldValues[k];});return result;}});var toString=Object.prototype.toString,PropertyParser=mstrmojo.netviz.PropertyParser;function getInteger(val,base,defval){var v=parseInt(val,base);return isNaN(v)?defval:v;}function isNumber(val){return toString.call(val)==="[object Number]";}function isString(val){return toString.call(val)==="[object String]";}var Property=mstrmojo.declare(mstrmojo.Base,[],{scriptClass:"mstrmojo.netviz.PropertyParser.Property",init:function(cfg){if(this._super){this._super();}this.defval=cfg.defval;},marshal:function(obj){return JSON.stringify(obj).replace(/"/g,"'");}});PropertyParser.BooleanProperty=mstrmojo.declare(Property,[],{scriptClass:"mstrmojo.netviz.PropertyParser.BooleanProperty",unmarshal:function(val){if(val===undefined){return this.defval;}return val.toString()==="true";},validate:function(val){return val===true||val===false||toString.call(val)==="[object Boolean]";}});PropertyParser.IntegerProperty=mstrmojo.declare(Property,[],{scriptClass:"mstrmojo.netviz.PropertyParser.IntegerProperty",unmarshal:function(val){return getInteger(val,10,this.defval);},validate:isNumber});PropertyParser.FloatProperty=mstrmojo.declare(Property,[],{scriptClass:"mstrmojo.netviz.PropertyParser.FloatProperty",unmarshal:function(val){var v=parseFloat(val);return isNaN(v)?this.defval:v;},validate:isNumber});PropertyParser.JsonProperty=mstrmojo.declare(Property,[],{scriptClass:"mstrmojo.netviz.PropertyParser.JsonProperty",unmarshal:function(val){function getJsonObject(string){var jsonVal;if(string!==undefined){try{jsonVal=JSON.parse(string.replace(/'/g,'"'));}catch(e){jsonVal=string;}}return jsonVal;}if(typeof val==="string"){return getJsonObject(val);}if(val!==undefined&&val!==null){return val;}return this.defval;},validate:function(val){return true;}});PropertyParser.StringProperty=mstrmojo.declare(Property,[],{scriptClass:"mstrmojo.netviz.PropertyParser.StringProperty",unmarshal:function(val){if(val!==undefined&&val!==null){return val.toString();}return this.defval;},marshal:function(val){return val;},validate:isString});var types=["BooleanProperty","StringProperty","JsonProperty","IntegerProperty","FloatProperty"];types.forEach(function(type){var TypeClass=PropertyParser[type];TypeClass.preset=function(defval){return new TypeClass({defval:defval});};});function hasPropertyInterface(obj){return hasInterface(obj,["marshal","unmarshal","validate"]);}function hasInterface(obj,methods){if(!obj){return false;}return(methods||[]).every(function(m){return obj[m] instanceof Function;});}if(DEBUG){var parser=new PropertyParser(),BooleanProperty=PropertyParser.BooleanProperty,IntegerProperty=PropertyParser.IntegerProperty,FloatProperty=PropertyParser.FloatProperty,StringProperty=PropertyParser.StringProperty,JsonProperty=PropertyParser.JsonProperty;var json={x:1,y:{x:"n+1"},z:true,m:3.14};var vp={bp1:"false",bp2:"true",bp3:"",dp1:"12",dp2:22,fp1:23.3,fp2:"3.14",sp1:"foobar",jp1:json,jp3:"transparent"};var defs={boolProp1:{key:"bp1",type:BooleanProperty.preset(false)},boolProp2:{key:"bp2",type:BooleanProperty.preset(false)},boolProp3:{key:"bp3",type:BooleanProperty.preset(false)},boolProp4:{key:"bp4",type:BooleanProperty.preset(false)},boolProp5:{key:"bp5",type:BooleanProperty.preset(true)},decimalProp1:{key:"dp1",type:IntegerProperty.preset(-1)},decimalProp2:{key:"dp2",type:IntegerProperty.preset(-1)},decimalPropn:{key:"dpn",type:IntegerProperty.preset(-1)},floatProp1:{key:"fp1",type:FloatProperty.preset(0)},floatProp2:{key:"fp2",type:FloatProperty.preset(0)},floatProp3:{key:"fp3",type:FloatProperty.preset(0.03)},stringProp1:{key:"sp1",type:StringProperty.preset("")},stringProp2:{key:"sp2",type:StringProperty.preset("string")},jsonProp1:{key:"jp1",type:JsonProperty.preset({})},jsonProp2:{key:"jp2",type:JsonProperty.preset({})},jsonProp3:{key:"jp3",type:JsonProperty.preset("error")}};var props=parser.parse(vp,defs);console.assert(Object.keys(props).length===Object.keys(defs).length,"wrong property count");console.assert(props.unmarshal instanceof Function,"unmarshal not found");console.assert(props.marshal instanceof Function,"marshal not found");console.assert(props.boolProp1===false);console.assert(props.boolProp2===true);console.assert(props.boolProp3===false);console.assert(props.boolProp4===false);console.assert(props.boolProp5===true);console.assert(props.marshal("boolProp5")==="true");props.unmarshal("boolProp5","false");console.assert(props.boolProp5===false);console.assert(props.marshal("boolProp5")==="false");console.assert(props.decimalProp1===12);console.assert(props.decimalProp2===22);console.assert(props.decimalPropn===-1);props.unmarshal("decimalProp1",42);console.assert(props.decimalProp1===42);console.assert(props.marshal("decimalProp1")==="42");console.assert(props.floatProp1===23.3);console.assert(props.marshal("floatProp1")==="23.3");console.assert(props.floatProp2===3.14);console.assert(props.floatProp3===0.03);props.unmarshal("floatProp3",100);console.assert(props.floatProp3===100);console.assert(props.stringProp1==="foobar");console.assert(props.stringProp2==="string");props.unmarshal("stringProp2","quux");console.assert(props.marshal("stringProp2")==="quux");props.unmarshal("stringProp2",42);console.assert(props.stringProp2==="42");console.assert(JSON.stringify(props.jsonProp1)===JSON.stringify(json));console.assert(Object.keys(props.jsonProp2).length===0);console.assert(props.jsonProp3==="transparent");console.assert(props.marshal("jsonProp1")===JSON.stringify(json).replace(/"/g,"'"));props.unmarshal("jsonProp2",true);console.assert(props.jsonProp2===true);console.assert(props.marshal("jsonProp2")==="true");console.info("PropertyParser: all tests processed");}}());