(function(){var isDebugging=false,log=function(msg){if(isDebugging){$U.visPrint(msg);}};mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.Base","mstrmojo.dom","mstrmojo.Container","mstrmojo.hash","mstrmojo.array","mstrmojo.netviz.VisNetworkStageScaleBar","mstrmojo.css","mstrmojo.netviz.ObservableModel","mstrmojo._HasPopup","mstrmojo.netviz._HasNetworkContextMenu","mstrmojo.VisEnum","mstrmojo.VisTooltip","mstrmojo.chart.enums.EnumFontStyle","mstrmojo.chart.enums.EnumLineStyle","mstrmojo.ui.PopupConfig","mstrmojo.VisUtility","mstrmojo.gm.GMUtility","mstrmojo.util.ui._LassoSelector","mstrmojo.netviz.Bitmap","mstrmojo.util.color","mstrmojo.ui.menus.MenuConfig");var $D=mstrmojo.dom,$P=$D.position,DRAG_MODE=mstrmojo.VisEnum.NETWORK_DRAG_MODE,OM=mstrmojo.netviz.ObservableModel,$CSS=mstrmojo.css,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$VIS_ENUM=mstrmojo.VisEnum,$U=mstrmojo.VisUtility,$GMU=mstrmojo.gm.GMUtility,$COLOR=mstrmojo.util.color,$CLR=mstrmojo.color;var LOCAL_PROPS=$VIS_ENUM.NETWORK_LOCAL_PROPS,FORM_NAME_DISPLAY_TYPE=$VIS_ENUM.FormNameDisplayType,FORCE_DIRECTED_LAYOUT_EDGE_CURVATURE=$VIS_ENUM.NETWORK_FORCE_DIRECTED_LAYOUT_EDGE_CURVATURE,ENUM_FONT_STYLE=mstrmojo.chart.enums.EnumFontStyle,LAYOUT_NAMES=$VIS_ENUM.NETWORK_LAYOUT;var actionTypes=["Select","Swipe","Multi","Tap",""],actionStateTypes=["Begin","End","Move","Cancel",""];var mouseEventTypes=["click","dblclick","drage","dragend","dragenter","dragleave","dragover","dragstart","drop","mousedown","mousemove","mouseup","mouseout","mouseover","mousewheel","scroll","contextmenu"];var broadcastTypes=["mousemove","mouseup"];var GESTURES_TYPES=[];$ARR.forEach(actionTypes,function(at){$ARR.forEach(actionStateTypes,function(ast){GESTURES_TYPES.push("touch"+at+ast);});});var TOOLTIP_AUTO_HIDE_DELAY=5*1000;var EDGE_SELFLOOP_RADIUS=6;var EDGE_SELFLOOP_OVERLAY_ANGLE=40*Math.PI/180;var ARROW_WING_MULTIPLIER=3,ARROW_ANGLE=30*Math.PI/180,ARROW_WING_SHORT_EDGE_MULTIPLIER_SQUARE=Math.pow(ARROW_WING_MULTIPLIER,2)+1-2*Math.cos(ARROW_ANGLE)*ARROW_WING_MULTIPLIER,ARROW_WING_OVERLAP_OFFSET_MULTIPLIER=Math.cos(ARROW_ANGLE)*ARROW_WING_MULTIPLIER,ARROW_POINT_TO_LINE_DISTANCE=Math.sin(ARROW_ANGLE)*ARROW_WING_MULTIPLIER;var TRANSITION_DURATION_DEFAULT=500;var SCALEBAR_LEFT=26,SCALEBAR_TOP=5,SCALEBAR_WIDTH=25,SCALEBAR_HEIGHT=350,ENUM_LAYER={EDGE:0,CIRCLE:1,HIGHLIGHT:2},ENUM_CANVAS={BASE:0,HIGHLIGHT:1};var BUBBLE_LABEL_FONT_STYLE={fontFamily:"Helvetica",fontSize:$U.psPt2CssPt("12pt",Math.round),fontStyle:ENUM_FONT_STYLE.FS_BOLD},BUBBLE_LABEL_FONT_LINE_WIDTH=4,BUBBLE_LABEL_MEASURE_WIDTH_BONUS=3,BUBBLE_LABEL_PADDING=5;(function(){var vendors=["ms","moz","webkit","o"],expectedTime=0,i,len=vendors.length;for(i=0;i<len&&!window.requestAnimationFrame;i+=1){window.requestAnimationFrame=window[vendors[i]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[vendors[i]+"CancelAnimationFrame"]||window[vendors[i]+"CancelRequestAnimationFrame"];}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(callback){var currentTime=new Date().getTime(),adjustedDelay=16-(currentTime-expectedTime),delay;if(adjustedDelay<0){expectedTime=currentTime;delay=0;}else{delay=adjustedDelay;}return setTimeout(function(){callback(expectedTime);},delay);};}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=clearTimeout;}}());function forEach(obj,method){if(typeof obj!=="object"){return ;}var keys=Object.keys(obj),i,len;for(i=0,len=keys.length;i<len;i++){method(keys[i]);}}function fsMaskToString(fs){var style=[];if(fs&ENUM_FONT_STYLE.FS_BOLD){style.push("bold");}if(fs&ENUM_FONT_STYLE.FS_ITALIC){style.push("italic");}return style.join(" ");}function fontStyleToString(ls){return[fsMaskToString(ls.fontStyle),ls.fontSize,ls.fontFamily].join(" ");}function getTextDecorationFromMask(fs){var deco=[];if(fs&ENUM_FONT_STYLE.FS_UNDERLINE){deco.push("underline");}if(fs&ENUM_FONT_STYLE.FS_STRIKETHROUGH){deco.push("line-through");}return deco.join(" ");}var getTextHeightFromCss=(function(){var cache={},reg=new RegExp("(\\d+)(p[xt])","i");return function measureTextHeightFromCSS(CSSString){var result,value,magnitude;if(cache.hasOwnProperty(CSSString)){return cache[CSSString];}result=reg.exec(CSSString);if(!result){return ;}value=parseInt(result[1],10);magnitude=result[2].toLowerCase();if(magnitude==="pt"){value*=96/72;}value=Math.ceil(value);cache[CSSString]=value;return value;};}());function deepCopy(dest,src){if(src instanceof Object){var keys=Object.keys(src),len=keys.length,i,key,value;for(i=0;i<len;i++){key=keys[i];value=src[key];if(!(value instanceof Object)){dest[key]=value;}else{if(!dest[key]){dest[key]={};}deepCopy(dest[key],value);}}}return dest;}function mergeObjects(dest){var len=arguments.length,i,obj;dest=$HASH.clone(dest||{});for(i=1;i<len;i++){obj=arguments[i];if(obj instanceof Object){deepCopy(dest,obj);}}return dest;}function getMouseButton(e){var button;if(e.which===undefined||e.which===null){button=(e.button<2)?0:((e.button===4)?1:2);}else{button=(e.which<2)?0:((e.which===2)?1:2);}return button;}function cancelTooltipDelayHide(tooltip){var id=tooltip._delayHideTimerId;if(id){clearTimeout(id);delete tooltip._delayHideTimerId;}}function requestTooltipDelayHide(tooltip){cancelTooltipDelayHide(tooltip);tooltip._delayHideTimerId=setTimeout(function(){tooltip.toggle(false);delete this._isTooltipShown;},TOOLTIP_AUTO_HIDE_DELAY);}function arrayKeys(arr){var rv=[],len,i;arr=arr||[];for(i=0,len=arr.length;i!==len;i++){rv.push(i);}return rv;}function showBubbleToolbarAndMenuItem(e){var CONFIG_ENUM_CORNERS=mstrmojo.ui.PopupConfig.ENUM_CORNERS,evt={pageX:e.pageX,pageY:e.pageY-6},stg=this,owner=stg.owner;owner.closePopup();var srcNode="";if(stg.selectedSprites[stg.selectedSprites.length-1].attSrc==="to"){srcNode="to";}else{srcNode="from";}stg.showContextMenu("bubble",stg.observableModel,evt,{alignment:{host:CONFIG_ENUM_CORNERS.TOP_LEFT,popup:CONFIG_ENUM_CORNERS.BOTTOM_LEFT,attSrc:srcNode}});var toolbar=stg._lastOpened;owner.showMenu(stg.owner.getFormatMenuConfig(),e);var menu=owner._lastOpened,_unlockHoverCheck=menu._unlockHoverCheck;menu._unlockHoverCheck=function(e,hWin){if(!$D.contains(toolbar.domNode,$D.eventTarget(hWin,e),true)){menu._unlockHoverCheck=_unlockHoverCheck;menu._unlockHoverCheck(e,hWin);}};}function getPointOnBezierCurve(t,p0,p1,p2){var s,tt,ss,st2;if(isNaN(t)||t<0||t>1){return{x:NaN,y:NaN};}s=1-t;ss=s*s;tt=t*t;st2=2*s*t;return{x:ss*p0.x+st2*p1.x+tt*p2.x,y:ss*p0.y+st2*p1.y+tt*p2.y};}var CE_LN_STYLE=mstrmojo.chart.enums.EnumLineStyle;function getOriginalThicknessAndStyle(combinedLineStyle){var thk=1,ceLnStyle=CE_LN_STYLE.LS_SOLID;if(combinedLineStyle){if(combinedLineStyle==="none"){ceLnStyle=CE_LN_STYLE.LS_NONE;}else{var w=parseInt(combinedLineStyle,10);if(!isNaN(w)){thk=w;}if(/dotted/.test(combinedLineStyle)){ceLnStyle=CE_LN_STYLE.LS_DOT;}else{if(/dashed/.test(combinedLineStyle)){ceLnStyle=CE_LN_STYLE.LS_DASH;}else{if(/solid/.test(combinedLineStyle)){ceLnStyle=CE_LN_STYLE.LS_SOLID;}}}}}return{ceLnStyle:ceLnStyle,thk:thk};}var Sprite=mstrmojo.declare(mstrmojo.Base,[],{scriptClass:"mstrmojo.netviz.VisNetworkStage.Sprite",init:function(e){this.zIndex=0;this.selectionState={};this.geometry={x:0,y:0,s:0};this.record();if(this._super){this._super(e);}var stage=this.stage,sprite=this,types=mouseEventTypes;var handler=function(e){var x=e.layerX,y=e.layerY,t=e.name;if(!stage.transitionTimer&&!stage.eventHasBeenHandled&&this["on"+t]&&(broadcastTypes.indexOf(t)!==-1||sprite.isHit(x,y))&&!this.isExcluded){sprite["on"+t](e);}};$ARR.forEach(types,function(type){stage.attachEventListenerForSprites(type,sprite,handler);});},updateZIndex:function(){var sc=this.stage&&this.stage.layers&&this.stage.layers[this.layerIndex];if(!(sc instanceof Array&&sc.length>0)){return ;}var len=sc.length,type=this.type,i,index,s;for(i=0;i<len;i++){s=sc[i];if(s.type===type){if(s!==this){index=sc.indexOf(this);this.zIndex=s.zIndex+1;s.zIndex=sc[i-1]?sc[i-1]-1:0;sc[index]=s;sc[i]=this;this.stylesChanged();}break;}}},stopPropagation:function(){this.stage.eventHasBeenHandled=true;},draw:function(){this.record();},record:function(){var g=this.getGeometry();this.oldGeometry=$HASH.clone(g);},drawStage:function(isUsingTransition,dontIgnore){this.stage.draw(isUsingTransition,dontIgnore);},stylesChanged:function(){this.hasStyleChanged=true;var stage=this.stage;if(stage){if(stage.onSpriteStyleChange&&stage.hasRendered){stage.onSpriteStyleChange(this.layerIndex);}}},highlight:function(){this.stage.addSpriteToLayer(this,ENUM_LAYER.HIGHLIGHT);},unHighlight:function(){var state=this.selectionState;if(!state.selected&&!state.hovered){this.stage.removeSpriteFromLayer(this,ENUM_LAYER.HIGHLIGHT);var originalIndex=this.type==="Circle"?ENUM_LAYER.CIRCLE:ENUM_LAYER.EDGE;this.stage.addSpriteToLayer(this,originalIndex);}},showTooltip:function(position){var tooltip=this.stage.tooltip;if(!this._isTooltipShown){this._isTooltipShown=true;tooltip.displayInfo(this.getTooltipInfo(),position);}else{tooltip.moveTo(position.x,position.y);}tooltip.toggle(true);requestTooltipDelayHide(tooltip);},hideTooltip:function(){var tooltip=this.stage.tooltip;cancelTooltipDelayHide(tooltip);tooltip.toggle(false);delete this._isTooltipShown;}});var CIRCLE_STYLES_DARK={normal:{color:{value:2212863,opacity:0.8},border:{color:{value:8487297,opacity:0.8},width:3,style:"2pt solid"}},hovered:{color:{opacity:0.5},highlightBorder:{color:{value:16777215,opacity:1},width:2,distance:3}},selected:{color:{opacity:1},selectionBorders:{inner:{color:{value:0,opacity:1},width:1},outer:{color:{value:16777215,opacity:1},width:2}}}};var CIRCLE_STYLES_LIGHT={normal:{color:{value:2062260,opacity:0.7},border:{color:{value:2062260,opacity:1},width:3,style:"1pt solid"}},hovered:{color:{opacity:0.35},fromNode:{color:{opacity:0.35}},toNode:{color:{opacity:0.35}},highlightBorder:{color:{value:0,opacity:1},width:2,distance:3}},selected:{color:{opacity:1},fromNode:{color:{opacity:1}},toNode:{color:{opacity:1}},selectionBorders:{inner:{color:{value:16777215,opacity:1},width:1},outer:{color:{value:0,opacity:1},width:2}}},selectedHovered:{color:{opacity:0.7},fromNode:{color:{opacity:0.7}},toNode:{color:{opacity:0.7}}}};function drawCircle(ctx,x,y,r,e,t){ctx.arc(x,y,r,e,t);}function drawSquare(ctx,x,y,r){ctx.rect(x-Math.sqrt(2)*r/2,y-Math.sqrt(2)*r/2,Math.sqrt(2)*r,Math.sqrt(2)*r);}function drawDiamond(ctx,x,y,r){ctx.moveTo(x,y-r);ctx.lineTo(x+r,y);ctx.lineTo(x,y+r);ctx.lineTo(x-r,y);ctx.lineTo(x,y-r);}function drawHexagon(ctx,x,y,r){ctx.moveTo(x,y-r);ctx.lineTo(x+r*Math.sqrt(3)/2,y-r/2);ctx.lineTo(x+r*Math.sqrt(3)/2,y+r/2);ctx.lineTo(x,y+r);ctx.lineTo(x-r*Math.sqrt(3)/2,y+r/2);ctx.lineTo(x-r*Math.sqrt(3)/2,y-r/2);ctx.lineTo(x,y-r);}function drawTriangle(ctx,x,y,r){ctx.moveTo(x,y-r);ctx.lineTo(x+r*Math.sqrt(3)/2,y+r/2);ctx.lineTo(x-r*Math.sqrt(3)/2,y+r/2);ctx.lineTo(x,y-r);}var shapes={Circle:drawCircle,Square:drawSquare,Diamond:drawDiamond,Hexagon:drawHexagon,Triangle:drawTriangle,Ring:drawCircle};function drawBorder(ctx,x,y,r,circleStyle,shapeType){if(!ctx||!r){return r;}circleStyle=circleStyle||{color:{value:0,opacity:1},width:1};var lineType=CE_LN_STYLE.LS_SOLID,distance=circleStyle.distance||0;if(circleStyle.style){var ls=getOriginalThicknessAndStyle(circleStyle.style);lineType=ls.ceLnStyle;circleStyle.width=ls.thk+1;}r+=distance;var w=circleStyle.width,cc=circleStyle.color,c=$COLOR.getCSSColorString(cc.value,cc.opacity);if(lineType===CE_LN_STYLE.LS_NONE){return r;}ctx.save();var br=r+w*0.5,angle=Math.PI*2;ctx.strokeStyle=c;ctx.lineWidth=w;ctx.beginPath();if(lineType===CE_LN_STYLE.LS_SOLID){shapes[shapeType](ctx,x,y,br,0,angle,true);}else{var dashLen=lineType===CE_LN_STYLE.LS_DASH?0.5:0.2;var n=br/dashLen,alpha=Math.PI*2/n,points=[],i=-1,theta,theta2,x1=(Math.cos(alpha)*br)+x,y1=(Math.sin(alpha)*br)+y,ex=(Math.cos(2*alpha)*br)+x,ey=(Math.sin(2*alpha)*br)+y,len=Math.sqrt(Math.pow(x1-ex,2)+Math.pow(y1-ey,2));if(shapeType==="Ring"||shapeType==="Circle"){while(i<n){theta=alpha*i;theta2=alpha*(i+1);points.push({x:(Math.cos(theta)*br)+x,y:(Math.sin(theta)*br)+y,ex:(Math.cos(theta2)*br)+x,ey:(Math.sin(theta2)*br)+y});i+=2;}$ARR.forEach(points,function(p){ctx.moveTo(p.x,p.y);ctx.lineTo(p.ex,p.ey);});}else{ctx.setLineDash([len,len]);ctx.lineWidth=2;shapes[shapeType](ctx,x,y,r);}}ctx.stroke();ctx.closePath();ctx.restore();return r+w;}function fillCircle(ctx,color,position,radius,shapeType){var x=position.x,y=position.y,hor=0,vor=0,cv=color.value;if($COLOR.isGradientColor(cv)){hor=cv.or;vor=1-hor;}ctx.save();ctx.fillStyle=$COLOR.createCanvasFillPattern(color,ctx,x-radius*hor,y-radius*vor,x+radius*hor,y+radius*vor);ctx.beginPath();if(shapeType==="Ring"){ctx.lineWidth=radius*0.3;ctx.strokeStyle=ctx.fillStyle;drawCircle(ctx,position.x,position.y,radius*0.85,0,2*Math.PI,true);ctx.stroke();}else{shapes[shapeType](ctx,position.x,position.y,radius,0,2*Math.PI,true);}ctx.closePath();if(shapeType!=="Ring"){ctx.fill();}ctx.restore();}var CIRCLE_STYLES={dark:CIRCLE_STYLES_DARK,light:CIRCLE_STYLES_LIGHT},LABEL_COLORS={dark:{stroke:{value:"#1f1f1f",opacity:1},fill:{value:"#ffffff",opacity:1}},light:{stroke:{value:"#ffffff",opacity:1},fill:{value:"#000000",opacity:1}}};var CircleSprite=mstrmojo.declare(Sprite,[],{scriptClass:"mstrmojo.netviz.VisNetworkStage.CircleSprite",init:function(config){this.position={x:0,y:0,r:0};this.style=null;if(this._super){this._super(config);}var p=this.position;p.x=isNaN(p.x)||Math.abs(p.x)===Infinity?0:p.x;p.y=isNaN(p.y)||Math.abs(p.y)===Infinity?0:p.y;p.r=isNaN(p.r)||Math.abs(p.r)===Infinity?0:p.r;this.updateTextSize();},getTooltipInfo:function(){var info=this.getTooltipAttrInfo();if(this.aggregationName){info.push({n:this.aggregationName,v:this.displayValue});}return info;},getTooltipAttrInfo:function(attributeName){var fndType=this.stage.owner.abstractedModel.formNameDisplayType,fs=this.forms,fvs=this.formValues,title=attributeName||this.title,info;if(fndType===FORM_NAME_DISPLAY_TYPE.OFF||this.selfLoop){info=[{n:title,v:this.text}];}else{info=fs.map(function(f,i){return{n:f,v:fvs[i]};});}return info;},onclick:function(){this.stopPropagation();},onmousedown:function(e){e=e.e||e;var src=e.srcElement||e.target,stg=this.stage,lasso=stg&&stg.lassoSelector;this.stopPropagation();if(!(getMouseButton(e)===2&&src===lasso)){this.stage.dismissLassoSelector();}if(stg.dragMode===DRAG_MODE.select){stg.lassoSelectorEnabled=false;}this._isMouseDown=true;this._selectionState=$HASH.clone(this.selectionState);this._lastMousePosition={x:e.pageX,y:e.pageY};},onmousemove:function(e){var i,len,g;var x=e.layerX,y=e.layerY,stg=this.stage,mustRepaint=false;e=e.e||e;if(this._isMouseDown&&getMouseButton(window.event||e)===0){var lp=this._lastMousePosition,dx=e.pageX-lp.x,dy=e.pageY-lp.y;this._lastMousePosition={x:e.pageX,y:e.pageY};this.stopPropagation();if(dx!==0||dy!==0){if(!this._dragged){stg.onSpriteStyleChange(ENUM_LAYER.EDGE);stg.onSpriteStyleChange(ENUM_LAYER.CIRCLE);}this._dragged=true;if(!this.selectionState.selected){if(!(e.ctrlKey||e.metaKey)){stg.clearSelection();}stg.addToSelection(this);mustRepaint=true;stg.owner.doSelection();}var ss=this.stage.selectedSprites,layout=this.stage.currentLayout;$ARR.forEach(ss,function(sprite){g=sprite.getGeometry();g.x+=dx;g.y+=dy;sprite.setGeometry(g);if(layout===LAYOUT_NAMES.LINEAR||layout===LAYOUT_NAMES.FORCE_DIRECTED){$ARR.forEach(sprite.unit.edges,function(edge){var fg=edge.from.sprite.getGeometry(),tg=edge.to.sprite.getGeometry(),curvature,geo;if(layout===LAYOUT_NAMES.LINEAR){geo={x:(fg.x+tg.x)*0.5-(tg.y-fg.y)*0.5,y:(fg.y+tg.y)*0.5+(tg.x-fg.x)*0.5};}else{if(layout===LAYOUT_NAMES.FORCE_DIRECTED){curvature=FORCE_DIRECTED_LAYOUT_EDGE_CURVATURE[edge.reversedEdge?1:0];geo={x:(fg.x+tg.x)*0.5+(fg.y-tg.y)*curvature,y:(fg.y+tg.y)*0.5+(tg.x-fg.x)*curvature};}}edge.sprite.setGeometry(geo);});}});this.drawStage(false,mustRepaint);}}else{var sprites,s,hit=this.isHit(x,y);if(hit){this.stopPropagation();}if(this._hoverHighlighted){if(!hit){sprites=this.getInvolvedSprites();len=sprites.length;for(i=0;i<len;i++){s=sprites[i];sprites[i].unHoverHighlight();}delete this._hoverHighlighted;this.hideTooltip();if(stg._pendingRefresh){stg.onSpriteStyleChange(ENUM_LAYER.CIRCLE);stg.onSpriteStyleChange(ENUM_LAYER.EDGE);}mustRepaint=true;if(stg._pendingRefresh){delete stg._pendingRefresh;}}}else{if(hit){sprites=this.getInvolvedSprites();len=sprites.length;for(i=0;i<len;i++){s=sprites[i];s.hoverHighlight();}this._hoverHighlighted=true;mustRepaint=true;}}if(stg.selectedSprites.length>0){stg.onSpriteStyleChange(ENUM_LAYER.HIGHLIGHT);}this.drawStage(false,mustRepaint);}if(this._hoverHighlighted){this.showTooltip({x:e.clientX,y:e.clientY});}},onmouseup:function(e){var stg=this.stage;e=e.e||e;if(this._isMouseDown){this.stopPropagation();if(!this._dragged){if(e.button===0){this.clickHandler(e);}}stg._bubbleToolbarPos=e;stg._pendingRefresh=true;delete this._selectionState;delete this._isMouseDown;delete this._lastMousePosition;delete this._dragged;}},clickHandler:function(e,dontRemoveSelection){e=e.e||e;var isInList=this.selectionState.selected,ctrlKey=e.ctrlKey||e.metaKey,stg=this.stage,isMultipleSelected=stg.selectedSprites.length>1,isClearAllEnabled=stg.isClearAllEnabled(this);if(isInList&&!isMultipleSelected){if(!dontRemoveSelection&&isClearAllEnabled){stg.clearSelection();}}if((isInList&&!ctrlKey&&isMultipleSelected&&!dontRemoveSelection)||(!isInList&&!ctrlKey)){stg.clearSelection();stg.addToSelection(this);}if(!isInList&&ctrlKey){stg.addToSelection(this);}if(isInList&&ctrlKey&&isMultipleSelected){if(!dontRemoveSelection){stg.removeFromSelection(this);}}this.drawStage(false,true);stg.owner.doSelection();},oncontextmenu:function oncontextmenu(evt){var stg=this.stage,owner=stg.owner,e=evt.e||evt;evt.preventDefault();evt.cancel();this.stopPropagation();this.clickHandler(e,true);if(this._isMouseDown){delete this._selectionState;delete this._isMouseDown;delete this._lastMousePosition;delete this._dragged;}if(stg.isOnFormattingMode){showBubbleToolbarAndMenuItem.call(stg,e);}else{owner.showSelectionMenu(e,function(){showBubbleToolbarAndMenuItem.call(stg,e);$U.selectPropertyPanel(owner,"de");});}this.hideTooltip();return false;},getInvolvedSprites:function(){var ret=[],edge;ret.push(this);var node=this.unit;if(node){var edges=node.edges,len=edges.length,i;for(i=0;i<len;i++){edge=edges[i];ret.push(edge.sprite);if(edge.from===node){ret.push(edge.to.sprite);}else{ret.push(edge.from.sprite);}}}return ret;},touchSwipeMove:function(touch){var x=touch.layerX,y=touch.layerY,g=this.getGeometry();g.x=x;g.y=y;this.setGeometry(g);this.drawStage(false);},hoverHighlight:function(){if(!this.selectionState.hovered){this.selectionState.hovered=true;this.highlight();}},unHoverHighlight:function(){if(this.selectionState.hovered){this.selectionState.hovered=false;this.unHighlight();}},getStyle:function(){var state=this.selectionState,stage=this.stage,styles=this.stage.themeType==="dark"?stage.circleStyle.dark:stage.circleStyle.light;return mergeObjects(styles.normal,state.hovered&&styles.hovered,state.selected&&styles.selected,state.hovered&&state.selected&&styles.selectedHovered);},getLabelBoundingBox:function(){var size=this.textSize,stg=this.stage,rotate=(stg.currentLayout===LAYOUT_NAMES.LINEAR),center=this.position,x=center.x,y=center.y,w,h,halfw,halfh;if(rotate){w=size.height;h=size.width;}else{w=size.width;h=size.height;}halfw=(w+BUBBLE_LABEL_PADDING)/2;halfh=(h+BUBBLE_LABEL_PADDING)/2;return{top:y-halfh,left:x-halfw,bottom:y+halfh,right:x+halfw};},isShowLabel:function isShowLabel(){var stg=this.stage,showNodeLabel=stg.circleStyle.showNodeLabel||(this.selectionState.hovered&&!this._hoverHighlighted),show=!stg.transitionTimer&&showNodeLabel,box=this.getLabelBoundingBox(),bitmap=stg.labelBitmap,noOverlap;if(show){noOverlap=bitmap&&bitmap.testZeros(box);if(noOverlap){bitmap.set(box);}}return show&&noOverlap;},draw:function drawCircle(showFakeOpacity,attSrc){if(this.isExcluded){return ;}this._super();var stage=this.stage,canvas=this.getCanvas(),backgroundColor=stage.background;if(!canvas){log("cannot find the corresponding canvas.");return ;}var ctx=canvas.getContext("2d"),p=this.position,r=p.r>1?p.r:1,style=this.getStyle(),c;var shapeType,borders=[];function fn(pt){shapeType=style[pt+"Node"].shape;c=style[pt+"Node"].color;if(!style.selectionBorders){borders.push(style[pt+"Node"].border);}return borders;}borders=fn(attSrc);if(showFakeOpacity){c=$COLOR.mix(c,backgroundColor);}fillCircle(ctx,c,p,r,shapeType);if(style.selectionBorders){borders.push(style.selectionBorders.inner);borders.push(style.selectionBorders.outer);}if(style.highlightBorder){borders.push(style.highlightBorder);}$ARR.forEach(borders,function(b){if(showFakeOpacity){b.color=$COLOR.mix(b.color,backgroundColor);}r=drawBorder(ctx,p.x,p.y,r,b,shapeType);});if(stage.onDraw){stage.onDraw(this);}this.drawText();},drawText:function(){function drawTextDecoration(ctx,fs,centerPos){function drawLineAtOffset(ctx,offset,width){var left=offset.x,top=offset.y,lineWidth=fs&ENUM_FONT_STYLE.FS_BOLD?2:1;ctx.save();ctx.lineWidth=1;ctx.strokeRect(left-1,top-1,width+2,lineWidth+2);ctx.fillRect(left,top,width,lineWidth);ctx.restore();}var size=this.textSize,w=size.width,left=centerPos.x-w/2;if(fs&ENUM_FONT_STYLE.FS_UNDERLINE){drawLineAtOffset(ctx,{x:left,y:centerPos.y+size.height/2},w);}if(fs&ENUM_FONT_STYLE.FS_STRIKETHROUGH){drawLineAtOffset(ctx,{x:left,y:centerPos.y},w);}}var stage=this.stage,canvas=this.getCanvas(),ctx=canvas.getContext("2d"),p=this.position,tp=p,labelStyle=this.stage.circleLabelStyle,labelColors=labelStyle.fontColor,fs=labelStyle.fontStyle;if(!this.isShowLabel()){this.hasDrawnLabel=false;return ;}ctx.save();ctx.font=fontStyleToString(labelStyle);ctx.lineWidth=BUBBLE_LABEL_FONT_LINE_WIDTH;ctx.fillStyle=$COLOR.getCSSColorString(labelColors.fill.value,labelColors.fill.opacity);ctx.strokeStyle=$COLOR.getCSSColorString(labelColors.stroke.value,labelColors.stroke.opacity);ctx.lineJoin="round";ctx.textBaseline="middle";ctx.textAlign="center";if(stage.currentLayout===LAYOUT_NAMES.LINEAR){ctx.translate(p.x,p.y);ctx.rotate(-Math.PI/2);tp={x:0,y:0};}ctx.strokeText(this.text,tp.x,tp.y);ctx.fillText(this.text,tp.x,tp.y);drawTextDecoration.call(this,ctx,fs,tp);ctx.restore();this.hasDrawnLabel=true;},isHit:function(x,y){var p=this.position,dx=p.x-x,dy=p.y-y,r=p.r,d=dx*dx+dy*dy;return(d<=r*r);},setGeometry:function(geometry){if(geometry){var x=geometry.x,y=geometry.y,s=geometry.s,p=this.position,c=false,edges;if(!isNaN(x)&&Math.abs(x)!==Infinity){if(x!==p.x){c=true;p.x=x;}}if(!isNaN(y)&&Math.abs(y)!==Infinity){if(y!==p.y){c=true;p.y=y;}}if(!isNaN(s)&&Math.abs(s)!==Infinity){if(s!==p.r){c=true;p.r=s;}}if(c){this.stylesChanged();edges=this.unit&&this.unit.edges;$ARR.forEach(edges,function(edge){edge=edge.sprite;edge.stylesChanged(true);});}}},getGeometry:function(){var p=this.position,g=this.geometry;g.x=p.x;g.y=p.y;g.s=p.r;return g;},getBorderWidth:function(){var i,len,style=this.getStyle(),borders=[],ls,width=0;if(style.selectionBorders){borders.push(style.selectionBorders.inner);borders.push(style.selectionBorders.outer);}else{if($U.getPropertyByPath(style,"fromNode.border",false)===false&&$U.getPropertyByPath(style,"toNode.border",false)===false){borders.push(style.border);}else{borders.push(style.fromNode.border);borders.push(style.toNode.border);}}for(i=0,len=borders.length;i!==len;i++){style=borders[i];if(style.style){ls=getOriginalThicknessAndStyle(style.style);width+=ls.thk+1;}else{width+=style.width||1;}}return width;},updateTextSize:function(){var txt=this.text,ls=this.stage.circleLabelStyle,h=getTextHeightFromCss(ls.fontSize),w=$U.measureTextWidth(txt,{fontSize:ls.fontSize,fontFamily:ls.fontFamily,fontStyle:fsMaskToString(ls.fontStyle)},BUBBLE_LABEL_MEASURE_WIDTH_BONUS);this.textSize={width:w,height:h};}});var EDGE_STYLES_DARK={hovered:"white"};var EDGE_STYLES_LIGHT={hovered:"black"};function updateSelfLoopStartEnd(desc){var start=desc.start,end=desc.end,tmp,swapped=false;if(start>end){tmp=start;start=end;end=tmp;swapped=!swapped;}if(start<=Math.PI&&end>start+Math.PI){tmp=start;start=end;end=tmp;swapped=!swapped;}if(swapped){tmp=desc.p1;desc.p1=desc.p2;desc.p2=tmp;}desc.start=start;desc.end=end;}function pointToArcAngle(center,p){var dx=p.x-center.x,dy=p.y-center.y,theta=Math.acos(dx/Math.sqrt(dx*dx+dy*dy));if(dy>=0){return theta;}return 2*Math.PI-theta;}function findSelfLoopKeyPoints(gc,cc,cr,lr,angle){var isNearZero=$U.isNearZero,ang=angle/2,segLen=lr*Math.cos(ang)+Math.sqrt(cr*cr-lr*lr*Math.pow(Math.sin(ang),2)),dx=cc.x-gc.x,dy=cc.y-gc.y,bevel,ldx,ldy,center,alpha,beta,theta1,theta2,signx,p1,p2;bevel=Math.sqrt(dx*dx+dy*dy);ldx=dx*segLen/bevel;ldy=dy*segLen/bevel;alpha=Math.acos((cr*cr+segLen*segLen-lr*lr)/(2*cr*segLen));beta=ldy/segLen;if(isNearZero(Math.abs(ldy)-Math.abs(segLen))){if(ldy<0){beta=-1;}else{if(ldy>0){beta=1;}}}beta=Math.asin(beta);theta1=beta+alpha;theta2=beta-alpha;signx=dx/Math.abs(dx);center={x:cc.x+ldx,y:cc.y+ldy};if(isNaN(signx)){p1={x:cc.x+cr*Math.cos(theta1),y:cc.y+cr*Math.sin(theta1)};p2={x:cc.x+cr*Math.cos(theta2),y:cc.y+cr*Math.sin(theta2)};}else{p1={x:cc.x+cr*Math.abs(Math.cos(theta1))*signx,y:cc.y+cr*Math.sin(theta1)};p2={x:cc.x+cr*Math.abs(Math.cos(theta2))*signx,y:cc.y+cr*Math.sin(theta2)};}return{center:center,p1:p1,p2:p2};}function describeSelfLoop(){var sprite=this,stage=this.stage,layout=stage.currentLayout,p=sprite.from.position,graphCenter;var width=sprite.width>1?sprite.width:1,r=p.r+sprite.from.getBorderWidth()/2,loopr=EDGE_SELFLOOP_RADIUS+width/2;if(layout===LAYOUT_NAMES.CIRCULAR){graphCenter=stage.graphCenter;}else{if(layout===LAYOUT_NAMES.FORCE_DIRECTED){graphCenter=stage.findForceDirectedGraphCenter(sprite.from);}else{graphCenter=stage.findLinearLayoutGraphCenter(sprite.from);}}var points=findSelfLoopKeyPoints(graphCenter,p,r,loopr,EDGE_SELFLOOP_OVERLAY_ANGLE);var start=pointToArcAngle(points.center,points.p1);var end=pointToArcAngle(points.center,points.p2);var desc=points;desc.start=start;desc.end=end;desc.r=loopr;updateSelfLoopStartEnd(desc);return desc;}function isHitSelfLoop(testPoint){var edge=this,desc=describeSelfLoop.call(edge),dx,dy,d,start=desc.start,end=desc.end,threshold=Math.max(edge.width,1),angle;if(isNaN(desc.center.x)||isNaN(desc.center.y)){return false;}dx=testPoint.x-desc.center.x;dy=testPoint.y-desc.center.y;d=Math.sqrt(dx*dx+dy*dy)-EDGE_SELFLOOP_RADIUS;if(d<0||d>threshold){return false;}angle=pointToArcAngle(desc.center,testPoint);if(start<end){return angle<=start||angle>=end;}if(start>end){return end<=angle&&angle<=start;}return true;}function drawArrow(desc,color,ctx){ctx.save();ctx.fillStyle=color;ctx.lineWidth=desc.width;ctx.lineJoin="round";ctx.lineCap="round";ctx.miterLimit=0;ctx.beginPath();ctx.moveTo(desc.tip.x,desc.tip.y);ctx.lineTo(desc.wing1.x,desc.wing1.y);ctx.lineTo(desc.crossing1.x,desc.crossing1.y);ctx.lineTo(desc.crossing2.x,desc.crossing2.y);ctx.lineTo(desc.wing2.x,desc.wing2.y);ctx.closePath();ctx.fill();ctx.restore();}function getLinePoint(start,end,offset){var dx=end.x-start.x,dy=end.y-start.y,isNearZero=$U.isNearZero,dxZero=isNearZero(dx),dyZero=isNearZero(dy),sign,k,c,x,y;if(dxZero&&dyZero){return{x:end.x,y:end.y};}if(dxZero){return{x:end.x,y:end.y-(dy>0?offset:-offset)};}if(dyZero){return{x:end.x-(dx>0?offset:-offset),y:end.y};}k=dx/dy;sign=dy>0?-1:1;c=Math.sqrt(offset*offset/(k*k+1));y=end.y+sign*c;x=end.x+k*(y-end.y);return{x:x,y:y};}function getLineFormula(cp,center,crossing){var dx=center.x-cp.x,dy=center.y-cp.y,isNearZero=$U.isNearZero,dxZero=isNearZero(dx),dyZero=isNearZero(dy),k;if(dxZero&&dyZero){return{a:crossing.y/crossing.x,b:-1,c:0};}if(dxZero){return{a:0,b:1,c:-crossing.y};}if(dyZero){return{a:1,b:0,c:-crossing.x};}k=dx/dy;return{a:-dx,b:-dy,c:(crossing.x*k+crossing.y)*dy};}function getWingPoints(line,inner,outer,width){var a=line.a,b=line.b,c=line.c,isNearZero=$U.isNearZero,aZero=isNearZero(a),bZero=isNearZero(b);if(aZero||bZero){var offset=ARROW_WING_OVERLAP_OFFSET_MULTIPLIER*width,mid=getLinePoint(inner,outer,offset),w=ARROW_POINT_TO_LINE_DISTANCE*width;if(aZero&&bZero){return[{x:outer.x,y:outer.y},{x:outer.x,y:outer.y}];}if(aZero){return[{x:mid.x+w,y:mid.y},{x:mid.x-w,y:mid.y}];}if(bZero){return[{x:mid.x,y:mid.y+w},{x:mid.x,y:mid.y-w}];}}var a2=a*a,x0=inner.x,y0=inner.y,c1=Math.sqrt(a*a+b*b),c2=ARROW_POINT_TO_LINE_DISTANCE*width*c1,c3=ARROW_WING_SHORT_EDGE_MULTIPLIER_SQUARE*width*width,c4=c2-c,c5=a*a+b*b,c6=2*(x0*a*b-b*c4-a2*y0),c7=c4*c4+a2*x0*x0-2*x0*a*c4+a2*y0*y0-c3*a2,c8=Math.sqrt(c6*c6-4*c5*c7),c9=2*c5,y1=(-c6+c8)/c9,y2=(-c6-c8)/c9,x1=(c4-b*y1)/a,x2=(c4-b*y2)/a;return[{x:x1,y:y1},{x:x2,y:y2}];}function describeArrow(cp,center,radius,width){var outer=getLinePoint(cp,center,radius),inner=getLinePoint(cp,center,radius+width),bisector=getLineFormula(cp,center,inner),wing=getWingPoints(bisector,inner,outer,width),offset=ARROW_WING_SHORT_EDGE_MULTIPLIER_SQUARE*width/3,crossing1=getLinePoint(inner,wing[0],offset),crossing2=getLinePoint(inner,wing[1],offset);return{tip:outer,inner:inner,wing1:wing[0],wing2:wing[1],crossing1:crossing1,crossing2:crossing2,width:width};}function isPointsOnSameLine(ab,mn,xy){var a=ab.x,b=ab.y,m=mn.x,n=mn.y,x=xy.x,y=xy.y;return $U.isNearZero(a*(n-y)+m*(y-b)+x*(b-n));}var EdgeSprite=mstrmojo.declare(Sprite,[],{scriptClass:"mstrmojo.netviz.VisNetworkStage.EdgeSprite",init:function(config){this.controlPoint={x:0,y:0};if(this._super){this._super(config);}},getTooltipInfo:function(){function getInfo(sprite){var unit=sprite.unit;return[].concat(sprite.from.getTooltipAttrInfo(fromName),sprite.to.getTooltipAttrInfo(toName),unit.values.map(function(v,i){return{n:v.metricName,v:unit.format(v.value,i)};}));}var info,reversedEdgeUnit=this.unit.reversedEdge,isCircular=this.stage.currentLayout===LAYOUT_NAMES.CIRCULAR,model=this.stage.owner.abstractedModel||{},indexes=model.indexes,attributes=model.attributes,fromName,toName;if(indexes&&attributes){fromName=(attributes[indexes.fromIndex]||{}).name;toName=(attributes[indexes.toIndex]||{}).name;}info=getInfo(this);if(isCircular&&reversedEdgeUnit){info=info.concat(null,getInfo(reversedEdgeUnit.sprite));}return info;},onmousemove:function(e){var x=e.layerX,y=e.layerY,isHit=this.isHit(x,y),stg=this.stage,hoverChanged=false;e=e.e||e;if(this.selectionState.hovered&&!isHit){this.unHoverHighlight();this.hideTooltip();delete stg._isEdgeHovered;if(stg._pendingRefresh){stg.onSpriteStyleChange(ENUM_LAYER.CIRCLE);stg.onSpriteStyleChange(ENUM_LAYER.EDGE);}hoverChanged=true;}else{if(!this.selectionState.hovered&&isHit){this.stopPropagation();this.hoverHighlight();stg._isEdgeHovered=true;hoverChanged=true;}}if(hoverChanged){if(stg.selectedSprites.length>0){stg.onSpriteStyleChange(ENUM_LAYER.HIGHLIGHT);}stg.draw(false,true);if(!this.selectionState.hovered){delete stg._pendingRefresh;}}if(this.selectionState.hovered){this.stopPropagation();this.showTooltip({x:e.clientX,y:e.clientY});}},oncontextmenu:function(e){e=e.e||e;this.stopPropagation();var cfg=new mstrmojo.ui.menus.MenuConfig(),stage=this.stage,nv=stage.owner,colorByMetric=nv.getColorByMetric();if(colorByMetric){cfg.addMenuItem(mstrmojo.desc(13174,"Select color ranges..."),"",function(){nv.model.openThresholdEditor(colorByMetric,true,false);});}var m=nv.observableModel.showEdgeDirection,isChecked=m.getValue();cfg.addMenuItem(mstrmojo.desc(12080,"Show Edge Direction"),isChecked?"on":"",function(){m.setValue(!isChecked);});nv.showMenu(cfg,e);},hoverHighlight:function(){this.selectionState.hovered=true;if(this.from){this.from.hoverHighlight();}if(this.to){this.to.hoverHighlight();}this.highlight();},unHoverHighlight:function(){this.selectionState.hovered=false;if(this.from){this.from.unHoverHighlight();}if(this.to){this.to.unHoverHighlight();}this.unHighlight();},getEndPoint:function(){var stg=this.stage,showEdgeDir=stg.showEdgeDirection,sprite=this,toSprite=sprite.to,toPos=toSprite.getGeometry(),newPos=toPos,cp=sprite.controlPoint,width=sprite.width>1?sprite.width:1,arrowWidth=width<4?4:width,arrowDesc,pos;if(showEdgeDir){arrowDesc=sprite.arrow||describeArrow(cp,toPos,toPos.s+toSprite.getBorderWidth(),arrowWidth);pos={x:(arrowDesc.crossing1.x+arrowDesc.crossing2.x)/2,y:(arrowDesc.crossing1.y+arrowDesc.crossing2.y)/2};newPos=getLinePoint(toPos,pos,0.15);if(!sprite.arrow){sprite.arrow=arrowDesc;}}return{pos:newPos,arrow:arrowDesc};},draw:function drawEdge(){if(this.isExcluded){return ;}var stage=this.stage,isCircular=stage.currentLayout===LAYOUT_NAMES.CIRCULAR,unit=this.unit,reversedEdge,sprite=this,canvas=this.getCanvas(),ctx=canvas.getContext("2d"),toSprite=sprite.to,p1=sprite.from.position,p2=toSprite.position,cp=sprite.controlPoint,width=sprite.width>1?sprite.width:1,state=sprite.selectionState,strokeStyle,desc,curveEndPt,startArrowDesc,endArrowDesc,start=p1,end;if(isCircular&&this.skipBidirectional){return ;}if(state.hovered||state.selected){strokeStyle=this.stage.themeType==="dark"?EDGE_STYLES_DARK.hovered:EDGE_STYLES_LIGHT.hovered;}else{strokeStyle=sprite.color;}ctx.strokeStyle=strokeStyle;ctx.lineWidth=width;if(p1===p2){desc=describeSelfLoop.call(this);ctx.beginPath();ctx.arc(desc.center.x,desc.center.y,desc.r,desc.start,desc.end,true);ctx.stroke();}else{curveEndPt=this.getEndPoint();end=curveEndPt.pos;endArrowDesc=curveEndPt.arrow;reversedEdge=unit.reversedEdge;if(isCircular&&reversedEdge){reversedEdge=reversedEdge.sprite;reversedEdge.skipBidirectional=true;sprite.skipBidirectional=false;curveEndPt=reversedEdge.getEndPoint();start=curveEndPt.pos;startArrowDesc=curveEndPt.arrow;}ctx.beginPath();ctx.moveTo(start.x,start.y);if(isPointsOnSameLine(start,cp,end)){ctx.lineTo(end.x,end.y);}else{ctx.quadraticCurveTo(cp.x,cp.y,end.x,end.y);}ctx.stroke();}if(startArrowDesc){drawArrow(startArrowDesc,ctx.strokeStyle,ctx);}if(endArrowDesc){drawArrow(endArrowDesc,ctx.strokeStyle,ctx);}if(stage.onDraw){stage.onDraw(this);}this._super();},isHit:function(x,y){var THRESHHOLD=Math.max(1,this.width/2),p1=this.controlPoint,p2=this.to.position,p0=this.from.position,ax=p0.x-2*p1.x+p2.x,bx=2*(p1.x-p0.x),cx=p0.x-x,deltx=bx*bx-4*ax*cx,ay=p0.y-2*p1.y+p2.y,by=2*(p1.y-p0.y),cy=p0.y-y,delty=by*by-4*ay*cy,d;function getDistance(p1,p2){return Math.sqrt(Math.pow((p1.x-p2.x),2)+Math.pow((p1.y-p2.y),2));}if(this.from===this.to){return isHitSelfLoop.call(this,{x:x,y:y});}var T=[];var t,t1,t2;if(ax===0){if(bx!==0){t=(x-p0.x)/(2*(p1.x-p0.x));}else{t=0;}T.push(t);}else{if(deltx>=0){t1=(Math.sqrt(deltx)-bx)/(2*ax);t2=(-1*Math.sqrt(deltx)-bx)/(2*ax);T.push(t1);T.push(t2);}}if(ay===0){if(by!==0){t=(y-p0.y)/(2*(p1.y-p0.y));}else{t=0;}T.push(t);}else{if(delty>=0){t1=(Math.sqrt(delty)-by)/(2*ay);t2=(-1*Math.sqrt(delty)-by)/(2*ay);T.push(t1);T.push(t2);}}var i,bp;for(i=0;i<T.length;i++){bp=getPointOnBezierCurve(T[i],p0,p1,p2);d=getDistance({x:x,y:y},bp);if(d<=THRESHHOLD){return true;}}return false;},getGeometry:function(){var cp=this.controlPoint,g=this.geometry;g.x=cp.x;g.y=cp.y;g.s=this.width;return g;},setGeometry:function(geometry){if(geometry){var x=geometry.x,y=geometry.y,s=geometry.s,cp=this.controlPoint,c=false;if(!isNaN(x)&&Math.abs(x)!==Infinity){if(x!==cp.x){cp.x=x;c=true;}}if(!isNaN(y)&&Math.abs(y)!==Infinity){if(y!==cp.y){cp.y=y;c=true;}}if(!isNaN(s)&&Math.abs(s)!==Infinity){if(s!==this.width){this.width=s;c=true;}}if(c){this.stylesChanged();}}},stylesChanged:function(clearArrowCache){if(this._super){this._super();}if(clearArrowCache){this.arrow=undefined;}}});function generateObservableModel(){function initCircleStyleModel(){var circleStyle=this.circleStyle,theme=this.themeType==="dark"?circleStyle.dark:circleStyle.light,style=$HASH.clone(theme.normal),cv=$U.getPropertyByPath(style,"color.value",false)!==false?$COLOR.getCSSColorString(style.color.value):undefined,bcv=$U.getPropertyByPath(style,"border.color.value",false)!==false?$COLOR.getCSSColorString(style.border.color.value):undefined,sfcv=$U.getPropertyByPath(style,"fromNode.color.value",false),stcv=$U.getPropertyByPath(style,"toNode.color.value",false),sfbcv=$U.getPropertyByPath(style,"fromNode.border.color.value",false),stbcv=$U.getPropertyByPath(style,"toNode.border.color.value",false),fcv=sfcv===false?cv:sfcv,tcv=stcv===false?cv:stcv,fbcv=sfbcv===false?bcv:sfbcv,tbcv=stbcv===false?bcv:stbcv;style={fromNode:{border:$U.getPropertyByPath(style,"fromNode.border",false)!==false?style.fromNode.border:style.border,color:$U.getPropertyByPath(style,"fromNode.color",false)!==false?style.fromNode.color:style.color,shape:style.fromNode!==undefined?style.fromNode.shape:"Circle"},toNode:{border:$U.getPropertyByPath(style,"toNode.border",false)!==false?style.toNode.border:style.border,color:$U.getPropertyByPath(style,"toNode.color",false)!==false?style.toNode.color:style.color,shape:style.toNode!==undefined?style.toNode.shape:"Circle"}};style.fromNode.border.color.value=$COLOR.getCSSColorString(fbcv);style.fromNode.color.value=$COLOR.getCSSColorString(fcv,undefined,{retainGradientObject:true});style.toNode.border.color.value=$COLOR.getCSSColorString(tbcv);style.toNode.color.value=$COLOR.getCSSColorString(tcv,undefined,{retainGradientObject:true});style.showNodeLabel=circleStyle.showNodeLabel;theme.normal=style;return style;}var model=this.addDisposable(new OM({background:this.background,circleStyle:initCircleStyleModel.call(this),circleLabelStyle:this.circleLabelStyle,dragMode:this.dragMode}));model.background.attachEventListener("valueChanged",this.id,function(evt){var background=model.background.getRawObject();this.background=background;var owner=this.owner,fbgc=$CLR.encodeColor(owner.getFormats()["background-color"],10),ebgc=$CLR.encodeColor(evt.newValue,10);if(fbgc!==ebgc){$U.changeWidgetBackground(owner,evt.newValue,evt.oldValue);}owner.onStylesModified("background",background);});model.circleStyle.attachEventListener("valueChanged",this.id,function(){function update(val,updateModel){var observableModel=this.observableModel,style=val;this.circleStyle=val;initCircleStyle.call(this);if(updateModel){style=initCircleStyleModel.call(this);observableModel.circleStyle.setValue(style,true);}this.draw(false,true,true);}var newStyle=model.circleStyle.getRawObject();newStyle.fromNode.border.color.value=$COLOR.getColorValue(newStyle.fromNode.border.color.value);newStyle.fromNode.color.value=$COLOR.getColorValue(newStyle.fromNode.color.value);newStyle.toNode.border.color.value=$COLOR.getColorValue(newStyle.toNode.border.color.value);newStyle.toNode.color.value=$COLOR.getColorValue(newStyle.toNode.color.value);var theme=this.themeType==="dark"?this.circleStyle.dark:this.circleStyle.light;theme.normal=newStyle;this.circleStyle.showNodeLabel=newStyle.showNodeLabel;this.owner.onStylesModified("circleStyle",newStyle,update);update.call(this,this.circleStyle);});model.circleLabelStyle.attachEventListener("valueChanged",this.id,function(evt){function update(val,updateModel){var observableModel=this.observableModel;this.circleLabelStyle=val;if(updateModel){initCircleLabelStyle.call(this);observableModel.circleLabelStyle.setValue(this.circleLabelStyle,true);}if(labelSizeChanged){(this.spriteCollection||[]).forEach(function(s){if(s.type==="Circle"){s.updateTextSize();}});}this.draw(false,true,true);}var labelSizeChanged=(evt.target!==model.circleLabelStyle.fontColor.fill.value);this.owner.onStylesModified("circleLabelStyle",model.circleLabelStyle.getRawObject(),update);update.call(this,model.circleLabelStyle.getRawObject());});model.dragMode.attachEventListener("valueChanged",this.id,function(evt){function update(val,updateModel){this.dragMode=val;if(updateModel){this.observableModel.dragMode.setValue(val,true);}if(val===DRAG_MODE.pan){this.dismissLassoSelector();this.lassoSelectorEnabled=false;this.scaleBar.inputPan.checked=true;}else{if(val===DRAG_MODE.select){this.lassoSelectorEnabled=true;this.scaleBar.inputSelect.checked=true;}}}var type=evt.newValue;update.call(this,type);this.owner.onStylesModified("dragMode",type,update);});return model;}function initCircleLabelStyle(){var savedStyle=this.circleLabelStyle,newStyle=$HASH.clone(BUBBLE_LABEL_FONT_STYLE);$HASH.copy(savedStyle||{},newStyle);if(!newStyle.fontColor){newStyle.fontColor=$HASH.clone(this.themeType==="dark"?LABEL_COLORS.dark:LABEL_COLORS.light);}this.circleLabelStyle=newStyle;this.owner.propInfo.circleLabelStyle=newStyle;}function initCircleStyle(){var cs=this.circleStyle,csKeys=Object.keys(cs),showLabel;if(!cs||(csKeys.length===1&&csKeys[0]==="showNodeLabel")){showLabel=cs.showNodeLabel;this.circleStyle=$HASH.clone(CIRCLE_STYLES);this.circleStyle.showNodeLabel=showLabel;}else{if(!this.circleStyle.light||!this.circleStyle.dark){var circleStyle=$HASH.clone(CIRCLE_STYLES),theme=this.themeType==="dark"?circleStyle.dark:circleStyle.light;theme.normal=this.circleStyle;circleStyle.showNodeLabel=this.circleStyle.showNodeLabel;delete this.circleStyle.showNodeLabel;this.circleStyle=circleStyle;}}}mstrmojo.netviz.VisNetworkStage=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup,mstrmojo.netviz._HasNetworkContextMenu,mstrmojo.util.ui._LassoSelector],{scriptClass:"mstrmojo.netviz.VisNetworkStage",markupString:'<div id="{@id}-networkstage" style="position: absolute; left: {@left}px; top: {@top}px; width: {@width}px; height:{@height}px;" mstrAttach:mousedown,mousemove,click,contextmenu><div id="{@id}-canvas-parent-parent" style="position: absolute; width: {@width}px; height: {@height}px;"><div id="{@id}-canvas-parent" style="position: relative; z-index: 0;"><canvas id="{@id}-canvas" style="position: absolute; z-index: {@canvasCount}" id="canvas" width= "{@width}" height="{@height}"></canvas></div></div><div style="position: absolute; display:none; border: 2px dotted white; -webkit-user-select: none;"></div><div style="position: absolute; left: '+SCALEBAR_LEFT+"px; top: "+SCALEBAR_TOP+'px;"></div><div style="position: absolute;"></div></div>',markupSlots:{baseCanvas:function(){return this.domNode.firstChild.firstChild.firstChild;},canvasContainer:function(){return this.domNode.firstChild.firstChild;},canvasOuterContainer:function(){return this.domNode.firstChild;},selectionRectangle:function(){return this.domNode.childNodes[1];},scaleBarPlaceHolder:function(){return this.domNode.childNodes[2];},containerNode:function(){return this.domNode.childNodes[0];}},init:function(e){this.spriteCollection=[];this.selectedSprites=[];this.frameRate=60;this.frameInterval=Math.ceil(1000/this.frameRate);this.eventHasBeenHandled=false;this.isOnFormattingMode=false;this.dragMode=DRAG_MODE.pan;this.canvases=[];this.canvasCount=2;this.layers=[];this.transitionDuration=TRANSITION_DURATION_DEFAULT;if(this._super){this._super(e);}this.scaleBarRect={x:SCALEBAR_LEFT,y:SCALEBAR_TOP,w:SCALEBAR_WIDTH,h:SCALEBAR_HEIGHT};initCircleStyle.call(this);initCircleLabelStyle.call(this);if(this.showTransition){this.enableTransition();}this.observableModel=generateObservableModel.call(this);if(!this.tooltip){this.tooltip=this.addDisposable(new mstrmojo.VisTooltip({placeholder:document.body.appendChild(document.createElement("div")),owner:this}));this.tooltip.render();this.tooltip.domNode.style.display="none";}this.enableRaiseEventsForGestures();},themeType:"dark",destroy:function(){var t=this.tooltip;if(t.domNode&&t.domNode.parentNode){t.domNode.parentNode.removeChild(t.domNode);}delete this.spriteCollection;delete this.selectedSprites;delete this.canvases;delete this.layers;if(this._super){this._super();}},preBuildRendering:function(e){this._super(e);},postBuildRendering:function(e){if(this._super){this._super(e);}var canvas=this.baseCanvas;if(!canvas){log("No canvas found. Init failed");return ;}this.putSpritesInCanvases();$ARR.forEach(this.layers,function(layer){if(layer){layer.sort(function(a,b){if(a.zIndex>b.zIndex){return 1;}if(a.zIndex===b.zIndex){return 0;}return -1;});}});this.clear();this.updateCanvasPosition();this.draw();this.scaleBar=this.addDisposable(new mstrmojo.netviz.VisNetworkStageScaleBar({owner:this,placeholder:this.scaleBarPlaceHolder,width:this.scaleBarRect.w,height:this.scaleBarRect.h,scale:this.scale,range:{min:isDebugging?0.00001:0.5,max:isDebugging?10:2},setDragType:this.setDragType,resetScene:this.resetScene,dragMode:this.dragMode}));this.scaleBar.render();var _this=this;$U.addWheelListener(this.domNode,function(e){e.preventDefault();_this.dismissLassoSelector();if(_this.transitionTimer){return ;}var scaleBar=_this.scaleBar,zoom=e.deltaY>0?-1:1,delta=0.1,sf=isNaN(scaleBar.scaleFactor)?1:scaleBar.scaleFactor;sf+=zoom*delta;scaleBar.setScaleFactor(sf);scaleBar._deActoniveTimer=window.setTimeout(function(){scaleBar.setScaleFactorDone();},1000);});this.registerLassoSelector(this.domNode,[],false);},lassoSelecting:function(){$CSS.removeClass(this.lassoSelector,"lasso-selector-hasContent");},lassoSelected:function(params){var stage=this,owner=stage.owner;stage.areaSelect({x0:params.left,y0:params.top,x1:params.left+params.width,y1:params.top+params.height},params);if(stage.selectedSprites.length){$CSS.addClass(this.lassoSelector,"lasso-selector-hasContent");}owner.doSelection();},lassoSelectorResized:function(params){this.lassoSelecting();this.lassoSelected(params);},initScaleBar:function(sf){var scaleBar=this.scaleBar;var localZoomFactor=sf||this.getLocalProp(LOCAL_PROPS.ZOOM_FACTOR);if(!isNaN(localZoomFactor)&&localZoomFactor!==1){scaleBar.setScaleFactor(localZoomFactor);}},getLocalProp:function(propName){var owner=this.owner;return owner&&owner.getLocalProp(propName);},setLocalProp:function(propName,value){var owner=this.owner;return owner&&owner.setLocalProp(propName,value);},setMainRect:function(rect){if(!rect){return ;}this.scaleBarRect.x=rect.x+SCALEBAR_LEFT;if(this.scaleBar&&this.scaleBar.domNode){this.scaleBar.domNode.style.left=this.scaleBarRect.x+"px";}rect.x=this.scaleBarRect.x+this.scaleBarRect.w;rect.w=rect.w-this.scaleBarRect.w-SCALEBAR_LEFT;this.mainRect=rect;},onSpriteStyleChange:function(index){if(!this.toBeDrawnLayersIndexes){this.toBeDrawnLayersIndexes=[];}var indexes=this.toBeDrawnLayersIndexes;if(!isNaN(index)&&indexes.indexOf(index)===-1){indexes.push(index);}},removeSpriteFromLayer:function(sprite,layerIndex){var ret=false,fromLayer=this.layers[layerIndex],fromIndex=fromLayer.indexOf(sprite);if(fromIndex!==-1){fromLayer.splice(fromIndex,1);ret=true;if(this.hasRendered){this.onSpriteStyleChange(layerIndex);}}return ret;},addSpriteToLayer:function(sprite,layerIndex){var toLayer=this.layers[layerIndex],ret=false;if(toLayer){sprite.layerIndex=layerIndex;if(toLayer.indexOf(sprite)===-1){toLayer.push(sprite);ret=true;}if(this.hasRendered){this.onSpriteStyleChange(layerIndex);}}return ret;},putSpritesInCanvases:function(){this.canvases=[];var newCanvasCount=this.canvasCount-1,canvases=this.canvases,layers=[],i,fragment=document.createDocumentFragment(),cvs;[ENUM_LAYER.EDGE,ENUM_LAYER.CIRCLE,ENUM_LAYER.HIGHLIGHT].forEach(function(layerIndex){var layer=layers[layerIndex]=[];layer.canvasIndex=layerIndex===ENUM_LAYER.HIGHLIGHT?ENUM_CANVAS.HIGHLIGHT:ENUM_CANVAS.BASE;});function putSprites(sprite,layerIndex){var layer=layers[layerIndex];if(layer.indexOf(sprite)===-1){sprite.layerIndex=layerIndex;layer.push(sprite);}sprite.getCanvas=function(){return this.stage.canvases[this.stage.layers[this.layerIndex].canvasIndex];};}for(i=0;i<newCanvasCount;i++){cvs=document.createElement("canvas");cvs.width=this.width;cvs.height=this.height;cvs.style.position="absolute";cvs.style.zIndex=(i+1).toString();fragment.appendChild(cvs);canvases.push(cvs);}this.canvasContainer.appendChild(fragment);this.canvases.push(this.baseCanvas);var sprites=this.spriteCollection;$ARR.forEach(sprites,function(s){if(s.type==="Circle"){putSprites(s,ENUM_LAYER.CIRCLE);$ARR.forEach(s.unit.edges,function(edge){edge=edge.sprite;putSprites(edge,ENUM_LAYER.EDGE);});}});this.layers=layers;},unrender:function(e){if(this.scaleBar&&this.scaleBar.unrender){this.scaleBar.unrender(e);}if(this._super){this._super(e);}},updateCanvasPosition:function(){this.canvasPosition=$P(this.baseCanvas,true);},enableRaiseEventsForGestures:function(){var types=mouseEventTypes;var _this=this,i,len,ID=this.id;var getHandler=function(t,b){return function(touch){var p=$P(this.baseCanvas,true),e=touch.e||touch.evt||touch;touch.name=t;touch.layerX=e.pageX-p.x;touch.layerY=e.pageY-p.y;mstrmojo.all[ID].eventHasBeenHandled=false;mstrmojo.all[ID].raiseEventForSprites(touch);if(b){b.call(mstrmojo.all[ID],touch);}};};var stageMouseMove=_this.onmousemove,type,handlerName,backupHandler,oldMouseMove,oldMouseDown,mouseupHandler;for(i=0,len=types.length;i<len;i++){type=types[i];handlerName="on"+type;backupHandler=_this[handlerName];_this[handlerName]=getHandler(type,backupHandler);}oldMouseMove=_this.onmousemove;_this.onmousemove=function(touch){if(!mstrmojo.all[ID]._isMouseDown){oldMouseMove.call(mstrmojo.all[ID],touch);}else{stageMouseMove.call(mstrmojo.all[ID],touch);}};oldMouseDown=_this.onmousedown;mouseupHandler=_this.onmouseup;_this.onmousedown=function(touch){oldMouseDown.call(mstrmojo.all[ID],touch);$U.captureEventOnce("mouseup",mouseupHandler,mstrmojo.all[ID]);};},clear:function clear(layerIndexes){var canvases=[],_this=this,w=this.width,h=this.height;if(layerIndexes instanceof Array){layerIndexes.forEach(function(i){var canvas=_this.canvases[_this.layers[i].canvasIndex];if(canvases.indexOf(canvas)===-1){canvases.push(canvas);}});}else{canvases=this.canvases;}canvases.forEach(function(canvas){var ctx;ctx=canvas.getContext("2d");ctx.clearRect(0,0,w,h);ctx.fillStyle="rgba(0, 0, 0, 0)";ctx.fillRect(0,0,w,h);});},applyScaleAndPosition:function(){var sc=this.spriteCollection,len=sc.length,sp=this.sceneInformation.position,sf=this.scaleFactor,mx=this.width/2,my=this.height/2,i,sprite,p;if(isNaN(sf)){sf=1;}for(i=0;i<len;i++){sprite=sc[i];p=sprite.getGeometry();p.s=p.s*sf;p.x=(p.x-mx)*sf+mx+sp.x;p.y=(p.y-my)*sf+my+sp.y;sprite.setGeometry(p);}if(this.currentLayout===LAYOUT_NAMES.CIRCULAR){var gc=this.graphCenter;if(gc){gc.x=(gc.x-mx)*sf+mx+sp.x;gc.y=(gc.y-my)*sf+my+sp.y;}}this.scaleFactor=1;sp.x=0;sp.y=0;},setDragType:function(type){var model=$U.getPropertyByPath(this,"observableModel.dragMode");if(model!==undefined){model.setValue(type);}},drawLayer:function drawLayer(layer,isHighlightLayer){if(!layer){return ;}var len=layer.length,i,s;for(i=len-1;i>=0;i--){s=layer[i];s.draw(isHighlightLayer,s.attSrc);delete s.hasStyleChanged;}},drawFrame:function drawFrame(timestamp,layerIndexes){var len,i,sc,sprite,geometry,transGeometry,layers,index,j,layerLen,diff,ratio,me=this;function updateGeometry(key){var totalDistance=transGeometry["diff"+key],newVal=totalDistance*ratio;if(!isNaN(newVal)){transGeometry[key]=transGeometry["start"+key]+newVal;}}if(!me._hasDrawnTheFirstFrame){$GMU.startTimer({functionName:"VisNetworkStage.draw",purpose:"Rendering the canvas"});}me.clear(layerIndexes);layers=[];if(layerIndexes instanceof Array){for(i=0;i<layerIndexes.length;i++){index=layerIndexes[i];layerLen=me.layers.length;for(j=0;j<layerLen;j++){var l=me.layers[index],ll=me.layers[j];if(j!==index&&l&&ll&&l.canvasIndex===ll.canvasIndex&&layerIndexes.indexOf(j)===-1){layerIndexes.push(j);}}}layerIndexes.sort();$ARR.forEach(layerIndexes,function(i){var layer=me.layers[i];if(layer){layers.push(layer);}});}else{layers=me.layers;}if(!layers.length){log("nothing to draw");return ;}if(me.transitionTimer){sc=me.spriteCollection;len=sc.length;diff=timestamp-me.transitionStartTime;if(diff>me.transitionDuration){for(i=0;i<len;i++){sprite=sc[i];geometry=sprite.newGeometry;sprite.setGeometry(geometry);delete sprite.transitionGeometry;}me.onDrawTransitionEnd();}else{ratio=diff/me.transitionDuration;for(i=0;i<len;i++){sprite=sc[i];transGeometry=sprite.transitionGeometry;geometry=sprite.getGeometry();forEach(geometry,updateGeometry);sprite.setGeometry(transGeometry);}}}var bitmap=me.labelBitmap,indexes=layerIndexes||$HASH.valarray(ENUM_LAYER),refreshAllCircles=indexes.some(function(idx){return idx===ENUM_LAYER.CIRCLE;}),highlights=indexes.some(function(idx){return idx===ENUM_LAYER.HIGHLIGHT;})?me.layers[ENUM_LAYER.HIGHLIGHT]:[];me.spriteCollection.forEach(function(sprite){var box,needRefresh;if(sprite.type==="Circle"&&sprite.hasDrawnLabel){needRefresh=refreshAllCircles||highlights.some(function(s){return s===sprite;});if(!needRefresh){box=sprite.getLabelBoundingBox();bitmap.set(box.left,box.top,box.right,box.bottom);}}});var layerCount=layers.length;if(layers[ENUM_LAYER.HIGHLIGHT]!==undefined&&layerCount>1){if(layerCount===2){log("WARN: refresh only two layers: highlight and [circle|edge]");}layers=layers.slice();layers.splice(ENUM_LAYER.HIGHLIGHT,1);}var highlightLayer=me.layers[ENUM_LAYER.HIGHLIGHT];$ARR.forEach(layers,function(layer){if(layer){me.drawLayer(layer,layer===highlightLayer);}});log("draw done");me.toBeDrawnLayersIndexes=[];if(!me._hasDrawnTheFirstFrame){me._hasDrawnTheFirstFrame=true;$GMU.endTimer();}},draw:function draw(showTransition,doNotIgnore,drawAllLayers){var layerIndexes,sc,len,i,sprite,transitionGeometry,newGeometry,_this=this;function initTransitionGeometry(key){transitionGeometry["diff"+key]=newGeometry[key]-transitionGeometry[key];transitionGeometry["start"+key]=transitionGeometry[key];}function paint(timestamp){if(!doNotIgnore&&_this.transitionTimer===undefined){if(_this.lastDrawTime!==undefined&&timestamp-_this.lastDrawTime<_this.frameInterval){log("draw ignored");return ;}}if(_this.transitionTimer&&!_this.transitionStartTime){_this.transitionStartTime=timestamp;}_this.labelBitmap=_this.addDisposable(new mstrmojo.netviz.Bitmap({left:0,top:0,right:_this.width,bottom:_this.height,scale:4}));var ID=_this.id;_this.drawFrame.call(mstrmojo.all[ID],timestamp,layerIndexes);_this.toBeDrawnLayersIndexes=[];_this.lastDrawTime=timestamp;if(_this.transitionTimer){_this.transitionTimer=window.requestAnimationFrame(paint);}}this.onDrawTransitionEnd();layerIndexes=this.toBeDrawnLayersIndexes;if(typeof layerIndexes==="number"&&this.layers[layerIndexes]){layerIndexes=[layerIndexes];}if(drawAllLayers){layerIndexes=arrayKeys(this.layers);}if(!showTransition){window.requestAnimationFrame(paint);}else{sc=this.spriteCollection;len=sc.length;for(i=0;i<len;i++){sprite=sc[i];transitionGeometry=$HASH.clone(sprite.oldGeometry);newGeometry=$HASH.clone(sprite.getGeometry());forEach(newGeometry,initTransitionGeometry);sprite.newGeometry=newGeometry;sprite.transitionGeometry=transitionGeometry;}this.transitionTimer=window.requestAnimationFrame(paint);}},onDrawTransitionEnd:function(){if(this.transitionTimer){window.cancelAnimationFrame(this.transitionTimer);delete this.transitionTimer;delete this.transitionStartTime;}},clearHoverHighlight:function(){var allSprites=this.spriteCollection,len=allSprites.length,sprite,i;for(i=0;i<len;i++){sprite=allSprites[i];if(sprite.type==="Edge"){sprite.unHoverHighlight();}}},clearSelection:function(){var ss=this.selectedSprites,len=ss.length,i,s;for(i=0;i<len;i++){s=ss[i];s.selectionState.selected=false;s.unHighlight();}this.selectedSprites=[];},addToSelection:function(sprite){var ss=this.selectedSprites;if(ss.indexOf(sprite)===-1){sprite.selectionState.selected=true;sprite.highlight();ss.push(sprite);}},removeFromSelection:function(sprite){var ss=this.selectedSprites,i=ss.indexOf(sprite);if(i!==-1){sprite.selectionState.selected=false;sprite.unHighlight();ss.splice(i,1);}},onclick:function(){},onmousedown:function(e){e=e.e||e;if(this.eventHasBeenHandled||this.transitionTimer||(this.lassoSelector!==e.target&&this.canvases.indexOf(e.target)===-1)){return ;}if(this.dragMode===DRAG_MODE.select){this.lassoSelectorEnabled=true;}this._isMouseDown=true;this._lastMousePosition={x:e.pageX,y:e.pageY};if(this._isEdgeHovered){delete this._isEdgeHovered;this._isEdgeMouseDown=true;}},onmousemove:function(e){e=e.e||e;if(this.eventHasBeenHandled||this.transitionTimer||!this._isMouseDown){return ;}var lp=this._lastMousePosition,p={x:e.pageX,y:e.pageY},dx=p.x-lp.x,dy=p.y-lp.y;if(!this._isDragged){if(dx||dy){this._isDragged=true;if(this._isEdgeMouseDown){this._pendingRefresh=true;delete this._isEdgeMouseDown;}}}if(this.dragMode===DRAG_MODE.pan&&e.button===0){var sp=this.sceneInformation.position;sp.x+=dx;sp.y+=dy;this.applyScaleAndPosition();this.draw(false);}this._lastMousePosition=p;},onmouseup:function(evt){var e=evt.e||evt,src=e.srcElement||e.target,owner=this.owner,selection;if(this.eventHasBeenHandled||this.transitionTimer||!this._isMouseDown){return ;}if(!this._isDragged){if(!(getMouseButton(e)===2&&this.lassoSelector===src)){selection=(this.selectedSprites||[]).filter(this.isClearAllEnabled,this);selection.forEach(function(circleSprite){if(this.isClearAllEnabled(circleSprite)){this.removeFromSelection(circleSprite);}},this);if(selection.length>0){owner.doSelection();this.draw(false);}}}delete this._isMouseDown;delete this._lastMousePosition;delete this._isDragged;delete this._isEdgeMouseDown;},oncontextmenu:function oncontextmenu(evt){var e=evt.e||evt,src=e.target||e.srcElement,lasso=this.lassoSelector;$D.stopPropogation(window,e);$D.preventDefault(window,e);if(this.eventHasBeenHandled||this.transitionTimer){return ;}if(this.isOnFormattingMode){this.showContextMenu("background",this.observableModel.background,e);}else{var owner=this.owner;if(src===lasso){owner.showSelectionMenu(e);}else{if(!$D.contains(this.scaleBar.domNode,src,true)){var stg=this;owner.showBlankSpaceMenu(e,function(){stg.showContextMenu("background",stg.observableModel.background,e);$U.selectPropertyPanel(stg.owner,0);});}}}if(this._isMouseDown){delete this._selectionState;delete this._isMouseDown;delete this._lastMousePosition;delete this._dragged;}},getCircleSpriteItems:function(){var ret=[];$ARR.forEach(this.spriteCollection,function(sprite){if(sprite.type==="Circle"){ret.push({n:sprite.text,id:sprite});}});return ret;},areaSelect:function(a,info){if(isNaN(a.x0)||isNaN(a.x1)||isNaN(a.y0)||isNaN(a.y1)){log("Invalid selection area.");return ;}var sc=this.spriteCollection,len=sc.length,i,sprite,g;if(!info.ctrlKey){this.clearSelection();}for(i=0;i<len;i++){sprite=sc[i];if(sprite.type==="Circle"){g=sprite.getGeometry();if((g.x-a.x0)*(g.x-a.x1)<=0&&(g.y-a.y0)*(g.y-a.y1)<=0){this.addToSelection(sprite);}}}var offset=$P(this.baseCanvas,true);this._bubbleToolbarPos={pageX:a.x0+offset.x,pageY:a.y0+offset.y};this.draw(false);},enableTransition:function(duration){this.showTransition=true;if(isNaN(duration)){duration=TRANSITION_DURATION_DEFAULT;}this.transitionDuration=duration;},disableTransition:function(){this.showTransition=false;delete this.transitionDuration;var sc=this.spriteCollection,len=sc.len,i;for(i=0;i<len;i++){delete sc[i].oldGeometry;delete sc[i].newGeometry;}},getSpriteIndex:function getInex(sprite){var eC=this.spriteCollection,i;for(i=0;eC[i];i++){if(sprite===eC[i]){return i;}}return null;},createSprite:function(props){props.stage=this;var sprite=null;if(props.type==="Circle"){sprite=this.addDisposable(new CircleSprite(props));}if(props.type==="Edge"){sprite=this.addDisposable(new EdgeSprite(props));}return sprite;},addSprite:function addSprite(sprite,index){if(!isNaN(index)){this.spriteCollection.splice(index,0,sprite);}else{this.spriteCollection.push(sprite);}},clearSprites:function(){this.spriteCollection=[];},removeSprite:function(sprite,index){if(isNaN(index)){index=this.getInex(sprite);}if(!isNaN(index)){this.spriteCollection.splice(index,1);}},attachEventListenerForSprites:function(eventType,sprite,handler){if(!sprite.eventHandlers){sprite.eventHandlers={};}var eventHandlers=sprite.eventHandlers;eventHandlers["on"+eventType]=handler;},removeEventListenerForSprites:function(sprite,eventType){var eventHandlers=sprite.eventHandlers;if(eventHandlers){delete eventHandlers[eventType];if(Object.keys(eventHandlers).length===0){delete sprite.eventHandlers;}}},raiseEventForSprites:function(e){if(this.eventHasBeenHandled){return ;}var type=e.name;if(type){var layers=[];$ARR.forEach(this.layers,function(layer){var l=[];layers.push(l);$ARR.forEach(layer,function(sprite){l.push(sprite);});});var len=layers.length,i,j,layer,sprite,eventHandlers;for(i=len-1;i>=0;i--){layer=layers[i];for(j=0;j<layer.length;j++){sprite=layer[j];eventHandlers=sprite.eventHandlers;if(eventHandlers&&eventHandlers["on"+type]){eventHandlers["on"+type].call(sprite,e);}if(this.eventHasBeenHandled){return ;}}}}},mainRect:null,setScene:function(){function bezierExtremum(p1,p2,cp){function same(p,q){return $U.isNearZero(p.x-q.x)&&$U.isNearZero(p.y-q.y);}var extremums=["x","y"].map(function axisExtremum(axis){var a=(p1[axis]-2*cp[axis]+p2[axis]),t=$U.isNearZero(a)?1:(p1[axis]-cp[axis])/a;if(t<0||t>=1){return p2;}return getPointOnBezierCurve(t,p1,cp,p2);}).filter(function(p){return !(same(p,p1)||same(p,p2));}),len=extremums.length;if(len===2&&same.apply(undefined,extremums)){extremums.pop();len=1;}if(len===0){return p2;}else{return extremums[0];}}this.sceneInformation={};this.scaleFactor=1;var mainRect=this.mainRect||{x:0,y:0,w:this.width,h:this.height},sc,i,j,circles=[],view=null,viewNoBorder=null,borderWidth=$VIS_ENUM.NETWORK_CIRCLE_BORDER_WIDTH,edgePadding=4,minScale=Infinity,showEdgeDir=this.showEdgeDirection,max=Math.max,min=Math.min,ceil=Math.ceil,pow=Math.pow,sqrt=Math.sqrt,len,g1,g2,d,toPos;sc=this.spriteCollection||[];$ARR.forEach(sc,function(sprite){var geo,r,g,x1,x2,y1,y2;if(sprite.isExcluded){return ;}geo=sprite.getGeometry();if(sprite.type==="Circle"){r=geo.s+borderWidth;g=geo;circles.push(sprite);}else{r=max(ceil(geo.s/2),edgePadding);if(showEdgeDir){toPos=sprite.getEndPoint().pos;}else{toPos=sprite.to.getGeometry();}g=bezierExtremum(sprite.from.getGeometry(),toPos,geo);}x1=g.x-r;x2=g.x+r;y1=g.y-r;y2=g.y+r;if(!view){view={x1:x1,x2:x2,y1:y1,y2:y2};}else{view.x1=min(view.x1,x1);view.x2=max(view.x2,x2);view.y1=min(view.y1,y1);view.y2=max(view.y2,y2);}if(!viewNoBorder){viewNoBorder={x1:g.x,x2:g.x,y1:g.y,y2:g.y};}else{viewNoBorder.x1=min(viewNoBorder.x1,g.x);viewNoBorder.x2=max(viewNoBorder.x2,g.x);viewNoBorder.y1=min(viewNoBorder.y1,g.y);viewNoBorder.y2=max(viewNoBorder.y2,g.y);}});if(!view){view={x1:0,x2:0,y1:0,y2:0};viewNoBorder={x1:0,x2:0,y1:0,y2:0};}this.sceneInformation.position={x:0,y:0};var borders={left:viewNoBorder.x1-view.x1,top:viewNoBorder.y1-view.y1,bottom:view.y2-viewNoBorder.y2,right:view.x2-viewNoBorder.x2},sfw,sfh,sf;if($U.isNearZero(viewNoBorder.x2-viewNoBorder.x1)){sfw=0;}else{sfw=(mainRect.w-borders.left-borders.right)/(viewNoBorder.x2-viewNoBorder.x1);}if($U.isNearZero(viewNoBorder.y2-viewNoBorder.y1)){sfh=0;}else{sfh=(mainRect.h-borders.top-borders.bottom)/(viewNoBorder.y2-viewNoBorder.y1);}if(sfw===0&&sfh!==0){sf=sfh;}else{if(sfh===0&&sfw!==0){sf=sfw;}else{sf=min(sfw,sfh);}}if(Math.abs(sf)===Infinity){return ;}var dx=(mainRect.w-(viewNoBorder.x2-viewNoBorder.x1)*sf-borders.left-borders.right)/2+borders.left,dy=(mainRect.h-(viewNoBorder.y2-viewNoBorder.y1)*sf-borders.top-borders.bottom)/2+borders.top;$ARR.forEach(sc,function(sprite){var geometry=sprite.getGeometry(),x=geometry.x,y=geometry.y;x-=viewNoBorder.x1;x*=sf;geometry.x=x+mainRect.x+dx;y-=viewNoBorder.y1;y*=sf;geometry.y=y+mainRect.y+dy;sprite.setGeometry(geometry);});if(this.currentLayout===LAYOUT_NAMES.CIRCULAR){this.graphCenter={x:mainRect.w/2+mainRect.x,y:mainRect.h/2+mainRect.y};}for(i=0,len=circles.length;i<len;i++){g1=circles[i].getGeometry();for(j=i+1;j<len;j++){g2=circles[j].getGeometry();d=sqrt(pow(g1.x-g2.x,2)+pow(g1.y-g2.y,2));if(d>2){minScale=min(minScale,d/(g1.s+g2.s));}}}if(minScale<1){$ARR.forEach(sc,function(s){s.setGeometry({s:s.getGeometry().s*minScale});});}},resetScene:function(){if(this.sceneInformation){this.sceneInformation.position={x:0,y:0};}this.setScene();},scale:function(sf){if(!this.sceneInformation){this.sceneInformation={size:{width:this.width,height:this.height},position:{x:0,y:0}};}this.scaleFactor=sf;this.applyScaleAndPosition();this.draw(false);},findForceDirectedGraphCenter:function(circle){var sc=this.spriteCollection,rv={x:0,y:0},cnt=0,i,len,s,from,to,pos,dummyPos={x:0,y:0},seen={};for(i=0,len=sc.length;i!==len;i++){s=sc[i];if(s instanceof EdgeSprite){from=s.from;to=s.to;if(from===circle&&!seen.hasOwnProperty(to.id)){pos=to.position;cnt++;seen[to.id]=true;}else{if(to===circle&&!seen.hasOwnProperty(from.id)){pos=from.position;cnt++;seen[from.id]=true;}else{pos=dummyPos;}}rv.x+=pos.x;rv.y+=pos.y;}}rv.x/=cnt;rv.y/=cnt;return rv;},findLinearLayoutGraphCenter:function(circle){var sc=this.spriteCollection,p=circle.position,diff=0,i,len,s,cp,rv;for(i=0,len=sc.length;i!==len;i++){s=sc[i];if(s instanceof EdgeSprite){if(s.from===s.to){continue;}cp=s.controlPoint;if(cp.y<p.y){diff++;}else{diff--;}}}if(diff>=0){rv={x:p.x,y:0};}else{rv={x:p.x,y:2*p.y};}return rv;},getDataLabelFormats:function(){var ls=this.circleLabelStyle;return{color:$COLOR.getCSSColorString(ls.fontColor.fill.value),font:fontStyleToString(ls),"text-decoration":getTextDecorationFromMask(ls.fontStyle)};},execFormatHandler:function(){var selection=this.selectedSprites;if(selection&&selection.length>0){showBubbleToolbarAndMenuItem.call(this,this._bubbleToolbarPos);$U.selectPropertyPanel(this.owner,"de");}else{$U.selectPropertyPanel(this.owner,0);}},isClearAllEnabled:function(sprite){return this.owner.isClearAllEnabled(sprite.unit);}});}());