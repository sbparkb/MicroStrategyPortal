(function(){mstrmojo.requiresCls("mstrmojo.HTMLButton","mstrmojo.CheckBox","mstrmojo.Editor","mstrmojo.HBox","mstrmojo.Label","mstrmojo.RadioButton","mstrmojo.warehouse.dbroles.DBRoleDSNConnection","mstrmojo.warehouse.dbroles.DBRoleSetting","mstrmojo.warehouse.obj.DBRole");mstrmojo.requiresDescs(10070,12933,12949,11139,8513,1162,11134,10071,1442,221);var $A=mstrmojo.array,$S=mstrmojo.string,$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,hiddenPwd="PWDHIDDEN123!@#",DssXmlPrivilegesUseDatabaseInstanceManager=57;function validate(){var dbe=this,dbr=this.dbrole.mdDBRole,name=$S.trim(dbe.container.txtname.text),isValid;if(name!==dbr.n){if(!mstrApp.getRootController().validateName($ENUM_OT.DBROLE,name,dbr.n)){return false;}}if(dbe.container.txtlogin.visible){isValid=dbe.container.txtlogin.isValid();if(!isValid.val){mstrmojo.alert(isValid.msg);return false;}}if(dbe.container.txtpwd.visible){isValid=dbe.container.txtpwd.isValid();if(!isValid.val){mstrmojo.alert(isValid.msg);return false;}}if(dbe.container.dsnSelector.WHDSNLIST.selectedIndex===1){var sdsn=dbe.container.dsninfo.dsnBox.dsnList.selectedItem;if(!sdsn||sdsn.des==="0"){mstrmojo.alert(mstrmojo.desc(10070,"Please select a DSN first"));return false;}}else{isValid=dbe.container.dsninfo.isValidInput();if(!isValid.val){mstrmojo.alert(isValid.msg);return false;}}return true;}function populate(){var $this=this,dsn=this.container.dsninfo,dbr=this.dbrole.mdDBRole,cfg=this.config,conn=dbr.connstr,c=this.container,hideDSNSelector=false,populateFn=function populateFn(){dsn.clear();if(!conn){var wls=window.localStorage,dsnOption=parseInt((wls&&wls.getItem("dbRoleDSNOption"))||0,10);if(dsnOption===0||hideDSNSelector){c.dsnSelector.WHDSNLIST.set("selectedIndex",0);}else{c.dsnSelector.WHDSNLIST.set("selectedIndex",1);}}else{var conntype=(conn.split("=")[0]).toUpperCase();if(conntype==="DSN"){c.dsnSelector.WHDSNLIST.set("selectedIndex",1);}else{c.dsnSelector.WHDSNLIST.set("selectedIndex",0);}}dsn.set("info",dbr);if(!dbr.shared){dbr.shared="0";}if(mstrApp.isSingleTier){c.sharedConnection.domNode.style.display="none";}else{c.sharedConnection.checked=(dbr.shared==="1");c.sharedConnection.refresh();}dbr.des=(mstrApp.rootController.isCloud()?dbr.n:"");dbr.ln=dbr.ln||"";c.txtlogin.set("text",dbr.ln);if(dbr.did===""){dbr.password=dbr.password||"";}else{dbr.password=dbr.password||hiddenPwd;}c.txtpwd.set("text",dbr.password);c.txtname.set("text",dbr.n||dbr.des);};if(cfg||mstrApp.isSingleTier){mstrApp.rootController.getDBObjects().reloadDSNs({success:function success(){populateFn.call($this);}});if(cfg.hideDSNOption||(mstrApp.isSingleTier&&navigator.userAgent.indexOf("Macintosh")>-1)){c.dsnSelector.domNode.style.display="none";hideDSNSelector=true;}if(cfg.hideDriverCheck){c.dsninfo.set("hideDriverCheck",cfg.hideDriverCheck);}if(cfg.requiresLogin!==undefined){c.txtlogin.isRequired=cfg.requiresLogin;c.txtpwd.isRequired=cfg.requiresLogin;}if(cfg.dbIdFilter){c.dsninfo.dbIdFilter=cfg.dbIdFilter.sort($A.numSorter);}if(cfg.dbIdExcludeFilter){c.dsninfo.dbIdExcludeFilter=cfg.dbIdExcludeFilter.sort($A.numSorter);}if(cfg.dsnDbTypeExcludeFilter){c.dsninfo.dsnDbTypeExcludeFilter=cfg.dsnDbTypeExcludeFilter.sort($A.numSorter);}if(cfg.showAddDriver){c.dsninfo.set("showAddDriver",cfg.showAddDriver);}if(cfg.singleType){c.dsninfo.set("singleType",true);}if(cfg.cfgDbmsTypeExcludeFilter){c.dsninfo.set("cfgDbmsTypeExcludeFilter",cfg.cfgDbmsTypeExcludeFilter);}c.sharedConnection.set("visible",!(cfg.hideShareConnection||false));}else{populateFn.call($this);}}function save(saveCB){var $this=this;var c=this.container,dsninfo=c.dsninfo,dbr=this.dbrole.mdDBRole;if(mstrApp.rootController.isCloud()){dbr.des=$S.trim(c.txtname.text);dbr.n=dbr.des+"___"+new Date().getTime();}else{dbr.n=$S.trim(c.txtname.text);}dbr.des=dbr.des.replace(",","%%%");dbr.n=dbr.n.replace(",","%%%");dbr.dbr_type="2";dbr.owned="1";dbr.writable="1";if(c.sharedConnection.isChecked()){dbr.shared="1";}else{dbr.shared="0";}if(c.txtlogin.visible){dbr.ln=$S.trim(c.txtlogin.text);}else{dbr.ln="";}if((c.txtpwd.text!==hiddenPwd)&&(c.txtpwd.visible)){dbr.password=c.txtpwd.text;}else{delete dbr.password;}var conn=dsninfo.getConnectionStr();dbr.connstr=conn.str;dbr.db_type=dsninfo.getDBType();dbr.cefu=dsninfo.getCharEncodingForUnix();dbr.driverMode=dsninfo.getDriverMode();dbr.odbcv=dsninfo.getOdbcv();dbr.dbms=dsninfo.getDbmsID();dbr.ab=dsninfo.getDBId();dsninfo.getVLDBProperties(dbr.vldbProperties);mstrApp.rootController.saveDBRole(this.dbrole,(dbr.did===""),{errorMsg:conn.err,success:function success(){if($this.callback&&$this.callback.success){$this.callback.success($this.dbrole);}if(saveCB&&saveCB.keepOpen){saveCB.success();}else{$this.close();}},complete:function complete(){if(this.errorMsg!==""){mstrmojo.alert(this.errorMsg);}}});}function onOKPressed(edtr,saveCB){var editor=(edtr.dbrole?edtr:edtr.parent),dbRole=editor.dbrole.mdDBRole;if(dbRole.writable==="1"&&mstrApp.rootController.hasPrivilege(DssXmlPrivilegesUseDatabaseInstanceManager)){if(validate.call(editor)){save.call(editor,saveCB);}}else{mstrmojo.alert(mstrmojo.desc(12933,"You don't have enough privileges to perform this operation"));}}mstrmojo.warehouse.dbroles.DBRoleEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleEditor",cssClass:"mstrmojo-wh-DBRoleEditor",title:mstrmojo.desc(12949,"Data Source"),zIndex:100,dbrole:undefined,useDSN:true,callback:mstrmojo.emptyFn(),onOpen:function onOpen(){populate.call(this);},onClose:function onClose(){if(this.callback&&this.callback.close){this.callback.close();}},container:undefined,dsnSelector:undefined,WHDSNLIST:undefined,dsninfo:undefined,txtlogin:undefined,txtpwd:undefined,sharedConnection:undefined,hideDSNOption:undefined,hideDriverCheck:undefined,requiresLogin:undefined,children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-wh-DBRoleEditor-container",alias:"container",children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-wh-DSNSelector",alias:"dsnSelector",children:[{scriptClass:"mstrmojo.ui.CheckList",cssClass:"mstrmojo-wh-DSNSelector-radio",multiSelect:false,orientation:"h",alias:"WHDSNLIST",items:[{did:"0",n:mstrmojo.desc(11132,"DSN less data sources")},{did:"1",n:mstrmojo.desc(11133,"DSN data sources")}],onchange:function(){if(this.selectedIndex===0){this.parent.parent.dsninfo.set("isDSNLess",true);}else{this.parent.parent.dsninfo.set("isDSNLess",false);}var wls=window.localStorage;if(wls){wls.setItem("dbRoleDSNOption",this.selectedIndex);}}}]},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-wh-DBRoleEditor-info",text:mstrmojo.desc(11139,"Connection Information"),visible:false},{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleDSNConnection",alias:"dsninfo",onEnterFn:function onEnter(widget){onOKPressed(widget.parent.parent);},updateLoginFn:function updateLoginFn(isStdLogin){this.parent.txtlogin.set("visible",isStdLogin);this.parent.txtpwd.set("visible",isStdLogin);}},{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSetting",alias:"txtlogin",isRequired:true,caption:mstrmojo.desc(8513,"login:"),onEnter:function onEnter(){onOKPressed(this.parent.parent);}},{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSetting",alias:"txtpwd",isPassword:true,hiddenPwd:hiddenPwd,isRequired:true,caption:mstrmojo.desc(1162,"password:"),onEnter:function onEnter(){onOKPressed(this.parent.parent);}},{scriptClass:"mstrmojo.warehouse.dbroles.DBRoleSetting",alias:"txtname",caption:mstrmojo.desc(11134,"ds name:"),onEnter:function onEnter(){onOKPressed(this.parent.parent);}},{scriptClass:"mstrmojo.CheckBox",cssClass:"mstrmojo-wh-DBRoleEditor-infoCheckbox",alias:"sharedConnection",label:mstrmojo.desc(10071,"Share this connection with everybody")}]},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-buttonBox",slot:"buttonNode",alias:"buttonsbox",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button rightfloat mstrmojo-WebButton hot",text:mstrmojo.desc(1442,"OK"),onclick:function(){onOKPressed(this.parent.parent);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),alias:"buttonCancel",onclick:function(){var e=this.parent.parent;if(e.onCancel){e.onCancel();}e.close();}}]}]});}());