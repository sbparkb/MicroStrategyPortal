(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.Box","mstrmojo.ui.SearchablePulldown");mstrmojo.requiresDescs(14185,14186,14187);var $A=mstrmojo.array,$DOM=mstrmojo.dom,STR_SEARCH_NS=mstrmojo.desc(14185,"Search for a namespace"),STR_LOADING_NS=mstrmojo.desc(14186,"Loading namespaces..."),STR_UPDATE=mstrmojo.desc(14187,"Update namespaces"),$ENUM_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents;var REFRESH_NS_BUTTON_WIDTH=31;mstrmojo.warehouse.ui.NameSpacePullDown=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.architect.ui.NameSpacePullDown",cssClass:"mstrmojo-wh-NameSpacePullDown",visible:false,pulldown:undefined,btnRefreshNS:undefined,selectedIndex:undefined,children:[{scriptClass:"mstrmojo.ui.SearchablePulldown",alias:"pulldown",isHostedWithin:false,hostedCSSClass:"mstrmojo-wh-Panel.AvailableTables",visible:false,nameSpacesLoaded:undefined,renderOnScroll:true,updateText:function updateText(text){this.selectedNode.textContent=text;},onPopupWidgetOpened:function onPopupWidgetOpened(){this.getPopupWidget().set("width",mstrmojo.dom.position(this.domNode).w+"px");},onitemSelected:function onitemSelected(item){if(this.parent.mode===1){if(this.getPopupList()._oldItems!==undefined){return ;}this.parent.selectedIndex=this.selectedIndex;if(this.parent.onItemSelectedCallback){this.parent.onItemSelectedCallback(item);}}else{this.updateText(STR_LOADING_NS);this.parent.selectedIndex=undefined;}}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-wh-btnRefreshNS",alias:"btnRefreshNS",visible:false,onclick:function onclick(){mstrApp.rootController.getNameSpaces({sourceInfo:this.parent.sourceInfo,getFresh:true});},title:STR_UPDATE,tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){var pos=$DOM.position(this.domNode);this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-A",top:Math.max(pos.y+40,0),left:Math.max(pos.x+2,0),posType:mstrmojo.tooltip.POS_TOPLEFT,content:this.title});},onvisibleChange:function onvisibleChange(evt){var width=this.parent.domNode.clientWidth||parseInt(this.parent.width,10);if(typeof width==="number"&&width>0){this.parent.pulldown.set("width",width-(this.visible?REFRESH_NS_BUTTON_WIDTH:0)+"px");}}}],onwidthChange:function onwidthChange(evt){var width=parseInt(evt.value,10);if(width>0){this.pulldown.set("width",width-(this.btnRefreshNS.visible?REFRESH_NS_BUTTON_WIDTH:0)+"px");}},onvisibleChange:function onvisibleChange(evt){var width=this.domNode.clientWidth||parseInt(this.width,10);if(this.visible&&typeof width==="number"&&width>0){this.pulldown.set("width",width-REFRESH_NS_BUTTON_WIDTH+"px");}},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}if($DOM.isIE8||$DOM.isIE9){mstrmojo.css.addClass(this.domNode,"ie9");}},init:function init(props){this._super(props);var $this=this,evtConfig={},listConfig=evtConfig[this.id]={};listConfig[$ENUM_DATA_CHANGE_EVENTS.NAMESPACES_CHANGED]=function nsChanged(evt){$this.loadNameSpaces(evt);};listConfig[$ENUM_DATA_CHANGE_EVENTS.NAMESPACES_REQUESTED]=function nsChanged(evt){$this.preLoadNameSpaces(evt);};mstrApp.getRootController().attachDataChangeListeners(evtConfig);},mode:0,preLoadNameSpaces:function preLoadNameSpaces(evt){if(!((this.sourceInfo===evt.sourceInfo)||(evt.sourceInfo==="")||(evt.sourceInfo===undefined))){return ;}var nameSpaces=[];this.mode=0;nameSpaces[0]={n:""};nameSpaces[1]={n:STR_LOADING_NS};this.pulldown.set("items",nameSpaces);this.pulldown.set("selectedIndex",0);this.pulldown.set("visible",true);this.set("visible",true);this.pulldown.updateText(STR_SEARCH_NS);},loadNameSpaces:function loadNameSpaces(res){if(!((this.sourceInfo===res.sourceInfo)||(res.sourceInfo==="")||(res.sourceInfo===undefined))){return ;}var nameSpaces=res.namespaces||[],hasNamespaces=true,newDBRoleID=res.dbRoleID,wls,cookieNameSpace,idx=-1;if(nameSpaces.length===0){nameSpaces.push({n:""});hasNamespaces=false;}nameSpaces=nameSpaces.sort(function(a,b){return a.n.toLowerCase().localeCompare(b.n.toLowerCase());});var txt=this.pulldown.selectedNode.innerHTML,isOpen=this.pulldown.getPopupList().visible;if(isOpen){this.pulldown.getPopupList().close();}this.mode=1;this.pulldown.set("items",nameSpaces);this.pulldown.set("visible",hasNamespaces);this.set("visible",hasNamespaces);this.btnRefreshNS.set("visible",hasNamespaces);if(!hasNamespaces&&!res.error){this.pulldown.set("selectedIndex",0);}this.dbRoleID=newDBRoleID;if(this.nameSpacesLoaded){this.nameSpacesLoaded();}if(hasNamespaces){if(isOpen){this.pulldown.getPopupList().open();}if(mstrApp.getRootController().isUsingCookieNamespace()){wls=window.localStorage;cookieNameSpace=(wls&&wls.getItem(newDBRoleID));idx=$A.find(nameSpaces,"n",cookieNameSpace);}if(idx>=0){this.pulldown.set("selectedIndex",idx);}else{this.pulldown.updateText(txt);}if(txt!==STR_SEARCH_NS){this.pulldown.processSearch();}}}});}());