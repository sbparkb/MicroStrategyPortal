(function(){mstrmojo.requiresCls("mstrmojo.onetier.vi.ui.OpenFromServerBrowser","mstrmojo.Editor");mstrmojo.requiresDescs(14151,11922,12726,13591,14064,14065,14066,14067,12726,14152,2397,2399,13568);var ddaSelector=function(cubeInfo,callback){var hasSecFilter=cubeInfo.hsf,ACLDenied=cubeInfo.acld,dda=cubeInfo.dda,getSizeLabel=function(sizeInKB){return(sizeInKB>=1048576?(sizeInKB/1048576).toFixed(2)+"GB":(sizeInKB>=1024?(Math.round((sizeInKB||0)*100/1024)/100).toFixed(2)+"MB":sizeInKB+"KB"));},maxFileSize=cubeInfo.maxcs*1024,cubeSize=cubeInfo.cs||0,bigCube=cubeSize>maxFileSize,showToggle=!hasSecFilter&&!ACLDenied&&!bigCube&&!dda,ed=(new mstrmojo.Editor({title:showToggle?mstrmojo.desc(11922,"Data Access Mode"):mstrmojo.desc(12726,"Connect Live"),cssClass:"mstrmojo-onetier-cubeDDAOrInMem",zIndex:20,premouseup:function premouseup(evt){if(evt.getTarget()===this.closeNode&&this.onPreClose()){this.close(true);}},onClose:function close(fromClose){if(fromClose){callback.failure(false);}},children:[{alias:"label",scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13591,"How would you like to access your data?"),visible:showToggle},{scriptClass:"mstrmojo.Label",cssClass:"message",text:mstrmojo.desc(14064,"A security filter has been defined for you in this project, so you can not download the data. Click OK in order to Connect Live to the selected Intelligent Cube."),visible:hasSecFilter},{scriptClass:"mstrmojo.Label",cssClass:"message",text:mstrmojo.desc(14065,"You do not have access to all the objects in the selected Intelligent Cube, so you can not download the data. Click OK in order to Connect Live to the selected Intelligent Cube."),visible:ACLDenied},{scriptClass:"mstrmojo.Label",cssClass:"message",text:mstrmojo.desc(14066,"Data in the selected Intelligent Cube is not In-Memory, so you need to Connect Live"),visible:dda},{scriptClass:"mstrmojo.Label",cssClass:"message",text:mstrmojo.desc(14067,"The size of the Intelligent Cube # is more than the download limit ## set by the administrator. Therefore, you can only Connect Live to the selected Intelligent Cube. Click OK to continue.").replace("##",getSizeLabel(maxFileSize)).replace("#",getSizeLabel(cubeSize)),visible:bigCube},{alias:"dda",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",text:mstrmojo.desc(12726,"Connect Live"),visible:showToggle,onclick:function(){ed.close();callback.success(true);}},{alias:"inMem",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",text:(cubeSize?mstrmojo.desc(14152,"Import as an In-memory Dataset (##)*").replace("##",getSizeLabel(cubeSize)):mstrmojo.desc(13589,"Import as an In-memory Dataset")),visible:showToggle,onclick:function(){ed.close();callback.success(false);}},{alias:"inMemHint",scriptClass:"mstrmojo.Label",cssClass:"message",text:mstrmojo.desc(14151,"* You will be downloading ## of data to Import as an In-memory Dataset.").replace("##",getSizeLabel(cubeSize)),visible:cubeSize>0&&showToggle},{scriptClass:"mstrmojo.HBox",alias:"buttonBox",slot:"buttonNode",cssClass:"mstrmojo-Editor-buttonBar",visible:!showToggle,children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton hot okButton",alias:"ok",text:mstrmojo.desc(2397,"OK"),onclick:function(){ed.close();callback.success(true);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",alias:"cancel",text:mstrmojo.desc(2399,"Cancel"),onclick:function(){ed.close(true);}}]}]}));ed.open();};mstrmojo.onetier.vi.ui.CubeBrowser=mstrmojo.declare(mstrmojo.onetier.vi.ui.OpenFromServerBrowser,null,{scriptClass:"mstrmojo.onetier.vi.ui.CubeBrowser",title:mstrmojo.desc(4354,"Select Intelligent Cube"),help:"pending.htm",browsableTypes:"8,768,769,770,774,776,779",browsableViewMedias:null,callback:null,succeeded:false,addDataset:true,close:function close(){var f=(this.callback||{}).failure;if(!this.succeeded&&f){f({closed:true});}this._super();},openOb:function openOb(){this.toggleNativeMenus(false);var that=this,model=mstrApp.getRootController().docCtrl.model,callback=this.callback||model.getDatasetsUpdateCallback(),getPollingStataus=function getPollingStatus(data,callback){that.connectivityProxy.getPollingStatus({id:data.id},{success:function success(res){switch(res.status){case 1:case 2:mstrApp.getRootController().showOrHideProgressBar(mstrmojo.desc(13568,"Download from server"),false);that.toggleNativeMenus(true);if(res.status===2){if(callback.failure){callback.failure(res.data);}}else{that.connectivityProxy.refreshNativeDialogMenu();callback.success(res.data);}break;case 4:mstrApp.getRootController().showOrHideProgressBar(mstrmojo.desc(13568,"Download from server"),false);if(that.addDataset){mstrApp.getRootController().docCtrl.cmdMgr.cmds.pop();mstrApp.getRootController().docCtrl.cmdMgr.resetState();}that.toggleFields("browsing");return ;default:mstrApp.getRootController().updateProgressBar({pct:res.pct,msg:res.msg,requestID:data.id,canCancel:res.status===0});getPollingStataus(res,callback);}},failure:function failure(res){mstrApp.getRootController().showOrHideProgressBar(mstrmojo.desc(13568,"Download from server"),false);if(callback.failure){callback.failure(res);}}});},addOrReplaceDataset=function addOrReplaceDataset(isDDA,isCube){var cmdMgr=mstrApp.getRootController().docCtrl.cmdMgr,interimCmd,toAddDataset=that.addDataset,downloadCube=function downloadloadCube(){that.connectivityProxy.loadCube({objectID:that.selectedItem.did,sessionState:that.sessionState,addDatasetToDocument:toAddDataset,connectionId:that.connectionId,dda:isDDA,isCube:isCube},{submission:function(){if(toAddDataset){interimCmd=cmdMgr.getInterimCmd();interimCmd.urInfo.callback=callback;interimCmd.undoStateId=cmdMgr.dataService.stid;}},success:function success(res){mstrApp.getRootController().showOrHideProgressBar(mstrmojo.desc(13568,"Download from server"),true);getPollingStataus({id:res.id},mstrmojo.func.wrapMethods(callback,{success:function(res){if(toAddDataset){cmdMgr.dataService.stid=interimCmd.redoStateId=res.stid;interimCmd.state=3;interimCmd._treesFromRes|=(res.defn?1:0)|(res.data?2:0);interimCmd.completeSubmit();cmdMgr.resetState();}that.succeeded=true;mstrApp.rootCtrl.set("dataProvider",new mstrmojo.onetier.vi.ui.ObjectBrowserDataProvider({connectivityProxy:that.connectivityProxy,sessionState:that.sessionState,connectionId:that.connectionId}));that.cacheCurrentFolder();that.close();that.toggleNativeMenus(true);},failure:function(res){if(toAddDataset){cmdMgr.resetState();cmdMgr.cmds.pop();}that.toggleFields("browsing");that.onError(res);that.toggleNativeMenus(true);}}));},failure:function failure(res){if(toAddDataset){cmdMgr.resetState();cmdMgr.cmds.pop();}if(res.cancel){that.close();}else{that.toggleNativeMenus(true);that.toggleFields("browsing");that.onError(res);}}});};if(toAddDataset){cmdMgr.execute({execute:function(){downloadCube();}});}else{downloadCube();}},openDDASelector=function(cubeInfo,isCube){ddaSelector(cubeInfo,{success:function(res){addOrReplaceDataset(res,isCube);},failure:function(close){that.toggleNativeMenus(true);if(!close){that.toggleFields("browsing");}else{that.close();}}});},loadCube=function(){that.connectivityProxy.getCubeInfo({cubeIds:that.selectedItem.did,sessionState:that.sessionState,connectionId:that.connectionId},{success:function(res){openDDASelector(res,true);},failure:function(res){if(res.cancel){that.close();}else{that.onError(res);that.toggleFields("browsing");}}});},currProject=this.loginToProjectBox.currentProject;this.model=model;this.toggleFields("loading");that.connectivityProxy.isCurrentProject(currProject,{success:function(isCurrentProject){if(isCurrentProject){if(that.selectedItem.st===779||that.selectedItem.st===776){loadCube();}else{addOrReplaceDataset(false,false);}}else{mstrmojo.confirm(mstrmojo.desc(16169,"A dashboard can have Intelligent Cubes from a single MicroStrategy project only. If you add the selected cube, all other cubes will be removed from this dashboard. Do you want to continue?"),{confirmBtn:{fn:function(){that.connectivityProxy.getCleanDocModel({success:function(docModelData){mstrApp.start(docModelData);var newDocModel=mstrApp.rootCtrl.docCtrl.model;that.callback=callback=newDocModel.getDatasetsUpdateCallback();that.docModel=newDocModel;loadCube();}});}},cancelBtn:{fn:function(){that.toggleFields("browsing");}}});}}});}});}());