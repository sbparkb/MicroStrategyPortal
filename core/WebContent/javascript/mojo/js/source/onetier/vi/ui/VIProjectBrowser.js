(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.SaveAsEditor","mstrmojo.HBox","mstrmojo.Label","mstrmojo.ui.Pulldown","mstrmojo.func","mstrmojo.hash","mstrmojo.css","mstrmojo.dom","mstrmojo.onetier.vi.ui.ObjectBrowserDataProvider","mstrmojo.onetier.vi.ui.LoginToProjectBox","mstrmojo.onetier.vi.prefs.DesktopConnectivityProxyBase");var $DOM=mstrmojo.dom,$CSS=mstrmojo.css,$HASH=mstrmojo.hash,$ERROR=mstrmojo.onetier.vi.prefs.handleErrorMessage,$INFO_CACHE={},AUTH_MODES=mstrmojo.onetier.vi.ui.LoginBox.AUTH_MODES,FOLDER_LINKS={AUTH_USER:30,GUEST:31},_toggleFields=function _toggleFields(state){var editorNode=this.editorNode;$CSS.toggleClass(editorNode,"loading",false);switch(state){case"loading":$CSS.toggleClass(editorNode,"loading",true);break;case"login":$CSS.toggleClass(editorNode,"login",true);$CSS.toggleClass(editorNode,"ready",false);$CSS.toggleClass(editorNode,"browsing",false);$CSS.toggleClass(editorNode,"selectingProject",false);break;case"browsing":$CSS.toggleClass(editorNode,"login",false);$CSS.toggleClass(editorNode,"ready",true);$CSS.toggleClass(editorNode,"browsing",true);$CSS.toggleClass(editorNode,"selectingProject",false);break;case"simple":$CSS.toggleClass(editorNode,"login",false);$CSS.toggleClass(editorNode,"ready",true);$CSS.toggleClass(editorNode,"browsing",false);$CSS.toggleClass(editorNode,"selectingProject",false);break;case"selectingProject":$CSS.toggleClass(editorNode,"login",false);$CSS.toggleClass(editorNode,"ready",false);$CSS.toggleClass(editorNode,"browsing",false);$CSS.toggleClass(editorNode,"selectingProject",true);}if(this.hasRendered){this.positionDialog();}},cacheValue=function cacheValue(key,value){var cache=$INFO_CACHE;if(!cache[this.sessionState]){cache[this.sessionState]={};}cache[this.sessionState][key]=value;},getCachedValue=function getCachedValue(key){var cache=$INFO_CACHE;if(cache[this.sessionState]){return cache[this.sessionState][key];}},cacheLastFolder=function cacheLastFolder(){var item=this.selectedFolder;if(item){cacheValue.call(this,"lastFolderId",item.did);}};mstrmojo.onetier.vi.ui.VIProjectBrowser=mstrmojo.declare(mstrmojo.SaveAsEditor,null,{scriptClass:"mstrmojo.onetier.vi.ui.VIProjectBrowser",help:"pending.htm",cssClass:"mstrmojo-SaveAsEditor mstrmojo-ViProjectBrowser server",browseOnOpen:false,browsableTypes:"8,55,768,769,770,774",folderLinksContextId:FOLDER_LINKS.AUTH_USER,useRichTooltip:false,toggleFields:_toggleFields,onError:$ERROR,rootFolderConf:null,_set_sessionState:function(n,v){this.sessionState=v;return true;},toggleNativeMenus:function toggleNativeMenus(enabled){if(mstrApp.isSingleTier){window.FormWrapper.toggleNetMenu(enabled?"enable":"disable");}},onconnectionIdChange:function onConnectionIdChange(){this.ob.getDataProvider().set("connectionId",this.connectionId);},onsessionStateChange:function onSessionStateChange(){this.ob.getDataProvider().set("sessionState",this.sessionState);this.afterLogin(this.sessionState);},afterLogin:function afterLogin(sessionState){_toggleFields.call(this,"simple");var c=$INFO_CACHE,cs=c[sessionState],folderLinksId=(this.loginToProjectBox.authMode.v===AUTH_MODES.authAnonymous.v)?FOLDER_LINKS.GUEST:FOLDER_LINKS.AUTH_USER;if(!cs){cs=c[sessionState]={};}if(!cs.folderLinksContextid){cs.folderLinksContextid=folderLinksId;}folderLinksId=cs.folderLinksContextid;this.folderLinksContextId=this.ob.folderLinksContextId=folderLinksId;this.ob.rootFolderID=cs.lastFolderId;},initBrowser:function initBrowser(state){var editor=this;editor.ob.browse(null,{success:function(res){this.selectedFolder=res;if(!getCachedValue.call(editor,"rootFolderConf")){cacheValue.call(editor,"rootFolderConf",res);}_toggleFields.call(this,state);}.bind(this)});},getLoginProjectBoxClass:function(){return"mstrmojo.onetier.vi.ui.LoginToProjectBox";},getValidatesConnectedServer:function(){return true;},init:function init(props){var editor=this;this.children=[{alias:"message",scriptClass:"mstrmojo.Label",cssClass:"message",text:mstrmojo.desc(13552,"Select a location to save your dashboard:")},{alias:"loginToProjectBox",scriptClass:this.getLoginProjectBoxClass(),docModel:props.docModel,connectivityProxy:props.connectivityProxy,selectedProject:props.selectedProject,validateConnectedServer:this.getValidatesConnectedServer(),ifNoWebProjects:function(){editor.close();},callback:{success:function(res){mstrApp.rootCtrl.selectedProject=editor.loginToProjectBox.currentProject;mstrApp.rootCtrl.authMode=editor.loginToProjectBox.loginBox.authMode;editor.set("connectionId",res.connectionId);editor.set("sessionState",res.sessionState);}},projectChanged:function projectChanged(){editor.selectedFolder=null;editor.selectedItem=null;editor.validate();}},{alias:"loadingBox",scriptClass:"mstrmojo.Box",cssClass:"loadingBox"}].concat(this.children);var buttonBox=$HASH.copy(this.children.pop());buttonBox.children=[{alias:"loginButton",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-Editor-button mstrmojo-WebButton hot loginButton",text:mstrmojo.desc(26,"Login"),onclick:function(){editor.loginToProjectBox.getSession();}},{alias:"openButton",scriptClass:"mstrmojo.Button",enabled:false,cssClass:"mstrmojo-Button mstrmojo-Editor-button mstrmojo-WebButton hot openButton",text:mstrmojo.desc(2309,"Open"),onclick:function(){this.parent.parent.openOb();}}].concat(buttonBox.children);this.children.push({alias:"showMore",scriptClass:"mstrmojo.Label",cssClass:"showBrowserLabels showBrowser",text:mstrmojo.desc(13715,"Show browser"),onclick:function(){_toggleFields.call(editor,"browsing");if(editor.ob.obList&&editor.ob.obList.updateScrollbars){editor.ob.obList.updateScrollbars();}}},{alias:"showLess",scriptClass:"mstrmojo.Label",cssClass:"showBrowserLabels hideBrowser",text:mstrmojo.desc(13563,"Hide browser"),onclick:function(){_toggleFields.call(editor,"simple");}},buttonBox);this._super(props);var ob=this.ob,obTitleBar=ob.titleBar,obIncFetch=ob.obIncFetch;_toggleFields.call(this,"simple");_toggleFields.call(this,"loading");ob.showCompletePath=false;ob.useOldSearch=true;ob.getDataProvider=function(){if(!ob.dataProvider){ob.dataProvider=new mstrmojo.onetier.vi.ui.ObjectBrowserDataProvider({connectivityProxy:editor.connectivityProxy});}return ob.dataProvider;};ob.onError=function(res){if(res.taskErrorCode===-2147028992){mstrmojo.error({longDesc:res.errorMessage},undefined,{zIndex:100000});}else{editor.onError(res);}switch(res.taskErrorCode){case -2147209051:editor.loginToProjectBox.logout();break;case -2147207899:case -2147028992:mstrApp.serverProxy.cancelRequests();editor.loginToProjectBox.logout();break;default:editor.close();break;}};if(editor.browsableViewMedias){ob.browsableViewMedias=editor.browsableViewMedias;}ob.updateUpButton=function onNewPageLoaded(info){var res=!(!info.pf||!mstrmojo.hash.walk("anc.items.0.items",info)),rootFolderConf=getCachedValue.call(editor,"rootFolderConf");if(res){(rootFolderConf.sc||[]).forEach(function(folder){if(folder.did===info.did||rootFolderConf.did===info.did){res=false;}});}this.set("canGoUp",res);};ob.set("scrollableIncFetch",true);obTitleBar.saveLabel.set("text",mstrmojo.desc(2475,"Folder:"));obTitleBar.title.onPopupAutoClosed=function(e,hWin){if($DOM.contains(this.domNode,$DOM.eventTarget(hWin,e),true,document.body)){this.autoClosed=true;}};obTitleBar.title.premousedown=function premousedown(){if(this.autoClosed){delete this.autoClosed;}else{this.togglePopup();}};obIncFetch.cssText="";obIncFetch.onvisibleChange=function(){mstrmojo.css.toggleClass(this.parent.domNode,"show-inc-fetch",this.visible);};if(props.dataProvider){this.loginToProjectBox.authMode=this.loginToProjectBox.loginBox.authMode=props.authMode||{};ob.dataProvider=props.dataProvider;this.set("connectionId",props.dataProvider.connectionId);if(props.selectedProject){this.set("sessionState",props.dataProvider.sessionState);var projectSelector=this.loginToProjectBox.projectBox.projectSelector;this.loginToProjectBox.currentProject=props.selectedProject;projectSelector.selectedIndex=0;projectSelector.items=[props.selectedProject];projectSelector.refresh();}}},onOpen:function(){_toggleFields.call(this,"loading");this.toggleNativeMenus(false);if(!this.sessionState&&!this.connectionId){this.loginToProjectBox.populateProjects();}else{if(!this.loginToProjectBox.currentProject){this.loginToProjectBox.populateProjects();}}if(!this.loginButtonListener){this.loginButtonListener=mstrApp.attachEventListener("loginButtonDisplay",this.id,function(e){$CSS.toggleClass(this.buttonBox.loginButton.domNode,"hide",!e.value);}.bind(this));}},validate:mstrmojo.emptyFn,onOBSelect:function(item){this.selectedItem=item;this.contPanel.name.set("value",item.n);this.validate();},onOBBrowseFolder:function(item){this.selectedItem=null;this.selectedFolder=item;this.validate();},serverRequest:function serverRequestProxy(params,callback){this.connectivityProxy.sendWebServerRequest(params,callback,{silent:true});},close:function(){if(this.loginButtonListener){mstrApp.detachEventListener(this.loginButtonListener);delete this.loginButtonListener;}this.toggleNativeMenus(true);this.loginToProjectBox.docModel=null;this.docModel=null;this.dataProvider=null;this._super();this.destroy();},cacheCurrentFolder:function cacheCurrentFolder(){cacheLastFolder.call(this);},saveAs:mstrmojo.empty,openOb:mstrmojo.empty});}());