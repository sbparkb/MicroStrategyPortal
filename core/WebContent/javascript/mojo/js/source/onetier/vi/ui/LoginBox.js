(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.hash","mstrmojo.array","mstrmojo.css","mstrmojo.Editor","mstrmojo.UsherLogin");var $HASH=mstrmojo.hash,$CSS=mstrmojo.css,$ERROR=mstrmojo.onetier.vi.prefs.handleErrorMessage,AUTH_MODES={authStandard:{desc:function(){return mstrmojo.desc(13560,"Standard Authentication");},v:1,rlp:true},authLDAP:{desc:function(){return mstrmojo.desc(1947,"LDAP Authentication");},v:16,rlp:true},authWarehousePassthrough:{desc:function(){return mstrmojo.desc(1948,"Database Authentication");},v:32,rlp:true},authAnonymous:{desc:function(){return mstrmojo.desc(2824,"Guest User");},v:8},authNTCredential:{desc:function(){return mstrmojo.desc(298,"Windows Authentication");},v:2},authIntegrated:{desc:function(){return mstrmojo.desc(5595,"Integrated Authentication");},v:128},authTrusted:{desc:function(){return mstrmojo.desc(4611,"Trusted Authentication Request");},v:64},authUsher:{desc:function(){return mstrmojo.desc(11632,"Usher");},v:256}},authModeChanged=function authModeChanged(checkList,evt,authMode){var loginBox=this;authMode=authMode||checkList.items[evt.added[0]];loginBox.authMode=authMode;loginBox.set("enable2FA",(authMode.v&AUTH_MODES.authStandard.v)>0||(authMode.v&AUTH_MODES.authLDAP.v)>0);if(authMode.rlp){if(loginBox.standardLogin.user.inputNode&&loginBox.standardLogin.pwd.inputNode){loginBox.standardLogin.user.inputNode.disabled=false;loginBox.standardLogin.pwd.inputNode.disabled=false;}}else{if(loginBox.standardLogin.user.inputNode&&loginBox.standardLogin.pwd.inputNode){loginBox.standardLogin.user.inputNode.disabled=true;loginBox.standardLogin.pwd.inputNode.disabled=true;}}},_toggleFields=function _toggleFields(state){$CSS.toggleClass(this.domNode,"showSingleLoginLabel",false);switch(state){case"noLoginAndPassword":$CSS.toggleClass(this.domNode,"noLoginAndPassword",true);break;case"showSingleLoginLabel":$CSS.toggleClass(this.domNode,"showSingleLoginLabel",true);break;case"simpleAuth":$CSS.toggleClass(this.domNode,"advancedAuth",false);break;case"advAuth":$CSS.toggleClass(this.domNode,"advancedAuth",true);break;case"singleAuthMode":$CSS.toggleClass(this.domNode,"singleAuthMode",true);break;case"multiAuthMode":$CSS.toggleClass(this.domNode,"singleAuthMode",false);break;}},login=function login(loginTaskConfig,loginTaskParams,callback){var loginBox=this,user=loginBox.standardLogin.user.value,pwd=loginBox.standardLogin.pwd.value,tsv=loginBox.standardLogin.tsv.value,authMode=loginBox.authMode.v,params={};params[loginTaskConfig.authModeParamName]=authMode;params[loginTaskConfig.userIdFieldName]=user;params[loginTaskConfig.passwordFieldName]=pwd;params[loginTaskConfig.twoFactorParamName]=tsv;$HASH.copy(loginTaskParams,params);this.parent.connectivityProxy[loginTaskConfig.method](params,callback);},validateArgs=function validateArgs(){var isValid=!!this.connectionId&&(this.isLoginFirst||(this.iServerName&&this.projectName&&this.port!==undefined&&this.port!==null));return isValid;},validVersion=function validVersion(minVersion,currVersion){var mva=(minVersion+"").split(".").concat(["0","0","0"]),cva=(currVersion+"").split(".").concat(["0","0","0"]),i=0,mvai,cvai;for(;i<4;i++){mvai=parseInt(mva[i]);cvai=parseInt(cva[i]);if(mvai===cvai){continue;}return mvai<cvai;}return true;},hideTrustedRadioButton=function(radioList){var usherItemIdx=this.usherItemIndex,trustedItemNode=radioList._getItemNode(usherItemIdx);if(usherItemIdx>-1&&trustedItemNode){$CSS.toggleClass(trustedItemNode,"hide",true);}},toggleAuthModeForUsherLogin=function(advAuth,index){if(this.usherLoginMode&&this.usherItemIndex){advAuth.select(this.usherItemIndex);}else{advAuth.select(index||0);advAuth.refresh();hideTrustedRadioButton.call(this,advAuth);}};mstrmojo.onetier.vi.ui.LoginBox=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.onetier.vi.ui.LoginBox",cssClass:"mstrmojo-loginBox",children:[{alias:"standardLogin",scriptClass:"mstrmojo.Box",bindings:{visible:"!this.parent.usherLoginMode"},children:[{alias:"singleLoginLabel",cssClass:"singleLoginLabel",scriptClass:"mstrmojo.Label",visible:false,onclick:function(){this.parent.parent.getSession();}},{alias:"user",scriptClass:"mstrmojo.TextBox",cssClass:"user",cssDisplay:"block",hint:mstrmojo.desc(17,"User name"),postCreate:function(){if(mstrmojo.dom.isIE9||mstrmojo.dom.isIE8||mstrmojo.dom.isIE7){this.emptyText=mstrmojo.desc(17,"User name");}},onRender:function(){window.setTimeout(function(){this.focus();}.bind(this),300);},onEnter:function(){this.parent.parent.getSession();}},{alias:"pwd",scriptClass:"mstrmojo.TextBox",cssClass:"pwd",cssDisplay:"block",hint:mstrmojo.desc(18,"Password"),type:"password",postCreate:function(){if(mstrmojo.dom.isIE9||mstrmojo.dom.isIE8||mstrmojo.dom.isIE7){this.emptyText=mstrmojo.desc(18,"Password");}},onEnter:function(){this.parent.parent.getSession();}},{alias:"tsv",scriptClass:"mstrmojo.TextBox",cssDisplay:"block",hint:mstrmojo.desc(13825),postCreate:function(){if(mstrmojo.dom.isIE9||mstrmojo.dom.isIE8||mstrmojo.dom.isIE7){this.emptyText=mstrmojo.desc(13825,"Usher code");}},onEnter:function(){this.parent.parent.getSession();},bindings:{visible:"this.parent.parent.has2FA && this.parent.parent.enable2FA"}},{alias:"sprtr",scriptClass:"mstrmojo.Label",cssClass:"seperator",text:""},{alias:"showAdvAuth",scriptClass:"mstrmojo.Label",cssClass:"authLabel showAdvAuth",text:mstrmojo.desc(13863,"Change authentication mode"),onclick:function(){_toggleFields.call(this.parent.parent,"advAuth");}},{alias:"authBox",scriptClass:"mstrmojo.Box",cssClass:"authBox",children:[{alias:"advAuth",scriptClass:"mstrmojo.RadioList",cssClass:"authModes",labelCssClass:"labelAuth",rowCssClass:"radioAuth",onselectionChange:function(evt){authModeChanged.call(this.parent.parent.parent,this,evt);}},{alias:"showSimpleAuth",scriptClass:"mstrmojo.Label",cssClass:"authLabel showSimpleAuth",text:mstrmojo.desc(13862,"Hide authentication modes"),onclick:function(){_toggleFields.call(this.parent.parent.parent,"simpleAuth");}}]}]},{alias:"usherLoginWidget",scriptClass:"mstrmojo.UsherLogin",showBadgeBackgroundImage:false,bindings:{serverName:"this.parent.iServerName",serverPort:"this.parent.port",projectName:"this.parent.projectName",connectionId:"this.parent.connectionId",loadQR:"this.parent.isLoginFirst",visible:"!!this.parent.usherLoginMode && this.parent.loginVisible"},onUsherLogin:function(){this.parent.getSession();}},{alias:"toggleLogin",scriptClass:"mstrmojo.Label",cssClass:"toggleLogin",allowHTML:true,bindings:{visible:"((this.parent.enabledAuthModes & 0x100) !== 0) && (this.parent.enabledAuthModes !== 0x100)"}}],loginVisible:true,usherLoginMode:null,enabledAuthModes:null,onusherLoginChange:function(){this.set("usherLoginMode",this.usherLogin);},onusherLoginModeChange:function(){mstrApp.raiseEvent({name:"loginButtonDisplay",value:!this.usherLoginMode});this.toggleLogin.set("text",(!this.usherLoginMode?'<a href="#" onclick="mstrmojo.all.'+this.id+'.toggleLoginMode(this); return false;">'+mstrmojo.desc(14140,"Display your ###QR Code##.").replace("###","").replace("##","")+"</a>":mstrmojo.desc(14136,"Use your ###Usher## app to scan the QR Code.").replace("###","").replace("##","")+'<br/><a href="#" onclick="mstrmojo.all.'+this.id+'.toggleLoginMode(this); return false;">'+mstrmojo.desc(14138,"Or, you can enter your ###Credentials##.").replace("###","").replace("##","")+"</a>"));},loginConfigUpdated:function loginConfigUpdated(){if(this.usherLogin&&this.usherLoginMode){this.usherLoginWidget.reloadQR();}},toggleLoginMode:function(){var advAuth=this.standardLogin.authBox.advAuth;this.set("usherLoginMode",!this.usherLoginMode);toggleAuthModeForUsherLogin.call(this,advAuth);},updateAuthModes:function updateAuthModes(enabledAuthModes,defaultAuthMode){var loginBox=this,items=[],au=loginBox.standardLogin.authBox.advAuth,selectedIndex,count=0,usherLogin=loginBox.usherLogin,compatibleAuthMode=usherLogin&&(defaultAuthMode===AUTH_MODES.authTrusted.v),usherAuthMode=defaultAuthMode===AUTH_MODES.authUsher.v,usherLoginEnabled=usherLogin||(enabledAuthModes&AUTH_MODES.authUsher.v)>0,showUsherLogin=usherAuthMode||compatibleAuthMode,noLoginAndPassword=true;this.set("enabledAuthModes",enabledAuthModes);$HASH.forEach(AUTH_MODES,function(authMode){if((enabledAuthModes&authMode.v)!==0){items.push({v:authMode.v,n:authMode.desc(),rlp:authMode.rlp});noLoginAndPassword=noLoginAndPassword&&!authMode.rlp;if((defaultAuthMode&authMode.v)!==0){selectedIndex=count;authModeChanged.call(loginBox,au,null,authMode);}count++;}});au.selectedIndices=[];au.selectedIndices[selectedIndex]=true;au.items=items;au.refresh();if(usherLoginEnabled){this.usherItemIndex=mstrmojo.array.find(items,"v",compatibleAuthMode?AUTH_MODES.authTrusted.v:AUTH_MODES.authUsher.v);toggleAuthModeForUsherLogin.call(this,au,selectedIndex);}else{delete this.usherItemIndex;}$CSS.toggleClass(this.domNode,"usherLogin",usherLoginEnabled);if(usherLoginEnabled){_toggleFields.call(loginBox,"advAuth");}else{if(noLoginAndPassword){_toggleFields.call(loginBox,"noLoginAndPassword");}else{if(items.length<=1){_toggleFields.call(loginBox,"singleAuthMode");}else{_toggleFields.call(loginBox,"multiAuthMode");}}}},connectionId:null,iServerName:null,projectName:null,port:null,isLoginFirst:false,onSessionObtained:mstrmojo.emptyFn,minVersion:"9.5.0000.0000",onError:function(res){$ERROR(res);},tryGetSession:function tryGetSession(doNotTry){var currentModeRequiresLogin=this.authMode.rlp;if(this.standardLogin.authBox.advAuth.items.length===1){if(!currentModeRequiresLogin&&!this.usherLogin){_toggleFields.call(this,"simpleAuth");if(doNotTry){_toggleFields.call(this,"showSingleLoginLabel");this.standardLogin.singleLoginLabel.set("text",this.authMode.desc());}else{this.getSession();}}}else{if(!currentModeRequiresLogin){_toggleFields.call(this,"advAuth");}}},getSession:function getSession(){if(!validateArgs.call(this)){$ERROR({errorMessage:"Invalid config on LoginBox"});return ;}var connectionId=this.connectionId,iServerName=this.iServerName,projectName=this.projectName,isUsherLogin=this.usherLoginMode,port=this.port,loginTaskConfig,loginTaskParams={connectionId:connectionId};if(this.isLoginFirst){if(this.webServerURL){loginTaskParams={webServerURL:this.webServerURL};}loginTaskConfig={method:"loginFirst",userIdFieldName:"Uid",passwordFieldName:"Pwd",authModeParamName:"ConnMode",twoFactorParamName:"tsvc"};}else{loginTaskConfig={method:isUsherLogin?"usherLoginWeb":"login",userIdFieldName:"userid",passwordFieldName:"password",authModeParamName:"authMode",twoFactorParamName:"tsvCode"};loginTaskParams.server=iServerName;loginTaskParams.project=projectName;loginTaskParams.port=port;}login.call(this,loginTaskConfig,loginTaskParams,{success:function(res){this.standardLogin.pwd.set("value","");if(!res.version||!this.minVersion||validVersion(this.minVersion,res.version)){this.onSessionObtained(res.sessionState);var dsPanel=mstrApp.rootCtrl.datasetsPanel;if(res.disableAllObjects===true){if(dsPanel&&dsPanel.allObjectBrowserOpened===true){dsPanel.set("allObjectBrowserOpened",false);mstrmojo.alert(mstrmojo.desc(14332,"You do not have the privileges to browse the objects in this project."));mstrApp.serverProxy.cancelRequests();}if(mstrmojo.all[dsPanel.datasetEditorId]){mstrmojo.alert(mstrmojo.desc(14332,"You do not have the privileges to browse the objects in this project."));mstrmojo.all[dsPanel.datasetEditorId].destroy();}}mstrApp.set("browseAllObjects",!res.disableAllObjects);}else{this.onError({errorMessage:mstrmojo.desc(473,"The Intelligence Server version and the client version are incompatible")});}}.bind(this),failure:function(res){this.onError(res);}.bind(this)});}});mstrmojo.onetier.vi.ui.LoginBox.AUTH_MODES=AUTH_MODES;mstrmojo.onetier.vi.ui.LoginBox.openDialog=function(label,connInfo,connectivityProxy,callback){var webServer=connInfo.webServer,connectionId=webServer.connection.id,iServer=connInfo.iServer||{},loginFirst=webServer.loginFirst,project=connInfo.project||{},loginInfo=(loginFirst?webServer.loginInfo:project.loginInfo),enabledAuthModes=loginInfo.enabledAuthModes,defaultAuthMode=loginInfo.defaultAuthMode,usherLogin=loginInfo.usherLogin,has2FA=loginInfo.has2FA,webServerURL=loginFirst?webServer.url:null,getConnectivityProxy=function(){return connectivityProxy||(mstrApp.isSingleTier?new mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy():new mstrmojo.onetier.vi.prefs.HostedDesktopConnectivityProxy());};var editor=(new mstrmojo.Editor({cssClass:"mstrmojo-onetier-loginDialog",title:mstrmojo.desc(26,"Login"),connectivityProxy:getConnectivityProxy(),zIndex:99999,onClose:function(){window.setTimeout(function(){editor.destroy();},100);},children:[{alias:"label",scriptClass:"mstrmojo.Label",cssClass:"label",text:label,visible:!!label},{alias:"loginBox",scriptClass:"mstrmojo.onetier.vi.ui.LoginBox",connectionId:connectionId,iServerName:iServer.name,port:iServer.port,projectName:project.name,isLoginFirst:loginFirst,webServerURL:webServerURL,onSessionObtained:function(sessionState){callback.success(sessionState,editor.loginBox.authMode.v);editor.close();},onError:function(res){if(callback.failure){callback.failure(res);}else{$ERROR(res);}}},{scriptClass:"mstrmojo.HBox",alias:"buttonBox",slot:"buttonNode",cssClass:"mstrmojo-Editor-buttonBar",children:[{alias:"addConnection",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",text:mstrmojo.desc(14395,"Edit Connection"),onclick:function onclick(){editor.close();editor.connectivityProxy.authenticationCancelled();editor.connectivityProxy.showPreferencesEditor({inputConnectionDetails:true});}},{alias:"loginButton",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-Editor-button mstrmojo-WebButton hot loginButton",text:mstrmojo.desc(26,"Login"),onclick:function onclick(){editor.loginBox.getSession();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",alias:"cancel",text:mstrmojo.desc(221,"Cancel"),onclick:function onclick(){editor.close();editor.connectivityProxy.authenticationCancelled();}}]}]}));if(!editor.loginButtonListener){editor.loginButtonListener=mstrApp.attachEventListener("loginButtonDisplay",editor.id,function(e){this.buttonBox.loginButton.domNode.style.display=!e.value?"none":"block";}.bind(editor));}editor.open();delete editor.loginBox.usherLogin;delete editor.loginBox.has2FA;editor.loginBox.set("usherLogin",((enabledAuthModes&mstrmojo.onetier.vi.ui.LoginBox.AUTH_MODES.authTrusted.v)>0)&&usherLogin||((loginInfo.defaultAuthMode&mstrmojo.onetier.vi.ui.LoginBox.AUTH_MODES.authUsher.v)>0));editor.loginBox.set("has2FA",has2FA);editor.loginBox.updateAuthModes(enabledAuthModes,defaultAuthMode);};}());