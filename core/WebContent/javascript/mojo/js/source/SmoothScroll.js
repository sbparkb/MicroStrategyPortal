(function(){mstrmojo.requiresCls("mstrmojo._HasTouchScroller","mstrmojo.dom");var $D=mstrmojo.dom;function rectIntersection(a,b){var x=Math.max(a.x,b.x);var y=Math.max(a.y,b.y);var w=Math.min(a.x+a.w,b.x+b.w)-x;var h=Math.min(a.y+a.h,b.y+b.h)-y;if(w<0||h<0){return{x:NaN,y:NaN,w:NaN,h:NaN};}return{x:x,y:y,w:w,h:h};}function copyRect(a){return{x:a.x,y:a.y,w:a.w,h:a.h};}mstrmojo.SmoothScroll=mstrmojo.provide("mstrmojo.SmoothScroll",{viewRect:null,scrollerRect:null,unitRect:null,cachedUnits:[],demarcationUnits:{left:null,right:null,top:null,bottom:null},viewCutX:function(){},storeUnits:function(){this.cachedUnits=[];var ir=copyRect(this.unitRect),len=Math.ceil(this.scrollRect.h/ir.h),i;for(i=0;i<len;i++,ir.y+=ir.h){var unit=this.getUnitFromPoint(ir.x+ir.w/2,ir.y+ir.h/2);if(!unit){continue;}this.cachedUnits.push(unit);}},appendUnits:function(i1,i2){var cus=this.cachedUnits,i;for(i=i1;i<=i2;i++){var unit=cus[i];if(!unit){return ;}if(unit.outside==true){unit.outside=false;var p=unit._parentNode,cn=p.children;p.insertBefore(unit,cn[unit._oldIndex]);p.style.paddingTop="";delete unit._parentNode;delete unit._oldIndex;}}console.log(i2-i1+1+" units added.");},removeUnits:function(i1,i2){var cus=this.cachedUnits,i;for(i=i1;i<=i2;i++){var unit=cus[i];if(!unit){return ;}if(unit.outside!=true){var p=unit.parentNode,cn=p.children;unit._parentNode=p;unit._oldIndex=0;p.removeChild(unit);p.style.paddingTop=this.unitRect.h+"px";unit.outside=true;}}console.log(i2-i1+1+" units removed.");},viewCutY:function(e){if(!this.viewRect||!this.scrollRect||!this.unitRect){return ;}var y1=e?e.y:this._scroller.origin.y,y2=y1+this.viewRect.h;if(!this._scroller||!this._scroller.scrollEl){console.log("no scrollEl.");return ;}var scrollEl=this._scroller.scrollEl;var i1=Math.floor(y1/this.unitRect.h),i2=Math.floor(y2/this.unitRect.h),cus=this.cachedUnits,len=cus.length;delta=0;this.removeUnits(0,i1-1);this.appendUnits(i1,i2);this.removeUnits(i2+1,len);delta=i1;console.log("do viewCut.");},updateScroller:function(o,d){if(this._super){this._super(o,d);}var $P=mstrmojo.dom.position;if(!this.unitRect||!this.unitRect.w||!this.unitRect.h){var su=this.cachedUnits[0];if(!su){return ;}this.unitRect=$P(su);}if(this.viewNode){this.viewRect=$P(this.viewNode);}this.scrollRect={x:this.unitRect.x,y:this.unitRect.y,w:this.unitRect.w,h:this.unitRect.h*this.cachedUnits.length};if(!this.viewRect||!this.scrollRect||!this.unitRect){return ;}this.viewCutY(this._scroller.origin);},getUnitFromPoint:function(x,y){var cache=[],found=false;do{var target=document.elementFromPoint(x,y);if(target==lastTarget){break;}if(target.offsetHeight==this.unitRect.h&&target.offsetWidth==this.unitRect.w){found=true;}else{target.__metaDisplay=target.style.display;cache.push(target);target.style.display="none";}var lastTarget=target;}while(!found&&target!=document.body);var ret=target;while(cache.length){var target=cache.pop();target.style.display=target.__metaDisplay;delete target.__metaDisplay;}if(found){return ret;}else{return null;}},postBuildRendering:function(c){if(this._super){this._super(c);}console.log("event binded!");this.smoothSwipeListener=this._scroller.attachEventListener("scrollMoved",this.id,this.viewCutY);},unrender:function(){if(this._super){this._super();}}});}());