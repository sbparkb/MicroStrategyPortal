(function(){mstrmojo.requiresCls("mstrmojo.gm.GMEnums","mstrmojo.hash","mstrmojo.DocDataService","mstrmojo.VisEnum.GMLegendFormatingPropertyTag","mstrmojo.VisUtility");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$WRAP=mstrmojo.func.wrapMethods;function cmdMgr(me){return me.model.controller.cmdMgr;}mstrmojo._colorPalette=mstrmojo.provide("mstrmojo._colorPalette",{listenToUpdateColorMap:function(refreshCallBack){if(mstrmojo.VisUtility.isOnExpressMode()){return ;}var me=this,panel,docModel=(me.getDocModel&&me.getDocModel())||me.model.docModel;if(docModel){return docModel.attachEventListener("colorMapChanged",me.id,function(evt){panel=me.parent.parent;if(panel.isPanelDisplaying()){refreshCallBack.call(me);}else{var panelDisplayLister=panel.attachEventListener("panelDisplaying",me.id,function(evt){if(me.postBuilderingCalled){refreshCallBack.call(me);}panel.detachEventListener(panelDisplayLister);});}});}},detachUpdateColorMapListener:function(sub){if(!sub){return ;}var docModel=(this.getDocModel&&this.getDocModel())||this.model.docModel;docModel.detachEventListener(sub);},submitUpdatesAndPersistXML:function submitUpdatesAndPersistXML(actions,callbacks,suppressData,rqstOnlyDefn){if(!actions||actions.length===0){return ;}var extra={},me=this,docModel=(me.getDocModel&&me.getDocModel())||me.model.docModel,dataService=docModel.getDataService(),controller=me.model.controller||docModel.controller,undoRedoCallback=controller._getXtabCallback(me);if(suppressData){$HASH.copy(mstrmojo.DocDataService.SUPPRESS_DATA,extra);}if(rqstOnlyDefn){$HASH.copy(mstrmojo.DocDataService.REQUEST_ONLY_DEFINITION,extra);}var updateColorMap=false;$ARR.forEach(actions,function(action){if(action.act==="updateElementsPropertiesMap"){updateColorMap=true;}});if(updateColorMap){$WRAP(docModel.getUpdateColorMapCallback(),undoRedoCallback);}cmdMgr(me).execute({execute:function execute(){var update=dataService.newUpdate(this,undefined);update.add(actions,callbacks,extra);this.submitUpdate(update);},urInfo:{callback:undoRedoCallback}});},updateColorMap:function(comb,color){if(!$ARR.isArray((color))){color=[color];comb=[comb];}if(comb.length!==color.length){throw new Error("comb and color number mismatch");}var docModel=(this.getDocModel&&this.getDocModel())||this.model.docModel,getUpdateColorMapAction=mstrmojo.VisUtility.getUpdateColorMapAction.bind(this),colorAction=comb.map(function(cb,idx){return getUpdateColorMapAction(cb,JSON.stringify({color:color[idx]}));});this.submitUpdatesAndPersistXML(colorAction,docModel.getUpdateColorMapCallback(),false,true);}});}());