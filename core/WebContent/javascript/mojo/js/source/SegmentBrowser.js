(function(){mstrmojo.requiresCls("mstrmojo.dnd","mstrmojo.WaitIcon","mstrmojo.Editor","mstrmojo.OBList","mstrmojo.CheckBox","mstrmojo.cookies");var _P="Brand Segments",_S="Shared Segments",PRIVATE_F=92,SHARED_F="F9BD9DCBCE304441AB44A61F6D34EFDF",delItem=function(item,me){var params={taskId:"deleteObject",objectType:"1",objectID:item.did},fn={success:function(res){var selIdx=me.selectedIndex,itslen=-1;me.clearSelect();me.remove(selIdx);itslen=me.items.length;if(itslen){me.singleSelect(selIdx<itslen?selIdx:itslen-1);}},failure:function(res){mstrmojo.alert("Error While Deleting Segment:"+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},noConfirm=mstrmojo.cookies.getCookieSetting("confDelSeg")=="1";if(noConfirm){mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,fn,params);}else{mstrmojo.insert({scriptClass:"mstrmojo.Dialog",title:mstrmojo.desc(3610),width:"475px",children:[{scriptClass:"mstrmojo.Label",text:"Are you sure you want to delete the segment?",cssText:"padding: 5px 10px;"},{scriptClass:"mstrmojo.ImageCheckBox",alias:"noconfirm",checked:false,label:"Do not show me again",cssText:"padding: 0 5px;",visible:mstrmojo.cookies.enabledCookieOnBrowser()}],buttons:[mstrmojo.Button.newInteractiveButton(mstrmojo.desc(1442),null,null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",onclick:function(){var d=this.parent.parent;mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,fn,params);if(d.noconfirm.checked){mstrmojo.cookies.updateCookieSetting("confDelSeg","1",true);}d.destroy();}}),mstrmojo.Button.newInteractiveButton(mstrmojo.desc(221),null,null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",onclick:function(){this.parent.parent.destroy();}})]}).render();}},turnPage=function(sb,data,pidx){var w=mstrmojo.insert({scriptClass:"mstrmojo.DeletableList",cssClass:"mstrmojo-Deletable-list",items:data});w.attachEventListener("change",sb.id,"onSegSelect");w.render();sb.segPages[pidx]=w;sb.booklet.set("waiting",false);sb.booklet.turn(w,true);},switchPage=function(sb,pidx){sb.seglist.set("text",pidx);var pg=sb.segPages[pidx];if(!pg){var fetchSegCB={success:function(res){if(res){turnPage(sb,res.items,pidx);}else{if(pidx==_P){turnPage(sb,[{did:"empty",n:"("+mstrmojo.desc(2210)+")",t:"e"}],pidx);}}},failure:function(res){mstrmojo.alert("Error while browsing "+pidx+" segments:"+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},params={taskId:"searchMetadata",styleName:"MojoFolderStyle",blockCount:-1,objectType:259,includeAncestorInfo:false};if(pidx==_S){params.rootFolderID=SHARED_F;}else{params.rootFolderType=PRIVATE_F;}sb.booklet.set("waiting",true);mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,fetchSegCB,params);}else{sb.booklet.turn(pg,true);}},toggleWait=function(me,shown){if(!me.waitIcon){var icon=document.createElement("div");icon.className="mojo-overlay-wait";icon.innerHTML='<div class="overlay"></div><div class="icon"></div>';me.containerNode.appendChild(icon);me.addSlots({waitIcon:icon});}me.waitIcon.style.display=!!shown?"block":"none";};mstrmojo.DeletableList=mstrmojo.declare(mstrmojo.OBList,null,{itemMarkupFunction:function(item,index,me){var iv=mstrmojo.string.htmlAngles(item.n),str='<div class="'+me.itemClass+' mstrmojo-onhoverparent mstrmojo-rel"><table cellspacing="0" cellpadding="0"><tbody><tr><td></td><td><div title="'+iv+'" class="'+me.textClass+'">'+iv+"</div></td></tr></tbody></table>";if("empty"!=item.did){str+='<div class="mstrmojo-onhover-bl mstrmojo-abs mstrmojo-topright"><img class="mstrmojo-del" src="../images/1ptrans.gif" onclick="mstrmojo.all[\''+me.id+'\'].del()" title="'+mstrmojo.desc(629,"Delete")+'"/></div>';}str+="</div>";return str;},del:function(){var me=this;delItem(me.selectedItem,me);}});mstrmojo.SegmentBrowser=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.SegmentBrowser",title:"Select a segment",cssClass:"mstrmojo-Segment-browser",segPages:{},children:[{alias:"seglist",scriptClass:"mstrmojo.DropDownButton",cssClass:"mstrmojo-FormatEditor-DropDownButton",cssText:"margin:0px;",popupRef:{scriptClass:"mstrmojo.Popup",contentNodeCssClass:"mstrmojo-OBNavigatorPopup",cssText:"position:relative;",slot:"popupNode",locksHover:true,children:[{scriptClass:"mstrmojo.OBList",items:[{n:_P},{n:_S}],itemMarkupFunction:function(item,index,me){return'<div class="'+me.itemClass+'" onclick="mstrmojo.all[\''+me.id+'\'].sel()" ><div class="'+me.textClass+'">'+mstrmojo.string.htmlAngles(item.n)+"</div></div>";},sel:function(){var me=this,pop=me.parent,seled=me.selectedItem;pop.close();switchPage(pop.parent.parent,seled.n);}}]}},{scriptClass:"mstrmojo.Booklet",cssText:"width:100%;background-color:white;margin-top: 5px;",alias:"booklet"},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",alias:"btns",cssClass:"mstrmojo-Editor-buttonBar",children:[{scriptClass:"mstrmojo.HTMLButton",alias:"load",text:"Load",cssClass:"mstrmojo-Editor-button",onclick:function(){var p=this.parent.parent,sid=p.selectedItem&&p.selectedItem.did;if(sid&&sid!="empty"){p.apply(sid,(p.fps&&p.fps.k)?p.fps.k:"");}}}]}],onOpen:function(){switchPage(this,_P);},onClose:function(){var pgs=this.segPages;pgs[_P]=pgs[_S]=null;},onSegSelect:function(evt){var item=evt&&evt.src.selectedItem;if(item&&item.did=="empty"){return ;}this.selectedItem=item;},apply:function(segId,nkey){var me=this,model=me.fps.model,loadCB={success:function(res){if(!res.data||!res.pukeys){return ;}var data=res.data,defs=model.getTargetDefn(res.pukeys);model.partialUpdate(data,defs);me.fps.clearBuffSlices();toggleWait(me,false);me.close();}};toggleWait(me,true);model.getDataService().applySegment(segId,nkey,loadCB);}});})();