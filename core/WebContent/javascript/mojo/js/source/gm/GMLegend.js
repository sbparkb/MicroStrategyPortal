(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css","mstrmojo.VisEnum","mstrmojo.VisLegend","mstrmojo.VisUtility","mstrmojo.gm.GMEnums","mstrmojo.gm.GMIdentities","mstrmojo.gm.GMUtility","mstrmojo.array","mstrmojo.string","mstrmojo.hash","mstrmojo._FormateVisLegend","mstrmojo.ui._HasScroller");var $MJ=mstrmojo,$GM=$MJ.gm,$DOM=$MJ.dom,$CSS=$MJ.css,$HASH=$MJ.hash,$UTILS=$MJ.VisUtility,$GMUTILS=$GM.GMUtility,$ARR=mstrmojo.array,$STR=mstrmojo.string,CS_ID=$GM.ColorSquareIdentity,CTRL_TYPE=$MJ.VisEnum.ControlType,LEGEND_POS=$GM.EnumLegendSlot,DOCK_POSITION=$GM.EnumDockPosition,PRP_LEGEND_SLOT=$GM.EnumLegendSlot,ID_TYPE=$GM.EnumIdentityType,SHAPE_TYPE=$GM.EnumShape,LEGEND_DATA_TYPE=$MJ.VisEnum.GMLegendDataType,SIZEBY_TITLE=mstrmojo.desc(13966,"Size by:"),PX="px",LINE_HEIGHT_RATIO=1.35,PT_PX_RATIO=0.75,GM_LEGEND_SPACING=5,TITLE_BAR_HEIGHT_DEFAULT=20,TITLE_BAR_HEIGHT=TITLE_BAR_HEIGHT_DEFAULT,TITLE_MARGIN=5,TABLE_MARGIN=5,COLOR_BOX_SIZE=16,TEXT_LINE_HEIGHT=15,TABLE_TITLE_LINE_HEIGHT=16,CB_TABLE_ROW_HEIGHT=20,SB_TABLE_LINE_HEIGHT=15,BORDER_WIDTH=1,SET_ATTR="setAttribute",SIZEBY_CANVAS_SCALE=3,SEPARATOR_LINE_HEIGHT=2,ICON_WIDTH=8,SIGN_WIDTH=15,STANDED_LINE_HEIGHT=14,TYPE_COLORBY=1,TYPE_SIZEBY=2,DRAW_METRIC_ICON=4,HAS_SIGN=8,IS_SIGN=16,TEXT_PADDING=10,COLORBY_TABLE_MARGIN=3,MIN_LEGEND_WIDTH=50,SPLITTER_PADDING=-3,NV_EDGE_SIZE_CANVAS_WIDTH=5,CUSTOM_SCALE_ICON_CLASSNAME="gm-legend-lock-icon",CUSTOM_SCALE_ICON_TITLE=mstrmojo.desc(14442,"This metric has its axis scale set to custom min and max values"),SVG_XMLNS="http://www.w3.org/2000/svg",ellipsis="\u2026",WORD_WRAP_REG=/[ \-]/;function positionSplitter(handle,dockPosition,panelWidth,panelHeight){if(!handle){return ;}var width,height,left,top,handleStyle=handle.style,isDockTop=dockPosition===DOCK_POSITION.TOP,isDockBottom=dockPosition===DOCK_POSITION.BOTTOM,isDockLeft=dockPosition===DOCK_POSITION.LEFT,isDockRight=dockPosition===DOCK_POSITION.RIGHT;if(isDockTop||isDockBottom){width=panelWidth;height=1;left=-1;top=SPLITTER_PADDING;if(isDockBottom){top+=panelHeight;}}else{if(isDockLeft||isDockRight){width=1;height=panelHeight;top=-1;left=SPLITTER_PADDING;if(isDockRight){left+=panelWidth;}}}handleStyle.cssText="left:"+left+PX+";top:"+top+PX+";width:"+width+PX+";height:"+height+PX+";";}function canWordWrap(text){var target=String(text);return target.indexOf(" ")>=0||target.indexOf("-")>=0;}function measureTextWidth(text,styles,bonus){var measureText=typeof text==="string"?$GMUTILS.restoreSpecialChars(text):text;return $UTILS.measureTextWidth(measureText,styles,bonus);}function setTextWidth(div,text,styles,maxWidth){var textWidth=measureTextWidth(text,styles,TEXT_PADDING);div.setAttribute("measureWidth",textWidth);if(textWidth>maxWidth){textWidth=maxWidth;}else{div.style.overflow="visible";}div.setAttribute("displayWidth",textWidth);div.style.width=textWidth+PX;return textWidth;}function getInnerText(div){var text;if(div.textContent&&typeof (div.textContent)!==undefined){text=div.textContent;}else{text=div.innerText;}return text;}function setToolTip(div){var realWidth=div.getAttribute("measureWidth"),dpWidth=div.getAttribute("displayWidth");if(!realWidth){div[SET_ATTR]("title","");}realWidth=parseFloat(realWidth,10);dpWidth=parseFloat(dpWidth,10);if((realWidth-dpWidth)>0.1){div[SET_ATTR]("title",getInnerText(div));}else{div[SET_ATTR]("title","");}}function generateUnderline(div,anchorPointLeft,underLineTop,underLineWidth){var underLine=document.createElement("div");underLine[SET_ATTR]("class","gm-legend-underLine");underLine.style.width=underLineWidth-TEXT_PADDING+PX;underLine.style.left=anchorPointLeft+5+PX;underLine.style.top=underLineTop+PX;div.appendChild(underLine);}function generateAnchorPoint(div,anchorPointLeft,underLineTop){var anchorPoint=document.createElement("div");anchorPoint[SET_ATTR]("class","gm-legend-underLine-anchorPoint");anchorPoint.style.left=anchorPointLeft+PX;anchorPoint.style.top=underLineTop-3+PX;div.appendChild(anchorPoint);}function generateUnderlineWithAnchorPoint(div,anchorPointLeft,underLineTop,underLineWidth){generateUnderline(div,anchorPointLeft,underLineTop,underLineWidth);generateAnchorPoint(div,anchorPointLeft,underLineTop);}function generateExtraUnderLineForTitle(div,styles,titleFirstLineWidth,underLineTop,containerWidth){var totalWidth,remainWidth,pos,sub,text=$GMUTILS.restoreSpecialChars(div.innerHTML),n=text.length,p=0,q=n,needToolTip=false;if(div.scrollHeight>1.5*TABLE_TITLE_LINE_HEIGHT){totalWidth=measureTextWidth(div.innerHTML,styles,TEXT_PADDING);remainWidth=totalWidth-titleFirstLineWidth+TEXT_PADDING;if(remainWidth>containerWidth){while((q-p)>1){pos=(p+q)>>1;sub=text.substring(0,pos)+ellipsis;totalWidth=measureTextWidth(sub,styles,TEXT_PADDING);remainWidth=totalWidth-titleFirstLineWidth+TEXT_PADDING;if(remainWidth>containerWidth){q=pos;}else{p=pos;}}div.innerHTML=$STR.encodeHtmlString(text.substring(0,p)+ellipsis,true);div[SET_ATTR]("title",text);needToolTip=true;totalWidth=measureTextWidth(div.innerHTML,styles,TEXT_PADDING);remainWidth=totalWidth-titleFirstLineWidth+TEXT_PADDING;}generateUnderline(div,0,underLineTop+TABLE_TITLE_LINE_HEIGHT,(remainWidth<containerWidth)?remainWidth:containerWidth);}if(titleFirstLineWidth>containerWidth){div[SET_ATTR]("title",text);}else{if(!needToolTip){div[SET_ATTR]("title","");}}}function fillTextInDiv(div,text,index,mark,maxWidth,styles){var underLineTop,underLineWidth,anchorPointLeft,textWidth,textBody=document.createElement("div");textBody[SET_ATTR]("class","gm-legend-textcell");textBody[SET_ATTR]("type",CTRL_TYPE.LGD_TEXT);textBody.style.lineHeight=TEXT_LINE_HEIGHT+PX;if(maxWidth){textWidth=setTextWidth(textBody,text,styles,maxWidth);}if(mark&TYPE_COLORBY){underLineTop=(CB_TABLE_ROW_HEIGHT+STANDED_LINE_HEIGHT)/2+index*CB_TABLE_ROW_HEIGHT;anchorPointLeft=COLOR_BOX_SIZE;}else{underLineTop=(SB_TABLE_LINE_HEIGHT+STANDED_LINE_HEIGHT)/2+index*SB_TABLE_LINE_HEIGHT;if(mark&HAS_SIGN){if(mark&IS_SIGN){anchorPointLeft=0;}else{anchorPointLeft=SIGN_WIDTH;}}else{if(mark&DRAW_METRIC_ICON){anchorPointLeft=ICON_WIDTH;}else{anchorPointLeft=0;}}}underLineWidth=textWidth||SIGN_WIDTH+TEXT_PADDING;textBody.innerHTML=text;textBody.identity={objType:ID_TYPE.LEGEND_TEXT};generateUnderlineWithAnchorPoint(div,anchorPointLeft,underLineTop,underLineWidth);this.textDivs.push(textBody);div.appendChild(textBody);}function getColorByWidth(cbData,styles){var i,n,elements,width=0;if(cbData){elements=cbData.elements;for(i=0,n=elements.length;i<n;i++){width=Math.max(width,measureTextWidth(elements[i].label,styles,TEXT_PADDING));}width+=COLOR_BOX_SIZE+TABLE_MARGIN*2+COLORBY_TABLE_MARGIN;}return width;}function getSizebyMetricsWidth(sbData,styles){var n,i,custMetrics,elements=sbData.items,width=0;if(!elements){return 0;}n=elements.length;custMetrics=sbData.custMetrics;for(i=0;i<n;i++){if(custMetrics&&custMetrics.indexOf(elements[i])!==-1){width=Math.max(width,measureTextWidth(elements[i],styles,TEXT_PADDING)+ICON_WIDTH);}else{width=Math.max(width,measureTextWidth(elements[i],styles,TEXT_PADDING));}}return width;}function getSizeByWidth(sbData,styles){var i,n,elements,width=0;if(sbData){elements=sbData.elements;n=elements.length;if(sbData.caseFlag===1){width=getSizebyMetricsWidth(sbData,styles);}else{if(sbData.caseFlag===0){for(i=0;i<n;i++){width=Math.max(width,measureTextWidth("Max: "+elements[i].v,styles,TEXT_PADDING));}width+=SB_TABLE_LINE_HEIGHT*SIZEBY_CANVAS_SCALE;width=Math.max(width,getSizebyMetricsWidth(sbData,styles));}else{if(sbData.caseFlag===2){for(i=0;i<n;i++){width=Math.max(width,measureTextWidth(elements[i].v,styles,TEXT_PADDING));}width+=SB_TABLE_LINE_HEIGHT*n+SIGN_WIDTH;width=Math.max(width,getSizebyMetricsWidth(sbData,styles));}else{if(sbData.caseFlag===3){for(i=0;i<n;i++){width=Math.max(width,measureTextWidth(elements[i].v,styles,TEXT_PADDING));}width+=SB_TABLE_LINE_HEIGHT*NV_EDGE_SIZE_CANVAS_WIDTH;}}}}width=Math.max(width,measureTextWidth(SIZEBY_TITLE,styles,TEXT_PADDING));width+=TABLE_MARGIN*3;}return width;}function getLegendHeight(dataArray,widthGiven,styles){if(!dataArray||!dataArray.length||dataArray.length<1){return 0;}var i,n,text,elements,caseFlag,textWidth,curData,cbData,sbData,cbHeight,sbHeight,height=TITLE_BAR_HEIGHT+2*BORDER_WIDTH,minHeight=height;for(i=0;i<dataArray.length;i++){curData=dataArray[i];if(curData.dataType===LEGEND_DATA_TYPE.COLOR_BY){cbData=curData.dataObj;if(cbData){cbHeight=2*TITLE_MARGIN+TABLE_TITLE_LINE_HEIGHT;text=$GMUTILS.removeExtraSpace(cbData.item);textWidth=measureTextWidth(text,styles,TEXT_PADDING);if((textWidth+2*TABLE_MARGIN>widthGiven-2*BORDER_WIDTH)&&canWordWrap(text)){cbHeight+=TABLE_TITLE_LINE_HEIGHT;}elements=cbData.elements;n=elements.length;cbHeight+=TABLE_MARGIN;cbHeight+=SEPARATOR_LINE_HEIGHT;height+=cbHeight+CB_TABLE_ROW_HEIGHT*n;minHeight+=cbHeight+(n>0?CB_TABLE_ROW_HEIGHT:0);}}else{if(curData.dataType===LEGEND_DATA_TYPE.SIZE_BY){sbData=curData.dataObj;if(sbData){sbHeight=2*TITLE_MARGIN+TABLE_TITLE_LINE_HEIGHT;text=$GMUTILS.removeExtraSpace(sbData.item);textWidth=measureTextWidth(text,styles,TEXT_PADDING);if((textWidth+2*TABLE_MARGIN>widthGiven-2*BORDER_WIDTH)&&canWordWrap(text)){sbHeight+=TABLE_TITLE_LINE_HEIGHT;}caseFlag=sbData.caseFlag;if(caseFlag===1){n=0;}else{if(caseFlag===0){n=2;}else{if(sbData.caseFlag===2||caseFlag===3){n=sbData.elements.length;}}}n+=(sbData.items&&sbData.items.length)||0;sbHeight+=SB_TABLE_LINE_HEIGHT*n;sbHeight+=TABLE_MARGIN;sbHeight+=SEPARATOR_LINE_HEIGHT;height+=sbHeight;minHeight+=sbHeight;}}}}return{height:height,minHeight:minHeight};}function getLegendWidth(dataArray,styles){var cbWidth=0,sbWidth=0;$ARR.forEach(dataArray||[],function(curData){var widthTemp;if(curData.dataType===LEGEND_DATA_TYPE.COLOR_BY){widthTemp=getColorByWidth(curData.dataObj,styles);if(widthTemp>cbWidth){cbWidth=widthTemp;}}else{if(curData.dataType===LEGEND_DATA_TYPE.SIZE_BY){widthTemp=getSizeByWidth(curData.dataObj,styles);if(widthTemp>sbWidth){sbWidth=widthTemp;}}}});return Math.max(cbWidth,sbWidth)+2*BORDER_WIDTH;}function getLegendSizeWithFixedWidth(dataArray,widthGiven,widgetHeight,styles){var legendHeight=getLegendHeight(dataArray,widthGiven,styles),height=legendHeight.height,heightLimit=widgetHeight-GM_LEGEND_SPACING*2,rtn={};rtn.autoCollapse=legendHeight.minHeight>heightLimit;rtn.minHeight=legendHeight.minHeight;rtn.width=widthGiven;rtn.height=Math.min(height,heightLimit);if(height>heightLimit){rtn.cutBy=height-heightLimit;}return rtn;}function updateColorSquare(element,colorDiv){var decodedColor=element.decodedColor||element.color,retColor;if(decodedColor.c1){retColor=$CSS.buildGradient(decodedColor.or,decodedColor.c1,decodedColor.c2);colorDiv.style[$CSS.convertCssToCamelCase(retColor.n)]=retColor.v;}else{colorDiv.style.backgroundColor=decodedColor;}if(element.image){colorDiv.style.backgroundImage=element.image;}colorDiv.identity=new CS_ID({objType:ID_TYPE.COLOR_SQUARE,parentIdentity:this.identity,token:element.token,decodedColor:element.decodedColor,encodedColor:element.encodedColor,isDefaultColor:element.isDefaultColor});}function renderMinMode(){var i,n,elements,curData,div,table,tr,td,colorDiv,colorContainerDiv,doc=document,triBtn=this.triBtn,closeBtn=this.closeBtn,cbContainer=this.cbContainer,sb1Container=this.sb1Container,sb2Container=this.sb2Container,cbTableContainer=this.cbTableContainer,cData=null,tableHeightMax=this.height-TITLE_BAR_HEIGHT-TABLE_MARGIN-2*BORDER_WIDTH,containerWidth=this.width-2*TABLE_MARGIN-2*BORDER_WIDTH;triBtn[SET_ATTR]("class","gm-legend-tri-button-collapsed");if(this.autoCollapse){triBtn[SET_ATTR]("title",mstrmojo.desc(13682,"There is not enough space to display the legend"));}else{triBtn[SET_ATTR]("title",mstrmojo.desc(13683,"Maximize Legend"));}closeBtn.style.display="none";this.splitter.style.display="none";this.domNode.style.overflow="hidden";for(i=0;this.dataArray&&i<this.dataArray.length;i++){curData=this.dataArray[i];if(curData.dataType===LEGEND_DATA_TYPE.COLOR_BY){cData=curData.dataObj;break;}}cbContainer.style.display=cData?"block":"none";sb1Container.style.display="none";sb2Container.style.display="none";if(cData){elements=cData.elements;n=elements.length;div=this.cbTitle;div.style.display="none";cbContainer.style.top=TITLE_BAR_HEIGHT+PX;cbContainer.style.width=containerWidth+PX;cbTableContainer.style.top="0px";table=this.cbTable;table.innerHTML="";for(i=0;i<n;i++){tr=doc.createElement("tr");td=doc.createElement("td");colorContainerDiv=doc.createElement("div");colorDiv=doc.createElement("div");colorContainerDiv[SET_ATTR]("class","gm-legend-colorbox-ctn-div");colorContainerDiv[SET_ATTR]("type",CTRL_TYPE.LGD_COLORBOX_CTN);colorContainerDiv[SET_ATTR]("title",elements[i].label);colorDiv[SET_ATTR]("class","gm-legend-colorbox-div");colorDiv[SET_ATTR]("type",CTRL_TYPE.LGD_COLORBOX);updateColorSquare.call(this,elements[i],colorDiv);tr[SET_ATTR]("class","gm-legend-tr");tr.style.height=CB_TABLE_ROW_HEIGHT+PX;td[SET_ATTR]("class","gm-legend-colorbox");colorContainerDiv.appendChild(colorDiv);td.appendChild(colorContainerDiv);tr.appendChild(td);table.appendChild(tr);if(table.offsetHeight+CB_TABLE_ROW_HEIGHT>tableHeightMax){break;}}table.style.top="0px";table.style.marginLeft="0px";cbTableContainer.style.top=TABLE_MARGIN+PX;cbTableContainer.style.height=table.offsetHeight+PX;}cbContainer.style.height=tableHeightMax+PX;}function createCircleSVG(svg,x,y,radius){var circle=document.createElementNS(SVG_XMLNS,"circle");circle.setAttribute("cx",x);circle.setAttribute("cy",y);circle.setAttribute("r",radius);circle.setAttribute("class","gm-legend-sizeby-circle");svg.appendChild(circle);}function createLineSVG(svg,x1,y1,x2,y2,strokeWidth,css){var line=document.createElementNS(SVG_XMLNS,"line");line.setAttribute("x1",x1);line.setAttribute("y1",y1);line.setAttribute("x2",x2);line.setAttribute("y2",y2);line.style.strokeWidth=strokeWidth;if(css){line.setAttribute("class",css);}svg.appendChild(line);}function drawSizeByIndicator(canvas,sbData){var i,radius,diameter,x,y,lineWidth,deltaWidth,dy,bRadius,sizebyType,PI=Math.PI,elements=sbData.elements,n=elements.length,width=n*SB_TABLE_LINE_HEIGHT,ctx=canvas.getContext("2d"),STYLES={LINE_COLOR:"#b0b0b0",MIN_WIDTH:1,MAX_WIDTH:10},visName=$UTILS.getPropertyByPath(this,"widget.model.data.visName")||$UTILS.getPropertyByPath(this,"widget.model.data.vis.vn");switch(visName){case"GraphMatrixVisualizationStyle":if(this.shapeType===SHAPE_TYPE.SQUARE||this.shapeType===SHAPE_TYPE.TICK||this.shapeType===SHAPE_TYPE.LINE||this.shapeType===SHAPE_TYPE.BAR||this.shapeType===SHAPE_TYPE.AREA||this.shapeType===SHAPE_TYPE.RECTANGLE){sizebyType="rectangle";}else{sizebyType="circle";}break;case"VIHeatMapVisualizationStyle":sizebyType="rectangle";break;default:sizebyType="circle";break;}switch(sbData.caseFlag){case 0:ctx.save();if(mstrApp.getThemeClassName().indexOf("dark")>=0){ctx.strokeStyle="rgba(116, 116, 117, 0.7)";ctx.fillStyle="rgba(116, 116, 117, 0.7)";}else{ctx.strokeStyle="rgba(188, 188, 189, 0.7)";ctx.fillStyle="rgba(188, 188, 189, 0.7)";}width=SB_TABLE_LINE_HEIGHT*SIZEBY_CANVAS_SCALE;bRadius=Math.floor(SB_TABLE_LINE_HEIGHT*0.75+0.5);radius=Math.floor(bRadius/3.5+0.5);if(sizebyType==="circle"){x=bRadius+1;y=SB_TABLE_LINE_HEIGHT;ctx.beginPath();ctx.arc(x,y,bRadius,0,2*PI,false);ctx.fill();ctx.stroke();x=2*x+2*radius;y=Math.floor(0.53*SB_TABLE_LINE_HEIGHT+0.5);ctx.beginPath();ctx.arc(x,y,radius,0,2*PI,false);ctx.fill();ctx.stroke();}else{x=1;y=SB_TABLE_LINE_HEIGHT-bRadius;ctx.beginPath();ctx.fillRect(x,y,2*bRadius,2*bRadius);x=2*bRadius+2+radius;y=Math.floor(0.53*SB_TABLE_LINE_HEIGHT-radius+0.5);ctx.beginPath();ctx.fillRect(x,y,2*radius,2*radius);}ctx.translate(0.5,0.5);ctx.lineWidth=1;ctx.strokeStyle="#9C9C9C";x=2*bRadius+3*radius+3;y=Math.floor(0.53*SB_TABLE_LINE_HEIGHT+0.5);ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(width,y);ctx.stroke();x=2*bRadius+2;y=Math.floor(1.53*SB_TABLE_LINE_HEIGHT-radius+0.5);ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+radius,y+radius);ctx.lineTo(width,y+radius);ctx.stroke();ctx.restore();break;case 1:break;case 2:diameter=parseInt(elements[0].diameter,10);diameter=Math.min(diameter,width);ctx.fillStyle="#ADADAC";ctx.strokeStyle="#ADADAC";if(sizebyType==="circle"){x=width>>1;y=x;ctx.arc(x,y,diameter>>1,0,2*PI,false);ctx.fill();ctx.stroke();}else{x=(width-diameter)>>1;y=x;ctx.rect(x,y,diameter,diameter);ctx.fill();ctx.stroke();}break;case 3:lineWidth=STYLES.MIN_WIDTH;deltaWidth=(n===1?0:(STYLES.MAX_WIDTH-STYLES.MIN_WIDTH)/(n-1));width=canvas.width;dy=SB_TABLE_LINE_HEIGHT;x=0;y=SB_TABLE_LINE_HEIGHT/2;ctx.strokeStyle=STYLES.LINE_COLOR;for(i=0;i<n;i++){ctx.lineWidth=lineWidth;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(width-x,y);ctx.stroke();y+=dy;lineWidth+=deltaWidth;}break;default:break;}}function getFirstLineTitleWidth(div,styles){var pos=1,sub,comp=1.5*TABLE_TITLE_LINE_HEIGHT,text=div.innerHTML,showText=$GMUTILS.restoreSpecialChars(text),texts=showText.split(WORD_WRAP_REG),tempStr,chr;var getCharAtIndex=function(index){chr=showText[index];return chr!==undefined?chr:"";};if(div.scrollHeight>comp){if(!texts[0]){return 0;}sub=texts[0]+getCharAtIndex(texts[0].length);while(texts[pos]!==undefined){tempStr=sub+texts[pos];tempStr+=getCharAtIndex(tempStr.length);div.innerHTML=$GMUTILS.replaceSpecialChars(tempStr);if(div.scrollHeight>comp){break;}sub=tempStr;pos++;}div.innerHTML=text;}else{sub=showText;}return measureTextWidth(sub,styles,TEXT_PADDING);}function fillSizeByTable(table,sbData,tableWidth,caseFlag){var i,tr,td0,td2,iconDiv,marginLeft,elements=sbData.elements,n=elements.length,tEles=[],doc=document,fragment=doc.createDocumentFragment(),needSign=false,styles=this.styles,textMaxWidth=tableWidth;switch(caseFlag){case 0:if(n>0){tEles.push({v:"Min: "+elements[n-1].v});tEles.push({v:"Max: "+elements[0].v});n=2;}break;case 1:elements=sbData.items;$ARR.forEach(elements,function(item){tEles.push({v:item});});break;case 3:tEles=elements;break;default:tEles=elements;needSign=true;break;}n=tEles.length;for(i=0;i<n;i++){tr=doc.createElement("tr");tr[SET_ATTR]("class","gm-legend-tr2");tr.style.height=SB_TABLE_LINE_HEIGHT+PX;if(needSign){td0=doc.createElement("td");fillTextInDiv.call(this,td0,tEles[i].sign,i,TYPE_SIZEBY|HAS_SIGN|IS_SIGN);td0[SET_ATTR]("class","gm-legend-sign");tr.appendChild(td0);textMaxWidth-=SIGN_WIDTH;}td2=doc.createElement("td");td2[SET_ATTR]("class","gm-legend-desc");if(sbData.custMetrics&&sbData.custMetrics.indexOf(tEles[i].v)!==-1){fillTextInDiv.call(this,td2,tEles[i].v,i,TYPE_SIZEBY|DRAW_METRIC_ICON,textMaxWidth-ICON_WIDTH,styles);marginLeft=parseInt(td2.lastChild.style.width,10);iconDiv=doc.createElement("div");iconDiv.setAttribute("class",CUSTOM_SCALE_ICON_CLASSNAME);iconDiv.setAttribute("title",CUSTOM_SCALE_ICON_TITLE);td2.appendChild(iconDiv);iconDiv.style.top=(SB_TABLE_LINE_HEIGHT-8)/2+i*SB_TABLE_LINE_HEIGHT+PX;td2.lastChild.style.marginLeft=marginLeft+PX;}else{if(needSign){fillTextInDiv.call(this,td2,tEles[i].v,i,TYPE_SIZEBY|HAS_SIGN,textMaxWidth,styles);}else{fillTextInDiv.call(this,td2,tEles[i].v,i,TYPE_SIZEBY,textMaxWidth,styles);}}tr.appendChild(td2);fragment.appendChild(tr);}table.appendChild(fragment);}function removeCustomScaleIcon(){var className="."+CUSTOM_SCALE_ICON_CLASSNAME,nodes=this.domLegend.querySelectorAll(className),pNode;$ARR.forEach(nodes,function(iconDiv){pNode=iconDiv.parentNode;if(pNode){pNode.removeChild(iconDiv);}});}function renderNormalMode(){var n,index,sizeByNum=0,div,table,metricNamesTable,item,elements,tableHeight,canvasWidth,canvasHeight,containerHeight,curTableWidth,width=this.width-2*BORDER_WIDTH,containerWidth=width-2*TABLE_MARGIN,doc=document,triBtn=this.triBtn,closeBtn=this.closeBtn,cbContainer=this.cbContainer,cbTableContainer=this.cbTableContainer,sb1Container=this.sb1Container,sb2Container=this.sb2Container,curCanvas,curData,curContainer,curTitle,cData,sData,cutBy=this.cutBy,topOffset=TITLE_BAR_HEIGHT,spLineIndex=0,styles=this.styles,iconDiv,showCustomScaleIcon,underLineTop=(TABLE_TITLE_LINE_HEIGHT+STANDED_LINE_HEIGHT)/2,titleFirstLineWidth,sizeByTitleWidth;triBtn[SET_ATTR]("class","gm-legend-tri-button");triBtn[SET_ATTR]("title",mstrmojo.desc(13684,"Minimize Legend"));closeBtn.style.display="block";closeBtn[SET_ATTR]("title",mstrmojo.desc(12002,"Hide Legend"));this.updateSplitter();removeCustomScaleIcon.call(this);this.domNode.style.overflow="visible";cbContainer.style.display="none";sb1Container.style.display="none";sb2Container.style.display="none";for(index=0;this.dataArray&&index<this.dataArray.length;index++){curData=this.dataArray[index];cData=null;sData=null;if(curData.dataType===LEGEND_DATA_TYPE.COLOR_BY){cData=curData.dataObj;if(cData){cbContainer.style.display="block";item=$GMUTILS.removeExtraSpace(cData.item);elements=cData.elements;n=elements.length;cbContainer.style.top=topOffset+PX;cbContainer.style.width=containerWidth+PX;containerHeight=0;if(spLineIndex===0){$CSS.addClass(this.sepLine1,"toggleHide");spLineIndex++;}div=this.cbTitle;div.style.display="block";setTextWidth(div,item,styles,containerWidth);div.innerHTML=$STR.encodeHtmlString(item,true);containerHeight+=div.offsetHeight+2*TITLE_MARGIN;titleFirstLineWidth=getFirstLineTitleWidth(div,styles);generateExtraUnderLineForTitle(div,styles,titleFirstLineWidth,underLineTop,containerWidth);generateUnderlineWithAnchorPoint(div,0,underLineTop,(titleFirstLineWidth<containerWidth)?titleFirstLineWidth:containerWidth);table=this.cbTable;table.style.display="block";table.style.width=(containerWidth-COLORBY_TABLE_MARGIN)+PX;table.style.marginLeft=COLORBY_TABLE_MARGIN+PX;table.innerHTML="";table.appendChild(this.fillColorByTable(cData,0));tableHeight=CB_TABLE_ROW_HEIGHT*n+1;cbTableContainer.style.top=containerHeight+PX;table.style.display="table";containerHeight+=tableHeight+TABLE_MARGIN;if(cutBy){containerHeight-=cutBy;tableHeight-=cutBy;}cbContainer.style.height=containerHeight+PX;cbTableContainer.style.height=tableHeight+PX;topOffset+=containerHeight+SEPARATOR_LINE_HEIGHT;}}else{if(curData.dataType===LEGEND_DATA_TYPE.SIZE_BY){sData=curData.dataObj;if(sData){sizeByNum++;if(sizeByNum===1){curContainer=sb1Container;curTitle=this.sb1Title;metricNamesTable=this.sb1MetricNamesTable;table=this.sb1DataTable;curCanvas=this.sb1Canvas;}else{curContainer=sb2Container;curTitle=this.sb2Title;metricNamesTable=this.sb2MetricNamesTable;table=this.sb2DataTable;curCanvas=this.sb2Canvas;}curContainer.style.display="block";item=$GMUTILS.removeExtraSpace(sData.item);elements=sData.elements;n=elements.length;curContainer.style.top=topOffset+PX;curContainer.style.width=containerWidth+PX;containerHeight=0;if(spLineIndex===0){$CSS.addClass(this.sepLine2,"toggleHide");spLineIndex++;}if(sData.caseFlag===0){canvasWidth=SIZEBY_CANVAS_SCALE*SB_TABLE_LINE_HEIGHT;canvasHeight=2*SB_TABLE_LINE_HEIGHT;}else{if(sData.caseFlag===3){canvasWidth=NV_EDGE_SIZE_CANVAS_WIDTH*SB_TABLE_LINE_HEIGHT;canvasHeight=n*SB_TABLE_LINE_HEIGHT;}else{canvasWidth=n*SB_TABLE_LINE_HEIGHT;canvasHeight=canvasWidth;}}div=curTitle;div.innerHTML=$STR.encodeHtmlString(item,true);showCustomScaleIcon=sData.custMetrics&&sData.custMetrics.indexOf(item)!==-1;if(showCustomScaleIcon){sizeByTitleWidth=containerWidth-ICON_WIDTH;}else{sizeByTitleWidth=containerWidth;}setTextWidth(div,item,styles,sizeByTitleWidth);if(showCustomScaleIcon){iconDiv=doc.createElement("div");iconDiv.setAttribute("class",CUSTOM_SCALE_ICON_CLASSNAME);iconDiv.setAttribute("title",CUSTOM_SCALE_ICON_TITLE);curContainer.appendChild(iconDiv);iconDiv.style.top=(div.offsetHeight-8)/2+TITLE_MARGIN+SEPARATOR_LINE_HEIGHT+PX;iconDiv.style.left=div.offsetWidth+"px";}titleFirstLineWidth=getFirstLineTitleWidth(div,styles);generateExtraUnderLineForTitle(div,styles,titleFirstLineWidth,underLineTop,sizeByTitleWidth);generateUnderlineWithAnchorPoint(div,0,underLineTop,(titleFirstLineWidth<sizeByTitleWidth)?titleFirstLineWidth:sizeByTitleWidth);containerHeight+=div.offsetHeight+2*TITLE_MARGIN;curTableWidth=containerWidth;metricNamesTable.innerHTML="";if(sData.items&&sData.items.length>0){metricNamesTable.style.display="block";fillSizeByTable.call(this,metricNamesTable,sData,curTableWidth,1);}else{metricNamesTable.style.display="none";}metricNamesTable.style.top=containerHeight+PX;metricNamesTable.style.left="0"+PX;metricNamesTable.style.width=curTableWidth+PX;containerHeight+=metricNamesTable.offsetHeight;if(canvasWidth>0){curTableWidth-=canvasWidth+TABLE_MARGIN;}table.innerHTML="";if(sData.elements&&sData.elements.length>0){table.style.display="block";fillSizeByTable.call(this,table,sData,curTableWidth,sData.caseFlag);}else{table.style.display="none";}curCanvas.style.position="absolute";curCanvas.style.top=containerHeight+PX;curCanvas.style.marginLeft=TABLE_MARGIN+PX;table.style.top=containerHeight+PX;table.style.left=(canvasWidth+TABLE_MARGIN)+PX;table.style.width=curTableWidth+PX;containerHeight+=table.offsetHeight+TABLE_MARGIN;curContainer.style.height=containerHeight+PX;table.style.display="table";curCanvas.width=canvasWidth;curCanvas.height=canvasHeight;drawSizeByIndicator.call(this,curCanvas,sData);topOffset+=containerHeight+SEPARATOR_LINE_HEIGHT;}}}}}function updateTooltip(){var i,textDivs=this.textDivs,n=textDivs.length;for(i=0;i<n;i++){setToolTip(textDivs[i]);}}mstrmojo.gm.GMLegend=mstrmojo.declare(mstrmojo.VisLegend,[mstrmojo._FormateVisLegend,mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.gm.GMLegend",cssClass:"gm-legend",dropZoneHighlightCss:"gm-legend-slot",dockedPositions:[{pos:PRP_LEGEND_SLOT.LEFT_TOP},{pos:PRP_LEGEND_SLOT.LEFT_MIDDLE},{pos:PRP_LEGEND_SLOT.LEFT_BOTTOM},{pos:PRP_LEGEND_SLOT.RIGHT_TOP},{pos:PRP_LEGEND_SLOT.RIGHT_MIDDLE},{pos:PRP_LEGEND_SLOT.RIGHT_BOTTOM}],dockPos:DOCK_POSITION.LEFT,GMW:0,GMH:0,isMinimal:false,shapeType:undefined,legendMarkup:'<div class="gm-legend-tri-button"></div><div class="gm-legend-close-button"></div><div class="gm-legend-container"><div class="gm-legend-separator-line" style="width:{@coreWidth}px"></div><div class="gm-legend-title" type="lgd-title" style="line-height:{@lineHeight}px; max-height:{@maxHeight}px"></div><div class="gm-legend-table-container"><table class="gm-legend-table"></table></div></div><div class="gm-legend-container"><div class="gm-legend-separator-line" style="width:{@coreWidth}px"></div><div class="gm-legend-title" type="lgd-title" style="line-height:{@lineHeight}px; max-height:{@maxHeight}px"></div><table class="gm-legend-table"></table><table class="gm-legend-table"></table><canvas type="lgd-canvas"></canvas></div><div class="gm-legend-container"><div class="gm-legend-separator-line" style="width:{@coreWidth}px"></div><div class="gm-legend-title" type="lgd-title" style="line-height:{@lineHeight}px; max-height:{@maxHeight}px"></div><table class="gm-legend-table"></table><table class="gm-legend-table"></table><canvas type="lgd-canvas"></canvas></div><div class="gm-legend-resizer-v" draggable="false"></div><div class="gm-legend-resizeRect"></div>',init:function init(props){this.styles={};this.cutBy=null;this.dataArray=null;this.textDivs=[];var ph=props.placeholder,phStyle=ph.style;if(ph){this.cssClass=ph.getAttribute("class");if(!this.cssClass){this.cssClass="";}if(props.hasOwnProperty("width")===false){props.width=(phStyle&&phStyle.width)||ph.clientWidth;}if(props.hasOwnProperty("height")===false){props.height=(phStyle&&phStyle.height)||ph.clientHeight;}if(props.hasOwnProperty("left")===false){props.left=ph.offsetLeft;}if(props.hasOwnProperty("top")===false){props.top=ph.offsetTop;}}this._super(props);},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.cbTableContainer;},getSplitterDockPos:function(){return(this.currDockedPositionIdx<3)?DOCK_POSITION.RIGHT:DOCK_POSITION.LEFT;},updateAlignClass:function(){var dockPosition=this.getDockedPosition(),slot=dockPosition&&dockPosition.pos,isRight=(slot===PRP_LEGEND_SLOT.RIGHT_MIDDLE||slot===PRP_LEGEND_SLOT.RIGHT_TOP||slot===PRP_LEGEND_SLOT.RIGHT_BOTTOM||slot===PRP_LEGEND_SLOT.RIGHT),domLegend=this.domLegend,domNode=this.domNode,resizeRect=this.resizeRect;if(isRight){$CSS.removeClass(domLegend,"gm-align-left");$CSS.addClass(domLegend,"gm-align-right");$CSS.toggleClass(domLegend,"gm-legend-alignRight",true);$CSS.toggleClass(domLegend,"gm-legend-alignLeft",false);$CSS.toggleClass(domNode,"gm-legend-alignRight",true);$CSS.toggleClass(domNode,"gm-legend-alignLeft",false);$CSS.toggleClass(resizeRect,"gm-legend-alignRight",true);$CSS.toggleClass(resizeRect,"gm-legend-alignLeft",false);}else{$CSS.removeClass(domLegend,"gm-align-right");$CSS.addClass(domLegend,"gm-align-left");$CSS.toggleClass(domLegend,"gm-legend-alignRight",false);$CSS.toggleClass(domLegend,"gm-legend-alignLeft",true);$CSS.toggleClass(domNode,"gm-legend-alignRight",false);$CSS.toggleClass(domNode,"gm-legend-alignLeft",true);$CSS.toggleClass(resizeRect,"gm-legend-alignRight",false);$CSS.toggleClass(resizeRect,"gm-legend-alignLeft",true);}},postBuildRendering:function(){this._super();var styles=this.styles,domNode=this.domNode,childNodes=this.domLegend.childNodes,cbContainer=childNodes[2],sb1Container=childNodes[3],sb2Container=childNodes[4],identity={objType:ID_TYPE.LEGEND};this.addSlots({triBtn:childNodes[0],closeBtn:childNodes[1],cbContainer:childNodes[2],sepLine1:cbContainer.firstChild,cbTitle:cbContainer.childNodes[1],cbTableContainer:cbContainer.childNodes[2],cbTable:cbContainer.childNodes[2].firstChild,sb1Container:sb1Container,sepLine2:sb1Container.firstChild,sb1Title:sb1Container.childNodes[1],sb1MetricNamesTable:sb1Container.childNodes[2],sb1DataTable:sb1Container.childNodes[3],sb1Canvas:sb1Container.childNodes[4],sb2Container:sb2Container,sepLine3:sb2Container.firstChild,sb2Title:sb2Container.childNodes[1],sb2MetricNamesTable:sb1Container.childNodes[2],sb2DataTable:sb2Container.childNodes[3],sb2Canvas:sb2Container.childNodes[4],splitter:childNodes[5],resizeRect:childNodes[6]});$GM.GMLegend.applyHTML5Props(styles);this.bgColor=styles.background||styles.backgroundColor||"transparent";$UTILS.applyStyle2Legend(styles,domNode,this.domLegend);var dockPos=this.getSplitterDockPos(),coreWidth=this.width-2*TABLE_MARGIN-2*BORDER_WIDTH,cbTitle=this.cbTitle,cbStyle=cbTitle.style,sb1Title=this.sb1Title,sb2Title=this.sb2Title,sb1Style=sb1Title.style,sb2Style=sb2Title.style,sepLine1=this.sepLine1,sepLine2=this.sepLine2,sepLine3=this.sepLine3;sepLine1.style.width=coreWidth+PX;sepLine2.style.width=coreWidth+PX;sepLine3.style.width=coreWidth+PX;cbStyle.lineHeight=TABLE_TITLE_LINE_HEIGHT+PX;sb1Style.lineHeight=TABLE_TITLE_LINE_HEIGHT+PX;sb2Style.lineHeight=TABLE_TITLE_LINE_HEIGHT+PX;cbStyle.maxHeight=2*TABLE_TITLE_LINE_HEIGHT+PX;sb1Style.maxHeight=2*TABLE_TITLE_LINE_HEIGHT+PX;sb2Style.maxHeight=2*TABLE_TITLE_LINE_HEIGHT+PX;cbTitle.identity={objType:ID_TYPE.LEGEND_TEXT,parentIdentity:identity};sb1Title.identity={objType:ID_TYPE.LEGEND_TEXT,parentIdentity:identity};sb2Title.identity={objType:ID_TYPE.LEGEND_TEXT,parentIdentity:identity};this.dockPos=dockPos;this.identity=domNode.identity=identity;this.updateAlignClass();},feedData:function(dataArray,minMode){this.dataArray=dataArray;this.isMinimal=minMode;this.textDivs=[];$GM.GMLegend.applyHTML5Props(this.styles);this.autoCollapseLegend();if(minMode||this.autoCollapse){renderMinMode.call(this);this.draggable=false;}else{renderNormalMode.call(this);this.draggable=true;}updateTooltip.call(this);this.updateScrollbars();},autoCollapseLegend:function(){this.autoCollapse=this.minHeight&&(this.minHeight>(this.GMH-GM_LEGEND_SPACING*2));},updateColorBySquare:function(colorByData){var elements,n,i,nodes;if(colorByData){nodes=this.domNode.querySelectorAll(".gm-legend-colorbox-div");elements=colorByData.elements;n=Math.min(elements.length,nodes.length);for(i=0;i<n;i++){updateColorSquare.call(this,elements[i],nodes[i]);}}},updateContainerSize:function(GMW,GMH){this.GMW=GMW;this.GMH=GMH;this.calculateDockedPositions(GMW,GMH);},updateAfterResize:function(){$GM.GMLegend.applyHTML5Props(this.styles);var sizeByNum=0,width=this.width,cbContainer=this.cbContainer,sb1Container=this.sb1Container,sb2Container=this.sb2Container,sepLine1=this.sepLine1,sepLine2=this.sepLine2,sepLine3=this.sepLine3,coreWidth=width-2*TABLE_MARGIN-2*BORDER_WIDTH;$ARR.forEach(this.dataArray||[],function(curData){if(curData.dataType===LEGEND_DATA_TYPE.COLOR_BY){if(curData.dataObj){if(cbContainer){cbContainer.style.width=coreWidth+PX;}}}else{if(curData.dataType===LEGEND_DATA_TYPE.SIZE_BY){if(curData.dataObj){sizeByNum++;if(sizeByNum===1&&sb1Container){sb1Container.style.width=coreWidth+PX;}if(sizeByNum===2&&sb2Container){sb2Container.style.width=coreWidth+PX;}}}}});if(sepLine1){sepLine1.style.width=coreWidth+PX;}if(sepLine2){sepLine2.style.width=coreWidth+PX;}if(sepLine3){sepLine3.style.width=coreWidth+PX;}this.domLegend.style.width=this.width+PX;this.domLegend.style.height=this.height+PX;},updateStyle:function(style){this.styles=style;this.bgColor=style.background||style.backgroundColor||"transparent";$UTILS.applyStyle2Legend(style,this.domNode,this.domLegend);},updateTitleLineHeight:function(){var cbTitle=this.cbTitle,cbStyle=cbTitle.style,sb1Title=this.sb1Title,sb2Title=this.sb2Title,sb1Style=sb1Title.style,sb2Style=sb2Title.style;$GM.GMLegend.applyHTML5Props(this.styles);cbStyle.lineHeight=TABLE_TITLE_LINE_HEIGHT+PX;sb1Style.lineHeight=TABLE_TITLE_LINE_HEIGHT+PX;sb2Style.lineHeight=TABLE_TITLE_LINE_HEIGHT+PX;cbStyle.maxHeight=2*TABLE_TITLE_LINE_HEIGHT+PX;sb1Style.maxHeight=2*TABLE_TITLE_LINE_HEIGHT+PX;sb2Style.maxHeight=2*TABLE_TITLE_LINE_HEIGHT+PX;},getSplitterPosition:function(evt){var position=evt.src.startPos+evt.tgt.pos.x-evt.src.pos.x,info=evt.src.posInfo,min=info&&info.min,max=info&&info.max;if(min!==undefined){position=Math.max(position,min);}if(max!==undefined){position=Math.min(position,max);}return position;},positionResizeRect:function(evt,leftPos){var isRight=evt.src.posInfo.dockPosition===DOCK_POSITION.LEFT,offsetLeft=leftPos-SPLITTER_PADDING,left=isRight?offsetLeft:0,width=isRight?this.width-offsetLeft:offsetLeft;this.resizeRect.style.left=(left-1)+PX;this.resizeRect.style.width=(width-2)+PX;},updateLegendSlot:function(slot,dockPosIdx){var dockPosition=this.getDockedPosition(),currentSlot=dockPosition&&dockPosition.pos;if(currentSlot!==slot){this.currDockedPositionIdx=dockPosIdx;this.dockPos=this.getSplitterDockPos();this.updateDropZonePosition();this.updateAlignClass();this.updateSplitter();this.widget.onLegendDropZoneChange(this.getDockedPosition());}},ondragstart:function(evt){var target=evt.src.e.target,data=evt.src.data;if(this.widget&&this.widget.setInteractive){this.widget.setInteractive(false);}if(target===this.splitter){evt.src.startPos=target.offsetLeft;evt.src.posInfo=this.getSplitterInfo(target);this.positionResizeRect(evt,evt.src.startPos);$CSS.addClass(this.resizeRect,"resizing");}else{this.cbTableScrollTop=this.cbTableContainer.scrollTop;this._super(evt);if(!data||!data.isScrollBar){this.clearSelectedTargets();$CSS.toggleClass(this.domNode,"gm-legend-hover",false);$CSS.toggleClass(this.domLegend,"active",false);this.cbTableContainer.scrollTop=this.cbTableScrollTop;this.domLegend.style.background=this.bgColor;this.isDragging=true;}}},ondragmove:function ondragmove(evt){var target=evt.src.e.target,left;if(target===this.splitter){left=this.getSplitterPosition(evt);target.style.left=left+PX;this.positionResizeRect(evt,left);}else{this._super(evt);}},ondragend:function(evt){var target=evt.src.e.target;if(target===this.splitter){$CSS.removeClass(this.resizeRect,"resizing");this.splitterMoved(this.getSplitterPosition(evt)-evt.src.startPos,evt.src.posInfo);}else{this._super(evt);var data=evt.src.data;if(!data||!data.isScrollBar){this.cbTableContainer.scrollTop=this.cbTableScrollTop;this.domLegend.style.background="transparent";this.isDragging=false;}delete this.cbTableScrollTop;}if(this.widget&&this.widget.setInteractive){this.widget.setInteractive(true);}},onscroll:function(){var i,n,yOffset=this.scrollNode.scrollTop,table,curData,cbData;if(this.prevScrpllTop===yOffset){return ;}n=(this.dataArray&&this.dataArray.length)||0;for(i=0;i<n;i++){curData=this.dataArray[i];if(curData.dataType===LEGEND_DATA_TYPE.COLOR_BY){cbData=curData.dataObj;break;}}if(cbData){table=this.cbTable;table.innerHTML="";table.appendChild(this.fillColorByTable(cbData,Math.floor(yOffset/CB_TABLE_ROW_HEIGHT)));this.prevScrpllTop=yOffset;this.scrollNode.scrollTop=yOffset;this._super();}},fillColorByTable:function(cbData,startIndex){var i,n,tr,td0,td2,colorContainerDiv,colorDiv,styles=this.styles,fragment,cutBy=this.cutBy,containerWidth=this.width-2*BORDER_WIDTH-2*TABLE_MARGIN,elements,textMaxWidth,cbTableHeight,cbTableFullHeight,startHeight;elements=cbData.elements;n=elements.length;fragment=document.createDocumentFragment();textMaxWidth=containerWidth-COLOR_BOX_SIZE-COLORBY_TABLE_MARGIN;cbTableHeight=0;cbTableFullHeight=CB_TABLE_ROW_HEIGHT*n;startHeight=startIndex*CB_TABLE_ROW_HEIGHT;function appendEmptyRow(rowHeight){tr=document.createElement("tr");td0=document.createElement("td");tr.style.height=rowHeight+PX;td0[SET_ATTR]("class","gm-legend-colorbox");tr.appendChild(td0);fragment.appendChild(tr);}if(startIndex>0){appendEmptyRow(startHeight);}for(i=startIndex;i<n;i++){tr=document.createElement("tr");td0=document.createElement("td");td2=document.createElement("td");colorContainerDiv=document.createElement("div");colorDiv=document.createElement("div");colorContainerDiv[SET_ATTR]("class","gm-legend-colorbox-ctn-div");colorContainerDiv[SET_ATTR]("type",CTRL_TYPE.LGD_COLORBOX_CTN);colorDiv[SET_ATTR]("class","gm-legend-colorbox-div");colorDiv[SET_ATTR]("type",CTRL_TYPE.LGD_COLORBOX);updateColorSquare.call(this,elements[i],colorDiv);tr[SET_ATTR]("class","gm-legend-tr");tr.style.height=CB_TABLE_ROW_HEIGHT+PX;td0[SET_ATTR]("class","gm-legend-colorbox");td2[SET_ATTR]("class","gm-legend-desc");fillTextInDiv.call(this,td2,elements[i].label,i,TYPE_COLORBY,textMaxWidth,styles);colorContainerDiv.appendChild(colorDiv);td0.appendChild(colorContainerDiv);tr.appendChild(td0);tr.appendChild(td2);fragment.appendChild(tr);cbTableHeight+=CB_TABLE_ROW_HEIGHT;if(cutBy&&(cutBy+cbTableHeight-CB_TABLE_ROW_HEIGHT)>cbTableFullHeight){appendEmptyRow(cbTableFullHeight-cbTableHeight-startHeight);break;}}return fragment;},calculateDockedPositions:function(w,h){var i,wLegend=this.getWidth(),hLegend=this.getHeight(),dockedPositions=this.dockedPositions,calculateDockedPosition=function(dockedPos){switch(dockedPos.pos){case LEGEND_POS.LEFT_TOP:dockedPos.x=0;dockedPos.y=GM_LEGEND_SPACING;break;case LEGEND_POS.LEFT_MIDDLE:dockedPos.x=0;dockedPos.y=Math.max(GM_LEGEND_SPACING,(h-hLegend)>>1);break;case LEGEND_POS.LEFT_BOTTOM:dockedPos.x=0;dockedPos.y=Math.max(0,h-hLegend-GM_LEGEND_SPACING);break;case LEGEND_POS.RIGHT_TOP:dockedPos.x=w-wLegend;dockedPos.y=GM_LEGEND_SPACING;break;case LEGEND_POS.RIGHT_MIDDLE:dockedPos.x=w-wLegend;dockedPos.y=Math.max(GM_LEGEND_SPACING,(h-hLegend)>>1);break;case LEGEND_POS.RIGHT_BOTTOM:dockedPos.x=w-wLegend;dockedPos.y=Math.max(0,h-hLegend-GM_LEGEND_SPACING);break;}};for(i=0;i<dockedPositions.length;i++){calculateDockedPosition(dockedPositions[i]);}this.updateDropZonePosition();},updateDropZonePosition:function(){var dockedPosition=this.getDockedPosition(),dropZoneStyle=this.dropZoneNode.style;dropZoneStyle.left=dockedPosition.x+PX;dropZoneStyle.top=dockedPosition.y+PX;},updateDropZoneNode:function(context){this._super(context);this.dockPos=this.getSplitterDockPos();this.updateSplitter();},onmouseover:function(evt){var domLegend=this.domLegend,target=evt.getTarget(),type=target.getAttribute("type"),widget=this.widget,identity;if(this.isDragging){return ;}var styles=$HASH.copy(this.styles);styles.opacity+=0.4;$UTILS.applyStyles2DomNode(this.domNode,styles);if($DOM.contains(domLegend,target,true)){$CSS.addClass(domLegend,"active");}if(type===CTRL_TYPE.LGD_COLORBOX){target=target.parentNode;type=target.getAttribute("type");}if(type===CTRL_TYPE.LGD_COLORBOX_CTN){identity=target.firstChild.identity;if(!identity||!identity.comb){return ;}$CSS.toggleClass(target,"hover-colorsquare",true);return ;}if(widget.formattingMode){switch(type){case CTRL_TYPE.LGD_TITLE:case CTRL_TYPE.LGD_TEXT:$CSS.toggleClass(domLegend,"hover-txt",true);break;default:$CSS.toggleClass(this.domNode,"gm-legend-hover",true);break;}}},onmouseout:function(evt){var domLegend=this.domLegend,toElement=evt.e.toElement||evt.e.relatedTarget,target=evt.getTarget(),type=target.getAttribute("type"),widget=this.widget,identity;$UTILS.applyStyles2DomNode(this.domNode,this.styles);if(!$DOM.contains(domLegend,toElement,true)){$CSS.removeClass(domLegend,"active");}if(type===CTRL_TYPE.LGD_COLORBOX){target=target.parentNode;type=target.getAttribute("type");}if(type===CTRL_TYPE.LGD_COLORBOX_CTN){identity=target.firstChild.identity;if(!identity||!identity.comb){return ;}$CSS.toggleClass(target,"hover-colorsquare",false);return ;}if(widget.formattingMode||widget.isOnFormattingMode){switch(type){case CTRL_TYPE.LGD_COLORBOX_CTN:case CTRL_TYPE.LGD_COLORBOX:break;case CTRL_TYPE.LGD_TITLE:case CTRL_TYPE.LGD_TEXT:$CSS.toggleClass(domLegend,"hover-txt",false);break;default:$CSS.toggleClass(this.domNode,"gm-legend-hover",false);break;}}},onclick:function(evt){var target=evt.getTarget(),type=target.getAttribute("type"),widget=this.widget;if(target===this.triBtn){if(!this.autoCollapse){this.raiseEvent({name:"gm-legend-clicked",action:(this.isMinimal?"restore":"minimize")});}}else{if(target===this.closeBtn){this.raiseEvent({name:"gm-legend-clicked",action:"close"});}else{if(type===CTRL_TYPE.LGD_COLORBOX){target=target.parentNode;type=target.getAttribute("type");}if(widget.formattingMode||widget.isOnFormattingMode){if(type===CTRL_TYPE.LGD_COLORBOX_CTN){this.selectColorBox(target,true);}else{if(type===CTRL_TYPE.LGD_TEXT||type===CTRL_TYPE.LGD_TITLE){this.selectText();}else{this.selectLegendBody();}}}else{this.clearSelectedColorBox();}}}$DOM.stopPropogation(null,evt.e);},attachClearEvent:function(){if(this.clearSelectTargetfn){return ;}var _this=this,domLegend=this.domLegend;this.clearSelectTargetfn=function(e){var target=e.target,toolbar=_this.widget.toolEditor,toolbarNode;if(!$DOM.contains(domLegend,target,true,domLegend)){if(toolbar){toolbarNode=toolbar.domNode;if(!$DOM.contains(toolbarNode,target,true,toolbarNode)){_this.clearSelectedTargets();}}else{_this.clearSelectedTargets();}}};$DOM.attachEvent(document.body,"mousedown",this.clearSelectTargetfn,true);},clearSelectedColorBox:function(){var target=this.selectedColorBox;if(target){$CSS.toggleClass(target,"select",false);$CSS.toggleClass(target,"selectfmt",false);this.selectedColorBox=undefined;}},clearSelectedText:function(){$CSS.removeClass(this.domNode,"select-txt");},clearSelectedLegendBody:function(){$CSS.removeClass(this.domNode,"gm-legend-select");},clearSelectedTargets:function(){this.clearSelectedColorBox();this.clearSelectedText();this.clearSelectedLegendBody();if(this.clearSelectTargetfn){$DOM.detachEvent(document.body,"mousedown",this.clearSelectTargetfn,true);delete this.clearSelectTargetfn;}},selectColorBox:function(target,isFmt){var identity=target.firstChild.identity;if(!identity||!identity.comb){return ;}this.clearSelectedText();this.clearSelectedLegendBody();if(this.selectedColorBox!==target){this.clearSelectedColorBox();this.selectedColorBox=target;if(isFmt){$CSS.toggleClass(target,"selectfmt",true);}else{$CSS.toggleClass(target,"select",true);}this.attachClearEvent();}},selectText:function(){this.clearSelectedColorBox();this.clearSelectedLegendBody();$CSS.addClass(this.domNode,"select-txt");this.attachClearEvent();},selectLegendBody:function(){this.clearSelectedColorBox();this.clearSelectedText();$CSS.addClass(this.domNode,"gm-legend-select");this.attachClearEvent();},adjustColorPickerPos:function(ele){var pos=$DOM.position(ele),padding=0,retPos={};if(this.currDockedPositionIdx<3){retPos.x=pos.x+pos.w+padding;retPos.alignLeft=true;}else{retPos.x=pos.x-padding;retPos.alignLeft=false;}retPos.y=pos.y+pos.h+padding;return retPos;},getSplitterInfo:function(splitter){if(!splitter){return{};}var dockPos=this.dockPos,rtn={},currentW=this.width,minLegendW=MIN_LEGEND_WIDTH,maxLegendW=Math.floor(this.GMW/3);rtn.dockPosition=dockPos;if(dockPos===DOCK_POSITION.LEFT){rtn.min=Math.min(currentW-maxLegendW,0);rtn.max=Math.max(currentW-minLegendW,0);}else{if(dockPos===DOCK_POSITION.RIGHT){rtn.min=minLegendW;rtn.max=maxLegendW;}}rtn.min+=SPLITTER_PADDING;rtn.max+=SPLITTER_PADDING;return rtn;},splitterMoved:function(position,info){if(position===0){return ;}if(info.dockPosition===DOCK_POSITION.LEFT){position=-position;}this.raiseEvent({name:"gm-legend-resized",position:position});this.updateSplitter();if(this.widget&&this.widget.setInteractive){this.widget.setInteractive(true);}},updateSplitter:function(){positionSplitter(this.splitter,this.dockPos,this.width,this.height);this.resizeRect.style.height=this.height-2+PX;}});$GM.GMLegend.applyHTML5Props=function(styles){var fontSize=parseInt(styles.fontSize,10)||8,lineHeight;if(styles.fontSize.indexOf("px")>=0){fontSize=Math.floor(fontSize*PT_PX_RATIO+0.5);}lineHeight=Math.floor(fontSize/PT_PX_RATIO*LINE_HEIGHT_RATIO+0.5);TABLE_TITLE_LINE_HEIGHT=Math.max(fontSize,8)+9;STANDED_LINE_HEIGHT=Math.floor(fontSize/PT_PX_RATIO+0.5);TEXT_LINE_HEIGHT=Math.max(lineHeight,15);CB_TABLE_ROW_HEIGHT=Math.max(lineHeight,20)+2;SB_TABLE_LINE_HEIGHT=Math.max(lineHeight,14)+2;BORDER_WIDTH=parseInt(styles.borderWidth,10)||1;var tbHeight=parseInt(styles.tbHeight,10);TITLE_BAR_HEIGHT=isNaN(tbHeight)?TITLE_BAR_HEIGHT_DEFAULT:tbHeight;};$GM.GMLegend.getLegendSize4MinMode=function(cbData,widgetHeight){var n,elements,height=TITLE_BAR_HEIGHT+2*BORDER_WIDTH;if(cbData){elements=cbData.elements;n=elements.length;height+=CB_TABLE_ROW_HEIGHT*n;height+=2*TABLE_MARGIN;}height=Math.min(height,widgetHeight-GM_LEGEND_SPACING*2);return{width:COLOR_BOX_SIZE+5+7+2*BORDER_WIDTH,height:height};};$GM.GMLegend.getLegendSize=function(dataArray,scale,widgetWidth,widgetHeight,styles,widthGiven){var i,width,height,widthLimit,heightLimit=widgetHeight-GM_LEGEND_SPACING*2,cbWidth=0,sbWidth=0,rtn={},widthTemp,curData,legendHeight;if(!dataArray||!dataArray.length||dataArray.length<1){return{};}if(scale!==undefined){if(!widthGiven){widthGiven=Math.floor(getLegendWidth(dataArray,styles)*scale);}widthLimit=Math.min(widthGiven,Math.floor(widgetWidth/3));widthLimit=Math.max(widthLimit,50);return getLegendSizeWithFixedWidth(dataArray,widthLimit,widgetHeight,styles);}widthLimit=Math.min(Math.floor(0.2*widgetWidth),300);for(i=0;i<dataArray.length;i++){curData=dataArray[i];if(curData.dataType===LEGEND_DATA_TYPE.COLOR_BY){widthTemp=getColorByWidth(curData.dataObj,styles);if(widthTemp>cbWidth){cbWidth=widthTemp;}}else{if(curData.dataType===LEGEND_DATA_TYPE.SIZE_BY){widthTemp=getSizeByWidth(curData.dataObj,styles);if(widthTemp>sbWidth){sbWidth=widthTemp;}}}}width=Math.max(cbWidth,sbWidth)+2*BORDER_WIDTH;rtn.width=Math.min(width,widthLimit);rtn.scale=rtn.width/width;legendHeight=getLegendHeight(dataArray,rtn.width,styles);height=legendHeight.height;rtn.autoCollapse=legendHeight.minHeight>heightLimit;rtn.minHeight=legendHeight.minHeight;rtn.height=Math.min(height,heightLimit);if(height>heightLimit){rtn.cutBy=height-heightLimit;}return rtn;};}());