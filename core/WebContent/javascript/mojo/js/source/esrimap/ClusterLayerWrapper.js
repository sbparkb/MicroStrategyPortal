(function(){mstrmojo.requiresCls("mstrmojo.gmaps.MapEnums");var $EnumClusterMode=mstrmojo.gmaps.EnumClusterMode,CLUSTER_SYMBOL_DIMENSION=50;mstrmojo.esrimap.ClusterLayerWrapper=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.esrimap.ClusterLayerWrapper",clusterLayer:null,clusterMode:null,clusterTolerance:50,clusterData:[],clusters:[],clusterLabelColor:"#000",clusterResolution:1,singleTemplate:null,sr:null,markerType:1,zoomEnd:null,unload:null,layerRemove:null,smallClusterCount:10,mediumClusterCount:100,offsetY:11,iRadius:15,oRadius:25,iDiameter:null,iCircleRings:[],oCircleRings:[],numberOfPoints:2999,visible:true,mapExtent:null,mapWidth:null,mapHeight:null,init:function init(props){this.clusterTolerance=props.clusterTolerance||this.clusterTolerance;this.clusterData=props.clusterData||this.clusterData;this.clusters=[];this.clusterLabelColor=props.clusterLabelColor||this.clusterLabelColor;this.singleTemplate=props.singleTemplate||(new esri.InfoTemplate({title:"",content:"{*}"}));this.sr=props.sr||(new esri.SpatialReference({wkid:102100}));this.markerType=props.markerType||this.markerType;this.visible=props.visible;this.mapViewer=props.mapViewer;this.clusterMode=props.mapViewer.clusterMode;this.clusterLayer=new esri.layers.GraphicsLayer({visible:props.visible});if(this.clusterMode===$EnumClusterMode.PIE){this.hasAngleMetric=!!this.mapViewer.dropZones.angle;var iCircleGeometry=new esri.geometry.Circle({center:esri.geometry.Point([0,this.offsetY*(-1)],new esri.SpatialReference({wkid:102100})),radius:this.iRadius,numberOfPoints:this.numberOfPoints}),oCircleGeometry=new esri.geometry.Circle({center:esri.geometry.Point([0,this.offsetY*(-1)],new esri.SpatialReference({wkid:102100})),radius:this.oRadius,numberOfPoints:this.numberOfPoints});this.iCircleRings=iCircleGeometry.rings[0];this.oCircleRings=oCircleGeometry.rings[0];this.iDiameter=this.iRadius*2;}},renderClusterLayer:function renderClusterLayer(map){this.mapExtent=map.extent;this.mapWidth=map.width;this.mapHeight=map.height;this.clusterResolution=map.extent.getWidth()/map.width;this._createAndShowClusters();var me=this;this.zoomEnd=map.on("zoom-end",function(){me.clusterResolution=me.clusterLayer._map.extent.getWidth()/me.clusterLayer._map.width;me.mapExtent=this.extent;me.mapWidth=this.width;me.mapHeight=this.height;me._clear();me._createAndShowClusters();me.mapViewer.populateDataLabelMetricValues();});this.unload=map.on("unload",function(){if(me.zoomEnd){me.zoomEnd.remove();}});this.layerRemove=map.on("layer-remove",function(layer){if(!!layer&&layer.layer===me.clusterLayer&&me.zoomEnd){me.zoomEnd.remove();}});},_clear:function(){this.clusterLayer.clear();this.clusters.length=0;},_createAndShowClusters:function(){this.clusters=this._createAllClusters(this.clusterData);this._showAllClusters(this.clusters);},_createAllClusters:function(pointsData){var point,clustered,numClusters,cluster,clusters=[],i,j,jl=pointsData.length;for(j=0;j<jl;j++){point=pointsData[j];clustered=false;numClusters=clusters.length;for(i=0;i<numClusters;i++){cluster=clusters[i];if(this._clusterTest(point,cluster)){this._clusterAddPoint(point,cluster);clustered=true;break;}}if(!clustered){clusters.push(this._clusterCreate(point));}}return clusters;},_clusterTest:function(p,cluster){var distance=(Math.sqrt(Math.pow((cluster.x-p.x),2)+Math.pow((cluster.y-p.y),2))/this.clusterResolution);return(distance<=this.clusterTolerance);},_clusterAddPoint:function(p,cluster){var count,x,y,pAttributes=p.attributes,clusterAttributes=cluster.attributes;count=clusterAttributes.clusterCount;x=(p.x+(cluster.x*count))/(count+1);y=(p.y+(cluster.y*count))/(count+1);cluster.x=x;cluster.y=y;clusterAttributes.clusterCount++;if(!p.hasOwnProperty("attributes")){pAttributes={};}pAttributes.clusterId=clusterAttributes.clusterId;if(!clusterAttributes.geoIndices){clusterAttributes.geoIndices=[];}if(!clusterAttributes.longGeoIndices){clusterAttributes.longGeoIndices=[];}clusterAttributes.geoIndices.push(pAttributes.geoIndex);clusterAttributes.longGeoIndices.push(pAttributes.longGeoIndex);if(!clusterAttributes.rowIndices){clusterAttributes.rowIndices=[];}clusterAttributes.rowIndices.push(pAttributes.rowIndex);if(!clusterAttributes.columnIndices){clusterAttributes.columnIndices=pAttributes.columnIndices;}if(this.clusterMode===$EnumClusterMode.PIE){cluster.points.push(p);if(this.hasAngleMetric){cluster.angleMetricSum+=p.absAngleMetricVal;}}},_clusterCreate:function(p){var clusterId=this.clusters.length+1,cluster,pAttributes=p.attributes,n;if(!pAttributes){pAttributes={};}pAttributes.clusterId=clusterId;cluster={x:p.x,y:p.y,attributes:{clusterCount:1,clusterId:clusterId,geoIndices:[pAttributes.geoIndex],longGeoIndices:[pAttributes.longGeoIndex],rowIndices:[pAttributes.rowIndex],columnIndices:pAttributes.columnIndices,infoWindowContent:p.infoWindowContent,singleSymbol:p.singleSymbol,layerKey:pAttributes.layerKey,dlTextName:p.dlTextName,symbolSize:p.symbolSize}};if(this.clusterMode===$EnumClusterMode.PIE){cluster.points=[p];if(this.hasAngleMetric){cluster.angleMetricSum=p.absAngleMetricVal;}}for(n in pAttributes){if(pAttributes.hasOwnProperty(n)){cluster.attributes[n]=pAttributes[n];}}return cluster;},_showAllClusters:function(clusters){var i,il,c;this.mapViewer.dataLabelsConfig.length=0;for(i=0,il=clusters.length;i<il;i++){c=clusters[i];this._showCluster(c);}},_showCluster:function(c){var cPoint=new esri.geometry.Point(c.x,c.y,this.sr);this.mapViewer.dataLabelsConfig.push(this._createDataLabelConfig(c.attributes,cPoint));this._createAndAddGraphic(c,cPoint);},_createAndAddGraphic:function(c,cPoint){var attributes=c.attributes,infoTemplate=this.singleTemplate.setContent(attributes.infoWindowContent),clusterCount=attributes.clusterCount,label,labelGraphic,symbolGraphic;if(clusterCount===1){symbolGraphic=new esri.Graphic(cPoint,attributes.singleSymbol,attributes,infoTemplate);this.clusterLayer.add(symbolGraphic);}else{symbolGraphic=(this.clusterMode===$EnumClusterMode.PIE)?this._addRingPieGraphics(c,cPoint,infoTemplate):this._addPictureGraphic(attributes,cPoint,infoTemplate);this.clusterLayer.add(symbolGraphic);label=new esri.symbol.TextSymbol(clusterCount).setColor(new dojo.Color(this.clusterLabelColor)).setOffset(0,7).setFont(new esri.symbol.Font("8pt","Arial"));labelGraphic=new esri.Graphic(cPoint,label,attributes,infoTemplate);labelGraphic.refGraphic=symbolGraphic;symbolGraphic.labelGraphic=labelGraphic;this.clusterLayer.add(labelGraphic);}},_createDataLabelConfig:function(attributes,cPoint){var dataLabelConfig={},clusterCount=attributes.clusterCount;if(clusterCount===1){dataLabelConfig={text:attributes.dlTextName,rowIndex:attributes.rowIndex,mapPoint:cPoint,symbolSize:attributes.symbolSize};}else{dataLabelConfig={rowIndex:attributes.rowIndex,mapPoint:cPoint,symbolSize:{width:CLUSTER_SYMBOL_DIMENSION,height:CLUSTER_SYMBOL_DIMENSION},disableLabel:true};}return dataLabelConfig;},_addPictureGraphic:function(attributes,cPoint,infoTemplate){var clusterCount=attributes.clusterCount,symbolGraphic,imageUrl;if(clusterCount<this.smallClusterCount){imageUrl=mstrmojo.getStyleRoot()+"/images/blue_highlight@2x.png";}else{if(clusterCount<this.mediumClusterCount){imageUrl=mstrmojo.getStyleRoot()+"/images/orange_highlight@2x.png";}else{imageUrl=mstrmojo.getStyleRoot()+"/images/red_highlight@2x.png";}}symbolGraphic=new esri.Graphic(cPoint,new esri.symbol.PictureMarkerSymbol(imageUrl,CLUSTER_SYMBOL_DIMENSION,CLUSTER_SYMBOL_DIMENSION).setOffset(0,this.offsetY),attributes,infoTemplate);return symbolGraphic;},_addRingPieGraphics:function(c,cPoint,infoTemplate){var attributes=c.attributes,clusterCount=attributes.clusterCount,outline=this.mapViewer.parent.regularStroke,color,symbol,symbolGraphic;if(clusterCount<this.smallClusterCount){color=new dojo.Color([0,150,255,0.75]);}else{if(clusterCount<this.mediumClusterCount){color=new dojo.Color([255,147,0,0.75]);}else{color=new dojo.Color([255,38,0,0.75]);}}symbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,this.iDiameter,outline,color).setOffset(0,this.offsetY);symbolGraphic=new esri.Graphic(cPoint,symbol,attributes,infoTemplate);symbolGraphic.sliceGraphics=this._addSliceGraphics(c,cPoint,symbolGraphic);symbolGraphic.isPieCluster=true;return symbolGraphic;},_addSliceGraphics:function(c,cPoint,centerGraphic){var sliceGraphics=[],sliceGraphic,points=c.points,clusterCount=points.length,angleInterval=this.numberOfPoints/clusterCount,startPointIdx=0,endPointIdx=0,p,i,il=clusterCount-1;for(i=0;i<il;i++){p=points[i];if(this.hasAngleMetric&&c.angleMetricSum!==0){j=this.numberOfPoints*p.absAngleMetricVal/c.angleMetricSum;if(j===0){continue;}endPointIdx+=Math.floor(j);}else{endPointIdx=Math.floor((i+1)*angleInterval);}sliceGraphic=this._createSliceGraphic(cPoint,p,startPointIdx,endPointIdx);sliceGraphic.refGraphic=centerGraphic;sliceGraphics.push(sliceGraphic);startPointIdx=endPointIdx;this.clusterLayer.add(sliceGraphic);}endPointIdx=this.numberOfPoints-1;sliceGraphic=this._createSliceGraphic(cPoint,points[il],startPointIdx,endPointIdx);sliceGraphic.refGraphic=centerGraphic;sliceGraphics.push(sliceGraphic);this.clusterLayer.add(sliceGraphic);return sliceGraphics;},_createSliceGraphic:function(cPoint,slicePoint,startPointIdx,endPointIdx){var iCircleRings=this.iCircleRings,oCircleRings=this.oCircleRings,cScreenPoint=new esri.geometry.toScreenGeometry(this.mapExtent,this.mapWidth,this.mapHeight,cPoint),outline=this.mapViewer.parent.regularStroke,geometry,color,symbol,graphic,rings=[],i,j=0,k=2*(endPointIdx-startPointIdx+1)-1;for(i=startPointIdx;i<=endPointIdx;i++){rings[j++]=[oCircleRings[i][0]+cScreenPoint.x,oCircleRings[i][1]+cScreenPoint.y];rings[k--]=[iCircleRings[i][0]+cScreenPoint.x,iCircleRings[i][1]+cScreenPoint.y];}rings.push([oCircleRings[startPointIdx][0]+cScreenPoint.x,oCircleRings[startPointIdx][1]+cScreenPoint.y]);geometry=new esri.geometry.Polygon({rings:[rings],spatialReference:undefined});color=slicePoint.singleSymbol.color;symbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,outline,color);graphic=new esri.Graphic(new esri.geometry.toMapGeometry(this.mapExtent,this.mapWidth,this.mapHeight,geometry),symbol,slicePoint.attributes,slicePoint.infoWindowContent);graphic.isSlice=true;return graphic;},destroy:function destroy(deepClean){if(this.unrenderred){return ;}this.unload.remove();this.layerRemove.remove();this._super(deepClean);}});}());