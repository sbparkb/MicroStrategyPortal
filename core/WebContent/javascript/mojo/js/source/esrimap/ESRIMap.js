(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo.Button","mstrmojo.HBox","mstrmojo.VBox","mstrmojo.SelectBox","mstrmojo.form","mstrmojo.css","mstrmojo.array","mstrmojo.hash","mstrmojo.DocXtabModel","mstrmojo.Box","mstrmojo.Editor","mstrmojo.gmaps.MapToolbar","mstrmojo.gmaps._CanShowMapToolbar","mstrmojo._CanLoadESRIMapScript","mstrmojo.esrimap.ESRIMapViewer","mstrmojo.esrimap.ClusterLayerWrapper","mstrmojo.esrimap.ESRIDensityLayer","mstrmojo.VisMapBase","mstrmojo._VizSelectionHelper","mstrmojo._CanDrawHeatMap","mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.gmaps._HasContextMenu","mstrmojo._Formattable","mstrmojo.dom","mstrmojo.Model","mstrmojo.gmaps.ObservableModel","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps._CanExportPDF");mstrmojo.requiresDescs(8268,13250,13251,1158,862,14664);var TOOLBAR_STATE=mstrmojo.gmaps.MapToolbar.TOOLBAR_STATE,DRILL_DIRECTION={NO_DRILL:0,DRILL_DOWN:1,DRILL_UP:2},DRILL_TOOLTIP_CSS="esri-alt-selection",DRILL_TOOLTIP_SHOW="show",$EnumMarkerType=mstrmojo.gmaps.EnumMapType,$EnumZoomBehavior=mstrmojo.gmaps.EnumZoomBehavior,$EDZ=mstrmojo.vi.viz.EnumDSSDropZones,$D=mstrmojo.dom,$C=mstrmojo.css,$H=mstrmojo.hash;if(!window.console){console={log:function(){}};}var EnumAreaDirection={NONE:0,ALL:1,TOP:2,LEFT:4,BOTTOM:8,RIGHT:16};var STREETMAP_TITLE="World Street Map";var drillDownMsg="<div>"+mstrmojo.desc(13854,"To automatically drill down:")+"</div><div>"+mstrmojo.desc(13855,"Hold ALT, make selection with mouse, and release")+"</div>",drillUpMsg="<div>"+mstrmojo.desc(13856,"To automatically drill up:")+"</div><div>"+mstrmojo.desc(13857,"Hold ALT/CTRL, make selection with mouse, and release")+"</div>";function updateTooltip(tooltip,cssClass){var node=dojo.query("div.tooltip")[0];if(node===undefined){return ;}if(!tooltip){node.innerHTML="";}else{if(node.innerHTML!==tooltip){node.innerHTML=tooltip;}}if(cssClass){$C.addClass(node,cssClass);}}function isExtentValid(extent){return !!extent&&!isNaN(extent.xmin)&&!isNaN(extent.xmax)&&!isNaN(extent.ymin)&&!isNaN(extent.ymax);}function cancelSelection(){if(this.getDrillSelectionMode()){if(this.mapDiv){$C.removeClass(this.mapDiv,DRILL_TOOLTIP_CSS);}this.getToolbar().set("state",TOOLBAR_STATE.NORMAL_STATE);this.setDrillSelectionMode(DRILL_DIRECTION.NO_DRILL);updateTooltip();window.removeEventListener("blur",this.clearDrillSelectionFun);delete this.clearDrillSelectionFun;}}function noDensityMapViewer(){var i,len,viewers=this.gridDataViewer;for(i=0,len=viewers&&viewers.length||0;i<len;i++){if(this.gridDataViewer[i].enableDensity){return false;}}return true;}function createObservableModel(){if(!!this.observableModel&&!this.observableModel.destroyed){this.observableModel.destroy();}var me=this,props=this.getProperties(),om=new mstrmojo.gmaps.ObservableModel({host:me,widgetProps:props});return om;}function isDataReady(data){if(data.gts){return true;}return false;}function drawCircleSelectionIndicator(evt){var me=this;function getRad(d){var PI=Math.PI;return d*PI/180;}function coolWPDistance(lat1,lng1,lat2,lng2){var s,c,w,r,d,h1,h2,f=getRad((lat1+lat2)/2),g=getRad((lat1-lat2)/2),l=getRad((lng1-lng2)/2),sf=Math.sin(f),sg=Math.sin(g),sl=Math.sin(l),a=6378137,fl=1/298.257;sg=sg*sg;sl=sl*sl;sf=sf*sf;s=sg*(1-sl)+(1-sf)*sl;c=(1-sg)*(1-sl)+sf*sl;w=Math.atan(Math.sqrt(s/c));r=Math.sqrt(s*c)/w;d=2*w*a;h1=(3*r-1)/2/c;h2=(3*r+1)/2/s;s=d*(1+fl*(h1*sf*(1-sg)-h2*(1-sf)*sg));s=s/1000;return s;}function dist(a,b){return(a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y);}function intersect(points,layerPoint,mc){if(!points){return 0;}var count=0,r=dist(layerPoint,mc),pt={},i;for(i=0;i<points.length;i++){pt.x=points[i][0];pt.y=points[i][1];if(dist(pt,mc)<=r){count++;}}return count;}function rotate(x,y,angle,length){var vx=x*Math.cos(angle)-y*Math.sin(angle),vy=x*Math.sin(angle)+y*Math.cos(angle);if(length){var d=Math.sqrt(vx*vx+vy*vy);vx=vx/d*length;vy=vy/d*length;}return{x:vx,y:vy};}if(me.enableCircleSelect&&me.center){var layerPoint=me.esriMap.toMap(new esri.geometry.Point(evt.layerX,evt.layerY,me.esriMap.spatialReference)),mp=esri.geometry.webMercatorToGeographic(layerPoint),c=me.center,mc=esri.geometry.geographicToWebMercator(c);if(!me.indicatorTooltip){me.indicatorTooltip=new mstrmojo.VisTooltip({placeholder:document.body.appendChild(document.createElement("div")),owner:this});me.indicatorTooltip.render();}var distance=coolWPDistance(mp.y,mp.x,c.y,c.x);var points=me.gridDataViewer[me._primaryGridIndex].points&&me.gridDataViewer[me._primaryGridIndex].points.points;me.indicatorTooltip.displayInfo([{n:"Radius",v:distance.toFixed(2)+" km"},{n:"Selected",v:intersect(points,layerPoint,mc)+""},{n:"Longitude",v:mp.x.toFixed(3)},{n:"Latitude",v:mp.y.toFixed(3)}],{x:evt.x,y:evt.y});me.indicatorTooltip.domNode.onmouseover=function(){me.indicatorTooltip.toggle(false);};me.indicatorTooltip.toggle(true);me.toggleCircleSelectionIndicator(true);var svgNode=document.getElementsByTagName("svg")[0],rect=svgNode.getBoundingClientRect(),x0=me.cX-rect.left,y0=me.cY-rect.top,x1=evt.x-rect.left,y1=evt.y-rect.top,H=10,L=4,angle=Math.atan(L/H),length=Math.sqrt(L*L+H*H),p2=rotate(x1-x0,y1-y0,angle,length),p3=rotate(x1-x0,y1-y0,-angle,length),x2=x1-p2.x,y2=y1-p2.y,x3=x1-p3.x,y3=y1-p3.y,pointStr="M "+x1+" "+y1+" L"+x2+" "+y2+" L"+x3+" "+y3;me.circleSelcDec.setAttribute("d",pointStr);me.circleSelcLine.setAttribute("x1",x0);me.circleSelcLine.setAttribute("y1",y0);me.circleSelcLine.setAttribute("x2",x1);me.circleSelcLine.setAttribute("y2",y1);}}mstrmojo.esrimap.ESRIMap=mstrmojo.declare(mstrmojo.VisMapBase,[mstrmojo._HasPopup,mstrmojo._Formattable,mstrmojo.gmaps._CanShowMapToolbar,mstrmojo._CanLoadESRIMapScript,mstrmojo._VizSelectionHelper,mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl,mstrmojo.gmaps._HasContextMenu,mstrmojo.gmaps._CanExportPDF],{scriptClass:"mstrmojo.esrimap.ESRIMap",iconClass:"",title:"",height:"auto",width:"auto",DEFAULT_COLOR:"#FE766A",drawingLayer:null,mapStylesCache:null,mapStyleReady:false,minZoom:1,minZoomLimit:0,showHomeButton:false,minExtent:null,searchMode:false,destroyed:false,maxScale:0,minScale:0,previousMapStyleId:null,needShowMapContextMenu:false,defaultMapExtent:null,previousExtent:null,refitContent:false,formatHandlers:{domNode:["RW","T"]},isESRIMap:true,mapDeferred:null,mapEventListeners:null,markupString:'<div id="{@id}" class="claro mstrmojo-ESRIMap {@cssClass} {@iconClass}" title="{@title}" sty="esrimap" style="{@domNodeCssText};position:relative;overflow:hidden" mstrAttach:contextmenu,mousedown><div id="{@id}-toolbar"></div><div id="{@id}-clearAllWindow"></div><div id="{@id}-merticSelectDiv"></div><div id="{@id}-clearAllPopupDiv"></div><div id="{@id}-singleSelectPopupDiv"></div><div id="{@id}-map" style="height:{@height}px"></div><div id="{@id}-legend"></div><div id="{@id}-home"></div></div>',markupSlots:{toolBarDiv:function(){return this.domNode.firstChild;},clearAllWindowDiv:function(){return this.domNode.childNodes[1];},merticSelectDiv:function(){return this.domNode.childNodes[2];},clearAllPopupDiv:function(){return this.domNode.childNodes[3];},singleSelectPopupDiv:function(){return this.domNode.childNodes[4];},mapDiv:function(){return this.domNode.childNodes[5];},legendPlaceholder:function(){return this.domNode.childNodes[6];}},oncontextmenu:function oncontextmenu(evt){var e=evt.e,target,graphic,targetConfig=null,cfg;if(e&&(this.needShowMapContextMenu||this.toolbarStateChanged)){$D.stopPropogation(window,e);$D.preventDefault(window,e);}else{target=evt.getTarget();graphic=target.e_graphic;targetConfig=this.getContextMenuConfigureFromTarget(graphic,e.offsetX,e.offsetY);cfg=this.getMenuConfig(targetConfig);if(cfg.hasMenuItems()){$D.stopPropogation(window,e);$D.preventDefault(window,e);}}return false;},onmousedown:function(evt){var e=evt.e,toolbar=this.getToolbar(),isSelectionState=toolbar&&toolbar.isSelectionState();if(this.isRightClick(evt)&&isSelectionState){toolbar.set("state",TOOLBAR_STATE.NORMAL_STATE);this.toolbarStateChanged=true;$D.stopPropogation(window,e);$D.preventDefault(window,e);return false;}this.toolbarStateChanged=false;return true;},handleMouseUp:function handleMouseUp(evt){var targetConfig=null,i,layer,layerCount=this.gridDataViewer?this.gridDataViewer.length:0,densityLayer=null;this.needShowMapContextMenu=false;if(this.isRightClick(evt)&&!this.toolbarStateChanged){targetConfig=this.getContextMenuConfigureFromTarget(evt.graphic,evt.screenPoint.x,evt.screenPoint.y);$D.stopPropogation(window,evt);this.needShowMapContextMenu=this.showMenu(evt,targetConfig);return !this.needShowMapContextMenu;}},getContextMenuConfigureFromTarget:function getConfigureFromTarget(targetGraphic,offsetX,offsetY){var targetConfig=null,i,layer,layerCount=this.gridDataViewer?this.gridDataViewer.length:0,densityLayer=null;if(targetGraphic&&targetGraphic.attributes){targetConfig={type:this.EnumContextMenuTargetType.GeoGraphic,object:targetGraphic};}else{for(i=0;i<layerCount;i++){layer=this.gridDataViewer[i];if(layer.enableDensity&&layer.visible){densityLayer=layer.densityLayer;break;}}if(densityLayer){var cluster=densityLayer.densityLayer?densityLayer.densityLayer.getAttrsFromLocationMapRange(Math.ceil(offsetX),Math.ceil(offsetY),5):[];if(cluster.length>0){targetConfig={type:this.EnumContextMenuTargetType.DensityGraphic,object:cluster};}}}if(!targetConfig){targetConfig={type:this.EnumContextMenuTargetType.BlankSpace,object:null};}return targetConfig;},handleSingleSelection:function handleSingleSelection(apply){for(var i in this.gridDataViewer){if(!!this.gridDataViewer[i].previousState){var viewer=this.gridDataViewer[i];var columnIndex=viewer.previousState.columnIndex;if(apply){viewer.command.applySelection(viewer.savedSliceInfo);viewer.endSelections();}else{viewer.currentSelections[columnIndex]=viewer.previousState.currentSelections;viewer.selectedRowIndices[columnIndex]=viewer.previousState.selectedRowIndices;viewer.highlightedGraphics[columnIndex]=viewer.previousState.highlightedGraphics;var selectedObjList=viewer.previousState.mapObjectsState.selectedObj;var unselectedObjList=viewer.previousState.mapObjectsState.unselectedObj;for(var j in selectedObjList){var g=selectedObjList[j];viewer.highlightGraphic(g);if(!!g.attributes.clusterCount){viewer.addVisSelection(g.attributes.rowIndices);}else{viewer.addVisSelection(g.attributes.rowIndex);}}for(var k in unselectedObjList){var g=unselectedObjList[k];viewer.clearHighlight(g);if(!!g.attributes.clusterCount){viewer.removeVisSelection(g.attributes.rowIndices);}else{viewer.removeVisSelection(g.attributes.rowIndex);}}if(viewer.enablePolygon){viewer.refreshMap();}}viewer.previousState=null;viewer.savedSliceInfo=[];}}this.set("markerSelected",!this.noMarkerSelected());},clearAllLayerSelections:function clearAllLayerSelections(){for(var i=0;i<this.gridDataViewer.length;i++){var currentGridDataViewer=this.gridDataViewer[i],selectedRowIndices=currentGridDataViewer.getSelectedRowIndices(currentGridDataViewer.getGeoColumnIndex());currentGridDataViewer.clearAllHighlight();currentGridDataViewer.currentSelections={};if(currentGridDataViewer.highlightedGraphics){currentGridDataViewer.highlightedGraphics={};}if(selectedRowIndices&&selectedRowIndices.length>0){currentGridDataViewer.selectedRowIndices={};currentGridDataViewer.clearSelections();currentGridDataViewer.endSelections();var pos;if(currentGridDataViewer.enablePolygon){pos=[currentGridDataViewer.geoPosition];}else{pos=[currentGridDataViewer.latIndex,currentGridDataViewer.longIndex];}var sliceInfo={pos:pos,elementIndex:[],setViewDataFlag:false,applyControl:true,beanPath:currentGridDataViewer.beanPath};currentGridDataViewer.command.applySelection(sliceInfo);}}},isSelectedDensity:function isSelectedDensity(){return false;},isRightClick:function isRightClick(evt){var isRightClick=false;if(evt.which){isRightClick=evt.which===3;}else{if(evt.button){isRightClick=evt.button===2;}}return isRightClick;},isToolbarPositionFixed:function isToolbarPositionFixed(){return true;},doClearRectangle:function doClearRectangle(forceClear){if(!forceClear&&!this.enableRectangleSelect&&!this.enableCircleSelect&&!this.enableFreeFormSelect){return ;}this.clearMap();},noMarkerSelected:function noMarkerSelected(){for(var i in this.gridDataViewer){var selections=this.gridDataViewer[i].currentSelections;if(!!selections){for(var j in selections){if(selections[j]&&selections[j].length>0){return false;}}}}return true;},noPolygonsPresentOnMap:function noPolygonsPresentOnMap(){return true;},selectedMetricIndex:0,onselectedMetricIndexChange:function onselectedMetricIndexChange(gridIndex,metricIndex,metricId){this.gridDataViewer[gridIndex].selectedMetricIndexChange(metricIndex,metricId);},useESRICloud:false,enableClickSelect:true,enableRectangleSelect:false,enableFreeFormSelect:false,enableCircleSelect:false,enableZoom:false,operationalLayers:null,rectangleFillSymbol:null,polylineFillSymbol:null,toolBarActive:false,drillable:true,onenableRectangleSelectChange:function onenableRectangleSelectChange(){if(this.esriToolbar===undefined){return ;}if(this.enableRectangleSelect){this.esriToolbar.setFillSymbol(this.rectangleFillSymbol);this.esriToolbar.activate(esri.toolbars.Draw.EXTENT);}else{this.esriToolbar.deactivate(esri.toolbars.Draw.EXTENT);}for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].enableSelect=this.enableRectangleSelect;}},onenableFreeFormSelectChange:function onenableFreeFormSelectChange(){if(this.esriToolbar===undefined){return ;}if(this.enableFreeFormSelect){this.esriToolbar.setFillSymbol(this.polylineFillSymbol);this.esriToolbar.activate(esri.toolbars.Draw.FREEHAND_POLYGON);}else{this.esriToolbar.deactivate(esri.toolbars.Draw.FREEHAND_POLYGON);}for(var i=0,len=this.gridDataViewer.length;i<len;i++){this.gridDataViewer[i].enableSelect=this.enableFreeFormSelect;}},onenableCircleSelectChange:function onenableCircleSelectChange(){var me=this;if(me.esriToolbar===undefined){return ;}if(!this.drawIndicatorListener){this.drawIndicatorListener=drawCircleSelectionIndicator.bind(this);}if(me.enableCircleSelect){me.esriToolbar.setFillSymbol(me.rectangleFillSymbol);me.esriToolbar.activate(esri.toolbars.Draw.CIRCLE);$D.attachEvent(me.esriDiv,"mousemove",this.drawIndicatorListener,true);}else{me.esriToolbar.deactivate(esri.toolbars.Draw.CIRCLE);$D.detachEvent(me.esriDiv,"mousemove",this.drawIndicatorListener,true);delete this.drawIndicatorListener;}for(var i=0;i<me.gridDataViewer.length;i++){me.gridDataViewer[i].enableSelect=me.enableCircleSelect;}},setMapType:function setMapType(value){this.setMapStyle(value);this.currentLayer&&this.currentLayer.setVisibility(true);},isSearchMode:function isSearchMode(){return this.searchMode;},setSearchMode:function setSearchMode(value){this.searchMode=value;},getSuggestions:function getSuggestions(pattern,callback){var protocol=this.getProtocol(),me=this,locator=this.locator;if(!locator){locator=new esri.tasks.Locator(protocol+"//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer");locator.outSpatialReference=this.esriMap.spatialReference;this.locator=locator;}locator.suggestLocations({text:pattern}).then(function(suggestions){var blocks=[],results,elems=[],visibleDv=0,props,excludes,dv,i,useAttr,displayForm,unitConfig,len;var stopFunction=function(obj){if(dv.rowIndex2Graphics[obj.v]){elems.push(obj);}return elems.length>=5;};for(i=0,len=me.gridDataViewer.length;i<len;i++){elems=[];dv=me.gridDataViewer[i];props=dv.getWidgetProps();if(dv.enablePolygon){unitConfig={unitId:props.ma,isAttr:true,excludes:[]};}else{useAttr=dv.useAttribute;excludes=(!useAttr&&props.lat)?[props.lat,props.lng]:[];displayForm=useAttr?props.atf:props.satf;unitConfig={unitId:displayForm?displayForm:props.ma,isAttr:displayForm?useAttr:true,excludes:excludes};}if(dv.visible){visibleDv++;results=[];dv.filterElements(pattern,unitConfig,stopFunction)||[];if(elems.length>0){mstrmojo.array.forEach(elems,function(v){v.cls="elem";v.dvi=i;results.push(v);});blocks.push({label:dv.getLayerGridName(),items:results});}}}if(visibleDv===1&&blocks.length>0){delete blocks[0].label;}if(suggestions&&suggestions.length>0){results=[];mstrmojo.array.forEach(suggestions,function(v){results.push({n:v.text,v:v.magicKey,cls:"geo",geo:v});});blocks.push({items:results});}callback(blocks);});},onSuggestionItemSelected:function onSuggestionItemSelected(item){var map=this.esriMap,dv,ext;if(item&&item.geo&&this.locator){this.locator.addressToLocations({address:{SingleLine:item.n},magicKey:item.v});this.locator.on("address-to-locations-complete",function(evt){var geom,ext,extent;mstrmojo.array.forEach(evt.addresses,function(candidate){if(candidate.score>80){geom=candidate.location;ext=candidate.extent;extent=new esri.geometry.Extent(ext.xmin,ext.ymin,ext.xmax,ext.ymax,map.spatialReference);return false;}});if(!geom&&evt.addresses&&evt.addresses.length>0){geom=evt.addresses[0].location;ext=evt.addresses[0].extent;extent=new esri.geometry.Extent(ext.xmin,ext.ymin,ext.xmax,ext.ymax,map.spatialReference);}if(geom){map.setExtent(extent,true);map.centerAt(geom);}});}else{if(item){dv=this.gridDataViewer[item.dvi];if(dv){ext=dv.getGeoObjectExt(item.v,true);if(ext){if(ext.center){map.centerAndZoom(ext.center,10);}if(ext.bound){map.setExtent(ext.bound,true);}}}}}},enablePopup:true,onenablePopupChange:function onenablePopupChange(evt){this.enablePopup=evt.value;},infoWindowVisible:true,oninfoWindowVisibleChange:function oninfoWindowVisibleChange(){var infoDiv=dojo.byId(this.domNode.id+"_infowindow");if(typeof infoDiv=="undefined"||!infoDiv){return ;}if(this.infoWindowVisible){if(infoDiv.style.visibility=="hidden"){infoDiv.style.visibility="";}}else{infoDiv.style.visibility="hidden";}},enableDebug:true,baseMapUrl:"http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer",baseLayer:null,isBaseMapDynamic:false,esriMapping:{},gridDataViewer:null,gridKeysMap:null,gridNamesSelectorItems:null,_primaryGridIndex:0,registeredSDPKeys:null,initMultipleDataProviders:function initMultipleDataProviders(gridParams){this.loadWidgetPropsAndGridData();if(!this.grids){return ;}this._primaryGridIndex=this.arrangeGridLayersVerticalOrderingOnMap();this.gridDataViewer=[];this.gridNamesSelectorItems=[];this.registeredSDPKeys=[];var beanPath,key,msgId,dm=this.getDocModel(),xtab;this.gridKeysMap={};if(!!gridParams&&!!gridParams.beanPath){beanPath=gridParams.beanPath;}else{if(typeof (microstrategy)!=="undefined"){this.gridBone=microstrategy.bone(gridParams.boneId);beanPath=this.gridBone&&this.gridBone.getDocViewer().beanPath;}}msgId=mstrApp.getMsgID&&mstrApp.getMsgID();for(var i=0,il=this.grids.length;i<il;i++){key=this.grids[i].grid1.k;xtab=this.fnGetWidget(key);this.gridDataViewer[i]=new mstrmojo.esrimap.ESRIMapViewer({parent:this,data:this.grids[i].grid1,defn:xtab&&xtab.defn,widgetProps:this.grids[i].widgetProps,k:key,beanPath:beanPath,msgID:msgId,isPrimary:(i===this._primaryGridIndex)?true:false,model:xtab&&xtab.model,layerIndex:i,dropZones:this.getDropZones(key)});this.gridKeysMap[key]=i;this.gridNamesSelectorItems.push({v:i,n:this.grids[i].grid1.n,id:key});if(!this.gridDataViewer[i].isPrimary){if(dm){dm.addSDP(key,{k:this.grids[this._primaryGridIndex].grid1.k,visName:this.grids[this._primaryGridIndex].grid1.visName});this.registeredSDPKeys.push(key);}}this.addDisposable(this.gridDataViewer[i]);}},fnGetWidget:function(_key){for(var i in mstrmojo.all){if(mstrmojo.all[i].k===_key){return mstrmojo.all[i];}}return null;},arrangeGridLayersVerticalOrderingOnMap:function arrangeGridLayersVerticalOrderingOnMap(){var tempGrid=[],primaryGridIndex;this.grids[0].isPrimary=true;for(var i=this.grids.length-1;i>=0;i--){if(this.grids[i].widgetProps.mtp===$EnumMarkerType.Bubble){tempGrid.unshift(this.grids.splice(i,1)[0]);}else{if(this.grids[i].widgetProps.mtp===$EnumMarkerType.Marker){tempGrid.push(this.grids.splice(i,1)[0]);}}}for(var i=this.grids.length-1;i>=0;i--){if(this.grids[i].widgetProps.mtp===$EnumMarkerType.Density&&this.isCanvasSupported()){tempGrid.unshift(this.grids.splice(i,1)[0]);}else{tempGrid.push(this.grids.splice(i,1)[0]);}}for(var i=this.grids.length-1;i>=0;i--){tempGrid.unshift(this.grids.splice(i,1)[0]);}for(var i=0;i<tempGrid.length;i++){if(tempGrid[i].isPrimary&&tempGrid[i].isPrimary==true){primaryGridIndex=i;}}this.grids=tempGrid.slice();return primaryGridIndex;},params:{},gridParams:null,grids:null,gridData:null,enableMarker:false,enablePolygon:false,debug:function debug(s){if(this.enableDebug){console.log(s);}},clearMap:function clearMap(){if(this.esriMap!==undefined){if(!!this.esriMap.graphics){this.esriMap.graphics.clear();}if(!!this.esriMap.infoWindow){this.esriMap.infoWindow.hide();}if(!!this.drawingLayer){this.drawingLayer.clear();}}},saveCustomInfo:function saveCustomInfo(){this.persistWidgetProps();this.closePopup();},regularStroke:null,mouseoverStroke:null,selectionStroke:null,populateStrokes:function populateStrokes(){if(!this.regularStroke){this.regularStroke=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,255,255,0.35]),1);this.mouseoverStroke=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,0,0.75]),2);this.selectionStroke=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,255,255,0.85]),2);this.selectionStrokePolygon=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,255,255,1]),3);}},isCtrl:false,processMapKeydown:function processMapKeydown(_event_){var winObj;if(window.event){winObj=window.event;}else{winObj=_event_;}var intShiftKey=winObj.shiftKey;var intAltKey=winObj.altKey;var intCtrlKey=winObj.ctrlKey;if(intCtrlKey){var oldValue=this.isCtrl;this.isCtrl=true;if(oldValue!=this.isCtrl){console.log("control key status changed to ?"+this.isCtrl);}}if(intAltKey){if(mstrApp&&mstrApp.isVI&&noDensityMapViewer.call(this)){if(window.addEventListener&&!this.getDrillSelectionMode()){this.clearDrillSelectionFun=cancelSelection.bind(this);window.addEventListener("blur",this.clearDrillSelectionFun);}if(this.mapDiv){$C.addClass(this.mapDiv,DRILL_TOOLTIP_CSS);}if(intCtrlKey){this.setDrillSelectionMode(DRILL_DIRECTION.DRILL_UP);updateTooltip(drillUpMsg,DRILL_TOOLTIP_SHOW);}else{this.setDrillSelectionMode(DRILL_DIRECTION.DRILL_DOWN);updateTooltip(drillDownMsg,DRILL_TOOLTIP_SHOW);}this.getToolbar().set("state",TOOLBAR_STATE.RECTANGLE_SELECT_STATE);}return false;}else{}},processMapKeyup:function processMapKeyup(_event_){var winObj;if(window.event){winObj=window.event;}else{winObj=_event_;}var keyCode=winObj.keyCode;if(keyCode==17){this.isCtrl=false;}else{if(keyCode===18){if(mstrApp&&mstrApp.isVI){cancelSelection.call(this);}}}},widgetProps:null,gridBone:null,createOldFormatWidgetPropsXML:function createOldFormatWidgetPropsXML(){var widgetPropsXml="<widgetProps><fmt>";var k;var wps=this.gridDataViewer[0].getWidgetProps();for(k in wps){widgetPropsXml+="<"+k+' value="'+this.encode(this.encode(wps[k]))+'" />';}widgetPropsXml+="</fmt></widgetProps>";return widgetPropsXml;},encode:function encode(oldStr,toServer){var sb=oldStr;if(toServer==null){toServer=false;}if((oldStr!=null)&&(oldStr.length>0)){sb="";for(var i=0,len=oldStr.length;i<len;i++){switch(oldStr.charAt(i)){case"&":if((oldStr.length!=(i+1))&&(oldStr.charAt(i+1)=="#")){sb+="&";}else{sb+="&amp;";}break;case"<":sb+="&lt;";break;case">":sb+="&gt;";break;case"'":sb+="&#039;";break;case"\n":if(!toServer){sb+="<br />";}else{sb+=oldStr.charAt(i);}break;case'"':sb+="&quot;";break;case" ":if(i==0||(i<oldStr.length-1&&oldStr.charAt(i+1)==" ")){sb+="&nbsp;";}else{sb+=oldStr.charAt(i);}break;default:sb+=oldStr.charAt(i);break;}}}return sb;},persistWidgetProps:function persistWidgetProps(){if(this.widgetProps){var widgetPropsXml=this.createWidgetPropsXML();var ac=[];this.gridBone.setVisualizationSettings(null,null,null,null,ac,widgetPropsXml);this.gridBone.um.add(ac);}},onSecondaryDataSliced:function onSecondaryDataSliced(key,data){var ind=this.gridKeysMap[key];this.gridDataViewer[ind].resetData(data);this.gridDataViewer[ind].unrender(true);this.gridDataViewer[ind].render(true);},isEmpty:function isEmpty(){return false;},getVisEmptyMsgControls:function getVisEmptyMsgControls(){return[];},update:function update(node){var continueUpdate=this._super(node);if(continueUpdate!==false){this.observableModel=createObservableModel.call(this);if(this.getData()&&this.getData().eg){return continueUpdate;}var model=this.getData(),vp=model.vp,secondaryProperties=vp.sgProps,secondaryKey,secondaryVp;this.upgradeWidgetProperties(vp);if(!!secondaryProperties){for(secondaryKey in secondaryProperties){secondaryVp=secondaryProperties[secondaryKey];this.upgradeWidgetProperties(secondaryVp);}}}return continueUpdate;},getProperties:function getProperties(key){return this.getVisProps(key);},upgradeWidgetProperties:function upgradeWidgetProperties(vp){if(!vp||$H.keyarray(vp).length===0){return ;}if(vp.mtp==$EnumMarkerType.Bubble&&vp.sa!="1"){if(!vp.separateColorSize&&!!vp.cmt&&!vp.smt){vp.smt=vp.cmt;}}vp.separateColorSize="1";},onShow:function onShow(){if(!this.domNode||this.domNode.offsetWidth===0||this.domNode.offsetHeight===0||!this.esriMap){return ;}if(!!this.esriDiv){var originalWidth=parseInt(this.esriDiv.style.width),originalHeight=parseInt(this.esriDiv.style.height),newWidth=parseInt(this.width),newHeight=parseInt(this.height);if(originalWidth!==newWidth||originalHeight!==newHeight){this.esriDiv.style.width=newWidth+"px";this.esriDiv.style.height=newHeight+"px";if(this.esriMap){this.esriMap.resize();this.esriMap.reposition();}}}},postBuildRendering:function postBuildRendering(){if(this.waitingForData){return ;}this._super();if(mstrApp.isSingleTier&&(typeof (FormWrapper)!="undefined")&&parseInt(FormWrapper.testInternetConnection(),10)!=0){var errorMsg="Unable to download the ESRI map. No Internet connection. You can configure an Internet proxy through your computer's #";var replaceStr='<a href="" style="color:#7CC5EC" onclick="window.FormWrapper.showProxyEditor(); return false;">'+mstrmojo.desc(7831,"Settings")+"</a>.";errorMsg=errorMsg.replace("#",replaceStr);this.displayError(errorMsg);return ;}var $ME=this;var model=this.getData();this.destroyed=false;this.totalLayersRendered=0;mstrApp.docModel&&mstrApp.docModel.attachEventListener("panelSelected",this.id,function(evt){var isChildOfPanel=false,panelDom=document.getElementById(evt.panelId);if(panelDom){isChildOfPanel=panelDom.contains($ME.domNode);if(isChildOfPanel&&evt.panelVisible){$ME.onShow();}}});if(this.isLoadingExtraConfig){return ;}if(mstrApp&&mstrApp.esriConfig){if(mstrApp.esriConfig.gridParams){this.gridParams=mstrApp.esriConfig.gridParams;}if(mstrApp.esriConfig.mapStylesCache){this.mapStylesCache=mstrApp.esriConfig.mapStylesCache;}}if(!this.gridParams){var splitParams={taskId:"getESRIExtraConfig",key:model.k,taskEnv:"xhr",taskContentType:"json"};var that=this;var callback={success:function(res){delete that.isLoadingExtraConfig;if(res){that.processData(res);that.buildESRIMap();}else{this.gridParamDownloadListener=null;}},failure:function(res){delete that.isLoadingExtraConfig;this.gridParamDownloadListener=null;that.hideWait(true);mstrmojo.alert("Error loading Configuration: "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};this.isLoadingExtraConfig=true;mstrApp.serverRequest(splitParams,callback);}else{this.buildESRIMap();}},processData:function processData(res){var extraProps=res.extProps;this.gridParams={};mstrmojo.hash.copy(extraProps.gridParams,this.gridParams);if(mstrApp){if(!mstrApp.esriConfig){mstrApp.esriConfig={};}mstrApp.esriConfig.gridParams=this.gridParams;}},buildESRIMap:function buildESRIMap(res){if(!!this.gridParams&&!!this.gridParams.err&&this.gridParams.err.length>0){this.displayError(this.gridParams.err);this.hideWait(true);return ;}if(!!this.gridParams.config.useESRICloud&&this.gridParams.config.useESRICloud==1){this.useESRICloud=true;}if($D.isIE9){this.isClientExport=false;}this.setEsriConfig(this.gridParams.config);var that=this;document.onkeydown=function(evt){return that.processMapKeydown(evt);};document.onkeyup=function(evt){return that.processMapKeyup(evt);};document.onkeypress=function(evt){var keycode;if(typeof evt==="undefined"){evt=window.event;keycode=evt.keyCode?evt.keyCode:undefined;}else{keycode=evt.keyCode;}if(keycode==13&&!!mstrApp.oi){$D.preventDefault(window,evt);return false;}};this.scriptClass=this.isOIVM()?"mstrmojo.esrimap.ESRIMapOIVM":"mstrmojo.esrimap.ESRIMap";if(mstrmojo.esriMapLib===undefined){mstrmojo.esriMapLib={};mstrmojo.esrimap.loadScriptListeners=[];this.loadExternalScript(this.loadESRIMap,this);}else{var me=this;var callback=this.loadESRIMap;var arg=this.gridParams.config;if(typeof (esri)!=="undefined"){this.loadESRIMap(this.gridParams.config);}else{mstrmojo.esrimap.loadScriptListeners.push({caller:me,method:callback,params:arg});}}},metricData:null,mapTypeData:null,createSlidingToolbar:function createSlidingToolbar(){var toolbarPlaceholder=this.toolBarDiv.id,clearAllPlaceholder=this.clearAllWindowDiv.id,merticSelectPlaceholder=this.merticSelectDiv.id,clearAllPopupPlaceholder=this.clearAllPopupDiv.id,singleSelectPopupPlaceholder=this.singleSelectPopupDiv.id,toolbarButtonsFlag;toolbarButtonsFlag=this.EnumToolbarButtonType.RECTANGLE_SELECT|this.EnumToolbarButtonType.FREE_SELECT|this.EnumToolbarButtonType.CIRCLE_SELECT|this.EnumToolbarButtonType.CLEAR_ALL|this.EnumToolbarButtonType.EDIT_INFO_WINDOW|this.EnumToolbarButtonType.GRIDS_SELECT|this.EnumToolbarButtonType.SEARCH_BAR;if(mstrApp&&mstrApp.isVI){toolbarButtonsFlag^=this.EnumToolbarButtonType.EDIT_INFO_WINDOW;toolbarButtonsFlag^=this.EnumToolbarButtonType.GRIDS_SELECT;}if(this.useESRICloud){toolbarButtonsFlag|=this.EnumToolbarButtonType.MAP_TYPE;}this.initMapTypeData();this.initMapToolbar(this,this.metricData,toolbarButtonsFlag,toolbarPlaceholder,merticSelectPlaceholder,clearAllPopupPlaceholder,singleSelectPopupPlaceholder,this.mapTypeData);this.renderToolbar();this.mapDiv.style.height=parseInt(this.height)-this.toolBarDiv.offsetHeight+"px";},hideInfoWindow:function hideInfoWindow(evt){if(!!this.esriMap&&!!this.esriMap.infoWindow){this.esriMap.infoWindow.hide();}},initMapTypeData:function initMapTypeData(){var $ME=this;$ME.mapTypeData=[];mstrmojo.array.forEach(this.mapStylesCache,function(mapStyle){$ME.mapTypeData.push({src:"../style/images/"+$ME.replaceSpace(mapStyle)+".jpg",n:mapStyle,v:mapStyle,type:"_ESRI_"});});},fullExtent:null,isAsp:function isAsp(){return(window.location.pathname.indexOf("/asp/")>0)?true:false;},isCanvasSupported:function isCanvasSupported(){var elem=document.createElement("canvas");return !!(elem.getContext&&elem.getContext("2d"));},trimString:function trimString(s){return mstr.utils.String.trim(s);},setPosition:function setPosition(){},loadESRIMap:function loadESRIMap(esriMapping){if(this.destroyed){return ;}if(this.isOIVM()){this.setPosition();}var pj,attr;this.prepareDivs();var bm=null,i;if(!!esriMapping&&!!esriMapping.bms){var bms=esriMapping.bms;for(i=0;i<bms.length;i++){if(!!bms[i].key&&bms[i].key=="default"){bm=bms[i];break;}}}if(!!esriMapping&&!!esriMapping.proxyURLs&&esriMapping.proxyURLs.length>0){var proxy=esriMapping.proxyURLs[0];esri.config.defaults.io.proxyUrl=proxy.value;esri.config.defaults.io.alwaysUseProxy=(proxy.alwaysUse=="true");}else{if(!!bm&&!!bm.proxyURL&&this.trimString(bm.proxyURL).length>0){esri.config.defaults.io.proxyUrl=bm.proxyURL;esri.config.defaults.io.alwaysUseProxy=true;}else{if(this.isAsp()){esri.config.defaults.io.proxyUrl="../asp/esriproxy.ashx";}else{esri.config.defaults.io.proxyUrl="../jsp/esriproxy.jsp";}esri.config.defaults.io.alwaysUseProxy=false;}}this.esriMapping=esriMapping;if(!!bm){this.isBaseMapDynamic=(bm.isDyn=="1");this.baseMapUrl=bm.value;}else{this.baseMapUrl=null;this.isBaseMapDynamic=false;}if(!this.useESRICloud&&(!this.baseMapUrl||this.trimString(this.baseMapUrl).length==0)){var errorMsg="The map visualization has not been configured properly. Please contact your administrator to resolve this issue.";this.displayError(errorMsg);return ;}if(!this.useESRICloud){var projects=esriMapping.pjs;var attributeMapping={},attrId;for(pj in projects){if(!pj){continue;}if(projects.hasOwnProperty(pj)&&!!projects[pj].at){for(i=0;i<projects[pj].at.length;i++){attrId=projects[pj].at[i].id;attributeMapping[attrId]=projects[pj].at[i];}}}this.esriAttributeMapping=attributeMapping;}if(!!this.width&&!!this.height){var maxSize=Math.max(parseInt(this.width),parseInt(this.height));var zoomLevel=Math.floor(Math.log(maxSize)/Math.LN2)-7;this.minZoom=zoomLevel>1?zoomLevel:1;}if(!this.esriMap){this.esriDiv=document.createElement("div");this.tempMapDiv=document.createElement("div");this.esriDiv.style.height=parseInt(this.height)+"px";this.esriDiv.style.width=parseInt(this.width)+"px";this.esriDiv.id=this.id+"-esriMapDiv";this.esriDiv.style.position="absolute";this.esriDiv.style.top="0px";this.esriDiv.style.left="0px";this.mapDiv.appendChild(this.esriDiv);var me=this;try{if(this.useESRICloud){this.createWebMap();}else{require(["esri/tasks/locator","esri/graphic","esri/symbols/SimpleMarkerSymbol","esri/symbols/TextSymbol","esri/symbols/PictureMarkerSymbol","esri/dijit/HomeButton","esri/InfoTemplate","esri/toolbars/draw","esri/layers/GraphicsLayer","dojo/_base/connect","esri/SpatialReference","esri/geometry/Point","esri/geometry/Circle","esri/layers/layer"],function(geocoder){me.esriMap=new esri.Map(me.esriDiv.id,{minZoom:me.minZoomLimit,wrapAround180:true,smartNavigation:false});me.initLayers(me.esriMap);});}}catch(e){this.hideWait(true);mstrmojo.alert(e.stack);return ;}}else{var previousWidth=this.esriDiv.style.width,previousHeight=this.esriDiv.style.height;this.esriDiv.style.width=parseInt(this.width)+"px";this.esriDiv.style.height=parseInt(this.height)+"px";this.mapDiv.appendChild(this.esriDiv);if(previousWidth!==this.esriDiv.style.width||previousHeight!==this.esriDiv.style.height){this.extentResized=true;this.esriMap.resize();this.esriMap.reposition();}this.doClearRectangle(true);this.destroyGridViewer();if(this.useESRICloud){var data=this.getData(),mapStyle=data&&data.vp&&data.vp.dv||null;if(mapStyle!==this.previousMapStyleId){this.setMapStyle(mapStyle);this.previousMapStyleId=mapStyle||null;}}this.initESRIMap();}},setMapStyle:function setMapStyle(usedMapStyleName){var layers=this.operationalLayers,i,layer;if(typeof usedMapStyleName=="undefined"||usedMapStyleName==STREETMAP_TITLE){this.baseLayer.setOpacity(1);this.currentLayer=this.baseLayer;}else{this.baseLayer.setOpacity(0);}if(!!layers){for(i=0;i<layers.length;i++){layer=layers[i];if(!!usedMapStyleName){if(layer.title==usedMapStyleName){this.currentLayer=layer.layerObject;}else{if(!layer.layerObject.type||layer.layerObject.type!="Feature Layer"){layer.layerObject.setVisibility(false);}}}}}},refresh:function refresh(){if(this.tempMapDiv&&this.esriDiv){this.tempMapDiv.appendChild(this.esriDiv);}this._super();},createWebMap:function createWebMap(){var me=this,wm=this.getDefaultMap(),webmapId,tokenStr=this.gridParams.config.token,expireTime=1209600,data=this.getData(),usedMapStyleName=data&&data.vp&&data.vp.dv,isPublicWebMap=false,mapStyles=[];if(!!wm){webmapId=wm.id;isPublicWebMap=wm.hasOwnProperty("isPublic")&&wm.isPublic;}if((!tokenStr||tokenStr.length==0)&&!isPublicWebMap){this.fetchTokenFromESRICloud();return ;}if(!!webmapId){var token={server:"http://www.arcgis.com/sharing/rest",token:tokenStr,ssl:false,expires:expireTime};require(["esri/arcgis/utils","esri/IdentityManager","esri/layers/layer","esri/tasks/locator","esri/toolbars/draw","esri/graphic","esri/symbols/SimpleMarkerSymbol","esri/symbols/TextSymbol","esri/symbols/PictureMarkerSymbol","esri/dijit/HomeButton","esri/InfoTemplate","esri/layers/GraphicsLayer","dojo/_base/connect","esri/SpatialReference","esri/geometry/Point","esri/geometry/Circle"],function(arcgisUtils,identityManager){if(!isPublicWebMap){if(!mstrmojo.esrimap.esriTokens){mstrmojo.esrimap.esriTokens=[];}if(mstrmojo.esrimap.esriTokens.indexOf(tokenStr)<0){identityManager.registerToken(token);mstrmojo.esrimap.esriTokens.push(tokenStr);}}if(mstrApp.isSingleTier){arcgisUtils.arcgisUrl=arcgisUtils.arcgisUrl.replace("file","http");}var mapDeferred=me.mapDeferred;if(!mapDeferred){mapDeferred=arcgisUtils.createMap(webmapId,me.esriDiv.id,{mapOptions:{slider:true,zoom:me.minZoom,minZoom:me.minZoomLimit,smartNavigation:false},ignorePopups:true});me.mapDeferred=mapDeferred;}mapDeferred.then(function(response){mapStyles.push(STREETMAP_TITLE);var map=response.map,baseMap=map.getLayer(map.layerIds[0]);if(!usedMapStyleName||STREETMAP_TITLE==usedMapStyleName){me.baseLayer=baseMap;me.currentLayer=me.baseLayer;}me.operationalLayers=response.itemInfo.itemData.operationalLayers;var layerInfo=dojo.map(me.operationalLayers,function(layer,index){if(!!usedMapStyleName&&layer.title==usedMapStyleName){me.currentLayer=layer.layerObject;}if(!layer.layerObject.type||layer.layerObject.type!="Feature Layer"){mapStyles.push(layer.title);}});me.mapStylesCache=mapStyles;me.previousMapStyleId=usedMapStyleName;if(mstrApp){if(!mstrApp.esriConfig){mstrApp.esriConfig={};}mstrApp.esriConfig.mapStylesCache=me.mapStylesCache;}if(map.loaded){me.initLayers(map);}else{me.mapEventListeners.push(dojo.connect(map,"onLoad",function(){me.initLayers(map);me.mapEventListeners.push(dojo.connect(me.esriDiv,"resize",map,function(){map.resize();map.reposition();}));}));}},function(error){var errorMsg;if(mstrApp.isSingleTier){errorMsg="Unable to create the map. Please check you connection. You can configure an Internet proxy through your computer's #";var replaceStr='<a href="" style="color:#7CC5EC" onclick="window.FormWrapper.showProxyEditor(); return false;">'+mstrmojo.desc(7831,"Settings")+"</a>.";errorMsg=errorMsg.replace("#",replaceStr);}else{errorMsg="Unable to download the requested map. Please contact your administrator to resolve this issue.";}me.displayError(errorMsg);return ;});});}},fetchTokenFromESRICloud:function fetchTokenFromESRICloud(){var extraInfo,appId,appSecret,me=this;extraInfo=this.gridParams.config.extrainfo;if(!!extraInfo&&!!extraInfo.primaryId&&!!extraInfo.secondaryId){var tokenURL="https://www.arcgis.com/sharing/oauth2/token";var TOKEN_MAX_LIFE_IN_MINUTES="20160";var GRANT_TYPE_PARAM_VALUE="client_credentials";appId=extraInfo.primaryId;appSecret=extraInfo.secondaryId;var data={client_id:encodeURIComponent(appId),client_secret:encodeURIComponent(appSecret),grant_type:encodeURIComponent(GRANT_TYPE_PARAM_VALUE),expiration:encodeURIComponent(TOKEN_MAX_LIFE_IN_MINUTES)};var callback={success:function(result){if(!!result.error){me.displayError(mstrmojo.desc(14664,"Error retrieving token using the given AppID and AppSecret. ")+result.error.message);return ;}var token=result.access_token;me.gridParams.config.token=token;me.createWebMap();me.cacheTheTokenInServer(appId,result);me.hideWait();},failure:function(response){me.displayError(mstrmojo.desc(14664,"Error retrieving token using the given AppID and AppSecret. ")+response.error);me.hideWait();return ;}};var xhr=new mstrmojo.SimpleXHR({isTask:false,async:true});mstrmojo.xhr.request("POST",tokenURL,callback,data);}else{console&&console.log("ExtraInfo not present to fetch token from ESRI Cloud in client authentication mode.");}},cacheTheTokenInServer:function cacheTheTokenInServer(appId,tokJSON){var model=this.getData(),splitParams={taskId:"getESRIConfig",key:model.k,taskEnv:"xhr",taskContentType:"json",tokenJson:JSON.stringify(tokJSON),id:appId},that=this;var callback={success:function(res){if(res){if(!!res.ec&&res.ec==1){console&&console.log("Successfully cached the token in client authentication mode");}else{console&&console.log("Error caching the token on web server in client authentication mode : "+res);}}},failure:function(res){console&&console.log("Error caching the token on web server in client authentication mode : "+res);}};mstrApp.serverRequest(splitParams,callback);},getDefaultMap:function getDefaultMap(){var webmaps=this.gridParams.config.webmaps;if(!!webmaps){for(var i in webmaps){if(!!webmaps[i]["default"]&&webmaps[i]["default"]==true){return webmaps[i];}}}return null;},setDrillSelectionMode:function setDrillSelectionMode(flag){this.isDrillSelectionMode=flag;},getDrillSelectionMode:function getDrillSelectionMode(){return this.isDrillSelectionMode;},initLayers:function initLayers(map){this.minExtent=map.extent;this.esriToolbar=new esri.toolbars.Draw(map,{showTooltips:false});this.rectangleFillSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([90,163,192]),2),new dojo.Color([83,212,252,0.6]));this.polylineFillSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([90,163,192]),2),null);this.mapEventListeners=[];this.mapEventListeners.push(dojo.connect(this.esriToolbar,"onDrawEnd",this,function(geometry){this.handleExtentDraw(geometry);if(me.getDrillSelectionMode()){if(me.getSelections()&&me.getSelections().length>0){me.processDrillTo(me.getDrillSelectionMode());}me.setDrillSelectionMode(DRILL_DIRECTION.NO_DRILL);}}));this.esriMap=map;var me=this;this.mapEventListeners.push(dojo.connect(this.esriMap,"onExtentChange",function(evt){me.showMapLayer();var viewerList=me.gridDataViewer,areaDirection=EnumAreaDirection.NONE;if(!!viewerList){for(var i=0,il=viewerList.length;i<il;i++){viewerList[i].setVisibility(true);viewerList[i].buildDataLabelLayer();}}var scale=map.getScale();if(me.minScale>0&&scale>me.minScale){areaDirection=me.getAreaDirection();me.showDirectionToast(areaDirection,3000,null,{id:me.id,dom:me.domNode});mstrmojo.toast(mstrmojo.desc(13250,"Please zoom in to see all shapes."),3000,null,{id:me.id,dom:me.domNode,cssClass:"mapToastCss"});}else{if(me.maxScale>0&&scale<me.maxScale){areaDirection=me.getAreaDirection();me.showDirectionToast(areaDirection,3000,null,{id:me.id,dom:me.domNode});mstrmojo.toast(mstrmojo.desc(13251,"Please zoom out to see all shapes."),3000,null,{id:me.id,dom:me.domNode,cssClass:"mapToastCss"});}else{if(!me.isAreaOverlapsViewPort()){areaDirection=me.getAreaDirection();me.showDirectionToast(areaDirection,3000,null,{id:me.id,dom:me.domNode});}else{try{var previousDirectionToastId=me.id+"-esriAreaDirectionToast";mstrmojo.all[previousDirectionToastId].destroy();}catch(e){}}}}me.previousExtent=map.extent;var ExtConfig=me.deferredExtentConfig;if(ExtConfig){map.setExtent(ExtConfig.extent,ExtConfig.includesAll);delete me.deferredExtentConfig;}if(me.onExtentChanged){me.onExtentChanged(evt);}}));if(this.useESRICloud){this.baseLayer=map.getLayer(map.layerIds[0]);}else{var layer;if(this.isBaseMapDynamic){layer=new esri.layers.ArcGISDynamicMapServiceLayer(this.baseMapUrl);}else{layer=new esri.layers.ArcGISTiledMapServiceLayer(this.baseMapUrl);}this.currentLayer=this.baseLayer=layer;map.addLayer(layer);}this.mapEventListeners.push(dojo.connect(map,"onMouseMove",this,function(evt){var isIE6=mstrmojo.dom.isIE6;var position=mstrmojo.dom.position(this.esriDiv,true);this.esriMap.reposition();this.originalY=position.y;}));this.mapEventListeners.push(dojo.connect(map,"onMouseOver",this,function(event){var msg;if(this.getDrillSelectionMode()===DRILL_DIRECTION.DRILL_DOWN){msg=drillDownMsg;updateTooltip(msg,DRILL_TOOLTIP_SHOW);}else{if(this.getDrillSelectionMode()===DRILL_DIRECTION.DRILL_UP){msg=drillUpMsg;updateTooltip(msg,DRILL_TOOLTIP_SHOW);}else{msg=mstrmojo.desc(8268,"Press down to start and let go to finish");updateTooltip(msg);}}}));this.mapEventListeners.push(dojo.connect(map,"onMouseDown",this,function(event){if(me.isSearchMode()){me.setSearchMode(false);me.getToolbar().removeSearchMode();me.toolbar.searchBar.clearResults();}if(me.enableCircleSelect){me.cX=event.x;me.cY=event.y;me.center=esri.geometry.webMercatorToGeographic(event.mapPoint);}}));this.mapEventListeners.push(dojo.connect(map,"onMouseUp",this,function(event){var target=event.target||event.srcElement,p=this.domNode;if($D.contains(p,target)){me.handleMouseUp(event);}if(me.indicatorTooltip){delete me.center;me.indicatorTooltip.toggle(false);me.toggleCircleSelectionIndicator(false);}}));mstrApp.docModel&&mstrApp.docModel.attachEventListener("secondaryDataSliced",this.id,function(evt){me.onSecondaryDataSliced(evt.key,evt.data);});this.populateStrokes();if(this.useESRICloud){this.initESRIMap();}else{this.mapEventListeners.push(dojo.connect(map,"onLoad",this,this.initESRIMap));}},toggleCircleSelectionIndicator:function(show){var svgNode=document.getElementsByTagName("svg")[0];if(show){if(!this.circleSelcDec){this.circleSelcDec=document.createElementNS("http://www.w3.org/2000/svg","path");this.circleSelcLine=document.createElementNS("http://www.w3.org/2000/svg","line");this.circleSelcDec.style.fill="rgb(90, 163, 192)";this.circleSelcLine.style.stroke="rgb(90, 163, 192)";this.circleSelcLine.style.strokeWidth=2;svgNode.appendChild(this.circleSelcDec);svgNode.appendChild(this.circleSelcLine);}}else{if(this.circleSelcDec){svgNode.removeChild(this.circleSelcDec);svgNode.removeChild(this.circleSelcLine);delete this.circleSelcDec;delete this.circleSelcLine;}}},getAreaDirection:function getAreaDirection(){var viewerList=this.gridDataViewer,areaDirection=0,len,extent,bottomCenter,center;if(!!viewerList){for(var i=0;i<viewerList.length;i++){if(!viewerList[i]){continue;}if(viewerList[i].getMapType()==$EnumMarkerType.Area){var graphic,graphics=viewerList[i].getGraphics();if(!graphics){continue;}len=graphics.length;center=this.esriMap.extent.getCenter();bottomCenter=new esri.geometry.Point(center.x,this.esriMap.extent.ymin,this.esriMap.spatialReference);for(var j=0;j<len;j++){graphic=graphics[j];if(!graphic.geometry){continue;}extent=graphic.geometry.getExtent();areaDirection|=this.pointPosition(extent,bottomCenter);if(areaDirection==EnumAreaDirection.ALL){return areaDirection;}}}}}return areaDirection;},isAreaOverlapsViewPort:function isAreaOverlapsViewPort(){var viewerList=this.gridDataViewer,len,extent,existsPolygonLayer=false;if(!!viewerList){for(var i=0;i<viewerList.length;i++){if(!viewerList[i]){continue;}if(viewerList[i].getMapType()==$EnumMarkerType.Area){existsPolygonLayer=true;extent=this.esriMap.extent;if(extent.contains(viewerList[i].getExtent())||extent.intersects(viewerList[i].getExtent())){return true;}else{existsPolygonLayer=false;}}}}return !existsPolygonLayer;},showDirectionToast:function showDirectionToast(direction,duration,callback,toastConfig){var id="esriAreaDirectionToast",dom,time=duration||3000,toastWidget,$CSS=mstrmojo.css;if(toastConfig&&toastConfig.id){id=toastConfig.id+"-"+id;}try{mstrmojo.all[id].destroy();}catch(e){}toastWidget=mstrmojo.insert({id:id,scriptClass:"mstrmojo.Container",markupString:'<div class="areadirection"><div id="top"></div><div id="left"></div><div id="bottom"></div><div id="right"></div></div>',markupSlots:{topNode:function(){return this.domNode.firstChild;},leftNode:function(){return this.domNode.childNodes[1];},bottomNode:function(){return this.domNode.childNodes[2];},rightNode:function(){return this.domNode.lastChild;}},startAnimation:function startAnimation(direction){if((direction&EnumAreaDirection.ALL)!=0){$CSS.addClass(this.topNode,"topBlinkAnimation");$CSS.addClass(this.leftNode,"leftBlinkAnimation");$CSS.addClass(this.bottomNode,"bottomBlinkAnimation");$CSS.addClass(this.rightNode,"rightBlinkAnimation");return ;}if((direction&EnumAreaDirection.TOP)!=0){$CSS.addClass(this.topNode,"topBlinkAnimation");}if((direction&EnumAreaDirection.LEFT)!=0){$CSS.addClass(this.leftNode,"leftBlinkAnimation");}if((direction&EnumAreaDirection.BOTTOM)!=0){$CSS.addClass(this.bottomNode,"bottomBlinkAnimation");}if((direction&EnumAreaDirection.RIGHT)!=0){$CSS.addClass(this.rightNode,"rightBlinkAnimation");}}});toastWidget.render();toastWidget.startAnimation(direction);dom=toastWidget.domNode;if(toastConfig&&toastConfig.dom){toastConfig.dom.appendChild(dom);}else{document.body.appendChild(dom);$D.bottomCenter(dom);}window.setTimeout(function(){if(callback){callback();}try{}catch(e){}},time);},pointPosition:function pointPosition(extent,point){var topLeft,topRight,bottomLeft,bottomRight;topLeft=new esri.geometry.Point(extent.xmin,extent.ymax,this.esriMap.spatialReference);topRight=new esri.geometry.Point(extent.xmax,extent.ymax,this.esriMap.spatialReference);bottomLeft=new esri.geometry.Point(extent.xmin,extent.ymin,this.esriMap.spatialReference);bottomRight=new esri.geometry.Point(extent.xmax,extent.ymin,this.esriMap.spatialReference);if(extent.contains(point)){return EnumAreaDirection.ALL;}else{if(this.isLeft(bottomLeft,topLeft,point)){return EnumAreaDirection.RIGHT;}else{if(this.isLeft(topLeft,topRight,point)){return EnumAreaDirection.BOTTOM;}else{if(this.isLeft(bottomRight,bottomLeft,point)){return EnumAreaDirection.TOP;}else{if(this.isLeft(topRight,bottomRight,point)){return EnumAreaDirection.LEFT;}else{return EnumAreaDirection.NONE;}}}}}},isLeft:function isLeft(a,b,c){return((b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x))>0;},showMapLayer:function showMapLayer(){var mapLayer=this.currentLayer;if(!!mapLayer&&(!mapLayer.visible||mapLayer.opacity==0)){mapLayer.setVisibility(true);mapLayer.setOpacity(1);}},removeDijit:function removeDijit(){var ids=this.esriDiv.id;dijit.registry.forEach(function(w){if(w.id.indexOf(ids)>=0){w.destroyRecursive();}});},destroy:function destroy(ignoreDom){var dm=this.getDocModel();if(dm&&this.registeredSDPKeys){for(var key in this.registeredSDPKeys){dm.removeSDP(key);}}this.removeEventListeners(this.mapEventListeners);this.mapEventListeners=[];delete this.controller;delete this.edtModel;delete this.builder;delete this.zonesModel;delete this.mixinParentMapObj;this._super(ignoreDom);if(!!this.observableModel){delete this.observableModel.host;this.observableModel.destroy();delete this.observableModel;}if(!!this.esriMap){this.esriMap.destroy();}delete this.mapDeferred;this.destroyed=true;},initMapViewer:function initMapViewer(){var data,cols,col,i,j,ind,indl,metricsString=mstrmojo.desc(1158,"Metrics");this.metricData=[];for(ind=0,indl=this.gridDataViewer.length;ind<indl;ind++){data=this.gridDataViewer[ind].data;if(!!data.eg||!data.gts){continue;}cols=data.gts.col;this.metricData[ind]={metrics:[],gridName:data.n};for(i=0;i<cols.length;i++){col=cols[i];if(col.n==metricsString){var es=col.es;for(j=0;j<es.length;j++){var o={v:j,n:es[j].n,id:es[j].id,gIdx:ind};this.metricData[ind].metrics.push(o);}break;}}}},createEmptyGridInfoWindowTable:function createEmptyGridInfoWindowTable(){var table=document.createElement("table");var isIE=(navigator.appVersion.indexOf("MSIE")!=-1)?true:false;var gridTableFormat="gridInfoWindowTable";table.className=gridTableFormat;table.setAttribute("cellspacing","0");table.setAttribute("cellpadding","2");var tableHead=document.createElement("tHead");var tableBody=document.createElement("tBody");table.appendChild(tableHead);table.appendChild(tableBody);return table;},prepareDivs:function prepareDivs(){this.infoTabDiv=document.createElement("div");this.infoTabDiv.id="infoDiv";this.infoTabDiv.style.paddingTop="3px";this.infoTabDiv.style.overflow="auto";var table=this.createEmptyGridInfoWindowTable();this.infoTabDiv.appendChild(table);var cssStyle=this.createInfoTabDivCSSStyle();if(cssStyle!=null){this.infoTabDiv.appendChild(cssStyle);}},createInfoTabDivCSSStyle:function createInfoTabDivCSSStyle(cssString){var cssStyle=null,m=this.getData(),cssString=m.cssString;if(cssString!==undefined){cssStyle=document.createElement("style");cssStyle.type="text/css";var node=cssStyle.styleSheet||cssStyle;if(mstrmojo.dom.isWK){if(node.firstChild){node.firstChild.nodeValue=cssString;}else{node.appendChild(document.createTextNode(cssString));}}else{node[mstrmojo.dom.isIE?"cssText":"innerHTML"]=cssString;}}return cssStyle;},minMaxMap:null,maxRadius:60,minRadius:3.5,bubbleMode:false,stripNumberFormat:function stripNumberFormat(numString){var newString=numString.replace(this.gridParams.currencySymbol,"");var oldString;do{oldString=newString;newString=newString.replace(this.gridParams.groupingSeparator,"");}while(oldString!=newString);var resultString=newString.replace(this.gridParams.decimalSeparator,".");return resultString;},highlightedGraphics:null,currentSelections:null,selectedRowIndices:null,clearHighlight:function clearHighlight(){for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].clearHighlight();}},addGridLayer:function addGridLayer(layerIndex){this.gridDataViewer[layerIndex].render(false);},removeGridLayer:function removeGridLayer(layerIndex){this.gridDataViewer[layerIndex].unrender(false);if(this.gridDataViewer[layerIndex].currentSelections){this.gridDataViewer[layerIndex].currentSelections={};}if(this.gridDataViewer[layerIndex].selectedRowIndices){this.gridDataViewer[layerIndex].selectedRowIndices={};}if(this.gridDataViewer[layerIndex].highlightedGraphics){this.gridDataViewer[layerIndex].highlightedGraphics={};}},handleExtentDraw:function handleExtentDraw(geometry){if(this.canShowSelectionArea()&&this.drawingLayer){this.drawingLayer.add(new esri.Graphic(geometry,this.rectangleFillSymbol));}var that=this;var callback=function(geometry){for(var i=0,len=that.gridDataViewer.length;i<len;i++){that.gridDataViewer[i].handleExtentDraw(geometry);}that.set("enableRectangleSelect",false);that.set("enableCircleSelect",false);that.set("enableFreeFormSelect",false);that.setToolbarState(0);that.setToolbarButtonState(that.EnumToolbarButtonType.CLEAR_ALL,"enabled",true);};var protocol=this.getProtocol();var geometryService=new esri.tasks.GeometryService(protocol+"//utility.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");esri.geometry.normalizeCentralMeridian([geometry],geometryService,function(results){callback(results[0]);},function(errorMsg){console.log(errorMsg);});},geoPosition:-1,geoElements:{},mapLayers:[],originalX:-1,originalY:-1,populateOriginalPosition:function populateOrignalPosition(){var position=mstrmojo.dom.position(this.esriDiv,true);this.originalX=position.x;this.originalY=position.y;},idMarkerMap:null,wpDisPlayAffinityLines:false,wpLookupAttId:null,initESRIMap:function initESRIMap(){this.enableMarker=false;this.enablePolygon=false;this.fullExtent=this.baseLayer.fullExtent;this.hideWait(true);this.initMultipleDataProviders(this.gridParams);this.mapStyleReady=true;this.updatePropertiesEditor();this.getDataLabelMetricConfig();try{for(var i=0,il=this.gridDataViewer.length;i<il;i++){if(this.gridDataViewer[i].eg){continue;}var viewer=this.gridDataViewer[i];this.showWait();viewer.render(true);}}catch(e){this.hideWait(true);console&&console.log("Error redering viewers "+e);}this.initMapViewer();this.createSlidingToolbar();if(mstrApp&&mstrApp.isVI){this.renderLegend();}if(!this.drawingLayer){this.drawingLayer=new esri.layers.GraphicsLayer({id:"drawingLayer"});this.esriMap.addLayer(this.drawingLayer);}this.esriMap.reorderLayer(this.drawingLayer,0);if(this.showHomeButton){if(this.esriMapHome){this.esriMapHome.destroy();}this.esriMapHome=new esri.dijit.HomeButton({map:this.esriMap},this.id+"-home");var me=this;window.setTimeout(function(){me.esriMapHome.extent=me.esriMap.extent;},100);this.esriMapHome.startup();}},updateScales:function updateScales(minScale,maxScale){this.minScale=(this.minScale<=0)?minScale:Math.max(this.minScale,minScale);this.maxScale=(this.maxScale<=0)?maxScale:Math.min(this.maxScale,maxScale);console&&console.log("ESRIMAP.updateScales: minScale = "+this.minScale+":maxScale = "+this.maxScale);},loadWidgetPropsAndGridData:function loadWidgetPropsAndGridData(){var M=this.getData(),sdpKey,i,grid;this.grids=[];if(!!this.gridParams.boneId&&typeof (microstrategy)!=="undefined"){this.gridBone=microstrategy.bone(this.gridParams.boneId);}this.widgetProps=this.getProperties();this.parseDataLabelProperties();this.grids[0]={grid1:M,grid2:null,widgetProps:this.widgetProps};sdpKey=!!M.vp&&M.vp.ag;if(sdpKey&&M.sdp&&M.sdp[sdpKey]){this.grids[0].grid2=M.sdp[sdpKey];}i=1;if(M&&M.vp&&M.vp.sgProps){for(var key in M.vp.sgProps){if(M.sdp&&M.sdp[key]){this.grids[i]={grid1:M.sdp[key],grid2:null,widgetProps:this.getProperties(key)};sdpKey=this.grids[i].grid1.ag;if(sdpKey&&M.sdp[sdpKey]){this.grids[i].grid2=M.sdp[sdpKey];}i++;}}}},totalLayersRendered:0,updateMapExtent:function updateMapExtent(){if(this.totalLayersRendered!=this.gridDataViewer.length){this.hideWait();return ;}var i,extentValid,extent=null,includesAll=true,map=this.esriMap,minExtent=this.minExtent;if(this.defaultMapExtent==null){for(i=0;i<this.gridDataViewer.length;i++){if(this.defaultMapExtent==null){this.defaultMapExtent=this.gridDataViewer[i].getExtent();}else{this.defaultMapExtent=this.defaultMapExtent.union(this.gridDataViewer[i].getExtent());}}}this.refitContent=this.widgetProps.rosa===$EnumZoomBehavior.Automatic;if(this.refitContent===true){for(i=0;i<this.gridDataViewer.length;i++){if(extent===null){extent=this.gridDataViewer[i].getExtent();}else{extent=extent.union(this.gridDataViewer[i].getExtent());}}if(extent===null){extent=this.defaultMapExtent;}}else{extent=this.previousExtent;extentValid=isExtentValid(extent);includesAll=!extentValid;extent=extentValid?extent:this.defaultMapExtent;}if(isExtentValid(extent)){if(minExtent&&(minExtent.getWidth()<extent.getWidth()||minExtent.getHeight()<extent.getHeight())){extent=minExtent.centerAt(extent.getCenter());includesAll=false;}if(!this.refitContent||!this.extentResized){map.setExtent(extent,includesAll);}else{this.deferredExtentConfig={extent:extent,includesAll:includesAll};}delete this.extentResized;}else{this.showMapLayer();}this.hideWait();},getGridDataViewers:function getGridDataViewer(){return this.gridDataViewer;},getPrimaryGridViewer:function getPrimaryGridViewer(){return this.gridDataViewer[this._primaryGridIndex];},getGridViewer:function getGridViewer(viewerIndex){if(viewerIndex<0||viewerIndex>=this.gridDataViewer.length){return null;}return this.gridDataViewer[viewerIndex];},markerColumnIndices:{Lat:-1,Long:-1},latIndex:-1,longIndex:-1,findWrapperDom:function findWrapperDom(){return this.domNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode;},isDrillable:function isDrillable(){for(var i=0;i<this.gridDataViewer.length;i++){if(this.gridDataViewer[i].getDrillStatus()){return true;}}return false;},getProtocol:function getProtocol(){return(mstrApp.isSingleTier)?"http:":window.location.protocol;},getAssociatedNodes:function getAssociatedNodes(){var gt=this.defn.an;return gt&&gt.length>0?gt:[];},getSelections:function getSelections(){for(var i=0;i<this.gridDataViewer.length;i++){var grid=this.gridDataViewer[i];if(this.k==grid.k){return grid.getSelections();}}return null;},getQuickSymbol:function getQuickSymbol(text){var result;switch(text){case"&#9679;":case'<font face="Wingdings">\u006c</font>':result="\u25CF";break;case"&#9632;":case'<font face="Wingdings">\u006e</font>':result="\u25a0";break;case"&#9830;":case'<font face="Wingdings">\u0074</font>':result="\u2666";break;case"&#9670;":case'<font face="Wingdings">\u0075</font>':result="\u25C6";break;case"&#10070;":case'<font face="Wingdings">\u0053</font>':result="\u2756";break;case"&#9784;":case'<font face="Wingdings">\u005D</font>':result="\u2638";break;case"&#10047;":case'<font face="Wingdings">\u007C</font>':result="\u273F";break;case"&#8984;":case'<font face="Wingdings">\u007a</font>':result="\u2318";break;case"&#10003;":case'<font face="Wingdings">\u0009</font>':result="\u2713";break;case"&#10007;":case'<font face="Wingdings">\u000a</font>':result="\u2717";break;case"&#8680;":case'<font face="Wingdings">\u00e8</font>':result="\u21E8";break;case"&#8679;":case'<font face="Wingdings">\u00e9</font>':result="\u21E7";break;case"&#8681;":case'<font face="Wingdings">\u00ea</font>':result="\u21E9";break;default:result=text;}return decodeURI(result);},getMousePositionFromEvent:function getMousePositionFromEvent(event){var propName,prop,position=null;if((event.clientX!==undefined)&&(event.clientY!==undefined)){position={x:event.clientX,y:event.clientY};}else{for(propName in event){prop=event[propName];if(!!prop&&(prop.clientX!==undefined)&&(prop.clientY!==undefined)){position={x:prop.clientX,y:prop.clientY};break;}}}return position;},_markerElementIDs:null,checkLookUpAttributeInSecondaryDP:function checkLookUpAttributeInSecondaryDP(){var data=this.secData.gvs.items;var rowAttributes=this.secData.gts.row;var numTemplateUnits=rowAttributes.length;for(i=0;i<numTemplateUnits;i++){if(rowAttributes[i].id==this.wpLookupAttId){return true;}}return false;},_affinityLines:null,affinityLineLayer:null,DEFAULT_LINE_COLOR:16711680,drawAffinityLinesUsingSecondaryDataProvider:function drawAffinityLinesUsingSecondaryDataProvider(){if(!this.secData){mstrmojo.alert("Secondary data provider could not be found. In order to see the Affinity Lines, please reset the secondary data provider in the design mode.",null,"Affinity Lines Error");return ;}if(this.findSecondaryDPAttrColIndexes()==-1){return ;}if(this.secData.gts.col.length==0){mstrmojo.alert("No Metric is present on the secondary data provider.",null,"Affinity Lines Error");return ;}this.affinityLineLayer=new esri.layers.GraphicsLayer();var secondMetricIndex;secondMetricIndex=this.findSecondaryDPSecondMetricIndex();this.computeSecondaryDPMetricMax(0);var data=this.secData.gvs.items;var rowAttributes=this.secData.gts.row;var rowHeaders=this.secData.ghs.rhs.items;var sourceAttrElementID,destAttrElementID;var lineColor,lineThickness;var maxLineThickness=this.wpMaxLineThickness;this._affinityLines=new Object();for(rowIndex=0;rowIndex<data.length;rowIndex++){var rowHeaderElements=rowHeaders[rowIndex].items;var firstAttrElementIndex=rowHeaderElements[this.secondaryDPFirstAttrColIndex];var secondAttrElementIndex=rowHeaderElements[this.secondaryDPSecondAttrColIndex];sourceAttrElementID=this.getElementIdWithoutAttributeID(rowAttributes[this.secondaryDPFirstAttrColIndex].es[firstAttrElementIndex.idx].id);destAttrElementID=this.getElementIdWithoutAttributeID(rowAttributes[this.secondaryDPSecondAttrColIndex].es[secondAttrElementIndex.idx].id);if(this._markerElementIDs[sourceAttrElementID]==null||this._markerElementIDs[destAttrElementID]==null){continue;}if(secondMetricIndex!=-1){lineColor=this.getThresoldString(rowIndex,"#FF0000",this.secData,secondMetricIndex);}else{lineColor="#FF0000";}var cell=data[rowIndex].items[0];if(cell.v){metricCellValue=parseFloat(this.stripNumberFormat(cell.v));lineThickness=(metricCellValue*maxLineThickness)/this.secondaryDPMetricMaxVal[0]["max"];}else{lineThickness=1;}var polyline=new esri.geometry.Polyline(this.esriMap.spatialReference);polyline.addPath([this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]]);var lineSymbol=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color(lineColor),lineThickness);polyline.setSymbol(lineSymbol);this.affinityLineLayer.add(polyline);this._affinityLines[sourceAttrElementID+destAttrElementID]=polyline;}this.esriMap.addLayer(this.affinityLineLayer);},_animationSourceMarkerLines:null,_animationMarkers:null,_affinityAnimationFinished:false,_currentAffinityInterval:0,NO_OF_POINTS:20,_affinityGlow:false,_selectedAffinityMarkers:null,startAffinityLinesAnimation:function startAffinityLinesAnimation(sourceMarkerIds){if(!this.secData){mstrmojo.alert("Secondary data provider could not be found. In order to see the Affinity Lines, please reset the secondary data provider in the design mode.",null,"Affinity Lines Error");return ;}if(this.findSecondaryDPAttrColIndexes()==-1){return ;}if(this.secData.gts.col.length==0){mstrmojo.alert("No Metric is present on the secondary data provider.",null,"Affinity Lines Error");return ;}var secondMetricIndex;secondMetricIndex=this.findSecondaryDPSecondMetricIndex();this.computeSecondaryDPMetricMax(0);var data=this.secData.gvs.items;var rowAttributes=this.secData.gts.row;var rowHeaders=this.secData.ghs.rhs.items;var sourceAttrElementID,destAttrElementID;var polyline,option;if(!this._animationSourceMarkerLines){this._animationSourceMarkerLines=[];}var i;for(i=this._animationSourceMarkerLines.length;i>0;i--){this._animationSourceMarkerLines.pop();}for(rowIndex=0;rowIndex<data.length;rowIndex++){var rowHeaderElements=rowHeaders[rowIndex].items;var firstAttrElementIndex=rowHeaderElements[this.secondaryDPFirstAttrColIndex];var secondAttrElementIndex=rowHeaderElements[this.secondaryDPSecondAttrColIndex];sourceAttrElementID=this.getElementIdWithoutAttributeID(rowAttributes[this.secondaryDPFirstAttrColIndex].es[firstAttrElementIndex.idx].id);destAttrElementID=this.getElementIdWithoutAttributeID(rowAttributes[this.secondaryDPSecondAttrColIndex].es[secondAttrElementIndex.idx].id);if(sourceMarkerIds[sourceAttrElementID]==null||this._markerElementIDs[destAttrElementID]==null){if(this._affinityLines[sourceAttrElementID+destAttrElementID]!=null){polyline=this._affinityLines[sourceAttrElementID+destAttrElementID];polyline.setMap(null);}continue;}polyline=this._affinityLines[sourceAttrElementID+destAttrElementID];polyline.strokeOpacity=1;polyline.setMap(this.map);if(this.wpDrawArcsLines=="Arcs"){this._animationSourceMarkerLines[this._animationSourceMarkerLines.length]=this.findPointsOnArc(this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]);}else{this._animationSourceMarkerLines[this._animationSourceMarkerLines.length]=this.findPointsOnLine(this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]);}}if(!this._animationMarkers){this._animationMarkers=[];}for(i=this._animationMarkers.length;i>0;i--){this._animationMarkers.pop();}this._affinityAnimationFinished=true;if(this._animationSourceMarkerLines.length==0){return ;}for(i=0;i<this._animationSourceMarkerLines.length;i++){var arr=this._animationSourceMarkerLines[i];var marker=this.createAffinityAnimationMarker(arr[0]);this._animationMarkers[i]=marker;}this._currentAffinityInterval=0;this.doAffinityAnimation();},clearAffinityAnimationObjects:function clearAffinityAnimationObjects(){if(this._animationMarkers){for(i=0;i<this._animationMarkers.length;i++){this._animationMarkers[i].setMap(null);}for(i=this._animationMarkers.length;i>0;i--){this._animationMarkers.pop();}}this._selectedAffinityMarkers=null;this._affinityAnimationFinished=false;},handleAffinityAnimationMouseClick:function handleAffinityAnimationMouseClick(marker,event){if(!marker){return ;}if(this._affinityAnimationFinished){this.clearAffinityAnimationObjects();}var ctrlKey=event.ctrlKey;if(!this._selectedAffinityMarkers){this._selectedAffinityMarkers=new Object();}if(!ctrlKey){this._selectedAffinityMarkers[marker.attributes.id]=marker;marker.isSelected=true;this.handleAffinityAnimationKeyUp();}else{if(this._selectedAffinityMarkers.hasOwnProperty(marker.attributes.id)){marker.isSelected=false;id=marker.attributes.id;delete this._selectedAffinityMarkers[marker.attributes.id];}else{this._selectedAffinityMarkers[marker.attributes.id]=marker;marker.isSelected=true;}}},handleAffinityAnimationKeyUp:function handleAffinityAnimationKeyUp(){if(!this._affinityAnimationFinished&&this._affinityGlow){var sourceId={};var id;for(id in this._selectedAffinityMarkers){sourceId[this.getElementIdWithoutAttributeID(id)]=id;}this.startAffinityLinesAnimation(sourceId);}},moveAffinityAnimationMarker:function moveAffinityAnimationMarker(){var i;for(i=0;i<this._animationSourceMarkerLines.length;i++){var arr=this._animationSourceMarkerLines[i];var marker=this._animationMarkers[i];if(this._currentAffinityInterval<this.NO_OF_POINTS){marker.setPosition(arr[this._currentAffinityInterval]);}if(this._currentAffinityInterval==0){marker.setMap(this.map);}}if(this._currentAffinityInterval==this.NO_OF_POINTS-1){for(i=0;i<this._animationMarkers.length;i++){this._animationMarkers[i].setMap(null);}clearTimeout(this._glowTimer);}else{this._currentAffinityInterval++;this.doAffinityAnimation();}},doAffinityAnimation:function doAffinityAnimation(){var that=this;this._glowTimer=setTimeout(function(){that.moveAffinityAnimationMarker();},50);},createAffinityAnimationMarker:function createAffinityAnimationMarker(latLng){var marker;var markerImage=new google.maps.MarkerImage("images/glow_marker.png",null,null,null,new google.maps.Size(10,8));marker=new google.maps.Marker({position:latLng,icon:markerImage,map:this.map});return marker;},findPointsOnArc:function findPointsOnArc(from,to){var nPoints=this.NO_OF_POINTS;var coords=[];var radToDeg=180/Math.PI;var lat1=from.lat()/radToDeg;var lng1=from.lng()/radToDeg;var lat2=to.lat()/radToDeg;var lng2=to.lng()/radToDeg;var degree=2*Math.asin(Math.sqrt(Math.pow((Math.sin(lat1-lat2)/2),2)+Math.cos(lat1)*Math.cos(lat2)*Math.pow((Math.sin(lng1-lng2)/2),2)));var i;for(i=0;i<=this.NO_OF_POINTS;i++){var f=Number(i/nPoints);var a=Math.sin((1-f)*degree)/Math.sin(degree);var b=Math.sin(f*degree)/Math.sin(degree);var x=a*Math.cos(lat1)*Math.cos(lng1)+b*Math.cos(lat2)*Math.cos(lng2);var y=a*Math.cos(lat1)*Math.sin(lng1)+b*Math.cos(lat2)*Math.sin(lng2);var z=a*Math.sin(lat1)+b*Math.sin(lat2);var rLat=Math.atan2(z,Math.sqrt(Math.pow(x,2)+Math.pow(y,2)));var rLng=Math.atan2(y,x);coords[i]=new google.maps.LatLng(rLat*radToDeg,rLng*radToDeg);}return coords;},findPointsOnLine:function findPointsOnLine(from,to){var m=Infinity;var c;var pts=[];var interval;var lat;var lng;var i;if(to.lng()-from.lng()!=0){m=(to.lat()-from.lat())/(to.lng()-from.lng());c=from.lat()-m*from.lng();interval=(to.lng()-from.lng())/this.NO_OF_POINTS;}else{interval=(to.lat()-from.lat())/this.NO_OF_POINTS;}for(i=0;i<=this.NO_OF_POINTS;i++){if(m==Infinity){lng=from.lng();lat=from.lat()+interval*i;}else{lng=from.lng()+interval*i;lat=m*lng+c;}pts[i]=new google.maps.LatLng(lat,lng);}return pts;},getElementIdWithoutAttributeID:function getElementIdWithoutAttributeID(elementID){var newElementID="";var pos=0;var i;for(i=0;i<elementID.length;i++){if(elementID.charAt(i)==":"){pos++;}if(pos==1){continue;}newElementID=newElementID+elementID.charAt(i);}return newElementID;},secondaryDPFirstAttrColIndex:-1,secondaryDPSecondAttrColIndex:-1,findSecondaryDPAttrColIndexes:function findSecondaryDPAttrColIndexes(){var data=this.secData.gvs.items;var rowAttributes=this.secData.gts.row;var attrId=rowAttributes[0].id;this.secondaryDPFirstAttrColIndex=0;var i;for(i=1;i<rowAttributes.length;i++){if(rowAttributes[i].id!=attrId){this.secondaryDPSecondAttrColIndex=i;break;}}return this.secondaryDPSecondAttrColIndex;},findSecondaryDPSecondMetricIndex:function findSecondaryDPSecondMetricIndex(){var colAttributes=this.secData.gts.col[0].es;if(colAttributes.length>1){return 1;}else{return -1;}},secondaryDPMetricMaxVal:null,computeSecondaryDPMetricMax:function computeSecondaryDPMetricMax(metricColumnIndex){if(!this.secondaryDPMetricMaxVal){this.secondaryDPMetricMaxVal={};}if(this.secondaryDPMetricMaxVal.hasOwnProperty(metricColumnIndex)){return ;}var rowHeaders=this.secData.ghs.rhs.items;var data=this.secData.gvs.items;var rowIndex=0;var maxValue=-Infinity;for(rowIndex=0;rowIndex<data.length;rowIndex++){var values=data[rowIndex].items;var cell=values[metricColumnIndex];if(cell.v){var cellNumber=parseFloat(this.stripNumberFormat(cell.v));maxValue=(cellNumber>maxValue)?cellNumber:maxValue;}}this.secondaryDPMetricMaxVal[metricColumnIndex]={max:maxValue};},getExecutionScope:function(){return microstrategy.EXECUTION_SCOPE;},getMsgId:function(){return this.gridParams.msgID;},addGridParameterDownloadListener:function addGridParameterDownloadListener(listener,callback){this.gridParamDownloadListener=this.gridParamDownloadListener||[];this.gridParamDownloadListener.push({listener:listener,callback:callback});},unrender:function unrender(){if(this.hasRendered){if(this.isOIVM()||(mstrApp&&mstrApp.isVI)){this.clearCache();}document.onkeydown=document.onkeyup=document.onkeypress=null;this.destroyGridViewer();delete this.gridDataViewer;}this._super();},unrenderGridViewer:function unrenderGridViewer(){if(!this.gridDataViewer){return ;}for(var i=0,il=this.gridDataViewer.length;i<il;i++){this.gridDataViewer[i].unrender(true);}},destroyGridViewer:function destroyGridViewer(){if(!this.gridDataViewer){return ;}for(var i=0,il=this.gridDataViewer.length;i<il;i++){this.gridDataViewer[i].destroy(true);}delete this.gridDataViewer;},canShowSelectionArea:function canShowSelectionArea(){var hasDensityLayer=false,gridDataViewers=this.gridDataViewer,viewerCount=gridDataViewers?gridDataViewers.length:0;for(var i=0;i<viewerCount;i++){if(gridDataViewers[i].enableDensity&&gridDataViewers[i].visible){hasDensityLayer=true;}}return hasDensityLayer;},backupToolBarSelections:function backupToolBarSelections(){if(!this.selectionBackUp){this.selectionBackUp={};this.selectionBackUp.toolbarState=this.toolbar.state;this.selectionBackUp.isMarkerSelected=this.markerSelected;}},restoreToolbarSelectionEffects:function restoreToolbarSelectionEffects(){this.set("markerSelected",this.selectionBackUp.isMarkerSelected);this.toolbar.set("state",this.selectionBackUp.toolbarState);},backupSelectionAreas:function backupSelectionAreas(){if(this.drawingLayer&&this.selectionBackUp){this.selectionBackUp.selectionAreas=(this.selectionBackUp.selectionAreas||[]).concat(this.drawingLayer.graphics);}},restoreSelectionAreas:function restoreSelectionAreas(){var graphic,graphicCount;if(this.drawingLayer){if(this.selectionBackUp&&this.selectionBackUp.selectionAreas){graphicCount=this.selectionBackUp.selectionAreas.length;for(var i=0;i<graphicCount;i++){graphic=this.selectionBackUp.selectionAreas[i];this.drawingLayer.add(graphic);}this.selectionBackUp.selectionAreas.length=0;}}},displayError:function displayError(message){this.toolBarDiv.innerHTML='<div class="map-err-message" style = "font-size:15px;height:100px;width:100%;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;text-align:center;z-index:100">'+message+"</div>";},drawMarkerLayers:function(){var viewer,i,len;if(!this.gridDataViewer){return ;}len=this.gridDataViewer.length;for(i=0;i<len;i++){this.gridDataViewer[i].unrender(true);}for(i=0;i<len;i++){viewer=this.gridDataViewer[i];viewer.loadWidgetProps();viewer.render(true);}},getRootDivForPDF:function(){return this.esriDiv;},getExtraNodeForPDF:function(){var ret=[];if(!$D.isChrome||(parseInt(this.widgetProps.mc)===2||parseInt(this.widgetProps.mc)===4)){var svgNodes=this.getRootDivForPDF().getElementsByTagName("svg");for(var i=0;i<svgNodes.length;i++){ret.push(svgNodes[i]);}}return ret;},preExportHook:function(callbackFn){var me=this;if($D.isIE9||$D.isIE10||$D.isIEW3C){me.substituteStyles(me.getRootDivForPDF());function fnReplaceLogo(callback){try{var logoNode=document.getElementsByClassName("logo-med")[0]||document.getElementsByClassName("logo-sm")[0];var bgURL=mstrmojo.css.getStyleValue(logoNode,"backgroundImage");if($D.isIE9||$D.isIE10||$D.isIEW3C){bgURL=bgURL.substring(5,bgURL.length-2);}else{bgURL=bgURL.substring(4,bgURL.length-1);}me.replaceImage(logoNode,bgURL,new Image(),function(){callback();});}catch(e){callback();}}me.replaceMapTiles(function(){fnReplaceLogo(callbackFn);});}else{$C.toggleClass(this.esriDiv,"clientExportAdjust",true);var svgNodes=this.getRootDivForPDF().getElementsByTagName("svg");for(var i=0;i<svgNodes.length;i++){var node=svgNodes[i];node.setAttribute("xmlns","http://www.w3.org/2000/svg");node.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");if($D.isChrome){node.style.transform="translate(1px, 1px)";}}this._super(callbackFn);}},postExportHook:function(){if($D.isIE9||$D.isIE10||$D.isIEW3C){this.reviveImages();this.reviveStyles(this.getRootDivForPDF());}else{$C.toggleClass(this.esriDiv,"clientExportAdjust",false);var me=this;var svgNodes=this.getRootDivForPDF().getElementsByTagName("svg");for(var i=0;i<svgNodes.length;i++){var node=svgNodes[i];node.removeAttribute("xmlns");node.removeAttribute("xmlns:xlink");if($D.isChrome){node.parentNode.style.transform=0;}}}},hideMapTools:function(){this._isPanArrows=this.esriMap.isPanArrows;this._isZoomSlider=this.esriMap.isZoomSlider;if(this._isPanArrows){this.esriMap.hidePanArrows();}if(this._isZoomSlider){this.esriMap.hideZoomSlider();}},showMapTools:function(){if(this._isPanArrows){this.esriMap.showPanArrows();}if(this._isZoomSlider){this.esriMap.showZoomSlider();}}});})();