(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.android.ui._CanBeFullScreen","mstrmojo.array","mstrmojo.css","mstrmojo.android.ui.ActionToolbarButtons","mstrmojo.android.ui.Menu","mstrmojo.android.EnumMenuOptions","mstrmojo._TouchGestures");var $ARR=mstrmojo.array,$CSS=mstrmojo.css,TYPE_MENU=1,TYPE_BUTTON=2,MENUS=mstrmojo.android.EnumMenuOptions,MNU_SHARE=MENUS.SHARE,MNU_ANNOTATION=MENUS.ANNOTATION;function useNativeMenu(){return mstrApp.isActionBarNative();}function buttonClicked(evt){if(!this.active){return ;}var added=evt.added,src=evt.src,item=added&&src.items[added[0]],menu=this.menu;if(!item){return ;}if(item.isMenu){if(mstrMobileApp&&mstrMobileApp.genMapPreview){mstrMobileApp.genMapPreview();}menu.set("visible",!menu.visible);}else{if(item.grp!==MNU_SHARE&&item.grp!==MNU_ANNOTATION){mstrApp.closeAllDialogs();}if(src===menu){menu.set("visible",false);if(mstrMobileApp&&mstrMobileApp.showMapView){mstrMobileApp.showMapView(0);}}mstrmojo.all[this._actController].handleMenuItem(item.grp,item.act);}}function getMenuItems(){var menuItems=[],icons=this.icons,groups=this.groups,actions=this.actions;$ARR.forEach(this.labels,function(label,idx){menuItems.push({cls:"ic"+icons[idx],grp:parseInt(groups[idx],10),act:parseInt(actions[idx],10),n:label});});return menuItems;}function extractButtons(maxCnt){var buttons=[],icons=this.icons,groups=this.groups,actions=this.actions,labels=this.labels;$ARR.forEach(this.types,function(type,idx){if(type===TYPE_BUTTON){buttons.push({cls:"ic"+icons[idx],act:parseInt(actions[idx],10),grp:parseInt(groups[idx],10),idx:idx,n:labels[idx]});if(buttons.length===maxCnt){return false;}}});var i;for(i=buttons.length-1;i>=0;i--){var button=buttons[i],menuIdx=button.idx;delete button.idx;this.types.splice(menuIdx,1);this.groups.splice(menuIdx,1);this.labels.splice(menuIdx,1);this.actions.splice(menuIdx,1);this.checked.splice(menuIdx,1);this.icons.splice(menuIdx,1);}return buttons;}var $TOOLBAR=mstrmojo.android.ui.ActionToolbar=mstrmojo.declare(mstrmojo.Box,[mstrmojo.android.ui._CanBeFullScreen],{scriptClass:"mstrmojo.android.ui.ActionToolbar",active:true,init:function init(props){this._super(props);$CSS.addWidgetCssClass(this,"mstrmojo-ActionToolbar");},children:[{scriptClass:"mstrmojo.android.ui.ActionToolbarButtons",alias:"buttons"},{scriptClass:"mstrmojo.android.ui.Menu",alias:"menu",visible:false}],addChildren:function addChildren(children,idx,silent){this._super(children,idx,silent);$ARR.forEach(this.children,function(child){child.attachEventListener("selectionChange",this.id,buttonClicked);},this);},setActions:function setActions(id,tbCfg){var buttonItems;var btnCount=tbCfg.getBtnCount(tbCfg.minBtnCount,tbCfg.maxBtnCount);if(btnCount){buttonItems=extractButtons.call(tbCfg,btnCount);}if(tbCfg.size()){if(useNativeMenu()){mstrMobileApp.setSysMenu(id,tbCfg.groups,tbCfg.labels,tbCfg.actions,tbCfg.checked,tbCfg.icons);}else{buttonItems.push({cls:"menu",isMenu:true,n:"Menu"});this.menu.set("items",getMenuItems.call(tbCfg));}}this.buttons.set("items",buttonItems);this._actController=id;this.raiseEvent("renderComplete");this.resetFullScreen();},onactiveChange:function onactiveChange(){$CSS.toggleClass(this.domNode,"inactive",!this.active);},reset:function reset(){this.menu.set("visible",false);},onEnterFullScreen:function onEnterFullScreen(){this.reset();},propogateMenuVisibleChange:function propogateMenuVisibleChange(isVisible){mstrmojo.touchManager.raiseEvent({name:"actionBarMenuStateChange",value:isVisible});}});function addItem(type,groupId,label,action,checked,icon){this.types.push(type);this.groups.push(String(groupId));this.labels.push(String(label));this.actions.push(String(action));this.checked.push(String(!!checked));this.icons.push(icon||-1);}$TOOLBAR.newToolbarConfig=function newToolbarConfig(){var cfg={addMenuItem:function addMenuItem(groupId,label,action,checked,icon){addItem.call(this,TYPE_MENU,groupId,label,action,checked,icon);this.mnuCount++;},addToolbarBtn:function addToolbarBtn(groupId,label,action,checked,icon){addItem.call(this,TYPE_BUTTON,groupId,label,action,checked,icon);this.btnCount++;},getBtnCount:function getBtnCount(minCnt,maxCnt){var btnCnt=this.btnCount;if(this.mnuCount){btnCnt++;}var actualCnt=Math.min(btnCnt,maxCnt);if(actualCnt<minCnt){return 0;}if(actualCnt===maxCnt){if(!useNativeMenu()&&(this.mnuCount||(btnCnt>actualCnt))){actualCnt--;}}return actualCnt;},clear:function clear(){this.btnCount=0;this.mnuCount=0;this.maxBtnCount=5;this.minBtnCount=1;this.types=[];this.groups=[];this.labels=[];this.actions=[];this.checked=[];this.icons=[];},size:function size(){return this.labels.length;}};cfg.clear();return cfg;};}());