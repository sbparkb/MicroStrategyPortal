(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo._TouchGestures","mstrmojo._HasTouchScroller","mstrmojo.array","mstrmojo.dom","mstrmojo.css");var $A=mstrmojo.array,$CSS=mstrmojo.css,$D=mstrmojo.dom,FirstMonthIdx=1,SELECTED_CSS_CLASS="selected",HTML_ATTR_DAY="d",HTML_ATTR_MONTH="m",HTML_ATTR_YEAR="y";function processSelectedDate(node,d,m,y){var i,sel=this.selected=this.selected||[],date;for(i=0;i<sel.length;i++){date=sel[i];if(date.day===d&&date.month===m&&date.year===y){sel.splice(i,1);return false;}}var newItem={node:node,day:d,month:m,year:y};newItem.n=mstrmojo.date.formatDateInfo(newItem,mstrmojo.locales.datetime.DATEOUTPUTFORMAT);sel.push(newItem);return true;}function updateMonthViewHTML(y){this.contentNode.innerHTML=this.markupBuilder.getContentHTML({m:0,y:y},{m:11,y:y},{incl:false});}function updateItemsSelection(optionalItems,add){var monthsHTML=this.contentNode.children,datesHTML;$A.forEach(optionalItems||this.selected,function(item){if(item&&item.year===this.current.y){var selectedDateObj=new Date(item.year,item.month-FirstMonthIdx,1);$A.forEach(monthsHTML,function(monthNode){if(parseInt(monthNode.getAttribute(HTML_ATTR_MONTH),10)===item.month){$CSS.toggleClass(monthNode.getElementsByClassName("mstrmojo-CalendarMV-DatesList")[0].children[item.day+(selectedDateObj.getDay())-1],SELECTED_CSS_CLASS,add);return false;}});}datesHTML=undefined;},this);}function scrollToMonth(m,oldM){var monthCache=this.MONTH_CACHE,current=monthCache[parseInt(m,10)],prev=monthCache[parseInt(oldM,10)],SELECTED_MONTH_CSS_CLASS="selectedMonth";if(oldM!==undefined){$CSS.toggleClass(prev.node,SELECTED_MONTH_CSS_CLASS,false);}$CSS.toggleClass(current.node,SELECTED_MONTH_CSS_CLASS,true);if(this._scroller){this._scroller.scrollTo(0,current.top,200);}if(!(mstrApp.isTablet()&&mstrApp.isLandscape())){this.headerNode.innerHTML=this.markupBuilder.getHeaderHTML(m,this.current.y);}}function updateCurrentYear(year,month){updateMonthViewHTML.call(this,this.current.y);this.updateScroller();var i=0,h=parseInt(this.height,10)-this.headerNode.clientHeight,contentNode=this.contentNode,rootOffsetTop=contentNode.offsetTop,children=contentNode.children,selected=this.selected,yearSelected=$A.find(selected,"year",year),hasSelected=yearSelected!==-1,monthCache=this.MONTH_CACHE=[{}];for(i=0;i<children.length-1;i++){var node=children[i],nodeHeight=node.clientHeight;monthCache.push({node:node,top:node.offsetTop-rootOffsetTop-(h-nodeHeight)/2,height:nodeHeight});}this._scroller.scrollTo(0,0);scrollToMonth.call(this,month||(hasSelected&&selected[yearSelected].month)||FirstMonthIdx);this.selectItems();}mstrmojo.android.ui.CalendarMonthView=mstrmojo.declare(mstrmojo.Widget,[mstrmojo._TouchGestures,mstrmojo._HasTouchScroller],{scriptClass:"mstrmojo.android.ui.CalendarMonthView",config:undefined,markupString:'<div id="{@id}" class="mstrmojo-Calendar-MonthView"><div class="mstrmojo-CalendarMV-Header"></div><div class="mstrmojo-CalendarMV-Content"><div></div></div></div>',markupSlots:{headerNode:function(){return this.domNode.firstChild;},contentNode:function(){return this.domNode.lastChild.lastChild;}},range:undefined,selected:undefined,multiSelect:true,current:undefined,scrollerConfig:{bounces:false,showScrollbars:false,showIndicators:false},postCreate:function postCreate(){if(this._super){this._super();}var calMonthWidget=this,initialYear=this.initialYear,initialMonth=this.initialMonth;if(isNaN(initialMonth)||isNaN(initialYear)){throw new Error(mstrmojo.desc(96,"Error"));}this.current=new mstrmojo.Obj({m:initialMonth,y:initialYear,onyChange:function onyChanged(){updateCurrentYear.call(calMonthWidget,this.y);},_set_m:function _set_m(n,v){var valueWas=this.m;this.m=v;scrollToMonth.call(calMonthWidget,this.m,valueWas);}});},postBuildRendering:function postBuildRendering(){var builder=this.markupBuilder,current=this.current;this._super();this.headerNode.innerHTML=builder.getHeaderHTML(current.m,current.y);updateCurrentYear.call(this,current.y,current.m);this._scroller.attachEventListener("scrollDone",this.id,function(evt){var monthCache=this.MONTH_CACHE,abs=Math.abs,scrolledPos=evt.y,curr,next,newIdx,i;for(i=1;i<monthCache.length-1;i++){curr=monthCache[i].top;next=monthCache[i+1].top;if((curr<=scrolledPos)&&(scrolledPos<=next)){newIdx=i+((abs(next-scrolledPos)<abs(curr-scrolledPos))?1:0);break;}}this.current.set("m",newIdx);});},touchTap:function touchTap(touch){var monthObj=$D.findAncestorByAttr(touch.target,HTML_ATTR_MONTH,true,this.domNode);if(monthObj){var item=touch.target,d=parseInt(item.getAttribute(HTML_ATTR_DAY),10),m=parseInt(monthObj.value,10),y=parseInt(monthObj.node.getAttribute(HTML_ATTR_YEAR),10);if(!isNaN(d)){if(this.singleSelect){$A.forEach(this.selected,function(date){$CSS.toggleClass(date.node,SELECTED_CSS_CLASS,false);});this.selected=[];}$CSS.toggleClass(item,SELECTED_CSS_CLASS,processSelectedDate.call(this,item,d,m,y));this.raiseEvent({name:"selectionChanged",items:this.selected});}if(!isNaN(m)){this.current.set("m",m);}}return false;},selectItems:function selectItems(newItems){updateItemsSelection.call(this,newItems,true);},unselectItems:function unselectItems(removedItems){updateItemsSelection.call(this,removedItems,false);},touchSelectBegin:function touchSelectBegin(touch){},touchSelectMove:function touchSelectMove(touch){},touchSelectEnd:function touchTap(touch){},updateScrollerConfig:function updateScrollerConfig(){var cfg=this._super(),icn=this.contentNode,h=parseInt(this.height,10);if(isNaN(h)){h=this.domNode.clientHeight;}cfg.scrollEl=icn;cfg.noHScroll=true;cfg.origin=cfg.origin||{x:0,y:0};var offsetIdx=cfg.offsetIdx;if(offsetIdx){delete cfg.offsetIdx;cfg.origin.y=this.getItemOffset(offsetIdx);}var offsetEnd=Math.max(icn.clientHeight+this.headerNode.clientHeight-h,0);var enableScroll=cfg.vScroll=offsetEnd!==0;if(enableScroll){cfg.offset={y:{start:0,end:offsetEnd}};}else{cfg.offset=null;}return cfg;},destroy:function destroy(){if(this.current){this.current.destroy();delete this.current;}delete this.MONTH_CACHE;this._super();}});}());