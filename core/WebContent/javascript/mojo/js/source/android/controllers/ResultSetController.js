(function(){mstrmojo.requiresCls("mstrmojo.android.controllers.ViewController","mstrmojo.android.ui.ActionToolbar","mstrmojo.android.EnumMenuOptions","mstrmojo.android.ui.PropertiesView","mstrmojo.hash","mstrmojo.array","mstrmojo.string");mstrmojo.requiresDescs(1142,8623,8429,8430,8624,8625,9099,11191);var $HASH=mstrmojo.hash,$AFE=mstrmojo.array.forEach,$DOM=mstrmojo.dom,TYPE_REPORT=768,MENUS=mstrmojo.android.EnumMenuOptions,MNU_FULLSCREEN=MENUS.FULL_SCREEN,MNU_SHARE=MENUS.SHARE,MNU_ANNOTATION=MENUS.ANNOTATION,OBJECT_TYPE_REPORT=3,BOTTOM_ACTION_TOOLBAR_HEIGHT_160_DPI=50;function restoreProjectId(){var oldPrjId=this._oldPID;if(oldPrjId){mstrApp.setCurrentProjectId(oldPrjId);}}function reExecuteRS(params,callback,resParams,isRefresh){var model=this.model,prompts=model.prompts;if(prompts){params.promptsAnswerXML=prompts.getAnswerXML();}params.useRefreshProgress=isRefresh;mstrApp.closeAllDialogs();model.execute(params,callback,resParams);}function refreshRS(callback,isAutoRefresh){var model=this.model,prompts=model.prompts,params={fresh:false,useRefreshProgress:mstrApp.isTablet(),isAutoRefresh:isAutoRefresh||false};if(prompts){params.promptsAnswerXML=prompts.getAnswerXML();}mstrApp.closeAllDialogs();this.refresh(params,callback);}function updateLastOpenedList(){var startParams=this._startParams,action=startParams.action,newItem;if(!action||(action!=="drillGrid"&&action!=="drill2Grid")){newItem=startParams;}this.rootCtrl.updateLastOpened(newItem);}function initView(response,params){params=params||{};var view=this.view=this.createView(response,$HASH.copy(params)),title=response.n||params.ttl||"",me=this;view.slot="containerNode";var frame=this.frame=this.newView("ResultSet",{controller:this});frame.addChildren([view]);this.rootCtrl.updateContent(frame,title);this.ttl=this._startParams.n=title;this.desc=response.dsc;updateLastOpenedList.call(this);window.setTimeout(function(){me.checkCache(response,params);},100);}function getViewCaptureConfig(){if(this.isFullScreen){this.cancelFlashFullScreen();}var position=this.frame.getPosition(),windowDim=$DOM.windowDim();position.ww=windowDim.w;position.wh=windowDim.h;return JSON.stringify(position);}mstrmojo.android.controllers.ResultSetController=mstrmojo.declare(mstrmojo.android.controllers.ViewController,null,{scriptClass:"mstrmojo.android.controllers.ResultSetController",supportsFullScreen:true,start:function start(params){this._super(params);this._startParams=$HASH.copy(params);var me=this,newProjectId=params.projectID,prevController=me.prevController,fnViewFailed=function(e){restoreProjectId.call(me);me.viewFailed(e);},fnLogMethod=function(isEntry){$MAPF(isEntry,"ResultSetController","start");},fnDocRequestComplete=function(){if(prevController&&prevController.docRequestComplete){prevController.docRequestComplete();}};var subtype=this.ctrlType=params.st;fnLogMethod(true);if(newProjectId){this._oldPID=mstrApp.getCurrentProjectId();mstrApp.setCurrentProjectId(newProjectId);this.pid=newProjectId;}try{var action=params.action||"execute";delete params.action;var model=this.model=this.initModel();if(subtype){model.st=subtype;model.n=params.n;}this.did=this.did||params.documentID||params.reportID||params.objectID;model[action](params,{success:function(response){try{initView.call(me,response,params);}catch(e){fnViewFailed(e);}},prompts:function(){me.openPrompts(params);},failure:function(details){fnViewFailed(details);},complete:function(){fnLogMethod(false);fnDocRequestComplete();},canceled:function(){fnViewFailed();}});}catch(e){fnViewFailed(e);fnDocRequestComplete();}},initModel:mstrmojo.emptyFn,canDelegateToolBar:function canDelegateToolBar(){return true;},createView:mstrmojo.emptyFn,getDefaultMenus:function getDefaultMenus(){return 0;},onorientationChange:function onorientationChange(){var frame=this.frame;if(frame&&frame.hasRendered){frame.rootOrientationChange({isLandscape:!this.orientation});}this._super();},refresh:function refresh(params,callback){var view=this.view;this.model.refresh(params,mstrmojo.func.wrapMethods({success:function(res){if(res){view.refresh();}}},callback));},reExecute:function reExecute(view){if(mstrApp.useBinaryFormat){mstrMobileApp.removeLiveCache(mstrApp.getCurrentProjectId(),this.model.ci.cid);var me=this;reExecuteRS.call(this,{},{success:function(res){me.setData(res);}},{refresh:true},false);}else{view.model.raiseEvent({name:"refresh"});}},reprompt:function reprompt(){this.repromptFlag=true;this.openPrompts();},openPrompts:function openPrompts(params){var me=this,prompts=this.model.prompts,size=prompts.size(),supportedPrompts=[],hasUnanswerdUnsupportedPrompts=false,i;for(i=0;i<size;i++){var prompt=prompts.get(i);if(prompt.supported()){supportedPrompts.push(prompt);}else{if(!prompt.hasAnswer){if(prompt.req){this.viewFailed({message:mstrmojo.desc(8623,"Report cannot be executed because it contains unanswered, required prompts.")});return ;}hasUnanswerdUnsupportedPrompts=true;}}}var fnAnswerPrompts=function(){if(hasUnanswerdUnsupportedPrompts){mstrmojo.alert(mstrmojo.desc(8624,"Warning: Report contains unasnwered, unsupported prompts."),function(){me.answerPrompts();});}else{me.answerPrompts();}};if(supportedPrompts.length>0){var frame=this.frame;this.spawn(mstrApp.controllerFactory.newController("Prompts"),{maskNode:frame&&frame.getMaskNode(),prompts:prompts,supportedPrompts:supportedPrompts,n:(params&&(params.n||params.ttl))||this.ttl,callback:function(){fnAnswerPrompts();}});}else{fnAnswerPrompts();}},answerPrompts:function answerPrompts(){var me=this;this.model.answerPrompts({success:function(response){var nextController=me.nextController;if(nextController){nextController.destroy();}if(me.repromptFlag){me.afterReprompt(response);delete me.repromptFlag;me.rootCtrl.updateContent(me.frame,response.n);updateLastOpenedList.call(me);me.checkCache(response);}else{initView.call(me,response);}},prompts:function(){me.viewFailed({message:mstrmojo.desc(8625,"Prompts in prompts are not supported.")});},failure:function(details){mstrApp.onerror(details);}});},afterReprompt:function afterReprompt(response){this.getPageByTree(true);},hasPageBy:mstrmojo.emptyFn,getPageByTree:function getPageByTree(override){var hasData=!!this.pageByData;if((!override&&hasData)||!this.hasPageBy()){return ;}var ctrl=this,view=this.view,model=(view.isVis&&view.isVis())?view.xtabModel:this.model;if(model.getPageByTree){if(hasData){this.set("pageByData",null);}model.getPageByTree({success:function(data){ctrl.set("pageByData",data);},failure:function(res){mstrApp.onerror(res);}});}},destroy:function destroy(){this.model.destroy();var frame=this.frame;if(frame){frame.destroy();}this._super();},checkCache:function checkCache(res,params,callback,option,config){var me=this,dataService=this.model.getDataService(),ifc=res&&res.ifc;callback=callback||mstrmojo.emptyFn;if(!mstrApp.useBinaryFormat||!ifc){callback();return ;}params=params||{did:this.did,n:this.n,st:this.st,t:this.t,sub_id:this.sub_id};var fnDisableMenu=function(menuInactive){var isActive=(menuInactive!==true);me.rootCtrl.setActionToolbarStatus(isActive);me.frame.setActionToolbarStatus(isActive);};var showMessage=true,refreshMethod=1,reExecuteCallback={success:function(newData){if(showMessage&&option!==2){mstrmojo.toast(mstrmojo.desc(8617,"Your view has been updated with the latest version of the document."),3000);}if(refreshMethod===1){me.setData(newData,true);}me.getPageByTree(true);me.generateActionToolbar();callback();fnDisableMenu();},prompts:function(){mstrmojo.alert(mstrmojo.desc(8619,"New prompts were added to the document."),function(){fnDisableMenu();me.reprompt();});},failure:function(){fnDisableMenu();},canceled:fnDisableMenu};fnDisableMenu(true);if(option===1&&res.ci.cid==="00000000000000000000000000000000"){showMessage=false;}dataService.checkCache($HASH.copy(res.ci||{},{isAutoRefresh:option===2}),{success:function(cache){if(cache.needUpdate){if(cache.refresh&&option===2){refreshMethod=2;refreshRS.call(me,reExecuteCallback,true);}else{params.isAutoRefresh=option===2;reExecuteRS.call(me,params,reExecuteCallback,{},mstrApp.isTablet());}}else{callback();fnDisableMenu();}},failure:function(){if(!mstrApp.onMobileDevice()){if(option===2){refreshMethod=2;refreshRS.call(me,reExecuteCallback);}else{reExecuteRS.call(me,params,reExecuteCallback,{},mstrApp.isTablet());}}else{fnDisableMenu();}},canceled:fnDisableMenu},config);},goBack:function goBack(){var rtn=this._super();if(!rtn){restoreProjectId.call(this);}return rtn;},makeCurrent:function makeCurrent(isBack){var frame=this.frame;if(frame){this._super(isBack);this.rootCtrl.updateContent(frame,this._startParams.n,isBack);updateLastOpenedList.call(this);}else{this.doNotRefresh=true;this.prevController.makeCurrent(isBack);}},onExecuteNewObject:function onExecuteNewObject(params){var subtype=(params.objType===OBJECT_TYPE_REPORT)?768:14081;this.spawn(mstrApp.controllerFactory.newController(this.getViewKey(subtype),{st:subtype}),params);},onDrill:function onDrill(params){this.spawn(mstrApp.controllerFactory.newController(this.getViewKey(TYPE_REPORT)),$HASH.copy(params,{action:(this.ctrlType===TYPE_REPORT)?"drillGrid":"drill2Grid",st:TYPE_REPORT}));},goUp:function goUp(){if(!this._super()){var folderController=this.getController("ctrlType",2048);if(folderController){folderController.makeCurrent(true);}else{this.rootCtrl.goHome();}}return true;},updateActionToolbar:function updateActionToolbar(tbCfg){if(mstrApp.getConfiguration().isMenuAllowed(MNU_SHARE,MNU_SHARE)){if(mstrMobileApp.getSDKVersion()>=11){tbCfg.addMenuItem(MNU_ANNOTATION,mstrmojo.desc(11191,"Annotation"),MNU_ANNOTATION,false,24);}tbCfg.addMenuItem(MNU_SHARE,mstrmojo.desc(9099,"Share"),MNU_SHARE,false,22);}tbCfg=this._super(tbCfg);if(this.frame&&this.frame.delegateToolbar(tbCfg)){tbCfg=mstrmojo.android.ui.ActionToolbar.newToolbarConfig();}return tbCfg;},handleMenuItem:function handleMenuItem(group,cmdId){switch(group){case MNU_SHARE:this.share("",false);return ;case MNU_FULLSCREEN:this[((cmdId===11)?"enter":"exit")+"FullScreen"]();return ;case MNU_ANNOTATION:this.startAnnotate();return ;}return this._super(group,cmdId);},beforeViewHidden:function beforeViewHidden(isBack){this._super(isBack);var view=this.view;if(view&&view.beforeViewHidden){view.beforeViewHidden(isBack);}if(this.isFullScreen){this.exitFullScreen(true,isBack);}},afterViewVisible:function afterViewVisible(isBackOperation){this._super(isBackOperation);if(this.isFullScreen||!!this.model.fs||!!this.model.data.fs){this.enterFullScreen();}else{if(mstrMobileApp.getSDKVersion()>=16){window.setTimeout(function(){mstrMobileApp.clearWebViewCache(false);},100);}}mstrMobileApp.hideProgress();if(!isBackOperation){var id=this.id;window.setTimeout(function(){var ctrl=mstrmojo.all[id];if(ctrl&&ctrl.rootCtrl.getCurrent()===ctrl){ctrl.takeScreenShot();}},300);}},takeScreenShot:function takeScreenShot(){var view=this.view,position=(view.getCaptureDimensions&&view.getCaptureDimensions())||$DOM.position(view.domNode),windowDim=$DOM.windowDim(),id=this.did||this.getDepth(),projId=mstrApp.getCurrentProjectId();$AFE(mstrmojo.android.ui.PropertiesView.getPreviewSizes(),function(preview){mstrMobileApp.takeScreenShot(JSON.stringify({pid:projId,dssId:id,x:position.x,y:position.y,w:Math.max(position.w,preview.w),h:Math.max(position.h,preview.h),pw:preview.w,ph:preview.h,ww:windowDim.w,wh:windowDim.h}));});},addFullScreenButton:function addFullScreenButton(tbCfg){var lbl=mstrmojo.desc(8430,"Enter Fullscreen"),icon=11;if(this.isFullScreen){lbl=mstrmojo.desc(8429,"Exit Fullscreen");icon=10;}},enterFullScreen:function enterFullScreen(){this.frame.enterFullScreen();this.rootCtrl.enterFullScreen();this.isFullScreen=true;this.generateActionToolbar();mstrmojo.touchManager.raiseEvent({name:"fullScreenStateChange"});},exitFullScreen:function exitFullScreen(noAnimation,isBack){this.isFullScreen=false;this.frame.exitFullScreen(!noAnimation);this.rootCtrl.exitFullScreen(!noAnimation,isBack);this.generateActionToolbar();mstrmojo.touchManager.raiseEvent({name:"fullScreenStateChange"});},viewTap:function viewTap(){},cancelFlashFullScreen:function cancelFlashFullScreen(){this.frame.cancelFlashFullScreen();this.rootCtrl.cancelFlashFullScreen();},getMagnifierConfig:function getMagnifierConfig(){var curtainPosition=this.frame.getPosition();return{curtainPosition:curtainPosition};},share:function share(subject,useDefault){var viewCaptureConfig=getViewCaptureConfig.call(this),ttl=this.ttl;window.setTimeout(function(){mstrMobileApp.takeScreenShotAndSend(viewCaptureConfig,JSON.stringify({attachmentName:mstrmojo.string.decodeHtmlString(ttl),subject:subject,useDefault:useDefault}));},100);},getBottomToolBarHeight:function getBottomToolBarHeight(){return(!mstrApp.isTablet()&&!this.isFullScreen&&!mstrApp.isLandscape())?(Math.round(BOTTOM_ACTION_TOOLBAR_HEIGHT_160_DPI*mstrMobileApp.getDeviceDPI()/160)):0;},startAnnotate:function startAnnotate(){if(!!this.ignoreAnnotationMenuItem){return ;}this.ignoreAnnotationMenuItem=true;mstrMobileApp.showProgress([mstrmojo.desc(8445,"Loading")],false);var viewCaptureConfig=getViewCaptureConfig.call(this),me=this;window.setTimeout(function(){mstrMobileApp.startAnnotate(viewCaptureConfig,mstrmojo.string.decodeHtmlString(me.ttl),"javascript:mstrmojo.all."+me.id+".onAnnotationFinished()");},100);},onAnnotationFinished:function onAnnotationFinished(){this.ignoreAnnotationMenuItem=false;}});}());