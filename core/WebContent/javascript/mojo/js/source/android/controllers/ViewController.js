(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.hash","mstrmojo.array","mstrmojo.android.EnumMenuOptions","mstrmojo.android.ui.ActionToolbar");mstrmojo.requiresDescs(1,1143,7831);var MENUS=mstrmojo.android.EnumMenuOptions,$HASH=mstrmojo.hash,$AFE=mstrmojo.array.forEach,GOTO_SETTINGS=MENUS.SETTINGS,GOTO_HELP=MENUS.HELP,GOTO_LEARN=MENUS.LEARN,DEFAULT_ALL=-1;var linkDrillParams={currentViewMedia:0,documentID:"objectID",elementsPromptAnswers:0,link:0,linkAnswers:0,objectID:0,objectsPromptAnswers:0,promptsAnswerXML:0,reportID:0,reportViewMode:0,valuePromptAnswers:0,visMode:0,desiredElements:0,desiredUnits:0,projectID:0,Project:"projectID",groupByElements:0,pageByElements:0,layoutIndex:0,originMessageID:"originMessageID",promptAnswerMode:0,selectorMode:"selectorMode"};mstrmojo.android.controllers.ViewController=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.android.controllers.ViewController",supportsFullScreen:false,start:function start(params){this.set("orientation",mstrApp.isLandscape()?0:1);this.pid=mstrApp.getCurrentProjectId();},detach:function detach(){var me=this,nextController=me.nextController,prevController=me.prevController;if(prevController){delete prevController.nextController;}if(nextController){nextController.destroy();}this.nextController=this.prevController=null;var view=this.view;if(view){view.destroy();}},destroy:function destroy(){this.detach();this._super();},canDetach:function canDetach(controller){return controller.hsc||!this.hsc;},getUpStatus:function getUpStatus(){return !this.hsc;},spawn:function spawn(controller,startParams){var nextController=this.nextController;if(nextController){if(!nextController.canDetach(controller)){nextController.spawn(controller,startParams);return ;}nextController.destroy();}this.nextController=controller;controller.prevController=this;controller.rootCtrl=this.rootCtrl||this;controller.start(startParams||{});},spawnFailed:function spawnFailed(details){this.makeCurrent();mstrApp.onerror(details);},viewFailed:function viewFailed(details){if(details){mstrmojo.dbg("details: "+JSON.stringify(details));}mstrApp.hideMessage();if(this.view){if(this.rootCtrl.getCurrent()!==this){this.makeCurrent(true);}}else{var previousController=this.prevController;if(previousController){previousController.spawnFailed(details);}}mstrApp.onerror(details);},makeCurrent:function makeCurrent(isBack){var nextController=this.nextController,needRefresh=true;if(nextController){needRefresh=!nextController.doNotRefresh;nextController.destroy();}if(!this.supportsFullScreen){this.rootCtrl.exitFullScreen();}var projectId=this.pid;if(projectId){mstrApp.setCurrentProjectId(projectId);}if(isBack){if(mstrApp.useBinaryFormat&&mstrApp.getCurrentProjectId()){var ctrlType=this.ctrlType;if(ctrlType){var model=this.model,emptyFn=mstrmojo.emptyFn,successFn=emptyFn,me=this;if(this.checkCache&&needRefresh){successFn=function(){setTimeout(function(){me.checkCache(null,null,null,1);},100);};}var params={taskId:"setCurrentView",st:ctrlType,did:this.did||"",mid:(model&&model.dataService&&model.dataService.msgId)||""},curLayoutKey=model&&model.currlaykey;if(curLayoutKey){params.layoutKey=curLayoutKey;}mstrApp.serverRequest(params,{success:successFn,failure:emptyFn},{silent:true});}}}},makeHome:function makeHome(){this.makeCurrent(true);},jumpTo:function jumpTo(item){var nextController=this.nextController;if(nextController){nextController.jumpTo(item);return ;}this.spawn(mstrApp.controllerFactory.newController(this.getViewKey(item.st),item),item);},getPath:function getPath(){var nextController=this.nextController;if(nextController){return nextController.getPath();}return[];},updateItemProperties:function updateItemProperties(defaultMsg,item,ctrlId,isAvail){var nextController=this.nextController;if(nextController){nextController.updateItemProperties(defaultMsg,item,ctrlId,isAvail);}},onorientationChange:function onorientationChange(){var orientation=this.orientation,view=this.view;if(view&&view.hasRendered&&view.rootOrientationChange){view.rootOrientationChange({isLandscape:!orientation});}var nextController=this.nextController;if(nextController){nextController.set("orientation",orientation);}},getCurrent:function getCurrent(){var nextController=this.nextController;if(nextController){return nextController.getCurrent();}return this;},goBack:function goBack(){var nextController=this.nextController;if(nextController){if(!nextController.goBack()){if(!this.rootCtrl){return false;}this.makeCurrent(true);}return true;}return false;},goUp:function goUp(){var nextController=this.nextController;if(nextController){return nextController.goUp();}return false;},getController:function getController(propName,propValue,isForward){var ctrl=this[(isForward?"next":"prev")+"Controller"];if(ctrl){if(ctrl[propName]===propValue){return ctrl;}return ctrl.getController(propName,propValue,isForward);}return null;},newView:function newView(viewKey,params){return mstrApp.viewFactory.newView(viewKey,mstrmojo.hash.copy(params,{controller:this}));},getViewKey:function getViewKey(subtype){return{1:"Projects",2:"Home",3:"Subscriptions",4:"Settings",5:"Projects",6:"Help",8:"Subscriptions",768:"Xtab",769:"Graph",774:"Xtab",2048:"Folder",14081:"Document"}[subtype];},getDefaultMenus:function getDefaultMenus(){return DEFAULT_ALL;},generateActionToolbar:function generateActionToolbar(){var rootCtrl=this.rootCtrl||this,currentCtrl=rootCtrl.getCurrent();rootCtrl.setActionToolbar(currentCtrl.id,currentCtrl.updateActionToolbar(mstrmojo.android.ui.ActionToolbar.newToolbarConfig()));},updateActionToolbar:function updateActionToolbar(tbCfg){var menus=this.getDefaultMenus(),config=mstrApp.getConfiguration();if(config.isMenuAllowed(GOTO_LEARN,menus)){tbCfg.addMenuItem(GOTO_LEARN,mstrmojo.desc(9849,"Learn More"),GOTO_LEARN,true,6);}if(config.isMenuAllowed(GOTO_SETTINGS,menus)){tbCfg.addMenuItem(GOTO_SETTINGS,mstrmojo.desc(7831,"Settings"),GOTO_SETTINGS,true,6);}if(config.isMenuAllowed(GOTO_HELP,menus)){tbCfg.addMenuItem(GOTO_HELP,mstrmojo.desc(1143,"Help"),GOTO_HELP,false,9);}if(!mstrApp.isTablet()){tbCfg.maxBtnCount=(mstrApp.isLandscape())?Math.round(mstrMobileApp.getDeviceDPI()/105)+1:2;}return tbCfg;},handleMenuItem:function handleMenuItem(group,cmdId){switch(group){case GOTO_SETTINGS:this.spawn(mstrApp.controllerFactory.newController("Settings"));break;case GOTO_LEARN:mstrMobileApp.displayLearnMore();break;case GOTO_HELP:mstrApp.displayHelp();break;}return false;},beforeViewVisible:mstrmojo.emptyFn,afterViewVisible:function afterViewVisible(){var me=this;window.setTimeout(function(){me.generateActionToolbar();},100);},beforeViewHidden:mstrmojo.emptyFn,afterViewHidden:mstrmojo.emptyFn,handleSpecialLink:function handleSpecialLink(uri){var eventId=uri.queryKey.evt,forceRepaint;if(eventId==="3999"){this.spawn(mstrApp.controllerFactory.newController("Settings",{}),{});}else{if(eventId==="3124"){mstrApp.goBack();forceRepaint=true;}else{if(eventId==="3994"){mstrApp.displayHelp();}else{if(eventId==="3997"){mstrApp.rootController.jumpTo({act:8});}else{if(eventId==="3995"){mstrApp.rootController.goHome();forceRepaint=true;}else{if(eventId==="3996"){mstrApp.rootController.jumpTo({act:5});forceRepaint=true;}}}}}}if(forceRepaint){window.setTimeout(function(){mstrMobileApp.forceRepaint();},0);}},getDepth:function getDepth(){var prev=this.prevController;return(prev&&(prev.getDepth()+1))||1;},onLink:function onLink(view,action){var params=this.buildLinkParams(action);params.action="linkToObject";var isHTMLDoc=false,subtype=768;switch(parseInt(action.evt,10)){case 4001:if(parseInt(action.reportViewMode,10)===2){subtype=769;}params.styleName="AndroidMessageResultStyle";break;case 32001:isHTMLDoc=true;break;case 2048001:subtype=14081;break;}params.st=subtype;this.spawn(mstrApp.controllerFactory.newController(isHTMLDoc?"HTMLDoc":this.getViewKey(subtype),{st:subtype}),params);},buildLinkParams:function buildLinkParams(action){var params={};$HASH.forEach(action,function(v,p){var pV=linkDrillParams[p];if(p==="Project"){var mobileCfg=mstrApp.getConfiguration(),sn=action.Server,port=action.port||action.Port,project;if(sn===undefined){var server=mobileCfg.getServerByProjectId(mstrApp.getCurrentProjectId());if(server!==undefined){$AFE(server.pl,function(p){if(v===p.pn){if((port===undefined)||(!!port&&parseInt(port,10)===p.sp)){project=p;return false;}}});}}else{project=mobileCfg.getProjectByServerAndProjectName(sn,port,v);}if(project!==undefined){params[pV]=project.pid;}}else{if(pV!==undefined){params[pV||p]=v;}}});if(mstrApp.useBinaryFormat){params.srcMsgId=action.srcMsgId;}var linkInfo=action.linkInfo;if(linkInfo&&linkInfo.so>0){params.selectorMode=linkInfo.so;params.originMessageID=action.srcMsgId;if(!action.linkAnswers){params.promptAnswerMode="0";}}return params;},exitFullScreen:mstrmojo.emptyFn});}());