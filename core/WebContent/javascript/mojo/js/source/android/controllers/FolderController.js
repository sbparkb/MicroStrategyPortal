(function(){mstrmojo.requiresCls("mstrmojo.android.controllers.ViewController","mstrmojo.android.controllers._SupportsQueuedTransactions","mstrmojo.android.controllers._HasFolderView","mstrmojo.android.EnumMenuOptions","mstrmojo.publisher","mstrmojo.array");mstrmojo.requiresDescs(773,8386,8388);var $ARR=mstrmojo.array,$DESC=mstrmojo.desc,$MENUS=mstrmojo.android.EnumMenuOptions,$REFRESH=$MENUS.REFRESH;function getLastRequest(){var requests=this._requests;return requests[requests.length-1];}function loadFolder(params,isRefresh,callback){var controller=this,view=this.view;params.csp=this.csp;callback=callback||{};this.dataService.getData(params,{success:function(res){view.set("items",res.items);if(isRefresh){getLastRequest.call(controller).res=res;}else{controller._requests.push({p:params,res:res});}var fnSuccess=callback.success;if(fnSuccess){fnSuccess.call(controller,res);}},failure:function(details){controller.viewFailed(details);},canceled:function(){var fnCancel=callback.canceled;if(fnCancel){fnCancel.call(controller);}}},isRefresh);}function cacheViewState(idx){var lastRequest=getLastRequest.call(this);lastRequest.orientation=mstrApp.isLandscape();lastRequest.idx=idx;lastRequest.origin=this.view.getScrollPos();lastRequest.hasState=true;}function clearPhoneViewSelections(){var view=this.view;if(view&&!mstrApp.isTablet()){view.clearSelect();}}function spawnItem(item){var itemSubType=item.st,params={ttl:item.n,st:itemSubType,did:item.did,ab:item.ab,rtf:item.rtf};this.spawn(mstrApp.controllerFactory.newController(this.getViewKey(itemSubType),params),params);}function restoreStateFromRequest(request){if(!request.hasState){return ;}var view=this.view,isDirty=(mstrApp.isTablet()&&request.orientation!==mstrApp.isLandscape()),idx=request.idx,origin={x:0,y:0};if(!isDirty){origin=request.origin;}view.restoreListState(idx,origin);view.items=request.res.items;view.refresh();if(isDirty){view.scrollToItem(idx);}}function jumpBack(idx){var requests=this._requests;if(idx!==undefined){if(requests.length<=idx+1){return false;}requests.splice(idx+1);}else{requests.pop();}var current=getLastRequest.call(this);if(!current){return false;}restoreStateFromRequest.call(this,current);var rootCtrl=this.rootCtrl,currentResponse=current.res;rootCtrl.updateFolder(null,currentResponse.n);rootCtrl.contentUpdated(2048);this.updatePropertiesMsg();return true;}mstrmojo.android.controllers.FolderController=mstrmojo.declare(mstrmojo.android.controllers.ViewController,[mstrmojo.android.controllers._SupportsQueuedTransactions,mstrmojo.android.controllers._HasFolderView],{scriptClass:"mstrmojo.android.controllers.FolderController",start:function start(params){this._super(params);this.ctrlType=2048;this.dataService=mstrApp.modelFactory.newDataService("Folder");this._requests=[];var view=this.initFolderView();loadFolder.call(this,params,false,{success:function(res){if(params.systemFolder===7){res.n=params.n||params.txt;}var rootCtrl=this.rootCtrl;rootCtrl.updateFolder(this.view,res.n);if(this.hsc&&!mstrApp.isTablet()){rootCtrl.updateContent(null,res.n);}this.updatePropertiesMsg();},canceled:function(){this.prevController&&this.prevController.makeCurrent();}});},openFolder:function openFolder(folder){cacheViewState.call(this,folder._renderIdx);this.view.resetListState();loadFolder.call(this,folder,false,{success:function(res){var rootCtrl=this.rootCtrl;rootCtrl.updateFolder(null,res.n);rootCtrl.contentUpdated(2048);this.updatePropertiesMsg();},canceled:clearPhoneViewSelections});},openItem:function openItem(item){cacheViewState.call(this,item._renderIdx);spawnItem.call(this,item);},itemLongPressed:function itemLongPressed(item){cacheViewState.call(this,item._renderIdx);return this._super(item);},getDefaultMenus:function getDefaultMenus(){return $MENUS.SETTINGS+$MENUS.HELP+$MENUS.LEARN;},getDefaultMessage:function getDefaultMessage(){var items=this.view.items;return(items&&items.length)?$DESC(8386,"Select a report, document or folder to view its content"):$DESC(8388,"No items in folder");},makeCurrent:function makeCurrent(isBack){this._super(isBack);var current=getLastRequest.call(this);if(current){var title=(this.hsc&&mstrApp.isTablet())?undefined:current.res.n;this.rootCtrl.updateFolder(this.view,title,isBack);restoreStateFromRequest.call(this,current);}},makeHome:function makeHome(){this._super();jumpBack.call(this,0);},goBack:function goBack(){if(this._super()){return true;}return jumpBack.call(this);},goUp:function goUp(){if(!this._super()){if(this._requests.length>1){jumpBack.call(this,0);}else{this.rootCtrl.goBack();}}return true;},getUpStatus:function getUpStatus(){if(!this._super()){var requests=this._requests;return !!(requests&&requests.length>1);}return true;},updateActionToolbar:function updateActionToolbar(tbCfg){this.getTxnToolbarButton(tbCfg);if(mstrMobileApp.isOnline()){tbCfg.addMenuItem($REFRESH,$DESC(773,"Refresh"),$REFRESH,true,5);}return this._super(tbCfg);},handleMenuItem:function handleMenuItem(group,cmdId){if(group===$REFRESH){loadFolder.call(this,getLastRequest.call(this).p,true,{success:function(){this.view._scroller.scrollTo(0,0);}});return false;}return this._super(group,cmdId);},getPath:function getPath(){var path=[],id=this.id;$ARR.forEach(this._requests,function(item,idx){var response=item.res;path.push({n:response.n,fn:function(){jumpBack.call(mstrmojo.all[id],idx);}});});return path;},goHome:function goHome(){jumpBack.call(this,0);}});}());