(function(){mstrmojo.requiresCls("mstrmojo.android.controllers.ViewController","mstrmojo.android.TransactionNotificationBoard","mstrmojo.android.Dialog","mstrmojo.func","mstrmojo.hash");mstrmojo.requiresDescs(9478,9479);var $H=mstrmojo.hash,TX_QUEUE_LEVEL_DOC=1,TX_QUEUE_LEVEL_ALL=2,BTN_HEIGHT={120:48,240:72,320:96};function createNotificationBoardCfg(params){var cfg={scriptClass:"mstrmojo.android.Dialog",cssClass:"notificaton-board",children:[{alias:"ntfBoard",scriptClass:"mstrmojo.android.TransactionNotificationBoard",model:params.model,isFullScreen:params.fullScreen,context:params.context,cssClass:params.fullScreen?"phone":"tablet",listViewMode:params.fullScreen?2:1,controller:params.controller}]};if(!params.fullScreen){$H.copy({onpopupResized:function(e){this.ntfBoard.setDimensions(e.height+"px",e.width+"px");}},cfg);}else{$H.copy({resizeDialog:function(){var screen=mstrApp.getScreenDimensions(),wpx=screen.w+"px",hpx=screen.h+"px",ensty=this.editorNode.style,cnsty=this.containerNode.style;ensty.left=ensty.top="0px";cnsty.width=wpx;cnsty.height=hpx;this.ntfBoard.setDimensions(hpx,wpx);},positionDialog:mstrmojo.emptyFn},cfg);cfg.children[0].buttonHeight=BTN_HEIGHT[mstrMobileApp.getDeviceDPI()]||70;}return cfg;}mstrmojo.android.controllers.TransactionNotificationController2=mstrmojo.declare(mstrmojo.android.controllers.ViewController,null,{scriptClass:"mstrmojo.android.controllers.TransactionNotificationController2",widgetMap:null,ntfBoardOpening:false,fullScreenView:true,boardOpen:null,init:function init(props){this._super(props);var widgetMap=this.widgetMap={},boardModel=this.boardModel=this.model.getBoardModel();if(!this._modelListener){this._modelListener=boardModel.attachEventListener("recordChanged",this.id,function(e){$H.forEach(widgetMap,function(v,k){if(!e.data||!e.data[k]){v.set("txData",null);delete this.widgetMap[k];}});if(this.isNotificationBoardOpen()){this.pendingUpdate=true;}else{this.generateActionToolbar();}});}this.fullScreenView=!mstrApp.isTablet();},start:function start(params){var cfg={};$H.copy(createNotificationBoardCfg({model:this.boardModel,controller:this,fullScreen:this.fullScreenView,context:params.context}),cfg);var dlg=mstrApp.showDialog(cfg);this.boardView=dlg.ntfBoard;},destroy:function destroy(ignoreDOM){var listener=this._modelListener;if(listener){this.boardModel.detachEventListener(listener);}this._super(ignoreDOM);},hasTransactionQueue:function hasTransactionQueue(did){var res=this.model.hasOfflineTransactions();if(res&&did){res=res&&this.boardModel.getOfflineRecords(did);}return res;},hasPendingTransactions:function hasPendingTransactions(did){var docTx=this.boardModel.getOfflineRecords(did);return docTx&&docTx.pending&&(docTx.pending.length>0);},showNotificationBoard:function showNotificationBoard(openerController,did){var params={context:did||openerController.did};this.boardOpen=did?TX_QUEUE_LEVEL_DOC:TX_QUEUE_LEVEL_ALL;this.contextController=openerController;openerController.spawn(this,params);},isNotificationBoardOpen:function isNotificationBoardOpen(){return !!this.boardOpen;},editTransactionRecord:function editTransactionRecord(did,isPending,timeStamp,callback){var bm=this.boardModel,id=this.id;this.model.editTransactionRecord(did,isPending,timeStamp,mstrmojo.func.wrapMethods(callback,{success:function(response){mstrmojo.all[id].startDocument(response,did,bm.docsTx[did]&&bm.docsTx[did].p.pid);}}));},deleteTransactionRecord:function deleteTransactionRecord(did,isPending,timeStamp,callback){var me=this;this.model.deleteTransactionRecord(did,isPending,timeStamp,{success:function(data){var noTxRecords=!me.boardModel.getOfflineRecords(did);if(callback&&callback.success){callback.success(data);}var boardOpen=me.boardOpen;if(boardOpen===TX_QUEUE_LEVEL_ALL&&noTxRecords){me.goBack();}if((boardOpen===TX_QUEUE_LEVEL_DOC&&noTxRecords)||me.model.emptyTransactionQueue){mstrmojo.toast(me.model.emptyTransactionQueue?mstrmojo.desc(9478,"There are no more pending transactions"):mstrmojo.desc(9479,"There are no more pending transactions for the current document"));mstrApp.closeDialog();}},failure:function(){if(callback&&callback.failure){callback.failure();}},complete:function(){if(callback&&callback.compelete){callback.compelete();}}});},startDocument:function startDocument(res,did,pid){res.ifc=false;mstrApp.closeDialog();var contextController=this.contextController;if(contextController){var scParams={st:14081},ctParams={action:"open",data:res,documentID:did,hasTxChanges:true};if(pid!==mstrApp.getCurrentProjectId()){ctParams.projectID=pid;}if(contextController instanceof mstrmojo.android.controllers.ResultSetController){if(contextController.did===did){contextController.hasTxChanges=true;contextController.model.transactionUpdate(res);contextController.setData(res);contextController.getPageByTree(true);return ;}}contextController.spawn(mstrApp.controllerFactory.newController("Document",scParams),ctParams);}},onCloseNotificationBoard:function onCloseNotificationBoard(){this.boardOpen=null;this.detach();if(this.pendingUpdate){this.rootCtrl.generateActionToolbar();delete this.pendingUpdate;}},addWidgetListener:function addWidgetListener(did,w){this.widgetMap[did]=w;},goBack:function goBack(){return !!(this.boardOpen===TX_QUEUE_LEVEL_ALL&&this.boardView.goBack());},setOfflineRecords:function setOfflineRecords(did){this.model.refresh();}});}());