(function(){mstrmojo.requiresCls("mstrmojo.android.controllers.ResultSetController","mstrmojo._IsDocController","mstrmojo.android.controllers._SupportsQueuedTransactions","mstrmojo.android.controllers._HasPageBy","mstrmojo.ui.MobileCheckList","mstrmojo.android.EnumMenuOptions","mstrmojo.string","mstrmojo.array","mstrmojo.hash","mstrmojo.android.nativedialog.LayoutDialog");mstrmojo.requiresDescs(1089,1917,2941,6189,9233,9254,9255,9256,9257);var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,MENUS=mstrmojo.android.EnumMenuOptions,MNU_LAYOUTS=MENUS.DOC_LAYOUTS,MNU_GROUPBY=MENUS.GROUP_BY,MNU_REPROMPT=MENUS.REPROMPT,MNU_SHARE=MENUS.SHARE,MNU_ANNOTATION=MENUS.ANNOTATION,UNIT_SEPARATOR="\u001F",MARK_ROW=1;function getCurLayout(me){var model=me.model,lyts=model.data.layouts,i=$ARR.find(lyts,"k",model.currlaykey);return i>=0?lyts[i]:null;}function getDrillGB(me,view){var elements=me.getGroupByElements(view),res=[],lyt=getCurLayout(me),gbys=lyt&&lyt.gbys&&lyt.gbys.groupbys,elemSize=elements&&elements.length;if(elemSize&&gbys){for(i=0;i<elemSize;i++){var gb=gbys[i].unit.target;res.push(gb.did);res.push(gb.t);res.push(elements[i]);}}return res.join(UNIT_SEPARATOR);}function getDesiredUnits(me,elements){var res=me.desiredUnits||{},lyt=getCurLayout(me),elemSize=elements&&elements.length;if(lyt&&lyt.gbys){var gbys=lyt.gbys.groupbys,size=gbys.length;for(i=0;i<size;i++){var gb=gbys[i].unit,elem;if(elements){if(i<elemSize){elem=elements[i];}else{break;}}else{elem=gb.elms[gb.idx].v;}res[gb.target.did]=elem;}}return res;}function toDesiredElements(units){var res="",i=0,u;for(u in units){if(i>0){res+=UNIT_SEPARATOR;}res+=u+UNIT_SEPARATOR+units[u];i++;}return res;}function clearRefreshTimer(){if(this.refreshTimer){clearInterval(this.refreshTimer);delete this.refreshTimer;}}function startRefreshTimer(){var rf=this.model.rf;if(rf&&rf>0){var ths=this;this.refreshTimer=self.setInterval(function(){ths.checkCache(null,null,null,2);},rf*1000);}}function clearOrientation(){var previousOrientation=this._previousOr;if(previousOrientation===-1){return ;}if(previousOrientation===0){window.setTimeout(function(){mstrMobileApp.releaseOrientation();});}else{if(previousOrientation>0){mstrMobileApp.lockOrientation(previousOrientation);}}this._previousOr=-1;}function getTxController(){return mstrApp.getTransactionNotificationController();}function createLinkParams(queryKeys,linkSrc){var params={srcMsgId:this.model.mid,desiredUnits:getDesiredUnits(this,this.getGroupByElements(linkSrc))};$HASH.forEach(queryKeys,function(v,k){v=v.replace(/\+/g," ");params[k]=decodeURIComponent(v);});return params;}function fillTxData(params){var txds=params.txData.split(";"),i,size=txds.length;for(i=0;i<size;i++){var t=txds[i],kvp=t.split(","),v=decodeURIComponent(kvp[1]),w=this.model.getFirstUnitInstanceByName(kvp[0]);if(w){w.dataChanged(0,w.v,{dv:v,v:v},w.valueNode);}}}mstrmojo.android.controllers.DocumentController=mstrmojo.declare(mstrmojo.android.controllers.ResultSetController,[mstrmojo.android.controllers._SupportsQueuedTransactions,mstrmojo._IsDocController,mstrmojo.android.controllers._HasPageBy],{scriptClass:"mstrmojo.android.controllers.DocumentController",initModel:function initModel(params){return mstrApp.modelFactory.newModel("Document",$HASH.copy(params,{controller:this}));},hasTxChanges:false,start:function start(params,callback){var du=this.desiredUnits=params.desiredUnits;if(du){var desired=toDesiredElements(du);if(desired){params.desiredElements=desired;}delete params.desiredUnits;}this.sub_id=params.sub_id;this.hasTxChanges=!!params.hasTxChanges;this._super(params,callback);},createView:function createView(res,params){var layouts=res.defn.layouts,currentLockedOrientation=mstrMobileApp.getLockedOrientation(),lastLayoutOrientation=-1,newOrientation=-1,shouldLock=true,cnt=layouts.length,i;for(i=0;i<cnt;i++){if(layouts[i].iw){continue;}var layoutOrientation=layouts[i].or;if(lastLayoutOrientation===-1){lastLayoutOrientation=layoutOrientation;}if(layoutOrientation!==lastLayoutOrientation||layoutOrientation===3){shouldLock=false;break;}}if(currentLockedOrientation>0){if(shouldLock){if(lastLayoutOrientation!==currentLockedOrientation){newOrientation=lastLayoutOrientation;}}else{newOrientation=0;}}else{if(shouldLock){newOrientation=lastLayoutOrientation;}}if(newOrientation>-1){if(newOrientation===0){mstrMobileApp.releaseOrientation();}else{mstrMobileApp.lockOrientation(newOrientation);}this._previousOr=currentLockedOrientation;}var doc=this.view=this.newView("Document",params);doc.set("model",this.model);doc.buildChildren();return doc;},afterReprompt:function afterReprompt(response){var view=this.view;view.unloadLayouts(null,false);view.model.loadLayout(response,true);this._super(response);},onPageBy:function onPageBy(pageByKeys){var gbUnits=[];$ARR.forEach(pageByKeys,function(item,idx){gbUnits.push({key:item.id,value:item.v});});this.onGroupBy({gbUnits:gbUnits});},hasPageBy:function hasPageBy(){var view=this.view,layout=view&&view.getLayouts()&&view.getCurrentLayout();return !!(layout&&layout.gb&&layout.defn.dpb);},onGroupBy:function onGroupBy(params,callback,config){var view=this.view,model=this.model;config=config||{};config.showWait=true;config.hideWait=true;config.delay=true;callback=mstrmojo.func.wrapMethods(callback,{success:function(res){view.unloadLayouts(null,true);model.loadLayout(res);}});model.getDataService().changeDocGroupBy(params,callback,config);},setData:function setData(res,isNewData){this._super(res,isNewData);if(res.rf!=this.old_rf){clearRefreshTimer.call(this);startRefreshTimer.call(this);}this.rootCtrl.updateContent(null,this.model.n,false);},onDrill:function onDrill(view,action){if(!this.isInRequest()){if(action.isWithin){view.model.drillGrid(this._addNodeKeyToAction(view,action),this._getXtabCallback(view));}else{action.rwGroupByElements=getDrillGB(this,view);this._super(this._addNodeKeyToAction(view,action));}}},onDownloadGridData:function onDownloadGridData(view,action){this.model.downloadGridData(this._addNodeKeyToAction(view,action));},onExecuteNewObject:function onExecuteNewObject(view,action){this._super(action);},onReExecute:function onReExecute(view){this.reExecute(view);},refresh:function refresh(params,callback){var id=this.id;this.model.getDataService().refresh(params,mstrmojo.func.wrapMethods({success:function(res){mstrmojo.all[id].setData(res,true);}},callback));},invalidClientCache:function(){if(mstrApp.useBinaryFormat){mstrMobileApp.removeLiveCache(mstrApp.getCurrentProjectId(),this.model.ci.cid);}},onTransactionUpdates:function onTransactionUpdates(view,updateObject,autoRefresh){var md=this.model,callback;if(mstrApp.useBinaryFormat){callback=md.newCallback({success:function(){view.clear();md.clearTxDeltaUpdate();if(autoRefresh){setTimeout(function(){view.autoRefresh();},250);}}});var dataService=md.getDataService();if(updateObject.manipulation===MARK_ROW){dataService.txMarkRows(updateObject,callback);}else{dataService.txChangeData(updateObject,callback);}}else{if(autoRefresh){view.autoRefresh();}}this.hasTxChanges=true;},onLink:function onLink(view,action){if(!action.url){return this._super(view,action);}var uri=mstrmojo.string.parseUri(action.url),authority=uri.authority,path=uri.path;if(uri.protocol==="mstr"){this.handleSpecialLink(uri,action);}else{if(authority==="mstrWeb"||authority==="Main.aspx"||(/mstrWeb$/.test(path))||(/Main\.aspx$/.test(path))){this._super(view,createLinkParams.call(this,uri.queryKey,action.src));}else{var err=mstrMobileApp.openLink(uri.source,action.target);if(err){mstrApp.onerror({message:err});}}}},getLinkRequest:function getLinkRequest(link){var res;if(!link.url){res=this.buildLinkParams(link);}else{var uri=mstrmojo.string.parseUri(link.url),uriParams=uri.queryKey,authority=uri.authority,path=uri.path;if(uri.protocol!=="mstr"&&(authority==="mstrWeb"||authority==="Main.aspx"||(/mstrWeb$/.test(path))||(/Main.aspx$/.test(path)))){res=this.buildLinkParams(createLinkParams.call(this,uriParams,link.src));if(res){switch(parseInt(uriParams.evt,10)){case 4001:res.taskID="reportExecute";res.styleName="AndroidMessageResultStyle";break;case 2048001:res.taskID="RWExecute";res.objType=55;var du=res.desiredUnits;if(du){var desired=toDesiredElements(du);if(desired){res.desiredElements=desired;}delete res.desiredUnits;}break;}}}}if(res&&res.link){res.linkAnswers=res.link.toXml();delete res.link;}return res;},getDesiredElements:function getDesiredElements(elements){var gbElements=this.model.gbElements,res="";if(gbElements){var gbs=gbElements.split(";"),size=gbs.length,i;for(i=0;i<size;i+=3){if(i>0){res+=UNIT_SEPARATOR;}res+=gbs[i]+UNIT_SEPARATOR+gbs[i+2];}}else{res=toDesiredElements(getDesiredUnits(this,elements));}return res;},confirmMsgBeforeSubmit:function confirmMsgBeforeSubmit(){var md=this.model,txNtfCtl=getTxController(),msg;if(this.hasTxChanges&&txNtfCtl&&txNtfCtl.hasPendingTransactions(this.did)){if(md.txrcd){msg=mstrmojo.desc(9254,"Pending transaction exists")+". "+mstrmojo.desc(9255,"You are about to replace a pending transaction.");}else{msg=mstrmojo.desc(9256,"There are one or more pending submissions in the transaction queue for this document.")+" "+mstrmojo.desc(9257,"Continuing will submit a new transaction.");}}return msg;},offlineTransactionsSubmitted:function offlineTransactionsSubmitted(ck){var txNtfCtl=getTxController();if(txNtfCtl){txNtfCtl.setOfflineRecords(this.did);}this.hasTxChanges=false;},openOfflineTransactions:function openOfflineTransactions(){var txNtfCtl=getTxController();if(txNtfCtl){txNtfCtl.showNotificationBoard(this,this.did,this.ttl);}},transactionDiscarded:function transactionDiscarded(ck){this.hasTxChanges=false;},destroy:function destroy(){clearOrientation.call(this);this._super();},nudgeWidget:function nudgeWidget(id,update){if(mstrMobileApp!==undefined&&mstrMobileApp.nudgeWidget){mstrMobileApp.nudgeWidget(id,JSON.stringify(update));}},resetOrientation:function resetOrientation(){clearOrientation.call(this);},checkCache:function checkCache(res,params,cacheIsGoodCallback,option,config){this.old_rf=this.model.rf;this._super(res||{ifc:true,ci:this.model.ci},params,cacheIsGoodCallback,option,config);},beforeViewHidden:function beforeViewHidden(isBack){this._super(isBack);if(isBack){mstrmojo.GraphBase.hideTooltips();this.resetOrientation();}clearRefreshTimer.call(this);},afterViewVisible:function afterViewVisible(){this._super();var view=this.view;if(view&&view.afterViewVisible){view.afterViewVisible();}if(!this.isSubscription){startRefreshTimer.call(this);}},hasFullScreenInfoWindow:function hasFullScreenInfoWindow(){var view=this.view;return view&&view.fullScreenInfoWindow;},updateActionToolbar:function updateActionToolbar(tbCfg){if(!this.hasFullScreenInfoWindow()){this.getTxnToolbarButton(tbCfg);this.addFullScreenButton(tbCfg);if(mstrMobileApp.isOnline()){var model=this.model,docModel=model.docModel||model,prompts=docModel.prompts,currentLayoutDef=docModel.getCurrentLayoutDef&&docModel.getCurrentLayoutDef(),dri=(currentLayoutDef&&currentLayoutDef.dri);if(prompts&&prompts.hasSupported()&&(dri===undefined||dri)){tbCfg.addToolbarBtn(MNU_REPROMPT,mstrmojo.desc(6189,"Filter"),MNU_REPROMPT,true,3);}}if(this.hasPageBy()){tbCfg.addToolbarBtn(MNU_GROUPBY,mstrmojo.desc(2941,"Grouping"),MNU_GROUPBY,true,2);}var layouts=this.view&&this.view.getSupportedLayouts();if(layouts&&(layouts.length>1)){tbCfg.addToolbarBtn(MNU_LAYOUTS,mstrmojo.desc(4174,"Layouts"),MNU_LAYOUTS,false,8);}}return this._super(tbCfg);},handleMenuItem:function handleMenuItem(group,cmdId){if(group!==MNU_SHARE&&group!==MNU_ANNOTATION){mstrmojo.GraphBase.hideTooltips();if(mstrApp.isTablet()){this.view.closeInfoWindowsOnTablet();}}switch(group){case MNU_LAYOUTS:var view=this.view,owner=this,fnLayouts=function(){var layouts=view.getSupportedLayouts();return{l:layouts,idx:$ARR.indexOf(layouts,view.getCurrentLayout())};},info=fnLayouts(),config={title:mstrmojo.desc(4174,"Layouts"),children:[{scriptClass:"mstrmojo.ui.MobileCheckList",isElastic:true,multiSelect:false,items:info.l,selectedIndex:info.idx,postselectionChange:function(evt){var added=evt.added;if(added){if(view.showLayout(this.items[added[0]])){mstrApp.closeDialog();}}},postCreate:function(){mstrApp.rootController.attachEventListener("rootOrientationChange",this.id,function(){var info=fnLayouts();this.set("items",info.l);this.select(info.idx);this.parent.resizeDialog();});}}]};if(mstrApp.useBinaryFormat){$HASH.copy({isNative:true,scriptClass:"mstrmojo.android.nativedialog.LayoutDialog",onSelectionChange:function(index){owner.onLayoutChange(index);this.close();},postCreate:function(){mstrApp.rootController.attachEventListener("rootOrientationChange",this.id,function(){var info=fnLayouts();this.update(info.l,info.idx);});}},config);}mstrApp.showDialog(config);return ;case MNU_GROUPBY:this.showGroupByDialog();return ;case MNU_REPROMPT:this.reprompt();return ;}return this._super(group,cmdId);},makeCurrent:function makeCurrent(isBack){this.isBack=true;this._super(isBack);delete this.isBack;},handleSpecialLink:function handleSpecialLink(uri,action){var param=uri.queryKey,view=this.view,eventId=param.evt;if(eventId==="2048500"){var name=param.panelName,model=view.model,unit=model.getInfoWindow(name);if(unit){view.showInfoWindow(unit.id,unit.k,action.src.domNode);}}else{if(eventId==="2048030"){var fresh=!!param.useCache&&param.useCache==="0",rparams={fresh:fresh,useRefreshProgress:mstrApp.isTablet()};this.refresh(rparams);}else{if(eventId==="2048258"){fillTxData.call(this,param);}else{if(eventId==="3037"){this.share(param.emailSubject,true);}else{if(eventId==="3175"){this.startAnnotate();}else{if(uri.authority==="gb"){var me=this,curLayout=view.getSelectedLayoutWidget(),gpby=curLayout.gb,attId=param.a,eId=param.e,$forEach=$ARR.forEach;$forEach(gpby.groupbys,function(gb){var unit=gb.unit,target=unit.target;if(target.did===attId){var showDialog=function(){var options=unit.elms,items=[];$forEach(options,function(opt,idx){items.push($HASH.copy(opt,{k:gb.k,on:(idx===unit.idx)}));});mstrApp.showDialog({title:target.n,children:[{scriptClass:"mstrmojo.ui.MobileCheckList",selectionPolicy:"reselect",items:items,multiSelect:false,isElastic:true,selectedIndex:unit.idx,preselectionChange:function(evt){if(evt.added[0]===evt.removed[0]){mstrApp.closeDialog();return false;}if(this._super){return this._super(evt);}},postselectionChange:function(evt){mstrApp.closeDialog();var item=items[evt.added[0]];me.onGroupBy({groupbyKey:item.k,elementId:item.v});}}]});};if(eId&&parseInt(eId,10)!==0){this.onGroupBy({groupbyKey:gb.k,elementId:eId},{failure:showDialog},{noErrorMessage:true});}else{showDialog();}return false;}});}else{this._super(uri,action);}}}}}}},getContentDimensions:function getContentDimensions(){var dim=mstrApp.getContentDimensions();return{w:dim.w,h:dim.h};},canDelegateToolBar:function canDelegateToolBar(){if(this.hasFullScreenInfoWindow()){return false;}return this._super();},onLayoutChange:function onLayoutChange(layoutIndex){this.view.showLayout(this.view.getSupportedLayouts()[layoutIndex]);}});}());