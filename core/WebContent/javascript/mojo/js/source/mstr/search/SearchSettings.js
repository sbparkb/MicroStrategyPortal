(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.Model","mstrmojo.Container","mstrmojo.Button","mstrmojo.Label","mstrmojo.DateTextBox","mstrmojo.TextArea","mstrmojo.ui.CheckList","mstrmojo.ui.Pulldown","mstrmojo.ui.MultiSelectPulldown","mstrmojo.ui.editors.controls.TwoColumnContainer","mstrmojo._HasPopup");mstrmojo.requiresDescs(2,3,520,686,687,688,698,699,1050,5688,6013,8956,9163);var desc=mstrmojo.desc,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$V=mstrmojo.validation,$NWB=mstrmojo.Button.newWebButton;var ID;var updateModel=function(p,v,submit){if(!this.hasRendered){return ;}mstrmojo.all[ID].model.settings[p]=v;if(submit!==false){mstrmojo.all[ID].onmodelChange();}};var fnGetCheckList=function(items,cfg){cfg=cfg||{};return $HASH.copy(cfg,{scriptClass:"mstrmojo.ui.CheckList",orientation:cfg.isVertical===false?"h":"v",multiSelect:!cfg.isRadio,items:items});};var createPanel=function(title,children,alias){return new mstrmojo.Box({alias:alias,cssClass:"mstrmojo-SearchSettings-panel "+alias,cssDisplay:"inline-block",children:[{scriptClass:"mstrmojo.Label",text:title}].concat(children)});};var createDateTextBox=function(alias){var me=this;return{scriptClass:"mstrmojo.DateTextBox",alias:alias,cssDisplay:"block",cssClass:alias,width:120,required:false,calendarToBody:true,calendarZIndex:112,constraints:{trigger:$V.TRIGGER.ALL},autoFormat:false,bindings:{value:function(){return me.model.settings[alias];}},onfocus:function(){this.parent.parent.dateSubType.set("selectedIndex",1);},getSetting:function(){return{p:this.alias,v:this.value};}};};mstrmojo.mstr.search.SearchSettings=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.mstr.search.SearchSettings",visible:false,markupString:'<div class="mstrmojo-SearchSettings {@cssClass}" style="{@cssText}"><div class="mstrmojo-SearchSettings-container"></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod},onmodelChange:mstrmojo.emptyFn,init:function init(props){if(this._super){this._super(props);}ID=this.id;},postBuildRendering:function postBuildRendering(){var me=this;this.prepareObjectTypes();var selectedObjectTypes=[];this.addChildren([createPanel(desc(8956,"Object type"),{scriptClass:"mstrmojo.ui.MultiSelectPulldown",alias:"objectType",isHostedWithin:true,orientation:"v",multiSelect:true,items:$ARR.map(this.allowedObjectTypesData,function(item,idx){if($ARR.indexOf(me.model.settings.objectType,item.t)>-1){selectedObjectTypes[idx]=true;}return{n:item.d,t:item.t};}),selectedIndices:selectedObjectTypes,allIdx:-1,onselectionChanged:function(){var itms=this.items;updateModel.call(this,this.alias,$ARR.map($HASH.keyarray(this.selectedIndices),function(v){return itms[v].t;}));},onchange:function(){var itms=this.items;updateModel.call(this,this.alias,$ARR.map($HASH.keyarray(this.selectedIndices),function(v){return itms[v].t;}));},getPopupWidget:function getPopupWidget(){var w=this;this.popupWidget.onClose=function(){this.list.selectedIndices=mstrmojo.hash.copy(w.selectedIndices);this.list.refresh();};return this.popupWidget;}},"objectTypePanel"),createPanel(desc(60,"Owner"),mstrmojo.ui.Pulldown.newPulldown([{n:desc(698,"Created by any user"),v:1},{n:desc(699,"Created only by me"),v:2}],function(newItem,oldItem){if(newItem.v!==oldItem.v){updateModel.call(this,this.alias,newItem.v);}},0,{alias:"ownerType"}),"ownerPanel"),createPanel(desc(2052,"Date"),[mstrmojo.ui.Pulldown.newPulldown([{n:mstrmojo.desc(2058,"All"),v:0},{n:mstrmojo.desc(694,"Created"),v:1},{n:mstrmojo.desc(61,"Modified"),v:2}],function(newItem,oldItem){if(newItem.v!==oldItem.v){updateModel.call(this,"dateType",newItem.v===0?1:2,false);updateModel.call(this,this.alias,newItem.v,newItem.v===0);}},0,{alias:"created",cssClass:"mstrmojo-SearchSettings-date-pulldown"}),mstrmojo.Button.newIconButton(desc(5688,"Show dates"),"mstrmjo-SearchSettings-calendar",function(){this.parent.datePopup.open();},{visible:function(){var visible=this.parent.created.selectedIndex!==0;if(visible){this.parent.datePopup.open();}return visible;}},{alias:"calIcon"}),{scriptClass:"mstrmojo.ui.PopupWidget",cssClass:"mstrmojo-SearchSettings-dates-popupWidget",alias:"datePopup",visible:false,children:[{scriptClass:"mstrmojo.ui.editors.controls.TwoColumnContainer",alias:"dateContainer",cssClass:"mstrmojo-SearchSettings-dates",width:"238px",col1Width:"80px",col2Width:"130px",children:[fnGetCheckList([{n:mstrmojo.desc(4049,"Last"),v:1},{n:mstrmojo.desc(294,"Between"),v:2}],{alias:"dateSubType",isRadio:true,bindings:{selectedIndex:function(){return $ARR.find(this.items,"v",me.model.settings.dateSubType);}},postselectionChange:function(){if(this.hasRendered){if(this.selectedIndex===0){this.parent.intervalBox.intervalValue.inputNode.focus();}else{this.parent.intervalBox.startDate.inputNode.focus();}}},getSetting:function(){return{p:this.alias,v:this.items[this.selectedIndex].v};},slot:"col1Node"}),{scriptClass:"mstrmojo.Box",cssDisplay:"inline-block",alias:"intervalBox",children:[{scriptClass:"mstrmojo.TextBox",alias:"intervalValue",cssClass:"intervalValue",cssDisplay:"inline-block",size:1,maxLength:4,bindings:{value:function(){return mstrmojo.all.searchSettings.model.settings.intervalValue;}},onvalueChange:function(){},onfocus:function(){this.parent.parent.dateSubType.set("selectedIndex",0);},getSetting:function(){return{p:this.alias,v:this.value||""};}},mstrmojo.ui.Pulldown.newPulldown([{n:mstrmojo.desc(708,"Hours"),v:1},{n:mstrmojo.desc(707,"Days"),v:2},{n:mstrmojo.desc(714,"Weeks"),v:3},{n:mstrmojo.desc(710,"Months"),v:4},{n:mstrmojo.desc(709,"Years"),v:5}],function(newItem,oldItem){if(newItem.v!==oldItem.v){}},0,{alias:"intervalUnit",cssClass:"intervalUnit",cssDisplay:"inline-block",getSetting:function(){return{p:this.alias,v:this.items[this.selectedIndex].v};}}),createDateTextBox.call(this,"startDate"),createDateTextBox.call(this,"endDate")],slot:"col2Node"}]},{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-Buttons",children:[$NWB(mstrmojo.desc(1442,"Ok"),function(){var dateContainer=this.parent.parent.dateContainer,ib=dateContainer.intervalBox;var propWidgets=[dateContainer.dateSubType,ib.intervalValue,ib.intervalUnit,ib.startDate,ib.endDate];$ARR.forEach(propWidgets,function(w){var s=w.getSetting();mstrmojo.all[ID].model.settings[s.p]=s.v;mstrmojo.all[ID].onmodelChange();});this.parent.parent.close();},true,{cssDisplay:"inline-block"}),$NWB(mstrmojo.desc(2140,"Cancel"),function(){this.parent.parent.close();},false,{cssDisplay:"inline-block"})]}]}],"datepanel"),createPanel(desc(6013,"Description (contains)"),{scriptClass:"mstrmojo.TextArea",alias:"description",rows:1,bindings:{value:function(){return mstrmojo.all.searchSettings.model.settings.description;}},onvalueChange:function(){updateModel.call(this,this.alias,this.value);}},"descriptionPanel")]);if(this._super){this._super();}},prepareObjectTypes:function prepareObjectTypes(){var tps=[],names=[];this.allowedObjectTypes=this.allowedObjectTypesData.concat([]);$ARR.forEach(this.allowedObjectTypes,function(item,i){tps[i]=parseInt(item.t,10);names[tps[i]]=item.d;});if(this.allowedObjectTypes.length===0){this.model.settings.objectType=[];return ;}var aot=this.allowedObjectTypes,ot=this.model.settings.objectType;$ARR.forEach([].concat(ot),function(t){$ARR.removeItems(ot,"t",$ARR.find(aot,"t",parseInt(t,10))===-1?[t]:null);});if(ot.length===0&&!(this.isMiniSearchBox||this.isDesktopSearchBox)){ot=$ARR.map(this.allowedObjectTypes,function(o){return o.t;});}this.model.settings.objectType=ot;}});mstrmojo.mstr.search.SearchSettings.getLocationPulldown=function(cfg){var rootFolderNames=[{n:mstrApp.projectAlias||mstrConfig.projectName,v:39},{n:desc(2,"Shared Reports"),v:7},{n:desc(3,"My Reports"),v:20}],selectedIdx=0;if(cfg.rootFolderType===0){rootFolderNames.push({n:cfg.rootFolderName||"",v:0});selectedIdx=3;}else{selectedIdx=$ARR.find(rootFolderNames,"v",cfg.rootFolderType);}return mstrmojo.ui.Pulldown.newPulldown(rootFolderNames,function onChange(newItem,oldItem){if(newItem.v!==oldItem.v){updateModel.call(this,"rootFolderType",newItem.v);}},selectedIdx,mstrmojo.hash.copy(cfg,{cssDisplay:"inline-block"}));};mstrmojo.mstr.search.SearchSettings.getSearchTypePulldown=function(cfg){return mstrmojo.ui.Pulldown.newPulldown([{n:desc(686,"Contains"),v:cfg.qse?16:1},{n:desc(520,"Exactly"),v:2},{n:desc(687,"Begins With"),v:4},{n:desc(688,"Ends with"),v:8}],function onChange(newItem,oldItem){if(newItem.v!==oldItem.v){updateModel.call(this,"nameWildcards",newItem.v);}},0,mstrmojo.hash.copy(cfg,{cssDisplay:"inline-block",cssClass:"searchType"}));};}());