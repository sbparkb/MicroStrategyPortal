(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css");var commonProps={T:["top","left"],D:["height","width"],B:["border","border-color","border-style","border-width"],F:["font","color","text-decoration"],P:["padding"],BG:["background-color","fx"],RW:[]};commonProps.RW=["z-index"].concat(commonProps.T.concat(commonProps.D));var $DOM=mstrmojo.dom,$CSS=mstrmojo.css;function pushFxProperty(fx,n,v){var p=fx[n]||[];p.push(v);fx[n]=p;}function getFormat(defn,thresholdId){var fmts=((defn&&defn.fmts)||null);if(thresholdId){var ts=defn.thresholds,tFmts=ts&&ts[thresholdId];if(tFmts){var fx={},p;for(p in fmts){fx[p]=tFmts[p]||fmts[p];}for(p in tFmts){var formatValue=tFmts[p];fx[p]=(typeof formatValue==="string")?(formatValue+" !important"):formatValue;}fmts=fx;}}return fmts;}mstrmojo._Formattable=mstrmojo.provide("mstrmojo._Formattable",{_mixinName:"mstrmojo._Formattable",formatHandlers:null,thresholdId:null,getCacheKey:function getCacheKey(){return"css_cache"+(this.thresholdId||"");},update:function update(node){var continueUpdate=true;this.invisible=!!(node&&node.data&&node.data.invisible);if(this._super){continueUpdate=this._super(node);}return continueUpdate;},buildCSSFormatString:function buildCSSFormatString(slotName,formats){var slot=this.formatHandlers[slotName],formatSource=slot.src?formats[slot.src]:formats;if(!formatSource){return null;}var props=slot.props||slot;if(!props){return null;}var css=[],x=-1;var propertyIdx=props.length-1;for(propertyIdx;propertyIdx>=0;propertyIdx--){var property=props[propertyIdx];var propsCollection=commonProps[property]||[property];var z=propsCollection.length-1;for(z;z>=0;z--){property=propsCollection[z];var propertyValue=formatSource[property];if(propertyValue!==undefined){if(property==="fx"){var f=propertyValue,fx={};var gradient=f.gd;if(gradient){this.formatGradient(gradient,fx);}var textRotation=parseInt(f.rt,10);if(textRotation){if(textRotation===1||textRotation===3){this.formatTextRotation(f.rt,fx);}}if(f.ds){this.formatDropShadow(f,fx);}var fp;for(fp in fx){css[++x]=fp+":"+fx[fp].join(" ");}}else{css[++x]=property+":"+propertyValue;}}}}if(this.invisible){css.push("visibility:hidden");}return css.join(";")+";";},applyCSSFormatToNode:function applyCSSFormatToNode(slotName,formats){var node=this[slotName],nodeStyle=node&&node.style;if(nodeStyle){this.buildCSSFormatString(slotName,formats).split(";").forEach(function(item){var parts=item.split(":");nodeStyle[$CSS.convertCssToCamelCase(parts[0])]=parts[1];});}},clearSlotBackgroundCSS:function clearSlotBackgroundCSS(slotName){var node=this[slotName],nodeStyle=node&&node.style;if(nodeStyle){nodeStyle.background="transparent none 0 0 no-repeat";nodeStyle.filter="none";}},preBuildRendering:function preBuildRendering(){this._super();var formatHandlers=this.formatHandlers,formats=this.getFormats();if(formatHandlers&&formats){var defn=this.defn=this.defn||{},cacheKey=this.getCacheKey(),cache=defn[cacheKey];if(!cache){cache=defn[cacheKey]={};for(var slotName in formatHandlers){var slotCss=slotName+"CssText";this[slotCss]=cache[slotCss]=this.buildCSSFormatString(slotName,formats)||"";}}else{var n;for(n in cache){this[n]=cache[n];}}}return true;},formatGradient:function formatGradient(gp,fx){var gd=$CSS.buildGradient(gp.t,gp.sc,gp.ec);if(gd){pushFxProperty(fx,gd.n,gd.v);}},formatDropShadow:function formatDropShadow(f,fx){if($DOM.supports($DOM.cssFeatures.DROP_SHADOW)){var ds=f.ds;if($DOM.isDXIE){pushFxProperty(fx,"filter","progid:DXImageTransform.Microsoft.DropShadow(Color='#66000000',Positive='true',OffX="+ds+",OffY="+ds+")");}else{var v=[ds,ds],rotation=parseInt(f.rt,10);if(rotation===1||rotation===3){v[((rotation===1)?1:0)]=-ds;}pushFxProperty(fx,($DOM.isWK?"-webkit-":"")+"box-shadow",v.join("px ")+"px 3px 0px #888");}}},formatTextRotation:function formatTextRotation(tr,fx){if($DOM.supports($DOM.cssFeatures.TEXT_ROTATION)){if($DOM.isDXIE){pushFxProperty(fx,"filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+tr+")");}else{var degrees=(tr===1)?90:-90;pushFxProperty(fx,$DOM.CSS3_PREFIX+"transform-origin","top left");pushFxProperty(fx,$DOM.CSS3_PREFIX+"transform","rotate("+degrees+"deg)");}}},getFormats:function getFormats(){if(!this.fmts){this.fmts=getFormat.call(this,this.defn,this.thresholdId);}return this.fmts;},clearFormats:function clearFormats(){this.fmts=undefined;},createEmptyFormats:function(){return(this.fmts=this.fmts||{});},clearCache:function clearCache(){delete this.defn[this.getCacheKey()];},unrender:function unrender(ignoreDom){if(this.thresholdId){this.fmts=null;}this._super(ignoreDom);}});mstrmojo._Formattable.getBorderWidths=function(widget){var f=widget.getFormats(),b=(f.border)?f.border.match(/(\d*|\d*\.\d*)pt/)[0]:f["border-width"],model=widget.model,docModel=model.docModel;return $CSS.getBorderWidths(b,(docModel&&docModel.dpi)||model.dpi);};}());