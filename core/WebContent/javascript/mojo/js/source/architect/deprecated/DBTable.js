(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.Label","mstrmojo.architect.DBTableRow","mstrmojo.css","mstrmojo.dom","mstrmojo.array","mstrmojo.hash");var $D=mstrmojo.dom,$CSS=mstrmojo.css,$A=mstrmojo.array,$H=mstrmojo.hash;var MAXHEIGHT=300;function setPosition(w,vl,vt){var st=w.editorNode.style;vl=(vl<0)?0:vl+"px";vt=(vt<0)?0:vt+"px";st.left=vl;w.set("left",vl);w.left=vl;st.top=vt;w.set("top",vt);w.top=vt;}function updateRows(){var rows=this.Rows.children,selectedIndices=this.selectedIndex;$A.forEach(rows,function(row,i){$CSS.toggleClass(row.domNode,["selected"],!!selectedIndices[i]);});}function clearSelections(){$A.forEach(this.selectedIndex,function(selected){selected=false;});}function addEmptyTableMessage(){var rowContainer=this.Rows;rowContainer.addChildren([{scriptClass:"mstrmojo.Label",text:"No elements to display in the current table",cssClass:"mstrmojo-architect-emptyDBTableMsg"}]);}function hideContextButtons(){var st=mstrmojo.all.CtxMnuBtn.domNode.style;if(st.visibility==="visible"){st.top="0px";st.visibility="hidden";}}function showContextButton(evt,src){var elem=$D.eventTarget(window,evt.e),w=$D.findWidget(elem),cmb=mstrmojo.all.CtxMnuBtn,st=cmb.domNode.style;if(cmb._subMenu&&cmb._subMenu.visible===true){cmb.closeMenuTree();}if(w.Rows||w.Obj||w.items){cmb.data=w;var n=w.Rows?w.editorNode:w.domNode,p=$D.position(n),p2=$D.position(src.domNode),tp=p.y-p2.y,el=Math.floor((evt.e.clientY-p2.y-tp)/15),lf=p.x-p2.x+n.clientWidth-25;if(w.Rows||w.Obj){tp=tp+2;}else{tp=tp+(el*15);cmb.data=w.items[el];}st.left=lf+"px";st.top=tp+"px";st.visibility="visible";}else{hideContextButtons();}}mstrmojo.architect.DBTable=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.architect.DBTable",cssClass:"mstrmojo-architect-DBTable",minWidth:80,maxWidth:250,maxHeight:300,minHeight:20,model:null,prevPos:{},container:null,selectedIndex:[],noCheckBox:true,modal:false,markupString:'<div id="{@id}" class="mstrmojo-Editor-wrapper"><div class="mstrmojo-Editor {@cssClass}" style="z-index:{@zIndex};{@cssText}" mstrAttach:mouseover,mousedown,mouseup,click><div style="position:absolute;height: 20px;width:100%;"><table cellspacing="0" cellpadding="0" class="mstrmojo-qb-DBTable-titlebar"><tr><td><input id="{@id}check" type="checkbox" mstrAttach:click></td><td class="mstrmojo-Editor-titleCell"><div id="{@id}title" class="mstrmojo-qb-DBTable-title"  mstrAttach:dblclick></div></td><td><div class="mstrmojo-Editor-close" style="display:none;"></div></td><td><div class="mstrmojo-Editor-close" style="display:none;"></div></td></tr></table></div><div class="mstrmojo-Editor-titleSpacer"></div>{@titlebarHTML}<div class="mstrmojo-Editor-content" style="overflow-x:hidden; overflow-y:auto; padding:0px;"></div><div class="mstrmojo-qb-table-resize-handle north" id="{@id}north" ></div><div class="mstrmojo-qb-table-resize-handle east" id="{@id}east"></div><div class="mstrmojo-qb-table-resize-handle south" id="{@id}south"></div><div class="mstrmojo-qb-table-resize-handle west" id="{@id}west"></div></div></div>',titleMarkupString:"",children:[{scriptClass:"mstrmojo.Box",alias:"Rows",cssText:"width:100%; background-color:white; border: 1px solid #C6C6C6; height:100%;white-space: nowrap;"},{scriptClass:"mstrmojo.QB.QContextMenu",alias:"tableMenu",zIndex:40,itemField:"ItmCss",cssText:"visibility:hidden; border:0px solid; background-color:transparent;",searchItemAdded:true,dynamicUpdate:true}],markupSlots:{editorNode:function editorNode(){return this.domNode.firstChild;},titlebarNode:function titlebarNode(){return this.showTitle?this.domNode.firstChild.firstChild.firstChild:null;},checkBoxNode:function checkBoxNode(){return this.showTitle?this.domNode.firstChild.firstChild.firstChild.rows[0].cells[0].firstChild:null;},titleNode:function titleNode(){return this.showTitle?this.domNode.firstChild.firstChild.firstChild.rows[0].cells[1].firstChild:null;},helpNode:function helpNode(){return this.showTitle?this.domNode.firstChild.firstChild.firstChild.rows[0].cells[3].firstChild:null;},closeNode:function closeNode(){return this.showTitle?this.domNode.firstChild.firstChild.firstChild.rows[0].cells[2].firstChild:null;},containerNode:function containerNode(){return this.domNode.firstChild.childNodes[2];},buttonNode:function buttonNode(){return this.domNode.firstChild.childNodes[3];},curtainNode:function curtainNode(){return this.domNode.lastChild;}},touchBegin:function touchBegin(touch){var s=this.editorNode.style;this._tl=parseInt(s.left,10);this._tt=parseInt(s.top,10);},touchSwipeMove:function touchSwipeBegin(touch){setPosition(this,touch.delta.x+this._tl,touch.delta.y+this._tt);},onmouseover:function(evt){showContextButton(evt,this);},onmousedown:function onmousedown(evt){this.editorNode.style.zIndex=35;hideContextButtons();},onmouseup:function onmouseup(evt){this.editorNode.style.zIndex=10;},toggleSelect:function toggleSelect(idx){this.selectedIndex[idx]=!this.selectedIndex[idx];updateRows.call(this);},rangeSelect:mstrmojo.emptyFn,singleSelect:function singleSelect(idx){clearSelections.call(this);this.selectedIndex[idx]=true;updateRows.call(this);},clearSelect:function clearSelect(){clearSelections.call(this);updateRows.call(this);},addRow:function addRow(level,tp,idx,Obj,Info,tbl,k){var row=mstrmojo.insert({scriptClass:"mstrmojo.architect.DBTableRow",did:Obj.id,n:Obj.name,tp:tp,display:"block",indent:level,rIndex:idx,Obj:Obj,Info:Info,tbl:tbl,cmid:Info.ClnID,DT:Info.Format,text:Obj.name,cssClass:(idx%2)?"odd":"even"});if(tp===12){var baseForms=tbl.AttrInfos[Obj.id].BaseFrms,expressions=Info.Expr;row.FrmNo=baseForms[0];row.EXP=expressions[0];row.supportsubItems=true;if(baseForms.length>1){var formItems=[],forms=Obj.Forms;$A.forEach(baseForms,function(formNumber,idx){formItems.push({n:[expressions[idx],"@",forms[formNumber].n].join(""),EXP:expressions[idx],FrmNo:idx,tbl:tbl,nfo:Info,did:Info.AttID,tp:12,parent:row});});row.indent=0;row.set("rowItems",formItems);}if(Info.isLookUp&&row.FrmNo===0){row.text="<b>"+row.text+"<b>";}}if(tp===13){row.EXP=Info.Expr;}this.Rows.addChildren([row]);},renderTable:function renderTable(){var rowContainer=this.Rows,model=mstrmojo.all.ArchModel;if(rowContainer.children&&rowContainer.children.length>0){rowContainer.removeChildren();}var tableData=this.tbl,attInfos=tableData.AttrInfos,factInfos=tableData.FactInfos,idx=0,attrID,factID,isEmpty=true;for(attrID in attInfos){this.addRow(1,12,idx++,model.getAttribute(attrID),attInfos[attrID],tableData);isEmpty=false;}for(factID in factInfos){this.addRow(1,13,idx++,model.getFact(factID),factInfos[factID],tableData);isEmpty=false;}if(isEmpty){addEmptyTableMessage.call(this);}this.maxHeight=Math.min(MAXHEIGHT,this.editorNode.clientHeight);if(this.editorNode.clientHeight>this.maxHeight){this.containerNode.style.height=this.maxHeight-20+"px";}},onclick:function onclick(evt){var hWin=evt.hWin,e=evt.e||hWin.event,tgt=e.target||e.srcElement,el=document.elementFromPoint(e.clientX,e.clientY),id=tgt&&tgt.id;if(id.replace(this.id,"")==="check"){if(this.onCheck){this.onCheck(tgt.checked);}}var w=$D.findWidget(el);if(!w||!w.Obj){this.clearSelect();return ;}if(tgt.className.indexOf("tlink")>-1){var targetPosition=$D.position(tgt),OFFSET=10,$this=this,cb={success:function success(res){var tmenu=$this.tableMenu,menuInfo=[];tmenu.getMenuPosition=function getMenuPosition(){return{x:targetPosition.x+OFFSET,y:targetPosition.y+OFFSET};};delete tmenu._subMenu;$A.forEach(res,function(tableInfo){if(typeof tableInfo==="string"){tableInfo={did:tableInfo};}if(tableInfo&&tableInfo.n){menuInfo.push($H.copy(tableInfo,{ItmCss:'<span class="mstrmojo-ArchitectListIcon t15" style="padding-left:20px;">'+tableInfo.n+"</span>"}));}});tmenu.cm=menuInfo;tmenu.showContextMenu();w.Obj.tbls=menuInfo;}};if(w.Obj.tbls.length>0){cb.success(w.Obj.tbls);}else{mstrmojo.all.ArchModel.getTbl4Obj([w.Obj.id+",12"],cb);}return ;}if(tgt.className.indexOf("mstrmojo-architect-DBTableRow-state")>-1){$CSS.toggleClass(w.domNode,"showForm",(w.Info.showForm=!w.Info.showForm));return ;}var idx=w.rIndex,c=$D.ctrlKey(hWin,e),s=$D.shiftKey(hWin,e);if(c||s){$D.clearBrowserHighlights(hWin);}if(c){this.toggleSelect(idx);}else{this.singleSelect(idx);}},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}if(this.noCheckBox){this.checkBoxNode.style.display="none";}if(this.titleNode){this.titleNode.style.width=this.titleNode.clientWidth-20+"px";}},getDragData:function getDragData(ctxt){var s=ctxt.src,n=s.node,id=n.id;if(id){var shouldReturnDragData={north:true,east:true,south:true,west:true}[id.replace(this.id,"")];if(shouldReturnDragData){return{dir:id.replace(this.id,""),startX:s.pos.x,startY:s.pos.y};}}else{if(this._super){return this.dropZone&&this._super(ctxt);}}return null;},ondragstart:function ondragstart(ctxt){var s=ctxt.src,d=s&&s.data,dir=d&&d.dir;if(dir){this.prevPos={x:s.pos.x,y:s.pos.y};return true;}if(this._super){return this._super(ctxt);}},ondragmove:function ondragmove(ctxt){var s=ctxt.src,d=s&&s.data,dir=d&&d.dir,tgt=ctxt.tgt,st=this.editorNode.style,dx,dy;if(dir){switch(dir){case"north":case"south":dy=(tgt.pos.y-this.prevPos.y)*(dir==="north"?1:-1);this.prevPos=tgt.pos;var editorHeight=this.editorNode.clientHeight,deltaHeight=editorHeight-dy;if(deltaHeight>=this.minHeight&&deltaHeight<=this.maxHeight){this.containerNode.style["overflow-y"]="auto";if(dir==="north"){st.top=parseInt(st.top,10)+dy+"px";}st.height=deltaHeight+"px";this.containerNode.style.height=editorHeight-this.titlebarNode.clientHeight+"px";}else{this.containerNode.style["overflow-y"]="hidden";}break;case"east":case"west":var offset=this.noCheckBox?39:59;dx=(tgt.pos.x-this.prevPos.x)*((dir==="east")?1:-1);this.prevPos=tgt.pos;var editorWidth=parseInt(st.width,10),deltaWidth=editorWidth+dx;if(deltaWidth>=this.minWidth&&deltaWidth<=this.maxWidth){if(dir==="west"){st.left=parseInt(st.left,10)-dx+"px";}st.width=editorWidth+dx+"px";this.titleNode.style.width=editorWidth-offset+"px";this.titlebarNode.style.width=editorWidth+"px";}break;}}else{var targetPosition=ctxt.tgt.pos,srcPosition=ctxt.src.pos,movingTgtStyle=this.getMovingTarget().style;movingTgtStyle.left=Math.max(this._leftPos+targetPosition.x-srcPosition.x,0)+"px";movingTgtStyle.top=Math.max(this._topPos+targetPosition.y-srcPosition.y,0)+"px";}},ondragend:function(ctxt){var l=this.editorNode.offsetLeft+"px",t=this.editorNode.offsetTop+"px";this.top=t;this.left=l;mstrApp.getRootController().getCurrentLayer().updateTableInfo(this.tbl,{x:l,y:t,h:getObjHeight(this.editorNode)+"px",w:getObjWidth(this.editorNode)+"px"});},_set_height:function _set_height(n,value){if(this.editorNode&&parseInt(value,10)>this.titlebarNode.clientHeight){var st=this.editorNode.style;st.height=parseInt(value,10)+"px";this.containerNode.style.height=parseInt(st.height,10)-this.titlebarNode.clientHeight+"px";}}});}());