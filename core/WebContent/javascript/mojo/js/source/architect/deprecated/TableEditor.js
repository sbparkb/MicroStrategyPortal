(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.Label","mstrmojo._HasContextMenu","mstrmojo.warehouse.MenuButton","mstrmojo.architect.NameEditor");var $D=mstrmojo.dom,activeMenuItem,TableEditorActions={NoAction:0,ConvertAttributeToFact:1,ConvertAttributeToForm:2,ConvertFactToAttribute:3,RemoveAttribute:4,RemoveFact:5,SetAsLookUp:6,RenameAttribute:7,RenameFact:8,AddAttribute:9,RemoveAttributeInfo:10,AddFact:11,RemoveFactInfo:12,UpdateFormat:13},_formats=[{n:"Text",did:"tp"},{n:"Number",did:"tp"},{n:"Date",did:"tp"},{n:"Time",did:"tp"},{n:"DateTime",did:"tp"},{n:"URL",did:"tp"},{n:"Email",did:"tp"},{n:"HTML Tag",did:"tp"},{n:"Symbol",did:"tp"},{n:"Big Decimal",did:"tp"},{n:"Phone Number",did:"tp"}];function getGUIRow(o1,o2,tp,its,idx){switch(tp){case 12:var frmNo=null,str="";if(typeof idx==="number"){frmNo=o2.BaseFrms[idx];}if(mstrmojo.array.find(its,"did",o2.id)>-1&&frmNo===0){str='<span class="mstrmojo-ArchitectToolbarIcon link" style="float: right;"><span>';}var FrmName=o1.Forms[frmNo].n,FrmCatID=o1.Forms[frmNo].fmcatid,fn=o1.name+((FrmName==="ID")?str:("@"+FrmName+" Form"));return{did:o2.id,inUse:true,TP:12,OID:o2.id,dirty:true,EXP:o2.Expr[idx],AL:fn,ORAL:o1.name,FRMName:FrmName,FRMCatID:FrmCatID,FRMNo:frmNo,DT:o2.Format,LKUP:false,cmid:o2.ClnID};case 13:return{TP:13,did:o2.id,dirty:true,EXP:o2.Expr,AL:o1.name,ORAL:o1.name,DT:o2.Format,TBL:o1.tbls,Sum:o1.Sum,Count:o1.Count,Max:o1.Max,Min:o1.Min,Variance:o1.Variance,Average:o1.Average,cmid:o2.ClnID};}}function hideContextButtons(){var st=mstrmojo.all.CtxMnuBtn.domNode.style;if(st.visibility==="visible"){st.top="0px";st.visibility="hidden";}}function showContextButton(evt,src){var elem=$D.eventTarget(window,evt.e),cmb=mstrmojo.all.CtxMnuBtn,st=cmb.domNode.style;var n,p,p2,tp,lf;if(cmb._subMenu&&cmb._subMenu.visible===true){cmb.closeMenuTree();}if(elem.innerText==="Expression"){p=$D.position(elem);p2=$D.position(src.domNode);tp=p.y-p2.y;lf=p.x-p2.x+elem.clientWidth-25;cmb.data={ttl:true};st.left=lf+"px";st.top=tp+"px";st.visibility="visible";}else{var node=elem.childNodes?elem.childNodes[0]:elem,w=$D.findWidget(node);if(w&&w.slot==="slot1"){cmb.data=w.data;src.tIdx=w.idx;n=w.domNode;p=$D.position(n);p2=$D.position(src.domNode);tp=p.y-p2.y;lf=p.x-p2.x+n.clientWidth-25;st.left=lf+"px";st.top=tp+"px";st.visibility="visible";}else{hideContextButtons();}}}function performGUIAction(evt,grid,ele,res){var mdl=mstrmojo.all.ArchModel;switch(evt){case TableEditorActions.ConvertAttributeToFact:case TableEditorActions.AddFact:case TableEditorActions.ConvertFactToAttribute:case TableEditorActions.AddAttribute:case TableEditorActions.ConvertAttributeToForm:mdl.raiseEvent({name:"refreshGrid"});break;case TableEditorActions.SetAsLookUp:ele.dirty=true;ele.LKUP=true;grid.render();break;case TableEditorActions.RemoveAttribute:case TableEditorActions.RemoveAttributeInfo:case TableEditorActions.RemoveFact:case TableEditorActions.RemoveFactInfo:grid.items.splice(grid.tIdx,1);grid.render();break;case TableEditorActions.RenameAttribute:case TableEditorActions.RenameFact:ele.AL=ele.nn;delete ele.nn;grid.render();break;}}function processAction(evt,data){var mdl=mstrmojo.all.ArchModel;if(!mdl.SchemaInstanceID){return ;}var src=mstrmojo.all.aflist,ele=src.items[src.tIdx],col,tid=mdl.SelTableID,cb;if(data){col={cln:data.cln,did:data.cmid};}var mnret={success:function(res){performGUIAction(evt,src,ele,res);}};switch(evt){case TableEditorActions.NoAction:break;case TableEditorActions.UpdateFormat:var fmt=mdl.getDataTypeValue(ele.DT);mdl.updateAttributeForm(ele.did,ele.FRMCatID,ele.cmid,ele.EXP,tid,null,null,null,fmt,1,1,ele.FrmName,null,mnret);break;case TableEditorActions.ConvertAttributeToFact:cb={success:function(res){if(!res){mdl.convertAttributeToFact(ele.FRMNo,ele,res,mnret);}}};mdl.findObjectByName(ele.ORAL,13,cb);break;case TableEditorActions.ConvertAttributeToForm:var deret={success:function(res){ele.did="";var aid=ele.att.AttID,att=mdl.getAttribute(aid),deret2={success:function(res){ele.FRMNo=res;ele.did=aid;mdl.addAttributeInfo(res,aid,ele.EXP,ele.cmid,tid,mnret);}};mdl.addNextAvailableForm(att,ele,deret2);}};mdl.removeAttributeInfo(ele.FRMNo,ele.did,tid,deret);break;case TableEditorActions.ConvertFactToAttribute:cb={success:function(res){var fmt=mdl.getDataTypeValue(ele.DT);if(!res){mdl.convertFactToAttribute(ele,res,fmt,1,1,"ID",mnret);}}};mdl.findObjectByName(ele.ORAL,12,cb);break;case TableEditorActions.RemoveAttribute:mdl.deleteObject(ele.TP,ele.did,mnret);break;case TableEditorActions.RemoveFact:mdl.deleteObject(ele.TP,ele.did,mnret);break;case TableEditorActions.SetAsLookUp:mdl.setAsLookUp(ele.did,ele.FRMNo,tid,mnret);break;case TableEditorActions.RenameFact:cb={success:function(res){rn.close();mnret.success();},failure:function(res){rn.error.set("text",res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.renameObject(ele.did,13,ele.nn,true,cb);break;case TableEditorActions.RenameAttribute:cb={success:function(res){rn.close();mnret.success();},failure:function(res){rn.error.set("text",res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.renameObject(ele.did,12,ele.nn,true,cb);break;case TableEditorActions.AddAttribute:var cbattr={success:function(res){var aid=res.did;mdl.aIdx=1;var formcb={success:function(res){mdl.addAttributeInfo(0,aid,"["+col.cln+"]",col.did,tid,mnret);}};mdl.addAttributeForm(aid,mdl.IDFormID,0,col.did,"["+col.cln+"]",tid,null,null,null,mdl.EnumDSSBaseFormType.DssBaseFormText,1,1,"ID",null,formcb);},failure:function(res){if(res.getResponseHeader("X-MSTR-TaskFailureMsg").indexOf("The schema already contains a Attribute object with name")>0){mdl.createObject(12,col.cln+"("+mdl.aIdx+")",col.did,cbattr);mdl.aIdx++;}}};mdl.aIdx=1;mdl.createObject(12,col.cln,col.did,cbattr);break;case TableEditorActions.RemoveAttributeInfo:mdl.removeAttributeInfo(ele.FRMNo,ele.did,tid,mnret);break;case TableEditorActions.AddFact:var cbfact={success:function(res){var fid=res.did;mdl.fIdx=1;mdl.addFactInfo(fid,"["+col.cln+"]",col.did,tid,mnret);},failure:function(res){if(res.getResponseHeader("X-MSTR-TaskFailureMsg").indexOf("The schema already contains a Fact object with name")>0){mdl.createObject(13,col.cln+"("+mdl.fIdx+")",col.did,cbfact);mdl.fIdx++;}}};mdl.fIdx=1;mdl.createObject(13,col.cln,col.did,cbfact);break;case TableEditorActions.RemoveFactInfo:mdl.removeFactInfo(ele.did,tid,mnret);break;}}var _menuItems=[{did:"NewAttr",n:"New Attribute"},{did:"NewFct",n:"New Metric"},{did:"Edit",n:"Edit"},{did:"Delete",n:"Delete"},{did:"RmvTbl",n:"Remove from Table"},{did:"Rename",n:"Rename"},{did:"ToAttr",n:"ToAttribute"},{did:"ToMetric",n:"ToMetric"},{did:-1,n:"-"},{did:"LookUp",n:"Set as LookUp"},{did:"Form",n:"Set as Form ",fns:[{did:"1",n:"1"}],onContextMenuOpen:function(){var va=[],lCounter=0,grid=mstrmojo.all.aflist,its=grid.items,ele=its[grid.tIdx],lc,len;for(lc=0,len=its.length;lc<len;lc++){var o=its[lc];if(o.TP===12&&o.did!==ele.OID&&o.FRMNo===0){va[lCounter++]={did:"Form",n:o.ORAL,AttID:o.OID,idx:lc};}}if(this._subMenu){var sm=this._subMenu;sm.set("items",va);}}},{did:"Agg",n:"Aggregation",fns:[{did:"Sum",n:"Sum"},{did:"Count",n:"Count"},{did:"Max",n:"Max"},{did:"Min",n:"Min"},{did:"Variance",n:"Variance"},{did:"Average",n:"Avg"}],onContextMenuClose:function(){var cxt=mstrmojo.all.CtxMnuBtn;if(cxt.onexec){this.showContextMenu();cxt.activeMenuItem=activeMenuItem;}}},{did:"Dtp",n:"Data Type",fns:_formats}];var rn=new mstrmojo.architect.NameEditor({onOK:function(evt){var aflst=mstrmojo.all.aflist;aflst.items[aflst.tIdx].nn=this.txtbox.value;processAction(this.evt);},onOpen:function(){this.txtbox.set("value",this.n);this.error.set("text","");this.txtbox.domNode.focus();this.txtbox.domNode.select();this.set("title",(this.tp===12?"Attribute: ":"Fact: ")+this.n);this.evt=(this.tp===12?TableEditorActions.RenameAttribute:TableEditorActions.RenameFact);}});var MnuBtn={scriptClass:"mstrmojo.warehouse.MenuButton",id:"CtxMnuBtn",queryVisible:function(item){var d=this.data;switch(item.did){case"Dtp":return d.TP===12;case"ToMetric":case"LookUp":case"Form":return d.TP===12&&d.did!==""&&d.FRMNo===0;case"ToAttr":case"Agg":return d.TP===13;case"NewAttr":case"NewFct":return d.ttl;case"Edit":case"RmvTbl":case"Delete":return d.TP;case"Rename":return d.TP&&(!d.FRMNo>0);default:return true;}},queryChecked:function queryChecked(item){return this.data[item.did]||(this.data.DT===item.n);},executeCommand:function(item){var mdl=mstrmojo.all.ArchModel,aflst=mstrmojo.all.aflist,idx=aflst.tIdx,tp;this.domNode.style.visibility="hidden";switch(item.did){case"NewAttr":if(!mdl.SelTableID){alert("You have to select one project table first!");return ;}mdl.exprEditor({TP:12});break;case"NewFct":if(!mdl.SelTableID){alert("You have to select one project table first!");return ;}mdl.exprEditor({TP:13});break;case"Edit":var obj=this.data;obj.idx=idx;mdl.exprEditor(obj);break;case"Delete":if(this.data.TP===12){tp=TableEditorActions.RemoveAttribute;}else{tp=TableEditorActions.RemoveFact;}processAction(tp);break;case"RmvTbl":if(this.data.TP===12){tp=TableEditorActions.RemoveAttributeInfo;}else{tp=TableEditorActions.RemoveFactInfo;}processAction(tp);break;case"Rename":rn.tp=this.data.TP;rn.n=this.data.AL;rn.open();break;case"ToAttr":processAction(TableEditorActions.ConvertFactToAttribute);break;case"ToMetric":processAction(TableEditorActions.ConvertAttributeToFact);break;case"LookUp":processAction(TableEditorActions.SetAsLookUp);break;case"Form":aflst.items[idx].att=item;processAction(TableEditorActions.ConvertAttributeToForm);break;case"tp":aflst.items[idx].DT=item.n;processAction(TableEditorActions.UpdateFormat);break;default:this.domNode.style.visibility="visible";this.onexec=true;activeMenuItem=this.activeMenuItem;var ele=aflst.items[idx],fct=mdl.getFact(this.data.did);if(ele[item.did]){ele[item.did]=false;fct[item.did]=false;}else{ele[item.did]=true;fct[item.did]=true;}break;}},postCreate:function(){this.cm=_menuItems;}};var DataGrid={scriptClass:"mstrmojo.DataGrid",id:"aflist",cssClass:"mstrmojo-Architect-ColumnMapping-Headline",cssText:"background-color:white;overflow-y:auto; height:100%;width:100%;cursor:pointer;",alias:"aflist",itemDisplayField:50,multiSelect:true,draggable:true,markupString:'<div id="{@id}" class="mstrmojo-DataGrid {@cssClass}" style="{@cssText}" mstrAttach:click,mousemove><div class="mstrmojo-DataGrid-headerContainer">{@headerHtml}</div><div class="mstrmojo-DataGrid-itemsScrollBox"><div class="mstrmojo-DataGrid-itemsContainer" style="{@itemsContainerCssText}" >{@itemsHtml}</div><div class="mstrmojo-ListBase2-dropCue"><div class="mstrmojo-ListBase2-dropCue-inner" mstrAttach:mouseover></div></div></div></div>',onmousemove:function(evt){showContextButton(evt,this);},itemFunction:function(item,idx,w){var c=new mstrmojo.DataRow({columns:w.columns,data:item,idx:idx,dataGrid:w,draggable:true,cssClass:"mstrmojo-di-datapreview-DataRow-text",buildDom:function(){this.children=[];var ph=document.createElement("tr"),d=this.data,idx=this.idx,dataGrid=this.dataGrid,css=this.cssClass+(d.TP===12?" Attribute":" Metric"),cls=this.columns,ch=this.children,its=dataGrid.items,td,cn=-1,cl,w,i,len;ph.setAttribute("id",this.id);if(dataGrid.banding){if(idx===0){this.even=true;}else{var prv=dataGrid.ctxtBuilder.itemWidgets[idx-1];if(d.FRMNo>0){this.even=prv.even;}else{this.even=!prv.even;}}css+=(this.even)?" even":" odd";}ph.className=css;for(i=0,len=cls.length;i<len;i++){cl=cls[i];w=cl.dataWidget;td=document.createElement("td");if(idx<its.length-1&&its[idx+1].FRMNo>0){td.style["border-bottom"]="none";}ph.appendChild(td);td.setAttribute("w","1");cn++;ch.push(mstrmojo.hash.copy(w,{slot:"slot"+cn,data:d,idx:idx,dataGrid:dataGrid}));}this.initChildren();return ph;},dropZone:true,allowDrop:function allowDrop(c){return true;},ondrop:function(c){var srcw=c.src.widget,d=srcw.data,mdl=mstrmojo.all.ArchModel;if(srcw.parent&&srcw.parent.parent&&srcw.parent.parent.alias==="elemBox"){mdl.handleDropfromRelation(c);}if(d.t===26){mdl.addHeterogenousExpr(srcw,c.tgt.widget);}},ondragstart:function(ctxt){w.inDrag=true;return true;},ondragend:function(ctxt){w.inDrag=false;},getDragData:function getDragData(ctxt){var w=ctxt.src.widget;if(w&&w.data){w.data.html='<span class="mstrmojo-ArchitectJoinList t'+w.data.TP+'" style="width:80px;background-color:white;padding:2px 0px 0px 20px;">'+w.data.ORAL+"</span>";return w.data;}}});return c;},processAction:function(evt){var e=TableEditorActions[evt.name],data=evt;processAction(e,data);},columns:[{dataWidget:{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-Architect-Objname",postCreate:function(){var d=this.data,css=(d.TP===12?" Attribute":" Metric");this.cssClass+=css;if(d.LKUP){this.cssText="font-weight:bold;";}else{this.cssText="font-weight:normal;";}this.set("text",d.AL);}},headerText:"Object Name",colCss:"uidCol",colWidth:"85"},{dataWidget:{scriptClass:"mstrmojo.Label",cssText:"font-weight:bold;",postCreate:function(){var d=this.data;if(d.LKUP){this.cssText="font-weight:bold;";}else{this.cssText="font-weight:normal;";}this.set("text",d.EXP);}},dataField:"EXP",headerText:"Expression",colCss:"uidCol",colWidth:"85"}],onclick:function clk(evt){var s=this.listSelector;if(s&&!this.inDrag){s.premousedown(this,this.itemsContainerNode,evt);s.premouseup(this,this.itemsContainerNode,evt);}},attachMousedownEvent:function attachMousedownEvent(){var me=this;me.evtAttached=true;if(!this._clearSelect){this._clearSelect=function(){var onGrid=$D.contains(me.domNode,$D.eventTarget(self,arguments[0]),false,document.body);if(!onGrid&&me.selectedIndex>-1){me.set("selectedIndex",-1);$D.detachEvent(document.body,"mousedown",this._clearSelect);me.evtAttached=false;}};}$D.attachEvent(document.body,"mousedown",this._clearSelect);},onchange:function(evt){if(this._super){this._super();}var mdl=mstrmojo.all.ArchModel,it=this.items[this.selectedIndex];if(!it){mdl.set("SelAttrID",null);}else{if(it.TP===12){mdl.set("SelAttrID",it.did);if(!this.evtAttached){this.attachMousedownEvent();}}}}};mstrmojo.architect.TableEditor=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasContextMenu],{scriptClass:"mstrmojo.architect.TableEditor",children:[DataGrid,MnuBtn],populateEditor:function(evt){var mdl=mstrmojo.all.ArchModel,af=mstrmojo.all.aflist,k,len;if(evt&&evt.items){af.jitems=evt.items;}this.tbl=mdl.getTable(mdl.SelTableID);if(!this.tbl){mstrmojo.all.aflist.set("items",[]);mstrmojo.all.tableTitle.set("text","");return ;}mstrmojo.all.tableTitle.set("text",this.tbl.n);var afs=[],attInfos,factInfos,idx=0,id;if(!this.tbl.AttrInfos&&!this.tbl.FactInfos){return ;}attInfos=this.tbl.AttrInfos;factInfos=this.tbl.FactInfos;for(id in attInfos){var attInfo=attInfos[id],att=mdl.getAttribute(id),bfs=attInfo.BaseFrms;for(k=0,len=bfs.length;k<len;k++){afs[idx++]=getGUIRow(att,attInfo,12,af.jitems,k);}}for(id in factInfos){var factInfo=factInfos[id],fct=mdl.getFact(factInfo.FactID);afs[idx++]=getGUIRow(fct,factInfo,13);}af.set("items",afs);},preBuildRendering:function preBR(){var mdl=mstrmojo.all.ArchModel;mdl.attachEventListener("tblJoinsUpdated",this.id,"populateEditor");mdl.attachEventListener("refreshGrid",this.id,"populateEditor");}});}());