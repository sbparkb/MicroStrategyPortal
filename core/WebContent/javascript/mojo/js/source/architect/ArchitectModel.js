(function(){mstrmojo.requiresCls("mstrmojo.warehouse.WHModel","mstrmojo.hash","mstrmojo.array","mstrmojo.func","mstrmojo.architect.EnumDataChangeEvents","mstrmojo.architect.ExpressionEditor","mstrmojo.architect.menu.EnumMenuActions","mstrmojo.architect.obj.Layer","mstrmojo.architect.obj.UserHierarchy","mstrmojo.architect.obj.Relationship","mstrmojo.architect.obj.SystemDimension","mstrmojo.architect.obj.Table","mstrmojo.warehouse.EnumObjectTypes","mstrmojo.warehouse.obj.DBRole");var $M=mstrmojo,$H=$M.hash,$A=$M.array,$WRAP=$M.func.wrapMethods,$MNU_ACTIONS=mstrmojo.architect.menu.EnumMenuActions,Enum_SM_CreateObject=1,Enum_SM_DeleteObject=2,Enum_SM_RenameObject=3,Enum_SM_AddFactInfo=4,Enum_SM_RemoveFactInfo=5,Enum_SM_UpdateFactInfo=6,Enum_SM_AddAttributeInfo=7,Enum_SM_RemoveAttributeInfo=8,Enum_SM_AutoRecognizeTable=10,Enum_SM_SetAsLookup=11,Enum_SM_AddAttributeForm=12,Enum_SM_UpdateAttributeInfo=13,Enum_SM_UpdateAttributeForm=14,Enum_SM_UpdateColumn=15,Enum_SM_CreateAttributeRelation=16,Enum_SM_GetAttributeRelation=17,Enum_SM_RemoveAttributeRelation=22,Enum_SM_CreateColumnAlias=23,Enum_SM_EditLayer=25,Enum_SM_CreateTableAlias=27,Enum_SM_ConvertAttributeToFact=1030,Enum_SM_ConvertFactToAttribute=31,Enum_SM_InsertAttributeRelation=32,Enum_SM_GroupForms=41,Enum_SM_UnGroupForms=42,Enum_SM_UnGroupForm=43,Enum_SM_GetProjectLocales=1031,$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,ENUM_OT_METRIC=$ENUM_OT.METRIC,ENUM_OT_ATTRIBUTE=$ENUM_OT.ATTRIBUTE,ENUM_OT_FACT=$ENUM_OT.FACT,ENUM_OT_TABLE=$ENUM_OT.TABLE,ENUM_OT_COLUMN=$ENUM_OT.COLUMN,ENUM_OT_FORM=$ENUM_OT.FORM,ENUM_OT_COMPOUND_FORM=$ENUM_OT.COMPOUND_FORM,ENUM_OT_RELATIONSHIP=$ENUM_OT.RELATIONSHIP,ENUM_OT_TRANSFORMATION=$ENUM_OT.TRANSFORMATION,ENUM_OT_LAYER=$ENUM_OT.LAYER,ENUM_OT_DIMENSION=$ENUM_OT.DIMENSION,ENUM_OT_RELATIONSHIP_ATTRIBUTE=$ENUM_OT.RELATIONSHIP_ATTRIBUTE,ENUM_STATUS_COMPLETE=1,ENUM_STATUS_MULTISOURCE=2,ENUM_STATUS_ERROR=3,Enum_TD_Columns_Unused=2,$ENUM_VIEW_TYPES=$M.architect.ui.EnumViewTypes,ENUM_VIEW_LAYER=$ENUM_VIEW_TYPES.LAYER,ENUM_VIEW_SYSDIM=$ENUM_VIEW_TYPES.SYS_HIERARCHY,ENUM_VIEW_USERHIER=$ENUM_VIEW_TYPES.USER_HIERARCHY,ENUM_VIEW_TRANSFORMATION=$ENUM_VIEW_TYPES.TRANSFORMATION,MENU_CONTEXT_TREE=1,MENU_CONTEXT_LAYER=2,MENU_CONTEXT_ALL=MENU_CONTEXT_TREE+MENU_CONTEXT_LAYER,NAME_NONE="None",STRING_UNSAVECHANGES=$M.desc(13290,"You have unsaved changes"),STRING_ALIAS=$M.desc(11916,"Alias"),STRING_ATTRIBUTETOFORM=$M.desc(13291,"Only Attributes with a single form can be converted to facts"),STRING_ATTRIBUTEONTABLE=$M.desc(13292,"Already have the attributes on this table!"),$ENUM_WH_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents,DBTABLES_USED=$ENUM_WH_DATA_CHANGE_EVENTS.DBTABLES_USED,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,EVENT_TABLES_ADDED=$ENUM_DATA_CHANGE_EVENTS.TABLES_ADDED,EVENT_TABLES_LOADED=$ENUM_DATA_CHANGE_EVENTS.TABLES_LOADED,EVENT_TABLES_CHANGED=$ENUM_DATA_CHANGE_EVENTS.TABLES_CHANGED,EVENT_LAYER_CHANGE=$ENUM_DATA_CHANGE_EVENTS.LAYER_CHANGE,EVENT_LAYER_TABLE_CHANGE=$ENUM_DATA_CHANGE_EVENTS.LAYER_TABLE_CHANGED,EVENT_TABLE_DBROLE_CHANGE=$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED,EVENT_RENAME=$ENUM_DATA_CHANGE_EVENTS.RENAME,EVENT_REMOVE=$ENUM_DATA_CHANGE_EVENTS.REMOVE,EVENT_REL_CHANGED=$ENUM_DATA_CHANGE_EVENTS.RELATIONSHIP_CHANGED,EVENT_LOGICALVIEWS_CHANGED=$ENUM_DATA_CHANGE_EVENTS.LOGICALVIEWS_CHANGED,EVENT_TRANSFORMATIONS_CHANGED=$ENUM_DATA_CHANGE_EVENTS.TRANSFORMATIONS_CHANGED,EVENT_TRANSFORMATION_UPDATED=$ENUM_DATA_CHANGE_EVENTS.TRANSFORMATION_UPDATED,EVENT_ATTRIBUTES_CHANGED=$ENUM_DATA_CHANGE_EVENTS.ATTRIBUTES_CHANGED,EVENT_USERHIERARCHY_LOADED=$ENUM_DATA_CHANGE_EVENTS.USER_HIERARCHY_LOADED,EVENT_USERHIERARCHY_CHANGED=$ENUM_DATA_CHANGE_EVENTS.USER_HIERARCHY_CHANGED,DRILL_TYPE_USERHIERARCHY="3585",ALL_TYPE_USERHIERARCHY="3585,3587";function getSystemDimension(){var model=this;if(!model.sysDimension){model.sysDimension=new mstrmojo.architect.obj.SystemDimension({mdl:model});}else{model.sysDimension.reset();}return model.sysDimension;}function getViewSource(){switch(this.currentView){case ENUM_VIEW_LAYER:return this.layers[this.currentlayerID];case ENUM_VIEW_SYSDIM:return this.sysDimension;case ENUM_VIEW_USERHIER:return this.userHierarchies[this.currentHierarchyID];}return null;}function getFunctionType(fn){return{Sum:"12",Count:"13",Avg:"14",Min:"15",Max:"16",Variance:"33"}[fn];}function constructMetricXML(name,fn,fact){return"<schm smt='1'><oi tp='4'  n='"+name+"'><def><fun fnt='"+getFunctionType(fn)+"'/><fc did='"+fact.id+"'/></def></oi></schm>";}function createNewFactMetrics(){var model=this,metricsXML="",metricXMLConfig={count:{name:"Count of ",fn:"Count"},average:{name:"Avg of ",fn:"Avg"},variance:{name:"Variance of ",fn:"Variance"},min:{name:"Min of ",fn:"Min"},max:{name:"Max of ",fn:"Max"},sum:{name:"Sum of ",fn:"Sum"}};$H.forEach(model.facts,function(fact){if(fact.isNew){fact.isNew=false;$H.forEach(metricXMLConfig,function(config,prop){if(fact[prop]){metricsXML=(metricsXML||"")+constructMetricXML(config.name+fact.name,config.fn,fact);}});}});return metricsXML;}function checkCompoundFormCategoryNone(catId,menuItem){var noneForm=false,idExists=false;if(menuItem.did==="None"){noneForm=true;$H.forEach(this.basicForms,function(basicForm){idExists=(basicForm.id===catId);return !idExists;});}return(noneForm&&!idExists)?true:menuItem.did===catId;}function menuItemEnabledTable(action){var isSelectedLayer=((this.currentlayerID!=="")&&(this.currentView===ENUM_VIEW_LAYER)),tableInProject=false;return(action===$MNU_ACTIONS.NONE||action===$MNU_ACTIONS.DELETE||action===$MNU_ACTIONS.RENAME||action===$MNU_ACTIONS.SAMPLE_DATA||((action===$MNU_ACTIONS.NEW_FACT)&&isSelectedLayer)||((action===$MNU_ACTIONS.NEW_ATTR)&&isSelectedLayer)||((action===$MNU_ACTIONS.AUTOMAP)&&isSelectedLayer)||action===$MNU_ACTIONS.REMOVE_TABLE||action===$MNU_ACTIONS.SHOW_UNUSED_COLUMNS||action===$MNU_ACTIONS.ADD_TO_LAYER||action===$MNU_ACTIONS.REMOVE_FROM_LAYER||action===$MNU_ACTIONS.DATA_SOURCES||action===$MNU_ACTIONS.UPSTRUCT||action===$MNU_ACTIONS.CREATE_ALIAS||action===$MNU_ACTIONS.LOGICAL_TABLE_SIZE||((action===$MNU_ACTIONS.ADD_TO_PROJECT)&&!tableInProject));}function menuItemEnabledColumn(action){var isSelectedLayer=((this.currentlayerID!=="")&&(this.currentView===ENUM_VIEW_LAYER));return(action===$MNU_ACTIONS.NONE||((action===$MNU_ACTIONS.ADD_ATTRIBUTE)&&isSelectedLayer)||((action===$MNU_ACTIONS.ADD_FACT)&&isSelectedLayer));}function menuItemEnabledAttribute(action,data){var model=this;return((action===$MNU_ACTIONS.DELETE_RELATIONSHIP&&model.hasRelation(data)));}function decodeDBRoleID(dbRoleID){return(dbRoleID==="00000000000000000000000000000000")?this.projPrimaryDBRoleID:dbRoleID;}function menuItemVisibleTable(data,menuItem){var action=menuItem.action,model=this,context=this.tableMenuContext,inContext=((menuItem.context||MENU_CONTEXT_ALL)&context)===context,singleTable=!data.length,tableId=singleTable?data.did:"",table=singleTable?model.getTable(tableId):null,isSelectedLayer=((this.currentlayerID!=="")&&(this.currentView===ENUM_VIEW_LAYER)),tablesInLayer=false,isInCurrentLayer=singleTable?model.tableIsInLayer(tableId):true,allShowUnusedColumns=true,noneShowUnusedColumns=true,isTable=true;if(!inContext){return false;}if(!singleTable){$H.forEach(data,function(tableData){tablesInLayer=tablesInLayer||model.tableIsInLayer(tableData.did);isInCurrentLayer=isInCurrentLayer&&model.tableIsInLayer(tableData.did);table=model.getTable(tableData.did);if(table){noneShowUnusedColumns=noneShowUnusedColumns&&(table.columnDisplay===table.EnumColumnDisplay.None);allShowUnusedColumns=allShowUnusedColumns&&(table.columnDisplay===table.EnumColumnDisplay.Unused);isTable=isTable&&(!table.isView);}});}else{isTable=(!data.isView);}return(action===$MNU_ACTIONS.NONE||action===$MNU_ACTIONS.DELETE||(action===$MNU_ACTIONS.RENAME&&singleTable)||(action===$MNU_ACTIONS.UPSTRUCT&&isTable)||action===$MNU_ACTIONS.ADD_TO_PROJECT||(action===$MNU_ACTIONS.CREATE_ALIAS)||(action===$MNU_ACTIONS.SAMPLE_DATA&&singleTable)||(action===$MNU_ACTIONS.NEW_FACT&&singleTable)||(action===$MNU_ACTIONS.NEW_ATTR&&singleTable)||action===$MNU_ACTIONS.AUTOMAP||(action===$MNU_ACTIONS.REMOVE_TABLE&&singleTable)||((action===$MNU_ACTIONS.DATA_SOURCES)&&singleTable&&(table.secondaryDBRoles.length>0))||((action===$MNU_ACTIONS.SHOW_UNUSED_COLUMNS)&&(singleTable||noneShowUnusedColumns||allShowUnusedColumns))||((action===$MNU_ACTIONS.ADD_TO_LAYER)&&isSelectedLayer&&!tablesInLayer&&!isInCurrentLayer)||action===$MNU_ACTIONS.LOGICAL_TABLE_SIZE||((action===$MNU_ACTIONS.REMOVE_FROM_LAYER)&&isSelectedLayer&&isInCurrentLayer));}function menuItemVisibleRelation(menuItem){var action=menuItem.action,model=this,retVal=true;if(action===$MNU_ACTIONS.ONE_TO_ONE||action===$MNU_ACTIONS.ONE_TO_MANY||action===$MNU_ACTIONS.MANY_TO_MANY||action===$MNU_ACTIONS.RELATIONSHIP_TABLE||action===$MNU_ACTIONS.ADD_JOIN_CHILDREN){retVal=(model.currentView===ENUM_VIEW_SYSDIM||model.currentView===ENUM_VIEW_LAYER);}return retVal;}function menuItemVisibleRelationshipAtt(data,menuItem){var model=this,userHierarchyview=(model.currentView===ENUM_VIEW_USERHIER),entryPoints=userHierarchyview?model.userHierarchies[model.currentHierarchyID].entryPoints:undefined,isEntryPoint=!!(userHierarchyview&&($A.find(entryPoints,"atid",data.attributeId)!==-1));switch(menuItem.action){case $MNU_ACTIONS.REL_ATTR_ELEMENT_DISPLAY:case $MNU_ACTIONS.ATTRIBUTE_FILTERS:case $MNU_ACTIONS.BROWSE_ATTRIBUTES:case $MNU_ACTIONS.REL_ATTR_ELEMENT_LIMIT:case $MNU_ACTIONS.REL_ATTR_ELEMENT_UNLOCK:case $MNU_ACTIONS.REL_ATTR_ELEMENT_LOCK:return userHierarchyview;case $MNU_ACTIONS.SET_ENTRY_POINT:return(userHierarchyview&&!isEntryPoint);case $MNU_ACTIONS.REMOVE_ENTRY_POINT:return(userHierarchyview&&isEntryPoint);default:return true;}}function menuItemVisibleFact(action,fact){return(action===$MNU_ACTIONS.NONE||action===$MNU_ACTIONS.DELETE||action===$MNU_ACTIONS.RENAME||action===$MNU_ACTIONS.CONVERT_FACT_TO_ATTR||action===$MNU_ACTIONS.UPDATE_AGGR||action===$MNU_ACTIONS.EDIT||(action===$MNU_ACTIONS.REMOVE_FROM_TABLE&&Object.keys(fact.tables).length>1)||(action===$MNU_ACTIONS.AGGREGATION&&fact.isNew)||action===$MNU_ACTIONS.LINKS);}function menuItemVisibleAttribute(action,attribute){return(action===$MNU_ACTIONS.NONE||action===$MNU_ACTIONS.DELETE||action===$MNU_ACTIONS.RENAME||action===$MNU_ACTIONS.CONVERT_ATTR_TO_FACT||((action===$MNU_ACTIONS.CONVERT_ATTR_TO_FORM)&&(Object.keys(attribute.forms).length===1))||action===$MNU_ACTIONS.SET_AS_FORM||action===$MNU_ACTIONS.UPDATE_FORMAT||(action===$MNU_ACTIONS.REMOVE_FROM_TABLE&&Object.keys(attribute.tables).length>1));}function menuItemVisibleColumn(action,data){return(action===$MNU_ACTIONS.NONE||action===$MNU_ACTIONS.ADD_ATTRIBUTE||action===$MNU_ACTIONS.ADD_FACT||action===$MNU_ACTIONS.COLUMN_DEF||((action===$MNU_ACTIONS.CONVERT_COLUMN_TO_FORM)&&(mstrApp.getRootController().getSameTableAttributes(data).length>0)));}function menuItemVisibleForm(action,attribute,bfIdx){var isCompound=false,model=this,formCount=Object.keys(attribute.forms).length;if(action===$MNU_ACTIONS.UNGROUP_FORM||action===$MNU_ACTIONS.GROUP_FORM||(action===$MNU_ACTIONS.UPDATE_GROUP)||(action===$MNU_ACTIONS.FORM_CATEGORY)||(action===$MNU_ACTIONS.UPDATE_CATEGORY)){isCompound=attribute.isCompound(bfIdx);}return(action===$MNU_ACTIONS.EDIT||action===$MNU_ACTIONS.NONE||action===$MNU_ACTIONS.RENAME||action===$MNU_ACTIONS.REMOVE_FROM_TABLE||action===$MNU_ACTIONS.DATA_TYPE||action===$MNU_ACTIONS.SET_AS_LOOKUP||action===$MNU_ACTIONS.UPDATE_FORMAT||(action===$MNU_ACTIONS.SET_AS_MULTILINGUAL&&((parseInt(bfIdx,10)>0))&&model.multiLingualEnabled)||(action===$MNU_ACTIONS.DELETE&&((parseInt(bfIdx,10)>0)||(formCount>1)))||action===$MNU_ACTIONS.LINKS||(action===$MNU_ACTIONS.FORM_CATEGORY&&!isCompound)||(action===$MNU_ACTIONS.UPDATE_CATEGORY&&!isCompound)||(action===$MNU_ACTIONS.UNGROUP_FORM&&isCompound)||(action===$MNU_ACTIONS.GROUP_FORM&&!isCompound&&formCount>1)||(action===$MNU_ACTIONS.UPDATE_GROUP&&!isCompound));}function menuItemVisibleCompoundForm(action){return(action===$MNU_ACTIONS.NONE||action===$MNU_ACTIONS.UNGROUP_FORMS||(action===$MNU_ACTIONS.FORM_CATEGORY)||(action===$MNU_ACTIONS.UPDATE_CATEGORY));}function menuItemCheckRelationshipAtt(menuItem){var action=menuItem.action;switch(action){case $MNU_ACTIONS.REL_ATTR_ELEMENT_LIMIT:return false;case $MNU_ACTIONS.REL_ATTR_ELEMENT_UNLOCK:return false;case $MNU_ACTIONS.REL_ATTR_ELEMENT_LOCK:return false;default:return false;}}function menuItemCheckFact(data,menuItem){var fact=this.getFact(data.did);switch(menuItem.n){case"Sum":return fact.sum;case"Count":return fact.count;case"Max":return fact.max;case"Min":return fact.min;case"Variance":return fact.variance;case"Average":return fact.average;}return false;}function menuItemCheckRelationship(data,menuItem){var relationship=this.getRelation(data.parentAttributeId,data.childAttributeId);switch(menuItem.action){case $MNU_ACTIONS.ONE_TO_ONE:return relationship.relationType===1;case $MNU_ACTIONS.ONE_TO_MANY:return relationship.relationType===2;case $MNU_ACTIONS.MANY_TO_MANY:return relationship.relationType===4;case $MNU_ACTIONS.RELATIONSHIP_TABLE_ENTRY:return menuItem.checked;case $MNU_ACTIONS.ADD_JOIN_CHILDREN:return false;}return false;}function menuItemCheckTable(data,action){var singleTable=!data.length,table,retValue=true,model=this;switch(action){case $MNU_ACTIONS.SHOW_UNUSED_COLUMNS:if(!singleTable){$A.forEach(data,function(tableData){table=model.getTable(tableData.did);retValue=retValue&&(table.columnDisplay===table.EnumColumnDisplay.Unused);});}else{table=this.getTable(data.did);retValue=(table.columnDisplay===table.EnumColumnDisplay.Unused);}return retValue;}return false;}function menuItemCheckForm(data,menuItem){var attribute=(data.tp===ENUM_OT_ATTRIBUTE)?this.getAttribute(data.did):this.getAttribute(data.sid),form=attribute.forms[data.bfIdx];if(menuItem.baseFormType){return form.baseFormType===menuItem.baseFormType;}switch(menuItem.action){case $MNU_ACTIONS.SET_AS_LOOKUP:return form.tableId===data.pdid;case $MNU_ACTIONS.SET_AS_MULTILINGUAL:return form.isMultiLingual;case $MNU_ACTIONS.UPDATE_CATEGORY:return checkCompoundFormCategoryNone.call(this,form.categoryId,menuItem);}return false;}function menuItemCheckTransformation(data,menuItem){var transformation=this.transformations[data.did];switch(menuItem.action){case $MNU_ACTIONS.TX_ONE_TO_ONE:return transformation.onetoOneMappingType===true;case $MNU_ACTIONS.TX_MANY_TO_MANY:return transformation.onetoOneMappingType===false;case $MNU_ACTIONS.TX_APPLY_TO_ALL:return transformation.transformationAllAttributes===true;case $MNU_ACTIONS.TX_APPLY_TO_HIGHEST:return transformation.transformationAllAttributes===false;}return false;}function menuItemCheckCompoundForm(data,menuItem){switch(menuItem.action){case $MNU_ACTIONS.UPDATE_CATEGORY:return checkCompoundFormCategoryNone.call(this,data.fcatId,menuItem);}return false;}function submitR(callback,params,fn){mstrApp.getRootController().getDataService()[fn||"submitRequest"](callback,params);}mstrmojo.architect.ArchitectModel=mstrmojo.declare(mstrmojo.warehouse.WHModel,null,{scriptClass:"mstrmojo.architect.ArchitectModel",attributes:{},facts:{},formCategories:{},basicForms:{},layers:{},transformations:{},tables:{},logicalViews:{},userHierarchies:{},dbRoleTables:{},columns:{},prjdbrs:[],PrjTblDbr:null,projPrimaryDBRoleID:"",currentlayerID:"",currentHierarchyID:"",currentTransformationId:"",currentLogicalViewID:"",forceReloadLayer:false,autoMap:false,askAutoMap:true,initialized:false,functions:undefined,sysDimension:undefined,currentView:ENUM_VIEW_LAYER,targetView:ENUM_VIEW_LAYER,statusStack:[],statusCount:0,statusIndex:0,tryQS:1,tableMenuContext:0,isDirty:false,schemaInstanceHasChanged:function schemaInstanceHasChanged(evt){var wls=window.localStorage,isDebug=(wls&&wls.getItem("isDebug")),checkDirty=(!(isDebug&&(isDebug==="1"))),model=mstrApp.rootController.model;if(checkDirty&&model.isDirty){evt.returnValue=STRING_UNSAVECHANGES;}},onCloseArchitect:function onCloseArchitect(){submitR({success:mstrmojo.emptyFn()},{schemaaction:3,showWait:true},"schemaAction");},tableIsInLayer:function tableIsInLayer(tableId){var model=this;return((model.currentlayerID!=="")&&model.getLayer(model.currentlayerID)&&(!!model.getLayer(model.currentlayerID).tables[tableId]));},getFormCount:function getFormCount(attId){var model=this,count=0,attribute=model.getAttribute(attId);$H.forEach(attribute.forms,function(){count++;});return count;},setTableMenuContext:function setTableMenuContext(context){this.tableMenuContext=context;},getNewValidName:function getNewValidName(type,newName){var model=this,collection,colArray;switch(type){case ENUM_OT_ATTRIBUTE:collection=model.getAttributes();break;case ENUM_OT_FACT:collection=model.getFacts();break;case ENUM_OT_TABLE:collection=model.getTables();break;}colArray=$H.valarray(collection);return model.findNextName(newName,colArray,"name");},findColumnName:function findColumnName(name){return(name.substring(0,name.indexOf(":"))!=="")?name.substring(0,name.indexOf(":")):name;},populateFormCategories:function populateFormCategories(){var model=this,form,objectName,objectID;submitR({success:function success(res){var objectInfos=res.oi;$H.forEach(objectInfos,function(objectInfo){if(objectInfo.did!=="A9BFF03B4D72CC4F457ACBB4B185E91D"){objectName=objectInfo.n;objectID=objectInfo.did;form=new mstrmojo.architect.obj.Form({isNew:false,id:objectID,category:objectName,useName:objectName,useDescription:objectName,isBrowseForm:true,isTemplateForm:true,tableId:""});if(objectInfo.stp===5377){model.basicForms[form.useName]=form;}model.formCategories[form.id]=form;}});model.basicForms[NAME_NONE]=new mstrmojo.architect.obj.Form({isNew:false,id:NAME_NONE,category:NAME_NONE,useName:NAME_NONE,useDescription:NAME_NONE,isBrowseForm:true,isTemplateForm:true,tableId:""});}},{objecttypes:ENUM_OT_FORM},"search");},getCategoryAtIndex:function getCategoryAtIndex(idx){var model=this,categories=model.formCategories,index=0,category=null,categoryId=(idx<2)?[model.basicForms.ID.id,model.basicForms.DESC.id][idx]:"";if(categoryId===""){if(Object.keys(categories).length>idx){$H.forEach(categories,function(categ){index++;if(index===idx){category=categ;return false;}return true;});categoryId=category.id;}}category=model.formCategories[categoryId];return category;},categoryIdUsedByAttribute:function categoryIdUsedByAttribute(attributeId,categoryId){var model=this,attribute=model.getAttribute(attributeId),form;$H.forEach(attribute.forms,function(frm){if(frm.categoryId===categoryId){form=frm;return false;}return true;});return(form!==undefined);},categoryNameUsedByAttribute:function categoryNameUsedByAttribute(attributeId,categoryName){var model=this,attribute=model.getAttribute(attributeId),form;$H.forEach(attribute.forms,function(frm){if(frm.catn===categoryName){form=frm;return false;}return true;});return(form!==undefined);},getReadableExpression:function getReadableExpression(expression){var desc=expression.replace("[","");desc=desc.replace("]","");return desc;},addNextAvailableForm:function addNextAvailableForm(attributeId,tableId,columnId,expression,callback){var model=this,attribute=model.getAttribute(attributeId),count=model.getFormCount(attributeId),categories=model.basicForms,category=null,categoryId="";$H.forEach(categories,function(categ){if(categ.useName!==NAME_NONE){if(!model.categoryIdUsedByAttribute(attributeId,categ.id)){category=categ;categoryId=categ.id;return false;}}return true;});if(category){attribute.addForm(true,categoryId+attributeId,count,categoryId,tableId,columnId,expression,"3","3",true,3,category.useName,category.useDescription,true,true,category.catn,callback);}else{model.addNoneForm(attributeId,tableId,columnId,expression,callback);}},addNoneForm:function addNoneForm(attributeId,tableId,columnId,expression,callback){var model=this,attribute=model.getAttribute(attributeId),count=model.getFormCount(attributeId),index,desc=model.getReadableExpression(expression),category,categoryId="";index=count;while(model.categoryNameUsedByAttribute(attributeId,attribute.name+index)===true){index++;}category={category:attribute.name+index,id:attributeId+index,isBrowseForm:true,isNew:false,isTemplateForm:true,tableId:"",useDescription:desc,useName:desc,catn:attribute.name+index};attribute.addForm(true,categoryId+attributeId,count,categoryId,tableId,columnId,expression,"3","3",true,3,category.useName,category.useDescription,true,true,category.catn,callback);},addAttributeForm:function addAttributeForm(attributeId,isNew,categoryId,baseFormIdx,columnId,expression,tableId,sortType,browseSortType,isMultiLingual,baseFormType,isBrowseForm,isTemplateForm,useName,useDescription,catn,callback){var model=this,attribute=model.getAttribute(attributeId);attribute.addForm(isNew,categoryId+attributeId,baseFormIdx,categoryId,tableId,columnId,expression,sortType,browseSortType,isMultiLingual,baseFormType,useName,useDescription,isBrowseForm,isTemplateForm,catn,callback);},updateAttributeForm:function updateAttributeForm(attributeId,baseFormId,callback){var model=this,attribute=model.getAttribute(attributeId);attribute.forms[baseFormId].update(callback);},updateFormFormat:function updateFormFormat(data,menuItem){var model=this,attributeId=data.sid,baseFormId=data.bfIdx,attribute=model.getAttribute(attributeId),form=attribute.forms[data.bfIdx];if((menuItem.baseFormType)&&(form.baseFormType!==menuItem.baseFormType)){form.baseFormType=menuItem.baseFormType;model.updateAttributeForm(attributeId,baseFormId,null);}},updateFormCategory:function updateFormCategory(data,menuItem){var model=this,attributeId=data.sid,attribute=this.getAttribute(attributeId),form=attribute.forms[data.bfIdx],cb={success:function success(){form.categoryId=menuItem.did;},complete:function complete(){form.newCatId=undefined;}};form.newCatId=menuItem.did;if(menuItem.did===NAME_NONE){form.newCatId="";form.useName=form.expression;form.useDescription=form.expression;}if(data.items){model.submitRequest(cb,{manipulationtype:Enum_SM_UpdateAttributeForm,objectid:attributeId,formcatid:data.fcatId,tableids:form.tableId,newformcatid:form.newCatId||"",showWait:true},"schemaManipulation");}else{this.updateAttributeForm(attributeId,data.bfIdx,cb);}},unGroupForms:function unGroupForms(data,menuItem){var $this=this,allForms=(menuItem.action===$MNU_ACTIONS.UNGROUP_FORMS),attId=data.sid,attr=$this.getAttribute(attId),groupId=(allForms?data.fcatId:data.did.substring(32,64)),formId=(allForms?"":data.fcatId),manipulationtype=(allForms?Enum_SM_UnGroupForms:Enum_SM_UnGroupForm),table=$this.getTable(data.pdid),tblIds="";this.submitRequest({success:function success(){var groupIdx=$A.find(attr.formGroups,"catID",groupId),group=attr.formGroups[groupIdx],formIdx;if(allForms||group.fms.length<3){$A.removeIndices(attr.formGroups,groupIdx,1);}else{formIdx=$A.find(group.fms,"did",formId);$A.removeIndices(group.fms,formIdx,1);}$H.forEach(attr.tables,function(tbl){table=$this.getTable(tbl.id);tblIds+=tbl.id+",";table.reset();});$this.getAttributesFactsInTable(tblIds,{success:function success(){$H.forEach(attr.tables,function(tbl){table=$this.getTable(tbl.id);$this.raiseTableChangeEvent(table);});}});}},{manipulationtype:manipulationtype,objectid:attId,objectid2:groupId,objectid3:formId},"schemaManipulation");},groupForms:function groupForms(source,target){var $this=this,attId=source[0].sid,attribute=this.attributes[attId],table=$this.getTable(source[0].pdid),category=this.formCategories[target.fcatId],sourceInfo="",tblIds="";$A.forEach(source,function(src){sourceInfo+=src.fcatId+";";});sourceInfo+=category.id+";";this.submitRequest({success:function success(){$H.forEach(attribute.tables,function(tbl){table=$this.getTable(tbl.id);tblIds+=tbl.id+",";table.reset();});$this.getAttributesFactsInTable(tblIds,{success:function success(){$H.forEach(attribute.tables,function(tbl){table=$this.getTable(tbl.id);$this.raiseTableChangeEvent(table);});}});}},{manipulationtype:Enum_SM_GroupForms,objectid:attId,usename:category.useName,usedesc:category.useDescription,info:sourceInfo},"schemaManipulation");},handleVisibleAction:function handleVisibleAction(data,item){if(!item){return false;}var tp=!data.length?data.tp:data[0].tp;switch(tp){case ENUM_OT_TABLE:return menuItemVisibleTable.call(this,data,item);case ENUM_OT_FACT:return menuItemVisibleFact(item.action,this.getFact(data.did));case ENUM_OT_ATTRIBUTE:return menuItemVisibleAttribute(item.action,this.getAttribute(data.did));case ENUM_OT_COLUMN:return menuItemVisibleColumn(item.action,data);case ENUM_OT_FORM:return menuItemVisibleForm.call(this,item.action,this.getAttribute(data.sid),data.bfIdx);case ENUM_OT_RELATIONSHIP:return menuItemVisibleRelation.call(this,item);case ENUM_OT_COMPOUND_FORM:return menuItemVisibleCompoundForm(item.action);case ENUM_OT_RELATIONSHIP_ATTRIBUTE:return menuItemVisibleRelationshipAtt.call(this,data,item);default:return this._super(data,item);}},handleEnabledAction:function handleEnabledAction(data,item){if(!item){return false;}var tp=!data.length?data.tp:data[0].tp;switch(tp){case ENUM_OT_TABLE:return menuItemEnabledTable.call(this,item.action,data);case ENUM_OT_COLUMN:return menuItemEnabledColumn.call(this,item.action);case ENUM_OT_FORM:return true;case ENUM_OT_RELATIONSHIP:return true;case ENUM_OT_FACT:return true;case ENUM_OT_ATTRIBUTE:return menuItemEnabledAttribute.call(this,item.action,data);case ENUM_OT_RELATIONSHIP_ATTRIBUTE:return true;default:return this._super(data,item);}},handleCheckAction:function handleCheckAction(data,item){if(!item){return false;}var tp=!data.length?data.tp:data[0].tp;switch(tp){case ENUM_OT_TABLE:return menuItemCheckTable.call(this,data,item.action);case ENUM_OT_FACT:return menuItemCheckFact.call(this,data,item);case ENUM_OT_ATTRIBUTE:return menuItemCheckForm.call(this,data,item);case ENUM_OT_COLUMN:return false;case ENUM_OT_FORM:return menuItemCheckForm.call(this,data,item);case ENUM_OT_COMPOUND_FORM:return menuItemCheckCompoundForm.call(this,data,item);case ENUM_OT_RELATIONSHIP:return menuItemCheckRelationship.call(this,data,item);case ENUM_OT_TRANSFORMATION:return menuItemCheckTransformation.call(this,data,item);case ENUM_OT_RELATIONSHIP_ATTRIBUTE:return menuItemCheckRelationshipAtt.call(this,item);default:return this._super(data,item);}},submitRequest:function submitRequest(callback,params,fn){submitR(callback,params,fn);},getColumnByName:function getColumnByName(columnName){var model=this,column=null;$H.forEach(model.columns,function(clm){if(clm.cln.toUpperCase()===columnName.toUpperCase()){column=clm;return false;}return true;});return column;},getColumnForExpression:function getColumnForExpression(expression){expression=expression.replace(/^\s\s*/,"").replace(/\s\s*$/,"");var pStart=expression.indexOf("[");if(pStart===-1){return this.getColumnByName(expression);}return this.getColumnByName(expression.substring(pStart+1,expression.indexOf("]")));},getAllColumnsForExpression:function getAllColumnsForExpression(expression){expression=expression.replace(/^\s\s*/,"").replace(/\s\s*$/,"");var $this=this,pattern=/[\[\]]/g,startIdx=expression.indexOf("["),endIdx=0,columns=[];if(startIdx>-1){do{pattern.test(expression);startIdx=pattern.lastIndex;pattern.test(expression);endIdx=pattern.lastIndex;columns.push($this.getColumnByName(expression.substring(startIdx,endIdx-1)));startIdx=expression.indexOf("[",endIdx);}while(startIdx>-1);}else{columns.push($this.getColumnByName(expression));}return columns;},createExpression:function createExpression(columnId){var model=this,column=model.columns[columnId],expression=[];if(column){expression.push("[");expression.push(column.cln);expression.push("]");return expression.join("");}return"";},setProjectPrimaryDBRole:function setProjectPrimaryDBRole(forceSet,callback){var model=this,primaryDBRoleId=model.SelDBRoleID;if(!model.projPrimaryDBRoleID||forceSet){model.submitRequest($WRAP({success:function suc(){model.projPrimaryDBRoleID=primaryDBRoleId;$A.forEach(model.dbrs,function(dbr){if(dbr.data.isPrimary){dbr.data.isPrimary=false;model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED,item:dbr});}if(dbr.did===primaryDBRoleId){dbr.data.isPrimary=true;model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED,item:dbr});}return true;});}},callback),{dbroleID:primaryDBRoleId,flgs:3,isPrimary:true},"addProjectDBRole");}else{callback.success();}},addDBRoleToProject:function addDBRoleToProject(dbRole,callback){var model=this;if(!model.initialized){model.projPrimaryDBRoleID=dbRole.did;model.setInitialValues();}if($A.find(this.prjdbrs,"did",dbRole.did)>=0){if(callback&&callback.success){callback.success();}return ;}model.submitRequest({success:function success(){model.prjdbrs.push(dbRole);if(callback&&callback.success){callback.success();}}},{dbroleID:dbRole.did,isPrimary:false},"addProjectDBRole");},setTableLogicalSize:function setTableLogicalSize(data){var model=this,table=this.getTable(data.did),cbLogicalSize={success:function success(){model.raiseTableChangeEvent(table);}};table.setLogicalSize(data.size,data.isLocked,cbLogicalSize);},setTableDBRoles:function setTableDBRoles(data){var model=this,table=this.getTable(data.did),changePrimary=(data.primaryId!==table.primaryDBRole),secondary=[],cbEditDBRoles={success:function success(){model.raiseTableChangeEvent(table);model.raiseEvent({name:DBTABLES_USED,items:model.getDBRoleTablesInUse(model.SelDBRoleID)});if(changePrimary){model.raiseEvent({name:EVENT_REMOVE,value:null,did:table.id,tp:ENUM_OT_TABLE});model.raiseEvent({name:EVENT_TABLES_ADDED,items:model.createViewableTable(table.primaryDBRole,[table.getTableData()])});}}};$A.forEach(data.secondary,function(secondaryDBRole){if(secondaryDBRole.id!==data.primaryId){secondary.push(secondaryDBRole.id);}});table.editDBRoles(data.primaryId,secondary,cbEditDBRoles);},getTableDBRoles:function getTableDBRoles(data){var model=this,dbrs=this.dbrs,tableId=data.did,table=this.getTable(tableId),allDBRoles=[],primaryId=table.primaryDBRole,getDBRoleName=function getDBRoleName(dbRoleIdToFind){dbRoleIdToFind=decodeDBRoleID.call(model,dbRoleIdToFind);var index=$A.find(dbrs,"did",dbRoleIdToFind);return index===-1?"Incorrect DBRole Id":dbrs[index].n;},primaryName=getDBRoleName(table.primaryDBRole);$H.forEach(table.secondaryDBRoles,function(dbroleId){allDBRoles.push({id:dbroleId,n:getDBRoleName(dbroleId)});});allDBRoles.push({id:primaryId,n:primaryName});return{did:tableId,primaryId:primaryId,primaryName:primaryName,dbRoles:allDBRoles};},addTableStatus:function addTableStatus(tableId,status,errorCode,selDBRoleId,callback){var model=this,statusStack=model.statusStack;statusStack.push({tableId:tableId,status:status,errorCode:errorCode,selDBRoleId:selDBRoleId,callback:callback});},checkItemStatus:function checkItemStatus(){var model=this,item=model.statusStack.pop();if(item){switch(item.status){case ENUM_STATUS_COMPLETE:model.checkItemStatus();break;case ENUM_STATUS_ERROR:mstrmojo.alert(mstrApp.getRootController().cleanError(item.errorCode),model.checkItemStatus(),item.tableId);break;case ENUM_STATUS_MULTISOURCE:var newTable=model.getTable(item.tableId);$M.confirm(item.errorCode,{confirmBtn:{t:mstrmojo.desc(1442,"OK"),fn:function(){newTable.secondaryDBRoles.push(item.selDBRoleId);newTable.editDBRoles(newTable.primaryDBRole,newTable.secondaryDBRoles,item.callback);model.checkItemStatus();}},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:function(){model.checkItemStatus();}}},{title:newTable.name});break;}}},checkTableStatus:function checkTableStatus(){var model=this;if(model.statusStack.length===model.statusCount){model.checkItemStatus();}},addTableToModel:function addTableToModel(table,isNew,dbroleId,callback){var model=this,dbRoleTables=model.dbRoleTables,dbrole=model.getDBRole(dbroleId),cb={success:function success(){if(isNew){model.tables[table.id]=table;if(table.isView){model.logicalViews[table.id]=table;}}if(!dbRoleTables[dbrole.did]){dbRoleTables[dbrole.did]={};}model.PrjTblDbr=dbrole.did;model.dbRoleTables[dbrole.did][table.id]=table;if(callback&&callback.success){callback.success();}}};model.addDBRoleToProject(dbrole,cb);},createTable:function createTable(isNew,sObjectName,tblDef,callback){var model=this,type=tblDef.type||1,dbroleId=model.SelDBRoleID||model.projPrimaryDBRoleID,tbl,cb={success:function success(){model.checkTableStatus();callback.success(tbl);}};mstrmojo.insert(new mstrmojo.architect.obj.Table({model:model,isNew:isNew,type:type,tblDef:tblDef,name:sObjectName,callback:{success:function success(table){tbl=table;model.addTableToModel(table,(table.secondaryDBRoles.length===0),dbroleId,cb);}}}));},createTableAlias:function createTableAlias(originalTable){var model=this,newName=originalTable.n+" "+STRING_ALIAS;newName=model.getNewValidName(ENUM_OT_TABLE,newName);model.submitRequest({success:function suc(res){var newitems={26:[],15:[]},objects=[].concat(res.mi["in"].oi);$A.forEach(objects,function(item){if(newitems[item.tp]){newitems[item.tp].push(item);}});var table=model.getTable(originalTable.did).clone(newitems[ENUM_OT_TABLE][0].did,newitems[ENUM_OT_TABLE][0].n);model.addTableToModel(table,true,originalTable.dbrole);table.addColumns(newitems[ENUM_OT_COLUMN]);model.raiseEvent({name:EVENT_TABLES_ADDED,items:model.createViewableTable(table.primaryDBRole,[table.getTableData()])});}},{manipulationtype:Enum_SM_CreateTableAlias,objectid:originalTable.did,objectname:newName,showWait:false},"schemaManipulation");},createViewableTable:function createViewableTable(dbroleId,items){var model=this,visibleFn=function(data,item){return model.handleVisibleAction(data,item);},checkFn=function(data,item){return model.handleCheckAction(data,item);},enabledFn=function(data,item){return model.handleEnabledAction(data,item);},dbrole,tableItem;dbrole=this.getDBRole(dbroleId);tableItem={n:dbrole.displayName(),st:dbrole.mdDBRole.stp,t:dbrole.mdDBRole.tp,did:dbroleId,items:items,isVisible:visibleFn,isChecked:checkFn,isEnabled:enabledFn};return tableItem;},addTables:function addTables(DBTables,callback){var model=this,createTableCb={success:function(table){if(table.secondaryDBRoles.length>0){model.raiseTableChangeEvent(table);}else{model.raiseEvent({name:EVENT_TABLES_ADDED,items:model.createViewableTable(table.primaryDBRole,[table.getTableData()])});}model.raiseEvent({name:DBTABLES_USED,items:model.getDBRoleTablesInUse(model.SelDBRoleID)});if(callback&&callback.success){callback.success(table.getTableData());}}};model.statusCount=DBTables.length;model.statusStack=[];$H.forEach(DBTables,function(DBTable){model.getColumnsForDBTable({data:DBTable},{success:function success(res){DBTable.columns=res.items;model.createTable(true,DBTable.dbtn,DBTable,createTableCb);}});});},updateLayer:function updateLayer(layer,callback){this.submitRequest(callback,{manipulationtype:Enum_SM_EditLayer,objectid:layer.id,info:JSON.stringify({tables:layer.tablePositions||{},attributes:layer.attributePositions||{}})},"schemaManipulation");},updateTableStructure:function updateTableStructure(did){var model=this,table=model.getTable(did),createTableCb={success:function success(){model.raiseTableChangeEvent(table);}},updateTableCb={success:function success(){model.getColumnsForDBTable({data:{n:table.name,dbtn:table.dbtn,ns:table.nameSpace,dbrole:table.primaryDBRole,tableId:table.dbtid},getFresh:true,compareWithMD:true},{success:function success(res){var cols=[],cas=res.xrc.cas[0],tis=cas.tis[0];$A.forEach(tis.clis,function(col){cols.push(new mstrmojo.architect.obj.Column({dbInfo:col}));});table.updateStructure({n:table.name,did:table.name,columns:cols,sta:parseInt(tis.sta,10)},createTableCb);}});}};if(table.isPopulated){updateTableCb.success();}else{model.getAttributesFactsInTable(did,updateTableCb);}},getProjectTables:function getProjectTables(){var model=this,cbgetTables={success:function(){var i=0,tableItems=[];$H.forEach(model.prjdbrs,function(dbrole){var items=[];$H.forEach(model.dbRoleTables[dbrole.did],function(table){if(model.getDBRole(table.primaryDBRole).did===decodeDBRoleID(dbrole.did)){items.push(table.getTableData());}});if(items.length>0){tableItems[i]=model.createViewableTable(dbrole.did,items);i++;}});model.raiseEvent({name:EVENT_TABLES_LOADED,items:tableItems});}};if(mstrApp.rootController.getObjectCount(model.tables)===0){model.loadProjectTables(cbgetTables);}else{cbgetTables.success();}},getProjectLocales:function getProjectLocales(callback){var model=this;model.submitRequest($WRAP({success:function success(res){if(res){model.multiLingualEnabled=res.multiLingualEnabled;}}},callback),{manipulationtype:Enum_SM_GetProjectLocales},"schemaManipulation");},getDBRoleTablesInUse:function getDBRoleTablesInUse(dbRoleId){var result=[];$H.forEach(this.dbRoleTables[dbRoleId],function buildDBRoleTablesId(tableObject){result.push(tableObject.name);});return result;},loadProjectTables:function loadProjectTables(callback){var model=this,cbLoadTables=$WRAP({success:function(res){$H.forEach(res.dbroles,function(dbrole){var primaryDBRoleId=dbrole.did,tables=dbrole.tables;model.addDBRoleToProject(model.getDBRole(primaryDBRoleId));$H.forEach(tables,function(tbl){var table=new mstrmojo.architect.obj.Table({model:model,isNew:false,id:tbl.did,name:tbl.n,primaryDBRole:primaryDBRoleId,nameSpace:tbl.ns,dbtid:tbl.dbtid,dbtn:tbl.dbtn,type:tbl.xt,SQLStatement:tbl.sql,subtype:tbl.stp});model.addTableToModel(table,true,primaryDBRoleId);$H.forEach(tbl.secdbroles,function(secondaryDBRole){table.secondaryDBRoles.push(secondaryDBRole.did);model.addTableToModel(table,false,secondaryDBRole.did);});});});}},callback);submitR(cbLoadTables,{showWait:true},"loadLogicalTables");},addSecondaryDBRole:function addSecondaryDBRole(tableId,dbroleId){var model=this,table=model.getTable(tableId),cbMulTable={success:function(){model.raiseEvent({name:EVENT_TABLE_DBROLE_CHANGE,tid:table.id,dbr:dbroleId});}};table.addSecondaryDBRole(dbroleId,cbMulTable);},setAsLookup:function setAsLookup(tableId,attributeId,baseFormId){var model=this,table=model.getTable(tableId),attribute=model.getAttribute(attributeId),form=attribute.forms[baseFormId],lookUpCb={success:function suc(){model.raiseEvent({name:EVENT_RENAME,value:form.useName,did:attributeId+baseFormId,tp:ENUM_OT_FORM,bfIdx:0});model.raiseTableChangeEvent(table);}};table.setAsLookup(attributeId,baseFormId,lookUpCb);},setAsMultiLingual:function setAsMultiLingual(tableId,attributeId,baseFormId){var model=this,table=model.getTable(tableId),attribute=model.getAttribute(attributeId),form=attribute.forms[baseFormId],lookUpCb={success:function suc(){model.raiseEvent({name:EVENT_RENAME,value:form.useName,did:attributeId+baseFormId,tp:ENUM_OT_FORM,bfIdx:0});model.raiseTableChangeEvent(table);}};form.isMultiLingual=(!form.isMultiLingual);form.update(lookUpCb);},getTableByName:function getTableByName(name){var model=this,selTable=null;$H.forEach(model.tables,function(table){if(table.name===name){selTable=table;return false;}return true;});return selTable;},getTables:function getTables(){return this.tables;},getTable:function getTable(tableId){return this.tables[tableId];},autoRecognizeTable:function autoRecognizeTable(tableId,callback){var model=this,table=model.getTable(tableId),cb={success:function(){table.autoRecognize(callback);}};if((table&&table.isPopulated)||(table&&table.isNew)){table.autoRecognize(callback);}else{model.getAttributesFactsInTable(tableId,cb);}},getAttributesFactsInTable:function getAttributesFactsInTable(tableId,callbacks){var model=this,table,items=[],result=[],tableId2=(tableId.length>32)?tableId.substring(0,tableId.indexOf(",")):tableId;if(tableId2){table=model.getTable(tableId2);if((table&&table.isPopulated)||(table&&table.isNew)){if(callbacks&&callbacks.success){items.push(table.getTableData());result=model.createViewableTable(table.primaryDBRole,items);callbacks.success({items:result,tableData:table.getTableData()});if(callbacks.complete){callbacks.complete();}}}else{var cb={complete:function(){if(callbacks&&callbacks.complete){callbacks.complete();}},success:function(res){$A.forEach(res.tables,function(tbl){table=model.getTable(tbl.tbid);var cols=tbl.table.cols,atts=tbl.table.atts,facts=tbl.table.facts,attribute;table.nameSpace=tbl.table.ns;table.size=tbl.table.sz;table.isPopulated=true;$A.forEach(cols,function(col){table.addColumn(col);});$A.forEach(atts,function(att){var attdid=att.did;if(!model.attributes[attdid]){model.attributes[attdid]=new mstrmojo.architect.obj.Attribute({isNew:false,id:attdid,name:att.n,arity:att.art,model:model});}attribute=model.attributes[attdid];attribute.formGroups=att.formGroups;$A.forEach(att.fms,function(form){attribute.addForm(false,form.catID+attdid,form.bfi,form.catID,form.tbid,form.col.did,form.exp,"3","3",(form.isml!==0),form.bft,form.formName,form.formName,true,true,"",null);table.addAttributeInfo(false,form.bfi,attdid,form.exp,form.col.did);$A.forEach(form.aliasColumns,function(col){var column=new mstrmojo.architect.obj.Column({tableInfo:col});model.columns[column.cmid]=column;});});});$A.forEach(facts,function(fact){var fcdid=fact.did;if(!model.facts[fcdid]){model.facts[fcdid]=new mstrmojo.architect.obj.Fact({isNew:false,id:fcdid,name:fact.n,model:model});}table.addFactInfo(false,fcdid,fact.exp.exp,fact.col.did);$A.forEach(fact.aliasColumns,function(col){var column=new mstrmojo.architect.obj.Column({tableInfo:col});model.columns[column.cmid]=column;});});items.push(table.getTableData());result=model.createViewableTable(table.primaryDBRole,items);});if(callbacks&&callbacks.success){callbacks.success({items:result});}}};submitR(cb,{manipulationtype:1001,tableids:tableId},"schemaManipulation");}}},addAttributeInfo:function addAttributeInfo(isNew,baseFormId,attId,expr,cmid,tableId,callback){var model=this,table=model.getTable(tableId);table.addAttributeInfo(isNew,baseFormId,attId,model.createExpression(cmid),cmid,callback);},removeAttributeInfo:function removeAttributeInfo(removeFromSI,tableId,baseFormId,attributeId){var model=this,table=model.getTable(tableId);table.removeAttributeInfo(removeFromSI,baseFormId,attributeId,{success:function success(){model.raiseTableChangeEvent(table);}});},updateAttributeInfo:function updateAttInfo(baseFormId,attId,expr,cmid,tableId,callback){var model=this,table=model.getTable(tableId);table.updateAttributeInfo(attId,baseFormId,expr,cmid,callback);},getAttributes:function getAttributes(){return this.attributes;},getAttribute:function getAttribute(id){return this.attributes[id];},createAttributeInTable:function createAttributeInTable(tableId,expression,columnId,name,callback){var model=this,table=model.getTable(tableId),attribute,attInfo,cbCreateAttInfo={success:function success(){if(callback&&callback.success){callback.success(attInfo.attributeId);}}},cbCreateForm={success:function success(res){attInfo=res;table.addAttributeInfo(false,"0",attribute.id,expression,columnId,cbCreateAttInfo);}},cbCreateAtt={success:function success(){model.attributes[attribute.id]=attribute;attribute.addForm(true,"",0,model.basicForms.ID.id,tableId,columnId,expression,"3","3",true,3,model.basicForms.ID.useName,model.basicForms.ID.useName,true,true,"",cbCreateForm);}};attribute=new mstrmojo.architect.obj.Attribute({isNew:true,name:name,model:model,callback:cbCreateAtt});},createAttribute:function createAttribute(data){var model=this,tableId=data.pdid,name=model.findColumnName(data.n),columnId=data.did,expression=model.createExpression(columnId),cbCreateAttr={success:function success(){model.raiseTableChangeEvent(model.getTable(tableId));}};name=model.getNewValidName(ENUM_OT_ATTRIBUTE,name);model.createAttributeInTable(tableId,expression,columnId,name,cbCreateAttr);},updateAttributeMapping:function updateAttributeMapping(data,menuItem){var model=this,attribute=model.getAttribute(data.did);attribute.automapping=(menuItem.did==="AutoMap");},removeAttributeForm:function removeAttributeForm(attributeId,formId,callback){this.getAttribute(attributeId).removeForm(formId,callback);},addFactInfo:function addFactInfo(isNew,factId,expr,cmid,tableId,callback){var model=this,table=model.getTable(tableId);table.addFactInfo(isNew,factId,model.createExpression(cmid),cmid,callback);},removeFactInfo:function removeFactInfo(removeFromSI,factId,tableId){var model=this,table=model.getTable(tableId);table.removeFactInfo(removeFromSI,factId,{success:function success(){model.raiseTableChangeEvent(table);}});},updateFactInfo:function updateFactInfo(factId,expr,cmid,tableId,callback){var model=this,table=model.getTable(tableId);table.updateFactInfo(factId,expr,cmid,callback);},getFacts:function getFacts(){return this.facts;},getFact:function getFact(factId){return this.facts[factId];},createFactInTable:function createFactInTable(tableId,expression,columnId,name,callback){var model=this,table=model.getTable(tableId),fact,cbCreateFactInfo={success:function success(){if(callback&&callback.success){callback.success(fact.id);}}},cbCreateFact={success:function success(){model.facts[fact.id]=fact;table.addFactInfo(true,fact.id,expression,columnId,cbCreateFactInfo);}};fact=new mstrmojo.architect.obj.Fact({isNew:true,name:name,model:model,callback:cbCreateFact});},createFact:function createFact(data){var model=this,name=model.findColumnName(data.n),columnId=data.did,tableId=data.pdid,expression=model.createExpression(columnId),cbCreateFact={success:function success(){model.raiseTableChangeEvent(model.getTable(tableId));}};name=model.getNewValidName(ENUM_OT_FACT,name);model.createFactInTable(tableId,expression,columnId,name,cbCreateFact);},updateFactMapping:function updateFactMapping(data,menuItem){var model=this,fact=model.getFact(data.did);fact.automapping=(menuItem.did==="AutoMap");},addTableInfo:function addTableInfo(physicalData,logicalData){var model=this,columnId=physicalData.did,tableId=physicalData.pdid,objtId=logicalData.did,count,bfCount,table=model.getTable(tableId),cbTableInfo={success:function success(){model.raiseTableChangeEvent(model.getTable(tableId));}},cb={success:function success(){model.addAttributeInfo(true,bfCount,objtId,model.createExpression(columnId),columnId,tableId,cbTableInfo);}};if(logicalData.tp===ENUM_OT_FACT){model.addFactInfo(true,objtId,model.createExpression(columnId),columnId,tableId,cbTableInfo);}else{count=model.getFormCount(objtId);bfCount=table.attributeInfos[objtId]?Object.keys(table.attributeInfos[objtId].baseForms).length:0;if(count>bfCount){cb.success();}else{model.addNextAvailableForm(objtId,tableId,columnId,model.createExpression(columnId),cb);}}},updateMappingMethod:function updateMappingMethod(data,menuItem){var model=this.model;if(data.tp===ENUM_OT_ATTRIBUTE){model.updateAttributeMapping(data,menuItem);}else{model.updateFactMapping(data,menuItem);}},removeInfoFromTable:function removeInfoFromTable(data){var model=this,attribute,tables,tblCount=0,bfIdx;if(data.tp===ENUM_OT_ATTRIBUTE||data.tp===ENUM_OT_FORM){attribute=(data.tp===ENUM_OT_ATTRIBUTE)?model.attributes[data.did]:model.attributes[data.sid];if(Object.keys(attribute.tables).length>1){tables=attribute.tables;bfIdx=(data.tp===ENUM_OT_ATTRIBUTE)?"-1":data.bfIdx;$H.forEach(tables,function(table){$H.forEach(table.attributeInfos,function(attributeInfo){$H.forEach(attributeInfo.baseForms,function(baseForm){if(baseForm.baseFormId===bfIdx){tblCount++;}});});});if(tblCount>1){model.removeAttributeInfo(true,data.pdid,bfIdx,attribute.id);}else{model.deleteObject(data);}}else{if(data.tp===ENUM_OT_FORM&&data.bfIdx==="0"){data.did=data.sid;data.tp=$ENUM_OT.ATTRIBUTE;model.deleteObject(data);}else{model.deleteObject(data);}}}else{model.removeFactInfo(true,data.did,data.pdid);}},convertAttributeToFact:function convertAttributeToFact(baseFormId,attributeId,factId,tableId,callback){var model=this,objid2="",fact,table=model.getTable(tableId),attribute=model.attributes[attributeId],attributeInfo=table.attributeInfos[attributeId],expression=(attributeInfo.baseForms[baseFormId])?attributeInfo.baseForms[baseFormId].expression:attribute.forms[baseFormId].expression,columnId=(attributeInfo.baseForms[baseFormId])?attributeInfo.baseForms[baseFormId].columnId:attribute.forms[baseFormId].columnId;if(Object.keys(attribute.forms).length>1){mstrmojo.alert(STRING_ATTRIBUTETOFORM);return ;}if(factId){objid2=factId;}var cb=$WRAP({success:function success(res){if(!fact){fact=res.mi["in"].oi[0];var fcdid=fact.did,source=getViewSource.call(this),target=model.attributes,relations,attribute,lIndex;if(!model.facts[fcdid]){model.facts[fcdid]=new mstrmojo.architect.obj.Fact({isNew:false,id:fcdid,name:fact.n,model:model});}fact=model.facts[fcdid];fact.isNew=true;table.addFactInfo(false,fcdid,expression,columnId);attribute=target[attributeId];$H.forEach(attribute.tables,function(table){table.removeAttributeInfo(false,"0",attributeId,null);});if(target[attributeId]){delete target[attributeId];}if(source){relations=source.relations;$H.forEach(relations,function(relation){if(((relation.childAttributeId===attributeId)||(relation.parentAttributeId===attributeId))&&relation.childAttributeId!==""){relations.splice(lIndex,1);return false;}lIndex++;return true;});}model.raiseTableChangeEvent(table);}}},callback);submitR(cb,{manipulationtype:Enum_SM_ConvertAttributeToFact,objectid:attributeId,objectid2:objid2,baseformid:baseFormId,columnid:columnId,tableids:tableId,objectname:attribute.name,expression:expression},"schemaManipulation");},convertAttributeToForm:function convertAttributeToForm(srcAttributeId,tgtAttributeId,tableId){var model=this,tgtAttribute=model.getAttribute(tgtAttributeId),table=model.getTable(tableId),attributeInfo=table.attributeInfos[srcAttributeId],bfcount=Object.keys(tgtAttribute.forms).length,columnId=attributeInfo.baseForms["0"].columnId,expression=attributeInfo.baseForms["0"].expression,bCreateBaseform=false,cbRemoveAttInfo={success:function success(){model.raiseTableChangeEvent(table);}},cbconvertAttFrm={success:function success(){table.removeAttributeInfo(true,"0",srcAttributeId,cbRemoveAttInfo);}},cbconvertAddForm={success:function success(){table.addAttributeInfo(bCreateBaseform,bfcount,tgtAttributeId,expression,columnId,cbconvertAttFrm);}};if(attributeInfo.count()<bfcount){bfcount=attributeInfo.count();bCreateBaseform=true;cbconvertAddForm.success();}else{model.addNextAvailableForm(tgtAttributeId,tableId,columnId,expression,cbconvertAddForm);}},convertColumnToForm:function convertColumnToForm(scrColumnId,tgtAttributeId,tableId){var model=this,tgtAttribute=model.getAttribute(tgtAttributeId),table=model.getTable(tableId),bfcount=Object.keys(tgtAttribute.forms).length,expression=model.createExpression(scrColumnId),attributeInfo=table.attributeInfos[tgtAttributeId],aicount=attributeInfo.count(),cbconvertAttFrm={success:function success(){model.raiseTableChangeEvent(table);}},cbconvertAddForm={success:function success(){table.addAttributeInfo(false,bfcount,tgtAttributeId,expression,scrColumnId,cbconvertAttFrm);}};if(aicount<bfcount){attributeInfo.addBaseForm(true,aicount,scrColumnId,expression,cbconvertAttFrm);}else{model.addNextAvailableForm(tgtAttributeId,tableId,scrColumnId,expression,cbconvertAddForm);}},convertFactToAttribute:function convertFactToAttribute(factId,attributeId,formFormat,isBrowseForm,isTemplateForm,useName,tableId,callback){var model=this,objid2="",fact=model.getFact(factId),frmID=model.basicForms.ID.id,table=model.getTable(tableId),factInfo=table.factInfos[factId],expression=factInfo.expression,columnId=factInfo.columnId;if(attributeId){objid2=attributeId;}var cb=$WRAP({success:function success(res){var attInfo=table.attributeInfos[attributeId],attr=res.mi[0]["in"].oi[0],attrId=attr.did,attribute;if(!model.attributes[attrId]){attribute=new mstrmojo.architect.obj.Attribute({isNew:false,id:attrId,name:attr.n,model:model});model.attributes[attrId]=attribute;attribute.addForm(false,"",0,model.basicForms.ID.id,tableId,columnId,expression,"3","3",true,3,attr.n,attr.n,true,true,"",null);}if(!attInfo){table.addAttributeInfo(false,0,attrId,expression,columnId);table.removeFactInfo(false,factId,tableId);delete model.facts[factId];}else{mstrmojo.alert(STRING_ATTRIBUTEONTABLE);}model.raiseTableChangeEvent(table);}},callback);submitR(cb,{manipulationtype:Enum_SM_ConvertFactToAttribute,objectid:factId,objectid2:objid2,columnid:columnId,tableids:tableId,formcatid:frmID,expression:expression,objectname:fact.name,isbrowseform:1,istemplateform:1,baseformtype:formFormat,usename:useName},"schemaManipulation");},raiseTableChangeEvent:function raiseTableChangeEvent(table){this.raiseEvent({name:EVENT_TABLES_CHANGED,item:table.getTableData()});this.raiseEvent({name:EVENT_LAYER_TABLE_CHANGE,item:table.getTableData(true)});},saveProject:function SaveProject(callback){this.isDirty=false;submitR(callback,{schemaaction:"5",showWait:true},"schemaAction");},saveAndUpdate:function saveAndUpdate(callback){this.isDirty=false;this.saveSchemaInstance({success:function success(){submitR(callback,{showWait:true},"refreshEngineSchema");}});},saveSchemaInstance:function saveSchemaInstance(callback){var model=this,metricsXML=createNewFactMetrics.call(model);if(metricsXML){model.createMetric(null,"Multiple Metrics",null,metricsXML,{success:function success(){model.saveProject(callback);}});}else{model.saveProject(callback);}},setInitialValues:function setInitialValues(callback){this.tables={};this.getProjectTables();this.loadDBTypeFilters(callback);this.initialized=true;},createSchemaInstance:function createSchemaInstance(callback){var model=this;submitR($WRAP({success:function success(res){model.set("schemaInstanceID",res.siid);model.populateFormCategories();model.getProjectLocales();$A.forEach(res.dbrs,function(dbRole){var dbr=new mstrmojo.warehouse.obj.DBRole({mdDBRole:dbRole,mdl:model});model.dbrs.push(dbr);model.prjdbrs.push(dbr);});if(model.dbrs.length&&model.dbrs.length>0){model.projPrimaryDBRoleID=model.dbrs[0].did;model.setInitialValues({success:function success(){mstrApp.rootController.switchView(model.currentView,true);}});}else{model.loadDBTypeFilters({success:function success(){mstrApp.getRootController().showDBRolePicker({success:function success(did){model.SelDBRoleID=did;model.setProjectPrimaryDBRole(true,{success:function success(){model.setInitialValues({success:function success(){mstrApp.rootController.switchView(model.currentView,true);}});model.SelDBRoleID="";model.set("SelDBRoleID",did);}});}});}});}}},callback),{schemaaction:"1",skipSchemaIDCheck:true,showWait:true},"schemaAction");},createMetric:function createMetric(sObjectName,fn,fct,objectDef,callback){submitR($WRAP({success:function success(){}},callback),{manipulationtype:Enum_SM_CreateObject,objecttype:ENUM_OT_METRIC,objectname:sObjectName,objectdef:objectDef,showWait:true},"schemaManipulation");},createColumnAlias:function createColumnAlias(oid,bfidx,tp,columnName,def,callback){if(tp===ENUM_OT_FORM){tp=ENUM_OT_ATTRIBUTE;}submitR(callback,{manipulationtype:Enum_SM_CreateColumnAlias,objectid:oid,objecttype:tp,baseformid:bfidx,objectname:columnName,objectdef:JSON.stringify(def),showWait:false},"schemaManipulation");},updateColumn:function updateColumn(column,colData,callback){var $this=this,cmid=column.cmid,cln=column.cln;submitR($WRAP({success:function success(){if(column.n!==cln){var updateExpression=function updateExpression(info){var exp=info.expression,cols=$this.getAllColumnsForExpression(exp);$A.forEach(cols,function(col){if(col&&(col.cmid===cmid)){info.expression=info.expression.replace(col.cln,cln);}});};$H.forEach($this.tables,function(tbl){$H.forEach(tbl.attributeInfos,function(attinfo){updateExpression(attinfo);updateExpression(attinfo.baseForms[attinfo.baseFormId]);});$H.forEach(tbl.factInfos,function(fctinfo){updateExpression(fctinfo);});});$H.forEach($this.transformations,function(transformation){$H.forEach(transformation.elements,function(element){updateExpression(element);});});}colData.cln=column.cln;colData.dt.tp=column.dt.tp;colData.dt.ps=column.dt.ps;colData.dt.sc=column.dt.sc;colData.tableId=column.tableId;var table=$this.getTable(column.tableId);$this.raiseTableChangeEvent(table);}},callback),{manipulationtype:Enum_SM_UpdateColumn,objectdef:JSON.stringify(column),showWait:false},"schemaManipulation");},updateAggregation:function updateAggregation(data,menuItem){var model=this,fact=model.getFact(data.did);$H.copy(menuItem.aggr,fact);},switchLayer:function switchLayer(layerId){if(layerId!==""){var $this=this,newlayer=this.layers[layerId];if(newlayer){newlayer.loadDefinition({success:function success(){var tables=newlayer&&newlayer.tables;if(tables&&Object.keys(tables).length>0){$this.getAttributesFactsInTable(Object.keys(tables).toString(),{success:function success(){newlayer.loadRelations({mdl:$this,complete:function complete(res){var aam=this.mdl.askAutoMap;this.mdl.askAutoMap=false;this.mdl.set("currentlayerID",res.id);this.mdl.askAutoMap=aam;}});}});}else{$this.set("currentlayerID",layerId);}}});}else{this.set("currentlayerID","");}}else{this.set("currentlayerID","");}},loadLayers:function loadLayers(callback){var $this=this,cb={success:function success(res){$A.forEach(res.layers,function(layer){var mdllayer=$this.layers[layer.did];if(!mdllayer){$this.layers[layer.did]=new mstrmojo.architect.obj.Layer({mdl:$this,id:layer.did,n:layer.n});}});}};if(Object.keys($this.layers).length===0){submitR($WRAP(cb,callback),{objecttypes:ENUM_OT_LAYER,xmlflags:1,namepattern:"",flags:512,specialparse:"getLayers"},"search");}else{if(callback&&callback.success){callback.success();}}},_set_currentlayerID:function _set_currentlayerID(n,layerId){var $this=this,prev=this.currentlayerID,items=$this.getAllLayers();if((prev!==layerId)||(this.forceReloadLayer)){this.forceReloadLayer=false;this.currentlayerID=layerId;this.getRelations({success:function success(relInfo){$this.raiseEvent({name:EVENT_LAYER_CHANGE,value:layerId,relations:relInfo.relations,positions:relInfo.attributePositions,layers:items});}});}},getAllLayers:function getAllLayers(){var layers=this.layers,items=[];$H.forEach(layers,function(layer){var layerItems=[];$H.forEach(layer.tables,function(table){layerItems.push(table.getTableData());});items.push({n:layer.name,did:layer.id,items:layerItems,tp:layer.tp});});return items;},getLayer:function getLayer(id){return this.layers[id];},updateRelation:function updateRelation(parentAttributeId,childAttributeId,relationType,relationTableId){var model=this,source=getViewSource.call(this),cbUpdateRelation={success:function success(relation){model.invalidateRelations();model.getRelations({success:function success(rels){model.raiseEvent({name:EVENT_REL_CHANGED,item:relation,relations:rels.relations,positions:rels.attributePositions,storePositions:false});model.getSystemDimensionAttributes({success:function success(rels){model.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}});}};source.updateRelation(parentAttributeId,childAttributeId,relationTableId,relationType,cbUpdateRelation);},addRelation:function addRelation(parentAttributeId,childAttributeId,relationTableId){var model=this,source=getViewSource.call(this),cbAddRelation={success:function cbAddRelation(relation){model.invalidateRelations();model.getRelations({success:function success(rels){model.raiseEvent({name:EVENT_REL_CHANGED,item:relation,relations:source.relations,positions:source.attributePositions,entryPoints:rels.entryPoints,attributeProperties:rels.attributeProperties,storePositions:false});if(model.currentView!==ENUM_VIEW_USERHIER){model.getSystemDimensionAttributes({success:function success(rels){model.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}}});}};source.addRelation(parentAttributeId,childAttributeId,cbAddRelation,relationTableId);},autoArrange:function autoArrange(){var model=this,source=getViewSource.call(this);model.getRelations({success:function success(rels){model.raiseEvent({name:EVENT_REL_CHANGED,relations:source.relations,entryPoints:rels.entryPoints,attributeProperties:rels.attributeProperties,storePositions:true});model.getSystemDimensionAttributes({success:function success(rels){model.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}});},removeRelation:function removeRelation(parentAttributeId,childAttributeId){var model=this,positions={},source=getViewSource.call(this),cbUpdateRelation={success:function success(){model.invalidateRelations();model.getRelations({success:function success(rels){model.raiseEvent({name:EVENT_REL_CHANGED,item:{parentAttributeId:parentAttributeId,childAttributeId:childAttributeId},entryPoints:rels.entryPoints,attributeProperties:rels.attributeProperties,relations:rels.relations,positions:positions,storePositions:false});if(model.currentView!==ENUM_VIEW_USERHIER){model.getSystemDimensionAttributes({success:function success(rels){model.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}}});}};source.removeRelation(parentAttributeId,childAttributeId,cbUpdateRelation);positions=source.attributePositions;},removeFromHierarchy:function removeFromHierarchy(attributeId){var model=this,positions={},source=getViewSource.call(this),cbremoveFromHierarchy={success:function success(){model.invalidateRelations();model.getRelations({success:function success(rels){model.raiseEvent({name:EVENT_REL_CHANGED,item:{parentAttributeId:attributeId,childAttributeId:attributeId},relations:rels.relations,positions:positions,attributeProperties:rels.attributeProperties,entryPoints:rels.entryPoints,storePositions:false});if(model.currentView!==ENUM_VIEW_USERHIER){model.getSystemDimensionAttributes({success:function success(rels){model.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}}});}};source.removeAttributes([{atid:attributeId}],cbremoveFromHierarchy);positions=source.attributePositions;},getRelation:function getRelation(parentAttributeId,childAttributeId){var source=getViewSource.call(this);return(parentAttributeId&&childAttributeId)?source.getRelation(parentAttributeId,childAttributeId):source.relations;},getRelations:function getRelations(callback){var model=this,sysDim=getSystemDimension.call(model);switch(this.currentView){case ENUM_VIEW_LAYER:if(this.currentlayerID===""){callback.success([]);return ;}var layer=this.layers[this.currentlayerID];layer.getRelations({success:function success(rels){callback.success({relations:rels,attributePositions:layer.attributePositions});}});return ;case ENUM_VIEW_SYSDIM:sysDim.load(callback);return ;case ENUM_VIEW_USERHIER:if(this.currentHierarchyID===""){callback.success([]);return ;}this.userHierarchies[this.currentHierarchyID].load(callback);return ;case ENUM_VIEW_TRANSFORMATION:sysDim.load(callback);return ;default:callback.success([]);return ;}},getSystemDimensionAttributes:function getSystemDimensionAttributes(callback){var model=this,sysDim=getSystemDimension.call(model);sysDim.getRelations(callback);},hasRelation:function hasRelation(data){var relations,affectedAttributes=[],source=getViewSource.call(this),counter=0,attrID=data.attributeId;relations=source.relations;affectedAttributes.push(attrID);$H.forEach(relations,function(relation){if(((relation.childAttributeId===attrID)||(relation.parentAttributeId===attrID))&&((relation.childAttributeId!=="")||(relation.parentAttributeId!==""))){counter++;}});return(counter!==0);},invalidateRelations:function invalidateRelations(attributesChanged){var layerID="";switch(this.currentView){case ENUM_VIEW_LAYER:getSystemDimension.call(this).relationsLoaded=false;layerID=this.currentlayerID;break;case ENUM_VIEW_SYSDIM:break;}$H.forEach(this.layers,function(layer){if((layerID==="")||attributesChanged||(layerID!==layer.id)){layer.relationsLoaded=false;}});},removeAttributeFromRelation:function removeAttributeFromRelation(data){var $this=this,affectedAttributes=[],distinctAffectedAttributes=[],relations,positions,source=getViewSource.call(this),counter=0,attrID=data.did||data.attributeId,i;relations=source.relations;positions=source.attributePositions;delete positions[data.attributeId];affectedAttributes.push(attrID);$H.forEach(relations,function(relation){if(((relation.childAttributeId===attrID)||(relation.parentAttributeId===attrID))&&relation.childAttributeId!==""){counter++;source.removeRelation(relation.parentAttributeId,relation.childAttributeId,{success:function success(){affectedAttributes.push(relation.parentAttributeId);affectedAttributes.push(relation.childAttributeId);},complete:function complete(){if(--counter===0){affectedAttributes.sort();distinctAffectedAttributes.push(affectedAttributes[0]);for(i=1;i<affectedAttributes.length;i++){if(affectedAttributes[i-1]!==affectedAttributes[i]){distinctAffectedAttributes.push(affectedAttributes[i]);}}$this.invalidateRelations();$this.getRelations({success:function success(rels){$this.raiseEvent({name:EVENT_REL_CHANGED,affectedAttributes:distinctAffectedAttributes,relations:rels.relations,positions:rels.attributePositions,storePositions:false});$this.getSystemDimensionAttributes({success:function success(rels){$this.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}});}}});}});if(counter===0){$this.getRelations({success:function success(rels){$this.raiseEvent({name:EVENT_REL_CHANGED,affectedAttributes:affectedAttributes,relations:rels.relations,positions:rels.attributePositions,storePositions:false});$this.getSystemDimensionAttributes({success:function success(){$this.getSystemDimensionAttributes({success:function success(rels){$this.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}});}});}},updateRelationPositions:function updateRelationPositions(positions,elementId){var model=this,view;if(!(positions&&mstrApp.rootController.getObjectCount(positions))){return ;}if(model.currentView===ENUM_VIEW_USERHIER&&elementId){model.userHierarchies[elementId].updateAttributePositions(positions,{success:mstrmojo.emptyFn});}else{view=getViewSource.call(this);if(view){view.updateAttributePositions(positions,{success:mstrmojo.emptyFn});}}},automapColumn:function automapColumn(columnId,tableId,callback){var model=this,table=model.getTable(tableId);table.automapColumn(columnId,callback);},findDependentsByNameSearch:function findDependentsByNameSearch(name){name=mstrmojo.string.trim(name);if(name===""){this.getProjectTables();return ;}var $this=this;submitR({success:function success(res){$this.tryQS=res.tryQS;var items=[];$H.forEach(res.es,function(element){items.push({did:element.did,n:element.n,tp:element.tp,isVisible:function isVisible(data,item){if(this.tp===ENUM_OT_TABLE){return $this.handleVisibleAction(data,item);}return false;},isChecked:function isChecked(data,item){if(this.tp===ENUM_OT_TABLE){return $this.handleCheckAction(data,item);}return false;},isEnabled:function isEnabled(data,item){if(this.tp===ENUM_OT_TABLE){return $this.handleEnabledAction(data,item);}return false;},items:[],isSearch:true,ttp:""});});var results=[{n:mstrmojo.desc(73,"search result"),tp:"search",did:"SEARCH",isVisible:function isVisible(){return false;},items:items}];$this.raiseEvent({name:EVENT_TABLES_LOADED,items:results});}},{namepattern:name,tryQS:$this.tryQS},"nameSearchTable");},loadSearchObjectContents:function loadSearchObjectContents(item,callback){var $this=this;if(item.tp===ENUM_OT_TABLE){$this.getAttributesFactsInTable(item.did,$WRAP({success:function success(res){if(res&&res.items&&res.items.items&&res.items.items[0]){res.items=res.items.items[0].items;}}},callback));}else{submitR($WRAP({success:function success(res){var tableItems=[];$A.forEach([].concat(res.oi),function(data){var table=$this.getTable(data.did);tableItems.push(table.getTableData());});res.items=tableItems;}},callback),{dependent:JSON.stringify({did:item.did,n:item.n,tp:item.tp}),tryQS:$this.tryQS},"nameSearchTable");}},createObject:function createObject(type,name,clnid,callback){var model=this,newObject,createCb={success:function suc(){var typeArr=(type===ENUM_OT_ATTRIBUTE)?model.attributes:model.facts;typeArr[newObject.id]=newObject;callback.success(newObject);}};newObject=(type===ENUM_OT_ATTRIBUTE)?new mstrmojo.architect.obj.Attribute({isNew:true,name:name,callback:createCb}):new mstrmojo.architect.obj.Fact({isNew:true,name:name,callback:createCb});},renameObject:function renameObject(id,type,newName,bfIdx,sid){var model=this,renameCb={success:function suc(){model.raiseEvent({name:EVENT_RENAME,value:newName,did:id,tp:type,bfIdx:bfIdx});if(type===ENUM_OT_FORM){var att=model.attributes[sid],frm=att.forms[bfIdx];model.raiseTableChangeEvent(model.getTable(frm.tableId));}else{if(type===ENUM_OT_ATTRIBUTE){model.invalidateRelations(true);}else{if(type===ENUM_OT_TABLE){mstrApp.getRootController().saveAndUpdate();}}}}};switch(type){case ENUM_OT_ATTRIBUTE:var attribute=model.attributes[id];attribute.rename(newName,renameCb);break;case ENUM_OT_FACT:var fact=model.facts[id];fact.rename(newName,renameCb);break;case ENUM_OT_TABLE:var table=model.getTable(id);table.rename(newName,renameCb);break;case ENUM_OT_TRANSFORMATION:var transformation=model.transformations[id];transformation.rename(newName,renameCb);break;case ENUM_OT_FORM:var att=model.attributes[sid],frm=att.forms[bfIdx];frm.useDescription=newName;frm.useName=newName;frm.update(renameCb);break;}},deleteObject:function deleteObject(data){var model=this,type=data.tp,id=data.did,target,isView=false,tp,table=(type!==ENUM_OT_TABLE)?model.getTable(data.pdid):null,deleteCb={success:function suc(){var source=getViewSource.call(this),relations,lIndex=0;switch(type){case ENUM_OT_ATTRIBUTE:target=model.attributes;if(target[id]){delete target[id];}tp=type;if(source){relations=source.relations;$H.forEach(relations,function(relation){if(((relation.childAttributeId===id)||(relation.parentAttributeId===id))&&relation.childAttributeId!==""){relations.splice(lIndex,1);return false;}lIndex++;return true;});}break;case ENUM_OT_FACT:target=model.facts;if(target[id]){delete target[id];}tp=type;break;case ENUM_OT_TRANSFORMATION:target=model.transformations;if(target[id]){delete target[id];}tp=type;model.raiseEvent({name:EVENT_TRANSFORMATIONS_CHANGED,items:model.getTransformations()});break;case ENUM_OT_DIMENSION:target=model.userHierarchies;if(target[id]){delete target[id];}tp=type;model.updateHierarchiesList();break;case ENUM_OT_TABLE:target=model.tables;isView=target[id].isView;if(target[id]){delete target[id];}delete model.dbRoleTables[decodeDBRoleID.call(model,data.dbrole)][id];if(isView){delete model.logicalViews[id];model.raiseEvent({name:EVENT_LOGICALVIEWS_CHANGED,views:model.logicalViews,value:""});}tp=type;model.raiseEvent({name:DBTABLES_USED,items:model.getDBRoleTablesInUse(model.SelDBRoleID)});break;case ENUM_OT_FORM:tp=ENUM_OT_FORM;break;}model.raiseEvent({name:EVENT_REMOVE,value:null,did:id,tp:tp});if((type!==ENUM_OT_TABLE)&&table&&(table.columnDisplay===Enum_TD_Columns_Unused)){model.raiseEvent({name:EVENT_LAYER_TABLE_CHANGE,item:table.getTableData(true)});}}};switch(type){case ENUM_OT_ATTRIBUTE:var attribute=model.attributes[id];attribute.remove(deleteCb);break;case ENUM_OT_FACT:var fact=model.facts[id];fact.remove(deleteCb);break;case ENUM_OT_TABLE:var tbl=model.getTable(id);tbl.remove(deleteCb);break;case ENUM_OT_FORM:model.removeAttributeForm(data.sid,data.bfIdx,deleteCb);break;case ENUM_OT_TRANSFORMATION:var transformation=model.transformations[id];transformation.remove(deleteCb);break;case ENUM_OT_DIMENSION:var dimension=model.userHierarchies[id];dimension.remove(deleteCb);break;}},addLogicalView:function addLogicalView(useDefaultName,newLogicalViewName){var model=this;var createViewCb={success:function success(logicalView){mstrApp.rootController.switchLogicalView(logicalView.id);model.raiseEvent({name:EVENT_TABLES_ADDED,items:model.createViewableTable(logicalView.primaryDBRole,[logicalView.getTableData()])});}};this.createTable(useDefaultName,newLogicalViewName,{type:3},createViewCb);},setTransformationCardinality:function setTransformationCardinality(transformationId,onetoOneMappingType){var transformation=this.transformations[transformationId];transformation.setMappingType(onetoOneMappingType);},setTransformationAllAttributes:function setTransformationAllAttributes(transformationId,transformationAllAttributes){var transformation=this.transformations[transformationId];transformation.setAttributeScope(transformationAllAttributes);},getTransformations:function getTransformations(){var $this=this;$this.getSystemDimensionAttributes({success:function success(rels){$this.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});return $H.valarray(this.transformations);},editTransformation:function editTransformation(transformationId){var model=this,transformation=model.transformations[transformationId];model.currentTransformationId=transformationId;if(transformationId===""||(!transformation)){return ;}transformation.load({success:function success(){model.raiseEvent({name:EVENT_TRANSFORMATION_UPDATED,items:transformation.getTransformationData(),value:transformation,source:0});}});model.getSystemDimensionAttributes({success:function success(rels){model.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});},loadTransformations:function loadTransformations(cb){var model=this,callback={success:function success(res){var transformations=[].concat(res.oi||[]),transformation;$A.forEach(transformations,function(trnsfrm){transformation=new mstrmojo.architect.obj.Transformation({isNew:false,id:trnsfrm.did,n:trnsfrm.n,onetoOneMappingType:(trnsfrm.def.ert===1),transformationAllAttributes:true,mdl:model});model.transformations[transformation.id]=transformation;});model.raiseEvent({name:EVENT_TRANSFORMATIONS_CHANGED,items:model.getTransformations()});}};if(Object.keys(model.transformations).length===0){model.submitRequest($WRAP(callback,cb),{objecttypes:ENUM_OT_TRANSFORMATION,flags:1+2+256+512,xmlflags:1},"search");}else{model.raiseEvent({name:EVENT_TRANSFORMATIONS_CHANGED,items:model.getTransformations()});if(cb&&cb.success){cb.success();}}},addTransformation:function addTransformation(useDefaultName,newTransformationName){var model=this;mstrmojo.insert(new mstrmojo.architect.obj.Transformation({defaultName:useDefaultName,newTransformationName:newTransformationName,isNew:true,mdl:model,callback:{success:function success(trans){model.transformations[trans.id]=trans;model.currentTransformationId=trans.id;model.raiseEvent({name:EVENT_TRANSFORMATIONS_CHANGED,items:model.getTransformations()});model.raiseEvent({name:EVENT_TRANSFORMATION_UPDATED,items:trans.getTransformationData(),value:trans,source:0});model.getSystemDimensionAttributes({success:function success(rels){model.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}}}));},addTransformationElement:function addTransformationElement(id,attributeID,expression,tableID,attributeName,tableName,source){var model=this,transformation=model.transformations[id];transformation.addElement(attributeID,expression,tableID,{success:function success(){model.raiseEvent({name:EVENT_TRANSFORMATION_UPDATED,items:transformation.getTransformationData(),value:transformation,source:source,attributeID:attributeID});}},attributeName,tableName);},removeTransformationElement:function removeTransformationElement(id,attributeID){var model=this,transformation=model.transformations[id];transformation.removeElement(attributeID,{success:function success(trans){model.raiseEvent({name:EVENT_TRANSFORMATION_UPDATED,items:trans.getTransformationData(),value:trans,attributeID:attributeID});}});},addLayer:function addLayer(callback,useDefaultName,newLayerName){var model=this,layer=new mstrmojo.architect.obj.Layer({defaultName:useDefaultName,newLayerName:newLayerName,isNew:true,mdl:model,callback:$WRAP(callback,{success:function success(newLayerID){model.layers[newLayerID]=layer;model.switchLayer(newLayerID);}})});},deleteLayer:function deleteLayer(layerId){var $this=this,layer=this.getLayer(layerId);layer.remove({model:$this,success:function success(did){var layers=this.model.layers;if(layers[did]){delete layers[did];}$this.forceReloadLayer=true;if($this.currentlayerID===layerId){$this.switchLayer(Object.keys(layers)[0]||"");}else{$this.switchLayer($this.currentlayerID);}}});},addAttributeToHierarchy:function addAttributeToHierarchy(attributeID,attributeName,callback){var model=this;model.userHierarchies[model.currentHierarchyID].addAttribute(attributeID,attributeName,callback);},addEntryPoint:function addEntryPoint(attributeID){var model=this;model.userHierarchies[model.currentHierarchyID].addEntryPoints([{atid:attributeID}]);},removeEntryPoint:function addEntryPoint(attributeID){var model=this;model.userHierarchies[model.currentHierarchyID].removeEntryPoints([{atid:attributeID}]);},loadUserHierarchies:function loadUserHierarchies(hierarchyId){var $this=this,userHierarchies=$this.userHierarchies,loadUserHierarchy=function loadUserHierarchy(){$this.currentHierarchyID=hierarchyId;if(hierarchyId&&userHierarchies[hierarchyId]){userHierarchies[hierarchyId].load({success:function success(evt){$this.raiseEvent({name:EVENT_REL_CHANGED,hierarchyId:hierarchyId,relations:evt.relations,positions:evt.attributePositions,entryPoints:evt.entryPoints,attributeProperties:evt.attributeProperties,viewType:$ENUM_VIEW_TYPES.USER_HIERARCHY,storePositions:false});$this.getSystemDimensionAttributes({success:function success(rels){$this.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}});}else{$this.raiseEvent({name:EVENT_REL_CHANGED,hierarchyId:"",relations:[],positions:[],entryPoints:[],viewType:$ENUM_VIEW_TYPES.USER_HIERARCHY,storePositions:false});}$this.raiseEvent({name:EVENT_USERHIERARCHY_CHANGED,value:hierarchyId});},cb={success:function success(res){$A.forEach(res.dimensions,function(dimension){userHierarchies[dimension.did]=new mstrmojo.architect.obj.UserHierarchy({model:$this,did:dimension.did,n:dimension.n,useForDrill:(dimension.stp===DRILL_TYPE_USERHIERARCHY)});});loadUserHierarchy();}};if(mstrApp.rootController.getObjectCount(userHierarchies)===0){submitR($WRAP(cb,{success:function success(){$this.raiseEvent({name:EVENT_USERHIERARCHY_LOADED,hierarchies:$H.valarray($this.userHierarchies)});if(hierarchyId){loadUserHierarchy();}}}),{objecttypes:ALL_TYPE_USERHIERARCHY,xmlflags:1,flags:512,specialparse:"getDimensions"},"search");}else{loadUserHierarchy();}},updateHierarchiesList:function updateHierarchiesList(){var $this=this,userHierarchies=[];$H.forEach($this.userHierarchies,function(hierarchy){userHierarchies.push({model:$this,did:hierarchy.did,n:hierarchy.n,tp:ENUM_OT_DIMENSION});});$this.raiseEvent({name:EVENT_USERHIERARCHY_LOADED,hierarchies:userHierarchies});},addUserHierarchy:function addUserHierarchy(newName,callback){var $this=this,hierarchyId,userHierarchy=new mstrmojo.architect.obj.UserHierarchy({model:$this,isNew:true,name:newName,callback:$WRAP(callback,{success:function success(res){hierarchyId=res.userHierarchy.did;$this.currentHierarchyID=hierarchyId;$this.userHierarchies[hierarchyId]=userHierarchy;userHierarchy.load({success:function success(evt){$this.raiseEvent({name:EVENT_REL_CHANGED,hierarchyId:hierarchyId,relations:evt.relations,viewType:$ENUM_VIEW_TYPES.USER_HIERARCHY,storePositions:false});$this.getSystemDimensionAttributes({success:function success(rels){$this.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});$this.raiseEvent({name:EVENT_USERHIERARCHY_CHANGED,value:hierarchyId});$this.updateHierarchiesList();}});}})});},setHierarchyAttributeLockProperty:function setHierarchyAttributeLockProperty(attributeID,lockStatus,lockLimit,callback){this.userHierarchies[this.currentHierarchyID].setAttributeLockProperty(attributeID,lockStatus,lockLimit,callback);},updateHiearchySubtype:function updateHiearchySubtype(userDrillHierarchy,callback){this.userHierarchies[this.currentHierarchyID].updateHiearchySubtype(userDrillHierarchy,callback);},getHierarchyAttributeFilters:function getHierarchyAttributeFilters(attributeID){return this.userHierarchies[this.currentHierarchyID].getAttributeFilters(attributeID);},setHierarchyAttributeFilters:function setHierarchyAttributeFilters(attributeID,filters,callback){this.userHierarchies[this.currentHierarchyID].setAttributeFilters(attributeID,filters,callback);},addJointChildren:function addJointChildren(relation,secondChildAttributeID){var model=this,dimen=getViewSource.call(this),cbAddRelation={success:function cbAddRelation(relation){model.invalidateRelations();model.getRelations({success:function success(){model.raiseEvent({name:EVENT_REL_CHANGED,item:relation,relations:dimen.relations,positions:dimen.attributePositions,storePositions:false});model.getSystemDimensionAttributes({success:function success(rels){model.raiseEvent({name:EVENT_ATTRIBUTES_CHANGED,relations:rels});}});}});}};dimen.addJointRelation(relation,secondChildAttributeID,cbAddRelation);},getJointChildrenCandidates:function getJointChildrenCandidates(relation){var model=this,candidates=[],notAllowed={},source=getViewSource.call(this),table=model.getTable(relation.relationTableId),jointChildRelations=[],tableData=table.getTableData();notAllowed[relation.parentAttributeId]=relation.parentAttributeId;notAllowed[relation.childAttributeId]=relation.childAttributeId;if(relation.isJointChildren){jointChildRelations=source.getRelatedRelations(relation.parentAttributeId);$A.forEach(jointChildRelations,function(relation){notAllowed[relation.childAttributeId]=relation.childAttributeId;return true;});}$H.forEach(tableData.items,function(info){if(info.tp===12&&notAllowed[info.did]===undefined){candidates.push(info);}});return candidates;},getProjects:function getProjects(params,callback){submitR(callback,params,"getProjects");},tokenizeExpression:function tokenizeExpression(expr,tableId,callback){var model=this;if(expr===""){if(callback&&callback.success){callback.success();}}else{model.validateExpr({expr:expr,tid:tableId,vo:null},{success:function suc(res){if(res&&res.mi.oi.tknstrm.mi){var tks=res.mi.oi.tknstrm.mi;model.trimTokenEnds(tks.tkn);if(callback&&callback.success){callback.success(tks);}}}});}},trimTokenEnds:function trimTokenEnds(tokens){var last=tokens[tokens.length-1];if(last&&last.tp===-1){tokens.pop();}if(tokens[0]&&(tokens[0].tp===64||(tokens[0].tp===33&&tokens[0].v==="!"))){tokens.splice(0,1);}},validateExpr:function validateExpr(params,callback){if(params.expr===""){return ;}submitR(callback,{exp:params.expr,tbls:params.tid,vo:(params.vo===1)?1:0},"parse");},validateTransformationExpr:function validateTransformationExpr(params,callback){if(params.expr===""){return false;}submitR(callback,{exp:params.expr,tbls:params.tid,vo:(params.vo===1)?1:0},"parse");return true;},getObjectInBulk:function getObjectInBulk(pair,callback){submitR(callback,{objects:pair.join(";")},"getObjects");},changeLayerTableColumnView:function changeLayerTableColumnView(data,menuItem){var table=this.getTable(data.did);switch(table.columnDisplay){case table.EnumColumnDisplay.None:table.columnDisplay=menuItem.view;break;default:table.columnDisplay=table.EnumColumnDisplay.None;break;}this.raiseTableChangeEvent(table);},loadFunctions:function loadFunctions(callback){var $this=this,parseError=false;if($this.functions){callback.success();return ;}var storedFunctions=(window.sessionStorage&&window.sessionStorage.getItem("functions"));if(storedFunctions){try{$this.functions=JSON.parse(storedFunctions).fncs;}catch(err){parseError=true;}if(!parseError){callback.success();return ;}}submitR({success:function success(res){var sortFunc=function sortFunc(a,b){return $A.stringSorter(a.n,b.n);};res.fncs=res.fncs.sort(sortFunc);$A.forEach(res.fncs,function(fn){fn.fns=fn.fns.sort(sortFunc);});$this.functions=res.fncs;if(window.sessionStorage){window.sessionStorage.setItem("functions",JSON.stringify(res));}callback.success();}},{includeFunctionDetails:false,functionFlags:2+4,showWait:true},"getSystemFunctions");},getTablesForRelationship:function getTablesForRelationship(attId1,attId2){var tables=[],source=getViewSource.call(this),attInfos;switch(this.currentView){case ENUM_VIEW_LAYER:$H.forEach(source.tables,function(table){attInfos=table.attributeInfos;if(attInfos[attId1]&&attInfos[attId2]){tables.push({n:table.name,did:table.id});}});break;default:tables=source.getTablesForRelationship(attId1,attId2);break;}return tables;},prePopulateRelationMenu:function prePopulateRelationMenu(relation,callback){var $this=this;if((relation.relationTableId===undefined)||(relation.relationTableId==="")){callback.success();}else{$this.getAttributesFactsInTable(relation.relationTableId,{success:function success(){if(!relation.isSysDimension){callback.success();}else{$this.sysDimension.loadTablesForRelationship(relation,callback);}}});}},searchAttributeTables:function searchAttributeTables(attrId,callback){this.submitRequest(callback,{objecttypes:15,uses:attrId+",12;",flags:1+2+256+512,xmlflags:1},"search");},openExpressionEditor:function openExpressionEditor(data,menuItem){var $this=this,isNew=menuItem.isNew,tableId=isNew?data.did:data.pdid,table=$this.getTable(tableId),objectForExpression,info={tbl:{clns:table.columns,did:tableId},data:data,isNew:isNew},cbApplyExpr={success:function success(){$this.raiseTableChangeEvent(table);}};if(!isNew){objectForExpression=(menuItem.tp===ENUM_OT_FACT)?table.factInfos[data.did]:table.attributeInfos[data.sid].baseForms[data.bfIdx];info.objectForExpression=objectForExpression;}$this.tokenizeExpression((objectForExpression&&objectForExpression.expression)||"",tableId,{success:function success(tokens){$this.loadFunctions({success:function success(){var exprEditor=mstrmojo.all.ExpressionEditor,columnId;if(!exprEditor){exprEditor=new mstrmojo.architect.ExpressionEditor();exprEditor.functions=$this.functions;exprEditor.validationFunc=$this.validateExpr;}exprEditor.callBackFunction=function callBackFunction(expInfo){var expression=expInfo.expression,column=expInfo.expressionColumn||$this.getColumnForExpression(expression)||$this.columns[Object.keys($this.columns)[0]],cbNewCol={success:function success(res){if(expInfo.needsNewCol){var oid=res,bfidx=info.data.bfIdx||0;$this.createColumnAlias(oid,bfidx,menuItem.tp,info.data.n+" "+STRING_ALIAS,{tp:expInfo.selItem.id,ps:expInfo.precision,sc:expInfo.scale},{success:function success(res){var newColumn=new mstrmojo.architect.obj.Column({tableInfo:res.col});$this.columns[newColumn.cmid]=newColumn;if(menuItem.tp===ENUM_OT_FACT){$this.updateFactInfo(oid,expInfo.expression,newColumn.cmid,tableId,cbApplyExpr);}else{$this.updateAttributeInfo(bfidx,oid,expInfo.expression,newColumn.cmid,tableId,cbApplyExpr);}}});}else{cbApplyExpr.success();}}};if(isNew){if(column){columnId=column.cmid;data.n=column.cln;}var renameEditor=new mstrmojo.architect.ui.editors.NameEditor({data:data,tp:menuItem.tp,isNew:true,onOK:function onOK(name){if(menuItem.tp===ENUM_OT_FACT){$this.createFactInTable(tableId,expression,columnId,name,cbNewCol);}else{$this.createAttributeInTable(tableId,expression,columnId,name,cbNewCol);}}});renameEditor.open();}else{if(!expInfo.dtChanged){if(menuItem.tp===ENUM_OT_FACT){$this.updateFactInfo(data.did,expression,column.cmid,tableId,cbNewCol);}else{$this.updateAttributeInfo(data.bfIdx,data.sid,expression,column.cmid,tableId,cbNewCol);}}else{column.dt.tp=expInfo.selItem.id;column.dt.ps=expInfo.precision;column.dt.sc=expInfo.scale;column.tableId=expInfo.tblId;mstrApp.getRootController().updateColumn(column,column,{success:function success(){if(menuItem.tp===ENUM_OT_FACT){$this.updateFactInfo(data.did,expression,column.cmid,tableId,cbNewCol);}else{$this.updateAttributeInfo(data.bfIdx,data.sid,expression,column.cmid,tableId,cbNewCol);}}});}}};exprEditor.set("title",isNew?((menuItem.tp===ENUM_OT_ATTRIBUTE)?"New Attribute":"New Fact"):data.n);exprEditor.model=$this;if(tokens){info.tokens=tokens.tkn;}else{info.tokens=[];}exprEditor.set("oi",info);exprEditor.open();}});}});},getLinks:function getLinks(obj,callback){var did=obj.did,tp=obj.tp,bfidx=0;if(tp===ENUM_OT_FORM){tp=ENUM_OT_ATTRIBUTE;did=obj.sid;bfidx=obj.bfIdx;}this.submitRequest(callback,{objectId:did,objectType:tp,exp:obj.n,bfidx:bfidx},"getLinkInfo");},searchFilters:function searchFilters(callback){this.submitRequest(callback,{objecttypes:1,flags:1+2+256+512,xmlflags:1},"search");}});mstrmojo.architect.ArchitectModel.EnumSchemaManipulation={CreateObject:Enum_SM_CreateObject,DeleteObject:Enum_SM_DeleteObject,RenameObject:Enum_SM_RenameObject,AddFactInfo:Enum_SM_AddFactInfo,RemoveFactInfo:Enum_SM_RemoveFactInfo,UpdateFactInfo:Enum_SM_UpdateFactInfo,AddAttributeInfo:Enum_SM_AddAttributeInfo,RemoveAttributeInfo:Enum_SM_RemoveAttributeInfo,UpdateAttributeInfo:Enum_SM_UpdateAttributeInfo,AutoRecognizeTable:Enum_SM_AutoRecognizeTable,SetAsLookup:Enum_SM_SetAsLookup,AddAttributeForm:Enum_SM_AddAttributeForm,UpdateAttributeForm:Enum_SM_UpdateAttributeForm,CreateAttributeRelation:Enum_SM_CreateAttributeRelation,RemoveAttributeRelation:Enum_SM_RemoveAttributeRelation,GetAttributeRelation:Enum_SM_GetAttributeRelation,ConvertAttributeToFact:Enum_SM_ConvertAttributeToFact,ConvertFactToAttribute:Enum_SM_ConvertFactToAttribute,InsertAttributeRelation:Enum_SM_InsertAttributeRelation};}());