(function(){mstrmojo.requiresCls("mstrmojo.Obj");var $A=mstrmojo.array,$H=mstrmojo.hash,$WRAP=mstrmojo.func.wrapMethods,$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,ENUM_OT_TRANSFORMATION=parseInt($ENUM_OT.TRANSFORMATION,10),ENUM_OT_COLUMN=parseInt($ENUM_OT.COLUMN,10),DEFAULT_TRANSFORMATION_NAME=mstrmojo.desc(12246,"New transformation"),Enum_SM_CreateObject=1,Enum_SM_DeleteObject=2,Enum_SM_RenameObject=3,Enum_SM_UpdateTransformationElements=1005,Enum_SM_GetTransformationElements=1006;function createTransformation(transformationName,callback){var transformation=this;transformation.isDirty=true;transformation.model.submitRequest({success:function(res){var objectInfo=res.mi["in"].oi;transformation.id=objectInfo.did;transformation.name=transformationName;if(callback&&callback.success){callback.success(transformation);}}},{manipulationtype:Enum_SM_CreateObject,objecttype:ENUM_OT_TRANSFORMATION,objectname:transformationName},"schemaManipulation");}mstrmojo.architect.obj.Transformation=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.architect.obj.Transformation",init:function init(props){this.model=props.mdl;this.elements={};if(props.isNew){if(props.defaultName){createTransformation.call(this,mstrApp.rootController.findNextName(DEFAULT_TRANSFORMATION_NAME,$H.valarray(this.model.transformations),"name"),props.callback);}else{if(mstrApp.getRootController().validateName(ENUM_OT_TRANSFORMATION,props.newTransformationName,this.name)){createTransformation.call(this,props.newTransformationName,props.callback);}}this.isLoaded=true;}else{this.id=props.id;this.name=props.n;this.onetoOneMappingType=props.onetoOneMappingType;this.transformationAllAttributes=props.transformationAllAttributes;this.isLoaded=false;}},tri:undefined,tris:undefined,ban:undefined,name:"",id:"",tp:ENUM_OT_TRANSFORMATION,transformationAllAttributes:true,onetoOneMappingType:true,elements:{},isDirty:false,isLoaded:false,setMappingType:function setMappingType(type){var transformation=this;transformation.onetoOneMappingType=type;transformation.isDirty=true;},setAttributeScope:function setAttributeScope(scope){var transformation=this;transformation.transformationAllAttributes=scope;transformation.isDirty=true;},commit:function commit(callback){var transformation=this,rootController=mstrApp.rootController,attIDs=[],exprs=[],tblIDs=[],colIDs=[],total=rootController.getObjectCount(transformation.elements),index=0,mappingType=transformation.onetoOneMappingType?1:4,roleProcess=transformation.transformationAllAttributes?0:1;if(transformation.isDirty){$H.forEach(transformation.elements,function(element){rootController.validateExpr({expr:element.expression,tid:element.tableID,vo:1},{success:function success(res){if(res&&res.mi.oi.tknstrm.mi){rootController.trimTokenEnds(res.mi.oi.tknstrm.mi.tkn);$A.forEach([].concat(res.mi.oi.tknstrm.mi["in"].oi),function(oi){if(oi.tp===ENUM_OT_COLUMN){if(element.isValid===true){attIDs.push(element.attributeID);exprs.push(element.expression);tblIDs.push(element.tableID);colIDs.push(oi.did);}}});}},complete:function complete(){if(++index===total){transformation.model.submitRequest({success:function(){transformation.isDirty=false;if(callback&&callback.success){callback.success();}}},{manipulationtype:Enum_SM_UpdateTransformationElements,tableids:tblIDs.join(";"),attributeids:attIDs.join(";"),expressions:exprs.join(";"),columnIDs:colIDs.join(";"),objectid:transformation.id,mpt:mappingType,roleProcess:roleProcess},"schemaManipulation");}}});});}else{if(callback&&callback.success){callback.success();}}},addElement:function addElement(attributeID,expression,tableID,callback,attributeName,tableName){var transformation=this,isValid=false,cb={success:function success(){isValid=true;mstrApp.rootController.populateTableContents(tableID,{success:mstrmojo.emptyFn()});},complete:function success(){transformation.elements[attributeID]={attributeID:attributeID,expression:expression,tableID:tableID,attributeName:attributeName,tableName:tableName,isValid:isValid};if(callback&&callback.success()){callback.success();}}};if(tableID){var returned=transformation.model.validateTransformationExpr({expr:expression,tid:tableID,vo:null},cb);if(returned===false){cb.complete();}}else{cb.complete();}transformation.isDirty=true;},removeElement:function removeElement(attributeID,callback){var transformation=this;delete transformation.elements[attributeID];transformation.isDirty=true;if(callback&&callback.success){callback.success(transformation);}},rename:function rename(newTransformationName){var transformation=this;transformation.isDirty=true;if(mstrApp.getRootController().validateName(ENUM_OT_TRANSFORMATION,newTransformationName,this.name)){transformation.model.submitRequest({success:function(){transformation.name=newTransformationName;}},{manipulationtype:Enum_SM_RenameObject,objecttype:ENUM_OT_TRANSFORMATION,objectid:this.id,objectname:newTransformationName},"schemaManipulation");return true;}return false;},remove:function remove(callback){var transformation=this;transformation.isDirty=true;transformation.model.submitRequest({transformation:this,callback:callback,success:function(){if(this.callback&&this.callback.success){this.callback.success(this.transformation.id);}}},{manipulationtype:Enum_SM_DeleteObject,objecttype:ENUM_OT_TRANSFORMATION,objectid:this.id},"schemaManipulation");},load:function load(callback){var transformation=this,cb={success:function success(res){transformation.isLoaded=true;var elems=res&&res.mi.tris.tri;if(elems){elems=elems.length?elems:[elems];$H.forEach(elems,function(elem){transformation.elements[elem.atid]={attributeID:elem.atid,expression:elem.exp,tableID:elem.tbid,attributeName:elem.ban,tableName:elem.tbn,isValid:true};});}}};if(transformation.isLoaded){if(callback&&callback.success){callback.success();}}else{transformation.model.submitRequest($WRAP(cb,callback),{manipulationtype:Enum_SM_GetTransformationElements,objectid:transformation.id},"schemaManipulation");}},getTransformationData:function getTransformationData(){var transformation=this,table,returnValue={n:transformation.name,did:transformation.id,tp:ENUM_OT_TRANSFORMATION,onetoOneMappingType:transformation.onetoOneMappingType,transformationAllAttributes:transformation.transformationAllAttributes,isVisible:function isVisible(data,item){return transformation.model.handleVisibleAction(data,item);},isChecked:function isChecked(data,item){return transformation.model.handleCheckAction(data,item);},isEnabled:function isEnabled(data,item){return transformation.model.handleEnabledAction(data,item);},elements:[]};if(transformation.isLoaded){$H.forEach(transformation.elements,function(element){table=transformation.model.getTable(element.tableID);returnValue.elements.push({attributeName:element.attributeName,attributeID:element.attributeID,expression:element.expression,tableName:element.tableName,tableID:element.tableID,isValid:element.isValid});});}return returnValue;},isValid:function(){var transformationElements=this.elements,isValid=!!(mstrApp.rootController.getObjectCount(transformationElements));$H.forEach(transformationElements,function(transformationElement){isValid=isValid&&transformationElement.isValid;return isValid;});return isValid;}});}());