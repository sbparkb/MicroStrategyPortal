(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.architect.obj.Relationship");var $A=mstrmojo.array,$H=mstrmojo.hash,$M=mstrmojo,$WRAP=$M.func.wrapMethods,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,RELATIONSHIP_CHANGED=$ENUM_DATA_CHANGE_EVENTS.RELATIONSHIP_CHANGED,$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,ENUM_OT_LAYER=$ENUM_OT.LAYER,ENUM_OT_RELATIONSHIP=$ENUM_OT.RELATIONSHIP,DEFAULT_LAYER_NAME=mstrmojo.desc(11431,"New Layer"),STR_NO_REL_TABLE=mstrmojo.desc(11435,"there are no tables that can relate these 2 attributes"),Enum_SM_CreateObject=1,Enum_SM_DeleteObject=2,Enum_SM_RenameObject=3,ENum_SM_EditJointChildRelationship=21,Enum_SM_EditLayer=25,Enum_SM_GetLayerRelationships=1026,Enum_SM_RemoveJointAttributeRelation=1022,Enum_SM_GetTableRelationships=1007;function processRelationships(res){var layer=this,model=layer.model,layerRelations=[],parentId,children,relTable,parentAtt,childAtt,inTableParent,inTableChild;$A.forEach(res.layerRel,function(rel){parentId=Object.keys(rel)[0];children=rel[parentId];$A.forEach(children,function(child){inTableParent=false;inTableChild=false;$H.forEach(layer.tables,function(table){$H.forEach(table.attributeInfos,function(attInfo){if(parentId===attInfo.attributeId){inTableParent=true;}if(child.atid===attInfo.attributeId){inTableChild=true;}return !(inTableParent&&inTableChild);});return !(inTableParent&&inTableChild);});if(inTableParent&&inTableChild){relTable=model.getTable(child.tbid);parentAtt=model.getAttribute(parentId);childAtt=model.getAttribute(child.atid);layerRelations.push(new mstrmojo.architect.obj.Relationship({isNew:false,parentAttributeId:parentId,childAttributeId:child.atid,relationType:child.ert,relationTableId:child.tbid,model:layer.model,relationTableName:relTable.name,parentAttributeName:parentAtt.name,childAttributeName:childAtt.name,isJointChildren:(child.joinChildren>1),isVisible:function isVisible(data,item){return model.handleVisibleAction(data,item);},isChecked:function isChecked(data,item){return model.handleCheckAction(data,item);},isEnabled:function isEnabled(data,item){return model.handleEnabledAction(data,item);},tp:ENUM_OT_RELATIONSHIP}));}});});return layerRelations;}function removeRelationship(layer,relationship){var lIndex=0,relations=layer.relations;$A.forEach(relations,function(relation){if(relation.parentAttributeId===relationship.parentAttributeId&&relation.childAttributeId===relationship.childAttributeId){relations.splice(lIndex,1);return false;}lIndex++;return true;});}function getRelationship(layer,parentAttributeId,childAttributeId){var model=layer.model,retRelationship=null,table,parentAtt,childAtt;$A.forEach(layer.relations,function(relationship){if(relationship.parentAttributeId===parentAttributeId&&relationship.childAttributeId===childAttributeId){retRelationship=relationship;}});table=model.getTable(retRelationship.relationTableId);if(table){retRelationship.relationTableName=table.name;}parentAtt=model.getAttribute(retRelationship.parentAttributeId);if(parentAtt){retRelationship.parentAttributeName=parentAtt.name;}childAtt=model.getAttribute(retRelationship.childAttributeId);if(childAtt){retRelationship.childAttributeName=childAtt.name;}return retRelationship;}function requestUpdate(callback){var layer=this;layer.model.submitRequest(callback,{manipulationtype:Enum_SM_EditLayer,objectid:layer.id,info:JSON.stringify({tables:layer.tablePositions||{},attributes:layer.attributePositions||{}})},"schemaManipulation");}function createLayer(layerName,callback){var layer=this;layer.model.submitRequest({success:function(res){var objectInfo=res.mi["in"].oi,did=objectInfo.did;layer.id=did;layer.name=objectInfo.n;if(callback&&callback.success){callback.success(did);}}},{manipulationtype:Enum_SM_CreateObject,objecttype:ENUM_OT_LAYER,objectname:layerName},"schemaManipulation");}mstrmojo.architect.obj.Layer=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.architect.obj.Layer",init:function init(props){this.tables={};this.tablePositions={};this.attributePositions={};this.relations=[];this.model=props.mdl;if(props.isNew){if(props.defaultName){createLayer.call(this,mstrApp.rootController.findNextName(DEFAULT_LAYER_NAME,$H.valarray(this.model.layers),"name"),props.callback);}else{if(mstrApp.getRootController().validateName(ENUM_OT_LAYER,props.newLayerName,this.name)){createLayer.call(this,props.newLayerName,props.callback);}}}else{this.id=props.id;this.name=props.n;}},tp:ENUM_OT_LAYER,definitionLoaded:false,loadDefinition:function loadDefinition(callback){var $this=this;if(this.definitionLoaded){callback.success();return ;}this.loadLayer($WRAP({success:function success(){$this.definitionLoaded=true;}},callback));},loadLayer:function loadLayer(callback){var $this=this,layerName=$this.name,model=$this.model,cb={success:function success(res){$A.forEach(res.layers,function(layer){var tables={},tablePositions={},attributePositions={},tableID,attributeID,mdllayer=model.layers[layer.did];if(mdllayer){$A.forEach(layer.tables,function(table){tableID=table.did;tables[tableID]=model.getTable(tableID);tablePositions[tableID]={x:table.l,y:table.t,h:table.h,w:table.w};});$A.forEach(layer.attributes,function(attribute){attributeID=attribute.did;attributePositions[attributeID]={x:attribute.l,y:attribute.t};});mdllayer.tables=$H.copy(tables);mdllayer.tablePositions=$H.copy(tablePositions);mdllayer.attributePositions=$H.copy(attributePositions);}});}};if(layerName){model.submitRequest($WRAP(cb,callback),{objecttypes:ENUM_OT_LAYER,xmlflags:1,namepattern:layerName,flags:1+2+256+512,specialparse:"getLayers"},"search");}else{mstrmojo.alert("missing layerName!");}},name:"",id:"",loadCount:0,tables:undefined,relations:[],relationsLoaded:false,layerRel:undefined,ratt:undefined,joinChildren:undefined,relationshipType:undefined,childrenIndex:undefined,rename:function rename(newLayerName){var layer=this;if(mstrApp.getRootController().validateName(ENUM_OT_LAYER,newLayerName,this.name)){this.model.submitRequest({success:function(){layer.name=newLayerName;}},{manipulationtype:Enum_SM_RenameObject,objecttype:ENUM_OT_LAYER,objectid:this.id,objectname:newLayerName},"schemaManipulation");return true;}return false;},remove:function remove(callback){this.model.submitRequest({layer:this,callback:callback,success:function(){if(this.callback&&this.callback.success){this.callback.success(this.layer.id);}}},{manipulationtype:Enum_SM_DeleteObject,objecttype:ENUM_OT_LAYER,objectid:this.id},"schemaManipulation");},tableCount:function tableCount(){return Object.keys(this.tables).length;},tablePositions:undefined,attributePositions:undefined,updateTablePositions:function updateTablePositions(tableObj,pos){var tableId=tableObj.did;this.tables[tableId]=this.model.tables[tableId];this.tablePositions[tableId]=$H.copy(pos,{x:"0px",y:"0px",w:"150px",h:"60px"});},updateAttributePositions:function updateAttributePositions(positions,callback){var key=Object.keys(positions)[1];if(key){if(positions[key]&&positions[key].y){this.attributePositions=positions;requestUpdate.call(this,callback);}}},removeTable:function removeTable(table){var idxs=[],i,tableId=table.did;$A.forEach(this.relations,function(rel,idx){if(tableId===rel.relationTableId){idxs.push(idx);}});for(i=idxs.length-1;i>=0;i--){var idx=idxs[i];$A.removeIndices(this.relations,idx,1);}delete this.tables[tableId];delete this.tablePositions[tableId];requestUpdate.call(this,{success:mstrmojo.emptyFn});},addTable:function addTable(table){var layer=this;this.tables[table.id]=table;layer.model.submitRequest({success:function success(res){layer.relations=(layer.relations||[]).concat(processRelationships.call(layer,res));layer.model.raiseEvent({name:RELATIONSHIP_CHANGED,value:layer.id,relations:layer.relations,layers:layer.model.getAllLayers()});}},{manipulationtype:Enum_SM_GetTableRelationships,tableids:[table.id]},"schemaManipulation");},loadRelations:function loadRelations(callback){var layer=this,model=layer.model;if(layer.relationsLoaded){if(callback){if(callback.success){callback.success(layer.relations);}if(callback.complete){callback.complete({id:layer.id});}}return ;}model.submitRequest({success:function(res){layer.relations=processRelationships.call(layer,res);layer.relationsLoaded=true;},complete:function(){if(callback){if(callback.success){callback.success(layer.relations);}if(callback.complete){callback.complete({id:layer.id});}}}},{manipulationtype:Enum_SM_GetLayerRelationships,objectid:layer.id},"schemaManipulation");},getRelations:function getRelations(callback){this.loadRelations(callback);},loading:function loading(){return(this.loadCount<this.tableCount());},tableLoaded:function tableLoaded(){if(this.loading){this.loadCount++;}if(this.loadCount>=this.tableCount()){this.model.raiseEvent({name:"layerLoaded"});}},addRelation:function addRelation(parentAttributeId,childAttributeId,callback,relationTableId){var layer=this,model=this.model,relationship,cbAddRelationship=$WRAP({success:function(res){relationship.relationTableId=res.mi.ei.ratt.at.gdid;layer.relations.push(relationship);}},callback);mstrApp.getRootController().searchTables.call(this,parentAttributeId,childAttributeId,{success:function success(res){if(res.ts.length>0){var did,index=$A.find(res.ts,"did",relationTableId),relTable=model.getTable(relationTableId),parentAtt=model.getAttribute(parentAttributeId),childAtt=model.getAttribute(childAttributeId);if(index>=0){did=relationTableId;}else{did=res.ts[0].did;}relationship=new mstrmojo.architect.obj.Relationship({isNew:true,parentAttributeId:parentAttributeId,childAttributeId:childAttributeId,relationType:2,relationTableId:did,model:model,callback:cbAddRelationship,relationTableName:relTable.name,parentAttributeName:parentAtt.name,childAttributeName:childAtt.name,isJointChildren:false,isVisible:function isVisible(data,item){return model.handleVisibleAction(data,item);},isChecked:function isChecked(data,item){return model.handleCheckAction(data,item);},isEnabled:function isEnabled(data,item){return model.handleEnabledAction(data,item);},tp:ENUM_OT_RELATIONSHIP});}else{mstrmojo.alert(STR_NO_REL_TABLE);}}});},addJointRelation:function addJointRelation(relation,secondChildAttributeID,callback){var $this=this,model=this.model,newRel,relationship=this.getRelation(relation.parentAttributeId,relation.childAttributeId),cbAddRelationship=$WRAP({success:function(){newRel=new mstrmojo.architect.obj.Relationship({isNew:false,isSysDimension:true,parentAttributeId:relation.parentAttributeId,parentAttributeName:relation.parentAttributeName,childAttributeId:secondChildAttributeID,childAttributeName:"",relationType:relation.relationType,relationTableId:relation.relationTableId,relationTableName:relation.relationTableName,isJointChildren:true,jointIndex:relation.childrenIndex+1,model:model,isVisible:function isVisible(data,item){return model.handleVisibleAction(data,item);},isChecked:function isChecked(data,item){return model.handleCheckAction(data,item);},isEnabled:function isEnabled(data,item){return model.handleEnabledAction(data,item);},tp:ENUM_OT_RELATIONSHIP});relationship.isJointChildren=true;$this.relations.push(newRel);}},callback);if(relationship){relationship.addJointChildren(relation.parentAttributeId,relation.childAttributeId,secondChildAttributeID,relation.relationType,relation.relationTableId,cbAddRelationship);}},removeRelation:function removeRelation(parentAttributeId,childAttributeId,callback){var layer=this,relations=layer.relations,jointChildId="",relationship=getRelationship(layer,parentAttributeId,childAttributeId),cbRemoveJointRelationship=$WRAP({success:function(){var lIndex=0;$A.forEach(relations,function(relation){if(relation.parentAttributeId===relationship.parentAttributeId&&relation.childAttributeId===relationship.childAttributeId){relations.splice(lIndex,1);return false;}lIndex++;return true;});lIndex=0;$A.forEach(relations,function(relation){if(relation.parentAttributeId===relationship.parentAttributeId&&relation.childAttributeId===jointChildId){relations.splice(lIndex,1);return false;}lIndex++;return true;});}},callback),cbRemoveRelationship=$WRAP({success:function(){removeRelationship(layer,relationship);}},callback);if(relationship){if(relationship.isJointChildren){$A.forEach(relations,function(relation){if(relation.isJointChildren&&relation.parentAttributeId===relationship.parentAttributeId&&relation.childAttributeId!==relationship.childAttributeId){jointChildId=relation.childAttributeId;return false;}return true;});this.model.submitRequest(cbRemoveJointRelationship,{manipulationtype:Enum_SM_RemoveJointAttributeRelation,objectid:relationship.parentAttributeId,objectid2:relationship.childAttributeId,objectid3:jointChildId},"schemaManipulation");}else{relationship.remove(cbRemoveRelationship);}}},getRelatedRelations:function removeRelation(parentAttributeId){var layer=this,relatedRelations=[],relations=layer.relations;$A.forEach(relations,function(relation){if(relation.isJointChildren&&relation.parentAttributeId===parentAttributeId){relatedRelations.push(relation);}return true;});return relatedRelations;},updateRelation:function updateRelation(parentAttributeId,childAttributeId,relationTableId,relationshipType,callback){var relationship=this.getRelation(parentAttributeId,childAttributeId),sysDim=this,jointChildren=[],relatedRelations;if(relationship){if(relationship.isJointChildren){relatedRelations=sysDim.getRelatedRelations(parentAttributeId);$A.forEach(relatedRelations,function(relation){jointChildren.push(relation.childAttributeId);return true;});sysDim.model.submitRequest($WRAP({success:function success(){$A.forEach(relatedRelations,function(relation){relation.relationType=relationshipType;relation.relationTableId=relationTableId;return true;});}},callback),{manipulationtype:ENum_SM_EditJointChildRelationship,objectid:parentAttributeId,ert:relationshipType,gdid:relationTableId,attributeids:jointChildren.join(";")},"schemaManipulation");}else{relationship.updateRelation(parentAttributeId,childAttributeId,relationshipType,relationTableId,callback);}}},getRelation:function getRelation(parentAttributeId,childAttributeId){return getRelationship(this,parentAttributeId,childAttributeId);}});}());