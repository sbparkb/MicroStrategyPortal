(function(){mstrmojo.requiresCls("mstrmojo._HasEditableText","mstrmojo.array","mstrmojo.Box","mstrmojo.css","mstrmojo.dom","mstrmojo.architect.EnumDataChangeEvents","mstrmojo.architect.menu.TransformationSettingMenu","mstrmojo.architect.ui.TransformationContainer","mstrmojo.warehouse.ui.BasePanel");var CSS_PREFIX="mstrmojo-ar-",CSS_PREFIX_TB_BTN="tbbtn",$DOM=mstrmojo.dom,$PX="px",$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,$ENUM_VIEW_TYPES=mstrmojo.architect.ui.EnumViewTypes,$MNU_ACTIONS=mstrmojo.architect.menu.EnumMenuActions,ENUM_ACTION_ONE_TO_ONE=$MNU_ACTIONS.TX_ONE_TO_ONE,ENUM_ACTION_MANY_TO_MANY=$MNU_ACTIONS.TX_MANY_TO_MANY,ENUM_ACTION_APPLY_TO_ALL=$MNU_ACTIONS.TX_APPLY_TO_ALL,ENUM_ACTION_APPLY_TO_HIGHEST=$MNU_ACTIONS.TX_APPLY_TO_HIGHEST,ENUM_VIEW_TRANSFORMATION=$ENUM_VIEW_TYPES.TRANSFORMATION,STR_SHOW_ALL_TRANSFORMATIONS=mstrmojo.desc(12208,"Show transformations"),STR_HIDE_ALL_TRANSFORMATIONS=mstrmojo.desc(12209,"Hide transformations"),STR_SETTINGS=mstrmojo.desc(7831,"Settings"),STR_CLOSE=mstrmojo.desc(12210,"Close transformation"),STR_INVALID_TRANSFORMATION=mstrmojo.desc(12211,"Transformation '%1' is in an invalid state, it needs to be fixed before proceeding"),STR_INSTRUCTIONS=mstrmojo.desc(12212,"Please select a transformation or create a new one");function showContents(isVisible){this.parent.showBottomPanel(!isVisible);this.transformationContainer.set("visible",isVisible);this.set("instructionsVisible",!isVisible);}function updateTransformation(evt){var containerWidget=this.transformationContainer,newTransformationId=evt.value.id,transformation=evt.value,hasOpenItems=(!!transformation),currentName=hasOpenItems?transformation.name:"";this.transformationId=newTransformationId;this.setEditableTitle(currentName);showContents.call(this,hasOpenItems);if(newTransformationId){containerWidget.refresh();}this.onwidthChange({value:this.width});}mstrmojo.architect.ui.panels.TransformationPanel=mstrmojo.declare(mstrmojo.warehouse.ui.BasePanel,[mstrmojo._HasEditableText,mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.architect.ui.panels.TransformationPanel",cssClass:"ContentsInfoPanel",editableSlot:"titleNode",allowEmptyText:true,instructionsText:STR_INSTRUCTIONS,icntp:$ENUM_OT.TRANSFORMATION,showList:undefined,transformationContainer:undefined,viewListVisible:true,settings:undefined,init:function init(props){this._super(props);var $this=this,rootController=mstrApp.getRootController(),evtConfig={},panelConfig=evtConfig[this.id]={};this.addNewTitleButton({alias:"settings",cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" settings",title:STR_SETTINGS,onclick:function(){var menuHelper=$this.settingsMenu=$this.settingsMenu||new mstrmojo.architect.menu.TransformationSettingMenu();menuHelper.data={did:$this.transformationId,isVisible:function isVisible(){return true;},isChecked:function isChecked(data,item){var transformation=rootController.getTransformation(data.did);switch(item.did){case ENUM_ACTION_ONE_TO_ONE:return(transformation.onetoOneMappingType);case ENUM_ACTION_MANY_TO_MANY:return(!transformation.onetoOneMappingType);case ENUM_ACTION_APPLY_TO_ALL:return(transformation.transformationAllAttributes);case ENUM_ACTION_APPLY_TO_HIGHEST:return(!transformation.transformationAllAttributes);}return false;},isEnabled:function isEnabled(){return true;}};var cfg=menuHelper.getMenuConfig();cfg.hostId=$this.id;cfg.hostElement=this.domNode;cfg.isHostedWithin=false;$this.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));}});this.addNewTitleButton({title:STR_CLOSE,cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" closeObject",onclick:function(){var rootController=mstrApp.rootController,transformationId=rootController.model.currentTransformationId,check=rootController.preSwitchCheck(rootController.getTransformation(transformationId),STR_INVALID_TRANSFORMATION,"name");if(check.canProceed){rootController.commitTransformation(transformationId,{success:mstrmojo.emptyFn()});rootController.closeViewObject();}else{mstrmojo.alert(check.msg);}}});this.addNewTitleButton({title:STR_SHOW_ALL_TRANSFORMATIONS,alias:"showList",cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" showList",onclick:function(){$this.viewListVisible=!$this.viewListVisible;mstrApp.getRootController().toggleViewList();}});panelConfig[$ENUM_DATA_CHANGE_EVENTS.TRANSFORMATION_UPDATED]=updateTransformation;rootController.attachDataChangeListeners(evtConfig);var checkerFn=function checkerFn(callback){var check=rootController.preSwitchCheck(rootController.getTransformation($this.transformationId),STR_INVALID_TRANSFORMATION,"name");if(check.canProceed){if($this.transformationId){rootController.commitTransformation($this.transformationId,callback);}else{if(callback&&callback.success){callback.success();}}}return check;};rootController.registerPreSwitchViewCallback(function preSwitchFn(currentView){if(currentView!==ENUM_VIEW_TRANSFORMATION){return{canProceed:true,msg:""};}return checkerFn();});rootController.registerPreSwitchViewCallback(checkerFn);rootController.registerPreSaveCallback(checkerFn);rootController.registerSaveCallback(function registerSaveCallback(){rootController.commitTransformation($this.transformationId,{success:mstrmojo.emptyFn()});});},postBuildRendering:function postBuildRendering(){this._super();showContents.call(this,!!this.transformationId);},closeObject:function closeObject(){mstrApp.rootController.editTransformation("");this.setEditableTitle("");this.transformationId="";showContents.call(this,false);},updateViewObjectName:function updateViewObjectName(itemID,itemName){if((!!(this.transformationId))&&(itemID===this.transformationId)){this.setEditableTitle(itemName);}},onTextEditComplete:function onTextEditComplete(textChanged,originalText){var rootController=mstrApp.rootController;if(textChanged){var transformationId=this.transformationId,name=this.text,isValid=rootController.renameTransformation(transformationId,name);if(!isValid){this.setEditableTitle(originalText);}else{rootController.updateViewListItem(transformationId,name);}}},onheightChange:function onheightChange(evt){var h=parseInt(evt.value,10),headerHeight=this.headerHeight=this.headerHeight||(this.hasRendered?this.headerNode.clientHeight:36),contentHeight=(Math.max(parseInt(h,10)-headerHeight,0))+$PX;this.height=h+$PX;this.transformationContainer.set("height",contentHeight);this.set("instructionsHeight",this.height);},onwidthChange:function onwidthChange(evt){var $this=this,w=parseInt(evt.value,10),contentWidth=Math.max(w,0),textWidth=contentWidth-(this.titleIconsNode?$DOM.position(this.titleIconsNode).w:0)-25;if(this.showList.domNode){this.showList.set("title",($this.viewListVisible)?STR_HIDE_ALL_TRANSFORMATIONS:STR_SHOW_ALL_TRANSFORMATIONS);}this.width=w+$PX;this.transformationContainer.set("width",contentWidth+$PX);if(this.titleNode){this.titleNode.style.width=textWidth+$PX;}},children:[{scriptClass:"mstrmojo.architect.ui.TransformationContainer",alias:"transformationContainer",visible:false}]});}());