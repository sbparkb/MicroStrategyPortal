(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.array","mstrmojo.dom","mstrmojo.hash","mstrmojo.architect.ui.AttributeLabel","mstrmojo.architect.EnumDragActions","mstrmojo.warehouse.EnumObjectTypes","mstrmojo.architect.EnumDataChangeEvents");var $A=mstrmojo.array,$DOM=mstrmojo.dom,$H=mstrmojo.hash,GAP=100,$ATTR_LABEL=mstrmojo.architect.ui.AttributeLabel,ENUM_DROP_ZONE_PARENT=$ATTR_LABEL.ENUM_DROP_ZONE.PARENT,ENUM_DROP_ZONE_CHILD=$ATTR_LABEL.ENUM_DROP_ZONE.CHILD,$ENUM_DRAG_ACTIONS=mstrmojo.architect.EnumDragActions,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,$ENUM_TYPES=mstrmojo.warehouse.EnumObjectTypes,ENUM_TP_ATTRIBUTE=$ENUM_TYPES.ATTRIBUTE,$PX="px";function reachable(attributeItems,firstID,secondID,type){if(firstID===secondID){return true;}var attribute=attributeItems[firstID],i,length;if(type===1){var childIds=attribute.cids;for(i=0,length=childIds.length;i<length;i++){if(reachable(attributeItems,childIds[i],secondID,type)){return true;}}}if(type===2){var parentIds=attribute.pids;for(i=0,length=parentIds.length;i<length;i++){if(reachable(attributeItems,parentIds[i],secondID,type)){return true;}}}return false;}function findConflictAttrs(dragData,type){var attributeItems=this.attributes,parentIds=dragData.pids,childIds=dragData.cids,newParentIds=[],newChildIds=[],i,length;if(type!==1){for(i=0,length=parentIds.length;i<length;i++){if(reachable(attributeItems,parentIds[i],dragData.caid,2)){newParentIds.push(parentIds[i]);}}}if(type!==2){for(i=0,length=childIds.length;i<length;i++){if(reachable(attributeItems,childIds[i],dragData.paid,1)){newChildIds.push(parentIds[i]);}}}return{pids:newParentIds,cids:newChildIds};}function addAttribute(attributeObject,left,top){var attributeId=attributeObject.attributeId,attributeItems=this.attributes,attrLabelWidgets=this.children,linker=this.parent.linker,attrLabel,properties=attributeObject.properties;if(!properties){properties={lockLimit:0,lockType:1,filters:[]};}if(attributeItems[attributeId]){attrLabel=attrLabelWidgets[$A.find(attrLabelWidgets,"attributeId",attributeId)];attrLabel.set("top",top+$PX);attrLabel.set("left",left+$PX);var labelDomNode=attrLabel.domNode;linker.drawLinks({MAX_DIMS:{x:left+labelDomNode.clientWidth,y:top+labelDomNode.clientHeight}});}else{attrLabel=new mstrmojo.architect.ui.AttributeLabel({left:left+$PX,top:top+$PX,linker:linker,tableId:attributeObject.tableId,name:attributeObject.n||attributeObject.name,attributeId:attributeId,isChecked:attributeObject.isChecked,isVisible:attributeObject.isVisible,isEnabled:attributeObject.isEnabled,entryPoint:attributeObject.entryPoint,locked:(properties.lockType!==1),size:properties.lockLimit,filtered:(properties.filters.length>0)});attrLabel.attachEventListener("attrRearranged",this.id,function(evt){this.handleDragDrop(evt.context);});attrLabel.updateIcons();this.addChildren([attrLabel]);attributeItems[attributeId]=attributeObject;}}function updatePostitionByMatrix(attributeObject,matrix,newX,newY,isInsert){newY=(newY===undefined)?attributeObject.y:newY;var verticalMatrix=matrix[newY]=matrix[newY]||[],attributeId=attributeObject.attributeId,oldX=attributeObject.x,oldY=attributeObject.y;if(verticalMatrix[newX]&&verticalMatrix[newX]!==attributeId){if(isInsert){verticalMatrix.splice(newX,0,attributeId);}else{while(verticalMatrix[newX]!==undefined){newX++;}}}if(oldX!==undefined&&oldY!==undefined){matrix[oldY][oldX]=undefined;}matrix[newY][newX]=attributeId;attributeObject.x=newX;attributeObject.y=newY;}function positionAttributeLabel(attributeId,top,left){var children=this.children;if(children){var attributeLabel=children[$A.find(children,"attributeId",attributeId)];if(attributeLabel){attributeLabel.set("top",top);attributeLabel.set("left",left);}}}function autoArrangeDP(evt,matrix){var rootIds,attributes;rootIds=evt.rootIds;attributes=evt.attributes;var calculateNodePositions,createRevChildren,paintThisTree,addPositionsIntoMatrix;calculateNodePositions=function calculateNodePositions(attributeId,depth){var attributeObject=attributes[attributeId];var childrenIds=attributeObject.revChildren;if(attributeObject.visited===undefined){attributeObject.visited=1;}else{return ;}attributeObject.revSubtreeCnt=1;$A.forEach(childrenIds,function(childId){calculateNodePositions(childId,depth+1);attributeObject.revSubtreeCnt+=attributes[childId].revSubtreeCnt;});attributes[attributeId].offsetHeadArr=[0];attributes[attributeId].offsetTailArr=[0];childrenIds.sort(function(a,b){return attributes[b].revSubtreeCnt-attributes[a].revSubtreeCnt;});var i,j,tmp;for(i=1,j=childrenIds.length-1;i<j;i+=2,j-=2){tmp=childrenIds[i];childrenIds[i]=childrenIds[j];childrenIds[j]=tmp;}$A.forEach(childrenIds,function(childId){var offset=0;var dep;for(dep=0;dep<attributes[childId].offsetHeadArr.length;dep++){if(offset+attributes[childId].offsetHeadArr[dep]<=attributes[attributeId].offsetTailArr[dep+1]){offset+=attributes[attributeId].offsetTailArr[dep+1]+1-(offset+attributes[childId].offsetHeadArr[dep]);}}attributes[childId].offsetToFather=offset;for(dep=0;dep<attributes[childId].offsetHeadArr.length;dep++){if(attributes[attributeId].offsetHeadArr[dep+1]===undefined){attributes[attributeId].offsetHeadArr[dep+1]=offset+attributes[childId].offsetHeadArr[dep];}else{attributes[attributeId].offsetHeadArr[dep+1]=Math.min(attributes[attributeId].offsetHeadArr[dep+1],offset+attributes[childId].offsetHeadArr[dep]);}if(attributes[attributeId].offsetTailArr[dep+1]===undefined){attributes[attributeId].offsetTailArr[dep+1]=offset+attributes[childId].offsetTailArr[dep];}else{attributes[attributeId].offsetTailArr[dep+1]=Math.max(attributes[attributeId].offsetTailArr[dep+1],offset+attributes[childId].offsetTailArr[dep]);}}});};createRevChildren=function createRevChildren(attributeId,virtualKey){var attributeObject=attributes[attributeId],childrenIds=attributeObject.children,childrenCount=childrenIds.length,isLeaf=childrenCount===0;if(attributeObject.revVisited===undefined){attributeObject.revVisited=1;}else{return ;}if(isLeaf){attributes[virtualKey].revChildren.push(attributeId);}var indexOf=function(needle){if(typeof Array.prototype.indexOf==="function"){indexOf=Array.prototype.indexOf;}else{indexOf=function(needle){var i=-1,index=-1;for(i=0;i<this.length;i++){if(this[i]===needle){index=i;break;}}return index;};}return indexOf.call(this,needle);};attributeObject.revChildren=[];$A.forEach(childrenIds,function(childId){createRevChildren(childId,virtualKey);var index=indexOf.call(attributes[childId].revChildren,attributeId);if(index===-1){attributes[childId].revChildren.push(attributeId);}});};addPositionsIntoMatrix=function addPositionsIntoMatrix(attributeId,posX,posY,isVirtual){var attributeObject=attributes[attributeId],childrenIds=attributeObject.revChildren;if(isVirtual===0){updatePostitionByMatrix(attributeObject,matrix,posX,posY);}$A.forEach(childrenIds,function(childId){addPositionsIntoMatrix(childId,posX+attributes[childId].offsetToFather,posY-1,0);});};paintThisTree=function paintThisTree(){var virtualKey=0;attributes[virtualKey]={children:[],revChildren:[]};$A.forEach(rootIds,function(rootId){createRevChildren(rootId,virtualKey);});calculateNodePositions(virtualKey,0);var depth=attributes[virtualKey].offsetHeadArr.length;addPositionsIntoMatrix(virtualKey,0,depth,1);delete attributes[virtualKey];};paintThisTree();}function autoArrange(evt){var attributes=evt.attributes,positions=this.positions=evt.positions||{},rootIds=evt.rootIds,xCoords=[],offsets=[],GAP_X=130,MAX_X=0,MAX_Y=0,matrix=[],calculateNodePositions=function calculateNodePositions(attributeId,depth){var attributeObject=attributes[attributeId],childrenIds=attributeObject.children,childrenCount=childrenIds.length,isLeaf=childrenCount===0,firstChild=attributes[childrenIds[0]],place;$A.forEach(childrenIds,function(childId){calculateNodePositions(childId,depth+1);});var offset=offsets[depth]=offsets[depth]||0,depthX=xCoords[depth]=xCoords[depth]||0,finalX,finalY;if(isLeaf){place=depthX;finalX=place;}else{if(childrenCount===1){place=firstChild.x-1;}else{var sum=0;$A.forEach(childrenIds,function(childId){sum+=attributes[childId].x;});place=Math.floor(sum/childrenCount);}}offset=offsets[depth]=Math.max(offset,depthX-place);if(!isLeaf){finalX=place+offset;}finalY=depth;updatePostitionByMatrix(attributeObject,matrix,finalX,finalY);xCoords[depth]+=1;},placeChildrenUnderParent=function placeChildrenUnderParent(attributeId){var attributeObject=attributes[attributeId],childrenIds=attributeObject.children,childrenCount=childrenIds.length;if(childrenCount>0){$A.forEach(childrenIds,function(childId){var childObject=attributes[childId];updatePostitionByMatrix(childObject,matrix,attributeObject.x);});}$A.forEach(childrenIds,function(childId){placeChildrenUnderParent(childId);});},centerToParent=function centerToParent(attributeId){var attributeObject=attributes[attributeId],childrenIds=attributeObject.children,parentCount=attributeObject.parent.length;if(parentCount>0){var sum=0;$A.forEach(attributeObject.parent,function(parentId){sum+=attributes[parentId].x;});updatePostitionByMatrix(attributeObject,matrix,Math.floor(sum/parentCount));}$A.forEach(childrenIds,function(childId){centerToParent(childId);});};var usePaintDP=1;if(usePaintDP){autoArrangeDP(evt,matrix);}else{$A.forEach(rootIds,function(rootId){calculateNodePositions(rootId,0);});$A.forEach(rootIds,function(rootId){placeChildrenUnderParent(rootId);});$A.forEach(rootIds,function(rootId){centerToParent(rootId);});}var indices=[];$A.forEach(matrix[0],function(attributeId,idx){if(!attributeId){var emptyCol=true,i;for(i=0;i<matrix.length;i++){emptyCol=emptyCol&&!matrix[i][idx];}if(emptyCol){indices.push(idx);}}});$A.forEach(indices.reverse(),function(idx){var i;for(i=0;i<matrix.length;i++){matrix[i].splice(idx,1);}});$A.forEach(matrix,function setNodePositions(verticalMatrix,y){$A.forEach(verticalMatrix,function setNodePositions(attributeId,x){if(attributeId){var top=(GAP*y)+$PX,left=(GAP_X*x)+$PX;positionAttributeLabel.call(this,attributeId,top,left);positions[attributeId]={x:left,y:top};}MAX_X=Math.max(x+1,MAX_X);},this);MAX_Y=Math.max(y+1,MAX_Y);},this);return{x:MAX_X*GAP_X,y:MAX_Y*GAP};}function reArrangeLabels(evt){var positions=this.positions=evt.positions||{},recentDrop=this.recentDrop,children=this.children||[],hasCustomPositions=($H.keyarray(positions).length>0),maxDims={},attributeLabel=(recentDrop?children[$A.find(children,"attributeId",recentDrop.data.attributeId)]:undefined),h=((children[0]&&children[0].domNode)?$DOM.position(children[0].domNode).h:0),w=((children[0]&&children[0].domNode)?$DOM.position(children[0].domNode).w:0);if(hasCustomPositions){$H.forEach(positions,function(position,attributeId){if(position&&position.x&&position.y){positionAttributeLabel.call(this,attributeId,position.y,position.x);maxDims.x=Math.max(maxDims.x||0,parseInt(position.x,10)+w);maxDims.y=Math.max(maxDims.y||0,parseInt(position.y,10)+h);}},this);if(attributeLabel&&attributeLabel.top==="0px"&&attributeLabel.left==="0px"){positionAttributeLabel.call(this,recentDrop.data.attributeId,recentDrop.pos.y,recentDrop.pos.x);maxDims.x=Math.max(maxDims.x||0,parseInt(recentDrop.pos.x,10)+w);maxDims.y=Math.max(maxDims.y||0,parseInt(recentDrop.pos.y,10)+h);}}else{maxDims=autoArrange.call(this,evt);}evt.MAX_DIMS=maxDims;}function getAttributeLabel(evt){if(evt.tp===ENUM_TP_ATTRIBUTE){var idx=$A.find(this.children,"attributeId",evt.did);if(idx>-1){return this.children[idx];}}return undefined;}function onAttributeRename(evt){var labelWidget=getAttributeLabel.call(this,evt);if(labelWidget){labelWidget.set("name",evt.value);}}function onAttributeRemoved(evt){var labelWidget=getAttributeLabel.call(this,evt);if(labelWidget){this.removeChildren(labelWidget,true);labelWidget.destroy();this.parent.linker.drawLinks();}}mstrmojo.architect.ui.AttributesContainer=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.architect.ui.AttributesContainer",markupString:'<div id="{@id}" class="mstrmojo-ar-rp-AttributesContainer {@cssClass}" style="{@cssText}"> </div>',positions:undefined,init:function init(props){this._super(props);this.attributes={};var evtConfig={},containerConfig=evtConfig[this.id]={};containerConfig[$ENUM_DATA_CHANGE_EVENTS.RENAME]=onAttributeRename;containerConfig[$ENUM_DATA_CHANGE_EVENTS.REMOVE]=onAttributeRemoved;mstrApp.getRootController().attachDataChangeListeners(evtConfig);},refreshLabels:function refreshLabels(evt){var $this=this,childrenWidgets=this.children,childrenAttributes=this.attributes||{},attributes=evt.attributes,isChecked=evt.isChecked,isVisible=evt.isVisible,isEnabled=evt.isEnabled,entryPoints=evt.entryPoints||[],properties=evt.attributeProperties||[];$H.forEach(attributes,function addLabelsHelper(attributeObject,attributeId){if(childrenAttributes[attributeId]===undefined){addAttribute.call($this,{attributeId:attributeId,tableId:attributeObject.tableId,n:attributeObject.n,isChecked:isChecked,isVisible:isVisible,isEnabled:isEnabled,entryPoint:($A.find(entryPoints,"atid",attributeId)!==-1)?true:false,properties:properties[attributeId]},0,0);}});$A.forEach(evt.affectedAttributes,function(affectedId){if(attributes[affectedId]===undefined){var idx=$A.find(childrenWidgets,"attributeId",affectedId);if(idx!==-1){$this.removeChildren(childrenWidgets[idx]);delete childrenAttributes[affectedId];}}});reArrangeLabels.call(this,evt);},handleDragDrop:function handleDragDrop(context){var $this=this,rootController=mstrApp.getRootController(),contextSrc=context.src;if(contextSrc&&contextSrc.data){var dragAction=context.action,dragData=contextSrc.data,childAttributeID=dragData.caid,parentAttributeID=dragData.paid,attributeName=dragData.n,attributeId=dragData.attributeId,isWithin=dragData.isDragWithin,containerPos=$DOM.position(this.domNode),node=context.tgt.e,cb={success:function success(){if(!isWithin&&$A.find(this.children,"id",dragData.id)!==-1){return ;}if(childAttributeID||parentAttributeID){var dragDataType=dragData.type||3,attribute=$this.attributes[attributeId],addRelationHelper=function addRelationHelper(){var isChildDropZone=dragDataType===ENUM_DROP_ZONE_CHILD,isParentDropZone=dragDataType===ENUM_DROP_ZONE_PARENT;if(isWithin){if(isChildDropZone||isParentDropZone){rootController.addRelation(isChildDropZone?parentAttributeID:attributeId,isChildDropZone?attributeId:childAttributeID,dragData.tableId);}}};if(!attribute||!attribute.pids){addRelationHelper();}else{dragData.pids=attribute.pids;dragData.cids=attribute.cids;var parentChildAttrs=findConflictAttrs.call($this,dragData,dragDataType),pids=parentChildAttrs.pids;if(pids.length===0){addRelationHelper();}else{rootController.removeRelation(pids,parentChildAttrs.cids);}}}else{if(attributeId&&(dragAction===$ENUM_DRAG_ACTIONS.TABLE_VIEW_ATTR||dragAction===$ENUM_DRAG_ACTIONS.LINKER_ATTR)){dragData.entryPoint=true;addAttribute.call($this,dragData,node.clientX-containerPos.x,node.clientY-containerPos.y);$this.updateAttributePositions(attributeId,{x:node.clientX-containerPos.x+"px",y:node.clientY-containerPos.y+"px"});rootController.updateRelationPositions($this.getAttributePositions(),rootController.getCurrentHierarchyID());}}}};rootController.addAttributeToHierarchy(attributeId,attributeName,cb);}},updateAttributePositions:function updateAttributePositions(attributeId,pos){this.positions[attributeId]=pos;},getAttributePositions:function getAttributePositions(){return this.positions;},cleanUp:function cleanUp(){this.attributes={};this.removeChildren();}});}());