(function(){mstrmojo.requiresCls("mstrmojo._HasEditableText","mstrmojo.array","mstrmojo.Box","mstrmojo.css","mstrmojo.dom","mstrmojo.architect.EnumDataChangeEvents","mstrmojo.warehouse.ui.BasePanel","mstrmojo.architect.ui.SQLInputBox");var CSS_PREFIX="mstrmojo-ar-",CSS_PREFIX_TB_BTN="tbbtn",$DOM=mstrmojo.dom,$PX="px",$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,STR_SHOW_VIEWS=mstrmojo.desc(12229,"Show logical views"),STR_HIDE_VIEWS=mstrmojo.desc(12230,"Hide logical views"),STR_CLOSE=mstrmojo.desc(12231,"Close logical view"),STR_CLEAR_SQL=mstrmojo.desc(12232,"Clear SQL statement"),STR_EXEC_SQL=mstrmojo.desc(12233,"Execute SQL statement"),STR_INSTRUCTIONS=mstrmojo.desc(12228,"Please select a logical view or create a new one");function showContents(isVisible){this.parent.showBottomPanel(!isVisible);this.sqlText.set("visible",!isVisible);this.sqlText.set("visible",isVisible);this.set("instructionsVisible",!isVisible);}function updateViewItems(evt){this.allViewItems=evt.views;var viewId=evt.value,view=this.allViewItems[viewId];this.viewId=viewId;this.sqlText.reset();if(viewId){this.setEditableTitle(this.allViewItems[viewId].name);this.sqlText.setSQLStatement(view.SQLStatement);}else{this.setEditableTitle("");}showContents.call(this,!!viewId);this.onwidthChange({value:this.width});}mstrmojo.architect.ui.panels.LogicalViewSQLPanel=mstrmojo.declare(mstrmojo.warehouse.ui.BasePanel,[mstrmojo._HasEditableText],{scriptClass:"mstrmojo.architect.ui.panels.LogicalViewSQLPanel",viewId:"",allViewItems:{},cssClass:"ContentsInfoPanel",editableSlot:"titleNode",allowEmptyText:true,instructionsText:STR_INSTRUCTIONS,icntp:$ENUM_OT.TABLE_LOGICAL_VIEW,showList:undefined,sqlText:undefined,execSQL:undefined,viewListVisible:true,init:function init(props){var $this=this;this._super(props);var rootController=mstrApp.getRootController(),evtConfig={},panelConfig=evtConfig[this.id]={},sqlPanel=this;this.addNewTitleButton({title:STR_EXEC_SQL,alias:"execSQL",cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" execSQL",onclick:function(evt){var table=rootController.getTable(sqlPanel.viewId);table.SQLStatement=sqlPanel.sqlText.getSQLStatement();table.getSQLData(false,{success:function success(res){rootController.raiseExecuteSQLEvent(res.cols);table.updateViewDefinition({});},failure:function failure(){rootController.raiseExecuteSQLEvent([]);}});evt.cancel();}});this.addNewTitleButton({title:STR_CLEAR_SQL,cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" clearSQL",onclick:function(){sqlPanel.sqlText.setSQLStatement("");sqlPanel.execSQL.onclick({cancel:mstrmojo.emptyFn});}});this.addNewTitleButton({title:STR_CLOSE,cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" closeObject",onclick:function(){mstrApp.getRootController().closeViewObject();}});this.addNewTitleButton({title:STR_SHOW_VIEWS,alias:"showList",cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" showList",onclick:function(){$this.viewListVisible=!$this.viewListVisible;mstrApp.getRootController().toggleViewList();}});panelConfig[$ENUM_DATA_CHANGE_EVENTS.LOGICALVIEWS_CHANGED]=updateViewItems;rootController.attachDataChangeListeners(evtConfig);rootController.getPrimaryDBRoleTablesAndColumns({success:function success(res){sqlPanel.sqlText.tables=res.tables;sqlPanel.sqlText.columns=res.columns;}});},postBuildRendering:function postBuildRendering(){this._super();showContents.call(this,!!this.viewId);},closeObject:function closeObject(){mstrApp.getRootController().switchLogicalView("");this.setEditableTitle("");this.viewId="";showContents.call(this,false);},updateViewObjectName:function updateViewObjectName(itemID,itemName){if((!!(this.viewId))&&(itemID===this.viewId)){this.setEditableTitle(itemName);}},onTextEditComplete:function onTextEditComplete(textChanged,originalText){var rootController=mstrApp.rootController,panel=this;if(textChanged){var id=this.viewId,name=this.text,cb={success:function success(){rootController.updateViewListItem(id,name);},failure:function failure(){panel.setEditableTitle(originalText);}};rootController.renameLogicalView(id,name,cb);}},onRender:function onRender(){this._super();this.onheightChange({value:this.height});this.onwidthChange({value:this.width});},onheightChange:function onheightChange(evt){var h=parseInt(evt.value,10),headerHeight=this.headerHeight=this.headerHeight||(this.hasRendered?this.headerNode.clientHeight:36),contentHeight=(Math.max(parseInt(h,10)-headerHeight,0))+$PX;this.height=h+$PX;this.sqlText.set("height",contentHeight);this.set("instructionsHeight",this.height);},onwidthChange:function onwidthChange(evt){var $this=this,w=parseInt(evt.value,10),contentWidth=Math.max(w,0),textWidth=contentWidth-(this.titleIconsNode?$DOM.position(this.titleIconsNode).w:0)-25;if(this.showList.domNode){this.showList.set("title",($this.viewListVisible)?STR_HIDE_VIEWS:STR_SHOW_VIEWS);}this.width=w+$PX;this.sqlText.set("width",contentWidth+$PX);if(this.titleNode){this.titleNode.style.width=textWidth+$PX;}},children:[{scriptClass:"mstrmojo.architect.ui.SQLInputBox",alias:"sqlText",visible:false}]});}());