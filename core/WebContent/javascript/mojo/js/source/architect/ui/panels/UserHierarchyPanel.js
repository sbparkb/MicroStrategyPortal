(function(){mstrmojo.requiresCls("mstrmojo._HasEditableText","mstrmojo.dom","mstrmojo.architect.EnumDataChangeEvents","mstrmojo.architect.ui.EnumViewTypes","mstrmojo.architect.ui.RelationPanel","mstrmojo.architect.menu.UserHiearchySettingMenu");var $DOM=mstrmojo.dom,$H=mstrmojo.hash,$PX="px",CSS_PREFIX="mstrmojo-ar-",CSS_PREFIX_TB_BTN="tbbtn",$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,$MNU_ACTIONS=mstrmojo.architect.menu.EnumMenuActions,STR_CLOSE=mstrmojo.desc(12235,"Close user hierarchy"),STR_INSTRUCTIONS=mstrmojo.desc(12234,"Please select a user hierarchy or create a new one"),STR_SHOW_HIERARCHIES=mstrmojo.desc(12236,"Show user hierarchies"),STR_HIDE_HIERARCHIES=mstrmojo.desc(12237,"Hide user hierarchies"),STR_AUTO_ARRANGE=mstrmojo.desc(12238,"Auto arrange"),STR_NO_ENTRY_POINT=mstrmojo.desc(12239,"The user hierarchy '%1' has no entry points. The user hierarchy needs to have an entry point before proceeding"),$ENUM_VIEW_TYPES=mstrmojo.architect.ui.EnumViewTypes,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,STR_SETTINGS=mstrmojo.desc(7831,"Settings"),ENUM_ACTION_DRILL=$MNU_ACTIONS.USE_AS_DRILL,ENUM_ACTION_BROWSE=$MNU_ACTIONS.USE_AS_BROWSE;function showContents(isVisible){this.content.set("visible",isVisible);this.set("instructionsVisible",!isVisible);}function updatePanel(evt){var viewType=evt.viewType||0,isVisible=false,name="";if(viewType!==$ENUM_VIEW_TYPES.USER_HIERARCHY){return ;}this.hierarchyId=evt.hierarchyId;if(evt.hierarchyId){name=mstrApp.rootController.getUserHierarchy(evt.hierarchyId).n||"";isVisible=true;this.openTransactions[this.hierarchyId]={id:this.hierarchyId,n:name};}this.setEditableTitle(name);showContents.call(this,isVisible);this.onwidthChange({value:this.width});}mstrmojo.architect.ui.panels.UserHierarchyPanel=mstrmojo.declare(mstrmojo.architect.ui.RelationPanel,[mstrmojo._HasEditableText,mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.architect.ui.panels.UserHierarchyPanel",cssClass:"ContentsInfoPanel",editableSlot:"titleNode",allowEmptyText:true,instructionsText:STR_INSTRUCTIONS,icntp:$ENUM_OT.DIMENSION,viewListVisible:true,showList:undefined,init:function init(props){var $this=this;this._super(props);var rootController=mstrApp.getRootController(),panel=this,evtConfig={},panelConfig=evtConfig[this.id]={};this.addNewTitleButton({alias:"settings",cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" settings",title:STR_SETTINGS,onclick:function(){var menuHelper=$this.settingsMenu=$this.settingsMenu||new mstrmojo.architect.menu.UserHiearchySettingMenu();menuHelper.data={did:$this.hierarchyId,isVisible:function isVisible(){return true;},isChecked:function isChecked(data,item){var hierarchy=rootController.getHierarchy(rootController.getCurrentHierarchyID());switch(item.did){case ENUM_ACTION_DRILL:return(hierarchy.useForDrill);case ENUM_ACTION_BROWSE:return(!hierarchy.useForDrill);}return false;},isEnabled:function isEnabled(){return true;}};var cfg=menuHelper.getMenuConfig();cfg.hostId=$this.id;cfg.hostElement=this.domNode;cfg.isHostedWithin=false;$this.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));}});this.addNewTitleButton({title:STR_AUTO_ARRANGE,alias:"autoArrange",cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" autoarrange",onclick:function(){rootController.autoArray();}});this.addNewTitleButton({title:STR_CLOSE,cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" closeObject",onclick:function(){rootController.closeViewObject();}});this.addNewTitleButton({title:STR_SHOW_HIERARCHIES,alias:"showList",cssClass:CSS_PREFIX+CSS_PREFIX_TB_BTN+" showList",onclick:function(){$this.viewListVisible=!$this.viewListVisible;rootController.toggleViewList();}});panelConfig[$ENUM_DATA_CHANGE_EVENTS.RELATIONSHIP_CHANGED]=updatePanel;mstrApp.getRootController().attachDataChangeListeners(evtConfig);rootController.registerPreSaveCallback(function registerPreSaveCallback(callback){var canProceed=true,hierarchy,msg="";$H.forEach(panel.openTransactions,function(transaction){hierarchy=rootController.getHierarchy(transaction.id);if(hierarchy){msg=STR_NO_ENTRY_POINT.replace("%1",hierarchy.n);canProceed=canProceed&&(hierarchy.entryPoints.length>0);}return canProceed;});if(canProceed){callback.success();}return{canProceed:canProceed,msg:msg};});},openTransactions:{},postBuildRendering:function postBuildRendering(){this._super();showContents.call(this,!!this.hierarchyId);},getRelationshipChangedEvents:function getRelationshipChangedEvents(){return[mstrmojo.architect.EnumDataChangeEvents.RELATIONSHIP_CHANGED];},shouldClearExistingRelations:function shouldClearExistingRelations(){return true;},hierarchyId:"",onTextEditComplete:function onTextEditComplete(textChanged,originalText){var rootController=mstrApp.rootController,panel=this;if(textChanged){var id=this.hierarchyId,name=this.text,cb={success:function success(){rootController.updateViewListItem(id,name);},failure:function failure(){panel.setEditableTitle(originalText);}};rootController.renameUserHierarchy(id,name,cb);}},closeObject:function closeObject(){mstrApp.rootController.switchUserHierarchy("");this.setEditableTitle("");this.hierarchyId="";showContents.call(this,false);},beforeLeave:function beforeLeave(){},updateViewObjectName:function updateViewObjectName(itemID,itemName){if((!!(this.hierarchyId))&&(itemID===this.hierarchyId)){this.setEditableTitle(itemName);}},onwidthChange:function onwidthChange(evt){var $this=this,w=parseInt(evt.value,10),contentWidth=Math.max(w,0),textWidth=contentWidth-(this.titleIconsNode?$DOM.position(this.titleIconsNode).w:0)-25;if(this.showList.domNode){this.showList.set("title",($this.viewListVisible)?STR_HIDE_HIERARCHIES:STR_SHOW_HIERARCHIES);}this.width=w+$PX;if(this.titleNode){this.titleNode.style.width=textWidth+$PX;}}});}());