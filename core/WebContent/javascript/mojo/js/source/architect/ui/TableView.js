(function(){mstrmojo.requiresCls("mstrmojo._HasOwnAvatar","mstrmojo._IsMovable","mstrmojo.array","mstrmojo.Container","mstrmojo.css","mstrmojo.dom","mstrmojo.hash","mstrmojo.architect.EnumDataChangeEvents","mstrmojo.architect.EnumDragActions","mstrmojo.architect.menu.DBTableMenu","mstrmojo.architect.ui.TableRows","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.ui.menus.Menu","mstrmojo.warehouse._CanToggleAvatarClass","mstrmojo.warehouse.EnumObjectTypes");var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$H=mstrmojo.hash,$MAX=Math.max,$PX="px",STR_EMPTY_TABLE="No attributes or facts currently mapped.",CSS_CLASS_DRAGGING="dragging",DEFAULT_HEIGHT=220,DEFAULT_WIDTH=150,$TABLEVIEW,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,$ENUM_DRAG_ACTIONS=mstrmojo.architect.EnumDragActions,$ENUM_TYPES=mstrmojo.warehouse.EnumObjectTypes,TABLE_ZINDEX=10;function updatePosition(){if(this.domNode){var domNodeStyle=this.domNode.style,tableData=this.tableData;domNodeStyle.left=this.left||tableData.x;domNodeStyle.top=this.top||tableData.y;}}function bringTableToTop(domNode){var zIndex=domNode.style.zIndex;if(parseInt(zIndex,10)<(TABLE_ZINDEX-1)){domNode.style.zIndex=TABLE_ZINDEX++;}}function updateTableDimensions(height,width){var rowsWidget=this.rows,domNode=this.domNode;if(height===undefined||width===undefined){this.minHeight=this.height=Math.min(domNode.clientHeight,DEFAULT_HEIGHT);this.width=$MAX(domNode.clientWidth,DEFAULT_WIDTH);}else{this.height=$MAX(height,this.minHeight);this.width=$MAX(width,DEFAULT_WIDTH);}rowsWidget.set("height",(this.height-this._ttlHeight)+$PX);rowsWidget.set("width",this.width+$PX);}mstrmojo.architect.ui.TableView=mstrmojo.declare(mstrmojo.Container,[mstrmojo._IsMovable,mstrmojo._HasOwnAvatar,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.warehouse._CanToggleAvatarClass],{scriptClass:"mstrmojo.architect.ui.TableView",markupString:'<div id="{@id}" class="mstrmojo-ar-TableView" mstrAttach:click><div class="mstrmojo-ar-tv-header item"><span class="mstrmojo-ar-tv-ttl">{@title}</span><span class="item-mn"></span></div><div class="mstrmojo-ar-tv-rsz"></div></div>',markupSlots:{headerNode:function headerNode(){return this.domNode.firstChild;},titleNode:function titleNode(){return this.domNode.firstChild.firstChild;},containerNode:function containerNode(){return this.domNode;},menuNode:function menuNode(){return this.domNode.firstChild.lastChild;},resizeHandle:function resizeHandle(){return this.domNode.children[1];}},init:function init(props){this._super(props);this.rows.attachEventListener("tableViewMenuSelect",this.id,function tableMenuEventHandler(evt){$TABLEVIEW.showPopupMenu(this,evt);});},rows:undefined,preBuildRendering:function preBuildRendering(){this._super();this.title=this.tableData.n;var items=this.tableData.items;if(!items||items.length===0){items=this.tableData.items=[{n:STR_EMPTY_TABLE,tp:"none"}];}this.rows.items=items;},postBuildRendering:function postBuildRendering(){this._super();updatePosition.call(this);this._ttlHeight=this.headerNode.clientHeight;updateTableDimensions.call(this);this.domNode.style.zIndex=TABLE_ZINDEX++;},registerSelection:mstrmojo.emptyFn,getMenuTableData:mstrmojo.emptyFn,setTableSelected:function setTableSelected(isSelected){this.selected=isSelected;$CSS.toggleClass(this.domNode,"selected",!!isSelected);bringTableToTop(this.domNode);},getTableID:function getTableID(){return this.tableData.did;},onclick:function onclick(evt){var targetNode=evt.getTarget();if(targetNode===this.menuNode){$TABLEVIEW.showPopupMenu(this,{menuNode:this.menuNode,data:this.getMenuTableData()});}else{this.registerSelection(evt);this.setTableSelected(true);}},ontableDataChange:function ontableDataChange(){var rowContainer=this.rows;rowContainer.height=rowContainer.width=undefined;this.refresh();},isItemAvailable:function isItemAvailable(itemId){return((this.getTableID()===itemId)||this.rows.isItemAvailable(itemId));},handleEvent:function handleEvent(evt){var itemID=(evt.item&&evt.item.did)||evt.did,items=this.tableData.items,ret;if(this.getTableID()===itemID){switch(evt.name){case $ENUM_DATA_CHANGE_EVENTS.RENAME:this.titleNode.innerHTML=this.title=evt.value;return true;case $ENUM_DATA_CHANGE_EVENTS.LAYER_TABLE_CHANGED:this.set("tableData",evt.item);return true;}}else{ret=this.rows.handleEvent(evt);if(!items||items.length===0){items=this.tableData.items=[{n:STR_EMPTY_TABLE,tp:"none"}];this.rows.items=items;this.ontableDataChange();}return ret;}return false;},getMovingHandle:function getMovingHandle(){return this.headerNode;},draggable:true,createAvatar:function createAvatar(sourceNode){var div=document.createElement("div");if(sourceNode!==this.resizeHandle){var item=$DOM.findAncestorByAttr(sourceNode,"idx",true,this.domNode);if(item&&item.node){div.appendChild(item.node.cloneNode(true));div.appendChild(document.createElement("div"));}else{if(sourceNode===this.headerNode||sourceNode===this.titleNode){return this.domNode.cloneNode(true);}}div.className=this.domNode.className+" "+this.rows.domNode.className;}return div;},toggleAvatarClass:function toggleAvatarClass(cls,isAdd){$CSS.toggleClass(this.avatar,cls,isAdd);},isDragValid:function isDragValid(context){return context.src.node===this.resizeHandle||this._super(context)||false;},ondragstart:function ondragstart(context){this._super(context);this.shouldBeginDrag=$DOM.contains(this.getMovingHandle(),context.src.node,true,document.body);this.closePopup();$CSS.toggleClass(this.domNode,[CSS_CLASS_DRAGGING],true);if(context.src.node===this.resizeHandle){this._rszCfg={h:this.height,w:this.width};}},ondragmove:function ondragmove(context){var sourcePos=context.src.pos,targetPos=context.tgt.pos,resizeConfig;if(this._rszCfg){resizeConfig=this._rszCfg;updateTableDimensions.call(this,resizeConfig.h+targetPos.y-sourcePos.y,resizeConfig.w+targetPos.x-sourcePos.x);}else{this.positionAvatar(targetPos);}},ondragend:function ondragend(context){var sourcePos=context.src.pos,targetPos=context.tgt.pos,targetStyle=this.getMovingTarget().style;if(this.shouldBeginDrag){targetStyle.left=this.left=Math.max(0,this._leftPos+targetPos.x-sourcePos.x)+"px";targetStyle.top=this.top=Math.max(0,this._topPos+targetPos.y-sourcePos.y)+"px";}this._super(context);var domNode=this.domNode;$CSS.toggleClass(domNode,[CSS_CLASS_DRAGGING],false);bringTableToTop(domNode);delete this._rszCfg;},getDragAction:function getDragAction(context){var item=$DOM.findAncestorByAttr(context.src.node,"idx",true,this.domNode);if(item){switch(this.rows.getRowItem(item.value).tp){case $ENUM_TYPES.ATTRIBUTE:return $ENUM_DRAG_ACTIONS.TABLE_VIEW_ATTR;case $ENUM_TYPES.COLUMN:return $ENUM_DRAG_ACTIONS.PROJECT_TABLE_COLUMN;case $ENUM_TYPES.FACT:return $ENUM_DRAG_ACTIONS.TABLE_VIEW_METRIC;case $ENUM_TYPES.FORM:return $ENUM_DRAG_ACTIONS.COMPOUND_FORM;}}},getDragData:function getDragData(context){var item=$DOM.findAncestorByAttr(context.src.node,"idx",true,this.domNode);if(item){var itemInfo=this.rows.getRowItem(item.value);context.createRelations=true;return $H.copy(itemInfo,{attributeId:itemInfo.did,tableId:this.tableData.did});}},children:[{scriptClass:"mstrmojo.architect.ui.TableRows",alias:"rows"}]});$TABLEVIEW=mstrmojo.architect.ui.TableView;$TABLEVIEW.showPopupMenu=function showPopMenu(tableView,itemInfo){var menuHelper=$TABLEVIEW.menuHelper=$TABLEVIEW.menuHelper||new mstrmojo.architect.menu.DBTableMenu(),MENU_CONTEXT_LAYER=2;mstrApp.getRootController().setTableMenuContext(MENU_CONTEXT_LAYER);menuHelper.target=tableView;menuHelper.data=itemInfo.data;var cfg=menuHelper.getMenuConfig();cfg.hostId=tableView.id;cfg.hostElement=itemInfo.menuNode;cfg.isHostedWithin=false;cfg.hostProxyCssClass="item-mn-proxy";tableView.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));};}());