(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.dom","mstrmojo.HBox","mstrmojo.Label","mstrmojo.MenuButton","mstrmojo.ME.FunctionSelector","mstrmojo.qb.FunctionWizard","mstrmojo.ui.Pulldown","mstrmojo.architect.EnumColumnDataTypes","mstrmojo.architect.ExpressionEditBox","mstrmojo.architect.menu.ExpressionEditorMenu","mstrmojo.architect.ui.TableColumnsList");var $PX="px",$A=mstrmojo.array,$H=mstrmojo.hash,$DOM=mstrmojo.dom,CSS_PREFIX="mstrmojo-ar-trns-",$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,$ENUM_WH_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents,STR_TABLES=mstrmojo.desc(1761,"Tables"),STR_APPLY=mstrmojo.desc(134,"Apply"),STR_AVAILABLE_COLUMNS=mstrmojo.desc(12207,"Available columns");function updateColumns(evt){var editor=this,columns=evt.items,suggestedItems=[],cols=[],col;if(columns.length===0){return ;}$A.forEach(columns,function(column){col={tp:column.tp,n:column.cln,dt:column.dt};cols.push(col);suggestedItems.push(col);});editor.info.tableGroup.tableColumnsList.set("items",cols);var expressionEditBox=editor.info.expressionGroup.exprEditBox,expressionInputBox=expressionEditBox.inputBox;editor.columnsCache[editor.tables[editor.selectedTableIndex].did]=columns;editor.onheightChange({value:editor.height});$A.forEach(editor.functions,function(list){$A.forEach(list.fns,function(fn){suggestedItems.push(fn);});});var candidates={items:suggestedItems,isComplete:true};expressionInputBox.set("candidates",candidates);expressionEditBox.set("iStatus","");expressionEditBox.set("vStatus",0);}function update(evt){var editor=this,tablesList=editor.info.tableGroup.tableslist,columnList=editor.info.tableGroup.tableColumnsList,rootController=mstrApp.rootController,table=evt.value.table,expressionInputBox=editor.info.expressionGroup.exprEditBox.inputBox,source=evt.source||0,attributeID=evt.value.attribute.id,attributeName=evt.value.attribute.n,attribute;if(source!==0){return ;}this.transformationInfo=evt.value;this.parent.set("title","");if(attributeID){rootController.getTransformationTables(attributeID,{success:function success(res){attribute=rootController.getAttribute(attributeID);editor.parent.set("title",(attribute&&attribute.name)||attributeName);editor.tables=res.tables;var tableIndex=Math.max($A.find(editor.tables,"did",table.id),0);editor.selectedTableIndex=-1;tablesList.set("items",editor.tables);tablesList.list.set("items",editor.tables);tablesList.set("selectedIndex",tableIndex);}});}else{tablesList.set("items",[]);tablesList.render();columnList.set("items",[]);columnList.render();}expressionInputBox.clearTokens();rootController.tokenizeExpression((evt.value.expression||""),table.id,{success:function success(tokens){if(tokens){mstrApp.getRootController().trimTokenEnds(tokens.tkn);expressionInputBox.set("items",tokens.tkn);}editor.onheightChange({value:editor.height});}});}mstrmojo.architect.ui.editors.TransformationEditor=mstrmojo.declare(mstrmojo.Box,[mstrmojo._IsPopup,mstrmojo._HasPopup],{scriptClass:"mstrmojo.architect.ui.editors.TransformationEditor",cssClass:CSS_PREFIX+"Editor",init:function init(props){this._super(props);var editor=this,rootController=mstrApp.getRootController(),evtConfig={},tableConfig=evtConfig[this.id]={};tableConfig[$ENUM_DATA_CHANGE_EVENTS.TRANSFORMATION_SELECTED]=update;tableConfig[$ENUM_WH_DATA_CHANGE_EVENTS.DBTABLES_CHANGED]=function tableLoaded(){var tablesList=editor.info.tableGroup.tableslist,table,selIndex=tablesList.selectedIndex;if((selIndex!==undefined)&&(selIndex>=0)){table=rootController.getTable(editor.tables[selIndex].did);rootController.populateTableContents(table.id,{success:function success(){updateColumns.call(editor,{items:$H.valarray(table.columns)});}});}};rootController.attachDataChangeListeners(evtConfig);rootController.loadFunctions({success:function success(){editor.functions=rootController.getFunctions();}});this.info.expressionGroup.exprEditBox.inputBox.customFunctionMode=false;},transformationInfo:undefined,functions:[],title:"",functionSelector:{scriptClass:"mstrmojo.ME.FunctionSelector"},wizard:{scriptClass:"mstrmojo.qb.FunctionWizard"},exprEditBox:undefined,bottombox:undefined,applyButton:undefined,tableslist:undefined,tableColumnsList:undefined,expressionGroup:undefined,tableGroup:undefined,insertBtn:undefined,expGroupLabel:undefined,model:undefined,selectedTableIndex:undefined,tables:[],columnsCache:{},onheightChange:function onheightChange(evt){var info=this.info,h=parseInt(evt.value,10),hboxh=h-(this.applyButton.domNode?$DOM.position(this.applyButton.domNode).h:0)-5,conth=hboxh-15,colh=conth-75,exph=conth-24;this.height=h+$PX;if(!this.hasRendered){return ;}this.domNode.style.height=this.height;info.domNode.style.height=hboxh+$PX;info.tableGroup.domNode.style.height=conth+$PX;info.expressionGroup.domNode.style.height=conth+$PX;info.tableGroup.tableColumnsList.domNode.style.height=colh+$PX;info.expressionGroup.exprEditBox.domNode.style.height=exph+$PX;info.expressionGroup.exprEditBox.inputBox.domNode.style.height=(exph-26)+$PX;},onwidthChange:function onwidthChange(evt){var info=this.info,w=parseInt(evt.value,10);this.width=w+$PX;if(!this.hasRendered){return ;}var btnw=($DOM.position(info.expressionGroup.toolbar.insertBtn.domNode).w),expw=(w-$DOM.position(info.tableGroup.domNode).w-40);info.expressionGroup.domNode.style.width=expw+$PX;info.expressionGroup.toolbar.expGroupLabel.domNode.style.width=(expw-(2*btnw)-10)+$PX;},showFunctionSelector:function showFunctionSelector(){var $this=this;$this.openPopup("functionSelector",{functions:$this.functions,zIndex:this.zIndex+10,openWizard:function openWizard(item){$this.showWizard(item);}});},showWizard:function showWizard(item){var metricEditorBox=this.info.expressionGroup.exprEditBox.inputBox,$this=this;$this.openPopup("wizard",{fctOi:item,zIndex:$this.zIndex+10,insertOnFinish:function insertOnFinish(tokens){metricEditorBox.insertTokens(tokens);}});},onRender:function onRender(){this._super();this.onheightChange({value:this.height});this.onwidthChange({value:this.width});var selIndex=this.info.tableGroup.tableslist.selectedIndex;if((selIndex!==undefined)&&(selIndex>=0)){this.info.tableGroup.tableslist.selectedNode.innerHTML=this.info.tableGroup.tableslist.items[selIndex].n;}},children:[{scriptClass:"mstrmojo.HBox",cssClass:CSS_PREFIX+"content",alias:"info",children:[{scriptClass:"mstrmojo.Box",cssClass:CSS_PREFIX+"tableGroup",alias:"tableGroup",children:[{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"tableGroupLabel",text:STR_TABLES+":"},{scriptClass:"mstrmojo.ui.Pulldown",cssClass:CSS_PREFIX+"tableGroupPullDown",alias:"tableslist",postBuildRendering:function postBuildRendering(){this.list.getItemMarkup=function(){return'<{@tag} class="item {@cls}" idx="{@idx}" style="{@style}" title="{@n}">{@n}</{@tag}>';};},onitemsChange:function onitemsChange(res){if(res.value.length===0){this.selectedIndex=-1;updateColumns.call(this.parent,{items:[]});}},onitemSelected:function onitemSelected(item){var editor=this.parent.parent.parent,selNode=this.selectedNode;if(this.selectedIndex===editor.selectedTableIndex){return ;}editor.selectedTableIndex=this.selectedIndex;var tableID=item.did,rootController=mstrApp.rootController;if(editor.columnsCache[tableID]){updateColumns.call(editor,{items:editor.columnsCache[tableID]});}else{rootController.populateTableContents(item.did,{success:function susccess(){rootController.model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.TABLE_LOADED,columns:rootController.getTable(item.did).columns});}});}if(selNode.offsetWidth<selNode.scrollWidth){this.selectedNode.title=item.n;}}},{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"tableGroupLabel",text:STR_AVAILABLE_COLUMNS+":"},{scriptClass:"mstrmojo.architect.ui.TableColumnsList",cssClass:CSS_PREFIX+"colList",alias:"tableColumnsList"}]},{scriptClass:"mstrmojo.Box",cssClass:CSS_PREFIX+"expressionGroup",alias:"expressionGroup",children:[{scriptClass:"mstrmojo.HBox",alias:"toolbar",children:[{scriptClass:"mstrmojo.Label",cssClass:CSS_PREFIX+"expGroupLabel",alias:"expGroupLabel",text:mstrmojo.desc(4449,"Expression")+":"},{scriptClass:"mstrmojo.MenuButton",cssClass:CSS_PREFIX+"actionButtons",iconClass:"tbInsert",alias:"insertBtn",title:mstrmojo.desc(2919,"Insert"),onclick:function onclick(){var editor=this.parent.parent.parent.parent;var contextMenu=editor.linkMenu;if(!contextMenu){contextMenu=editor.linkMenu=new mstrmojo.architect.menu.ExpressionEditorMenu({zIndex:60});}contextMenu.target=editor;contextMenu.domNode=this.domNode;contextMenu.showContextMenu();}},{scriptClass:"mstrmojo.Button",cssClass:CSS_PREFIX+"actionButtons",title:mstrmojo.desc(2827,"Clear"),iconClass:"tbClear",onclick:function(){var editor=this.parent.parent.parent.parent;editor.info.expressionGroup.exprEditBox.inputBox.clearTokens([]);editor.onheightChange({value:editor.height});}}]},{scriptClass:"mstrmojo.architect.ExpressionEditBox",cssClass:CSS_PREFIX+"exprEditBox",alias:"exprEditBox",dropZone:true}]}]},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button "+CSS_PREFIX+"applybutton",alias:"applyButton",text:STR_APPLY,enabled:true,onclick:function(){var editor=this.parent,rootController=mstrApp.getRootController(),info=editor.transformationInfo,index=editor.info.tableGroup.tableslist.selectedIndex,newTable,tokensArray=[],tokensString;if(index>=0){newTable={id:editor.info.tableGroup.tableslist.items[index].did,n:editor.info.tableGroup.tableslist.items[index].n};$A.forEach(editor.info.expressionGroup.exprEditBox.inputBox.items,function(token){tokensArray.push(token.v);});tokensString=tokensArray.join(" ").replace(/<\s/g,"<").replace(/>\s/g,">");rootController.validateExpr({expr:tokensString,tid:newTable.id,vo:1},{success:function success(){editor.info.expressionGroup.exprEditBox.set("vStatus",0);editor.info.expressionGroup.exprEditBox.markupMethods.onvStatusChange.call(editor.info.expressionGroup.exprEditBox);editor.onheightChange({value:editor.height});rootController.addTransformationElement(info.id,info.attribute.id,tokensString,newTable.id,info.attribute.n,newTable.n,1);}});}}}]});}());