(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo.dom","mstrmojo.array","mstrmojo.hash","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.ui.menus.Menu","mstrmojo.architect.menu.ArchitectMenu","mstrmojo.architect.menu.RelationMenu");var $D=mstrmojo.dom,$H=mstrmojo.hash,$A=mstrmojo.array,$LINKER,LINKER_MENU=mstrmojo.architect.menu.RelationMenu,ENUM_RELATION_TYPE=mstrmojo.architect.menu.ArchitectMenu.EnumRelationType,SUPPORTS_SVG,SVG_NAMESPACE="http://www.w3.org/2000/svg",LINK_ID_PREFIX="lnk";function createVMLFrameElement(){var vmlRectangle=document.createElement("v:rect"),vmlRectangleStyle=vmlRectangle.style;vmlRectangle.setAttribute("id","vmlFrame");vmlRectangle.setAttribute("stroke","true");vmlRectangle.setAttribute("strokecolor","red");vmlRectangleStyle.width=this.width;vmlRectangleStyle.height=this.height;vmlRectangleStyle.zindex="-1";document.getElementById("vmlCanvas").appendChild(vmlRectangle);}function createVMLElement(){var pixelWidth=parseInt(this.width,10),pixelHeight=parseInt(this.height,10),vmlGroup=document.createElement("v:group"),vmlGroupStyle=vmlGroup.style;vmlGroup.setAttribute("id","vmlCanvas");vmlGroup.setAttribute("coordorigin","0, 0");vmlGroup.setAttribute("coordsize",pixelWidth+", "+pixelHeight);vmlGroupStyle.width=this.width;vmlGroupStyle.height=this.height;this.domNode.appendChild(vmlGroup);createVMLFrameElement.call(this);}function clearLinkHighlight(){var highlightLink=this.hltLinkId;if(highlightLink){if(document.getElementById(LINK_ID_PREFIX+highlightLink)){document.getElementById(LINK_ID_PREFIX+highlightLink).setAttribute("class","");delete this.hltLinkId;}}}function clearLinks(){if(SUPPORTS_SVG){delete this.svgNode;this.domNode.innerHTML="";}else{var vmlEl=document.getElementById("vmlCanvas");if(vmlEl.hasChildNodes()){while(vmlEl.childNodes.length>=1){vmlEl.removeChild(vmlEl.firstChild);}createVMLFrameElement.call(this);}}clearLinkHighlight.call(this);}function highLightLink(linkID){if(SUPPORTS_SVG){this.hltLinkId=linkID;if(document.getElementById(LINK_ID_PREFIX+linkID)){document.getElementById(LINK_ID_PREFIX+linkID).setAttribute("class","hlt");}}}function drawArrow(linkId,x1,y1,x2,y2,x3,y3,blueLine){var arrow;if(SUPPORTS_SVG){var svgNode=this.svgNode,svgDocument=svgNode.ownerDocument,groupId="lnk"+linkId,groupNode=svgNode.getElementById(groupId);if(!groupNode){groupNode=svgDocument.createElementNS(SVG_NAMESPACE,"g");}arrow=svgDocument.createElementNS(SVG_NAMESPACE,"polygon");arrow.setAttribute("points",x1+","+y1+" "+x2+","+y2+" "+x3+","+y3);if(blueLine){arrow.setAttribute("style","stroke:rgb(0,0,255)");}else{arrow.setAttribute("style","stroke:rgb(255, 255, 255)");}groupNode.appendChild(arrow);svgNode.appendChild(groupNode);}else{arrow=document.createElement("v:line");arrow.setAttribute("points",x1+","+y1+" "+x2+","+y2+" "+x3+","+y3);if(blueLine){arrow.setAttribute("fillcolor","blue");}else{arrow.setAttribute("fillcolor","black");}}}function drawLine(linkId,x1,y1,x2,y2,blueLine){var line;if(SUPPORTS_SVG){var svgNode=this.svgNode,svgDocument=svgNode.ownerDocument,groupId="lnk"+linkId,groupNode=svgNode.getElementById(groupId);if(!groupNode){groupNode=svgDocument.createElementNS(SVG_NAMESPACE,"g");groupNode.setAttribute("id",groupId);}line=svgDocument.createElementNS(SVG_NAMESPACE,"line");line.setAttribute("x1",String(x1));line.setAttribute("y1",String(y1));line.setAttribute("x2",String(x2));line.setAttribute("y2",String(y2));if(blueLine){line.setAttribute("style","stroke:rgb(0,0,255)");}groupNode.appendChild(line);svgNode.appendChild(groupNode);}else{line=document.createElement("v:line");line.setAttribute("from",[x1," ",y1].join(""));line.setAttribute("to",[x2," ",y2].join(""));if(blueLine){line.setAttribute("fillcolor","blue");}}}function distanceToLineSegment(a,b,c){var square=function square(x){return x*x;},distanceToLine=function distanceToLine(v,w){return square(v.x-w.x)+square(v.y-w.y);},comparisonPoint;var projection=((c.x-a.x)*(b.x-a.x)+(c.y-a.y)*(b.y-a.y))/distanceToLine(a,b);if(projection<0){comparisonPoint=a;}if(projection>1){comparisonPoint=b;}return Math.sqrt(distanceToLine(c,comparisonPoint||{x:a.x+projection*(b.x-a.x),y:a.y+projection*(b.y-a.y)}));}function isRelationClicked(coords,point){return distanceToLineSegment(coords.src,coords.tgt,point)<=13;}function getRelationLink(x,y){var returnVal=null;$H.forEach(this.linksInfo,function(link,linkId){if(isRelationClicked(link.coords,{x:x,y:y})){returnVal=linkId;return false;}return true;},this);return returnVal;}mstrmojo.architect.ui.RelationLinker=mstrmojo.declare(mstrmojo.Widget,[mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.architect.ui.RelationLinker",markupString:'<div id="{@id}" class="mstrmojo-RelationLinker" mstrAttach:click></div>',markupMethods:{onvisibleChange:function onvisibleChange(){this.domNode.style.display=(this.visible)?"block":"none";},onheightChange:function onheightChange(){var max=this._max;this.domNode.style.height=Math.max(parseInt(this.height,10),(max&&max.y)||0)+"px";},onwidthChange:function onwidthChange(){var max=this._max;this.domNode.style.width=Math.max(parseInt(this.width,10),(max&&max.x)||0)+"px";}},init:function init(props){this._super(props);this.linksInfo={};},postBuildRendering:function postBuildRendering(){this._super();if(!SUPPORTS_SVG){SUPPORTS_SVG=!!document.createElementNS&&!!document.createElementNS(SVG_NAMESPACE,"svg").createSVGRect;}if(!SUPPORTS_SVG){createVMLElement.call(this);}},handleClick:function handleClick(evt){var pos=$D.position(this.domNode),x=evt.clientX,y=evt.clientY,linkID=getRelationLink.call(this,x-pos.x,y-pos.y);if(linkID){highLightLink.call(this,linkID);$LINKER.showPopupMenu(this,{data:this.linksInfo[linkID].relationObj,pos:{x:x+2,y:y+2}});}else{this.closePopup();clearLinkHighlight.call(this);}},_max:{x:0,y:0},drawLinks:function drawLinks(evt){if(isNaN(this._max.x)||isNaN(this._max.y)){this._max={x:0,y:0};}var newMaxDims=evt&&evt.MAX_DIMS,maxDims=this._max,h=parseInt(this.height,10),w=parseInt(this.width,10);if(newMaxDims){maxDims.x=Math.max(newMaxDims.x,maxDims.x);maxDims.y=Math.max(newMaxDims.y,maxDims.y);this.set("height",Math.max(maxDims.y,isNaN(h)?0:h)+"px");this.set("width",Math.max(maxDims.x,isNaN(w)?0:w)+"px");}clearLinks.call(this);var relations=this.relations=(evt&&evt.relations)||this.relations,i,relationsCount=relations&&relations.length,MARGIN=8,SMALL_MARGIN=4;if(SUPPORTS_SVG){var svgNode=this.svgNode=document.createElementNS(SVG_NAMESPACE,"svg");svgNode.style.width=this.width;svgNode.style.height=this.height;}for(i=0;i<relationsCount;i++){var children=this.parent.elemBox.children,sourceIdx=$A.find(children,"attributeId",relations[i].parentAttributeId),targetIdx=$A.find(children,"attributeId",relations[i].childAttributeId);if(sourceIdx===-1||targetIdx===-1){continue;}var sourceWidget=children[sourceIdx],targetWidget=children[targetIdx],sourceContainerNode=sourceWidget.containerNode,targetContainer=targetWidget.containerNode,sourcePos=$D.delta(sourceContainerNode,this.domNode),targetPos=$D.delta(targetContainer,this.domNode),sourceX=sourcePos.x+0.5*sourceContainerNode.clientWidth,sourceY=sourcePos.y+sourceContainerNode.clientHeight,targetX=targetPos.x+0.5*targetContainer.clientWidth,targetY=targetPos.y,isSourceBelowTarget=(sourceY-sourcePos.h)>targetY,padding=isSourceBelowTarget?-MARGIN:MARGIN,smallPadding=isSourceBelowTarget?-SMALL_MARGIN:SMALL_MARGIN,isJointChildren=relations[i].isJointChildren||false;sourceY-=isSourceBelowTarget?sourcePos.h:0;targetY+=isSourceBelowTarget?targetPos.h:0;var relationObject=relations[i];this.linksInfo[i]={relationObj:relationObject,coords:{src:{x:sourceX,y:sourceY},tgt:{x:targetX,y:targetY}},marker:[{x:sourceX,y:sourceY},{x:sourceX,y:sourceY+MARGIN},{x:targetX,y:targetY},{x:targetX,y:targetY-MARGIN}]};drawLine.call(this,i,sourceX,sourceY,sourceX,sourceY+padding,false);drawLine.call(this,i,sourceX,sourceY+padding,targetX,targetY-padding,isJointChildren);drawLine.call(this,i,targetX,targetY-padding,targetX,targetY,false);var type=relationObject.relationType,isSourceOne=type===ENUM_RELATION_TYPE.ONE_TO_ONE||type===ENUM_RELATION_TYPE.ONE_TO_MANY,isSourceMany=type===ENUM_RELATION_TYPE.MANY_TO_MANY,isTargetOne=type===ENUM_RELATION_TYPE.ONE_TO_ONE,isTargetArrow=type===ENUM_RELATION_TYPE.PARENT_CHILD;if(isSourceOne){drawLine.call(this,i,sourceX-padding,sourceY+padding,sourceX+padding,sourceY+padding,isJointChildren);}else{if(isSourceMany){drawLine.call(this,i,sourceX,sourceY+padding,sourceX-padding,sourceY,isJointChildren);drawLine.call(this,i,sourceX,sourceY+padding,sourceX+padding,sourceY,isJointChildren);}}if(isTargetOne){drawLine.call(this,i,targetX-padding,targetY-padding,targetX+padding,targetY-padding,isJointChildren);}else{if(isTargetArrow){drawArrow.call(this,i,targetX-smallPadding,targetY-padding,targetX+smallPadding,targetY-padding,targetX,targetY,isJointChildren);}else{drawLine.call(this,i,targetX-padding,targetY,targetX,targetY-padding,isJointChildren);drawLine.call(this,i,targetX+padding,targetY,targetX,targetY-padding,isJointChildren);}}}if(SUPPORTS_SVG){this.domNode.appendChild(this.svgNode);}}});$LINKER=mstrmojo.architect.ui.RelationLinker;$LINKER.showPopupMenu=function showPopMenu(linkerWidget,linkInfo){var menuHelper=$LINKER.linkMenu=$LINKER.linkMenu||new LINKER_MENU({zIndex:45});menuHelper.set("cmPos",linkInfo.pos);menuHelper.target=linkerWidget;menuHelper.data=linkInfo.data;var cfg=menuHelper.getMenuConfig();var hostProxyElement=document.createElement("div");document.body.appendChild(hostProxyElement);var divStyle=hostProxyElement.style;divStyle.position="absolute";divStyle.top=linkInfo.pos.y+"px";divStyle.left=linkInfo.pos.x+"px";divStyle.height="1px";divStyle.width="1px";cfg.hostId=linkerWidget.id;cfg.hostElement=hostProxyElement;cfg.isHostedWithin=false;cfg.addPopupHandlers(linkerWidget.id,mstrmojo.emptyFn,function closeRelationMenu(){clearLinkHighlight.call(linkerWidget);document.body.removeChild(hostProxyElement);});mstrApp.getRootController().prePopulateRelationMenu(linkInfo.data,{success:function success(){linkerWidget.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));}});};}());