(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.architect.ui.TableView","mstrmojo.architect.EnumDataChangeEvents","mstrmojo.architect.EnumDragActions","mstrmojo._HasLassoSelector","mstrmojo.warehouse._CanToggleAvatarClass","mstrmojo.boxmodel","mstrmojo.dom","mstrmojo.hash","mstrmojo.array");var $DOM=mstrmojo.dom,$H=mstrmojo.hash,$ARR=mstrmojo.array,$BM=mstrmojo.boxmodel,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.architect.EnumDataChangeEvents,$ENUM_DRAG_ACTIONS=mstrmojo.architect.EnumDragActions,DRAG_ACTION_PROJECT_TABLE=$ENUM_DRAG_ACTIONS.PROJECT_TABLE,DRAG_ACTION_ADD_TABLE=$ENUM_DRAG_ACTIONS.ADD_TABLE,EVENT_REMOVE=$ENUM_DATA_CHANGE_EVENTS.REMOVE,CASCADING_PADDING=25,$PX="px";function refreshTables(evt){var tableData=evt.item,tableID=evt.did||tableData.did,evtName=evt.name;$ARR.forEach(this.children,function delegateRefreshTables(table){if(table.isItemAvailable(tableID)){var handled=table.handleEvent(evt);if(!handled){switch(evtName){case EVENT_REMOVE:this.removeTable(table.tableData);return false;}}}return true;},this);}function handleTableSelections(tableId,isMultiple){var currSelections=this.selTableIds;if(currSelections.length>0&&!isMultiple){$ARR.forEach(currSelections,function(tableWidgetId){mstrmojo.all[tableWidgetId].setTableSelected(false);});this.selTableIds=[];}this.selTableIds.push(tableId);}mstrmojo.architect.ui.TableContainer=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasLassoSelector,mstrmojo.warehouse._CanToggleAvatarClass],{scriptClass:"mstrmojo.architect.ui.TableContainer",markupString:'<div id="{@id}" class="mstrmojo-ar-TableContainer {@cssClass}" style="{@cssText}" mstrAttach:click><div class="mstrmojo-ar-tc-container"></div></div>',markupSlots:{containerNode:function containerNode(){return this.domNode.lastChild;}},init:function init(props){this._super(props);var rootController=mstrApp.getRootController(),evtConfig={},tableConfig=evtConfig[this.id]={};tableConfig[$ENUM_DATA_CHANGE_EVENTS.TABLES_SELECTED]=function selTableIDChange(evt){$ARR.forEach(evt.tableItems,function(tableData){this[((evt.toAdd?"add":"remove")+"Table")](tableData);},this);};tableConfig[$ENUM_DATA_CHANGE_EVENTS.LAYER_TABLE_CHANGED]=tableConfig[$ENUM_DATA_CHANGE_EVENTS.RENAME]=tableConfig[EVENT_REMOVE]=refreshTables;tableConfig[$ENUM_DATA_CHANGE_EVENTS.BEFORE_LAYER_CHANGE]=this.updateTablePositionCache;rootController.attachDataChangeListeners(evtConfig);this.selTableIds=[];var tableContainer=this;rootController.registerSaveCallback(function(){if(tableContainer.hasRendered){tableContainer.updateTablePositionCache();}});},onclick:function onclick(evt){var targetNode=evt.getTarget();if(targetNode===this.containerNode||targetNode===this.domNode){$ARR.forEach(this.children,function(table){table.setTableSelected(false);},this);this.selTableIds=[];}},addTable:function addTable(tableData){var tableContainer=this,tables=this.children,tableID=tableData.did;$ARR.forEach(tables,function(table){if(table.isItemAvailable(tableID)){this.removeTable(tableData);}},this);if((tableData.x===undefined)||(tableData.y===undefined)){var cascadingPadding=CASCADING_PADDING*(tables?tables.length:0)+$PX;tableData=$H.copy({x:cascadingPadding,y:cascadingPadding},tableData);}tableContainer.addChildren([new mstrmojo.architect.ui.TableView({tableData:tableData,left:tableData.x,top:tableData.y,registerSelection:function registerSelection(evt){handleTableSelections.call(tableContainer,this.id,($DOM.ctrlKey(evt.hWin,evt.e)||$DOM.isMetaKey(evt.hWin,evt.e)));},getMenuTableData:function getMenuTableData(){var $ALL=mstrmojo.all,currSelections=tableContainer.selTableIds,data=[];if(currSelections.length>1){$ARR.forEach(currSelections,function(tableWidgetId){data.push($ALL[tableWidgetId].tableData);});}else{data=this.tableData;}return data;}})]);},removeTable:function removeTable(tableData){var tableContainer=this,tableID=tableData.did;$ARR.forEach(this.children,function(table,idx){if(table.getTableID()===tableID){tableContainer.removeChildren(tableContainer.children[idx]);mstrApp.getRootController().removeFromCurrentLayer(table.tableData);return false;}return true;});},updateTablePositionCache:function updateTablePositionCache(){if(this.domNode){var tables=this.children,containerPosition=$DOM.position(this.domNode),items=[];$ARR.forEach(tables,function(table){var tablePosition=$DOM.position(table.domNode);items.push($H.copy({x:((tablePosition.x-containerPosition.x)+$PX),y:((tablePosition.y-containerPosition.y)+$PX),h:tablePosition.h+$PX,w:tablePosition.w+$PX},table.tableData));});mstrApp.getRootController().setLayerTablePositions(items);}},refresh:function refresh(updateCache){if(updateCache){this.updateTablePositionCache();}this.removeChildren();$ARR.forEach(mstrApp.getRootController().getTablePositions(),function(table){this.addTable(table);},this);},dropZone:true,allowDrop:function allowDrop(context){return[DRAG_ACTION_PROJECT_TABLE,DRAG_ACTION_ADD_TABLE].indexOf(context.action)!==-1;},ondrop:function ondrop(context){var dragEvent=context.action,contextSrc=context.src,dragData=contextSrc.data;if(contextSrc&&dragData){if(dragEvent===DRAG_ACTION_PROJECT_TABLE||dragEvent===DRAG_ACTION_ADD_TABLE){var domPos=$DOM.position(this.domNode),dropPos=context.tgt.pos,x=dropPos.x-domPos.x,y=dropPos.y-domPos.y;$ARR.forEach(dragData,function appendDragPos(tableData,idx){var cascadingPadding=CASCADING_PADDING*idx;tableData.x=x+cascadingPadding;tableData.y=y+cascadingPadding;});mstrApp.getRootController().addOrRemoveTables(dragData,true);}}},ondragstart:function ondragstart(evt){var children=this.children,containerNode=this.containerNode,childPosition=this.childPositions=[];$ARR.forEach(children,function(childWidget){var domNode=childWidget.domNode,position=$DOM.position(domNode),delta=$DOM.delta(domNode,containerNode);childPosition.push({id:childWidget.id,x:delta.x,y:delta.y,h:position.h,w:position.w});});this._super(evt);},onSelectedBoundingBox:function onSelectedBoundingBox(boundingBox){var intersects=function intersects(childInfo){return $BM.rangeIntersect(childInfo.y,childInfo.y+childInfo.h,boundingBox.y,boundingBox.y+boundingBox.h)&&$BM.rangeIntersect(childInfo.x,childInfo.x+childInfo.w,boundingBox.x,boundingBox.x+boundingBox.w);},currentSelections=this.selTableIds=[];$ARR.forEach(this.childPositions,function(childInfo){var childId=childInfo.id,doesChildIntersect=intersects(childInfo),childSelectionIdx=currentSelections.indexOf(childId);mstrmojo.all[childId].setTableSelected(doesChildIntersect);if(doesChildIntersect){currentSelections.push(childId);}else{if(childSelectionIdx!==-1){currentSelections.splice(childSelectionIdx,1);}}},this);}});}());