(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.ME.MetricEditBox","mstrmojo.warehouse._CanToggleAvatarClass");var $A=mstrmojo.array,$S=mstrmojo.string,$CSS=mstrmojo.css,_D=mstrmojo.dom,CSS_VISIBLE="visible",DEL_LIST=["(",")","{","}","-","+","*","/","<",">","=","|","~",","," ","\t","\n",";"],DEL_MAP=null,$ENUM_OT=mstrmojo.warehouse.EnumObjectTypes,ENUM_OT_TABLE=$ENUM_OT.TABLE,ENUM_OT_COLUMN=$ENUM_OT.COLUMN;function isDelimiterHelper(c){var i;if(!DEL_MAP){DEL_MAP={};for(i=0;i<DEL_LIST.length;i++){DEL_MAP[DEL_LIST[i]]=true;}}return DEL_MAP[c];}mstrmojo.architect.ui.SQLInputBox=mstrmojo.declare(mstrmojo.ME.MetricEditBox,[mstrmojo.warehouse._CanToggleAvatarClass],{scriptClass:"mstrmojo.architect.ui.SQLInputBox",cssClass:"mstrmojo-ar-sqlInput-inputbox",dropZone:true,allowDrop:function allowDrop(context){var obj=[].concat(context.src.data)[0],model=mstrApp.rootController.model;if(!obj){return false;}if(!((obj.tp===ENUM_OT_COLUMN)||(obj.tp===ENUM_OT_TABLE))){return false;}return(model.SelDBRoleID===model.projPrimaryDBRoleID);},ondrop:function ondrop(context){var $this=this,obj=[].concat(context.src.data)[0],items=this.inputBox.items,addTokens=function addTokens(cols){items=[{v:"select"}];items.push({v:String.fromCharCode(10)});$A.forEach(cols,function(col){items.push({v:col.cln});items.push({v:", "});});items.pop();items.push({v:String.fromCharCode(10)});items.push({v:"from"});items.push({v:String.fromCharCode(10)});items.push({v:obj.n});$this.inputBox.set("items",items);$this.parent.execSQL.onclick({cancel:mstrmojo.emptyFn});$this.inputBox.focus();};if(!obj){return ;}this.inputBox.set("items",[]);switch(obj.tp){case ENUM_OT_COLUMN:items.push({v:obj.cln});this.inputBox.set("items",items);break;case ENUM_OT_TABLE:var isDBTable=(context.src.widget.alias==="dbTableTree");if(isDBTable){mstrApp.rootController.getColumnsForDBTable({data:obj},{success:function success(res){addTokens(res.items);}});}else{mstrApp.rootController.model.getAttributesFactsInTable(obj.did,{success:function success(){addTokens(mstrApp.rootController.model.getTable(obj.did).columns);}});}break;}},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.onheightChange({value:this.height});this.onwidthChange({value:this.width});this.reset();},onheightChange:function onheightChange(evt){var iBox=this.inputBox,height=evt.value;if(iBox.hasRendered&&height!==undefined){iBox.height=height;iBox.domNode.style.height=height;iBox.editNode.style.height=height;}},onwidthChange:function onwidthChange(evt){var iBox=this.inputBox,width=evt.value;if(iBox.hasRendered&&width!==undefined){iBox.width=width;iBox.editNode.style.width=width;}},tables:[],columns:[],sqlFunctions:[{n:"Select"},{n:"Update"},{n:"Insert"},{n:"Delete"},{n:"Create"},{n:"Drop"},{n:"Alter"},{n:"Set"},{n:"Exec"},{n:"From"},{n:"Where"},{n:"Having"},{n:"In"},{n:"Group"},{n:"By"},{n:"Order"},{n:"Into"},{n:"On"},{n:"Values"},{n:"Table"},{n:"Case"},{n:"Then"},{n:"Else"},{n:"Join"},{n:"As"}],getSQLStatement:function getSQLStatement(){var tokensArray=[];$A.forEach(this.inputBox.items,function(token){tokensArray.push(token.v);});return $S.trim(tokensArray.join("").replace(/<\s/g,"<").replace(/>\s/g,">"));},setSQLStatement:function setSQLStatement(sqlStatement){var items=[],tkn,CRLF="\n",COMMA=", ",tokens=sqlStatement.split(CRLF),commaTokens;$A.forEach(tokens,function(token){tkn=$S.trim(token);if(tkn.indexOf(COMMA)>0){commaTokens=tkn.split(COMMA);$A.forEach(commaTokens,function(commaToken){items.push({v:$S.trim(commaToken)});items.push({v:COMMA});});items.pop();}else{items.push({v:tkn});}items.push({v:CRLF});});this.inputBox.set("items",items);},onvisibleChange:function onvisibleChange(){$CSS.toggleClass(this.domNode,CSS_VISIBLE,this.visible);$CSS.toggleClass(this.inputBox.domNode,CSS_VISIBLE,this.visible);},reset:function reset(){var candidates={items:this.sqlFunctions.concat(this.tables).concat(this.columns),isComplete:true};this.inputBox.set("candidates",candidates);this.inputBox.set("items",[]);},children:[{scriptClass:"mstrmojo.ME.TokenInputBox",cssClass:"mstrmojo-ar-sqlInput-tokenbox",alias:"inputBox",slot:"editNode",browseItemVisible:false,renderBlockSize:1000,lastPagePos:{left:0,top:0,width:0,height:0},lastScrollPos:{left:0,top:0,width:0,height:0},breakOnEnterKeyDown:function breakOnEnterKeyDown(){return !this.suggestionShown;},getCharacter:function getCharacter(e){var k=(_D.isIE&&!_D.isIE9)?e.keyCode:e.charCode;return(k>0)?((k===13)?"\n":String.fromCharCode(k)):null;},ondrop:function(c){this.parent.ondrop(c);},ondragenter:function ondragenter(context){this.parent.ondragenter(context);},allowDrop:function allowDrop(context){return this.parent.allowDrop(context);},item2textCss:function item2textCss(data){return{15:" mstrmojo-ArchitectListIconSuggest t15 ",26:" mstrmojo-ArchitectListIconSuggest t26 "}[data.tp||data.t]||"";},itemFunction:function itemFunction(item){return new mstrmojo.ME.MetricToken({data:item,brackets:function(s){return s;},isDelimiter:function isDelimiter(){var data=this.data,dataLength=data.v.length;if(data){return data.isDelimiter||(dataLength===1&&isDelimiterHelper(data.v));}return false;}});},isDelimiter:isDelimiterHelper}]});}());