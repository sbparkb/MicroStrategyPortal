(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.HBox","mstrmojo.Label","mstrmojo.MenuButton","mstrmojo.architect.ExpressionEditBox","mstrmojo.architect.EnumColumnDataTypes","mstrmojo.architect.menu.ExpressionEditorMenu","mstrmojo.ME.FunctionSelector","mstrmojo.qb.FunctionWizard","mstrmojo.ui.Pulldown");var $EXPR_EDITOR,$A=mstrmojo.array,$H=mstrmojo.hash;function getTokensAsString(tokens){var tokensArray=[];$A.forEach(tokens,function(token){tokensArray.push(token.v);});return tokensArray.join(" ").replace(/<\s/g,"<").replace(/>\s/g,">");}function validateExpression(callback){var editor=this;editor.validationFunc({expr:getTokensAsString(editor.exprEditBox.inputBox.items),tid:editor.oi.tbl.did,vo:1},{success:function success(res){if(res&&res.mi.oi.tknstrm.mi){mstrApp.getRootController().trimTokenEnds(res.mi.oi.tknstrm.mi.tkn);editor.exprEditBox.handleValidation(res.mi.oi);if(!res.mi.reject_error_code&&callback&&callback.success){callback.success();}else{if(callback&&callback.failure){callback.failure(res);}}}}});}function updateFields(item){var $this=this,optBox=this.bottombox.optionsBox;$this.dtChanged=true;optBox.removeChildren(null,true);$A.forEach(item.options,function(option,index){optBox.addChildren([new mstrmojo.Label({cssClass:"mstrmojo-architect-ExpressionEditBox-option",text:option.txt})]);optBox.addChildren([new mstrmojo.TextBox({cssClass:"mstrmojo-architect-ExpressionEditBox-optiontxt",alias:"opt"+index,type:"number",min:0,value:0,onvalueChange:function(){$this.dtChanged=true;},postCreate:function(){if($this.expressionColumn){this.set("value",$this.expressionColumn.dt[option.field]);}}})]);});}mstrmojo.architect.ExpressionEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.architect.ExpressionEditor",cssClass:"mstrmojo-architect-ExpressionEditor",zIndex:50,id:"ExpressionEditor",suggestedItems:[],functions:[],tokens:[],title:"",functionSelector:{scriptClass:"mstrmojo.ME.FunctionSelector"},wizard:{scriptClass:"mstrmojo.qb.FunctionWizard"},exprEditBox:undefined,bottombox:undefined,datatypelist:undefined,optionsBox:undefined,opt0:undefined,opt1:undefined,originalDTIndex:undefined,expressionColumn:undefined,columnInTable:false,dtChanged:false,model:undefined,onOpen:function onOpen(){var $this=this,objectInfo=this.oi,expressionEditBox=this.exprEditBox,expressionInputBox=expressionEditBox.inputBox,expColId;expressionInputBox.customFunctionMode=false;objectInfo.isSave=false;$this.suggestedItems=[];$this.expressionColumn=undefined;$this.columnInTable=false;if(objectInfo.objectForExpression){expColId=objectInfo.objectForExpression.columnId;}$A.forEach(objectInfo.tbl.clns,function(column){$this.suggestedItems.push(column);if(expColId===column.cmid){$this.expressionColumn=column;$this.columnInTable=true;}});if(!$this.expressionColumn&&$this.model.columns[expColId]){$this.expressionColumn=$this.model.columns[expColId];}$A.forEach(this.functions,function(list){$A.forEach(list.fns,function(fn){$this.suggestedItems.push(fn);});});var candidates={items:$this.suggestedItems,isComplete:true};expressionInputBox.set("candidates",candidates);$this.set("candidates",candidates);expressionEditBox.set("iStatus","");expressionEditBox.set("vStatus",0);if(objectInfo&&objectInfo.tokens){mstrApp.getRootController().trimTokenEnds(objectInfo.tokens);expressionInputBox.set("items",objectInfo.tokens);}var types=[],list=$this.bottombox.datatypelist;if($this.oi.isNew){types.push({id:0,n:" Auto Detect"});}$H.forEach(mstrmojo.architect.EnumColumnDataTypes,function(dt){types.push(dt);});types.sort(function(a,b){return a.n.toUpperCase().localeCompare(b.n.toUpperCase());});list.set("items",types);if(!this.expressionColumn&&expColId){this.expressionColumn=mstrApp.getRootController().getColumns()[expColId];}if($this.expressionColumn){$this.originalDTIndex=$A.find($this.bottombox.datatypelist.items,"id",$this.expressionColumn.dt.tp);list.set("selectedIndex",$this.originalDTIndex);}else{list.set("selectedIndex",0);}$this.dtChanged=false;},showFunctionSelector:function showFunctionSelector(){var $this=this;$this.openPopup("functionSelector",{functions:this.functions,zIndex:this.zIndex+10,openWizard:function openWizard(item){$this.showWizard(item);}});},showWizard:function showWizard(item){var metricEditorBox=this.exprEditBox.inputBox,$this=this;$this.openPopup("wizard",{fctOi:item,zIndex:$this.zIndex+10,insertOnFinish:function insertOnFinish(tokens){metricEditorBox.insertTokens(tokens);}});},children:[{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-toolBox toolbar",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-Editor-toolBox expLabel",text:mstrmojo.desc(4449,"Expression")+":"},{scriptClass:"mstrmojo.MenuButton",iconClass:"tbInsert",title:mstrmojo.desc(2919,"Insert"),onclick:function onclick(){$EXPR_EDITOR.showPopupMenu(this.parent.parent,this.domNode);}},{scriptClass:"mstrmojo.Button",title:mstrmojo.desc(9110,"Syntax Validation"),iconClass:"tbValidate",onclick:function(){validateExpression.call(this.parent.parent,null);}},{scriptClass:"mstrmojo.Button",title:mstrmojo.desc(2827,"Clear"),iconClass:"tbClear",onclick:function(){var editor=this.parent.parent;editor.oi.tokens=[];editor.exprEditBox.inputBox.clearTokens([]);}}]},{scriptClass:"mstrmojo.architect.ExpressionEditBox",alias:"exprEditBox"},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-architect-ExpressionEditBox-bottombox",alias:"bottombox",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-architect-ExpressionEditBox-dt",text:mstrmojo.desc(9918,"data type")+":"},{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"mstrmojo-architect-ExpressionEditBox-dtlist",alias:"datatypelist",onitemSelected:function onitemSelected(item){updateFields.call(this.parent.parent,item);}},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-architect-ExpressionEditBox-optionsbox",alias:"optionsBox"},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-architect-ExpressionEditBox-buttonbox",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(5891,"Save"),onclick:function onclick(){var editor=this.parent.parent.parent,objectInfo=editor.oi;objectInfo.isSave=(editor.exprEditBox.inputBox.itemsContainerNode.textContent!=="");if(objectInfo.isSave){validateExpression.call(editor,{success:function success(){editor.callBackFunction({expression:getTokensAsString(editor.exprEditBox.inputBox.items),selItem:editor.bottombox.datatypelist.items[editor.bottombox.datatypelist.selectedIndex],precision:parseInt((editor.bottombox.optionsBox.opt0&&editor.bottombox.optionsBox.opt0.value)||"0",10),scale:parseInt((editor.bottombox.optionsBox.opt1&&editor.bottombox.optionsBox.opt1.value)||"0",10),dtChanged:editor.dtChanged,expressionColumn:editor.expressionColumn,needsNewCol:(editor.columnInTable||!editor.expressionColumn)&&!(!editor.dtChanged||(editor.bottombox.datatypelist.selectedIndex===0)),tblId:editor.oi.tbl.did});editor.close();},failure:function failure(){objectInfo.isSave=false;}});}}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var me=this.parent.parent.parent;me.close();}}]}]}]});$EXPR_EDITOR=mstrmojo.architect.ExpressionEditor;$EXPR_EDITOR.showPopupMenu=function showPopupMenu(exprEditor,menuNode){var contextMenu=$EXPR_EDITOR.linkMenu;if(!contextMenu){contextMenu=$EXPR_EDITOR.linkMenu=new mstrmojo.architect.menu.ExpressionEditorMenu({zIndex:60});}contextMenu.target=exprEditor;contextMenu.domNode=menuNode;contextMenu.showContextMenu();};}());