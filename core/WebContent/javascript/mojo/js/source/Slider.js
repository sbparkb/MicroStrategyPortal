(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._ListSelections","mstrmojo.tooltip","mstrmojo.dom","mstrmojo.hash","mstrmojo.css");var $DOM=mstrmojo.dom,$CSS=mstrmojo.css,$HASH=mstrmojo.hash,$REGISTRY=mstrmojo.all,$PX="px";function dndOnMouseMove(e){if(this.dragging){return ;}this._moveCnt++;if(this._moveCnt>this.mousemoveBuffer){var docBody=document.body;$DOM.detachEvent(docBody,"mousemove",this._mousemoveCallback);$DOM.detachEvent(docBody,"mouseup",this._cancelCallback);this.initDrag(e);}}function dndDragCancel(e){var docBody=document.body;$DOM.detachEvent(docBody,"mousemove",this._mousemoveCallback);$DOM.detachEvent(docBody,"mouseup",this._cancelCallback);var fnAfterDrag=this.afterDragCancel;if(fnAfterDrag){fnAfterDrag.call(this.target,e);}}function dndOnMouseDown(e){$DOM.preventDefault(window,e);if(this.dragging){return true;}var targetId=this.target.id,docBody=document.body;if(!this._mousemoveCallback){this._mousemoveCallback=function(e){dndOnMouseMove.call($REGISTRY[targetId].dnd,e);return true;};}this._moveCnt=0;this.startE=$HASH.copy(e);$DOM.attachEvent(docBody,"mousemove",this._mousemoveCallback);if(!this._cancelCallback){this._cancelCallback=function(e){dndDragCancel.call($REGISTRY[targetId].dnd,e);return true;};}$DOM.attachEvent(docBody,"mouseup",this._cancelCallback);return false;}function dndOnDrag(e){var fnDrag=this.duringDrag;if(fnDrag){fnDrag.call(this.target,e);}return true;}function dndDragEnd(e){this.dragging=false;var docBody=document.body;$DOM.detachEvent(docBody,"mousemove",this._dragCallback);$DOM.detachEvent(docBody,"mouseup",this._dragEndCallback);var fnAfterDrag=this.afterDragEnd;if(fnAfterDrag){fnAfterDrag.call(this.target,e);}return true;}function clearListeners(){if(this._mousemoveCallback){$DOM.detachEvent(document.body,"mousemove",this._mousemoveCallback);delete this._mousemoveCallback;}if(this._cancelCallback){$DOM.detachEvent(document.body,"mouseup",this._cancelCallback);delete this._cancelCallback;}if(this._dragCallback){$DOM.detachEvent(document.body,"mousemove",this._dragCallback);delete this._dragCallback;}if(this._dragEndCallback){$DOM.detachEvent(document.body,"mouseup",this._dragEndCallback);delete this._dragEndCallback;}}mstrmojo.DnDComponent=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.DnDComponent",isDragging:false,initD:null,startE:null,afterDragStart:null,duringDrag:null,afterDragEnd:null,target:null,mousemoveBuffer:1,init:function init_DnDComp(props){$HASH.copy(props,this);},initDrag:function initDrag(e){this.dragging=true;var targetId=this.target.id,docBody=document.body;var dragCallback=this._dragCallback;if(!dragCallback){dragCallback=this._dragCallback=function(e){return dndOnDrag.call($REGISTRY[targetId].dnd,e);};}$DOM.attachEvent(docBody,"mousemove",dragCallback);var dragEndCallback=this._dragEndCallback;if(!dragEndCallback){dragEndCallback=this._dragEndCallback=function(e){return dndDragEnd.call($REGISTRY[targetId].dnd,e);};}$DOM.attachEvent(docBody,"mouseup",dragEndCallback);var fnAfterDragStart=this.afterDragStart;if(fnAfterDragStart){fnAfterDragStart.call(this.target,e);}this._dragCallback(e);}});function SingleSlider(sl){this.getUnit=function getUnit(){var itemLength=sl.items.length;return itemLength>1?sl._effLen/(itemLength-1):1;};this.calcMinMax=function(pxMin,pxMax){var p=Math.round((pxMin/sl.unit+pxMax/sl.unit)/2);return{min:p,max:p};};this.preUpdateThumb=function(){sl.start=Math.min(sl.min*sl.unit,sl._effLen)+$PX;sl.sdCssText=sl.orCfg.posCssP+":"+sl.start+";";};this.updateThumb=function(){sl.containerNode.style[sl.orCfg.posCssP]=sl.start=Math.min(Math.round(sl.min*sl.unit),sl._effLen)+$PX;};return this;}function MultiSlider(sl){this.getUnit=function(){return sl._effLen/sl.items.length;};this.calcMinMax=function(pxMin,pxMax){return{min:Math.floor(pxMin/sl.unit+0.5),max:Math.floor(pxMax/sl.unit-0.5)};};function updateThumbProps(){var min=sl.min,unit=sl.unit;var start=sl.start=(min*unit)+$PX;var length=sl.length=Math.max(Math.round((sl.max-min+1)*unit-sl.gap),0)+$PX;return{st:start,len:length};}this.preUpdateThumb=function(){var orCfg=sl.orCfg,up=updateThumbProps();sl.sdCssText=orCfg.posCssP+":"+up.st+";"+orCfg.lenCssP+":"+up.len+";";};this.updateThumb=function(){var orCfg=sl.orCfg,up=updateThumbProps(),containerNodeStyle=sl.containerNode.style;containerNodeStyle[orCfg.posCssP]=up.st;containerNodeStyle[orCfg.lenCssP]=up.len;};return this;}var tooltipMarkup="<span>{@content}</span>";mstrmojo.Slider=mstrmojo.declare(mstrmojo.Container,[mstrmojo._ListSelections],{scriptClass:"mstrmojo.Slider",markupString:'<div id="{@id}" class="mstrmojo-Slider {@cssClass} {@clsType} {@clsOrientation}" style="{@cssText}" ><div class="cont"><div class="bk" style="{@bkCssText}"></div><div class="sdc" style="position:absolute;{@sdcCssText}" mstrAttach:mouseout><div class="sd" style="{@sdCssText}"><div class="t1"></div><div class="t2"></div><div class="t3"></div></div></div></div></div>',sdCssText:"",cssClass:"sc",clsType:"sc2",clsOrientation:"sc-v",orCfg:null,typeHelper:null,_tooltip_pos:"TL",useRichTooltip:true,init:function init(p){this._super(p);if(p.isHoriz){this.orCfg={posCssP:"left",marginCssP:"marginLeft",lenCssP:"width",lenP:"clientWidth",opPosCssP:"top",thickP:"clientHeight",offsetP:"x"};this.clsOrientation=" sc-h";this._tooltip_pos=mstrmojo.tooltip.POS_BOTTOMLEFT;}else{this.orCfg={posCssP:"top",marginCssP:"marginTop",lenCssP:"height",lenP:"clientHeight",opPosCssP:"left",thickP:"clientWidth",offsetP:"y"};this._tooltip_pos=mstrmojo.tooltip.POS_TOPRIGHT;this.titleHeight=(p.docSelector.fmts.ttl&&p.docSelector.fmts.ttl.height)?parseInt(p.docSelector.fmts.ttl.height,10):0;}this._exRoom=this.thumbWidth;if(this.multiSelect){this._exRoom*=2;}if(p.multiSelect){this.typeHelper=new MultiSlider(this);}else{this.clsType="sc1";this.typeHelper=new SingleSlider(this);}},markupSlots:{dndNode:function(){return this.domNode.firstChild;},bgNode:function(){return this.domNode.firstChild.firstChild;},sdcNode:function(){return this.domNode.firstChild.lastChild;},containerNode:function(){return this.domNode.firstChild.lastChild.firstChild;},frontNode:function(){return this.domNode.firstChild.lastChild.firstChild.firstChild;},thumbNode:function(){return this.domNode.firstChild.lastChild.firstChild.childNodes[1];},endNode:function(){return this.domNode.firstChild.lastChild.firstChild.lastChild;},tooltipNode:function(){return this.domNode.firstChild.lastChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,onwidthChange:function(){this.synchronizeSlider();}},start:"50px",length:"30px",min:0,max:0,gap:1,ghost:null,thumbWidth:11,cssBkBW:1,dndNode:null,synchronizeSlider:function synchronizeSlider(){var orientationCfg=this.orCfg,dimension=orientationCfg.lenCssP,dimensionValue=this[dimension],dimensionLength=parseInt(dimensionValue,10),hasRendered=this.hasRendered,titleHeight=this.titleHeight||0;var effectiveLength=this._effLen=isNaN(dimensionLength)?0:(dimensionLength-this._exRoom-titleHeight);if(dimensionValue){var backgroundCss={};backgroundCss[dimension]=Math.max(parseInt(dimensionValue,10)-(2*this.cssBkBW),0)-titleHeight+$PX;var sdcCss={};sdcCss[dimension]=effectiveLength+$PX;sdcCss[orientationCfg.posCssP]=Math.round(this._exRoom/2)+$PX;sdcCss[orientationCfg.opPosCssP]="0"+$PX;if(hasRendered){$HASH.copy(backgroundCss,this.bgNode.style);$HASH.copy(sdcCss,this.sdcNode.style);}else{this.bkCssText=$CSS.getCssTextFromObj(backgroundCss);this.sdcCssText=$CSS.getCssTextFromObj(sdcCss);}}var idx=this.selectedIndices;if(!$HASH.isEmpty(idx)){this.min=this.items.length-1;this.max=0;var i;for(i in idx){if(idx[i]){this.min=Math.min(this.min,i);this.max=Math.max(this.max,i);}}}var helper=this.typeHelper;this.unit=helper.getUnit();if(hasRendered){helper.updateThumb();}else{helper.preUpdateThumb();}},preBuildRendering:function preBuildRendering(){this.synchronizeSlider();},postBuildRendering:function postBuildRendering(){this._super();if(this.items.length>1){var dnd=this.dnd=new mstrmojo.DnDComponent({target:this});var id=this.id;this.__mouseDownEvt=function(e){$DOM.stopPropogation(window,e);dndOnMouseDown.call($REGISTRY[id].dnd,e);return true;};$DOM.attachEvent(this.dndNode,"mousedown",this.__mouseDownEvt);dnd.afterDragStart=this.initDrag;dnd.duringDrag=this.ondrag;dnd.afterDragEnd=this.ondrop;dnd.afterDragCancel=this.cancelDrag;}},initDrag:function initDrag(e,hWin){hWin=hWin||window;var ghost=this.configureGhost(true),orientationCfg=this.orCfg,dndComponent=this.dnd,startEvt=dndComponent.startE;dndComponent.initD={tP:parseInt(this.start,10),sL:this._effLen,contL:ghost.containerNode[orientationCfg.lenP],offset:$DOM.getMousePosition(startEvt,hWin)[orientationCfg.offsetP],td:$DOM.eventTarget(hWin,startEvt)};},configureGhost:function configureGhost(showGhost){var ghost=this.ghost;if(!ghost){var ghostNode=this.containerNode.cloneNode(true),ghostNodeChildren=ghostNode.childNodes;$CSS.addClass(ghostNode,"gh");ghostNode.style.display="none";ghost=this.ghost={containerNode:ghostNode,frontNode:ghostNodeChildren[0],thumbNode:ghostNodeChildren[1],endNode:ghostNodeChildren[2]};this.sdcNode.appendChild(ghostNode);}var ghostStyle=this.ghost.containerNode.style,orientationConfig=this.orCfg;$HASH.copyProps([orientationConfig.posCssP,orientationConfig.lenCssP],this.containerNode.style,ghostStyle);if(showGhost){ghostStyle.display="block";}return ghost;},ondrag:function ondrag(e,hWin){hWin=hWin||window;var initD=this.dnd.initD,ghostContainerNode=this.ghost.containerNode,minPx,maxPx,lenPx,min=this.min,max=this.max,orientationCfg=this.orCfg,lengthProp=orientationCfg.lenCssP,positionProp=orientationCfg.posCssP;var diff=$DOM.getMousePosition(e,hWin)[orientationCfg.offsetP]-initD.offset;switch(initD.td){case this.thumbNode:minPx=Math.max(Math.min(initD.tP+diff,initD.sL-initD.contL),0);maxPx=minPx+initD.contL;ghostContainerNode.style[positionProp]=minPx+$PX;var minmax=this.typeHelper.calcMinMax(minPx,maxPx);min=minmax.min;max=minmax.max;break;case this.frontNode:minPx=Math.max(Math.min(initD.tP+diff,initD.tP+initD.contL),0);lenPx=Math.max(Math.min(initD.contL-diff,initD.tP+initD.contL),0);ghostContainerNode.style[positionProp]=minPx+$PX;ghostContainerNode.style[lengthProp]=lenPx+$PX;min=Math.min(Math.floor(minPx/this.unit+0.5),this.max);break;case this.endNode:lenPx=Math.max(Math.min(initD.contL+diff,initD.sL-initD.tP),0);maxPx=initD.tP+lenPx;ghostContainerNode.style[lengthProp]=lenPx+$PX;max=Math.max(Math.floor(maxPx/this.unit-0.5),this.min);break;default:return ;}if(min!==this.min||max!==this.max){this.min=min;this.max=max;this.typeHelper.updateThumb();}this._updateTooltip();},ondrop:function ondrop(){this.typeHelper.updateThumb();var ghost=this.ghost;if(ghost){ghost.containerNode.style.display="none";}this.hideTooltip();var initD=this.dnd&&this.dnd.initD;if(this.makeSelection&&initD){this.makeSelection({selItem:initD.td});}var items=this.items;if(items&&items.length){var selections=[],i;for(i=this.min;i<=this.max;i++){var selectedItem=items[i];if(selectedItem){selections.push(i);}}this.select(selections);}this.dnd.initD=null;},cancelDrag:function cancelDrag(e,hWin){if(this.makeSelection){this.makeSelection({selItem:$DOM.eventTarget(hWin||window,this.dnd.startE)});}},showTooltip:function showTooltip(e,win){this.configureGhost(false);this._updateTooltip(e,win);this._super(e,win);},hideTooltip:function hideTooltip(e,win){if(this.dnd&&this.dnd.dragging){return ;}this._super(e,win);},_updateTooltip:function _updateTooltip(){var orientationConfig=this.orCfg,tooltipInfo={contentNodeCssClass:"sc-tooltip",refNode:this.domNode,posType:this._tooltip_pos},ref=(this.ghost)?this.ghost.containerNode:this.containerNode;tooltipInfo[orientationConfig.opPosCssP]=0;tooltipInfo[orientationConfig.posCssP]=ref.style[orientationConfig.posCssP];tooltipInfo.content="";var items=this.items,itemCnt=items.length;if(items&&itemCnt){var minItem=(items[this.min]||items[0]),min=this.getItemTooltip(minItem),tooltipText=min;if(this.min!==this.max){var maxItem=(items[this.max]||items[itemCnt-1]);tooltipText=mstrmojo.desc(146,"From:")+" '"+min+"' "+mstrmojo.desc(147,"To:")+" '"+this.getItemTooltip(maxItem)+"'";}tooltipInfo.content=tooltipMarkup.replace(/\{@content\}/g,tooltipText);}this.set("richTooltip",tooltipInfo);},getItemTooltip:function getItemTooltip(item){var itemName=item?item.n:"";return"'"+(itemName.length>20?itemName.slice(0,20)+"...":itemName)+"'";},unrender:function unrender(ignoreDOM){this.ghost=null;this.hideTooltip();this.min=0;this.max=(this.items&&this.items.length-1)||0;var dndNode=this.dndNode,fnMouseDown=this.__mouseDownEvt;if(fnMouseDown&&dndNode){$DOM.detachEvent(dndNode,"mousedown",fnMouseDown);}clearListeners.call(this);this._super(ignoreDOM);},onselectionChange:function onselChg(){var sel=this.selectedIndices,isEmpty=$HASH.isEmpty(sel);if(sel){this.set("max",isEmpty?this.items.length-1:$HASH.max(sel,false,true));this.set("min",isEmpty?0:$HASH.min(sel,false,true));if(this.typeHelper){this.typeHelper.updateThumb();}}if(this.onchange){this.onchange();}}});mstrmojo.Slider.SINGLE_HANDLE_WIDTH=11;mstrmojo.Slider.SCROLLHANDLEWIDTH=11;}());