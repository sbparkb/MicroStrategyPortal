(function(){mstrmojo.requiresCls("mstrmojo.Widget");var $C=mstrmojo.css,$ARR=mstrmojo.array;function getSearchParams(taskId,extraParams){var params={searchMetadata:{taskId:"searchMetadata",styleName:this.searchStyleName,rootFolderID:this.rootID,searchPattern:this.searchPattern+"*",nameWildcards:(this.qse?16:1),quickSearch:this.qse,sortKey:(this.qse?-1:6),blockBegin:this.blockBegin||1,blockCount:this.blockCount,recursive:1,folderBrowserStyle:0,includeAncestorInfo:"true",includeObjectDesc:this.includeObjectDesc,searchXML:this.searchXML||"",dataSourcesXML:this.dataSources||"",objectType:this.objectTypes},browseFolder:{taskId:"searchMetadata",rootFolderID:this.rootID,blockBegin:this.blockBegin,blockCount:this.blockCount,recursive:this.hierarchical?0:(this.searchXML?"":1),folderBrowserStyle:this.hierarchical?1:0,includeAncestorInfo:String(!!this.hierarchical),searchXML:this.searchXML||"",dataSourcesXML:this.dataSources||"",objectType:this.objectTypes},browseElements:{taskId:"browseElements",styleName:"MojoAttributeStyle",attributeID:this.rootID,blockBegin:this.blockBegin,blockCount:this.blockCount,filterXML:this.filterXML||"",searchPattern:this.searchPattern||"",matchCase:!!this.matchCase,dataSourcesXML:this.dataSourcesXML||"",includeFormNames:!!this.collectForms,includeFormValues:!!this.bIncludeFormValues,displayedForms:this.displayedForms||1,dimensionID:this.dimensionId||""}}[taskId]||{};if(typeof extraParams==="object"){mstrmojo.hash.copy(extraParams,params);}return params;}var _spIndex="##searchPattern";mstrmojo.SearchBox2=mstrmojo.declare(mstrmojo.Widget,null,{scriptClass:"mstrmojo.SearchBox2",taskId:"searchMetadata",rootID:null,searchStyleName:"MojoFolderStyle",objectTypes:"3,14,256,257,1024,1027,2048,3072,10",token:{searchMetadata:/\//,browseElements:/(^-)|(,)|( OR )|( AND)|([<>]=?)|(&)|( )|(["\[\]\/])/},blockCount:50,blockBegin:1,minSearchLength:2,matchCase:false,enableMatchCase:true,supportIncFetch:true,quickSearch:false,searchAfterSearchPatternRestored:false,includeObjectDesc:true,forceResetCache:false,onUpdateSearchParams:mstrmojo.emptyFn,markupString:'<table id={@id} cellspacing=0 cellpadding=0 class="mstrmojo-SearchBox-Wrapper {@cssClass}" style="{@cssText};"><tr><td><div class="mstrmojo-SearchBox" mstrAttach:click ><input class="mstrmojo-SearchBox-input" type="text" mstrAttach:keyup,blur /></div></td><td><div class="mstrmojo-SearchBox-bg"><div class="mstrmojo-SearchBox-search" id="{@id}sbSearch" mstrAttach:click ></div></div></td><td><div class="mstrmojo-SearchBox-options" style="{@cssTextShowMC}"><input id="{@id}sbMatchCase" type="checkbox" mstrAttach:click /><label for="{@id}sbMatchCase">'+mstrmojo.desc(4326,"Case Sensitive")+"</label></div></td></tr></table>",markupSlots:{inputNode:function(){return this.domNode.rows[0].cells[0].firstChild.firstChild;},searchNode:function(){return this.domNode.rows[0].cells[1].firstChild.firstChild;},optionNode:function(){return this.domNode.rows[0].cells[2].firstChild.firstChild;}},preBuildRendering:function(){this.cssTextShowMC=this.enableMatchCase?"":"display: none";},postBuildRendering:function(){if(this._super){this._super();}this.matchCase=this.optionNode.checked;},onkeyup:function onkeyup(evt){var me=this;var tmr=me.searchTimer;if(tmr){window.clearTimeout(tmr);}me.searchTimer=window.setTimeout(function(){me.onkeyupDelayed(evt);delete me._searchTimer;},parseInt(evt.e.keyCode||evt.e.charCode,10)===13?0:me.searchDelay);},onkeyupDelayed:function onkeyupDelayed(evt){var hWin=evt.hWin,e=evt.e||hWin.event;var input=mstrmojo.string.trim(this.inputNode.value);if(this.searchNode){$C.toggleClass(this.searchNode,["clear"],input.length>0);}this.showTaskError=false;this.click2Search=false;if(input.length==0||this.autoSubmit||this.onEnter&&e.keyCode===13){this._onsearch();}},onEnter:function(){this._onsearch();},onclick:function(evt){var hWin=evt.hWin,e=evt.e||hWin.event,tgt=e.target||e.srcElement,id=tgt&&tgt.id;switch(id.replace(this.id,"")){case"sbDown":if(this.enableMatchCase){var s=this.optionNode.parentNode.style;s.display=s.display=="block"?"none":"block";}break;case"sbSearch":if(this.inputNode.value.length>0){this.clearSearch();}break;case"sbMatchCase":this.set("matchCase",this.optionNode.checked);break;case"sbSpinner":break;}},clearSearch:function(){this.inputNode.value="";$C.removeClass(this.searchNode,["clear"]);var c=this.searchCache,rid=this.rootID;if(c&&c[rid]){c[rid][_spIndex]="";}this._onsearch(true);},onmatchCaseChange:function(){this.matchCaseChanged=true;this._onsearch();},onrootIDChange:function(){this.rootChanged=true;this._setupCache(this.forceResetCache);var c=this.searchCache[this.rootID];if(c){var sp=c[_spIndex]||"";this.inputNode.value=sp;if(sp.length>0){if(sp.length>=this.minSearchLength&&this.searchAfterSearchPatternRestored){this._onsearch();}}}},getRootID:function(){},contentWidget:null,_notifyContentWidget:function(items){var cw=this.contentWidget||this;cw.set("items",items[0]);if(this.supportIncFetch){var ts=items[1],bb=items[2],bc=this.blockCount;cw.set("ifs",{np:Math.floor(ts/bc)+((ts%bc>0)?1:0),cp:Math.floor(bb/bc)+((bb%bc>0)?1:0)});}},_onsearch:function(toRoot){this.getRootID();this._setupCache();var input=mstrmojo.string.trim(this.inputNode.value);if(input.length===0){toRoot=true;}var token=this.token[this.taskId];if(token.test(input)){}if(this.searchPattern==input&&!this.rootChanged&&!this.matchCaseChanged&&!this.click2Search){return ;}var rid=this.rootID,cache=this.searchCache[rid];if((input.length<this.minSearchLength&&!this.click2Search)&&!toRoot){if(this.searchPattern&&this.searchPattern.length>=this.minSearchLength){this._notifyContentWidget(cache[rid]);this.searchPattern=input;}}else{this.searchPattern=input;cache[_spIndex]=this.searchPattern;var items=this.filterCache(input,cache,toRoot);if((this.click2Search||items===null)&&!toRoot){this.blockBegin=1;this.fetch();return ;}else{this._notifyContentWidget(items);}}cache[_spIndex]=input;},_setupCache:function(forceResetCache){var c=this.searchCache,rid=this.rootID;if(c&&(forceResetCache||!c[rid])){c[rid]=c[rid]||{};var itms=this.contentWidget&&this.contentWidget.items||this.rootCacheItems||[];c[rid][rid]=[itms,this.totalSize||0,this.blockBegin||1].concat();}},taskCallId:0,path:mstrConfig.taskURL,method:"POST",serverRequest:function serverRequest(params,callback){mstrmojo.xhr.request("POST",this.path,callback,params,undefined,this.XServer,this.baseParams);},fetch:function(){this.rootChanged=false;this.matchCaseChanged=false;if(this.spinnerNode){this.spinnerNode.style.display="block";}if(this.preFetch){this.preFetch();}var me=this,params=getSearchParams.apply(this,[this.taskId]);params.searchPattern=this.searchPattern;this.onUpdateSearchParams(params);var callback={success:function(res){var itms=res.items||res.es||[];itms=[itms,res.totalSize||res.sz||0,res.blockBegin||res.bb];mstrmojo.all[me.id].searchCache[me.rootID][(params.searchPattern.length==0?me.rootID:me.buildIndex(params.searchPattern))]=itms;me._notifyContentWidget(itms);},failure:function(res){if(me.showTaskError){mstrmojo.alert(mstrmojo.desc(8117,"Data request failed:")+" \n"+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},complete:function(){if(me.spinnerNode){me.spinnerNode.style.display="none";}if(me.postFetch){me.postFetch();}}};this.serverRequest(params,callback);},fetchPage:function(pn){this.blockBegin=pn*this.blockCount+1;this.fetch();},filterCache:function(input,cached,toRoot){var cacheItem=cached&&cached[toRoot?this.rootID:this.buildIndex(input)];if(cacheItem){return cacheItem;}var token=this.token[this.taskId];if(token.test(input)||this.totalSize>this.blockCount){return null;}var subtxt=input.replace(/.$/,"");cacheItem=cached&&cached[this.buildIndex(subtxt)];while(cacheItem===undefined&&(subtxt=subtxt.replace(/.$/,"")).length>0){cacheItem=cached&&cached[this.buildIndex(subtxt)];}if(cacheItem!==undefined){if(cacheItem[1]>this.blockCount){return null;}var itms=cacheItem[0],r=[];$ARR.forEach(itms,function(item){if(item.n.search(new RegExp(input,this.matchCase?"":"i"))>-1){r.push(item);}});this.totalSize=r.length;return(cached[this.buildIndex(input)]=[r,r.length,this.blockBegin].concat());}return null;},buildIndex:function(txt){if(txt.replace(/^\s|\s$/g,"").length===0){return"";}return !this.matchCase?txt.toUpperCase():txt+"::0";},init:function(props){if(this._super){this._super(props);}this.qse=mstrApp.useQuickSearch&&mstrApp.useQuickSearch()||0;this.autoSubmit=this.quickSearch&&(mstrApp.searchAutoComplete&&mstrApp.searchAutoComplete()||false);this.searchDelay=mstrApp.searchAutoCompleteDelay&&mstrApp.searchAutoCompleteDelay()||0;this.xhr=new mstrmojo.SimpleXHR();this.searchCache=this.searchCache||{};},clear:function(){this.inputNode.value="";$C.removeClass(this.searchNode,["clear"]);}});})();