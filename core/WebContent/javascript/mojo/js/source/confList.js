(function(){mstrmojo.requiresCls("mstrmojo.mobileConfigUtil","mstrmojo.MultiColumnListBox","mstrmojo.InlineEditor","mstrmojo.form","mstrmojo.MCListBoxCP");var util=mstrmojo.mobileConfigUtil,_D=mstrmojo.dom,_H=mstrmojo.hash,_S=mstrmojo.string,_TR=mstrmojo.validation.TRIGGER,_DTP=mstrmojo.expr.DTP;var androidUrlAuthenMode=[{n:mstrmojo.desc(7778),v:util.AUTHEN_ANONY},{n:mstrmojo.desc(7227),v:util.AUTHEN_BASIC},{n:mstrmojo.desc(7779),v:util.AUTHEN_WIN}],urlAuthenMode=_H.cloneArray(androidUrlAuthenMode),reqType=[{n:mstrmojo.desc(7785),v:util.REQ_HTTP},{n:mstrmojo.desc(7786),v:util.REQ_HTTPS}],deviceType=[{n:mstrmojo.desc(7725),v:util.DEVICE_IPHONE},{n:mstrmojo.desc(7726),v:util.DEVICE_IPAD},{n:mstrmojo.desc(8433),v:util.DEVICE_PHONE_UNIVERSAL},{n:mstrmojo.desc(8434),v:util.DEVICE_TABLET_UNIVERSAL}];urlAuthenMode.push({n:mstrmojo.desc(5595),v:util.AUTHEN_INTEGRATED});var confListTable=new mstrmojo.MultiColumnListBox({slot:"0,0",id:"confListTable",n:"Configuration List",renderAllItems:true,model:[],getActBtn:function getActBtn(title,onclickStr,cssClass){return'<a class = mstrLink><span class="actionIcons '+cssClass+'" title="'+title+'" onclick="'+onclickStr+'"></span></a>';},genActions:function genActions(){return this.getActBtn(mstrmojo.desc(767),"mstrmojo.all['"+this.id+"'].modifyItem(event)","actionIcons-modify")+this.getActBtn(mstrmojo.desc(3558),"mstrmojo.all['"+this.id+"'].duplicateItem(event)","actionIcons-duplicate")+this.getActBtn(mstrmojo.desc(7826),"mstrmojo.all['"+this.id+"'].urlGen(event)","actionIcons-url")+this.getActBtn(mstrmojo.desc(3559),"mstrmojo.all['"+this.id+"'].deleteItem(event)","actionIcons-delete");},getDeviceName:function(deviceType){switch(deviceType){case util.DEVICE_IPHONE:return mstrmojo.desc(7725);case util.DEVICE_IPAD:return mstrmojo.desc(7726);case util.DEVICE_PHONE_UNIVERSAL:return mstrmojo.desc(8433);case util.DEVICE_TABLET_UNIVERSAL:return mstrmojo.desc(8434);case util.DEVICE_BLACKBERRY:return mstrmojo.desc(7866);}},_set_model:function(n,v){this.model=v;var indexList=[];if(v){for(var i=0;i<this.model.length;i++){indexList.push([{v:this.model[i].n,icon:(this.model[i].uptc!=-1)?"actionIcons-update":""},{v:this.getDeviceName(this.model[i].dt)},{v:this.genActions()}]);}this.columns[0].editable=true;}else{indexList=[[{v:"<"+mstrmojo.desc(7835,"No Configuration")+">"},{v:""},{v:""}]];this.columns[0].editable=false;}delete this.cp.items;this.cp.set("items",indexList);this.refresh();this.set("editor",this.getEditor());return true;},left:"20px",top:"150px",width:"100%",height:"100%",autoColWidth:false,sortable:false,resizable:false,getItemRow:function(e){var tgt=_D.eventTarget(window,e);if(tgt){var tgtTD=_D.findAncestorByName(tgt,"td",false,this.domNode);if(tgtTD){return tgtTD.parentNode.rowIndex;}}},getEditor:function(){return new mstrmojo.InlineEditor({cssClass:"mobile-InlineEditor",onblur:function(evt){if(this.target&&this.editor.value&&_S.trim(this.editor.value)&&(_S.trim(this.editor.value)!=this.target[this.target.innerText?"innerText":"textContent"])){var t=this.target,itemIdx=t.parentNode.parentNode.parentNode.rowIndex,item=mstrmojo.all.confListTable.model[itemIdx];var v={};v=_H.clone(item);v.n=this.editor.value;var r=util.obj2Xml(v,"cnf",true,false);var that=this;mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(response){t[t.innerText?"innerText":"textContent"]=v.n;that.setTarget(null);that.set("visible",false);mstrmojo.all.confListTable.model[itemIdx].n=v.n;},failure:function(response){util.showErrorMsgBox(response.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{taskId:"updateMobileConfigurationProperties",taskEnv:"xhr",configurationID:v.cid,configurationPropertiesXML:r},null,null);}else{this.setTarget(null);this.set("visible",false);}}});},modifyItem:function(e){this.parent.toEdit(this.model[this.getItemRow(e)].dt,this.model[this.getItemRow(e)].cid);},urlGen:function(e){mstrmojo.all.confList.urlSetting.open(null,{rowIdx:this.getItemRow(e)});},applyDuplicate:function(id,name,count){var confNm="";if(count===0){confNm=mstrmojo.desc(3651).replace(/##/,name);}else{confNm=mstrmojo.desc(3652).replace(/###/,count).replace(/##/,name);}var that=this;mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(response){mstrmojo.all.confIndex.refreshData();},failure:function(response){that.applyDuplicate(id,name,++count);}},{taskId:"duplicateMobileConfiguration",taskEnv:"xhr",configurationID:id,configurationName:confNm},null,null);},duplicateItem:function(e){var rowId=this.getItemRow(e);this.applyDuplicate(this.model[rowId].cid,this.model[rowId].n,0);},deleteItem:function(e){mstrmojo.all.confList.disableCurtain.set("visible",true);var rowId=this.getItemRow(e),id=this.model[rowId].cid,msg="<span>"+mstrmojo.desc(7856)+', </span><span style="font-weight:bold">'+_S.htmlAngles(this.model[rowId].n)+"</span><span> ?</span>",del=mstrmojo.all.cnfrmDel;if(del){del.children.msg.set("text",msg);}else{mstrmojo.insert({scriptClass:"mstrmojo.Dialog",id:"cnfrmDel",title:mstrmojo.desc(3610),btnAlignment:"right",width:"475px",cssText:"border:1px solid #AAAAAA;",buttons:[{scriptClass:"mstrmojo.HTMLButton",cssText:"margin-bottom:2px",text:mstrmojo.desc(1442),preBuildRendering:function(){this.cssClass="mobileconfig-Button";},postBuildRendering:function(){this.domNode.focus();},onclick:function(evt){mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(response){},failure:function(response){util.showErrorMsgBox(response.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{taskId:"deleteMobileConfiguration",taskEnv:"xhr",configurationID:id},null,null);mstrmojo.all.confIndex.refreshData();mstrmojo.all.confList.disableCurtain.set("visible",false);mstrmojo.all.cnfrmDel.destroy();}},{scriptClass:"mstrmojo.HTMLButton",cssText:"margin-left:15px;margin-bottom:2px",text:mstrmojo.desc(221),preBuildRendering:function(){this.cssClass="mobileconfig-Button";},onclick:function(evt){mstrmojo.all.confList.disableCurtain.set("visible",false);mstrmojo.all.cnfrmDel.destroy();}}],children:[{scriptClass:"mstrmojo.Label",alias:"msg",text:msg,allowHTML:true}]}).render();}},cp:new mstrmojo.MCListBoxCP({columns:[{type:"icon_text",v:mstrmojo.desc(7765),sortable:false,editable:true,width:"400px"},{type:"text",v:mstrmojo.desc(2327),sortable:false,editable:false,width:"120px"},{type:"text",v:mstrmojo.desc(3265),sortable:false,editable:false,width:"150px"}],items:[[{v:""},{v:""},{v:""}]]})});mstrmojo.confList=mstrmojo.insert({id:"confListContainer",scriptClass:"mstrmojo.Container",markupString:"<div></div>",visible:true,markupSlots:{containerNode:function(){return this.domNode;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},children:[{scriptClass:"mstrmojo.Table",id:"confList",rows:5,cols:1,cssText:"margin:20px 20px 20px 20px",toEdit:function(dt,id){if(!dt){return ;}mstrmojo.form.send((id)?{evt:3004,target:"mobileConfig",configId:id,device:dt}:{evt:3004,target:"mobileConfig",device:dt});},children:[confListTable,{slot:"1,0",scriptClass:"mstrmojo.Button",enabled:true,text:mstrmojo.desc(7766),cssText:"text-decoration:underline;margin-left:10px;margin-top:8px;color:#0000FF; font-weight: bold;width:150px",onclick:function(evt){this.parent.dtEdtr.open();}},{slot:"2,0",scriptClass:"mstrmojo.Popup",alias:"dtEdtr",cssClass:"greyBorder",zIndex:20,cssText:"margin-left:65px;background-color:#F5F5F2",onOpen:function(){mstrmojo.all.confList.disableCurtain.set("visible",true);},onClose:function(){mstrmojo.all.confList.disableCurtain.set("visible",false);},children:[{scriptClass:"mstrmojo.Table",cssText:"margin: 5px 5px 5px 5px",layout:[{cells:[{},{colSpan:2,cssText:"width:100px"}]},{cells:[{},{},{}]}],children:[util.propertyName(mstrmojo.desc(2327),"0,0","margin-right: 10px"),{slot:"0,1",alias:"dt",scriptClass:"mstrmojo.SelectBox",showItemTooltip:true,cssText:"width:100%",size:1,items:deviceType,selectedItem:{v:util.DEVICE_IPHONE}},{slot:"1,1",scriptClass:"mstrmojo.Button",cssClass:"mobileconfig-Button",cssText:"margin-top:5px;margin-right:10px",text:mstrmojo.desc(1442),onclick:function(){var dvc=this.parent.dt.selectedItem.v;this.parent.parent.parent.toEdit(dvc);}},{slot:"1,2",scriptClass:"mstrmojo.Button",cssClass:"mobileconfig-Button",cssText:"margin-top:5px",text:mstrmojo.desc(221),onclick:function(){this.parent.parent.close();}}]}]},{slot:"3,0",scriptClass:"mstrmojo.Popup",cssClass:"greyBorder",zIndex:20,alias:"urlSetting",useShortURL:false,onOpen:function(){var urlEdt=this.children[0];urlEdt.hostnameVTB.validate();if(urlEdt.hostportVTB.enabled){urlEdt.hostportVTB.validate();}mstrmojo.all.confList.disableCurtain.set("visible",true);var dmNd=this.domNode;document.body.appendChild(dmNd);document.body.appendChild(mstrmojo.all.confList.disableCurtain.domNode);_D.center(dmNd);},onClose:function(){this.urlCurtain.set("visible",false);delete this.itmCpy;this.set("urlStr",undefined);delete this.urlStr;mstrmojo.all.confList.disableCurtain.set("visible",false);},updatePopupConfig:function(config){this.rowIdx=config.rowIdx;this.set("itmCpy",_H.clone(mstrmojo.all.confListTable.model[mstrmojo.all.confList.urlSetting.rowIdx]));},buildURLParams:function(paramMap){var paramArray=[];for(var n in paramMap){paramArray.push(n+"="+paramMap[n]);}return paramArray.join("&");},updateURL:function(btn){var lct=window.location,path=lct.pathname.slice(0,String(lct.pathname).lastIndexOf("/")),itm=this.itmCpy,prtcl=(itm.lnk.rt===util.REQ_HTTPS)?"https":"http",universal=(itm.dt==util.DEVICE_PHONE_UNIVERSAL||itm.dt==util.DEVICE_TABLET_UNIVERSAL),isBlackberry=itm.dt==util.DEVICE_BLACKBERRY,port=itm.lnk.ipo?":"+itm.lnk.po:"",host=itm.lnk.nm;var params={taskId:"getMobileConfiguration"};params.taskEnv=universal?"xhr":"xml";params.taskContentType=universal?"json":"xmlanf";params.configurationID=itm.cid;if(isBlackberry){params.taskEnv="blackberry_xml";}if(universal){params.blockTransform="flatten";}if(universal||isBlackberry){params.blockVersion="1";}var baseUrl=prtcl+"://"+host+port+path+"/"+mstrConfig.taskProcURL+"?"+this.buildURLParams(params);var url="";if(itm.dt==util.DEVICE_BLACKBERRY){url=baseUrl;}else{baseUrl=encodeURIComponent(baseUrl);url="mstr://?url="+baseUrl+"&authMode="+itm.lnk.am+((itm.cs)?("&csUrl="+encodeURIComponent(itm.cs)):"")+"&dt="+itm.dt;me=this;tcs=itm.tcs;for(var i=0,len=tcs&&tcs.length;i<len||0;i++){url+="&trust="+encodeURIComponent(tcs[i].url);}}var waitIcon=function(show){btn.set("textIconClass",show?"mstrmojo-WaitIcon":"");btn.set("enabled",!show);},me=this;if(this.useShortURL&&universal){waitIcon(true);url="http://tinyurl.com/api-create.php?url="+encodeURIComponent(url);mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(response){me.set("urlStr",response);waitIcon(false);},failure:function(response){me.set("urlStr",response.getResponseHeader("X-MSTR-TaskFailureMsg"));waitIcon(false);}},{taskId:"shortURL",taskEnv:"xhr",srcUrl:url});}else{this.set("urlStr",url);}},children:[{scriptClass:"mstrmojo.Table",cssText:"width:400px;height:140px;background-color:#F5F5F2",layout:[{cssClass:"mstrmojo-Editor-titlebar",cells:[{cssClass:"mstrmojo-Editor-titleCell"},{cssClass:"mstrmojo-Editor-titleCell",colSpan:2}]},{cells:[{colSpan:3}]},{cells:[{},{colSpan:2}]},{cells:[{},{colSpan:2}]},{cells:[{},{colSpan:2}]},{cells:[{},{colSpan:2}]},{cells:[{colSpan:3}]},{cells:[{},{},{}]},{cells:[{colSpan:3}]}],children:[{slot:"0,0",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-Editor-title",cssText:"font-weight: bold",text:mstrmojo.desc(7794)},{slot:"0,1",scriptClass:"mstrmojo.Button",title:mstrmojo.desc(2102),iconClass:"mstrmojo-Editor-close",cssText:" float: right",onclick:function(){this.parent.parent.close();}},util.propertyName(mstrmojo.desc(7949),"1,0","margin:15px 2px 2px 15px;"),{slot:"2,0",scriptClass:"mstrmojo.Label",cssText:"margin:5px 2px 2px 15px",text:mstrmojo.desc(36)+":"},{slot:"2,1",scriptClass:"mstrmojo.ValidationTextBox",cssText:"margin:5px 15px 2px 0px;width:200px",alias:"hostnameVTB",required:true,dtp:_DTP.CHAR,constraints:{trigger:_TR.ALL,validator:function(v){return util.generalValidator(v,this.dtp,function(v){if(v=="localhost"||v=="127.0.0.1"){return false;}},mstrmojo.desc(7852));}},bindings:{value:"this.parent.parent.itmCpy.lnk.nm || window.location.hostname"},onValid:function(){if(this.parent.parent.itmCpy){this.parent.parent.itmCpy.lnk.nm=this.value;this.set("isValid",true);}},onInvalid:function(){this.set("isValid",false);}},{slot:"3,0",scriptClass:"mstrmojo.CheckBox",alias:"showPrt",cssText:"margin:5px 0px 2px 11px",label:mstrmojo.desc(7950)+":",bindings:{checked:"this.parent.parent.itmCpy.lnk.ipo"},oncheckedChange:function(){if(this.checked==null){return ;}if(this.checked){this.parent.hostportVTB.validate();}else{this.parent.hostportVTB.clearValidation();this.parent.hostportVTB.set("isValid",true);}this.parent.parent.itmCpy.lnk.ipo=this.checked;}},{slot:"3,1",scriptClass:"mstrmojo.ValidationTextBox",cssText:"margin:5px 15px 2px 0px;width:200px",alias:"hostportVTB",required:true,dtp:_DTP.INTEGER,constraints:{trigger:_TR.ALL,validator:function(v){return util.generalValidator(v,this.dtp,util.validatePort,mstrmojo.desc(7839).replace(/###/,65535).replace(/##/,0));}},bindings:{enabled:"this.parent.showPrt.checked",value:function(){var port=this.parent.parent.itmCpy.lnk.po;return port==-1?(window.location.port||80):port;}},onValid:function(){if(this.parent.parent.itmCpy){this.parent.parent.itmCpy.lnk.po=this.value;}this.set("isValid",true);},onInvalid:function(){this.set("isValid",false);}},util.propertyName(mstrmojo.desc(7951)+":","4,0","margin:5px 2px 2px 15px"),{slot:"4,1",scriptClass:"mstrmojo.SelectBox",showItemTooltip:true,cssText:"margin:5px 15px 2px 0px;width:205px",itemIdField:"v",size:1,items:reqType,bindings:{selectedItem:"{v:this.parent.parent.itmCpy.lnk.rt}"},onchange:function(){if(this.parent.parent.itmCpy){this.parent.parent.itmCpy.lnk.rt=this.selectedItem.v;}}},util.propertyName(mstrmojo.desc(7952)+":","5,0","margin:5px 2px 2px 15px",{visible:"this.parent.parent.itmCpy.dt!=5"}),{slot:"5,1",scriptClass:"mstrmojo.SelectBox",showItemTooltip:true,cssText:"margin:5px 15px 2px 0px;width:205px",itemIdField:"v",size:1,bindings:{items:function(){if(this.parent.parent.itmCpy){if(this.parent.parent.itmCpy.dt===1||this.parent.parent.itmCpy.dt===2){return urlAuthenMode;}else{return androidUrlAuthenMode;}}},selectedItem:"{v:this.parent.parent.itmCpy.lnk.am}",visible:"this.parent.parent.itmCpy.dt!=5"},onchange:function(){if(this.parent.parent.itmCpy&&this.selectedItem){this.parent.parent.itmCpy.lnk.am=this.selectedItem.v;}}},{slot:"6,0",scriptClass:"mstrmojo.CheckBox",cssText:"margin:5px 15px 2px 11px",label:mstrmojo.desc(9047),oncheckedChange:function(){this.parent.parent.useShortURL=this.checked;},bindings:{checked:"this.parent.parent.useShortURL",visible:"this.parent.parent.itmCpy.dt==3||this.parent.parent.itmCpy.dt==4"}},{slot:"7,0",scriptClass:"mstrmojo.Button",cssClass:"mobileconfig-Button",cssText:"margin-right: 50px",alias:"urlBtn",text:mstrmojo.desc(7826),bindings:{enabled:"this.parent.hostnameVTB.isValid&&this.parent.hostportVTB.isValid"},markupMethods:_H.copy(mstrmojo.Button.prototype.markupMethods,{ontextIconClassChange:function(){this.textNode.className="mstrmojo-Button-text  "+this.textIconClass;}}),onclick:function(){this.parent.parent.updateURL(this);}},{slot:"7,1",scriptClass:"mstrmojo.Button",cssClass:"mobileconfig-Button",cssText:"margin-left: 15px;margin-right: 15px",text:mstrmojo.desc(118),bindings:{enabled:"this.parent.hostnameVTB.isValid&&this.parent.hostportVTB.isValid"},enableBtn:function(enable){this.set("enabled",enable);this.parent.cancelBtn.set("enabled",enable);this.parent.urlBtn.set("enabled",enable);},onclick:function(){this.parent.parent.urlCurtain.set("visible",true);this.enableBtn(false);var cpy=mstrmojo.all.confList.urlSetting.itmCpy;var lpath=window.location.pathname,host=cpy.lnk.nm,port=cpy.lnk.ipo?":"+cpy.lnk.po:"",path=lpath.slice(0,String(lpath).lastIndexOf("/")+1);cpy.lnk.bu=host+port+path+mstrConfig.taskProcURL;var r=util.obj2Xml(cpy,"cnf",false,false);var that=this;mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(response){mstrmojo.all.confListTable.model[mstrmojo.all.confList.urlSetting.rowIdx].lnk=cpy.lnk;mstrmojo.all.confList.urlSetting.close();that.enableBtn(true);},failure:function(response){util.showErrorMsgBox(response.getResponseHeader("X-MSTR-TaskFailureMsg"));that.enableBtn(true);}},{taskId:"updateMobileConfigurationProperties",taskEnv:"xhr",configurationID:cpy.cid,configurationPropertiesXML:r},null,null);}},{slot:"7,2",scriptClass:"mstrmojo.Button",alias:"cancelBtn",cssClass:"mobileconfig-Button",cssText:"margin-left: 15px;margin-right: 15px",text:mstrmojo.desc(221),onclick:function(){mstrmojo.all.confList.urlSetting.close();}},{slot:"8,0",scriptClass:"mstrmojo.Panel",cssText:"text-align:center",alias:"urlShow",bindings:{state:"(this.parent.parent.urlStr)?1:0"},children:[{scriptClass:"mstrmojo.TextArea",cssText:"width:350px;height:100px;margin-bottom:15px;cursor:default",cssClass:"greyBorder",readOnly:true,bindings:{value:"this.parent.parent.parent.urlStr"}},{scriptClass:"mstrmojo.Button",enabled:true,visible:_D.isAndroid,text:"Link",cssText:"margin-bottom:15px;text-decoration:underline;color:#0000FF;font-weight: bold",onclick:function(){window.location=this.parent.parent.parent.urlStr;}}]}]},{scriptClass:"mstrmojo.Label",alias:"urlCurtain",visible:false,cssClass:"confList-disableCurtain"}]},{slot:"4,0",scriptClass:"mstrmojo.Label",alias:"disableCurtain",visible:false,cssClass:"confList-disableCurtain"}]}]});})();