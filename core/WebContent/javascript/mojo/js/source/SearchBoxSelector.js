(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.string","mstrmojo.elementHelper","mstrmojo.SimpleObjectInputBox");var $ARR=mstrmojo.array,$DOM=mstrmojo.dom,$KEYS=mstrmojo.Enum_Keys,thousandsSeperator=mstrConfig.thousandsSep;if(thousandsSeperator===undefined){thousandsSeperator=",";}var ERR_SDK_E_INVALID=2147762227,ERR_SDK_E_PROMPT_NUMERICAL_VALUES=2147762262,ERR_SDK_E_PROMPT_DATE_TIME=2147762269,MAX_SUGGESTION_POPUP_HEIGHT=140,SELECT_ALL_ITEM=-100,NO_MATCH_MSG=-101;var markup;mstrmojo.SearchBoxSelectorList=mstrmojo.declare(mstrmojo.SuggestionList,null,{getItemMarkup:function(item,idx){if(!markup){markup=this._super(item,idx).replace(">{@"+this.itemField+"}<",">{@"+this.itemField+"}{@weight}<");}return markup;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx),weight=item.wt;props.weight=weight?"<em>("+mstrmojo.num.addSeparators(weight,thousandsSeperator)+" "+this.parent.opener.wtStr+")</em>":"";return props;},onclick:function(evt){var suggestionItems=this.parent.opener.suggestionItems,len=suggestionItems.length;this._super(evt);if(len<=1){return ;}var allIdx=$ARR.find(suggestionItems,"t",SELECT_ALL_ITEM),item=this.getItemFromTarget(evt.getTarget());if(item&&item.t&&item.t===SELECT_ALL_ITEM){$ARR.forEach(suggestionItems,function(suggestionItem,index){if(!this.selectedIndices[index]){this.doItemSelect(suggestionItem,{});}},this);}else{if(this.selectedIndices[allIdx]){this.doItemSelect(suggestionItems[allIdx],{});}}}});mstrmojo.SearchBoxSelector=mstrmojo.declare(mstrmojo.SimpleObjectInputBox,null,{scriptClass:"mstrmojo.SearchBoxSelector",cssClass:"mstrmojo-SearchBoxSelector",srcid:null,dataSourcesXML:null,maxItemWidth:"",wtStr:"likes",suggestionListClass:"mstrmojo.SearchBoxSelectorList",useRichTooltip:false,postCreate:function postCreate(){var suggestionPopup=this.suggestionPopup;suggestionPopup.cssClass="mstrmojo-SearchBoxSelector-suggest";suggestionPopup.nudge=function(){var popupNode=this.domNode;if(!popupNode){return ;}var height=Math.min(popupNode.offsetHeight,(mstrApp&&mstrApp.MAX_SUGGESTION_POPUP_HEIGHT)||MAX_SUGGESTION_POPUP_HEIGHT),width=popupNode.offsetWidth,windowDimensions=$DOM.windowDim(),left=parseInt(this.left,10),top=parseInt(this.top,10);if(top+height>=windowDimensions.h){top=Math.max(top-height,0);}if(left+width>=windowDimensions.w){left=Math.max(left-width,0);}var editorNodeStyle=popupNode.style;editorNodeStyle.top=top+"px";editorNodeStyle.left=left+"px";};},preBuildRendering:function preBuildRendering(){var width=this.parent.contentNode.offsetWidth||this.parent.width;this.set("maxItemWidth",parseInt(width,10));this._super();},postBuildRendering:function postBuildRendering(){var fmts=this.parent.defn.fmts;if(!fmts.height){this.domNode.style.height="auto";}return this._super();},filterCandidates:function filterCandidates(items,t,max){var filteredCandidates=items,suggestCnt=this.suggestCount;if(!this.noCache){max=max||suggestCnt;if(t==="*"){t="";}else{t=mstrmojo.string.regEscape(t);}var itemField=this.itemField,testExp=new RegExp(t,"i");filteredCandidates=$ARR.filter(items,function(item){return testExp.test(item[itemField]);},{max:max});}if(filteredCandidates.length){$ARR.forEach(this.items,function(item){var idx=$ARR.find(filteredCandidates,"v",item.v);if(idx>-1){filteredCandidates.splice(idx,1);}});}if(filteredCandidates.length>=suggestCnt){filteredCandidates=filteredCandidates.slice(0,suggestCnt);}return filteredCandidates;},getCandidatesThroughTaskCall:function getCandidatesThroughTaskCall(params,callbacks){var id=this.id,targetWas=this.getSuggestionTarget(),searchPattern=params.pattern||"",rawInput=searchPattern,parent=this.parent,attributeId=this.srcid;var t=searchPattern;searchPattern=t;if(t===""){return ;}if(attributeId){var taskParams={taskId:"browseElements",styleName:"MojoAttributeStyle",attributeID:attributeId,dataSourcesXML:this.dsrc||"",blockCount:this.REQUEST_THRESHOLD,searchPattern:searchPattern,rawInput:rawInput,browseFlags:1},instParams=null;var defn=parent.defn;if(defn.dsid){instParams={};instParams.datasetID=defn.dsid;instParams.messageID=parent.model.mid;instParams.ctlKey=parent.ckey;}if(defn.sfs){var searchForms="",separator="";$ARR.forEach(defn.sfs,function(form){searchForms+=separator+form.did;separator=";";});taskParams.searchForms=searchForms;if(parent.model.isnew){var clientFormPatterns="",_separator="",model=parent.model,attr=$ARR.filterOne(model.getDatasetUnits(["att"]),function(unit){return unit.did===attributeId;}),attrForms=attr.fs||[];$ARR.forEach(defn.sfs,function(searchForm){var fm=$ARR.filterOne(attrForms,function(form){return form.fid===searchForm.did;});clientFormPatterns+=_separator+searchForm.did+":"+(fm&&fm.bftp)||0;_separator=";";});taskParams.clientFormPatterns=clientFormPatterns;}}callbacks.success=function(res){var box=mstrmojo.all[id];if(res&&res.es){var target=box.getSuggestionTarget(),len=res.es.length;if(!res||!target||(targetWas!==target)){return ;}var newPattern=target.getSearchPattern(),items=res.es;if(attributeId){items=mstrmojo.elementHelper.buildElemsTerseID(items,attributeId,true);}var srcPattern=params.pattern;box._last_hit={items:items,pattern:srcPattern};if(newPattern&&newPattern.indexOf(srcPattern)>-1){box.updateSuggestion(box.filterCandidates(items,newPattern));}}else{box.updateSuggestion([]);}};callbacks.failure=function(res){var ec=parseInt(res.code,10)+4294967296;if(ec!==ERR_SDK_E_INVALID&&ec!==ERR_SDK_E_PROMPT_NUMERICAL_VALUES&&ec!==ERR_SDK_E_PROMPT_DATE_TIME){mstrmojo.alert(res.message);}};mstrmojo.elementHelper.browseElements(callbacks,taskParams,instParams);}},onsuggestionItemsChange:function onsuggestionItemsChange(){var suggestionItems=this.suggestionItems,popup=this.suggestionPopup,editorNode=popup.editorNode,hasScrollBar=suggestionItems&&(suggestionItems.length>8),height="",px="";if(hasScrollBar){height=(mstrApp&&mstrApp.MAX_SUGGESTION_POPUP_HEIGHT)||MAX_SUGGESTION_POPUP_HEIGHT;px="px";}if(editorNode){editorNode.style.maxHeight=height+px;}else{if(hasScrollBar){px+=";";popup.cssText=(popup.cssText||"")+"max-height:"+height+px;}}},getSuggestionPos:function getSuggestionPos(){var ret=this._super();if(ret){ret.lockIW=this;}return ret;},updateSuggestion:function updateSuggestion(items){var len=items&&items.length;this.autoSelect=true;this.set("disableClick",false);if(this.parent.defn.multi&&len&&len>1){items=$ARR.filter(items,function(item){return item.v!=="u;"&&item.t!==14;});items.unshift({n:mstrmojo.desc(13976,"(All search results)"),t:SELECT_ALL_ITEM});this.autoSelect=false;}if(!len){items=[{n:mstrmojo.desc(13779,"No elements match your search"),t:NO_MATCH_MSG,cls:"nomatch"}];this.autoSelect=false;this.set("disableClick",true);}this._super(items);},handleSuggestionItemSelect:function handleSuggestionItemSelect(it,obCfg){if($ARR.isArray(it)||it.t===SELECT_ALL_ITEM){it=$ARR.ensureArray(it);var items=$ARR.filter(it,function(item){return item.t!==SELECT_ALL_ITEM;});if(items.length<it.length){items=$ARR.filter(this.suggestionItems,function(item){return item.t!==SELECT_ALL_ITEM;});}this.onSuggestionItemSelect(items);}else{this._super(it,obCfg);}},prekeydown:function prekeydown(evt){this._super(evt);var e=evt.e,height=(mstrApp&&mstrApp.MAX_SUGGESTION_POPUP_HEIGHT)||MAX_SUGGESTION_POPUP_HEIGHT,maxItems=8,itemHeight=height/maxItems;var selected=this.getSelected();if(selected){var index=selected._renderIdx,minScroll=(index-maxItems+1)*itemHeight,maxScroll=(index-1)*itemHeight,currentScrollTop=this.suggestionPopup.domNode.scrollTop;switch(parseInt(e.keyCode||e.charCode,10)){case $KEYS.DOWN_ARROW:if(currentScrollTop<=minScroll){this.suggestionPopup.domNode.scrollTop=minScroll;}else{if(currentScrollTop>maxScroll){this.suggestionPopup.domNode.scrollTop=maxScroll;}}break;case $KEYS.UP_ARROW:if(currentScrollTop<=minScroll||currentScrollTop>maxScroll){this.suggestionPopup.domNode.scrollTop=maxScroll;}break;}}}});}());