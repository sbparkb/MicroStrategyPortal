(function(){mstrmojo.requiresCls("mstrmojo.color","mstrmojo.dom","mstrmojo.css","mstrmojo._HasOwnAvatar","mstrmojo.Container","mstrmojo.threshold.ThresholdModel");var $COLOR=mstrmojo.color,$DOM=mstrmojo.dom,$CSS=mstrmojo.css;function getRelativePosition(context){var colorSlider=this.parent,colorSliderWidth=colorSlider.width,left=Math.min(Math.max(context.last.x-$DOM.position(this.domNode).x,0),colorSliderWidth-1);return left/colorSliderWidth;}mstrmojo.threshold.MarkersNode=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasOwnAvatar],{scriptClass:"mstrmojo.threshold.MarkersNode",cssClass:"markers",markupString:'<div id="{@id}" class="{@cssClass}" style="{@cssText}"  mstrAttach:click,mousedown,mouseover,mouseout></div>',markupSlots:{containerNode:function containerNode(){return this.domNode;}},dropZone:true,draggable:true,avatarCssClass:"marker-drag-avatar",addMarker:function addMaker(x){this.parent.parent.switchToCustomScheme();var slider=this.parent,w=$DOM.position(this.containerNode).w,palette=slider.getPalette(),indexAddedAfter=slider.addMarkerToMap(x/w),totalColors=palette.length;if(totalColors===(indexAddedAfter+1)){indexAddedAfter--;}var nextColor=palette[indexAddedAfter+1],previousColor=indexAddedAfter===-1?nextColor:palette[indexAddedAfter];palette.splice(indexAddedAfter+1,0,$COLOR.findMidColorHex(previousColor,nextColor));slider.update();},remove:function deleteMarker(i){var comp=this.parent.getComp(),palette=this.parent.getPalette();comp.splice(i,1);palette.splice(i+1,1);},onclick:function onclick(event){if(this.parent.sliderMode===mstrmojo.threshold.ThresholdModel.SLIDER_MODE.COLOR_BASED&&event.getTarget()===this.domNode){var pos=$DOM.position(this.containerNode),x=event.e.clientX-pos.x;this.addMarker(x);}},premousedown:function premousedown(){this.parent.unselectAll();},createAvatar:function createAvatar(node,context){var i;for(i=0;i<this.children.length;i++){if(this.children[i].id===node.id){context.tgtNode=this.children[i];context.i=i;}}var avatar=node.cloneNode(true),splitter=document.createElement("div");$CSS.addClass(splitter,"bar");avatar.appendChild(splitter);return avatar;},positionAvatar:function positionAvatar(pos){var avatar=this.avatar,avs=avatar.style,restrictedToAxis=this.restrictedToAxis,domPos=$DOM.position(this.domNode),top=domPos.y;if(avatar){if(restrictedToAxis!=="y"){var xPos=pos.x;if(xPos<domPos.x){xPos=domPos.x;}if(xPos>domPos.x+domPos.w){xPos=domPos.x+domPos.w-1;}avs.left=xPos-2+"px";}if(restrictedToAxis!=="x"){avs.top=top+"px";}}},isDragValid:function isDragValid(context){return context.src.node!==this.domNode;},ondragstart:function ondragstart(context){this._super(context);var comp=this.parent.getComp();this.removeChildren(this.children[context.i]);comp.splice(context.i,1);},ondragmove:function ondragmove(context){this._super(context);this.parent.editableBubble.showBubble(getRelativePosition.call(this,context));},ondragend:function ondragend(context){var colorSlider=this.parent,index=colorSlider.addMarkerToMap(getRelativePosition.call(this,context));colorSlider.update();this.children[index].set("selected",true);this._super(context);},onmouseover:function onmouseover(evt){if(this.parent.sliderMode===mstrmojo.threshold.ThresholdModel.SLIDER_MODE.COLOR_BASED&&!this._cursorAvatar){var doc=document,domNode=this.domNode,cursorAvatar=this._cursorAvatar=doc.createElement("div"),mouseMoveHandler=this._mouseMoveHandler=function(e){var target=$DOM.eventTarget(self,e),mousePos=$DOM.getMousePosition(e,self),cursorStyle=cursorAvatar.style;cursorStyle.top=mousePos.y+12+"px";cursorStyle.left=mousePos.x+12+"px";cursorStyle.display=(target===domNode&&mstrApp.isInteractive())?"block":"none";};doc.body.appendChild(cursorAvatar);$CSS.addClass(cursorAvatar,"mstrmojo-SimpleThresholdEditor add-cursor");$DOM.attachEvent(domNode,"mousemove",mouseMoveHandler);}if(this._super){return this._super(evt);}},onmouseout:function onmouseout(evt){if(this.parent.sliderMode===mstrmojo.threshold.ThresholdModel.SLIDER_MODE.COLOR_BASED){$DOM.detachEvent(this.domNode,"mousemove",this._mouseMoveHandler);var cursorAvatar=this._cursorAvatar;cursorAvatar.parentNode.removeChild(cursorAvatar);delete this._cursorAvatar;delete this._mouseMoveHandler;}if(this._super){return this._super(evt);}}});}());