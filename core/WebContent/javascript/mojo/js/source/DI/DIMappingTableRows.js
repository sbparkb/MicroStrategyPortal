(function(){mstrmojo.requiresCls("mstrmojo.ui.SimpleTree","mstrmojo.warehouse._CanToggleAvatarClass","mstrmojo.architect.ui._HasTreeDropZone","mstrmojo.string","mstrmojo.dom","mstrmojo.warehouse.EnumObjectTypes","mstrmojo.DI.DIHelpers");mstrmojo.requiresDescs(11611,11805,13243);var $DOM=mstrmojo.dom,$STR=mstrmojo.string,$CSS=mstrmojo.css,$H=mstrmojo.hash,$A=mstrmojo.array,$ENUM_TYPES=mstrmojo.warehouse.EnumObjectTypes,constants=mstrmojo.DI.DIConstants,CSS_USER_SELECT_CLASS="selected",diHelper=mstrmojo.DI.DIHelpers,ITEM_TAG="li",IDX_ATTR="idx",ATTRIBUTE_TYPE=12,TABLE_VIEW_ATTR="tableViewItemAttr",TABLE_VIEW_METRIC="tableViewItemMetric",TABLE_VIEW_FORM="tableViewItemForm";function scrollIntoViewIfNeeded(el,containerNode){var elementY=mstrmojo.dom.position(el).y;var elementH=mstrmojo.dom.position(el).h;var containerPos=mstrmojo.dom.position(containerNode);if(elementY+elementH>=containerPos.y+containerPos.h){el.parentElement.scrollTop=el.parentElement.scrollTop+elementY-containerPos.y-containerPos.h+elementH;}else{if(elementY<containerPos.y){el.parentElement.scrollTop=el.parentElement.scrollTop-(containerPos.y-elementY);}}}mstrmojo.DI.DIMappingTableRows=mstrmojo.declare(mstrmojo.ui.SimpleTree,[mstrmojo._HasOwnAvatar,mstrmojo._HasPopup,mstrmojo.warehouse._CanToggleAvatarClass,mstrmojo.architect.ui._HasTreeDropZone],{scriptClass:"mstrmojo.DI.DIMappingTableRows",markupString:'<div id="{@id}" class="mstrmojo-SimpleTree mstrmojo-di-mappingRows {@cssClass}" mstrAttach:click,dblclick,contextmenu,scroll>{@itemsHTML}</div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;},scrollboxNode:function scrollboxNode(){return this.domNode;}},tableData:undefined,tp:undefined,useRichTooltip:true,convertEnabled:true,init:function init(props){this._super(props);this.userSelections={};},getItemMarkup:function getItemMarkup(){return'<div class="item {@cls}"><span class="di-item-ic"></span><span class="di-item-n {@ipa}">{@n}</span><div class="{@link}"></div>';},preBuildRendering:function preBuildRendering(){if(this._super){this._super();}if(diHelper.isIE()){var divs=document.getElementsByTagName("div");mstrmojo.array.forEach(divs,function(div){div.onselectstart=function(){return false;};});}},postBuildRendering:function postBuildRendering(){this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-V",refNode:this.domNode,posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:"",keepArrowXPos:true});if(!this._ontooltipover){var id=this.id;this._ontooltipover=function(evt){var me=mstrmojo.all[id];var target=evt.target||evt.srcElement;$DOM.stopPropogation(self,evt);var item=$DOM.findAncestorByAttr(target,IDX_ATTR,true,me.domNode);if(!!item){var node=item.node.firstChild.childNodes[1];var nodePos=mstrmojo.dom.position(node);if(nodePos.w<node.scrollWidth){var treeItem=me.getTreeItem(item.value);me.richTooltip.refNode=target;me.richTooltip.content=$STR.encodeHtmlString((treeItem.ipa?(mstrmojo.desc(13243,"Project Attribute")+": "):"")+treeItem.ttp+((treeItem.isMultiForm&&treeItem.fmn)?"@"+treeItem.fmn:""));me.showTooltip(evt,self);}}};this._ontooltipout=function(evt){var me=mstrmojo.all[id];me.hideTooltip(evt,self);};}return this._super();},getItemProps:function getItemProps(item,idx){return{sel:!!this.selectedIndices[idx],cls:(function(){var linked=item.isLinked;var geoLinked=false;if(linked){var linkedItems=mstrApp.getRootController().model.findMappingItem(item);var i;for(i=0;i<linkedItems.length;i++){if(linkedItems[i].georole){geoLinked=true;break;}}}var cls="tp"+item.tp;if((!item.isAttributeForm&&item.georole&&item.georole>0)||geoLinked){cls+=" geo";}else{if(item.timerole&&item.timerole>0){cls+=" time";}}return cls+(item.unused?" uc":"");}()),link:item.isLinked?"linked":"",n:$STR.encodeHtmlString(item.isAttributeForm?(item.alias+"@"+item.fmn):item.alias),idx:idx,ipa:item.ipa?"ipa":""};},getRowItem:function getRowItem(index){return this.getTreeItem(index);},getRowNode:function getRowNode(prop,value){var index=mstrmojo.array.find(this.items,prop,value);if(index>-1){return this.domNode.children[0].children[index];}},isItemAvailable:function isItemAvailable(itemId){return this.getItemWithPropName(this.items,"did",itemId).length>0;},handleEvent:function handleEvent(evt){var item=this.getItemWithPropName(this.items,"did",evt.did)[0];switch(evt.name){case"Remove":this.removeChild(item._renderIdx);return true;case"Rename":item.n=evt.value;this.updateChild(item._renderIdx,item);return true;}return false;},onclick:function onclick(evt){try{var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),item=$DOM.findAncestorByAttr(target,IDX_ATTR,true,this.domNode),el;if(item){item.tableId=evt.src.tableData.id;item.tableRow=this;item.tableRow.parent=this.parent;this.parent.parent.clickedNode=item;}if(!diHelper.isCtrlKey(evt.hWin,evt.e)&&!$DOM.shiftKey(evt.hWin,evt.e)){this.parent.parent.raiseEvent({name:"allTableSelectionClear"});}else{this.parent.parent.raiseEvent({name:"allTableSelectionClear",source:evt.src.tableData});}this._super(evt);this.raiseEvent({name:"tableSelectionClear",source:this});this.parent.parent.parent.linker.clearLinks();var selectedData=this.getUserSelectedData();if(selectedData&&selectedData.length>0){this.parent.parent.parent.parent.raiseEvent({name:"scrollPreviewToCurItem",tableId:this.tableData.id,columnIndex:selectedData[0].dataIdx,data:selectedData[0]});}if($DOM.shiftKey(evt.hWin,evt.e)){var startIdx=Math.min(parseInt(selectedData[0]._renderIdx,10),parseInt(selectedData[1]._renderIdx,10));var endIdx=Math.max(parseInt(selectedData[0]._renderIdx,10),parseInt(selectedData[1]._renderIdx,10));if(selectedData.length>2){target=evt.target||$DOM.eventTarget(evt.hWin,evt.e);item=$DOM.findAncestorByAttr(target,"idx",true,this.domNode);if(startIdx>item.value){endIdx=startIdx;startIdx=item.value;}else{startIdx=endIdx;endIdx=item.value;}}var i;for(i=startIdx;i<endIdx;i++){this.userSelections[i]=true;el=this.domNode.children[0].childNodes[i];$CSS.addClass(el,"selected");if(i!==startIdx&&i!==endIdx){selectedData.push(this.items[i]);}}}if(selectedData.length!==0){$A.forEach(selectedData,function(data){if(data.isLinked){this.raiseEvent({name:"selectLinkedItems",source:this,oid:data.oid,alias:data.alias});}},this);}}catch(ex){throw ex;}},ondblclick:function dblclick(evt){var target=evt.getTarget();if(target.nodeName!=="SPAN"){target=target.childNodes[1];}else{var className=mstrmojo.string.trim(target.nextSibling.className);if(className==="di-item-n"){target=target.nextSibling;}}var src={data:this.getUserSelectedData(),target:evt.src.parent,position:$DOM.position(target,true)};this.clearSelections($H.copy(this.userSelections));var selectItem=src.data[0];if(!selectItem||selectItem.isAttributeForm){return ;}mstrApp.getRootController().openRenameTextBox(constants.contextMenuType.ITEM_MENU,target,src);},treeHooks:{select:function select(el,item){var userSelections=this.userSelections,itemIndex=item._renderIdx,isUserSelected=userSelections[itemIndex]===true;if(isUserSelected){delete userSelections[itemIndex];}else{userSelections[itemIndex]=true;}$CSS.toggleClass(el,CSS_USER_SELECT_CLASS,!isUserSelected);delete this.selectedIndices[itemIndex];return true;}},createAvatar:function createAvatar(sourceNode){var div=document.createElement("div"),item=$DOM.findAncestorByAttr(sourceNode,IDX_ATTR,true,this.domNode);if(item&&item.node){var selections=this.userSelections;if(selections[item.value]){var treeNodes=this.domNode.getElementsByTagName(ITEM_TAG);$A.forEach(treeNodes,function(treeNode){if(selections[treeNode.getAttribute(IDX_ATTR)]===true){div.appendChild(treeNode.cloneNode(true));}},this);}else{div.appendChild(item.node.cloneNode(true));}div.appendChild(document.createElement("div"));}div.className=this.domNode.className;return div;},ondragenter:function ondragenter(context){if(this._super){this._super(context);}var srcWidget=context.src.widget;if(srcWidget&&srcWidget.updateAvatarHTML){srcWidget.updateAvatarHTML(context);}},isDragValid:function isDragValid(){return true;},ondragstart:function ondragstart(context){this._super(context);if(context.src.data&&context.src.data.length){this.selectItem("did",context.src.data[0].did);}},ondragmove:function ondragmove(context){if(this._super){this._super(context);}var srcWidget=context.src.widget;var tgtWidget=context.tgt.widget;var rowNode=context.tgt.node.parentElement;if(srcWidget&&tgtWidget&&srcWidget.tp===ATTRIBUTE_TYPE&&tgtWidget.tp===ATTRIBUTE_TYPE&&rowNode!==tgtWidget.domNode){this.parent.parent.parent.linker.clearLinks();this.parent.parent.parent.linker.drawLink(rowNode,tgtWidget.parent,context.src.node,srcWidget.parent);}else{this.parent.parent.parent.linker.clearLinks();}},updateAvatarHTML:function updateAvatarHTML(context){var hint="";if(!this.convertEnabled){return ;}if(context.action===TABLE_VIEW_METRIC&&this.tp===$ENUM_TYPES.METRIC){hint=mstrmojo.desc(11611,"Convert to Attribute");}else{if(context.action===TABLE_VIEW_ATTR){if(this.tp===$ENUM_TYPES.ATTRIBUTE){hint=mstrmojo.desc(11805,"Convert to Metric");}}}this.avatar.lastChild.innerHTML=hint;},getAvatarIconClass:function getAvatarIconClass(context){var data=context.src&&context.src.data;data=data&&data[0];return data.tableId===this.tableData.id?"enabled":"";},toggleAvatarClass:function toggleAvatarClass(cls,isAdd){$CSS.toggleClass(this.avatar,cls,isAdd);},getDragAction:function getDragAction(context){var item=$DOM.findAncestorByAttr(context.src.node,IDX_ATTR,true,this.domNode);if(item){switch(this.getRowItem(item.value).tp){case $ENUM_TYPES.ATTRIBUTE:return TABLE_VIEW_ATTR;case $ENUM_TYPES.METRIC:return TABLE_VIEW_METRIC;case $ENUM_TYPES.FORM:return TABLE_VIEW_FORM;}}},getDragData:function getDragData(context){var sourceIndex=this.getNodeAttributes(context.src.node).index,itemInfo=this.getTreeItem(sourceIndex),userSelections=this.userSelections;if(itemInfo&&itemInfo.tp!==21){$H.copy(itemInfo,{columnId:itemInfo.did,tableName:this.tableData.n,tableId:this.tableData.id});if(userSelections[sourceIndex]===true){return this.getUserSelectedData();}this.clearSelections($H.copy(userSelections));return[itemInfo];}return itemInfo;},getUserSelectedData:function getUserSelectedData(){var userSelectedData=[],itemInfo;$H.forEach(this.userSelections,function(flag,index){itemInfo=this.getTreeItem(index);userSelectedData.push($H.copy(itemInfo,{columnId:itemInfo.did,tableName:this.tableData.n,tableId:this.tableData.id}));},this);return userSelectedData;},getNodeAttributes:function getNodeAttributes(node){var item=$DOM.findAncestorByAttr(node,IDX_ATTR,true,this.domNode),level=item&&item.node.getAttribute("level");return{index:item&&item.value,level:parseInt(level,10)};},clearSelections:function clearSelections(indices){var treeNodes=this.domNode.getElementsByTagName(ITEM_TAG),index;$A.forEach(treeNodes,function unSelect(treeNode){index=treeNode.getAttribute(IDX_ATTR);if(indices[index]===true){$CSS.toggleClass(treeNode,CSS_USER_SELECT_CLASS,false);delete this.userSelections[index];}},this);},selectItem:function selectItem(n,v){var items=this.items;var index=mstrmojo.array.find(items,n,v);var el;if(index!==-1){el=this.domNode.children[0].childNodes[index];if(!this.userSelections[index]){this.userSelections[index]=true;$CSS.addClass(el,"selected");}scrollIntoViewIfNeeded(el,this.domNode);}return el;},onscroll:function onscroll(){var selectedData=this.getUserSelectedData();if(selectedData.length!==0&&selectedData[0].isLinked){this.raiseEvent({name:"drawLinks",source:this,oid:selectedData[0].oid});}},draggable:true,dropZone:true,allowDrop:function allowDrop(context){var data=context.src&&context.src.data;var len=data&&data.length;data=data&&data[0];if(data&&data.tableId===this.tableData.id){return this.convertEnabled&&data.tp!==this.tp&&$A.indexOf([TABLE_VIEW_ATTR,TABLE_VIEW_METRIC],context.action)!==-1;}return context.action===TABLE_VIEW_ATTR&&data.tp===this.tp&&len===1;},ondrop:function ondrop(context){var rootController=mstrApp.getRootController(),contextSrc=context.src;if(contextSrc&&contextSrc.data){var dragData=contextSrc.data,item=$DOM.findAncestorByAttr(context.tgt.node,IDX_ATTR,true,this.domNode),itemInfo;if(this.tableData.id===dragData[0].tableId){if(context.action===TABLE_VIEW_ATTR&&this.tp===$ENUM_TYPES.METRIC){rootController.toMetric(dragData);}if(context.action===TABLE_VIEW_METRIC&&this.tp===$ENUM_TYPES.ATTRIBUTE){rootController.toAttribute(dragData);}}else{if(item&&dragData.length===1&&this.tp===dragData[0].tp){this.domNode.scrollTop=50;itemInfo=this.getTreeItem(item.value);var targetItem=context.tgt;targetItem.data=[itemInfo];this.raiseEvent({name:"tableSelectionClear"});this.selectItem("did",itemInfo.did);rootController.linkAttributes(targetItem,contextSrc);this.parent.parent.parent.linker.clearLinks();}}}if(this._super){this._super(context);}},oncontextmenu:function oncontextmenu(evt){var src=evt.src;var target=evt.getTarget()||$DOM.eventTarget(evt.hWin,evt.e);var item=$DOM.findAncestorByAttr(target,"idx",true,this.domNode),idx=item&&item.value;if(!src.userSelections[idx]&&!diHelper.isCtrlKey(evt.hWin,evt.e)){this.raiseEvent({name:"tableSelectionClear"});this.onclick(evt);}}});}());