(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.Editor","mstrmojo.Box","mstrmojo.Label","mstrmojo.CheckBox","mstrmojo.ui.Checkbox","mstrmojo.HTMLButton","mstrmojo.DI.DIConstants");mstrmojo.requiresDescs(221,308,5369,12829,12830,12831,12862,12863,12864,12865,12866,12867,12868,12869,12870,12871,12872,12873,13643,13644,13645);var formsOptions=mstrmojo.DI.DIConstants.formsOptions,$ARR=mstrmojo.array,constants=mstrmojo.DI.DIConstants;mstrmojo.DI.MultiFormItem=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.DI.MultiFormItem",editor:null,formMap:null,visible:true,linkedColumnId:null,closeButtonVisible:true,children:[{scriptClass:"mstrmojo.HBox",children:[{scriptClass:"mstrmojo.Label",bindings:{text:function(){return this.parent.parent.formMap.alias||this.parent.parent.formMap.name;},title:function(){return this.parent.parent.formMap.alias||this.parent.parent.formMap.name;}}},{scriptClass:"mstrmojo.Pulldown",alias:"formPullDown",popupToBody:true,itemField:"fmn",itemIdField:"fmid",bindings:{popupZIndex:"this.parent.parent.editor.zIndex",linkedColumnId:"this.parent.parent.linkedColumnId"},preBuildRendering:function preBuildRendering(){var multiFormItem=this.parent.parent,editor=multiFormItem.editor,formMap=multiFormItem.formMap,forms=formMap.forms,formId=formMap.formId,idx;if((editor.attribute.isLinked)&&(formId===editor.idFormId)&&editor.isMultiLinked&&(editor.formsOption===formsOptions.CREATE_MULTIFORM_ATTRIBUTE)){this.set("items",forms);idx=$ARR.find(forms,this.itemIdField,formId);this.set("defaultSelection",idx);}else{if((editor.attribute.isLinked)&&(formId===editor.idFormId)&&(!editor.isMultiLinked)){this.enabled=false;this.set("items",[{fmid:0,fmn:editor.idFormName}]);this.set("defaultSelection",0);}else{this.set("items",forms);idx=$ARR.find(forms,this.itemIdField,formId);this.set("defaultSelection",idx);}}},onvalueChange:function(){var list=this,selectedIndex=list.selectedIndex,multiFormItem=this.parent.parent;multiFormItem.editor.onFormChanged(multiFormItem.formMap,list.items[selectedIndex].fmid,this.parent);}},{scriptClass:"mstrmojo.ui.Checkbox",alias:"displayFormCheckbox",checked:false,label:"",oncheckedChange:function(){var multiFormItem=this.parent.parent;multiFormItem.formMap.displayForm=this.checked?"1":"0";var editor=multiFormItem.editor;$ARR.forEach(editor.tableIds,function(tableId){var tableConfig=editor.tables[tableId];$ARR.forEach(tableConfig.formMaps,function(map){if(map.formId===multiFormItem.formMap.formId){map.displayForm=multiFormItem.formMap.displayForm;}});});},preBuildRendering:function preBuildRendering(){var multiFormEditor=this.parent.parent;this.set("checked",multiFormEditor.formMap.displayForm==="1");}},{scriptClass:"mstrmojo.Button",iconClass:"mstrmojo-Editor-close",alias:"removeButton",onclick:function(){var multiFormItem=this.parent.parent;multiFormItem.editor.onRemoveMap(multiFormItem.formMap);},preBuildRendering:function preBuildRendering(){this.visible=this.parent.parent.closeButtonVisible;}}]}]});mstrmojo.DI.DIMultiFormEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.DIMultiFormEditor",tables:null,tableIds:null,attribute:null,attributes:null,cssClass:"mstrmojo-di-multiformeditor",formMaps:null,formsOption:null,idFormId:"",idFormName:"",idMap:null,isShared:null,isMultiLinked:null,tableId:null,noButtonCls:true,linkedColumnId:"",help:"Create_Multiform_Attribute_dialog_box.htm",buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(5369,"Submit"),alias:"submit",useRichTooltip:true,updateTooltipConfig:function(){var refNode=this.domNode;var tooltip={cssClass:"vi-regular vi-tooltip-V",posType:mstrmojo.tooltip.POS_TOPLEFT,refNode:refNode,top:-32};tooltip.content=this.title;this.set("richTooltip",tooltip);},onclick:function(){var editor=this.parent.parent;editor.updateMapping();editor.close();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var editor=this.parent.parent;editor.close();editor.destroy();}}],children:[{scriptClass:"mstrmojo.VBox",alias:"boxContainer",cssClass:"mstrmojo-di-multiformeditor-boxContainer",children:[{scriptClass:"mstrmojo.VBox",alias:"tableAndAttributeNameContainer",children:[{scriptClass:"mstrmojo.HBox",alias:"attributeNameContainer",cssClass:"mstrmojo-di-multiformeditor-attributeNameContainer",children:[{scriptClass:"mstrmojo.Label",cssClass:"new-attribute-Label",text:mstrmojo.desc(12862,"New Attribute Name:")},{scriptClass:"mstrmojo.TextBox",alias:"attributeName",cssClass:"mstrmojo-di-multiformeditor-attributeName",onvalueChange:function(){var multiFormEditor=this.parent.parent.parent.parent;multiFormEditor.attribute.alias=this.value;}}]},{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"mstrmojo-di-multiformeditor-tablePulldown",alias:"tablesPullDown",popupToBody:true,itemField:"n",itemIdField:"id",visible:false,bindings:{popupZIndex:"this.parent.parent.parent.editor.zIndex"},preBuildRendering:function(){if(mstrmojo.ui.Pulldown.prototype.preBuildRendering){mstrmojo.ui.Pulldown.prototype.preBuildRendering.call(this);}var list=this.getPopupList();list.set("useRichTooltip",true);list.set("tooltipOpenDelay",0);},postselectedIndexChange:function(evt){var editor=this.parent.parent.parent;var newValue=evt.value,oldValue=evt.valueWas,tableId;if(newValue!==oldValue){tableId=editor.tableIds[newValue];editor.setEditorConfig(tableId);}}}]},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-di-multiformeditor-formMapsListHeader",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-multiformeditor-formMapsListHeader-formName",text:""},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-multiformeditor-formMapsListHeader-formCategory",text:mstrmojo.desc(12864,"Form Category")},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-multiformeditor-formMapsListHeader-displayForm",text:mstrmojo.desc(12865,"Display Form")}]},{scriptClass:"mstrmojo.WidgetList",alias:"formMapsList",cssClass:"mstrmojo-di-multiformeditor-formMapsList",visible:true,itemFunction:function ifn(item,idx,w){var formId=item.formId;var sharedVisible=!((w.parent.parent.isShared)&&(formId===w.parent.parent.idFormId));var itemLengthVisible=(w.items.length===1)?false:true;var itemW=new mstrmojo.DI.MultiFormItem({editor:w.parent.parent,formMap:item,linkedColumnId:w.parent.parent.linkedColumnId,parent:w,closeButtonVisible:sharedVisible&&itemLengthVisible});return itemW;},bindings:{items:function(){return this.parent.parent.formMaps;},linkedColumnId:function(){return this.parent.parent.linkedColumnId;}}}]}],getDescription:function getDescription(option){switch(option){case formsOptions.ADDTO_MULTIFORM_ATTRIBUTE:return mstrmojo.desc(12866,"Include in the Multi-forms Attribute the following attribute forms:");case formsOptions.CREATE_MULTIFORM_ATTRIBUTE:return mstrmojo.desc(12866,"Include in the Multi-forms Attribute the following attribute forms:");case formsOptions.EDIT_MULTIFORM_ATTRIBUTE:return mstrmojo.desc(12867,"Edit Multi-forms Attribute with the following attribute forms:");}return"";},getTitle:function getTitle(option){switch(option){case formsOptions.ADDTO_MULTIFORM_ATTRIBUTE:return mstrmojo.desc(12868,"Add to Multi-forms Attribute");case formsOptions.CREATE_MULTIFORM_ATTRIBUTE:return mstrmojo.desc(12869,"Create Multi-forms Attribute");case formsOptions.EDIT_MULTIFORM_ATTRIBUTE:return mstrmojo.desc(12870,"Edit Multi-forms Attribute");}return"";},setEditorConfig:function setEditorConfig(tableId){this.set("tableId",tableId);var tables=this.tables;var config=tables[tableId];if(config.isShared){var linkedColumnId=mstrApp.getRootController().formsController.getLinkedColumnId(config.attribute,config.attributes,config.idFormId);if(linkedColumnId){this.set("linkedColumnId",linkedColumnId);}}this.set("idMap",config.idMap);this.set("idFormId",config.idFormId);this.set("idFormName",config.idFormName);this.set("formsOption",config.formsOption);this.set("attribute",config.attribute);this.set("attributes",config.attributes);this.set("isShared",config.isShared);this.set("formMaps",config.formMaps);this.set("isMultiLinked",config.isMultiLinked);},onOpen:function onOpen(){this.setEditorConfig(this.tableIds[0]);this.validateForms();this.set("title",this.getTitle(this.formsOption));var tableAndAttributeNameContainer=this.boxContainer.tableAndAttributeNameContainer;var tableNamesPulldown=tableAndAttributeNameContainer.tablesPullDown;var attributeName="";if(this.formsOption===formsOptions.CREATE_MULTIFORM_ATTRIBUTE&&this.idMap){attributeName=this.idMap.alias||this.idMap.name;}else{attributeName=this.attribute.alias||this.attribute.name;}tableAndAttributeNameContainer.attributeNameContainer.attributeName.set("value",attributeName);var tableIds=this.tableIds,tables=this.tables;tableNamesPulldown.set("visible",false);if(this.formsOption===formsOptions.EDIT_MULTIFORM_ATTRIBUTE||this.formsOption===formsOptions.CREATE_MULTIFORM_ATTRIBUTE){if(this.tableIds.length>1){var items=[],item,tableName="";$ARR.forEach(tableIds,function(tableId){tableName=tables[tableId].tableName;item={};item[tableNamesPulldown.itemIdField]=tableId;item[tableNamesPulldown.itemField]=tableName;items.push(item);});tableNamesPulldown.set("items",items);var idx=$ARR.find(items,tableNamesPulldown.itemIdField,this.attribute.tableId);tableNamesPulldown.set("selectedIndex",idx);tableNamesPulldown.set("visible",true);}}},preBuildRendering:function preBuildRendering(){this._super();this.setEditorConfig(this.tableIds[0]);},onFormChanged:function onFormChanged(formMap,formId,item){formMap.formId=formId;var tableConfig,formMaps,editor=this;if(editor.isMultiLinked){$ARR.forEach(editor.tableIds,function(tableId){tableConfig=editor.tables[tableId];formMaps=tableConfig.formMaps;$ARR.forEach(formMaps,function(map){if(map.name===formMap.name){map.formId=formId;}if(map.formId===editor.idFormId){tableConfig.idMap=map;}});});}var sharedVisible=!((this.isShared)&&(formId===this.idFormId));var itemLengthVisible=(this.formMaps.length===1)?false:true;var closeButtonVisible=sharedVisible&&itemLengthVisible;item.removeButton.set("visible",closeButtonVisible);this.validateForms();if(formId===this.idFormId){this.idMap=formMap;tableConfig=editor.tables[editor.tableId];tableConfig.idMap=formMap;}},onRemoveMap:function onRemoveMap(formMap){formMap.remove="-1";this.boxContainer.formMapsList._remove(formMap);var tableDate=this.tables[this.tableId];var items=tableDate.formMaps;if(tableDate.formsOption===formsOptions.CREATE_MULTIFORM_ATTRIBUTE){$ARR.removeItem(items,formMap);}var v=this.validateForms();if(formMap.formId===this.idFormId){if(v[0].idMaps.length>0){this.idMap=v[0].idMaps[0];tableDate.idMap=this.idMap;}else{this.idMap=null;tableDate.idMap=null;}}},updateMapping:function updateMapping(){var attrNameValid=this.validateAttributeName();var tableConfig=null;if(attrNameValid){var controller=mstrApp.getRootController();var editor=this;var cnt=0;var callback={success:function(){cnt++;if(cnt>=editor.tableIds.length){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;controller.getImportedDataEMMA(constants.actions.none,flags);editor.destroy();}else{tableConfig=editor.tables[editor.tableIds[cnt]];controller.formsController.updateMapping(tableConfig.formsOption,tableConfig.tableId,tableConfig.attribute,tableConfig.attributes,tableConfig.isShared,tableConfig.formMaps,tableConfig.idMap,callback);}}};if(editor.tableIds&&editor.tableIds.length){tableConfig=editor.tables[editor.tableIds[0]];controller.formsController.updateMapping(tableConfig.formsOption,tableConfig.tableId,tableConfig.attribute,tableConfig.attributes,tableConfig.isShared,tableConfig.formMaps,tableConfig.idMap,callback);}}},setSubmitBtn:function setSubmitBtn(validateResults){var submitButton=this.btnHbox.submit;var i,item,validate=true,noneIdFormTableNames=[],emptyFormTableNames=[],duplicateFormTableNames=[],errorMsg="";for(i=0;i<validateResults.length;i++){item=validateResults[i];validate=validate&&item.valid;}submitButton.set("enabled",validate);if(validate){submitButton.title="";return ;}for(i=0;i<validateResults.length;i++){item=validateResults[i];if(item.idMaps.length===0){noneIdFormTableNames.push(item.tableName);}if(item.haveEmptyForm){emptyFormTableNames.push(item.tableName);}if(item.duplicateMaps.length>0){duplicateFormTableNames.push(item.tableName);}}if(noneIdFormTableNames.length>0){errorMsg=mstrmojo.desc(13643,"A column must be assigned to the ID form category within each table containing a multi-form attribute. Table ### violates this condition.");errorMsg=this.concatErrorMsg(noneIdFormTableNames,errorMsg);}else{if(duplicateFormTableNames.length>0){errorMsg=mstrmojo.desc(13644,"The same Form Category cannot be used more than once within each table containing a multi-form attribute. Table ### violates this condition.");errorMsg=this.concatErrorMsg(duplicateFormTableNames,errorMsg);}else{errorMsg=mstrmojo.desc(13645,"A column cannot have an empty Form Category  within any table containing a multi-form attribute. Table ### violates this condition.");errorMsg=this.concatErrorMsg(emptyFormTableNames,errorMsg);}}submitButton.title=errorMsg;},concatErrorMsg:function concatErrorMsg(tableNames,errorMsg){var i,concateTableNames,length=tableNames.length;if(length===1){concateTableNames=tableNames[0];}else{if(length===2){concateTableNames=tableNames[0]+" "+mstrmojo.desc(308,"and")+" "+tableNames[1];}else{for(i=0;i<length-2;i++){concateTableNames+=tableNames[i];concateTableNames+=", ";}concateTableNames+=tableNames[length-2];concateTableNames+=" ";concateTableNames+=mstrmojo.desc(308,"and");concateTableNames+=" ";concateTableNames+=tableNames[length-1];}}errorMsg=errorMsg.replace("###",concateTableNames);return errorMsg;},validateAttributeName:function validateAttributeName(){var text=this.attribute.alias;var controller=mstrApp.getRootController(),model=controller.model;if(!text||text.length<=0){controller.displayError(mstrmojo.desc(12829,"Cannot rename column with empty string."));model.raiseEvent({name:"MappingsFetched"});return false;}if(text.length>=250){controller.displayError(mstrmojo.desc(12830,"Cannot rename column with a too long string."));model.raiseEvent({name:"MappingsFetched"});return false;}if(constants.invalidObjectNameCharsRegex.test(text)){controller.displayError(mstrmojo.desc(12831,"Cannot rename column with string contains the following characters: ####").replace("####",constants.invalidObjectNameChars));model.raiseEvent({name:"MappingsFetched"});return false;}var allMaps=model.getAllMappings();var j,k,map,found,msg;for(j=0;j<allMaps.length;j++){map=allMaps[j];var continueFlag=false;for(k=0;k<this.attributes.length;k++){if(map.oid===this.attributes[k].oid){continueFlag=true;break;}}if(continueFlag){continue;}if(text===map.alias&&this.attribute.tp===map.tp){found=true;break;}}if(found){msg=mstrmojo.desc(12532,"The name ## has been used by another column. Please give a new name.");controller.displayError(msg.replace("##",text));return false;}return true;},validateForms:function validateForms(){var idMaps,duplicateMaps,formMaps,forms,validMaps,map=null,i,j,valid,haveEmptyForm;var tables=this.tables,tableIds=this.tableIds,table,tableId,validateResult=[];for(j=0;j<tableIds.length;j++){idMaps=[];duplicateMaps=[];validMaps=[];haveEmptyForm=false;tableId=tableIds[j];table=tables[tableId];formMaps=table.formMaps;forms=formMaps?formMaps[0].forms:[];forms.push({fmid:this.idFormId,fmn:"ID"});$ARR.forEach(formMaps,function(formMap){if(formMap.remove!=="-1"){validMaps.push(formMap);}});formMaps=validMaps;$ARR.forEach(formMaps,function(formMap){haveEmptyForm=haveEmptyForm||($ARR.find(forms,"fmid",formMap.formId)===-1);});forms.pop();for(i=0;i<formMaps.length;i++){map=formMaps[i];if(map.formId===this.idFormId){idMaps.push(map);}}for(i=0;i<formMaps.length;i++){map=formMaps[i];if($ARR.find(duplicateMaps,"formId",map.formId)===-1){var r=$ARR.findMulti(formMaps,"formId",[map]);if(r.count>1){duplicateMaps.push({formId:map.formId,indices:r.indices});}}}valid=((idMaps.length===1)&&(duplicateMaps.length===0)&&!haveEmptyForm);validateResult.push({tableName:table.tableName,valid:valid,idMaps:idMaps,duplicateMaps:duplicateMaps,haveEmptyForm:haveEmptyForm});}this.setSubmitBtn(validateResult);return validateResult;}});}());