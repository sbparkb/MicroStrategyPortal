(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.DI.TableSources","mstrmojo.DI.DIDatabaseImportOption","mstrmojo.DI.DIMappingDeck");mstrmojo.requiresDescs(702,962,967,1388,3581,11403,12860,12861,13039);var constants=mstrmojo.DI.DIConstants;var menuItems=mstrmojo.DI.DIConstants.menuItems;var $D=mstrmojo.dom;var DATABASE_IMPORT_DIALOG_ID="databaseImportDialog";var TABLE_SOURCE_DIALOG_ID="__di_table_source_dialog";var DIpageType=mstrmojo.DI.DIConstants.pageType;function addSourceTable(){var pageType=this.pageType;if(pageType){switch(pageType){case DIpageType.database:var databaseImportOptionWidget=mstrmojo.all[DATABASE_IMPORT_DIALOG_ID];if(!databaseImportOptionWidget){var databaseImportOptionWidgetConfig={scriptClass:"mstrmojo.DI.DIDatabaseImportOption",domSrc:this.parent.parent.domSrc};databaseImportOptionWidget=mstrmojo.insert(databaseImportOptionWidgetConfig);}databaseImportOptionWidget.open();break;default:var slot=mstrApp.getRootController().navigationController.getPageSlot();slot.setConfig({properties:{operationMode:constants.operationMode.create}});mstrApp.getRootController().showPage(pageType,this.sourceInfo,slot);mstrmojo.Obj.free(slot);}}}function createAvatar(w,ctxt){var d=document.createElement("div"),s=d.style,dn=w.domNode;d.className="resize-handler-avatar";s.width=dn.clientWidth+"px";dn.appendChild(d);w.avatar=d;return d;}function showAvatar(widget,ctxt){var s=ctxt.src,d=s&&s.data;if(d&&d.node){var av=widget.avatar||createAvatar(widget,ctxt);av.style.top=Math.max(d.pos.y,s.pos.y)+"px";av.style.left=d.pos.x+"px";av.style.display="block";av.style.zIndex="9999";av.style.width=d.pos.w+"px";return true;}}function hideAvatar(widget,ctxt){if(widget.avatar){widget.avatar.style.display="none";}}function updateAvatar(widget,ctxt){var src=ctxt.src;var s=ctxt.src;if(!s){return false;}var d=s.data;var t=ctxt.tgt,av=widget.avatar;if(av){av.style.top=Math.min(Math.max(d.pos.y+widget.minSpan,t.pos.y),d.pos.y+d.pos.h-widget.minSpan)+"px";}}mstrmojo.DI.DITableItem=mstrmojo.declare(mstrmojo.Container,null,{type:"",name:"",cm:"",cssClass:"",allowEdit:true,markupString:'<div id="{@id}" class="mstrmojo-di-tableitem {@cssClass}" style="{@cssText}" ><div class="mstrmojo-di-tableitem-icon t{@type}"></div><div class="mstrmojo-di-tableitem-name"></div><div class="mstrmojo-di-tableitem-button"></div>',markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"table":"none";}},markupSlots:{textNode:function(){return this.domNode.children[1];},menuNode:function(){return this.domNode.children[2];}},rename:function(){this.text.rename();},children:[{slot:"textNode",alias:"text",scriptClass:"mstrmojo.InlineEditBox",getValueFromText:function(){return this.text?mstrmojo.string.decodeHtmlString(this.text):"";},rename:function(){if(this.editMode!==this.allowEdit){this.set("editMode",this.allowEdit);}},onSave:function(){var value=this.text;this.parent.raiseEvent({name:"itemOnSave",src:this,text:value});},bindings:{allowEdit:"this.parent.allowEdit",text:"this.parent.name"}},{slot:"menuNode",scriptClass:"mstrmojo.MenuButton",postCreate:function(){if(this.parent.cm){this.cm=this.parent.cm;}else{this.set("visible",false);}this.menuZIndex=this.parent.menuZIndex||999;},onclick:function(){var me=this;if(!this._close_handler_onmouseup_set){if(this._close_handler){mstrmojo.dom.attachEvent(document.body,"mouseup",this._close_handler);}this._close_handler_onmouseup_set=true;}},onmousedown:function(evt){evt.cancel();},executeCommand:function(item){this.parent.raiseEvent({name:"executeCommand",src:this,item:item});}}]});mstrmojo.DI.DIMappingPanel=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.DI.DIMappingPanel",draggable:true,dropZone:true,ownAvatar:true,minSpan:80,markupString:'<div id="{@id}" class="mstrmojo-di-mapping-panel {@cssClass}" style="{@cssText}"><div class="table-list"></div><div class="table-deck"><div class="resize-handler __r0"></div></div><div class="table-deck"><div class="resize-handler __r1"></div></div><div class="table-deck"><div class="resize-handler __r2"></div></div><div class="unused-option"></div></div>',markupSlots:{tableListNode:function(){return this.domNode.children[0];},attrDeckNode:function(){return this.domNode.children[1];},metricDeckNode:function(){return this.domNode.children[2];},unusedDeckNode:function(){return this.domNode.children[3];},unusedOptionNode:function(){return this.domNode.children[4];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},layoutConfig:{h:{tableListNode:"20%",attrDeckNode:"40%",metricDeckNode:"40%",unusedDeckNode:"0%",unusedOptionNode:"20px"},w:{tableListNode:"100%",attrDeckNode:"100%",metricDeckNode:"100%",unusedDeckNode:"100%",unusedOptionNode:"100%"}},getDragData:function(ctxt){var src=ctxt.src;var node=src.node;var bottomNode,topNode;var pos=null;if(node.className&&node.className.indexOf("resize-handler")>=0){var i=node.className.indexOf("__r");var idx=parseInt(node.className.substr(i+3,1),10);switch(idx){case 0:topNode=this.tableListNode;bottomNode=this.attrDeckNode;break;case 1:topNode=this.attrDeckNode;bottomNode=this.metricDeckNode;break;case 2:topNode=this.metricDeckNode;bottomNode=this.unusedDeckNode;break;}if(topNode&&bottomNode){var topPos=$D.position(topNode);var bottomPos=$D.position(bottomNode);pos={x:topPos.x,y:topPos.y,w:topPos.w,h:topPos.h+bottomPos.h};}return{node:node,pos:pos,idx:idx};}return null;},allowDrop:function(ctxt){var src=ctxt.src;return src&&src.data&&src.data.node;},isDragValid:function isDragValid(context){var s=context.src,d=s&&s.data;return !!(d&&d.node);},ondragstart:function(ctxt){showAvatar(this,ctxt);},ondragmove:function(ctxt){updateAvatar(this,ctxt);},ondragend:function(ctxt){var s=ctxt.src,d=s&&s.data;var deltaX=null;if(d&&d.node){var av=this.avatar;if(av){deltaX=parseInt(av.style.top,10)-d.pos.y;}}hideAvatar(this,ctxt);if(deltaX){var idx=d.idx;var totalHeight=$D.position(this.domNode).h;var tableListP=null,attrDeckP=null,metricDeckP=null,unusedDeckP=null;switch(idx){case 0:tableListP=deltaX/totalHeight*100;attrDeckP=($D.position(this.tableListNode).h+$D.position(this.attrDeckNode).h-deltaX)/totalHeight*100;metricDeckP=$D.position(this.metricDeckNode).h/totalHeight*100;unusedDeckP=$D.position(this.unusedDeckNode).h/totalHeight*100;break;case 1:tableListP=$D.position(this.tableListNode).h/totalHeight*100;attrDeckP=deltaX/totalHeight*100;metricDeckP=($D.position(this.attrDeckNode).h+$D.position(this.metricDeckNode).h-deltaX)/totalHeight*100;unusedDeckP=$D.position(this.unusedDeckNode).h/totalHeight*100;break;case 2:tableListP=$D.position(this.tableListNode).h/totalHeight*100;attrDeckP=$D.position(this.attrDeckNode).h/totalHeight*100;metricDeckP=deltaX/totalHeight*100;unusedDeckP=($D.position(this.metricDeckNode).h+$D.position(this.unusedDeckNode).h-deltaX)/totalHeight*100;break;}if(tableListP!==null&&attrDeckP!==null&&metricDeckP!==null&&unusedDeckP!==null){tableListP=Math.round(tableListP);attrDeckP=Math.round(attrDeckP);if(unusedDeckP!==0){metricDeckP=Math.round(metricDeckP);unusedDeckP=100-tableListP-attrDeckP-metricDeckP;}else{metricDeckP=100-tableListP-attrDeckP;}this.layoutConfig.h={tableListNode:tableListP+"%",attrDeckNode:attrDeckP+"%",metricDeckNode:metricDeckP+"%",unusedDeckNode:unusedDeckP+"%",unusedOptionNode:"20px"};this.doLayout();}}},afterLayout:function(){var resizeHeight;if(this.tableListNode){this.tableList.set("height",this.tableListNode.clientHeight);}if(this.attrDeckNode){resizeHeight=this.attrDeckNode.children[0].clientHeight;this.attrDeck.set("height",this.attrDeckNode.clientHeight-resizeHeight);}if(this.metricDeckNode){resizeHeight=this.metricDeckNode.children[0].clientHeight;this.metricDeck.set("height",this.metricDeckNode.clientHeight-resizeHeight);}if(this.unusedDeckNode){resizeHeight=this.unusedDeckNode.children[0].clientHeight;this.unusedDeck.set("height",this.unusedDeckNode.clientHeight-resizeHeight);}},reInitLayout:function(alias){var bShow=this[alias].visible;var allNodes=["attrDeckNode","metricDeckNode","unusedDeckNode"];var heightConfig=this.layoutConfig.h;var allDeckHeightP=0;var i,j,p,cnt,key;cnt=allNodes.length;for(i=0;i<allNodes.length;i++){allDeckHeightP+=parseInt(heightConfig[allNodes[i]],10);}if(bShow){p=Math.round(allDeckHeightP/cnt);}else{p=0;}j=0;for(i=0;i<allNodes.length;i++){key=allNodes[i];if(key===alias+"Node"){this.layoutConfig.h[key]=p+"%";}else{if(j<cnt-2){this.layoutConfig.h[key]=Math.round((allDeckHeightP-p)/(cnt-1))+"%";j++;}else{this.layoutConfig.h[key]=allDeckHeightP-p-Math.round((allDeckHeightP-p)/(cnt-1))*(cnt-2)+"%";}}}this.doLayout();},preBuildRendering:function(){if(this._super){this._super();}this.model.attachEventListener("CurrentSourceChanged",this.id,"update");this.update();},update:function(){var source=this.model.currentSource;var showUnusedOption=true;if(source===null){showUnusedOption=false;}else{if(source.type===constants.sourceType.querybuilder){if(source.xdaType===constants.xdaType.qbSingleTable){showUnusedOption=true;}else{showUnusedOption=false;}}}if(showUnusedOption){this.unusedOption.set("visible",true);this.layoutConfig.w.unusedOptionNode="100%";this.layoutConfig.h.unusedOptionNode="20px";this.unusedDeck.set("visible",this.unusedOption.checked);}else{this.unusedOption.set("visible",false);this.layoutConfig.w.unusedOptionNode="0px";this.layoutConfig.h.unusedOptionNode="2px";this.unusedDeck.set("visible",false);}},children:[{slot:"tableListNode",alias:"tableList",scriptClass:"mstrmojo.Container",markupString:'<div class="tablelist" style="{@cssText}"><div></div><div></div></div>',markupSlots:{captionNode:function(){return this.domNode.children[0];},listNode:function(){return this.domNode.children[1];}},onheightChange:function(e){this.list.set("height",(parseInt(e.value,10)-20)+"px");},children:[{slot:"captionNode",alias:"table",scriptClass:"mstrmojo.Table",cssClass:"titlebar-table",rows:1,cols:2,children:[{scriptClass:"mstrmojo.Label",cssClass:"titlebar-label",text:"Table",slot:"0,0"},{scriptClass:"mstrmojo.Button",cssClass:"titlebar-button",text:"+",slot:"0,1",onclick:function onclick(){var tableSourceDialog=mstrmojo.all[TABLE_SOURCE_DIALOG_ID];if(!tableSourceDialog){tableSourceDialog=mstrmojo.insert({id:TABLE_SOURCE_DIALOG_ID,scriptClass:"mstrmojo.DI.TableSources",zIndex:999,domSrc:this.domNode,clickhandler:addSourceTable});}tableSourceDialog.open();}}]},{slot:"listNode",alias:"list",scriptClass:"mstrmojo.WidgetList",cssClass:"mstrmojo-di-mappingpanel-tablelist",itemFunction:function(item,index,list){var cfg={type:item.type,name:item.n,cm:item.cm,data:item,parent:list,index:index};if(typeof item.allowEdit==="boolean"){cfg.allowEdit=item.allowEdit;}var iw=new mstrmojo.DI.DITableItem(cfg);iw.attachEventListener("executeCommand",list.id,"onExecuteCommand");iw.attachEventListener("itemOnSave",list.id,"onTableItemRename");return iw;},onheightChange:function(e){if(this.domNode){this.domNode.style.height=parseInt(e.value,10)+"px";}},onchange:function(){var item=this.selectedItem;var currentTableID=this.parent.parent.model.currentSource?this.parent.parent.model.currentSource.tableID:-1;var i;if(!item){return ;}for(i=0;i<this.items.length;i++){if(this.itemsContainerNode&&this.itemsContainerNode.childNodes){mstrmojo.css.toggleClass(this.itemsContainerNode.childNodes[i],"selected",(i===item.index||this.itemsContainerNode.childNodes.length===1));}}var dssid=item.dssid;mstrApp.getRootController().selectSourceTable(dssid);},postCreate:function(){var m=this.parent.parent.model;this.update();if(this.items.length>0){mstrApp.getRootController().selectSourceTable(this.items[0].dssid);}m.attachEventListener("MappingsFetched",this.id,"update");},update:function(){var items=[];var m=this.parent.parent.model;var item;var cm=[];cm.push({n:mstrmojo.desc(1388,"Rename"),did:menuItems.RENAME});cm.push({n:mstrmojo.desc(12860,"Clean your data"),did:menuItems.REFINE});cm.push({n:mstrmojo.desc(702,"Advanced"),did:menuItems.REFINE_WITHOUT_PARSING});cm.push({did:menuItems.SEPARATOR});cm.push({n:mstrmojo.desc(13039,"Delete"),did:menuItems.DELETE});if(m.operationMode===constants.operationMode.edit){cm.push({did:menuItems.SEPARATOR});cm.push({n:mstrmojo.desc(967,"Refresh Data"),did:menuItems.REFRESH_DATA});}var sourceTables=m.getAllTableID();var i,source;for(i=0;i<sourceTables.length;i++){source=m.getImportSource(sourceTables[i]);if(source.sourceInfo){item={n:source.sourceInfo.name,type:source.type,dssid:source.key,cm:cm,index:i+1};items.push(item);}}if(items.length>1){items.splice(0,0,{n:"All",type:"All",dssid:-1,index:0,allowEdit:false});}this.set("items",items);if(this.items.length>0){i=this.selectedIndex===-1?0:this.selectedIndex;if(i>=this.items.length){i=0;}this.set("selectedIndex",-1);this.set("selectedIndex",i);}},onTableItemRename:function(evt){var src=evt.src;var text=evt.text;var tableID=src.data.dssid;var table=mstrApp.getRootController().model.getImportSource(tableID);if(!table||!table.sourceInfo){return ;}if(text===table.sourceInfo.name){return ;}mstrApp.getRootController().renameSourceTable(tableID,text);},onExecuteCommand:function(evt){var src=evt.src;var item=evt.item;switch(item.did){case menuItems.REFINE:mstrApp.getRootController().startRefineStage(src.data.dssid,1);break;case menuItems.REFINE_WITHOUT_PARSING:var filename=mstrmojo.all.DIModel.importSources[src.data.dssid].sourceInfo.dbTableName;var pos=filename.lastIndexOf(".");var type=filename.substr(pos+1);var xml;if(type==="xls"){xml='<rss rfmt="binary/xls"><rpo>{"includeFileSources":false,"xmlBased":false,"storeBlankRows":true,"ignoreLines":-1,"storeBlankCellsAsNulls":true,"headerLines":1,"skipDataLines":0,"sheets":[0],"projectName":"lmy"}</rpo></rss>';}else{if(type==="xlsx"){xml='<rss rfmt="text/xml/xlsx"><rpo>{"includeFileSources":false,"xmlBased":true,"storeBlankRows":true,"ignoreLines":-1,"storeBlankCellsAsNulls":true,"headerLines":1,"skipDataLines":0,"sheets":[0],"projectName":"lmy"}</rpo></rss>';}else{xml='<rss rfmt="text/line-based/*sv"><rpo>{"encoding":"","separator":"","ignoreLines":-1,"headerLines":0,"skipDataLines":0,"limit":-1,"storeBlankRows":true,"guessCellValueTypes":false,"processQuotes":true,"storeBlankCellsAsNulls":true,"includeFileSources":false,"projectName":"lmy"}</rpo></rss>';}}mstrApp.getRootController().startRefineStage(src.data.dssid,2,xml);break;case menuItems.RENAME:src.rename();break;case menuItems.DELETE:mstrApp.getRootController().removeSourceTable(src.data.dssid);break;case menuItems.REFRESH_DATA:mstrApp.getRootController().refreshSourceTable(src.data.dssid);break;}}}]},{slot:"attrDeckNode",alias:"attrDeck",scriptClass:"mstrmojo.DI.DIMappingDeck",title:mstrmojo.desc(3581,"Attributes"),type:"amps",bindings:{model:"this.parent.model"}},{slot:"metricDeckNode",alias:"metricDeck",scriptClass:"mstrmojo.DI.DIMappingDeck",title:mstrmojo.desc(962,"Metrics"),type:"mtmps",bindings:{model:"this.parent.model"}},{slot:"unusedDeckNode",alias:"unusedDeck",scriptClass:"mstrmojo.DI.DIMappingDeck",cssClass:"unused",title:mstrmojo.desc(12861,"Unused"),type:"cmps",visible:false,bindings:{model:"this.parent.model"},markupMethods:{onvisibleChange:function(){this.parent.unusedDeckNode.style.display=this.visible?"block":"none";this.parent.reInitLayout("unusedDeck");}}},{slot:"unusedOptionNode",alias:"unusedOption",scriptClass:"mstrmojo.ImageCheckBox",cssClass:"unusedOption",label:mstrmojo.desc(11403,"Show unused columns"),oncheckedChange:function(){var bChecked=this.checked;this.parent.unusedDeck.set("visible",bChecked);}}]});}());