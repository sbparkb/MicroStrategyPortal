(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.Label","mstrmojo.WidgetList","mstrmojo.HBox","mstrmojo.VBox","mstrmojo.CheckList","mstrmojo.RadioList","mstrmojo.StackContainer");mstrmojo.requiresDescs(373,547,12724);var SHEETS_SELECTION_DIALOG="sheetsSelectionDiaglog";var constants=mstrmojo.DI.DIConstants;function isSheetsSelected(importSources){var k,i;for(k in importSources){var sheets=importSources[k].sheetsInfo;if(sheets){for(i=0;i<sheets.length;i++){if(sheets[i].selected){return true;}}}}return false;}mstrmojo.DI.DISheetsSelection=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.DISheetsSelection",cssClass:"mstrmojo-di-sheets-selection-dialog",title:mstrmojo.desc(12724,"Select Worksheets"),srcWidgetID:null,noButtonCls:true,id:SHEETS_SELECTION_DIALOG,children:[{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-di-ssd-file-content",alias:"filesAndSheets",children:[{scriptClass:"mstrmojo.VBox",alias:"leftPanel",cssClass:"mstrmojo-di-ssd-left-panel",children:[{scriptClass:"mstrmojo.Label",text:"FILES",cssClass:"mstrmojo-di-ssd-title"},{scriptClass:"mstrmojo.WidgetList",alias:"fileList",cssClass:"mstrmojo-di-ssd-file-list",itemFunction:function(item,idx,list){var iw=new mstrmojo.Button({text:item.n,sheets:item.sheets,widget:list,onclick:function(){list.updateSheetsList(item);}});return iw;},postCreate:function(){var model=mstrApp.getRootController().getModel();model.attachEventListener("SheetsInfoFetched",this.id,"populateSheets");},populateSheets:function(evt){var model=mstrApp.getRootController().getModel();var i,items=this.items||[];var tableID=evt.tableID;var table=model.importSources[tableID];var sheets=table.sheetsInfo;var sheetsItem=[];if(sheets){var k;if(sheets.length>1){for(k=0;k<sheets.length;k++){sheetsItem.push({idx:k,n:sheets[k].name});}items.push({n:table.fileName,id:table.tableID,sheets:sheetsItem});}}this.set("items",items);this.render();},onitemsChange:function(evt){this.updateSheetsList(evt.value[0]);},updateSheetsList:function(item){var sheetsSelectionDialog=this.parent.parent.parent;var rightPanel=this.parent.parent.rightPanel;var sheetsStack=rightPanel.sheets;var sheetsWidget;var model=mstrApp.getRootController().getModel();var widget,i;if(sheetsStack.children){for(i=0;i<sheetsStack.children.length;i++){if(sheetsStack.children[i].tableID===item.id){sheetsWidget=sheetsStack.children[i];}}}if(!sheetsWidget){if(model.operationMode===constants.operationMode.create){widget="mstrmojo.CheckList";}else{var tableId=model.currentSource.tableID;if(model.importSources[tableId].sourceInfo.partition.type!==0){widget="mstrmojo.CheckList";}else{widget="mstrmojo.RadioList";}}sheetsWidget=sheetsStack.addChildren([mstrmojo.insert({scriptClass:widget,cssClass:"mstrmojo-di-ssd-sheets-list",items:item.sheets,list:item.sheets,tableID:item.id,sheetsSelectionDialog:sheetsSelectionDialog,selectedIndex:0,onselectionChange:function onselectionChange(evt){var model=mstrApp.getRootController().getModel();var sheetsInfo=model.importSources[this.tableID].sheetsInfo;if(model.operationMode===constants.operationMode.create){var evtItem=evt.removed||evt.added;var sheet=sheetsInfo[evtItem[0]];sheet.selected=!sheet.selected;if(!isSheetsSelected(model.importSources)){this.sheetsSelectionDialog.btnHbox.selectBtn.set("enabled",false);}else{this.sheetsSelectionDialog.btnHbox.selectBtn.set("enabled",true);}}}})])[0];rightPanel.fileName.set("text",item.n);}sheetsStack.set("selected",sheetsWidget);}}]},{scriptClass:"mstrmojo.VBox",alias:"rightPanel",cssClass:"mstrmojo-di-ssd-right-panel",children:[{scriptClass:"mstrmojo.Label",alias:"fileName"},{scriptClass:"mstrmojo.TextBox",cssClass:"mstrmojo-di-ssd-search",cssText:"font-size:10pt;",alias:"searchBox",onkeyup:function(evt){var input=this.value;var items=this.parent.sheets.list;var k,index,result=[],row=0,col=0;for(k=0;k<items.length;k++){index=items[k].n.toLowerCase().search(input.toLowerCase());if(index>-1){result.push(items[k]);}}this.parent.sheets.set("items",result);}},{scriptClass:"mstrmojo.StackContainer",cssClass:"mappingpage-bottom",alias:"sheets"}]}]}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(373,"Back"),alias:"backBtn",onclick:function(){var sheetsSelectionDialog=this.parent.parent;var controller=mstrApp.getRootController(),model=controller.model;model.sheetsInfo={};sheetsSelectionDialog.destroy();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(547,"Select"),alias:"selectBtn",enabled:true,onclick:function(){var sheetsSelectionDialog=this.parent.parent;var files=sheetsSelectionDialog.filesAndSheets.leftPanel.fileList.items;var controller=mstrApp.getRootController(),model=controller.model,importSources=model.importSources,i,j,tableID,params={},index,len,currentSheets;var filterFn=function(sheet){return sheet.selected;};function getSheets(tableID){var selectedSheets=[];mstrmojo.hash.forEach(importSources[tableID].sheetsInfo,function(sheet){if(sheet.selected){selectedSheets.push(sheet.name);}});return selectedSheets;}if(model.operationMode===constants.operationMode.create){for(j=0;j<files.length;j++){tableID=files[j].id;currentSheets=mstrmojo.array.filter(importSources[tableID].sheetsInfo,filterFn);len=currentSheets.length;var multiSheets=len>1?true:false;for(i=0;i<len;i++){if(multiSheets){params.flags="4";}index=currentSheets[i].index;if(i===0){params.shtIx=index;controller.autoMappingSourceTable(null,tableID,params,tableID);}else{var srcTableID=params.tbid=tableID;controller.createEMMASourceTableMultiSheets(params,index,srcTableID,constants.sourceType.file,constants.sourceSubtype.localFile);}}params={};}}else{var sheetsWidget=sheetsSelectionDialog.filesAndSheets.rightPanel.sheets;var selectedIndex;tableID=model.currentSource.tableID;var partition=model.importSources[tableID].sourceInfo.partition;currentSheets=model.currentSource.sheetsInfo;len=currentSheets.length;if(partition.isPartition){selectedIndex=sheetsWidget.selected.selectedIndices;for(i=0;i<len;i++){if(selectedIndex[i]){currentSheets[i].selected=true;}else{currentSheets[i].selected=false;}}controller.setPartition(tableID);}else{selectedIndex=sheetsWidget.selected.selectedIndex;for(i=0;i<len;i++){if(i!==selectedIndex){currentSheets[i].selected=false;}}currentSheets[selectedIndex].selected=true;index=currentSheets[selectedIndex].index;params.shtIx=index;controller.setDataImportInfo(tableID,params,tableID);}}sheetsSelectionDialog.destroy();}}],postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.closeNode.style.display="none";}});}());