(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.DI.DIConstants","mstrmojo.List","mstrmojo.Label","mstrmojo.TextArea","mstrmojo.Widget","mstrmojo.DI.DIDragFiles");mstrmojo.requiresDescs(12512,12741,12744,12745,13030);function isValidProtocol(urlText){urlText=urlText.toLowerCase();urlText=urlText.replace(/\s+/g," ");return(urlText.indexOf("file://")===0)||(urlText.indexOf("ftp://")===0)||(urlText.indexOf("http://")===0)||(urlText.indexOf("https://")===0)||(urlText.indexOf("hdfs://")===0);}function isURLSupported(urlText){var support={protocolDisabled:false,protocol:""};urlText.toLowerCase();urlText.replace(/\s+/g," ");return support;}function extractFileName(url){if(!url){return"";}var firstIndex,lastIndex,fileName;firstIndex=url.lastIndexOf("/")+1;lastIndex=url.indexOf("?op=");fileName=url.substring(firstIndex,lastIndex);return fileName;}function getCurrentSource(){var m=this.model;var source;if(this.currentSource){source=this.currentSource;}else{source=m.currentSource;}return source;}var constants=mstrmojo.DI.DIConstants;function doImport(action){var i,urlList=this.getDropZone(),tableID=this.tableID||null,urls=[],list=urlList.urls;mstrmojo.hash.copy(urlList.urls,urls);var controller=mstrApp.getRootController();var isPartition=false;if(tableID&&list&&list.length>1){var source=this.model&&this.model.getImportSource(tableID);if(source&&source.sourceInfo&&source.sourceInfo.url){var partition=source.sourceInfo.partition;if(partition&&partition.isPartition){isPartition=true;}}if(!isPartition){controller.displayError(mstrmojo.desc(12741,"You can upload only one file when refresh a table."));return ;}}var showPreview=true;var urlSupport,msg;if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"");};}for(i=0;i<urls.length;i++){var url=urls[i].trim();urls[i]=url;if(!isValidProtocol.call(this,url)){controller.displayError(mstrmojo.desc(12512,"We do not support the URL protocol you provided."),false);return ;}urlSupport=isURLSupported.call(this,url);if(urlSupport.protocolDisabled){msg=mstrmojo.desc(13030,"Unable to fetch data. Importing files using ## has been disabled by the administrator.").replace("##",urlSupport.protocol);controller.displayError(msg,false);return ;}}controller.importURLEMMA(urlList,urls,showPreview,!controller.model.hasEMMAReportInstance(),this.id,true,action);}mstrmojo.DI.DIHadoop=mstrmojo.declare(mstrmojo.DI.DIDragFiles,null,{scriptClass:"mstrmojo.DI.DIHadoop",supportFolderDrag:true,sizeTooltip:true,folderSizeTooltip:true,controller:null,dbRoleSavedEvt:null,dbRoleLoadedEvt:null,createTitleWidget:function createTitleWidget(){var cfg={dbRoleName:"Hadoop Connection",cssClass:"di-hadoop-titleWidget",children:[{scriptClass:"mstrmojo.Label",cssClass:"di-connector-title",bindings:{text:"this.parent.dbRoleName"}},{scriptClass:"mstrmojo.Label",text:"(##)".replace("##",mstrmojo.desc(12744,"Change Connection...")),cssClass:"di-connector-title-connection",onclick:function(){var controller=mstrApp.getRootController(),dbRole=controller.hadoopController.dbRole;controller.hadoopController.renderDBRoleEditor(dbRole);}},{scriptClass:"mstrmojo.Label",cssClass:"di-connector-title-refresh",onclick:function(){var controller=mstrApp.getRootController(),dbRoleId=controller.hadoopController.dbRoleID;controller.hadoopController.loadBDETypeDBRole(dbRoleId);}}]};return new mstrmojo.Box(cfg);},ondrop:function ondrop(evt){if(!this.droppable){return ;}var selectedNodes=evt.src.data,selectedNode,i,controller=mstrApp.getRootController(),list=this.urls;if(controller.model.isDirectDataAccess&&(list.length+selectedNodes.length)>1){var msg=mstrmojo.desc(12745,"Live mode Cube with multiple files or folders from HDFS is not supported yet. Please keep only one file or folder and remove others.");controller.displayError(msg,false);return ;}for(i=0;i<selectedNodes.length;i++){selectedNode=selectedNodes[i];this.addURL(selectedNode.data.address,selectedNode.text,selectedNode.data.isFolder);}mstrmojo.css.removeClass(this.dnDNode,"dragging");},browseFunction:function browseFunction(node){return mstrApp.getRootController().hadoopController.hadoopBrowserFunction(node);},refreshFunction:function refreshFunction(){mstrApp.getRootController().hadoopController.browseHadoop(this.rootUrl,this);},preBuildRendering:function preBuildRendering(){if(this._super){this._super();}this.controller=mstrApp.getRootController();var dbRoleId=this.controller.hadoopController.dbRoleID;this.controller.hadoopController.loadBDETypeDBRole(dbRoleId);},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}if(this.dbRoleSavedEvt){this.model.detachEventListener(this.dbRoleSavedEvt);}if(this.dbRoleLoadedEvt){this.model.detachEventListener(this.dbRoleLoadedEvt);}this.dbRoleSavedEvt=this.model.attachEventListener("HadoopDBRoleSaved",this.id,this.handleDBRoleSaved);this.dbRoleLoadedEvt=this.model.attachEventListener("BDEDBRoleLoaded",this.id,this.handleDBRoleLoaded);this.model.attachEventListener("windowSizeChanged",this.id,this.changeSize);this.controller.sourceSelected(false);},handleDBRoleSaved:function handleDBRoleSaved(){var controller=mstrApp.getRootController();var dbRoleId=controller.hadoopController.dbRoleID;controller.hadoopController.loadDBRoleByID(dbRoleId);},handleDBRoleLoaded:function handleDBRoleLoaded(){if(this.controller.rootView.currentPage.id!==this.id){return ;}var hadoopController=this.controller.hadoopController;var dbRoleId=hadoopController.dbRoleID;if(dbRoleId){var rootURL=hadoopController.hadoopConnURL;this.setRootURL(rootURL);this.refreshBrowser();this.setFilesForRefreshData();var title=this.getTitleWidget();title.set("dbRoleName",hadoopController.dbRole.n);}else{hadoopController.renderDBRoleEditor();}},setFilesForRefreshData:function setFilesForRefreshData(){var tableId=this.tableID;var source=this.model&&this.model.getImportSource(tableId);if(source&&source.sourceInfo&&source.sourceInfo.url){var path=source.sourceInfo.url;var partition=source.sourceInfo.partition;var dropZone=this.getDropZone();if(partition&&partition.isPartition){var i;for(i=0;i<partition.tables.length;i++){dropZone.addURL(partition.tables[i].name,extractFileName(partition.tables[i].name),false);}}else{dropZone.addURL(path,extractFileName(source.sourceInfo.name),false);}}},onHelpButtonClick:function onHelpButtonClick(){return"importing_data_from_a_Hadoop_file_browser.htm";},onNextButtonClick:function onNextButtonClick(){doImport.call(this,this.tableID?constants.actions.refreshData:constants.actions.importSource);},onFinishButtonClick:function(){doImport.call(this,constants.actions.savePublish);},onBackButtonClick:function onBackButtonClick(){this.controller.showPage(constants.pageType.dataSelection);},setFilesObject:function setFilesObject(urls){var urlList=this.getDropZone();urlList.setURLsObject(urls);}});}());