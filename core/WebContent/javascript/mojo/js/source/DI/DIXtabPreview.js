(function(){mstrmojo.requiresCls("mstrmojo.Table","mstrmojo.Widget");var action={none:0,moveMetricHeader:1,moveData:2,moveDataColumn:3,moveDataRow:4};function isInsideMHB(row,col,mhb){var value;if(mhb.startRow===mhb.endRow&&row===mhb.startRow&&col>=mhb.startColumn){value=true;}else{value=mhb.startColumn===mhb.endColumn&&col===mhb.startColumn&&row>=mhb.startRow;}return value;}function isStartOfDB(row,col,db){return row===db.startRow&&col===db.startColumn;}function isFisrtColumnOfDB(row,col,db){return col===db.startColumn&&row>db.startRow;}function isFisrtRowOfDB(row,col,db){return row===db.startRow&&col>db.startColumn;}function renderMousePointer(row,col,mhb,db){if(isInsideMHB(row,col,mhb)||(this.operation===action.moveMetricHeader)){this.domNode.style.cursor="move";}else{if(isStartOfDB(row,col,db)||(this.operation===action.moveData)){this.domNode.style.cursor="se-resize";}else{if(isFisrtColumnOfDB(row,col,db)||(this.operation===action.moveDataColumn)){this.domNode.style.cursor="w-resize";}else{if(isFisrtRowOfDB(row,col,db)||(this.operation===action.moveDataRow)){this.domNode.style.cursor="n-resize";}else{this.domNode.style.cursor="auto";}}}}}function handleMouseDown(evt){var cell=evt.currentTarget;var row=cell.parentNode;if(isInsideMHB(row.rowIndex,cell.cellIndex,this.xtabModel.mhb)){this.operation=action.moveMetricHeader;this.draw();}if(isStartOfDB(row.rowIndex,cell.cellIndex,this.xtabModel.db)){this.operation=action.moveData;this.draw();}if(isFisrtColumnOfDB(row.rowIndex,cell.cellIndex,this.xtabModel.db)){this.operation=action.moveDataColumn;this.draw();}if(isFisrtRowOfDB(row.rowIndex,cell.cellIndex,this.xtabModel.db)){this.operation=action.moveDataRow;this.draw();}}function handleMouseMove(evt){var cell=(evt.currentTarget)?evt.currentTarget:evt.srcElement;var row=cell.parentNode;var mhb=this.xtabModel.mhb;var db=this.xtabModel.db;var indices={x:row.rowIndex,y:cell.cellIndex};var sel=window.getSelection();sel.removeAllRanges();if(this.operation===action.none){renderMousePointer.call(this,row.rowIndex,cell.cellIndex,mhb,db);return ;}switch(this.operation){case action.moveMetricHeader:if((indices.x<db.startRow)&&(indices.y>=db.startColumn)){mhb.set("startRow",indices.x);mhb.set("startColumn",db.startColumn);mhb.set("endRow",indices.x);mhb.set("endColumn",-1);}else{if((indices.y<db.startColumn)&&(indices.x>=db.startRow)){mhb.set("startRow",db.startRow);mhb.set("startColumn",indices.y);mhb.set("endRow",-1);mhb.set("endColumn",indices.y);}}break;case action.moveData:db.set("startRow",indices.x);db.set("startColumn",indices.y);if(mhb.startColumn>-1&&mhb.startRow>-1&&mhb.startRow===mhb.endRow){if(mhb.startRow>=indices.x){mhb.set("startRow",indices.x-1);mhb.set("endRow",indices.x-1);}mhb.set("startColumn",indices.y);}else{if(mhb.startColumn>-1&&mhb.startRow>-1&&mhb.startRow!==mhb.endRow){if(mhb.startColumn>=indices.y){mhb.set("startColumn",indices.y-1);mhb.set("endColumn",indices.y-1);}mhb.set("startRow",indices.x);}else{this.raiseEvent({name:"NoMetricHeaderBlock"});}}break;case action.moveDataRow:db.set("startRow",indices.x);if(mhb.startColumn>-1&&mhb.startRow>-1&&mhb.startRow===mhb.endRow){if(mhb.startRow>=indices.x){mhb.set("startRow",indices.x-1);mhb.set("endRow",indices.x-1);}}else{if(mhb.startColumn>-1&&mhb.startRow>-1&&mhb.startRow!==mhb.endRow){if(mhb.startColumn>=indices.y){mhb.set("startColumn",indices.y-1);mhb.set("endColumn",indices.y-1);}mhb.set("startRow",indices.x);}else{this.raiseEvent({name:"NoMetricHeaderBlock"});}}break;case action.moveDataColumn:db.set("startColumn",indices.y);if(mhb.startColumn>-1&&mhb.startRow>-1&&mhb.startRow===mhb.endRow){if(mhb.startRow>=indices.x){mhb.set("startRow",indices.x-1);mhb.set("endRow",indices.x-1);}mhb.set("startColumn",indices.y);}else{if(mhb.startColumn>-1&&mhb.startRow>-1&&mhb.startRow!==mhb.endRow){if(mhb.startColumn>=indices.y){mhb.set("startColumn",indices.y-1);mhb.set("endColumn",indices.y-1);}}else{this.raiseEvent({name:"NoMetricHeaderBlock"});}}break;}this.draw();renderMousePointer.call(this,row.rowIndex,cell.cellIndex,mhb,db);}function handleMouseUp(){this.operation=action.none;this.draw();}function attachCellEvents(){var rows=this.domNode.firstChild.children;var i,j;var me=this;var onMouseMove=function(evt){handleMouseMove.call(me,evt);};var onMouseDown=function(evt){handleMouseDown.call(me,evt);};var onMouseUp=function(evt){handleMouseUp.call(me,evt);};for(i=0;i<rows.length;i++){var row=rows[i];var cells=row.children;for(j=0;j<cells.length;j++){mstrmojo.dom.attachEvent(cells[j],"mousemove",onMouseMove);mstrmojo.dom.attachEvent(cells[j],"mousedown",onMouseDown);mstrmojo.dom.attachEvent(cells[j],"mouseup",onMouseUp);}}}function adjustSize(clnCount){var clnWidth=200;var p=this.parent&&this.parent.previewNode;if(!p){return ;}var w=clnWidth*clnCount;if(p.clientWidth>w){this.cssText="width:100%";}else{this.cssText="width:"+w+"px";}}mstrmojo.DI.DIXtabPreview=mstrmojo.declare(mstrmojo.Table,null,{scriptClass:"mstrmojo.DI.DIXtabPreview",preview:null,colHdrs:null,xtabModel:null,operation:action.none,cellCssClass:"di-xtab-cell",setDimensions:function setDimensions(h,w){if(!this.colHdrs){return ;}var width=parseInt(w,10);var height=parseInt(h,10)-5+"px";var _clnWidth=200;var p=this.parent&&this.parent.previewNode;if(!p){return ;}this.parent.preGrid.set("height",height);if(width>this.colHdrs.length*_clnWidth){this.domNode.style.width="100%";}else{this.domNode.style.width=this.colHdrs.length*_clnWidth+"px";}},initXtab:function(preview,xtabModel,colHdrs){this.preview=preview;this.xtabModel=xtabModel;this.colHdrs=colHdrs;if(!xtabModel){return ;}this.populate();attachCellEvents.call(this);},populate:function(){var cols=this.colHdrs.length;this.removeChildren();this.unrender();this.rows=49;this.cols=cols;adjustSize.call(this,cols);this.render();this.addContents();this.draw();},addContents:function addContents(){var rows=this.domNode.firstChild.children;var data=this.preview;var row,cells,i,j;for(i=0;i<rows.length;i++){row=rows[i];cells=row.children;for(j=0;j<cells.length;j++){if(i===0){cells[j].innerHTML=this.colHdrs[j];}else{if(!mstrmojo.string.isEmpty(data[i-1][j])){cells[j].innerHTML=data[i-1][j].toString();}}}}},draw:function(){var i,j,row,cells;var mhb=this.xtabModel.mhb;var db=this.xtabModel.db;var rows=this.domNode.firstChild.children;if(db.startRow>this.rows||db.startColumn>this.cols||(mhb.startRow===-1&&mhb.startColumn===-1&&db.startRow===-1&&db.startColumn===-1)){db.set("startRow",0);db.set("startColumn",0);db.set("endRow",-1);db.set("endColumn",-1);mhb.set("startRow",-1);mhb.set("startColumn",-1);mhb.set("endRow",-1);mhb.set("endColumn",-1);for(i=0;i<rows.length;i++){row=rows[i];cells=row.children;for(j=0;j<cells.length;j++){cells[j].className="di-xtab-cell di-xtab-cell-data";}}return ;}var db_endColumn=db.endColumn>-1?db.endColumn:this.cols-1;var mhb_endColumn=mhb.endColumn>-1?mhb.endColumn:this.cols-1;var db_endRow=db.endRow>-1?db.endRow:this.rows-1;var mhb_endRow=mhb.endRow>-1?mhb.endRow:this.rows-1;for(i=0;i<rows.length;i++){row=rows[i];cells=row.children;for(j=0;j<cells.length;j++){cells[j].className="";if(j>=db.startColumn&&i>=db.startRow){cells[j].className="di-xtab-cell di-xtab-cell-data";if(i===db.startRow){cells[j].className+=" di-xtab-cell-data-top";if((j-db.startColumn)%5===0){cells[j].className+=" handler";}}if(i===db_endRow){cells[j].className+=" di-xtab-cell-data-bottom";}if(j===db.startColumn){cells[j].className+=" di-xtab-cell-data-left";if((i-db.startRow)%5===0){cells[j].className+=" handler";}}if(j===db_endColumn){cells[j].className+=" di-xtab-cell-data-right";}}else{if(j<db.startColumn&&i<db.startRow){cells[j].className="di-xtab-cell di-xtab-cell-undefined";}else{if(mhb.startColumn===db.startColumn&&i===mhb.startRow&&j>=mhb.startColumn){cells[j].className="di-xtab-cell di-xtab-cell-metricHeader di-xtab-cell-metricHeader-top di-xtab-cell-metricHeader-bottom";if(j===mhb.startColumn){cells[j].className+=" di-xtab-cell-metricHeader-left header-first-one";}else{if(j===mhb_endColumn){cells[j].className+=" di-xtab-cell-metricHeader-right";}}}else{if(mhb.startRow===db.startRow&&j===mhb.startColumn&&i>=mhb.startRow){cells[j].className="di-xtab-cell di-xtab-cell-metricHeader di-xtab-cell-metricHeader-left di-xtab-cell-metricHeader-right";if(i===mhb.startRow){cells[j].className+=" di-xtab-cell-metricHeader-top header-first-one";}else{if(i===mhb_endRow){cells[j].className+=" di-xtab-cell-metricHeader-bottom";}}}else{cells[j].className="di-xtab-cell di-xtab-cell-dataElement";}}}}}}}});}());