(function(){mstrmojo.requiresCls("mstrmojo.DI.DISourceObjects","mstrmojo.DI.DIAnalytics","mstrmojo.date");mstrmojo.requiresDescs(14214,14534);var acceptedDateInput=["MM/DD/YYYY","today","yesterday"],regDaysAgo=/^\d+daysAgo$/;var sourceType=mstrmojo.DI.DIConstants.sourceType;var constants=mstrmojo.DI.DIConstants;var separator="###";var gaDateFormat="yyyy-MM-dd";var isOperationMode=mstrmojo.DI.DIHelpers.isOperationMode,$ARR=mstrmojo.array,$L=mstrmojo.locales,$D=mstrmojo.date;var analyticsComponent={scriptClass:"mstrmojo.DI.DIAnalytics",alias:"analyticsComponent",slot:"analyticsNode"};function calculateDates(date){var dateStr;if(date.toUpperCase()==="MM/DD/YYYY"){dateStr="YYYY-MM-DD";}else{if(mstrmojo.array.indexOf(acceptedDateInput,date)!==-1||regDaysAgo.test(date)){dateStr=date;}else{var dateObj=mstrmojo.date.getDateJson(new Date(date));if(dateObj.day.toString()!=="NaN"){dateStr=mstrmojo.date.formatDateInfo(dateObj,"yyyy-MM-dd");}else{mstrApp.getRootController().displayError(mstrmojo.desc(14214,"Requests can only specify a date formatted as YYYY-MM-DD, or as a relative date (e.g., today, yesterday, or N days ago where N is a positive integer). Please change your input into any of the aforementioned formats."),false);return ;}}}return dateStr;}function getDateQuery(analytics){var dateQuery,dateTable=analytics.dateTable;if(dateTable.dates.idx===0){dateQuery="&start-date="+calculateDates(dateTable.fromDate.value)+"&end-date="+calculateDates(dateTable.toDate.value);}else{dateQuery="&dynamic-date={"+dateTable.dates.options[dateTable.dates.idx].qn+"}";}return dateQuery;}function generateQuery(analytics,nodeData){var dateQuery,query;dateQuery=getDateQuery(analytics);var addr=nodeData.address.replace("${PROFILEIDS}","ga:"+analytics.selectedProfile.id);query=addr+dateQuery;return query;}function decodeQuery(query){query=query.substr(query.indexOf("?")+1);return decodeURIComponent(query);}function getParam(query,paramName){var start=query.indexOf(paramName);if(start===-1){return"";}var end=query.indexOf("&",start+paramName.length)===-1?query.length:query.indexOf("&",start+paramName.length);return query.substring(start,end);}function wrapQuery(query,fl){var newQuery="";if(fl.node){newQuery=query+separator+"accountID:"+this.selectedAccount.id+",webPropertyID:"+this.selectedWebProperty.id+",profileID:"+this.selectedProfile.id+",folderName:"+fl.node.parent.text;}else{newQuery=query+separator+"accountID:"+this.selectedAccount.id+",webPropertyID:"+this.selectedWebProperty.id+",profileID:"+this.selectedProfile.id;}return newQuery;}function setProperty(name){var source,address,idx,model,index,folderName;if(this.tableID){source=this.model.getImportSource(this.tableID);}if(this.currentSource){source=this.currentSource;}if(!source){return ;}address=source.sourceInfo.url.substr("SQL=".length);idx=address.indexOf(separator);if(idx>-1){var params=address.substr(idx+separator.length,address.length);params=params.split(",");model=this.model.externalSources[sourceType.googleAnalytics];var gaAccountTable=this.analyticsComponent.accountTable;switch(name){case"accountID":mstrmojo.array.forEach(params,function(param){var currParam=param.split(":");if(currParam[0]===name){index=mstrmojo.array.find(model.accounts,"id",currParam[1]);gaAccountTable.account.set("idx",index);}});break;case"webPropertyID":mstrmojo.array.forEach(params,function(param){var currParam=param.split(":");if(currParam[0]===name){index=mstrmojo.array.find(model.accounts[gaAccountTable.account.idx].webProperties,"id",currParam[1]);gaAccountTable.webproperty.set("idx",index);}});break;case"profileID":mstrmojo.array.forEach(params,function(param){var currParam=param.split(":");if(currParam[0]===name){index=mstrmojo.array.find(model.accounts[gaAccountTable.account.idx].webProperties[gaAccountTable.webproperty.idx].profiles,"id",currParam[1]);gaAccountTable.profiles.set("idx",index);}});break;case"folderName":mstrmojo.array.forEach(params,function(param){var currParam=param.split(":");if(currParam[0]===name){folderName=currParam[1];}});return folderName;}}}function getNewCustomQueryName(){var model=mstrApp.getRootController().getModel(),prefix="CustomQuery",customQueryCnt=this.customQueryCnt,name;if(!customQueryCnt){customQueryCnt=1;}do{name=prefix+customQueryCnt;customQueryCnt++;}while(!model.isTableAliasUnique(name));return name;}function doImport(action){var items=[];var item,i,data,showPreview;var operationMode=this.model.operationMode;var list=this.browser.fileTree,query,analytics=this.analyticsComponent;var tableID=this.tableID||null,source;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}showPreview=true;if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"");};}if(this.analyticsComponent.ultp.selectedIndex===0){for(i=0;i<list.selectedNodes.length;i++){data=list.selectedNodes[i].data;item={n:data.n,desc:data.desc,type:data.type,tableID:tableID};if(!mstrApp.isSingleTier){item.node=list.selectedNodes[i];}query=generateQuery(this.analyticsComponent,data);query=decodeQuery(query);query=wrapQuery.call(analytics,query.trim(),data);item.query=query;items.push(item);}}else{if(this.analyticsComponent.ultp.selectedIndex===1){item={desc:"Google Analytics",type:"file",tableID:tableID,node:null};if(tableID){source=mstrApp.getRootController().getModel().getImportSource(tableID);if(source&&source.sourceInfo){item.n=source.sourceInfo.name;}else{item.n=getNewCustomQueryName.call(this);}}else{item.n=getNewCustomQueryName.call(this);}query=this.textarea.value.substr(this.textarea.value.indexOf("ids=ga"));query=decodeQuery(query);query=wrapQuery.call(analytics,query.trim(),item);item.query=query;items.push(item);}}if(tableID){mstrApp.getRootController().refreshDataOAuthReport(this.sourceObjectsInfo.type,this.sourceObjectsInfo.subtype,tableID,items[0],constants.actions.refreshData);}else{mstrApp.getRootController().importMultiOAuthReports(this.sourceObjectsInfo.type,items,showPreview,!mstrApp.getRootController().model.hasEMMAReportInstance(),action,this.sourceObjectsInfo.subtype,this.id);}}mstrmojo.DI.DISourceObjectsGA=mstrmojo.declare(mstrmojo.DI.DISourceObjects,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.DI.DISourceObjectsGA",cssClass:"mojo-di-sourceobjectsga",refreshed:false,populate:function(evt){var options=[],account,folders,source,i,gaAccountTable=this.analyticsComponent.accountTable;var model=this.model.externalSources[sourceType.googleAnalytics];var operationMode=this.model.operationMode;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}if(evt&&evt.targetPageId){if(evt.targetPageId!==this.id){return ;}}for(account in model.accounts){options.push({n:model.accounts[account].n,v:account});}gaAccountTable.account.set("options",options);gaAccountTable.account.notExist=false;if(this.tableID&&(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit)){setProperty.call(this,"accountID");if(gaAccountTable.account.idx===-1){gaAccountTable.account.notExist=true;mstrApp.getRootController().displayError(mstrmojo.desc(14534,"The user has not been granted permissions on the account."),false);if(gaAccountTable.account.options.length>0){gaAccountTable.account.set("idx",0);}}}else{gaAccountTable.account.set("idx",0);}gaAccountTable.account.refresh();var res=this.model.externalSources[this.sourceObjectsInfo.type].reports;var list=mstrApp.getRootController().parseOAuthSourceFolder(this.sourceObjectsInfo.type,res);this.browser.set("fileList",list);if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){if(this.tableID){source=this.model.getImportSource(this.tableID);}if(this.currentSource){source=this.currentSource;}if(source&&source.sourceInfo&&source.sourceInfo.name){var GAReportName=source.sourceInfo.dbTableName;var GAFolderName=setProperty.call(this,"folderName");if(GAReportName.indexOf("CustomQuery")<0&&GAReportName.indexOf("Google Analytics Query")<0&&!!GAFolderName){folders=this.browser.fileTree.items;if(GAFolderName){for(i=0;i<folders.length;i++){if(folders[i].isFolder===true&&folders[i].n===GAFolderName){this.browser.autoSelectNode(folders[i].node,"/"+GAReportName);folders[i].fetched=true;folders[i].node.set("state",1);}}}}}}},onHelpButtonClick:function onHelpButtonClick(){return"Importing_data_from_google_analytics.htm";},onNextButtonClick:function onNextButtonClick(){doImport.call(this);},onFinishButtonClick:function(){doImport.call(this,constants.actions.savePublish);},handleImportError:function(reports,status){if(this.analyticsComponent.ultp.selectedIndex===0){this.browser.set("forceEnableContinue",!this.tableID);$ARR.forEach(reports,function(report,idx){if(status[idx].success===true){report.node.deselect();}});}return true;},onEditButtonClick:function onEditButtonClick(node){var analytics=this.analyticsComponent;var radioList=analytics.ultp;var query;query=generateQuery(analytics,node.data);node.data.browser.parent.textarea.value=query;radioList.setSelectedItems(radioList.items[1]);node.data.browser.parent.textarea.focus();},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.model.externalSources[sourceType.googleAnalytics].attachEventListener("analyticsWebPropertiesFetched",this.id,this.populateWebProperties);this.model.externalSources[sourceType.googleAnalytics].attachEventListener("analyticsProfilesFetched",this.id,this.populateProfiles);this.populateDate();},populateDate:function populatedDate(){var operationMode=this.model.operationMode,dateTable=this.analyticsComponent.dateTable,source;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){if(this.tableID){source=this.model.getImportSource(this.tableID);}if(this.currentSource){source=this.currentSource;}if(source){var address=source.sourceInfo.url.substr("SQL=".length);address=address.substring(0,address.indexOf(separator));if(address.indexOf("start-date=")!==-1){dateTable.dates.set("idx",0);var fromDate=getParam(address,"start-date=").substr("start-date=".length);var toDate=getParam(address,"end-date=").substr("end-date=".length);var dateObj;dateObj=$D.parseDate(fromDate,false,gaDateFormat);if(!dateObj){dateObj=$D.parseDate(fromDate);}fromDate=dateObj?$D.formatDateInfo(dateObj,$L.datetime.DATEOUTPUTFORMAT):fromDate;dateTable.fromDate.set("value",fromDate);dateObj=$D.parseDate(toDate,false,gaDateFormat);if(!dateObj){dateObj=$D.parseDate(toDate);}toDate=dateObj?$D.formatDateInfo(dateObj,$L.datetime.DATEOUTPUTFORMAT):toDate;dateTable.toDate.set("value",toDate);}else{if(address.indexOf("dynamic-date={")!==-1){var option=address.substring(address.indexOf("dynamic-date={")+"dynamic-date={".length,address.indexOf("}",address.indexOf("dynamic-date={")+"dynamic-date={".length));var index=3;var options=dateTable.dates.options;for(var i=0,len=options&&options.length||0;i<len;i++){var obj=options[i];if(obj&&obj.qn.indexOf(option)>-1){index=i;}}dateTable.dates.set("idx",index);}}}}},postCreate:function postCreate(){this.children=mstrmojo.hash.clone(this.children);if(this._super){this._super();}analyticsComponent.model=this.model;analyticsComponent.tableID=this.tableID;analyticsComponent.currentSource=this.currentSource;this.addChildren([new mstrmojo.DI.DIAnalytics(analyticsComponent)]);},populateWebProperties:function populateWebProperties(evt){var operationMode=this.model.operationMode,gaAccountTable=this.analyticsComponent.accountTable,accountID=gaAccountTable.account.idx;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}if(evt&&evt.targetPageId){if(evt.targetPageId!==this.id){return ;}}var options=[],property;var model=this.model.externalSources[sourceType.googleAnalytics];if(accountID!==undefined){for(property in model.accounts[accountID].webProperties){options.push({n:model.accounts[accountID].webProperties[property].n,v:property});}}gaAccountTable.webproperty.set("options",options);if((operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit)&&(!this.refreshed)&&this.tableID){if(options.length!==0){if(!gaAccountTable.account.notExist){setProperty.call(this,"webPropertyID");}else{gaAccountTable.webproperty.set("idx",0);}}else{gaAccountTable.webproperty.set("idx",-1);}}else{gaAccountTable.webproperty.set("idx",-1);gaAccountTable.webproperty.set("idx",0);}gaAccountTable.webproperty.refresh();},populateProfiles:function populateProfiles(evt){var options=[],gaAccountTable=this.analyticsComponent.accountTable,profile,accountID=gaAccountTable.account.idx,curWebProperty;var model=this.model.externalSources[sourceType.googleAnalytics];var operationMode=this.model.operationMode;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}if(evt&&evt.targetPageId){if(evt.targetPageId!==this.id){return ;}}if(accountID!==undefined&&model.accounts[accountID].webProperties){curWebProperty=model.accounts[accountID].webProperties[gaAccountTable.webproperty.idx];if(curWebProperty){for(profile in curWebProperty.profiles){options.push({n:curWebProperty.profiles[profile].n,v:profile});}}}gaAccountTable.profiles.set("options",options);if((operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit)&&(!this.refreshed)&&this.tableID){if(options.length!==0){if(!gaAccountTable.account.notExist){setProperty.call(this,"profileID");}else{gaAccountTable.profiles.set("idx",0);}this.refreshed=true;}else{gaAccountTable.profiles.set("idx",-1);}}else{gaAccountTable.profiles.set("idx",-1);gaAccountTable.profiles.set("idx",0);}gaAccountTable.profiles.refresh();},setDimensions:function setDimensions(h,w){var height=parseInt(h,10);var width=parseInt(w,10);if(isNaN(height)||isNaN(width)){return ;}if(!this.layoutConfig){this.layoutConfig={h:{},w:{}};}this.layoutConfig.h.listNode=Math.max((height-250),0)+"px";this.layoutConfig.w.listNode=Math.max((width-40),0)+"px";if(this._super){this._super(height+"px",w);}if(this.analyticsComponent){this.analyticsComponent.fixObjectBrowserHeight();}}});}());