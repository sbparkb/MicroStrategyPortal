(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.FileUploadBox","mstrmojo.Editor","mstrmojo.DI.MstrFileReportSummary");mstrmojo.requiresDescs(1443,2177,4444,8131,11593);mstrmojo.DI.MstrFileSummaryEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.MstrFileSummaryEditor",cssClass:"mstr-file-upload-editor",successItems:[],failItems:[],bindings:{title:function(){if(this.failItems.length>0){return mstrmojo.desc(11593,"Oops!");}return mstrmojo.desc(1443,"Success!");}},children:[{scriptClass:"mstrmojo.DI.MstrFileReportSummary",cssClass:"mstr_fu_content",alias:"summaryEditor",bindings:{successItems:"this.parent.successItems",failItems:"this.parent.failItems"}},{scriptClass:"mstrmojo.HBox",cssClass:"mstr_fu_footer",slot:"buttonNode",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstr_fu_report_button",text:mstrmojo.desc(8131,"Run Dashboard"),bindings:{visible:function(){return(this.parent.parent.successItems.length===1);}},onclick:function(){var m={};m.evt=2048001;m.documentID=this.parent.parent.successItems[0].dashboardId;m.src=mstrApp.name+".2048001";m.visMode=0;mstrmojo.form.send(m,null,"POST",null);}},{scriptClass:"mstrmojo.Label",cssClass:"mstr_fu_cancel_button",text:mstrmojo.desc(2177,"Close"),onclick:function(){var loginEditor=this.parent.parent;loginEditor.close();}}]}],onClose:function(){if(this.successItems.length>0){this.refreshList();}}});mstrmojo.DI.MstrFileImport=mstrmojo.declare(mstrmojo.FileUploadBox,null,{scriptClass:"mstrmojo.MstrFileImport",visible:false,fileFieldName:"myFile",multiple:"multiple",initValue:false,completeProgress:0,markupMethods:{onvalueChange:function(){this.fileCount=this.fileNode.files.length;this.completeProgress=0;this.uploadStatus={currentIndex:0,successItems:[],failItems:[]};this.inputNode.value=this.value;if(!this.value){return ;}if(this.value.match(/.mstr$/)){this.submit();mstrApp.showProgress(this.config);}else{this.displayFileTypeMsg();}var cNode=this.createInputNode();this.formNode.children[1].replaceChild(cNode,this.fileNode);this.fileNode=cNode;this.fileNode.value="";}},createInputNode:function(){var node=document.createElement("input"),temp=this;node.setAttribute("class","mstrmojo-FileUploadBox-file");node.setAttribute("type","file");node.setAttribute("name",this.fileFieldName);node.setAttribute("onchange","mstrmojo.all."+this.id+".synValue()");node.setAttribute("","multiple");return node;},submit:function(){var ps=this.params,callbacks=this.callbacks,config=this.config,uploadFileIndex=this.uploadStatus.currentIndex;function handleFileLoaded(e){var array=[];array.push(e.target.result);var blob=new Blob(array);mstrmojo.xhr.upload("POST",mstrConfig.taskURL,callbacks,ps,blob,config);}var r=true;if(this.onsubmit){r=this.onsubmit();}if(r){ps.jsonp=this.jsonp.replace("{@id}",this.id);if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)){var reader=new FileReader();if(this.params){ps=this.params;}var file=this.fileNode.files[uploadFileIndex];if(callbacks){this.onSuccess=callbacks.success;this.onFailed=callbacks.failure;}reader.onload=handleFileLoaded;reader.readAsArrayBuffer(file);}else{ps.taskEnv="jsonp2";var h=[],p;for(p in ps){h.push('<input type="hidden" name="'+p+'" value="'+mstrmojo.string.encodeHtmlString(ps[p].toString())+'"/>');}if(this.params){ps=this.params;for(p in ps){h.push('<input type="hidden" name="'+p+'" value="'+mstrmojo.string.encodeHtmlString(ps[p].toString())+'"/>');}}this.paramsNode.innerHTML=h.join("");if(callbacks){this.onSuccess=callbacks.success;this.onFailed=callbacks.failure;}this.formNode.submit();}this.set("status","loading");}},loopUpload:function(){this.uploadStatus.currentIndex++;if(this.uploadStatus.currentIndex<this.fileCount){this.submit();}else{mstrApp.hideProgress();var mstrEditor=mstrmojo.all.statusEditor;if(!mstrEditor){mstrEditor=new mstrmojo.DI.MstrFileSummaryEditor({id:"statusEditor",refreshList:this.refreshList});}mstrEditor.set("successItems",this.uploadStatus.successItems);mstrEditor.set("failItems",this.uploadStatus.failItems);mstrEditor.open();}},onRender:function(){var controller=this;this.config={showProgress:true,showProgressText:true,progressText:"Uploading Files"};this.params={fileFieldName:this.fileFieldName,taskId:"importSaveRWD",taskEnv:"xhr",taskContentType:"json"};this.callbacks={success:function(res){if(res.errorCode){var dashboardName=res.n||mstrmojo.desc(4444,"Unknown");controller.uploadStatus.failItems.push({dashBoardName:dashboardName,errorLog:res.errorMessage});controller.loopUpload();}else{controller.uploadStatus.successItems.push({dashBoardName:res.n,dashboardId:res.did});controller.loopUpload();}},failure:function(res){var dashboardName=res.n||mstrmojo.desc(4444,"Unknown");controller.uploadStatus.failItems.push({dashBoardName:dashboardName,errorLog:res.getResponseHeader("X-MSTR-TaskFailureMsg")});controller.loopUpload();},progress:function(evt,config){if(evt.lengthComputable){controller.completeProgress+=(evt.loaded/evt.total);var totalComplete=controller.completeProgress/controller.fileCount;mstrApp.setProgressParams(totalComplete,config);}}};},markupString:'<div id={@id} class="{@cssClass}" style="{@cssText}"><form class="mstrmojo-FileUploadBox-form" target="{@id}_iframe" enctype="multipart/form-data" method="post" action="{@action}"><input class="uploadFileText" readonly="readonly" type="text"/><div class="mstrmojo-di-fu-buttonDiv"><div class="mstrmojo-di-button primary-button" style="display:none"></div><input class="mstrmojo-FileUploadBox-file" type="file" {@multiple} size="30" style="font-size:4em;" name="{@fileFieldName}" onchange="mstrmojo.all.{@id}.synValue();" accept=".mstr"/></div><div style="display:none;"></div></form><iframe id="{@id}_iframe" + name="{@id}_iframe" style="display:none;" src="about:blank"></iframe></div>',displayFileTypeMsg:function(){},refreshList:function(){}});}());