(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.DI.DIConstants","mstrmojo.List","mstrmojo.DI.DIObjectBrowser","mstrmojo._HasLayout","mstrmojo.Label","mstrmojo.TextArea","mstrmojo.Widget");mstrmojo.requiresDescs(8338,8513,12891);var constants=mstrmojo.DI.DIConstants,sourceType=mstrmojo.DI.DIConstants.sourceType,isOperationMode=mstrmojo.DI.DIHelpers.isOperationMode;function wrapQuery(query,path){return query+"###path:"+path;}mstrmojo.DI.DISourceObjects=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.DI.DISourceObjects",markupString:'<div id="{@id}" class="{@cssClass}" style="{@cssText}"><div class="cf source-objects-options"></div><div></div><div style="padding-left:20px;"></div><div style="padding-left:20px;padding-right:20px;"></div><div class="show-preview"></div><div class="source-objects-refresh"></div></div>',markupSlots:{subtitleNode:function(){return this.domNode.children[0];},analyticsNode:function(){return this.domNode.children[1];},listHeaderNode:function(){return this.domNode.children[2];},listNode:function(){return this.domNode.children[3];},previewNode:function(){return this.domNode.children[4];},refreshNode:function(){return this.domNode.children[5];}},markupMethods:{onvisibleChange:function(){var operationMode=mstrApp.getRootController().getModel().operationMode;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}this.domNode.style.display=this.visible?"block":"none";}},isMultiSelect:true,children:[{slot:"subtitleNode",scriptClass:"mstrmojo.Label",cssClass:"source-objects-signout",text:mstrmojo.desc(8338,"sign out"),onclick:function(){mstrApp.getRootController().oAuthSignOut(this.parent.sourceObjectsInfo.type);}},{slot:"subtitleNode",scriptClass:"mstrmojo.Label",cssClass:"source-objects-username",alias:"username",postBuildRendering:function(){this.update();mstrApp.getRootController().model.externalSources[this.parent.sourceObjectsInfo.type].attachEventListener("oAuthReportsFetched",this.id,this.update);},update:function(){var source=mstrApp.getRootController().model.externalSources[this.parent.sourceObjectsInfo.type],msg=source.userDisplayName;if(source.userEmail){msg+=" ("+source.userEmail+")";}this.set("text",msg);}},{slot:"subtitleNode",alias:"subtitle",scriptClass:"mstrmojo.Label",cssClass:"source-objects-subtitle",bindings:{text:function(){return mstrmojo.desc(12891,"Select Your file from ####").replace("####",this.parent.sourceObjectsInfo.name);}}},{slot:"subtitleNode",scriptClass:"mstrmojo.Label",allowHTML:true,cssClass:"source-objects-subtitle2",alias:"rightFormat",text:'|  Make sure your file is in <a target="_blank" href="http://www.microstrategy.com/express/resources/data-preparation">right format!</a>'},{scriptClass:"mstrmojo.DI.DIObjectBrowser",cssClass:"source-objects-browser",slot:"listNode",alias:"browser",browseFunction:function(node){return mstrApp.getRootController().oAuthSourceBrowserFunction(this.parent.sourceObjectsInfo.type,node);},editFunction:function(node){this.parent.onEditButtonClick(node);},refreshFunction:function(){mstrApp.getRootController().getOAuthSourceReports(this.parent.sourceObjectsInfo.type,false);},bindings:{visible:function(){if(this.parent.sourceObjectsInfo.type===sourceType.googleAnalytics){return(this.parent.analyticsComponent.ultp.selectedIndex===0);}return true;},canRefresh:function(){return this.parent.sourceObjectsInfo.type!==sourceType.googleAnalytics;},isMultiSelect:"this.parent.isMultiSelect"},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},autoSelectNode:function(node,path){if(node.data.isFolder){node.data.browser.clickedNode=node;mstrApp.getRootController().oAuthSourceBrowserFunction(this.parent.sourceObjectsInfo.type,node,path);}else{node.data.list.selectedItem=node.data;node.selectThisNode();mstrApp.getRootController().sourceSelected(true);}},postCreate:function(){this.sortRoot=(this.parent.sourceObjectsInfo.type!==sourceType.salesforce);}},{scriptClass:"mstrmojo.TextArea",slot:"listNode",alias:"textarea",maxLength:2000,markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";},onheightChange:function(){this.domNode.style.height=this.height||"";},onwidthChange:function(){this.domNode.style.width=this.width||"";}},onvalueChange:function(){if(this.value!==""){mstrApp.getRootController().sourceSelected(true);}else{mstrApp.getRootController().sourceSelected(false);}},bindings:{value:function(){var operationMode=mstrApp.getRootController().getModel().operationMode;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}if(operationMode!==constants.operationMode.create){return this.model.currentSource.sourceInfo.name;}return"";},visible:function(){if(this.parent.sourceObjectsInfo.type===sourceType.googleAnalytics){return(this.parent.analyticsComponent.ultp.selectedIndex===1);}return false;}}}],populate:function(evt){var res=this.model.externalSources[this.sourceObjectsInfo.type].reports;var list=mstrApp.getRootController().parseOAuthSourceFolder(this.sourceObjectsInfo.type,res);this.browser.set("fileList",list);var path,index,folderName,fileName;var operationMode=this.model.operationMode;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}var folders,reports,i,j,source=null;if(evt&&evt.targetPageId){if(evt.targetPageId!==this.id){return ;}}if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){source=this.model.currentSource;if(this.tableID){source=this.model.getImportSource(this.tableID);}if(this.currentSource){source=this.currentSource;}if(this.sourceObjectsInfo.type===sourceType.salesforce){if(source&&source.sourceInfo&&source.sourceInfo.url){folders=this.browser.fileTree.items;for(i=0;i<folders.length;i++){reports=folders[i].items;for(j=0;j<reports.length;j++){var report=reports[j];if(report.n===source.sourceInfo.name){folders[i].node.set("state",1);report.node.selectThisNode();}}}}}if(this.sourceObjectsInfo.type===sourceType.dropbox){if(source&&source.sourceInfo&&source.sourceInfo.url){reports=folders=this.browser.fileTree.items;path=source.sourceInfo.url;index=path.indexOf("/",1);if(index!==-1){folderName=path.substring(1,index);for(i=0;i<folders.length;i++){if(folders[i].isFolder===true&&folders[i].n===folderName){this.browser.autoSelectNode(folders[i].node,path.substring(index));folders[i].fetched=true;folders[i].node.set("state",1);}}}else{fileName=path.substring(1);for(i=0;i<reports.length;i++){if(reports[i].isFolder!==true&&reports[i].n===fileName){reports[i].node.selectThisNode();}}}}}if(this.sourceObjectsInfo.type===sourceType.googleDrive){if(source&&source.sourceInfo&&source.sourceInfo.url){reports=folders=this.browser.fileTree.items;path=source.sourceInfo.url;path=path.substr(path.indexOf("###")+"###path:".length);index=path.indexOf("/",1);while(index!==-1){folderName=path.substring(1,index);for(i=0;i<folders.length;i++){if(folders[i].isFolder===true&&folders[i].n===folderName){this.browser.autoSelectNode(folders[i].node,path.substring(index));folders[i].fetched=true;folders[i].node.set("state",1);}}path=path.substr(index);index=path.indexOf("/",1);}fileName=path.substring(1);for(i=0;i<reports.length;i++){if(reports[i].isFolder!==true&&reports[i].n===fileName){reports[i].node.selectThisNode();}}}}}this.username.set("text",mstrmojo.desc(8513,"User:")+this.model.externalSources[this.sourceObjectsInfo.type].userDisplayName+" | ");},preBuildRendering:function preBuildRendering(){var operationMode=this.model.operationMode;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}mstrApp.getRootController().sourceSelected(false);var name=this.sourceObjectsInfo.name.toLowerCase();if(name.indexOf(" ")!==-1){name=name.substring(0,name.indexOf(" "))+name.substring(name.indexOf(" ")+1,name.length);}this.subtitle.cssClass+=" extrasmall-"+name;if(this.sourceObjectsInfo.type===sourceType.googleAnalytics||this.sourceObjectsInfo.type===sourceType.salesforce||operationMode===constants.operationMode.refresh){this.rightFormat.set("visible",false);}this.setDimensions(parseInt(this.parent.layoutNode.offsetHeight,10),this.parent.layoutNode.offsetWidth);if(this._super){this._super();}},setDimensions:function setDimensions(h,w){var height=parseInt(h,10);var width=parseInt(w,10);var operationMode=this.model.operationMode;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}if(!this.layoutConfig){this.layoutConfig={h:{},w:{}};}this.layoutConfig.h.listNode=(height-70)+"px";if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){this.layoutConfig.h.listNode=(height-340)+"px";}this.layoutConfig.w.listNode=(width-40)+"px";if(this._super){this._super(height+"px",w);}},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.model.externalSources[this.sourceObjectsInfo.type].attachEventListener("oAuthReportsFetched",this.id,this.populate);},onNextButtonClick:function onNextButtonClick(){var operationMode=this.model.operationMode;var items=[];var item,i,showPreview,list;var tableID=this.tableID||null;if(isOperationMode(this.operationMode)){operationMode=this.operationMode;}showPreview=(operationMode===constants.operationMode.create)?true:this.showPrv.checked;list=this.browser.fileTree;for(i=0;i<list.selectedNodes.length;i++){item=list.selectedNodes[i].data;items.push({n:item.n,desc:item.desc,query:wrapQuery(item.address,item.folderPath+"/"+item.n),type:item.type,tableID:tableID});}mstrApp.getRootController().importMultiOAuthReports(this.sourceObjectsInfo.type,items,showPreview,!mstrApp.getRootController().model.hasEMMAReportInstance(),tableID?constants.actions.refreshData:constants.actions.importSource,this.id);},onBackButtonClick:function onBackButtonClick(){var controller=mstrApp.getRootController();controller.showPage(constants.pageType.dataSelection);},setSelectedNodes:function(nodes){var list=this.browser.fileTree,i=0,node;for(i=0;i<list.selectedNodes.length;i++){node=list.selectedNodes[i];node.deselect();}list.selectedNodes=[];list.selectedNode=null;this.browser.set("forceEnableContinue",true);for(i=0;i<nodes.length;i++){nodes[i].selectThisNode();}}});}());