(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.DI.DIConstants","mstrmojo.List","mstrmojo.Label","mstrmojo.TextArea","mstrmojo.Widget","mstrmojo.DI.DIDragFiles","mstrmojo.DI.DIProjectsMenu");mstrmojo.requiresDescs(12783,13091,13092,13093,13094,13095);var $ARR=mstrmojo.array,$DOM=mstrmojo.dom,selectedDBRoleName,selectedDBRoleId,rootController;mstrmojo.DI.DIRemoteProjects=mstrmojo.declare(mstrmojo.DI.DIDragFiles,[mstrmojo._HasPopup,mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.DI.DIHadoop",supportFolderDrag:false,sizeTooltip:false,createTitleWidget:function createTitleWidget(){var cfg={dbRoleName:mstrmojo.desc(13091,"Choose a connection"),children:[{scriptClass:"mstrmojo.Label",cssClass:"di-connector-projects-title",bindings:{text:"this.parent.dbRoleName"}},{scriptClass:"mstrmojo.Pulldown",alias:"dbRoleList",popupToBody:true,itemField:"dbrn",itemIdField:"dbrid",defaultText:mstrmojo.desc(13092,"Select a MicroStrategy Project"),bindings:{popupZIndex:"this.parent.parent.zIndex"},onvalueChange:function(){var list=this,selectedIndex=list.selectedIndex;selectedDBRoleName=list.items[selectedIndex].dbrn;selectedDBRoleId=list.items[selectedIndex].dbrid;rootController.projectController.getProjectSourceFolderId(selectedDBRoleId);}},{scriptClass:"mstrmojo.Label",cssClass:"di-connector-title-menu-connection",onclick:function(evt){if(!selectedDBRoleId){return ;}var menu=this.menuHelper;if(!menu){menu=new mstrmojo.DI.DIProjectsMenu();}menu.data=selectedDBRoleId;var cfg=menu.getMenuConfig();cfg.hostId=this.parent.parent.parent.parent.parent.id;cfg.hostElement=evt.target||$DOM.eventTarget(evt.hWin,evt.e);cfg.position=$DOM.position(cfg.hostElement,true);cfg.isHostedWithin=false;cfg.hostProxyCssClass="item-mn-proxy";this.parent.parent.parent.parent.parent.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));}},{scriptClass:"mstrmojo.Label",cssClass:"di-connector-title-add-connection",onclick:function(){rootController.projectController.renderDBRoleEditor();}}]};return new mstrmojo.HBox(cfg);},ondrop:function ondrop(evt){if(!this.droppable){return ;}var selectedNodes=evt.src.data,selectedNode,i,controller=mstrApp.getRootController(),list=this.urls;if(controller.model.isDirectDataAccess&&(list.length+selectedNodes.length)>1){var msg=mstrmojo.desc(13093,"A dataset can have only a single MicroStrategy Cube. Please create another dataset to import the second MicroStrategy cube.");controller.displayError(msg,false);return ;}for(i=0;i<selectedNodes.length;i++){selectedNode=selectedNodes[i];this.addURL(selectedNode.data.address,selectedNode.text,selectedNode.data.isFolder);}},filterType:["folder","emmaCube"],browseFunction:function browseFunction(node){return mstrApp.getRootController().projectSourceBrowserFunction(node.data.browser,node.data.address,selectedDBRoleId);},refreshFunction:function refreshFunction(folderId){if(!folderId){this.getObjectBrowser().set("fileList",[]);return ;}this.getObjectBrowser().clickedNode=this.mainPage.content.objectListPanel.browser.fileTree;return mstrApp.getRootController().projectSourceBrowserFunction(this.getObjectBrowser(),folderId,selectedDBRoleId);},preBuildRendering:function preBuildRendering(){if(this._super){this._super();}this.model.attachEventListener("projectsDBRoleLoaded",this.id,this.projectsDBRoleLoaded);this.model.attachEventListener("getFolderId",this.id,this.projectsFolderIdLoaded);this.model.attachEventListener("DBRoleLoadedById",this.id,this.projectDBRoleLoadedById);this.model.attachEventListener("projectDBRoleSaved",this.id,this.handleDBRoleSaved);this.model.attachEventListener("deleteDBRole",this.id,this.deleteDBRole);this.model.attachEventListener("DuplicateDBRole",this.id,this.duplicateDBRole);this.model.attachEventListener("getFolderIdFailure",this.id,this.getFolderIdFailure);this.getDropZone().set("text",mstrmojo.desc(13094,"Drag and Drop a Cube"));rootController=mstrApp.getRootController();rootController.projectController.loadRemoteProjectsDBRole();rootController.model.isDirectDataAccess=true;var onCreateReportInstance={success:function(res){if(res&&res.msgid){rootController.dataService.set("messageID",res.msgid);rootController.model.resetImportSource();}mstrApp.hideProgress();},failure:function(res){rootController.displayError(mstrmojo.desc(12783,"Create EMMA Report Instance error. Please check the metadata."),false,res.message||"");}};rootController.createNewReportInstance(onCreateReportInstance);},getFolderIdFailure:function getFolderIdFailure(){this.refreshFunction();},deleteDBRole:function deleteDBRole(){var title=this.getTitleWidget(),items=title.dbRoleList.items;var idx=$ARR.find(items,"dbrid",selectedDBRoleId);if(idx!==-1){items.splice(idx,1);title.dbRoleList.set("items",items);title.dbRoleList.set("selectedIndex",-1);title.dbRoleList.set("text",mstrmojo.desc(13092,"Select a MicroStrategy Project"));selectedDBRoleId="";this.refreshFunction();}else{this.set("defaultSelection",idx);}},duplicateDBRole:function duplicateDBRole(){rootController.projectController.duplicate();},handleDBRoleSaved:function handleDBRoleSaved(evt){var title=this.getTitleWidget(),items=title.dbRoleList.items,db_role=evt.data;var idx=$ARR.find(items,"dbrid",db_role.dbrid);if(idx===-1){items.push(db_role);title.dbRoleList.set("items",items);title.dbRoleList.set("defaultSelection",items.length-1);title.dbRoleList.set("text",items[items.length-1].dbrn);title.dbRoleList.set("selectedIndex",items.length-1);selectedDBRoleId=db_role.dbrid;}else{this.set("defaultSelection",idx);}rootController.projectController.getProjectSourceFolderId(selectedDBRoleId);},projectsFolderIdLoaded:function projectsFolderIdLoaded(evt){var folderId=evt.data.fid;this.refreshFunction(folderId);},projectDBRoleLoadedById:function projectDBRoleLoadedById(){var projectController=mstrApp.getRootController().projectController;var dbr=projectController.dbRole;projectController.renderDBRoleEditor(dbr);},projectsDBRoleLoaded:function projectsDBRoleLoaded(evt){var dbroles=evt.data;if(dbroles){var title=this.getTitleWidget(),dbroleid=rootController.projectController.dbRoleID;title.dbRoleList.set("items",dbroles);if(dbroleid){var idx=$ARR.find(dbroles,"dbrid",dbroleid);title.dbRoleList.set("text",dbroles[idx].dbrn);title.dbRoleList.set("selectedIndex",idx);selectedDBRoleId=dbroleid;rootController.projectController.getProjectSourceFolderId(dbroleid);}else{title.dbRoleList.set("selectedIndex",-1);title.dbRoleList.set("text",mstrmojo.desc(13092,"Select a MicroStrategy Project"));selectedDBRoleId="";this.refreshFunction();}}},onHelpButtonClick:function onHelpButtonClick(){return"importing_a_microstrategy_file.htm";},onFinishButtonClick:function onFinishButtonClick(){var urlList=this.getDropZone(),urls=[];mstrmojo.hash.copy(urlList.urls,urls);var reportInstanceCreated={success:function(){rootController.getImportController().importProjects({success:function(){rootController.saveAndPublish();},failure:function(res){rootController.displayError(mstrmojo.desc(13095,"Error in importing the cube. Please check the cube being imported."),false,res.message);}},selectedDBRoleId,urls[0]);},failure:function(res){rootController.displayError(mstrmojo.desc(12783,"Create EMMA Report Instance error. Please check the metadata."),false,res.message||"");}};rootController.duplicateSelectedDataset(reportInstanceCreated);},onBackButtonClick:function onBackButtonClick(){var controller=mstrApp.getRootController();controller.showPage(mstrmojo.DI.DIConstants.pageType.dataSelection);}});}());