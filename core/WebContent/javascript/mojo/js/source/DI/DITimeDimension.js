(function(){mstrmojo.requiresCls("mstrmojo.Table","mstrmojo.Label","mstrmojo.Box","mstrmojo.array","mstrmojo.CheckList","mstrmojo.fx","mstrmojo.DI.DIConstants");mstrmojo.requiresDescs(487,871,872,873,2052,2057,2461,10042,10043,10044,10045,10046,10047,10048,10049,10050,10051,12731,12732,13008);var ALL_DID="all",NONE=0,YEAR_DID=1,QUARTER_DID=2,QUARTER_OF_YEAR_DID=4,MONTH_DID=8,MONTH_OF_YEAR_DID=16,WEEK_DID=32,WEEK_OF_YEAR_DID=64,DATE_DID=128,DAY_OF_MONTH_DID=256,DAY_OF_WEEK_DID=512,HOUR_DID=1024,MINUTE_DID=2048,SECOND_DID=4096;var constants=mstrmojo.DI.DIConstants;var timeRole=constants.timeRoles;var _TIME0=[{n:mstrmojo.desc(2461,"All"),did:ALL_DID}],_TIME1=[{n:mstrmojo.desc(873,"Year"),did:YEAR_DID},{n:mstrmojo.desc(10050,"Quarter"),did:QUARTER_DID},{n:mstrmojo.desc(10051,"Quarter of Year"),did:QUARTER_OF_YEAR_DID},{n:mstrmojo.desc(871,"Month"),did:MONTH_DID},{n:mstrmojo.desc(10049,"Month of Year"),did:MONTH_OF_YEAR_DID},{n:mstrmojo.desc(10048,"Week"),did:WEEK_DID},{n:mstrmojo.desc(10047,"Week of Year"),did:WEEK_OF_YEAR_DID},{n:mstrmojo.desc(2052,"Date"),did:DATE_DID},{n:mstrmojo.desc(10046,"Day of Month"),did:DAY_OF_MONTH_DID},{n:mstrmojo.desc(10045,"Day of Week"),did:DAY_OF_WEEK_DID}],_TIME2=[{n:mstrmojo.desc(10042,"Hour"),did:HOUR_DID},{n:mstrmojo.desc(10043,"Minute"),did:MINUTE_DID},{n:mstrmojo.desc(10044,"Second"),did:SECOND_DID}],_TIMEROLES=[{n:mstrmojo.desc(2057,"None"),did:timeRole.NONE},{n:mstrmojo.desc(873,"Year"),did:timeRole.YEAR},{n:mstrmojo.desc(10050,"Quarter"),did:timeRole.QUARTER},{n:mstrmojo.desc(871,"Month"),did:timeRole.MONTH},{n:mstrmojo.desc(10048,"Week"),did:timeRole.WEEK},{n:mstrmojo.desc(872,"Day"),did:timeRole.DAY},{n:mstrmojo.desc(10042,"Hour"),did:timeRole.HOUR},{n:mstrmojo.desc(10043,"Minute"),did:timeRole.MINUTE},{n:mstrmojo.desc(10044,"Second"),did:timeRole.SECOND},{n:mstrmojo.desc(487,"Time"),did:timeRole.TIME},{n:mstrmojo.desc(13008,"Date Time"),did:timeRole.DATE_TIME},{n:mstrmojo.desc(2052,"Date"),did:timeRole.DATE}];var _skip=false;var TIME_DIMENSION_DATE_MODE=1,TIME_DIMENSION_TIME_MODE=2,TIME_DIMENSION_DATE_TIME_MODE=3,TIME_DIMENSION_TIME_ROLE=4;mstrmojo.DI.DITimeDimension=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.DI.DITimeDimension",markupString:'<div id="{@id}"  class="{@cssClass}" style="top:{@top};left:{@left};width:155px;height:{@height};"><div style="z-index:{@zIndex};{@cssText}" mstrAttach:mousedown,click><div class="mstrmojo-di-mapping-title"></div><div class="mstrmojo-di-mapping-time"></div></div></div>',markupSlots:{contentNode:function(){return this.domNode.firstChild.childNodes[1];},titleNode:function(){return this.domNode.firstChild.childNodes[0];}},top:"0px",left:"0px",height:"320px",mode:TIME_DIMENSION_DATE_TIME_MODE,timeFormIndex:0,init:function init(props){this._super(props);this.raiseEvent({name:"dataChange"});},onmodeChange:function onmodeChange(){var mode=this.mode,items=[],children;this.timebrowser.set("visible",false);this.timeRoleList.set("visible",false);switch(mode){case TIME_DIMENSION_DATE_MODE:items=_TIME0.concat(_TIME1);children=this.timebrowser;break;case TIME_DIMENSION_TIME_MODE:items=_TIME0.concat(_TIME2);children=this.timebrowser;break;case TIME_DIMENSION_DATE_TIME_MODE:items=_TIME0.concat(_TIME1).concat(_TIME2);children=this.timebrowser;break;case TIME_DIMENSION_TIME_ROLE:items=_TIMEROLES.concat(_TIME2);children=this.timeRoleList;break;default:break;}children.set("items",items);children.set("visible",true);},ondataChange:function ondataChange(){var data=this.data,timeIndex=0;if(data.isMultiForm){var subCols=data.subColumns;var options=[];mstrmojo.array.forEach(subCols,function(subCol,i){options.push({n:subCol.fmn,v:i});if((subCol.timerole&&subCol.timerole!==0)||(subCol.der&&subCol.der!==0)){timeIndex=i;}});this.timeFormIndex=timeIndex;this.getMode(data.subColumns[timeIndex]);this.multiFormList.set("options",options);this.title.set("text",mstrmojo.desc(12731,"Select a column to mark as a Time role: "));this.multiFormList.set("idx",this.timeFormIndex);}else{this.getMode(data);this.multiFormList.set("visible",false);this.title.set("text",mstrmojo.desc(12732,"Please select a time role for this attribute."));}},getMode:function getMode(data){var useGeo;switch(data.dtp){case 8:this.set("height","220px");this.mode=1;useGeo=false;break;case 9:this.set("height","100px");this.mode=2;useGeo=false;break;case 1:this.set("height","260px");this.mode=3;useGeo=false;break;case 2:case 3:this.set("height","260px");this.mode=4;useGeo=false;break;default:this.georole=data.georole;break;}this.raiseEvent({name:"modeChange"});},_close:function(){var parent=this.parent;if(parent&&parent._cmSource){parent._cmSource.closeMenuTree();}},onOK:function(){var parent=this.parent,data,i,len,tempSelections,derivedAttrFlag;var selections,controller=mstrApp.getRootController();if(this.data.isMultiForm){var index=this.multiFormList.idx;if(index!==this.timeFormIndex){this.data.subColumns[this.timeFormIndex].timerole=0;this.data.subColumns[this.timeFormIndex].der=0;}data=this.data.subColumns[index];}else{data=this.data;}if(this.mode===TIME_DIMENSION_TIME_ROLE){selections=this.timeRoleList.getSelectedItems();data.timerole=selections[0].did;controller.setTimeRole(this.data);}else{selections=this.timebrowser.getSelectedItems();tempSelections=selections.slice();derivedAttrFlag=0;for(i=0,len=tempSelections.length;i<len;i++){if(tempSelections[i].did!=="all"){derivedAttrFlag=derivedAttrFlag|tempSelections[i].did;}}data.der=derivedAttrFlag;controller.setTimeDimension(this.data);}this._close();},onCancel:function(){this._close();},children:[{scriptClass:"mstrmojo.Label",slot:"titleNode",alias:"title"},{scriptClass:"mstrmojo.DropDownList",slot:"titleNode",alias:"multiFormList",idx:0,onvalueChange:function onvalueChange(){var data=this.parent.data.subColumns[this.value];this.parent.getMode(data);}},{scriptClass:"mstrmojo.CheckList",slot:"contentNode",alias:"timebrowser",cssClass:"mstrmojo-di-time-tree",visible:false,onchange:function(evt){var added=evt.added,removed=evt.removed,items,length,idx,selectedIndices;if(_skip){_skip=false;return ;}if(added){items=this.items;length=items.length;selectedIndices=this.selectedIndices;if(added[0]===0){for(idx=0;idx<length;idx++){if(!selectedIndices[idx]){_skip=true;this.setSelectedItems(items,true);break;}}}else{for(idx=1;idx<length;idx++){if(!selectedIndices[idx]){return ;}}if(!selectedIndices[0]){_skip=true;this.toggleSelect(0,false);}}}if(removed){if(removed[0]===0){this.clearSelect();}else{if(this.selectedIndices[0]){_skip=true;this.toggleSelect(0,false);}}}},onRender:function(){var parent=this.parent,data=parent.data,items=this.items,selections=[],i,derivedAttrFlag,len;if(data.isMultiForm){data=data.subColumns[parent.multiFormList.value];}derivedAttrFlag=data.der;for(i=0,len=items.length;i<len;i++){if(derivedAttrFlag&items[i].did){selections.push(items[i]);}}if(len===selections.length+1){selections.push(items[0]);}if(selections.length){this.setSelectedItems(selections,true);}}},{scriptClass:"mstrmojo.RadioList",slot:"contentNode",alias:"timeRoleList",cssClass:"mstrmojo-di-time-tree",visible:false,onRender:function onRender(){var parent=this.parent,data=parent.data;if(data.isMultiForm){data=data.subColumns[parent.multiFormList.value];}var timerole=data.timerole,items=this.items,selections=[],i,len;for(i=0,len=items.length;i<len;i++){if(timerole===items[i].did){selections.push(items[i]);break;}}if(selections.length){this.setSelectedItems(selections,true);}}}]});}());