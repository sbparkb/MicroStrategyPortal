(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.dom");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash;var pageInstanceRef={pages:[],refCnt:[]};var pagePool={};var cnt=0;function getPagePoolKey(){return cnt++;}function addRef(pageInstance){if(!pageInstance){return ;}var pages=pageInstanceRef.pages;var idx=$ARR.indexOf(pages,pageInstance);if(idx!==-1){pageInstanceRef.refCnt[idx]=pageInstanceRef.refCnt[idx]+1;}else{pageInstanceRef.pages.push(pageInstance);pageInstanceRef.refCnt.push(1);}}function release(pageInstance){if(!pageInstance){return ;}var pages=pageInstanceRef.pages;var idx=$ARR.indexOf(pages,pageInstance);var page,key;if(idx!==-1){pageInstanceRef.refCnt[idx]=pageInstanceRef.refCnt[idx]-1;if(pageInstanceRef.refCnt[idx]===0){page=pageInstanceRef.pages[idx];pageInstanceRef.pages.splice(idx,1);pageInstanceRef.refCnt.splice(idx,1);for(key in pagePool){if(page===pagePool[key].page){pagePool[key].page=null;}}page.destroy();}}}mstrmojo.DI.DIPagePoolSlot=mstrmojo.declare(mstrmojo.Obj,null,{key:null,get:function(){return pagePool[this.key].page||null;},set:function(pageInstance){var key=this.key;pagePool[key].page=pageInstance;pageInstance.pageSlotKey=key;},getConfig:function(){return pagePool[this.key].config||null;},setConfig:function(pageConfig){var key=this.key;pagePool[key].config=pageConfig;},postCreate:function(){if(this._super){this._super();}var key=this.key;if(key&&!pagePool[key]){pagePool[key]={slot:this,page:null};}},destroy:function(params){var key=this.key;if(key){delete pagePool[key];}if(this._super){this._super(params);}}});mstrmojo.DI.DINavigationController=mstrmojo.declare(mstrmojo.Obj,null,{routes:{},postCreate:function(){this.routes={};this.pagePool=pagePool;this.pageInstanceRef=pageInstanceRef;},destroy:function(ignoreDom){$HASH.forEach(pagePool,function(item){if(item.page&&!item.page.destroyed){item.page.destroy();}});this.routes={};pagePool={};pageInstanceRef={pages:[],refCnt:[]};if(this._super){this._super(ignoreDom);}},addRoute:function(key){if(this.routes[key]){return false;}this.routes[key]=[];return true;},deleteRoute:function(key){var route=this.routes[key];var i,page;if(route){for(i=route.length-1;i>-1;i--){page=route[i].slot.get();route[i].slot.destroy();release(page);}}delete this.routes[key];},getPreviousPageSlot:function(key,currentPageType){var route=this.getRoute(key);var i,item=null;var curIdx=-1;if(route){for(i=0;i<route.length;i++){if(route[i].type===currentPageType){curIdx=i;break;}}}if(curIdx>0){item=route[curIdx-1].slot;}return item;},getNextPageSlot:function(key,currentPageType){var route=this.getRoute(key);var i,item=null;var curIdx=-1;if(route){for(i=0;i<route.length;i++){if(route[i].type===currentPageType){curIdx=i;break;}}}if(curIdx+1<route.length){item=route[curIdx+1].slot;}return item;},getRoute:function(key){return this.routes[key];},pushPage:function(key,pageType,pageInstance,pageSlot,pageConfig){var route;var poolKey;var slot;if(!this.getRoute(key)){this.addRoute(key);}route=this.getRoute(key);if(!pageSlot){poolKey=getPagePoolKey().toString();slot=this.getPageSlot(poolKey);}else{slot=pageSlot;}if(pageInstance){slot.set(pageInstance);addRef(slot.get());}if(pageConfig){slot.setConfig(pageConfig);}route.push({type:pageType,slot:slot});return slot;},getCurrentPageSlot:function(key,pageType){var route=this.getRoute(key);var ret=null;var i;if(route){for(i=0;i<route.length;i++){if(route[i].type===pageType){ret=route[i].slot;}}}return ret;},getPageSlot:function(key){var slot=null;var defKey=getPagePoolKey().toString();key=key||defKey;slot=pagePool[key]&&pagePool[key].slot;if(!slot){slot=new mstrmojo.DI.DIPagePoolSlot({key:key});}return slot;}});}());