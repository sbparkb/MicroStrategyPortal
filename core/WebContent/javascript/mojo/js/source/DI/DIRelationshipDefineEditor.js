(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.ui.Pulldown","mstrmojo.DI.DIModel","mstrmojo.DI.DIConstants");mstrmojo.requiresDescs(118,221,5186,6389,12877,12878,12879,12880,12881,13783,13784,13785,13851,12706,14678,14679,14680,14689,14716);var RELATIONSHIP_ITEM_CSS_CLASS="rs-item";var $A=mstrmojo.array,$H=mstrmojo.hash,$D=mstrmojo.dom,$C=mstrmojo.css,$WIDGET=mstrmojo.Widget,constants=mstrmojo.DI.DIConstants;var adjustPopupWidget=function(){var popupWidget=this.getPopupWidget(),pos;pos=$D.position(this.getPopupHostNode(),true);popupWidget.popupConfig.position=pos;};function saveRelationshipChanges(tableID,origRSs,RSs,callback){var tpEnum=constants.relationshipEditType;var rsTypeEnum=constants.ERType;var tp=[],paid=[],atid=[],ert=[],rstp=[];var cmds=[];var i,origItem,item,hasInvalidRS,errMsg;var origLen=origRSs&&origRSs.length,len=RSs&&RSs.length;var rsEditSortFn=function(cmd1,cmd2){if(cmd1.tp===cmd2.tp){return 0;}if(cmd1.tp===tpEnum.remove){return -1;}if(cmd1.tp===tpEnum.create){return cmd2.tp===tpEnum.remove?1:-1;}if(cmd1.tp===tpEnum.changeERType){return 1;}};if(len<origLen){return ;}for(i=0;i<len;i++){origItem=i<origLen?origRSs[i]:null;item=RSs[i];if(item.deleted){if(origItem){cmds.push({tp:tpEnum.remove,paid:origItem.parent.id,atid:origItem.child.id,ert:rsTypeEnum.reserved,rstp:constants.RSType.reserved});}}else{if(origItem){if(origItem.parent.id===item.parent.id&&origItem.child.id===item.child.id){if(origItem.ert!==item.ert){cmds.push({tp:tpEnum.changeERType,paid:item.parent.id,atid:item.child.id,ert:item.ert,rstp:item.type});}else{if(origItem.type!==item.type){cmds.push({tp:tpEnum.changeERType,paid:item.parent.id,atid:item.child.id,ert:item.ert,rstp:item.type});}}}else{cmds.push({tp:tpEnum.remove,paid:origItem.parent.id,atid:origItem.child.id,ert:rsTypeEnum.reserved,rstp:constants.RSType.reserved});cmds.push({tp:tpEnum.create,paid:item.parent.id,atid:item.child.id,ert:item.ert,rstp:item.type});}}else{if(item.parent&&item.parent.id&&item.child&&item.child.id){cmds.push({tp:tpEnum.create,paid:item.parent.id,atid:item.child.id,ert:item.ert,rstp:item.type});}}}}cmds.sort(rsEditSortFn);hasInvalidRS=false;$A.forEach(cmds,function(cmd){if(cmd.paid===cmd.atid){hasInvalidRS=true;errMsg=mstrmojo.desc(13851,"Cannot define the relationship between the same attributes.");}tp.push(cmd.tp);paid.push(cmd.paid);atid.push(cmd.atid);ert.push(cmd.ert);rstp.push(cmd.rstp);});if(hasInvalidRS){if(callback.failure){callback.failure({message:errMsg});}if(callback&&callback.complete){callback.complete();}return ;}if(cmds.length>0){mstrApp.getRootController().editRelationship([tableID],{tp:tp.join(),paid:paid.join(),atid:atid.join(),ert:ert.join(),rstp:rstp.join()},callback);}else{if(callback&&callback.success){callback.success();}if(callback&&callback.complete){callback.complete();}}}function checkRelationship(items,maps){var valid=true;$A.forEach(items,function(data){var idx,parent,child;if(data){idx=$A.find(maps,"id",data.parent.id);if(idx>=0){parent=maps[idx];}idx=$A.find(maps,"id",data.child.id);if(idx>=0){child=maps[idx];}if(parent&&child){if(parent.id===child.id){valid=false;}else{if(parent.ipa&&child.ipa){valid=false;}}}if(!valid){return false;}}});return valid;}mstrmojo.DI.DIRelationshipItem=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.DI.DIRelationshipItem",markupString:'<div id="{@id}" class="mstrmojo-Box mstrmojo-di-relationship-item cf {@cssClass}" style="{@cssText}"><div class="rsitem-icon status{@status}" tooltip="{@tooltip}"></div><div class="rsitem-toggle {@toggle}"></div><div class="rsitem-pulldown parent"></div><div class="rsitem-pulldown child"></div><div class="rsitem-pulldown type"></div><div class="rsitem-button"></div></div>',markupSlots:{containerNode:function(){return this.domNode;},toggleButtonNode:function(){return this.domNode.children[1];},parentPulldownNode:function(){return this.domNode.children[2];},childPulldownNode:function(){return this.domNode.children[3];},typePulldownNode:function(){return this.domNode.children[4];},buttonNode:function(){return this.domNode.children[5];}},markupMethods:{onvisibleChange:$WIDGET.visibleMarkupMethod,onheightChange:$WIDGET.heightMarkupMethod,onwidthChange:$WIDGET.widthMarkupMethod,onstatusChange:function(){var sn=this.domNode.firstChild;sn.className="rsitem-icon status"+this.status;},ontooltipChange:function(){var sn=this.domNode.firstChild;sn.setAttribute("tooltip",this.tooltip);}},onstatusChange:function(){var data=this.data;data.status=this.status;},ontooltipChange:function(){var data=this.data;data.tooltip=this.tooltip;},ontypeChange:function(evt){var n=this.toggleButtonNode,bToggle=evt.value===constants.RSType.defined;if(this.hasRendered&&n){$C.toggleClass(n,"toggle",bToggle);if($D.isIE9||$D.isIE8){n.firstChild.firstChild.style.display=bToggle?"none":"block";}}},setRSType:function(type){var data=this.data;if(type!==data.type){data.type=type;this.set("type",type);this.parent.raiseEvent({name:"change",src:this});}},postBuildRendering:function(){var toggle=this.toggle,n=this.toggleButtonNode;if(this._super){this._super();}if(toggle==="toggle"&&($D.isIE9||$D.isIE8)){n.firstChild.firstChild.style.display="none";}},children:[{slot:"toggleButtonNode",scriptClass:"mstrmojo.Box",markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" style="{@cssText}" mstrAttach:click><div class="front"></div><div class="back"></div></div>',onclick:function(){var data=this.parent.data,type=data&&data.type,bChanged=false;switch(type){case constants.RSType.auto:data.type=constants.RSType.defined;bChanged=true;break;case constants.RSType.defined:data.type=constants.RSType.auto;bChanged=true;break;}if(bChanged){this.parent.set("type",data.type);this.parent.raiseEvent({name:"change",src:this});}}},{slot:"parentPulldownNode",scriptClass:"mstrmojo.ui.Pulldown",isHostedWithin:false,hostedCSSClass:"mstrmojo-di-relationship-item-hosted",bindings:{items:"this.parent.maps"},preBuildRendering:function(){if(this._super){this._super();}if(this.parent.data&&this.parent.data.parent){this.selectItemByField("id",this.parent.data.parent.id);}},postselectedIndexChange:function(evt){var newValue=evt.value,oldValue=evt.valueWas,items=this.items,data=this.parent.data;if(newValue!==oldValue){if(items[newValue]){this.set("title",items[newValue].n);}data.parent.id=items[newValue].id;if(this.parent.hasRendered){data.type=constants.RSType.defined;this.parent.set("type",data.type);this.parent.raiseEvent({name:"change",src:this});}}}},{slot:"childPulldownNode",scriptClass:"mstrmojo.ui.Pulldown",isHostedWithin:false,hostedCSSClass:"mstrmojo-di-relationship-item-hosted",bindings:{items:"this.parent.maps"},preBuildRendering:function(){if(this._super){this._super();}if(this.parent.data&&this.parent.data.child){this.selectItemByField("id",this.parent.data.child.id);}},postselectedIndexChange:function(evt){var newValue=evt.value,oldValue=evt.valueWas,items=this.items,data=this.parent.data;if(newValue!==oldValue){if(items[newValue]){this.set("title",items[newValue].n);}data.child.id=items[newValue].id;if(this.parent.hasRendered){data.type=constants.RSType.defined;this.parent.set("type",data.type);this.parent.raiseEvent({name:"change",src:this});}}}},{slot:"typePulldownNode",scriptClass:"mstrmojo.ui.Pulldown",isHostedWithin:false,hostedCSSClass:"mstrmojo-di-relationship-item-hosted ertype",preBuildRendering:function(){if(this._super){this._super();}if(this.parent.data){this.selectItemByField("id",this.parent.data.ert);}},postselectedIndexChange:function(evt){var newValue=evt.value,oldValue=evt.valueWas,items=this.items,data=this.parent.data;if(newValue!==oldValue){data.ert=items[newValue].id;if(this.parent.hasRendered){data.type=constants.RSType.defined;this.parent.set("type",data.type);this.parent.raiseEvent({name:"change",src:this});}}},items:[{n:mstrmojo.desc(13783,"One to One"),id:constants.ERType.ERType11},{n:mstrmojo.desc(13784,"One to Many"),id:constants.ERType.ERType1M},{n:mstrmojo.desc(13785,"Many to Many"),id:constants.ERType.ERTypeMM}]},{slot:"buttonNode",scriptClass:"mstrmojo.Button",onclick:function(){this.parent.raiseEvent({name:"delete",src:this});}}]});mstrmojo.DI.DIRelationshipDefineEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.DIRelationshipDefineEditor",cssClass:"mstrmojo-di-relationship-define",title:mstrmojo.desc(12706,"Define Relations"),origItems:null,help:"attribute_relationships.htm",items:null,onOpen:function(){var model=mstrApp.getRootController().model;var id=this.tableID;var items,maps;var source=model.getImportSource(id);if(!source){this.close();}if(source.currentTransformations&&source.currentTransformations.xtab&&source.currentTransformations.xtab.isCrosstab){maps=source.transformedMapping;}else{maps=source.currentMapping;}maps=$A.filter(maps,function(v){return v.tp===12&&v.selected===true;});maps=$H.clone(maps);$A.forEach(maps,function(map){map.n=map.alias;map.cls=map.ipa?"ipa":"";});items=$H.clone(source.relationship);this.set("origItems",source.relationship);this.set("maps",maps);this.set("items",items);},onClose:function(){this.destroy();},ondeleteItem:function(evt){var iw=evt.src;var items=this.items;var valid;iw.data.deleted=true;this.set("items",items);this.hasChanged=true;valid=checkRelationship(this.list.items,this.maps);this.btnHbox.children[0].set("enabled",valid);},onchangeItem:function(evt){var valid=true,data,msg="",idx,parent,child;this.hasChanged=true;data=evt&&evt.src&&evt.src.data;if(data){idx=$A.find(this.maps,"id",data.parent.id);if(idx>=0){parent=this.maps[idx];}idx=$A.find(this.maps,"id",data.child.id);if(idx>=0){child=this.maps[idx];}if(parent&&child){if(parent.id===child.id){valid=false;msg=mstrmojo.desc(13851,"Cannot define the relationship between the same attributes.");}else{if(parent.ipa&&child.ipa){valid=false;msg=mstrmojo.desc(14689,"Do not support two project attributes have relationship here.");}}}}if(!valid){evt.src.set("status",8002);evt.src.set("tooltip",msg);this.btnHbox.children[0].set("enabled",valid);return ;}else{evt.src.set("status","");evt.src.set("tooltip","");}valid=checkRelationship(this.list.items,this.maps);this.btnHbox.children[0].set("enabled",valid);},_set_items:function(n,v){this.items=v;return true;},onitemsChange:function(){var scrollTop=null,isAdd=false,selectedItems;selectedItems=$A.filter(this.items,function(item){return !item.deleted;});if(this.list.items){isAdd=selectedItems.length>this.list.items.length;}if(this.list.domNode){scrollTop=this.list.domNode.scrollTop;}this.list.set("items",selectedItems);if((scrollTop!==null||isAdd)&&this.list.domNode){this.list.domNode.scrollTop=isAdd?this.list.domNode.scrollHeight:scrollTop;}},deleteAllItems:function(){var items;$A.forEach(this.items,function(item){item.deleted=true;});items=this.items;this.set("items",items);this.hasChanged=true;},toggleAllRSType:function(type){var list=this.list,iws=list&&list.ctxtBuilder.itemWidgets;$A.forEach(iws,function(iw){iw.setRSType(type);});},children:[{scriptClass:"mstrmojo.Box",cssClass:"rseditor-header cf",children:[{scriptClass:"mstrmojo.HBox",children:[{scriptClass:"mstrmojo.Label",cssClass:"rseditor-header-label parent",text:mstrmojo.desc(12877,"Parent Attribute")},{scriptClass:"mstrmojo.Label",cssClass:"rseditor-header-label child",text:mstrmojo.desc(12878,"Child Attribute")},{scriptClass:"mstrmojo.Label",cssClass:"rseditor-header-label relation",text:mstrmojo.desc(12879,"Relationship")}]}]},{scriptClass:"mstrmojo.WidgetList",cssClass:"rseditor-list",alias:"list",bindings:{maps:"this.parent.maps"},itemFunction:function(item,idx,list){var cfg={data:item,maps:list.maps,cssClass:RELATIONSHIP_ITEM_CSS_CLASS,idx:idx,parent:list,tooltip:item.tooltip||""};if(item.hasOwnProperty("status")){cfg.status=item.status;if(cfg.status===2){cfg.tooltip=mstrmojo.desc(14716,"Please modify the relationship");}}if(item.hasOwnProperty("type")){cfg.type=item.type;cfg.toggle=cfg.type===constants.RSType.defined?"toggle":"";}var iw=new mstrmojo.DI.DIRelationshipItem(cfg);iw.attachEventListener("delete",list.parent.id,"ondeleteItem");iw.attachEventListener("change",list.parent.id,"onchangeItem");return iw;}},{scriptClass:"mstrmojo.Box",cssClass:"rseditor-box cf",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebHoverButton",iconClass:"addBtn",text:mstrmojo.desc(6389,"Add New"),onclick:function(){var editor=this.parent.parent,items=editor.items;items.push({parent:{},child:{},ert:constants.ERType.ERType1M,type:constants.RSType.defined});editor.set("items",items);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebHoverButton",iconClass:"delBtn",text:mstrmojo.desc(5186,"Delete All"),onclick:function(){this.parent.parent.deleteAllItems();}},{scriptClass:"mstrmojo.Box",cssClass:"sep"},{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"toggleAllPulldown",value:mstrmojo.desc(14678,"Convert All"),items:[{n:mstrmojo.desc(14679,"To user managed"),cls:"defined",id:constants.RSType.defined},{n:mstrmojo.desc(14680,"To auto managed"),cls:"auto",id:constants.RSType.auto}],postselectedIndexChange:function(evt){var editor=this.parent.parent,newValue=evt.value,oldValue=evt.valueWas,items=this.items,v=this.value,me=this,type;this.set("value","");this.set("value",v);if(newValue!==oldValue){type=items[newValue].id;editor.toggleAllRSType(type);}if(newValue>=0){window.setTimeout(function(){me.getPopupList().clearSelect();},0);}}}]}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(118,"Save"),onclick:function(){var editor=this.parent.parent;var callback={success:function(){editor.close();},failure:function(res){mstrApp.getRootController().displayError(mstrmojo.desc(12881,"Cannot save relationships."),false,res.message);}};saveRelationshipChanges(editor.tableID,editor.origItems,editor.items,callback);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var editor=this.parent.parent;editor.close();}}]});}());