(function(){mstrmojo.requiresCls("mstrmojo.DataGrid","mstrmojo.DataRow","mstrmojo.css","mstrmojo.hash","mstrmojo.ui._HasScroller");var $ARR=mstrmojo.array,MAX_LEVEL=2;function getFlatColumns(columns){var newColumns=[],subColumns;$ARR.forEach(columns,function(column){subColumns=column.subColumns;newColumns=newColumns.concat((subColumns&&subColumns.length>1)?subColumns:column);});return newColumns;}function destroySubHeaderWidgets(dataGrid){$ARR.forEach(dataGrid._subHeaderWidgets_,function(headerWidget){headerWidget.destroy(true);});}function preBuildRenderingHook(buildColumnHtmlFunc){var columns=this.columns,out=['<table class="mstrmojo-DataGrid-headerTable" cellspacing="0" cellpadding="0"><tr>'],level=1,subRowOut=["<tr>"],curColumnIndex=0,subColumns,subColumnNum,rowspan,colspan,tdAttributes,columnIndex,colHtml,subHeaderAttributes='w="'+MAX_LEVEL+'"';this._headerWidgets=[];this._subHeaderWidgets=[];$ARR.forEach(columns,function(col){subColumns=col.subColumns;if(subColumns&&subColumns.length>1){level=MAX_LEVEL;return false;}return true;});$ARR.forEach(columns,function(col){subColumns=col.subColumns;subColumnNum=subColumns?subColumns.length:0;if(subColumnNum>1){rowspan=1;colspan=subColumnNum;columnIndex=0;}else{rowspan=level;colspan=1;columnIndex=curColumnIndex++;}tdAttributes='rowspan="'+rowspan+'" colspan="'+colspan+'"';colHtml=buildColumnHtmlFunc.apply(this,[col,columnIndex,tdAttributes]);out.push(colHtml);if(subColumnNum>1){$ARR.forEach(subColumns,function(subColumn){colHtml=buildColumnHtmlFunc.apply(this,[subColumn,curColumnIndex,"",this._subHeaderWidgets,subHeaderAttributes]);subRowOut.push(colHtml);curColumnIndex++;},this);}},this);out.push("</tr>");subRowOut.push("</tr>");$ARR.forEach(subRowOut,function(item){out.push(item);});out.push("</table>");this.headerHtml=out.join("");}function postBuildRenderingHook(buildColGroupFunc,renderHeaderWidgetsFunc){var flatColumns;renderHeaderWidgetsFunc.apply(this);renderHeaderWidgetsFunc.apply(this,["_subHeaderWidgets",MAX_LEVEL.toString()]);flatColumns=getFlatColumns(this.columns);this.titleColGroup=buildColGroupFunc.apply(this,[flatColumns]);}mstrmojo.DI.LevelDataGrid=mstrmojo.declare(mstrmojo.DataGrid,[mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.DI.LevelDataGrid",renderHook:{pre:preBuildRenderingHook,post:postBuildRenderingHook},itemFunction:function itemFunction(item,idx,w){return new mstrmojo.DI.LevelDataGridDataRow({columns:w.columns,data:item,idx:idx,dataGrid:w});},refresh:function refresh(postUnrender){destroySubHeaderWidgets(this);if(this._super){this._super(postUnrender);}},destroy:function destroy(skipCleanup){destroySubHeaderWidgets(this);this._super(skipCleanup);},unrender:function unrender(ignoreDom){$ARR.forEach(this._subHeaderWidgets_,function(subHeaderWidget){if(subHeaderWidget&&subHeaderWidget.hasRendered){subHeaderWidget.unrender(true);}});this._super(ignoreDom);},createColSizeArray:function createColSizeArray(){var headerContainerNode=this.headerContainerNode,headerTable=headerContainerNode&&headerContainerNode.getElementsByTagName("table")[0],columns=headerTable.rows[0].cells,subColumns=headerTable.rows[1]&&headerTable.rows[1].cells,subColumnIndex=0,colSizeArr=[],colspan,i,subColumn;$ARR.forEach(columns,function(column){colspan=column.getAttribute("colspan");colspan=colspan?parseInt(colspan,10):1;if(colspan===1){colSizeArr.push(column.offsetWidth);}else{for(i=0;i<colspan;i++){subColumn=subColumns[subColumnIndex++];colSizeArr.push(subColumn.offsetWidth);}}});return colSizeArr;},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.scrollboxNode;}});mstrmojo.DI.LevelDataGridDataRow=mstrmojo.declare(mstrmojo.DataRow,null,{scriptClass:"mstrmojo.DI.LevelDataGridDataRow",cssClass:"mstrmojo-DataRow",columns:null,init:function init(props){this._super(props);this.columns=getFlatColumns(this.columns);}});}());