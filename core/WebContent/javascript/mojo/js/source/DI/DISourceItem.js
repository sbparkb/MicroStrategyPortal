(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.List","mstrmojo.DI.DIConstants","mstrmojo.dom","mstrmojo.Button","mstrmojo.List","mstrmojo.Table","mstrmojo.DI.DIDatabaseHelper","mstrmojo.warehouse.EnumDatabaseType");mstrmojo.requiresDescs(13191,13227,13961,14030,14712);var $H=mstrmojo.hash,constants=mstrmojo.DI.DIConstants,$A=mstrmojo.array,$DOM=mstrmojo.dom,$HELPER=mstrmojo.DI.DIDatabaseHelper,$ENUM_DATABASE_TYPE=mstrmojo.warehouse.EnumDatabaseType;function disableImportOptionByDBType(dbType,srcItem){if(dbType===constants.dbType.PIG){srcItem.showImportOption=false;srcItem.sourceInfo.type=constants.xdaType.ffsql;}}function excludeDB(dbType){if(mstrApp.isSingleTier){if((dbType===1400)&&!(window.FormWrapper.isWin32&&window.FormWrapper.isWin32())){return true;}}return false;}mstrmojo.DI.DISourceItem=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.DI.DISourceItem",pageType:null,icon:null,title:"",n:"",desc:"",enabled:true,containHadoopFile:false,showImportOption:false,dbTypes:null,tooltipOpenDelay:0,useRichTooltip:true,markupString:'<div id="{@id}" class="mstrmojo-di-source-item {@icon}" mstrAttach:click,mouseover,mouseout><div class="mstrmojo-di-source-name"><span class="mstrmojo-di-source-name-span">{@n}</span></div><div class="mstrmojo-di-source-below"><div class="mstrmojo-di-Icons medium-{@icon}"></div><div class="mstrmojo-di-source-link"></div><div class="mstrmojo-di-source-desc">{@desc}</div><div class="mstrmojo-di-source-pulldown mstrmojo-di-source-link-paddingtop"></div><div class="mstrmojo-di-source-link mstrmojo-di-source-link-paddingtop"></div></div></div>',markupSlots:{nameNode:function(){return this.domNode.firstChild;},iconNode:function(){return this.domNode.children[1].children[0];},firstLinkNode:function(){return this.domNode.children[1].children[1];},descNode:function(){return this.domNode.children[1].children[2];},pulldownNode:function(){return this.domNode.children[1].children[3];},lastLinkNode:function(){return this.domNode.children[1].lastChild;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},init:function init(props){this._super(props);var model=mstrApp.getRootController().model;if(this.dbObjectsDisplayOptions){if(model.supportDBObjects&&model.supportDBObjects.supportDBType){this.filterDB();}else{model.attachEventListener("dbTypeFetched",this.id,"filterDB");}}},filterDB:function filterDB(evt){var model,dbTypes,uniqDBTypes;if(!mstrApp.getRootController){return ;}if(!evt||!evt.src){model=mstrApp.getRootController().model;}else{model=evt.src;}dbTypes=model.supportDBObjects&&model.supportDBObjects.supportDBType;dbTypes=$HELPER.filterDBByDispOption(dbTypes,this.dbObjectsDisplayOptions,this.dbIdExcludeFilter);dbTypes=$HELPER.filterDBByAdminConfig(dbTypes,this.dbRolesAdminConfig);this.dbTypes=dbTypes;this.dbIds=$HELPER.getDBIds(dbTypes);if(this.isWaitingDBTypes){mstrApp.hideProgress();this.onclick(this.clickEvent,this.clickEventTarget);}if(!mstrApp.isSingleTier&&this.sid===constants.sourceItemType.database&&!mstrApp.dbRoles){uniqDBTypes=$HELPER.getUniqueDBTypes(dbTypes);mstrApp.getRootController().getDBRoles(uniqDBTypes,this.dbRolesAdminConfig);}},handleSourceSelect:function handleSourceSelect(selectedItem,subItem){var $this=this,defaultConfig,dbTypes=[],dbItems=[],config,controller=mstrApp.getRootController(),model=controller.model,isFilterDDA,isXquery=!!subItem&&subItem.dbType===3000,sourceInfo;if(!mstrApp.isSingleTier&&this.sid===constants.sourceItemType.database&&mstrApp.dbRoles){if(!$H.equals(mstrApp.dbRolesAdminConfig,this.dbRolesAdminConfig||[])){mstrApp.dbRoles=undefined;}}if(selectedItem.dbIds){dbTypes=(subItem&&subItem.dbType)?[subItem.dbType]:$HELPER.getUniqueDBTypes(selectedItem.dbTypes);isFilterDDA=$this.parent.parent.isFilterDDA;$A.forEach(dbTypes,function(dbType){if(!isFilterDDA||model.canAddToDDACube(selectedItem.sourceInfo.subtype,dbType)){dbItems.push(dbType);}});mstrApp.dbIds=(subItem&&subItem.id)?[].concat(subItem.id):selectedItem.dbIds;mstrApp.dbTypes=dbItems;mstrApp.supportDBObjects=mstrApp.getRootController().model.supportDBObjects;mstrApp.dbObjectsDisplayOptions=this.dbObjectsDisplayOptions;mstrApp.dbRolesVersionExcludeFilter=this.excludeDBVFilter||[];}if(selectedItem.showImportOption){defaultConfig={onOK:function(item){var sourceInfoClone=mstrmojo.hash.clone($this.sourceInfo);var sourceInfo=mstrmojo.hash.copy(item.sourceInfo,sourceInfoClone);$this.openSelectedSource(item.pageType,sourceInfo);}};if(selectedItem.sourceInfo.type===constants.sourceType.googleBigQuery){config={isODBC:true,srcInfo:selectedItem.sourceInfo};}else{if(selectedItem.sourceInfo.type===constants.xdaType.querybuilder){if(selectedItem.isSAPHanaDDA){config={isSAPHanaDDA:true};}else{config=(subItem&&subItem.dbType===$ENUM_DATABASE_TYPE.SAPHana)?{isSAPHana:true}:{isODBC:true};config.hasNonSAPHana=selectedItem.hasNonSAPHana;if(isXquery){sourceInfo={sourceType:constants.sourceType.querybuilder,type:constants.xdaType.ffsql};controller.showPage(constants.pageType.database,sourceInfo);return ;}}}else{if(selectedItem.enableHadoopOption){config=$H.copy(defaultConfig,{isContainHadoop:true});}else{config=$H.copy(defaultConfig,{isContainHadoop:false});}}}mstrApp.getRootController().showDialog(constants.dialogType.qbImportOptionDialog,config);}else{$this.openSelectedSource();}},openSelectedSource:function(pageType,sourceInfo){var controller=mstrApp.getRootController(),slot;if(this.enabled){if(mstrApp.isSingleTier&&this.checkConectivity&&window.FormWrapper.testInternetConnection()!==0){var errorMessage=mstrmojo.desc(13961,"No Internet connection. You can configure an Internet proxy through your computer's #."),replaceStr='<a href="" onclick="mstrApp.getRootController().dialogController.close(mstrmojo.DI.DIConstants.dialogType.errorDialog);window.setTimeout(function(){window.FormWrapper.showProxyEditor();},100);return false;">'+mstrmojo.desc(14125,"settings")+"</a>";errorMessage=errorMessage.replace("#",replaceStr)+".";controller.displayError(errorMessage,false,"",null,mstrmojo.desc(11812,"Notification"));return ;}slot=mstrApp.getRootController().navigationController.getPageSlot();slot.setConfig({properties:{operationMode:constants.operationMode.create}});controller.showPage(pageType===undefined?this.pageType:pageType,sourceInfo===undefined?this.sourceInfo:sourceInfo,slot);}},onclick:function(evt,clickEventTarget){var evtTarget=evt.getTarget();if(!evtTarget){evtTarget=clickEventTarget;}var target=$DOM.findWidget(evtTarget);if(!target){return ;}var dbList=this.dbList;if(evt.e&&evt.e.button===1){evt.cancel();return ;}if(dbList){if(this.waitDbTypes&&!this.dbTypes){this.isWaitingDBTypes=true;this.clickEvent=evt;this.clickEventTarget=evt.e&&(evt.e.target||evt.e.srcElement);mstrApp.showProgress();return ;}if(target===dbList||target===dbList.list){return ;}}this.handleSourceSelect(target);},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}if(!this.enabled){mstrmojo.css.addClass(this.domNode,"disabled");}else{mstrmojo.css.addClass(this.domNode,"enabled");}},updateTooltipConfig:function(){var pos=$DOM.position(this.nameNode);this.set("richTooltip",{cssClass:"vi-regular A-center vi-tooltip-V",top:Math.max(pos.y,0),left:Math.max(pos.x+pos.w/2,0),posType:mstrmojo.tooltip.POS_BOTTOMCENTER,content:this.title});},postCreate:function(){if(this.showDBList){var $this=this;var item;var dbPulldown={scriptClass:"mstrmojo.ui.Pulldown",slot:"pulldownNode",alias:"dbList",isHostedWithin:true,value:mstrmojo.desc(14030,"All Datasets"),onitemSelected:function onvalueChange(item){var dbIds=mstrApp.dbIds=[],dbTypes=mstrApp.dbTypes=[],dbVersions=mstrApp.dbVersions=[];$A.forEach(item.dbVersions,function(dbv){dbVersions.push(dbv.v);});dbIds=dbIds.concat(item.id);dbTypes.push(item.dbType);mstrApp.supportDBObjects=mstrApp.getRootController().model.supportDBObjects;mstrApp.dbVersions=[];disableImportOptionByDBType(item.dbType,$this);$this.enableHadoopOption=false;$this.handleSourceSelect($this,item);},onPopupWidgetOpened:function(){if(this.items){return ;}var model=mstrApp.getRootController().model;if(!model.supportDBObjects.supportDBType){model.attachEventListener("dbTypeFetched",this.id,"setDBList");mstrApp.showProgress();}else{this.setDBList();}},setDBList:function(){var model=mstrApp.getRootController().model,dbItems=[],hasHanaSingleTable,hasTable,isFilterDDA=this.parent.parent.parent.isFilterDDA;if(this.parent.dbTypes){$H.forEach(model.importSources,function(source){hasTable=true;if(source.subtype===constants.sourceSubtype.hanaSingleTable){hasHanaSingleTable=true;return false;}});if(hasHanaSingleTable){$A.forEach(this.parent.dbTypes,function(dbObject){if(dbObject.dbType===$ENUM_DATABASE_TYPE.SAPHana){dbItems.push(dbObject);}});}else{item=this.parent;$A.forEach(item.dbTypes,function(dbObject){if(!excludeDB(dbObject.dbType)&&(!isFilterDDA||model.canAddToDDACube(item.sourceInfo.subtype,dbObject.dbType))){dbItems.push(dbObject);}});}}else{item=this.parent;$A.forEach(model.supportDBObjects.supportDBType,function(dbObject){if(!excludeDB(dbObject.dbType)&&(!isFilterDDA||model.canAddToDDACube(item.sourceInfo.subtype,dbObject.dbType))){dbItems.push(dbObject);}});}this.set("items",dbItems);this.refresh();mstrApp.hideProgress();var popupList=this.children[0],eventName="mousewheel";if(popupList.domNode){if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){eventName="DOMMouseScroll";}$DOM.attachEvent(popupList.domNode.children[0],eventName,function(e){var evt=window.event||e;var delta=evt.detail?evt.detail*(-120):evt.wheelDelta;if((delta<0&&(this.scrollTop+this.clientHeight)===this.scrollHeight)||(delta>0&&this.scrollTop===0)){$DOM.preventDefault(window,e);}});}}};this.addChildren(dbPulldown);}if(this.containHadoopFile&&!mstrApp.isSingleTier){var browseHadoopFilesButton={scriptClass:"mstrmojo.Button",slot:"firstLinkNode",alias:"hadoopFiles",text:mstrmojo.desc(13191,"Browse Hadoop Files"),onclick:function onclick(evt){$DOM.stopPropogation(evt.hWin,evt.e);var controller=mstrApp.getRootController();controller.showPage(constants.pageType.hadoop,1);}};this.addChildren(browseHadoopFilesButton);}if(this.showOAuthLink&&(mstrApp.diParams.SetOAuthParams||mstrApp.isSingleTier)){var setOAuthButton={scriptClass:"mstrmojo.Button",slot:"lastLinkNode",alias:"setOAuth",text:mstrmojo.desc(13227,"Set OAuth Parameters"),onclick:function onclick(event){event.cancel();var model=mstrApp.getRootController().model;var externalSources=model.externalSources[this.parent.sourceInfo.type];var sourceItem=this.parent;mstrApp.getRootController().openOAuthParaDialog(event,{sourceName:externalSources.name,did:externalSources.dbRoleID,isOneTier:!!mstrApp.isSingleTier,sourceItem:sourceItem});}};this.addChildren(setOAuthButton);}if(this.showWhiteListLink&&!mstrApp.isSingleTier&&mstrApp.diParams.configureProjectBasic){var setWhiteList={scriptClass:"mstrmojo.Button",slot:"lastLinkNode",alias:"setWhiteList",text:mstrmojo.desc(14712,"Set Allowed URLs"),onclick:function onclick(event){event.cancel();var sourceItem=this.parent;mstrApp.getRootController().openWhiteListDialog(event,{isOneTier:!!mstrApp.isSingleTier,sourceItem:sourceItem});}};this.addChildren(setWhiteList);}}});}());