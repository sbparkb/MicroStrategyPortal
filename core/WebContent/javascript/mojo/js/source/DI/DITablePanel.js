(function(){mstrmojo.requiresCls("mstrmojo.DI.DIMappingTableContainer","mstrmojo.qb.DBTableLinker","mstrmojo.DI.DIConstants","mstrmojo._HasLayout","mstrmojo.dom","mstrmojo.array","mstrmojo.DI.DILabel");mstrmojo.requiresDescs(531,12730);var constants=mstrmojo.DI.DIConstants,SUPPORTS_CANVAS,CANVAS_WIDTH=1500,CANVAS_HEIGHT=590,SAPHANA_DBTYPE=4000,$A=mstrmojo.array,$D=mstrmojo.dom,$CSS=mstrmojo.css;function createVMLFrameElement(){var vmlRectangle=document.createElement("v:rect"),vmlRectangleStyle=vmlRectangle.style;vmlRectangle.setAttribute("id","vmlFrame");vmlRectangle.setAttribute("stroke","true");vmlRectangle.setAttribute("strokecolor","red");vmlRectangleStyle.width=this.width;vmlRectangleStyle.height=this.height;vmlRectangleStyle.zindex="-1";document.getElementById("vmlCanvas").appendChild(vmlRectangle);}function clearHighLightCanvas(){if(this.highlight){this.highlight.clearRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);this.hl_link=null;this.highlight.beginPath();}}function drawLine(x1,y1,x2,y2){if(SUPPORTS_CANVAS){var context=this.context=this.context||this.canvas.getContext("2d");context.lineJoin="round";context.lineCap="round";context.moveTo(x1,y1);context.lineTo(x2,y2);}else{var line=document.createElement("v:line");line.setAttribute("from",[x1," ",y1].join(""));line.setAttribute("to",[x2," ",y2].join(""));document.getElementById("vmlCanvas").appendChild(line);}}mstrmojo.DI.DITablePanel=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.DI.DITablePanel",markupString:'<div id="{@id}" class="mstrmojo-di-DBTablePanel cf {@cssClass}" ><div class="button-node"></div><div class="container-node"></div></div>',markupSlots:{containerNode:function(){return this.domNode.children[1];},buttonNode:function(){return this.domNode.children[0];}},setDimensions:function setDimensions(h,w){var width=parseInt(w,10);if(!this.layoutConfig){this.layoutConfig={h:{},w:{}};}this.layoutConfig.h.buttonNode="100%";this.layoutConfig.h.containerNode="100%";this.layoutConfig.w.buttonNode="220px";this.layoutConfig.w.containerNode=(width-220-30)+"px";if(this._super){this._super(h,w);}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},tableContainer:undefined,joinInfos:[],children:[{scriptClass:"mstrmojo.qb.DBTableLinker",alias:"linker",clearLinks:function clearLinks(){if(SUPPORTS_CANVAS){var context=this.context;if(context&&context.clearRect){context.clearRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);context.beginPath();}}else{var canvas=document.getElementById("vmlCanvas");if(canvas&&canvas.hasChildNodes()){while(canvas.childNodes.length>=1){canvas.removeChild(canvas.firstChild);}createVMLFrameElement.call(this);}}clearHighLightCanvas.call(this);},drawLink:function(sourceRowContainer,sourceTableWidget,targetRowContainer,targetTableWidget){var canvas=this.canvas;SUPPORTS_CANVAS=canvas&&canvas.getContext&&canvas.getContext("2d");var canvasPosition=mstrmojo.dom.position(this.domNode),MARGIN=8,sourcePosY,targetPosY,sourceTablePos,targetTablePos,sourceX,sourceY,targetX,targetY,sourceTableTopY,targetTableTopY,sourceTableBottomY,targetTableBottomY,isSourceLeftToTarget,padding;sourceTablePos=$D.position(sourceTableWidget.domNode);targetTablePos=$D.position(targetTableWidget.domNode);sourceTableTopY=sourceTablePos.y+sourceTableWidget.headerNode.clientHeight*1.5-canvasPosition.y;targetTableTopY=targetTablePos.y+targetTableWidget.headerNode.clientHeight*1.5-canvasPosition.y;sourceTableBottomY=sourceTablePos.y+sourceTableWidget.domNode.clientHeight-canvasPosition.y;targetTableBottomY=targetTablePos.y+targetTableWidget.domNode.clientHeight-canvasPosition.y;sourcePosY=$D.position(sourceRowContainer).y;targetPosY=$D.position(targetRowContainer).y;sourceX=sourceTablePos.x+sourceTablePos.w-canvasPosition.x;sourceY=Math.max(sourcePosY+0.5*sourceRowContainer.clientHeight-canvasPosition.y,sourceTableTopY);targetX=targetTablePos.x-canvasPosition.x;targetY=Math.max(targetPosY+0.5*targetRowContainer.clientHeight-canvasPosition.y,targetTableTopY);isSourceLeftToTarget=sourceX<targetX;padding=isSourceLeftToTarget?MARGIN:-MARGIN;sourceX-=isSourceLeftToTarget?0:sourceTablePos.w;targetX+=isSourceLeftToTarget?0:targetTablePos.w;if(sourceTableBottomY-118>=sourceY&&targetTableBottomY-118>=targetY){drawLine.call(this,sourceX,sourceY,sourceX+padding,sourceY);drawLine.call(this,sourceX+padding,sourceY,targetX-padding,targetY);drawLine.call(this,targetX-padding,targetY,targetX,targetY);}else{if(sourceTableBottomY-118<sourceY&&targetTableBottomY-118>targetY){drawLine.call(this,sourceX,sourceTableTopY,sourceX+padding,sourceTableTopY);drawLine.call(this,sourceX+padding,sourceTableTopY,targetX-padding,targetY);drawLine.call(this,targetX-padding,targetY,targetX,targetY);}else{if(sourceTableBottomY-118>sourceY&&targetTableBottomY-118<targetY){drawLine.call(this,sourceX,sourceY,sourceX+padding,sourceY);drawLine.call(this,sourceX+padding,sourceY,targetX-padding,targetTableTopY);drawLine.call(this,targetX-padding,targetTableTopY,targetX,targetTableTopY);}}}if(SUPPORTS_CANVAS){this.context.strokeStyle="#999999";this.context.stroke();}},drawLinks:function drawLinks(evt){var joinInfos=this.parent.tableContainer.joinInfos,oid=evt.oid;var me=this,sourceTableWidget,targetTableWidget,sourceRowContainer,targetRowContainer;$A.forEach(joinInfos.joins,function(joinInfo){sourceTableWidget=joinInfo.sourceTable;targetTableWidget=joinInfo.targetTable;if(sourceTableWidget&&targetTableWidget){$A.forEach(joinInfo.links,function(link,index){if(link.source.oid===oid){sourceRowContainer=sourceTableWidget.attrRows.getRowNode("did",link.source.did);targetRowContainer=targetTableWidget.attrRows.getRowNode("did",link.target.did);me.drawLink(sourceRowContainer,sourceTableWidget,targetRowContainer,targetTableWidget,index,joinInfo);return false;}});}});},postCreate:function postCreate(){if(this._super){this._super();}var m=this.parent.parent.model;m.attachEventListener("MappingsFetched",this.id,"clearLinks");},postBuildRendering:function postBuildRendering(){if(mstrmojo.qb.DBTableLinker.prototype.postBuildRendering){mstrmojo.qb.DBTableLinker.prototype.postBuildRendering.call(this);}this.clearLinks();}},{scriptClass:"mstrmojo.DI.DIMappingTableContainer",cssClass:"mstrmojo-di-tableview",alias:"tableContainer"},{slot:"buttonNode",scriptClass:"mstrmojo.Label",alias:"background",cssClass:"plus-background",onclick:function(evt){mstrmojo.dom.stopPropogation(evt.hWin,evt.e);var rootController=mstrApp.getRootController(),model=rootController.model;model.isAddingNewTable=true;rootController.showDialog(constants.dialogType.diPageDialog,{pageType:constants.pageType.dataSelection,left:"200px",top:"115px",cssClass:"mstrmojo-di-homepage-editor"});},bindings:{enabled:function(){return !this.parent.disableNewTables;}},onenabledChange:function(){$CSS.toggleClass(this.domNode,"disable-button",!this.enabled);this.set("enabled",this.enabled);}},{slot:"buttonNode",scriptClass:"mstrmojo.DI.DILabel",cssClass:"button-label button",alias:"background-button",text:mstrmojo.desc(12730,"Add a new table"),onclick:function(evt){mstrmojo.dom.stopPropogation(evt.hWin,evt.e);var rootController=mstrApp.getRootController(),model=rootController.model;model.isAddingNewTable=true;rootController.showDialog(constants.dialogType.diPageDialog,{pageType:constants.pageType.dataSelection,left:"200px",top:"115px",cssClass:"mstrmojo-di-homepage-editor"});},onmouseover:function(){if(this.enabled){$CSS.removeClass(this.domNode,"button-label");$CSS.addClass(this.domNode,"button-label-hover");$CSS.removeClass(this.parent.background.domNode,"plus-background");$CSS.addClass(this.parent.background.domNode,"plus-background-hover");}},onmouseout:function(){if(this.enabled){$CSS.addClass(this.domNode,"button-label");$CSS.removeClass(this.domNode,"button-label-hover");$CSS.addClass(this.parent.background.domNode,"plus-background");$CSS.removeClass(this.parent.background.domNode,"plus-background-hover");}},bindings:{enabled:function(){return !this.parent.disableNewTables;}},onenabledChange:function(){$CSS.toggleClass(this.domNode,"disable-button",!this.enabled);this.set("enabled",this.enabled);}}]});}());