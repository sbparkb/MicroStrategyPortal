(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.Button","mstrmojo.Label","mstrmojo.Pulldown","mstrmojo.ui.Pulldown","mstrmojo.CheckBox","mstrmojo.TextBox","mstrmojo.SREditor","mstrmojo.warehouse.EnumDatabaseType","mstrmojo.DI.DIModel","mstrmojo.DI.DITableStatusList","mstrmojo.locales","mstrmojo.date","mstrmojo.ProgressBar");mstrmojo.requiresDescs(221,773,1302,4311,4364,4996,8473,10160,12761,12762,12763,12764,12765,12766,12767,12769,13005,13028,13029,2502,13257,9242,13274,13444,13882);var $A=mstrmojo.array,$H=mstrmojo.hash,constants=mstrmojo.DI.DIConstants,EVENT_CAN_SAVE_SCHEDULE="canSaveSchedule",EVENT_CAN_START_REFRESH="canStartRefresh",DISABLED_BUTTON_TOOLTIP=mstrmojo.desc(13882,"Please upload the data or unselect the source in order to enable this option.");mstrmojo.DI.DIRepublishScheduleEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.DIRepublishScheduleEditor",cssClass:"mstrmojo-di-scheduleEMMA",title:"",simpleProgressMode:false,showTimeWarningMsg:false,width:"650px",onOpen:function(){var rootModel=mstrApp.getRootController().model,model=this.model,canHasAdv=false,hasBDE=false,tableIDs,source,i;if(this.opened){return ;}this.opened=true;if(this.subEvt){model.detachEventListener(this.subEvt);}if(model.operationMode===constants.operationMode.refresh){this.subEvt=model.attachEventListener("PublishStatusUpdate",this.id,"update");this.set("title",mstrmojo.desc(12761,"Republish ####").replace("####",model.cubeName));this.set("showTimeWarningMsg",!!rootModel.analysisID);this.okButton.set("text",rootModel.analysisID?mstrmojo.desc(13953,"Republish"):mstrmojo.desc(1302,"Finish"));this.okButton.set("visible",true);this.cancelButton.set("visible",true);this.cancelButton.set("text",mstrmojo.desc(221,"Cancel"));}if(model.operationMode===constants.operationMode.subscribe){this.set("help","scheduling_updates_for_Intelligent_Cube_imported_data.htm");this.subEvt=model.attachEventListener("CreateScheduleUpdate",this.id,"update");this.set("title",mstrmojo.desc(12762,"Schedule for ####").replace("####",model.cubeName));this.okButton.set("visible",true);this.okButton.set("text",mstrmojo.desc(1302,"Finish"));this.cancelButton.set("visible",true);this.cancelButton.set("text",mstrmojo.desc(221,"Cancel"));tableIDs=model.getAllTableID();for(i=0;i<tableIDs.length;i++){source=model.getImportSource(tableIDs[i]);if(source.canSetAlternateSource()){canHasAdv=true;}if(source.type===constants.sourceType.hadoop||source.databaseType===mstrmojo.warehouse.EnumDatabaseType.BDE){hasBDE=true;}}if(hasBDE){canHasAdv=false;}this.advLink.set("visible",canHasAdv);}if(model.operationMode===constants.operationMode.create){this.subEvt=model.attachEventListener("CreateScheduleUpdate",this.id,"update");this.set("title",mstrmojo.desc(13028,"### Publishing Status").replace("###",model.cubeName));this.set("width","450px");}if(model.operationMode===constants.operationMode.edit){this.subEvt=model.attachEventListener("PublishStatusUpdate",this.id,"update");this.okButton.set("visible",true);this.okButton.set("text",mstrmojo.desc(1302,"Finish"));this.cancelButton.set("visible",true);this.cancelButton.set("text",mstrmojo.desc(221,"Cancel"));if(rootModel.isDirectDataAccess){this.set("title",mstrmojo.desc(13029,"### Saving Status").replace("###",model.cubeName));}else{this.set("title",mstrmojo.desc(13028,"### Publishing Status").replace("###",model.cubeName));}if(this.simpleProgressMode){this.okButton.set("visible",false);this.cancelButton.set("visible",false);this.progress.updateProgress(50);}}},onClose:function(){var controller=mstrApp.getRootController(),model=this.model,reportId=model.cubeID,editor=this;this.opened=false;if(this.subEvt){model.detachEventListener(this.subEvt);}$A.forEach(model.getAllTableID(),function(id){var source=model.getImportSource(id);source.hasSelectFile=false;source.republishError=undefined;});this.toggleEnable(true);this.statusList.updateStarted=false;this.stopPublishAnimation();this.destroy();if(this.onCompleted&&model.operationMode===constants.operationMode.subscribe&&controller.dialogController.pageZIndex>0){window.setTimeout(function(){if(editor.isSendNow){controller.getCubeQuota({success:function(){controller.scheduleController.updateScheduleAndStatus();}},{showProgress:true,showProgressText:true,progressText:mstrmojo.desc(12955,"Getting information about your cubes...")});}else{controller.scheduleController.updateScheduleAndStatus();}},1);}if(this.onCompleted&&model.operationMode===constants.operationMode.refresh&&controller.dialogController.pageZIndex>0){window.setTimeout(function(){var model,cubesInfo,cubes,idx,dataset={did:reportId};if(mstrApp.refreshMultipleCubes){model=mstrApp.getRootController().getModel();model.publishedDatasets.push(dataset);cubesInfo=model.cubesInfo;cubes=cubesInfo&&cubesInfo.cubes&&cubesInfo.cubes.cube;idx=$A.find(cubes,"cube_id",reportId);if(idx>=0){cubes.splice(idx,1);model.raiseEvent({name:"cubesInfoChange"});}}},1);}if(model.operationMode===constants.operationMode.refresh||model.operationMode===constants.operationMode.subscribe){if(this.onCompleted&&!mstrApp.fromCubesList){mstrApp.getRootController().exitApplication();}else{if(mstrApp.fromCubesList){mstrApp.fromCubesList=false;var cubeID=mstrApp.getRootController().model.cubeID;controller.resetAppforImport();if(!mstrApp.refreshMultipleCubes){controller.getCubeQuota();}else{controller.getCubeInfo(cubeID);}}else{mstrApp.getRootController().cancelApplication();}}}this.toggleEnable(true);this.statusList.updateStarted=false;},onwidthChange:function(){if(this.editorNode){this.editorNode.style.width=this.width||"auto";}},startPublishAnimation:function(){var origTitle=this.title,tickCnt=0,me=this;this._origTitle=origTitle;var animationTick=function(){var txt,dots;if(me._tickTimer===null||!me.titleNode){return ;}switch(tickCnt%3){case 0:dots=".&nbsp;&nbsp;";break;case 1:dots="..&nbsp;";break;case 2:dots="...";break;}txt='<span class="republish-success-label">'+me._origTitle+'</span><span class="republish-success-label color">(&nbsp;'+mstrmojo.desc(4311,"Processing")+dots+"&nbsp)</span>";me.titleNode.innerHTML=txt;tickCnt++;};if(this._tickTimer){return ;}this._tickTimer=window.setInterval(animationTick,1000);},stopPublishAnimation:function(){if(this._tickTimer){window.clearInterval(this._tickTimer);this._tickTimer=null;this.titleNode.innerHTML=this._origTitle;}},update:function(evt){var model=this.model,res,cnt,i,title;this.onCompleted=false;this.onError=false;if(model.operationMode===constants.operationMode.refresh||(model.operationMode===constants.operationMode.edit&&!this.simpleProgressMode)){this.startPublishAnimation();if(evt.completed!==undefined){this.onCompleted=evt.completed;}if(evt.error!==undefined){this.onError=evt.error;}if(this.onCompleted){this.toggleEnable(true);}else{this.toggleEnable(false);}this.cancelButton.set("text",mstrmojo.desc(221,"Cancel"));if(this.onError){this.okButton.set("visible",false);this.cancelButton.set("visible",true);this.sendToHistoryList.set("visible",false);this.stopPublishAnimation();}else{if(this.onCompleted&&!this.onError){this.stopPublishAnimation();title=this.title;if(title.indexOf('<span class="republish-success-label">')<0){title='<span class="republish-success-label">'+title+'</span><span class="republish-success-label color">'+mstrmojo.desc(13444,"( Successfully published to memory )")+"</span>";}this.set("title",title);this.okButton.set("visible",false);this.cancelButton.set("text",mstrmojo.desc(8473,"Done"));this.cancelButton.set("enabled",true);this.sendToHistoryList.set("visible",false);this.cancelButton.set("visible",true);}}if(evt&&evt.reset){this.stopPublishAnimation();this.toggleEnable(true);this.okButton.set("visible",true);this.cancelButton.set("visible",true);this.cancelButton.set("enabled",true);}}if(model.operationMode===constants.operationMode.subscribe){res=evt.res;if(res.subsID){this.okButton.set("visible",false);this.cancelButton.set("visible",true);this.cancelButton.set("text",mstrmojo.desc(8473,"Done"));this.onCompleted=true;}else{this.onError=true;mstrApp.getRootController().displayError(mstrmojo.desc(12763,"Cannot save this subscription."),false,res.message);}}if(model.operationMode===constants.operationMode.edit&&this.simpleProgressMode){i=0;cnt=0;$H.forEach(model.importSources,function(value){cnt++;if(value.status!=="3"&&value.status!=="4"&&value.status!=="6"){this.onCompleted=false;}if(value.status==="4"||value.status==="6"){this.onError=true;}if(value.status==="3"||value.status==="4"||value.status==="6"){i++;}},this);this.progress.updateProgress(50+i*50/cnt);}},toggleEnable:function(bEnable){this.okButton.set("enabled",!!bEnable);},getFileUploader:function(tableID){return this.statusList.getFileUploader(tableID);},checkCanRefresh:function(){return this.statusList.checkCanRefresh();},checkCanChange:function(){return this.statusList.checkCanChange();},children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13005,"Building the cube"),cssClass:"simpleProgress-label",bindings:{visible:"this.parent.simpleProgressMode"}},{alias:"progress",scriptClass:"mstrmojo.ProgressBar",cssClass:"simpleProgress-progress",bindings:{visible:"this.parent.simpleProgressMode"}},{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13956,"Publishing time depends on your dataset. Are you sure you want to republish?"),cssClass:"timewarning-label",bindings:{visible:"this.parent.showTimeWarningMsg"}},{scriptClass:"mstrmojo.DI.DITableStatusList",alias:"statusList",bindings:{model:"this.parent.model",forceFullPublish:"(!this.parent.model.isCubePublished || !this.parent.model.rawDataExistsInAE)",bHasRefreshPolicy:function(){return this.parent.model.operationMode===constants.operationMode.refresh||this.parent.model.operationMode===constants.operationMode.subscribe||this.parent.model.operationMode===constants.operationMode.edit;},visible:"!this.parent.simpleProgressMode"}},{alias:"advLink",scriptClass:"mstrmojo.Label",cssClass:"advanceOpsLink",cssDisplay:"table",text:mstrmojo.desc(12765,"Show Advanced Update Options"),postCreate:function postCreate(){mstrmojo.ImageCheckBox.prototype.postCreate.call(this);var evtConfig={},listConfig=evtConfig[this.id]={};listConfig.isScheduleAdvancedChange=this.handleAdvMode;mstrApp.getRootController().attachDataChangeListeners(evtConfig);},postBuildRendering:function postBuildRendering(){this.set("checked",mstrApp.getRootController().getScheduleController().isAdvState());},handleAdvMode:function handleAdvMode(evt){this.set("checked",evt.value);},bindings:{visible:function(){return(this.parent.model.operationMode===constants.operationMode.subscribe)&&!this.parent.simpleProgressMode;}},onclick:function(){this.set("checked",!this.checked);},oncheckedChange:function(){var bChecked=this.checked,parent=this.parent,statusList=parent.statusList,rootController=mstrApp.getRootController(),scheduleController=rootController.getScheduleController(),cubeID=parent.model.cubeID,callback={success:function success(){var changeList=[],refreshTypes=[];scheduleController.setAdvMode(true);statusList.set("hasIRR",true);mstrmojo.array.forEach(statusList.items,function(item){if(!item.isAll&&item.checked){changeList.push(item.tableID);refreshTypes.push(item.refreshType.toString());}});if(changeList.length>0){scheduleController.createEmmaIRRSourceTables(cubeID,changeList,refreshTypes);}},failure:function failure(res){scheduleController.setAdvMode(false);rootController.displayError(mstrmojo.desc(12766,"Cannot create emma IRR report instance."),false,(res&&res.message)||"");}};statusList.set("bHasSourceFilter",bChecked);statusList.set("bHasAlternateSource",bChecked);statusList.refresh();if(bChecked){this.set("text",mstrmojo.desc(13257,"Hide Advanced Update Options"));parent.set("width","800px");}else{this.set("text",mstrmojo.desc(12765,"Show Advanced Update Options"));parent.editorNode.style.width="650px";parent.set("width","650px");}parent.positionDialog();if(bChecked){if(!rootController.dataService.emmaIRRMessageID){scheduleController.createEmmaIRRReportInstance(rootController.model.IRRid,null,callback);return ;}if(!statusList.hasIRR){statusList.set("hasIRR",true);}scheduleController.setAdvMode(true);scheduleController.setAdvState(true);}else{scheduleController.setAdvState(false);}}},{scriptClass:"mstrmojo.Box",cssClass:"cf firstBox",bindings:{visible:function(){return(this.parent.model.operationMode===constants.operationMode.subscribe)&&!this.parent.simpleProgressMode;}},children:[{scriptClass:"mstrmojo.Label",cssClass:"text",text:mstrmojo.desc(12767,"Choose a Schedule Template: ")},{scriptClass:"mstrmojo.ui.Pulldown",isHostedWithin:false,cssClass:"chooseSchedPulldown",hostedCSSClass:"mstrmojo-di-republishSchedule-chooseSched-hosted",popupToBody:true,popupZIndex:999,defaultSelection:-1,itemIdField:"id",itemField:"n",preBuildRendering:function(){var model=this.parent.parent.model,schedule=model&&model.getSchedule();this.update();if(schedule){schedule.attachEventListener("availableTriggersChange",this.id,"update");schedule.attachEventListener("trgIDChange",this.id,"update");}},update:function(){var model=this.parent.parent.model,schedule=model&&model.getSchedule(),idx=-1;if(schedule){this.set("items",schedule.availableTriggers);if(schedule.trgID){idx=$A.find(schedule.availableTriggers,this.itemIdField,schedule.trgID);}if(idx>=0){this.set("selectedIndex",idx);}}},postselectedIndexChange:function(evt){var model=this.parent.parent.model,schedule=model&&model.getSchedule(),$D=mstrmojo.date,$L=mstrmojo.locales,now,dateJson,dateStr,timeStr,idx;if(!model){return ;}idx=evt.value;if(idx>=0){schedule.set("curTrg",this.items[idx]);schedule.set("trgName",this.items[idx].n);if(!schedule.subsID){now=new Date();dateJson=$D.getDateJson(now);dateStr=$D.formatDateInfo(dateJson,$L.datetime.DATEDISPLAYFORMAT);timeStr=$D.formatTimeInfo(dateJson,$L.datetime.TIMEDISPLAYFORMAT);schedule.set("subsName",model.cubeName+" "+schedule.trgName+" "+dateStr+" "+timeStr);}}}},{scriptClass:"mstrmojo.Button",cssClass:"button new",text:mstrmojo.desc(4996,"new"),onclick:function(){var model=this.parent.parent.model,schedule=model&&model.getSchedule(),editor=this.SREditor,cfg={zIndex:mstrApp.getRootController().dialogController.getNextZIndex()};if(!editor){editor=new mstrmojo.SREditor({cssClass:"mstrmojo-SREditor mstrmojo-di-scheduleEMMA-SREditor",title:mstrmojo.desc(10160,"Select a schedule below"),zIndex:mstrApp.getRootController().dialogController.getNextZIndex(),showNote:false,onOK:function(){var trgDef=this.getTrgDefinition();schedule.set("trgName",this.getTrgName());if($A.find(schedule.availableTriggers,"id",schedule.trgName)<0){schedule.set("availableTriggers",schedule.availableTriggers.concat({n:schedule.trgName,id:trgDef,isHidden:true}));schedule.set("trgID",trgDef);}var d=new Date();if(!schedule.subsID){schedule.set("subsName",model.cubeName+" "+schedule.trgName+" "+d.toLocaleString());}this.close();},onCancel:function(){this.close();},onClose:mstrmojo.emptyFn});this.SREditor=editor;}editor.set("trgName",schedule.trgName||null);editor.open(null,cfg);}}]},{scriptClass:"mstrmojo.Box",cssClass:"cf secondBox",bindings:{visible:function(){return(this.parent.model.operationMode===constants.operationMode.subscribe)&&!this.parent.simpleProgressMode;}},children:[{scriptClass:"mstrmojo.Label",cssClass:"text",text:mstrmojo.desc(12769,"Schedule Name:")},{scriptClass:"mstrmojo.TextBox",cssClass:"inputName",onvalueChange:function(){if(this.parent.parent.model){this.parent.parent.model.getSchedule().set("subsName",this.value);}},postBuildRendering:function(){var model=this.parent.parent.model,schedule=model&&model.getSchedule();this.update();if(schedule){schedule.attachEventListener("subsNameChange",this.id,"update");}},update:function(){var model=this.parent.parent.model,schedule=model&&model.getSchedule();if(schedule){this.set("value",schedule.subsName||"");}}}]},{scriptClass:"mstrmojo.CheckBox",cssClass:"advanceOpsCheckbox",label:mstrmojo.desc(13274,"Refresh data now"),cssDisplay:"table",postBuildRendering:function(){var model=this.parent.model,schedule=model&&model.getSchedule();this.update();if(schedule){schedule.attachEventListener("trgNameChange",this.id,"update");schedule.attachEventListener("isSendNowChange",this.id,"update");}},update:function(){var model=this.parent.model,schedule=model&&model.getSchedule();if(model){this.set("visible",model.operationMode===constants.operationMode.subscribe&&mstrApp.diParams.canSendNow);this.set("enabled",!!schedule.trgName);this.set("checked",schedule.isSendNow);}},oncheckedChange:function(){var model=this.parent.model,checked=this.checked;if(model){model.getSchedule().set("isSendNow",checked);}}},{slot:"buttonNode",alias:"cancelButton",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var editor=this.parent;editor.close();},postBuildRendering:function(){var model=this.parent.model;model.attachEventListener("PublishStatusUpdate",this.id,"update");},update:function(evt){if(evt&&evt.name&&!evt.completed&&!evt.hasError){this.set("enabled",false);}if(evt&&evt.reset){this.set("enabled",true);}},bindings:{visible:function(){return(mstrApp.getRootController().model.operationMode!==constants.operationMode.create&&!this.parent.simpleProgressMode);}}},{slot:"buttonNode",alias:"okButton",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(1302,"Finish"),useRichTooltip:true,richTooltip:{cssClass:"vi-regular vi-tooltip-V",posType:mstrmojo.tooltip.POS_BOTTOMLEFT},postBuildRendering:function(){this.richTooltip.refNode=this.domNode;this.attachEventListener("renderComplete",this.id,this.onuseRichTooltipChange);},postCreate:function postCreate(){var me=this,evtConfig={},listConfig=evtConfig[this.id]={};var evtHandler=function(evt){var model=me.parent.model,operationMode=model.operationMode;if(operationMode===constants.operationMode.subscribe||operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){me.set("enabled",evt.value);me.richTooltip.content=evt.value?"":DISABLED_BUTTON_TOOLTIP;}};listConfig[EVENT_CAN_SAVE_SCHEDULE]=evtHandler;listConfig[EVENT_CAN_START_REFRESH]=evtHandler;mstrApp.getRootController().attachDataChangeListeners(evtConfig);},onclick:function(){var model=this.parent.model;if(model.operationMode===constants.operationMode.subscribe){mstrApp.getRootController().getScheduleController().createSchedule();this.parent.isSendNow=this.parent.model.getSchedule().isSendNow;}if(model.operationMode===constants.operationMode.refresh){this.parent.toggleEnable(false);mstrApp.getRootController().saveAndPublish();}if(model.operationMode===constants.operationMode.edit){this.parent.toggleEnable(false);mstrApp.getRootController().getPublishController().startSaveAndPublish();}},bindings:{visible:function(){return(mstrApp.getRootController().model.operationMode!==constants.operationMode.create&&!this.parent.simpleProgressMode);}}},{slot:"buttonNode",alias:"sendToHistoryList",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(4364,"Send to History List"),useRichTooltip:true,richTooltip:{cssClass:"vi-regular vi-tooltip-V",posType:mstrmojo.tooltip.POS_BOTTOMLEFT},onclick:function(){mstrApp.getRootController().getPublishController().sendToHistoryList();},postBuildRendering:function(){this.richTooltip.refNode=this.domNode;this.attachEventListener("renderComplete",this.id,this.onuseRichTooltipChange);},postCreate:function postCreate(){var me=this,evtConfig={},listConfig=evtConfig[this.id]={};var evtHandler=function(evt){var model=me.parent.model,operationMode=model.operationMode;if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){me.set("enabled",evt.value);me.richTooltip.content=evt.value?"":DISABLED_BUTTON_TOOLTIP;}};listConfig[EVENT_CAN_START_REFRESH]=evtHandler;mstrApp.getRootController().attachDataChangeListeners(evtConfig);},bindings:{visible:function(){return(mstrApp.getRootController().model.operationMode!==constants.operationMode.subscribe&&!mstrApp.isSingleTier&&!mstrApp.getRootController().model.analysisID&&!mstrApp.refreshMultipleCubes);}}}]});}());