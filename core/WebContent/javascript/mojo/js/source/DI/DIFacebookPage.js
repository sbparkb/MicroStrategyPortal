(function(){mstrmojo.requiresCls("mstrmojo.DI.DISearchBoxPage","mstrmojo.DI.DIDateTextBox2","mstrmojo.DI.DIFacebookAdvancedEditor");mstrmojo.requiresDescs(221,1442,3653,12689,12690,14124);var $ARR=mstrmojo.array,constants=mstrmojo.DI.DIConstants,sourceType=mstrmojo.DI.DIConstants.sourceType;function adjustSearchBoxWidth(){var width=this.searchPanel.blockNode.clientWidth;if(width>90){this.searchPanel.searchFieldNode.style.width=(width-90)+"px";}}mstrmojo.DI.DIFacebookPage=mstrmojo.declare(mstrmojo.DI.DISearchBoxPage,null,{scriptClass:"mstrmojo.DI.DIFacebookPage",advancedProperties:null,groupID:"",searchBoxHint:mstrmojo.desc(12689,"Search for Pages"),signOutTooltipText:mstrmojo.desc(14124,"Please logout of Facebook in the popup window."),handleNoDataReturned:function handleNoDataReturned(){this.toggleDataPreview(false);},init:function init(props){var evtConfig,listConfig;this._super(props);evtConfig={};listConfig=evtConfig[this.id]={};listConfig[constants.dataEvents.NO_DATA_RETURNED_EVENT]=this.handleNoDataReturned;listConfig.oAuthReportsFetched=this.populate;listConfig.windowSizeChanged=this.adjustSize;mstrApp.getRootController().attachDataChangeListeners(evtConfig);this.searchPanel.signOutTooltipText=this.signOutTooltipText;},adjustSize:function adjustSize(evt){var size=evt.size,width=Math.ceil(parseInt(size.w,10)),content=this.previewPanel.content;if(!content){return ;}if(width>=760&&width<=950){if(content.cols!==2){content.cols=2;content.refresh();}}else{if(content.cols!==3){content.cols=3;content.refresh();}}adjustSearchBoxWidth.call(this);},refreshConfig:function refreshConfig(){this.config={firstSplit:{v:"60px",min:"60px",max:undefined},secondSplit:{v:"100%",min:"150px",max:undefined},resizeHandle:{v:"2px"}};},generateGUID:function generateGUID(){function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1);}return(s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4());},populate:function populate(evt){var results;if(this._super){this._super(evt);}if(evt&&evt.targetPageId){if(evt.targetPageId!==this.id){return ;}}results=mstrApp.getRootController().model.externalSources[sourceType.facebook].reports;if(!results.mi.ca){mstrApp.getRootController().raiseModelEvent({name:constants.dataEvents.NO_DATA_RETURNED_EVENT});return ;}this.toggleDataPreview(true);this.previewPanel.populate(evt);adjustSearchBoxWidth.call(this);},preBuildRendering:function preBuildRendering(){if(this._super){this._super();}this.set("headerLabelText",mstrmojo.desc(12689,"Search for Pages"));this.set("placeHolderText",mstrmojo.desc(12689,"Search for Pages"));this.set("showOperators",false);this.set("showAdvancedOptions",false);this.set("noDataErrorString",mstrmojo.desc(12690,"No Pages found, please try another search string."));this.set("iconCssClass","facebookIcon");this.previewPanel.previewType="table";},postBuildRendering:function postBuildRendering(){var controller=mstrApp.getRootController();if(this.tableID!==undefined&&this.tableID!==""){if(this.advProps!==undefined){this.advancedProperties=this.advProps;}}controller.sourceSelected(false);if(this._super){this._super();}},onSearchClick:function onSearchClick(query){if(query===undefined||query===""){return ;}if(this._super){this._super(query);}var controller=mstrApp.getRootController(),searchQuery="searchedPage?q="+encodeURIComponent(query);controller.oAuthSourceFetchFunction(sourceType.facebook,{fbPageSearchQuery:searchQuery});},handleSearchChange:function handleSearchChange(evt){if(this._super){this._super(evt);}mstrApp.getRootController().enableFinishButton(false);},getSelectedPageInfo:function getSelectedPageInfo(){return this.previewPanel.content.selectedItem;},getTimeFeed:function getTimeFeed(time){var timeFeed=time||"?since=-1%20days",advPro=this.getSelectedPageInfo().advancedProperties;if(advPro&&advPro.getProperties){var dateRange=advPro.getProperties(),since=(!dateRange.since||dateRange.since==="MM/DD/YYYY")?"":encodeURIComponent(dateRange.since),until=(!dateRange.until||dateRange.until==="MM/DD/YYYY")?"":encodeURIComponent(dateRange.until),connector="";if(since){timeFeed="?since="+since;}else{timeFeed="";}if(until){if(since){connector="&";}else{connector="?";}timeFeed+=connector+"until="+until;}}return timeFeed;},getTableQuery:function getTableQuery(groupId,tableName,timeFeed){var selectedPageId=this.getSelectedPageInfo().pg_id,searchQuery=this.searchPanel.getSearchQuery(),query="",advancedProps=this.getSelectedPageInfo().advancedProperties;var pageInfo={query:encodeURIComponent(searchQuery),groupID:groupId,advProps:advancedProps};timeFeed=this.getTimeFeed(timeFeed);pageInfo.timeFeed=timeFeed;switch(tableName){case"page":pageInfo.name="page";query=selectedPageId+"_Page###"+JSON.stringify(pageInfo);break;case"posts":pageInfo.name="posts";query=selectedPageId+":feed_Posts"+timeFeed+"###"+JSON.stringify(pageInfo);break;case"comments":pageInfo.name="comments";query=selectedPageId+":feed_Comments"+timeFeed+"###"+JSON.stringify(pageInfo);break;case"likes":pageInfo.name="likes";query=selectedPageId+":feed_Likes"+timeFeed+"###"+JSON.stringify(pageInfo);break;}return query;},getItems:function getItems(tableId){var controller=mstrApp.getRootController(),model=controller.getModel(),_that=this,items=[],selectedPageName=this.getSelectedPageInfo().n,searchName=selectedPageName.substr(0,10),groupId=this.generateGUID();if(tableId===""){var page_main_table={query:_that.getTableQuery(groupId,"page"),n:searchName+" Page"};items.push(page_main_table);var feed_posts_main_table={query:_that.getTableQuery(groupId,"posts"),n:searchName+" Posts"};items.push(feed_posts_main_table);var feed_posts_comments_table={query:_that.getTableQuery(groupId,"comments"),n:searchName+" Comments"};items.push(feed_posts_comments_table);var feed_posts_likes_table={query:_that.getTableQuery(groupId,"likes"),n:searchName+" Likes"};items.push(feed_posts_likes_table);}else{var groupID=this.groupID,refreshItems=[];items=[];$ARR.forEach(model.getAllTableID(),function(tableId){var source=model.getImportSource(tableId),paramString=decodeURIComponent(source.sourceInfo.url.split("###")[1]),searchParam=JSON.parse(paramString);if(searchParam&&searchParam.groupID===groupID){refreshItems.push(source);}});if(refreshItems.length>0){$ARR.forEach(refreshItems,function(item){var sourceInfo=item.sourceInfo,paramString=decodeURIComponent(sourceInfo.url.split("###")[1]),searchParam=JSON.parse(paramString),name=searchParam.name,timeFeed=searchParam.timeFeed.replace(" ","%20"),tableID=item.tableID;switch(name){case"page":items.push({query:_that.getTableQuery(groupID,"page",timeFeed),n:searchName+" Page",tableID:tableID});break;case"posts":items.push({query:_that.getTableQuery(groupID,"posts",timeFeed),n:searchName+" Posts",tableID:tableID});break;case"comments":items.push({query:_that.getTableQuery(groupID,"comments",timeFeed),n:searchName+" Comments",tableID:tableID});break;case"likes":items.push({query:_that.getTableQuery(groupID,"likes",timeFeed),n:searchName+" Likes",tableID:tableID});break;}});}}return items;},performAction:function performAction(action){var controller=mstrApp.getRootController(),items=this.getItems(this.tableID);if(this.tableID!==""){controller.refreshMultiOAuthReports(this.sourceObjectsInfo.type,constants.sourceSubtype.facebook,items,action);}else{controller.importMultiOAuthReports(this.sourceObjectsInfo.type,items,true,!controller.model.hasEMMAReportInstance(),action,constants.sourceSubtype.facebook,this.id);}},onNextButtonClick:function(){this.performAction(this.tableID?constants.actions.refreshData:constants.actions.importSource);},onBackButtonClick:function onBackButtonClick(){var controller=mstrApp.getRootController();controller.showPage(constants.pageType.dataSelection);},onHelpButtonClick:function onHelpButtonClick(){return"importing_data_from_Facebook.htm";},onFinishButtonClick:function(){this.performAction(constants.actions.savePublish);},onadvancedSearchClick:function onadvancedSearchClick(){var _that=this;var zIndex=mstrApp.getRootController().dialogController.getCurrentZIndex()+1;var d=new mstrmojo.Editor({cssClass:"mstrmojo-di-facebookAdvancedEditor",cssText:"background: white; width:460px;height: 380px;border: 10px solid rgba(0, 0, 0, 0.3); border-radius:5px; -moz-border-radius:5px;-webkit-border-radius:10px;",showTitle:true,title:"Filter Post Data by Date",zIndex:zIndex,onOpen:function(){var st=this.curtainNode.style;st.background="black";st.opacity=0.5;st.filter="alpha(opacity=50)";},children:[{scriptClass:"mstrmojo.DI.DIFacebookAdvancedEditor",alias:"editorContent",bindings:{advancedProperties:function(){return _that.advancedProperties||{};}}}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(1442,"OK"),onclick:function(){var p=this.parent.parent;if(p.editorContent.onOk){p.editorContent.onOk();_that.advancedProperties=p.editorContent.advancedProperties;}p.close();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var p=this.parent.parent;p.close();if(p.onCancel){p.onCancel();}}}]});d.open();}});}());