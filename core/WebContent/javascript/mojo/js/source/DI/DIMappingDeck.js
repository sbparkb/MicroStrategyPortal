(function(){mstrmojo.requiresCls("mstrmojo.Panel","mstrmojo.Container","mstrmojo.Button","mstrmojo.MenuButton","mstrmojo.WidgetList","mstrmojo.DI.DIMappingItem","mstrmojo.DI.DIMultiFormEditor");var $D=mstrmojo.dom;var constants=mstrmojo.DI.DIConstants;var menuItems=mstrmojo.DI.DIConstants.menuItems;function createAvatar(widget,data){var avCfg={placeholder:document.body.appendChild(document.createElement("div")),cssClass:"mstrmojo-di-mappingitem-avatar",visible:false,data:data,name:data.n,type:data.tp,georole:data.georole,timerole:data.der,parent:widget};var av=new mstrmojo.DI.DIMappingItem(avCfg);av.render();widget.avatar=av;return av;}function showAvatar(widget,ctxt){var s=ctxt.src;var node,w;if(!s){return false;}node=s.node;if(node){w=$D.findWidget(node);}if(!w||!w._allowDnD){return false;}var pos=$D.position(w.domNode);var av=widget.avatar||createAvatar(widget,w.data);av.set("name",w.data.n);av.domNode.style.top=(s.pos.y+1)+"px";av.domNode.style.left=(s.pos.x+1)+"px";av.domNode.style.display="block";av.domNode.style.zIndex="9999";av.domNode.style.width=(pos.w-2)+"px";av.domNode.style.height=(pos.h-2)+"px";}function hideAvatar(widget,ctxt){if(widget.avatar&&widget.avatar.domNode){widget.avatar.domNode.style.display="none";}}function updateAvatar(widget,ctxt){var s=ctxt.src;var t=ctxt.tgt;if(t&&t.pos&&widget.avatar&&widget.avatar.domNode){widget.avatar.domNode.style.left=(t.pos.x+1)+"px";widget.avatar.domNode.style.top=(t.pos.y+1)+"px";}}function removeRelationship(item){if(!item||!item.data||!item.data.ert||!item.data.col){return ;}var m=this.model;var rsData=item.data.col;var tableIDs=[];var i,source;var params={tp:constants.relationshipEditType.remove,paid:rsData.parent.id,atid:rsData.child.id,ert:constants.ERType.reserved};if(m.currentSource){tableIDs=[m.currentSource.tableID];}else{var pSources=m.findMappingSource(rsData.parent);var cSources=m.findMappingSource(rsData.child);for(i=0;i<pSources.length;i++){if(cSources.indexOf(pSources[i])>-1){if(m.hasRelationship(pSources[i].tableID,rsData.parent,rsData.child)){tableIDs.push(pSources[i].tableID);}}}}mstrApp.getRootController().editRelationship(tableIDs,params);}function flipOrderRelationship(item){if(!item||!item.data||!item.data.ert||!item.data.col){return ;}var m=this.model;var rsData=item.data.col;var tableIDs=[];var i;if(m.currentSource){tableIDs=[m.currentSource.tableID];}else{var pSources=m.findMappingSource(rsData.parent);var cSources=m.findMappingSource(rsData.child);for(i=0;i<pSources.length;i++){if(cSources.indexOf(pSources[i])>-1){if(m.hasRelationship(pSources[i].tableID,rsData.parent,rsData.child)){tableIDs.push(pSources[i].tableID);}}}}var params={tp:constants.relationshipEditType.flip,paid:rsData.parent.id,atid:rsData.child.id,ert:rsData.ert};mstrApp.getRootController().editRelationship(tableIDs,params);}function changeERTypeRelationship(item,type){if(!item||!item.data||!item.data.ert||!item.data.col){return ;}var m=this.model;var rsData=item.data.col;var tableIDs=[];var i;if(rsData.ert===type){return ;}if(m.currentSource){tableIDs=[m.currentSource.tableID];}else{var pSources=m.findMappingSource(rsData.parent);var cSources=m.findMappingSource(rsData.child);for(i=0;i<pSources.length;i++){if(cSources.indexOf(pSources[i])>-1){if(m.hasRelationship(pSources[i].tableID,rsData.parent,rsData.child)){tableIDs.push(pSources[i].tableID);}}}}var params={tp:constants.relationshipEditType.changeERType,paid:rsData.parent.id,atid:rsData.child.id,ert:type};mstrApp.getRootController().editRelationship(tableIDs,params);}function queryRSItemChecked(item){var data=this.data;var checked=false;if(data&&data.ert!==undefined){if(item.did===menuItems.ONE_TO_ONE&&data.ert===constants.ERType.ERType11){checked=true;}if(item.did===menuItems.ONE_TO_MANY&&data.ert===constants.ERType.ERType1M){checked=true;}if(item.did===menuItems.MANY_TO_ONE&&data.ert===constants.ERType.ERTypeM1){checked=true;}if(item.did===menuItems.MANY_TO_MANY&&data.ert===constants.ERType.ERTypeMM){checked=true;}}return checked;}mstrmojo.DI.DIMappingDeck=mstrmojo.declare(mstrmojo.Container,null,{title:"",type:"",titlebarCss:"",scriptClass:"mstrmojo.DI.DIMappingDeck",markupString:'<div id="{@id}" class="mstrmojo-di-mappingdeck {@cssClass}" style="{@cssText}"><div class="mstrmojo-di-mappingdeck-titlebar {@titlebarCss}"></div><div class="mstrmojo-di-mappingdeck-list"></div></div>',markupSlots:{titlebarNode:function(){return this.domNode.children[0];},containerNode:function(){return this.domNode.children[1];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},children:[{slot:"titlebarNode",scriptClass:"mstrmojo.Table",cssClass:"titlebar-table",rows:1,cols:2,children:[{slot:"0,0",scriptClass:"mstrmojo.Label",cssClass:"titlebar-label",bindings:{text:"this.parent.parent.title"}},{slot:"0,1",scriptClass:"mstrmojo.Button",cssClass:"titlebar-button",text:"?",onclick:function(){if(this.parent.parent.onCaptionOK){this.parent.parent.onCaptionOK();}}}]},{slot:"containerNode",alias:"list",scriptClass:"mstrmojo.WidgetList",cssClass:"mstrmojo-di-mappingdeck-list",draggable:true,dropZone:true,ownAvatar:true,allowDrop:function(ctxt){var s=ctxt.src;var node,w;if(!s){return false;}node=s.node;if(node){w=$D.findWidget(node);}return w&&w._allowDnD;},getDragData:function(ctxt){var data=null;var s=ctxt.src;var node,w;if(!s){return false;}node=s.node;if(node){w=$D.findWidget(node);}if(w&&w._allowDnD){data={item:w.data};}return data;},isDragValid:function isDragValid(context){var s=context.src;if(!s){return false;}var node,w;node=s.node;if(node){w=$D.findWidget(node);}if(!w||!w.data||!w.data.col||isNaN(w.data.tp)){return false;}if(w&&w._allowDnD){showAvatar(this,context);}return w&&w._allowDnD;},ondragstart:function(context){var s=context.src;var node,w;node=s.node;if(node){w=$D.findWidget(node);}if(w&&w._allowDnD){showAvatar(this,context);}},ondragend:function(ctxt){hideAvatar(this,ctxt);},ondrop:function(ctxt){var s=ctxt&&ctxt.src;var t=ctxt&&ctxt.tgt;var node,srcItem,tgtItem,tgtPosition,srcTextPosition;if(!s||!s.node||!t||!t.node){return ;}node=s.node;srcItem=$D.findWidget(node);node=t.node;tgtItem=$D.findWidget(node);tgtPosition=t.pos;if(!tgtItem._allowDnD&&tgtItem.parent._allowDnD){tgtItem=tgtItem.parent;}if(tgtItem.textNode){srcTextPosition=$D.position(tgtItem.textNode);}if(!srcItem||!srcItem._allowDnD){return ;}if(tgtItem._allowDnD&&srcTextPosition&&(tgtPosition.x<=srcTextPosition.x)){this.parent.onMappingItemsDnD(srcItem,tgtItem);}else{if(tgtItem===t.widget){this.parent.onItemToDeck(srcItem,tgtItem.parent);}else{if(tgtItem._allowDnD&&srcTextPosition&&(tgtPosition.x>srcTextPosition.x)){if(s.widget===t.widget){this.parent.onMappingItemsDnD(srcItem,tgtItem);}else{this.parent.onItemToDeck(srcItem,t.widget.parent);}}}}},ondragenter:function(ctxt){var s=ctxt.src;var node,w;if(!s){return false;}node=s.node;if(node){w=$D.findWidget(node);}if(!w||!w._allowDnD){return false;}var widget=s.widget;showAvatar(widget,ctxt);updateAvatar(widget,ctxt);return true;},ondragmove:function(ctxt){updateAvatar(this,ctxt);},ondragover:function(ctxt){},ondragleave:function(ctxt){var s=ctxt.src;if(!s||!s.widget){return false;}hideAvatar(s.widget,ctxt);},getItemContainerChildrenHeight:function(){var h=0;var i;if(this.domNode&&this.itemsContainerNode&&this.itemsContainerNode.childNodes){for(i=0;i<this.itemsContainerNode.childNodes.length;i++){h+=this.itemsContainerNode.childNodes[i].clientHeight;}}return h;},onheightChange:function(e){var h;if(this.domNode){this.domNode.style.height=parseInt(e.value,10)+"px";h=this.getItemContainerChildrenHeight();if(h>parseInt(e.value,10)-20){this.domNode.childNodes[0].style.height=this.domNode.childNodes[0].clientHeight+50+"px";}else{if(h>0){this.domNode.childNodes[0].style.height=h+10+"px";}}}},itemFunction:function(item,index,list){var cfg={data:item.col,name:item.n,tooltip:item.n,type:item.tp,queryChecked:item.queryChecked,queryVisible:item.queryVisible,model:list.parent.model,_allowDnD:true,cssClass:item.isLinked?"linked":"",georole:item.georole,timerole:item.der,parent:list};if(typeof item.allowEdit==="boolean"){cfg.allowEdit=item.allowEdit;}var iw=new mstrmojo.DI.DIMappingItem(cfg);return iw;},postCreate:function(){var m=this.parent.model;this.update();m.attachEventListener("MappingsFetched",this.id,"update");m.attachEventListener("CurrentSourceChanged",this.id,"update");},update:function(){var m=this.parent.model;var maps;if(m.currentSource){if(m.currentSource.currentTransformations&&m.currentSource.currentTransformations.xtab&&m.currentSource.currentTransformations.xtab.isCrosstab){maps=m.currentSource.transformedMapping;}else{maps=m.currentSource.currentMapping;}}else{maps=m.getAllMappings();}if(!maps||!maps.length){return ;}var i,col,add;var items=[];for(i=0;i<maps.length;i++){col=maps[i];add=false;switch(this.parent.type){case"amps":if(col.tp===12&&col.selected){add=true;}break;case"mtmps":if(col.tp===4&&col.selected){add=true;}break;case"cmps":if(!col.selected){add=true;}break;}if(add){items.push({n:col.alias,tp:col.tp,col:col,idx:i,isLinked:col.isLinked,queryVisible:queryMenuItemVisible,isMultiForm:col.isMultiForm});}}var relationships=[];var key,rs,item;if(this.parent.type==="amps"){if(m.currentSource){relationships=m.currentSource.relationship||[];}else{relationships=m.getAllRelationships();}for(i=0;i<relationships.length;i++){rs=relationships[i];item={n:"&lt"+rs.parent.n+", "+rs.child.n+"&gt",tp:"rs",allowEdit:false,ert:rs.ert,col:rs,queryChecked:queryRSItemChecked};if(rs.ert===constants.ERType.ERType11){item.n=item.n+"(1:1)";}else{if(rs.ert===constants.ERType.ERType1M){item.n=item.n+"(1:M)";}else{if(rs.ert===constants.ERType.ERTypeM1){item.n=item.n+"(M:1)";}else{if(rs.ert===constants.ERType.ERTypeMM){item.n=item.n+"(M:M)";}}}}items.push(item);}}this.set("items",items);}}],onheightChange:function(e){this.list.set("height",parseInt(e.value,10)-20+"px");},onMappingItemsDnD:function(srcItem,tgtItem){var srcName=srcItem.name;var tgtName=tgtItem.name;var m=this.model;var tableIDs=[],tmp;var srcSources,tgtSources,i;if(srcItem.type!==12||tgtItem.type!==12){if(tgtItem.type===12||tgtItem.type==="rs"){srcItem.toAttribute();return ;}if(tgtItem.type===4){srcItem.toMetric();return ;}return ;}if(!srcItem.data||!srcItem.data.col||!tgtItem.data||!tgtItem.data.col){return ;}if(!srcItem.data.col.selected&&tgtItem.data.col.selected){srcItem.toAttribute();return ;}if(srcItem.data.col.selected&&!tgtItem.data.col.selected){srcItem.toUnused();return ;}if(!srcItem.data.col.selected&&!tgtItem.data.col.selected){return ;}if(srcItem.data.col.id===tgtItem.data.col.id){return ;}if(m.currentSource){if(!(m.hasRelationship(m.currentSource.tableID,tgtItem.data.col,srcItem.data.col)||m.hasRelationship(m.currentSource.tableID,srcItem.data.col,tgtItem.data.col))){tableIDs.push(m.currentSource.tableID);}}else{srcSources=m.findMappingSource(srcItem.data.col);tgtSources=m.findMappingSource(tgtItem.data.col);for(i=0;i<srcSources.length;i++){if(tgtSources.indexOf(srcSources[i])>-1){if(!(m.hasRelationship(srcSources[i].tableID,tgtItem.data.col,srcItem.data.col)||m.hasRelationship(srcSources[i].tableID,srcItem.data.col,tgtItem.data.col))){tableIDs.push(srcSources[i].tableID);}}}}var params={tp:constants.relationshipEditType.create,paid:tgtItem.data.col.id,atid:srcItem.data.col.id,ert:constants.ERType.ERType1M};mstrApp.getRootController().editRelationship(tableIDs,params);},onItemToDeck:function(srcItem,tgtDeck){var srcName=srcItem.name;var srcItemType=srcItem.type;var tgtDeckType=tgtDeck.type;switch(tgtDeckType){case"amps":srcItem.toAttribute();break;case"mtmps":srcItem.toMetric();break;case"cmps":srcItem.toUnused();break;}}});}());