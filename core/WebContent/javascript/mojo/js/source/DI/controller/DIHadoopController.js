(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.array","mstrmojo.warehouse.EnumDatabaseType","mstrmojo.warehouse.dbroles.DBRoleEditor","mstrmojo.DI.DIHadoopModel","mstrmojo.DI.controller.DIHadoopWHController","mstrmojo.warehouse.obj.DBRole","mstrmojo.qb.DataService");mstrmojo.requiresDescs(12773,12774,12815,12816,12817);var $A=mstrmojo.array;var $ENUM_DATABASE_TYPE=mstrmojo.warehouse.EnumDatabaseType;function populateURLPath(dbr){if(!dbr){return"";}return"hdfs://"+dbr.hadoopName+":"+dbr.webHDFSPort+"/webhdfs/v1/?op=liststatus";}function parseURLFiles(res){var fls=res.mi.ftree.fl;var size=0,fl,i;if(fls!==undefined){for(i=0;i<fls.length;i++){fl=fls[i];size+=fl.sz;}}return size;}mstrmojo.DI.controller.DIHadoopController=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.DI.controller.DIHadoopController",dbRoleID:"",hadoopConnURL:"",dbRole:"",saveDBRole:function saveDBRole(dbRole,editorNode){var controller=mstrApp.getRootController(),$this=this;editorNode.set("visible",false);editorNode.close();controller.getDataService().saveDBRole({success:function success(res){$this.dbRoleID=res.dbr.did;$this.hadoopConnURL=populateURLPath(dbRole);controller.model.raiseEvent({name:"HadoopDBRoleSaved"});},fail:function fail(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{dbroleinfo:JSON.stringify(dbRole)});},loadBDETypeDBRole:function loadBDETypeDBRole(dbRoleId){var controller=mstrApp.getRootController(),$this=this;if(dbRoleId){$this.loadDBRoleByID(dbRoleId);return ;}var callback={success:function(res){var dbRoles=res.dbRoles,haveBDE=false;if(dbRoles){dbRoles=[].concat(dbRoles);$A.forEach(dbRoles,function(dbRole){if($ENUM_DATABASE_TYPE.BDE===dbRole.db_type){$this.loadDBRoleByID(dbRole.did);haveBDE=true;}});}if(!haveBDE){mstrApp.hideProgress();controller.model.raiseEvent({name:"BDEDBRoleLoaded"});}},failure:function(){controller.displayError(mstrmojo.desc(12815,"Error when loading DB Roles."));}};controller.getDataService().archSearch(callback,{typeFilter:$ENUM_DATABASE_TYPE.BDE,domain:3});},loadDBRoleByID:function loadDBRoleByID(dbRoleId){var $this=this,DB_Role=new mstrmojo.DI.DIHadoopDBRole(),controller=mstrApp.getRootController();DB_Role.mdDBRole.did=dbRoleId;DB_Role.populate(function(db_role){var connStr=db_role.mdDBRole.connstr;$A.forEach(connStr.split(";"),function(x){var arr=x.split("=");db_role[arr[0].trim()]=arr[1];});$this.hadoopConnURL=populateURLPath(db_role);$this.dbRoleID=dbRoleId;$this.dbRole=DB_Role;controller.model.raiseEvent({name:"BDEDBRoleLoaded"});});},populateDBRole:function populateDBRole(dbRoleID,callback){var controller=mstrApp.getRootController();controller.model.populateDBRole(dbRoleID,callback);},renderDBRoleEditor:function renderDBRoleEditor(dbRole){var $this=this;this.launchingApp=mstrApp;window.mstrApp=new mstrmojo.qb.QBApp();mstrApp.sessionState=this.launchingApp.sessionState;mstrApp.msgID=mstrApp.messageID;mstrApp.docID=mstrApp.messageID;mstrApp.isSingleTier=this.launchingApp.isSingleTier;mstrApp.serverProxy=this.launchingApp.serverProxy;delete mstrApp.messageID;delete this.launchingApp.dbType;delete this.launchingApp.supportDBObjects;mstrApp.sessionManager=this.launchingApp.sessionManager;mstrApp.enableAutomaticSessionRecovery=this.launchingApp.enableAutomaticSessionRecovery;mstrApp.maxSessionIdleTime=this.launchingApp.maxSessionIdleTime;mstrApp.timeBeforeSessionTimeoutWarning=this.launchingApp.timeBeforeSessionTimeoutWarning;mstrApp.enableWarningSessionTimeout=this.launchingApp.enableWarningSessionTimeout;mstrApp.projectName=this.launchingApp.projectName;mstrApp.serverName=this.launchingApp.serverName;mstrApp.serverPort=this.launchingApp.serverPort;mstrApp.authMode=this.launchingApp.authMode;mstrApp.name=this.launchingApp.name;mstrApp.persistTaskParams=this.launchingApp.persistTaskParams;mstrApp.hideProgress=this.launchingApp.hideProgress;var controller=mstrApp.rootController=new mstrmojo.DI.controller.DIHadoopWHController();controller.dataService=mstrmojo.qb.DataService;var model=controller.model=new mstrmojo.DI.DIHadoopModel();model.dbRoleEditorCfg={hideDSNOption:true,hideDriverCheck:true,dbIdFilter:[42]};model.loadDBObjects({success:function success(){var dbrEditor=new mstrmojo.warehouse.dbroles.DBRoleEditor();dbrEditor.config=model.dbRoleEditorCfg;dbrEditor.callback={close:function(){if(mstrmojo.all.QBuilderModel){mstrmojo.all.QBuilderModel.destroy();}if(mstrmojo.all.QBuilderPage){mstrmojo.all.QBuilderPage.destroy();}mstrApp.getRootController().destroy();var qbApp=window.mstrApp;window.mstrApp=$this.launchingApp;mstrApp.sessionState=qbApp.sessionState;mstrApp.msgID=qbApp.messageID;mstrApp.docID=qbApp.messageID;if(qbApp.dbRoleID){mstrApp.getRootController().hadoopController.dbRoleID=qbApp.dbRoleID;mstrApp.getRootController().hadoopController.hadoopConnURL=qbApp.hadoopConnURL;mstrApp.getRootController().model.raiseEvent({name:"HadoopDBRoleSaved"});}qbApp.destroy();}};if(!dbRole){dbRole=new mstrmojo.warehouse.obj.DBRole({mdl:model});}dbrEditor.dbrole=dbRole;dbrEditor.open();}});},hadoopBrowserFunction:function(node){this.browseHadoop(node.data.address,node.data.browser,node);},browseHadoop:function browseHadoop(urlPath,browser,node){var controller=mstrApp.getRootController(),params={},$browser=browser,$node=node;if(urlPath===""){controller.displayError(mstrmojo.desc(12773,"Please enter a valid network path."),false);return ;}if(urlPath.substring(0,1)==="\\"){urlPath=urlPath.replace(/\\\\/g,"file://");urlPath=urlPath.replace(/\\/g,"/");}params.urlPath=urlPath;var callback={success:function(res){if(res.mi.ftree===""){controller.displayError(mstrmojo.desc(12774,"We could not find anything. Please verify that you have entered a valid network path."),false);}$browser.set("fileList",controller.parseURLFolders(res));if($node){$node.data.isMouseOver=true;if(res.mi.ftree===""){$node.totalSize=0;}else{var files=res.mi.ftree.fl;if(files){$node.totalSize=mstrmojo.DI.DIHelpers.getRoundSize(parseURLFiles(res));}else{$node.totalSize="---";}}}},failure:function(res){$browser.set("fileList",[]);controller.displayError(mstrmojo.desc(12816,"Uh-Oh, Error fetching the list of files for the given network path: ####").replace("####",res.message),false);}};controller.dataService.getOAuthSourceReports(callback,params);},browseHadoopForFolderSize:function browseHadoopForFolderSize(urlPath,itemNode){var controller=mstrApp.getRootController(),params={},$this=itemNode,$browser=itemNode.tree.parent;if(urlPath===""){controller.displayError(mstrmojo.desc(12773,"Please enter a valid network path."),false);return ;}if(urlPath.substring(0,1)==="\\"){urlPath=urlPath.replace(/\\\\/g,"file://");urlPath=urlPath.replace(/\\/g,"/");}params.urlPath=urlPath;var callback={success:function(res){if(res.mi.ftree===""){$this.totalSize=0;}else{var files=res.mi.ftree.fl;if(files){$this.totalSize=mstrmojo.DI.DIHelpers.getRoundSize(parseURLFiles(res));}else{$this.totalSize="---";}}$browser.setFileListForNode(controller.parseURLFolders(res),itemNode);$this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-V",refNode:$this.textNode,posType:mstrmojo.tooltip.POS_BOTTOMLEFT,top:-5,content:mstrmojo.desc(12817,"Name: #### Size: @@@@").replace("####",$this.text).replace("@@@@",$this.totalSize)});},failure:function(){}};controller.dataService.getHadoopFolderSize(callback,params);}});}());