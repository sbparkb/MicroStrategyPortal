(function(){mstrmojo.requiresCls("mstrmojo.DI.DIModel","mstrmojo.DI.DIRepublishScheduleEditor","mstrmojo.DI.DIConstants");mstrmojo.requiresDescs(12394,12836,12837);var $A=mstrmojo.array,$H=mstrmojo.hash,constants=mstrmojo.DI.DIConstants,BLANK_EMMA_IRR_TEMPLATE_ID="CDE80A9048DB5E6E1B1A378503859835";var IRR_SOURCE_TYPE_URL=0,IRR_SOURCE_TYPE_SINGLE_TABLE=1;var emmaIRRCallback={success:function success(res){mstrApp.getRootController().dataService.set("emmaIRRMessageID",res.msgid);}};function getAttributes(node){var result=[];if(!node){return result;}if(node.fn===mstrmojo.expr.FN.AND||node.fn===mstrmojo.expr.FN.OR||node.fn===mstrmojo.expr.FN.NOT){if(Object.prototype.toString.call(node.nds)==="[object Array]"){$A.forEach(node.nds,function(item){result=result.concat(getAttributes(item));});}}else{if(node.a){result.push(node.a.did);if(node.a2){result.push(node.a2.did);}}}return result;}function buildWalk(node,objectNames){var result,attributeTagName,formTagName,dataType=0;node=node&&node.nd;if(node===undefined){return null;}if(node.op&&(node.op.fnt===mstrmojo.expr.FN.AND||node.op.fnt===mstrmojo.expr.FN.OR)){if(Object.prototype.toString.call(node.nds)==="[object Array]"){result={fn:node.op.fnt,et:node.et,nds:[]};$A.forEach(node.nds,function(item){result.nds.push(buildWalk(item,objectNames));});}else{if(!node.nd){return null;}result=buildWalk(node.nd,objectNames);}}else{if(node.op.fnt===mstrmojo.expr.FN.NOT){node=node.nds[0].nd;node.not=true;}result={fn:node.op.fnt,et:node.et,not:node.not||false};$A.forEach(node.nds,function(item){dataType=item.cst&&item.cst.ddt;});$A.forEach(node.nds,function(item){if(item.fmshct){attributeTagName=result.a?"a2":"a";formTagName=result.fm?"fm2":"fm";result[attributeTagName]={did:item.fmshct.atid,n:objectNames[item.fmshct.atid],t:12};result[formTagName]={did:item.fmshct.fmid,n:objectNames[item.fmshct.fmid],t:21,dtp:dataType||item.ddt};}else{if(item.cst){result.cs=result.cs||[];result.cs.push({v:item.cst.v,dtp:item.cst.ddt});}}});}return result;}mstrmojo.DI.controller.DIScheduleController=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.DI.controller.DIScheduleController",getCubeSubscription:function(callback){var rootController=mstrApp.getRootController();var cb={success:function(res){rootController.getModel().populateSubscriptions(res);},failure:function(res){rootController.displayError(res.message||res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};rootController.dataService.getObjectSubscriptions(mstrmojo.func.wrapMethods(cb,callback),{detailFlag:5});},getAvailableTriggers:function(callback){var rootController=mstrApp.getRootController();var cb={success:function(res){var model=rootController.model;model.getSchedule().populateTriggers(res);},failure:function(res){rootController.displayError(res.message||res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};rootController.dataService.getAvailableTriggers(mstrmojo.func.wrapMethods(cb,callback),{});},getSubscriptionDefinition:function(subsID,callback){var rootController=mstrApp.getRootController();rootController.dataService.getSubscriptionInfo(callback,{subscriptionID:subsID});},launchScheduleEditor:function(){var me=this,rootController=mstrApp.getRootController(),model=mstrApp.getRootController().getModel(),schedule=model.getSchedule(),editor=null,hasSingleWHTable;model.rawFilter=undefined;model.updateFilterUsedInTable=function updateFilterUsedInTable(){var attributesUsed=getAttributes(model.filter),hasFilter=attributesUsed.length>0,isFilterInTable=model.isFilterInTable={};$H.forEach(model.IRRTableAttrs,function(attributes,tableID){isFilterInTable[tableID]=true;$A.forEach(attributesUsed,function(attributeID){if($A.indexOf(attributes,attributeID)<0){isFilterInTable[tableID]=false;return false;}});isFilterInTable[tableID]=isFilterInTable[tableID]&&hasFilter;});};function openEditor(){editor=rootController.showDialog(constants.dialogType.publishStatusDialog,{zIndex:999,model:model});}function checkIRRAttributes(){mstrmojo.hash.forEach(model.importSources,function(source){if(source.xdaType===constants.xdaType.qbSingleTable){hasSingleWHTable=true;}});if(hasSingleWHTable){me.getEmmaIRRAttributes({success:function success(res){var targets=[],tableID,tableAttributes={},objectNames={},attributeForms={},attributeID;$A.forEach(res.ts,function tableHandler(table){$A.forEach(table.amps,function tableHandler(item){attributeID=item.atid;tableID=table.tbid;tableAttributes[tableID]=tableAttributes[tableID]||[];tableAttributes[tableID].push(attributeID);if($A.find(targets,"did",attributeID)===-1){targets.push({n:item.atnm,did:attributeID,t:12});}objectNames[attributeID]=item.atnm;$A.forEach(item.afmps,function formHandler(form){objectNames[form.fmid]=form.fmn;attributeForms[attributeID]=attributeForms[attributeID]||[];if($A.find(attributeForms[attributeID],"did",form.fmid)<0){attributeForms[attributeID].push({did:form.fmid,dtp:mstrmojo.expr.mapBaseFormTypeToDataType(form.bft),n:form.fmn,t:21});}});});});model.filter=buildWalk(model.rawFilter,objectNames);model.IRRAttributes=targets;model.IRRTableAttrs=tableAttributes;model.IRRAttrForms=attributeForms;model.updateFilterUsedInTable();openEditor();}});}else{model.IRRAttributes=[];openEditor();}}this.getAvailableTriggers({success:function(){if(schedule.subsID){me.getSubscriptionDefinition(schedule.subsID,{success:function(res){var source,deltaXML,idx;schedule.set("trgID",res.trgID);schedule.set("trgName",res.trgName);idx=$A.find(schedule.availableTriggers,"id",res.trgID);if(idx<0){schedule.availableTriggers.push({n:res.trgName,id:res.trgID});schedule.set("curTrg",{n:res.trgName,id:res.trgID});}else{schedule.set("curTrg",schedule.availableTriggers[idx]);}schedule.set("subsName",res.subsName);deltaXML=res.delta;if(deltaXML){mstrApp.getRootController().dataService.set("emmaIRRMessageID",null);me.createEmmaIRRReportInstance(model.IRRid,deltaXML,{success:function success(res){var def=res.def,srce,alternateSource,XDA_TYPES=constants.xdaType,fileDesc,tableName,delTables=[],callback;$A.forEach(def.datap,function tableHandler(item){source=model.getImportSource(item.tbid);if(!source){delTables.push(item.tbid);return true;}source.checked=true;if(item.crt!==undefined){source.refreshType=parseInt(item.crt,10);}alternateSource=null;srce=item.srce;if(srce){switch(srce.xt){case XDA_TYPES.qbSingleTable:alternateSource={tableName:srce.tbn};break;case XDA_TYPES.excel:case XDA_TYPES.text:fileDesc=srce.file_description;if(fileDesc&&fileDesc.url){tableName=mstrmojo.DI.DIHelpers.getURLFileName(fileDesc.url);}else{tableName=srce.tbal;}alternateSource={tableName:tableName};break;}}source.alternateSource=alternateSource;});callback={success:function success(){var ls=window.localStorage,item,bShow=true;if(ls){item=ls.getItem("irr"+schedule.subsID);if(item==="true"){bShow=true;}if(item==="false"){bShow=false;}}model.rawFilter=def.f.exp;checkIRRAttributes();me.setAdvMode(true);me.setOldIsAdvMode(true);me.setAdvState(bShow);},failure:function failure(res){rootController.displayError(mstrmojo.desc(12394,"Cannot delete source table."),false,(res&&res.message)||"");}};if(delTables.length>0){me.deleteEmmaIRRSourceTable(delTables,callback);}else{callback.success();}}});return ;}$A.forEach(res.ts,function tableHandler(item){source=model.getImportSource(item.did);if(!source){return true;}source.checked=true;if(item.crb!==undefined){source.refreshType=parseInt(item.crb,10);source.checked=true;}if(item.ac!==undefined){source.executeAction=parseInt(item.ac,10);source.checked=true;}});checkIRRAttributes();},failure:function(res){rootController.displayError(mstrmojo.desc(12836,"Cannot get definition about this subscription"),false,res.message||res.getResponseHeader("X-MSTR-TaskFailureMsg"));}});}else{$H.forEach(model.importSources,function(source){source.checked=source.canSubscribe();});checkIRRAttributes();}}});},createSchedule:function(callback){var rootController=mstrApp.getRootController(),model=rootController.getModel(),schedule=model.getSchedule(),cubeID=model.cubeID,subsID=schedule.subsID,subsName=schedule.subsName,tableIDs=[],refreshTypes=[],executeActions=[];var params={subscriptionName:subsName,contentID:cubeID};var cb={success:function(res){var id=res.subsID,ls=window.localStorage;model.raiseEvent({name:"CreateScheduleUpdate",res:res});if(id&&ls){ls.setItem("irr"+id,schedule.showAdvanceState);}},failure:function(res){model.raiseEvent({name:"CreateScheduleUpdate",res:res});}};if(!schedule.curTrg){return ;}mstrmojo.hash.forEach(model.importSources,function(source){if(source.checked&&source.canSubscribe()){tableIDs.push(source.tableID);refreshTypes.push(source.refreshType);executeActions.push(1);}});params.tableIDs=tableIDs.join();params.refreshTypes=refreshTypes.join();params.executeActions=executeActions.join();if(schedule.curTrg.isHidden){params.triggerPattern=schedule.curTrg.id;}else{params.triggerID=schedule.curTrg.id;}if(subsID){params.subscriptionID=subsID;}if(this.isAdvMode()&&(this.hasRefreshFilter()||this.hasAlternateSource())){params.hasIRR=1;}if(this.getOldIsAdvMode()){params.oldHasIRR=1;}params.sendNow=schedule.isSendNow;rootController.dataService.saveEMMASchedule(mstrmojo.func.wrapMethods(cb,callback),params);},removeSubscription:function(subscriptions,callback){mstrApp.getRootController().dataService.removeSubscription(callback,{subscriptionID:subscriptions.join()});},getScheduleStatus:function(cubeIDs,callback){var rootController=mstrApp.getRootController();var model=rootController.getModel();var params={dids:cubeIDs.join(),type:3,size:5};var cb={success:function(res){model.populateScheduleStatus(res);}};rootController.dataService.getScheduleStatus(mstrmojo.func.wrapMethods(cb,callback),params);},getScheduleStatusBySubscription:function(subIDs,callback){var rootController=mstrApp.getRootController(),model=rootController.getModel(),params={dids:subIDs.join(),type:255,size:5};var cb={success:function(res){model.populateScheduleStatus(res);}};rootController.dataService.getScheduleStatus(mstrmojo.func.wrapMethods(cb,callback),params);},updateScheduleAndStatus:function(callback){var controller=mstrApp.getRootController();controller.getScheduleController().getCubeSubscription({success:function(){var model=controller.getModel(),subs=model.subsInfo,dids=[];$A.forEach(subs,function(sub){dids.push(sub.did);});if(dids.length>0){controller.getScheduleController().getScheduleStatusBySubscription(dids,callback);}else{if(callback&&callback.success){callback.success();}if(callback&&callback.complete){callback.complete();}}},failure:function(res){if(callback&&callback.failure){callback.failure(res);}if(callback&&callback.complete){callback.complete();}}});},showScheduleStatusDialog:function(subsID,onOK){var m=mstrApp.getRootController().getModel();var status=m.subsStatus&&m.subsStatus[subsID];if(status){status=status.slice().reverse();}else{status=[];}var cfg={subsStatus:status};if(onOK){cfg.onOK=onOK;}mstrApp.getRootController().showDialog(mstrmojo.DI.DIConstants.dialogType.refreshHistoryDialog,cfg);},selectAlternateSourceURL:function(tableID,url,callback){var rootController=mstrApp.getRootController(),dataService=mstrApp.getRootController().dataService;var validateCallback={success:function(res){if(res.vt===1){if(callback.success){callback.success(res);}if(callback.complete){callback.complete();}}else{var items=mstrmojo.DI.DIHelpers.parseAlternateSourceValidationResults(res.cols);rootController.showDialog(constants.dialogType.alternateSourceValidateDialog,{items:items,zIndex:rootController.rootView.zIndex+10});}},failure:function(res){if(callback.failure){callback.failure(res);}if(callback.complete){callback.complete();}}};var editCallback={success:function(res){if(res&&res.msgid){dataService.set("emmaIRRMessageID",res.msgid);}dataService.validateEmmaIRRAlternateSource(validateCallback,{tbid:tableID});},failure:function(res){rootController.displayError(mstrmojo.desc(12837,"Cannot set alternate source."),false,(res&&res.message)||"");}};this.editEmmaIRRSourceTableURL(tableID,null,"0",url,editCallback);},isAdvMode:function isAdvMode(){return mstrApp.rootController.model.getSchedule().isScheduleAdvanced;},setAdvMode:function setAdvMode(isScheduleAdvanced){var model=mstrApp.rootController.model,schedule=model.getSchedule();if(schedule.isScheduleAdvanced!==isScheduleAdvanced){schedule.set("isScheduleAdvanced",isScheduleAdvanced);}},setAdvState:function setAdvState(bShow){var model=mstrApp.rootController.model,schedule=model.getSchedule();schedule.set("showAdvanceState",bShow);},isAdvState:function isAdvState(){return mstrApp.rootController.model.getSchedule().showAdvanceState;},getOldIsAdvMode:function getOldIsAdvMode(){return mstrApp.rootController.model.getSchedule().oldIsScheduleAdvanced;},setOldIsAdvMode:function setOldIsAdvMode(value){var model=mstrApp.rootController.model,schedule=model.getSchedule();if(schedule.oldIsScheduleAdvanced!==value){schedule.oldIsScheduleAdvanced=value;}},createEmmaIRRReportInstance:function createEmmaIRRReportInstance(reportID,deltaXML,callback){var dataService=mstrApp.getRootController().dataService,createCallback;if(dataService.emmaIRRMessageID){return ;}createCallback={success:function success(res){dataService.set("emmaIRRMessageID",res.msgid);}};dataService.createEmmaIRRReportInstance(mstrmojo.func.wrapMethods(createCallback,callback),{reportID:reportID||BLANK_EMMA_IRR_TEMPLATE_ID,delta:deltaXML||""});},createEmmaIRRSourceTables:function createEmmaIRRSourceTables(baseReportID,tableIds,refreshTypes,callback){var dataService=mstrApp.getRootController().dataService,params={};if(baseReportID){params.brid=baseReportID;}params.tbids=tableIds.join(",");params.crts=refreshTypes.join(",");dataService.createEmmaIRRSourceTables(mstrmojo.func.wrapMethods(emmaIRRCallback,callback),params);},editEmmaIRRSourceTableURL:function editEmmaIRRSourceTableURL(tableID,refreshType,deleteTable,url,callback){var dataService=mstrApp.getRootController().dataService,params={sourceType:IRR_SOURCE_TYPE_URL,tables:tableID};if(refreshType){params.refreshTypes=refreshType;}if(deleteTable){params.deleteTables=deleteTable;}if(url){params.url=url;}dataService.editEmmaIRRSourceTable(mstrmojo.func.wrapMethods(emmaIRRCallback,callback),params);},editEmmaIRRSourceTableSingleTable:function editEmmaIRRSourceTableSingleTable(tableID,refreshType,deleteTable,dbRoleID,dbNamespace,dbTableName,callback){var dataService=mstrApp.getRootController().dataService,params={sourceType:IRR_SOURCE_TYPE_SINGLE_TABLE,tables:tableID};if(refreshType){params.refreshTypes=refreshType;}if(deleteTable){params.deleteTables=deleteTable;}if(dbRoleID){params.dbRoleID=dbRoleID;}if(dbNamespace){params.dbNamespace=dbNamespace;}if(dbTableName){params.dbTableName=dbTableName;}dataService.editEmmaIRRSourceTable(mstrmojo.func.wrapMethods(emmaIRRCallback,callback),params);},editEmmaIRRSourceTableRefreshTypes:function editEmmaIRRSourceTableRefreshTypes(tableIDs,refreshTypes,deleteTables,callback){var dataService=mstrApp.getRootController().dataService,params={sourceType:IRR_SOURCE_TYPE_SINGLE_TABLE,tables:tableIDs.join(",")};if(refreshTypes){params.refreshTypes=refreshTypes.join(",");}if(deleteTables){params.deleteTables=deleteTables.join(",");}dataService.editEmmaIRRSourceTable(mstrmojo.func.wrapMethods(emmaIRRCallback,callback),params);},deleteEmmaIRRSourceTable:function deleteEmmaIRRSourceTable(tableIds,callback){mstrApp.getRootController().dataService.deleteEmmaIRRSourceTable(mstrmojo.func.wrapMethods(emmaIRRCallback,callback),{tbids:tableIds.join(",")});},getEmmaIRRAttributes:function getEmmaIRRAttributes(callback){mstrApp.getRootController().dataService.getEmmaIRRAttributes(callback);},setEmmaIRRFilter:function setEmmaIRRFilter(expression,callback){mstrApp.getRootController().dataService.setEmmaIRRFilter(mstrmojo.func.wrapMethods(emmaIRRCallback,callback),{exp:expression});},hasRefreshFilter:function hasRefreshFilter(){var m=mstrApp.getRootController().getModel(),ret=false;$H.forEach(m.isFilterInTable,function(v){if(v){ret=true;return false;}});return ret;},hasAlternateSource:function hasAlternateSource(){var m=mstrApp.getRootController().getModel(),ret=false;$H.forEach(m.importSources,function(source){if(source.alternateSource){ret=true;return false;}});return ret;}});}());