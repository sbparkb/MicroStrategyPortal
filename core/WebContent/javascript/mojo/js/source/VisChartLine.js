(function(){mstrmojo.requiresCls("mstrmojo.VisChart","mstrmojo.locales");var ROTATE_X_ADJUST=20;var ROTATE_Y_ADJUST=-20;var PLAIN_Y_ADJUST=25;var $H=mstrmojo.hash;var prevDate=null;mstrmojo.VisChartLine=mstrmojo.declare(mstrmojo.VisChart,null,{scriptClass:"mstrmojo.VisChartLine",fillinColor:null,rotateXLabels:false,isFillLinesArea:null,isAnimateLines:true,isDrawStartEndPoints:0,startEndPointRadius:5,startPointColor:null,endPointColor:null,prevLines:null,chartLineColors:["#0099FF","#FFB03C","#F26AE1","#888BF4","#93CA20","#FE2F68"],maxXLabels:6,DSS_XML_BASE_FORM_DATE:"8",drawChart:function drwchrt(){var model=this.model;if(model.err){return ;}var context=this.animationContext,mvalues=model.mvalues,values=model.series,margin=this.margin,lines=[],linesFrom=[],height=this.getHeight(),width=this.getWidth(),me=this,utils=this.utils;if(!values){return ;}var vl=values.length;if(this.isDrawAxis&&this.drawYAxisLabels){margin.l=utils.getLabelWidthForMargin(this,model.mls);}me.RTY=(height-margin.t-margin.b-5)/(mvalues[mvalues.length-1]-mvalues[0]);me.RTX=(width-margin.l-margin.r-1)/(me.windowSize-1);var mn=(mvalues[0]+mvalues[mvalues.length-1])/2;var mnY=utils.getYValue(me,mn);for(var j=0;j<vl;j++){lines=[];var k=0;for(var i=0;i<me.windowSize;i++){var val=values[j].rv[i];if(val.length===0){continue;}lines[k]={x:(i*me.RTX)+margin.l,y:utils.getYValue(me,val)};if(!this.prevLines){linesFrom[k]={x:lines[k].x,y:mnY};}k++;}this.drawChartLine(lines,linesFrom,vl,j,context);if(!this.multiLine){break;}}this.prevLines=lines;},drawChartLine:function drwcl(lines,linesFrom,vl,si,context,lw){var me=this,height=me.getHeight(),utils=me.utils;var cfg={rate:6};context.strokeStyle=utils.getColor(me);context.lineCap="round";context.lineWidth=lw||2;context.lineJoin="round";if(me.isAnimateLines&&(!me.multiLine||vl===1)){if(me.prevLines){linesFrom=me.prevLines;if(linesFrom.length<lines.length){for(var i=linesFrom.length;i<lines.length;i++){linesFrom.push(lines[linesFrom.length-1]);}}}utils.animateLineSet(me,me.prevLines||linesFrom,lines,cfg);}else{if(me.multiLine&&vl>1){context.strokeStyle=me.chartLineColors[si%6];}utils.drawLineSet(me,lines,false,context);if(me.isFillLinesArea){utils.fillLinesArea(me,lines.slice(0));}if(me.isDrawStartEndPoints){utils.drawStartEndPoints(me,lines,context,me.isDrawStartEndPoints);}}},setMicroChartProperties:function setMicroChartProperties(){this.isDrawAxis=false;this.margin={t:0,r:5,b:0,l:5};this.showHighlightLine=false;this.isDrawStartEndPoints=3;},initFromVisProps:function initFromVisProps(vp){if(!vp){return ;}if(vp.thc){this.themeColor="#"+vp.thc;}if(vp.shl==="0"){this.showHighlightLine=false;}if(vp.mc==="1"){this.setMicroChartProperties();}},postCreate:function pstCrt(){if(this._super){this._super();}if(this.rotateXLabels){this.margin.b=75;}if(typeof (this.isFillLinesArea)==="undefined"&&!this.multiLine){this.isFillLinesArea=true;}},drawLabels:function drwlbls(needNotDrawVerticalGridLine){if(!this.isDrawAxis){return ;}if(this._super){this._super();}if(!this.drawXAxisLabels){return ;}var me=this,cat=me.model.categories,labels=cat.items,tp=cat.tp,utils=me.utils,mg=me.margin,l=labels.length,li=null,x=null,y=0,lbl=null,ts=me.isTimeSeries,ctx=me.animationContext,dgl=me.drawGridLines;var pxl=me.prevXLabel;pxl.x=0;pxl.y=0;pxl.w=0;ctx.save();ctx.globalAlpha=1;ctx.strokeStyle=utils.rgb2rgbStr(me.formatProp.textClr,0.35);ctx.lineWidth=1;ctx.lineCap="round";var totalLabels=l>me.maxXLabels?me.maxXLabels:l;var xlblDiv=null;if(ts){xlblDiv=document.createElement("div");me.xdiv=xlblDiv;totalLabels*=(me.totalChartWidth/(me.chartWidth));}if(me.rotateXLabels){y=me.canvas.height+ROTATE_Y_ADJUST;}else{if(ts){y=me.canvas.height-this.margin.b+5;}else{y=me.canvas.height-PLAIN_Y_ADJUST;}}var labInterval=Math.round(l/totalLabels);if(labInterval===0){labInterval=1;}var lw=Math.round(labInterval*me.RTX)-me.xLabelPadding;prevDate=null;var curPrevDate={mn:0,dt:0,yr:0};if(ts){var labelDisplayStatus=-1;this.needRedrawVerticalLine=false;var firstX=Math.ceil(me.ACrns/labInterval)*labInterval-me.ACrns;for(var i=me.ACrns+firstX;i<me.ACrne;i+=labInterval){x=((i-me.ACrns)*me.RTX);var dtlbl=labels[i];if(labelDisplayStatus<0&&i>=me.model.rns){labelDisplayStatus=0;}if(ts&&(tp.toString()===me.DSS_XML_BASE_FORM_DATE)){if(labelDisplayStatus==0){prevDate=null;labelDisplayStatus=1;}dtlbl=me.getFormattedDateLabel(dtlbl,curPrevDate);}if(me.rotatXLabels){lbl=utils.addLabel(me,dtlbl,x-ROTATE_X_ADJUST,y,null,true,pxl);}else{lbl=utils.addLabel(me,dtlbl,x,y,null,false,pxl);}if(lbl){if(dgl&me.drawVerticalGridLines){prevDate=$H.clone(curPrevDate);if(!needNotDrawVerticalGridLine){var xPos=Math.floor(x)+0.5;utils.drawLineSet(me,[{x:xPos,y:me.canvas.height-mg.b},{x:xPos,y:mg.t}],false,ctx);}}}}}else{for(var i=0;i<l;i+=labInterval){x=(i*me.RTX)+mg.l;var dtlbl=labels[i];if(ts&&(tp.toString()===me.DSS_XML_BASE_FORM_DATE)){dtlbl=me.getFormattedDateLabel(dtlbl,curPrevDate);}if(me.rotateXLabels){lbl=utils.addLabel(me,dtlbl,x-ROTATE_X_ADJUST,y,null,true,pxl);}else{lbl=utils.addLabel(me,dtlbl,x,y,lw,false,pxl);}if(lbl){if(dgl&me.drawVerticalGridLines){prevDate=$H.clone(curPrevDate);utils.drawLineSet(me,[{x:x,y:me.canvas.height-mg.b},{x:x,y:mg.t}],false,ctx);}}}}if(xlblDiv){if(this.isTimeSeries){me.xLabelsDiv.innerHTML=xlblDiv.innerHTML;me.xdiv=null;}else{var tc=me.animationCanvas;me.itemsContainerNode.innerHTML=xlblDiv.innerHTML;me.itemsContainerNode.insertBefore(tc,me.itemsContainerNode.firstChild);me.xdiv=null;}}ctx.restore();},getFormattedDateLabel:function getFormattedDateLabel(val,cpv){if(isNaN(val)){return val;}var fVal=val;try{val=this.utils.convertRawValueToMilliseconds(val);var dt=new Date(Number(val));var mn=cpv.mn=mstrmojo.locales.datetime.MONTHNAME_SHORT[dt.getMonth()];var yr=cpv.yr=dt.getFullYear().toString().substring(2);cpv.dt=dt.getDate();if(!prevDate||(mn!==prevDate.mn&&yr!==prevDate.yr)){fVal=mn+" "+cpv.dt+" "+yr;}else{if(mn!==prevDate.mn){fVal=mn+" "+cpv.dt;}else{fVal=cpv.dt;}}}catch(e){}return fVal;},removeLabels:function rmvlbls(){var todel=this.domNode.getElementsByClassName("mstrmojo-Chart-lbl");for(var i=todel.length-1;todel&&i>=0;i--){todel[i].parentElement.removeChild(todel[i]);}},highlightPoint:function hghlghtpnt(x,touchY){var me=this,ctx=me.highlightContext,height=me.getHeight(),margin=me.margin,model=me.model,utils=me.utils,si=me.seriesIndex;var xcoord=(x*me.RTX)+margin.l;if(this.prevHighlight>=0){var prevXCoord=(this.prevHighlight*me.RTX)+margin.l;var PADDING=10;var TOP_PADDING=8;var y=margin.t-TOP_PADDING>0?margin.t-TOP_PADDING:0;ctx.clearRect(prevXCoord-PADDING,y,prevXCoord+PADDING,height-margin.b);}if(x<0){return ;}var xcoord=(x*me.RTX)+margin.l;ctx.shadowBlur=5;ctx.shadowColor="#000";ctx.globalAlpha=1;if(me.showHighlightLine){ctx.strokeStyle=this.highlightColor;ctx.fillStyle=this.highlightColor;ctx.lineWidth=2;ctx.lineCap="round";utils.drawLineSet(me,[{x:xcoord,y:margin.t},{x:xcoord,y:height-margin.b}],false,ctx);}else{ctx.strokeStyle=utils.getColor(me);ctx.fillStyle=ctx.strokeStyle;}var s=model.series,l=s.length,y=utils.getYValue(me,s[si].rv[x]);if(!me.multiLine){utils.drawArc(me,xcoord,y,5,0,Math.PI*2,true,true,ctx);}else{if(me.showHighlightLine){if(l>1){ctx.strokeStyle=this.chartLineColors[0];ctx.fillStyle=ctx.strokeStyle;}for(var i=0;i<l;i++){ctx.strokeStyle=this.chartLineColors[i%6];if(i>0){ctx.fillStyle=ctx.strokeStyle;}y=utils.getYValue(me,s[i].rv[x]);utils.drawArc(me,xcoord,y,5,0,Math.PI*2,true,true,ctx);}}else{if(l>1){ctx.strokeStyle=this.chartLineColors[si];ctx.fillStyle=ctx.strokeStyle;}utils.drawArc(me,xcoord,utils.getYValue(me,s[si].rv[x]),5,0,Math.PI*2,true,true,ctx);}}},refreshChart:function refreshChart(){var height=this.getHeight(),width=this.getWidth();this.highlightContext.clearRect(0,0,width,height);this.animationContext.clearRect(0,0,width,height);this.removeLabels();this.drawChart();this.drawLabels();}});})();