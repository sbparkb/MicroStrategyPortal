(function(){mstrmojo.requiresClsP("mstrmojo","Editor","HBox","HTMLButton","Label","SortRow","ButtonSwitch","CheckBox","_HasOwnAvatar");mstrmojo.requiresCls("mstrmojo.ui._HasScroller","mstrmojo.mstr.EnumDSSXMLObjectTypes");mstrmojo.requiresDescs(11591,3095,11592,2968,122,221,1442,13153);var $DESC=mstrmojo.desc,$ARR=mstrmojo.array,$DOM=mstrmojo.dom,$CSS=mstrmojo.css,ROW=0,ENUM_EDGE_TOP="top",ENUM_EDGE_BOTTOM="bottom",$EID;mstrmojo.AdvancedSortData=null;function addNewRule(parent,type){var newRule=new mstrmojo.SortRow(),editor=mstrmojo.all[$EID];newRule.setPulldownOptions(type===ROW?editor.sortData.rows:editor.sortData.cols);newRule.setRank(parent.children.length+1);parent.addChildren([newRule]);}function setAppliedRules(parent,applied,type){var i,j,rule,children=parent.children,editor=mstrmojo.all[$EID],filterRules=function(){var i,ilen,j,jlen,rule,sortData=(type===ROW?editor.sortData.rows:editor.sortData.cols),result=[];for(i=0,ilen=applied.length;i<ilen;i++){rule=applied[i];for(j=0,jlen=sortData.length;j<jlen;j++){if(rule.value===sortData[j].v){result.push(rule);break;}}}return result;};if(!editor.isDesignMode){applied=filterRules();}for(i=0,j=0;i<children.length&&j<applied.length;i++,j++){rule=applied[j];children[i].setSelected(rule.value,rule.isAsc,rule.n);}for(;i<children.length;i++){children[i].setSelected("",1);}for(;j<applied.length;j++){rule=applied[j];addNewRule(parent,type);children[j].setSelected(rule.value,rule.isAsc,rule.n);}}function appendBlankRowToEnd(){var children=this.children;if(children[children.length-1].getSortKey()===""){return ;}addNewRule(this,this.type);}function reorder(){var j,children=this.children;for(j=0;j<children.length;j++){var child=children[j];if(child.getRank()!==j+1){child.setRank(j+1);}}}function submitChanges(){var i,j,sortKey,sorts=[],editor=mstrmojo.all[$EID],names=["appliedRows","appliedCols"],children=[];children.push(editor.tabContainer.children[0].children);children.push(editor.tabContainer.children[1].children);for(j=0;j<2;j++){var axisSorts=[];for(i=0;i<children[j].length;i++){sortKey=children[j][i].getSortKey();if(sortKey&&sortKey!==" "){axisSorts.push({key:sortKey,isAsc:children[j][i].isAscending()});}}if(axisSorts.length===0){if(editor.sortData[names[j]].length===0){axisSorts=null;}}sorts.push(axisSorts);}var hrlSort=editor.sortData.hierarchicalSort,stt=editor.hrlSortBox.checked?hrlSort.stt:null,rp=editor.resHrlBox.checked?"1":"0";editor.controller.onAdvancedSort(editor.xtab,sorts,null,stt,rp);}mstrmojo.AdvancedSortEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.AdvancedSortEditor",help:"advanced_sort_editor.htm",cssClass:"mstrmojo-AdvancedSortEditor",title:$DESC(11591,"Advanced Sort"),tabSwitcher:undefined,tabContainer:undefined,hrlSortBox:undefined,sortData:undefined,sourceAxis:1,init:function init(props){this._super(props);$EID=this.id;},onOpen:function onOpen(){var sortData=this.sortData,appliedRules,names=["appliedRows","appliedCols"],targetAxis=this.sourceAxis-1;$ARR.forEach(this.tabContainer.children,function(panel,i){appliedRules=sortData[names[i]];$ARR.forEach(panel.children,function(sortRow){sortRow.setPulldownOptions(sortData[i===ROW?"rows":"cols"]);});setAppliedRules(panel,appliedRules,i);appendBlankRowToEnd.call(panel);reorder.call(panel);});if(this.sourceType===mstrmojo.mstr.EnumDSSXMLObjectTypes.Metric){targetAxis^=1;}this.tabSwitcher.set("selected",targetAxis);this.tabContainer.updateScrollbars();this.updateUseHierarchicalSort(targetAxis);},onClose:function(){$ARR.forEach(this.tabContainer.children,function(panel){$ARR.forEach(panel.children,function(sortRow){sortRow.resetPulldownOptions();});});},onTabChange:function(selected){var tab=this.tabContainer;tab.children[selected].set("visible",true);tab.children[1-selected].set("visible",false);tab.set("selected",selected);tab.updateScrollbars();this.updateUseHierarchicalSort(selected);},updateUseHierarchicalSort:function updateUseHierarchicalSort(axis){var axisName=(axis===ROW)?"rows":"cols",ruleName=(axis===ROW)?"appliedRows":"appliedCols",sortData=this.sortData,hierarchicalSort=sortData.hierarchicalSort,hrlPref=hierarchicalSort.pref,isRespectParent=hierarchicalSort.rp,isOutlineMode=hierarchicalSort.isOutlineMode,hasHrlSort=hierarchicalSort.isRA,appliedRules=sortData[ruleName],hrlSortBox=this.hrlSortBox,resHrlBox=this.resHrlBox;hrlSortBox.set("visible",hrlPref==="1");hrlSortBox.set("checked",isOutlineMode||(hrlPref==="1"&&(appliedRules.length===0||hasHrlSort)));resHrlBox.set("visible",false);resHrlBox.set("checked",isRespectParent);},updateTooltipConfig:function updateTooltipConfig(){if($DOM.isIE8){this.richTooltip.cssClass+=" ie8";updateTooltipConfig.repaint=!!!updateTooltipConfig.repaint;this.richTooltip.cssClass+=(updateTooltipConfig.repaint?" repaint":"");}},postBuildRendering:function postBuildRendering(){this._super();this.tabContainer.domNode.onselectstart=function(){return false;};},children:[{scriptClass:"mstrmojo.ButtonSwitch",alias:"tabSwitcher",label1:$DESC(2968,"Rows"),label2:$DESC(122,"Columns"),switchFn:function onselectedChange(){this.parent.onTabChange(this.selected);}},{scriptClass:"mstrmojo.Widget",markupString:"<div class='rulesTitles'><div>"+$DESC(3095,"Order")+"</div><div>"+$DESC(11592,"Sort by")+"</div></div>"},{scriptClass:"mstrmojo.SortRulesPanelContainer",alias:"tabContainer",cssClass:"mstrmojo-AdvancedSortEditor-RulesPanelContainer"},{scriptClass:"mstrmojo.CheckBox",alias:"hrlSortBox",cssClass:"hrlSortBox",oncheckedChange:function(){if($DOM.isIE8){$CSS[this.checked?"addClass":"removeClass"](this.labelNode,"checked");}},postBuildRendering:function postBuildRendering(){if($DOM.isIE8){var me=this,labelNode=this.labelNode;$DOM.attachEvent(labelNode,"click",function(){me.set("checked",!me.checked);});}},label:$DESC(13153,"Sort metrics hierarchically")},{scriptClass:"mstrmojo.CheckBox",alias:"resHrlBox",cssClass:"resHrlBox",oncheckedChange:function(){if($DOM.isIE8){$CSS[this.checked?"addClass":"removeClass"](this.labelNode,"checked");}},postBuildRendering:function postBuildRendering(){if($DOM.isIE8){var me=this,labelNode=this.labelNode;$DOM.attachEvent(labelNode,"click",function(){me.set("checked",!me.checked);});}},label:$DESC(12420,"Respect Hierarchy")},{scriptClass:"mstrmojo.Button",slot:"buttonNode",cssClass:"mstrmojo-WebButton Advanced-Sort-Editor-Button",text:$DESC(221,"Cancel"),onclick:function(){mstrmojo.all[$EID].close();}},{scriptClass:"mstrmojo.Button",slot:"buttonNode",cssClass:"mstrmojo-WebButton Advanced-Sort-Editor-Button",iconClass:"hot",text:$DESC(1442,"OK"),onclick:function(){submitChanges();mstrmojo.all[$EID].close();}}]});function getIndexByMousePosition(y,dragData){var idx=Math.floor((y-dragData.y0-$DOM.getVerticalScroll())/dragData.h);if(idx<0){idx=0;}else{if(idx>=this.children.length){idx=this.children.length-1;}}return idx;}function getTargetEdge(y,dragData){var edge=ENUM_EDGE_TOP,pos=(Math.floor(y-dragData.y0)%dragData.h)/dragData.h,idx=getIndexByMousePosition.call(this,y,dragData);if(idx===this.children.length-1){if(pos>0.5||Math.floor((y-dragData.y0)/dragData.h)>idx){edge=ENUM_EDGE_BOTTOM;}}else{if(pos>0.5){if(idx<this.children.length-1){idx+=1;}}}return{edge:edge,idx:idx};}mstrmojo.SortRulesPanelContainer=mstrmojo.declare(mstrmojo.Box,[mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.SortRulesPanelContainer",selected:undefined,setupScrollNodes:function setupScrollNodes(){var selectedPanel=this.children[this.selected||0];this.scrollNode=selectedPanel.domNode;if(!selectedPanel.hasEventListener){$CSS.addClass(this.scrollNode,"mstrmojo-scrollNode");$DOM.attachMarkupEvent(this.id,this.scrollNode,"scroll");selectedPanel.set("hasEventListener",true);}},onscroll:function onscroll(){if(this._super){this._super();}var target;$ARR.forEach(this.children,function(child){if(!target){$ARR.forEach(child.children,function(sc){if(!target){var rlist=sc.sortRule.list,olist=sc.sortOrder.list;if(rlist.visible){target=rlist;}else{if(olist.visible){target=olist;}}}});}});if(target){target.set("visible",false);}},children:[{scriptClass:"mstrmojo.SortRulesPanel",cssClass:"mstrmojo-AdvancedSortEditor-RulesPanel",type:0},{scriptClass:"mstrmojo.SortRulesPanel",cssClass:"mstrmojo-AdvancedSortEditor-RulesPanel",type:1}]});mstrmojo.SortRulesPanel=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasOwnAvatar],{scriptClass:"mstrmojo.SortRulesPanel",dropZone:true,draggable:true,avatarCssClass:"sort-rule-drag-avatar",type:undefined,hasEventListener:undefined,getDragData:function getDragData(){return{};},createAvatar:function createAvatar(node,context){var dragData=context.src.data;dragData.y0=$DOM.position(this.domNode).y;dragData.h=$DOM.position(this.children[0].domNode).h;dragData.left=$DOM.position(this.children[0].domNode).x;var i=getIndexByMousePosition.call(this,context.src.pos.y,dragData),avatar=this.children[i].domNode.cloneNode(true);dragData.index=i;dragData.node=this.children[i];return avatar;},positionAvatar:function positionAvatar(pos,context){pos.x=context.src.data.left+10;this._super(pos,context);},isDragValid:function isDragValid(context){if(this.children.length===1){return false;}var domNode=this.domNode,child=this.children[Math.floor((context.src.pos.y-$DOM.position(domNode).y-$DOM.getVerticalScroll())/$DOM.position(this.children[0].domNode).h)],srcTarget=context.src.e.target;return !($DOM.contains(child.sortRule.domNode,srcTarget,true,domNode)||$DOM.contains(child.sortOrder.domNode,srcTarget,true,domNode));},ondragstart:function(context){this._super(context);var dragData=context.src.data;this.removeChildren(this.children[dragData.index]);dragData.y0=$DOM.position(this.domNode).y;},ondragmove:function ondragmove(context){var dragData=context.src.data,y=context.last.y,lastIdx=dragData.tgtIdx,lastEdge=dragData.tgtEdge,target=getTargetEdge.call(this,y,dragData),curIdx=target.idx,curEdge=target.edge;if(lastIdx!==curIdx||lastEdge!==curEdge){if(lastIdx!==undefined){$CSS.removeClass(this.children[lastIdx].domNode,lastEdge);}$CSS.addClass(this.children[curIdx].domNode,curEdge);dragData.tgtIdx=curIdx;dragData.tgtEdge=curEdge;}this._super(context);},ondragend:function ondragend(context){var dragData=context.src.data,i=dragData.tgtIdx;if(i!==undefined){$CSS.removeClass(this.children[i].domNode,dragData.tgtEdge);}if(dragData.tgtEdge===ENUM_EDGE_BOTTOM){i++;}this.addChildren([dragData.node],i);this.updatePanel();this._super(context);},pulldownActive:function(isOpen){mstrmojo.css.toggleClass(mstrmojo.all[$EID].tabContainer.domNode,"disableScroller",isOpen);},updatePanel:function(){reorder.call(this);appendBlankRowToEnd.call(this);mstrmojo.all[$EID].tabContainer.updateScrollbars();},deleteSortRule:function(node){this.removeChildren(node);this.updatePanel();},itemSelected:function(){this.updatePanel();},children:[{scriptClass:"mstrmojo.SortRow"},{scriptClass:"mstrmojo.SortRow"},{scriptClass:"mstrmojo.SortRow"}]});}());