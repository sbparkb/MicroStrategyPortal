(function(){mstrmojo.requiresCls("mstrmojo.XtabBase","mstrmojo._Formattable","mstrmojo._IsSelectorTarget","mstrmojo._IsDocXtab","mstrmojo._XtabSelections","mstrmojo._XtabCellHoverMgr","mstrmojo.XtabCellHoverPopup","mstrmojo._HasPopup","mstrmojo.dom");var LOCK_OFF=0,OVERFLOW_A="overflow:auto",OVERFLOW_H="overflow:hidden",$DOM=mstrmojo.dom,$PS="mstrmojo.DocPanelStack",PX="px",SUPPRESS_DATA_PROPS=mstrmojo.DocDataService.SUPPRESS_DATA,$DATA_INTERFACE=mstrmojo.models.template.DataInterface,$ENUM_GRID_RESIZE=$DATA_INTERFACE.ENUM_GRID_RESIZE,$FIXED_SCENARIO=$ENUM_GRID_RESIZE.FIXED,$FIT_TO_WIN_SCENARIO=$ENUM_GRID_RESIZE.FIT_TO_WINDOW,$FIT_TO_CON_SCENARIO=$ENUM_GRID_RESIZE.FIT_TO_CONTENTS;var fc=function findContainerByScriptName(w,s){var anc=w&&w.parent;while(anc&&anc.scriptClass!==$PS){if(anc.scriptClass===s){return anc;}anc=anc.parent;}return anc;};mstrmojo.Xtab=mstrmojo.declare(mstrmojo.XtabBase,[mstrmojo._Formattable,mstrmojo._IsSelectorTarget,mstrmojo._IsDocXtab,mstrmojo._XtabSelections,mstrmojo._HasPopup],{scriptClass:"mstrmojo.Xtab",cellHoverMgr:"mstrmojo._XtabCellHoverMgr",cellHoverPopupRef:"mstrmojo.XtabCellHoverPopup",preBuildRendering:function preBuildRendering(){var rtn=this._super();var gd=this.gridData;var overflowClip=this.lockHeadersCase===LOCK_OFF&&gd.co;this.scrollboxNodeOverflow=overflowClip&&!this.numRowFixed?OVERFLOW_H:OVERFLOW_A;var f=this.getFormats();if(mstrmojo.dom.isIE8&&!gd.co&&this.lockHeadersCase===LOCK_OFF&&(!gd.rw||(gd.rw&&(gd.rw.row.bc>=gd.rw.row.tc)))&&mstrmojo.string.isEmpty(f.height)&&mstrmojo.string.isEmpty(f.width)){this.scrollboxNodeOverflow="";}this._useFilter=this._useFilter||gd.cssflt||false;return rtn;},postBuildRendering:function postBldRndr(){var gd=this.gridData,rtn=this._super();if(this.supportsContextMenu()){var xtab=this;if(this.viewport){this.viewport.onmouseover=function(){xtab.addDisposable(xtab.requiresContrib("cellHoverMgr",true));xtab.viewport.onmouseover=null;};}}if(!this.getFormats().width&&this.model.docModel.addAutoWidthID&&(this.parent&&this.parent.scriptClass!=="mstrmojo.ExpressDocPanel")){this.model.docModel.addAutoWidthID(this.id);gd=this.gridData;var afc=gd&&gd.afc;if(afc&&mstrmojo.dom.isIE7){var p=fc(this,$PS);if(p&&p.scriptClass===$PS){this.viewport.style.width=this.contentNode.offsetWidth+(this.scrollboxNode.offsetWidth-this.scrollboxNode.clientWidth)+"px";}}}if($DOM.isIE&&!$DOM.isIE8&&this._useFilter){var sn=this.scrollboxNode;window.setTimeout(function(){var img=document.createElement("img");sn.appendChild(img);sn.removeChild(img);},0);}return rtn;},supportsContextMenu:function supportsContextMenu(){return !$DOM.supportsTouches;},onCGBMapChange:function(evt){if(this._resolveCGBToTKS(evt.cgbMap)&&this._currentSelectedTD){this.defaultAction(this._currentSelectedTD);}},_resolveCGBToTKS:function _resolveCGBToTKS(cgbMap){if(!cgbMap){return false;}var scm=this.model.scm,delim="\u001E",i,id,curSelector,cgb,targetKey,updatedTks=false;for(id in scm){curSelector=scm[id];cgb=curSelector.cgb;for(i in cgb){targetKey=cgbMap[cgb[i]];if(targetKey){if(!curSelector.tks){curSelector.tks=targetKey;updatedTks=true;}else{if(curSelector.tks&&(curSelector.tks.indexOf(targetKey)<0)){curSelector.tks+=delim+targetKey;updatedTks=true;}}}}}return updatedTks;},onGridWidthChanged:function onGridWidthChange(b){if(this._super){this._super(b);}if(this.cellHoverMgr.onXtabWidthChanged){this.cellHoverMgr.onXtabWidthChanged();}},getDim:function(){var cn=this.contentNode;return{w:cn.scrollWidth,h:cn.scrollHeight};},unrender:function unrender(ignoreDom){var chm=this.cellHoverMgr;if(chm&&chm.shutdown){chm.shutdown();}this._super(ignoreDom);},link:function link(cell,idx){this.controller.onLink(this,this.model.getLinkAction(cell,idx));},sort:function sort(cell,isAsc){this.controller.onSort(this,this.model.getSortAction(cell,isAsc));},advSort:function advSort(cell,axis){this.controller.onGetAdvSortData(this,axis,cell._e&&cell._e.otp);},pivot:function pivot(cell,btn){this.controller.onPivot(this,this.model.getPivotAction(cell,btn));},drill:function drill(cell,drillPath){this.controller.onDrill(this,this.model.getDrillAction(this.getActionCells(cell),drillPath));},removeUnit:function removeUnit(cell){this.controller.onRemoveUnit(this,this.model.getRemoveTemplateUnitAction({id:cell._e?cell._e.oid:cell.id,t:cell._e?cell._e.otp:cell.otp}));},showTotal:function showTotal(cell,subtotalType,clearSubtotalType){this.controller.onShowTotals(this,this.model.getTotalsAction(cell,subtotalType,clearSubtotalType));},derivedMetric:function derivedMetric(cell,cmd){var config,did=cell._e.oid,actionParams={did:did,alias:cell._e.n,n:cell._e.n,v:cell.um?cell.formula:cell._e.v,idx:cell.mix,host:this,nodeKey:this.k,dsid:this.controller.model.findDatasetIdFromUnit(did)||this.model.data.datasetId},callback;if(cmd==="edit"){config={metricId:actionParams.did,action:{cmd:"edit",n:actionParams.n,alias:actionParams.alias}};callback=this.controller.model.getDataService().getEditDerivedMetricSubmitFunc(actionParams);}else{config={metricId:"",action:{cmd:"editNew",refOi:{did:actionParams.did,n:actionParams.n}}};callback=this.controller.model.getDataService().getAddNewDerivedMetricToXtabSubmitFunc(actionParams);}var docmodel=this.controller.model;if(docmodel.isFromSolrCube&&docmodel.isFromSolrCube(actionParams.did)||docmodel.isFromMDXCube(actionParams.did)){config.disableAFB=true;}this.controller.openDME(this,config,callback);},findSelectorControl:function findSelectorControl(){var selectorControl=this.gridData.sc;if(selectorControl&&parseInt(selectorControl.ct,10)===6){this.selectorControl=selectorControl;}else{delete this.selectorControl;}return this.selectorControl;},handlesMultiSelection:function handlesMultiSelection(evt){var cell=this.getCellForNode($DOM.findAncestorByName(evt.getTarget(),"td",true,this.viewport)),unit=cell&&this.model.data.gts[cell.axis===1?"row":"col"][cell.tui||cell.ui],singleUnitSelector=unit&&unit.id&&unit.sc;return !!(this.findSelectorControl()||singleUnitSelector);},getBasicSubtotalEditorConfig:function getBasicSubtotalEditorConfig(subtotals){var cfgEditor=new mstrmojo.ui.menus.EditorConfig({contents:new mstrmojo.express.ui.SubtotalsWidget({onchange:function onchange(){var types=this.getSubtotalTypes(),selectionChanged=types[0].length>0||types[1].length>0;cfgEditor.set("okEnabled",selectionChanged);}}),data:{},okEnabled:false});if(!this.model.data.gsi.hidesb){cfgEditor.contents.set("selectedItems",subtotals||[]);}return cfgEditor;},updateRelatedColWidths:function updateRelatedColWidths(colWidths){var columnsData=(new mstrmojo.models.template.DataInterface(this.gridData)).getColumnHeaderData(),tabularWidthModel=this.gridData.twm||{},bottomWidths=tabularWidthModel.bottom,topWidths=tabularWidthModel.top;(colWidths||[]).forEach(function(col){var currentHeader=columnsData[col.colIndex],relatedIndices=currentHeader._ridx||[];if(relatedIndices.length>1){relatedIndices.forEach(function(index){topWidths[index].w=bottomWidths[index].w=col.value;});}else{topWidths[col.colIndex].w=bottomWidths[col.colIndex].w=col.value;}});this.refresh();},updateScenario:function updateScenario(scenario){var gridData=this.gridData;gridData.afc=scenario===$FIT_TO_CON_SCENARIO;gridData.afw=scenario===$FIT_TO_WIN_SCENARIO;if(scenario!==$FIXED_SCENARIO){this.setAllXtabWidths("");}this.refresh();},setAllXtabWidths:function setAllXtabWidths(width){},changeResizeScenario:function changeResizeScenario(scenario,isColumns,changedColumnSize,silent){var templateInterface=new mstrmojo.models.template.DataInterface(this.gridData),tabularWidthModel=this.gridData.twm||{},bottomWidths=tabularWidthModel.bottom,columnsData=templateInterface.getColumnHeaderData(),me=this,model=this.model,id=this.id,key=this.k,actions=[],currentValues=[],currentFormIndex=1,distinctCols=[];if(isColumns){actions.push({act:"changeXtabColWidthScenario",value:scenario});columnsData.forEach(function(col,index){var id=col.oid||col.id,fnRedundant=function(item){return item.unitId===id&&item.depth===currentFormIndex;};if(!(col.fs&&col.fs.length>0)){currentFormIndex=1;}var isTarget=id===(changedColumnSize&&changedColumnSize.did)&&currentFormIndex===changedColumnSize.depth;if(!distinctCols.some(fnRedundant)){distinctCols.push({unitId:id,depth:currentFormIndex});currentValues.push({colIndex:index,value:isTarget?changedColumnSize.width+PX:bottomWidths[index].w});if(scenario===$FIXED_SCENARIO){actions.push(model.getColumnResizeAction(id,col.otp,isTarget?changedColumnSize.width:parseInt((bottomWidths[index].w)||0,10),currentFormIndex,isTarget?changedColumnSize.isExtra:false));}}currentFormIndex++;});var updateWidths=function updateWidths(scenario,colValues){var xtab=mstrmojo.all[id];if(scenario===$FIXED_SCENARIO){me.updateRelatedColWidths(colValues);}me.updateScenario(scenario);};updateWidths(scenario,currentValues);me.submitColumnWidthChange(actions,silent);}return silent?actions:undefined;},submitColumnWidthChange:function submitColumnWidthChange(actions,silent){if(!silent){this.model.getDataService().submitTemplateUpdates(this.k,actions,{success:function success(){}},SUPPRESS_DATA_PROPS);}},changeColumnWidth:function changeColumnWidth(unitId,unitType,width,formIndex,isExtraColumn,silent){var templateInterface=new mstrmojo.models.template.DataInterface(this.gridData),columnsData=templateInterface.getColumnHeaderData(),model=this.model,actions=[],me=this,currentValues=[],currentFormIndex=1,currentColIndex=-1,distinctCols=[];if(templateInterface.getColResizeScenario()!==$FIXED_SCENARIO){actions=this.changeResizeScenario($FIXED_SCENARIO,true,{did:unitId,t:unitType,width:width,depth:formIndex,isExtra:isExtraColumn},silent);return silent?actions:undefined;}if(unitId==="all"){columnsData.forEach(function(col,index){var id=col.oid||col.id,fnRedundant=function(item){return item.unitId===id&&item.depth===currentFormIndex;},previousCol=columnsData[index-1];if(!(col.fs&&col.fs.length>0)||(previousCol&&id!==(previousCol.oid||previousCol.id))){currentFormIndex=1;}if(!distinctCols.some(fnRedundant)){distinctCols.push({unitId:id,depth:currentFormIndex});currentValues.push({colIndex:index,value:width+PX});actions.push(model.getColumnResizeAction(id,col.otp,width,currentFormIndex,false));}currentFormIndex++;});}else{columnsData.every(function(col,index){var isItem=(col.oid===unitId||col.id===unitId);if(isItem){currentColIndex=index+formIndex-1;}return !isItem;});if(currentColIndex>=0){currentValues.push({colIndex:currentColIndex,value:width+PX});actions.push(model.getColumnResizeAction(unitId,unitType,width,formIndex,isExtraColumn));}}me.updateRelatedColWidths(currentValues);me.submitColumnWidthChange(actions,silent);return silent?actions:undefined;}});}());