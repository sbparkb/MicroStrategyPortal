(function(){mstrmojo.requiresCls("mstrmojo.VisBase","mstrmojo.Widget","mstrmojo.VisUtility","mstrmojo.VisEnum","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.vi.ui.rw._XtabDE","mstrmojo.vi.ui.rw._HasVisSelections","mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl","mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights","mstrmojo.Button","mstrmojo.models.template.DataInterface","mstrmojo.string","mstrmojo.dom","mstrmojo.array","mstrmojo.DocDataService","mstrmojo.hash","mstrmojo.gm.GMUtility","mstrmojo.func.composite","mstrmojo._colorPalette");var $DOM=mstrmojo.dom,$ARR=mstrmojo.array,$DSSOBJ_TYPES=mstrmojo.chart.model.enums.EnumDSSObjectType,$HASH=mstrmojo.hash,$NWB=mstrmojo.Button.newWebButton,$COMPOS=mstrmojo.func.composite,$FNEMPTY=mstrmojo.emptyFn,$UTIL=mstrmojo.VisUtility,$VIS_ENUM=mstrmojo.VisEnum,$GM_UTIL=mstrmojo.gm.GMUtility;var FILTER_TYPE={SHARED:0};function getErrorCtrlOverlay(){return[{scriptClass:"mstrmojo.Label",cssClass:"dropMsg",text:this.errorMessage+" "+this.errorDetails}];}function toggleError(show){this.raiseEvent({name:"toggleCtrlOverlay",visible:show,controls:getErrorCtrlOverlay.call(this)});}function hideFilterMenuOption(){var vizContainer=this.parent,titleBar=vizContainer&&vizContainer.titleBar,toolbarCfg=titleBar&&titleBar.getMenuConfig();if(!toolbarCfg){return ;}toolbarCfg.menus=$ARR.filter(toolbarCfg.menus,function(item){return item.cls!=="uaf";});}function getSetPropertiesAction(){var modelData=this.model.data,xmlDom,xmlString;var convertJSONToXML=function(object,tagName){var ret=xmlDom.createElement(tagName),key;if(object instanceof Object){for(key in object){if(object.hasOwnProperty(key)){var child=convertJSONToXML(object[key],key);if(child){ret.appendChild(child);}}}}else{ret.setAttribute("value",object);}return ret;},encodeXMLString=function(xmlString){return xmlString.replace(/</g,"&lt;").replace(/"/g,"&quot;");};xmlDom=(new DOMParser()).parseFromString("<props><widgetProps><fmt></fmt></widgetProps></props>","text/xml");xmlDom.firstChild.firstChild.firstChild.appendChild(convertJSONToXML(this.getProperties(),"cvp"));xmlString=(new XMLSerializer()).serializeToString(xmlDom);return[{act:"setProperty",nodeKey:modelData.k,prs:"FormattingWidget",pri:4,v:encodeXMLString(xmlString)}];}function isValidProperties(properties,level){var isObject=typeof properties==="object";if((level===0&&!isObject)||(level===2&&isObject)){return false;}for(var key in properties){var value=properties[key];if(typeof value==="object"&&!isValidProperties(value,level+1)){return false;}}return true;}mstrmojo.CustomVisBase=mstrmojo.declare(mstrmojo.VisBase,[mstrmojo.vi.ui.rw._XtabDE,mstrmojo.vi.ui.rw._HasVisSelections,mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl,mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights,mstrmojo._colorPalette],{scriptClass:"mstrmojo.CustomVisBase",plotted:false,markupString:'<div id="{@id}" class="custom-vis-layout {@cssClass}" style="position:absolute;font-size:8pt;width:{@width}px;height:{@height}px;z-index:{@zIndex};{@viewportCssText}" mstrattach:click,mousedown,mouseup,mousemove></div>',markupSlots:{containerNode:function(){return this.domNode;},viewport:function(){return this.domNode;}},formatHandlers:{viewport:["background-color","left","top"]},bindings:{gridData:"this.model.data"},externalLibraries:null,cssFiles:null,errorMessage:"Either there is not enough data to display the visualization or the visualization configuration is incomplete.",errorDetails:"",isDynamicTooltip:true,reuseDOMNode:false,dataInterface:null,init:function init(props){if(window.mstrApp&&window.mstrApp.isVI){var viewportHandler=this.formatHandlers.viewport;if(viewportHandler){var idx=$ARR.indexOf(viewportHandler,"background-color");if(idx>-1){viewportHandler.splice(idx,1);}}}this._super(props);var cssFiles=this.cssFiles;if(cssFiles){mstrmojo.insertCSSLinks(cssFiles);}},plot:mstrmojo.emptyFn,getFilterType:function getFilterType(){return this.defn.ins||FILTER_TYPE.SHARED;},unrender:function unrender(ignoreDom){this.clearCache();this._super(ignoreDom);},displayError:function displayError(){toggleError.call(this,true);},renderVisualization:function renderVisualization(){try{toggleError.call(this,false);this.dataInterface=new mstrmojo.models.template.DataInterface(this.getData());this.plot();this.plotted=true;}catch(e){this.displayError();this.plotted=false;}},getExternalLibraries:function getExternalLibraries(){var result=[];$ARR.forEach(this.externalLibraries,function(element){result.push(element);});return result;},postBuildRendering:function postBuildRendering(){var me=this,libraries,res,sub;if(me.waitingForData){return ;}sub=me.listenToUpdateColorMap(function(){me.render();if(sub&&me.detachUpdateColorMapListener instanceof Function){me.detachUpdateColorMapListener(sub);}});hideFilterMenuOption.call(me);res=this._super();var egt=this.model.data.egt;if(this.isEmpty()&&(egt===undefined||egt===$VIS_ENUM.SERVER_JSON_ERROR_TYPE.AE_ERROR)){if(mstrApp.isExpress){this.addChildren(this.getVisEmptyMsgControls());this.errorMsg.render();}return false;}libraries=this.getExternalLibraries();if(libraries){this.requiresExternalScripts(libraries,function(){me.renderVisualization();});}else{me.renderVisualization();}return res;},redraw:function redraw(){if(this.reuseDOMNode){if(this.plotted){this.renderVisualization();}return this.plotted;}return false;},moveTooltip:function moveTooltip(evt,win){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),that=this,content,getTitle=function getTitle(node){var i,children=node.childNodes;for(i=0;i<children.length;i++){var child=children[i];if(child.nodeName==="title"){return child;}}if(node!==that.domNode){return getTitle(node.parentNode);}return null;},title=getTitle(target);if(title){var tooltip=title.innerHTML;if(tooltip.length){content=tooltip;title.tt=tooltip;title.innerHTML="";}else{if(title.tt!==undefined){content=title.tt;}}}this.richTooltip={posType:mstrmojo.tooltip.POS_TOPLEFT,content:content,top:evt.clientY+12,left:evt.clientX-12,cssClass:"vi-regular vi-tooltip-A"};this._super(evt,win);},isEmpty:function isEmpty(){var data=this.model.data;return data.eg!==undefined||data.egt!==undefined;},getVisEmptyMsgControls:function getVisEmptyMsgControls(){var egt=this.model.data.egt;return this.isEmpty()?(((egt===undefined||egt===$VIS_ENUM.SERVER_JSON_ERROR_TYPE.AE_ERROR))?[{scriptClass:"mstrmojo.Widget",cssClass:"error-msg",alias:"errorMsg",markupString:$UTIL.getVisEmptyMsg("AE_ERROR")}]:getErrorCtrlOverlay.call(this)):this._super();},getProperties:function getProperties(){var data=this.model.data,vp=data.vp;if(!vp){data.vp={cvp:{}};}else{if(!vp.cvp){vp.cvp={};}}return data.vp.cvp;},getDefaultProperties:function getDefaultProperties(){return this.dvp||{};},setDefaultPropertyValues:function setDefaultPropertyValues(dvp){if(dvp instanceof Object){this.dvp=dvp;}else{this.dvp={};}},getProperty:function getProperty(propertyName){var props=this.getProperties(),defProps=this.getDefaultProperties(),propValue;propValue=props[propertyName]===undefined?defProps[propertyName]:props[propertyName];if(typeof propValue==="object"){propValue=$HASH.copy(props[propertyName],defProps[propertyName]);}return propValue;},setProperty:function setProperty(propertyName,newValue,config){var properties=this.getProperties(),oldValue=properties[propertyName];if(properties&&!$HASH.equals(oldValue,newValue)){properties[propertyName]=newValue;if(config&&config.onPropertyChange instanceof Function){var changedProperties=config.onPropertyChange(propertyName,newValue);if(isValidProperties(changedProperties,0)){$HASH.copy(changedProperties,properties);}else{mstrmojo.warn("Results of onPropertyChange() is invalid. It must be an JSON object that contains the properties and values you want to change, and can't have child properties that exceeds two levels.",{},{buttons:[$NWB(mstrmojo.desc(1442,"OK"),mstrmojo.emptyFn)]});}}var suppressData=!!(config&&config.suppressData),requestDefinition=config&&config.requestDefinition,customUndoRedoCallback=config&&config.clientUndoRedoCallback,hasClientUndoRedoCallback=customUndoRedoCallback&&(customUndoRedoCallback instanceof Function),me=this,visId=me.id,boxId=me.parent.id,visModel=me.model,docModel=visModel.docModel,controller=visModel.controller,actions=getSetPropertiesAction.call(this),callback,undoredoCallback,extra={},execute;var getClientUndoRedoCallback=function getClientUndoRedoCallback(val){return hasClientUndoRedoCallback?function(){var vis=mstrmojo.all[visId],properties=vis.getProperties();properties[propertyName]=val;customUndoRedoCallback.call(vis,val);vis.getDocModel().selectVIUnit(vis.parent.id,true);}:$FNEMPTY;};if(suppressData){callback=mstrmojo.emptyFn;execute=function(){this.submitSilent(actions);};}else{callback=docModel.getSliceCallback({tks:visModel.data.k});callback.success=$COMPOS([callback.success,function(){docModel.selectVIUnit(boxId,true);}]);execute=function(){this.submit(actions,callback,extra);};}undoredoCallback=controller._getXtabCallback(me);undoredoCallback.success=$COMPOS([undoredoCallback.success,function(){docModel.selectVIUnit(boxId,true);}]);if(requestDefinition){$HASH.copy(mstrmojo.DocDataService.REQUEST_DEFN_DATA,extra);}controller.cmdMgr.execute({execute:execute,urInfo:{silent:hasClientUndoRedoCallback,callback:undoredoCallback,redo:getClientUndoRedoCallback(newValue),undo:getClientUndoRedoCallback(oldValue)}});}},addThresholdMenuItem:function addThresholdMenuItem(){this.showThreshold=true;},addUseAsFilterMenuItem:function addUseAsFilterMenuItem(){var vizContainer=this.parent;if(vizContainer&&vizContainer.generateToolbar){vizContainer.generateToolbar();}},getColorBy:function getColorBy(eids){if(!eids||!this.zonesModel){return null;}var zoneItems=this.zonesModel.getColorByAttributes(),colorObj,gts=this.dataInterface.data.gts,tids=[],attr=$DSSOBJ_TYPES.DssTypeAttribute;$ARR.forEach(gts.row.concat(gts.col),function(item){$ARR.forEach(zoneItems,function(itm){if((itm.otp===attr||itm.t===attr)&&itm.id===item.id){tids.push(itm.id);}});});colorObj=this.model.docModel.getColorBy(tids,eids);return $GM_UTIL.decodeColor(colorObj.color);},getColorByAttInfo:function getColorByAttInfo(zoneItems){function getShapeColorAndOpacity(cbElements){var me=this,colorObj,tid,eid,strtid,streid,attr,opacity,props=this.props||{},opacities=props.attrColorByOpacity||{};cbElements.map(function(item){tid=item.colorByAttributeIDs;eid=item.colorByElementIDs;strtid=tid&&tid.join("|");streid=eid&&eid.join("|");attr=opacities[strtid]||{};opacity=attr&&attr[streid];if(opacity===undefined){opacity=100;}item.opacity=opacity;if(tid&&eid){colorObj=me.model.docModel.getColorBy(tid,eid);item.color=$GM_UTIL.decodeColor(colorObj.color);}});}function getCbElements(zoneItems){var cbElements,cbAtt=[],gts=this.dataInterface.data.gts;$ARR.forEach(zoneItems,function(item){$ARR.forEach(gts.row.concat(gts.col),function(itm){if(itm.otp===12&&itm.id===item.id){cbAtt.push(itm);}});});function descartes(arr){var rs=[],len=arr.length,m,str,bothDescartes=function(arr1,arr2){var r=[],i,j,idx=0,len1=arr1.length,len2=arr2.es.length;for(i=0;i<len1;i++){for(j=0;j<len2;j++){str=arr1[i].text+" "+arr2.es[j].n;idx++;r.push({comb:arr1[i].comb.concat({eid:arr2.es[j].id,tid:arr2.id}),colorByAttributeIDs:arr1[i].colorByAttributeIDs.concat(arr2.id),colorByElementIDs:arr1[i].colorByElementIDs.concat(arr2.es[j].id),text:str});}}return r;};for(m=0;m<len;m++){if(m===0){$ARR.forEach(arr[0].es,function(itm){rs.push({comb:[{tid:arr[0].id,eid:itm.id}],colorByAttributeIDs:[arr[0].id],colorByElementIDs:[itm.id],text:itm.n});});}else{rs=bothDescartes(rs,arr[m]);}}return rs;}cbElements=descartes(cbAtt);cbElements.unshift({text:mstrmojo.desc(2461,"All"),color:"#ffffff",opacity:100,comb:[]});return cbElements;}var cbElements=getCbElements.call(this,zoneItems);getShapeColorAndOpacity.call(this,cbElements);return cbElements;},applySelection:function addSelection(selectInfo){if(!selectInfo){return ;}var me=this;this.clearSelections();$ARR.forEach($ARR.ensureArray(selectInfo),function(selection){if(selection.isSelectAttr){me.addAttributeSelection(selection.tid,selection.eid,selection.name);}else{me.addMetricValueSelection(selection);}});this.endSelections();}});}());