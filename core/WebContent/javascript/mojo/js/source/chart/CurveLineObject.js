(function(){mstrmojo.requiresClsP("mstrmojo.chart","GraphObject","FormatLine","BezierCurve");mstrmojo.requiresClsP("mstrmojo.chart.enums","EnumLineJoinType","EnumLineStyle");var $C=mstrmojo.chart,$CHART_ENUMS=$C.enums,$LJT=$CHART_ENUMS.EnumLineJoinType,$LSL=$CHART_ENUMS.EnumLineStyle,SVG=103,kSlopeTolerance=0.087,kZeroTolerance=0.01;function swap(point){var temp=point.x;point.x=point.y;point.y=temp;}function hCreateCurveLine(bezierCurve,index){var bezierCurves=this.mBezierCurves,curveLine=new $C.CurveLineObject({TripleId:this.mTripleId,GraphObjectManager:this.mpManager,GraphCollectionObject:this.mpParentObject,BezierCurvePtr:null}),i;if(bezierCurve){curveLine.AddBezierCurveLine(bezierCurve);}var numberOfCurves=bezierCurves.length;for(i=index;i<numberOfCurves;++i){curveLine.AddBezierCurveLine(bezierCurves[i]);}bezierCurves.splice(index,bezierCurves.length-index);return curveLine;}function hSplitAtTangentPointRecursive(offset,splitCurves){var bezierCurves=this.mBezierCurves,slope=(offset.y)/offset.x,numberOfCurves=bezierCurves.length,curveLine,i,j;for(i=0;i<numberOfCurves;++i){var currentBezierCurves=[];bezierCurves[i].SplitAtTangentPoints(offset,currentBezierCurves);if(currentBezierCurves.length!==0){var currentCurvesCount=currentBezierCurves.length;for(j=0;(j+1)<currentCurvesCount;++j){splitCurves.push(new $C.CurveLineObject({TripleId:this.mTripleId,GraphObjectManager:this.mpManager,GraphCollectionObject:this.mpParentObject,BezierCurvePtr:currentBezierCurves[j]}));}curveLine=hCreateCurveLine.call(this,currentBezierCurves[currentBezierCurves.length-1],i+1);hSplitAtTangentPointRecursive.call(curveLine,offset,splitCurves);splitCurves.push(curveLine);return ;}if((i+1)<bezierCurves.length){var independent=bezierCurves[i].getEndIndependent(),derivative=bezierCurves[i].evaluateDerivative(independent);if(Math.abs(derivative-slope)<Math.abs(1+derivative*slope)*kSlopeTolerance){var secondDerivative=bezierCurves[i].evaluate2ndDerivative(independent),current3rdDerivative=bezierCurves[i].evaluate3rdDerivative(),next3rdDerivative=bezierCurves[i].evaluate3rdDerivative();if((Math.abs(secondDerivative)>=0.1*kZeroTolerance)||(current3rdDerivative*next3rdDerivative<-kZeroTolerance)){curveLine=hCreateCurveLine.call(this,null,i+1);hSplitAtTangentPointRecursive.call(curveLine,offset,splitCurves);splitCurves.push(curveLine);return ;}}}}}function hSplitInsideBezierRecursive(curveLine,splitCurves){var bezierCurves=this.mBezierCurves,numberOfCurves=this.mBezierCurves.length,numberOfInputCurveLine=curveLine.mBezierCurves.length,i,j,k;for(i=0;i<numberOfCurves;++i){for(j=0;j<numberOfInputCurveLine;++j){var splitBezierCurves=[];bezierCurves[i].SplitAtIntersections(curveLine.mBezierCurves[j],splitBezierCurves);if(splitBezierCurves.length!==0){var numberOfSplitCurves=splitBezierCurves.length;for(k=0;(k+1)<numberOfSplitCurves;++k){splitCurves.push(new $C.CurveLineObject({TripleId:this.mTripleId,GraphObjectManager:this.mpManager,GraphCollectionObject:this.mpParentObject,BezierCurvePtr:splitBezierCurves[k]}));}var currentCurveLine=hCreateCurveLine.call(this,splitBezierCurves[splitBezierCurves.length-1],i+1);hSplitInsideBezierRecursive.call(currentCurveLine,curveLine,splitCurves);splitCurves.push(currentCurveLine);return ;}}}}function hSplitEndPointBezierRecursive(curveLine,splitCurves){var bezierCurves=this.mBezierCurves,numberOfCurves=bezierCurves.length,numberOfInputCurveLine=curveLine.mBezierCurves.length,i,j;for(i=1;i<numberOfCurves;++i){var selfPoint=bezierCurves[i].getStartPoint();for(j=1;j<numberOfInputCurveLine;++j){var inputPoint=curveLine.mBezierCurves[j].getStartPoint();if(Math.abs(selfPoint.x-inputPoint.x)<kZeroTolerance&&Math.abs(selfPoint.y-inputPoint.y)<kZeroTolerance){var selfSlope=bezierCurves[i].evaluateDerivative(bezierCurves[i].getStartIndependent());var inputSlope=curveLine.mBezierCurves[j].evaluateDerivative(curveLine.mBezierCurves[j].getStartIndependent());var withinTolerance=Math.abs(selfSlope-inputSlope)<Math.abs(1+selfSlope*inputSlope)*kSlopeTolerance;if(!withinTolerance){var currentCurveLine=hCreateCurveLine.call(this,null,i);hSplitEndPointBezierRecursive.call(currentCurveLine,curveLine,splitCurves);splitCurves.push(currentCurveLine);return ;}}}}}function hTridiagonalSolve(b,c,d,x){var len=c.length,i;for(i=0;i<len;++i){x.push(0);}c[0]/=b[0];d[0]/=b[0];for(i=1;i<len;++i){var temp=b[i]-c[i-1];c[i]/=temp;d[i]=(d[i]-d[i-1])/temp;}x[len-1]=d[len-1];for(i=len-2;i>=0;i--){x[i]=d[i]-c[i]*x[i+1];}}function hGenerateBezierCurveLines(points){var bezierCurves=this.mBezierCurves,coefficientB=[],coefficientC=[],coefficientD=[],numberOfPoints=points.length,i;for(i=0;i<numberOfPoints;++i){var currentIndex,nextIndex;if(i===0){currentIndex=0;nextIndex=1;}else{if(i===points.length-1){currentIndex=points.length-2;nextIndex=points.length-1;}else{currentIndex=i-1;nextIndex=i+1;}}var currentData=this.mIsVertical?points[currentIndex].y:points[currentIndex].x,nextData=this.mIsVertical?points[nextIndex].y:points[nextIndex].x;coefficientD.push(nextData-currentData);}for(i=0;i<points.length;++i){coefficientB.push(4);}coefficientB[0]-=2;coefficientB[coefficientB.length-1]-=2;for(i=0;i<points.length;++i){coefficientC.push(1);}var distanceDifference=[];hTridiagonalSolve.call(this,coefficientB,coefficientC,coefficientD,distanceDifference);for(i=0;i<numberOfPoints-1;++i){if(this.mIsVertical){bezierCurves.push(new $C.BezierCurve({P0:points[i],F1:points[i].y+distanceDifference[i],F2:points[i+1].y-distanceDifference[i+1],P3:points[i+1],IsVertical:this.mIsVertical}));}else{bezierCurves.push(new $C.BezierCurve({P0:points[i],F1:points[i].x+distanceDifference[i],F2:points[i+1].x-distanceDifference[i+1],P3:points[i+1],IsVertical:this.mIsVertical}));}}}function hSetBorderStyle(points){var chartCtx=this.mChartContextPtr,lineStyle=this.mFormatLinePtr.mLineStyle,i,j,t;if(chartCtx.mImageFormat===SVG){return ;}if(this.mFormatLinePtr.mLineStyle===$LSL.LS_SOLID||chartCtx.mUseAnimation){return ;}chartCtx.NewPath();var n=points.length;if(n<2){return ;}var dashPattern=$C.FormatLine.getLinePattern(lineStyle),dashPatternSize=dashPattern.length,dashIndex=0,length=0,xArray=[],yArray=[];for(i=0;i<n;++i){yArray.push(0);xArray.push(0);}var x=points[0].x;var y=points[0].y;var sectionLength=0.05;if(lineStyle===$LSL.LS_DOT_DOT_DOT){sectionLength=0.03;dashPattern[dashPatternSize-1]*=3;}else{if(lineStyle===$LSL.LS_DOT){sectionLength=0.005;}}for(t=0;t<=1;t+=sectionLength/n){for(i=1;i<n;++i){for(j=0;j<n-i;++j){if(i===1){xArray[j]=points[j].x*(1-t)+points[j+1].x*t;yArray[j]=points[j].y*(1-t)+points[j+1].y*t;continue;}xArray[j]=xArray[j]*(1-t)+xArray[j+1]*t;yArray[j]=yArray[j]*(1-t)+yArray[j+1]*t;}}length+=Math.sqrt((x-xArray[0])*(x-xArray[0])+(y-yArray[0])*(y-yArray[0]));if(length>=dashPattern[dashIndex]){if(dashIndex%2===0){if(this.mIsVertical){chartCtx.MoveTo(x,y);chartCtx.LineTo(xArray[0],yArray[0]);}else{chartCtx.MoveTo(y,x);chartCtx.LineTo(yArray[0],xArray[0]);}}dashIndex=(dashIndex+1)%dashPatternSize;length=0;x=xArray[0];y=yArray[0];}}}mstrmojo.chart.CurveLineObject=mstrmojo.declare(mstrmojo.chart.GraphObject,null,{scriptClass:"mstrmojo.chart.CurveLineObject",mBezierCurves:[],mIsVertical:false,isClosePath:false,identity:null,startPoint:null,midPoint:null,endPoint:null,init:function init(props){this.mBezierCurves=[];if(props.hasLine===undefined){props.hasLine=true;}if(props.IsVertical===undefined){props.IsVertical=true;}if(props.IsClosePath===undefined){props.IsClosePath=false;}props.GraphCollectionObject=props.GraphCollectionObject||null;this._super(props);this.isClosePath=props.IsClosePath;if(props.BezierCurvePtr){this.mBezierCurves.push(props.BezierCurvePtr);this.mIsVertical=props.BezierCurvePtr.mIsVertical;}else{this.mIsVertical=props.IsVertical;if(props.Points){hGenerateBezierCurveLines.call(this,props.Points);}}if(props.Identity){this.identity=props.Identity;}},Draw:function Draw(){var chartCtx=this.mChartContextPtr,bezierCurves=this.mBezierCurves,backupLineJoinType=chartCtx.GetLineJoin(),i,numberOfCurves,points=[],renderingPoints=[],len,midCurveInd,midPointX,midPointY,temp,startPointInd,endPointInd,control1Ind,control2Ind;if(bezierCurves.length===0){return ;}chartCtx.SetLineJoin($LJT.LJT_ROUND);this.SetLineWidth();numberOfCurves=bezierCurves.length;if(this.mFormatLinePtr.mLineStyle===$LSL.LS_SOLID||chartCtx.mUseAnimation){chartCtx.NewPath();bezierCurves[0].MoveToStart(chartCtx);for(i=0;i<numberOfCurves;++i){bezierCurves[i].CurveToEnd(chartCtx);}}else{for(i=0;i<numberOfCurves;++i){bezierCurves[i].GetControlPoints(points);hSetBorderStyle.call(this,points);this.ApplyLineFormat();}}if(this.isClosePath){chartCtx.ClosePath();}if(this.mFormatLinePtr.mLineStyle===$LSL.LS_SOLID||chartCtx.mUseAnimation){this.ApplyLineFormat();}chartCtx.SetLineJoin(backupLineJoinType);for(i=0;i<numberOfCurves;++i){var curve=bezierCurves[i],p0=new $C.Point2D({Point2D:curve.mP0}),p1=new $C.Point2D({Point2D:curve.mP1}),p2=new $C.Point2D({Point2D:curve.mP2}),p3=new $C.Point2D({Point2D:curve.mP3});if(!this.mIsVertical){p0.swap();p1.swap();p2.swap();p3.swap();}renderingPoints.push(p0);renderingPoints.push(p1);renderingPoints.push(p2);renderingPoints.push(p3);}if((this.startPoint===undefined||this.startPoint===null)&&(this.endPoint===undefined||this.endPoint===null)&&(this.midPoint===undefined||this.midPoint===null)){len=renderingPoints.length;this.startPoint={x:renderingPoints[0].x,y:renderingPoints[0].y};this.endPoint={x:renderingPoints[len-1].x,y:renderingPoints[len-1].y};if(numberOfCurves%2===0){this.midPoint={x:renderingPoints[len/2-1].x,y:renderingPoints[len/2-1].y};}else{midCurveInd=(numberOfCurves-1)/2;midPointX=(bezierCurves[midCurveInd].mP0.x+bezierCurves[midCurveInd].mP3.x)/2;midPointY=bezierCurves[midCurveInd].evaluate(midPointX);if(!this.mIsVertical){temp=midPointX;midPointX=midPointY;midPointY=temp;}this.midPoint={x:midPointX,y:midPointY};}}else{if(!this.mIsVertical){swap.call(this,this.startPoint);swap.call(this,this.midPoint);swap.call(this,this.endPoint);}}chartCtx.FinishDrawCurves(renderingPoints,this.mTripleId,this.identity,this.startPoint,this.midPoint,this.endPoint);},DrawOutLine:function DrawOutLine(){var chartCtx=this.mChartContextPtr,bezierCurves=this.mBezierCurves,i;this.SetOutlineWidth();chartCtx.NewPath();bezierCurves[0].MoveToStart(chartCtx);var numberOfCurves=bezierCurves.length;for(i=0;i<numberOfCurves;++i){bezierCurves[i].CurveToEnd(chartCtx);}this.ApplyOutlineFormat();},PointInObject:function PointInObject(irPoint){var bezierCurves=this.mBezierCurves,lLineWidth=(this.mFormatLinePtr.mLineThickness<4)?4:this.mFormatLinePtr.mLineThickness,lSize=bezierCurves.length,i,polygon;for(i=0;i<lSize;++i){polygon=[];bezierCurves[i].GetApproximatePolygon(lLineWidth,polygon);if(irPoint.IsInPolygon(polygon)){return true;}}return false;},ObjectInRectangle:function ObjectInRectangle(rect){var bezierCurves=this.mBezierCurves,lineWidth=(this.mFormatLinePtr.mLineThickness<1)?1:this.mFormatLinePtr.mLineThickness,numberOfCurves=bezierCurves.length,i,j,polygon;for(i=0;i<numberOfCurves;++i){polygon=[];bezierCurves[i].GetApproximatePolygon(lineWidth,polygon);for(j=0;j<polygon.length;++j){if(!rect.PointInRectangle(polygon[j])){return false;}}}return true;},AddBezierCurveLine:function AddBezierCurveLine(bezierCurve){var bezierCurves=this.mBezierCurves;if(bezierCurves.length===0){this.mIsVertical=bezierCurve.mIsVertical;}bezierCurves.push(bezierCurve);},GetClockwisePolygon:function GetClockwisePolygon(){return[];},MoveToStart:function MoveToStart(isLinePath){var chartCtx=this.mChartContextPtr;this.mBezierCurves[0].MoveToStart(chartCtx,isLinePath&&chartCtx.NeedAdjustedLinePath());},CurveToEnd:function CurveToEnd(isLinePath){var chartCtx=this.mChartContextPtr,bezierCurves=this.mBezierCurves,numberOfCurves=bezierCurves.length,i;for(i=0;i<numberOfCurves;++i){bezierCurves[i].CurveToEnd(chartCtx,isLinePath&&chartCtx.NeedAdjustedLinePath());}},DashedCurveToEnd:function DashedCurveToEnd(lineStyle,iIsLinePath){var chartCtx=this.mChartContextPtr,bezierCurves=this.mBezierCurves,numberOfCurves=bezierCurves.length,i,j,t;for(i=0;i<numberOfCurves;++i){var points=[];bezierCurves[i].GetControlPoints(points);var numberOfPoints=points.length;if(numberOfPoints<4){return ;}var tuning=(iIsLinePath&&chartCtx.NeedAdjustedLinePath()),xOffset=tuning?0.5:0,yOffset=tuning&&(points[0].y===points[1].y&&points[1].y===points[2].y&&points[2].y===points[3].y)?0.5:0,sameXOffset=(Math.abs(points[0].x-points[1].x)<0.5)?0.5:0;points[1].x+=sameXOffset;points[1].y+=yOffset;points[2].x+=sameXOffset;points[2].y+=yOffset;points[3].x+=xOffset;points[3].y+=yOffset;var dashPattern=$C.FormatLine.getLinePattern(lineStyle),dashPatternSize=dashPattern.length,dashIndex=0,length=0,xArray=[],yArray=[];for(i=0;i<numberOfPoints;++i){yArray.push(0);xArray.push(0);}var x=points[0].x,y=points[0].y;var sectionLength=0.05;if(lineStyle===$LSL.LS_DOT_DOT_DOT){sectionLength=0.03;dashPattern[dashPatternSize-1]*=2;}else{var factor=11.2;for(j=0;j<dashPatternSize;++j){if(j%2===0){dashPattern[j]*=factor;}}}for(t=0;t<=1;t+=sectionLength/numberOfPoints){for(i=1;i<numberOfPoints;++i){for(j=0;j<numberOfPoints-i;++j){if(i===1){xArray[j]=points[j].x*(1-t)+points[j+1].x*t;yArray[j]=points[j].y*(1-t)+points[j+1].y*t;continue;}xArray[j]=xArray[j]*(1-t)+xArray[j+1]*t;yArray[j]=yArray[j]*(1-t)+yArray[j+1]*t;}}length+=Math.sqrt((x-xArray[0])*(x-xArray[0])+(y-yArray[0])*(y-yArray[0]));if(length>=dashPattern[dashIndex]){if(dashIndex%2===0){if(this.mIsVertical){chartCtx.MoveTo(x,y);chartCtx.LineTo(xArray[0],yArray[0]);}else{chartCtx.MoveTo(y,x);chartCtx.LineTo(yArray[0],xArray[0]);}}dashIndex=(dashIndex+1)%dashPatternSize;length=0;x=xArray[0];y=yArray[0];}}}},LineToStart:function LineToStart(isLinePath){var chartCtx=this.mChartContextPtr;this.mBezierCurves[0].LineToStart(chartCtx,isLinePath&&chartCtx.NeedAdjustedLinePath());},getStartPoint:function GetStartPoint(){return this.mBezierCurves[0].getStartPoint();},getEndPoint:function GetEndPoint(){var bezierCurves=this.mBezierCurves;return bezierCurves[bezierCurves.length-1].getEndPoint();},evaluate:function evaluate(independentValue){var bezierCurves=this.mBezierCurves,numberOfCurves=bezierCurves.length,i;for(i=0;(i+1)<numberOfCurves;++i){var minX=bezierCurves[i].getMinX();var maxX=bezierCurves[i].getMaxX();if(minX-independentValue<kZeroTolerance&&independentValue-maxX<kZeroTolerance){return bezierCurves[i].evaluate(independentValue);}}return bezierCurves[bezierCurves.length-1].evaluate(independentValue);},GetMinMax:function GetMinMax(){var bezierCurves=this.mBezierCurves,numberOfCurves=bezierCurves.length,data,i,tempData;if(numberOfCurves>0){data=bezierCurves[0].GetMinMax();for(i=1;i<numberOfCurves;++i){tempData=bezierCurves[i].GetMinMax();if(tempData.MinY<data.MinY){data.MinY=tempData.MinY;}if(tempData.MaxY>data.MaxY){data.MaxY=tempData.MaxY;}}}return data;},GetApproximatePolyline:function GetApproximatePolyline(orPolyline){var bezierCurves=this.mBezierCurves,i,j,numberOfCurves,polyLine,polyLineSize;bezierCurves[0].GetApproximatePolyline(orPolyline);numberOfCurves=bezierCurves.length;for(i=1;i<numberOfCurves;++i){polyLine=[];bezierCurves[i].GetApproximatePolyline(polyLine);polyLineSize=polyLine.length;for(j=1;j<polyLineSize;++j){orPolyline.push(polyLine[j]);}}},CloneReverseShift:function CloneReverseShift(offset){var bezierCurves=this.mBezierCurves,curveLine=new $C.CurveLineObject({TripleId:this.mTripleId,GraphObjectManager:this.mpManager,GraphCollectionObject:this.mpParentObject,BezierCurvePtr:null}),i;for(i=bezierCurves.length-1;i>-1;--i){curveLine.AddBezierCurveLine(bezierCurves[i].CloneReverseShift(offset));}return curveLine;},Clone:function Clone(){var bezierCurves=this.mBezierCurves,curveLine=new $C.CurveLineObject({TripleId:this.mTripleId,GraphObjectManager:this.mpManager,GraphCollectionObject:this.mpParentObject,BezierCurvePtr:null}),numberOfCurves=bezierCurves.length,i;for(i=0;i<numberOfCurves;++i){curveLine.AddBezierCurveLine(bezierCurves[i].Clone());}return curveLine;},Reverse:function Reverse(){var bezierCurves=this.mBezierCurves,numberOfCurves=bezierCurves.length,i;for(i=0;i<numberOfCurves;++i){bezierCurves[i].Reverse();}bezierCurves.reverse();},getMinX:function GetMinX(){var bezierCurves=this.mBezierCurves,min=Number.MAX_VALUE,numberOfCurves=bezierCurves.length,i;for(i=0;i<numberOfCurves;++i){var tempValue=bezierCurves[i].getMinX();if(tempValue<min){min=tempValue;}}return min;},getMaxX:function GetMaxX(){var bezierCurves=this.mBezierCurves,max=Number.MIN_VALUE,numberOfCurves=bezierCurves.length,i;for(i=0;i<numberOfCurves;++i){var tempValue=bezierCurves[i].getMaxX();if(tempValue>max){max=tempValue;}}return max;},isBefore:function IsBefore(offset,curveLine){var bezierCurves=this.mBezierCurves,numberOfCurves=bezierCurves.length,inputCurveLineSize=curveLine.mBezierCurves.length,i,j;for(i=0;i<numberOfCurves;++i){for(j=0;j<inputCurveLineSize;++j){if(bezierCurves[i].isBefore(offset,curveLine.mBezierCurves[j])){return true;}}}return false;},SplitAtTangentPoints:function SplitAtTangentPoints(fffset,splitCurves){if(!this.mIsVertical){fffset.swap();}if(fffset.x===0){return ;}hSplitAtTangentPointRecursive.call(this,fffset,splitCurves);},SplitAtIntersections:function SplitAtIntersections(curveLine,splitCurves){var currentSplitCurves=[];hSplitInsideBezierRecursive.call(this,curveLine,currentSplitCurves);splitCurves=currentSplitCurves;hSplitEndPointBezierRecursive.call(this,curveLine,splitCurves);var numberOfCurves=currentSplitCurves.length,i;for(i=0;i<numberOfCurves;++i){hSplitEndPointBezierRecursive.call(currentSplitCurves[i],curveLine,splitCurves);}}});}());