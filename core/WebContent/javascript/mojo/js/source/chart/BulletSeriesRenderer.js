(function(){mstrmojo.requiresClsP("mstrmojo.chart","CategoryPlot","StraightLineObject","MarkerObject","SeriesRenderer","BarSeriesRenderer","Plot");mstrmojo.requiresClsP("mstrmojo.chart.enums","EnumCollectionType","EnumMajorGraphType","EnumOrientation","EnumGraphMatrixThemeType","EnumValueAxis","EnumFontRotation","EnumFontRotation","EnumGenericDirection");mstrmojo.requiresCls("mstrmojo.chart.common.Utility");mstrmojo.requiresClsP("mstrmojo.chart.model.enums","EnumDSSGraphDataTextPosition","EnumDSSGraphObject");var $C=mstrmojo.chart,$CHART_ENUMS=$C.enums,$OR=$CHART_ENUMS.EnumOrientation,$TT=$CHART_ENUMS.EnumGraphMatrixThemeType,$CT=$CHART_ENUMS.EnumCollectionType,$FR=$CHART_ENUMS.EnumFontRotation,$M=mstrmojo.chart.model,$MODEL_ENUMS=$M.enums,$DTP=$MODEL_ENUMS.EnumDSSGraphDataTextPosition,$GO=$MODEL_ENUMS.EnumDSSGraphObject;var $K=$C.ChartConstants,$Utility=mstrmojo.chart.common.Utility,kDefaultBandWidthRatio=0.9,kAutomaticBandingPadding=5,kDerivedColor=0,kGrayScale=2,kRed2Green=3,kBlue2Yellow=4,kMaxBandWidth=100,kMinBandWidth=10,kBandNumber=3,kBulletNumber=1,kTargetsNumber=1;function hGetBandColors(groupIndex){var colorInfo={},color,colors,Alphas=[0.1,0.2,0.3],barId,barObject,barColor,chartCtx=this.mChartContextPtr;if(this.oneGroupBandColors){return this.oneGroupBandColors;}this.oneGroupBandColors=null;switch(this.bandOptions.ColorMode){case kGrayScale:color=7697781;break;case kDerivedColor:barId=new $C.TripleId([$GO.DssGraphRiser,kBandNumber,groupIndex]);barObject=this.GetGraphObject(barId,true);if(barObject&&barObject.mFormatFillPtr){barColor=barObject.mFormatFillPtr.mSimpleColor;}else{barColor=chartCtx.GetColorValue(barId,0,true);}color=barColor;break;case kBlue2Yellow:colors=[16711680,65280,16776960];break;case kRed2Green:colors=[255,16776960,65280];break;default:break;}if(color){colorInfo.Color=color;}if(colors){if(this.bandOptions.DescentLayout){colorInfo.Colors=colors.reverse();}else{colorInfo.Colors=colors;}}colorInfo.Alphas=Alphas;this.oneGroupBandColors=colorInfo;return colorInfo;}function hGetBandRatio(groupIndex,vaIndex){vaIndex=vaIndex||0;var x,result,i;x=this.mDatasetPtr.getBandDivision(groupIndex,vaIndex);if(x.Metrics&&x.Metrics.length){x=x.Metrics;result=[];var value,ablPlotCtx=this.mpABLPlotContext,valueIndex=this.mSeriesInfo[vaIndex].mValueAxis,valueAxis=ablPlotCtx.mValueAxis[valueIndex],minTick=valueAxis.mMinTick,base=valueAxis.mMaxTick-minTick,len=x.length;for(i=0;i<len;++i){if(i===len-1){value=1;}else{value=x[i];value=Math.max(value-minTick/base,0);value=Math.min(value,1);}result.push(value);}}else{if(x.Ratios&&x.Ratios.length){result=x.Ratios;}}return(result||[3/11,6/11,1]);}function hGetBandValues(groupIndex,vaIndex){vaIndex=vaIndex||0;if(this.oneGroupBandValues){return this.oneGroupBandValues;}var ratios=hGetBandRatio.call(this,groupIndex,vaIndex),ablPlotCtx=this.mpABLPlotContext,valueIndex=this.mSeriesInfo[vaIndex].mValueAxis,valueAxis=ablPlotCtx.mValueAxis[valueIndex],minTick=valueAxis.mMinTick,base=valueAxis.mMaxTick-minTick,values=[],i,len=ratios.length;for(i=0;i<len;++i){values.push(minTick+ratios[i]*base);}this.oneGroupBandValues=values;return values;}function hCalculateBulletWidth(){if(this.mBarWidth<=0){var barOptions=this.mBarOptions,bandOptions=this.bandOptions;if(this.mBarColumns===-1){barOptions.mGapWidth=0;this.mBarColumns=1;var groupSize=this.mpABLPlot.mABLPlotContext.mCategoryAxisPtr.getGroupSize(),bandPadding=bandOptions.Width.Padding;this.mBarWidth=(groupSize-2*bandPadding)*bandOptions.Width.Ratio;this.mBarWidth=Math.round(this.mBarWidth);var widthLimit=this.bandOptions.Width.Limit;this.mBarWidth=Math.min(this.mBarWidth,widthLimit.Max);this.mBarWidth=Math.max(this.mBarWidth,widthLimit.Min);this.mBarWidth=Math.round(this.mBarWidth);bandOptions.Width.Padding=bandPadding=Math.max((groupSize-this.mBarWidth)/2,0);this.mSpaceBetweenRiser=0;this.mSpaceBetweenGroup=bandPadding*2;}}var bandWidth=this.mBarWidth,leftover;if($Utility.isIntegar(bandWidth)){leftover=bandWidth%3;this.bulletWidth=(bandWidth-leftover)/3+leftover;}else{this.bulletWidth=bandWidth/3;}}function hPostProcessOneBarEx(riserInfo,rectangleObject){var seriesInfoId=riserInfo.seriesInfoID,isBullet=seriesInfoId>=kBandNumber&&seriesInfoId<kBandNumber+kBulletNumber,barRect=rectangleObject.mRect,offset=0,ablPlotCtx=this.mpABLPlotContext,ablOptions=ablPlotCtx.mABLOptions,categoryAxisPtr=ablPlotCtx.mCategoryAxisPtr,groupPosition=riserInfo.groupID;this.hPostProcessOneBar(riserInfo,rectangleObject);if(isBullet){switch(ablOptions.mOrientation){case $OR.OR_VERTICAL:offset=Math.abs(categoryAxisPtr.getGroupMiddlePos(groupPosition)-barRect.GetBottomMiddle().x);barRect.x+=offset;break;case $OR.OR_HORIZONTAL:offset=Math.abs(categoryAxisPtr.getGroupMiddlePos(groupPosition)-barRect.GetLeftMiddle().y);barRect.y-=offset;break;}}else{var valueIndex=this.mSeriesInfo[riserInfo.seriesInfoID].mValueAxis,valueAxis=ablPlotCtx.mValueAxis[valueIndex],values=hGetBandValues.call(this,riserInfo.groupID),seriesId=riserInfo.seriesInfoID,value=values[seriesId],highEnd=valueAxis.ValueToPosition(value),lowEnd=valueAxis.ValueToPosition(valueAxis.mMinTick);switch(ablOptions.mOrientation){case $OR.OR_VERTICAL:if(riserInfo.seriesInfoID!==0){value=values[seriesId-1];lowEnd=valueAxis.ValueToPosition(value);}barRect.y=highEnd;barRect.height=Math.abs(highEnd-lowEnd);break;case $OR.OR_HORIZONTAL:if(riserInfo.seriesInfoID!==0){value=values[seriesId-1];lowEnd=valueAxis.ValueToPosition(value);}barRect.x=lowEnd;barRect.width=Math.abs(highEnd-lowEnd);break;}var formatFill=rectangleObject.mFormatFillPtr,bandColors=hGetBandColors.call(this,riserInfo.groupID);formatFill.mSimpleColor=bandColors.Color||bandColors.Colors[riserInfo.seriesInfoID]||255;formatFill.mAlpha=bandColors.Alphas[riserInfo.seriesInfoID]*255||255;}}function hRenderOneRiser(riserInfo,isOnlyForDataLabels){var seriesInfoId=riserInfo.seriesInfoID,isBullet=seriesInfoId>=kBandNumber&&seriesInfoId<kBandNumber+kBulletNumber,result={Bar:null,AddToMapAndList:false};var data=this.PrepareData(riserInfo,isBullet);if(data===null||data===undefined){return result;}var returnVal=this.hPrepareRect(riserInfo,data,isBullet?this.bulletWidth:this.mBarWidth),barRect=returnVal.Rect,aboveZero=returnVal.AboveBase;if(isBullet){if(!this.hUpdateBarRect(riserInfo,barRect,aboveZero,data)){return result;}}if(barRect.width<=0||barRect.height<=0){return result;}if(!isOnlyForDataLabels){var barObjectPtr=this.hPrepareRectangleObject(riserInfo,barRect,aboveZero);if(barObjectPtr){hPostProcessOneBarEx.call(this,riserInfo,barObjectPtr);}result.Bar=barObjectPtr;result.AddToMapAndList=true;}return result;}function hRenderTargetLine(riserInfo,isOnlyForDataLabels,vaIndex){vaIndex=vaIndex||0;isOnlyForDataLabels=isOnlyForDataLabels||false;if(isOnlyForDataLabels){return ;}var chartCtx=this.mChartContextPtr,gmCtx=chartCtx.GetGraphMatrixContext(),ablPlotCtx=this.mpABLPlotContext,value=this.mDatasetPtr.GetData(riserInfo.seriesInfoID,riserInfo.groupID),valueIndex=this.mSeriesInfo[vaIndex].mValueAxis,valueAxis=ablPlotCtx.mValueAxis[valueIndex],ablOptions=ablPlotCtx.mABLOptions,lineObject,bandObject,points=[],point1=new $C.Point2D(),point2=new $C.Point2D(),bandId=new $C.TripleId([$GO.DssGraphRiser,0,riserInfo.groupID]),lineId=new $C.TripleId([$GO.DssGraphDataLine,riserInfo.seriesInfoID,riserInfo.groupID]);bandObject=this.GetGraphObject(bandId);if(bandObject){var rect=bandObject.GetBoundingRect();switch(ablOptions.mOrientation){case $OR.OR_VERTICAL:point1.x=rect.GetLeftMiddle().x;point2.x=rect.GetRightMiddle().x;point1.y=point2.y=valueAxis.ValueToPosition(value);break;case $OR.OR_HORIZONTAL:point1.y=rect.GetTopMiddle().y;point2.y=rect.GetBottomMiddle().y;point1.x=point2.x=valueAxis.ValueToPosition(value);break;}}else{var result=this.GetRiserStartPosAndSize(riserInfo);switch(ablOptions.mOrientation){case $OR.OR_VERTICAL:point1.x=result.Start;point2.x=result.Start+result.Size;point1.y=point2.y=valueAxis.ValueToPosition(value);break;case $OR.OR_HORIZONTAL:point1.y=result.Start;point2.y=result.Start+result.Size;point1.x=point2.x=valueAxis.ValueToPosition(value);break;}}points.push(point1);points.push(point2);lineObject=new $C.StraightLineObject({TripleId:lineId,GraphObjectManager:this,StartPoint:points[0],EndPoint:points[1],GraphCollectionObject:null});if(lineObject){this.AddToMapAndList(lineObject);}}function hPlaceOneLabel(textPtr,riserInfo,refRect,onRiser,lowEnd,highEnd){var maxPosition,minPosition,reverseSign,value,chartCtx=this.mChartContextPtr,isVertical=this.mIsVertical,valueAxis;onRiser=onRiser||false;maxPosition=isVertical?refRect.GetTopMiddle():refRect.GetRightMiddle();minPosition=isVertical?refRect.GetBottomMiddle():refRect.GetLeftMiddle();reverseSign=false;value=this.GetData(riserInfo.seriesInfoID,riserInfo.groupID);if(value!==null){valueAxis=this.mpABLPlotContext.mValueAxis[this.mSeriesInfo[riserInfo.seriesInfoID].mValueAxis];reverseSign=(value<0)^valueAxis.IsReverseOrder();}else{return false;}if(lowEnd===undefined){lowEnd=0;}if(highEnd===undefined){highEnd=this.mIsVertical?chartCtx.mGraphHeight:chartCtx.mGraphWidth;}var rect=textPtr.GetBoundingRect(),gmCtx=chartCtx.GetGraphMatrixContext();if(reverseSign){maxPosition.swapPoints(minPosition);lowEnd=0;highEnd=valueAxis.GetBasePosition();}var padding=gmCtx.getPadding($K.kLabelToChart),ablOptions=this.mpABLPlotContext.mABLOptions,labelLocation=ablOptions.mTextPosition;switch(labelLocation){case $DTP.DssGraphDTPositionCenter:break;case $DTP.DssGraphDTPositionInMin:case $DTP.DssGraphDTPositionOutMax:if(onRiser){if(reverseSign){if(isVertical){maxPosition.y-=padding;}else{maxPosition.x+=padding;}}else{if(isVertical){maxPosition.y+=padding;}else{maxPosition.x-=padding;}}}else{if(reverseSign){if(isVertical){maxPosition.y+=padding;}else{maxPosition.x-=padding;}}else{if(isVertical){maxPosition.y-=padding;}else{maxPosition.x+=padding;}}}break;case $DTP.DssGraphDTPositionOutMin:case $DTP.DssGraphDTPositionInMax:break;default:break;}this.MoveLabel(riserInfo.groupID,textPtr,maxPosition,minPosition,riserInfo.seriesInfoID);rect=textPtr.GetBoundingRect();return gmCtx.checkLabelPaddingToBorder(rect,lowEnd,highEnd,!this.mIsVertical);}function hCheckLabelAgainstTargetLine(linePosition,label){var rect=label.rect;if(this.mIsVertical){return !(rect.GetBottomMiddle().y>=linePosition&&rect.GetTopMiddle().y<=linePosition);}return !(rect.GetRightMiddle().x>=linePosition&&rect.GetLeftMiddle().x<=linePosition);}function hUpdateRefRect(rect,targetLinePosition,isBulletPositive,onRiser){onRiser=onRiser||false;var resultRect=new $C.Rect2D({Rect:rect}),lowEnd,highEnd;if(this.mIsVertical){if(isBulletPositive){if(onRiser){resultRect.height-=Math.max(0,targetLinePosition-resultRect.y);resultRect.y=Math.max(targetLinePosition,resultRect.y);}else{resultRect.height+=Math.max(0,resultRect.y-targetLinePosition);resultRect.y=Math.min(targetLinePosition,resultRect.y);}}else{if(onRiser){resultRect.height-=Math.max(0,targetLinePosition-resultRect.y);}else{resultRect.height+=Math.max(0,resultRect.y-targetLinePosition);}}}else{if(isBulletPositive){if(onRiser){resultRect.width=targetLinePosition-resultRect.x;}else{resultRect.width=targetLinePosition-resultRect.x;}}else{if(onRiser){resultRect.width-=Math.max(targetLinePosition-resultRect.x,0);resultRect.x=targetLinePosition;}else{resultRect.width+=Math.max(resultRect.x-targetLinePosition,0);resultRect.x=targetLinePosition;}}}return{Valid:true,Rect:resultRect,Low:lowEnd,High:highEnd};}function hRenderOneLabel(riserInfo){var tripleId=new $C.TripleId({ObjectId:$GO.DssGraphRiser,SeriesId:this.mSeriesInfo[riserInfo.seriesInfoID].mSeriesId,GroupId:riserInfo.groupID}),hasTarget=kTargetsNumber>0,considerTarget=hasTarget,isOK,refRect,bullet=this.GetGraphObject(tripleId),i,newRefRect,color;if(!bullet){return null;}refRect=bullet.GetBoundingRect();tripleId.mObjectId=$GO.DssGraphDataText;if(this.mSGMapLabel[tripleId.mSeriesId]===undefined){this.mSGMapLabel[tripleId.mSeriesId]=new $C.GraphCollectionObject({TripleId:tripleId,GraphObjectManager:this,CollectionType:$CT.CT_TEXT});}var collection=this.mSGMapLabel[tripleId.mSeriesId],targetLinePosition=0,targetOverBullet=true,bulletValue=this.mDatasetPtr.GetData(tripleId.mSeriesId,tripleId.mGroupId),label=this.createRiserLabel(riserInfo.seriesInfoID,riserInfo.groupID,collection);if(label===null){return null;}if(considerTarget){var targetValue=this.mDatasetPtr.GetData(kBandNumber+kBulletNumber,tripleId.mGroupId);if(targetValue){if(targetValue===0||targetValue===bulletValue){considerTarget=false;}else{considerTarget=(targetValue>0&&bulletValue>=0)||(targetValue<0&&bulletValue<=0);if(considerTarget){targetOverBullet=(targetValue>bulletValue&&bulletValue>=0)||(targetValue<bulletValue&&bulletValue<=0);}}}else{considerTarget=false;}}for(i=0;i<2;++i){if(isOK===true){return label;}if(i===1){label.SetRotation($FR.FR_90);}isOK=hPlaceOneLabel.call(this,label,riserInfo,refRect);if(considerTarget&&targetOverBullet&&isOK){isOK=hCheckLabelAgainstTargetLine.call(this,targetLinePosition,label);if(!isOK){newRefRect=hUpdateRefRect.call(this,refRect,targetLinePosition,(bulletValue>=0),false);if(newRefRect.Valid){isOK=hPlaceOneLabel.call(this,label,riserInfo,newRefRect.Rect,false,newRefRect.High,newRefRect.Low);}}}if(!isOK){var ablOptions=this.mpABLPlotContext.mABLOptions,labelLocation=ablOptions.mTextPosition,backupLocation=labelLocation;ablOptions.mTextCollection=$DTP.DssGraphDTPositionInMax;isOK=hPlaceOneLabel.call(this,label,riserInfo,refRect,true);if(considerTarget&&!targetOverBullet&&isOK){isOK=hCheckLabelAgainstTargetLine.call(this,targetLinePosition,label);if(!isOK){newRefRect=hUpdateRefRect.call(this,refRect,targetLinePosition,(bulletValue>=0),true);if(newRefRect.Valid){isOK=hPlaceOneLabel.call(this,label,riserInfo,newRefRect.Rect,true,newRefRect.High,newRefRect.Low);}}}var borderStroke=true,useBold=false;if(this.mIsVertical){useBold=refRect.height<=label.height;}else{useBold=refRect.width<=label.width;}if(borderStroke){color=this.mChartContextPtr.getDefaultContrastColor();var FS_BOLD=1,formatFont=new $C.FormatFont({Font:label.mFormatFontPtr});formatFont.mStrokeColor=color;if(useBold){formatFont.mFontStyle=FS_BOLD;}label.mFormatFontPtr=formatFont;}ablOptions.mTextCollection=backupLocation;}}return label;}function hRenderOneGroup(groupID,series,isOnlyForDataLabels){var tempSeries=series,irRiserInfo={groupID:groupID,seriesInfoID:0},showBullet=true,showBands=true,showTargets=true,showDataLabel=true;var i,barResult,targetResult;if(showBullet){for(i=0;i<kBulletNumber;++i){irRiserInfo.seriesInfoID=tempSeries[kBandNumber+i];barResult=hRenderOneRiser.call(this,irRiserInfo,isOnlyForDataLabels);if(barResult.Bar===null){return ;}}}else{return ;}if(showBands){for(i=0;i<kBandNumber;++i){irRiserInfo.seriesInfoID=tempSeries[i];barResult=hRenderOneRiser.call(this,irRiserInfo,isOnlyForDataLabels);}}if(showTargets){for(i=0;i<kTargetsNumber;++i){irRiserInfo.seriesInfoID=tempSeries[kBandNumber+kBulletNumber+i];targetResult=hRenderTargetLine.call(this,irRiserInfo,isOnlyForDataLabels);}}if(showDataLabel){for(i=0;i<kBulletNumber;++i){irRiserInfo.seriesInfoID=tempSeries[kBandNumber+i];var ablOptions=this.mpABLPlotContext.mABLOptions,backupShowValue=ablOptions.mShowValue,backupShowLabel=this.mpABLPlotContext.mSeriesOptions[this.mSeriesInfo[irRiserInfo.seriesInfoID].mSeriesIndex].mShowDataLabels;ablOptions.mShowValue=true;this.mpABLPlotContext.mSeriesOptions[this.mSeriesInfo[irRiserInfo.seriesInfoID].mSeriesIndex].mShowDataLabels=true;var oneLabel=hRenderOneLabel.call(this,irRiserInfo);if(oneLabel){oneLabel.mTripleId.mSeriesID=kBandNumber+kBulletNumber+kTargetsNumber;this.AddToMapAndList(oneLabel);}ablOptions.mShowValue=backupShowValue;this.mpABLPlotContext.mSeriesOptions[this.mSeriesInfo[irRiserInfo.seriesInfoID].mSeriesIndex].mShowDataLabels=backupShowLabel;}}}function hRenderItems(valueAxisIndex){var isReverseDrawGroup=this.IsReverseGroupOrder(),groupID,lSeries=[],lSize,groupPos;var groupCount=this.mDatasetPtr.GetGroupCount();for(groupPos=0;groupPos<groupCount;++groupPos){groupID=groupPos;if(isReverseDrawGroup){groupID=groupCount-1-groupID;}lSeries=this.GetSeriesOrderByType(groupID,lSeries,valueAxisIndex);lSize=lSeries.length;hGetBandValues.call(this,groupID,valueAxisIndex);hGetBandColors.call(this,groupID);hRenderOneGroup.call(this,groupID,lSeries);this.oneGroupBandValues=null;this.oneGroupBandColors=null;}this.GenerateTrendLine();this.GenerateRefLine();}mstrmojo.chart.BulletSeriesRenderer=mstrmojo.declare(mstrmojo.chart.BarSeriesRenderer,null,{scriptClass:"mstrmojo.chart.BulletSeriesRenderer",bandOptions:null,bulletWidth:0,oneGroupBandValues:null,oneGroupBandColors:null,labelCollection:null,init:function init(props){this._super(props);this.bandOptions={DescentLayout:false,Width:{Ratio:kDefaultBandWidthRatio,Padding:kAutomaticBandingPadding,Limit:{Max:kMaxBandWidth,Min:kMinBandWidth}},ColorMode:kGrayScale,PositionByMetric:false};},GenerateByValueAxis:function GenerateByValueAxis(iValueAxis){this.mGroupSize=this.mpABLPlotContext.mCategoryAxisPtr.getGroupSize();hCalculateBulletWidth.call(this);if(this.mSeriesInfo.length===0){return ;}hRenderItems.call(this,iValueAxis);},PrepareData:function PrepareData(irRiserInfo,isBullet){if(isBullet){return this.hPrepareData(irRiserInfo);}var bandValues=hGetBandValues.call(this,irRiserInfo.groupID);return bandValues[irRiserInfo.seriesInfoID];}});}());