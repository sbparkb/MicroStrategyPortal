(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.TextBox","mstrmojo.Button","mstrmojo.HBox","mstrmojo.EnumAuthenticationModes","mstrmojo.UsherLogin","mstrmojo.string","mstrmojo.cookies");mstrmojo.requiresDescs(17,18,221,11804,11863);var AUTH_MODES=mstrmojo.EnumAuthenticationModes,auth_labels={};auth_labels[AUTH_MODES.LDAP]=mstrmojo.desc(1947,"LDAP Authentication");auth_labels[AUTH_MODES.DATABASE]=mstrmojo.desc(1948,"Database Authentication");var SESSION_RESULT_CODES={LIVE_OR_HL:0,PERSISTED:1};function getLastMsgID(){return(JSON.parse(decodeURIComponent(mstrmojo.cookies.getCookieSetting("lastMsgID")||"{}")))[mstrConfig.lastMsgKey];}function loginHandler(){var editor=this,stdLoginInfo=editor.stdLoginInfo,user=stdLoginInfo.user.value,tsvCode=stdLoginInfo.tsvCode.value,pwd=stdLoginInfo.pwd.value,params={taskId:"login",server:mstrConfig.serverName,project:mstrmojo.string.decodeHtmlString(mstrConfig.projectName),port:mstrConfig.serverPort,authMode:mstrConfig.authMode,setAsActiveSession:true};var lastMsgID=getLastMsgID();if(lastMsgID){params.msgID=lastMsgID;}if((this.authMode&(AUTH_MODES.STANDARD|AUTH_MODES.LDAP|AUTH_MODES.DATABASE))>0){params.userid=user;params.password=pwd;params.tsvCode=tsvCode;}mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(res){if(res&&res.sessionState){mstrApp.updateSessionState(res.sessionState);if(mstrApp.sessionManager){mstrApp.sessionManager.restart();}var loginRes=res;var resCode=res.resCode;if(resCode==SESSION_RESULT_CODES.LIVE_OR_HL&&(mstrApp.isVI||mstrApp.scriptClass==="mstrmojo.OIVMApp"||mstrApp.analysisID)){mstrmojo.xhr.request("post",mstrConfig.taskURL,{success:function(){var cb=editor.config.callback,success=cb.success;if(success){success(loginRes);}},failure:function(){mstrmojo.form.send({evt:3010,src:mstrApp.name+".3010"},null,"POST");}},{taskId:"docXMLResults",sessionState:res.sessionState,msgID:res.msgID,resultFlags:33554432});}else{var cb=editor.config.callback,success=cb.success;if(success){success(loginRes);}}}editor.destroy();},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"),null,null,editor.zIndex);}},params);}function logout(){if(mstrApp.sessionManager){mstrApp.sessionManager.gotoLogoutPage();}}mstrmojo.LoginEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.LoginEditor",cssClass:"mstrmojo-LoginEditor",title:mstrmojo.desc(11804,"Log in to"),btnAlignment:"right",help:"login_box",config:{callback:{},taskParams:{}},authMode:AUTH_MODES.STANDARD,usherEnabled:false,init:function init(props){this._super(props);this.title+=" "+mstrApp.projectName;this.set("authMode",parseInt(mstrConfig.authMode,10));if(this.isUsherLogin()){mstrmojo.css.addWidgetCssClass(this,"usher");}},isUsherLogin:function(){return this.authMode===AUTH_MODES.USHER;},onvisibleChange:function onvisibleChange(){if(this.visible&&(mstrmojo.dom.isFF||mstrmojo.dom.isWK)){var user=this.stdLoginInfo.user;window.setTimeout(function(){user.focus();},50);}},onClose:function onClose(){logout();},destroy:function destroy(){mstrmojo.dom.detachEvent(document.body,"mousedown",this.stopPropagation,true);this._super();},postBuildRendering:function postBuildRendering(){if(this.authMode===mstrmojo.EnumAuthenticationModes.NTCREDENTIAL){loginHandler.call(this);return ;}else{var ret=this._super();this.stopPropagation=function(evt){evt.stopPropagation();};mstrmojo.dom.attachEvent(document.body,"mousedown",this.stopPropagation,true);return ret;}},preBuildRendering:function preBuildRendering(){if(this.isUsherLogin()){var me=this,usherLogin=mstrmojo.insert({scriptClass:"mstrmojo.UsherLogin",alias:"usherLogin",onUsherLogin:function(){mstrConfig.authMode=AUTH_MODES.USHER;loginHandler.call(me);}});this.addChildren([usherLogin],1);}return this._super();},children:[{scriptClass:"mstrmojo.Label",cssText:"margin-bottom: 20px; line-height: 1.5em;",text:mstrmojo.desc(11863,"Your user session has timed out due to inactivity, and you have been automatically logged out. Please log in again.")},{scriptClass:"mstrmojo.Box",alias:"stdLoginInfo",cssClass:"std-login-container",bindings:{visible:function(){return this.parent.authMode!==AUTH_MODES.USHER;}},children:[{scriptClass:"mstrmojo.TextBox",alias:"user",cssClass:"login-username",cssDisplay:"block",hint:mstrmojo.desc(17,"User name"),postCreate:function(){if(mstrmojo.dom.isIE9||mstrmojo.dom.isIE8||mstrmojo.dom.isIE7){this.emptyText=mstrmojo.desc(17,"User name");}},onEnter:function(){loginHandler.call(this.parent.parent);}},{scriptClass:"mstrmojo.TextBox",alias:"pwd",cssClass:"login-pwd",cssDisplay:"block",hint:mstrmojo.desc(18,"Password"),type:"password",postCreate:function(){if(mstrmojo.dom.isIE9||mstrmojo.dom.isIE8||mstrmojo.dom.isIE7){this.emptyText=mstrmojo.desc(18,"Password");}},onEnter:function(){loginHandler.call(this.parent.parent);}},{scriptClass:"mstrmojo.TextBox",alias:"tsvCode",cssClass:"login-tsvCode",cssDisplay:"block",hint:mstrmojo.desc(13825,"Usher code"),bindings:{visible:function(){return mstrConfig.features["is-two-step-verification-required"];}},postCreate:function(){if(mstrmojo.dom.isIE9||mstrmojo.dom.isIE8||mstrmojo.dom.isIE7){this.emptyText=mstrmojo.desc(13825,"Usher code");}},onEnter:function(){loginHandler.call(this.parent.parent);}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-LoginEditor-authMode",bindings:{visible:function(){return this.parent.parent.authMode===AUTH_MODES.LDAP||this.parent.parent.authMode===AUTH_MODES.DATABASE;},text:function(){return auth_labels[this.parent.parent.authMode]||"";}}}]},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",alias:"btns",cssClass:"mstrmojo-Editor-buttonBar",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton hot",text:mstrmojo.desc(26,"Login"),bindings:{enabled:"this.parent.parent.stdLoginInfo.user.value.length > 0",visible:function(){return this.parent.parent.authMode!==AUTH_MODES.USHER;}},onclick:function(){loginHandler.call(this.parent.parent);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){logout();}}]}]});}());