(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.css","mstrmojo.hash","mstrmojo._HasEditableText","mstrmojo.ui.Pulldown");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,ARROW_WIDTH=19,KEY_ENTER=13,KEY_ESC=27;var $CSS=mstrmojo.css,$DOM=mstrmojo.dom;mstrmojo.Refine.RefineSearchablePulldown=mstrmojo.declare(mstrmojo.ui.Pulldown,[mstrmojo._HasEditableText],{scriptClass:"mstrmojo.Refine.RefineSearchablePulldown",editableSlot:"selectedNode",markupString:'<div id="{@id}" style="{@cssText}" class="mstrmojo-ui-Pulldown {@cssClass}" mstrAttach:mousedown,click><div class="mstrmojo-ui-Pulldown-label" title="{@title}">Search</div><div class="mstrmojo-ui-Pulldown-text" title="{@title}" style="{@labelCssText}"></div><div class="container"></div></div>',markupSlots:{selectedNode:function selectedNode(){return this.domNode.children[1];},labelNode:function labelNode(){return this.domNode.children[0];},containerNode:function containerNode(){return this.domNode.lastChild;}},allowCustomText:false,isSearching:false,editOnClick:false,init:function init(props){this._super(props);var popupList=this.getPopupList();popupList.renderOnScroll=this.renderOnScroll||popupList.renderOnScroll;popupList.renderBlockSize=this.renderBlockSize||popupList.renderBlockSize;mstrmojo.css.addWidgetCssClass(this,"mstrmojo-ui-SearchablePulldown mstrmojo-Refine-SearchablePulldown");var prt=popupList.constructor.prototype,getItemProps=popupList.getItemProps?popupList.getItemProps:prt.getItemProps,getItemMarkup=popupList.getItemMarkup?popupList.getItemMarkup:prt.getItemMarkup;popupList.getItemProps=function(item,idx){var input=this._spft||"",itemName=item.n,index=itemName.toUpperCase().indexOf(input);if(index===-1){input="";}var props=getItemProps.call(this,item,idx);props.before=itemName.slice(0,index);props.input=itemName.substring(index,index+input.length);props.after=itemName.slice(index+input.length,itemName.length);return props;};popupList.getItemMarkup=function(item,idx){return getItemMarkup.call(this,item,idx).replace("{@en@n}","{@en@before}<span class='sp-highlight'>{@en@input}</span>{@en@after}");};},onclick:function onclick(evt){var selectedNode=this.selectedNode,target=evt.getTarget(),isArrow=evt.e.offsetX>=(selectedNode.offsetWidth-ARROW_WIDTH),popupWidget=this.getPopupWidget(),isPopupWidgetVisible=popupWidget.visible;if(target===selectedNode&&(!isPopupWidgetVisible||(isPopupWidgetVisible&&isArrow))){this.set("isEditing",!isPopupWidgetVisible);this.labelNode.style.display=isPopupWidgetVisible?"none":"block";$CSS.toggleClass(this.labelNode,"hidden",false);this._super(evt);}},onPopupWidgetClosed:function onPopupWidgetClosed(){this.set("isEditing",false);this.labelNode.style.display="none";var pulldownList=this.getPopupList(),oldItems=pulldownList._oldItems,textValue=this.text;delete pulldownList._oldItems;if(oldItems){var selIdx=$ARR.find(oldItems,"n",textValue);if(selIdx===-1&&!this.allowCustomText){pulldownList.set("items",oldItems);return ;}pulldownList.set("items",oldItems);this.set("selectedIndex",selIdx);}},_set_selectedIndex:function onselectedIndexChange(n,v){if(this.allowCustomText&&v===-1){this.selectedIndex=-1;this.onitemSelected(null,v);}else{this.isSearching=false;this._super(n,v);if(this.hasRendered){var pulldownList=this.getPopupList();var index=this.selectedIndex;var items=pulldownList.items;this.text=items[index].n;}}return true;},onkeydown:function onkeydown(event){this._super(event);var evt=window.event||event.e;if(evt.keyCode===KEY_ENTER){this.getPopupList().close();}},onkeyup:function onkeyup(event){this._super(event);var evt=window.event||event.e,keyCode=evt.keyCode,pulldownList=this.getPopupList();if(keyCode===KEY_ESC||keyCode===KEY_ENTER){pulldownList.close();}else{this.processSearch();}},onblur:function onblur(){},processSearch:function processSearch(){this.isSearching=true;this.hideTooltip();var result=[],pulldownList=this.getPopupList(),searchValue=this.selectedNode.innerHTML,oldItems=pulldownList._oldItems||pulldownList.items,input=searchValue.toUpperCase();if(searchValue){$CSS.toggleClass(this.labelNode,"hidden",true);}else{$CSS.toggleClass(this.labelNode,"hidden",false);}input=input.replace(/<BR>/,"");if(input.length>0){$ARR.forEach(oldItems,function(item){if(item.n.toUpperCase().indexOf(input)>-1&&!item.skipSearch){result.push($HASH.clone(item));}},this);}else{result=oldItems;}pulldownList._spft=input;if(this.customizeSearchResult){this.customizeSearchResult(result);}pulldownList.set("items",result);pulldownList.adjustCornersForPopupOverflow();delete pulldownList._spft;pulldownList._oldItems=oldItems;pulldownList.set("visible",result.length!==0);},onisEditingChange:function onisEditingChange(){if(this.hasRendered){var editableDomNode=this[this.editableSlot],isEditing=!!this.isEditing;editableDomNode.contentEditable=isEditing;editableDomNode.spellcheck=false;$CSS.toggleClass(editableDomNode,"editable",isEditing);if(isEditing){editableDomNode.innerHTML="";editableDomNode.focus();$DOM.setElementSelection(editableDomNode);}else{editableDomNode.innerHTML=this.text;editableDomNode.blur();editableDomNode.scrollLeft=0;}}}});}());