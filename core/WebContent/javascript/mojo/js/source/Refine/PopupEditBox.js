(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.dom","mstrmojo.Refine.DateTimeUtil","mstrmojo.Refine.RefineHelpers","mstrmojo.string");mstrmojo.requiresDescs(221,12366,2164,13188,14517);var _D=mstrmojo.dom;var DateTimeUtil=mstrmojo.Refine.DateTimeUtil;function isNumber(n){return !isNaN(parseFloat(n))&&isFinite(n);}mstrmojo.PopupEditBox=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.PopupEditBox",text:"",value:"",top:0,left:0,markupString:'<div id="{@id}" class="refine-cell-editor {@cssClass}" style="top: {@top}; left: {@left};" mstrAttach:click,keydown><div class="refine-menu-overlay"></div><div class="refine-menu-container" style="width: {@width};"><div class="refine-cell-editor-text"></div><div class="refine-cell-editor-actions"><div class="refine-cell-editor-action"></div><div class="refine-cell-editor-action"></div><div class="refine-cell-editor-action"></div></div></div></div>',markupSlots:{overlayNode:function(){return this.domNode.firstChild;},autoNode:function(){return this.domNode.lastChild.childNodes[0];},buttonNode:function(){return this.domNode.lastChild.lastChild;},applyToAllNode:function(){return this.domNode.lastChild.lastChild.childNodes[2];},applyNode:function(){return this.domNode.lastChild.lastChild.childNodes[1];},cancelNode:function(){return this.domNode.lastChild.lastChild.childNodes[0];}},children:[{scriptClass:"mstrmojo.Button",cssClass:"refine-cell-editor-apply-to-all",title:mstrmojo.desc(12366,"Apply To All")+" (Enter)",slot:"applyToAllNode",onclick:function(){this.parent.applyToAll();this.hideTooltip();this.parent.destroy();},tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){var pos=_D.position(this.domNode);this.set("richTooltip",{cssClass:"vi-regular A-center vi-tooltip-A",top:Math.max(pos.y+30,0),left:Math.max(pos.x+10,0),posType:mstrmojo.tooltip.POS_TOPCENTER,content:this.title});}},{scriptClass:"mstrmojo.Button",cssClass:"refine-cell-editor-apply",title:mstrmojo.desc(2164,"Apply")+" (Ctrl + Enter)",slot:"applyNode",alias:"applyButton",bindings:{visible:function(){return(!this.parent.fromFacet)&&(!mstrApp.getRootController().refineApp.isBDE);}},onclick:function(){this.parent.apply();this.hideTooltip();this.parent.destroy();},tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){var pos=_D.position(this.domNode);this.set("richTooltip",{cssClass:"vi-regular A-center vi-tooltip-A",top:Math.max(pos.y+30,0),left:Math.max(pos.x+10,0),posType:mstrmojo.tooltip.POS_TOPCENTER,content:this.title});}},{scriptClass:"mstrmojo.Button",cssClass:"refine-cell-editor-cancel",title:mstrmojo.desc(221,"Cancel"),alias:"cancel",slot:"cancelNode",onclick:function(){this.hideTooltip();this.parent.destroy();},tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){var pos=_D.position(this.domNode);this.set("richTooltip",{cssClass:"vi-regular A-center vi-tooltip-A",top:Math.max(pos.y+30,0),left:Math.max(pos.x+10,0),posType:mstrmojo.tooltip.POS_TOPCENTER,content:this.title});}}],applyToAll:function(){var inputText=this.autoNode.childNodes[0].childNodes[2].value;if(String(this.text)!==inputText){var controller=this.preview.controller;var model=controller.model;var columnName=this.columnName;var operations=[],operation,value;var dtFormat="yyyy-MM-ddTHH:mm:ssZ";var type=this.type;operation=JSON.parse(JSON.stringify(model.transformations.EditCell.applyToAll));operation.description=operation.description.replace("[column name]",columnName);operation.columnName=columnName;operation.edits[0].to=inputText;if(this.type==="number"){if(!isNumber(inputText)){mstrmojo.alert(mstrmojo.desc(13188,"Not a valid Number. Convert data type of column to Text"));return ;}value=parseFloat(inputText);operation.edits[0].to=value;}else{if(this.type==="date"||this.type==="time"||this.type==="datetime"){value=Date.parse(inputText);if(!value){mstrmojo.alert(mstrmojo.desc(14517,"Not a valid Date"));return ;}operation.edits[0].to=inputText;type="date";}}if(this.text===""||(this.text==="(blank)"&&this.blankChoice)){operation.edits[0].fromBlank=true;operation.edits[0].from[0]="";}else{operation.edits[0].from[0]=this.value||this.text;}operation.edits[0].type=type;if(!this.fromFacet){operation.engineConfig=JSON.parse(model.engine);}operations.push(operation);this.preview.controller.applyOperations({operations:JSON.stringify(operations),engine:JSON.stringify({facets:[],mode:"row-based"})});}},apply:function(){var inputText=this.autoNode.childNodes[0].childNodes[2].value;if(this.text.toString()!==inputText){var controller=this.preview.controller;var model=controller.model;var operations=[],operation,value;var dtFormat="yyyy-MM-ddTHH:mm:ssZ";operation=JSON.parse(JSON.stringify(model.transformations.EditCell.singleEdit));operation.description=operation.description.replace("####",this.row);operation.description=operation.description.replace("####",this.cell);operation.row=this.row;operation.col=this.cell;value=inputText;if(this.type==="number"){if(!isNumber(inputText)){mstrmojo.alert(mstrmojo.desc(13188,"Not a valid Number. Convert data type of column to Text"));return ;}value=parseFloat(inputText);}else{if(this.type==="date"||this.type==="time"||this.type==="datetime"){value=Date.parse(inputText);if(!value){mstrmojo.alert(mstrmojo.desc(14517,"Not a valid Date."));return ;}value=inputText;}}operation.to=value;operation.description=operation.description.replace("####",value);operations.push(operation);this.preview.controller.applyOperations({operations:JSON.stringify(operations),engine:JSON.stringify({facets:[],mode:"row-based"})});}},onclick:function(evt){var e=evt.e,t=_D.eventTarget(evt.hWin,e);if(t===this.overlayNode){this.destroy();}},prekeydown:function(evt){var e=evt.e,k=e.keyCode||e.charCode,controller=this.preview.controller,model=controller.model;if(e.ctrlKey&&k===mstrmojo.Enum_Keys.ENTER){if(!this.fromFacet&&!model.hasAddSample()){this.apply();this.destroy();}}else{if(k===mstrmojo.Enum_Keys.ENTER){this.applyToAll();this.destroy();}else{if(k===mstrmojo.Enum_Keys.ESCAPE){this.destroy();}}}},preBuildRendering:function preBuildRendering(){var controller=this.preview.controller,model=controller.model;this.placeholder=document.body.appendChild(document.createElement("div"));if(model.hasAddSample()){this.applyButton.set("visible",false);}return this._super();},postBuildRendering:function postBuildRendering(){this._super();this.autoNode.style.width=(parseInt(this.width)-(this.fromFacet?43:88))+"px";if(this.floatLeft){this.autoNode.style["float"]="left";this.autoNode.style.marginRight="3px";this.buttonNode.style["float"]="left";}else{this.autoNode.style["float"]="right";this.autoNode.style.marginLeft="3px";this.buttonNode.style["float"]="right";}var me=this;var auto=mstrmojo.Refine.RefineHelpers.completely(this.autoNode,{bottom:(this.fromFacet?14:16),top:(this.fromFacet?15:17),left:(this.fromFacet?0:10),fontSize:"8pt",fontFamily:"monospace",width:(parseInt(this.width)-(this.fromFacet?43:77))});setTimeout(function(){auto.input.focus();auto.setText(me.text);auto.input.select();auto.repaint();},0);var config={facets:[{type:"list",name:this.columnName,columnName:this.columnName,expression:"value",omitBlank:false,omitError:false,selection:[],selectBlank:false,selectError:false,invert:false}],mode:"row-based"};var fullOptions=[];var callback={success:function(res){var choices=res.facets[0].choices,i;if(choices){for(i=0;i<choices.length;i++){fullOptions.push(choices[i].v.l);}}fullOptions.sort(function(a,b){return a.localeCompare(b);});auto.options=fullOptions;setTimeout(function(){auto.repaint();},0);}};var postParams={engine:JSON.stringify(config)};var params={project:this.preview.controller.model.projectID};this.preview.controller.dataService.computeFacetsQuiet(callback,params,postParams);return true;}});}());