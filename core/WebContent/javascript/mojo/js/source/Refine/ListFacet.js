(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Button","mstrmojo.ui.menus.Menu","mstrmojo._HasPopup","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.Refine.RefineFacetMenu","mstrmojo.Widget","mstrmojo.dom");mstrmojo.requiresDescs(3946,3945,12352,1905,8445,1088);var _D=mstrmojo.dom;var _C=mstrmojo.css;var INCREASEMENT=100;var choiceNode={scriptClass:"mstrmojo.Widget",choiceIndex:null,label:null,count:null,s:false,markupString:'<div class="facet-choice" mstrAttach:click,mouseover,mouseout><a class="facet-choice-link"></a><a class="facet-choice-link" title="'+mstrmojo.desc(1088,"Edit")+'">'+mstrmojo.desc(1088,"Edit")+'</a><div class="facet-choice-label"></div><span class="facet-choice-count">({@count})</span><div class="facet-choice-count-bar"></div></div>',markupSlots:{toggleNode:function(){return this.domNode.children[0];},editNode:function(){return this.domNode.children[1];},labelNode:function(){return this.domNode.children[2];},countNode:function(){return this.domNode.children[3];},barNode:function(){return this.domNode.children[4];}},markupMethods:{onlabelChange:function(){this.labelNode.innerHTML=mstrmojo.string.encodeHtmlString(String(this.label)||"",null,true);this.labelNode.title=this.label;}},onmouseover:function(){if(!this.s){this.toggleNode.style.visibility="visible";}this.editNode.style.visibility="visible";},onmouseout:function(){if(!this.s){this.toggleNode.style.visibility="hidden";}this.editNode.style.visibility="hidden";},onclick:function(evt){var e=evt.e,t=_D.eventTarget(evt.hWin,e);if(t===this.labelNode){this.parent.labelClick(this.choiceIndex);}else{if(t===this.toggleNode){this.parent.toggleClick(this.choiceIndex);}else{if(t===this.editNode){var posDom=_D.position(this.domNode);var left=posDom.x-1;var top=posDom.y-1;mstrmojo.insert({scriptClass:"mstrmojo.PopupEditBox",cssClass:"facet",top:top+document.body.scrollTop+"px",left:left+document.body.scrollLeft+"px",width:posDom.w+"px",text:this.blankChoice?"":this.label,preview:this.parent.parent.parent.parent.parent,columnName:this.parent.config.name,type:"text",blankChoice:this.blankChoice,fromFacet:true,floatLeft:true}).render();}}}},postBuildRendering:function(){if(this.s){_C.toggleClass(this.domNode,"facet-choice-selected",true);}this.toggleNode.style.visibility=(this.s?"visible":"hidden");this.toggleNode.innerHTML=(this.parent.config.invert!==this.s?mstrmojo.desc(3946,"exclude"):mstrmojo.desc(3945,"include"));this.toggleNode.title=(this.parent.config.invert!==this.s?mstrmojo.desc(3946,"exclude"):mstrmojo.desc(3945,"include"));this.editNode.style.visibility="hidden";if(this.toggleNode.clientWidth+this.editNode.clientWidth+this.labelNode.clientWidth+this.countNode.offsetWidth+21>291){this.toggleNode.style.maxWidth="45px";this.editNode.style.maxWidth="45px";}this.barNode.style.right=(1-this.bar)*100+"%";}};mstrmojo.Refine.ListFacet=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup,mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.Refine.ListFacet",config:null,options:null,selection:[],blankChoice:null,errorChoice:null,data:null,_dataIndex:0,_childrenNodes:[],markupString:'<li class="facet-container" id="{@id}" mstrAttach:click><div class="facet-title"><div class="facet-text"><a class="facet-choice-link" >'+mstrmojo.desc(1905,"reset")+'</a><a class="facet-choice-link" >'+mstrmojo.desc(12352,"invert")+'</a><div class="facet-column-name"></div><div class="choiceCountContainer"></div> </div><div class="facet-menu"></div></div><div class="facet-body"><div class="facet-body-inner"></div></div></li>',markupSlots:{menuNode:function(){return this.domNode.children[0].children[1];},resetNode:function(){return this.domNode.children[0].children[0].children[0];},invertNode:function(){return this.domNode.children[0].children[0].children[1];},choiceCountNode:function(){return this.domNode.children[0].children[0].children[3];},titleNode:function(){return this.domNode.children[0].children[0].children[2];},bodyInnerNode:function(){return this.domNode.children[1].children[0];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},children:[{slot:"menuNode",alias:"menu",iconClass:"refine",scriptClass:"mstrmojo.Button",onclick:function(){var src=this.parent;var $MAPPINGTABLE=mstrmojo.Refine.ListFacet;var menuHelper=$MAPPINGTABLE.menuHelper=$MAPPINGTABLE.menuHelper||new mstrmojo.Refine.RefineFacetMenu();menuHelper.target=src;menuHelper.type=0;var cfg=menuHelper.getMenuConfig();cfg.hostId=src.id;cfg.hostElement=this.domNode;cfg.isHostedWithin=false;cfg.position=_D.position(this.domNode,true);src.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));}}],labelClick:function(index){var choices=this.data.choices,choice;var selectionCount=this.selection.length+(this.blankChoice!==null&&this.blankChoice.s?1:0)+(this.errorChoice!==null&&this.errorChoice.s?1:0);if(index===-1){choice=this.blankChoice;}else{if(index===-2){choice=this.errorChoice;}else{choice=choices[index];}}if(choice.s){if(selectionCount>1){this.select(choice,true);}else{this.deselect(choice);}}else{if(selectionCount>0){this.select(choice,true);}else{this.select(choice,false);}}},toggleClick:function(index){var choices=this.data.choices,choice;if(index===-1){choice=this.data.blankChoice;}else{choice=choices[index];}if(choice.s){this.deselect(choice);}else{this.select(choice,false);}},select:function(choice,only){if(only){this.selection=[];if(this.blankChoice!==null){this.blankChoice.s=false;}if(this.errorChoice!==null){this.errorChoice.s=false;}}choice.s=true;if(choice!==this.errorChoice&&choice!==this.blankChoice){this.selection.push(choice);}this.parent.updateEngine(true);},deselect:function(choice){var i;if(choice===this.errorChoice||choice===this.blankChoice){choice.s=false;}else{for(i=this.selection.length-1;i>=0;i--){if(this.selection[i]===choice){this.selection.splice(i,1);break;}}}this.parent.updateEngine(true);},onclick:function(evt){var e=evt.e,t=_D.eventTarget(evt.hWin,e);if(t===this.invertNode){this.config.invert=!this.config.invert;this.parent.updateEngine(true);}else{if(t===this.resetNode){this.reset();this.parent.updateEngine(true);}}},sortByName:function(){if(this.options.sort!=="name"){this.options.sort="name";this.reSortChoices();this.update();}},sortByCount:function(){if(this.options.sort!=="count"){this.options.sort="count";this.reSortChoices();this.update();}},reset:function(){this.selection=[];this.blankChoice=null;this.errorChoice=null;this.config.invert=false;},remove:function(){this.parent.removeFacet(this);this.config=null;this.selection=null;this.blankChoice=null;this.errorChoice=null;this.data=null;},hasSelection:function(){return this.selection.length>0||(this.blankChoice!==null&&this.blankChoice.s)||(this.errorChoice!==null&&this.errorChoice.s);},getRequirementDiscription:function(){var i,res='{cells in "'+this.config.name+'" '+(this.config.invert?"are not equal to ":"are equal to ");for(i=0;i<this.selection.length;i++){var sel=this.selection[i];res+='"'+sel.v.l+'"';if(i!==this.selection.length-1){res+=" / ";}}res+="}";return res;},postBuildRendering:function(){if(this._super){this._super();}this.titleNode.innerHTML=this.config.name;this.titleNode.title=this.config.name;this.config.invert=false;this.update();this.bodyInnerNode.onscroll=function(){var listFacet=_D.findWidget(this.parentNode.parentNode);if(this.scrollTop+this.clientHeight+3>=this.scrollHeight){if(listFacet._dataIndex<listFacet._childrenNodes.length-1){listFacet.incrementalRender(listFacet._childrenNodes,listFacet._dataIndex);}}};},updateState:function(data){this.maxCount=0;this.data=data;var i,reset=false;if(data.choices){var selection=[];var choices=data.choices;for(i=0;i<choices.length;i++){var choice=choices[i];this.maxCount=Math.max(this.maxCount,choice.c);if(choice.s){if(choice.c===0){reset=true;}else{selection.push(choice);}}}this.selection=selection;this.reSortChoices();this.blankChoice=null;if(data.blankChoice){this.maxCount=Math.max(this.maxCount,data.blankChoice.c);if(data.blankChoice.c===0){data.blankChoice=null;reset=true;}else{this.blankChoice=data.blankChoice;}}this.errorChoice=data.errorChoice||null;}if(reset===true){this.parent.updateEngine(true);return ;}this.update();},reSortChoices:function(){this.data.choices.sort(this.options.sort==="name"?function(a,b){return a.v.l.toLowerCase().localeCompare(b.v.l.toLowerCase());}:function(a,b){var c=b.c-a.c;return c!==0?c:a.v.l.localeCompare(b.v.l);});},update:function(){var i,node;var invert=this.config.invert;if(invert){_C.toggleClass(this.bodyInnerNode,"facet-mode-inverted",true);_C.toggleClass(this.invertNode,"facet-mode-inverted",true);}else{_C.toggleClass(this.bodyInnerNode,"facet-mode-inverted",false);_C.toggleClass(this.invertNode,"facet-mode-inverted",false);}while(this.bodyInnerNode.hasChildNodes()){this.bodyInnerNode.removeChild(this.bodyInnerNode.firstChild);}if(!this.data){node=document.createElement("div");node.className="facet-body-message";node.innerHTML=mstrmojo.desc(8445,"Loading")+"...";this.bodyInnerNode.appendChild(node);return ;}if(this.data.hasOwnProperty("error")){node=document.createElement("div");node.className="facet-body-message";node.innerHTML=this.data.error;this.bodyInnerNode.appendChild(node);return ;}var choices=this.data.choices;var selectionCount=this.selection.length+(this.blankChoice!==null&&this.blankChoice.s?1:0)+(this.errorChoice!==null&&this.errorChoice.s?1:0);this.choiceCountNode.innerHTML="("+choices.length+")";if(selectionCount>0){this.invertNode.style.display="block";this.resetNode.style.display="block";}else{this.invertNode.style.display="none";this.resetNode.style.display="none";}var childrenNodes=[];var choice,choiceCell;for(i=0;i<choices.length;i++){choice=choices[i];if(choice.c===0){continue;}choiceNode.slot="bodyInnerNode";choiceNode.choiceIndex=i;choiceNode.label=choice.v.l;choiceNode.count=choice.c;choiceNode.bar=choice.c/this.maxCount;choiceNode.s=choice.s;choiceNode.blankChoice=false;choiceCell=new mstrmojo.Widget(choiceNode);childrenNodes.push(choiceCell);}if(this.blankChoice!==null){choice=this.blankChoice;choiceNode.slot="bodyInnerNode";choiceNode.choiceIndex=-1;choiceNode.label="(blank)";choiceNode.blankChoice=true;choiceNode.count=choice.c;choiceNode.bar=choice.c/this.maxCount;choiceNode.s=choice.s;choiceCell=new mstrmojo.Widget(choiceNode);childrenNodes.push(choiceCell);}if(this.errorChoice!==null){choice=this.errorChoice;choiceNode.slot="bodyInnerNode";choiceNode.choiceIndex=-2;choiceNode.label="(error)";choiceNode.count=choice.c;choiceNode.bar=choice.c/this.maxCount;choiceNode.s=choice.s;choiceCell=new mstrmojo.Widget(choiceNode);childrenNodes.push(choiceCell);}this.set("_dataIndex",0);this.set("_childrenNodes",childrenNodes);this.incrementalRender(this._childrenNodes,this._dataIndex);},incrementalRender:function(childrenNodes,index){var start=index===0?index:index+1,end=start+INCREASEMENT-1,arr=childrenNodes.slice(start,end+1);this.set("_dataIndex",end);this.addChildren(arr);},getJSON:function(){var i;var o={type:"list",name:this.config.name,columnName:this.config.columnName,expression:this.config.expression,omitBlank:this.config.omitBlank||false,omitError:this.config.omitError||false,selection:[],selectBlank:this.blankChoice!==null&&this.blankChoice.s,selectError:this.errorChoice!==null&&this.errorChoice.s,invert:this.config.invert};for(i=0;i<this.selection.length;i++){var choice={v:this.selection[i].v};o.selection.push(choice);}return o;}});}());