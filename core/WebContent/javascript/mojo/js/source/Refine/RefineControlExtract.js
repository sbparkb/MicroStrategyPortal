(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.HBox","mstrmojo.TextBox","mstrmojo.RadioList","mstrmojo.Button","mstrmojo.Refine.RefineConstants");mstrmojo.requiresDescs(13574,134,1052,1053,12343,12362,12363,12364,12365,3627,14549,14550);var constants=mstrmojo.Refine.RefineConstants;function escapeSpecial(str){str=str.replace(/\n/g,"\\n");str=str.replace(/\t/g,"\\t");return str;}function replaceDollar(str){return str.replace(/\$/g,"$$$$").replace(/[\\"']/g,"\\$&");}function applyOperations(){var i=1,j,unique,operations=[],operation,transformation,columns,index,columnName,transformationList,idx,targetColumn,newColumnName,columnIndex;transformation=this.parent;columns=transformation.columns;index=columns.selectedIndex;columnIndex=columns.items[columns.selectedIndex].columnIndex;if(index===undefined){return ;}columnName=(columns.items[index]).name;transformationList=transformation.transformationList;idx=transformationList.subType%10;while(true){newColumnName=columnName+" "+i;unique=true;for(j=0;j<columns.items.length;j++){if(newColumnName===(columns.items[j]).name){unique=false;break;}}i++;if(unique){targetColumn=newColumnName;break;}}switch(idx){case 0:operation=JSON.parse(JSON.stringify(this.operations.fromTo));var from=this.optionsBox.fromto.from.value;var to=this.optionsBox.fromto.to.value;if(!from||!to){mstrmojo.alert(mstrmojo.desc(13574,"Please fill out all fields before apply."));return ;}operation.description=operation.description.replace("[new column name]",targetColumn);operation.description=operation.description.replace("[column name]",columnName);operation.description=operation.description.replace("[from]",parseInt(from)-1);operation.description=operation.description.replace("[to]",to);operation.columnInsertIndex=columnIndex+1;operation.newColumnName=operation.newColumnName.replace("[column name]",targetColumn);operation.baseColumnName=operation.baseColumnName.replace("[column name]",columnName);operation.expression=operation.expression.replace("[from]",parseInt(from)-1);operation.expression=operation.expression.replace("[to]",to);break;case 1:case 2:if(!this.optionsBox.separatorBox.separator.value){mstrmojo.alert(mstrmojo.desc(13574,"Please fill out all fields before apply."));return ;}if(idx===1){operation=JSON.parse(JSON.stringify(this.operations.beforeFirst));}else{operation=JSON.parse(JSON.stringify(this.operations.afterLast));}operation.description=operation.description.replace("[new column name]",targetColumn);operation.description=operation.description.replace("[column name]",columnName);operation.columnInsertIndex=columnIndex+1;operation.newColumnName=operation.newColumnName.replace("[column name]",targetColumn);operation.baseColumnName=operation.baseColumnName.replace("[column name]",columnName);if(this.optionsBox.separatorBox.separatorList.selectedIndex===7){operation.description=operation.description.replace("####","/"+this.optionsBox.separatorBox.separator.value+"/");operation.expression=operation.expression.replace(new RegExp("\\[separator\\]","gm"),"/"+this.optionsBox.separatorBox.separator.value+"/");}else{operation.description=operation.description.replace("####","'"+escapeSpecial(replaceDollar(this.optionsBox.separatorBox.separator.value))+"'");operation.expression=operation.expression.replace(new RegExp("\\[separator\\]","gm"),"'"+replaceDollar(this.optionsBox.separatorBox.separator.value)+"'");}break;}operation.engineConfig=JSON.parse(this.controller.model.engine);operations.push(operation);this.controller.applyOperations({operations:JSON.stringify(operations),engine:JSON.stringify({facets:[],mode:"row-based"})});this.optionsBox.fromto.from.set("value","");this.optionsBox.fromto.to.set("value","");this.optionsBox.separatorBox.separatorList.set("selectedIndex",0);this.optionsBox.separatorBox.separator.set("value",",");}mstrmojo.Refine.RefineControlExtract=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.Refine.RefineControlExtract",markupString:'<div class="refine-controls"><div></div></div>',markupSlots:{optionsNode:function(){return this.domNode.children[0];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},operations:null,bindings:{visible:function(){return(this.parentBox.transformationList.type===constants.transformationType.Extract);}},children:[{scriptClass:"mstrmojo.HBox",slot:"optionsNode",alias:"optionsBox",children:[{scriptClass:"mstrmojo.HBox",alias:"fromto",children:[{scriptClass:"mstrmojo.TextBox",cssClass:"refine-extract-fromto",alias:"from",tooltip:mstrmojo.desc(14549,"Start Index")+" (1, 2, ...)",emptyText:mstrmojo.desc(14549,"Start Index")+" (1, 2, ...)",valueChangeDelay:200,onvalueChange:function(evt){var value=evt.value;value=value.replace(/[^0-9]/g,"");if(value!==""){if(parseInt(value)===0){value="";}}this.set("value",value);}},{scriptClass:"mstrmojo.TextBox",cssClass:"refine-extract-fromto",alias:"to",tooltip:mstrmojo.desc(14550,"End Index")+" (1, 2, ...)",emptyText:mstrmojo.desc(14550,"End Index")+" (1, 2, ...)",valueChangeDelay:200,onvalueChange:function(evt){var value=evt.value;value=value.replace(/[^0-9]/g,"");if(value!==""){if(parseInt(value)===0){value="";}}this.set("value",value);}}],bindings:{visible:function(){return(this.parent.parent.parentBox.transformationList.subType%10===0);}}},{scriptClass:"mstrmojo.HBox",alias:"separatorBox",children:[{scriptClass:"mstrmojo.ui.Pulldown",cssClass:"refine-pulldown",alias:"separatorList",items:[{n:mstrmojo.desc(1052,"comma")},{n:mstrmojo.desc(1053,"tab")},{n:mstrmojo.desc(12343,"whitespace")},{n:mstrmojo.desc(12362,"newline")},{n:mstrmojo.desc(12363,"pipe")},{n:mstrmojo.desc(12364,"period")},{n:mstrmojo.desc(3627,"other")},{n:mstrmojo.desc(12365,"regex")}],selectedIndex:0,onitemSelected:function(){if(this.selectedIndex===6||this.selectedIndex===7){this.parent.separator.set("value","");this.parent.separator.set("visible",true);}else{this.parent.separator.set("visible",false);if(this.selectedIndex===0){this.parent.separator.set("value",",");}else{if(this.selectedIndex===1){this.parent.separator.set("value","\t");}else{if(this.selectedIndex===2){this.parent.separator.set("value"," ");}else{if(this.selectedIndex===3){this.parent.separator.set("value","\n");}else{if(this.selectedIndex===4){this.parent.separator.set("value","|");}else{if(this.selectedIndex===5){this.parent.separator.set("value",".");}}}}}}}}},{scriptClass:"mstrmojo.TextBox",alias:"separator",visible:false,value:","}],bindings:{visible:function(){return(this.parent.parent.parentBox.transformationList.subType%10!==0);}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton hot",text:mstrmojo.desc(134,"Apply"),onclick:function(){applyOperations.call(this.parent.parent);}}]}]});}());