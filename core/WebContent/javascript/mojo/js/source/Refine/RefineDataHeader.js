(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Refine.RefineMenu","mstrmojo.InlineEditBox");var _D=mstrmojo.dom;var ITEM_MENU=0;var diHelper=mstrmojo.DI.DIHelpers;mstrmojo.Refine.RefineDataHeader=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup,mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.Refine.RefineDataHeader",text:"",markupString:'<div id="{@id}" class="refine-data-header {@cssClass}" style="{@cssText}" mstrAttach:mousedown><div class="refine-data-header-text"></div><div class="refine-data-header-menu"></div></div>',markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},markupSlots:{textNode:function(){return this.domNode.children[0];},menuNode:function(){return this.domNode.children[1];}},onmousedown:function(evt){this.preview.controller.model.raiseEvent({name:"columnSelected",columnIndex:this.columnIndex,columnName:this.text,isCtrlKey:diHelper.isCtrlKey(evt.hWin,evt.e)});this.preview.controller.isClickedInDatePreview=true;this.preview.controller.resetRecords();},children:[{slot:"textNode",alias:"inlineEdit",scriptClass:"mstrmojo.InlineEditBox",markupString:'<div id="{@id}" class="mstrmojo-InlineEditBox {@cssClass}" style="{@cssText}" mstrAttach:mousedown,dblclick><div class="mstrmojo-InlineEditBox-text"></div><div class="mstrmojo-InlineEditBox-edit"><input type="text" class="mstrmojo-InlineEditBox-input" mstrAttach:keyup/><img class="mstrmojo-InlineEditBox-ok" src="../images/1ptrans.gif" title="Save"/><img class="mstrmojo-InlineEditBox-cancel" src="../images/1ptrans.gif" title="Cancel"/></div><div class="mstrmojo-InlineEditBox-overlay"></div></div>',markupSlots:{textNode:function(){return this.domNode.firstChild;},editNode:function(){return this.domNode.childNodes[1];},inputNode:function(){return this.domNode.childNodes[1].firstChild;},okNode:function(){return this.domNode.childNodes[1].childNodes[1];},cancelNode:function(){return this.domNode.childNodes[1].lastChild;},overlayNode:function(){return this.domNode.lastChild;}},markupMethods:{ontextChange:function(){this.textNode.innerHTML=mstrmojo.string.encodeHtmlString(this.text||"",null,true);this.textNode.title=this.text;},oneditModeChange:function(){var em=this.editMode,dn=this.domNode,tn=this.textNode,on=this.overlayNode,en=this.editNode;mstrmojo.css.toggleClass(dn,["edit"],em);if(em){tn.style.display="none";en.style.display="block";on.style.display="block";tn=this.inputNode;var tns=tn.style;tn.value=this.text||"";tns.width=(this.nodeWidth-(this.okSave?(this.okNode.offsetWidth+this.cancelNode.offsetWidth):0))+"px";tns.height=this.nodeHeight+"px";tn.select();tn.focus();if(tn.createTextRange){var tr=tn.createTextRange(),len=tn.value.length;tr.move("character",len);tr.select();}}else{tn.style.display="block";en.style.display="none";on.style.display="none";}},onokSaveChange:function(){var s=this.okSave?"inline":"none";this.okNode.style.display=s;this.cancelNode.style.display=s;},onallowEditChange:function(){mstrmojo.css.toggleClass(this.domNode,["disable"],!this.allowEdit);}},bindings:{text:"this.parent.text"},ondblclick:function(){this.nodeWidth=this.domNode.clientWidth;this.nodeHeight=this.domNode.clientHeight;this.set("editMode",this.allowEdit);},onmousedown:function(evt){var e=evt.e,t=_D.eventTarget(evt.hWin,e);if(t===this.okNode){this.save();}else{if(t===this.cancelNode){this.cancel();}}},save:function(){this.oldColumn=this.text;this.newColumn=this.inputNode.value;this.set("editMode",false);if(this.oldColumn===this.newColumn){return ;}if(this.onSave){this.onSave();}},onSave:function(){this.handleRename();},handleRename:function(){var controller=this.parent.preview.controller;var model=controller.model;var oldColumn=this.oldColumn;var newColumn=this.newColumn;var operations=[],operation;operation=JSON.parse(JSON.stringify(model.transformations.Other.Rename));operation.description=operation.description.replace("####",oldColumn);operation.description=operation.description.replace("@@@@",newColumn);operation.oldColumnName=oldColumn;operation.newColumnName=newColumn;operations.push(operation);controller.applyOperations({operations:JSON.stringify(operations),engine:JSON.stringify({facets:[],mode:"row-based"})});},handleDelete:function(){var controller=this.parent.preview.controller;var model=controller.model;var deleteColumn=this.text;var operations=[],operation;operation=JSON.parse(JSON.stringify(model.transformations.Delete.Colomn));operation.description=operation.description.replace("[column name]",deleteColumn);operation.columnName=deleteColumn;operations.push(operation);controller.applyOperations({operations:JSON.stringify(operations),engine:JSON.stringify({facets:[],mode:"row-based"})});},_attachEvents:function(){var me=this;if(this.editMode){if(!this._save_handler){this._save_handler=function(){var t=_D.eventTarget(self,arguments[0]);if(t===me.overlayNode){me.save();}};}_D.attachEvent(document.body,"mousedown",this._save_handler);}else{if(this._save_handler){_D.detachEvent(document.body,"mousedown",this._save_handler);}}}},{slot:"menuNode",alias:"menu",iconClass:"refine",scriptClass:"mstrmojo.Button",onclick:function(){var src=this.parent;var $MAPPINGTABLE=mstrmojo.Refine.RefineDataHeader;var menuHelper=$MAPPINGTABLE.menuHelper=$MAPPINGTABLE.menuHelper||new mstrmojo.Refine.RefineMenu();menuHelper.target=src;menuHelper.data=[src.data];menuHelper.type=ITEM_MENU;var cfg=menuHelper.getMenuConfig();cfg.hostId=src.id;cfg.hostElement=this.domNode;cfg.isHostedWithin=false;cfg.position=_D.position(this.domNode,true);src.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));},bindings:{visible:function(){return(!this.parent.suggestionPreview);}}}]});}());