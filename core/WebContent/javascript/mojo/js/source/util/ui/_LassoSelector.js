(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css");var $M=Math,$DOM=mstrmojo.dom,$CSS=mstrmojo.css,CSS_ACTIVE="active",CSS_READY="ready",BOX_SIZE=6,MIN_LASSO_SIZE=10,THRESHOLD=10,CONTROL_TYPE={LASSO_SELECTOR:"lasso-selector",LASSO_RESIZER:"lasso-resizer",BUTTON:"button"};mstrmojo.util.ui.LassoSelectorParamsType=null;function getEventHandler(fn,scopeId,params){return function(evt){fn.call(mstrmojo.all[scopeId],evt,params);};}function onClick(evt){var win=evt.view,target=$DOM.eventTarget(window,evt),selector=this.lassoSelector;if(this.clickFromLassoResizer||(target!==selector&&this.clickFromCreatingLasso)){$DOM.stopPropogation(win,evt);$DOM.preventDefault(win,evt);}delete this.clickFromLassoResizer;delete this.clickFromCreatingLasso;}function onMouseMove(evt,params){var width,height,left,top,x=evt.clientX,y=evt.clientY,selector=this.lassoSelector,startX=params.startX,startY=params.startY,containerPos=params.containerPos,endX=x-containerPos.x,endY=y-containerPos.y;endX=$M.min(endX,params.maxX);endX=$M.max(endX,params.minX);endY=$M.min(endY,params.maxY);endY=$M.max(endY,params.minY);width=$M.abs(endX-startX);height=$M.abs(endY-startY);top=$M.min(startY,endY);left=$M.min(startX,endX);selector.style.width=width+"px";selector.style.height=height+"px";selector.style.left=left+"px";selector.style.top=top+"px";params.width=width;params.height=height;params.left=left;params.top=top;if(width<=THRESHOLD&&height<=THRESHOLD){selector.style.visibility="hidden";$CSS.removeClass(selector,CSS_ACTIVE);}else{selector.style.visibility="visible";$CSS.addClass(selector,CSS_ACTIVE);document.body.style.cursor="crosshair";}}function onMouseUp(evt,params){var doc=window.document,selector=this.lassoSelector,width=params.width,height=params.height;$DOM.detachEvent(doc,"mousemove",params.fnMove);$DOM.detachEvent(doc,"mouseup",params.fnUp);delete params.fnMove;delete params.fnUp;document.body.style.cursor="default";if(!width||width===0||!height||height===0){this.dismissLassoSelector();}else{params.ctrlKey=evt.ctrlKey;this.lassoSelected(params);this.clickFromCreatingLasso=true;$CSS.addClass(selector,CSS_READY);this.positionBoxResizers();}}function onMouseDown(evt){var i,win=evt.view,startX,startY,target=$DOM.eventTarget(window,evt),targetType=target.getAttribute("type"),selector=this.lassoSelector,container=this.lassoContainer,excludeAttrArr=this.excludeAttrArr,n=excludeAttrArr.length,containerPos,params={};delete this.clickFromLassoResizer;delete this.clickFromCreatingLasso;if(!selector||!container||!this.lassoSelectorEnabled){return ;}if($DOM.contains(this.dropDownBtn,target,true)){return ;}for(i=0;i<n;i++){if(targetType===excludeAttrArr[i]){return ;}}this.lassoSelecting();containerPos=$DOM.position(container);startX=evt.clientX-containerPos.x;startY=evt.clientY-containerPos.y;params.containerPos=containerPos;params.maxX=containerPos.w;params.maxY=containerPos.h;params.startX=startX;params.startY=startY;params.minX=0;params.minY=0;params.info=this.getLassoSelectionInfo(target);params.useAsSelectorOrBrushes=this.useAsSelectorOrBrushes||((this.hasAssociatedNodes&&this.hasAssociatedNodes())||this.selectorControl);selector.style.visibility="hidden";selector.style.left=startX+"px";selector.style.top=startY+"px";selector.style.width="0px";selector.style.height="0px";$CSS.removeClass(selector,CSS_READY);container.appendChild(selector);var id=this.id,doc=document,fnMove=getEventHandler(onMouseMove,id,params),fnUp=getEventHandler(onMouseUp,id,params);$DOM.attachEvent(doc,"mousemove",fnMove);$DOM.attachEvent(doc,"mouseup",fnUp);params.fnMove=fnMove;params.fnUp=fnUp;$DOM.stopPropogation(win,evt);$DOM.preventDefault(win,evt);}function onBoxMouseMove(evt,params){var index=params.index,startX=params.startX,startY=params.startY,containerPos=params.containerPos,endX=evt.clientX-containerPos.x,endY=evt.clientY-containerPos.y,selector=this.lassoSelector;endX=$M.min(endX,params.maxX);endX=$M.max(endX,params.minX);endY=$M.min(endY,params.maxY);endY=$M.max(endY,params.minY);var deltaWidth=endX-startX,deltaHeight=endY-startY;if(index%3===1){deltaWidth=0;}if(index===3||index===5){deltaHeight=0;}var width=params.selWidth,height=params.selHeight,left=params.selLeft,top=params.selTop;if(deltaWidth!==0){if(index%3===0){left+=deltaWidth;width-=deltaWidth;}else{width+=deltaWidth;}}if(deltaHeight!==0){if(index<3){top+=deltaHeight;height-=deltaHeight;}else{height+=deltaHeight;}}selector.style.width=width+"px";selector.style.left=left+"px";selector.style.top=top+"px";selector.style.height=height+"px";params.width=width;params.left=left;params.height=height;params.top=top;this.positionBoxResizers();}function onBoxMouseUp(evt,params){var win=evt.view,doc=window.document;$DOM.detachEvent(doc,"mousemove",params.fnMove);$DOM.detachEvent(doc,"mouseup",params.fnUp);delete params.fnMove;delete params.fnUp;this.clickFromLassoResizer=true;$DOM.stopPropogation(win,evt);$DOM.preventDefault(win,evt);this.lassoSelectorResized(params);}function onBoxMouseDown(evt){var win=evt.view,target=$DOM.eventTarget(window,evt),index=parseInt(target.getAttribute("index"),10),selector=this.lassoSelector,selX1=selector.offsetLeft,selY1=selector.offsetTop,selX2=selX1+selector.offsetWidth,selY2=selY1+selector.offsetHeight,containerPos=$DOM.position(this.lassoContainer),minX=0,minY=0,maxX=containerPos.w,maxY=containerPos.h,params={};if(index%3===0){maxX=selX2-MIN_LASSO_SIZE;}if(index%3===2){minX=selX1+MIN_LASSO_SIZE;}if(index<3){maxY=selY2-MIN_LASSO_SIZE;}if(index>=6){minY=selY1+MIN_LASSO_SIZE;}params.minX=minX;params.minY=minY;params.maxX=maxX;params.maxY=maxY;params.startX=evt.clientX-containerPos.x;params.startY=evt.clientY-containerPos.y;params.index=index;params.containerPos=containerPos;params.selWidth=selector.clientWidth;params.selHeight=selector.clientHeight;params.selLeft=selector.offsetLeft;params.selTop=selector.offsetTop;var id=this.id,doc=document,fnMove=getEventHandler(onBoxMouseMove,id,params),fnUp=getEventHandler(onBoxMouseUp,id,params);$DOM.attachEvent(doc,"mousemove",fnMove);$DOM.attachEvent(doc,"mouseup",fnUp);params.fnMove=fnMove;params.fnUp=fnUp;$DOM.stopPropogation(win,evt);$DOM.preventDefault(win,evt);}mstrmojo.util.ui._LassoSelector=mstrmojo.provide("mstrmojo.util.ui._LassoSelector",{_mixinName:"mstrmojo.util.ui._LassoSelector",lassoContainer:undefined,lassoSelector:undefined,lassoSelectorEnabled:true,excludeAttrArr:null,boxResizers:null,useDropDownBtn:false,dropDownBtn:undefined,init:function(props){if(this._super){this._super(props);}this.excludeAttrArr=[];this.boxResizers=[];},registerLassoSelector:function(container,excludeAttrArr,useDropDownBtn){excludeAttrArr=excludeAttrArr||[];excludeAttrArr.push(CONTROL_TYPE.LASSO_SELECTOR);excludeAttrArr.push(CONTROL_TYPE.LASSO_RESIZER);excludeAttrArr.push(CONTROL_TYPE.BUTTON);this.lassoContainer=container;this.excludeAttrArr=excludeAttrArr;this.useDropDownBtn=useDropDownBtn||false;$DOM.attachEvent(container,"mousedown",getEventHandler(onMouseDown,this.id));$DOM.attachEvent(container,"click",getEventHandler(onClick,this.id));var selector=this.lassoSelector;if(!selector){selector=this.createLassoSelector();this.lassoSelector=selector;}var parent=selector.parentNode;if(parent){parent.removeChild(selector);}},createLassoSelector:function(){var i,boxDiv,btnDiv,boxes=this.boxResizers,selector=document.createElement("div");selector.setAttribute("class","lasso-selector");selector.setAttribute("type",CONTROL_TYPE.LASSO_SELECTOR);selector.setAttribute("draggable",false);selector.draggable=false;for(i=0;i<9;i++){if(i!==4){boxDiv=document.createElement("div");boxDiv.setAttribute("class","lasso-selector-resizer");boxDiv.setAttribute("type",CONTROL_TYPE.LASSO_RESIZER);boxDiv.setAttribute("index",String(i));boxDiv.setAttribute("draggable",false);boxDiv.draggable=false;selector.appendChild(boxDiv);boxes[i]=boxDiv;$DOM.attachEvent(boxDiv,"mousedown",getEventHandler(onBoxMouseDown,this.id));}}$CSS.addClass(boxes[0],["top","left"]);$CSS.addClass(boxes[1],["top"]);$CSS.addClass(boxes[2],["top","right"]);$CSS.addClass(boxes[3],["left"]);$CSS.addClass(boxes[5],["right"]);$CSS.addClass(boxes[6],["bottom","left"]);$CSS.addClass(boxes[7],["bottom"]);$CSS.addClass(boxes[8],["bottom","right"]);if(this.useDropDownBtn===true){btnDiv=document.createElement("div");btnDiv.setAttribute("type",CONTROL_TYPE.BUTTON);btnDiv.setAttribute("class","lasso-selector-dropdown-button");selector.appendChild(btnDiv);$DOM.attachEvent(btnDiv,"click",getEventHandler(this.lassoButtonClicked,this.id));this.dropDownBtn=btnDiv;}return selector;},positionBoxResizers:function(){var boxes=this.boxResizers,selector=this.lassoSelector,width=selector.clientWidth,height=selector.clientHeight,centerX=(width-BOX_SIZE)>>1,centerY=(height-BOX_SIZE)>>1;boxes[1].style.left=centerX+"px";boxes[3].style.top=centerY+"px";boxes[5].style.top=centerY+"px";boxes[7].style.left=centerX+"px";},dismissLassoSelector:function(){var selector=this.lassoSelector;if(selector){$CSS.removeClass(selector,[CSS_ACTIVE,CSS_READY]);if(selector.parentNode){selector.parentNode.removeChild(selector);}}},isLassoSelectorActive:function(){function hasClass(node,className){var names=node.className.split(/\s+/),i;for(i=0;i<names.length;i++){if(names[i]===className){return true;}}return false;}var selector=this.lassoSelector;if(selector){return hasClass(selector,CSS_ACTIVE);}return false;},getLassoSelectionInfo:mstrmojo.emptyFn,lassoSelected:mstrmojo.emptyFn,lassoSelecting:mstrmojo.emptyFn,lassoButtonClicked:mstrmojo.emptyFn,lassoSelectorResized:mstrmojo.emptyFn});}());