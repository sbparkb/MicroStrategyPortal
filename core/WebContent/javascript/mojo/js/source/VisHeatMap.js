(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.dom","mstrmojo.VisHeatMapColorTheme","mstrmojo.VisHeatMapPopup","mstrmojo.VisHeatMapTree","mstrmojo._TouchGestures","mstrmojo._HasTouchScroller","mstrmojo.num","mstrmojo._HasWaitIcon","mstrmojo.EnumReadystate","mstrmojo.css","mstrmojo.VisHeatMapCanvas","mstrmojo.VisUtility");var $U=mstrmojo.VisUtility;var $READYSTATE=mstrmojo.EnumReadystate;var DRILLING_ACTION=1,SELECTOR_ACTION=2,HYPERLINK_ACTION=4,INFOWINDOW_ACTION=4;var $CSS=mstrmojo.css,cssShow="heatmap-show";var LabelSize={On:0,Off:1,Proportional:2};var AggregationType={Sum:0,Avg:1,Cnt:2,Max:3,Min:4,GeoAvg:5};var BandDirection={LeftToRight:0,RightToLeft:1,Center:2,None:3};var LayoutAlgorithm={Squarified:0,PivotByMiddle:1,SliceAndDice:2};var LayoutProperties={Padding:6,MaxLegendHeight:60,LegendMenuEditorWidth:70,LegendTickCount:5,LegendMinWidth:15,LegendTickLength:4,LegendMaxBandWidth:400,LegendWidthPercent:0.9,LegendMinPadding:15,LegendBottomPadding:3,LegendGutter:5,LegendBandAspect:10,MinShowLabelDimension:6,DeletedListHeight:500,EditorDialogWidth:565,EditorDialogHeight:574,EditButtonWidth:60,EditButtonHeight:40,EditButtonRight:10,WaitIconWidth:205,WaitIconHeight:105,WaitIconMargin:10,WaitIconFontSize:20};var Spec={heatmap_popup_panel_title:{font_size:{value:18,unit:"pt"}},heatmap_gray_label:{padding_bottom:{value:7,unit:"px"},font_size:{value:10,unit:"pt"},height:{value:32,unit:"px"},padding_left:{value:22,unit:"px"}},heatmap_tree_button:{font_size:{value:12,unit:"pt"}},heatmap_one_level_1:{font_size:{value:14,unit:"pt"}},heatmap_multi_level_1:{font_size:{value:24,unit:"pt"}},heatmap_two_level_2:{font_size:{value:14,unit:"pt"}},heatmap_multi_level_2:{font_size:{value:20,unit:"pt"}},heatmap_multi_level_3:{font_size:{value:10,unit:"pt"}},heatmap_size_legend:{font_size:{value:12,unit:"pt"}},heatmap_color_legend:{font_size:{value:12,unit:"pt"}},heatmap_color_legend_label:{font_size:{value:12,unit:"pt"}},heatmap_color_legend_tooltip:{font_size:{value:12,unit:"pt"}},heatmap_color_legend:{font_size:{value:12,unit:"pt"}},heatmap_editor_button:{font_size:{value:12,unit:"pt"}},heatmap_tooltip_gray_bold:{font_size:{value:14,unit:"pt"}},heatmap_tooltip_gray:{font_size:{value:14,unit:"pt"}},heatmap_tooltip_black_bold:{font_size:{value:14,unit:"pt"}},heatmap_tooltip_black:{font_size:{value:14,unit:"pt"}},heatmap_tree_div:{font_size:{value:18,unit:"pt"}},heatmap_tree_root__heatmap_tree_div:{font_size:{value:14,unit:"pt"}}};var Fake_Metric_ID="--";var Background_Color=16119287;var EID_SELECTALL="OA:(All)";function adjustPixel(px,forceFix){var DPIX=149,base=160;if(forceFix){base=149;}if(this.enableMultiDPI||forceFix){DPIX=this.DPIX;}return parseInt(px*(DPIX/base));}function getCSSColor(rgb){var c=16777216+rgb;var str="#"+c.toString(16).substring(1).toUpperCase();return str;}function roundNumber(n,l){return Math.round(n*Math.pow(10,l))/Math.pow(10,l);}function createPath(x,y,w,h,r,ctx){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r-1,y);ctx.quadraticCurveTo(x+w-1,y,x+w-1,y+r);ctx.lineTo(x+w-1,y+h-r-1);ctx.quadraticCurveTo(x+w-1,y+h-1,x+w-r-1,y+h-1);ctx.lineTo(x+r,y+h-1);ctx.quadraticCurveTo(x,y+h-1,x,y+h-r-1);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}function updateEntityAggValue(ev,rawValue,needsCopy){if(needsCopy&&ev.total===undefined){ev.avgTotal=ev.total=ev.geomProduct=ev.max=ev.min=ev.value;ev.count=isNaN(ev.value)?0:1;ev.positiveCount=ev.value>0?1:0;}ev.value=rawValue;ev.allChildrenCount++;if(!isNaN(rawValue)){if(isNaN(ev.total)){ev.total=rawValue;}else{ev.total+=rawValue;}if(isNaN(ev.avgTotal)){ev.avgTotal=rawValue;}else{ev.avgTotal+=rawValue;}if(isNaN(ev.max)){ev.max=rawValue;}else{ev.max=Math.max(ev.max,rawValue);}if(isNaN(ev.min)){ev.min=rawValue;}else{ev.min=Math.min(ev.min,rawValue);}if(isNaN(ev.geomProduct)){if(rawValue>0){ev.geomProduct=rawValue;ev.positiveCount++;}}else{if(rawValue>0){ev.geomProduct*=rawValue;ev.positiveCount++;}}ev.count++;}}function updateEntityContainerAggValue(ev,oldev){var rawValue=oldev.total;if(!isNaN(rawValue)){if(isNaN(ev.total)){ev.total=rawValue;}else{ev.total+=rawValue;}ev.count++;}rawValue=oldev.avg;if(!isNaN(rawValue)){if(isNaN(ev.avgTotal)){ev.avgTotal=rawValue;}else{ev.avgTotal+=rawValue;}}rawValue=oldev.max;if(!isNaN(rawValue)){if(isNaN(ev.max)){ev.max=rawValue;}else{ev.max=Math.max(ev.max,rawValue);}}rawValue=oldev.min;if(!isNaN(rawValue)){if(isNaN(ev.min)){ev.min=rawValue;}else{ev.min=Math.min(ev.min,rawValue);}}rawValue=oldev.geomAvg;if(!isNaN(rawValue)){if(isNaN(ev.geomProduct)){if(rawValue>0){ev.geomProduct=rawValue;ev.positiveCount++;}}else{if(rawValue>0){ev.geomProduct*=rawValue;ev.positiveCount++;}}}}function decodeXML(s){return s.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');}var delStatus={dftUnDel:0,dftDel:1,usrDel:2};function parseDeletedList(s){var oParser=new DOMParser(),oDOM=oParser.parseFromString(decodeXML(s),"text/xml"),i=0,ce=oDOM.childNodes[0],l=oDOM.childNodes[0].childElementCount;if(l==0){return{};}var cr=ce.firstElementChild,at=cr.attributes,al=at.length,ret=this.props.deletedList||{},dict=ret,key;while(i<l){dict=ret;at=cr.attributes;for(var j=0;j<al;j++){key=at[j].value;if(j===(al-1)){dict[key]=delStatus.dftDel;}else{if(!dict[key]){dict[key]={};}dict=dict[key];}}i++;cr=cr.nextElementSibling;}return ret;}function loadSession(){var props=this.props,session=this.controller.view.model.session;if(session){if(session.db!==undefined){props.delButtonEnabled=session.db;}if(session.dl!==undefined){props.deletedList=mergeDeletedList(props.deletedList,session.dl);}if(isNaN(session.navigatingIndex)){props.navigatingIndex=session.navigatingIndex;}if(session.entitiesWithStates){var es=session.entitiesWithStates;this.entitiesWithStates={};var entities=this.entitiesWithStates;for(var key in es){entities[key]=[];var ee=es[key]||[],len=ee.length,i;for(i=0;i<len;i++){var e=ee[i];var entity=lookUpEntityDic.call(this,e.pathName);entity.isExpanded=e.isExpanded;entity.isSelected=e.isSelected;entities[key].push(entity);}}}if(session.dialogScrollerPosition){this.dialogScrollerPosition=session.dialogScrollerPosition;}this.isUsingSavedColorTheme=session.isUsingSavedColorTheme;this.isUsingDefaultColorTheme=session.isUsingDefaultColorTheme;}function lookUpEntityDic(sd){var root=this.root;for(var i=0,len=sd.length;i<len;i++){var children=root.entityChildren;for(var j=0,l=children.length;j<l;j++){var ret=null;if(this.getEntityDisplayName(children[j])===sd[i]){ret=children[j];root=ret;break;}}}return ret;}function mergeDeletedList(d1,d2){function merge(a,b){var keys=Object.keys(b),len=keys.length;for(var i=0;i<len;i++){var key=keys[i];if(typeof b[key]!=="object"){a[key]=b[key];}else{if(a[key]===undefined){a[key]={};}merge(a[key],b[key]);}}}var ret={};merge(ret,d1);merge(ret,d2);return ret;}}function storeSession(){var cvm=this.controller.view.model,session={},props=this.props;cvm.session=session;if(props.delButtonEnabled!==undefined){session.db=props.delButtonEnabled;}if(props.deletedList!==undefined){session.dl=props.deletedList;}if(isNaN(this.props.navigatingIndex)){session.navigatingIndex=props.navigatingIndex;}if(this.entitiesWithStates){var es=this.entitiesWithStates;var entities={};session.entitiesWithStates=entities;for(var key in es){entities[key]=[];var ee=es[key]||[],len=ee.length,i;for(i=0;i<len;i++){var entity=ee[i],e={};e.pathName=generateEntityDic.call(this,entity);e.isExpanded=entity.isExpanded;e.isSelected=entity.isSelected;entities[key].push(e);}}}if(this.dialogScrollerPosition){session.dialogScrollerPosition=this.dialogScrollerPosition;}session.isUsingSavedColorTheme=this.isUsingSavedColorTheme;session.isUsingDefaultColorTheme=this.isUsingDefaultColorTheme;function generateEntityDic(entity){var sd=[];while(entity.parentEntity){sd.push(this.getEntityDisplayName(entity));entity=entity.parentEntity;}return sd;}}function loadProps(){this.props={};var props=this.props,m=this.model,propValue=m.vp?m.vp:{},temp;props.deletedList={};props.delButtonEnabled=false;props.showMetricValues=false;props.refreshType=0;props.labelSize=LabelSize.On;props.showLegend=true;props.sizeMetricEnabled=true;props.colorMetricEnabled=true;props.layout=LayoutAlgorithm.Squarified;props.legendAsc=true;var w=mstrmojo.VisHeatMapColorTheme.newInstance();w.initialize();this.colorTheme=w;if(propValue.dl){props.deletedList=parseDeletedList.call(this,propValue.dl);}if(propValue.ed){props.delButtonEnabled=(propValue.ed=="true"?true:false);}if(propValue.mv){props.showMetricValues=(propValue.mv=="true"?true:false);}if(propValue.rt!=""){props.refreshType=parseInt(propValue.rt);}if(propValue.ml){temp=propValue.ml.split(",");if(temp.length>=2){props.sizeMetricID=temp[0];props.colorMetricID=temp[1];}}if(propValue.lb){temp=propValue.lb;if(temp=="Off"){props.labelSize=LabelSize.Off;}else{if(temp=="Proportional"){props.labelSize=LabelSize.Proportional;}}}if(propValue.lg){props.showLegend=(propValue.lg=="true"?true:false);}if(propValue.rlp=="false"&&propValue.abs){w.convertAbsoluteToBlend(this,propValue);}if(propValue.blc){w.isBlend=(propValue.blc=="true"?true:false);}if(propValue.gradientColors&&propValue.bandColors){w.createDataProviderFromString(propValue.gradientColors,propValue.bandColors);}if(propValue.la){props.layout=parseInt(propValue.la,10);}if(propValue.rlp=="false"&&propValue.abs){this.colorTheme.convertAbsoluteToBlend(this,propValue);this.colorTheme.createDataProviderFromString(propValue.gradientColors,propValue.bandColors);}}function setLayout(){var widgetWidth=parseInt(this.width,10),widgetHeight=parseInt(this.height,10),heatMapWidth=widgetWidth-2*this.LayoutProperties.Padding,legendHeight=0,heatMapHeight;if(this.model.gvs.items.length<=0){this.props.showLegend=false;}if(this.props.showLegend){legendHeight=Math.min(Math.floor(0.2*(widgetHeight-2*this.LayoutProperties.Padding)),this.LayoutProperties.MaxLegendHeight);heatMapHeight=widgetHeight-legendHeight-3*this.LayoutProperties.Padding;}else{heatMapHeight=widgetHeight-2*this.LayoutProperties.Padding;}this.heatMapSize={x:0,y:0,w:heatMapWidth,h:heatMapHeight};this.legendSize={x:0,y:widgetHeight-2*this.LayoutProperties.Padding-legendHeight,w:widgetWidth,h:legendHeight};this.infoWindowSize={maxWidth:parseInt(this.width)-60,maxHeight:parseInt(this.height)-60};this.maxScale=10;}function resetMetricIndices(){var m=this.model,l=m.ghs.chs.items[0]?m.ghs.chs.items[0].items.length:0,sid=this.props.sizeMetricID,cid=this.props.colorMetricID,a=[];this.metricArray=a;for(var i=0;i<l;i++){a.push(getMetricID.call(this,i));}a.push(Fake_Metric_ID);l++;this.sizeMetricIndex=0;this.colorMetricIndex=l>2?1:0;for(var i=0;i<l;i++){if(sid==a[i]){this.sizeMetricIndex=i;}if(cid==a[i]){this.colorMetricIndex=i;}}if(sid===undefined){sid=a[this.sizeMetricIndex];this.props.sizeMetricID=sid;}if(cid===undefined){cid=a[this.colorMetricIndex];this.props.colorMetricID=cid;}var gvs=m.gvs&&m.gvs.items,lgvs=gvs&&gvs.length,i,sidx=this.sizeMetricIndex,cidx=this.colorMetricIndex;this.sizeByMetricMissing=true;this.colorByMetricMissing=true;for(i=0;i<lgvs;i++){var values=gvs[i]&&gvs[i].items;if(values[sidx]===undefined||values[sidx].rv!==""){this.sizeByMetricMissing=false;break;}}for(i=0;i<lgvs;i++){var values=gvs[i]&&gvs[i].items;if(values[cidx]===undefined||values[cidx].rv!==""){this.colorByMetricMissing=false;break;}}if(this.sizeByMetricMissing){this.props.sizeMetricEnabled=false;this.sizeMetricIndex=a.length-1;this.props.sizeMetricID=a[this.sizeMetricIndex];}if(this.colorByMetricMissing){this.props.colorMetricEnabled=false;}if(this.props.sizeMetricID===Fake_Metric_ID){this.props.sizeMetricEnabled=false;}if(this.props.colorMetricID===Fake_Metric_ID){this.props.colorMetricEnabled=false;this.colorTheme.hasNoColorMetric=true;}if(this.props.sizeMetricEnabled==false&&this.props.colorMetricEnabled==false){this.props.showLegend=false;}}function loadMetricsInfo(){this.aggFunctions=[];var props=this.props,cid=props.colorMetricID,af=this.aggFunctions,m=this.model,propValue=m.vp?m.vp:{},ar=this.metricArray,l=ar.length-1;if(cid!=Fake_Metric_ID){var mlEnabled=(propValue["mle"+cid]=="true")?true:false;if(mlEnabled){var val=parseFloat(propValue["mlma"+cid]);if(!isNaN(val)){this.mlmax=val;}val=parseFloat(propValue["mlmi"+cid]);if(!isNaN(val)){this.mlmin=val;}}}for(var i=0;i<l;i++){var id="agf"+ar[i];if(propValue[id]!==undefined){af.push(parseInt(propValue[id]));}else{af.push(AggregationType.Sum);}}}function totalRow(row){for(var i=0;i<row.length;i++){var obj=row[i].etk;if(obj==-1||obj=="-1"){return true;}}return false;}function convertDataToModels(){resetMetricIndices.call(this);loadMetricsInfo.call(this);var m=this.model,deletedList=this.props.deletedList,att=m.gts&&m.gts.row||[],atl=att.length,mv=m.gvs&&m.gvs.items||[],rhs=m.ghs&&m.ghs.rhs&&m.ghs.rhs.items||[],rl=rhs.length,ml=mv[0]&&mv[0].items&&mv[0].items.length||0;if(atl<=0){var errmsg="The Heat Map requires at least one attribute on row axis to render properly; it is recommended that two metrics be placed on the column axis as well.";m.err=mstrmojo.desc(11147,errmsg);return ;}this.singleSelection=false;this.hasNegativeSizeValue=false;this.levelAttributes=[];this.root={aggValues:[],entityChildren:[],level:0};for(var i=0;i<atl;i++){this.levelAttributes[i]={index:i,order:i+1,isInLOA:i+1>0?true:false};}var hashDict={},attSpan=[];for(var i=0;i<atl;i++){var o=att[i].fs;attSpan[i]=Math.max(1,o?o.length:1);}this.attSpan=attSpan;var longestSelectedLength=0,longestSelectedElementsEntity;for(var i=0;i<rl;i++){var rowHeaderData=rhs[i].items,k;if(totalRow(rowHeaderData)){continue;}var levelID="",delDict=deletedList,parent=this.root,cur=0,entity,str,selectedLength=0;for(var j=0;j<atl;j++){var index;str="";for(var k=0;k<attSpan[j];k++,cur++){index=rowHeaderData[cur].idx;if(index==-1){continue;}str+=att[j].es[index].n+" ";if(k==0){levelID+=index;}}str=str.substring(0,str.length-1);if(delDict){delDict=delDict[decodeXML(str)];}if(j!=atl-1){if(hashDict[levelID]!==undefined){parent=hashDict[levelID];}else{var entityContainer={aggValues:[],entityChildren:[],parentEntity:parent};var childrenArray=parent.entityChildren;childrenArray.push(entityContainer);hashDict[levelID]=entityContainer;parent=entityContainer;entityContainer.deleted=false;entityContainer.text=str;entityContainer.label=str;entityContainer.level=j;entityContainer.index=i;}levelID+=":";}else{if(hashDict[levelID]!==undefined){entity=hashDict[levelID];var indice=entity.indices;indice.push(i);for(var k=0;k<ml+1;k++){var ev=entity.aggValues[k];var rawValue;if(k==ml){rawValue=1;}else{rawValue=mv[i].items[k].rv;}updateEntityAggValue(ev,parseFloat(rawValue),true);if(!isNaN(rawValue)){this.aggregated=true;}}}else{entity={indices:[],aggValues:[],parentEntity:parent};var indice=entity.indices;indice.push(i);var aggValues=entity.aggValues;for(var k=0;k<ml+1;k++){var ev={};aggValues[k]=ev;var rawValue;if(k==ml){rawValue=1;}else{rawValue=mv[i].items[k].rv;}ev.value=parseFloat(rawValue);ev.allChildrenCount=1;}this.aggregated=false;if(delDict){entity.deleted=true;this.colorTheme.useDefault=false;}var childrenArray=parent.entityChildren;childrenArray.push(entity);entity.level=atl-1;entity.text=str;entity.label=str;hashDict[levelID]=entity;}}if(rowHeaderData[j].cet!=undefined){selectedLength++;if(selectedLength>longestSelectedLength){longestSelectedLength=selectedLength;longestSelectedElementsEntity=hashDict[levelID];}}}}this.previousSelected=longestSelectedElementsEntity;checkSelector.call(this);checkLinkDrill.call(this);}function clearMaxMinValues(){this.cmax=NaN;this.cmin=NaN;this.smax=NaN;this.smin=NaN;}function checkLinkDrill(){this.hasLinkDrill=false;var rowHeader=this.model.gts.row,rl=rowHeader.length;for(var i=0;i<rl;i++){var attr=rowHeader[i];if(attr.lm){for(var j=0;j<attr.lm.length;j++){if(attr.lm[j].links){break;}}if(j!=attr.lm.length){this.hasLinkDrill=true;this.firstRowLinkDrillIndex=i;break;}}}var metricH=this.model.gts.col[0];if(!metricH){return ;}var metricHL=metricH.es.length;for(var i=0;i<metricHL;i++){var metric=metricH.es[i],lm=metricH.lm[i];if(lm&&lm.links){this.hasLinkDrill=true;this.firstColLinkDrillIndex=i;break;}}}function checkSelector(){this.hasSelector=false;var m=this.model,rown=m.gts.row,rl=rown.length;var xtabModel=this.xtabModel,docModel=(xtabModel&&xtabModel.docModel),layouts=(docModel&&docModel.defn&&docModel.defn.layouts),currentLayout;for(var i=0;layouts&&i<layouts.length;i++){if(layouts[i].loaded==true){currentLayout=layouts[i];break;}}var units=(currentLayout&&currentLayout.units);for(var i=0;i<rl;i++){var att=rown[i];if(att.otp!=-1&&att.sc!==undefined){this.hasSelector=true;var targets=att.sc.tks;if(typeof targets!="string"){continue;}targets=targets.split("\x1E");var len=targets.length;this.hasGridTarget=false;for(var j=0;j<len;j++){if(targets[j]==""){continue;}targetName=targets[j];if(units&&units[targetName]&&!units[targetName]["ifw"]){this.hasGridTarget=true;return ;}}}}}function layoutEntities(){var width=this.width-2*this.LayoutProperties.Padding;var legendHeight=0;if(this.props.showLegend){legendHeight=Math.min(Math.floor(0.2*(parseInt(this.height)-2*this.LayoutProperties.Padding)),this.LayoutProperties.MaxLegendHeight);}var hm=this,area=copyRect(this.heatMapSize);area.w*=this.scaleFactor;area.h*=this.scaleFactor;var min=Math.min(area.w,area.h);var ch=this.root.entityChildren;switch(this.props.layout){case LayoutAlgorithm.Squarified:var arr=ch.slice(0);arr.sort(function sortEntity(s,t){var vs=getSizeValue(s,hm);var vt=getSizeValue(t,hm);if(isNaN(vs)){if(isNaN(vt)){return 0;}return 1;}else{if(isNaN(vt)){return -1;}return vs<vt?1:-1;}return 0;});squarify.call(this,arr,{r:[]},min,area);break;case LayoutAlgorithm.SliceAndDice:sliceAndDice.call(this,ch,area);break;case LayoutAlgorithm.PivotByMiddle:var arr=getVisibleEntities.call(this,ch),l=arr.length;if(l>0){pivotByMiddle.call(this,arr,0,l-1,area);}break;}}function squarify(t,r,m,c,a){var params=[[this,t,r,m,c,a]];while(params.length){var param=params.pop();var _this=param[0];t=param[1];r=param[2];m=param[3];c=param[4];a=param[5];var newRow=false;if(t.length==0){setLayoutOrder.call(_this,r,c);}else{var area=c.w*c.h;var cwa;if(a!==undefined){cwa=a;}else{cwa=worstAspect.call(_this,r,m,area);}var data=t[0],arr=r.r;arr.push(data);var fwa=worstAspect.call(_this,r,m,area);if(cwa>=fwa||cwa==-1){t.shift();params.push([_this,t,r,m,c,fwa]);}else{r.r.pop();setLayoutOrder.call(_this,r,c);m=Math.min(c.w,c.h);if(r.t===undefined){params.push([_this,t,{r:[]},m,c]);}else{params.push([_this,t,{r:[],t:r.t},m,c]);}}}}}function getTextStyle(l,w){var fs,css,len=w.levelAttributes.length;if(len==1){if(l==0){css="heatmap-one-level-1";fs=this.Spec.heatmap_one_level_1.font_size.value;}}else{if(len==2){if(l==0){css="heatmap-multi-level-1";fs=this.Spec.heatmap_multi_level_1.font_size.value;}else{if(l==1){css="heatmap-two-level-2";fs=this.Spec.heatmap_two_level_2.font_size.value;}}}else{if(len>=3){if(l==0){css="heatmap-multi-level-1";fs=this.Spec.heatmap_multi_level_1.font_size.value;}else{if(l==1){css="heatmap-multi-level-2";fs=this.Spec.heatmap_multi_level_2.font_size.value;}else{css="heatmap-multi-level-3";fs=this.Spec.heatmap_multi_level_3.font_size.value;}}}}}return{css:css,size:fs};}function getRectangleGap(e){var getGapPixel=function(){var te=e,level=e.level,l=this.levelAttributes.length;if(l==1){return 1;}if(l==2){if(level==0){return 3;}return 1;}if(l==3){if(level==0){return 6;}if(level==1){return 3;}return 1;}else{if(level==0){return 8;}if(level==1){return 4;}if(level==2){return 2;}return 1;}};var ret,gap=getGapPixel.call(this);if(this.DPI>160){ret=adjustPixel.call(this,gap);}else{ret=gap;}if(ret<=0){ret=1;}return ret;}function rectIsValid(a){return a.w>0&&a.h>0;}function rectIntersection(a,b){var x=Math.max(a.x,b.x);var y=Math.max(a.y,b.y);var w=Math.min(a.x+a.w,b.x+b.w)-x;var h=Math.min(a.y+a.h,b.y+b.h)-y;if(w<0||h<0){return{x:NaN,y:NaN,w:NaN,h:NaN};}return{x:x,y:y,w:w,h:h};}function rectIsEqual(a,b){if(a.x==b.x&&a.y==b.y&&a.w==b.w&&a.h==b.h){return true;}else{return false;}}function rectCanEncircle(a,b){var c=rectIntersection(a,b);return rectIsEqual(c,b);}function rectPutAside(a,b,c){var p=[{x:b.x-a.w,y:b.y+b.h/2-a.h/2,w:a.w,h:a.h},{x:b.x+b.w,y:b.y+b.h/2-a.h/2,w:a.w,h:a.h},{x:b.x+b.w/2-a.w/2,y:b.y-a.h,w:a.w,h:a.h},{x:b.x+b.w/2-a.w/2,y:b.y+b.h,w:a.w,h:a.h}];for(var i=0;i<4;i++){if(rectCanEncircle(c,p[i])){return{rect:p[i],index:i};}}}function swapRect(a){var temp=a.x;a.x=a.y;a.y=temp;temp=a.w;a.w=a.h;a.h=temp;return a;}function copyRect(a){var b={};b.x=a.x;b.y=a.y;b.w=a.w;b.h=a.h;return b;}function worstAspect(r,m,a){var worst,arr=r.r,l=arr.length;if(l>0&&a>0){var e=arr[0];var pval=getSizeValue(e.parentEntity,this);if(isNaN(pval)||pval<=0){return -1;}var min,max,sum=0,val,e,inited=false;for(var i=0;i<l;i++){e=arr[i];if(!e.deleted){val=getSizeValue(e,this);if(!isNaN(val)){if(inited==false){max=min=val;inited=true;}else{max=Math.max(val,max);min=Math.min(val,min);}sum+=val;}}}var suba=a*sum/pval,otherMin=suba/m,newMin=(m<otherMin)?m:otherMin;max=a*max/pval;min=a*min/pval;var e1=max/(newMin*newMin);var e2=min/(newMin*newMin);e1=(e1>1)?e1:(1/e1);e2=(e2>1)?e2:(1/e2);worst=Math.max(e1,e2);}else{worst=-1;}return worst;}function layoutRow(r,c,n,sum,swapped){var width,height,ch=r.r,l=ch.length,w,h,tmpc,localSwapped=false;if(l==0){return ;}if(n<c.h){w=n;h=c.h;tmpc=c;}else{w=c.h;h=n;var tmpc=copyRect(c);swapRect(tmpc);localSwapped=true;}var x=tmpc.x,y=tmpc.y,bound={x:x,y:y,w:w,h:h};var gap=getRectangleGap.call(this,ch[0]);for(var i=0;i<l;i++){var e,rect,minDim;e=ch[i];if(e.deleted){if((swapped==true&&localSwapped!=true)||(swapped==false&&localSwapped==true)){e.size={x:y,y:x,w:0,h:0};}else{e.size={x:x,y:y,w:0,h:0};}continue;}var value=getSizeValue(e,this);height=(sum<=0||e.deleted)?0:Math.ceil(h*value/sum);width=w;if(e.entityChildren!==undefined){if(value<sum){if(i==0){if(gap>1){height-=(gap>>1);}else{height--;}}else{if(i<l-1){if(gap>1){height-=gap;}else{height--;}}else{height=h+tmpc.y-y;}}}var nc={x:x,y:y,w:width,h:height};rect=rectIntersection(nc,bound);if((swapped==true&&localSwapped!=true)||(swapped==false&&localSwapped==true)){swapRect(nc);swapRect(rect);}if(rectIsValid(rect)){e.size=rect;}else{e.size={x:rect.x,y:rect.y,w:0,h:0};}minDim=Math.min(rect.w,rect.h);var hm=this;var arr=e.entityChildren.slice(0);arr.sort(function sortEntity(s,t){var vs=getSizeValue(s,hm);var vt=getSizeValue(t,hm);if(isNaN(vs)){if(isNaN(vt)){return 0;}return 1;}else{if(isNaN(vt)){return -1;}return vs<vt?1:-1;}return 0;});squarify.call(this,arr,{r:[]},minDim,nc);y+=height+gap;}else{if(value<sum){if(i==0||i==l-1){if(gap>1){if(height>(gap>>1)){height-=(gap>>1);}}else{if(height>1){height--;}}}else{if(height>gap){height-=gap;}}}width=Math.max(0,width);height=Math.max(0,height);var rect=rectIntersection({x:x,y:y,w:width,h:height},bound);rect.x=x;rect.y=y;y+=height+gap;if(y>=tmpc.y+h){rect.h=tmpc.y+h-rect.y;}if((swapped==true&&localSwapped!=true)||(swapped==false&&localSwapped==true)){rect=swapRect(rect);}if(rectIsValid(rect)){e.size=rect;}else{e.size={x:rect.x,y:rect.y,w:0,h:0};}}}}function setLayoutOrder(r,c){var sum=0,arr=r.r,l=arr.length;if(l==0){return ;}var ra,p=arr[0].parentEntity,ch=p.entityChildren,ll=ch.length;for(var i=0;i<l;i++){var e=arr[i],v=getSizeValue(e,this);if(!e.deleted&&v>0){sum+=v;}}if(r.t===undefined){var t=0;for(var i=0;i<ll;i++){var e=ch[i],v=getSizeValue(e,this);if(!e.deleted&&v>0){t+=v;}}r.t=t;}var e=arr[0],gap=getRectangleGap.call(this,e),bound={x:0,y:0,w:0,h:0};if(e==this.root){ra=this.heatMapSize.w*this.scaleFactor*this.heatMapSize.h*this.scaleFactor;bound.w=this.heatMapSize.w*this.scaleFactor;bound.h=this.heatMapSize.h*this.scaleFactor;}else{if(p==this.root){ra=this.heatMapSize.w*this.scaleFactor*this.heatMapSize.h*this.scaleFactor;bound.w=this.heatMapSize.w*this.scaleFactor;bound.h=this.heatMapSize.h*this.scaleFactor;}else{var pSize=p.size;ra=pSize.w*pSize.h;bound=copyRect(pSize);}if(r.t==0){ra=0;}else{ra*=sum/r.t;}}var aw=c.w,ah=c.h,swapped=false;if(c.h<c.w){}else{swapped=true;swapRect(c);swapRect(bound);var temp=aw;aw=ah;ah=temp;}if((bound.x<c.x)||(bound.x+bound.w>c.x+c.w)){if(gap>1){aw+=(gap>>1);}}if((bound.y<c.y)||(bound.y+bound.h>c.y+c.h)){if(gap>1){ah+=(gap>>1);}}var width=ah==0?0:Math.min(c.w,Math.ceil(ra/ah));if(sum<r.t&&sum>0){if(c.x+width<bound.x+bound.w){if(gap>1){width-=(gap>>1);}else{width--;}}}layoutRow.call(this,r,c,width,sum,swapped);var newX=c.x+width,newWidth=c.w-width;if(sum<r.t&&sum>0){if(c.x+width<bound.x+bound.w){if(gap>1){newX+=gap;newWidth-=gap;}else{newX++;newWidth--;}}}c.x=newX;c.w=Math.max(0,newWidth);if(swapped){swapRect(c);}}function getVisibleEntities(a){if(a==null){return[];}var arr=a.slice(0),total=0,l=arr.length;arr.t=[];for(var i=0;i<l;i++){var e=arr[i],val=getSizeValue(e,this);if(e.deleted||isNaN(val)||val<=0){arr.splice(i,1);i--;l--;continue;}total+=val;arr.t[i]=total;}return arr;}function pivotByMiddle(t,l,r,c){var params=[[this,t,l,r,c]];while(params.length){var param=params.pop();var _this=param[0];t=param[1];l=param[2];r=param[3];c=param[4];var e=t[0],gap=getRectangleGap.call(_this,e),lc,rc,lv,rv,lp,swapped=false,n=r-l+1,pivot=(n>2?((n-1)>>1):(n>>1))+l,cc;cc=copyRect(c);if(cc.w>cc.h){}else{swapRect(cc);swapped=true;}lc=copyRect(cc);rc=copyRect(cc);if(l==r){e=t[l];layoutEntityByMiddle.call(_this,e,cc,swapped,params);continue;}if(l+1==r){e=t[l];lv=getSizeValue(e,_this);e=t[r];rv=getSizeValue(e,_this);}else{if(l==0){lv=t.t[pivot-1];}else{lv=t.t[pivot-1]-t.t[l-1];}if(pivot==0){rv=t.t[r];}else{rv=t.t[r]-t.t[pivot-1];}}lp=lv/(lv+rv);lc.w=Math.ceil(lc.w*lp);if(lc.w<c.w){if(gap>1){if(lc.w>(gap>>1)){lc.w-=(gap>>1);}}else{if(lc.w>1){lc.w--;}}}if(l+1==r){rc.w-=lc.w+gap;rc.x+=lc.w+gap;e=t[l];layoutEntityByMiddle.call(_this,e,lc,swapped,params);e=t[r];layoutEntityByMiddle.call(_this,e,rc,swapped,params);continue;}var mc=copyRect(cc),as,pap,cv=0,pi=-1,la=1,pv;if(pivot>l){var llc=copyRect(lc);if(swapped){swapRect(llc);}params.push([_this,t,l,pivot-1,llc]);}mc.w-=lc.w+gap;mc.x+=lc.w+gap;rc.w=mc.w;rc.x=mc.x;as=mc.w/mc.h;e=t[pivot];pv=getSizeValue(e,_this);pap=pv/rv;for(var i=pivot;i<=r;i++){e=t[i];cv+=getSizeValue(e,_this);if(i==r-1){continue;}var pwp=cv/rv,php=pv/cv,a=pwp/php*as;if(a>=1){if(la<1&&la*a>1){pi=(i==r)?i-2:i-1;}else{pi=i;}break;}la=a;}pi=pi<0?r:pi;var mv,pw,ph;if(pivot==0){mv=t.t[pi];}else{mv=t.t[pi]-t.t[pivot-1];}pw=Math.ceil(mc.w*(mv/rv));ph=Math.ceil(mc.h*(pv/mv));if(pw<mc.w){if(gap>1){if(pw>(gap>>1)){pw-=(gap>>1);}}else{if(pw>1){pw--;}}}if(ph<mc.h){if(gap>1){if(ph>(gap>>1)){ph-=(gap>>1);}}else{if(ph>1){ph--;}}}var pc={x:mc.x,y:mc.y,w:pw,h:ph};e=t[pivot];layoutEntityByMiddle.call(_this,e,pc,swapped,params);if(pivot<pi){mc.y+=ph+gap;mc.w=pw;mc.h-=ph+gap;if(swapped){swapRect(mc);}params.push([_this,t,pivot+1,pi,mc]);}if(pi<r){rc.x+=pw+gap;rc.w-=pw+gap;if(swapped){swapRect(rc);}params.push([_this,t,pi+1,r,rc]);}}}function layoutEntityByMiddle(e,c,swapped,params){var size=copyRect(c);if(swapped==true){swapRect(size);}if(rectIsValid(size)){e.size=size;}else{e.size={x:size.x,y:size.y,w:0,h:0};}var ch=e.entityChildren;if(ch!==undefined){var arr=getVisibleEntities.call(this,ch),l=arr.length;if(l>0&&params){params.push([this,arr,0,l-1,size]);}}}function sliceAndDice(r,c){var params=[[this,r,c]];while(params.length){var param=params.pop();var _this=param[0];r=param[1];c=param[2];if(r==null||r.length==0){continue;}var t=0,e=r[0],val,gap=getRectangleGap.call(_this,e),swapped=false,l=r.length,x,y,w,h;for(var i=0;i<l;i++){e=r[i],val=getSizeValue(e,_this);if(!e.deleted&&val>0){t+=val;}}if(c.w<c.h){}else{swapped=true;swapRect(c);}w=c.w;h=c.h;x=c.x;y=c.y;for(var i=0;i<l;i++){e=r[i],val=getSizeValue(e,_this);if(!e.deleted&&val>0){var width,height;height=t<=0?0:Math.ceil(val/t*h);width=w;if(val<t){if(i==0||i==l-1){if(gap>1){if(height>(gap>>1)){height-=(gap>>1);}}else{if(height>1){height--;}}}else{if(height>gap){height-=gap;}}}width=Math.max(0,width);height=Math.max(0,height);var nc={x:x,y:y,w:width,h:height},rect=rectIntersection(nc,c);y+=height+gap;if(y>=c.y+h){rect.h=c.y+h-rect.y;}if(swapped){swapRect(rect);}if(rectIsValid(rect)){e.size=rect;}else{e.size={x:rect.x,y:rect.y,w:0,h:0};}if(e.entityChildren!==undefined){params.push([_this,e.entityChildren,rect]);}}else{e.size={};if(swapped){e.size={x:y,y:x,w:0,h:0};}else{e.size={x:x,y:y,w:0,h:0};}continue;}}if(swapped){swapRect(c);}}}function setShow(mf,s,fm,sfm,ec,w,ml){if(ec.entityChildren!==undefined){var parent=ec.parentEntity,del=true,cd=false,teAggValues=[],eChildren=ec.entityChildren,l=eChildren.length;for(var i=0;i<ml;i++){teAggValues[i]={count:0,allChildrenCount:0,positiveCount:0};}for(var i=0;i<l;i++){var child=eChildren[i];setShow(mf,s,fm,sfm,child,w,ml);if(!child.deleted){del=false;}if(child.entityChildren===undefined){if(child.deleted){cd=true;}}else{if(child.hasChildDeleted){cd=true;}}if(!child.deleted){aggregateTotals(ec,child,teAggValues,w,ml);}}ec.deleted=del;ec.hasChildDeleted=cd;for(var i=0;i<ml;i++){var ev=ec.aggValues[i];if(ev==null){ev={};ec.aggValues[i]=ev;}var temp=teAggValues[i];ev.total=temp.total;ev.avg=temp.count==0?0:temp.avgTotal/temp.count;ev.geomAvg=temp.positiveCount==0?NaN:Math.pow(temp.geomProduct,1/temp.positiveCount);ev.min=temp.min;ev.max=temp.max;ev.count=temp.count;ev.positiveCount=temp.positiveCount;}}else{if(ec.deleted){return ;}var sv=getSizeValue(ec,w);if(!isNaN(sv)){if(isNaN(w.smax)){w.smax=w.smin=sv;}else{if(sv>w.smax){w.smax=sv;}if(sv<w.smin){w.smin=sv;}}}var cv=getColorValue(ec,w);if(!isNaN(cv)){if(isNaN(w.cmax)){w.cmax=w.cmin=cv;}else{if(cv>w.cmax){w.cmax=cv;}if(cv<w.cmin){w.cmin=cv;}}}}}function aggregateTotals(ec,child,teAggValues,w,ml){var ev,agg=child.aggValues;if(child.entityChildren!==undefined){ev=getEntityValue(child,w.sizeMetricIndex);if(ev!==null){var cnt=ev.count;if(cnt>0){for(var i=0;i<ml;i++){ev=teAggValues[i];updateEntityContainerAggValue(ev,agg[i]);}}}}else{if(getSizeValue(child,w)>0&&!child.deleted){for(var i=0;i<ml;i++){ev=teAggValues[i];updateEntityAggValue(ev,getAggValue(child,i,w));}}}}function getEntityValue(e,index){var agg=e.aggValues;if(index>=agg.length){return NaN;}return agg[index];}function getColorValue(e,w){var idx=w.colorMetricIndex;return getAggValue(e,idx,w);}function getSizeValue(e,w){var idx=w.sizeMetricIndex,val=getAggValue(e,idx,w);if(val<0){w.hasNegativeSizeValue=true;return Math.abs(val);}return val;}function getSizeRawValue(e,w){var idx=w.sizeMetricIndex;return getAggValue(e,idx,w);}function getAggValue(e,i,w){var agg=e.aggValues;if(i>=agg.length){return NaN;}var ev=agg[i],t=w.aggFunctions[i];if(e.entityChildren!==undefined){switch(t){case AggregationType.Sum:return ev.total;case AggregationType.Avg:return ev.avg;case AggregationType.Cnt:return ev.count;case AggregationType.Max:return ev.max;case AggregationType.Min:return ev.min;case AggregationType.GeoAvg:return(ev.positiveCount>0)?ev.geomAvg:0;default:return ev.total;}}else{if(ev.allChildrenCount==1){return ev.value;}switch(t){case AggregationType.Sum:return ev.total;case AggregationType.Avg:return ev.count==0?0:ev.avgTotal/ev.count;case AggregationType.Cnt:return ev.count;case AggregationType.Max:return ev.max;case AggregationType.Min:return ev.min;case AggregationType.GeoAvg:return ev.positiveCount>0?NaN:Math.pow(ev.geomProduct,1/ev.positiveCount);default:return ev.total;}}}function getLegendMaxMin(){if(!isNaN(this.mlmax)||!isNaN(this.mlmin)){if(!isNaN(this.mlmax)){this.cmax=this.mlmax;if(isNaN(this.mlmin)&&(this.mlmax<this.cmin)){this.cmin=this.mlmax;}}if(!isNaN(this.mlmin)){this.cmin=this.mlmin;if(isNaN(this.mlmax)&&(this.mlmin>this.cmax)){this.cmax=this.mlmin;}}}if(!isNaN(this.mlmax)&&this.cmax>this.mlmax){this.cmax=this.mlmax;}if(!isNaN(this.mlmin)&&this.cmin<this.mlmin){this.cmin=this.mlmin;}this.colorTheme.min=this.cmin;this.colorTheme.max=this.cmax;this.colorTheme.checkMinMax();}function getMetricID(idx){var str="",m=this.model,col=m.ghs.chs.items,cnt=col.length,ml=col[0].items.length,coln=m.gts.col;if(idx<0||idx>=ml){return"";}for(var i=0;i<cnt;i++){var index=col[i].items[idx].idx;var temp=coln[i].es[index];var id=(temp.oid!==undefined)?temp.oid:temp.id;str+=id+" ";}return str.slice(0,str.length-1);}function getNumberForTick(i){var v;if(this.props.legendAsc){v=this.cmin+(this.cmax-this.cmin)*i/this.legendTickCount;}else{v=this.cmax+(this.cmin-this.cmax)*i/this.legendTickCount;}if(this.props.legendRounded){v=Math.floor(v);}return v;}function getTooltip(e,w){var level=e.level,index=(e.index===undefined)?e.indices[0]:e.index,st=0,str="",ret="",ar=w.attSpan,rhs=w.model.ghs.rhs.items,rowHeaderData=rhs[index].items,attr=w.model.gts.row,mv=w.model.gvs.items,ml=mv[0]?mv[0].items.length:0,att,fs;for(var i=0;i<level;i++){att=attr[i];ret+='<div class="heatmap-inline"><div class = "heatmap-tooltip-gray-bold">'+att.n+'</div><div class="heatmap-tooltip-gray-bold"><p>:&nbsp;</p></div>';str="";for(var j=st;j<st+ar[i];j++){var idx=rowHeaderData[j].idx;if(idx==-1){continue;}str+=att.es[idx].n+" ";}str=str.substring(0,str.length-1);ret+='<div class = "heatmap-tooltip-gray">'+str+"</div></div>";st+=ar[i];}att=attr[level];ret+='<div class="heatmap-inline"><div class = "heatmap-tooltip-black-bold">'+att.n+'</div><div class="heatmap-tooltip-black-bold"><p>:&nbsp;</p></div>';str="";for(var i=st;i<st+ar[level];i++){var idx=rowHeaderData[i].idx;if(idx==-1){continue;}str+=att.es[idx].n+" ";}str=str.substring(0,str.length-1);ret+='<div class = "heatmap-tooltip-black">'+str+"</div></div>";var si=w.sizeMetricIndex,ci=w.colorMetricIndex,n,v;if(si!=ml){n=w.getMetricName(si);if(e.entityChildren!==undefined||w.aggregated){var tmp=w.aggFunctions[si];n=tooltipMacro(n,tmp);v=getSizeRawValue(e,w);if(isNaN(v)){v="-";}else{if(AggregationType.Cnt!=tmp){fs=w.getFormatString(si);v=w.nf.formatByMask(fs,v);}}}else{v=mv[index].items[si].v;}ret+='<div class="heatmap-inline"><div class = "heatmap-tooltip-black-bold">'+n+'</div><div class="heatmap-tooltip-black-bold"><p>:&nbsp;</p></div>';ret+='<div class = "heatmap-tooltip-black">'+v+"</div></div>";}if(e.entityChildren===undefined&&ci!=ml&&si!=ci){n=w.getMetricName(ci);if(e.entityChildren!==undefined||w.aggregated){var tmp=w.aggFunctions[ci];n=tooltipMacro(n,tmp);v=getColorValue(e,w);if(isNaN(v)){v="-";}else{if(AggregationType.Cnt!=tmp){fs=w.getFormatString(ci);v=w.nf.formatByMask(fs,v);}}}else{v=mv[index].items[ci].v;}ret+='<div class="heatmap-inline"><div class = "heatmap-tooltip-black-bold">'+n+'</div><div class="heatmap-tooltip-black-bold"><p>:&nbsp;</p></div>';ret+='<div class = "heatmap-tooltip-black">'+v+"</div></div>";}for(var i=0;i<ml;i++){if(i==si){continue;}if(i==ci&&e.entityChildren===undefined&&si!=ci){continue;}n=w.getMetricName(i);if(e.entityChildren!==undefined||w.aggregated){var tmp=w.aggFunctions[i];n=tooltipMacro(n,tmp);v=getAggValue(e,i,w);if(isNaN(v)){v="-";}else{if(AggregationType.Cnt!=tmp){fs=w.getFormatString(i);v=w.nf.formatByMask(fs,v);}}}else{v=mv[index].items[i].v;}ret+='<div class="heatmap-inline"><div class = "heatmap-tooltip-gray-bold">'+n+'</div><div class="heatmap-tooltip-gray-bold"><p>:&nbsp;</p></div>';ret+='<div class = "heatmap-tooltip-gray">'+v+"</div></div>";}return ret;}function tooltipMacro(n,t){var macro;switch(t){case AggregationType.Sum:macro="Sum of {0}";break;case AggregationType.Avg:macro="Average of {0}";break;case AggregationType.Cnt:macro="Count of {0}";break;case AggregationType.Max:macro="Maximum of {0}";break;case AggregationType.Min:macro="Minimum of {0}";break;case AggregationType.GeoAvg:macro="Geometry Average of {0}";break;default:macro="Sum of {0}";}return macro.replace("{0}",n);}function bindTouchEvents(d,owner){if(d.eventOwner==owner){return ;}var $D=mstrmojo.dom,eventList=[$D.TOUCHSTART,$D.TOUCHMOVE,$D.TOUCHEND,$D.TOUCHCANCEL];for(var i=0;i<eventList.length;i++){if(eventList[i]==""){continue;}if(document.createTouch){d["on"+eventList[i]]=function(e){var evt=document.createEvent("TouchEvent"),t=e.touches[0];if(!t){t={};}evt.initTouchEvent(e.touches,e.targetTouches,e.changedTouches,e.type,e.view,t.screenX,t.screenY,t.clientX,t.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey);owner.dispatchEvent(evt);};}else{d["on"+eventList[i]]=function(e){var evt=document.createEvent("MouseEvent");evt.initMouseEvent(e.type,e.bubbles,e.cancelable,e.view,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget);owner.dispatchEvent(evt);};}}d.eventOwner=owner;}mstrmojo.VisHeatMap=mstrmojo.declare(mstrmojo.Vis,[mstrmojo._TouchGestures,mstrmojo._HasTouchScroller],{scriptClass:"mstrmojo.VisHeatMap",scrollerConfig:{bounces:false,showScrollbars:false,useTranslate3d:true,vScroll:true,hScroll:true,offset:{y:{start:0,end:0},x:{start:0,end:0}},origin:{x:0,y:0}},selectedStyle:"background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #058CF5), color-stop(1, #015DE6));color:#FFFFFF;",selectedClass:"",insertedStyles:[],LayoutProperties:{},highlightBoxWidth:3,waitIconString:mstrmojo.desc("8445","Loading"),markupString:'<div id="{@id}" class="mstrmojo-{@cssClass}" style="background-color:#333333;width:{@width};height:{@height}; left:{@left}; top:{@top}; z-index: {@zIndex}; position:absolute;" mstrAttach:mousedown,mouseup,mousemove,click><div class="heatmap-canvas-outer-container" style="padding: {@LayoutProperties.Padding}px; height:{@heatMapSize.h}px; width:{@heatMapSize.w}px"><div id ="{@id}-heatmap-canvas-container" class="heatmap-canvas-container" style="left: {@LayoutProperties.Padding}px; top: {@LayoutProperties.Padding}px; height:{@heatMapSize.h}px; width:{@heatMapSize.w}px"><div><div></div><div class="heatmap-selection-highlight-box heatmap-round-corner" style="border: {@highlightBoxWidth}px solid white;"></div></div></div></div><div class="heatmap-legend" style="left:{@legendSize.x}px; top:{@legendSize.y}px; height:{@legendSize.h}px; width:{@legendSize.w}px"><div  class="heatmap-size-legend"><div class="heatmap-size-legend-title">Rectangle Size:</div><div id="{@id}-color-legend-ticker" class="heatmap-size-legend-label" ></div></div><div  class="heatmap-color-legend"><div class="heatmap-color-legend-title">Rectangle Color:</div><table cellpadding="4" class="heatmap-color-legend-label"><tbody><tr><td class="heatmap-color-legend-label-td"></td></tr></tbody></table><div style="position:relative;"><canvas id="{@id}-color-legend-band" class="heatmap-color-legend-band"></canvas><div id="{@id}-legend-tooltip" class="heatmap-color-legend-tooltip"></div></div></div><div id="{@id}-editor-div" class="heatmap-editor-button" style="width: {@LayoutProperties.EditButtonWidth}px; height:{@LayoutProperties.EditButtonHeight}px; right:{@LayoutProperties.EditButtonRight}px"></div></div><span id="textSpan" class="heatmap-measure-text"></span><div class="mojo-overlay-wait" style="display: -webkit-box; -webkit-box-align:center; -webkit-box-pack:center; position: absolute; left: -100000px; top: -100000px"><div class="overlay"></div><div style="width:{@LayoutProperties.WaitIconWidth}px; height:{@LayoutProperties.WaitIconHeight}px; background-color: black; opacity: 0.8; display: -webkit-box"><div style="display: -webkit-box; -webkit-box-align: center; -webkit-box-pack: center; -webkit-box-flex:1;  margin: {@LayoutProperties.WaitIconMargin}px; border: 1px solid white; color: white; font-family: Helvetica; font-weight: bold; font-size:{@LayoutProperties.WaitIconFontSize}pt">{@waitIconString}</div></div></div><div></div></div>',markupSlots:{canvas:function(){return this.domNode.childNodes[0].childNodes[0].childNodes[0].childNodes[0];},canvasContainer:function(){return this.domNode.childNodes[0].childNodes[0];},canvasOuterContainer:function(){return this.domNode.childNodes[0];},scrollNode:function(){return this.domNode.childNodes[0].childNodes[0].childNodes[0];},selectionHighlightBox:function(){return this.domNode.childNodes[0].childNodes[0].childNodes[0].childNodes[1];},legend:function(){return this.domNode.childNodes[1];},sizeLegend:function(){return this.domNode.childNodes[1].childNodes[0];},sizeLegendTitle:function(){return this.domNode.childNodes[1].childNodes[0].firstChild;},sizeLegendLabel:function(){return this.domNode.childNodes[1].childNodes[0].lastChild;},colorLegend:function(){return this.domNode.childNodes[1].childNodes[1];},colorLegendTitle:function(){return this.domNode.childNodes[1].childNodes[1].firstChild;},colorLegendLabel:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[1];},colorLegendBand:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[2].firstChild;},legendTooltip:function(){return this.domNode.childNodes[1].childNodes[1].childNodes[2].childNodes[1];},editorButton:function(){return this.domNode.childNodes[1].lastChild;},textSpan:function(){return this.domNode.childNodes[2];},waitIcon:function(){return this.domNode.childNodes[3];},infoBoxPuppet:function(){return this.domNode.childNodes[4];}},addCSSToHead:function(){var cssString={text:".heatmap-popup-panel-title {  font-size: "+adjustPixel.call(this,22,true)+"pt !important;  height: "+adjustPixel.call(this,65,true)+"px !important;}.heatmap-gray-label {        padding-bottom: "+adjustPixel.call(this,7,true)+"px !important;        font-size: "+adjustPixel.call(this,14,true)+"pt !important;  height: "+adjustPixel.call(this,32,true)+"px !important;  padding-left: "+adjustPixel.call(this,22,true)+"px !important;  line-height: "+adjustPixel.call(this,40,true)+"px !important;}.heatmap-tree-text {  font-size: "+adjustPixel.call(this,18,true)+"pt !important;  line-height: "+adjustPixel.call(this,65,true)+"px !important;}.heatmap-tree-div {  font-size: "+adjustPixel.call(this,18,true)+"pt !important;  line-height: "+adjustPixel.call(this,40,true)+"px !important;}.heatmap-tree-button {  font-size: "+adjustPixel.call(this,16,true)+"pt !important;}.heatmap-apply-button > .mstrmojo-Button-text {  font-size: "+adjustPixel.call(this,14,true)+"pt !important;  line-height: "+adjustPixel.call(this,24,true)+"px !important;   height: "+adjustPixel.call(this,24,true)+"px !important; }.heatmap-tree.root > .heatmap-tree-div > div {  font-size: "+adjustPixel.call(this,14,true)+"pt !important;  line-height: "+adjustPixel.call(this,40,true)+"px !important;  height: "+adjustPixel.call(this,40,true)+"px !important;}.heatmap-one-level-1 {  font-size: "+adjustPixel.call(this,14)+"pt !important;}.heatmap-multi-level-1 {  font-size: "+adjustPixel.call(this,24)+"pt !important;}.heatmap-two-level-2 {  font-size: "+adjustPixel.call(this,14)+"pt !important;}.heatmap-multi-level-2 {  font-size: "+adjustPixel.call(this,20)+"pt !important;}.heatmap-multi-level-3 {  font-size: "+adjustPixel.call(this,10)+"pt !important;}.heatmap-size-legend {  font-size: "+adjustPixel.call(this,12)+"pt !important;}.heatmap-color-legend {  font-size: "+adjustPixel.call(this,12)+"pt !important;}.heatmap-color-legend-label {  font-size: "+adjustPixel.call(this,10)+"pt !important;}.heatmap-color-legend-tooltip {  font-size: "+adjustPixel.call(this,12)+"pt !important;}.heatmap-legend {  font-size: "+adjustPixel.call(this,12)+"pt !important;}.heatmap-editor-button {  font-size: "+adjustPixel.call(this,12)+"pt !important;}.heatmap-tooltip-gray-bold {  font-size: "+adjustPixel.call(this,14)+"pt !important;}.heatmap-tooltip-gray {  font-size: "+adjustPixel.call(this,14)+"pt !important;}.heatmap-tooltip-black-bold {  font-size: "+adjustPixel.call(this,14)+"pt !important;}.heatmap-tooltip-black {  font-size: "+adjustPixel.call(this,14)+"pt !important;}"};this.addAdjustedClassToDocument(cssString.text);},addAdjustedClassToDocument:function(classString){var beginIndex=classString.indexOf(".");if(beginIndex==-1){return ;}var p=document.getElementsByTagName("head")[0];this.CSSParent=p;for(var i=beginIndex;i<classString.length;){var endIndex=i+classString.substring(i).indexOf("}");if(endIndex==-1){break;}var style=document.createElement("style");style.type="text/css";style.innerHTML=classString.substring(i,endIndex+1);this.insertedStyles.push(style);p.appendChild(style);i=endIndex+1;}},isMultipleDPIEnabled:function(){var xtabModel=this.xtabModel,docModel=(xtabModel&&xtabModel.docModel),fitToPage=false,microApp=false;if(docModel){fitToPage=docModel.zt&&(docModel.zt==2);var layouts=(docModel&&docModel.defn&&docModel.defn.layouts),layout;var i;for(i in layouts){if(layouts[i].loaded){layout=layouts[i];break;}}if(layout&&layout.hasOwnProperty("fch")){microApp=layout.fch;}}if(fitToPage&&microApp){return true;}else{return false;}},init:function(e){if(this._super){this._super(e);}var canvas=document.createElement("canvas");browserSupportsHtml5=canvas.getContext;if(!browserSupportsHtml5){this.error=mstrmojo.desc(8126,"Your browser does not support HTML5");return ;}},preBuildRendering:function(){delete this.error;if(this._super){this._super();}this.dpiAdjusted=true;this.DPI=mstrMobileApp.getDeviceDPI();if(mstrMobileApp.getDeviceDPIX){this.DPIX=mstrMobileApp.getDeviceDPIX();}else{this.DPIX=149;}if(this.isMultipleDPIEnabled()){this.enableMultiDPI=true;}else{this.enableMultiDPI=false;}this.adjustLocalDPI();this.addCSSToHead();this.zIndex=null;this.loadDefinedFormat();loadProps.call(this);loadSession.call(this);if(!this.model){this.error=mstrmojo.desc(8426,"No model provided");return ;}var err=this.model.err||this.model.eg;if(err){this.error=err;return ;}convertDataToModels.call(this);var err=this.model.err||this.model.eg;if(err){this.error=err;return ;}setLayout.call(this);this.calculateValuesInTree();layoutEntities.call(this);getLegendMaxMin.call(this);this.nf=mstrmojo.num;if(this.editorDialog){this.editorDialog.destroy();this.editorDialog=null;}},createInfoBox:function(){var html='<div id="'+this.id+'-infobox" class="heatmap-infobox" style="position:absolute; left:0px; top:0px;"><div class="heatmap-highlight-box heatmap-round-corner" style="border: '+this.highlightBoxWidth+'px solid white;"></div><div class="heatmap-shadow-box heatmap-round-corner"></div><div class="heatmap-triangle"></div><div class="heatmap-tooltip-box heatmap-round-corner" style="max-width: '+document.body.offsetWidth+"px; max-height: "+document.body.offsetHeight+'px; "></div><div class="heatmap-delete-button"></div><div class="heatmap-tooltip-shelter heatmap-round-corner"></div></div>';var div=document.createElement("div");div.innerHTML=html;this.infoBox=div.childNodes[0];this.highlightBox=this.infoBox.childNodes[0];this.shadowBox=this.infoBox.childNodes[1];this.triBox=this.infoBox.childNodes[2];this.tooltipBox=this.infoBox.childNodes[3];this.deleteButton=this.infoBox.childNodes[4];this.shelter=this.infoBox.childNodes[5];div.style.cssText="position: absolute; left: 0px; top: 0px";bindTouchEvents(div,this.infoBoxPuppet);document.body.appendChild(div);},postBuildRendering:function postBR(){if(this.error){this.renderErrorMessage(this.error);return ;}var heatMap=this;var tmpFunction=this.controller.onorientationChange;this.controller.onorientationChange=function(){tmpFunction.call(heatMap.controller);heatMap.onorientationChange();};this._onorientationChange=tmpFunction;this.enableGlobalDismiss();this.setupScroller();if(this._super){this._super();}var backup=this._tsCallback;this._tsCallback=function(e){if(heatMap.isInfoWindowDisplayed()){heatMap.infoWindowMode=true;}else{heatMap.infoWindowMode=false;}backup.call(heatMap,e);};var $DAE=mstrmojo.dom.attachEvent,$DDE=mstrmojo.dom.detachEvent,TOUCHSTART=mstrmojo.dom.TOUCHSTART;$DDE(this._tn,TOUCHSTART,backup);$DAE(this._tn,TOUCHSTART,this._tsCallback);if(this.isUsingSavedColorTheme){this.useSavedColorTheme();}if(this.isUsingDefaultColorTheme){this.useDefaultColorTheme();}try{this.initCanvas();}catch(err){this.renderErrorMessage(err);return ;}this.renderLegend();if(!this.infoBox){this.createInfoBox();}if(this.props.delButtonEnabled){this.deleteButton.style.display="block";}if(this.previousSelected&&this.previousSelected.parentEntity){this.highlightEntity(this.selectionHighlightBox,this.previousSelected);}},unrender:function(){storeSession.call(this);if(this._scroller){this._scroller.detachEventListener(this._scrollMovedHandler);this._scroller.detachEventListener(this._scrollDoneHandler);}this.disableGlobalDismiss();var $DAE=mstrmojo.dom.attachEvent,$DDE=mstrmojo.dom.detachEvent,TOUCHSTART=mstrmojo.dom.TOUCHSTART;$DDE(this._tn,TOUCHSTART,this._tsCallback);if(this.infoBox&&this.infoBox.parentNode&&this.infoBox.parentNode.parentNode){this.infoBox.parentNode.parentNode.removeChild(this.infoBox.parentNode);}delete this.infoBox;delete this.editorDialog;if(this.canvasObject){this.canvasObject.unrender();}if(this._super){this._super();}},hasPageBy:function hasPageBy(){if(this.model&&this.model.phs&&this.model.phs.show){return true;}return false;},getFirstInfowindow:function getFirstInfowindow(){var me=this,model=me.model,xtabModel=me.xtabModel,docModel=(xtabModel&&xtabModel.docModel),row=model&&model.gts&&model.gts.row,tks;if(row&&row.length>0){tks=row[0]&&row[0].sc&&row[0].sc.tks;}if(docModel&&tks){ifws=docModel.getTargetInfoWin(tks);if(ifws&&ifws.length){var ifwunit=docModel.infoWinByKey[ifws[0]];var id=ifwunit&&(ifwunit.id+"_ifw");return mstrmojo.all[id];}}},isInfoWindowDisplayed:function(){var ifw=this.getFirstInfowindow();if(ifw){ifw=ifw.domNode;}if(!ifw){return false;}if(ifw.style.display=="block"){return true;}else{return false;}},globalListener:function(){var that=window.heatMap;if(!that){return ;}that.hideInfoBox();if(!that.selectAll){that.doSelection(that.previousSelected);}},addGlobalListener:function(){window.heatMap=this;var p=document.getElementsByClassName("mstrmojo-DocLayoutViewer-layout")[0];if(p){p.addEventListener(mstrmojo.dom.TOUCHSTART,window.heatMap.globalListener,false);}},removeGlobalListener:function(){var p=document.getElementsByClassName("mstrmojo-DocumentView")[0];if(p){p.removeEventListener("click",this.globalListener,false);}delete window.heatMap;},addCurtain:function(){var p=document.getElementsByClassName("mstrmojo-DocLayoutViewer-layout")[0];var div=document.createElement("div"),that=this;div.style.width=p.offsetWidth+"px";div.style.height=p.offsetHeight+"px";div.style.position="absolute";div.style.zIndex=-1;div.id=this.id+"curtain";div.onclick=this.globalListener;p.appendChild(div);},removeCurtain:function(){var div=document.getElementById(this.id+"curtain");if(div){div.parentNode.removeChild(div);}},renderErrorMessage:function renderErrorMessage(msg){var d=this.domNode,p=d.parentNode,div=document.createElement("div"),textDiv=document.createElement("div");if(d){div.style.width=d.offsetWidth-2+"px";div.style.height=d.offsetHeight-2+"px";div.style.left=d.offsetLeft+"px";div.style.top=d.offsetTop+"px";div.style.zIndex=this.zIndex;}else{div.style.width=parseInt(this.width)-2+"px";div.style.height=parseInt(this.height)-2+"px";div.style.left=this.left;div.style.top=this.top;div.style.zIndex=this.zIndex;}div.style.cssText+="background-color:#F5F5F2; position:absolute; display:-webkit-box; -webkit-box-pack:center; -webkit-box-align:center; -webkit-box-orient:vertical; border-style:solid; border-color:#A7A7A7; border-width:1px; ";textDiv.className="mstrmojo-message";textDiv.innerText=msg;div.appendChild(textDiv);if(d){p.replaceChild(div,d);}else{p.appendChild(div);}},convertDPI:function(props){if(typeof props!="object"){if(typeof props=="number"&&props%1==0){return adjustPixel.call(this,props);}else{return props;}}else{var ret={};for(var key in props){ret[key]=this.convertDPI(props[key]);}return ret;}},adjustLocalDPI:function(){this.LayoutProperties=this.convertDPI(LayoutProperties);this.LayoutProperties.LegendTickCount=5;this.LayoutProperties.LegendWidthPercent=0.9;this.LayoutProperties.LegendBandAspect=10;this.LayoutProperties.EditorDialogWidth=adjustPixel.call(this,565,true);this.LayoutProperties.EditorDialogHeight=adjustPixel.call(this,574,true);var h=document.body.offsetHeight,eh=this.LayoutProperties.EditorDialogHeight,sfh=h/eh,sf=1;if(sfh<1){sf=sfh;sf*=0.9;this.LayoutProperties.EditorDialogHeight=parseInt(eh*sf);}this.LayoutProperties.DeletedListHeight=adjustPixel.call(this,500*sf,true);this.LayoutProperties.EditButtonWidth=adjustPixel.call(this,60);this.LayoutProperties.EditButtonHeight=adjustPixel.call(this,40);this.LayoutProperties.EditButtonRight=adjustPixel.call(this,10);},onorientationChange:function(){if(this.editorDialog){var domNode=this.editorDialog.domNode;if(domNode&&domNode.firstChild){var d=domNode.firstChild,t=d.firstChild.firstChild;d.style.marginTop=parseInt((document.body.offsetHeight-this.LayoutProperties.DeletedListHeight-t.offsetHeight)/2)+"px";}}},loadDefinedFormat:function(){if(this.defn&&this.defn.fmts){var fmts=this.defn.fmts,pWidgetHeight=fmts&&fmts.p_fmts&&fmts.p_fmts.height;if(fmts.height){this.height=fmts.height;}if(!this.isFullScreenWidget){if(fmts.width){this.width=fmts.width;}}if(fmts["z-index"]){this.zIndex=fmts["z-index"];}}},checkErrors:function(){var err=this.error;if(err){this.renderErrorMessage(err);return true;}if(!this.model){this.renderErrorMessage(mstrmojo.desc(8426,"No model provided"));return true;}var err=this.model.err||this.model.eg;if(err){this.renderErrorMessage(err);return true;}return false;},setupScroller:function(){var sclConfig=this.scrollerConfig;sclConfig.scrollEl=this.scrollNode;sclConfig.offset.x.start=0;sclConfig.offset.x.end=this.heatMapSize.w*(this.scaleFactor-1);sclConfig.offset.y.start=0;sclConfig.offset.y.end=this.heatMapSize.h*(this.scaleFactor-1);if(sclConfig.origin.x>sclConfig.offset.x.end){sclConfig.origin.x=sclConfig.offset.x.end;}if(sclConfig.origin.y>sclConfig.offset.y.end){sclConfig.origin.y=sclConfig.offset.y.end;}},refreshLabelInTree:function(){var getLabel=function(e,idx){if(e==this.root){return ;}var text=this.getLabelForEntity(e);e.text=text;e.idx=idx;};this.dfs(this.root,getLabel,"");},refreshColorInTree:function(){var paintColor=function(e){if(e.EntityChildren||e==this.root){return ;}var color=getCSSColor(this.colorTheme.getColor(getColorValue(e,this)));e.color=color;};this.dfs(this.root,paintColor,"");},dfs:function(root,f,indexString){if(root.deleted){return ;}if(indexString===undefined){f.call(this,root);}else{f.call(this,root,indexString);}if(root.entityChildren===undefined){return ;}var arr=root.entityChildren,l=arr.length;for(var i=0;i<l;i++){var e=arr[i];if(indexString===undefined){this.dfs(e,f);}else{var param=indexString;if(!param){param=i.toString();}else{param=param+":"+i;}this.dfs(e,f,param);}}},traverseBFS:function traverse(){var heatMap=this,canvas=this.textCanvas,renderText=function(e,indexString){},terminate=function(level){var lv=level-heatMap.levelToShowText;if(lv>=3){return false;}return true;};},initCanvas:function(){var _this=this;this.refreshColorInTree();this.refreshLabelInTree();var props={colorTheme:this.colorTheme,placeholder:this.canvas,root:this.root,width:this.heatMapSize.w,height:this.heatMapSize.h,scale:this.scaleFactor,attributes:this.levelAttributes,showMetric:this.props.showMetricValues,labelSetting:this.props.labelSize};this.canvasObject=new mstrmojo.VisHeatMapCanvas(props);this.canvasObject.render();this.canvasObject.updateOffsets(this._scroller.origin.x,this._scroller.origin.y);this.canvas=this.canvasObject.domNode;},renderRectangles:function(){this.refreshColorInTree();this.refreshLabelInTree();this.canvasObject.scale=this.scaleFactor;this.canvasObject.offsetX=this._scroller.origin.x;this.canvasObject.offsetY=this._scroller.origin.y;try{this.canvasObject.draw();}catch(err){this.renderErrorMessage(err);}},renderLegend:function renderLegend(){if(this.props.showLegend==false){this.editorButton.style.height="";this.editorButton.style.width="";this.editorButton.style.right="";this.editorButton.style.bottom="";this.editorButton.className="heatmap-editor-legend-unshown";this.editorButton.innerHTML="";this.editorButton.style.top="";this.sizeLegend.style.display="none";this.colorLegend.style.display="none";this.legend.style.left="";this.legend.style.top="";this.legend.style.right="0px";this.legend.style.bottom="0px";this.legend.style.zIndex="100";return ;}var el=mstrmojo.desc(11158,"EDIT"),rsl=mstrmojo.desc(10079,"Rectangle Size"),rcl=mstrmojo.desc(10080,"Rectangle Color");this.editorButton.className="heatmap-editor-button";this.editorButton.innerHTML=el;var w=parseInt(this.width),h=parseInt(this.height),canvasHeight=this.heatMapSize.h,computedStyle=window.getComputedStyle(this.editorButton,null),editorButtonHeight=parseInt(computedStyle.height),editorButtonWidth=parseInt(computedStyle.width),legendHeight=this.legendSize.h,legendWidth=this.legendSize.w-editorButtonWidth-parseInt(computedStyle.right),sfs=this.getFormatString(this.sizeMetricIndex);this.legend.style.top=this.heatMapSize.h+2*this.LayoutProperties.Padding+"px";this.editorButton.style.top=((legendHeight-editorButtonHeight)>>1)+"px";this.editorButton.style.bottom="";if(this.props.showEditor){legendWidth-=this.LayoutProperties.LegendMenuEditorWidth;}var sizeT={w:0,h:0},sizeL={w:0,h:0},sizeSize={w:0,h:0},tickCount,padding,bandWidth,bandHeight;if(this.props.sizeMetricEnabled){var sizeTitle="<span style='font-weight: bold'>"+rsl+":</span>";var vld=this.checkMetricValid(this.sizeMetricIndex),mn=this.getMetricName(this.sizeMetricIndex);if(this.hasNegativeSizeValue){mn="Absolute value of "+mn;}if(isNaN(this.smin)){this.smin=0;}if(isNaN(this.smax)){this.smax=0;}var sizeLabel="<div>"+(vld?this.nf.formatByMask(sfs,this.smin):"0")+" < </div><div class='heatmap-flex'>"+mn+"</div><div> < "+(vld?this.nf.formatByMask(sfs,this.smax):"0")+"</div>";this.sizeLegendTitle.innerHTML=sizeTitle;this.sizeLegendLabel.innerHTML=sizeLabel;sizeSize={w:Math.max(this.sizeLegendTitle.offsetWidth,this.sizeLegendLabel.offsetWidth),h:this.sizeLegendTitle.offsetHeight};}else{this.sizeLegend.style.display="none";}if(this.props.colorMetricEnabled){var colorTitle;if(this.props.sizeMetricEnabled){colorTitle=rcl+": <span style='font-weight:normal;'>"+this.getMetricName(this.colorMetricIndex)+"</span>";}else{colorTitle="<span style='font-weight:bold'>"+this.getMetricName(this.colorMetricIndex)+"</span>";}tickCount=this.LayoutProperties.LegendTickCount;if(isNaN(this.cmin)||this.cmin>=this.cmax){tickCount=1;}this.legendTickCount=tickCount;bandWidth=Math.min(this.LayoutProperties.LegendMaxBandWidth,this.LayoutProperties.LegendWidthPercent*(legendWidth-sizeSize.w));padding=Math.floor((legendWidth-sizeSize.w-bandWidth)/3);var pd=this.renderTickLabels(bandWidth,tableHeight,tickCount);if(padding>=this.LayoutProperties.LegendMinPadding+pd.l+pd.r){bandWidth+=pd.l+pd.r;padding-=((pd.l+pd.r)>>1);}else{if(padding<this.LayoutProperties.LegendMinPadding){padding=this.LayoutProperties.LegendMinPadding;var temp=((legendWidth-3*padding)>>1);if(temp>sizeSize.w){bandWidth=legendWidth-3*padding-sizeSize.w;}else{sizeSize.w=temp;bandWidth=sizeSize.w;}}}bandHeight=Math.min(Math.floor(bandWidth/this.LayoutProperties.LegendBandAspect),Math.floor(legendHeight/3))-this.LayoutProperties.LegendBottomPadding;this.colorLegend.style.display="";this.colorLegendTitle.innerHTML=colorTitle;}else{padding=((legendWidth-sizeSize.w)>>1);this.colorLegend.style.display="none";}if(this.props.sizeMetricEnabled){this.sizeLegend.style.left=padding+"px";this.sizeLegend.style.width=sizeSize.w+this.LayoutProperties.LegendGutter+2*this.LayoutProperties.Padding+"px";this.sizeLegend.style.height=legendHeight+"px";}else{this.sizeLegend.style.left="0px";this.sizeLegend.style.width="0px";this.sizeLegend.top="0px";this.sizeLegend.style.height="0px";this.sizeLegendLabel.style.marginTop="0px";padding=((legendWidth-bandWidth)>>1);}if(this.props.colorMetricEnabled){if(this.props.sizeMetricEnabled){this.colorLegend.style.left=sizeSize.w+2*padding+"px";}else{this.colorLegend.style.left=sizeSize.w+padding+"px";}this.colorLegend.style.width=bandWidth+"px";this.colorLegend.style.height=legendHeight+"px";sizeT={w:this.colorLegendTitle.offsetWidth,h:this.colorLegendTitle.offsetHeight};var tableHeight=legendHeight-bandHeight-sizeT.h-2*this.LayoutProperties.LegendBottomPadding;this.colorLegendLabel.style.width=bandWidth+"px";this.colorLegendLabel.style.height=tableHeight+"px";this.colorLegendBand.width=bandWidth;this.colorLegendBand.height=bandHeight+10;var pd=this.renderTickLabels(bandWidth,tableHeight,tickCount);this.colorTheme.tooltipInfo=null;this.legendBand={x:pd.l,y:0,w:bandWidth-pd.r-pd.l,h:bandHeight};this.colorLegendBand.parentNode.style.width=bandWidth+"px";this.colorLegendBand.parentNode.style.height=bandHeight+"px";this.renderGradientBand(this.legendBand);}},renderTickLabels:function renderLabel(w,h,t){var count=t+1;var p=this.colorLegendLabel.firstChild.firstChild,nodes=p.childNodes,curCount=nodes.length,lastNode=p.lastChild,diff=curCount-count,cfs=this.getFormatString(this.colorMetricIndex);lastNode.style.display="";lastNode.style.width="";lastNode.style.textAlign="center";if(diff<0){for(var i=0;i<Math.abs(diff);i++){var node=lastNode.cloneNode(true);p.insertBefore(node,lastNode.nextSibling);lastNode=node;}}else{for(var i=0;i<diff;i++){if(t==0&&i==diff-1){lastNode.style.display="none";break;}p.removeChild(p.lastChild);}}p.firstChild.style.textAlign="left";p.lastChild.style.textAlign="right";var valid=true;if(isNaN(this.cmax)||isNaN(this.cmin)){valid=false;}for(var i=0;i<count;i++){node=nodes[i];var v="Null";if(valid){v=getNumberForTick.call(this,i);}node.innerHTML='<div style="display: inline-block; overflow: hidden; text-overflow: ellipsis; max-width: 100%; white-space: nowrap;">'+this.nf.formatByMask(cfs,v)+"</div>";if(this.props.legendRounded){}}var firstV=p.firstChild.innerHTML,lastV=p.lastChild.innerHTML,fSize={w:p.firstChild.firstChild.offsetWidth,h:p.firstChild.firstChild.offsetHeight};lSize={w:p.lastChild.firstChild.offsetWidth,h:p.lastChild.firstChild.offsetHeight};left=Math.min(w/count,fSize.w)>>1,right=Math.min(w/count,lSize.w)>>1;return{l:left,r:right};},renderGradientBand:function renderBand(frame){var x=frame.x,y=frame.y,w=frame.w,h=frame.h,ctx=this.colorLegendBand.getContext("2d");ctx.clearRect(x,y,w+2,h);var lingrad=ctx.createLinearGradient(x,y,w+x,y);lingrad.addColorStop(0,"#333333");var gradientInfo=this.colorTheme.getGradientFillInfo(this.cmin,this.cmax);var c=gradientInfo.c,r=gradientInfo.r,l=c.length;for(var i=0;i<l;i++){lingrad.addColorStop(roundNumber(r[i],2),getCSSColor(c[i]));}ctx.fillStyle=lingrad;createPath(x,y,w,h,0,ctx);ctx.fill();},renderHilightedBand:function renderHighlightedBand(i){var frame=this.legendBand,info=this.colorTheme.tooltipInfo[i],x=frame.x,y=frame.y,w=frame.w,h=frame.h,ctx=this.colorLegendBand.getContext("2d");this.renderGradientBand(frame);this.selectedBandIndex=i;ctx.strokeStyle="#FFFFFF";ctx.lineWidth=2;ctx.strokeRect(info.r.x+x+1,y+1,info.r.w-1,h-3);},getTextSize:function gts(str,fontName,fontSize,isBold,isItalic){this.textSpan.style="";this.textSpan.style.fontFamily=fontName;this.textSpan.style.fontSize=isNaN(fontSize)?fontSize:fontSize+"px";this.textSpan.style.fontWeight=isBold?"bold":"normal";this.textSpan.style.fontStyle=isItalic?"italic":"normal";this.textSpan.innerHTML=str;var w=this.textSpan.offsetWidth,h=this.textSpan.offsetHeight;return{w:w,h:h};},reRender:function reRender(){if(this.model.err||this.model.eg){return ;}if(this._super){this._super();}},useDefaultColorTheme:function(callback){if(this.entitiesWithStates){var es=this.entitiesWithStates;for(var key in es){var ee=es[key]||[],len=ee.length,i;for(i=0;i<len;i++){var e=ee[i];e.pathName=undefined;e.isExpanded=undefined;e.isSelected=undefined;}}}this.entitiesWithStates=undefined;this.dialogScrollerPosition=undefined;var colorTheme=this.colorTheme,needsRefresh=false;if(colorTheme.useDefault==false){needsRefresh=true;colorTheme.isBlend=true;colorTheme.setDefaultDataProvider();}if(this.scaleFactor!=1){needsRefresh=true;this.scaleFactor=1;}function markUndelete(delDict){for(var key in delDict){var childDict=delDict[key];if(typeof childDict==="object"){if(Object.keys(childDict).length===0){delete delDict[key];}else{markUndelete(childDict);}}else{if(childDict===delStatus.dftDel){needsRefresh=true;delDict[key]=delStatus.dftUnDel;}else{if(childDict===delStatus.usrDel){needsRefresh=true;delete delDict[key];}}}}}markUndelete(this.props.deletedList);this.loadDeleteStatus(this.root,this.props.deletedList);if(needsRefresh){colorTheme.tooltipInfo=null;this.refreshWidget();}if(callback){callback();}},loadDeleteStatus:function(node,delDict){if(!node.entityChildren){if(delDict===delStatus.dftDel||delDict===delStatus.usrDel){node.deleted=true;}else{delete node.deleted;}return ;}if((!delDict||Object.keys(delDict).length===0)&&!node.hasChildDeleted){return ;}var children=node.entityChildren;for(var i=0;i<children.length;i++){var child=children[i];var name=this.getEntityDisplayName(child);var thisDict=delDict&&delDict[name];this.loadDeleteStatus(child,thisDict);}},useSavedColorTheme:function(callback){var colorTheme=this.colorTheme,needsRefresh=false;if(colorTheme.useDefault==true){needsRefresh=true;var propValue=this.model.vp;if(propValue){colorTheme.isBlend=((propValue.blc===undefined||propValue.blc=="true")?true:false);}if(propValue.gradientColors&&propValue.bandColors){colorTheme.createDataProviderFromString(propValue.gradientColors,propValue.bandColors);}colorTheme.useDefault=false;}if(this.scaleFactor!=1){needsRefresh=true;this.scaleFactor=1;}function markDelete(delDict){for(var key in delDict){var childDict=delDict[key];if(typeof childDict==="object"){if(Object.keys(childDict).length===0){delete delDict[key];}else{markDelete(childDict);}}else{if(childDict===delStatus.dftUnDel){needsRefresh=true;delDict[key]=delStatus.dftDel;}else{if(childDict===delStatus.usrDel){needsRefresh=true;delete delDict[key];}}}}}markDelete(this.props.deletedList);this.loadDeleteStatus(this.root,this.props.deletedList);if(needsRefresh){colorTheme.tooltipInfo=null;this.refreshWidget();}if(callback){callback();}},getFormatString:function getFormatString(idx){var m=this.model,col=m.gvs.items[0]?m.gvs.items[0].items:[],cnt=col.length;if(idx>=0&&idx<cnt){var obj=col[idx];if(obj.formatstring!==undefined){return obj.formatstring.replace(/\'/g,'"');}return"";}return"";},checkMetricValid:function checkMetric(idx){var str="",m=this.model,col=m.ghs.chs.items,cnt=col.length,ml=col[0]?col[0].items.length:0,coln=m.gts.col;if(idx<0||idx>=ml){return false;}return true;},getMetricName:function getMetricName(idx){var str="",m=this.model,col=m.ghs.chs.items,cnt=col.length,coln=m.gts.col;if(!this.checkMetricValid(idx)){return Fake_Metric_ID;}for(var i=0;i<cnt;i++){var index=col[i].items[idx].idx;var name=coln[i].es[index].n;str+=name+" ";}return str.slice(0,str.length-1);},getEntityDisplayName:function getEntityDisplayName(e){var level=e.level,index=(e.index===undefined)?e.indices[0]:e.index,st=0,str="",ar=this.attSpan,rhs=this.model.ghs.rhs.items,rowHeaderData=rhs[index].items,att=this.model.gts.row[level];for(var i=0;i<level;i++){st+=ar[i];}str="";for(var i=st;i<st+ar[level];i++){var idx=rowHeaderData[i].idx;if(idx==-1){continue;}str+=att.es[idx].n+" ";}str=str.substring(0,str.length-1);return str;},previousTooltip:null,previousSelected:null,highlightEntity:function(box,entity){if(!entity||!box){return ;}var w=this.canvasContainer.offsetWidth,h=this.canvasContainer.offsetHeight,size=entity.size,origin=this._scroller.origin,border=this.highlightBoxWidth,widgetRect=mstrmojo.dom.position(this.canvasContainer,true);var container={x:origin.x,y:origin.y,w:w,h:h};var canvasRect={x:0,y:0,w:Math.ceil(this.heatMapSize.w*this.scaleFactor),h:Math.ceil(this.heatMapSize.h*this.scaleFactor)};var rect={x:size.x-border,y:size.y-border,w:size.w+2*border,h:size.h+2*border};var inters=rectIntersection(rect,canvasRect);if(box==this.highlightBox){inters=rectIntersection(inters,container);this.previousHighlighted=entity;}if(isNaN(inters.x)){return null;}inters.x+=(border-origin.x);inters.y+=(border-origin.y);inters.w-=2*border;inters.h-=2*border;if(box==this.highlightBox){box.style.left=inters.x-border+widgetRect.x+"px";box.style.top=inters.y-border+widgetRect.y+"px";inters.x+=widgetRect.x;inters.y+=widgetRect.y;}else{box.style.left=inters.x-border+origin.x+"px";box.style.top=inters.y-border+origin.y+"px";}box.style.width=inters.w+"px";box.style.height=inters.h+"px";box.style.display="block";return inters;},getLowestLevelRectangle:function(touch){target=document.elementFromPoint(touch.pageX,touch.pageY);var hiddenStack=[];while(!this.isLowestLevelRectangle(target)){target.style.display="none";hiddenStack.push(target);target=document.elementFromPoint(touch.pageX,touch.pageY);}while(hiddenStack.length){hiddenStack.pop().style.display="block";}return target;},getEntityByTouch:function(touch,getLowest){var entity=null;var pageX=touch.pageX,pageY=touch.pageY;$U.visPrint("#getEntityByTouch#pageX:"+pageX+" pageY:"+pageY);var target=document.elementFromPoint(pageX,pageY),backUps=[];if(!target){$U.visPrint("target is null! at elementFromPoint.");return null;}var lastLevel=target;while(!this.isRectangle(target)&&target!=this.domNode){backUps.push(target);target.style.visibility="hidden";target=document.elementFromPoint(pageX,pageY);if(!target||target==lastLevel){break;}lastLevel=target;}if(getLowest){lastLevel=target;while(target!=this.domNode&&target.tagName.toLowerCase()!="img"){backUps.push(target);target.style.visibility="hidden";target=document.elementFromPoint(pageX,pageY);if(!target||target==lastLevel){break;}lastLevel=target;}}var backLen=backUps.length;while(backUps.length>0){var node=backUps.pop();node.style.visibility="visible";}if(!target){$U.visPrint("target is null. At backups.");return null;}if(target!=this.domNode){if(target.getAttribute("idx")&&!getLowest){var entity=this.getIdxObjectByTarget(target);}else{var rectPosition=mstrmojo.dom.position(this.canvas,true),offsetX=pageX-rectPosition.x,offsetY=pageY-rectPosition.y;var position={x:offsetX,y:offsetY},entity=this.canvasObject.getEntity(position);}}else{}return entity;},getLabelForEntity:function(e){if(!this.props.showMetricValues||e.entityChildren!==undefined){return this.getEntityDisplayName(e);}var index=(e.index===undefined)?e.indices[0]:e.index,st="",si=this.sizeMetricIndex,ci=this.colorMetricIndex,mv=this.model.gvs.items,ml=mv[0].items.length,n,v,dn=this.getEntityDisplayName(e);st='<span style="font-weight:bold;">';if(dn!==""){st+=dn+"<br>";}if(si!=ml){if(e.entityChildren!==undefined||this.aggregated){var tmp=this.aggFunctions[si];v=getSizeValue(e,this);if(isNaN(v)){v="-";}else{if(AggregationType.Cnt!=tmp){fs=this.getFormatString(si);v=this.nf.formatByMask(fs,v);}}}else{v=mv[index].items[si].v;}if(v!==""){st+=v+"<br>";}}if(e.entityChildren===undefined&&ci!=ml&&si!=ci){if(e.entityChildren!==undefined||this.aggregated){var tmp=this.aggFunctions[ci];v=getColorValue(e,this);if(isNaN(v)){v="-";}else{if(AggregationType.Cnt!=tmp){fs=this.getFormatString(ci);v=this.nf.formatByMask(fs,v);}}}else{v=mv[index].items[ci].v;}if(v!==""){st+=v+"<br>";}}st+='</span><span style="font-weight:normal;">';for(var i=0;i<ml;i++){if(i==si){continue;}if(i==ci&&e.entityChildren===undefined&&si!=ci){continue;}if(e.entityChildren!==undefined||this.aggregated){var tmp=this.aggFunctions[i];n=tooltipMacro(n,tmp);v=getAggValue(e,i,this);if(isNaN(v)){v="-";}else{if(AggregationType.Cnt!=tmp){fs=this.getFormatString(i);v=this.nf.formatByMask(fs,v);}}}else{v=mv[index].items[i].v;}if(v!==""){st+=v;if(i!==ml-1){st+="<br>";}}}st+="</span>";return st;},multiTap:true,touchBegin:function(touch){},touchTap:function(touch){if(touch.count>=2){if(this.scaleFactor>1){this.scaleFactor=1;this._scroller.offset.x.start=0;this._scroller.offset.x.end=0;this._scroller.offset.y.start=0;this._scroller.offset.y.end=0;this._scroller.scrollTo(0,0,0);this.refreshWidget();}return ;}var target=touch.target;if(target==this.infoBoxPuppet){target=document.elementFromPoint(touch.pageX,touch.pageY);}if(this.touchLegendTooltipValid(touch)){this.showLegendTooltip(touch);}else{this.hideLegendTooltip();}switch(target){case this.editorButton:target.style.backgroundColor="rgba(51, 181, 229, 0.6)";var callback=function(){mstrmojo.VisHeatMapAnimation.animate(target,"background",{r:51,g:181,b:229,a:0.6},{r:255,g:255,b:255,a:0});};var that=this;setTimeout(function(){setTimeout(function(){try{that.popupEditor(target);}catch(e){}finally{callback();}},0);},0);return ;case this.deleteButton:if(this.previousTooltip){var delDict=this.props.deletedList;var delNode=this.previousTooltip;var keyStack=[];var tempNode=delNode;do{keyStack.push(this.getEntityDisplayName(tempNode));tempNode=tempNode.parentEntity;}while(tempNode.parentEntity);var parentDict,key;for(var i=keyStack.length-1;i>=0;i--){parentDict=delDict;key=keyStack.pop();var tempDict=delDict[key];if(!tempDict){delDict[key]={};tempDict=delDict[key];}delDict=tempDict;}this.deleteNode(delNode,delDict,parentDict,key);this.hideInfoBox();this.refreshWidget();var deleteTreeId=this.id+"-deleteTree";var object=mstrmojo.all[deleteTreeId];if(object){object.needRefresh=true;}}this.previousTooltip=null;break;case this.selectionHighlightBox:this.doSelection(this.previousSelected);break;case this.highlightBox:this.hideInfoBox();var entity=this.previousHighlighted;if(this.hasSelector){if(!this.previousHighlighted.entityChildren){this.doSelection(entity);}}else{if(this.hasLinkDrill){this.doLinkDrill(entity);}}break;default:if(this.isRectangle(target)){if(this.hasSelector){this.hideInfoBox();var entity=this.getEntityByTouch(touch,true);this.doSelection(entity);}else{if(this.hasLinkDrill){var entity=this.getEntityByTouch(touch);this.doLinkDrill(entity);}else{var entity=this.getEntityByTouch(touch);this.showInfoBox(entity);}}break;}else{if(target.parentNode==this.infoBox){this.hideInfoBox();}else{this.hideInfoBox();if(!this.selectAll){this.doSelection(this.previousSelected);}}}}},isRectangle:function(target){if(this.canvasObject.domNode==target.parentNode||(target.parentNode&&this.canvasObject.domNode==target.parentNode.parentNode)||target.tagName.toLowerCase()=="img"){return true;}else{return false;}},isLowestLevelRectangle:function(target){if(target.getAttribute&&target.getAttribute("idx")&&!(target.innerHTML)){return true;}else{return false;}},doLinkDrill:function(entity){if(!entity){return ;}var actionObj=this.getActionObj({entity:entity,type:HYPERLINK_ACTION});if(actionObj){this.highlightEntity(this.selectionHighlightBox,entity);this.performAction([actionObj]);}},getActionObj:function(actionInfo){if(!actionInfo){return null;}var actionType=actionInfo.type,entity=actionInfo.entity,actionObj=null;switch(actionType){case HYPERLINK_ACTION:var rowHeader=this.model.gts.row,rl=rowHeader.length,level=entity.level,attrIndex;for(var i=0;i<=level;i++){var attr=rowHeader[i];if(attr.lm){for(var j=0;j<attr.lm.length;j++){if(attr.lm[j].links){break;}}if(j!=attr.lm.length){attrIndex=i;break;}}}var rowIndex=(entity.index===undefined)?entity.indices[0]:entity.index,ghs=this.model.ghs;if(!isNaN(attrIndex)){var attr=this.model.gts.row[attrIndex];linkDrillNode={};linkDrillNode.titleInfo=attr;linkDrillNode._e=attr.es[ghs.rhs.items[rowIndex].items[attrIndex].idx];actionObj={at:actionType,k:this.getModelKey(),node:linkDrillNode};break;}index=this.firstColLinkDrillIndex;if(!isNaN(index)){var metricH=this.model.gts.col[0],metric=metricH.es[index],lm=metricH.lm[index];if(lm&&lm.links){linkDrillNode={};linkDrillNode.titleInfo=metricH;linkDrillNode.mix=index;actionObj={at:actionType,k:this.getModelKey(),node:linkDrillNode};}break;}break;case SELECTOR_ACTION:var entity=actionInfo.entity,anchor=actionInfo.anchor;if(!entity||!anchor){break;}if(entity){var m=this.model,rown=m.gts.row,rl=rown.length,rhs=m.ghs.rhs.items,index=(entity.index===undefined)?entity.indices[0]:entity.index,row=rhs[index].items,selectorObjects=[];for(var i=0;i<rl;i++){var att=rown[i],sc=att.sc;if(att.otp!=-1&&sc!==undefined){var ix=row[i].idx,elementId=att.es[ix].id,es=att.es[ix].n,eid;if(!elementId||elementId.substring(0,1)==="D"){continue;}if(sc.all!="false"&&sc.all!=false&&actionInfo.needSelectAll){eid=EID_SELECTALL;}else{eid=att.es[ix].id;}selectorObjects.push({sc:sc,es:es,eid:eid});}}actionObj={at:actionType,k:this.getModelKey(),scObjList:selectorObjects,anchor:anchor};}break;case INFOWINDOW_ACTION:var entity=actionInfo.entity,anchor=actionInfo.anchor;if(!entity||!anchor){break;}if(entity){var m=this.model,rown=m.gts.row,rl=rown.length,rhs=m.ghs.rhs.items,index=(entity.index===undefined)?entity.indices[0]:entity.index,row=rhs[index].items,selectorObjects=[];for(var i=0;i<rl;i++){var att=rown[i],sc=att.sc;if(att.otp!=-1&&sc!==undefined){var ix=row[i].idx,elementId=att.es[ix].id,es=att.es[ix].n,eid;if(!elementId||elementId.substring(0,1)==="D"){continue;}if(sc.all!="false"&&sc.all!=false&&actionInfo.needSelectAll){eid=EID_SELECTALL;}else{eid=att.es[ix].id;}selectorObjects.push({sc:sc,es:es,eid:eid});}}actionObj={at:actionType,k:this.getModelKey(),scObjList:selectorObjects,anchor:anchor};}break;default:break;}return actionObj;},getModelKey:function(){return this.model&&this.model.k;},deleteNode:function(node,delDict,parentDict,key){if(!(node.size&&node.size.w&&node.size.h)){return ;}if(!node.entityChildren){node.deleted=true;if(parentDict&&key){if(delDict===delStatus.dftUnDel||delDict===delStatus.dftDel){parentDict[key]=delStatus.dftDel;}else{parentDict[key]=delStatus.usrDel;}}return ;}else{parentDict=delDict;for(var index in node.entityChildren){var thisChild=node.entityChildren[index];key=this.getEntityDisplayName(thisChild);var thisDict=parentDict[key];if(!thisDict){parentDict[key]={};thisDict=parentDict[key];}this.deleteNode(thisChild,thisDict,parentDict,key);}}},toggleSelectAll:function(entity){var sc=this.model.gts.row[entity.level].sc;if((sc&&sc.all!="false"&&sc.all!=false)||!this.hasGridTarget){if(this.selectAll){this.selectAll=false;}else{this.selectAll=true;}return true;}return false;},doSelection:function(entity){if(!entity){return ;}if(entity==this.previousSelected){if(!this.toggleSelectAll(entity)){return ;}var anchor=this.selectionHighlightBox,actionInfo={entity:entity,type:SELECTOR_ACTION,needSelectAll:this.selectAll,anchor:anchor};actionObject=this.getActionObj(actionInfo);if(this.selectAll){this.selectionHighlightBox.style.display="none";delete actionObject.anchor;}else{this.highlightEntity(this.selectionHighlightBox,entity);}this.performAction([actionObject]);}else{this.selectAll=false;var anchor=this.selectionHighlightBox,actionInfo={entity:entity,type:SELECTOR_ACTION,needSelectAll:this.selectAll,anchor:anchor};this.previousSelected=entity;this.highlightEntity(this.selectionHighlightBox,entity);var actionObject=this.getActionObj(actionInfo);this.performAction([actionObject]);}},getObjectByIdx:function(idx){if(idx){var indexArray=idx.split(":");var obj=this.root;for(var i=0;i<indexArray.length;i++){obj=obj.entityChildren[indexArray[i]];}return obj;}return null;},toggleDeleteButton:function(){if(!this.infoBox){return ;}if(this.props.delButtonEnabled){this.deleteButton.style.display="none";this.props.delButtonEnabled=false;}else{this.deleteButton.style.display="block";this.props.delButtonEnabled=true;}},editorDialog:null,popupEditor:function(anchor){this.hideInfoBox();var heatmapId=this.id;var deleteTreeId=heatmapId+"-deleteTree";var editorId=heatmapId+"-editor";var that=this;var defaultSelectionStatus=0;if(this.props.delButtonEnabled){defaultSelectionStatus=1;}var strSettings=mstrmojo.desc(7831,"Settings"),strDeletedItems=mstrmojo.desc(10081,"Deleted Items"),strRefresh=mstrmojo.desc(10378,"REFRESH"),strRTSC=mstrmojo.desc(10082,"Refresh to saved configuration"),strRTDC=mstrmojo.desc(10083,"Refresh to default configuration"),strApply=mstrmojo.desc(10379,"APPLY"),strDelete=mstrmojo.desc(10380,"DELETE"),strEnableDelete=mstrmojo.desc(10085,"Enable Delete"),strRestore=mstrmojo.desc(10084,"Please select elements that you want to restore"),strButtonCancel=mstrmojo.desc(221,"Cancel"),strButtonApply=mstrmojo.desc(134,"Apply");var prop={anchor:this.editorButton,title:"Heat Map",id:editorId,anchorOrientation:"h",owner:this,width:this.LayoutProperties.EditorDialogWidth+"px",contentMaxHeight:this.LayoutProperties.DeletedListHeight,defaultIndex:this.props.navigatingIndex,panels:[{title:strSettings,scriptClass:"mstrmojo.VisHeatMapPopupPanel",width:"100%",height:"100%",children:[{scriptClass:"mstrmojo.Label",text:strRefresh,cssDisplay:"-webkit-box",cssClass:"heatmap-gray-label"},{scriptClass:"mstrmojo.VisHeatMapTree",showIndicators:false,isSelectable:false,cssClass:"simple-tree",cssText:"padding-left:15px;padding-right:15px;",buttonNodeCss:"",items:[{n:strRTSC,buttonNodeWidget:{scriptClass:"mstrmojo.Button",text:strApply,cssClass:"heatmap-apply-button",onclick:function(){that.isUsingSavedColorTheme=true;that.isUsingDefaultColorTheme=false;var node=this.domNode;node.style.backgroundColor="rgba(51, 181, 229, 0.6)";that.hideInfoBox();that.hideLegendTooltip();that._scroller.offset.x.start=0;that._scroller.offset.x.end=0;that._scroller.offset.y.start=0;that._scroller.offset.y.end=0;that._scroller.scrollTo(0,0,0);var callback=function(){mstrmojo.VisHeatMapAnimation.animate(node,"background",{r:51,g:181,b:229,a:0.6},{r:255,g:255,b:255,a:0});};setTimeout(function(){setTimeout(function(){that.useSavedColorTheme(callback);var object=mstrmojo.all[deleteTreeId];if(object){object.needRefresh=true;}},0);},0);}}},{n:strRTDC,buttonNodeWidget:{scriptClass:"mstrmojo.Button",text:strApply,cssClass:"heatmap-apply-button",onclick:function(){that.isUsingSavedColorTheme=false;that.isUsingDefaultColorTheme=true;var node=this.domNode;node.style.backgroundColor="rgba(51, 181, 229, 0.6)";that.hideInfoBox();that.hideLegendTooltip();that._scroller.offset.x.start=0;that._scroller.offset.x.end=0;that._scroller.offset.y.start=0;that._scroller.offset.y.end=0;that._scroller.scrollTo(0,0,0);var callback=function(){mstrmojo.VisHeatMapAnimation.animate(node,"background",{r:51,g:181,b:229,a:0.6},{r:255,g:255,b:255,a:0});};setTimeout(function(){setTimeout(function(){that.useDefaultColorTheme(callback);var object=mstrmojo.all[deleteTreeId];if(object){object.needRefresh=true;}},0);},0);}}}]},{scriptClass:"mstrmojo.Label",text:strDelete,cssDisplay:"-webkit-box",cssClass:"heatmap-gray-label"},{scriptClass:"mstrmojo.VisHeatMapTree",isSelectable:true,cssClass:"simple-tree",cssText:"margin-left:15px;margin-right:15px;",showIndicators:false,defaultSelectionStatus:defaultSelectionStatus,items:[{n:strEnableDelete,itemFunction:function(){that.toggleDeleteButton();}}]},]},{title:strDeletedItems,scriptClass:"mstrmojo.VisHeatMapPopupPanel",cssText:"position: relative",width:"100%",naviAction:function(){var object=mstrmojo.all[deleteTreeId];if(object){object.refresh();}},children:[{scriptClass:"mstrmojo.Box",cssText:"padding-left:16px;padding-right:16px; maxHeight:"+parseInt(this.LayoutProperties.DeletedListHeight*0.89)+"px",children:[{scriptClass:"mstrmojo.VisHeatMapTree",height:"100%",heightLimit:parseInt(this.LayoutProperties.DeletedListHeight*0.89),showIndicators:true,showScrollbars:true,id:deleteTreeId,itemDisplayField:"label",itemChildrenField:"entityChildren",draggable:true,showRoot:true,rootText:strRestore,itemIncludeFunction:function(item){if(item&&(item.deleted||item.hasChildDeleted)){return true;}else{return false;}},apply:function(callback){var itemFunction=function(){if(this.selectionStatus===1&&this.dataProvider&&this.dataProvider.deleted){this.dataProvider.deleted=false;var tempNode=this.dataProvider;if(!tempNode.entityChildren){var keyStack=[];while(tempNode.parentEntity){keyStack.push(that.getEntityDisplayName(tempNode));tempNode=tempNode.parentEntity;}var delDict=that.props.deletedList;while(keyStack.length>1){delDict=delDict[keyStack.pop()];}var key=keyStack.pop();if(delDict[key]===delStatus.dftDel){delDict[key]=delStatus.dftUnDel;}else{delete delDict[key];}}}};var iterator=function(item,itemFunction){itemFunction.apply(item);if(!item.childTree){return ;}for(var i=0;i<item.childTree.length;i++){var subItem=item.childTree[i];iterator(subItem,itemFunction);}};iterator(this,itemFunction);that.refreshWidget();var tree=this;window.setTimeout(function(){tree.needRefresh=true;tree.refresh();if(callback){callback();}},50);},dataProvider:that.root,owner:that}]},{scriptClass:"mstrmojo.Box",cssText:"background-color:whiteSmoke; position:relative; bottom:0px;font:12pt Roboto,Regular;text-align:center;vertical-align:middle;line-height:55px;border-top: 1px solid rgba(34, 34, 34, 0.18);",height:parseInt(this.LayoutProperties.DeletedListHeight*0.11)+"px",width:"100%",children:[{scriptClass:"mstrmojo.Button",text:strButtonCancel,cssClass:"heatmap-tree-button",cssDisplay:"inline-block",cssText:"border-right: 1px solid rgba(34, 34, 34, 0.18); position: absolute; left:0px; top: 0px; height:100%;",width:"49.5%",onclick:function(){var node=this.domNode;node.style.backgroundColor="rgba(51, 181, 229, 0.6)";mstrmojo.VisHeatMapAnimation.animate(node,"background",{r:51,g:181,b:229,a:0.6},{r:255,g:255,b:255,a:0});setTimeout(function(){mstrmojo.all[editorId].close();},100);}},{scriptClass:"mstrmojo.Button",text:strButtonApply,cssClass:"heatmap-tree-button",cssDisplay:"inline-block",cssText:"position: absolute; right:0px; top:0px; height: 100%",width:"50.5%",postBuildRendering:function(){mstrmojo.all[deleteTreeId].register(this);},notify:function(enabled){this.set("enabled",enabled);},onclick:function(){var node=this.domNode;node.style.backgroundColor="rgba(51, 181, 229, 0.6)";that.hideInfoBox();var callback=function(){mstrmojo.VisHeatMapAnimation.animate(node,"background",{r:51,g:181,b:229,a:0.6},{r:255,g:255,b:255,a:0});};setTimeout(function(){setTimeout(function(){mstrmojo.all[deleteTreeId].apply(callback);},0);},0);}}]}]}]};this.editorDialog=mstrApp.showDialog(prop,"HeatMapEditor");},showWaitIcon:function(delay){var w=this.waitIcon;w.style.display="-webkit-box";w.style.left="0px";w.style.top="0px";},hideWaitIcon:function(){var w=this.waitIcon;w.style.left="-100000px";w.style.top="-100000px";},clearChildren:function(node){var firstChild;if(!node){return ;}while(firstChild=node.firstChild){node.removeChild(firstChild);}},calculateValuesInTree:function(){var ml=this.model.gvs.items[0]?this.model.gvs.items[0].items.length:0;clearMaxMinValues.call(this);setShow(false,false,true,true,this.root,this,ml+1);},refreshWidget:function(){this.showWaitIcon();var that=this;var refresh=function(){that.calculateValuesInTree();getLegendMaxMin.call(that);layoutEntities.call(that);that.renderRectangles();that.renderLegend();var ps=that.previousSelected;if(ps){if(ps.deleted){that.selectionHighlightBox.style.display="none";}else{if(!that.selectAll){that.highlightEntity(that.selectionHighlightBox,that.previousSelected);}}}that.hideWaitIcon();};window.setTimeout(refresh,10);},hideInfoBox:function(){if(!this.infoBox){return ;}this.infoBox.style.zIndex="-50";this.infoBox.style.opacity=0;this.previousTooltip=null;},getIdxObjectByTarget:function(target){var ancestor=mstrmojo.dom.findAncestorByAttr(target,"idx",true,this.domNode);var idx=ancestor&&ancestor.value;if(!idx){return null;}var idxObject=this.getObjectByIdx(idx);return idxObject;},showInfoBox:function(entity){if(!entity){return ;}if(!this.infoBox){this.createInfoBox();}var idxObject=entity;if(idxObject===this.previousTooltip){return ;}this.previousTooltip=idxObject;if(this.infoBox.style.display!="block"){this.infoBox.style.display="block";}this.infoBox.style.zIndex="75";this.infoBox.style.opacity=1;var hBoxWidth=this.highlightBoxWidth,domRect=mstrmojo.dom.position(document.body,true),interRect=this.highlightEntity(this.highlightBox,idxObject);if(!interRect||isNaN(interRect.x)){return ;}this.deleteButton.style.left=interRect.x+"px";this.deleteButton.style.top=interRect.y+"px";this.tooltipBox.style.width="";this.tooltipBox.innerHTML=getTooltip(idxObject,this);var anchorBox={x:interRect.x-hBoxWidth,y:interRect.y-hBoxWidth,w:interRect.w+hBoxWidth*2,h:interRect.h+hBoxWidth*2};this.triBox.style.display="block";var anchorCenterX=anchorBox.x+(anchorBox.w>>1);var anchorCenterY=anchorBox.y+(anchorBox.h>>1);var triSize=this.triBox.offsetWidth*0.717;var cNodes=this.tooltipBox.childNodes,len=cNodes.length;for(var i=0;i<len;i++){var cInline=cNodes[i].childNodes;if(cInline[0].offsetWidth+cInline[1].offsetWidth+cInline[2].offsetWidth>cNodes[i].offsetWidth){cInline[0].className+=" heatmap-half-width";}}var tHeight=this.tooltipBox.offsetHeight;var tWidth=this.tooltipBox.offsetWidth;var matched=false;var xFit=((anchorCenterX-(tWidth>>1))>0)&&(anchorCenterX+(tWidth>>1))<(domRect.w);var yFit=((anchorCenterY-(tHeight>>1))>0)&&(anchorCenterY+(tHeight>>1))<(domRect.h);var canShiftPadding=10;function calcPosition(triBox,tooltipBox,deleteButton,canShift){if(canShift===undefined){canShift=false;}if(!matched&&(canShift||yFit)){if(anchorBox.x-triSize-tWidth>=0){matched=true;triBox.style.left=anchorBox.x-triSize+"px";tooltipBox.style.left=anchorBox.x-triSize-tWidth+"px";deleteButton.style.left=interRect.x+interRect.w+"px";}else{if(anchorBox.x+anchorBox.w+triSize+tWidth<=domRect.w){matched=true;triBox.style.left=anchorBox.x+anchorBox.w+triSize+"px";tooltipBox.style.left=anchorBox.x+anchorBox.w+triSize+"px";}}if(matched){var triTop=anchorCenterY;var tooltipTop=anchorCenterY-tHeight/2;if(canShift){if(tHeight+canShiftPadding*2>domRect.h){matched=false;}else{var upLimit=canShiftPadding;var downLimit=domRect.h-canShiftPadding-tHeight;if(tooltipTop<upLimit){tooltipTop=upLimit;}else{if(tooltipTop>downLimit){tooltipTop=downLimit;}}}}triBox.style.top=triTop+"px";tooltipBox.style.top=tooltipTop+"px";}}if(!matched&&(canShift||xFit)){if(anchorBox.y-triSize-tHeight>=0){matched=true;triBox.style.top=anchorBox.y-triSize+"px";tooltipBox.style.top=anchorBox.y-triSize-tHeight+"px";deleteButton.style.top=interRect.y+interRect.h+"px";}else{if(anchorBox.y+anchorBox.h+triSize+tHeight<=domRect.h){matched=true;triBox.style.top=anchorBox.y+anchorBox.h+triSize+"px";tooltipBox.style.top=anchorBox.y+anchorBox.h+triSize+"px";}}if(matched){var triLeft=anchorCenterX;var tooltipLeft=anchorCenterX-tWidth/2;if(canShift){if(tWidth+canShiftPadding*2>domRect.w){matched=false;}else{var leftLimit=canShiftPadding;var rightLimit=domRect.w-canShiftPadding-tWidth;if(tooltipLeft<leftLimit){tooltipLeft=leftLimit;}else{if(tooltipLeft>rightLimit){tooltipLeft=rightLimit;}}}}triBox.style.left=triLeft+"px";tooltipBox.style.left=tooltipLeft+"px";}}}calcPosition(this.triBox,this.tooltipBox,this.deleteButton,false);this.infoBox.style.display="block";if(!matched){anchorBox={x:anchorCenterX,y:anchorCenterY,w:0,h:0};this.triBox.style.display="none";triSize=0;calcPosition(this.triBox,this.tooltipBox,this.deleteButton,true);}if(!matched){this.triBox.style.display="none";this.tooltipBox.style.left=anchorCenterX-tWidth/2+"px";this.tooltipBox.style.top=anchorCenterY-tHeight/2+"px";}this.shadowBox.style.left=this.tooltipBox.style.left;this.shadowBox.style.top=this.tooltipBox.style.top;this.shadowBox.style.width=this.tooltipBox.offsetWidth+"px";this.shadowBox.style.height=this.tooltipBox.offsetHeight+"px";this.shelter.style.left=this.tooltipBox.style.left;this.shelter.style.top=this.tooltipBox.style.top;this.shelter.style.width=this.tooltipBox.offsetWidth+"px";this.shelter.style.height=this.tooltipBox.offsetHeight+"px";var span=this.tooltipBox.childNodes[0].childNodes[0];var style=window.getComputedStyle(span,null);},enableGlobalDismiss:function(){var touchManager=mstrmojo.touchManager;var heatMap=this;this._globalTouchListener=touchManager.attachEventListener("touchesBegin",this.id,function(evt){if(!evt||!evt.touch||!evt.touch.target){return ;}var target=evt.touch.target,backgroundDiv1=document.getElementsByClassName("mstrmojo-DocLayoutViewer-layout")[0],backgroundDiv2=document.getElementsByClassName("mstrmojo-DocSubsection")[0];if(heatMap.infoBoxPuppet!=target&&!mstrmojo.dom.contains(heatMap.infoBox,target,true)){heatMap.hideInfoBox();}if(target!=backgroundDiv1&&target!=backgroundDiv2){return ;}if(!this.selectAll){heatMap.doSelection(heatMap.previousSelected);}});},disableGlobalDismiss:function(){var touchManager=mstrmojo.touchManager;if(this._globalTouchListener){touchManager.detachEventListener(this._globalTouchListener);delete this._globalTouchListener;}},touchInfoBoxValid:function(touch){var taget=touch.target;if(target.id==this.id+"-infobox"){return true;}},touchLegendTooltipValid:function touchValid(touch){var target=touch.target;if(target.id!=this.id+"-color-legend-band"){return false;}var frame=mstrmojo.dom.position(target,true),x=touch.clientX-frame.x,y=touch.clientY-frame.y,p=this.legendBand;if(x<p.x||x>=p.x+p.w-1){return false;}return true;},showLegendTooltip:function(touch){var target=touch.target,frame=mstrmojo.dom.position(target,true),x=touch.clientX-frame.x,y=touch.clientY-frame.y,p=this.legendBand,idx;var ct=this.colorTheme;if(ct.tooltipInfo===undefined||ct.tooltipInfo===null){ct.createTooltipInfo(this.legendTickCount,p.w,this);this.selectedBandIndex=-1;}var i=ct.getTooltipInfo(x-p.x);if(i!=this.selectedBandIndex){this.renderHilightedBand(i);}var t=this.colorTheme.tooltipInfo[i],cfs=this.getFormatString(this.colorMetricIndex),mn=this.getMetricName(this.colorMetricIndex),sign=(t.sign===undefined)?" < ":" > ",str="<div>"+this.nf.formatByMask(cfs,t.sv)+sign+"</div><div class='heatmap-flex'>"+mn+"</div><div>"+sign+this.nf.formatByMask(cfs,t.ev)+"</div>";this.legendTooltip.innerHTML=str;this.legendTooltip.style.borderColor=getCSSColor(t.c);this.legendTooltip.style.lineHeight=this.legendTooltip.style.height;this.legendTooltip.style.display="-webkit-box";var size={w:this.legendTooltip.offsetWidth,h:this.legendTooltip.offsetHeight};var lc=mstrmojo.dom.position(this.colorLegend,true),cv=mstrmojo.dom.position(this.canvas,true),tx=t.r.x+((t.r.w-size.w)>>1);if(tx<0){tx=0;}else{if(tx>frame.w-size.w){tx=frame.w-size.w;}}this.legendTooltip.style.left=tx+"px";this.legendTooltip.style.top=-35+"px";},hideLegendTooltip:function(){if(this.selectedBandIndex===undefined||this.selectedBandIndex==-1){return ;}this.renderGradientBand(this.legendBand);this.selectedBandIndex=-1;this.legendTooltip.style.left="-100000px";},touchSelectBegin:function(touch){if(touch.evt.ctrlKey){this.touchMultiBegin(touch);return ;}var target=touch.target;if(!target){return ;}this.lastTouchSelectTarget=target;if(this.touchLegendTooltipValid(touch)){this.showLegendTooltip(touch);this.hideInfoBox();}else{this.hideLegendTooltip();var entity;if(this.infoWindowMode){entity=this.getEntityByTouch(touch,true);}else{entity=this.getEntityByTouch(touch);}if(!entity){return ;}if(this.timer){cleatTimeout(this.timer);this.timer=null;}if(this.infoWindowMode){this.doSelection(entity);}else{this.showInfoBox(entity);}}},touchSelectMove:function(touch){if(touch.evt.ctrlKey){this.touchMultiMove(touch);return ;}var target=touch.target;if(!target){return ;}if(this.touchLegendTooltipValid(touch)){this.showLegendTooltip(touch);this.hideInfoBox();}else{this.hideLegendTooltip();var entity;if(this.infoWindowMode){entity=this.getEntityByTouch(touch,true);}else{entity=this.getEntityByTouch(touch);}if(!entity){return ;}var that=this;if(this.timer){clearTimeout(this.timer);this.timer=null;}if(this.infoWindowMode){if(this.previousSelected!=entity){this.doSelection(entity);}}else{this.showInfoBox(entity);}}},touchSelectEnd:function(touch){if(touch.evt.ctrlKey){this.touchMultiEnd(touch);}return ;},initScroller:function(scroller){this._scrollMovedHandler=scroller.attachEventListener("scrollMoved",this.id,function(evt){this.hideInfoBox();});this._scrollDoneHandler=scroller.attachEventListener("scrollDone",this.id,function(evt){this.canvasObject.updateOffsets(scroller.origin.x,scroller.origin.y);});},multiTouch:true,touchMultiBegin:function(touch){this.hideLegendTooltip();this.hideInfoBox();var touch1;var touch2;if(touch.evt.touches&&touch.evt.touches.length==2){touch1=touch.evt.touches[0];touch2=touch.evt.touches[1];}else{touch1=touch;touch2={pageX:300,pageY:300};}var xDiff=touch1.pageX-touch2.pageX;var yDiff=touch1.pageY-touch2.pageY;this.initDiffDiff=xDiff*xDiff+yDiff*yDiff;this.initCenterX=((touch1.pageX+touch2.pageX)>>1);this.initCenterY=((touch1.pageY+touch2.pageY)>>1);this.initScrollX=this._scroller.origin.x;this.initScrollY=this._scroller.origin.y;this.relScaleFactor=1;},touchMultiMove:function(touch){var touch1;var touch2;if(touch.evt.touches&&touch.evt.touches.length==2){touch1=touch.evt.touches[0];touch2=touch.evt.touches[1];}else{touch1=touch;touch2={pageX:300,pageY:300};}var xDiff=touch1.pageX-touch2.pageX;var yDiff=touch1.pageY-touch2.pageY;var curDiffDiff=xDiff*xDiff+yDiff*yDiff;var curCenterX=((touch1.pageX+touch2.pageX)>>1);var curCenterY=((touch1.pageY+touch2.pageY)>>1);var scale=Math.sqrt(curDiffDiff/this.initDiffDiff);var offset={x:scale*(this.initCenterX+this.initScrollX)-curCenterX,y:scale*(this.initCenterY+this.initScrollY)-curCenterY};var transform={scale:scale,offset:offset};this.relScaleFactor=scale;if(this.relScaleFactor*this.scaleFactor>=this.maxScale&&!this.oldTransform){this.oldTransform=transform;}this.applyTransform(transform);},touchMultiEnd:function(touch){var finalScale=this.relScaleFactor*this.scaleFactor;if(finalScale<1){var initTransform={offset:{x:0,y:0},scale:1/this.scaleFactor};this.relScaleFactor=initTransform.scale;this.applyTransform(initTransform,500,this.postScale);}else{if(finalScale>this.maxScale){this.relScaleFactor=this.maxScale/this.scaleFactor;this.applyTransform(this.oldTransform,500,this.postScale);delete this.oldTransform;}else{this.postScale();}}},relScaleFactor:1,scaleFactor:1,applyTransform:function(transform,duration,callback){var scl=this._scroller;if(duration===undefined){duration=0;}scl.scrollEl.style.webkitTransformOrigin="left top";scl.transform="scale("+transform.scale+","+transform.scale+")";var scrollX=transform.offset.x,scrollY=transform.offset.y,scrollerOffsetScale=this.scaleFactor*this.relScaleFactor-1,vOffsetEnd=this.heatMapSize.h*scrollerOffsetScale,hOffsetEnd=this.heatMapSize.w*scrollerOffsetScale;scl.offset={y:{start:0,end:vOffsetEnd},x:{start:0,end:hOffsetEnd}};this._scroller.scrollTo(scrollX,scrollY,duration);if(callback){var that=this;setTimeout(function(){callback.apply(that);that=null;},duration);}},postScale:function(){delete this._scroller.transform;this._scroller.scrollTo(this._scroller.origin.x,this._scroller.origin.y,0);this.scaleFactor*=this.relScaleFactor;if(this.scaleFactor>this.maxScale){this.scaleFactor=this.maxScale;}this.refreshWidget();},destroy:function(skipCleanup){if(this.canvasObject){this.canvasObject.destroy();delete this.canvasObject;}if(this.controller){this.controller.onorientationChange=this._onorientationChange;delete this._onorientationChange;}this._super(skipCleanup);if(this.editorDialog){this.editorDialog.destroy();delete this.editorDialog;}}});})();