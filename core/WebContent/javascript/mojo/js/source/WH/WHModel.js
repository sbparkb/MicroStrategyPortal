(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.string","mstrmojo.date","mstrmojo.hash","mstrmojo.array");var $WRAP=mstrmojo.func.wrapMethods,$DT=mstrmojo.date,$H=mstrmojo.hash,$S=mstrmojo.string;var _catalogStr=mstrmojo.desc(9143,"Available tables cache was created at ##. Click Refresh to get the latest tables and update the cache.");var DssCatalogFlags={DssCatalogDefault:0,DssCatalogGetTables:1,DssCatalogGetColumns:2,DssCatalogGetTablePrimaryKeys:4,DssCatalogGetTableForeignKeys:8,DssCatalogGetTableKeys:12,DssCatalogGetTableSize:16,DssCatalogGetTableContent:32,DssCatalogGetColumnCardinality:64,DssCatalogGetColumnContent:128,DssCatalogGetFullCatalog:255,DssCatalogSelectedOnly:256,DssCatalogApplyConnectionMapping:512,DssCatalogAllNamespaces:1024,DssCatalogGetFresh:4096,DssCatalogIgnoreNamespace:8192,DssCatalogIgnoreCase:16384,DssCatalogIgnoreInvalidNames:32768,DssCatalogReuseMatching:65536,DssCatalogReuseCompatible:131072,DssCatalogReuseAny:262144,DssCatalogAugmentExisting:524288,DssCatalogSortDescending:1048576,DssCatalogSortTableNameFirst:2097152,DssCatalogGetNamespaces:16777216,DssCatalogCompareWithMetadata:134217728};var DSSCatalogStateFlags={DssCatalogStateDefault:0,DssCatalogStateSelected:1,DssCatalogStateFresh:2,DssCatalogStateMissing:4,DssCatalogStateUnexpected:8,DssCatalogStateCompatibleSmaller:16,DssCatalogStateCompatibleLarger:32,DssCatalogStateCompatible:64,DssCatalogStateIncompatible:128,DssCatalogStateCompatibilityMask:240,DssCatalogStateFreshTables:256,DssCatalogStateMissingTables:512,DssCatalogStateFreshColumns:1024,DssCatalogStateMissingColumns:2048,DssCatalogStatePartitionMappingTable:65536,DssCatalogStateDummyPartitionMappingTable:131072,DssCatalogStateDummyPartitionSliceTable:262144};var EnumDSSBaseFormType={DssBaseFormDateTime:1,DssBaseFormNumber:2,DssBaseFormText:3,DssBaseFormPicture:4,DssBaseFormUrl:5,DssBaseFormEmail:6,DssBaseFormHTMLTag:7,DssBaseFormDate:8,DssBaseFormTime:9,DssBaseFormSymbol:10,DssBaseFormBigDecimal:11,DssBaseFormPhoneNumber:12};var EnumDssDataType={DssDataTypeReserved:0,DssDataTypeInteger:1,DssDataTypeUnsigned:2,DssDataTypeNumeric:3,DssDataTypeDecimal:4,DssDataTypeReal:5,DssDataTypeDouble:6,DssDataTypeFloat:7,DssDataTypeChar:8,DssDataTypeVarChar:9,DssDataTypeLongVarChar:10,DssDataTypeBinary:11,DssDataTypeVarBin:12,DssDataTypeLongVarBin:13,DssDataTypeDate:14,DssDataTypeTime:15,DssDataTypeTimeStamp:16,DssDataTypeNChar:17,DssDataTypeNVarChar:18,DssDataTypeBigDecimal:30,DssDataTypeCellFormatData:31,DssDataTypeUTF8Char:33};var DataTypeToString={0:"[unknown]",1:"[Signed Integer]",2:"[Unsigned Integer]",3:"[Number]",4:"[Decimal]",5:"[Real]",6:"[Double]",7:"[Float]",8:"[Char]",9:"[VarChar]",10:"[LongVarChar]",11:"[Binary]",12:"[VarBin]",13:"[LongVarBin]",14:"[Date]",15:"[Time]",16:"[TimeStamp]",17:"[NChar]",18:"[NVarChar]",30:"[BigDecimal]",31:"[CellFormatData]",33:"[UTF8Char]"};function decodeHTMLString(input){return $S.decodeHtmlString(input).replace(/&apos;/g,"'");}function getDateObject(modifiedtime){var SEP_SPACE=" ",SEP_DASH="-",SEP_COLUMN=":",value=modifiedtime.split(SEP_SPACE),datevalue=value[0].split(SEP_DASH),timevalue=value[1].split(SEP_COLUMN);return new Date(Date.UTC(datevalue[0],parseInt(datevalue[1],10)-1,datevalue[2],timevalue[0],timevalue[1],timevalue[2]));}function submitRequest(callback,params,showWait){if(showWait){mstrApp.showWait&&mstrApp.showWait();}mstrmojo.xhr.request("POST",mstrConfig.taskURL,$WRAP(callback,{success:mstrmojo.emptyFn,complete:function complete(res){if(showWait){mstrApp.hideWait&&mstrApp.hideWait();}},failure:function failure(res){var msg=res.getResponseHeader("X-MSTR-TaskFailureMsg");if(msg){msg=(msg.length>2000)?msg.substring(0,2000)+"...":msg;mstrmojo.alert(msg.replace(/com\.microstrategy(\.\w+)*: \(?/,"").replace(/\)$/,""));}else{msg=res.responseText;msg=msg&&msg.match(/\[HttpException \(0x80004005\): (.)+\]/);mstrmojo.alert((msg&&msg[0]&&msg[0].replace(/\[HttpException \(0x80004005\): |\]/gi,""))||"Request timed out.");}}}),params);}function nameSorter(a,b){var A=a.n.toString().toLowerCase(),B=b.n.toString().toLowerCase();if(A<B){return -1;}else{if(A>B){return 1;}else{return 0;}}}function verSorter(a,b){return Number(a.db_ver)-Number(b.db_ver);}function loadDSNs(mdl,callback){if(mdl.dsns.length==0){var dsnparams={taskId:"arch.getODBCDSNs"};var dsncb={success:function(res){var dsns=[{n:"select a dsn",des:0}],dsnlist=res.dsns.dsn,length=dsnlist&&dsnlist.length;if(!length){if(dsnlist){dsns.push(dsnlist);}}else{dsnlist.sort(nameSorter);dsns=dsns.concat(dsnlist);}mdl.set("dsns",dsns);if(callback){callback(res);}}};submitRequest(dsncb,dsnparams,true);}else{if(callback){callback();}}}function loadDBMSObjects(mdl,callback){if(mdl.dbms.length==0){var dbmsparams={taskId:"arch.getDBMSObjects"};var dbmscb={success:function(res){var dbms=res.dbmss.dbms;dbms.sort(verSorter);mdl.set("dbms",dbms);loadSuppDBs(mdl,callback);}};submitRequest(dbmscb,dbmsparams,true);}else{loadSuppDBs(mdl,callback);}}function loadSuppDBs(mdl,callback){if(mdl.suppdbs.length==0){var suppdbparams={taskId:"arch.readFileContents",fileNumber:"1"};var suppdbcb={success:function(res){var databases=[],DB=res.DBS.DB,length=DB&&DB.length;if(!length){if(DB){databases.push(DB);}}else{databases=DB;}databases.sort(nameSorter);mdl.set("suppdbs",databases);loadDrivers(mdl,callback);}};submitRequest(suppdbcb,suppdbparams,true);}else{loadDrivers(mdl,callback);}}function loadDrivers(mdl,callback){if(mdl.drivers.length==0){var driversparams={taskId:"arch.getODBCDrivers"};var driverscb={success:function(res){mdl.set("drivers",res.odns.name);loadDSNs(mdl,callback);}};submitRequest(driverscb,driversparams,true);}else{loadDSNs(mdl,callback);}}mstrmojo.WH.WHModel=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.WH.WHModel",dbtbls:{},dbtables:[],cachedStamp:{},dbrs:[],dsns:[],drivers:[],dbms:[],suppdbs:[],namespaces:[],catalogStamp:"",SelDBRoleID:null,SelNameSpaceID:null,usecCache:false,isCloud:false,catalogRefresh:false,loadDBRoles:function(){var mdl=this;var dbrparams={taskId:"getDBInstances",isDataImport:true,reverseOrder:true,verbose:true};var dbrcb={success:function(res){var dbr=res.dbrs,dbrs=[];if(!dbr){mdl.set("dbrs",[]);}else{for(lc=0;lc<dbr.length;lc++){db=dbr[lc];db.n=db.n.toString();db.des=(db&&!(db.des&&mstrApp.isCloudPro)?db.n:db.des+"");db.uCche=(parseInt(db.uCche,10)===1)?true:false;if(db.db_type!=2900){dbrs.push(db);}}mdl.set("dbrs",dbrs);}}};submitRequest(dbrcb,dbrparams,true);},loadDBObjects:function(callback){loadDBMSObjects(this,callback);},_set_SelDBRoleID:function(n,v){var model=this,dbr=model.getDBRle(v);this.SelDBRoleID=v;this.raiseEvent({name:"dbroleSelection",value:v});model.SelNameSpaceID=null;if(dbr&&dbr.uCche){model.usecCache=true;this.getNameSpaces();}else{model.usecCache=false;model.set("namespaces",[{cdid:"",dbrid:v,ns:""}]);model._set_SelNameSpaceID(n,"");}},_set_SelNameSpaceID:function(n,v){this.SelNameSpaceID=v;this.filterText="";this.raiseEvent({name:"namespaceSelection",value:v});},getDBRle:function getDBRle(dbr){var model=this,dbrole,lc=0;for(lc=0;lc<model.dbrs.length;lc++){dbrole=model.dbrs[lc];if(dbrole.did===dbr){return dbrole;}}},getDBRoleType:function getDBRoleType(dbr){var model=this,dbrole,lc=0;for(lc=0;lc<model.dbrs.length;lc++){dbrole=model.dbrs[lc];if(dbrole.did===dbr){return dbrole.db_type;}}return 0;},getNameSpaces:function(){var model=this,dbr=model.SelDBRoleID,flags=DssCatalogFlags.DssCatalogGetNamespaces,tableparams={taskId:"arch.catalogAction",dbrid:dbr,flags:flags},cb={success:function(res){var items=res.xrc.cas;mstrmojo.array.forEach(items,function(item){item.n=item.ns;});model.set("namespaces",res.xrc.cas);},complete:function complete(){model.raiseEvent({name:"loadNamespaces",value:0});}};model.raiseEvent({name:"loadNamespaces",value:1});submitRequest(cb,tableparams,false);},getSelectedDBRoleTables:function(params,callbacks){var model=this,dbr=model.SelDBRoleID,cachedStamp=model.cachedStamp,dbts=model.dbtbls,tp,blockCount=params.blockCount,blockBegin=params.blockBegin,filterText=this.filterText,dbe=model.getDBRle(dbr);if(!dbe){callbacks.success({items:[]});return ;}if(dbe.db_type===3000){callbacks.success({items:[]});return ;}var namespaces=(dbts[dbr]=dbts[dbr]||{}),cachedStampPerDBRole=(cachedStamp[dbr]=cachedStamp[dbr]||{}),currentNamespace=model.SelNameSpaceID+"",_ispopulated=false,result=[],tableArray=[],fullTableList=[],item,cachedDBTables,count=0,supportNamespaceCaching=model.usecCache;currentNamespace=currentNamespace.replace(/&amp;/g,"&");currentNamespace=currentNamespace.replace(/&lt;/g,"<");currentNamespace=currentNamespace.replace(/&gt;/g,">");currentNamespace=currentNamespace.replace(/&quot;/g,'"');if(!model.catalogRefresh&&namespaces&&(cachedDBTables=namespaces[currentNamespace])){$H.forEach(cachedDBTables,function(table,tablename){_ispopulated=true;item={id:table.tbid,n:tablename,did:tablename,st:8405,tag:table,ns:table.ns,items:[]};if(!filterText||tablename.toUpperCase().indexOf(filterText)>-1){tableArray.push(item);}fullTableList.push(item);});if(_ispopulated){model.set("catalogStamp",cachedStampPerDBRole[currentNamespace]);result=tableArray.slice(blockBegin,blockBegin+blockCount);callbacks.success({items:result,sz:tableArray.length,bb:blockBegin,bc:blockCount});model.raiseEvent({name:"dbTablesChange",value:fullTableList});return ;}}cachedDBTables=(namespaces[currentNamespace]={});cachedStampPerDBRole[currentNamespace]=null;var flags=DssCatalogFlags.DssCatalogGetTables;flags=model.catalogRefresh?(flags|DssCatalogFlags.DssCatalogGetFresh):flags;flags=supportNamespaceCaching?flags:(flags|DssCatalogFlags.DssCatalogAllNamespaces);var tableparams={taskId:"arch.catalogAction",dbrid:dbr,flags:flags,ns:currentNamespace},cb={success:function(res){var cas=res.xrc.cas[0],timestamp=cas.timestamp,dbtables=cas.tis,name,namespace;if(timestamp){var di=$DT.getDateJson(getDateObject(timestamp.replace(/&apos;/,"")));timestamp=[$DT.formatDateInfo(di,"yyyy-MM-dd")," ",$DT.formatTimeInfo(di,"hh:mm a")].join("");timestamp=_catalogStr.replace(/##/,timestamp);}cachedStampPerDBRole[currentNamespace]=timestamp;model.set("catalogStamp",timestamp);model.catalogRefresh=false;mstrmojo.array.forEach(dbtables,function(dbtable,idx){name=dbtable.tbn=decodeHTMLString(dbtable.tbn);namespace=dbtable.ns=decodeHTMLString(dbtable.ns);!supportNamespaceCaching&&namespace&&(name=namespace+"."+name);if(!cachedDBTables[name]){cachedDBTables[name]=dbtable;namespaces[namespace]=namespaces[namespace]||{};namespaces[namespace][name]=dbtable;item={n:name,id:dbtable.tbid,ns:namespace,did:name,st:8405,tag:dbtable,items:[]};fullTableList.push(item);if(idx<blockCount){result.push(item);}}});callbacks.success({items:result,sz:dbtables.length,bb:blockBegin,bc:blockCount});model.raiseEvent({name:"dbTablesChange",value:fullTableList});},failure:function(res){callbacks.failure();}};submitRequest(cb,tableparams,false);},getColumnsForDBTable:function getColumnsForDBTable(params,callbacks){var model=this,dbroleid=model.SelDBRoleID,data=params.data,dbtablename=data.n,namespace=data.ns,supportNamespaceCaching=model.usecCache;if(dbroleid){var columns=model.dbtbls[dbroleid][namespace][dbtablename].columns;if(columns){callbacks.success({src:params,items:columns,selDBRole:dbroleid});return ;}var tableNameWithoutNamspace=dbtablename,prefix=namespace+".";if(dbtablename.indexOf(prefix)===0){tableNameWithoutNamspace=dbtablename.substring(prefix.length);}var ctparams={taskId:"arch.catalogAction",dbrid:dbroleid,ns:supportNamespaceCaching?namespace:"",dbts:JSON.stringify([{tbn:supportNamespaceCaching?dbtablename:tableNameWithoutNamspace,ns:namespace}]),flags:DssCatalogFlags.DssCatalogGetColumns},cb={success:function success(res){var columns=res.xrc.cas[0].tis[0].clis,datatype,result=[],columnname;mstrmojo.array.forEach(columns,function(column){datatype=column.dt;columnname=decodeHTMLString(column.cln);result.push({n:columnname,nt:columnname+" "+model.getColumnDataTypeString(datatype.tp),id:column.cmid,sta:column.sta,cln:columnname,did:columnname,dtps:datatype.prec,dtsc:datatype.scl,dttp:datatype.tp,st:26});});model.dbtbls[dbroleid][namespace][dbtablename].columns=result;callbacks.success({src:params,items:result,selDBRole:dbroleid});}};submitRequest(cb,ctparams,false);}},getColumnDataTypeString:function getdi(tp){tp=parseInt(tp,10);return(DataTypeToString[tp]||"[unknown]");}});})();