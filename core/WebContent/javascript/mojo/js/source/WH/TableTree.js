(function(){mstrmojo.requiresCls("mstrmojo.TreeBrowser","mstrmojo.dnd","mstrmojo.dom");mstrmojo.requiresDescs(9142,773,9143);var _D=mstrmojo.dom,_dnd=mstrmojo.dnd;function _createAvatar(k){var w=k.parent;var d=document.createElement("div"),dn=w.parent.parent.domNode;d.className="mstrmojo-wh-avatar";dn.appendChild(d);w.avatar=d;return d;}function _setPosition(av,t,l){av.style.left=l;av.style.top=t;}mstrmojo.WH.TableTree=mstrmojo.declare(mstrmojo.TreeBrowser,null,{scriptClass:"mstrmojo.WH.TableTree",model:null,alias:"DBTableTree",cssClass:"mstrmojo-TreeBrowser mstrmojo-Architect-WarehouseTablesTree",items:[],draggable:true,multiSelect:true,itemDisplayField:"n",useCache:false,noCheckBox:true,ownAvatar:true,itemIdField:"did",blockCount:1000,selectionAcrossBranch:false,listSelector:mstrmojo.ListSelector,branchClickPolicy:mstrmojo.TreeBrowserEnum.BRANCH_POLICY_SELECT,itemFunction:function ifn(item,idx,w){var tree=w.tree||w,iw=new mstrmojo.TreeBrowserNode({data:item,state:0,parent:w,tree:tree,multiSelect:w.multiSelect,text:item[w.itemDisplayField],textCssClass:tree.item2textCss(item),items:item[w.itemChildrenField],itemIdField:w.itemIdField,itemDisplayField:"nt",itemIconField:w.itemIconField,itemChildrenField:w.itemChildrenField,itemFunction:w.itemFunction,listSelector:w.listSelector,draggable:true,ownAvatar:true,getDragData:function(c){return c.src.widget.data;},onmousedown:function omd(evt){if(this.selectedIndex>-1){_dnd.startDragCheck(evt.hWin,evt.e);}},predblclick:function predblclick(evt){var w=evt.src,e=(window.event)?window.event:evt,target=_D.eventTarget(window.event,_D.isFF?e.e:e);if(!target||target.className.indexOf("mstrmojo-TreeNode-state")>-1){return ;}if(target.className.indexOf("t26")>-1){tree.onColumndblclick&&tree.onColumndblclick(evt);}else{if(w.items.length===0){tree.model&&tree.model.getColumnsForDBTable(w,{success:tree.onTabledblclick});}else{tree.onTabledblclick&&tree.onTabledblclick({src:w,items:w.items,selDBRole:tree.model.SelDBRoleID});}}_D.stopPropogation(evt.hWin,evt.e);_D.clearBrowserHighlights(evt.hWin);return false;},isDragValid:function(context){return !(!tree.allowdragstart||!tree.allowdragstart(context));},ondragstart:function ondragstart(context){var data=context.src.data,dataItems=data.items;if(!dataItems){return ;}if(dataItems.length===0){tree.model.getColumnsForDBTable(context.src.widget,{success:function(res){var w=res.src,items=res.items;w.set("items",items);w.data.items=items;}});}var newNode=this.domNode.childNodes[0].cloneNode(true);this.parent.ownAvatar=true;var a=this.parent.avatar||_createAvatar(this);var l=context.src.pos.x+"px";var t=context.src.pos.y+"px";if((data)&&(data.ns.length>1)){newNode.childNodes[2].innerHTML=context.src.data.ns.length;newNode.childNodes[2].style.cssText="font-size:12px; font-weight:900;color:black;";}while(a.hasChildNodes()){a.removeChild(a.lastChild);}a.appendChild(newNode);_setPosition(a,t,l);a.style.display="block";},ondragmove:function ondragmove(ctxt){var t=ctxt.tgt,a=this.parent.avatar;if(a){var l=t.pos.x+1+"px";t=t.pos.y+1+"px";_setPosition(a,t,l);}tree.onItemdragmove&&tree.onItemdragmove(ctxt);},ondragend:function ondragend(ctxt){this.parent.avatar.style.display="none";this.parent.ownAvatar=false;tree.onItemdragend&&tree.onItemdragend(ctxt);},getColumns:function(callbacks){tree.model.getColumnsForDBTable(this,callbacks);}});return iw;},contentRetrieved:true,getContent:function(w,blockBegin){var isRoot=(w===this),tree=this,success=function(res){if(isRoot){mstrmojo.css.removeClass(tree.domNode,["loading"]);}tree.updateTreeContent(w,res);},failure=function(res){w.set("items",[tree.failItemCreaterFunc()]);},callbacks={success:success,failure:failure};if(isRoot){mstrmojo.css.addClass(tree.domNode,["loading"]);}this.getContentThroughTaskCall({isRoot:isRoot,data:w.data,blockBegin:blockBegin||0,blockCount:tree.blockCount},callbacks);},getContentThroughTaskCall:function getContentThroughTaskCall(params,callbacks){var m=this.model;if(params.isRoot){m.getSelectedDBRoleTables(params,callbacks);}else{m.getColumnsForDBTable(params,callbacks);}},isBranch:function isBranch(data){return data.items;},item2textCss:function item2textCss(data){return"mstrmojo-ArchitectListIcon "+{"-1":"failed","-2":"loading","-3":"next","-4":"prev","26":"t26","8405":"t15"}[data.st];},onRender:function onR(){if(this.domNode){this.domNode.style.height=this.height;this.domNode.style.width=this.width;}},onheightChange:function heightchange(evt){if(this.domNode){this.domNode.style.height=parseInt(this.height,10)+"px";}},dbroleSelectHandler:function(evt){var tr=this;tr.set("items",[]);tr.blockBegin=0;tr.getContent(tr);},setSelectedTables:function(items){var res=mstrmojo.array.findMulti(this.items,this.itemIdField,items);this.select(res.indices);}});})();