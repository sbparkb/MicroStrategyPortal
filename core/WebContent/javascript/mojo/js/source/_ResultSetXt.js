(function(){mstrmojo.requiresCls("mstrmojo.prompt.WebPrompts");var CLASS_NAME="mstrmojo._ResultSetXt",STATUS_MISSING=0,STATUS_COMPLETE=1,STATUS_ERROR=2,STATUS_PROMPT=3,STATUS_POLL=4;var URL_LINK_PARAMS=["promptsAnswerXML","elementsPromptAnswers","valuePromptAnswers","objectsPromptAnswers"];function fromLink(params){if(params.linkAnswers){return true;}var len=URL_LINK_PARAMS.length,i;for(i=0;i<len;i++){if(params[URL_LINK_PARAMS[i]]){return true;}}return false;}function resolveStatus(res){if((!res)||(res.status===undefined)||(isNaN(res.status))){return STATUS_MISSING;}switch(parseInt(res.status,10)){case 0:case 1:return STATUS_COMPLETE;case 2:return STATUS_PROMPT;case 3:return STATUS_ERROR;default:return STATUS_POLL;}}function pollForResult(request,isInitialRequest,callback){var fnSuccess=callback.success;delete callback.success;var app=mstrApp,isRefresh=!!request.useRefreshProgress,pst=isRefresh?[mstrmojo.desc(10078,"Refreshing data. Please wait.")]:[],fnPollStatus;delete request.useRefreshProgress;callback.success=function(res,req){switch(resolveStatus(res)){case STATUS_COMPLETE:case STATUS_PROMPT:case STATUS_MISSING:fnSuccess(res,req);break;case STATUS_ERROR:callback.failure(res);break;case STATUS_POLL:var hInterval;callback.success=function(res,req){var pollStatus=resolveStatus(res);switch(pollStatus){case STATUS_COMPLETE:case STATUS_PROMPT:fnSuccess(res,req);break;case STATUS_MISSING:case STATUS_POLL:fnPollStatus();break;default:res.message="Error checking the status of running report/document.";callback.failure(res);break;}};fnPollStatus=function(){app.serverRequest({taskId:"pollStatus",msgID:res.id},callback,{src:CLASS_NAME+"::pollForResult"});};fnPollStatus();break;}};app.serverRequest(request,callback,{src:CLASS_NAME+"::pollForResult",showProgress:isInitialRequest,hideProgress:!isInitialRequest,hideWait:!isInitialRequest,useRefreshProgress:isRefresh,progressStateText:pst});}function execAndPoll(request,callback,isInitialRequest,resParams){var me=this;pollForResult.call(this,request,isInitialRequest,{success:function(res){me.msgId=res.id;if(res.visName){me.visName=res.visName;}var rc=resolveStatus(res);if(rc===STATUS_PROMPT){if(callback.prompts){me.loadPrompts({success:callback.prompts,failure:callback.failure});}else{callback.failure({message:"Wrong status. Received Prompts while expected Result."});}}else{if(callback.execSuccess){callback.execSuccess(res);}if(resParams&&resParams.statusOnly){callback.success(res);}else{if(me.visName&&me.visName!==""){if(!resParams){resParams={};}resParams.colsPerPage=-1;resParams.rowsPerPage=-1;}me.getResults(resParams,{success:callback.success,failure:callback.failure,complete:callback.complete||mstrmojo.emptyFn,canceled:callback.canceled||mstrmojo.emptyFn});}}},failure:callback.failure,complete:callback.complete||mstrmojo.emptyFn,canceled:callback.canceled||mstrmojo.emptyFn});}function getPromptModel(prompts,answers){var factory=mstrApp.modelFactory;if(factory){return factory.newPromptsModel(prompts,answers);}return mstrApp.viewFactory.newPrompts(prompts,answers);}mstrmojo._ResultSetXt=mstrmojo.provide("mstrmojo._ResultSetXt",{_mixinName:"mstrmojo._ResultSetXt",msgId:null,execute:function execute(request,callback,resParams){if(request.link){request.linkAnswers=request.link.toXml();delete request.link;}var me=this,cb=mstrmojo.func.addMethods(callback,{prompts:function(res){me.prompts=res;callback.prompts(res);},success:function(res){if(res.prompt){me.prompts=res.prompt;}callback.success(res);}});if(!me.prompts&&fromLink(request)){cb.success=function(res,req){delete req.config.hideWait;delete req.config.hideProgress;me.loadPrompts({success:function(prm){if(prm.prompts){me.prompts=prm;me.answers=getPromptModel(prm).buildAnswerObject();}callback.success(res,req);},failure:callback.failure,complete:callback.complete||mstrmojo.emptyFn},{includeClosed:true});};}else{if(request.promptsAnswerXML){cb.success=function(res,req){me.prompts=null;me.answers=null;me.loadPrompts({success:function(prm){if(prm.prompts){me.prompts=prm;me.answers=getPromptModel(prm).buildAnswerObject();}callback.success(res,req);},failure:mstrmojo.emptyFn});};}}execAndPoll.call(this,request,cb,true,resParams);},answerPrompts:function answerPrompts(prompts,callback,request){if(mstrApp.useBinaryFormat){request.objectType=55;}request.taskId="answerPrompts";request.msgID=request.msgId||this.msgId;request.promptAnswerXML=prompts.getAnswerXML();var me=this;execAndPoll.call(this,request,{success:function(res){me.answers=prompts.buildAnswerObject();callback.success(res);},prompts:callback.prompts,failure:callback.failure},true);},getResults:function getResults(request,callback){request.messageID=request.msgId||this.msgId;pollForResult.apply(this,[request,false,callback]);},loadPrompts:function loadPrompts(callback,request){request.taskId="getPrompts";request.msgID=request.msgID||this.msgId;pollForResult.apply(this,[request,false,callback]);},linkToObject:function linkToObject(params,callback){this.execute(params,callback);},getPrompts:function getPrompts(){var prompts=this.prompts;if(prompts){return getPromptModel(this.prompts,this.answers);}return undefined;},checkCache:function checkCache(request,callback,config){var cfg=mstrmojo.hash.copy(config,{src:CLASS_NAME+"::checkCache",override:false,silent:true});request.taskId="checkCache";mstrApp.serverRequest(request,callback,cfg);},checkCachedLinkTargets:function checkCachedLinkTargets(items,callback){var request={taskId:"checkCachedLinkTargets",items:items};mstrApp.serverRequest(request,callback,{src:CLASS_NAME+"::checkCachedLinkTargets",override:false,silent:true});},urlLinkParams:function urlLinkParams(){return URL_LINK_PARAMS;}});}());