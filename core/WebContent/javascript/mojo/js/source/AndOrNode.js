(function(){mstrmojo.requiresCls("mstrmojo.TreeNode","mstrmojo._IsExprNode","mstrmojo.array","mstrmojo.dom","mstrmojo.css","mstrmojo.expr","mstrmojo._HasOwnAvatar");var _A=mstrmojo.array,_E=mstrmojo.expr,_D=mstrmojo.dom,_C=mstrmojo.css;function _ndsToMove(me,idxs){var d=me.data,nds=d&&d.nds;if(!nds){return null;}if(idxs){idxs.sort(_A.numSorter);}else{idxs=me.sortSelectedIndices();}if(!idxs.length){return null;}return{idxs:idxs,nds:_A.get(nds,idxs)};}function _noNot(me){var ct=me.ctxtBuilder,iws=ct&&ct.itemWidgets,w=iws&&iws[0],d=w&&w.data;if(d&&d.not&&(iws.length>0)){delete d.not;w.paint();}}mstrmojo.AndOrNode=mstrmojo.declare(mstrmojo.TreeNode,[mstrmojo._IsExprNode,mstrmojo._HasOwnAvatar],{scriptClass:"mstrmojo.AndOrNode",data:null,editable:false,prefixedAndOrEditable:false,markupString:'<div id="{@id}" class="mstrmojo-andor mstrmojo-AndOrNode {@cssClass}"  style="position:relative;{@cssText}" mstrAttach:mousedown><div class="mstrmojo-onhoverparent mstrmojo-andor-prefix" mstrAttach:click><span class="mstrmojo-textset mstrmojo-andor-prefix-text"></span><span class="mstrmojo-onhover-in mstrmojo-andor-tools {@cssClass}">{@_prefixAndOrToolsMarkup}</span></div><div class="mstrmojo-andor-top"></div><div class="mstrmojo-andor-contentsWrapper" style="position:relative"><div class="mstrmojo-andor-contents" style="position:relative;{@itemsContainerCssText}">{@itemsHtml}</div><div class="mstrmojo-ListBase2-dropCue mstrmojo-AndOrNode-dropCue {@cssClass}"><div class="mstrmojo-ListBase2-dropCue-inner mstrmojo-AndOrNode-dropCue-inner"></div></div></div><div class="mstrmojo-andor-bottom"></div></div>',markupSlots:{prefixHoverNode:function(){return this.domNode.firstChild;},prefixNode:function(){return this.domNode.firstChild.firstChild;},prefixAndOrToolsNode:function(){return this.domNode.firstChild.childNodes[1];},itemsContainerPrefix:function(){return this.domNode.childNodes[1];},itemsContainerNode:function(){return this.domNode.childNodes[2].firstChild;},dropCueNode:function(){return this.domNode.childNodes[2].lastChild;},itemsContainerSuffix:function(){return this.domNode.lastChild;},scrollboxNode:function(){return this.domNode;}},markupMethods:{onitemCntChange:function(){_C.toggleClass(this.itemsContainerNode,["multi"],this.itemCnt>2);},onprefixedAndOrEditableChange:function(){_C.toggleClass(this.prefixNode,["editable"],this.prefixedAndOrEditable);},ondataChange:function(){this.prefixNode.innerHTML=this.andOrTxt();},ondropCuePosChange:mstrmojo.TreeNode.prototype.markupMethods.ondropCuePosChange},multiSelect:true,itemIdField:null,init:function(props){this._super(props);this.markupString=this.markupString.replace("{@_prefixAndOrToolsMarkup}",this.getPrefixAndOrToolsMarkup());var d=this.data;if(d){delete this.data;this._set_data(null,d);}},itemCnt:0,postBuildRendering:function(){var ret;this.set("itemCnt",this.items.length);if(this._super){ret=this._super();}_noNot(this);return ret;},preadd:function pa(evt){if(this._super){this._super(evt);}this.set("itemCnt",this.items.length);_noNot(this);},preremove:function prm(evt){if(this._super){this._super(evt);}this.set("itemCnt",this.items.length);_noNot(this);},_set_data:function(n,v){var vWas=this.data,chg=(vWas!==v);if(chg){this.data=v;if(v&&!v.nds){v.nds=[];}this.set("items",v&&v.nds);}return chg;},isDragValid:function isDragValid(){return true;},isSelectableArea:function(el){return false;},getDragData:function(ctxt){var d=this._super(ctxt);if(d&&!d.html){var k=d.et&&_E.ET2TGT[d.et];d.html=k?d[k]&&d[k].n||"":d.n||"";}return d;},remove:function rmv(items,dontConsolidate){var idx=this._super(items);if(idx>-1){var skip=dontConsolidate||this.suppressConsolidation;if(!skip){this.consolidate(false);}}return idx;},move:function(arr,idx){this.suppressConsolidation=true;var ret;if(this._super){ret=this._super(arr,idx);}this.suppressConsolidation=false;return ret;},consolidate:function con(){var p=this.parent;if(!p||!p.remove){return ;}var its=this.items,len=its&&its.length;if(len<2){var it=len?its[0]:null,idx=this.childIndex();if(it){p.add([it],idx);}p.remove(this.data);}},indent:function ind(idxs,cfg){var toIn=_ndsToMove(this,idxs);if(!toIn){return ;}this.remove(toIn.idxs,true);var nds=toIn.nds,fn=cfg&&cfg.fn||this.data&&this.data.fn,bq={et:_E.ET.ANDOR,nds:nds,fn:fn};if(nds.length===2&&nds[0].not){if(nds[1].not){delete nds[0].not;delete nds[1].not;bq.not=true;bq.fn=(fn===_E.FN.AND?_E.FN.OR:_E.FN.AND);}else{var tmp=nds[0];nds[0]=nds[1];nds[1]=tmp;}}this.add([bq],toIn.idxs[0]);this.consolidate(false);},outdent:function oud(idxs){var p=this.parent,pd=p&&p.data;if(!pd||pd.et!==_E.ET.ANDOR){return ;}var toOut=_ndsToMove(this,idxs);if(!toOut){return ;}this.remove(toOut.idxs,true);if(this.data.not){toOut.nds[0].not=true;}p.add(toOut.nds,this.childIndex());this.consolidate(false);},edit:function edt(c,fn,not){if(!c){return ;}var d=this.data,fnWas=d&&d.fn,cd=c.data,notWas=cd&&cd.not;if(!cd){cd={};c.data=cd;}cd.not=!!not;if(fnWas!==fn){var nds=d.nds;if(nds&&nds.length>2){var idx=c.childIndex();if(idx>0){this.indent([idx-1,idx],{fn:fn});}}else{d.fn=fn;var ct=this.ctxtBuilder,iws=ct&&ct.itemWidgets;for(var i=0,len=(iws&&iws.length)||0;i<len;i++){var w=iws[i];if(w){w.paint();}}}}else{c.paint();}},preclick:function pc(evt){var p=null,t=_D.eventTarget(evt.hWin,evt.e);if(t===this.prefixNode){}else{if(_D.contains(this.prefixNode,t,true)){p="andor";}}evt.part=p;},createAvatar:function createAvatar(node){var avatar=document.createElement("div"),conditionNode=_D.findWidget(node),avatarNode=conditionNode.getAvatarNode&&conditionNode.getAvatarNode();if(!avatarNode){avatarNode=conditionNode.condNode.cloneNode(true);avatarNode.style.boxSizing="border-box";avatarNode.style.width=conditionNode.condNode.offsetWidth+"px";}avatar.appendChild(avatarNode);_C.addClass(avatar,conditionNode.avatarCssCls||"mstrmojo-FE mstrmojo-ConditionNode");avatar.style.zIndex=20;return avatar;},_ndsToMove:_ndsToMove});})();