(function(){mstrmojo.requiresCls("mstrmojo.ListBoxBase","mstrmojo._HasScrollbox");mstrmojo.ListBox=mstrmojo.declare(mstrmojo.ListBoxBase,[mstrmojo._HasScrollbox],{scriptClass:"mstrmojo.ListBox",renderAllItems:false,renderPause:10,numPagesRendered:0,pageStatus:null,_rc:null,_totalPages:null,_rh:null,_rhMin:8,_rowsPerPage:null,_defaultRowsPerPage:100,_minRowsPerPage:100,_pageHeight:null,buildRendering:function bldRnd(){if(this.renderAllItems===true){this._super();return true;}this._initPageSettings();var tmp=this.items;this.items=this._rc?this.items.slice(0,Math.min(this._rowsPerPage,this._rc)):[];this._super();this.items=tmp;this.postRenderPage(0,true);if(this._rc>this._rowsPerPage){this.itemsContainerNode.style[mstrmojo.css.MINHEIGHT]=(this._rh*this._rc)+"px";if(!this.connectedScrollbox){this.connectScrollbox(this);this.connectedScrollbox=true;}}else{this.postRenderingCleanup();}},_initPageSettings:function initPgSet(){var its=this.items;this._rc=(its&&its.length)||0;var ir=this.itemRenderer;this._rh=(ir&&ir.rowHeight)||this._rhMin||3;var rpp=this._defaultRowsPerPage;if(!isNaN(this.scrollboxHeight)){rpp=Math.ceil(this.scrollboxHeight/this._rh);rpp=Math.max(rpp,this._minRowsPerPage);}this._rowsPerPage=rpp;this._totalPages=Math.ceil(this._rc/this._rowsPerPage);this._pageHeight=this._rh*this._rowsPerPage;this._pageStatus=new Array(this._totalPages);this._numPagesRendered=0;},onscroll:function onscroll(){if(!this._renderingRows){this._startPageRenderThread();}},_startPageRenderThread:function startRndrThd(){this.renderingRows=true;var me=this,renderTimer=this._renderTimer=self.setInterval(function(){if(!me){self.clearInterval(renderTimer);return ;}var pages=me.getPagesToRender();if(pages.length>0){me.renderPages(pages);}else{me.renderingRows=false;self.clearInterval(me._renderTimer);delete me._renderTimer;if(me.isRenderingComplete()){me.postRenderingCleanup();}me=null;}},this.renderPause);},getPagesToRender:function getPagesToRender(){var pages=[],pageSize=this._pageHeight,tBodies=null,stats=this._pageStatus,me=this;function pageHeight(idx){var stat=stats[idx];if(stat&&stat.filled){if(!stat.height){if(!tBodies){tBodies=me.itemsNode.tBodies;}stat.height=tBodies[idx].offsetHeight;}return stat.height;}else{return pageSize;}}var y=0,topPageIdx=null,bottomPageIdx=null,scrollTop=this.scrollboxTop;for(var i=0,len=this._totalPages;i<len;i++){y+=pageHeight(i);if(y>=scrollTop){topPageIdx=i;break;}}if(topPageIdx==null){topPageIdx=bottomPageIdx=len-1;}else{var scrollBottom=this.scrollboxBottom;for(var j=topPageIdx+1;j<len;j++){if(y>=scrollBottom){bottomPageIdx=j-1;break;}y+=pageHeight(j);}}if(bottomPageIdx==null){bottomPageIdx=len-1;}for(var n=this._numPagesRendered;n<topPageIdx;++n){pages.push({idx:n,fill:false});}for(var m=topPageIdx;m<=bottomPageIdx;++m){var stat=stats[m];if(!stat||!stat.filled){pages.push({idx:m,fill:true});}}return pages;},renderPages:function renderPages(pages){for(var i=0,len=pages.length;i<len;++i){this.renderPage(pages[i].idx,pages[i].fill);}},renderPage:function renderPage(idx,bFillCells){var arrStatus=this._pageStatus,alreadyRendered=(this._numPagesRendered>=idx+1);if(alreadyRendered){if(!bFillCells||(arrStatus[idx]&&arrStatus[idx].filled)){return ;}}var rpp=this._rowsPerPage,start=idx*rpp,end=Math.min(start+rpp,this._rc)-1;var tempTableCont=this.tempTableCont;if(!tempTableCont){tempTableCont=this.tempTableCont=this.domNode.ownerDocument.createElement("div");}var tInnerHTML=bFillCells?this._buildItemsMarkup(start,end,'<table><tbody idx="'+idx+'">',"</tbody></table>",this._itemPrefix&&this._itemPrefix(),this._itemSuffix&&this._itemSuffix()).join(""):'<table><tbody idx="'+idx+'"><tr><td style="height:'+this._pageHeight+'px">&nbsp;</td></tr></tbody></table>';tempTableCont.innerHTML=tInnerHTML;var tbody=tempTableCont.firstChild.tBodies[0],tn=this.itemsNode;if(!alreadyRendered){tn.appendChild(tbody);}else{tn.replaceChild(tbody,tn.tBodies[idx]);}this.postRenderPage(idx,bFillCells);},postRenderPage:function pstRndPg(idx,bFillCells){if(idx+1>this._numPagesRendered){this._numPagesRendered=idx+1;}var arr=this._pageStatus,status=arr[idx];if(!status){status=arr[idx]={};}if(bFillCells){status.filled=true;}if(idx>0&&idx==this._totalPages-1){this.itemsContainerNode.style[mstrmojo.css.MINHEIGHT]="";}},isRenderingComplete:function isRdrComplete(){if(this._numPagesRendered==this._totalPages){for(var arr=this._pageStatus,i=this._totalPages-1;i>-1;i--){if(!arr[i]||!arr[i].filled){return false;}}return true;}return false;},postRenderingCleanup:function pstRndClnup(){if(this.connectedScrollbox){this.disconnectScrollbox(this);this.connectedScrollbox=false;}},unrender:function(ignoreDom){this.postRenderingCleanup();this._super(ignoreDom);},refresh:function refresh(){if(!this.hasRendered){return ;}var d=this.domNode,p=d&&d.parentNode;if(!this.parent&&p){var elTemp=d.ownerDocument.createElement("span");p.insertBefore(elTemp,d);}this.unrender();if(!this.parent&&p){this.domNode=elTemp;}this.render();if(this.defn&&this.defn.set){this.defn.set("readyState",mstrmojo.EnumReadystate.IDLE);}}});})();