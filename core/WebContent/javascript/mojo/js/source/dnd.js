(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.hash");var $DOM=mstrmojo.dom,$HASH=mstrmojo.hash,$DND,$DOC=mstrmojo.global.document,EVT_MOUSE_DOWN="mousedown",EVT_MOUSE_MOVE="mousemove",EVT_MOUSE_UP="mouseup";function onMouseDown(e){if($DOM.isPrimaryMouseBtn(e)){$DND.startDragCheck(self,e);}}var avatar,avatarFirstChild,CSS_AVATAR="mstrmojo-dnd-avatar",avatarStyle;function updateAvatar(pos,html){if(html!==undefined&&html!==null){avatarFirstChild.innerHTML=html;}avatarStyle.left=pos.x+"px";avatarStyle.top=pos.y+"px";}function showAvatar(pos,html){if(!avatar){avatar=$DOC.createElement("div");avatarStyle=avatar.style;avatar.className=CSS_AVATAR;avatar.innerHTML='<div class="'+CSS_AVATAR+'-inner"></div>';avatarFirstChild=avatar.firstChild;$DOC.body.appendChild(avatar);}updateAvatar(pos,html);avatarStyle.display="block";}function hideAvatar(){if(avatarStyle){avatarStyle.display="none";}}function onMoveDuringCheck(e){var c=++$DND.ctxt.moveCount;if(c>=$DND.minMoves){$DND.stopDragCheck();if((e.buttons===1||e.buttons===undefined||$DOM.isIE9)&&(e.which===1||e.button===0||$DOM.isIE8)){$DND.startDrag(self,e);}}}function onUpDuringCheck(e){if($DOM.isPrimaryMouseBtn(e)){$DND.stopDragCheck();delete $DND.ctxt;}}function onMoveDuringDrag(e){$DND.onDragMove(self,e);}function onUpDuringDrag(e){if($DOM.isPrimaryMouseBtn(e)){$DND.stopDrag(window,e);}}function captureEventInfo(info){var rtn=mstrmojo.hash.copy(info,{}),win=rtn.hWin=rtn.hWin||window,evt=rtn.e=rtn.e||win.event;rtn.node=$DOM.eventTarget(win,evt);rtn.pos=$DOM.getMousePosition(evt,win);return rtn;}function findDraggable(nd){var w=$DOM.findWidget(nd);while(w){if(w.draggable){return w;}w=w.parent;}return null;}function getVerifiedDragWidget(context){var src=context.src,widget=findDraggable(src.node);if(!widget){return null;}if(widget.getDragAction){context.action=widget.getDragAction(context);}src.widget=widget;src.data=widget.getDragData&&widget.getDragData(context);if(widget.isDragValid){if(!widget.isDragValid(context)){if(!widget.shouldDragBubble||widget.shouldDragBubble(context)!==true){context.src.node=widget.domNode.parentNode;return getVerifiedDragWidget(context);}return null;}}if(widget.ondragstart){widget.ondragstart(context);}return widget;}function findDropWidget(node,context){var w=$DOM.findWidget(node),targetWidget=context.tgt&&context.tgt.widget;while(w){if(w.dropZone){if(w===targetWidget){return w;}if(w.allowDrop&&w.allowDrop(context)){return w;}}w=w.parent;}return null;}function defaultDragLeaveHandler(){if(this.set){this.set("allowingDrop",false);}}mstrmojo.dnd=mstrmojo.dnd||mstrmojo.provide("mstrmojo.dnd",{minMoves:3,enable:function(){if(!mstrmojo.dndEnabled){$DOM.attachEvent($DOC,EVT_MOUSE_DOWN,onMouseDown);mstrmojo.dndEnabled=true;}},disable:function(){mstrmojo.dndEnabled=false;$DOM.detachEvent($DOC,EVT_MOUSE_DOWN,onMouseDown);},startDragCheck:function(hWin,e){delete this.ctxt;var src=captureEventInfo({hWin:hWin,e:e});this.ctxt={src:src,moveCount:0,last:$HASH.copy(src.pos),getDirection:function(axis){return !!this.dir[axis];},getCtxtDragData:function(){var src=this.src;return(src&&src.data)||{};},getCtxtDropData:function(){var tgt=this.tgt;return(tgt&&tgt.data)||{};}};if(this.minMoves){$DOM.attachEvent($DOC,EVT_MOUSE_MOVE,onMoveDuringCheck);$DOM.attachEvent($DOC,EVT_MOUSE_UP,onUpDuringCheck);}else{this.startDrag(hWin,e);}},stopDragCheck:function(){$DOM.detachEvent($DOC,EVT_MOUSE_MOVE,onMoveDuringCheck);$DOM.detachEvent($DOC,EVT_MOUSE_UP,onUpDuringCheck);},startDrag:function(hWin,e){var context=this.ctxt;context.id=mstrmojo.now();var widget=getVerifiedDragWidget(context);if(!widget){return ;}$DOM.clearBrowserHighlights(hWin);$DOM.preventDefault(self,e);$DOM.attachEvent($DOC,EVT_MOUSE_MOVE,onMoveDuringDrag);$DOM.attachEvent($DOC,EVT_MOUSE_UP,onUpDuringDrag);var app=window.mstrApp;if(app&&app.setInteractive){this._changeAppStatus=app.setInteractive(false);}if(!widget.ownAvatar){var src=context.src;showAvatar(src.pos,src.data&&src.data.html);}},stopDrag:function(hWin,e){$DOM.detachEvent($DOC,EVT_MOUSE_MOVE,onMoveDuringDrag);$DOM.detachEvent($DOC,EVT_MOUSE_UP,onUpDuringDrag);var context=this.ctxt,lastTarget=context.tgt||{},ct=captureEventInfo({hWin:hWin,e:e,data:lastTarget.data}),widget=findDropWidget(ct.node,context);ct.widget=widget;context.tgt=ct;if(widget){if(widget.ondrop){widget.ondrop(context);}else{defaultDragLeaveHandler.call(widget);}}var s=context.src.widget;if(s&&s.ondragend){s.ondragend(context);}if(s&&!s.ownAvatar){hideAvatar();}if(this._changeAppStatus){window.mstrApp.setInteractive(true);delete this._changeAppStatus;}},onDragMove:function(hWin,e){if($DOM.isSafari){$DOM.clearBrowserHighlights();}var context=this.ctxt,lastTarget=context.tgt||{},lastTargetWidget=lastTarget.widget,evtInfo=captureEventInfo({hWin:hWin,e:e,data:lastTarget.data}),dropWidget=evtInfo.widget=findDropWidget(evtInfo.node,context),lastPosition=context.last,currentPosition=evtInfo.pos;context.dir={x:currentPosition.x>lastPosition.x,y:currentPosition.y>lastPosition.y};context.last=$HASH.copy(evtInfo.pos);context.tgt=evtInfo;if(lastTargetWidget!==dropWidget){if(lastTargetWidget){if(lastTargetWidget.ondragleave){lastTargetWidget.ondragleave(context);}else{defaultDragLeaveHandler.call(lastTargetWidget);}}if(dropWidget){context.tgt.data=(dropWidget.getDropData&&dropWidget.getDropData(context))||{};if(dropWidget.ondragenter){dropWidget.ondragenter(context);}else{if(dropWidget.set){dropWidget.set("allowingDrop",true);}}}}if(dropWidget){if(dropWidget.ondragover){dropWidget.ondragover(context);}}var sourceWidget=context.src.widget;if(sourceWidget&&sourceWidget.ondragmove){sourceWidget.ondragmove(context);}if(sourceWidget&&!sourceWidget.ownAvatar){updateAvatar(evtInfo.pos);}}});$DND=mstrmojo.dnd;$DND.enable();}());