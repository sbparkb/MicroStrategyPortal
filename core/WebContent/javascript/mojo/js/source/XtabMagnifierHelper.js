(function(){mstrmojo.requiresCls("mstrmojo.TouchScroller","mstrmojo.dom");var LOCK_OFF=0,LOCK_ROW=1,LOCK_COL=2,LOCK_BOTH=3,TAB_INFO="CellInfo",TAB_DRILL="Drill",TAB_LINK="Link",TOUCH_OFFSET=25,CONTENT_LINE_HEIGHT=40,TITLE_HEIGHT=55,TITLE_BORDER_HEIGHT=6,MAX_ENTRIES=4,isTablet=false,CSS_TAB="InfoViewer-Tab",CSS_TAB_WRAPPER="InfoViewer-TabWrapper",CSS_SCOLL_TAB="InfoViewer-nTab",CSS_SHOW_ALL="showAll",CSS_DRILL_TO="drillTo",CSS_LINK_TO="linkTo",CSS_GLOW="glow",$CSS=mstrmojo.css,EVENT_HANDLERS=[];EVENT_HANDLERS[CSS_TAB]=EVENT_HANDLERS[CSS_SCOLL_TAB]=function(dom){var cssClass=dom.className;if(cssClass==CSS_TAB){cssClass=dom.parentNode.className;}for(var i=0,len=this.tabs.length;i<len;i++){if(cssClass.indexOf(this.tabs[i].name)>-1){this.setCurrentTab(i);break;}}this.xtab.magnifier.resizeAndPosition();};EVENT_HANDLERS[CSS_DRILL_TO]=function(){mstrApp.closeDialog();this.xtab.controller.onDrill(this.xtab,this.drillPaths[0].act);};EVENT_HANDLERS[CSS_LINK_TO]=function(dom){mstrApp.closeDialog();this.xtab.controller.onLink(this.xtab,this.linkPaths[dom.getAttribute("lnk")].act);};EVENT_HANDLERS[CSS_SHOW_ALL]=function(dom){this.tabs[this.currentTabIndex].expanded=true;$CSS.removeClass(this.xtab.magnifier.containerNode,"hideMore");this.xtab.magnifier.resizeAndPosition();};mstrmojo.XtabMagnifierHelper=mstrmojo.declare(mstrmojo.Obj,null,{xtab:null,cellInfo:null,selectedCell:null,drillPaths:null,linkPaths:null,tabs:[],currentTabIndex:0,init:function(props){this._super(props);isTablet=mstrApp.isTablet();var dpi=mstrMobileApp.getDeviceDPI();if(dpi<=120){CONTENT_LINE_HEIGHT=26;TITLE_HEIGHT=35;TOUCH_OFFSET=15;}else{if(dpi<=160){CONTENT_LINE_HEIGHT=35;TITLE_HEIGHT=46;TOUCH_OFFSET=20;}else{if(dpi<=213){CONTENT_LINE_HEIGHT=46;TITLE_HEIGHT=61;TOUCH_OFFSET=26;}else{if(dpi<=240){CONTENT_LINE_HEIGHT=53;TITLE_HEIGHT=69;TOUCH_OFFSET=30;}else{CONTENT_LINE_HEIGHT=70;TITLE_HEIGHT=92;TOUCH_OFFSET=40;}}}}if(!isTablet){MAX_ENTRIES=3;}this.titleHeight=TITLE_HEIGHT;},glowOnTap:function(dom){var glowCssClass=[CSS_TAB_WRAPPER,CSS_SHOW_ALL,CSS_DRILL_TO,CSS_LINK_TO],cssClass=dom.className;if(cssClass==CSS_TAB){dom=dom.parentNode;cssClass=dom.className;}for(var i=0,len=glowCssClass.length;i<len;i++){if(cssClass.indexOf(glowCssClass[i])>-1){$CSS.addClass(dom,CSS_GLOW);setTimeout(function(){$CSS.removeClass(dom,CSS_GLOW);},200);break;}}},handleTouchTap:function(dom){this.glowOnTap(dom);for(n in EVENT_HANDLERS){if(dom.className.indexOf(n)>-1){EVENT_HANDLERS[n].call(this,dom);}}},handleTouchSwipe:function(touch){if(!isTablet){var directionX=touch.direction.x,delta=touch.delta,idx=this.currentTabIndex,tabLen=this.tabs.length,totalWidth=parseInt(this.xtab.magnifier.width,10),minDeltaX=isNaN(totalWidth)?50:totalWidth*0.2;if(Math.abs(delta.x)>minDeltaX){if(delta.x>0){idx=(idx+tabLen-1)%tabLen;}else{idx=(idx+tabLen+1)%tabLen;}if(idx!=this.currentTabIndex){this.setCurrentTab(idx);this.xtab.magnifier.resizeAndPosition();}}}},resolveTouchEvent:function(touch){var x=touch.pageX,y=touch.pageY,dom=document.elementFromPoint(x,y),xtab=this.xtab,zones=xtab.zones,td,z;while(dom){var c=dom.className;if(!td&&dom.tagName==="TD"&&c&&c.toLowerCase().indexOf("xtab-td")>=0){td=dom;}if(/mstrmojo-XtabZone/.test(c)){for(var i in zones){if(dom==zones[i].domNode){z=zones[i];}}break;}dom=dom.parentNode;}if(td&&z){return{cell:td,zone:z,pos:{x:x-TOUCH_OFFSET,y:y-TOUCH_OFFSET,w:TOUCH_OFFSET*2,h:TOUCH_OFFSET*2}};}return null;},resolveInfoToDisplay:function(touchObj){var td=touchObj.cell,zone=touchObj.zone,xtab=this.xtab,lv=xtab.lockHeadersCase,r=parseInt(td.getAttribute("r"),10),colTitleCell,umCells,row,i,tdIndex,si,rhc,colIdx,c,cs,i,iLen,j,jLen,k,kLen,listOfPairs=[],me=this,addPair=function(title,value,isSelected){if(isSelected){me.selectedCell=value;listOfPairs.unshift({title:title,value:value});}else{listOfPairs.push({title:title,value:value});}};delete this.selectedCell;if(lv==LOCK_OFF||lv==LOCK_ROW){r=r-(Math.max(xtab.titlesCP.rc,xtab.chsCP.rc)||0);}else{if(zone.slot=="_TR"||zone.slot=="_TL"){r=-1;}}if(r<0){colTitleCell=xtab.getCellForNode(td);if(colTitleCell&&colTitleCell.o!==undefined){addPair(xtab.model.getCellTitleInfo(colTitleCell).title,colTitleCell,true);}else{return null;}}else{umCells=xtab.rhsCP.getUnmergedCells(r)||[];row={rh:umCells.concat(xtab.rhsCP.getRowCells(r)),vs:xtab.valuesCP.getRowCells(r),ch:[]};for(i=0,iLen=xtab.chsCP.rc;i<iLen;i++){row.ch.push(xtab.chsCP.getRowCells(i));}tdIndex=td.cellIndex;if(lv==LOCK_OFF||lv==LOCK_COL||zone.slot=="_BL"){if(td.parentNode.sectionRowIndex===0){si=tdIndex;}else{si=tdIndex+umCells.length;}}else{si=tdIndex+row.rh.length;}rhc=row&&row.rh.length;if(si>=rhc){si-=rhc;for(j=0,jLen=row.ch.length;j<jLen;j++){colIdx=0;for(k=0,kLen=row.ch[j].length;k<kLen;k++){c=row.ch[j][k];cs=(c&&c.cs)||1;if((si>=colIdx)&&(si<colIdx+cs)){if(c.mix!==undefined){addPair(c,row.vs[si],true);}else{if(c.ui!=null||c.tui!=null){addPair(xtab.model.getCellTitleInfo(c).title,c);}}break;}colIdx+=cs;}}if(!this.selectedCell){addPair(null,row.vs[si],true);}si=-1;}for(i=0,iLen=rhc;i<iLen;i++){c=row.rh[i];addPair(xtab.model.getCellTitleInfo(c).title,c,i==si);if(i==si){break;}}}this.cellInfo=listOfPairs;if(this.cellInfo){this.tabs=[];this.tabs.push({name:TAB_INFO,label:mstrmojo.desc(10638,"Info"),expanded:false,content:this.cellInfo});var selectedCell=this.selectedCell,drillable=(selectedCell.v!==undefined)&&!!(selectedCell.at&1),linkable=!!(selectedCell.at&4);if(drillable){this.drillPaths=[];this.drillPaths.push({n:xtab.model.getCellDrillsInfo(selectedCell).n,act:xtab.model.getDrillAction([selectedCell])});this.tabs.push({name:TAB_DRILL,label:mstrmojo.desc(145,"Drill"),expanded:false,content:this.drillPaths});}else{this.drillPaths=null;}if(linkable){this.linkPaths=[];var lInf=xtab.model.getCellLinksInfo(selectedCell);for(var i=0,len=lInf.links.length;i<len;i++){this.linkPaths.push({n:lInf.links[i].n,act:xtab.model.getLinkAction(selectedCell,i)});}this.tabs.push({name:TAB_LINK,label:mstrmojo.desc(8149,"Link"),expanded:false,content:this.linkPaths});}else{this.linkPaths=null;}}return this.cellInfo;},createTitle:function(parentNode){var mks=[],i=0,tabs=this.tabs,len=tabs.length,tab,idx;for(;i<len;i++){tab=tabs[i];if(isTablet){mks.push('<div class="',CSS_TAB_WRAPPER," ",tab.name,'" style="height:'+(TITLE_HEIGHT-TITLE_BORDER_HEIGHT)+'px;" >');mks.push('<div class="',CSS_TAB,'">',tab.label,"</div>");mks.push("</div>");}else{mks.push('<div class="',CSS_SCOLL_TAB," ",tab.name,'" >',tab.label,"</div>");}}parentNode.style.lineHeight=parentNode.style.height=TITLE_HEIGHT+"px";parentNode.innerHTML=mks.join("");this.setCurrentTab();},createContent:function(parentNode){var info=this.cellInfo,drillPaths=this.drillPaths,linkPaths=this.linkPaths,mks=[],rows=[],xtab=this.xtab,addPair=function(l,r,selected){function _cellMarkup(c,cs){var cmk=[],lineHeight=(cs==="value"&&!isTablet)?CONTENT_LINE_HEIGHT/2:CONTENT_LINE_HEIGHT;cmk.push('<td><div class="',cs,'" style="line-height:',lineHeight,"px;max-height:",CONTENT_LINE_HEIGHT,'px;" >');if(c){if(c.ts==4){var imgURL=(c.n||c.v),ds=xtab.controller&&xtab.controller.model&&xtab.controller.model.dataService;if(ds&&ds.getImage){imgURL=ds.getImage(imgURL);}cmk.push('<img src="'+imgURL+'"/>');}else{cmk.push(c.n||c.v||"&nbsp;");}}cmk.push("</div></td>");return cmk.join("");}rows.push('<tr style="height:',CONTENT_LINE_HEIGHT,'px">',_cellMarkup(l,"title"),_cellMarkup(r,"value"),"</tr>");},i,len;if(info==null){return ;}for(i=0,len=info.length;i<len;i++){addPair(info[i].title,info[i].value);}mks.push('<table class="content">');mks.push(rows.join(""));mks.push("</table>");if(drillPaths){mks.push('<div class="actionMenu hide">');for(var i=0,len=drillPaths.length;i<len;i++){mks.push('<div class="drillTo" style="line-height:',CONTENT_LINE_HEIGHT,'px">',drillPaths[i].n,"</div>");}mks.push("</div>");}if(linkPaths){mks.push('<div class="actionMenu hide">');for(var i=0,len=linkPaths.length;i<len;i++){mks.push('<div class="linkTo" style="line-height:',CONTENT_LINE_HEIGHT,'px" lnk="',i,'">',linkPaths[i].n,"</div>");}mks.push("</div>");}mks.push('<div class="',CSS_SHOW_ALL,'" style="line-height:',CONTENT_LINE_HEIGHT,'px" >'+mstrmojo.desc(8995,"See all...")+"</div>");parentNode.innerHTML=mks.join("");},setCurrentTab:function(idx){var tabIndex=idx||0,tabs=this.tabs,tab=tabs[tabIndex],tabLen=tabs.length,magnifier=this.xtab.magnifier,tabs=magnifier.titleNode.children,contents=magnifier.containerNode.children,i,len,contentInfo;this.currentTabIndex=tabIndex;for(i=0;i<tabLen;i++){$CSS.toggleClass(tabs[i],"selected",i==tabIndex);if(!isTablet){if(tabLen<=2){$CSS.toggleClass(tabs[i],"left",i!=tabIndex);}else{$CSS.toggleClass(tabs[i],"left",i==(tabIndex+tabLen-1)%tabLen);}$CSS.toggleClass(tabs[i],"right",i==(tabIndex+tabLen+1)%tabLen);}}for(i=0,len=contents.length-1;i<len;i++){$CSS.toggleClass(contents[i],"hide",i!=tabIndex);if(i==tabIndex){this.contentNode=contents[i];}}$CSS.toggleClass(magnifier.containerNode,"hideMore",!tab.expanded&&tab.content.length>MAX_ENTRIES);},getContentHeight:function(){function calculateHeight(tab){var content=tab.content,entryNum=content.length,expanded=tab.expanded;return(!expanded&&entryNum>MAX_ENTRIES)?(CONTENT_LINE_HEIGHT+1)*(MAX_ENTRIES+1):(CONTENT_LINE_HEIGHT+1)*entryNum;}var tabs=this.tabs;if(isTablet){return calculateHeight(tabs[this.currentTabIndex]);}else{var max=0;for(var i=0,len=tabs.length;i<len;i++){max=Math.max(calculateHeight(tabs[i]),max);}return max;}}});}());