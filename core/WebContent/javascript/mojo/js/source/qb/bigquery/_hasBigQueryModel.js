(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.string","mstrmojo.Obj","mstrmojo.hash","mstrmojo.array","mstrmojo.warehouse.EnumDataChangeEvents","mstrmojo.architect.EnumColumnDataTypes");var $WRAP=mstrmojo.func.wrapMethods,$H=mstrmojo.hash,$A=mstrmojo.array,$S=mstrmojo.string,Enum_OT_COLUMN=26,Enum_OT_TABLE=15,STR_UNKNOWN=mstrmojo.desc(11428,"[unknown]"),COLUMN_TYPES=mstrmojo.architect.EnumColumnDataTypes,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents,DBTABLES_CHANGED=$ENUM_DATA_CHANGE_EVENTS.DBTABLES_CHANGED;function getColumnDataTypeString(dt){var name,tp=dt.tp;name=(tp===undefined?dt:COLUMN_TYPES[tp].n);return("["+(name||STR_UNKNOWN)+"]");}function decodeHTMLString(input){return $S.decodeHtmlString(input).replace(/&apos;/g,"'");}mstrmojo.qb.bigquery._hasBigQueryModel=mstrmojo.provide("mstrmojo.qb.bigquery._hasBigQueryModel",{projects:[],datasets:[],warehouseTables:{},selectedProject:undefined,selectedDataset:undefined,getColDataType:function getColDataType(srcData){var tp=srcData.dt.tp;return tp===undefined?srcData.dt:tp;},loadDBRoles:function loadDBRoles(callback){var $this=this;mstrApp.getRootController().getDataService().submitRequest($WRAP({success:function(res){var projects=res.mi.gbqht.gbqp,projectItems=[],name;if(!projects){projects=[];}if(!(projects instanceof Array)){projects=[projects];}$A.forEach(projects,function(project){name=project.n||project.id;projectItems.push($H.copy({did:String(project.id),n:name,des:name,tp:29,isPrimary:function isPrimary(){return this.data.isPrimary;},data:{isPrimary:false}},project));});$this.set("projects",projectItems);$this.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBROLES_LOADED,items:projectItems});}},callback),{taskId:"qBuilder.FetchSourceObjects",dbRoleID:mstrApp.dbrid,sourceAccountID:mstrApp.said,flags:64});},_set_selectedProject:function set_selectedProject(n,projectID){var model=this;this.selectedProject=projectID;this.selectedDataset=undefined;this.SelDBRoleID=undefined;this.set("SelDBRoleID",mstrApp.dbroleID);$A.forEach(model.projects,function(item){if(item.data.isPrimary){item.data.isPrimary=false;model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED,item:item});}if(item.did==projectID){item.data.isPrimary=true;model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED,item:item});}});this.getDatasets();},getAccountInfo:function getAccountInfo(said,dbrid,callback){mstrApp.getRootController().getDataService().submitRequest({success:function(res){callback&&callback(res);}},{taskId:"qBuilder.FetchSourceObjects",sourceAccountID:said,dbRoleID:dbrid,flags:2,showWait:true});},getProject:function getProject(projectId){var result=null;$A.forEach(this.projects,function(project){if(projectId===project.id){result=project;return false;}});return result;},getDatasets:function getDatasets(){var $this=this,projectID=$this.selectedProject;$this.raiseEvent({name:DBTABLES_CHANGED,items:[],selectedItems:[]});$this.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.NAMESPACES_REQUESTED});mstrApp.getRootController().getDataService().submitRequest({success:function(res){var datasets=res.mi.gbqht.gbqp.gbqd,items=[];if(!datasets){datasets=[];}if(!(datasets instanceof Array)){items.push({n:datasets.id||""});}else{$A.forEach(datasets,function(dataset){items.push({n:dataset.id});});}$this.datasets=items;$this.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.NAMESPACES_CHANGED,namespaces:items,usecCache:items.length,dbRoleID:projectID});}},{taskId:"qBuilder.FetchSourceObjects",dbRoleID:mstrApp.dbrid,sourceAccountID:mstrApp.said,gbqpid:projectID,flags:64,showWait:true});},onselectedDatasetChange:function onselectedDatasetChange(evt){this.selectedDataset=evt.value;this.getDatasetTables({blockBegin:0,blockCount:1000,filterText:""});},getDatasetTables:function getDatasetTables(params,callback){var model=this,projectID=model.selectedProject,datasetID=model.selectedDataset,filterText=params.filterText,item,isPopulated=false,filteredArray=[],fullTableList=[],tableCollection;tableCollection=model.warehouseTables[projectID]=model.warehouseTables[projectID]||{};if(!model.catalogRefresh&&datasetID&&(tableCollection[datasetID]!==undefined)){$H.forEach(tableCollection[datasetID],function(table,tablename){isPopulated=true;item={id:table.id,n:tablename,did:tablename,dbtn:tablename,st:8405,tag:table,ns:table.ns,tp:Enum_OT_TABLE,isVisible:function isVisible(){},items:[]};if(filterText!==""&&tablename.toUpperCase().indexOf(filterText.toUpperCase())>-1){filteredArray.push(item);}fullTableList.push(item);});if(isPopulated){model.raiseEvent({name:DBTABLES_CHANGED,items:(filterText!=="")?filteredArray:fullTableList,selectedItems:[]});return ;}}model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBTABLES_REQUESTED,sourceInfo:params.sourceInfo||""});mstrApp.getRootController().getDataService().submitRequest({success:function(res){var dataset=res.mi.gbqht.gbqp.gbqd,tables=dataset&&dataset.gbqt,items=[],tableName,tableHash;model.catalogRefresh=false;model.selectedDataset=datasetID=dataset.id;tableHash=tableCollection[datasetID]={};if(!tables){tables=[];}if(!(tables instanceof Array)){tables=[tables];}$A.forEach(tables,function(table){tableName=table.id;item={n:tableName,id:tableName,ns:projectID+":"+datasetID,did:tableName,dbtn:tableName,st:8405,tag:table,tp:Enum_OT_TABLE,isVisible:function(data,item){return model.handleVisibleAction(data,item);},isChecked:function(data,item){return model.handleCheckAction(data,item);},isEnabled:function(data,item){return model.handleEnabledAction(data,item);},items:[]};tableHash[tableName]=item;items.push(item);});model.raiseEvent({name:DBTABLES_CHANGED,items:items,selectedItems:[]});}},{taskId:"qBuilder.FetchSourceObjects",dbRoleID:mstrApp.dbrid,sourceAccountID:mstrApp.said,gbqpid:projectID,dsid:datasetID,flags:64,showWait:true});},getColumnsForDBTable:function getColumnsForDBTable(params,callbacks){var model=this,projectID=model.selectedProject,getFresh=params.getFresh,data=params.data,datasetID=data.datasetID||model.selectedDataset,tableID=data.did,tableName=data.n,columns;if(!getFresh){columns=model.warehouseTables[projectID]&&model.warehouseTables[projectID][datasetID][tableID].columns;if(columns){callbacks.success({src:params,items:columns,selDBRole:datasetID});model.raiseEvent({name:"dbTablesPopulated",items:{id:tableID,n:tableName,items:columns}});if(callbacks&&callbacks.complete){callbacks.complete();}return ;}}mstrApp.getRootController().getDataService().submitRequest($WRAP({success:function success(res){var columns=res.mi.gbqcs.gbqc,result=[],columnname;$A.forEach(columns,function(column){columnname=decodeHTMLString(column.id);result.push({n:columnname+": "+getColumnDataTypeString(column.dt),cln:column.id,dt:column.dt,id:column.id,did:columnname,st:26,tp:Enum_OT_COLUMN,isVisible:function isVisible(){}});});if((result.length>0)&&!getFresh){model.warehouseTables[projectID][datasetID][tableID].columns=result;}res.items=result;}},callbacks),{taskId:"qBuilder.FetchSourceObjects",dbRoleID:mstrApp.dbrid,sourceAccountID:mstrApp.said,gbqpid:projectID,dsid:datasetID,tbid:tableID,flags:1,showWait:false});}});}());