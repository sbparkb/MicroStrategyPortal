(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.css","mstrmojo.string","mstrmojo.qb.QBTableView","mstrmojo.qb.FFsqlEditor","mstrmojo.Label","mstrmojo.Table","mstrmojo.Button");mstrmojo.requiresDescs(2827,9130,9137,9141,9215,9927,12378,12417,13403);var $S=mstrmojo.string,$CSS=mstrmojo.css,$DESC=mstrmojo.desc,CSS_CLASS_ON="on",$ENUM_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents;var ENUM_EDITOR_MODE_QB=1,ENUM_EDITOR_MODE_FFSQL=2;var FFSQLEmptyPrompt=mstrmojo.desc(9215,"Type multi-pass SQL or double-click a table name");mstrmojo.qb.Button=mstrmojo.declare(mstrmojo.Button,null,{scriptClass:"mstrmojo.qb.Button",markupString:'<div id="{@id}" class="mstrmojo-Button mstrmojo-qb-Button {@cssClass} {@iconClass}" title="{@title}" style="{@cssText}" mstrAttach:touchstart,click,mousedown,mouseup><div class="mstrmojo-qb-Button-icon {@innerIconClass}"></div><div class="mstrmojo-Button-text mstrmojo-qb-Button-text {@innerIconClass}"></div></div>',markupSlots:{iconNode:function(){return this.domNode.firstChild;},textNode:function(){return this.domNode.lastChild;}},postBuildRendering:function(){var rtn;if(this._super){rtn=this._super();}var me=this;this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-A",refNode:this.domNode,posType:mstrmojo.tooltip.POS_TOPLEFT,top:32,content:this.text||""});if(!this._ontooltipover){this._ontooltipover=function(e){var textNode=me.textNode;if(textNode.offsetWidth<textNode.scrollWidth){me.showTooltip(e,self);}};this._ontooltipout=function(e){var textNode=me.textNode;if(textNode.offsetWidth<textNode.scrollWidth){me.hideTooltip(e,self);}};}mstrmojo.dom.attachEvent(this.domNode,"mouseover",this._ontooltipover);mstrmojo.dom.attachEvent(this.domNode,"mouseout",this._ontooltipout);return rtn;}});mstrmojo.qb.QBPanel=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.qb.QBPanel",markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},cssText:"position:relative;",mode:ENUM_EDITOR_MODE_QB,children:[{scriptClass:"mstrmojo.Box",alias:"header",cssClass:"mstrmojo-qb-tableview-toolbar",children:[{scriptClass:"mstrmojo.qb.Button",iconClass:"mstrmojo-qb-tableview-toolbarIcon play",text:$DESC(9130,"Execute SQL"),postCreate:function postCreate(){var evtConfig={},listConfig=evtConfig[this.id]={};listConfig[$ENUM_DATA_CHANGE_EVENTS.DBTABLES_ENABLED]=function(evt){this.set("enabled",evt.value);};mstrApp.getRootController().attachDataChangeListeners(evtConfig);},onclick:function(){var controller=mstrApp.getRootController(),panel=this.parent.parent;if(panel.mode===ENUM_EDITOR_MODE_QB){controller.autoMap();}else{controller.autoMapFFSQL(panel.SQL.ffsql.getSQLstmt());}}},{scriptClass:"mstrmojo.qb.Button",iconClass:"mstrmojo-qb-tableview-toolbarIcon erase",text:$DESC(2827,"Clear"),bindings:{visible:function(){return this.parent.parent.mode===ENUM_EDITOR_MODE_FFSQL;}},postCreate:function postCreate(){var evtConfig={},listConfig=evtConfig[this.id]={};listConfig[$ENUM_DATA_CHANGE_EVENTS.DBTABLES_ENABLED]=function(evt){this.set("enabled",evt.value);};mstrApp.getRootController().attachDataChangeListeners(evtConfig);},onclick:function onclick(){var ffsqlEditor=this.parent.parent.SQL,ffsqlInput=ffsqlEditor.ffsql,controller=mstrApp.getRootController();ffsqlInput.clearTokens();ffsqlEditor.updatepasses();controller.autoMapFFSQL("");if(controller.canAddTableSQL(true,"")){controller.enableAvailableTables();}}},{scriptClass:"mstrmojo.qb.Button",iconClass:"mstrmojo-qb-tableview-toolbarIcon refresh",text:$DESC(9927,"Update Tables"),bindings:{visible:function(){return(this.parent.parent.mode===ENUM_EDITOR_MODE_QB&&!mstrApp.isBigQuery);}},onclick:function(){mstrApp.getRootController().updateTableStructure();}},{scriptClass:"mstrmojo.Label",cssClass:"condition",text:$DESC(12378,"Filter..."),postBuildRendering:function postBuildRendering(){var me=this;mstrApp.getRootController().attachEventListener("reportModeChange",this.id,function(evt){me.set("visible",evt.mode!==2);});var rtn;if(this._super){rtn=this._super();}this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-A",refNode:this.domNode,posType:mstrmojo.tooltip.POS_TOPLEFT,top:32,content:$DESC(12378,"Filter...")});if(!this._ontooltipover){this._ontooltipover=function(e){me.showTooltip(e,self);};this._ontooltipout=function(e){me.hideTooltip(e,self);};}mstrmojo.dom.attachEvent(this.domNode,"mouseover",this._ontooltipover);mstrmojo.dom.attachEvent(this.domNode,"mouseout",this._ontooltipout);return rtn;},onclick:function(){mstrApp.getRootController().openConditionDialog();}},{scriptClass:"mstrmojo.Button",cssClass:"FFSQL_QB_converter",useRichTooltip:true,richTooltip:{cssClass:"vi-regular vi-tooltip-A",top:32,posType:mstrmojo.tooltip.POS_TOPLEFT},bindings:{text:function(){var isQB=this.parent.parent.mode===ENUM_EDITOR_MODE_QB;return isQB?$DESC(9137,"Edit SQL"):$DESC(13403,"Switch to Build a Query");},visible:function(){return !mstrApp.isFFSQL;}},onclick:function(){if(!mstrApp.isCloudPro||mstrApp.said){mstrApp.getRootController().convertMode(this.parent.parent.mode===ENUM_EDITOR_MODE_QB);}},postBuildRendering:function postBuildRendering(){var me=this;var rtn;if(this._super){rtn=this._super();}var content;if(!this._ontooltipover){this._ontooltipover=function(evt){if(evt.relatedTarget!==me.domNode&&evt.relatedTarget!==me.domNode.childNodes[0]){content=mstrApp.isCloudPro?$DESC(12417,"View SQL"):$DESC(9137,"Edit SQL");me.richTooltip.refNode=me.domNode;if(me.parent.parent.mode===ENUM_EDITOR_MODE_QB){mstrApp.getRootController().getSQLPreview({success:function success(sqlstmt){me.richTooltip.content=sqlstmt?content+"<br><br>"+sqlstmt.replace("\n","<br>"):content;me.showTooltip(evt,self);},failure:function failure(){me.richTooltip.content=content;me.showTooltip(evt,self);}});}else{me.richTooltip.content=me.text;me.showTooltip(evt,self);}}};this._ontooltipout=function(evt){me.hideTooltip(evt,self);};}mstrmojo.dom.attachEvent(this.domNode,"mouseover",this._ontooltipover);mstrmojo.dom.attachEvent(this.domNode,"mouseout",this._ontooltipout);return rtn;}}]},{scriptClass:"mstrmojo.qb.QBTableView",cssClass:"mstrmojo-qb-tableview on",alias:"tables",bindings:{visible:function(){return(this.parent.mode===ENUM_EDITOR_MODE_QB);}}},{scriptClass:"mstrmojo.qb.FFsqlEditor",cssClass:"mstrmojo-qb-ffsqlview",alias:"SQL",bindings:{visible:function(){return(this.parent.mode===ENUM_EDITOR_MODE_FFSQL);}}}],enterMode:function enterMode(evt){var mode=evt.mode;this.set("mode",mode);var isFFSQLMode=(mode===ENUM_EDITOR_MODE_FFSQL);this.tables.set("visible",!isFFSQLMode);$CSS.toggleClass(this.tables.domNode,CSS_CLASS_ON,!isFFSQLMode);$CSS.toggleClass(this.SQL.domNode,CSS_CLASS_ON,isFFSQLMode);this.SQL.set("visible",isFFSQLMode);if(isFFSQLMode){var ffsqleditor=this.SQL.ffsql;ffsqleditor.updateSQL(evt);}else{this.tables.scrollBox.linker.drawLinks();}},onheightChange:function(e){if(this.domNode&&this.header.domNode){this.tables.set("height",parseInt(e.value,10)-this.header.domNode.clientHeight+"px");this.SQL.set("height",this.tables.height);}},onwidthChange:function onwidthChange(evt){if(this.width!=="NaNpx"){this.tables.set("width",this.width);this.SQL.set("width",this.width);}},postBuildRendering:function postBR(){if(this._super){this._super();}var controller=mstrApp.getRootController();controller.attachEventListener("reportModeChange",this.id,this.enterMode);controller.attachEventListener("addCandidateTables",this.SQL.ffsql.id,"addCandidateTables");}});}());