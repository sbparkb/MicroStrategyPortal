(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.qb.DBTableView","mstrmojo.qb.EnumDataChangeEvents","mstrmojo.qb.EnumDragActions","mstrmojo.qb.EnumMenuActions","mstrmojo.dom","mstrmojo.hash","mstrmojo.array");var $DOM=mstrmojo.dom,$H=mstrmojo.hash,$ARR=mstrmojo.array,$PX="px",$ENUM_DATA_CHANGE_EVENTS=mstrmojo.qb.EnumDataChangeEvents,EVENT_REMOVE=$ENUM_DATA_CHANGE_EVENTS.REMOVE,DRAG_ACTION_ADD_TABLE=mstrmojo.qb.EnumDragActions.ADD_TABLE;function refreshTables(evt){var tableData=evt.item,tableID=evt.did||tableData.id,evtName=evt.name;$ARR.forEach(this.children,function(table){if(table.isItemAvailable(tableID)){var handled=table.handleEvent(evt);if(!handled){switch(evtName){case EVENT_REMOVE:this.removeTable(table.tableData);break;}}}},this);}mstrmojo.qb.TableContainer=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.qb.TableContainer",markupString:'<div id="{@id}" class="mstrmojo-qb-TableContainer {@cssClass}" style="{@cssText}"><div class="mstrmojo-qb-tc-container"></div></div>',markupSlots:{containerNode:function containerNode(){return this.domNode.lastChild;}},init:function init(props){this._super(props);var evtConfig={},tableConfig=evtConfig[this.id]={};tableConfig[$ENUM_DATA_CHANGE_EVENTS.TABLES_ADDED]=function selTableIDChange(evt){$ARR.forEach(evt.tableItems,function(tableData){this[((evt.toAdd?"add":"remove")+"Table")](tableData);},this);};tableConfig[$ENUM_DATA_CHANGE_EVENTS.TABLE_CHANGED]=tableConfig[$ENUM_DATA_CHANGE_EVENTS.RENAME]=tableConfig[EVENT_REMOVE]=refreshTables;},addTable:function addTable(tableData){var tableContainer=this,tables=this.children,tableID=tableData.id;$ARR.forEach(tables,function(table){if(table.isItemAvailable(tableID)){this.removeTable(tableData);}},this);if((tableData.x===undefined)||(tableData.y===undefined)){var cascadingPadding=25*(tables?tables.length:0)+$PX;tableData=$H.copy({x:cascadingPadding,y:cascadingPadding},tableData);}tableContainer.addChildren([new mstrmojo.qb.DBTableView({tableData:tableData,left:tableData.x,top:tableData.y,linker:this.parent.linker})]);},removeTable:function removeTable(tableData){var tableContainer=this,tableID=tableData.id;$ARR.forEach(this.children,function(table,idx){if(table.getTableID()===tableID){tableContainer.removeChildren(tableContainer.children[idx]);mstrApp.getRootController().removeFromCurrentLayer(table.tableData);return false;}return true;});},updateTablePositionCache:function updateTablePositionCache(){var tables=this.children,containerPosition=$DOM.position(this.domNode),items=[];$ARR.forEach(tables,function(table){var tablePosition=$DOM.position(table.domNode);items.push($H.copy({x:((tablePosition.x-containerPosition.x)+$PX),y:((tablePosition.y-containerPosition.y)+$PX),h:tablePosition.h+$PX,w:tablePosition.w+$PX},table.tableData));});mstrApp.getRootController().setTablePositions(items);},refresh:function refresh(updateCache){if(updateCache){this.updateTablePositionCache();}this.removeChildren();$ARR.forEach(mstrApp.getRootController().getTablePositions(),function(table){this.addTable(table);},this);},dropZone:true,allowDrop:function allowDrop(context){return DRAG_ACTION_ADD_TABLE.indexOf(context.action)!==-1;},ondrop:function ondrop(context){var dragEvent=context.action,contextSrc=context.src;if(contextSrc&&contextSrc.data){var dragData=contextSrc.data;if(dragEvent===DRAG_ACTION_ADD_TABLE){var currentPosition=context.tgt.pos,basePosition=mstrmojo.dom.position(context.tgt.node);dragData.x=currentPosition.x-basePosition.x+$PX;dragData.y=currentPosition.y-basePosition.y+$PX;mstrApp.getRootController().addWHTable([dragData],true);}}}});}());