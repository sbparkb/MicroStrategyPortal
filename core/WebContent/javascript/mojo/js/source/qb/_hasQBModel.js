(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.string","mstrmojo.form","mstrmojo.qb.ExpressionEditor","mstrmojo.qb.MissingColumnWarning","mstrmojo.qb.DataService","mstrmojo.warehouse.EnumDataChangeEvents");mstrmojo.requiresDescs(218,219,1442,9220,9221,9222,9223,9224,9225,9226,9227,9228,9229,9230,9945,9946,11164);var _S=mstrmojo.string,_H=mstrmojo.hash,_A=mstrmojo.array,_C=mstrmojo.css,_HELPER=mstrmojo.DI.DIHelpers,constants=mstrmojo.DI.DIConstants,$DECODEHTML=_S.decodeHtmlString,$ENUM_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents,$FOUR_SPACE="    ",_DEFAULT_TEMPLATE_ID="A61B85F4485D3B953003B195E58B5138",_twipPerPixel=15,DEFAULT_HEIGHT=200,DEFAULT_WIDTH=200,DEFAULT_POSITION_TOP=0,DEFAULT_POSITION_LEFT=0,BDE_FUNCTIONS=["0DFE6FB4356F4FA2A0C1C10D0B415355","375104850C3E45EA889D9F5FEB37D317","B2C0FA4020C711D6AD1400C04F0423DE","B2C0FA4120C711D6AD1400C04F0423DE","9AD889E56E4D4E56A127207B4AF77166","AB08D4FC700B4EE58C021BFA2ABD77D0","993F6897863E43CFBEA4969F68BBDED7","C50F2A4F75AE49D6B20E00224967B500","0150F348CB0B4D9AB8CCA458C1ACC4B0","6F7DF5F2449111D5BEA300B0D01A55EF","6F7DF5F3449111D5BEA300B0D01A55EF","6F7DF5F4449111D5BEA300B0D01A55EF","6F7DF5FB449111D5BEA300B0D01A55EF","6F7DF5FE449111D5BEA300B0D01A55EF","6F7DF5FC449111D5BEA300B0D01A55EF","6F7DF5F6449111D5BEA300B0D01A55EF","A9A5B40DF7204F27A04AB3C74225477E","B651EC29A3074BA68F31DE99FC300AF7","7C63D4E70B2741C3A5B54A2EFD40961B","6F7DF5F7449111D5BEA300B0D01A55EF","6F7DF5FD449111D5BEA300B0D01A55EF","6F7DF5F5449111D5BEA300B0D01A55EF","6F7DF5F8449111D5BEA300B0D01A55EF","2146A148C528458181CD816CD96E71D3","8F090B600594488A8FF89A5867C78973","8107C33EDD9911D3B98100C04F2233EA","8107C33FDD9911D3B98100C04F2233EA","6F7DF5FF449111D5BEA300B0D01A55EF","8107C357DD9911D3B98100C04F2233EA","6F7DF606449111D5BEA300B0D01A55EF","6F7DF609449111D5BEA300B0D01A55EF","6F7DF600449111D5BEA300B0D01A55EF","6F7DF601449111D5BEA300B0D01A55EF","6F7DF602449111D5BEA300B0D01A55EF","6F7DF603449111D5BEA300B0D01A55EF","6F7DF608449111D5BEA300B0D01A55EF","6F7DF604449111D5BEA300B0D01A55EF","6F7DF605449111D5BEA300B0D01A55EF","6F7DF607449111D5BEA300B0D01A55EF","8107C347DD9911D3B98100C04F2233EA","8107C327DD9911D3B98100C04F2233EA","F262C811DDA611D3B98100C04F2233EA","F262C812DDA611D3B98100C04F2233EA","F262C813DDA611D3B98100C04F2233EA","F262C830DDA611D3B98100C04F2233EA","F262C814DDA611D3B98100C04F2233EA","F262C815DDA611D3B98100C04F2233EA","F262C816DDA611D3B98100C04F2233EA","F262C817DDA611D3B98100C04F2233EA","F262C818DDA611D3B98100C04F2233EA","F262C819DDA611D3B98100C04F2233EA","F262C81ADDA611D3B98100C04F2233EA","F262C81BDDA611D3B98100C04F2233EA","F262C81CDDA611D3B98100C04F2233EA","F262C81DDDA611D3B98100C04F2233EA","F262C81EDDA611D3B98100C04F2233EA","F262C81FDDA611D3B98100C04F2233EA","F262C820DDA611D3B98100C04F2233EA","F262C821DDA611D3B98100C04F2233EA","F262C822DDA611D3B98100C04F2233EA","F262C831DDA611D3B98100C04F2233EA","F262C824DDA611D3B98100C04F2233EA","F262C825DDA611D3B98100C04F2233EA","F262C826DDA611D3B98100C04F2233EA","F262C828DDA611D3B98100C04F2233EA","F262C829DDA611D3B98100C04F2233EA","5CCBF590DAB311D5AD0E00C04F0423DE","F262C82ADDA611D3B98100C04F2233EA","F262C82BDDA611D3B98100C04F2233EA","F262C82CDDA611D3B98100C04F2233EA","F262C82DDDA611D3B98100C04F2233EA","F262C82EDDA611D3B98100C04F2233EA","F262C82FDDA611D3B98100C04F2233EA","A202C222DD9D11D3B98100C04F2233EA","A202C223DD9D11D3B98100C04F2233EA","A202C224DD9D11D3B98100C04F2233EA","A202C225DD9D11D3B98100C04F2233EA","A202C226DD9D11D3B98100C04F2233EA","A202C228DD9D11D3B98100C04F2233EA","A202C227DD9D11D3B98100C04F2233EA","A202C229DD9D11D3B98100C04F2233EA","A202C210DD9D11D3B98100C04F2233EA","A202C211DD9D11D3B98100C04F2233EA","A202C212DD9D11D3B98100C04F2233EA","A202C213DD9D11D3B98100C04F2233EA","A202C22ADD9D11D3B98100C04F2233EA","A202C22BDD9D11D3B98100C04F2233EA","A202C214DD9D11D3B98100C04F2233EA","A202C215DD9D11D3B98100C04F2233EA","A202C216DD9D11D3B98100C04F2233EA","A202C217DD9D11D3B98100C04F2233EA","A202C22DDD9D11D3B98100C04F2233EA","A202C218DD9D11D3B98100C04F2233EA","A202C22CDD9D11D3B98100C04F2233EA","A202C219DD9D11D3B98100C04F2233EA","A202C21ADD9D11D3B98100C04F2233EA","A202C22EDD9D11D3B98100C04F2233EA","A202C22FDD9D11D3B98100C04F2233EA","A202C230DD9D11D3B98100C04F2233EA","A202C231DD9D11D3B98100C04F2233EA","A202C21BDD9D11D3B98100C04F2233EA","A202C21CDD9D11D3B98100C04F2233EA","A202C232DD9D11D3B98100C04F2233EA","A202C233DD9D11D3B98100C04F2233EA","A202C234DD9D11D3B98100C04F2233EA","A202C21DDD9D11D3B98100C04F2233EA","A202C21EDD9D11D3B98100C04F2233EA","A202C236DD9D11D3B98100C04F2233EA","A202C21FDD9D11D3B98100C04F2233EA","A202C220DD9D11D3B98100C04F2233EA","A202C237DD9D11D3B98100C04F2233EA","A202C238DD9D11D3B98100C04F2233EA","A202C239DD9D11D3B98100C04F2233EA","A202C221DD9D11D3B98100C04F2233EA","A202C235DD9D11D3B98100C04F2233EA","A202C23ADD9D11D3B98100C04F2233EA","A202C23BDD9D11D3B98100C04F2233EA","9C374206DD9F11D3B98100C04F2233EA","9C374207DD9F11D3B98100C04F2233EA","9C374209DD9F11D3B98100C04F2233EA","9C374220DD9F11D3B98100C04F2233EA","9C37421CDD9F11D3B98100C04F2233EA","9C37420CDD9F11D3B98100C04F2233EA","9C374208DD9F11D3B98100C04F2233EA","9C37421DDD9F11D3B98100C04F2233EA","9C374236DD9F11D3B98100C04F2233EA","9C37420DDD9F11D3B98100C04F2233EA","9C374233DD9F11D3B98100C04F2233EA","9C37420EDD9F11D3B98100C04F2233EA","9C374214DD9F11D3B98100C04F2233EA","9C374216DD9F11D3B98100C04F2233EA","9C374215DD9F11D3B98100C04F2233EA","9C37421EDD9F11D3B98100C04F2233EA","9C374219DD9F11D3B98100C04F2233EA","9C37421ADD9F11D3B98100C04F2233EA","9C374218DD9F11D3B98100C04F2233EA","9C37421BDD9F11D3B98100C04F2233EA","9C37420FDD9F11D3B98100C04F2233EA","9C374210DD9F11D3B98100C04F2233EA","9C37420BDD9F11D3B98100C04F2233EA","9C37421FDD9F11D3B98100C04F2233EA","9C374211DD9F11D3B98100C04F2233EA","9C374221DD9F11D3B98100C04F2233EA","9C37420ADD9F11D3B98100C04F2233EA","9C374212DD9F11D3B98100C04F2233EA","9C374213DD9F11D3B98100C04F2233EA"],ENUM_OBJECT_TYPE_ATTRIBUTE=12,ENUM_OBJECT_TYPE_METRIC=4,ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE=1,ENUM_LOAD_REPORT_BROWSE_TYPE_SQLPREVIEW=2,ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW=4,ENUM_LOAD_REPORT_BROWSE_TYPE_LEVELPROPERTY=256,ENUM_LOAD_REPORT_BINDING_FLAG_ALL=15,ENUM_LOAD_REPORT_BINDING_FLAG_TABLE_AND_DBTABLE=1,ENUM_LOAD_REPORT_BINDING_FLAG_REPORT=2,ENUM_LOAD_REPORT_BINDING_FLAG_TEMPLATE=4,ENUM_LOAD_REPORT_BINDING_FLAG_COLUMN=8,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo=1,ENUM_LOAD_REPORT_PREVIEW_FLAG_DataInfo=2,ENUM_LOAD_REPORT_PREVIEW_FLAG_SourceInfo=8,ENUM_LOAD_REPORT_PREVIEW_FLAG_SheetsInfo=16,ENUM_LOAD_REPORT_AUTOMAP_TRIGGER=1,ENUM_LOAD_REPORT_AUTOMAP_NOT_TRIGGER=0,SPACE_SEP=" ",PERIOD_SEP=".",SLASH_SEP="/",SEMICOLON_SEP=";";function removeTrimmingSemicolon(statement){var sql=_S.trim(statement);if(sql.slice(-1)===SEMICOLON_SEP){sql=sql.slice(0,-1);}return sql;}function processName(input,pattern){if(!pattern){return input;}return(input.indexOf(SPACE_SEP)>-1||input.indexOf(PERIOD_SEP)>-1||input.indexOf(SLASH_SEP)>-1)?pattern.replace("#0",input):input;}function composeSQLTokens(namespace,tablename,columns){var tokens=[],length=columns.length,notLastColumn,columnpattern,i,INDENT_LEN=10;columnpattern=mstrApp.isBigQuery?"":((this.getDBRole&&this.getDBRole(this.SelDBRoleID).mdDBRole.cpat)||"");tokens.push({v:"select",oi:{n:"select",sta:100,t:100}},{isNew:true,v:" ",isDelimiter:true});_A.forEach(columns,function(column,idx){tokens.push({v:processName(column.cln,columnpattern)});notLastColumn=idx<length-1;if(notLastColumn){tokens.push({v:",",isDelimiter:true});}tokens.push({v:"\n",isDelimiter:true});if(notLastColumn){for(i=0;i<INDENT_LEN;++i){tokens.push({v:" ",isDelimiter:true});}}});tablename=processName(tablename,columnpattern);tokens.push({v:"from",oi:{n:"from",sta:100,t:100}},{v:" ",isDelimiter:true},{v:" ",isDelimiter:true},{v:" ",isDelimiter:true},{v:(namespace?processName(namespace,columnpattern)+PERIOD_SEP+tablename:tablename)},{v:";"});this.raiseEvent({name:"sqlTokensAdded",value:tokens});}function preprocessTokenStream(tokens){if(!tokens||!tokens.length){return ;}var last=tokens[tokens.length-1];if(last&&last.tp===-1){tokens.pop();}if(tokens[0]&&(tokens[0].tp===64||(tokens[0].tp===36&&tokens[0].v==="$"))){tokens.splice(0,1);}}function getTokenExpr(tokens){var sa=[];_A.forEach(tokens,function(token){sa.push(token.v);});return sa.join(" ");}function _getOp(expression){var operators={">=":2,"<>":5,"<=":4,"<":3,">":1},op;for(op in operators){if(expression.indexOf(op)>-1){return operators[op];}}return 0;}function sliceFunctions(fcts,isBDE){var fs=function(a,b){return mstrmojo.array.stringSorter(a.n||a.did,b.n||b.did);},copy,myFunctions=[];if(isBDE){_A.forEach(fcts,function(currentFunctionCategory){_A.forEach(currentFunctionCategory.fns,function(currentFunction){if(_A.indexOf(BDE_FUNCTIONS,currentFunction.did)>-1){currentFunctionCategory.fns=currentFunctionCategory.fns.sort(fs);copy=[];_A.forEach(currentFunctionCategory.fns,function(item){if(_A.indexOf(BDE_FUNCTIONS,item.did)>-1){copy.push(item);}});currentFunctionCategory.fns=copy;myFunctions.push(currentFunctionCategory);return false;}});});}else{_A.forEach(fcts,function(currentFunctionCategory){_A.forEach(currentFunctionCategory.fns,function(currentFunction){if(_A.indexOf(PREDEFINED_FUNCTION_IDS,currentFunction.did)>-1){currentFunctionCategory.fns=currentFunctionCategory.fns.sort(fs);if(mstrApp.isCloudPro&&currentFunction.did===PREDEFINED_FUNCTION_IDS[2]){_A.removeItems(currentFunctionCategory.fns,"did",[{did:OLAP_FUNCTION_ID}]);}myFunctions.push(currentFunctionCategory);return false;}});});}myFunctions=myFunctions.sort(fs);return myFunctions;}var _fns={1:"Sum",2:"Avg",3:"Min",4:"Max",5:"Count",6:"Count<Distinct=true>"};var PREDEFINED_FUNCTION_IDS=["8107C31BDD9911D3B98100C04F2233EA","6F7DF5F8449111D5BEA300B0D01A55EF","4A257916A153468384320E8DB7FD338B","8107C345DD9911D3B98100C04F2233EA","6F7DF605449111D5BEA300B0D01A55EF","8107C324DD9911D3B98100C04F2233EA","F262C81CDDA611D3B98100C04F2233EA"];var OLAP_FUNCTION_ID="8107C344DD9911D3B98100C04F2233EA",SEP=".";function getTableNameFromToken(tokenValue){var separatorIndex=tokenValue.indexOf(SEP),tableName;if(separatorIndex>=1){tableName=tokenValue.slice(0,separatorIndex).toLowerCase();}return tableName;}function removeTableFromCondition(condition,tablename){if(!condition){return false;}var nds=condition.nds,tokenTableName;if(nds){var indices=[],index,length;_A.forEach(nds,function(node,idx){removeTableFromCondition(node,tablename)&&indices.push(idx);});for(index=indices.length-1;index>-1;index--){nds.splice(indices[index],1);}length=nds.length;if(length===1){condition=nds[0];}return(length===0);}var requireDelete;_A.forEach(condition.expr,function(token){if(token.tp===309){tokenTableName=getTableNameFromToken(token.v);if(tokenTableName!==undefined&&tablename===tokenTableName){requireDelete=true;return false;}}});return requireDelete;}function updateTableAliasInCondition(oldname,newname,condition){if(!condition){return ;}var tokens=condition.expr,oi,cols=condition.cols;_A.forEach(tokens,function(token){oi=token.tknctx&&token.tknctx.oi;if(oi&&oi.tp===26){if(token.extra.sqlti.als===oldname){token.extra.sqlti.als=newname;token.v=(token.v+"").replace(oldname,newname);}}});_A.forEach(cols,function(token){if(token.t===oldname){token.t=newname;token.v=(token.v+"").replace(oldname,newname);}});condition.n=(condition.n+"").replace(oldname,newname);_A.forEach(condition.nds,function(node){updateTableAliasInCondition(oldname,newname,node);});}function getRowsWithFilter(rows,condition){rows=rows||{};if(!condition){return ;}var tokens=condition.expr,oi,tablename,cols=condition.cols,subtokens,colname;_A.forEach(tokens,function(token){if(token.tp===309){var separatorIndex=token.v.toString().indexOf(SEP),tokenValue=token.v.toString();if(separatorIndex>=1){tablename=tokenValue.slice(0,separatorIndex).toLowerCase();colname=tokenValue.slice(separatorIndex+1).toLowerCase();if(tablename&&colname){rows[tablename]=rows[tablename]||{};rows[tablename][colname]=true;}}}});_A.forEach(cols,function(token){tablename=token.t.toLowerCase();rows[tablename]=rows[tablename]||{};rows[tablename][token.col.toLowerCase()]=true;});_A.forEach(condition.nds,function(node){getRowsWithFilter(rows,node);});}var _E=mstrmojo.expr,_ET=_E.ET,OPs={19:" AND ",20:" OR ",21:"(NOT( "},NOT_SUFFIX="))";function getConditionExpr(condition){if(!condition){return"";}if(!condition.nds){return condition.n||"";}var exprStringArr=[],nds=condition.nds,fn=condition.fn,isNot;_A.forEach(nds,function(node,idx){isNot=node.not;if(idx!==0){exprStringArr.push(OPs[fn]);}isNot&&exprStringArr.push(OPs[21]);exprStringArr.push("(");exprStringArr.push(getConditionExpr(node));exprStringArr.push(")");isNot&&exprStringArr.push(NOT_SUFFIX);});return exprStringArr.join("");}function decodeHTMLString(input){return $DECODEHTML(input).replace(/&apos;/g,"'");}function _rmescp(s){return s.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;apos;/g,'"').replace(/&apos;/g,"'").replace(/^\n+|\n+$/g,"").replace(/\t/g," ").replace(/&amp;/g,"&");}var _typeOf=function(v){if(v==null){return"null";}var t=typeof (v);if(t!="object"){return t;}else{if(v.length===undefined){return"object";}else{return"array";}}};var _formats=[{n:"Text",v:"3"},{n:"Number",v:"2"},{n:"Date",v:"8"},{n:"Time",v:"9"},{n:"DateTime",v:"1"},{n:"URL",v:"5"},{n:"Email",v:"6"},{n:"HTML Tag",v:"7"},{n:"Symbol",v:"10"},{n:"Big Decimal",v:"11"},{n:"Phone Number",v:"12"}];function _getTokenStreamXML(expr){var newItems=[],xml=[];var props={mi:true,cn:true,v:true,tp:true,lv:true,sta:true,tkn:true};newItems.push({lv:3,sta:1,tp:64,v:""});newItems.push({lv:1,sta:1,tp:2,v:expr});newItems.push({lv:2,sta:1,tp:-1,v:""});var config={getArrItemName:function(n,v,i){return"tkn";},isSerializable:function(nodeName,jsons,index){return(props[nodeName])?true:false;}};xml.push('<mi cn="3">');xml.push(_S.json2xml("tkn",newItems[0],config));xml.push(_S.json2xml("tkn",newItems[1],config));xml.push(_S.json2xml("tkn",newItems[2],config));xml.push("</mi>");return xml.join("");}var EnumDSSBaseFormType_Reserved=0,EnumDSSBaseFormType_DateTime=1,EnumDSSBaseFormType_Number=2,EnumDSSBaseFormType_Text=3,EnumDSSBaseFormType_Picture=4,EnumDSSBaseFormType_Url=5,EnumDSSBaseFormType_Email=6,EnumDSSBaseFormType_HTMLTag=7,EnumDSSBaseFormType_Date=8,EnumDSSBaseFormType_Time=9,EnumDSSBaseFormType_Symbol=10,EnumDSSBaseFormType_BigDecimal=11,EnumDSSBaseFormType_PhoneNumber=12;var dataTypeToBaseFormType={0:EnumDSSBaseFormType_Reserved,1:EnumDSSBaseFormType_Number,2:EnumDSSBaseFormType_Number,3:EnumDSSBaseFormType_Number,4:EnumDSSBaseFormType_Number,5:EnumDSSBaseFormType_Number,6:EnumDSSBaseFormType_Number,7:EnumDSSBaseFormType_Number,8:EnumDSSBaseFormType_Text,9:EnumDSSBaseFormType_Text,10:EnumDSSBaseFormType_Text,11:EnumDSSBaseFormType_Text,12:EnumDSSBaseFormType_Text,13:EnumDSSBaseFormType_Text,14:EnumDSSBaseFormType_Date,15:EnumDSSBaseFormType_Time,16:EnumDSSBaseFormType_DateTime,17:EnumDSSBaseFormType_Text,18:EnumDSSBaseFormType_Text,30:EnumDSSBaseFormType_BigDecimal,31:EnumDSSBaseFormType_Reserved,33:EnumDSSBaseFormType_Reserved};function _getcolwids(model,cols){var ids=[],col,wid;for(var i=0,len=cols.length;i<len;i++){col=cols[i];if(model.uiids[col.tid+col.cid]){wid=model.uiids[col.tid+col.cid];ids.push(wid);}}return ids;}function _loadConditions(model,roo,arr,whe,sqltp,sysprompt){if(!roo.ftype){var exp=_rmescp(roo.exp);if(exp.indexOf("? aptqbr_prompt")>-1){sysprompt.push({n:exp,cid:whe.chn[0].cmid});return ;}var wids=_getcolwids(model,_findSelectedColumns(whe,[])),rowWidget,cols=[];_A.forEach(wids,function(wid){rowWidget=mstrmojo.all[wid];rowWidget&&rowWidget.updateState&&rowWidget.updateState(2);cols.push({t:rowWidget.srcTable,col:rowWidget.text});});return arr.push({et:"*",n:exp,expr:[{v:exp}],sqltp:sqltp,cols:cols});}switch(roo.ftype){case 19:case 20:case 21:var tmp=[],opnd;for(var i=0,len=roo.children.length;i<len;i++){opnd=roo.children[i];_loadConditions(model,opnd,tmp,whe.chn[i],sqltp,sysprompt);}if(tmp.length==0){return ;}if(tmp.length<len&&tmp.length==1){arr.push(tmp[0]);}else{arr.push({et:14,fn:roo.ftype,nds:tmp,not:(roo.ftype==21),sqltp:sqltp});}break;default:break;}}function _getJoinPairs(roo,exp,arr){if(!exp.ftype){arr.push({lcid:roo.chn[0].col,rcid:roo.chn[1].col,exp:exp.exp});return exp.exp;}var exp1,exp2,exptxt;switch(exp.ftype){case 19:case 20:exp1=_getJoinPairs(roo.chn[0],exp.children[0],arr);exp2=_getJoinPairs(roo.chn[1],exp.children[1],arr);exptxt=exp1+((exp.ftype==19)?" AND ":" OR ")+exp2;break;case 21:exptxt=" NOT "+_getJoinPairs(roo.chn[0],exp.children[0],arr);break;default:break;}return exptxt;}function _findSelectedColumns(roo,cols){var chn=roo.chn;if(!chn){if(roo.col&&roo.stbid){cols.push({cid:roo.col,tid:roo.stbid});}return cols;}for(var i=0,len=chn.length;i<len;i++){cols=_findSelectedColumns(chn[i],cols);}return cols;}function raiseDataPreviewEvent(model){model.raiseEvent({name:"dataPreview",mappings:model.mappings,dataset:model.dataset,selectedColumns:model.selectedClns,isRefined:model.isRefined});}function _loadFFSQLReport(arr,maps,model){var sql=arr[arr.length-1].oi.def.csl.roo.chn[0].va.vv;sql=sql?_rmescp(sql):"";mstrApp.getRootController().raiseEvent({name:"reportModeChange",mode:2,value:sql});model.populateFFSQLMapping(maps);if(model.firstTimeLoading){raiseDataPreviewEvent(model);model.firstTimeLoading=false;}}function _loadExistingReport(res,model){if(!res||!res.btb){return ;}var arr=res.btb;var maps=res.datap.maps;if(model.firstTimeLoading){model.orimaps=maps;}model.refresh_opt=arr[0].oi.def.crpt;var dbrid=null;if(arr[0].oi.ext_type===304){model.set("isFFSQL",true);model.set("FFSQLMode",true);mstrApp.isFFSQL=mstrApp.isFFSQLMode=true;for(var i=0,len=arr.length;i<len;i++){if(arr[i].oi.tp===53){dbrid=arr[i].oi.def.dbr.did;}}dbrid&&model._set_SelDBRoleID("SelDBRoleID",dbrid,false);_loadFFSQLReport(arr,maps,model);return ;}var dbtables={},clns={},rpt,obj;for(var i=0,len=arr.length;i<len;i++){obj=arr[i].oi;switch(obj.tp){case 53:dbtables[obj.did]={cs:obj.def.cs.cs,tbn:decodeHTMLString(obj.def.tbn),did:obj.did,ns:obj.def.ns};break;case 26:clns[obj.did]={did:obj.did,cln:decodeHTMLString(obj.def.cln),dttp:obj.def.dt.tp,dtps:obj.def.dt.ps,dtsc:obj.def.dt.sc};break;case 3:rpt=obj.efd;break;default:break;}}var def=null,oi=null;for(var i=0,len=rpt.length;i<len;i++){oi=rpt[i].oi;switch(oi.tp){case 53:def=oi.def.sqs.c_c[0];dbrid=oi.def.dbr.did;break;default:break;}}model._set_SelDBRoleID("SelDBRoleID",dbrid,false);if(def===null){return ;}var selected=def.sqcs.c_c;var joins=def.sjs.c_c;var ts=def.stbs.c_c;var whe=def.whe;var cds=def.w_cond;var he=def.he;var hds=def.h_cond;model.selectedClns=[];model.dbtables=[];model.joins=[];model.joinsInfo={};model.uiids={};model.tables={};var selclns=model.selectedClns;var mps={},cols,exp,cid,tid,col;for(var i=0,len=selected.length;i<len;i++){if(selected[i].der&2147483648){selclns.push({isDerived:true,existing:true});continue;}cols=_findSelectedColumns(selected[i].exp.roo,[]);exp=decodeHTMLString(selected[i].exp.exp);selclns.push({wid:[],expr:[{v:exp}],existing:true});for(var j=0;j<cols.length;j++){col=cols[j];cid=col.cid;tid=col.tid;mps[tid]=mps[tid]||{};mps[tid][cid]=mps[tid][cid]||{};mps[tid][cid].state=1;mps[tid][cid].count=!mps[tid][cid].count?1:mps[tid][cid].count+1;selclns[i].wid.push(tid+cid);}}model.tbns={};var pos_hash=model.pos_hash;var tbns=model.tbns,tables=[];var t,dbtid,tf,cid,cs,ncs,als;for(var i=0,len=ts.length;i<len;i++){tables[i]={};t=ts[i];tid=t.id;dbtid=t.dbt.did;als=t.als?decodeHTMLString(t.als):dbtables[dbtid].tbn;cs=dbtables[dbtid].cs;if(pos_hash&&pos_hash[als]){tables[i].pos={w:pos_hash[als].w,h:pos_hash[als].h,t:pos_hash[als].t,l:pos_hash[als].l};}else{tf=t.sqltf;if(tf&&tf.length){tables[i].pos={w:(tf[0]&&tf[0].pdv)/_twipPerPixel||DEFAULT_WIDTH,h:(tf[1]&&tf[1].pdv)/_twipPerPixel||DEFAULT_HEIGHT,t:(tf[2]&&tf[2].pdv)/_twipPerPixel||DEFAULT_POSITION_TOP,l:(tf[3]&&tf[3].pdv)/_twipPerPixel||DEFAULT_POSITION_LEFT};}}ncs=[];for(var j=0,cnt=cs.length;j<cnt;j++){cid=cs[j].did;ncs.push(_H.copy(clns[cid]));if(mps[tid]&&mps[tid][cid]){ncs[j].state=1;ncs[j].count=mps[tid][cid].count;}}tables[i].did=tid;tables[i].cs=ncs;tables[i].tbn=als;tables[i].ns=dbtables[dbtid].ns;tables[i].dbtbn=dbtables[dbtid].tbn;tbns[als]=als;}if(model.firstTimeLoading&&!model.isNew){model.orits=model.orits||tables.slice(0);}var originalTables=model.orits;_A.forEach(tables,function(table){if(_A.find(originalTables,"did",table.did)>-1){table.existing=true;table.readOnly=mstrApp.isCloudPro;}});model.raiseEvent({name:"BindingTableLoaded",value:tables});for(var i=0,len=selclns.length;i<len;i++){var wids=selclns[i].wid;if(wids){for(var j=0,cnt=wids.length;j<cnt;j++){wids[j]=model.uiids[wids[j]];}}}model.populateMappings(maps);if(res.datap.data){model.populateDataset(res.datap.data);}raiseDataPreviewEvent(model);var join,ltid,rtid,jt,op,root,lcid,rcid,exp,jid,jcarr;for(var i=0,len=joins.length;i<len;i++){join=joins[i];ltid=join.ltid,rtid=join.rtid,jt=join.jt,idx=join.ix;root=join.cdn.roo;jcarr=[];exp=decodeHTMLString(_getJoinPairs(root,join.exp_bo,jcarr));jid=model.uiids[ltid]+model.uiids[rtid];model.joins.push(jid);model.joinsInfo[jid]=new Object();model.joinsInfo[jid].jt=""+jt;model.joinsInfo[jid].exp=exp;model.joinsInfo[jid].srctID=model.uiids[ltid];model.joinsInfo[jid].tgttID=model.uiids[rtid];if(!model.joinsInfo[jid].links){model.joinsInfo[jid].links=new Object();}if(model.tables[model.uiids[ltid]].njoins){model.tables[model.uiids[ltid]].njoins++;}else{model.tables[model.uiids[ltid]].njoins=1;}if(model.tables[model.uiids[rtid]].njoins){model.tables[model.uiids[rtid]].njoins++;}else{model.tables[model.uiids[rtid]].njoins=1;}for(var j=0;j<jcarr.length;j++){lcid=jcarr[j].lcid;rcid=jcarr[j].rcid;exp=decodeHTMLString(jcarr[j].exp);var srcwid=model.uiids[ltid+lcid],tgtwid=model.uiids[rtid+rcid];model.joinsInfo[jid].links[srcwid+tgtwid]={srcw:mstrmojo.all[srcwid],tgtw:mstrmojo.all[tgtwid],coords:[],exp:exp,jid:jid,op:_getOp(exp)};if(model.joinsInfo[jid].nlinks){model.joinsInfo[jid].nlinks++;}else{model.joinsInfo[jid].nlinks=1;}}}model.raiseEvent({name:"JoinsLoaded"});var arr=[],sysprompt=[];if(whe.exp!=""){_loadConditions(model,cds,arr,whe.roo,0,sysprompt);arr.length&&(model.conditions.where=arr[0]);if(sysprompt.length&&!model.isCubeReport){model.pattrs={};var amps=maps.amps,attribute;_A.forEach(amps,function(item){if(_A.find(sysprompt,"cid",item.afmps[0].sqc.id)>=0){attribute=item.aimp;model.pattrs[attribute.atid]={n:attribute.atnm,tp:12};}});}}if(he.exp!=""){arr=[];_loadConditions(model,hds,arr,he.roo,1);arr.length&&(model.conditions.having=arr[0]);}model.firstTimeLoading=false;}function submitR(callback,params,fn){mstrApp.getRootController().getDataService()[fn||"submitRequest"](callback,params);}function addJoinCol(joinCols,srcId,tgtId){var visited={};if(!joinCols[srcId]){joinCols[srcId]=tgtId;}else{if(!joinCols[tgtId]){joinCols[tgtId]=srcId;}else{while(joinCols[srcId]){visited[srcId]=true;srcId=joinCols[srcId];if(visited[srcId]){return ;}}joinCols[srcId]=tgtId;}}}function removeJoinCol(joinCols,srcId,tgtId){if(joinCols[srcId]){delete joinCols[srcId];}else{if(joinCols[tgtId]){delete joinCols[tgtId];}}}function isJoinCircular(joinCols,srcId,tgtId){var visited={};while(joinCols[srcId]){visited[srcId]=true;srcId=joinCols[srcId];if(visited[srcId]){return true;}}while(joinCols[tgtId]){visited[tgtId]=true;tgtId=joinCols[tgtId];if(visited[tgtId]){return true;}}return srcId===tgtId;}function preprocessJoins(joins,mdl){var newJoins=[],newJoin,jid,links,join;for(jid in joins){links=joins[jid].links;join=links[0];newJoin={srcIndex:mdl.gettIndex(join.srcw.srcID),destIndex:mdl.gettIndex(join.tgtw.srcID),jtype:join.jtype,jexp:joins[jid].jexp};newJoins.push(newJoin);}return newJoins;}mstrmojo.qb._hasQBModel=mstrmojo.provide("mstrmojo.qb._hasQBModel",{id:"QBuilderModel",tables:{},selLink:null,dbtbls:{},uiids:{},riid:"",analysisID:null,alertTitle:null,msgid:"",dbtables:[],selectedClns:[],joins:[],joinsInfo:{},joinCols:{},dbrs:[],dsns:[],drivers:[],dbms:[],suppdbs:[],pos_hash:{},bindingT:[],tbns:{},catalogRefresh:false,SelDBRoleID:null,prevDBRoleID:null,isDI:false,FFSQLMode:false,isFFSQL:false,isCloud:false,supportTimeGeo:true,isCubeReport:true,autoRefreshSQL:false,isDirty:false,SQLPreviewStmt:"",SQLstmt:undefined,refresh_opt:1,mappings:[],cloneMappings:[],dataset:[],cacheMP:[],cacheDS:[],conditions:{},cnum:0,datatypes:_formats,init:function init(props){if(this._super){this._super(props);}this.dbtables=[];this.tables={};this.selectedClns=[];this.tbns={};this.joins=[];this.joinsInfo={};this.joinCols={};this.uiids={};this.conditions={};this.mappings=[];this.cloneMappings=[];this.dataset=[];this.cacheMP=[];this.cacheDS=[];},addLink:function addLink(srcw,tgtw,jid,callbacks){var mdl=this,key=srcw.id+tgtw.id,links=mdl.joinsInfo[jid].links,jtype=mdl.joinsInfo[jid].jt;var jIndex=this.getjIndex(jid),lexp=this.brackets(srcw.oriexpr)+"="+this.brackets(tgtw.oriexpr),jexp=mdl.joinsInfo[jid].exp+" AND "+lexp;if(links[key]||links[tgtw.id+srcw.id]){return ;}var cbexpr={success:function(res){mdl.joinsInfo[jid].exp=jexp;links[key]={};links[key].srcw=srcw;links[key].tgtw=tgtw;links[key].coords=[];links[key].exp=lexp;links[key].jid=jid;mdl.joinsInfo[jid].exp=jexp;if(callbacks&&callbacks.success){callbacks.success();}mdl.raiseEvent({name:"JoinsAdded"});}};addJoinCol(mdl.joinCols,srcw.id,tgtw.id);mstrApp.getRootController().getDataService().editJoin(cbexpr,{jindex:jIndex,exp:jexp,tbid:mdl.tableID||"",jtype:jtype});},removeLink:function removeLink(linkid,jid,callbacks){var model=this,links=model.joinsInfo[jid].links,jtype=model.joinsInfo[jid].jt,jIndex=model.getjIndex(jid),jexp="",link=links[linkid];_H.forEach(links,function(item,key){if(key!==linkid){jexp+=(jexp?" AND ":"")+item.exp;}});removeJoinCol(model.joinCols,link.srcw.id,link.tgtw.id);if(!jexp){model.removeJoin(jid,callbacks);}else{var cbexpr={success:function(res){mstrApp.msgid=res.msgid;model.joinsInfo[jid].exp=jexp;delete links[linkid];if(callbacks&&callbacks.success){callbacks.success();}}};mstrApp.getRootController().getDataService().editJoin(cbexpr,{jindex:jIndex,exp:jexp,tbid:model.tableID||"",jtype:jtype});}},getTouchValue:function getTouchValue(x,y){for(var j in this.joinsInfo){var links=this.joinsInfo[j].links;for(var elem in links){var coordsArray=links[elem].coords;if(this.inPoly(coordsArray,x,y)){return[j,elem];}}}return null;},inPoly:function inPoly(poly,px,py){var npoints=poly.length;var xnew,ynew,xold,yold,x1,y1,x2,y2,i;var inside=false;if(npoints/2<3){return false;}xold=poly[npoints-2];yold=poly[npoints-1];for(i=0;i<npoints;i=i+2){xnew=poly[i];ynew=poly[i+1];if(xnew>xold){x1=xold;x2=xnew;y1=yold;y2=ynew;}else{x1=xnew;x2=xold;y1=ynew;y2=yold;}if((xnew<px)==(px<=xold)&&((py-y1)*(x2-x1)<(y2-y1)*(px-x1))){inside=!inside;}xold=xnew;yold=ynew;}return inside;},exprEditor:function(w,type,widget,cIndex){this.getFunctions();},brackets:function(s){return"["+s+"]";},isEquivalentExpr:function(exp1,exp2){var updateString=function updateString(input){return input.replace(/\s/g,"").replace(/\[+(.*?)\]+/g,"$1").replace(/\(+(.*?)\)+/g,"($1)").toUpperCase();};return(updateString(exp1)===updateString(exp2));},_set_SelDBRoleID:function(n,value){var model=this,changed=(model.SelDBRoleID!==value);this._super&&this._super(n,value);model.SelDBRoleID=value;if(changed&&value){model.setDBRole&&model.setDBRole(value);}_A.forEach(model.dbrs,function(dbr){if(dbr.data.isPrimary){dbr.data.isPrimary=false;model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED,item:dbr});}if(dbr.did===value){dbr.data.isPrimary=true;model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED,item:dbr});}});if(changed){model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBTABLES_ENABLED,value:model.getAvailableTablesEnabled()});mstrApp.getRootController().enableButton();}return changed;},setDBRole:function(value){var model=this;model.connectLiveSupport=undefined;mstrApp.getRootController().getDataService().setDBRole({success:function(res){mstrApp.msgid=res.msgid;model.loadConnectLiveSupport();}},{dbrid:value,tbid:this.tableID||""});},autoMap:function(callbacks,silent,previewOnly){var mdl=this;if(!mdl.FFSQLMode){if(mdl.getColumnsCount()===0){mstrmojo.alert(mstrmojo.desc(9945,"Please add at least one column and try again."));if(callbacks&&callbacks.failure){callbacks.failure();}return ;}else{if(mdl.getTablesCount()===0){mstrmojo.alert(mstrmojo.desc(9946,"Please add at least one table and try again."));if(callbacks&&callbacks.failure){callbacks.failure();}return ;}}}var cb2={success:function(res){mdl.isDirty=false;if(!silent){var datap=res.datap,maps=datap.maps,dataset=datap.data;if(mdl.FFSQLMode){var indices=[];mdl.populateFFSQLMapping(maps);mdl.populateDataset(dataset);}else{mdl.populatePreview(maps,dataset);}raiseDataPreviewEvent(mdl);}if(callbacks&&callbacks.success){callbacks.success(res);}}};mdl.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo+ENUM_LOAD_REPORT_PREVIEW_FLAG_DataInfo,previewOnly?ENUM_LOAD_REPORT_AUTOMAP_NOT_TRIGGER:ENUM_LOAD_REPORT_AUTOMAP_TRIGGER,cb2);},convertToQueryBuilder:function convertToQueryBuilder(callbacks){var mdl=this;mstrApp.getRootController().getDataService().convertToQB({success:function success(res){mstrApp.msgid=res.msgid;mstrApp.isFFSQLMode=false;mdl.isDirty=true;mdl.FFSQLMode=false;mdl.mappings=mdl.cacheMP;mdl.dataset=mdl.cacheDS;raiseDataPreviewEvent(mdl);callbacks&&callbacks.success&&callbacks.success(res);}},{tbid:mdl.tableID||""});},convertToFFSQL:function convertToFFSQL(stmt,callbacks,silent){var mdl=this;mdl.SQLstmt=stmt;mstrApp.getRootController().getDataService().convertToFFSQL({success:function success(res){mstrApp.msgid=res.msgid;mdl.isDirty=true;mdl.FFSQLMode=true;mstrApp.isFFSQLMode=true;mdl.cacheMP=mdl.mappings;mdl.cacheDS=mdl.dataset;mdl.dataset=[];mdl.mappings=[];if(!silent){raiseDataPreviewEvent(mdl);}callbacks&&callbacks.success&&callbacks.success(res);}},{tbid:mdl.tableID||"",exp:_S.encodeXMLAttribute(stmt)});},isMultiPassSQL:function isMultiPassSQL(statement){return removeTrimmingSemicolon(statement).indexOf(SEMICOLON_SEP)>-1;},autoMapFFSQL:function autoMapFFSQL(statement,callback){var model=this;statement=removeTrimmingSemicolon(statement);mstrApp.getRootController().getDataService().editFFSQL({success:function success(res){model.isDirty=model.isDirty||(_S.trim(model.SQLstmt)===_S.trim(statement)?false:true);model.SQLstmt=statement;model.isDDA=model.isDDA&&!model.isMultiPassSQL(statement);if(statement){model.autoMap(callback);}else{model.dataset=[];model.mappings=[];raiseDataPreviewEvent(model);callback&&callback.success&&callback.success({msgid:mstrApp.msgid});}}},{exp:_S.encodeXMLAttribute(statement).replace(/\t/g,$FOUR_SPACE),tbid:model.tableID||""});},editFFSQL:function editFFSQL(callbacks,stmt){var model=this;if(this.SQLstmt===stmt){if(callbacks&&callbacks.success){callbacks.success();return ;}}stmt=removeTrimmingSemicolon(stmt);mstrApp.getRootController().getDataService().editFFSQL({success:function success(res){mstrApp.msgid=res.msgid;model.isDirty=true;model.SQLstmt=stmt;callbacks&&callbacks.success&&callbacks.success(res);}},{exp:_S.encodeXMLAttribute(stmt).replace(/\t/g,$FOUR_SPACE),tbid:model.tableID||""});},updateSQL:function(callbacks){this.getSQL(callbacks);},getSQL:function getSQL(callbacks){var mdl=this;if((!mdl.SelDBRoleID&&mdl.riid===_DEFAULT_TEMPLATE_ID)||mdl.dbtables.length===0){var v="";if(callbacks&&callbacks.success){callbacks.success(v);}}else{mdl.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_SQLPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,null,null,{success:function success(res){var s=res.sqls[res.sqls.length-1],v=s?_rmescp(s):"";if(callbacks&&callbacks.success){callbacks.success(v);}}},true);}},isNameUnique:function(did,cIndex,v){var mdl=this,mp=mdl.mappings;for(var i=0,len=mp.length;i<len;i++){if(i!=cIndex){if(v===mp[i].alias&&mp[cIndex].tp==mp[i].tp){return false;}}}return true;},mapAttribute:function(did,aid,fid,idf,callbacks,originalObjectId){var mdl=this,mappings=mdl.mappings;for(var i=0,len=mappings.length;i<len;i++){if(mappings[i].afid===(aid+fid)){if(callbacks&&callbacks.failure){callbacks.failure(mstrmojo.desc(9926,"The attribute form you select has been mapped. Please choose a different one."));}return false;}}var index=_A.find(mappings,"did",did),mapping=mappings[index],remap=function remap(changedMappings){mstrApp.getRootController().getDataService().remapObject({success:function success(res){mdl.autoMap();if(callbacks&&callbacks.success){callbacks.success(res);}}},{mpcs:JSON.stringify(changedMappings),docid:mstrApp.docID||"",suppressError:true});};if(mapping.isIDForm&&mapping.multiForms&&!mapping.ipa){mstrmojo.confirm(mstrmojo.desc(11164,"All other forms of the attribute will be unmapped. Do you want to continue?"),{confirmBtn:{fn:function(){var changedMappings=[];_A.forEach(mappings,function(map){if(map.oid===originalObjectId&&map.did!==did){changedMappings.push({did:map.did,aid:"",ot:ENUM_OBJECT_TYPE_ATTRIBUTE});}});changedMappings.push({did:did,aid:aid,fid:fid});remap(changedMappings);}}});}else{remap([{did:did,aid:aid,fid:fid}]);}},unmap:function(did,attributeid){var mdl=this,mappings=mdl.mappings,index=_A.find(mappings,"did",did),mapping=mappings[index],remap=function remap(changedMappings){mstrApp.getRootController().getDataService().remapObject({success:function success(res){mdl.autoMap();}},{mpcs:JSON.stringify(changedMappings),docid:mstrApp.docID||"",suppressError:true});};if(mapping.isIDForm&&mapping.multiForms){mstrmojo.confirm(mstrmojo.desc(11164,"All other forms of the attribute will be unmapped. Do you want to continue?"),{confirmBtn:{fn:function(){var changedMappings=[];_A.forEach(mappings,function(map){if(map.oid===attributeid&&map.did!==did){changedMappings.push({did:map.did,aid:"",ot:ENUM_OBJECT_TYPE_ATTRIBUTE});}});changedMappings.push({did:did,aid:"",ot:ENUM_OBJECT_TYPE_ATTRIBUTE});remap(changedMappings);}}});}else{remap([{did:did,aid:"",ot:ENUM_OBJECT_TYPE_ATTRIBUTE}]);}},remap:function remap(data,callbacks){mstrApp.getRootController().getDataService().changeMapping({success:function success(res){if(callbacks&&callbacks.success){callbacks.success(res);}}},{tbid:this.tableID||"",mpcs:JSON.stringify([data]),docid:mstrApp.docID||""});},commitMapping:function(callbacks){var mdl=this;var clone=this.cloneMappings,maps=this.mappings;var mpc,mpcs=[],dirty,m,nm;for(var i=0,len=clone.length;i<len;i++){m=clone[i];nm=maps[i];mpc={};dirty=false;if(!nm.selected){mpcs.push({did:nm.did,cmf:0});}else{if(nm.alias!=m.alias){mpc.alias=nm.alias;dirty=true;}if(nm.dtp!=m.dtp){mpc.bft=nm.dtp;dirty=true;}if(nm.tp!=m.tp){mpc.ot=nm.tp;dirty=true;}if(dirty){mpc.did=nm.did;mpcs.push(mpc);}}}if(mpcs.length>0){mstrApp.getRootController().getDataService().remapObject({success:function(res){if(callbacks&&callbacks.success){callbacks.success(res);}}},{mpcs:JSON.stringify(mpcs),docid:mstrApp.docID||""});}else{if(callbacks&&callbacks.success){callbacks.success();}}},validateExpr:function validateExpr(params,callbacks){this.parseExpression(params.vo===1,1,params.cIndex,null,params.qbrex,params.expr,params.tKnStrm,callbacks);},parseExpression:function parseExpression(validateOnly,qindex,cindex,jindex,type,exp,tokenstrm,callbacks){var params={qbrex:type};params.qindex=qindex||1;params.tbid=this.tableID||"";if(jindex!=null){params.jindex=jindex;}if(exp!=null){params.exp=exp;}if(tokenstrm){params.tokenStrm=tokenstrm;}params.vo=1;mstrApp.getRootController().getDataService().parse({success:function(res){if(res&&res.mi&&res.mi.items){var tokens=res.mi.items;preprocessTokenStream(tokens);res.expr=getTokenExpr(tokens);}if(callbacks&&callbacks.success){callbacks.success(res);}}},params);},canAddTable:function canAddTable(notRaiseError){var model=this,currentDBRoleID=model.SelDBRoleID,dbridForDDA=model.dbridForDDA,evt;if(model.isDDA&&dbridForDDA&&currentDBRoleID!==dbridForDDA){evt={name:"directDataAccessTableError"};}if(evt){if(!notRaiseError){this.raiseEvent(evt);}return false;}return true;},addTable:function addTable(table,cls){var model=this,alias=table.tbn||table.did,tbns=model.tbns,temp,count=1,items=[],datatype,currentDBRoleID=model.SelDBRoleID,ddaController;if(!this.canAddTable()){return ;}alias=alias.replace(/^[0-9]/,"L");temp=alias;while(tbns[temp]){temp=alias+"_"+(count++);}alias=temp;_A.forEach(cls,function(column){datatype=column.dt;items.push({cln:column.cln,dtps:datatype.ps,dttp:datatype.tp,dtsc:datatype.sc});});var params={tbn:table.dbtn||table.tbn||table.did,clns:JSON.stringify(items),ns:table.ns,alias:alias,tbid:model.tableID||""},missingTableID=this.getMissingTableID(table.tbn,alias,table.ns);if(missingTableID){params.stbid=missingTableID;}var cb={success:function(res){tbns[alias]=alias;model.isDirty=true;mstrApp.msgid=res.msgid;model.raiseEvent({name:"TableAdded",data:cls,table:{x:table.x,y:table.y,tbn:alias,dbtbn:table.tbn||table.did,ns:table.ns,did:missingTableID}});if(model.dbtables.length>1){model.autoJoin();}model.prevDBRoleID=currentDBRoleID;if(!model.isDDA){ddaController=mstrApp.getRootController().getDDAController();ddaController.tryEnableDDACheckbox(false);}}};mstrApp.getRootController().getDataService().addTable(cb,params);},removeTable:function(tablewidget,callbacks){var mdl=this,tIndex=this.gettIndex(tablewidget.id),rows=tablewidget.Rows.children;var cb={widget:tablewidget,success:function(res){mstrApp.msgid=res.msgid;mdl.isDirty=true;var linkId,links,wid=this.widget.id;var tbns=mdl.tbns,table=mdl.tables[wid],tbn=table.tbn,dbtbn=table.dbtbn,ns=table.ns;if(tbns[tbn]){delete tbns[tbn];}for(var k in mdl.joinsInfo){var srctID=mdl.joinsInfo[k].srctID,tgttID=mdl.joinsInfo[k].tgttID;if(wid==srctID||wid==tgttID){links=mdl.joinsInfo[k].links;for(linkId in links){removeJoinCol(mdl.joinCols,links[linkId].srcw.id,links[linkId].tgtw.id);}delete mdl.joinsInfo[k];mstrmojo.array.removeItem(mdl.joins,k);mdl.tables[srctID].njoins--;mdl.tables[tgttID].njoins--;}if(mdl.selLink&&_A.indexOf(mdl.selLink[0],wid)>-1){mdl.selLink=null;}}mdl.upttIndex(tbn,dbtbn,wid,false,table.did,ns);if(mdl.dbtables.length===0&&mdl.canAddTable(true)){mdl.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBTABLES_ENABLED,value:true});mstrApp.getRootController().enableButton();}if(!mdl.isDDA){ddaController=mstrApp.getRootController().getDDAController();ddaController.tryEnableDDACheckbox(true);}var selectedColumns=mdl.selectedClns,cIndices=[],index;_A.forEach(rows,function(rowitem){_A.forEach(selectedColumns,function(selectedColumn,idx){index=_A.indexOf(selectedColumn.wid,rowitem.id);if(index>-1){_A.removeIndices(selectedColumn.wid,index,1);if(_A.indexOf(cIndices,idx)==-1){cIndices.push(idx);}}});});cIndices.sort(mstrmojo.array.numSorter);for(var j=cIndices.length-1;j>-1;j--){mdl.removeExpression(cIndices[j],true);}if(cIndices.length>0){raiseDataPreviewEvent(mdl);}mdl.raiseEvent({name:"refreshTables",items:mdl.dbtables.slice(0)});var conditions=mdl.conditions;tbn=tbn.toLowerCase();removeTableFromCondition(conditions.where,tbn)&&(delete conditions.where);removeTableFromCondition(conditions.having,tbn)&&(delete conditions.having);mdl.updateFilterLabel(conditions);if(callbacks&&callbacks.success){callbacks.success();}}};mstrApp.getRootController().getDataService().removeTable(cb,{tbid:mdl.tableID||"",tindex:tIndex});},getAvailableTablesEnabled:function getAvailableTablesEnabled(){return(!mstrApp.isFFSQLMode)?this.canAddTable(true):this.canAddTableSQL(true);},addExpression:function addExpression(cIndex,silent){var exp=getTokenExpr(this.selectedClns[cIndex].expr);var item={did:cIndex+exp,alias:exp,n:exp,selected:false,hasMapped:false,isQB:!this.FFSQLMode,expr:this.selectedClns[cIndex].expr,dtp:1,colo:cIndex,ix:cIndex,tp:0};this.mappings.push(item);var count=this.dataset.length;if(count>0){for(var i=0;i<count;i++){var row=this.dataset[i];row.push("");}}if(!silent){mstrApp.getRootController().toggleDataPreview(true);raiseDataPreviewEvent(this);}},removeExpression:function removeExpression(cIndex,delayRefreshPreview){var selectedColumns=this.selectedClns,row,gap=0,index;_A.forEach(selectedColumns[cIndex].wid,function(id){row=mstrmojo.all[id];row.count--;row.updateState(0);});selectedColumns.splice(cIndex,1);if(this.isRefined&&!mstrApp.isFFSQLMode){}else{index=this.mappings[cIndex].ix;_A.forEach(this.mappings,function(mapping){if(mapping.ix>index){gap=gap?Math.min(gap,mapping.ix-index):mapping.ix-index;}});_A.forEach(this.mappings,function(mapping){if(mapping.ix>index){mapping.ix=mapping.ix-gap;mapping.colo=mapping.colo-1;}});_A.removeIndices(this.mappings,cIndex,1);}_A.forEach(this.dataset,function(data){_A.removeIndices(data,cIndex,1);});if(!delayRefreshPreview){raiseDataPreviewEvent(this);}},editExpression:function(cIndex){var scl=this.selectedClns[cIndex-1],ws=scl.wid;this.exprEditor(scl,3,null,cIndex);},updateExpression:function updateExpression(cIndex){var exp=getTokenExpr(this.selectedClns[cIndex].expr);var item=this.mappings[cIndex];if(!item){return ;}item.did=cIndex+exp;item.alias=exp;item.n=exp;item.expr=this.selectedClns[cIndex].expr,item.selected=false;item.hasMapped=false;item.tp=0;var count=this.dataset.length;if(count>0){for(var i=0;i<count;i++){var row=this.dataset[i];row[cIndex]="";}}raiseDataPreviewEvent(this);},addSelectedColumns:function addSelectedColumns(selRows,tbIdx,funIndex,callbacks){var mdl=this,missingID,coldef,colArray=[],colrow,exp,data,isExistingTable=mdl.tables[mdl.dbtables[tbIdx-1]].existing;for(i=0;i<selRows.length;i++){colrow=selRows[i];data=colrow.dt;coldef={dt:data.tp,ps:data.ps,sc:data.sc,clix:colrow.rIndex+1,tblIdx:tbIdx};if(funIndex!=null){coldef.findex=funIndex;exp=[_fns[funIndex],"(",colrow.oriexpr,")"].join("");}else{exp=colrow.expr[0].oi.n;}if(isExistingTable){missingID=this.getMissingColumnID(exp);if(missingID){coldef.cmid=missingID;}}colArray.push(coldef);}var strObj=JSON.stringify(colArray);var cb={success:function(res){mdl.isDirty=true;mstrApp.msgid=res.msgid;for(var i=0,len=selRows.length;i<len;i++){mdl.addColumnIndex(selRows[i],funIndex,null,!isExistingTable,colArray[i].cmid,true);}mstrApp.getRootController().toggleDataPreview(true);raiseDataPreviewEvent(mdl);if(callbacks&&callbacks.success){callbacks.success(colrow);}}};mstrApp.getRootController().getDataService().addSelectedColumns(cb,{tbid:mdl.tableID||"",colArray:strObj});},addColumnWithExpression:function addColumnWithExpression(columnRow,expression,tokens,callbacks){var model=this,data=columnRow.dt,params={dt:data.tp,ps:data.ps,sc:data.sc,tbid:model.tableID||"",exp:expression||""},isExistingTable=model.tables[columnRow.srcID].existing;if(isExistingTable){var missingID=this.getMissingColumnID(expr);if(missingID){params.cmid=missingID;}}mstrApp.getRootController().getDataService().addColumn({success:function(res){model.isDirty=true;mstrApp.msgid=res.msgid;res.cIndex=model.addColumnIndex(columnRow,null,expression,!isExistingTable,missingID);mstrApp.getRootController().updateTableViewWithExpression(res.cIndex,tokens,true);if(callbacks&&callbacks.success){callbacks.success();}}},params);},removeSelectedColumn:function(cIndex,callbacks){var model=this,mapping=model.mappings,cindex;if(this.isRefined&&!mstrApp.isFFSQLMode){cindex=model.selectedClns[cIndex].ix+1;}else{cindex=mapping[cIndex].ix+1;}mstrApp.getRootController().getDataService().removeColumn({success:function(res){model.isDirty=true;mstrApp.msgid=res.msgid;model.removeExpression(cIndex);if(callbacks&&callbacks.success){callbacks.success();}}},{cindex:cindex,tbid:model.tableID||""});},removeAllColumns:function removeAllColumns(){var model=this,mappings=model.mappings;mstrApp.getRootController().getDataService().removeColumn({success:function(res){model.isDirty=true;mstrApp.msgid=res.msgid;_A.forEach(model.selectedClns,function(selectedCol){row=mstrmojo.all[selectedCol.wid[0]];row.count--;row.updateState(0);});model.selectedClns=[];model.mappings=[];raiseDataPreviewEvent(model);}},{count:mappings.length,tbid:model.tableID||""});},editColumnExpression:function editColumnExpression(cIndex,expression,tokens,callbacks){var model=this,params={cindex:model.mappings[cIndex].ix+1,exp:expression||"",tbid:model.tableID||""};mstrApp.getRootController().getDataService().editColumn({success:function(res){model.isDirty=true;mstrApp.msgid=res.msgid;mstrApp.getRootController().updateTableViewWithExpression(cIndex,tokens);if(callbacks&&callbacks.success){callbacks.success();}}},params);},editExpr:function(cIndex){var scl=this.selectedClns[cIndex-1];this.exprEditor(scl,3,null,cIndex);},getColDataType:function getColDataType(srcData){return parseInt(srcData.dt.tp,10);},addJoinColInfo:function addJoinColInfo(srcwId,tgtwId){addJoinCol(this.joinCols,srcwId,tgtwId);},autoJoin:function autoJoin(){var len=this.dbtables.length,newTid,tid,newTable,tables=this.tables,rows,row,rowData,newRows,newRow,newRowData,tp,srcw,tgtw,joins={},join,lexp,jid;newTid=this.dbtables[len-1];newTable=tables[newTid];newRows=newTable.rows;for(tid in tables){if(tid===newTid){continue;}rows=tables[tid].rows;jid=newTid+tid;for(newRow in newRows){srcw=newRows[newRow];newRowData=srcw.srcData;tp=this.getColDataType(newRowData);if(tp===constants.columnDataTypes.integer||tp===constants.columnDataTypes.unsigned||tp===constants.columnDataTypes.int64||tp==="INTEGER"){for(row in rows){tgtw=rows[row];rowData=tgtw.srcData;if(newRowData.cln===rowData.cln&&tp===this.getColDataType(rowData)&&!isJoinCircular(this.joinCols,newRow,row)){lexp=this.brackets(srcw.oriexpr)+"="+this.brackets(tgtw.oriexpr);if(joins[jid]){joins[jid].jexp=joins[jid].jexp+" AND "+lexp;}else{joins[jid]={jexp:lexp,links:[]};}join={srcw:srcw,tgtw:tgtw,jtype:0,jexp:lexp};joins[jid].links.push(join);addJoinCol(this.joinCols,srcw.id,tgtw.id);break;}}}}}if(!_H.isEmpty(joins)){this.addJoins(joins);}},addJoin:function addJoin(srcw,tgtw,jtype,jexp,callbacks){var jid,join,joins={};jid=srcw.srcID+tgtw.srcID;join={srcw:srcw,tgtw:tgtw,jtype:jtype,jexp:this.brackets(srcw.oriexpr)+"="+this.brackets(tgtw.oriexpr)};joins[jid]={links:[join],jexp:join.jexp};addJoinCol(this.joinCols,srcw.id,tgtw.id);this.addJoins(joins,callbacks);},addJoins:function addJoins(joins,callbacks){var mdl=this,joinsJSON,join,links,jid,jexp,srcw,tgtw,cbjoin={success:function(res){mdl.isDirty=true;mstrApp.msgid=res.msgid;for(jid in joins){jexp=joins[jid].jexp;links=joins[jid].links;mdl.joinsInfo[jid]={jt:0,exp:jexp,links:{},nlinks:links.length};for(i=0;i<links.length;i++){join=links[i];srcw=join.srcw;tgtw=join.tgtw;mdl.joinsInfo[jid].links[srcw.id+tgtw.id]={srcw:srcw,tgtw:tgtw,coords:[],exp:join.jexp,jid:jid};mdl.tables[srcw.srcID].njoins++;mdl.tables[tgtw.srcID].njoins++;}mdl.joinsInfo[jid].srctID=srcw.srcID;mdl.joinsInfo[jid].tgttID=tgtw.srcID;mdl.joins.push(jid);}if(callbacks&&callbacks.success){callbacks.success();}mdl.raiseEvent({name:"JoinsAdded"});}};joinsJSON=JSON.stringify(preprocessJoins(joins,mdl));mstrApp.getRootController().getDataService().addJoin(cbjoin,{joins:joinsJSON,tbid:mdl.tableID||""});},removeJoin:function(jid,callbacks){var mdl=this;var jinfo=mdl.joinsInfo[jid],srctID=jinfo.srctID,tgttID=jinfo.tgttID;var cb={success:function(res){mdl.isDirty=true;mstrApp.msgid=res.msgid;_A.removeItem(mdl.joins,jid);delete mdl.joinsInfo[jid];mdl.tables[srctID].njoins--;mdl.tables[tgttID].njoins--;if(callbacks&&callbacks.success){callbacks.success();}}};mstrApp.getRootController().getDataService().removeJoin(cb,{jindex:mdl.getjIndex(jid),tbid:mdl.tableID||""});},editJoin:function editJoin(data){var model=this,linkID=data.linkID,joinID=data.joinID,expression=data.exp||"",operator=data.op,joinType=data.type,links=model.joinsInfo[joinID].links,jIndex=model.getjIndex(joinID),joinExpression="",param={jindex:jIndex,jtype:joinType,tbid:model.tableID||""},callbackEdit={success:function success(res){mstrApp.msgid=res.msgid;model.isDirty=true;model.joinsInfo[joinID].jt=joinType;if(expression){links[linkID].op=operator;links[linkID].exp=expression;model.joinsInfo[joinID].exp=joinExpression;}model.raiseEvent({name:"joinChanged"});}};if(expression){_H.forEach(links,function(item,key){joinExpression+=(joinExpression?" AND ":"")+((key!==linkID)?item.exp:expression);});param.exp=joinExpression;}mstrApp.getRootController().getDataService().editJoin(callbackEdit,param);},renameTable:function renameTable(tid,old,current){var model=this;mstrApp.getRootController().getDataService().editTable({success:function(res){mstrApp.msgid=res.msgid;delete model.tbns[old];model.tbns[current]=current;model.tables[tid].tbn=current;_H.forEach(model.conditions,function(condition){updateTableAliasInCondition(old,current,condition);});model.raiseEvent({name:"TableNameChanged",value:current,tid:tid});}},{tbid:model.tableID||"",tables:JSON.stringify([{alias:current,tindex:model.gettIndex(tid)}])});},saveTableLayout:function saveTableLayout(callbacks){var tables=[];for(var wid in this.tables){var w=mstrmojo.all[wid];if(w&&w.editorNode){tables.push({tindex:this.gettIndex(wid),t:parseInt(w.top,10)*_twipPerPixel,l:parseInt(w.left,10)*_twipPerPixel,w:w.editorNode.clientWidth*_twipPerPixel,h:w.editorNode.clientHeight*_twipPerPixel});}}mstrApp.getRootController().getDataService().editTable({success:function success(res){mstrApp.msgid=res.msgid;if(callbacks&&callbacks.success){callbacks.success();}}},{tbid:this.tableID||"",tables:JSON.stringify(tables)});},loadReport:function loadReport(browseType,bindingFlag,previewFlag,automap,callbacks,hideWait){var mdl=this;bindingFlag=bindingFlag||ENUM_LOAD_REPORT_BINDING_FLAG_ALL;var params={browsetype:browseType,bindingflag:bindingFlag,suppressError:true,showWait:!hideWait};if(previewFlag!=null){params.previewflag=previewFlag;}if(automap!=null){params.automap=automap;params.docid=mstrApp.docID||"";}params.tableID=mdl.tableID||"";var cb={success:function(res){if(browseType&ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE){if(res.btb){mdl.bindingT=res.btb.slice(0);}}if(callbacks&&callbacks.success){callbacks.success(res);}}};mstrApp.getRootController().getDataService().getReportDefinition(cb,params);},loadConnectLiveSupport:function loadConnectLiveSupport(){var model=this,cb,params={browsetype:ENUM_LOAD_REPORT_BROWSE_TYPE_LEVELPROPERTY,bindingflag:0,previewflag:0,tableID:model.tableID||"",showWait:false};model.connectLiveSupport=undefined;cb={success:function(res){if(res.prs&&res.prs.dda!==undefined){model.connectLiveSupport=res.prs.dda;}}};mstrApp.getRootController().getDataService().getReportDefinition(cb,params);},getcIndex:function getcIndex(wid){return mstrmojo.array.indexOf(this.selectedClns,wid)+1;},getRowWidget:function getRowWidget(tn,rn){var tbls=this.tables;rn=rn.toLowerCase();if(!tn){for(var k in tbls){var rows=tbls[k].rows;for(var j in rows){if(rows[j].text.toLowerCase()===rn){return mstrmojo.all[j];}}}}else{tn=tn.toLowerCase();for(var k in tbls){if(tbls[k].tbn.toLowerCase()===tn){var rows=tbls[k].rows;for(var j in rows){if(rows[j].text.toLowerCase()===rn){return mstrmojo.all[j];}}}}}},uptcIndex:function uptcIndex(wid,idx){while(idx>this.selectedClns.length){this.selectedClns.push("");}this.selectedClns[idx]=wid;},getjIndex:function getjIndex(lid){return mstrmojo.array.indexOf(this.joins,lid)+1;},gettIndex:function gettIndex(tid){return mstrmojo.array.indexOf(this.dbtables,tid)+1;},upttIndex:function upttIndex(tbn,dbtbn,tid,toAdd,did,ns){var dbts=this.dbtables,ts=this.tables,constructTableObject=function constructTableObject(tbn,ns,dbtbn,did){return{rows:{},njoins:0,tbn:tbn,ns:ns,alias:"",dbtbn:dbtbn,did:did};};if(toAdd){ts[tid]=constructTableObject(tbn,ns,dbtbn,did);dbts.push(tid);}else{delete ts[tid];mstrmojo.array.removeItem(dbts,tid);}},save:function(name,desc,folderId,overwrite,autoName,SQLstmt,callback){var mdl=this;var cb6={success:function(res){var reportID=res.did;mdl.riid=reportID;mstrApp.path=res.path;mstrApp.reportID=reportID;mstrApp.folderID=folderId;var cb={success:function(res){if(callback&&callback.success){callback.success({did:reportID,path:mstrApp.path});}},failure:function(res){var tables=mdl.dbtables,w,pos_hash=mdl.pos_hash;for(var i=0,len=tables.length;i<len;i++){w=mstrmojo.all[tables[i]];if(w&&w.editorNode){pos_hash[w.title]={t:parseInt(w.top,10),l:parseInt(w.left,10),w:w.editorNode.clientWidth,h:w.editorNode.clientHeight};}if(w){w.set("visible",false);w.set("opener",null);}delete mstrmojo.all[tables[i]];}var CE=mstrmojo.all.CE,cel;if(CE&&(cel=CE.CEl)){cel.filterExpr.set("items",[]);cel.aggfilterExpr.set("items",[]);}mdl.createReportInstance();}};mstrApp.getRootController().getDataService().publishCube(cb,{reportid:reportID});}};var cb5={success:function(){params={reportid:mdl.riid,folderID:folderId,isCube:mdl.isCubeReport,crb:mdl.refresh_opt,overwrite:!!overwrite,autoName:!!autoName};if(name){params.name=name;}if(desc){params.desc=desc;}mstrApp.getRootController().getDataService().saveReport(cb6,params);}};var cb4={success:function(){mdl.updateDerivedFlags(cb5);}};var cb3={success:function(){if(mdl.skipMissingCheck){cb4.success();return ;}var personalattributes=[],missings=mdl.getMissingMaps(personalattributes);if(missings){var hasMissingPersonalAttributes=personalattributes.length>0,m=mstrmojo.insert({scriptClass:"mstrmojo.qb.MissingColumnWarning",hasPT:hasMissingPersonalAttributes,mappings:hasMissingPersonalAttributes?personalattributes:missings,isCube:mdl.isCubeReport,onOK:function(){cb4.success();return true;}});m.open();}else{cb4.success();}}};var cb2={success:function(){if(mdl.isDirty){mdl.autoMap(cb3);}else{cb3.success();}}};if(!mdl.FFSQLMode){mdl.saveTableLayout(cb2);}else{mdl.editFFSQL(cb2,SQLstmt);}},populatePreview:function populatePreview(maps,data){this.populateMappings(maps);this.populateDataset(data);},populateMappings:function populateMappings(maps){var attrs=maps.amps,metrs=maps.mtmps,isReadOnly=!mstrApp.isCloudPro&&(mstrApp.saveAsCube==2)&&(!this.isNew),mappingItems=[];var bak=this.mappings.slice(0);this.mappings=[];this.cloneMappings=[];var j,attr,aimp,afmps,sqc,cnt=0,pos,ipa,isDerived,formcount,getFormCount=function(forms){var formcount=0;_A.forEach(forms,function(form){if(!(form.sqc.der&2147483648)){formcount++;}});return formcount;};for(var i=0,len=attrs.length;i<len;i++){attr=attrs[i];aimp=attr.aimp;ipa=aimp.ipa;afmps=attr.afmps;cnt+=afmps.length;formcount=getFormCount(afmps);for(j=0,aflen=afmps.length;j<aflen;j++){sqc=afmps[j].sqc;pos=mstrmojo.array.find(bak,"did",sqc.id);isDerived=(sqc.der&2147483648)?true:false;mappingItems.push({did:sqc.id,alias:decodeHTMLString(aimp.atnm),n:decodeHTMLString(attr.afmps[j].cln),selected:(sqc.se==1),hasMapped:true,isReadOnly:isReadOnly,isDI:this.isDI,isQB:!(this.FFSQLMode),dtp:afmps[j].bft,colo:afmps[j].colo-1,ix:sqc.ix,tp:12,ipa:ipa,georole:(pos>=0)?bak[pos].georole:sqc.geo,der:(pos>=0)?bak[pos].der:sqc.der,oid:aimp.atid,fmid:afmps[j].fmid,afid:aimp.atid+afmps[j].fmid,fmn:decodeHTMLString(afmps[j].fmn),shapeKey:decodeHTMLString((pos>=0)?bak[pos].shapeKey:afmps[j].sha),toDel:(sqc.ups&4)?true:false,isDerived:isDerived,multiForms:formcount>1,isIDForm:j===0});}}for(var i=0,len=metrs.length;i<len;i++){var metr=metrs[i],sqc=metr.sqc;mappingItems.push({did:sqc.id,alias:decodeHTMLString(metr.mtn),n:decodeHTMLString(metr.cln),selected:(sqc.se==1),isReadOnly:isReadOnly,hasMapped:true,isDI:this.isDI,isQB:!(this.FFSQLMode),dtp:dataTypeToBaseFormType[sqc.dt.tp],colo:metr.colo-1,ix:sqc.ix,tp:4,oid:metr.mtid,georole:sqc.geo,der:sqc.der,toDel:(sqc.ups&4)?true:false});}_A.forEach(maps.cmps,function(item){sqc=item.sqc;mappingItems.push({did:sqc.id,alias:decodeHTMLString(sqc.exp.exp),n:decodeHTMLString(sqc.exp.exp),selected:false,hasMapped:false,isQB:!this.FFSQLMode,expr:sqc.exp.exp,dtp:dataTypeToBaseFormType[sqc.dt.tp],colo:item.colo-1,ix:sqc.ix,tp:0});});var item;mappingItems.sort(function(a,b){return(a.ix<b.ix)?-1:1;});for(var i=0,len=mappingItems.length;i<len;i++){item=mappingItems[i];if(item.toDel){this.selectedClns&&this.selectedClns[i]&&(this.selectedClns[i].missing=true);}else{if(item.isDerived){this.selectedClns&&this.selectedClns[i]&&(this.selectedClns[i].isDerived=true);}else{this.mappings.push(item);this.cloneMappings.push(_H.copy(item));}}}},populateDataset:function populateDataset(data){var dataset;if(!(data instanceof Array)){data=data.dcs;if(!data||!data.length){this.dataset=[];return ;}}dataset=[];_A.forEach(data,function(item){_A.forEach(item.dvs,function(value,idx){value=(value===null)?"":_HELPER.encodeData(value);dataset[idx]=dataset[idx]||[];dataset[idx].push(value);});});this.dataset=dataset;},populateFFSQLMapping:function populateFFSQLMapping(maps){var attrs=maps.amps,metrs=maps.mtmps;var hash={};var bak=this.mappings.slice(0);this.mappings=[];this.cloneMappings=[];var j,attr,aimp,c,cnt=0,aflen,afmps,item,ipa,isDerived,formcount,getFormCount=function getFormCount(forms){var formcount=0;_A.forEach(forms,function(form){if(!(form.col.oi.def.dicl.der&2147483648)){formcount++;}});return formcount;};for(var i=0,len=attrs.length;i<len;i++){attr=attrs[i];aimp=attr.aimp;ipa=aimp.ipa;afmps=attr.afmps;formcount=getFormCount(afmps);for(j=0,aflen=afmps.length;j<aflen;j++){c=afmps[j].col.oi;pos=mstrmojo.array.find(bak,"did",c.did);if(c.def.dicl.ups&4){break;}isDerived=(c.def.dicl.der&2147483648)?true:false;cnt++;item={did:c.did,alias:decodeHTMLString(aimp.atnm),n:_HELPER.encodeData(c.def.cln),selected:true,hasMapped:true,dtp:afmps[j].bft,georole:(pos>=0)?bak[pos].georole:c.def.dicl.geo,shapeKey:decodeHTMLString((pos>=0)?bak[pos].shapeKey:afmps[j].sha),oid:aimp.atid,fmid:afmps[j].fmid,afid:aimp.atid+afmps[j].fmid,fmn:decodeHTMLString(afmps[j].fmn),ipa:ipa,colo:afmps[j].colo-1,ix:c.def.dicl.clix-1,tp:12,der:(pos>=0)?bak[pos].der:c.def.dicl.der,isDerived:isDerived,multiForms:formcount>1,isIDform:j===0};hash[item.ix]=item;}}var idx=attrs.length;for(var i=0,len=metrs.length;i<len;i++){var metr=metrs[i],c=metr.col.oi;if(c.def.dicl.ups&4){continue;}cnt++;var item={did:c.did,alias:decodeHTMLString(metr.mtn),n:decodeHTMLString(c.def.cln),selected:true,hasMapped:true,dtp:dataTypeToBaseFormType[c.def.dt.tp],colo:metr.colo-1,ix:c.def.dicl.clix-1,oid:metr.mtid,tp:4,georole:c.def.dicl.geo,der:c.def.dicl.der};hash[item.ix]=item;}var item;var indices=[];_H.forEach(hash,function(value,key){indices.push(parseInt(key,10));});indices.sort(function(a,b){return a-b;});for(var i=0;i<indices.length;i++){item=hash[indices[i]];if(item&&!item.isDerived){this.mappings.push(item);this.cloneMappings.push(_H.copy(item));}}},updateDerivedFlags:function(callbacks){var cur=this.mappings;var mpcs=[],mpc;for(var i=0,len=cur.length;i<len;i++){if(cur[i].hasMapped){mpcs.push({did:cur[i].did,georole:cur[i].georole,shapekey:cur[i].shapeKey,drvflgs:cur[i].der});}}if(mpcs.length===0){callbacks&&callbacks.success&&callbacks.success();}else{mstrApp.getRootController().getDataService().remapObject({success:function success(res){if(callbacks&&callbacks.success){callbacks.success(res);}}},{mpcs:JSON.stringify(mpcs),docid:mstrApp.docID||"",utm:1});}},getMissingMaps:function(personalAttributes){if(!this.orimaps){return null;}var diff=[],i,j,len,item;var ori=this.orimaps;var cur=this.mappings;var amps=ori.amps,mtmps=ori.mtmps;ori={};var atid,atnm,afmps,def,sqc,exp,cmid,isFFSQL=mstrApp.isFFSQL;for(i=0,len=amps.length;i<len;i++){item=amps[i].aimp;atid=item.atid;atnm=decodeHTMLString(item.atnm);item=amps[i].afmps;for(j=0;j<item.length;j++){if(isFFSQL){def=item[j].col.oi.def;if(def.dicl.der&2147483648){break;}exp=def.cln;cmid=item[j].col.oi.did;}else{sqc=item[j].sqc;if(sqc.der&2147483648){break;}exp=sqc.exp.exp;cmid=sqc.id;}ori[atid]=ori[atid]||{n:atnm,oid:atid,tp:12,fms:[]};ori[atid].fms.push({fmid:item[j].fmid,fnm:decodeHTMLString(item[j].fmn),exp:decodeHTMLString(exp),cmid:cmid});}}for(i=0,len=mtmps.length;i<len;i++){if(isFFSQL){exp=mtmps[i].col.oi.def.cln;cmid=mtmps[i].col.oi.did;}else{sqc=mtmps[i].sqc;exp=sqc.exp.exp;cmid=sqc.id;}ori[mtmps[i].mtid]={oid:mtmps[i].mtid,n:decodeHTMLString(mtmps[i].mtn),tp:4,exp:decodeHTMLString(exp),cmid:cmid};}var ps=mstrmojo.hash.copy((this.pattrs||{}));var len=cur.length,oid,originalobj,forms,index;for(i=0;i<len;i++){oid=cur[i].oid;originalobj=ori[oid];if(originalobj&&originalobj.tp==cur[i].tp){forms=originalobj.fms;if(forms){index=_A.find(forms,"fmid",cur[i].fmid);if(index>-1){_A.removeIndices(forms,index,1);}}else{delete ori[oid];}}if(ps[oid]&&ps[oid].tp==cur[i].tp){delete ps[oid];}}if(personalAttributes){for(oid in ps){item=ps[oid];personalAttributes.push(item);}}for(oid in ori){item=ori[oid];if(item.tp===12){if(item.fms.length){diff.push(item);}}else{diff.push(item);}}return((diff.length>0)?diff:null);},getMissingColumnID:function(exp){var model=this,missings=model.getMissingMaps();if(!missings){return null;}var missingColId=null,expArray,currentMappings=model.mappings;_A.forEach(missings,function(item){expArray=(item.tp===4)?[item]:item.fms;_A.forEach(expArray,function(expitem){if(_A.find(currentMappings,"did",expitem.cmid)===-1&&model.isEquivalentExpr(expitem.exp,exp)){missingColId=expitem.cmid;return false;}});if(missingColId){return false;}});if(missingColId){_A.forEach(model.selectedClns,function(column){if(column.cmid===missingColId&&!column.missing){missingColId=null;return false;}});}return missingColId;},getMissingTableID:function(tbn,alias,ns){var ori=this.orits;if(!ori){return null;}var dbts=this.dbtables,ts=this.tables,t;for(var i=0,len=dbts.length;i<len;i++){t=ts[dbts[i]];if(t.existing&&t.missing&&t.tbn===alias&&t.dbtbn===tbn&&t.ns===ns){return(!t.did?null:t.did);}}return null;},getTablesCount:function(){var ts=this.tables,dbts=this.dbtables,cnt=0;for(var i=0,len=dbts.length;i<len;i++){!ts[dbts[i]].missing&&(cnt++);}return cnt;},getColumnsCount:function(){var selClns=this.selectedClns,cnt=0;for(var i=0,len=selClns.length;i<len;i++){!selClns[i].missing&&(cnt++);}return cnt;},addColumnIndex:function(row,aggIndex,expr,ignoreCheck,existingMissingColumnID,silent){var selClns=this.selectedClns,tIndex=this.gettIndex(row.parent.parent.id),exp,cIndex,found,len=selClns.length,i,column;if(!!expr){exp=expr;}else{if(aggIndex){exp=_fns[aggIndex]+"("+(row.oriexpr)+")";}else{exp=this.brackets(row.oriexpr);}}if(!ignoreCheck){for(i=0;i<len;i++){column=selClns[i];if(column.missing&&column.expr&&this.isEquivalentExpr(column.expr[0].v,exp)){column.missing=false;column.wid=[row.id];column.cmid=existingMissingColumnID;found=true;break;}}cIndex=i;}else{cIndex=len;}if(!found){if(aggIndex){if(aggIndex===6){selClns.push({wid:[row.id],expr:[{isNew:true,v:"Count",oi:{t:"11",n:"Count"}},{isNew:true,v:"<Distinct=true>",oi:{t:"11",n:"<Distinct=true>"}},{isNew:true,v:"(",isDelimiter:true},{isNew:true,v:this.brackets(row.oriexpr),oi:{tIndex:tIndex,rIndex:row.rIndex,t:"26",n:row.oriexpr}},{isNew:true,v:")",isDelimiter:true}]});}else{selClns.push({wid:[row.id],expr:[{isNew:true,v:_fns[aggIndex],oi:{t:"11",n:_fns[aggIndex]}},{isNew:true,v:"(",isDelimiter:true},{isNew:true,v:this.brackets(row.oriexpr),oi:{tIndex:tIndex,rIndex:row.rIndex,t:"26",n:row.oriexpr}},{isNew:true,v:")",isDelimiter:true}]});}}else{selClns.push({wid:[row.id],expr:[{isNew:true,v:exp,oi:{tIndex:tIndex,rIndex:row.rIndex,t:"26",n:row.oriexpr}}]});}}this.addExpression(cIndex,silent);return cIndex;},compareDBTables:function(callback){var model=this;if(model.dbtables.length===0){return ;}var cbload={success:function(res){var arr=res.btb,whts=[],obj,def;_A.forEach(arr,function(item){obj=item.oi;def=obj.def;(obj.tp===53&&def.xt===1)&&whts.push({tbid:obj.did,tbn:decodeHTMLString(def.tbn),ns:decodeHTMLString(def.ns)});});if(whts.length==0){return ;}model.whts=whts;mstrApp.getRootController().getDataService().catalogAction({success:function suc(res){var def=res.xrc.cas[0];model.whdef=def.tis?def.tis:[def];callback&&callback.success&&callback.success();}},{dbrid:model.SelDBRoleID,flags:1073741824|2|524288,mid:mstrApp.msgid,dbts:JSON.stringify(whts),showWait:true});}};model.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE+ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo,null,cbload);},updateDBTables:function(hasMissingColumn){var mdl=this,t,cli,tbs=[],tclone,clis,clisclone,i,j,len,cl;for(i=0,len=mdl.whdef.length;i<len;i++){t=mdl.whdef[i];if(t.sta!=0){tclone={ns:t.ns,sta:t.sta,tbid:t.tbid,tbn:decodeHTMLString(t.tbn),clis:[]};clisclone=tclone.clis;clis=t.clis;for(j=0;j<clis.length;j++){cl=clis[j];clisclone.push({cln:decodeHTMLString(cl.cln),cmid:cl.cmid,sta:cl.sta,prec:cl.dt.prec,scl:cl.dt.scl,tp:cl.dt.tp});}tbs.push(tclone);}}if(tbs.length==0){return ;}var cb={success:function(res){mstrApp.msgid=res.msgid;var cbload={success:function(res){var tables=mdl.dbtables,w,pos_hash=mdl.pos_hash,alreadyRaisedEvt;for(var i=0,len=tables.length;i<len;i++){w=mstrmojo.all[tables[i]];if(w&&w.editorNode){pos_hash[w.title]={t:parseInt(w.top,10),l:parseInt(w.left,10),w:w.editorNode.clientWidth,h:w.editorNode.clientHeight};}w.set("visible",false);w.set("opener",null);delete mstrmojo.all[tables[i]];}var CE=mstrmojo.all.CE,cel;if(CE&&(cel=CE.CEl)){cel.filterExpr.set("items",[]);cel.aggfilterExpr.set("items",[]);}mdl.isDirty=true;if(mdl.loadDefinition){alreadyRaisedEvt=mdl.firstTimeLoading;mdl.loadDefinition(res);if(!alreadyRaisedEvt){raiseDataPreviewEvent(mdl);}}else{_loadExistingReport(res,mdl);}}};mdl.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE+ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo,null,cbload);}};mstrApp.getRootController().getDataService().updateTableStructure(cb,{tables:JSON.stringify(tbs),tbid:mdl.tableID||""});},isColumnUsed:function(t,cl){var tbn=t.tbn,cln=cl.cln,i,len,rows;var ts=this.tables;for(var id in ts){if(ts[id].dbtbn===tbn){rows=ts[id].rows;for(var rid in rows){if((rows[rid].text===cln)&&(rows[rid].state!=0)){return true;}}}}return false;},hasMissingUsedDBColumns:function(){var tbs=this.whdef,t,i,j,len,lenj,cl,clis;for(i=0,len=tbs.length;i<len;i++){t=tbs[i];switch(parseInt(t.sta,10)){case 0:case 64:break;default:clis=t.clis;for(j=0,lenj=clis.length;j<lenj;j++){cl=clis[j];if(parseInt(cl.sta,10)===4){if(this.isColumnUsed(t,cl)){return true;}}}break;}if(t.sta==4){clis=t.clis;for(j=0,lenj=clis.length;j<lenj;j++){cl=clis[j];if(this.isColumnUsed(t,cl)){return true;}}}}return false;},getShapeKeys:function(){var mdl=this;var cb={success:function(res){if(res&&res.ShapeFileMaps&&res.ShapeFileMaps.ShapeFileMap){var keys=res.ShapeFileMaps.ShapeFileMap,items=[],desc,name,nameSorter=function nameSorter(a,b){var A=a.n.toLowerCase();var B=b.n.toLowerCase();if(A<B){return -1;}else{if(A>B){return 1;}else{return 0;}}};_A.forEach(keys,function(item){desc=item.descWeb;name=desc?mstrmojo.desc(desc.slice(8)):decodeHTMLString(item.name);items.push({did:item.shapeKey,n:name});});items.sort(nameSorter);mdl.shapeKeys=items;}}};mstrApp.getRootController().getDataService().getShapeKeys(cb,{});},createEmmaTable:function createEmmaTable(){var dataService=mstrApp.getRootController().getDataService(),me=this,isFFSQL=mstrApp.isFFSQL,xdatype=(isFFSQL?304:352),createEmmaTable=function createEmmaTable(xdatype){dataService.createEmmaTable({success:function success(res){me.tableID=res.tbid;mstrApp.msgid=res.msgid;}},{xt:xdatype});};mstrApp.msgid=mstrApp.msgID;if(mstrApp.msgid){createEmmaTable(xdatype);}else{dataService.createEmmaInstance({success:function success(res){mstrApp.msgid=res.msgid;createEmmaTable(xdatype);}});}if(mstrApp.isFFSQL){me.set("isFFSQL",true);me.set("FFSQLMode",true);mstrApp.isFFSQLMode=true;}},createReportInstance:function createReportInstance(){var mdl=this,isCloud=mstrApp.isCloudPro;mdl.msgid=mstrApp.msgid;mdl.riid=mstrApp.reportID||_DEFAULT_TEMPLATE_ID;mdl.supportTimeGeo=true;mdl.analysisID=mstrApp.analysisID;mdl.isNew=(mdl.riid==_DEFAULT_TEMPLATE_ID);mdl.alertTitle=isCloud?"Oops!":null;if(mstrApp.isEMMACube){this.createEmmaTable();return ;}var cb={success:function succ(res){mdl.msgid=res.msgid;mstrApp.msgid=res.msgid;if(mdl.riid!==_DEFAULT_TEMPLATE_ID){mdl.firstTimeLoading=true;var callback2={success:function success(res){var items;if(res&&(items=res.items)&&items.length){mdl.pattrs={};_A.forEach(items,function(item){item.ismapped&&(mdl.pattrs[item.did]={n:item.n,tp:12});});}mdl.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE+ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo,null,{success:function(res){_loadExistingReport(res,mdl);if(isCloud){mstrApp.getRootController().getDataService().autoClosePrompt({success:function success(res){mstrApp.msgid=res.msgid;}});}}});}};if(isCloud&&mstrApp.analysisID&&mstrApp.saveAsCube!=2){mstrApp.getRootController().getDataService().getDocumentAttributes(callback2,{objectID:mstrApp.analysisID});}else{callback2.success();}}else{mdl.skipMissingCheck=true;if(mstrApp.isFFSQL){mdl.set("isFFSQL",true);mdl.set("FFSQLMode",true);mstrApp.isFFSQLMode=true;mdl.convertToFFSQL("",null,true);}}mdl.set("isCloud",isCloud);mdl.set("isCubeReport",mstrApp.saveAsCube!=2);}};mstrApp.getRootController().getDataService().createReportInstance(cb,{reportid:mdl.riid});if(!mstrApp.isCloudPro){mdl.getShapeKeys();}mdl.getFunctions();},getAllowSave:function getAllowSave(statement){var allowSave,isFFSQL=mstrApp.isFFSQLMode;if(isFFSQL&&statement===undefined){statement=mstrApp.getRootController().rootView.getSQLStatement();}if(this.isNew){allowSave=isFFSQL?(!!_S.trim(statement)):(this.dbtables.length>0&&this.selectedClns.length>0);allowSave=allowSave&&(!!this.SelDBRoleID);}else{allowSave=isFFSQL?(!!_S.trim(statement)):true;}allowSave=allowSave&&this.getAvailableTablesEnabled();return allowSave;},getAutoReportName:function getAutoReportName(){var tbns=this.tbns,name=[];_H.forEach(tbns,function(table,tbn){name.push(tbn);});name=name.join("_");if(name==""){name="FFSQL";}return name.substring(0,252);},getFunctions:function getFunctions(isBDE,callback,params){var me=this;if(!this.functions){mstrApp.getRootController().getDataService().getSystemFunctions({success:function(res){me.functions=sliceFunctions(res.fncs,isBDE);if(callback&&callback.success){callback.success();}}},_H.copy(params,{includeFunctionDetails:false,functionFlags:2}));}},getFunctionList:function getFunctionList(){return this.functions;},getSuggestionItems:function getSuggestionItems(isFFSQLMode){var items=[],expr;if(isFFSQLMode){var tables=this.dbtbls[this.SelDBRoleID];_H.forEach(tables,function(v,key){items.push({n:key,sta:2,t:15});});}else{_H.forEach(this.tables,function(v){_H.forEach(v.rows,function(col){expr=col.oriexpr;items.push({n:expr,cmid:col.srcData.id,rIndex:col.rIndex+1,t:26,display:['<span class="mstrmojo-qb-ListIconBlock t26 "></span><span>',expr,"</span>"].join("")});});});}_A.forEach(this.functions,function(v){_A.forEach(v.fns,function(fn){items.push(fn);});});if(isFFSQLMode){this.FFsqlComp=items;}return items;},getConditions:function getConditions(){return this.conditions;},setCondition:function setCondition(isWhere,expression,callbacks){var model=this;mstrApp.getRootController().getDataService().editCondition({success:function success(res){mstrApp.msgid=res.msgid;model.isDirty=true;if(callbacks&&callbacks.success){callbacks.success(res);}}},{tbid:model.tableID||"",clause:isWhere?"where":"having",exp:expression});},updateConditions:function updateConditions(filterItem,aggfilterItem){var model=this,conditions=this.conditions,updatecallback={success:function suc(res){conditions.having=aggfilterItem;model.updateFilterLabel(conditions);}},handleHavingClause=function handleHavingClause(res){conditions.where=filterItem;if(aggfilterItem){model.setCondition(false,getConditionExpr(aggfilterItem),updatecallback);}else{if(conditions.having){model.setCondition(false,"",updatecallback);}else{updatecallback.success();}}},callback={success:handleHavingClause};if(filterItem){this.setCondition(true,getConditionExpr(filterItem),callback);}else{if(conditions.where){this.setCondition(true,"",callback);}else{handleHavingClause();}}},appendCondition:function appendCondition(newitem){var conditions=this.conditions,isWhereClause=newitem.sqltp===0;condition=isWhereClause?conditions.where:conditions.having;if(!condition){condition=newitem;}else{if(condition.nds){condition.nds.push(newitem);}else{condition={et:_ET.ANDOR,fn:_E.FN.AND,nds:[_H.copy(condition),newitem]};}}conditions[isWhereClause?"where":"having"]=condition;this.setCondition(isWhereClause,getConditionExpr(condition),null);this.updateFilterLabel(conditions);},canAddTableSQL:function canAddTableSQL(notRaiseError,statement){var model=this,currentDBRoleID=model.SelDBRoleID,evt;dbridForDDA=this.dbridForDDA;if(model.isDDA&&dbridForDDA&&currentDBRoleID!==dbridForDDA){evt={name:"directDataAccessTableError"};}if(evt){if(!notRaiseError){this.raiseEvent(evt);}return false;}return true;},addTableSQL:function addTableSQL(tableData,columns){composeSQLTokens.call(this,tableData.ns,tableData.n,columns);this.prevDBRoleID=this.SelDBRoleID;},updateFilterLabel:function updateFilterLabel(conditions){var rowsWithFilter={},tables=this.tables,tablename,rows,rowname,hasFilter,state;_H.forEach(conditions,function(condition){getRowsWithFilter(rowsWithFilter,condition);});_H.forEach(tables,function(table){rows=table.rows;tablename=table.tbn.toLowerCase();hasFilter=rowsWithFilter[tablename];_H.forEach(rows,function(row){state=row.state;state=(hasFilter&&hasFilter[row.text.toLowerCase()])?(state|2):(state&(~2));if(row.state!==state){row.state=state;row.images[1]=row.img[state];row.render();}});});},submitRequest:function submitRequest(callback,params,fn){submitR(callback,params,fn);},onisDDAChange:function onisDDAChange(evt){var model=this;mstrApp.getRootController().getDDAController().checkDDACheckbox(evt.value);model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBTABLES_ENABLED,value:model.getAvailableTablesEnabled()});mstrApp.getRootController().enableButton();}});})();