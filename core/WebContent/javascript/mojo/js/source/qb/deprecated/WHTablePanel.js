(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.QB.DBRoleSelector","mstrmojo.TreeBrowserNode","mstrmojo.TreeBrowser");mstrmojo.requiresDescs(773,9142,9143);function _setPosition(av,t,l){av.style.left=l;av.style.top=t;}function _createAvatar(k){var w=k.parent;var d=document.createElement("div"),s=d.style,dn=w.parent.parent.domNode;d.className="mstrmojo-qb-avatar";dn.appendChild(d);w.avatar=d;return d;}var _C=mstrmojo.css,_dnd=mstrmojo.dnd,_useCache=true,_R=mstrmojo.range,$D=mstrmojo.dom;var STR=mstrmojo.desc(9143,"Available tables cache was created at ##. Click Refresh to get the latest tables and update the cache.");mstrmojo.QB.WHTablePanel=mstrmojo.declare(mstrmojo.QB.VSplitPanel,null,{scriptClass:"mstrmojo.QB.WHTablePanel",markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},marginSpan:10,children:[new mstrmojo.QB.DBRoleSelector({slot:"topItem"}),new mstrmojo.Box({slot:"bottomItem",cssClass:"mstrmojo-qb-WarehouseTableSection",children:[{scriptClass:"mstrmojo.Table",rows:1,cols:2,cssClass:"mstrmojo-qb-DBRoleSelector-header",layout:[{cells:[{cssText:"padding-left: 5px; padding-right: 5px;"},{cssText:"height: 20px; padding-right: 3px;"}]}],children:[{scriptClass:"mstrmojo.Label",slot:"0,0",cssClass:"mstrmojo-qb-DBRoleSelector-header",text:mstrmojo.desc(9142,"Available Tables")},{scriptClass:"mstrmojo.Button",slot:"0,1",title:mstrmojo.desc(773,"Refresh"),iconClass:"mstrmojo-ArchitectListIcon info",cssText:"float:right;",cacheStamped:function(evt){if(evt.value){this.title=STR.replace(/##/,evt.value);this.tooltip=this.domNode.title;this.render();}}}]},{scriptClass:"mstrmojo.Table",rows:1,cols:2,alias:"actionbar",cssClass:"mstrmojo-Architect-SearchBoxContainer",layout:[{cells:[{cssText:"padding:1px 5px;"},{cssText:"height: 20px;"}]}],children:[{alias:"SearchBox",slot:"0,0",scriptClass:"mstrmojo.Widget",markupString:'<table id={@id} cellspacing=0 cellpadding=0 class="mstrmojo-Architect-SearchBox {@cssClass}" style="{@cssText};"><tr><td><div class="mstrmojo-SearchBox" mstrAttach:click ><input class="mstrmojo-SearchBox-input" type="text" style="width:{@width};" mstrAttach:keyup,blur/></div></td><td><div class="mstrmojo-SearchBox-bg"><div class="mstrmojo-Architect-SearchBox-search" id="{@id}sbClear" mstrAttach:click ></div></div></td></tr></table>',markupSlots:{inputNode:function(){return this.domNode.rows[0].cells[0].firstChild.firstChild;},clearNode:function(){return this.domNode.rows[0].cells[1].firstChild.firstChild;}},onclick:function(evt){var hWin=evt.hWin,e=evt.e||hWin.event,tgt=e.target||e.srcElement,id=tgt&&tgt.id;switch(id.replace(this.id,"")){case"sbSearch":if(this.onEnter&&e.keyCode===13){this.onEnter();}this._onsearch();break;case"sbClear":this.clearSearch();break;}},clearSearch:function(){this.inputNode.value="";_C.removeClass(this.clearNode,["show"]);this._onsearch(true);},onkeyup:function onkeyup(evt){var hWin=evt.hWin,e=evt.e||hWin.event;var input=mstrmojo.string.trim(this.inputNode.value);if(this.clearNode){_C.toggleClass(this.clearNode,["show"],input.length>0);}if(this._searchTimer){self.clearTimeout(this._searchTimer);}var me=this;this._searchTimer=self.setTimeout(function(){me._onsearch();},500);},_onsearch:function(toRoot){var mdl=mstrmojo.all.QBuilderModel,me=this,dbtree=this.parent.parent.DBTableTree;var callbacks={success:function(res){dbtree.clearSelect();dbtree.set("items",[]);var input=mstrmojo.string.trim(me.inputNode.value).toUpperCase();if(input.length>0){var filtered=[];var index=0;for(var i=0,len=res.length;i<len;i++){if(res[i].n.toUpperCase().indexOf(input)>-1){filtered[index++]=res[i];}}}else{filtered=res;}dbtree.set("items",filtered);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.getSelectedDBRoleTables(callbacks,_useCache);},enableMatchCase:false,onwidthChange:function(e){if(this.domNode){this.inputNode.style.width=parseInt(this.width)-71+"px";}},onRender:function(){this.inputNode.style.width=parseInt(this.width)-71+"px";}},{scriptClass:"mstrmojo.Button",slot:"0,1",title:mstrmojo.desc(773,"Refresh"),iconClass:"mstrmojo-ArchitectListIcon refresh",cssText:"float:right;",onclick:function(evt){this.parent.parent.actionbar.SearchBox.clearSearch();_useCache=false;var mdl=mstrmojo.all.QBuilderModel;if(mdl){mdl.catalogRefresh=true;}this.parent.parent.DBTableTree.dbroleChange();if(mdl){mdl.catalogRefresh=false;}_useCache=true;}}]},{alias:"DBTableTree",scriptClass:"mstrmojo.TreeBrowser",cssClass:"mstrmojo-TreeBrowser mstrmojo-Architect-WarehouseTablesTree",items:[],draggable:true,multiSelect:true,itemDisplayField:"n",useCache:false,noCheckBox:true,ownAvatar:true,itemIdField:"did",selectionAcrossBranch:false,listSelector:mstrmojo.ListSelector,branchClickPolicy:mstrmojo.TreeBrowserEnum.BRANCH_POLICY_SELECT,itemFunction:function ifn(item,idx,w){var tree=w.tree||w,iw=new mstrmojo.TreeBrowserNode({data:item,state:0,parent:w,tree:tree,multiSelect:w.multiSelect,text:item[w.itemDisplayField],textCssClass:tree.item2textCss(item),items:item[w.itemChildrenField],itemIdField:w.itemIdField,itemDisplayField:"nt",itemIconField:w.itemIconField,itemChildrenField:w.itemChildrenField,itemFunction:w.itemFunction,listSelector:w.listSelector,draggable:true,ownAvatar:true,getDragData:function(c){var w=c.src.widget,d=w.data,p=w.parent;d.html=d.n;d.ns=new Array();for(var k in p.selectedIndices){d.ns.push(p.items[k].did);}return d;},onmousedown:function omd(evt){if(this.selectedIndex>-1){_dnd.startDragCheck(evt.hWin,evt.e);}},predblclick:function predblclick(evt){var qb=mstrmojo.all.QBuilderModel,e=(window.event)?window.event:evt;target=$D.eventTarget(window.event,$D.isFF?e.e:e),t=evt.src.data;if(target.className.indexOf("mstrmojo-TreeNode-state")>-1){return ;}if(qb.FFSQLMode){if(qb.isCloud){return ;}var ff=mstrmojo.all.FFsql,tks=[];var st=ff.parent.parent.emtxt.domNode.style;if(st.visibility==="visible"){st.visibility="hidden";}if(t&&t.tag&&t.tag.tbn){var cb={success:function(res){var items=ff.items,len=items.length;if(len>0&&items[len-1]!=="\n"){items.push({isNew:true,v:"\n",isDelimiter:true,did:ff.itemCount++});}items=items.concat(res.items);ff.set("items",items);ff.raiseChangeEvent({type:"insert"});},failure:function(res){}};qb.getSQLfromTbl(evt.src,cb);}else{tks.push({isNew:true,v:evt.src.data.did,oi:evt.src.data,did:ff.itemCount++});ff.insertTokens(tks);}}else{if(t&&t.tag&&t.tag.tbn){t=t.tag;var cb={success:function(res){var fn=function(res){var cnt=qb.dbtables.length+1;qb.raiseEvent({name:"TableAdded",data:res.items,x:10*cnt,y:10*cnt,tbn:res.alias});};qb.addTable(t,res.items,{success:fn});},failure:function(res){return ;}};qb.getColumnsForDBTable(evt.src,cb);}}$D.stopPropogation(evt.hWin,evt.e);$D.clearBrowserHighlights(evt.hWin);return false;},postcreate:function(){this.scrollboxNode=new Object();this.dropCueNode=new Object();},ondragstart:function ondragstart(ctxt){var newNode=this.domNode.cloneNode(true);var qb=mstrmojo.all.QBuilderModel;if(!qb.FFSQLMode&&!qb.isFFSQL){if((ctxt.src.data)&&(ctxt.src.data.cln)){return false;}}this.parent.ownAvatar=true;var a=this.parent.avatar||_createAvatar(this);var newNode=this.domNode.cloneNode(true);var l=ctxt.src.pos.x+"px";var t=ctxt.src.pos.y+"px";if((ctxt.src.data)&&(ctxt.src.data.ns.length>1)){newNode.firstChild.childNodes[2].innerHTML=ctxt.src.data.ns.length;newNode.firstChild.childNodes[2].style.cssText="font-size:12px; font-weight:900;color:black;";}var fc=a.firstChild;var fs=newNode.childNodes[1];var fsc=fs.firstChild;while(fc){a.removeChild(fc);fc=a.firstChild;}while(fsc){fs.removeChild(fsc);fsc=fs.firstChild;}a.appendChild(newNode);_setPosition(a,t,l);a.style.display="block";return true;},ondragmove:function ondragmove(ctxt){var qdl=mstrmojo.all.QBuilderModel;var t=ctxt.tgt,w=ctxt.tgt.widget,a=this.parent.avatar;if(a){var l=t.pos.x+1+"px";var t=t.pos.y+1+"px";_setPosition(a,t,l);}if((qdl.FFSQLMode)&&w&&(w.data||w.id=="FFsql")){var x=ctxt.tgt.pos.x,y=ctxt.tgt.pos.y;if(w.id=="FFsql"){var ws=w.ctxtBuilder.itemWidgets,len=ws.length;if(len===0){return ;}var n=ws[len-1].domNode,pos=$D.position(n);if(y>pos.y+n.clientHeight){w._delaySetCaretPos(n,false);}else{for(var i=len-1;i>-1;i--){if(ws[i].data.v=="\n"||ws[i].data.v=="\t"){continue;}var node=ws[i].domNode,wy=$D.position(node).y;if(wy<y&&!(wy+14<y)){w._delaySetCaretPos(node,false);break;}}}}else{var len=w.data.v.length,width=w.domNode.offsetWidth,pos=$D.position(ctxt.tgt.widget.domNode),offset=parseInt((x-pos.x)*len/width+0.5);_R.collapseOnTextNode(ctxt.tgt.widget.domNode,offset);}}},ondragend:function ondragend(ctxt){var qdl=mstrmojo.all.QBuilderModel;if((ctxt.tgt.widget)&&(ctxt.tgt.widget.alias)&&(ctxt.tgt.widget.alias=="canvasbox")){}else{this.parent.avatar.style.display="none";this.parent.ownAvatar=false;}}});return iw;},getContentThroughTaskCall:function getContentThroughTaskCall(params,callbacks){var m=mstrmojo.all.QBuilderModel,me=this;if(params.isRoot){callbacks.success(me.items);}else{m.getColumnsForDBTable(params,callbacks);}},isBranch:function isBranch(data){return data.items;},item2textCss:function item2textCss(data){return("mstrmojo-ArchitectListIcon "+(data.items?"t15":"t26"));},onRender:function onR(){if(this.domNode){this.domNode.style.height=this.height;this.domNode.style.width=this.width;}},onheightChange:function heightchange(evt){if(this.domNode){this.domNode.style.height=parseInt(this.height)+"px";}},dbroleChange:function clear(evt){var tr=this;tr.set("items",[]);callbacks={success:function(res){tr.set("items",res);var me=mstrmojo.all.FFsql;if(!me){return ;}success=function(res){if(res){me.set("candidates",{items:res,isComplete:true});}},failure=function(res){};m.getFFsqlComponents({success:success,failure:failure});},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};var m=mstrmojo.all.QBuilderModel;m.getSelectedDBRoleTables(callbacks,this.useCache);}}],onheightChange:function(e){this.DBTableTree.set("height",parseInt(e.value)-68+"px");},onwidthChange:function(e){this.actionbar.SearchBox.set("width",parseInt(e.value)+"px");}})],load:function(){var mdl=mstrmojo.all.QBuilderModel;if(!mdl){mdl=new mstrmojo.QB.QBuilderModel();}this.children[0].initModel(mdl);mdl.attachEventListener("dbrsChange",this.children[0].id,"load");mdl.loadDBRoles();var treeid=this.children[1].DBTableTree.id;mdl.attachEventListener("dbroleChange",treeid,"dbroleChange");var btnid=this.children[1].children[0].children[1].id;mdl.attachEventListener("cacheStamped",btnid,"cacheStamped");}});})();