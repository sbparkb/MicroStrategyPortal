(function(){mstrmojo.requiresCls("mstrmojo.HTMLButton","mstrmojo.HBox","mstrmojo.Label","mstrmojo.Table","mstrmojo.Editor","mstrmojo.QB.DBRoleSetting","mstrmojo.QB.DBRoleDSNConnection","mstrmojo.QB.DBRoleSettingPulldown","mstrmojo.QB.Password");mstrmojo.requiresDescs(221,1162,1442,1834,2140,3336,8512,8513,8514);function trim(st){var str=new String("");str=st.toString();if(!str){return"";}return str.replace(/^\s\s*/,"").replace(/\s\s*$/,"");}function validate(dbe){var mdl=mstrmojo.all.QBuilderModel;if(trim(dbe.txtname.text)==""){mstrmojo.alert("The Database Connectione Name can't be empty");return false;}if(trim(dbe.txtlogin.text)==""){mstrmojo.alert("The Database Connection Login can't be empty");return false;}if(dbe.dsninfo.selectlist.selectedID===0){if(dbe.dsninfo.tbl){var sdsn=dbe.dsninfo.tbl.contents.dsnlist.selectedItem;if(!sdsn){mstrmojo.alert("Please select a DSN first");return false;}if(sdsn.des=="0"){mstrmojo.alert("Please select a DSN first");return false;}}}return true;}function addContents(dbe){var mdl=mstrmojo.all.QBuilderModel;dbe.dsninfo.dbmslist.set("items",mdl.dbms);}function populate(dbe){var dbr=dbe.dbrole;var dsn=dbe.dsninfo;dsn.dbmslist.set("selectedID",dbr.dbms);dbe.txtlogin.set("text",(dbr.ln==null)?"":dbr.ln);dbe.txtpwd.set("text",(dbr.password==null)?"":dbr.password);dbe.txtname.set("text",(dbr.n==null)?"":dbr.n);dsn.set("info",dbr);dsn.dbmslist.set("selectedID",dbr.dbms);}function getDBInfo(dbe,dbr){var dbms=dbe.dsninfo.dbmslist.selectedItem;dbr.n=dbe.txtname.text;dbr.dbms=dbms.did;dbr.dbr_type="2";dbr.owned="1";dbr.writable="1";dbr.shared="1";dbr.db_type=dbe.dsninfo.dbtype();dbr.connstr=dbe.dsninfo.connstr();dbr.ln=dbe.txtlogin.text;dbr.password=dbe.txtpwd.text;switch(dbr.db_ver){case dbe.dsninfo.DatabaseVersions.DatabaseVersionDBSybaseIQ112:case dbe.dsninfo.DatabaseVersions.DatabaseVersionDBSybaseIQ12:case dbe.dsninfo.DatabaseVersions.DatabaseVersionDBSybaseIQ127:case dbe.dsninfo.DatabaseVersions.DatabaseVersionDBSybaseIQ15:case dbe.dsninfo.DatabaseVersions.DatabaseVersionDBSybaseIQ151:case dbe.dsninfo.DatabaseVersions.DatabaseVersionDBSybaseIQ152:dbr.cefu="0";break;default:dbr.cefu="1";break;}if(dbr.db_type==dbe.dsninfo.DatabaseTypes.DatabaseTypeHive){dbr.odbcv="20";}}function apply(dbe){var dbr=dbe.dbrole;getDBInfo(dbe,dbr);var params={taskId:"arch.saveDBRole",dbroleinfo:JSON.stringify(dbr)};mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,{success:function(res){dbe.callback.success(dbe.id);dbe.close();},failure:function(res){var c=res&&res.getResponseHeader("X-MSTR-TaskErrorCode");c=(c<0)?(4294967296+parseInt(c,10)):c;switch(c){case 2147749923:mstrmojo.alert("The Database connection with name  "+dbr.n+" is already in use. Please provide a different name");break;default:mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg").substring(0,500));dbe.callback.success(dbe.id);dbe.close();}}},params);}mstrmojo.QB.DBRoleEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.QB.DBRoleEditor",zIndex:100,id:"",dbrole:null,cssClass:"mstrmojo-ObjectInfoEditor",cssText:"width:450px;",sessionState:null,callback:null,isCloud:false,postBuildRendering:function(){if(this._super){this._super();}addContents(this);},ondragend:function ondragmove(ctxt){var w=parseInt(mstrmojo.all.QBuilderPage.width)-parseInt(ctxt.src.node.clientWidth);var y=parseInt(mstrmojo.all.QBuilderPage.height)-parseInt(ctxt.src.node.clientHeight);var wy=ctxt.tgt.pos.y;var wx=ctxt.tgt.pos.x;if(wy<1){this.editorNode.style.top="1px";}if(wx<1){this.editorNode.style.left="1px";}if(wy>y){this.editorNode.style.top=y+"px";}if(wx>w){this.editorNode.style.left=w+"px";}},onOpen:function(){populate(this);},onOK:function(){if(validate(this)){return apply(this);return true;}else{return false;}},onCancel:function(){this.callback.cancel(null);},onRender:function(){if(this.containerNode){this.containerNode.style.height="100%";this.containerNode.style.padding="20px 20px 0px 20px";this.isCloud=mstrmojo.all.QBuilderModel&&mstrmojo.all.QBuilderModel.isCloud;var list=this.dsninfo.selectlist.tbl.list;var st=list.domNode.style;st.width="325px";list=this.dsninfo.dbmslist.tbl.list;st=list.domNode.style;st.width="325px";this.txtlogin.tbl.txt.domNode.style.width="320px";this.txtpwd.tbl.txt.domNode.style.width="320px";this.txtname.tbl.txt.domNode.style.width="320px";if(this.isCloud){this.conninfo.domNode.style.color="#0066cc";this.nameinfo.domNode.style.color="#0066cc";}}},children:[{scriptClass:"mstrmojo.Label",cssText:"font-weight:bold; width:100%; padding:0px 0px 5px;",alias:"conninfo",text:mstrmojo.desc(1834,"connection information")},{scriptClass:"mstrmojo.QB.DBRoleDSNConnection",alias:"dsninfo"},{scriptClass:"mstrmojo.QB.DBRoleSetting",alias:"txtlogin",caption:mstrmojo.desc(8513,"login:")},{scriptClass:"mstrmojo.QB.Password",alias:"txtpwd",caption:mstrmojo.desc(1162,"password:"),isPassword:true},{scriptClass:"mstrmojo.Label",cssText:"font-weight:bold; width:100%; padding:10px 0px;",alias:"nameinfo",text:mstrmojo.desc(8514,"name the connection")},{scriptClass:"mstrmojo.QB.DBRoleSetting",alias:"txtname",caption:"Name:"},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",cssText:"width:100%;height:40px;left:100px;",children:[{scriptClass:"mstrmojo.Box",cssText:"width:220px;padding-right:12px;",slot:"0,0"},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button  OKButton",text:mstrmojo.desc(1442,"OK"),cssText:"width:70px;",onclick:function(evt){var e=this.parent.parent;var ret=true;if(e.onOK){ret=e.onOK();}if(ret){e.close();}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button cancel",text:mstrmojo.desc(2140,"Cancel"),cssText:"width:70px;",onclick:function(evt){var e=this.parent.parent;if(e.onCancel){e.onCancel();}e.close();}}]}]});})();