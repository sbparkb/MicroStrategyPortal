(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.WidgetList","mstrmojo.qb.FilterTree","mstrmojo.CustomGroupEl","mstrmojo._HasPopup","mstrmojo._IsMovable","mstrmojo.ConditionNode","mstrmojo._IsPopup");mstrmojo.requiresDescs(1994,2550,3415,3416,5893,7953,12367,12368);var $H=mstrmojo.hash,$ARR=mstrmojo.array,_E=mstrmojo.expr,_BF=_E.BRANCH_FNS,_D=mstrmojo.dom,$DESC=mstrmojo.desc;function extractData(item){if(!item){return undefined;}var nds=item.nds;if(!nds){return item;}$ARR.forEach(nds,function(node,idx){nds[idx]=extractData(node);});item.nds=nds.slice(0);return item;}function updateTreeItems(items,data,newData){$ARR.forEach(items,function(item,idx){if(item.nds){updateTreeItems(item.nds,data,newData);}else{if(item===data){items[idx]=newData;}}});}function openExpressionEditor(expressionNode,isNew){var data=expressionNode.data;mstrApp.getRootController().openExpressionEditor({n:isNew?mstrmojo.desc(5893,"New Condition"):mstrmojo.desc(7953,"Condition Editor"),tkn:isNew?[]:data.expr,callbacks:{success:function success(res){var WIDGET={0:"filterExpr",1:"aggfilterExpr"},mi=res.mi,sqltp=mi.exp.sqltp;var newitem={et:"*",expr:mi.items,n:res.expr,sqltp:sqltp};if(isNew){expressionNode[WIDGET[sqltp]].newCondition(newitem);}else{if(data.sqltp===sqltp){updateTreeItems(expressionNode.tree.items,expressionNode.data,newitem);expressionNode.data=newitem;expressionNode.paint();}else{expressionNode.del();expressionNode.tree.parent[WIDGET[sqltp]].newCondition(newitem);}}}}});}function deleteAllFilters(tree){var data=tree&&tree.items;if(data){tree.remove(data);}}mstrmojo.qb.ConditionEditor=mstrmojo.declare(mstrmojo.Editor,[mstrmojo._HasPopup,mstrmojo._IsMovable],{scriptClass:"mstrmojo.qb.ConditionEditor",cssClass:"mstrmojo-qb-filterEditor",title:mstrmojo.desc(2550,"Filters"),ondataChange:function ondataChange(){var filterTree=this.CEl,data=this.data,aggexpr=data.having,expr=$H.clone(data.where);filterTree.filterExpr.set("items",[]);filterTree.filterExpr.add(expr?[expr]:[],0);filterTree.aggfilterExpr.set("items",[]);filterTree.aggfilterExpr.add(aggexpr?[aggexpr]:[],0);},children:[{scriptClass:"mstrmojo.CustomGroupEl",cssClass:"mstrmojo-qb-filterTreeBox",alias:"CEl",markupString:'<div id="{@id}" class="mstrmojo-onhoverparent mstrmojo-CustomGroupEl {@cssClass}" style="{@cssText}"><div class="mstrmojo-qb-cond-details" {@cssClass}"><div class="mstrmojo-qb-expr-tools {@cssClass}"></div><div class="mstrmojo-CustomGroupEl-expr {@cssClass}"></div><div class="mstrmojo-CustomGroupEl-expr {@cssClass}"></div><div class="mstrmojo-CustomGroupEl-expr {@cssClass}"><br></div><div class="mstrmojo-CustomGroupEl-expr {@cssClass}"></div></div></div>',markupMethods:{onstateChange:function(){this.detailsNode.style.display=this.state?"block":"none";}},markupSlots:{stateNode:function(){return this.domNode.firstChild.firstChild;},detailsNode:function(){return this.domNode.lastChild;},exprNode:function(){return this.domNode.lastChild.children[2];},expr2Node:function(){return this.domNode.lastChild.children[4];},exprToolsNode:function(){return this.domNode.lastChild.firstChild;}},parent:this.parent,children:[{scriptClass:"mstrmojo.qb.FilterTree",slot:"exprNode",alias:"filterExpr",onexprclick:function onexprclick(exprNode){openExpressionEditor(exprNode,false);}},{scriptClass:"mstrmojo.qb.FilterTree",slot:"expr2Node",alias:"aggfilterExpr",onexprclick:function onexprclick(exprNode){openExpressionEditor(exprNode,false);}},{scriptClass:"mstrmojo.Box",slot:"exprToolsNode",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-CGE-addCondition",text:mstrmojo.desc(1994,"Add Condition"),onclick:function(){openExpressionEditor(this.parent.parent,true);}},{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(5186,"Delete All"),cssClass:"mstrmojo-qb-deleteAll",onclick:function(){var editor=this.parent.parent;deleteAllFilters(editor.filterExpr);deleteAllFilters(editor.aggfilterExpr);}}]}],state:true}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(1442,"OK"),onclick:function onclick(){var me=this.parent.parent,filterTree=me.CEl;mstrApp.getRootController().updateFilters(extractData(filterTree.filterExpr.items[0]),extractData(filterTree.aggfilterExpr.items[0]));me.set("visible",false);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(3416,"Cancel"),onclick:function onclick(){var me=this.parent.parent,filterTree=me.CEl,data=me.data,popUpZIndex=1000;if($H.equals(extractData(filterTree.filterExpr.items[0]),data.where)&&$H.equals(extractData(filterTree.aggfilterExpr.items[0]),data.having)){me.set("visible",false);return ;}var $NIB=mstrmojo.Button.newInteractiveButton;mstrmojo.confirm($DESC(12367,"All your changes on the filter will be lost. Do you want to exit?"),null,{buttons:[$NIB(mstrmojo.desc(1442,"OK"),function yes(){me.set("visible",false);},null,{onRender:function(){if(mstrApp.isCloudPro){mstrmojo.css.addClass(this.domNode,"cloud");}else{mstrmojo.css.addClass(this.domNode,["mstrmojo-di-button","mstrmojo-WebButton","hot"]);}}}),$NIB(mstrmojo.desc(3416,"Cancel"),mstrmojo.emptyFn,null,{onRender:function(){if(mstrApp.isCloudPro){mstrmojo.css.addClass(this.domNode,"cloud cancel");}else{mstrmojo.css.addClass(this.domNode,["mstrmojo-di-button","mstrmojo-WebButton"]);}}})],title:$DESC(12368,"Lose Your Changes?"),zIndex:popUpZIndex});}}],getMovingHandle:function getMovingHandle(){return this.children[0].domNode;},andOrPopupRef:{scriptClass:"mstrmojo.Editor",cssClass:"mstrmojo-CGE-andOrPopup mstrmojo-ConditionWalk",cssText:"width: auto;",contentNodeCssClass:"mstrmojo-balloon",left:"250px",top:"15px",slot:"containerNode",autoClose:true,showTitle:false,draggable:false,openEffect:null,closeEffect:null,onOpen:function(){var w=this.condition,not=w&&w.data&&w.data.not,p=w&&w.parent,pd=p&&p.data,fn=(pd&&pd.fn)+(not?21:0),list=this.list;list.opening=true;list.set("selectedItem",isNaN(fn)?null:{did:fn});list.opening=false;this.curtainNode.style.position="fixed";},children:[{scriptClass:"mstrmojo.Dial",cssClass:"mstrmojo-CGE-andOrDial",alias:"list",itemMarkup:'<div class="dial-item {@css}">{@n}</div>',itemIdField:"did",items:[{did:19,n:_BF[19]},{did:20,n:_BF[20]},{did:19+21,n:_BF["19_21"]},{did:20+21,n:_BF["20_21"]}],onchange:function(){if(this.opening){return ;}var pop=this.parent,w=pop.condition,sel=this.selectedItem,did=sel&&sel.did,not=did>21?true:null,fn=did-(not?21:0);pop.close();var bq=w&&w.parent;if(bq&&bq.data&&bq.data.et===_E.ET.ANDOR){bq.edit(w,fn,not);}else{var d=w&&w.data;if(d&&(d.not!==not)){d.not=not;w.paint();}}}}]},inlineTextRef:{scriptClass:"mstrmojo.Popup",locksHover:true,children:[{scriptClass:"mstrmojo.TextBox",alias:"txt",onTab:function(evt){if(this.onEnter){this.onEnter();}var w=_D.shiftKey(evt.hWin,evt.e)?this.prevTab:this.nextTab;if(w&&w.onclick){w.onclick();}},onblur:function(){if(this.onEnter){this.onEnter();}},onEsc:function(){if(this.onCancel){this.onCancel();}this.parent.close({cancel:true});}}],onOpen:function(){var textBox=this.txt,config=this.txtConfig;$H.forEach(config,function(prop){textBox.set(prop,config[prop]);});textBox.focus();},onClose:function(cfg){if(!cfg||(!cfg.cancel&&!cfg.enter)){this.txt.onEnter();}}}});}());