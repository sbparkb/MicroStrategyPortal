(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo._IsWebApp","mstrmojo.ServerProxy","mstrmojo.XHRServerTransport","mstrmojo.warehouse.WHModel","mstrmojo.warehouse.WHController","mstrmojo.qb.QBuilderPage","mstrmojo.qb.QBuilderModel","mstrmojo.qb.EmmaModel","mstrmojo.qb.RootController","mstrmojo.qb.EmmaController","mstrmojo.qb.bigquery.RootController","mstrmojo.qb.bigquery.ESRootView","mstrmojo.qb.bigquery.BigQueryBuilderPage","mstrmojo.qb.es.Model","mstrmojo.qb.es.Controller","mstrmojo.qb.EnumQBAppType","mstrmojo.qb.QBAlertDialog","mstrmojo.qb.thirdParty.Controller","mstrmojo.qb.thirdParty.Model","mstrmojo.qb.thirdParty.RootView","mstrmojo.DI.DIConstants");mstrmojo.requiresDescs(37,889,1442,9944,11583,11584,11585,11622,11623,11624,11625,12569,12920,12921,12923,12941,5781,14297);var WAIT_BOX_ID="QBwaitBox",waitBoxConfig={scriptClass:"mstrmojo.Editor",id:WAIT_BOX_ID,draggable:false,showTitle:false,zIndex:9999,cssClass:"mstrmojo-di-progressBar",children:[{scriptClass:"mstrmojo.ProgressBar",alias:"progress",cssClass:"mstrmojo-di-progress stripes"}],counter:0,displayMsg:null,ondisplayMsgChange:function ondisplayMsgChange(){if(this.progress){this.progress.set("progressText",this.displayMsg);}},oncounterChange:function oncounterChange(){var counter=this.counter,visible=this.visible;if(counter===0&&visible){this.close();}else{if(counter>0&&!visible){var container=mstrApp.container;var config={};if(container&&container.domNode){var position=mstrmojo.dom.position(container.domNode);if(position){config={top:position.y+"px"};}}this.open(null,config);}}}};var ERROR_EXEC_SQL=-2147215346,ERROR_QUOTA_EXCEED=-2147071825,ERROR_UNMAP_ATTRIBUTE=-2147212035,ERROR_MSI_SERVER_NAME_NOT_INITIALIZED=-2147206925,ERROR_MSI_INVALID_SESSION_ID=-2147206924,ERROR_MSI_USERMGR_USER_NOTFOUND=-2147209051,ERROR_MSI_CONNECT_FAILED=-2147207419,ERROR_PUBLISH_CUBE=-2147071870,ERROR_CREATE_REPORT_INSTANCE=-2147216373;var GENERIC_ERROR_MSG={};GENERIC_ERROR_MSG[ERROR_EXEC_SQL]=mstrmojo.desc(11583,"Failed to execute query.");GENERIC_ERROR_MSG[ERROR_QUOTA_EXCEED]=mstrmojo.desc(11584,"Insufficient storage space to upload your data.");GENERIC_ERROR_MSG[ERROR_UNMAP_ATTRIBUTE]=mstrmojo.desc(11622,"Please unmap the attribute's non-key form first.");GENERIC_ERROR_MSG[ERROR_MSI_SERVER_NAME_NOT_INITIALIZED]=mstrmojo.desc(11623,"Your session has expired.");GENERIC_ERROR_MSG[ERROR_MSI_INVALID_SESSION_ID]=mstrmojo.desc(11623,"Your session has expired.");GENERIC_ERROR_MSG[ERROR_MSI_USERMGR_USER_NOTFOUND]=mstrmojo.desc(11623,"Your session has expired.");GENERIC_ERROR_MSG[ERROR_MSI_CONNECT_FAILED]=mstrmojo.desc(11623,"Your session has expired.");GENERIC_ERROR_MSG[ERROR_PUBLISH_CUBE]=mstrmojo.desc(11624,"No quota left to create cube.");GENERIC_ERROR_MSG[ERROR_CREATE_REPORT_INSTANCE]=mstrmojo.desc(11625,"Failed to create report instance.");var _DEFAULT_TEMPLATE_ID="A61B85F4485D3B953003B195E58B5138";var $DI_CONSTANTS=mstrmojo.DI.DIConstants;function handleServerRequestFailure(res,failureHandler,alertCfg){var UNKNOWN_ERROR=mstrApp.isSingleTier?mstrmojo.desc(14297,"There is an error."):mstrmojo.desc(11585,"There is an error on the server."),rootController=mstrApp.getRootController(),errorCode=res.code||(res.getResponseHeader&&res.getResponseHeader("X-MSTR-TaskErrorCode"))||"",msg=res.message||(res.getResponseHeader&&res.getResponseHeader("X-MSTR-TaskFailureMsg"))||"",newMsg="",genericMsg="",detailedMsg;msg=(msg.length>2000)?msg.substring(0,2000)+"...":msg;detailedMsg=msg.replace(/com\.microstrategy(\.\w+)*: \(?/,"").replace(/\)$/,"");errorCode=parseInt(errorCode,10);switch(errorCode){case ERROR_EXEC_SQL:if(rootController.model.FFSQLMode){newMsg=msg.replace(/com\.microstrategy(\.\w+)*: \(/,"").replace(/\)$/,"");if(newMsg.match(/(.\s)*DataImport\)?\[(\d+)\](.\s)*/)){var passNumber=parseInt(RegExp.$2,10);rootController.markFailureLabel(passNumber);genericMsg=mstrmojo.desc(9944,"SQL Pass ## failed to execute.").replace("##",passNumber);detailedMsg=newMsg;}}mstrmojo.qb.alert(genericMsg||GENERIC_ERROR_MSG[errorCode],detailedMsg,failureHandler,null,alertCfg);break;case ERROR_QUOTA_EXCEED:msg=msg.match(/currently using(.*)space/g)[0];msg=msg.match(/\d+../g);newMsg=mstrmojo.desc(12920,"You are currently using ## of the allocated ### space.");mstrmojo.qb.alert(GENERIC_ERROR_MSG[errorCode],newMsg.replace("##",msg[0]).replace("###",msg[1]),failureHandler,null,alertCfg);break;case ERROR_UNMAP_ATTRIBUTE:mstrmojo.qb.alert(GENERIC_ERROR_MSG[errorCode],detailedMsg,failureHandler,null,alertCfg);break;case ERROR_PUBLISH_CUBE:mstrmojo.qb.alert(GENERIC_ERROR_MSG[errorCode],detailedMsg,function(){mstrmojo.form.send({evt:"3124",src:mstrApp.name+".qbuilder.3124",relativePageNumber:"-1"},mstrApp.name,"POST",null,null,false);},null,alertCfg);break;case ERROR_CREATE_REPORT_INSTANCE:if(rootController.model.riid===_DEFAULT_TEMPLATE_ID){mstrmojo.alert(mstrmojo.desc(12921,"Please contact your Administrator to update the Project Metadata."),function(){mstrApp.redirectToPage({evt:3010});});}else{mstrmojo.qb.alert(GENERIC_ERROR_MSG[errorCode],detailedMsg,failureHandler,null,alertCfg);}break;case ERROR_MSI_SERVER_NAME_NOT_INITIALIZED:case ERROR_MSI_INVALID_SESSION_ID:case ERROR_MSI_USERMGR_USER_NOTFOUND:case ERROR_MSI_CONNECT_FAILED:if(mstrApp.isCloudPro){rrOpenHomePage&&rrOpenHomePage();}else{mstrmojo.form.send({evt:"3010"},mstrApp.name,"POST",null,null,false);}break;default:if(detailedMsg){mstrmojo.qb.alert(UNKNOWN_ERROR,detailedMsg,failureHandler,null,alertCfg);}else{msg=res.responseText;msg=msg&&msg.match(/\[HttpException \(0x80004005\): (.)+\]/);mstrmojo.qb.alert(UNKNOWN_ERROR,(msg&&msg[0]&&msg[0].replace(/\[HttpException \(0x80004005\): |\]/gi,""))||mstrmojo.desc(5781,"Request timed out."),failureHandler,null,alertCfg);}break;}}mstrmojo.qb.QBApp=mstrmojo.declare(mstrmojo.Obj,[mstrmojo._IsWebApp],{scriptClass:"mstrmojo.qb.QBApp",enableWaitBox:true,getWaitBoxPosition:function(){var container=mstrApp.container;var config={};if(container&&container.domNode){var position=mstrmojo.dom.position(container.domNode);if(position){config={top:position.y};}}return config;},init:function init(props){this._super(props);if(!this.serverProxy){this.serverProxy=new mstrmojo.ServerProxy({transport:mstrmojo.XHRServerTransport});}},start:function start(type,params){var controller,$ENUMAPPTYPE=mstrmojo.qb.EnumQBAppType,xdatype,viewConfig,newParams=mstrmojo.hash.clone(params),connectorType,ENUM_CONNECTOR_TYPE=$DI_CONSTANTS.backendSourceSubtype,delayDBProperties=false;switch(parseInt(type,10)){case $ENUMAPPTYPE.BigQuery:case $ENUMAPPTYPE.BigQueryFFSQL:mstrApp.isBigQuery=true;xdatype=mstrApp.isFFSQL?342:341;this.dbroleID=mstrApp.dbrid;controller=this.rootController=new mstrmojo.qb.bigquery.RootController();controller.dataService=mstrmojo.qb.DataService;newParams.id="QBuilderModel";controller.model=new mstrmojo.qb.bigquery.Model(newParams);controller.rootView=new mstrmojo.qb.bigquery.BigQueryBuilderPage({placeholder:this.placeholder});break;case $ENUMAPPTYPE.BigQuerySingleTable:mstrApp.isBigQuery=true;xdatype=345;this.dbroleID=mstrApp.dbrid;controller=this.rootController=new mstrmojo.qb.bigquery.ESController();controller.dataService=mstrmojo.qb.es.DataService;controller.model=new mstrmojo.qb.bigquery.ESModel(newParams);controller.rootView=new mstrmojo.qb.bigquery.ESRootView({placeholder:this.placeholder});this.msgid=this.msgID;break;case $ENUMAPPTYPE.EmmaSingleTable:controller=this.rootController=new mstrmojo.qb.es.Controller();controller.dataService=mstrmojo.qb.es.DataService;if(newParams.hasOwnProperty("emmaSingleIsForAlternateSource")){newParams.isForAlternateSource=newParams.emmaSingleIsForAlternateSource;delete newParams.emmaSingleIsForAlternateSource;}controller.model=new mstrmojo.qb.es.Model(newParams);viewConfig={placeholder:this.placeholder};if(newParams.hasOwnProperty("emmaSingleAlertCfg")){viewConfig.alertCfg=newParams.emmaSingleAlertCfg;}controller.rootView=new mstrmojo.qb.es.RootView(viewConfig);this.msgid=this.msgID;delayDBProperties=true;break;case $ENUMAPPTYPE.MDX:controller=this.rootController=new mstrmojo.qb.mdx.Controller();controller.dataService=mstrmojo.qb.mdx.DataService;delete newParams.dbObjectsDisplayOptions;controller.model=new mstrmojo.qb.mdx.Model(newParams);controller.rootView=new mstrmojo.qb.mdx.RootView({placeholder:this.placeholder});this.msgid=this.msgID;break;case $ENUMAPPTYPE.BISource:mstrApp.isBISource=true;xdatype=mstrApp.isFFSQL?304:352;controller=this.rootController=mstrmojo.insert({scriptClass:"mstrmojo.qb.thirdParty.Controller"});controller.dataService=mstrmojo.qb.DataService;controller.model=new mstrmojo.qb.thirdParty.Model(newParams);controller.rootView=new mstrmojo.qb.thirdParty.RootView({placeholder:this.placeholder});break;default:xdatype=mstrApp.isFFSQL?304:352;connectorType=mstrApp.isFFSQL?ENUM_CONNECTOR_TYPE.customSQL:ENUM_CONNECTOR_TYPE.customSQLWizard;if(mstrApp.isEMMACube){controller=this.rootController=mstrmojo.insert({scriptClass:"mstrmojo.qb.EmmaController"});controller.dataService=mstrmojo.qb.DataService;newParams.canSupportDDA=mstrApp.canSupportDDA;newParams.shouldSupportDDA=mstrApp.shouldSupportDDA;newParams.dbridForDDA=mstrApp.dbridForDDA;newParams.isDDA=mstrApp.isDDA;newParams.ddaCheckboxID=mstrApp.ddaCheckboxID;controller.model=new mstrmojo.qb.EmmaModel(newParams);controller.model.set("id","QBuilderModel");delayDBProperties=true;}else{controller=this.rootController=mstrmojo.insert({scriptClass:"mstrmojo.qb.RootController"});controller.dataService=mstrmojo.qb.DataService;controller.model=new mstrmojo.qb.QBuilderModel({id:"QBuilderModel"});}controller.rootView=new mstrmojo.qb.QBuilderPage({placeholder:this.placeholder});break;}if(!delayDBProperties){controller.model.dbObjects.populateDBProperties({});}controller.start(xdatype,connectorType);},getRootController:function getRootController(){return this.rootController;},hideProgress:function hideWait(manually){var progressBar=mstrmojo.all.progressBar,cfg={manually:!!manually};if(progressBar){progressBar.close(cfg);}},redirectToPage:function redirectToPage(url){this.showWait();mstrmojo.form.send(url,mstrApp.name,"POST",null,null,false);},serverResponse:function serverResponse(id,methodName,requestID,status,responseJSON){mstrmojo.all[id][methodName](requestID,!!status,responseJSON);},serverRequest:function serverRequest(params,callback,showWait,suppressError,displayMsg,msgid,alertCfg,waitBoxCfg){var config={},failureHandler;if(!params.sessionState&&this.sessionState){params.sessionState=this.sessionState;}params.msgid=msgid||mstrApp.msgid;config.hideFailureErr=true;if(!suppressError){failureHandler=callback.failure;callback.failure=function failure(res){handleServerRequestFailure(res,failureHandler,alertCfg);};}config.waitBoxCfg=waitBoxCfg||{showCancel:false};config.waitBoxCfg.position=this.getWaitBoxPosition();config.waitBoxCfg.message=displayMsg;config.silent=!showWait;this._super(params,callback,config);},serverRequestParallel:function serverRequestParallel(params,callback,showWait,suppressError,displayMsg,msgid,alertCfg){if(showWait===true){this.showWait(displayMsg);}if(!params.sessionState&&this.sessionState){params.sessionState=this.sessionState;}params.msgid=msgid||mstrApp.msgid;try{var $this=this;window.setTimeout(function(){var failureHandler=callback.failure;callback.failure=function failure(res){handleServerRequestFailure(res,failureHandler,alertCfg);};var newCallback=mstrmojo.func.wrapMethods(callback,{complete:function complete(){if(showWait){$this.hideWait();}}});var xhr=new mstrmojo.SimpleXHR();xhr.request("POST",mstrConfig.taskURL,{success:function(res){if(newCallback.success){newCallback.success(res);}},failure:function(res){if(newCallback.failure){newCallback.failure({code:res.getResponseHeader("X-MSTR-TaskErrorCode"),message:res.getResponseHeader("X-MSTR-TaskFailureMsg")});}},complete:function(){if(newCallback.complete){newCallback.complete();}}},params);},0);}catch(ex){mstrmojo.err(ex);}},serverRequestParallel:function serverRequestParallel(params,callback,showWait,suppressError,displayMsg,msgid,alertCfg){if(showWait===true){this.showWait(displayMsg);}if(!params.sessionState&&this.sessionState){params.sessionState=this.sessionState;}params.msgid=msgid||mstrApp.msgid;try{var $this=this;window.setTimeout(function(){var failureHandler=callback.failure;callback.failure=function failure(res){handleServerRequestFailure(res,failureHandler,alertCfg);};var newCallback=mstrmojo.func.wrapMethods(callback,{complete:function complete(){if(showWait){$this.hideWait();}}});var xhr=new mstrmojo.SimpleXHR();xhr.request("POST",mstrConfig.taskURL,{success:function(res){if(newCallback.success){newCallback.success(res);}},failure:function(res){if(newCallback.failure){newCallback.failure({code:res.getResponseHeader("X-MSTR-TaskErrorCode"),message:res.getResponseHeader("X-MSTR-TaskFailureMsg")});}},complete:function(){if(newCallback.complete){newCallback.complete();}}},params);},0);}catch(ex){mstrmojo.err(ex);}},getSearchAutoCompleteDelay:mstrmojo.emptyFn});window.$MAPF=function(){return false;};}());