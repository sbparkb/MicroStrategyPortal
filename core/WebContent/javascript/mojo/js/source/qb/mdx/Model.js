(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.warehouse.EnumDatabaseType","mstrmojo.warehouse.EnumDataChangeEvents","mstrmojo.DI.DIConstants");mstrmojo.requiresDescs(12370);var $H=mstrmojo.hash,$A=mstrmojo.array,$S=mstrmojo.string,$ENUM_DATABASE_TYPE=mstrmojo.warehouse.EnumDatabaseType,CUBES_CHANGED=mstrmojo.warehouse.EnumDataChangeEvents.DBTABLES_CHANGED,CUBES_REQUESTED=mstrmojo.warehouse.EnumDataChangeEvents.DBTABLES_REQUESTED,$MNU_ACTIONS=mstrmojo.architect.menu.EnumMenuActions,DBROLE_SUBTYPE_DI=7425,DBROLE_SUBTYPE_DI_PRIMARY=7426,$DIConstants=mstrmojo.DI.DIConstants;mstrmojo.qb.mdx.Model=mstrmojo.declare(mstrmojo.warehouse.WHModel,null,{scriptClass:"mstrmojo.qb.mdx.Model",cubes:[],dbRoleEditorCfg:{hideDSNOption:true,hideDriverCheck:true,dbIdFilter:[36,37,38,39],help:"Creating_a_data_source_connection_to_an_OLAP_source.htm"},dbObjectsDisplayOptions:2,dbRolesTypeFilter:[$ENUM_DATABASE_TYPE.SAP,$ENUM_DATABASE_TYPE.MSAS,$ENUM_DATABASE_TYPE.EssBase,$ENUM_DATABASE_TYPE.TM1],recursive:0,addCubes:function addCubes(data){var cubes=[],me=this;if(!this.canAddCube(false)){return ;}mstrmojo.array.forEach(data,function(cube){cubes.push({n:cube.n&&cube.n.toString(),tp:cube.cubetp.toString(),des:cube.des&&cube.des.toString(),ctn:cube.ctn,tn:cube.tn&&cube.tn.toString(),isNew:true,dbrid:me.SelDBRoleID});});me.cubes=me.cubes.concat(cubes);mstrApp.getRootController().getDataService().pollingStatus({success:function success(){me.raiseEvent({name:"refreshTables",items:me.cubes.slice(0)});}},null,mstrmojo.desc(12370,"Please wait..."));},canAddCube:function canAddCube(silent){if(this.cubes.length>0){if(!silent){this.raiseEvent({name:"maxCubeError"});}return false;}return true;},commitChanges:function commitChanges(callback){var me=this,addCubes=function(cb){var recursive=me.recursive.toString();$A.forEach(me.cubes,function(cube){cube.rec=recursive;});mstrApp.getRootController().getDataService().addCubes(cb,{cubes:JSON.stringify(me.cubes),tbid:me.tableID,dbrid:me.cubes[0].dbrid,showWait:true});},saveCubes=function(cb){if(me.isManagedCube){if(cb&&cb.success){cb.success();}}else{var getFolderCallback={success:function(res){if(res&&res.items&&res.items.length===1){me.folderID=res.items[0].fid;}me.submitRequest(cb,{taskId:"saveAndPublishCube",displayMode:12,shouldRefresh:false,saveAsFlags:$DIConstants.saveAsFlags.saveAsDDA|$DIConstants.saveAsFlags.saveAsOverWrite,folderID:me.folderID||"",objName:me.cubeName||"",objDesc:me.cubeDesc||"",showWait:true});}};if(!me.folderID&&me.cubeID){mstrApp.getRootController().getDataService().getObjectFolder(getFolderCallback,{dids:me.cubeID,types:3});}else{getFolderCallback.success();}}};if(this.original){if(me.cubes[0].isNew){addCubes({success:function success(){saveCubes(callback);}});}else{saveCubes(callback);}}else{addCubes({success:function success(){saveCubes(callback);}});}},removeCube:function removeCube(index){mstrmojo.array.removeIndices(this.cubes,index,1);this.raiseEvent({name:"refreshTables",items:this.cubes.slice(0)});},updateCube:function updateCube(){var me=this;mstrApp.getRootController().getDataService().updateCubes({success:function success(){me.raiseEvent({name:"refreshTables",items:me.cubes.slice(0)});}},{tbid:me.tableID,showWait:true});},initialize:function initialize(){var model=this,isNew=model.isNew=!mstrApp.tableID,$MDX_XDA_TYPE=2,$MDX_CONNECTOR_TYPE=327681,dataService=mstrApp.getRootController().getDataService(),createEmmaTable=function createEmmaTable(){dataService.createEmmaTable({success:function success(res){model.tableID=res.tbid;model.isFREnabled=res.frFlag;mstrApp.msgid=res.msgid;}},{xt:$MDX_XDA_TYPE,dict:$MDX_CONNECTOR_TYPE});};model.tableID=mstrApp.tableID;model.folderID=mstrApp.folderID;model.cubeName=mstrApp.cubeName;model.cubeDesc=mstrApp.cubeDesc;model.cubeID=mstrApp.reportID;mstrApp.msgid=mstrApp.msgID;model.cubes=[];model.dbtbls={};model.original=undefined;model.SelDBRoleID=undefined;model.recursive=0;if(isNew){if(mstrApp.msgid){createEmmaTable();}else{dataService.createEmmaInstance({success:function success(res){mstrApp.msgid=res.msgid;createEmmaTable();}});}}else{model.loadTable(model.tableID);}},loadTable:function loadTable(tableID){var me=this;me.tableID=tableID;me.submitRequest({success:function success(res){var table=res.datap.srce,dbroleID=table.dbrid,tableAlias=table.tbal&&table.tbal.toString(),recursive=table.recurisve||0;me.original=table;me.cubes.push({n:tableAlias,tp:table.dbtp&&table.dbtp.toString(),des:table.des&&table.des.toString(),ctn:table.ctn,tn:tableAlias});me.raiseEvent({name:"refreshTables",items:me.cubes.slice(0)});me.set("SelDBRoleID",dbroleID);me.set("recursive",recursive);}},{taskId:"qBuilder.GetReportXDADefinition",showWait:true,tableID:tableID,browsetype:4,previewflag:8});},_set_SelDBRoleID:function _set_SelDBRoleID(n,dbRoleID){var model=this,changed=(model.SelDBRoleID!==dbRoleID),$ENUM_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents;if(this._super){this._super(n,dbRoleID);}model.SelDBRoleID=dbRoleID;if(changed&&dbRoleID){mstrApp.getRootController().getDataService().setDBRole({success:function success(res){mstrApp.msgid=res.msgid;}},{dbrid:dbRoleID,tbid:model.tableID});}$A.forEach(model.dbrs,function(dbr){if(dbr.data.isPrimary){dbr.data.isPrimary=false;model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED,item:dbr});}if(dbr.did===dbRoleID){dbr.data.isPrimary=true;model.raiseEvent({name:$ENUM_DATA_CHANGE_EVENTS.DBROLE_CHANGED,item:dbr});var footerID=mstrApp.diFooterID,footer=footerID?mstrmojo.all[footerID]:undefined;if(footer){footer.mdxRA.update((!model.isNew||model.isFREnabled)&&!model.hasNonRADataset&&(dbr.mdDBRole.db_type===$ENUM_DATABASE_TYPE.EssBase||dbr.mdDBRole.db_type===$ENUM_DATABASE_TYPE.MSAS));}}});return changed;},getNameSpaces:function getNameSpaces(){var dbRoleID=this.SelDBRoleID;this.raiseEvent({name:mstrmojo.warehouse.EnumDataChangeEvents.NAMESPACES_CHANGED,namespaces:undefined,namespaceMode:mstrmojo.warehouse.EnumNamespaceMode.ALL,dbRoleID:dbRoleID,namespace:undefined});},getSelectedDBRoleTables:function getSelectedDBRoleTables(params){var model=this,dbRoleID=model.SelDBRoleID,dbts=model.dbtbls,blockCount=params.blockCount,filterText=params.filterText,dbRole=model.getDBRole(dbRoleID),isPopulated=false,hasCube,result=[],filteredArray=[],fullTableList=[],filteredCubes,item,cubes,cubeInfos,cachedCatalogs=dbts[dbRoleID],catalogName,expandedIndices={};if(!dbRole){return ;}if(!model.catalogRefresh&&cachedCatalogs!==undefined){filterText=filterText&&filterText.toUpperCase();$H.forEach(cachedCatalogs,function(catalog,catalogTechName){isPopulated=true;catalogName=$S.decodeHtmlString(catalog.n);cubeInfos=[];cubes=catalog.cuis;cubes=[].concat((cubes&&cubes.cui)||[]);hasCube=false;filteredCubes=[];if(filterText!==""){$A.forEach(cubes,function(cube){if(cube.n.toUpperCase().indexOf(filterText)>-1){filteredCubes.push(cube);hasCube=true;}});}else{filteredCubes=cubes;hasCube=true;}if(hasCube){item=new mstrmojo.warehouse.obj.TableData({id:catalogTechName,n:catalogName,tn:catalogTechName,tp:15,model:model,ns:""});item.items=filteredCubes.slice(0);filteredArray.push(item);}});if(isPopulated){if(filterText!==""){$A.forEach(filteredArray,function(item,idx){expandedIndices[idx]=true;});}model.raiseEvent({name:CUBES_CHANGED,items:filteredArray,expandedIndices:expandedIndices,selectedItems:model.getDBRoleTablesInUse(dbRoleID)||[]});return ;}}cachedCatalogs=dbts[dbRoleID]={};model.raiseEvent({name:CUBES_REQUESTED,sourceInfo:params.sourceInfo||""});this.submitRequest({success:function(res){var catalogs=res.mi.cas,catalogName,catalogTechName;model.catalogRefresh=false;catalogs=[].concat((catalogs&&catalogs.ca)||[]);$A.forEach(catalogs,function(catalog,idx){catalogName=$S.decodeHtmlString(catalog.n&&catalog.n.toString());catalogTechName=$S.decodeHtmlString(catalog.tn&&catalog.tn.toString())||catalogName;if(!cachedCatalogs[catalogTechName]){cachedCatalogs[catalogTechName]=catalog;cubeInfos=[];cubes=catalog.cuis;cubes=[].concat((cubes&&cubes.cui)||[]);$A.forEach(cubes,function cubeHandler(cube){cube.cubetp=cube.tp;cube.tp=26;cube.ctn=catalogName;cube.tn=catalogTechName;cube.n=cube.n&&cube.n.toString();cube.des=cube.des&&cube.des.toString();cubeInfos.push(cube);});item=new mstrmojo.warehouse.obj.TableData({id:catalogTechName,n:catalogName,tp:15,model:model,ns:"",did:catalogName,items:cubeInfos});cachedCatalogs[catalogTechName].cubes=cubeInfos;fullTableList.push(item);if(idx<blockCount){result.push(item);}}});model.raiseEvent({name:CUBES_CHANGED,items:fullTableList,selectedItems:model.getDBRoleTablesInUse(dbRoleID)||[]});},failure:function failure(){model.raiseEvent({name:CUBES_CHANGED,items:fullTableList,selectedItems:model.getDBRoleTablesInUse(dbRoleID)||[]});}},{taskId:"qBuilder.FetchSourceObjects",dbRoleID:dbRoleID,mdx:1,showWait:false});},getColumnsForDBTable:function getColumnsForDBTable(params,callbacks){var model=this,dbRoleID=params.data.dbrole||model.SelDBRoleID,data=params.data,dbTableName=data.n,dbTableId=data.did,cubes=model.dbtbls[dbRoleID][dbTableId].cubes;callbacks.success({src:params,items:cubes,selDBRole:dbRoleID});model.raiseEvent({name:"dbTablesPopulated",items:{id:dbTableName,n:dbTableName,items:cubes}});if(callbacks&&callbacks.complete){callbacks.complete();}},handleVisibleAction:function handleVisibleAction(data,item){var visible;if(!item){return true;}if(item.action===$MNU_ACTIONS.EDIT){visible=data.tp===DBROLE_SUBTYPE_DI||data.tp===DBROLE_SUBTYPE_DI_PRIMARY;}else{visible=this._super(data,item);}return visible;},submitRequest:function submitRequest(callback,params,fn){mstrApp.getRootController().getDataService()[fn||"submitRequest"](callback,params);}});}());