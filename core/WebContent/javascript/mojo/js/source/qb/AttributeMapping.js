(function(){mstrmojo.requiresCls("mstrmojo.Table","mstrmojo.Label","mstrmojo.Box","mstrmojo.TreeBrowser","mstrmojo.fx","mstrmojo.array","mstrmojo.hash");mstrmojo.requiresDescs(221,1442,8117,8953,9135,12911);function isIDFormMapped(currentMapping,selections){var i,j,item,hashMap={};var checkIDForm=function checkIDForm(item){if(item.selected){if(item.ipa){hashMap[item.oid]=hashMap[item.oid]||(item.fmn==="ID");}}};for(i=0;i<currentMapping.length;i++){item=currentMapping[i];if(item.isMultiForm){for(j=0;j<item.subColumns.length;j++){checkIDForm(item.subColumns[j]);}}else{checkIDForm(item);}}if(!hashMap[selections[0].aid]&&selections[0].n!=="ID"){return false;}else{return true;}}var STR_SUGGEST=mstrmojo.desc(8953,"Suggestions"),STR_NOMATCH=mstrmojo.desc(9135,"No match found"),_D=mstrmojo.dom,_C=mstrmojo.css,_H=mstrmojo.hash,$ARR=mstrmojo.array,OFFSET_WIDTH=16,cachedSearchPattern,cachedSearchResult;function getAttributeForms(data,callbacks){var attributeID=data.did,attributeName=data.n,taskCallback={success:function(res){if(res.container){var forms=res.container.dssforms||[],i,len;for(i=0,len=forms.length;i<len;i++){forms[i].aid=attributeID;forms[i].an=attributeName;forms[i].did=attributeID+forms[i].dssid;forms[i].idf=forms[0].dssid;}if(callbacks&&callbacks.success){callbacks.success({items:forms});}}}},taskParam={attributeID:attributeID,displayedForms:0};mstrApp.getRootController().getDataService().getAttributeForms(taskCallback,taskParam);}function displayError(msg){var bar=this.status;bar.set("text",msg);bar.set("title",msg);_C.addClass(bar.domNode,"error");this.adjustPosition();}function onsearch(){var input=mstrmojo.string.trim(this.inputNode.value),me=this,isQuickSearch,callback,taskParams;if(!input){return ;}callback={success:function success(res){var items=[],hasMatch;cachedSearchPattern=cachedSearchPattern.toLowerCase();mstrmojo.array.forEach(res.items,function(item){if(item.n.toString().toLowerCase().indexOf(cachedSearchPattern)===0){items.push(_H.copy({items:[],st:-5},item));}});cachedSearchResult=items;hasMatch=items.length>0;me.status.set("text",hasMatch?STR_SUGGEST:STR_NOMATCH);me.statusNode.style.display="block";me.set("showContent",hasMatch);_C.removeClass(me.status.domNode,"error");me.children[0].set("items",items);},failure:function failure(res){if(me.showTaskError){mstrmojo.alert(mstrmojo.desc(8117,"Data request failed:")+" \n"+res.getResponseHeader("X-MSTR-TaskFailureMsg").replace(/com\.microstrategy\.(.*): \((.*)\)/,"$2"));}},complete:function complete(res){if(me.spinnerNode){me.spinnerNode.style.display="none";}if(me.postFetch){me.postFetch();}}};if(typeof microstrategy!=="undefined"&&microstrategy.useQuickSearch){isQuickSearch=microstrategy.useQuickSearch();}else{isQuickSearch=false;}if(cachedSearchPattern&&input.indexOf(cachedSearchPattern)===0&&cachedSearchResult.length<this.blockCount){cachedSearchPattern=input;callback.success({items:cachedSearchResult});return ;}cachedSearchPattern=input;if(this.spinnerNode){this.spinnerNode.style.display="block";}taskParams={styleName:"MojoFolderStyle",nameWildcards:isQuickSearch?16:1,blockBegin:this.blockBegin||1,blockCount:this.blockCount,recursive:true,includeAncestorInfo:true,objectType:"12",quickSearch:isQuickSearch};taskParams.searchPattern=isQuickSearch?input:input+"*";mstrApp.getRootController().getDataService().searchMetadata(callback,taskParams);}mstrmojo.qb.AttributeMappingTreeBrowserNode=mstrmojo.declare(mstrmojo.TreeBrowserNode,null,{scriptClass:"mstrmojo.qb.AttributeMappingTreeBrowserNode",markupString:'<div id="{@id}" class="mstrmojo-TreeNode {@cssClass}" style="{@cssText}" title="{@title}" mstrAttach:mousedown,click,dblclick><div class="mstrmojo-TreeNode-div"><img class="mstrmojo-TreeNode-state" src="../images/1ptrans.gif" /><img class="mstrmojo-TreeNode-checkBox" src="../images/1ptrans.gif" /><span class="mstrmojo-TreeNode-text {@textCssClass}"></span></div><div class="mstrmojo-TreeNode-itemsContainer">{@itemsHtml}</div></div>',premousedown:function premousedown(evt){if(this._super){this._super(evt);}var D=mstrmojo.dom,t=mstrmojo.dom.eventTarget(evt.hWin,evt.e),isLeaf=(this.state===2),toggleOnClick=(this.tree.branchClickPolicy===mstrmojo.TreeBrowserEnum.BRANCH_POLICY_TOGGLE);if(this.isSpecialNode()||!(t===this.checkBoxNode||((t===this.textNode||t===this.displayNode)&&(isLeaf||!toggleOnClick)))){D.stopPropogation(evt.hWin,evt.e);}else{this.tree.raiseEvent({name:"formSelected",evt:evt,target:t});}}});mstrmojo.qb.AttributeMapping=mstrmojo.declare(mstrmojo.Container,[mstrmojo._IsPopup],{scriptClass:"mstrmojo.qb.AttributeMapping",markupString:'<div id="{@id}"  class="mstrmojo-Editor {@cssClass}" style="top:{@top};left:{@left};" mstrAttach:mousedown><div style="z-index:{@zIndex};{@cssText}" mstrAttach:mousedown><div class="mstrmojo-qb-mapping-searchbox" mstrAttach:click ><input class="mstrmojo-SearchBox-input mstrmojo-qb-mapping-searchinput" type="text"  mstrAttach:keyup,blur/><span class="mstrmojo-qb-mapping-spinnerbox" style="width:20px;"><span class="mstrmojo-SearchBox2-spinner" id="{@id}sbSpinner"></span></span></div><div class="mstrmojo-qb-mapping-search-status"></div><div class="mstrmojo-qb-mapping-search-content"><div class="mstrmojo-di-mapping-search-tree" style="float:left"></div><div class="mstrmojo-di-mapping-search-form"></div></div><div class="mstrmojo-qb-mapping-buttons"></div></div><div class="mstrmojo-Editor-curtain"></div></div>',markupSlots:{contentNode:function(){return this.domNode.firstChild.childNodes[2];},treeNode:function(){return this.domNode.firstChild.childNodes[2].firstChild;},formNode:function(){return this.domNode.firstChild.childNodes[2].lastChild;},inputNode:function(){return this.domNode.firstChild.firstChild.firstChild;},spinnerNode:function(){return this.domNode.firstChild.firstChild.lastChild.lastChild;},buttonNode:function(){return this.domNode.firstChild.childNodes[3];},statusNode:function(){return this.domNode.firstChild.childNodes[1];},curtainNode:function(){return this.domNode.lastChild;}},blockCount:50,cssClass:"mstrmojo-qb-mapping-editor",init:function init(props){this._super(props);this.tree.attachEventListener("formSelected",this.id,"updateFormSelector");},updateFormSelector:function updateFormSelector(evt){var src=evt.evt.src;var data=this.target.data[0];if(data.isMultiForm){if(src.text==="ID"){this.attrName.set("text",data.alias+"<br>ID");}else{var alias=data.alias+"_"+src.text;if(!src.selected){var subCols=data.subColumns;var options=[];mstrmojo.array.forEach(subCols,function(subCol,i){if(subCol.fmn!=="ID"){options.push({n:subCol.fmn,v:i});}});this.addChildren(mstrmojo.insert({scriptClass:"mstrmojo.DropDownList",cssClass:"mstrmojo-di-mapping-form-list",slot:"formNode",options:options,alias:alias}));}else{this.removeChildren(this[alias]);}this.renderChildren();}}},children:[{scriptClass:"mstrmojo.TreeBrowser",slot:"treeNode",alias:"tree",noCheckBox:false,itemIdField:"did",cssClass:"mstrmojo-qb-mapping-tree",items:[],itemFunction:function ifn(item,idx,w){var tree=w.tree||w,itemWidget,attributePath=[],attributePathStr="";if(item.anc&&item.anc.items){$ARR.forEach(item.anc.items,function(element){attributePath.push(element.n||"");});}if(attributePath.length>0){attributePathStr="\\"+attributePath.join("\\");}itemWidget=new mstrmojo.qb.AttributeMappingTreeBrowserNode({data:item,state:0,parent:w,tree:tree,multiSelect:w.multiSelect,text:item[w.itemDisplayField],textCssClass:tree.item2textCss(item),items:item[w.itemChildrenField],itemIdField:w.itemIdField,itemDisplayField:w.itemDisplayField,itemIconField:w.itemIconField,itemChildrenField:w.itemChildrenField,itemFunction:w.itemFunction,listSelector:w.listSelector,title:attributePathStr,selectionPolicy:"toggle"});return itemWidget;},isBranch:function isBranch(data){return data.items;},item2textCss:function item2textCss(data){return("mstrmojo-qb-ListIcon "+(data.items?"t12":"t21"));},selectionAcrossBranch:false,listSelector:mstrmojo.ListSelector,multiSelect:true,getContentThroughTaskCall:function getContentThroughTaskCall(params,callbacks){var me=this;if(params.isRoot){callbacks.success(me.items);}else{getAttributeForms(params.data,callbacks);}}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-mapping-form-name",slot:"formNode",alias:"attrName"},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-qb-mapping-status",slot:"statusNode",alias:"status",text:STR_SUGGEST},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-qb-mapping-buttonbox",slot:"buttonNode",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-qb-attributelink-button",cssText:"float: right",text:mstrmojo.desc(1442,"OK"),onclick:function(evt){var attrMappingEditor=this.parent.parent,selections=attrMappingEditor.children[0].getTotalSelections(),model,mappings,obj,callback,i,j,currentMapping;attrMappingEditor.close();if(selections&&selections.length>0){model=mstrApp.getRootController().model;mappings=attrMappingEditor.cols;var ddlAlias,index;for(i=0;i<mappings.length;i++){obj=mappings[i];currentMapping=model.importSources[obj.tableId].currentMapping;if(!isIDFormMapped(currentMapping,selections)){var errorMsg=mstrmojo.desc(12911,"Key attribute form ID of attribute ## has not been mapped.").replace("##",selections[0].an);mstrApp.getRootController().displayError(errorMsg);return ;}}for(i=0;i<mappings.length;i++){obj=mappings[i];obj.ipa=1;obj.tp=12;if(obj.isMultiForm){for(j=0;j<selections.length;j++){obj.subColumns[j].ipa=1;if(j===0){obj.subColumns[0].oid=selections[0].aid;obj.subColumns[0].fmid=selections[0].dssid;}else{ddlAlias=obj.alias+"_"+selections[j].n;index=attrMappingEditor[ddlAlias].selectNode.value;obj.subColumns[index].oid=selections[j].aid;obj.subColumns[index].fmid=selections[j].dssid;}}}else{obj.oid=selections[0].aid;obj.fmid=selections[0].dssid;}obj.nochange=true;}callback={failure:function(res){displayError.call(attrMappingEditor,res);}};model.mapAttribute(obj,selections[0],callback,obj.oid);}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-qb-attributelink-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(evt){var attrMappingEditor=this.parent.parent;attrMappingEditor.close();}}]}],onEnter:function(){onsearch.call(this);},onEsc:function(){if(this.onCancel){this.onCancel();}this.close();},close:function(){var node;_D.detachEvent(document.body,"mousedown",this._close_handler);if(this.target){_C.toggleClass(this.target.domNode,"highlight",false);}this.buttonNode.style.display="none";this.statusNode.style.display="none";this.slideProp(false,this.contentNode,95);this.slideProp(false,this.inputNode,16);node=this.domNode;self.setTimeout(function(){document.body.removeChild(node);},510);},onkeyup:function onkeyup(evt){var hWin=evt.hWin,newEvent=evt.e||hWin.event;if(this.onEnter&&newEvent.keyCode===13){this.onEnter();return ;}if(this.onEsc&&newEvent.keyCode===27){this.onEsc();return ;}if(typeof microstrategy!=="undefined"&&microstrategy.enableQuickSearch){if(this._autoSearchTimer){self.clearTimeout(this._autoSearchTimer);}var searchAutoCompleteDelay=microstrategy.searchAutoCompleteDelay,me=this;if(searchAutoCompleteDelay){this._autoSearchTimer=self.setTimeout(function(){onsearch.call(me);},searchAutoCompleteDelay);}}else{onsearch.call(this);}},slideProp:function(show,node,height){var animate,props={target:node,props:{height:{start:(show?0:height),stop:(show?height:0),suffix:"px"}}};animate=new mstrmojo.fx.AnimateProp(props);animate.play();},onshowContentChange:function onshowContentChange(){if(this.showContent){this.contentNode.style.display="block";this.slideProp(true,this.contentNode,95);this.buttonNode.style.display="block";}else{this.contentNode.style.display="none";this.buttonNode.style.display="none";}},attachMousedownEvent:function attachMousedownEvent(){var me=this;if(!this._close_handler){this._close_handler=function(){if(!me.isOnMe(_D.eventTarget(self,arguments[0]))){me.close();}};}_D.attachEvent(document.body,"mousedown",this._close_handler);},isOnMe:function isOnMe(t){return _D.contains(this.domNode.firstChild,t,true,document.body);},adjustPosition:function adjustPosition(){var root=this.domNode,box=root.firstChild,height=box.offsetHeight,width=box.offsetWidth,wDim=_D.windowDim(),pos=_D.position(box,false);if((pos.x+width+OFFSET_WIDTH)>wDim.w){box.style.left=wDim.w-width-OFFSET_WIDTH+"px";}if((pos.y+height+OFFSET_WIDTH)>wDim.h){box.style.top=wDim.h-height-OFFSET_WIDTH+"px";}},onOpen:function onOpen(){var inputNode=this.inputNode;this.tree.set("items",[]);inputNode.value="";this.set("showContent",false);this.statusNode.style.display="none";if(!mstrmojo.dom.isWK){this.slideProp(true,inputNode,16);}inputNode.focus();this.attachMousedownEvent();}});}());