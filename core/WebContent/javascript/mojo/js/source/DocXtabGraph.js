(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.GraphBase","mstrmojo._Formattable","mstrmojo._IsSelectorTarget","mstrmojo.tooltip");var $D=mstrmojo.dom,$ARR=mstrmojo.array,EnumDSSXMLDrillType=mstrmojo.mstr.EnumDSSXMLDrillType;function adjustGraphHeight(w){var f=w.getFormats();if(!f.width&&"gp" in f){f=f.gp;}w.resizeForDisplayState(parseInt(f.height,10),parseInt(f.width,10),false);}function getDrillCss(drillType){var css="";switch(drillType){case EnumDSSXMLDrillType.DssXmlDrillToChild:css="drillDown";break;case EnumDSSXMLDrillType.DssXmlDrillToParent:css="drillUp";break;case EnumDSSXMLDrillType.DssXmlDrillToTemplate:css="drillTemplate";break;}return css;}function getDrillPosition(area,e){var x=e.offsetX,y=e.offsetY,coords=area.coords.split(",");switch(area.shape){case"rect":case"poly":break;case"circle":x=coords[0];y=coords[1];}return{x:x,y:y};}function sortDrillPaths(a,b){var atp=parseInt(a.tp,10),btp=parseInt(b.tp,10);if(atp>btp){return 1;}if(btp>atp){return -1;}return(a.n<b.n?-1:1);}function _getEventPos(e){var domNodePosition=$D.position(this.domNode),mousePosition=$D.getMousePosition(e);return{x:mousePosition.x-Math.floor(domNodePosition.x),y:mousePosition.y-Math.floor(domNodePosition.y)};}function getOverlappedItems(e,win){var t=$D.eventTarget(win,e),p=t&&t.parentNode,c=p&&p.children,as=[],coords=t.getAttribute("coords");if(c&&!!coords){for(var i=0;i<c.length;++i){if(c[i]&&c[i].getAttribute&&c[i].getAttribute("coords")==coords){as.push(c[i]);}}}return as;}function processHyperLink(me,e,area,i,j){return function(){var params={taskId:"getElementFromGraph",msgID:me.model.docModel.mid,nodeKey:me.node.k,sliceID:me.node.data.sid,x:e.layerX,y:e.layerY},cb={success:function(res){var cell={mix:i,els:res.els},action=me.model.getLinkActionImpl(cell,area,j);me.controller.onLink(me,action);},failure:function(res){}};mstrmojo.xhr.request("POST",mstrConfig.taskURL,cb,params);};}mstrmojo.DocXtabGraph=mstrmojo.declare(mstrmojo.GraphBase,[mstrmojo._Formattable,mstrmojo._IsSelectorTarget,mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.DocXtabGraph",cssClassPrefix:"mstrmojo-DocXtabGraph",areaMarkup:'<area shape="{@shape}" coords="{@coords}" ttl="{@tooltip}" aid="{@aid}" onclick="mstrmojo.all[\'{@id}\'].onClickArea(this, event);" oncontextmenu="mstrmojo.all[\'{@id}\'].onContextMenu(this, event);" onmousemove="mstrmojo.all[\'{@id}\']._updateTooltip(event, self);" {@extra}/>',_att:"",markupSlots:{imgNode:function(){return this.domNode.childNodes[1];},mapNode:function(){return this.domNode.childNodes.length>2?this.domNode.childNodes[2]:null;},textNode:function(){return this.domNode.firstChild;}},formatHandlers:{domNode:["RW","B","background-color","fx"]},markupMethods:{onvisibleChange:function(){this.domNode.style.display=(this.visible)?"block":"none";}},onClickArea:function onClickArea(elem,e){e=e||window.event;var ep=_getEventPos.apply(this,[e]),defn=this.defn,domNodePosition=$D.position(this.domNode),area=this.as[elem.getAttribute("aid")],key=this.k,x=ep.x,y=ep.y,anchor={getBoundingClientRect:function(){var left=domNodePosition.x+x,top=domNodePosition.y+y;return{left:left,top:top,right:left+1,bottom:top+1};},w:this};this.showInfoWin(area.ifw,area.tks,anchor);this.model.docModel.slice({type:parseInt(defn.t,10)||mstrmojo.EnumRWUnitType.GRAPH,src:key,ck:defn.ck,gk:key,tks:area.tks,cks:area.cks,sid:this.node.data.sid,x:x,y:y,anchor:anchor,tty:area.tty});},onContextMenu:function onContextMenu(elem,e){e=e||window.event;var me=this,formats=this.getFormats(),gH=parseInt(formats.height,10),gW=parseInt(formats.width,10),area=this.as[elem.getAttribute("aid")],lm=area.lm||[],dp=area.dp||[];mstrmojo.dom.preventDefault(window,e);var cfg=new mstrmojo.ui.menus.MenuConfig({hostId:this.id,isHostedWithin:false,hostElement:this,position:{x:e.pageX,y:e.pageY}});if(lm.length!==0){cfg.addPopupMenuItem(mstrmojo.desc(5752,"Links"),this.id,function(){var subCfg=new mstrmojo.ui.menus.MenuConfig();for(var i=0;i<lm.length;i++){var links=lm[i].links;for(var j=0;j<links.length;j++){subCfg.addMenuItem(links[j].n||links[j].url||(links[j].target&&(links[j].target.n||links[j].target.did)),"",processHyperLink(me,e,area,i,j));}}return subCfg;});}var requestOnDemandDrill=function requestOnDemandDrill(xtab){var drillItems=xtab.onDemandDrillItems;var dynamicItems=xtab.onDemandDrillDynamicItems;if(!xtab.onDemandDrillItems&&!xtab.loadingDCM){xtab.loadingDCM=true;var xhr=new mstrmojo.SimpleXHR({async:false});xhr.request("POST",mstrConfig.taskURL,{success:function success(res){var dynamicMenu=res.dynamicMenus[0];if(dynamicMenu&&dynamicMenu.items){dynamicItems=dynamicMenu.items;}drillItems=res.menuItems;xtab.onDemandDrillItems=drillItems||[];xtab.onDemandDrillDynamicItems=dynamicItems||[];delete xtab.loadingDCM;}},{taskId:"RWOnDemandDrill",styleName:"OndemandDrillContextMenusStyle",viewMode:2,docGridKey:xtab.k,rwb:mstrApp.docModel.bs});}var items=[];$ARR.forEach(dynamicItems,function(itm){var idx=itm.idx,level1Item=drillItems[idx],indices=JSON.parse(level1Item.subMenuIndices||"[]");if(indices.length>0){var subItems=[];mstrmojo.array.forEach(indices,function(idx){subItems.push(drillItems[idx]);});level1Item.items=subItems;}items.push(level1Item);});return items;};var onDemandDrillItems=requestOnDemandDrill(this.model.xtab);if((dp.length>0)||(onDemandDrillItems.length>0)){dp=dp.sort(sortDrillPaths);var pos=getDrillPosition(area,e);cfg.addPopupMenuItem(mstrmojo.desc(145,"Drill"),this.id,function(){var drillMenuCfg=new mstrmojo.ui.menus.MenuConfig({menuCssClass:"drill",isHostedWithin:false,supportsScroll:true,maxHeight:mstrmojo.dom.windowDim().h-50});for(var i=0;i<dp.length;i++){var path=dp[i];drillMenuCfg.addMenuItem(path.n,getDrillCss(path.tp),function graphDrill(){me.controller.onDrillGraph(me,{displayType:2,drillPathKey:this.ctxt.key,x:pos.x,y:pos.y,graphHeight:gH,graphWidth:gW,n:this.ctxt.n,isWithin:this.ctxt.dwi},{});},path);}var clearCachedDrillMenus=function(){me.model.xtab.onDemandDrillItems=null;me.model.xtab.onDemandDrillDynamicItems=null;};$ARR.forEach(onDemandDrillItems,function(item){drillMenuCfg.addPopupMenuItem(item.n,"",function(){var drillSubMenuCfg=new mstrmojo.ui.menus.MenuConfig({menuCssClass:"drill",isHostedWithin:false,supportsScroll:true,maxHeight:350});$ARR.forEach(item.items,function(subItem){drillSubMenuCfg.addMenuItem(subItem.n,getDrillCss(subItem.dt),function(){var sItem=this.ctxt;me.controller.onDrillGraph(me,{displayType:2,drillPathKey:sItem.k,x:pos.x,y:pos.y,graphHeight:gH,graphWidth:gW,n:this.ctxt.n,isWithin:sItem.within},{});clearCachedDrillMenus();},subItem);});return drillSubMenuCfg;});});return drillMenuCfg;});}cfg.addMenuItem(mstrmojo.desc(6089,"Sort graph"),this.id,function(){me.controller.onGetAdvSortData(me,1,-1);});var popup=cfg.newInstance();if(this._lastOpened){mstrmojo.css.removeClass(this._lastOpened?this._lastOpened.popupConfig.hostElement:null,"open");mstrmojo._HasPopup.closePopup.call(this);}mstrmojo._HasPopup.openPopup.call(this,popup);mstrmojo.css.addClass(popup?popup.popupConfig.hostElement:null,"open");return false;},showInfoWin:function showInfoWin(ifw,tks,anchor){var m=this.model.docModel,ifws=[].concat(m.getTargetInfoWin(ifw)).concat(m.getTargetInfoWin(tks));if(ifws&&ifws.length){for(var i=0;i<ifws.length;i++){m.showInfoWin(ifws[i],anchor,"h");}}},showTooltip:function showTooltip(e,win){this._updateTooltip(e,win);var items=getOverlappedItems(e,win);if(items&&items.length>1){mstrmojo.DocXtabGraph.multiTooltip.open(this,e,win,items);}else{this._super(e,win);}},_updateTooltip:function _updateTooltip(evt,win){this.updatingTooltipHelper($D.eventTarget(win,evt),_getEventPos.apply(this,[evt]));},hideTooltip:function hideTooltip(e,win){var elem=$D.eventTarget(win,e);if(elem.getAttribute("aid")===this.cAreaIdx){this.cAreaIdx=-1;var items=getOverlappedItems(e,win);if(items&&items.length>1){mstrmojo.DocXtabGraph.multiTooltip.close(this,e,win,items);}else{this._super(e,win);}}},update:function update(node){this.node.data=node.data;this.as=node.data.as;var sep="\u001E",m=this.model.docModel,cgbm=m.getCGBMap&&m.getCGBMap(),as=this.as||[],i,j;for(i=0;i<as.length;i++){var a=as[i],cgb=a&&a.tgbs;if(cgb){var cgbs=cgb.split(sep);var keys={};for(j=0;j<cgbs.length;j++){var k=cgbm&&cgbm[cgbs[j]];if(k){keys[k]=true;}else{keys[cgbs[j]]=true;}}a.tks=mstrmojo.hash.keyarray(keys).join(sep);}}this.eg=node.data.eg;this.gridInfo=node.data.gsi;if(node.defn&&node.defn.tooltip){this.defaultTooltip=node.defn.tooltip;}var m=this.model;if(m){m.set("data",node.data);}},retrieveGraphSrc:function retrieveGraphSrc(h,w){var src=mstrConfig.taskURL+"?taskId=getRWGraphImage&taskEnv=xhr&__ts__="+(new Date().getTime())+"&messageID="+this.model.docModel.mid+"&nodeKey="+this.k+"&sliceID="+parseInt(this.node.data.sid,10)+"&imgType=4&width="+parseInt(w,10)+"&height="+parseInt(h,10),imgNode=this.imgNode;if(imgNode.src!==src){imgNode.src=src;}},resize:function(){adjustGraphHeight(this);},resizeForDisplayState:function resizeForDisplayState(h,w,doDom){var f=this.getFormats(),imgNode=this.imgNode;if(doDom){var dns=this.domNode.style;dns.top=f.top;dns.left=f.left;dns.height=f.height;dns.width=f.width;}if(imgNode){imgNode.style.height=h+"px";}if(!this.eg){if(h){this.retrieveGraphSrc(h,w);this.refreshMap();}}}});function getTargetWidth(a){var c=a&&a.getAttribute&&a.getAttribute("coords");c=(c&&c.split(","))||[];switch(c.length){case 3:return c[2]*2;case 4:return c[2]-c[0];default:return 10;}}function getMultiPosition(targetWid){var p=[],docw=document.body.offsetWidth,doch=document.body.offsetHeight,maxw=0,maxh=0,x=ttpList[0]&&ttpList[0].domNode?ttpList[0].domNode.offsetLeft:0,y=ttpList[0]&&ttpList[0].domNode?ttpList[0].domNode.offsetTop:0,line=Math.ceil(ttpList.length/2),margin=5,originalX=function(x,tpWid){if(x+targetWid+tpWid+margin>docw){return docw-targetWid-tpWid-margin;}else{if(ttpList.length>1&&x-tpWid-margin<0){return tpWid+margin;}}return x;},originalY=function(y,tpHeight,line){y+=tpHeight;var toph=line==1?tpHeight:(line*tpHeight+(line-1)*margin)/2;if(toph>y){return 0;}else{if(toph+y>doch){return doch-toph*2;}else{return y-toph;}}};for(var i=0;i<ttpList.length;++i){maxw=Math.max(maxw,ttpList[i].containerNode.offsetWidth);maxh=Math.max(maxh,ttpList[i].containerNode.offsetHeight);}x=originalX(x,maxw);y=originalY(y,maxh,line);for(var i=0;i<ttpList.length;++i){if(i%2==0){p.push({l:x+targetWid+margin,t:y});}else{p.push({l:x-ttpList[i].containerNode.offsetWidth-margin,t:y});y+=maxh+margin;}}return p;}var ttpList=[];mstrmojo.DocXtabGraph.multiTooltip={_posMultiTp:function(multiPos){for(var i=0;i<ttpList.length;++i){ttpList[i].domNode.style.left=multiPos[i].l+"px";ttpList[i].domNode.style.top=multiPos[i].t+"px";}},open:function(opener,e,win,as,config){if(!config){config={};}config.e=e;config.win=win;var tw=0;if(as&&as.length){tw=getTargetWidth(as[0]);}for(var i=0;i<as.length;++i){var tp=ttpList[i];if(!tp||!mstrmojo.all[tp.id]){tp=new mstrmojo.Tooltip();var count=0,me=this;tp.optimizePos=function(){count++;if(count>=ttpList.length){count=0;me._posMultiTp(getMultiPosition(tw));}};ttpList.push(tp);}opener.richTooltip.content=as[i]&&as[i].getAttribute("ttl");tp.open(opener,config);}},close:function(){for(var j=ttpList.length-1;j>=0;--j){ttpList[j].close();}ttpList=[];}};}());