(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.dom","mstrmojo.css","mstrmojo.Model","mstrmojo.Container","mstrmojo.List","mstrmojo.WidgetList","mstrmojo.HTMLButton","mstrmojo.Arr","mstrmojo.Label","mstrmojo.Box","mstrmojo.VBox","mstrmojo.HBox","mstrmojo.MenuButton","mstrmojo.ValidationTextBox","mstrmojo.InlineEditBox","mstrmojo.Editor","mstrmojo.Image","mstrmojo.dnd");var $D=mstrmojo.dom,$S=mstrmojo.string,$H=mstrmojo.hash,$A=mstrmojo.array,ATL="attachEventListener",DTL="detachEventListener",FORMAT_LINE=["bc","bs","bw"],FORMAT_RECT=["bgc"].concat(FORMAT_LINE),FORMAT_FONT=["ff","fs","fc","fb","fi","fso","ful"],DEFAULT_ICON="../style/mstr/images/table_icon.png",MIN_CELL_HEIGHT=30,GROUP_TITLE_HEIGHT=36,GROUP_TITLE_TOP_PADDING=10,TRX_CTRL_TEXTFIELD=1,TRX_CTRL_SWITCH=2,TRX_CTRL_LIST=3,TRX_CTRL_SLIDER=4,TRX_CTRL_CALENDAR=5,TRX_CTRL_TIMEPICKER=6,TRX_CTRL_TOGGLE=7,TRX_CTRL_TEXTAREA=8,TRX_CTRL_SIG_CAPTURE=9,TRX_CTRL_RATING=10,TRX_CTRL_RANK=11,TRX_CTRL_STEPPER=12,TRX_CTRL_BARCODE=13,TRX_CTRL_LIKERTSCALE=14,CELL_STYLE_HORIZONTAL=1,CELL_STYLE_VERTICAL=2,SEPARATOR=-1,DEL_CELL=1,ADD_CELL=11,DEL_GRP=2,ADD_GRP=21,DEL_GRP_TTL=22,CHANGE_STYLE=3,TABLE_PROPS=4,CONFIG_TRX=5,CONFIG_SEL=6,CONFIG_NAV=7,CELL_STYLE=8,TXT_STYLE=81,TRX_STYLE=82,NAV_T_STYLE=83,NAV_ST_STYLE=84,SEL_STYLE=85,CONFIG_ICON=9,CS={txt:1,trx:2,nav_t:3,nav_st:4,sel:5};function _exec(model,cmd){return model.bone.exec(cmd);}function _setTableDef(model){if(model.def&&model.fmt){_exec(model,{id:"setTableDef",v:{def:model.persist()},umNow:true});}}function _query(model,cmd,v){return model.bone.queryState(cmd,v);}function _findWidget(t,prop){while(t){if(t[prop]){return t;}t=$D.findWidget(t.domNode.parentNode);}return null;}function rmvItem(arr,idx){var pre=arr[idx-1],cur=arr[idx],N="next";if(pre){pre.set(N,cur[N]);}cur.removeObj();arr.remove(idx);}function _openIconEditor(cell){var id="mstrTCIcon",e=mstrmojo.all[id];if(!e){e=new mstrmojo.Editor({id:id,title:"Configure cell icon",children:[{scriptClass:"mstrmojo.Label",cssDisplay:"inline",text:"Source:"},{scriptClass:"mstrmojo.ValidationTextBox",alias:"urlInput",cssText:"width:200px;",constraints:{},required:true,dtp:mstrmojo.expr.DTP.CHAR,bindings:{value:"this.parent.url"},onvalueChange:function(){this.parent.set("url",this.value);}},{scriptClass:"mstrmojo.Label",cssText:"background-color:grey;",bindings:{src:"this.parent.url"},onsrcChange:function(){var pvn=this.preViewNode;if(pvn){pvn.src=this.src;}},onRender:function(){var img=document.createElement("img");img.src=this.parent.url||"";img.style.margin="auto";img.style.display="block";this.preViewNode=img;this.domNode.appendChild(img);}},{scriptClass:"mstrmojo.HTMLButton",text:"OK",slot:"buttonNode",cssClass:"mstrmojo-Editor-button",cssText:"float:right;",onclick:function(){var e=this.parent;e.opener.set("iconUrl",this.parent.url);e.close();}},{scriptClass:"mstrmojo.HTMLButton",text:"Cancel",slot:"buttonNode",cssClass:"mstrmojo-Editor-button",cssText:"float:right;",onclick:function(){this.parent.close();}}]});}e.open(cell,{url:cell.iconUrl});}function _showCXM(evt,view){var cm=[{n:mstrmojo.desc(11181),did:ADD_CELL},{n:mstrmojo.desc(11183),did:DEL_CELL},{n:"-",did:SEPARATOR},{n:mstrmojo.desc(11182),did:ADD_GRP},{n:mstrmojo.desc(11184),did:DEL_GRP},{n:"-",did:SEPARATOR},{n:"Configure icon...",did:CONFIG_ICON},{n:"Change Cell Style",cmCssClass:"mstrmojo-TC-CXM",did:CELL_STYLE,items:[{n:"Plain Text",did:TXT_STYLE,sty:CS.txt},{n:"Navigation with Title only",did:NAV_T_STYLE,sty:CS.nav_t},{n:"Navigation with Subtitle",did:NAV_ST_STYLE,sty:CS.nav_st},{n:"Selector",did:SEL_STYLE,sty:CS.sel}]},{n:"Change Input Style",did:CHANGE_STYLE},{n:"Configure navigation...",did:CONFIG_NAV},{n:"Configure selector...",did:CONFIG_SEL},{n:mstrmojo.desc(5356),did:TABLE_PROPS},{n:mstrmojo.desc(8240),did:CONFIG_TRX}],e=evt.e,win=evt.hWin,cmPos=$D.getMousePosition(e,win),id="mstrTC-CXM",cx=mstrmojo.all[id];if(!cx){cx=new mstrmojo.MenuButton({cmCssClass:"mstrmojo-TC-CXM",zIndex:1000,id:id,cm:cm,dynamicUpdate:true,queryVisible:function(item){var tgt=this.tgt,g;switch(item.did){case SEPARATOR:return true;case ADD_CELL:return !!_findWidget(tgt,"isGroup");case CONFIG_NAV:var c=_findWidget(tgt,"isCell");sty=c&&c.model.sty;return sty==CS.nav_t||sty==CS.nav_st;case DEL_CELL:g=_findWidget(tgt,"isGroup");c=_findWidget(tgt,"isCell");return c&&g&&g.model&&g.model.cells.length>1;case DEL_GRP:g=_findWidget(tgt,"isGroup");return g&&this.view.model.groups.length>1;case DEL_GRP_TTL:g=_findWidget(tgt,"isGroup");return g;case CONFIG_ICON:case CELL_STYLE:return false;case CONFIG_TRX:case ADD_GRP:case TABLE_PROPS:case TXT_STYLE:case TRX_STYLE:case NAV_T_STYLE:case NAV_ST_STYLE:return true;}return false;},queryChecked:function(item){switch(item.did){case TXT_STYLE:case TRX_STYLE:case NAV_T_STYLE:case NAV_ST_STYLE:case SEL_STYLE:var c=_findWidget(this.tgt,"isCell");sty=c&&c.model.sty;return sty==item.sty;}return false;},executeCommand:function(item){var m=this.view.model,tgt=this.tgt,c=_findWidget(tgt,"isCell"),g=_findWidget(tgt,"isGroup"),gm=g&&g.model,csfn=function(sty){c.model.set("is",sty);};switch(item.did){case ADD_CELL:if(g&&gm){gm.addCell(g.getBottom());}break;case DEL_CELL:if(gm&&c){gm.removeCell($A.indexOf(gm.cells,c.model));}break;case ADD_GRP:if(m){m.addGroup(this.view.getBottom());}break;case DEL_GRP:if(g){m.removeGroup($A.indexOf(m.groups,g.model));}break;case DEL_GRP_TTL:if(gm){gm.removeTitle();}break;case CONFIG_NAV:var node=_findWidget(tgt,"isCell");if(node){_exec(m,{id:"edtLinks",v:{key:node.model.indn.key}});}break;case CONFIG_ICON:_openIconEditor(c.model);break;case CONFIG_TRX:_exec(m,{id:"transactionEdit"});break;case CONFIG_SEL:var node=_findWidget(tgt,"isCell");if(node){_exec(m,{id:"selectorEdit",v:{key:node.model.seln.key}});}case TABLE_PROPS:_exec(m,{id:"edtProps"});break;case TXT_STYLE:case TRX_STYLE:case NAV_T_STYLE:case NAV_ST_STYLE:case SEL_STYLE:c.model.set("sty",item.sty);break;}}});}cx.set("cmPos",cmPos);cx.set("view",view);cx.set("tgt",$D.findWidget($D.eventTarget(win,e)));cx.render();cx.showContextMenu();view.contextMenu=cx;$D.stopPropogation(win,e);$D.preventDefault(win,e);}mstrmojo.platform.FormatUnit=mstrmojo.declare(mstrmojo.Model,null,{scriptClass:"mstrmojo.platform.FormatUnit",tableFormat:null,formatFont:true,formatShape:false,init:function(props){if(this._super){this._super(props);}var fps=FORMAT_FONT,sps=FORMAT_RECT,me=this,ps=[];if(this.formatFont){ps=ps.concat(fps);}if(this.formatShape){ps=ps.concat(sps);}$A.forEach(ps,function(p){me[ATL](p+"Change",me.id,"persist");});},persist:function(){_setTableDef(this.tableFormat.parent);}});mstrmojo.platform.TableFormat=mstrmojo.declare(mstrmojo.Model,null,{scriptClass:"mstrmojo.platform.TableFormat",init:function(props){if(this._super){this._super(props);}var props={tableFormat:this},$FU=mstrmojo.platform.FormatUnit,g=this.g,c=this.c;if(g){$H.make(g,mstrmojo.Model);$H.make(g.t,$FU,props);$H.make(g.r,$FU,{tableFormat:this,formatShape:true,formatFont:false});}if(c){$H.make(c,mstrmojo.Model);$H.make(c.t,$FU,props);if(c.st){$H.make(c.st,$FU,props);}if(this.c.v){$H.make(c.v,$FU,props);}}},persist:function(){var me=this,cfg={isSerializable:function(nodeName,jsons,idx){switch(nodeName){case"h":case"ff":case"fs":case"fc":case"fb":case"fi":case"fso":case"ful":case"bgc":case"bc":case"bs":case"bw":case"r":case"t":case"st":case"v":case"c":case"g":return true;}return false;},convertBoolean:true};return $S.json2xml("fmt",this,cfg);}});mstrmojo.platform.TableModel=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.platform.TableModel",fmt:null,smk:"",dck:"",init:function(props){this._super(props);this.groups=[];$H.make(this.groups,mstrmojo.Arr);if(this.fmt){this.fmt.parent=this;this.fmt=new mstrmojo.platform.TableFormat(this.fmt);}this._setDef(false);},ondefChange:function(evt){this._setDef(true);},_setDef:function(clear){var i=0,def=this.def,sg=this.sg,gs=def&&def.gs,sz=gs&&gs.length;this.smk=def&&def.smk;this.dck=def&&def.dck;if(clear){this.groups.splice(0,this.groups.length);}var pre=null,g;for(;i<sz;i++){gs[i].parent=this;gs[i].tableModel=this;g=new mstrmojo.platform.GroupModel(gs[i]);this.groups.add([g]);if(pre){pre.set("next",g);}pre=g;}if(sg){sg.tableModel=this;this.set("selGroupModel",new mstrmojo.platform.TableSelectorGroupModel(sg));this.groups[ATL]("add",this.selGroupModel.id,"ontgsChange");this.groups[ATL]("remove",this.selGroupModel.id,"ontgsChange");this.selGroupModel.ontgsChange=function(){var len=this.tableModel.groups.length-1,g=this.tableModel.groups[len];g&&this.set("top",parseFloat(g.t)+parseFloat(g.h)+5+"px");};}_setTableDef(this);},onfmtChange:function(evt){this._setFmt(true);},_setFmt:function(clear){var i=0,fmt=this.fmt||{};fmt.parent=this;this.fmt=new mstrmojo.platform.TableFormat(fmt);},addGroup:function(top){var gdef=_exec(this,{id:"newGroup",v:{top:top,th:parseInt(this.fmt.g.h),ch:parseInt(this.fmt.c.h),fmt:this.fmt}})||{},gs=this.groups,len=gs.length-1,g;gdef.parent=this;gdef.tableModel=this;g=new mstrmojo.platform.GroupModel(gdef);gs[len].set("next",g);gs.add([g]);},removeGroup:function(idx){rmvItem(this.groups,idx);},getTRXObjs:function(){var r={};$A.forEach(this.groups,function(g){$A.forEach(g.cells,function(c){if(c.vn.key){r[c.vn.key]=c.tn.text;}});});return r;},setTRXObjs:function(){},persist:function(){var me=this,cfg={isSerializable:function(nodeName,jsons,idx){switch(nodeName){case"tp":return true;case"fmt":return{child:(me.fmt&&me.fmt.persist())||null};case"groups":var child='<def smk="'+me.smk+'" dck="'+me.dck+'"><gs>',gs=me.groups,sz=gs.length,i=0;for(;i<sz;i++){child+=gs[i].persist();}return{child:child+"</gs></def>"};}return false;},convertBoolean:true};return $S.json2xml("table",this,cfg);}});mstrmojo.platform._HasRWObj=mstrmojo.provide("mstrmojo.platform._HasRWObj",{removeObj:function(){var me=this,ch=this.children,tm=this.tableModel,key=this.key;if(tm&&key){_exec(tm,{id:"remove",v:{key:key}});}this.set("key",null);if(ch){$A.forEach(ch,function(c){if(c.removeObj){c.removeObj();}});}}});mstrmojo.platform.TableFieldModel=mstrmojo.declare(mstrmojo.Obj,[mstrmojo.platform._HasRWObj,mstrmojo._HasChidlren,mstrmojo._HasBindings],{scriptClass:"mstrmojo.platform.TableFieldModel",requiredFields:["tableModel","fmtModel"],key:"",top:"",left:"",width:"",height:"",isLine:false,heightAsFont:true,formats:["R","F","P","S"],onFormatChange:function(data){var p=data.prop,id="set"+p,tm=this.tableModel,key=this.key;if(tm&&key){_exec(tm,{id:id,v:{key:key,prop:p,value:this[p]}});}},onPropChange:function(p){if(this.tableModel&&this.key){_exec(this.tableModel,{id:"setProp",v:{key:this.key,prop:p,value:this[p]}});}},_onPropChange:function(id,p){if(this.tableModel&&this.key){_exec(this.tableModel,{id:id,v:{key:this.key,prop:p,value:this[p]}});}},onfsChange:function(){if($A.indexOf(this.formats,"F")>-1&&this.tableModel&&this.heightAsFont){this.set("height",_query(this.tableModel,"pxFromPt",this.fs));}},ontopChange:function(){this.onPropChange("top");},onleftChange:function(){this.onPropChange("left");},onwidthChange:function(){if($A.indexOf(this.formats,"S")>-1||$A.indexOf(this.formats,"W")>-1){this.onPropChange("width");}},onheightChange:function(){if(($A.indexOf(this.formats,"S")>-1||$A.indexOf(this.formats,"H")>-1)&&!this.isLine){this.onPropChange("height");}},init:function(props){if(this._super){this._super(props);}var fmt=this.fmtModel,ps=[];if($A.indexOf(this.formats,"R")>-1){ps=ps.concat(FORMAT_RECT);}if($A.indexOf(this.formats,"F")>-1){ps=ps.concat(FORMAT_FONT);}$H.copyProps(ps,fmt,this);this.initPos();this.bindings=this.bindings?this.bindings:{};var bs=this.bindings;$A.forEach(ps,function(p){bs[p]="this.fmtModel."+p;});ps=FORMAT_RECT.concat(FORMAT_FONT);var l=this.isLine,me=this;$A.forEach(ps,function(p){if(l&&p=="bgc"){return ;}me[ATL](p+"Change",me.id,"onFormatChange");});if(!this.parent){this.initBindings();}},initPos:function(){var me=this,fn=function(p){if(me.key&&me.tableModel){me[p]=_query(me.tableModel,p,me.key);}};if($A.indexOf(this.formats,"P")>-1){fn("top");fn("left");}if($A.indexOf(this.formats,"S")>-1){fn("width");fn("height");}if($A.indexOf(this.formats,"W")>-1){fn("width");}if($A.indexOf(this.formats,"H")>-1){fn("height");}fn("text");},ontextChange:function(){if(this.key&&this.tableModel){_exec(this.tableModel,{id:"setText",v:{key:this.key,fmla:this.text}});}},prekeyChange:function(){var me=this,fn=function(p){if(me.key&&me.tableModel){me.set(p,_query(me.tableModel,p,me.key));}};fn("top");fn("left");fn("width");fn("height");if(this.key&&this.tableModel){this.set("text",_query(this.tableModel,"text",this.key));}}});mstrmojo.platform.GroupModel=mstrmojo.declare(mstrmojo.Obj,[mstrmojo.platform._HasRWObj,mstrmojo._HasChildren,mstrmojo._HasBindings],{scriptClass:"mstrmojo.platform.GroupModel",cells:[],requiredFields:["tableModel"],children:[{alias:"title",scriptClass:"mstrmojo.platform.TableFieldModel",heightAsFont:true,formats:["P","S","F"],bindings:{key:"this.parent.tk"},postApplyProperties:function(){var tm=this.parent.parent;this.tableModel=tm;this.fmtModel=tm.fmt.g.t;this.key=this.parent.tk;}},{alias:"rn",scriptClass:"mstrmojo.platform.TableFieldModel",formats:["P","S","R"],bindings:{gm:"this.parent"},postApplyProperties:function(){var tm=this.parent.parent;this.tableModel=tm;this.fmtModel=tm.fmt.g.r;this.key=this.parent.rk;},updateHeight:function(){var gm=this.gm,cls=gm.cells,sz=cls&&cls.length,i=0,h=0,fmt=this.fmtModel,bd=0;if(fmt.bs!=="none"){bd=_query(this.tableModel,"pxFromPt",fmt.bw);}h=bd;for(;i<sz;i++){var c=cls[i];h+=parseFloat(c.h)+bd;}this.set("height",h+"px");var gt=gm.title;if(gt.key){h+=parseFloat(GROUP_TITLE_HEIGHT);}this.gm.set("h",h+"px");}}],init:function(props){if(this._super){this._super(props);}if(this.children){this.initChildren();}var cells=this.cells,tm=this.parent;this.cells=[];$H.make(this.cells,mstrmojo.Arr,{tableModel:tm,removeObj:function(){$A.forEach(this,function(c){c.removeObj();});}});for(var i=0;i<cells.length;i++){var c=cells[i];c.parent=this;c.tableModel=tm;c=new mstrmojo.platform.CellModel(c);this.cells.add([c]);}this.initBindings();var fmt=tm.fmt,id=this.id,rn=this.rn,cs=this.cells,sz=cs.length,j=0;for(;j<sz;j++){cs[j].initBindings();}this.registerListeners();rn[ATL]("removeCell",id,"onremoveCell");rn[ATL]("addCell",id,"onaddCell");fmt.g.r[ATL]("bsChange",id,"_onborderChange");fmt.g.r[ATL]("bwChange",id,"_onborderChange");fmt.g.t[ATL]("fsChange",id,"adjustTitleTop");},_onborderChange:function(evt){var fmt=this.parent.fmt.g.r;bw=fmt.bw,bs=fmt.bs,w=(bs=="none")?0:_query(this.parent,"pxFromPt",bw);this.cells[0].set("t",parseFloat(this.t)+(this.title.key?parseFloat(GROUP_TITLE_HEIGHT):0)+w+"px");},adjustTitleTop:function(){var fmt=this.parent.fmt.g.t,fs=fmt.fs,h=parseFloat(_query(this.tableModel,"pxFromPt",fs)),gt=this.title,t=parseFloat(this.t);offset=(GROUP_TITLE_HEIGHT>h)?(GROUP_TITLE_HEIGHT-h)/2:0;if(gt&&gt.key){gt.set("top",(t+offset)+"px");}},registerListeners:function(){var cs=this.cells,rn=this.rn,sz=cs.length;$A.forEach(cs,function(c,i){var n=cs[i+1];c.set("next",n);if(!n){c.t_sub=c[ATL]("tChange",rn.id,"updateHeight");c.h_sub=c[ATL]("hChange",rn.id,"updateHeight");}else{if(c.t_sub&&c.h_sub){c[DTL](c.t_sub);c[DTL](c.h_sub);}}});},onremoveCell:function(evt){this.registerListeners();var idx=evt.index,c=this.cells[idx];if(!idx&&c){c.ln.removeObj();}},onaddCell:function(evt){this.registerListeners();var idx=evt.index,c=this.cells[idx];c1=this.cells[idx+1];if(!idx){c.ln.removeObj();if(c1){var def=_exec(this.parent,{id:"addLine",v:{top:c1.t,left:this.rn.left,fmt:this.parent.fmt}});c1.ln.set("key",def.key);}}else{if(!c.ln.key){var def=_exec(this.parent,{id:"addLine",v:{top:c.t,left:this.rn.left,fmt:this.parent.fmt}});c.ln.set("key",def.key);}}},ontChange:function(evt){var t=this.t,gt=this.title,rn=this.rn;if(gt&&rn){if(gt.key){this.adjustTitleTop();rn.set("top",parseFloat(t)+parseFloat(GROUP_TITLE_HEIGHT)+"px");}else{rn.set("top",t);}if(this.next){this.next.set("t",parseFloat(t)+parseFloat(this.h)+"px");}else{var sgm=this.tableModel&&this.tableModel.selGroupModel;sgm&&sgm.set("top",parseFloat(t)+parseFloat(this.h)+5+"px");}}},onhChange:function(evt){if(this.next){this.next.set("t",parseFloat(this.t)+parseFloat(this.h)+"px");}else{var sgm=this.tableModel&&this.tableModel.selGroupModel;sgm&&sgm.set("top",parseFloat(this.t)+parseFloat(this.h)+5+"px");}},onwidthChange:function(evt){var w=this.width,tm=this.parent,cw=_query(tm,"removeBorders",{v:w,fmt:tm.fmt.g.r})+"px",gt=this.title;if(gt&&gt.key){gt.set("width",w);}this.rn.set("width",w);$A.forEach(this.cells,function(c){c.set("width",cw);});},addCell:function(top){var cdef=_exec(this.parent,{id:"newCell",v:{top:top,ch:this.parent.fmt.c.h,fmt:this.parent.fmt,line:true}})||{},cs=this.cells,pre=cs[cs.length-1],c;cdef.parent=this;cdef.tableModel=this.tableModel;c=new mstrmojo.platform.CellModel(cdef);c.initBindings();cs.add([c]);},removeObj:function(){var cs=this.cells;$A.forEach(cs,function(c,idx){rmvItem(cs,idx);});if(this._super){this._super();}if(this.next){this.next.set("t",this.t);}},removeCell:function(idx){rmvItem(this.cells,idx);},persist:function(){var me=this,cfg={isSerializable:function(nodeName,jsons,idx){switch(nodeName){case"rk":case"tk":case"t":case"h":return true;case"cells":var child="",cs=me.cells,sz=cs.length,i=0;for(;i<sz;i++){child+=cs[i].persist();}return{child:child};}return false;},convertBoolean:true};return $S.json2xml("g",this,cfg);}});mstrmojo.platform.CellModel=mstrmojo.declare(mstrmojo.Obj,[mstrmojo.platform._HasRWObj,mstrmojo._HasChildren,mstrmojo._HasBindings],{scriptClass:"mstrmojo.platform.CellModel",requiredFields:["tableModel"],top:"",sty:CS.txt,style:CELL_STYLE_HORIZONTAL,children:[{alias:"ln",scriptClass:"mstrmojo.platform.TableFieldModel",isLine:true,formats:["P","S","R"],onkeyChange:function(){this.parent.lk=this.key;},postApplyProperties:function(){this.fmtModel=this.tableModel.fmt.g.r;this.key=this.parent.lk;}},{alias:"icn",scriptClass:"mstrmojo.platform.TableFieldModel",formats:["P","S"],requiredFields:["tableModel"],bindings:{url:function(){var k=this.key,tm=this.tableModel;return _query(tm,"img",k);}},postApplyProperties:function(){this.key=this.parent.ick;},onkeyChange:function(){this.parent.ick=this.key;}},{alias:"tn",scriptClass:"mstrmojo.platform.TableFieldModel",formats:["P","S","F"],bindings:{fmtModel:"this.tableModel.fmt.c.t"},onkeyChange:function(){this.parent.tk=this.key;},postApplyProperties:function(){this.fmtModel=this.tableModel.fmt.c.t;this.key=this.parent.tk;}},{alias:"stn",scriptClass:"mstrmojo.platform.TableFieldModel",formats:["P","S","F"],bindings:{key:"this.parent.stk",fmtModel:"this.tableModel.fmt.c.st"},onkeyChange:function(){this.parent.stk=this.key;},postApplyProperties:function(){this.fmtModel=this.tableModel.fmt.c.st;this.key=this.parent.stk;}},{alias:"vn",scriptClass:"mstrmojo.platform.TableFieldModel",formats:["P","W","F"],bindings:{fmtModel:"this.tableModel.fmt.c.v"},onkeyChange:function(){this.parent.vk=this.key;},postApplyProperties:function(){this.fmtModel=this.tableModel.fmt.c.v;this.key=this.parent.vk;}},{alias:"indn",scriptClass:"mstrmojo.platform.TableFieldModel",requiredFields:["tableModel"],formats:["P","S"],postApplyProperties:function(){this.key=this.parent.ink;},onkeyChange:function(){this.parent.ink=this.key;}}],init:function(props){if(this._super){this._super(props);}var ch=this.children;if(ch){for(var i=0,len=ch.length;i<len;i++){ch[i].tableModel=this.tableModel;}this.initChildren();}if(!this.parent){this.initBindings();}var ln=this.ln,tm=this.tableModel,fmtm=tm.fmt,cf=fmtm.c,gf=fmtm.g,tn=this.tn,vn=this.vn,rn=this.parent.rn;if(rn){rn[ATL]("widthChange",ln.id,function(){var w=_query(tm,"removeBorders",{v:rn.width,fmt:gf.r});ln.set("width",w+"px");});this.width=rn.width;}cf.t[ATL]("fsChange",this.id,"_onposChange");cf.st[ATL]("fsChange",this.id,"_onposChange");cf.v[ATL]("fsChange",this.id,"_onposChange");vn[ATL]("textChange",this.id,function(){this.set("vph",vn.text);_setTableDef(tm);});this.tableModel[ATL]("trxInfoChange",this.id,"updateTix");this.updateTix();},updateTix:function(){var trxInfo=this.tableModel.trxInfo,vk=this.vk,tix=null;tixType=null;if(trxInfo&&vk){$A.filter(trxInfo.tscObjs,function(n){if(vk==n.key&&n.tix!=null){tixType=n.ctl&&n.ctl.pr&&n.ctl.pr.t;tix=n.tix;return true;}return false;},{max:1});}this.set("tix",tix);this.set("tixType",tixType);},ontixTypeChange:function(){var tixType=this.tixType&&(this.tixType+"");if(tixType==TRX_CTRL_TEXTAREA){this.set("style",CELL_STYLE_VERTICAL);this.set("h","80px");}else{this.set("style",CELL_STYLE_HORIZONTAL);this.set("h","44px");}},onstyleChange:function(){this.onwidthChange();this._onposChange();},oniconUrlChange:function(){if(this.icn.key){this.icn.set("url",this.iconUrl);_exec(this.parent.parent,{id:"setImg",v:{key:this.icn.key,url:this.iconUrl}});}},ontChange:function(evt){this._onposChange(evt);},onhChange:function(evt){this._onposChange(evt);},onwidthChange:function(evt){var iconWidth=parseFloat(this.icn.width||_query(this.tableModel,"defaultCellPadding")),w2=(parseFloat(this.width)-parseFloat(iconWidth)*2)/2,cn=this.vn,ind=this.indn,sty=this.sty;if(sty==CS.txt||sty==CS.trx){if(this.style==CELL_STYLE_HORIZONTAL){cn.set("left",w2+parseFloat(this.tn.left)+"px");cn.set("width",w2+"px");}else{cn.set("left",this.tn.left);cn.set("width",w2*2+"px");}}else{if(sty==CS.nav_t||sty==CS.nav_st){ind.set("left",parseFloat(this.width)-parseFloat(ind.width)+"px");}}this.tn.set("width",w2+"px");},_onposChange:function(evt){var tm=this.parent.parent,fmt=tm.fmt.c,ch=this.h,adjustSingleText=function(fs){var ih=parseFloat(_query(tm,"pxFromPt",fs)),ich=parseFloat(ch);return(ich>ih)?((ich-ih)/2):0;},adjust2Texts=function(fs1,fs2){var ih1=parseFloat(_query(tm,"pxFromPt",fs1)),ih2=parseFloat(_query(tm,"pxFromPt",fs2)),ich=parseFloat(ch),t=(ich>ih1+ih2)?((ich-ih1-ih2)/2):0;return{t1:t,t2:t+ih1};},adjustVerticalText=function(fs1,fs2){var ih1=parseFloat(_query(tm,"pxFromPt",fs1)),ih2=parseFloat(_query(tm,"pxFromPt",fs2)),ich=parseFloat(ch),diff=ich-ih1-ih2;if(diff<10){t=(ich-ih1-ih2)/2;}else{t=(ich-ih1-ih2-10)/2;}return{t1:t,t2:t+ih1+10};},adjustIcon=function(h){var ih=parseFloat(h),ich=parseFloat(ch);return(ich>ih)?((ich-ih)/2):0;},v=parseFloat(this.t);if(this.ln.key){this.ln.set("top",this.t);}this.icn.set("top",v+adjustIcon(this.icn.height||0)+"px");switch(this.sty){case CS.txt:case CS.trx:if(this.style==CELL_STYLE_HORIZONTAL){this.vn.set("top",v+adjustSingleText(this.vn.fs)+"px");this.tn.set("top",v+adjustSingleText(this.tn.fs)+"px");}else{var ts=adjustVerticalText(this.tn.fs,this.vn.fs);this.tn.set("top",v+ts.t1+"px");this.vn.set("top",v+ts.t2+"px");}break;case CS.nav_t:this.tn.set("top",v+adjustSingleText(this.tn.fs)+"px");this.indn.set("top",v+adjustIcon(this.indn.height)+"px");break;case CS.nav_st:var ts=adjust2Texts(this.tn.fs,this.stn.fs);this.tn.set("top",v+ts.t1+"px");this.stn.set("top",v+ts.t2+"px");this.indn.set("top",v+adjustIcon(this.indn.height)+"px");break;case CS.sel:break;}var nc=this.next;if(nc){var gf=this.parent.parent.fmt.g.r,w=(gf.bs=="none")?0:_query(this.parent.parent,"pxFromPt",gf.bw);nc.set("t",parseFloat(this.t)+parseFloat(this.h)+w+"px");}_setTableDef(this.parent.parent);},onstyChange:function(evt){var ov=evt.valueWas,me=this,fmt=me.parent.parent.fmt.c,apply=false,addIndicator=function(){var ret=_exec(me.parent.parent,{id:"addIndicator",v:{top:me.t,cellHeight:me.h}});me.indn.set("key",ret.key);me.indn.set("url",ret.url);},addSubtitle=function(){var l=parseFloat(me.tn.left)+"px",h=me.tn.height,w=me.tn.width,ret=_exec(me.parent.parent,{id:"addCellSubtitle",v:{cellHeight:me.h,top:me.t,left:l,height:h,width:w,fmt:fmt}});me.stn.set("key",ret.key);me.tn.set("top",ret.t);me.tn.set("height",ret.h);},addSelector=function(){var l=parseFloat(me.tn.left)+parseFloat(me.tn.width)+"px",h=me.h,w=me.tn.width,ret=_exec(me.parent.parent,{id:"addSelector",v:{cellHeight:me.h,top:me.t,left:l,height:h,width:w,fmt:fmt}});me.seln.set("key",ret.key);},adjustSingleTitle=function(){var ct=parseFloat(me.t),ch=parseFloat(me.h),h=ch-parseFloat(me.tn.height);h=h?h:0;me.tn.set("top",(h/2)+ct+"px");};switch(this.sty){case CS.txt:case CS.trx:if(ov==CS.nav_t||ov==CS.nav_st){var l=parseFloat(this.tn.left)+parseFloat(this.tn.width)+"px",h=this.tn.height,w=this.tn.width;ret=_exec(this.parent.parent,{id:"addCellValue",v:{cellHeight:this.h,top:this.t,left:l,height:h,width:w,fmt:this.parent.parent.fmt.c.v}});this.vn.set("key",ret.key);adjustSingleTitle();this.indn.removeObj();}if(ov==CS.nav_st){this.stn.removeObj();}break;case CS.nav_t:if(ov==CS.txt||ov==CS.trx){addIndicator();this.vn.removeObj();}else{if(ov==CS.nav_st){this.stn.removeObj();adjustSingleTitle();}}break;case CS.nav_st:if(ov==CS.nav_t){addSubtitle();}else{if(ov==CS.txt||ov==CS.trx){addSubtitle();addIndicator();this.vn.removeObj();}}break;case CS.sel:if(this.stn.key){this.stn.removeObj();}if(this.indn.key){this.indn.removeObj();}if(this.vn.key){this.vn.removeObj();}addSelector();apply=true;break;}_setTableDef(this.parent.parent);if(apply){_exec(this.parent.parent,{id:"postAddSelector"});}},persist:function(){var cfg={isSerializable:function(nodeName,jsons,idx){switch(nodeName){case"sty":case"ick":case"tk":case"stk":case"vk":case"vph":case"lk":case"ink":case"selk":case"tp":case"t":case"h":case"trx":return true;}return false;},skipNull:true,convertBoolean:true};return $S.json2xml("c",this,cfg);}});mstrmojo.platform._HasFormatsMarkup=mstrmojo.provide("mstrmojo.platform._HasFormatsMarkup",{visible:true,formats:["R","F","P","S","W"],methods:{R:{onbgcChange:function(){if(this.bgc){this.domNode.style.backgroundColor=this.bgc;}},onbsChange:function(){if(this.bs){this.domNode.style.borderStyle=this.bs;}},onbcChange:function(){if(this.bc){this.domNode.style.borderColor=this.bc;}},onbwChange:function(){if(this.bw){this.domNode.style.borderWidth=this.bw+"pt";}}},F:{onffChange:function(){if(this.ff){this.domNode.style.fontFamily=this.ff;this.inputNode.style.fontFamily=this.ff;}},onfsChange:function(){if(this.fs){this.domNode.style.fontSize=this.fs+"pt";this.inputNode.style.fontSize=this.fs+"pt";}},onfcChange:function(){if(this.fc){this.domNode.style.color=this.fc;}this.inputNode.style.color=this.fc;},onfbChange:function(){var fb=this.fb?"bold":"normal";this.domNode.style.fontWeight=fb;this.inputNode.style.fontWeight=fb;},onfiChange:function(){var fi=this.fi?"italic":"normal";this.domNode.style.fontStyle=fi;this.inputNode.style.fontStyle=fi;},onfsoChange:function(){this._applyFontDecorationChange();},onfulChange:function(){this._applyFontDecorationChange();}},P:{onleftChange:function(){if(this.left){this.domNode.style.left=this.left;}}},S:{onwidthChange:function(){if(this.width){this.domNode.style.width=this.width;}},onheightChange:function(){if(this.height){this.domNode.style.height=this.height;}}},W:{onwidthChange:function(){if(this.width){this.domNode.style.width=this.width;}}},H:{onheightChange:function(){if(this.height){this.domNode.style.height=this.height;}}}},_applyFontDecorationChange:function(){var td="";td+=this.fso?"line-through":"";td+=this.ful?" underline":"";if(td==""){td="none";}this.domNode.style.textDecoration=td;this.inputNode.style.textDecoration=td;},postCreate:function(){if(this._super){this._super();}var fields=["formats","width","height","left"],bs={};fields=fields.concat(FORMAT_RECT);fields=fields.concat(FORMAT_FONT);$A.forEach(fields,function(f){bs[f]="this.model."+f;});this.bindings=$H.copy(bs,this.bindings);},preBuildRendering:function(){if(this._super){this._super();}var mum={onvisibleChange:function(){this.domNode.style.display=this.visible?"":"none";}},f=this.formats;for(var i in f){mum=$H.copy(this.methods[f[i]],mum);}this.markupMethods=$H.copy(mum,$H.copy(this.markupMethods));}});mstrmojo.platform.TableSelector=mstrmojo.declare(mstrmojo.Label,[mstrmojo.platform._HasFormatsMarkup],{scriptClass:"mstrmojo.platform.TableSelector",preBuildRendering:function(){if(this._super){this._super();}if($A.indexOf(this.formats,"P")>-1){this.markupMethods=$H.copy({onrelativeTopChange:function(){if(this.relativeTop){this.domNode.style.top=this.relativeTop;}}},$H.copy(this.markupMethods));}},postBuildRendering:function(){}});mstrmojo.platform.TableTextField=mstrmojo.declare(mstrmojo.InlineEditBox,[mstrmojo.platform._HasFormatsMarkup],{scriptClass:"mstrmojo.platform.TableTextField",type:0,model:null,emptyHint:"",postCreate:function(){this._super();this.bindings=$H.copy({width:function(){var w=this.model.width,ph=this.model.tableModel.textPaddings.h;return(w?Math.max(parseFloat(w)-parseFloat(ph),0):0)+"px";},height:function(){var h=this.model.height,pv=this.model.tableModel.textPaddings.v;return(h?Math.max(parseFloat(h)-parseFloat(pv),0):0)+"px";}},this.bindings);},preBuildRendering:function(){this._super();if($A.indexOf(this.formats,"P")>-1){this.markupMethods=$H.copy({onrelativeTopChange:function(){if(this.relativeTop){this.domNode.style.top=this.relativeTop;}}},$H.copy(this.markupMethods));}this.markupMethods=$H.copy({ontextChange:function(){this.textNode.innerHTML=mstrmojo.string.encodeHtmlString(this.text||this.emptyHint||"");var empty=!this.text;this.textNode.style.fontSize=empty?"10pt":"";this.textNode.style.color=empty?"#999999":"";}},$H.copy(this.markupMethods));this.markupMethods.onheightChange=function(){};},onSave:function(){this.model.set("text",this.text);}});mstrmojo.platform.GroupTitleField=mstrmojo.declare(mstrmojo.platform.TableTextField,null,{scriptClass:"mstrmojo.platform.GroupTitleField",preBuildRendering:function(){this._super();this.markupMethods=$H.copy({onheightChange:function(){var h=GROUP_TITLE_HEIGHT+"px",dn=this.domNode;if(h&&dn){dn.style.height=h;dn.style.lineHeight=h;}},onwidthChange:function(){var w=this.width,dn=this.domNode;if(dn&&w&&!/NaN/.test(w)){dn.style.width=parseInt(w)/2+"px";}}},$H.copy(this.markupMethods));}});mstrmojo.platform.CellIcon=mstrmojo.declare(mstrmojo.Image,[mstrmojo.platform._HasFormatsMarkup],{scriptClass:"mstrmojo.platform.CellIcon",preBuildRendering:function(){this.markupMethods=$H.copy({onleftChange:function(){if(this.left){this.domNode.style.left=this.left;}},onwidthChange:function(){if(this.width){this.domNode.style.width=this.width;this.imgNode.style.width=this.width;}},onheightChange:function(){if(this.height){this.domNode.style.height=this.height;this.imgNode.style.height=this.height;}},onvisibleChange:function(){this.domNode.style.display=this.visible?"":"none";}},$H.copy(this.markupMethods));if($A.indexOf(this.formats,"P")>-1){this.markupMethods=$H.copy({onrelativeTopChange:function(){if(this.relativeTop){this.domNode.style.top=this.relativeTop;}}},$H.copy(this.markupMethods));}}});mstrmojo.platform.TableCell=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.platform.TableCell",markupString:'<div id="{@id}" class="mi-tc-c {@cssClass}" style="{@cssText}" mstrAttach:contextmenu,dblclick><div class="mi-tc-c-icon"></div><div class="mi-tc-c-nm"></div><div class="mi-tc-c-ph"></div><div class="mi-tc-c-ind"></div><div class="mi-tc-c-sel"></div><div class="mi-tc-c-trxi"></div><div ch="1" class="mi-tc-c-handler"></div></div>',markupSlots:{iconNode:function(){return this.domNode.firstChild;},titleNode:function(){return this.domNode.childNodes[1];},valueNode:function(){return this.domNode.childNodes[2];},indicatorNode:function(){return this.domNode.childNodes[3];},selectorNode:function(){return this.domNode.childNodes[4];},trxIndicatorNode:function(){return this.domNode.childNodes[5];},handlerNode:function(){return this.domNode.lastChild;}},markupMethods:{onbsChange:function(){if(this.bs){this.domNode.style.borderTopStyle=this.bs;}},onbcChange:function(){if(this.bc){this.domNode.style.borderTopColor=this.bc;}},onbwChange:function(){if(this.bw){this.domNode.style.borderTopWidth=this.bw+"pt";}},onheightChange:function(){var h=parseFloat(this.height);if(h){this.domNode.style.height=h+"px";this.handlerNode.style.top=(h-3)+"px";}},onresizableChange:function(){this.handlerNode.style.display=this.resizable?"block":"none";}},cssDisplay:"block",isCell:true,resizable:false,children:[{scriptClass:"mstrmojo.platform.CellIcon",alias:"ci",slot:"iconNode",bindings:{model:"this.parent.model.icn",visible:"this.model.key",src:function(){var url=this.model.url;return url||DEFAULT_ICON;},relativeTop:function(){var t=parseFloat(this.model.top),ch=parseFloat(this.parent.model.t),rt=t-ch;return(rt?rt:0)+"px";}}},{scriptClass:"mstrmojo.platform.TableTextField",alias:"ct",slot:"titleNode",bindings:{model:"this.parent.model.tn",text:"this.model.text",relativeTop:function(){var t=parseFloat(this.model.top),ch=parseFloat(this.parent.model.t),rt=t-ch;return(rt?rt:0)+"px";}},ontextChange:function(){this.model.set("text",this.text);}},{scriptClass:"mstrmojo.platform.TableTextField",alias:"cst",slot:"titleNode",bindings:{model:"this.parent.model.stn",text:"this.model.text",relativeTop:function(){var t=parseFloat(this.model.top),ch=parseFloat(this.parent.model.t),rt=t-ch;return(rt?rt:0)+"px";},visible:function(){var sty=this.parent.model.sty,k=this.model.key;return sty==CS.nav_st&&k;}},ontextChange:function(){this.model.set("text",this.text);}},{scriptClass:"mstrmojo.platform.TableTextField",alias:"cv",slot:"valueNode",bindings:{model:"this.parent.model.vn",text:"this.model.text",visible:function(){var sty=this.parent.model.sty,tix=this.parent.model.tix,tixType=this.parent.model.tixType;return !tixType||(tixType==TRX_CTRL_TEXTFIELD||tixType==TRX_CTRL_TEXTAREA||tixType==TRX_CTRL_BARCODE);},relativeTop:function(){var t=parseFloat(this.model.top),ch=parseFloat(this.parent.model.t),rt=t-ch;return(rt?rt:0)+"px";},allowEdit:function(){var sty=this.parent.model.sty,tixType=this.parent.model.tixType;return(sty==CS.txt||sty==CS.trx)&&tixType!=TRX_CTRL_BARCODE;}},ontextChange:function(){if(this.model){this.model.set("text",this.text);}}},{scriptClass:"mstrmojo.Label",cssClass:"trxindicator",slot:"trxIndicatorNode",bindings:{model:"this.parent.model.vn",visible:"this.parent.model.tix && this.parent.model.tix>0"}},{scriptClass:"mstrmojo.platform.TableSelector",alias:"csel",slot:"selectorNode",text:"Selector",bindings:{model:"this.parent.model.seln",visible:"this.model.key",relativeTop:function(){var t=parseFloat(this.model.top),ch=parseFloat(this.parent.model.t),rt=t-ch;return(rt?rt:0)+"px";}}},{scriptClass:"mstrmojo.platform.CellIcon",alias:"indicator",slot:"indicatorNode",linkable:true,bindings:{model:"this.parent.model.indn",src:function(){var url=this.model.url;return url||DEFAULT_ICON;},relativeTop:function(){var t=parseFloat(this.model.top),ch=parseFloat(this.parent.model.t),rt=t-ch;return(rt?rt:0)+"px";},visible:function(){var sty=this.parent.model.sty;return sty!=CS.txt&&sty!=CS.trx;}}}],onwidthChange:function(){var icn=parseFloat(this.ci.width||_query(this.model.tableModel,"defaultCellPadding")),w2=(parseFloat(this.width)-parseFloat(icn)*2)/2,cvm=this.cv.model,ind=this.indicator.model,sty=this.model.sty;if(sty==CS.txt||sty==CS.trx){cvm.set("left",w2+parseFloat(this.ct.model.left)+"px");cvm.set("width",w2+"px");}else{if(sty==CS.nav_t||sty==CS.nav_st){ind.set("left",parseFloat(this.width)-parseFloat(ind.width)+"px");}}this.ct.model.set("width",w2+"px");},ontopChange:function(){var t=this.top;this.model.set("t",t);},ontixTypeChange:function(evt){var css=mstrmojo.css,tixType=this.tixType&&(this.tixType+""),clsMap={"3":"trx-list"};if(this.cv&&this.cv.textNode){if(tixType==TRX_CTRL_BARCODE){this.cv.textNode.innerHTML=mstrmojo.desc(11180);}if(tixType==TRX_CTRL_TEXTFIELD||tixType==TRX_CTRL_TEXTAREA){this.cv.textNode.innerHTML=this.cv.text;}}css.removeClass(this.domNode,["trx-list"]);tixType&&clsMap[tixType]&&css.addClass(this.domNode,clsMap[tixType]);},postBuildRendering:function(){this._super();this.ontixTypeChange();}});function _doNothing4Resizing(w,_super,ctxt){var s=ctxt.src,d=s&&s.data,c=d&&d.cell;if(!c){return _super&&_super.apply(w,[ctxt]);}}mstrmojo.platform.TableCellList=mstrmojo.declare(mstrmojo.WidgetList,[mstrmojo.platform._HasFormatsMarkup],{scriptClass:"mstrmojo.platform.TableCellList",cssClass:"mi-tc-c-l",alias:"cs",renderOnScroll:false,resizable:false,draggable:true,dropZone:true,preBuildRendering:function(){if(this._super){this._super();}this.markupMethods=$H.copy({onwidthChange:function(){if(this.width){this.domNode.style.width=this.width;this.itemsContainerNode.style.width=this.width;}}},$H.copy(this.markupMethods));},onwidthChange:function(){if(this._super){this._super();}var cs=this.ctxtBuilder&&this.ctxtBuilder.itemWidgets,sz=cs&&cs.length,i=0;var tm=this.model.tableModel,fmt=tm.fmt.g.r,bd=(fmt.bs=="none")?0:_query(tm,"pxFromPt",fmt.bw);for(;i<sz;i++){cs[i].set("width",parseFloat(this.width)-bd*2+"px");}},ontopChange:function(evt){var cs=this.ctxtBuilder&&this.ctxtBuilder.itemWidgets,sz=cs&&cs.length,t=parseFloat(this.top),i=0,c;for(;i<sz;i++){c=cs[i].model;c.set("t",t+"px");t=t+parseFloat(c.h);}},onadd:function(evt){this.model.raiseEvent({name:"addCell",index:evt.index});this._onchange(evt);},onremove:function(evt){this.model.raiseEvent({name:"removeCell",index:evt.index});this._onchange(evt);},_onchange:function(evt){var gs=this.table.gs.ctxtBuilder.itemWidgets;for(var i=0;i<gs.length;i++){if(gs[i]==this.group){var idx=evt.index,cs=this.ctxtBuilder.itemWidgets,sz=cs.length,gt=this.group.model.title;var th=parseFloat((gt.key&&GROUP_TITLE_HEIGHT)||0),t=parseFloat(this.group.model.t)+th,h=0;j=0;for(;j<sz;j++){if(j>=idx){cs[j].model.set("t",t+"px");}t+=parseInt(cs[j].height);h+=parseInt(cs[j].height)+1;}this.model.set("height",h+"px");this.group.model.set("h",h+th+"px");}}_setTableDef(this.table.model);},postCreate:function(){if(this._super){this._super();}$H.copy({bgc:"this.model.bgc",bc:"this.model.bc",bs:"this.model.bs",bw:"this.model.bw",top:"this.model.top",width:"this.model.width",height:"this.model.height",left:"this.model.left"},this.bindings);},itemFunction:function(item,idx,w){return new mstrmojo.platform.TableCell({model:item,parent:w,width:w.width,top:item.t,h:item.h,bindings:{tix:"this.model.tix",tixType:"this.model.tixType",height:"this.model.h",resizable:"this.parent.resizable",bs:function(){var ln=this.model.ln.key,bs=this.parent.model.bs;return ln?bs:"none";},bc:function(){var ln=this.model.ln.key,bc=this.parent.model.bc;return ln&&bc;},bw:function(){var ln=this.model.ln.key,bw=this.parent.model.bw;return ln&&bw;}}});},getDragData:function getDragData(ctxt){var s=ctxt.src,n=s.node,cell=n.getAttribute("ch")&&$D.findWidget(n);if(cell){return{cell:cell,h:cell.model.h,resize:true};}else{if(this._super){return this.dropZone&&this._super(ctxt);}}return null;},allowDrop:function allowDrop(ctxt){var s=ctxt.src,d=s&&s.data,c=d&&d.cell;if(c){return this.resizable;}else{return d.parent.id==this.model.gm.id;}},ondragstart:function(c){var s=c.src,d=s&&s.data,cl=d&&d.cell;if(d&&d.resize){var w=this;function _createAvatar(){var d=document.createElement("div"),s=d.style,dn=w.domNode;d.className="mstrmojo-TC-avatar";s.height=dn.clientHeight+"px";dn.appendChild(d);w.avatar=d;return d;}mstrmojo.css.addClass(cl.domNode,"dragging");var a=this.avatar||_createAvatar();a.style.display="block";this.ownAvatar=true;}else{var w;if(s&&s.node){w=_findWidget($D.findWidget(s.node),"isCell");}var html=(w&&w.domNode.innerText)||"";d.set("html",html);}return this._super(c);},ondragenter:function ondragenter(ctxt){_doNothing4Resizing(this,this._super,ctxt);},ondragover:function ondragover(ctxt){_doNothing4Resizing(this,this._super,ctxt);},ondragleave:function ondragleave(ctxt){_doNothing4Resizing(this,this._super,ctxt);},ondrop:function ondrop(ctxt){_doNothing4Resizing(this,this._super,ctxt);},ondragmove:function ondragmove(ctxt){var s=ctxt.src,d=s&&s.data,c=d&&d.cell;if(c){var t=ctxt.tgt,deltaX=t.pos.y-s.pos.y,h=Math.max(parseFloat(c.model.h)+deltaX,MIN_CELL_HEIGHT)+"px";c.domNode.style.height=h;this.avatar.style.top=$D.position(c.domNode,true).y+parseFloat(h)-$D.position(this.domNode,true).y+"px";d.h=h;}else{if(this._super){this._super(ctxt);}}},ondragend:function ondragend(ctxt){var s=ctxt.src,d=s&&s.data,c=d&&d.cell;if(c){c.model.set("h",d.h);mstrmojo.css.removeClass(c.domNode,"dragging");this.avatar.style.display="none";this.ownAvatar=false;}else{if(this._super){this._super(ctxt);}}}});mstrmojo.platform.TableGroup=mstrmojo.declare(mstrmojo.VBox,null,{scriptClass:"mstrmojo.platform.TableGroup",markupString:'<div id="{@id}" class="mi-tc-g {@cssClass}" style="{@cssText}" mstrAttach:mousemove,mouseover,mouseout,selectstart><div class="mi-tc-g-hd"></div><div class="mi-tc-g-cs"></div></div>',markupSlots:{headerNode:function(){return this.domNode.firstChild;},cellsNode:function(){return this.domNode.lastChild;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?mstrmojo.css.DISPLAY_TABLE:"none";}},title:null,cells:[],isGroup:true,top:null,children:[{scriptClass:"mstrmojo.HBox",cssClass:"mi-tc-g-hd-ctn",colHTML:'<colgroup><col style="width:50%;"><col style="width:50%;"></colgroup>',slot:"headerNode",alias:"gh",children:[{scriptClass:"mstrmojo.platform.GroupTitleField",slot:"groupTitleNode",cssClass:"mi-tc-g-nm",alias:"gt",isGroupTitle:true,bindings:{model:"this.parent.parent.model.title",visible:"this.model.key",text:"this.model.text"},ontextChange:function(){this.model.set("text",this.text);}},{scriptClass:"mstrmojo.Button",cssClass:"mi-button-add",text:mstrmojo.desc(11181),slot:"newCellNode",alias:"newCell",bindings:{top:"this.parent.gt.model.top",visible:"this.parent.parent.table.model.curGroup == this.parent.parent.model"},onclick:function(){var g=this.parent.parent;g.model.addCell(g.getBottom());},postCreate:function(){this.markupMethods=$H.copy({ontopChange:function(){if(this.top){this.domNode.style.top=this.top;}}},$H.copy(this.markupMethods));}}]},{scriptClass:"mstrmojo.platform.TableCellList",slot:"cellsNode",alias:"cs",bindings:{model:"this.parent.model.rn",items:"this.parent.model.cells",key:"this.parent.model.rn.key",table:"this.parent.table",group:"this.parent",top:"this.model.top"}}],bindings:{title:"this.model.title",cells:"this.model.cells"},updateTop:function(){this.set("top",parseInt(this.getBottom())-parseInt(this.getAndUpdateHeight())+"px");},onRender:function(){this.top=parseInt(this.getBottom())-parseInt(this.getAndUpdateHeight())+"px";this.height=this.getAndUpdateHeight();},ontopChange:function(evt){this.gh.gt.model.set("top",this.top);var gt=this.model.title,th=(gt.key&&GROUP_TITLE_HEIGHT)||0;this.cs.model.set("top",parseInt(this.top)+parseInt(th)+"px");var iws=this.cs.ctxtBuilder.itemWidgets,t=parseInt(this.top)+parseInt(th),i=0;for(var i=0;i<iws.length;i++){iws[i].set("top",t+"px");t+=parseInt(iws[i].height);}},onwidthChange:function(){this.cs.model.set("width",parseInt(this.width)+"px");},getAndUpdateHeight:function(){var gt=this.model.title,r=parseInt((gt.key&&GROUP_TITLE_HEIGHT)||0),cs=this.cs.ctxtBuilder.itemWidgets,sz=cs.length,i=0;for(;i<sz;i++){r+=parseInt(cs[i].height);}this.height=r+"px";return r+"px";},getBottom:function(){return parseFloat(this.model.t)+parseFloat(this.model.h)+"px";},onmouseover:function(){var me=this;me.table.model.set("curGroup",me.model);},onmouseout:function(){var me=this;me.table.model.set("curGroup",null);},onselectstart:function(evt){var e=evt.e,win=evt.hWin,target=$D.eventTarget(win,e);if(target.tagName&&target.tagName.toLowerCase()==="input"){$D.stopPropogation(win,evt.e);}}});mstrmojo.platform.TableGroupList=mstrmojo.declare(mstrmojo.WidgetList,null,{scriptClass:"mstrmojo.WidgetList",cssClass:"mi-tc-g-l",alias:"gs",renderOnScroll:false,makeObservable:true,draggable:true,dropZone:true,ownAvatar:true,itemFunction:function(item,idx,w){var top=idx?w.ctxtBuilder.itemWidgets[idx-1].top:"0px";return new mstrmojo.platform.TableGroup({table:w.parent,model:item,top:top,parent:w,bindings:{height:function(){var tk=this.model.title.key,th=GROUP_TITLE_HEIGHT,rh=this.model.rn.height,bs=this.model.rn.bs,bw=this.model.rn.bw;return parseFloat((tk&&th)||0)+parseFloat(rh)+((bs=="none")?0:parseFloat(bw)*2)+"px";}}});},onadd:function(evt){_setTableDef(this.parent.model);this._onchange(evt);},onremove:function(evt){_setTableDef(this.parent.model);},allowDrop:function allowDrop(ctxt){var s=ctxt.src;if(s&&s.widget){return s.widget===this;}},ondragstart:function(c){var s=c.src,d=s&&s.data,w=mstrmojo.dom.findWidget(s.node);while(w){if(w.scriptClass=="mstrmojo.platform.TableGroup"){break;}w=w.parent;}if(w){var node=w.domNode.cloneNode(true);node.style.position="absolute";mstrmojo.css.addClass(node,"avatar-dragging");node.style.zIndex="1000";document.body.appendChild(node);this.avatar=node;}return this._super(c);},ondragmove:function(ctxt){var t=ctxt.tgt,pos=mstrmojo.dom.getMousePosition(t.e,t.hWin),avt=this.avatar;if(avt){avt.style.left=(pos.x+2)+"px";avt.style.top=(pos.y+2)+"px";}return this._super&&this._super(ctxt);},ondragend:function(ctxt){var avt=this.avatar;if(avt){avt.parentNode.removeChild(avt);}return this._super(ctxt);},_onchange:function(evt){var groups=this.items,t=0,h=0;for(var i=0;i<groups.length;i++){groups[i].next=null;}for(var i=0;i<groups.length;i++){var g=groups[i],cs=g.cells,gt=g.title,gth=parseFloat((gt.key&&GROUP_TITLE_HEIGHT)||0),gh=parseFloat(g.h),ct=t+gth;g.set("t",t+"px");for(var j=0;j<cs.length;j++){var c=cs[j];c.set("t",ct+"px");ct+=parseInt(c.h);}g.set("next",groups[i+1]);t+=gh;}}});mstrmojo.platform.TableSelectorGroupModel=mstrmojo.declare(mstrmojo.Model,null,{scriptClass:"mstrmojo.platform.TableSelectorGroupModel",init:function init(props){if(this._super){this._super(props);}if(props.smt){this.smt.tableModel=this.tableModel;props.smt.formats=["P","W"];this.set("smt",new mstrmojo.platform.TableFieldModel(props.smt));}if(props.dsc){this.dsc.tableModel=this.tableModel;props.dsc.formats=["P","W"];this.set("dsc",new mstrmojo.platform.TableFieldModel(props.dsc));}},ontopChange:function(){var top=this.top;if(!top){return ;}this.smt&&this.smt.set("top",this.top);this.smt&&this.dsc.set("top",this.top);},onwidthChange:function(){if(!this.width||/NaN/.test(this.width)){return ;}var width=parseInt(this.width),bi=this.buttonInterval,btnWidth=(width-bi)/2;if(this.smt){this.smt.set("width",btnWidth+"px");this.smt.set("left",this.marginLeft+btnWidth+this.buttonInterval+"px");}if(this.dsc){this.dsc.set("width",btnWidth+"px");}}});mstrmojo.platform.TableSelectorButton=mstrmojo.declare(mstrmojo.HTMLButton,[mstrmojo.platform._HasFormatsMarkup],{scriptClass:"mstrmojo.platform.TableSelectorButton"});mstrmojo.platform.TableSelectorGroup=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.platform.TableSelectorGroup",markupString:'<div class="mi-tc-selectors-group"><div class="mi-tc-selectors-submit"></div><div class="mi-tc-selectors-cancel"></div></div>',markupSlots:{submitNode:function(){return this.domNode.firstChild;},discardNode:function(){return this.domNode.lastChild;}},onmodelChange:function(){this.__renderSelectors();},postBuildRendering:function(){this.__renderSelectors();},__renderSelectors:function(){if(!this.model){return ;}this.addChildren(new mstrmojo.platform.TableSelectorButton({text:"Submit",alias:"submit",parent:this,slot:"submitNode",bindings:{text:"this.parent.model.smt.dpTxt",model:"this.parent.model.smt"}}));this.addChildren(new mstrmojo.platform.TableSelectorButton({text:"Cancel",cssText:"left:"+this.model.marginLeft+"px",alias:"discard",parent:this,slot:"discardNode",bindings:{text:"this.parent.model.dsc.dpTxt",model:"this.parent.model.dsc"}}));this.renderChildren();}});mstrmojo.platform.TableControl=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.platform.TableControl",markupString:'<div id="{@id}" class="mstrmojo-TC {@cssClass}" style="{@cssText}" mstrAttach:click,mousemove,mouseout,mouseover,contextmenu><div></div><div class="mi-tc-selectors"></div><div class="mi-tc-btns"><div class="mi-tc-btn-ng"></div><div class="mi-tc-btn-nc"></div></div></div>',markupSlots:{newGroupNode:function(){return this.domNode.lastChild.firstChild;},newCellNode:function(){return this.domNode.lastChild.ChildNodes;},selectorGroupNode:function(){return this.domNode.childNodes[1];},groupsNode:function(){return this.domNode.firstChild;}},markupMethods:{},cssDisplay:"block",def:{items:[]},model:null,fmt:{},children:[{scriptClass:"mstrmojo.Button",cssClass:"mi-button-add",text:mstrmojo.desc(11182),slot:"newGroupNode",alias:"newGroup",onclick:function(){this.parent.model.addGroup(this.parent.getBottom());}},{scriptClass:"mstrmojo.platform.TableGroupList",slot:"groupsNode",bindings:{items:"this.parent.model.groups"}},{scriptClass:"mstrmojo.platform.TableSelectorGroup",slot:"selectorGroupNode",alias:"selectorGroup",bindings:{width:"this.parent.width",model:"this.parent.model.selGroupModel"}}],getBottom:function(){var gs=this.gs.ctxtBuilder.itemWidgets;return gs[gs.length-1].getBottom();},resize:function(h,w){h&&this.set("height",h);w&&this.set("width",w);},onwidthChange:function(evt){var w=this.width,sg=this.model.selGroupModel;$A.forEach(this.model.groups,function(g){g.set("width",w);});if(sg){sg.set("width",w);}},oncontextmenu:function(evt){_showCXM(evt,this);}});})();