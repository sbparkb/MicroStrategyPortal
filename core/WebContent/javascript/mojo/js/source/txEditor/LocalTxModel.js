(function(){mstrmojo.requiresCls("mstrmojo.Model","mstrmojo.string","mstrmojo.array","mstrmojo.hash","mstrmojo.txEditor.CSIStatementToken","mstrmojo.txEditor.CommonComponent");var $S=mstrmojo.string,$A=mstrmojo.array,$H=mstrmojo.hash,_TC=mstrmojo.txEditor.CommonComponent,_CSIKT=_TC.CSI_KEYWORD_TYPE,_ST=_TC.STATEMENT_TYPE,_OP=mstrmojo.txEditor.CSIStatementToken.isOperation,DssRWManipulationNoAction=0;DssRWManipulationAddOfflineTransaction=201;DssRWManipulationRemoveOfflineTransaction=202;DssRWManipulationUpdateOfflineTransaction=203;function getMappedTscObjs(tscObjs){var mappedObjs=[];$A.forEach(tscObjs,function(obj){if(obj.mapped){mappedObjs.push(obj);}});return mappedObjs;}function transformTextFieldTokenValue(item){var tscObjs=mstrmojo.all.offModel.offTxs.tscObjs||[],v="",len=tscObjs.length,idx;for(idx=0;idx<len;++idx){if(tscObjs[idx].tn===item.v){item.tn=item.v;item.v=tscObjs[idx].n;item.exv=tscObjs[idx].key;item.extp="8";break;}}}function preprocessTokenStream(items){var csType=_ST.STATEMENT_UPDATE,nextSplitTp,tgtDsId,tgtDsName,clauses=[],clause=[],isCSIKeyWordItem=function(item){return((item.tp>=_CSIKT.UPDATE&&item.tp<=_CSIKT.FROM)||35===item.tp||-1===item.tp);};$A.forEach(items,function(item){if(_CSIKT.UPDATE===item.tp){csType=_ST.STATEMENT_UPDATE;nextSplitTp=_CSIKT.WHERE;}else{if(_CSIKT.INSERT===item.tp){csType=_ST.STATEMENT_INSERT;nextSplitTp=_CSIKT.VALUES;}else{if(_CSIKT.DELETE===item.tp){csType=_ST.STATEMENT_DELETE;}else{if(269===item.tp){var oi=item.oi;if(oi){tgtDsId=oi.did;tgtDsName=oi.n;}}else{if(nextSplitTp&&nextSplitTp===item.tp){clauses.push(clause);clause=[];}else{if(!isCSIKeyWordItem(item)&&(item.oi||_CSIKT.FIELDUNIT===item.tp)){item.isMstrObj=true;}}}}}}item.isRecognized=true;if(_CSIKT.FIELDUNIT===item.tp){transformTextFieldTokenValue(item);}if(37!==item.tp){clause.push(item);}});if(clause){clauses.push(clause);}return{tgtDsId:tgtDsId,tgtDsName:tgtDsName,tknstrm:{csType:csType,clauses:clauses}};}mstrmojo.txEditor.LocalTxModel=mstrmojo.declare(mstrmojo.Model,null,{scriptClass:"mstrmojo.txEditor.LocalTxModel",enablePlainText:false,setTargetDataset:function(tgtDsId,tgtDsName){mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(res){if(res){res.n=res.n||tgtDsName;mstrmojo.all.offModel.set("tgtDs",res);}},failure:function(res){_TC.showError(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{taskId:"getRWTransactionTargetDataset",datasetId:tgtDsId});},_set_offTxs:function(n,v){this.offTxs=$H.make(v,mstrmojo.Obj);var offTxs=this.offTxs,tscObjs=offTxs.tscObjs,localCsiTknStrm=offTxs.localCsiTknStrm,tknStrmItems=localCsiTknStrm&&localCsiTknStrm.items;if(tscObjs){offTxs.mappedObjs=getMappedTscObjs(tscObjs);}if(tknStrmItems){$H.copy(preprocessTokenStream(tknStrmItems),offTxs);}var tgtDsId=offTxs.tgtDsId,tgtDsName=offTxs.tgtDsName;if(tgtDsId){this.setTargetDataset(tgtDsId,tgtDsName);}if(this.enablePlainText&&offTxs.offPlainText){var offPlainText=$S.trim(offTxs.offPlainText),cp=offPlainText.slice(0,6).toUpperCase(),csType=("UPDATE"===cp?0:("INSERT"===cp?"1":"2")),getClauses=function(){var prefixRegExp,infixStr;if(0===csType){prefixRegExp=new RegExp("UPDATE.*SET");infixStr="WHERE";}else{if(1===csType){prefixRegExp=new RegExp("INSERT INTO [a-zA-Z_0-9]*\\s+");infixStr="VALUES";}else{prefixRegExp=new RegExp("DELETE FROM [a-zA-Z_0-9]*\\s+");}}var rmPrefixText=offPlainText.replace(prefixRegExp,""),items=infixStr?rmPrefixText.split(infixStr):[rmPrefixText],clauses=[];$A.forEach(items,function(item){clauses.push([{v:$S.trim(item)}]);});return clauses;};offTxs.tknstrm={clauses:getClauses(),csType:csType};}return true;},ontgtDsChange:function(){var offTxs=this.offTxs,tgtDs=this.tgtDs;if(offTxs&&(!tgtDs||tgtDs.did!=offTxs.tgtDsId)){this.set("isDirty",true);}},onEditableObjsChange:function(evt){var offTxs=this.offTxs;if(offTxs){offTxs.set("mappedObjs",getMappedTscObjs(offTxs.tscObjs));}},_set_isDirty:function(n,v){this.isDirty=v;if(v&&this.validationError){this.set("validationError",null);}return true;},_postprocessTokenStream:function _postprocessTokenStream(items){var items=items||[],len=items.length,last=items[len-1],newItems=[],newV="",it,lastNewItem,addUnknownValue=function(){newItems.push({v:newV,tp:2,lv:1});newV="";};if(items[0]&&items[0].tp!=35){newItems.push({v:"#",tp:35,lv:4,sta:2,isDelimiter:true});}for(i=0;i<len;++i){it=items[i];if(!it){continue;}else{if(!(it.isDelimiter||it.isMstrObj||it.isRecognized)){newV+=it.v;}else{if(!$S.isEmpty(newV)){addUnknownValue();lastNewItem=newItems[newItems.length-1];}if(it.isDelimiter&&lastNewItem&&(lastNewItem.isDelimiter||_OP(lastNewItem.v))){lastNewItem.v+=it.v;$H.copy({tp:2,lv:1,isDelimiter:true},lastNewItem);if(lastNewItem.oi){lastNewItem.oi=null;}}else{if(!it.oi){it.tp=it.tp||2;it.lv=it.lv||1;}if(_CSIKT.FIELDUNIT===it.tp){it.v=it.tn||it.v;}newItems.push(it);lastNewItem=it;}}}}if(!$S.isEmpty(newV)){addUnknownValue();}if(last&&last.tp!==-1){if(last.v!==";"){newItems.push({v:";",tp:2,lv:1});}newItems.push({v:"",tp:-1,lv:4,sta:2});}return newItems;},getValidationXML:function getValidationXML(){var tokenXml=this.getTokenStreamXML(),manipulationMethod=(this.tgtDs&&this.tgtDs.did)?DssRWManipulationUpdateOfflineTransaction:DssRWManipulationNoAction,xml="";if(manipulationMethod!=DssRWManipulationNoAction&&!!this.offTxs.localCtlKey){xml='<rwLocalTxXML nodekey="'+this.nodeKey+'" manipulationMethod="'+manipulationMethod+'" localCtlKey="'+this.offTxs.localCtlKey+'">'+tokenXml+"</rwLocalTxXML>";}return xml;},isRemoved:function isRemoved(){return !this.tgtDs;},getXML:function getXML(){var tokenXml=this.enablePlainText?this.getCSIPlainText():this.getTokenStreamXML(),manipulationMethod=this.getManipulationMethod(),xml="";if(!this.offTxs.localCtlKey){this.offTxs.localCtlKey=mstrmojo.all.teModel.getNewCtlKey();}if(manipulationMethod!==DssRWManipulationNoAction){xml='<rwLocalTxXML nodekey="'+this.nodeKey+'" manipulationMethod="'+manipulationMethod+'" localCtlKey="'+this.offTxs.localCtlKey+'">'+tokenXml+"</rwLocalTxXML>";}return xml;},getTokenStreamXML:function getTokenStreamXML(){var tknstrm=this.offTxs.tknstrm,clauses=tknstrm&&tknstrm.clauses,tokenXml="";if(this.tgtDs&&this.tgtDs.did){tokenXml=this.getClauseXML(clauses);tokenXml="<tknstrm>"+tokenXml+"</tknstrm>";}return tokenXml;},getCSIPlainText:function getCSIPlainText(){var SPACE_NUM={312:1,313:2,314:1,315:1,316:2,317:1,318:2,319:2},tknstrm=this.offTxs.tknstrm,clauses=tknstrm&&tknstrm.clauses,len=clauses&&clauses.length||0,csi="",its=[],i,last;if(this.tgtDs&&this.tgtDs.did){for(i=0;i<len;++i){its=its.concat(clauses[i]);}last=its[its.length-1];if(last&&last.v!==";"){its.push({v:";"});}var isDatasetObj=function(item){return item.oi&&3===item.oi.t;};$A.forEach(its,function(item){var sn=item.tp&&SPACE_NUM[item.tp],_isDSObj=isDatasetObj(item);if(sn===2){csi+=" ";}if(_isDSObj){csi+="[";}csi+=item.v;if(_isDSObj){csi+="]";}if(sn>0||_isDSObj){csi+=" ";}});csi="<fmu>"+csi+"</fmu>";}return csi;},getManipulationMethod:function getManipulationMethod(){var offTxs=this.offTxs,tgtDs=this.tgtDs,oldId=offTxs&&offTxs.tgtDsId,newId=tgtDs&&tgtDs.did;if(!oldId&&newId){return DssRWManipulationAddOfflineTransaction;}if(oldId&&newId&&this.isDirty){return DssRWManipulationUpdateOfflineTransaction;}if(oldId&&!newId){return DssRWManipulationRemoveOfflineTransaction;}return DssRWManipulationNoAction;},getClauseXML:function getClauseXML(clauses){var its=[],len=clauses.length,xml,i,props={items:true,v:true,tp:true,lv:true,oi:true,n:true,did:true,t:true,key:true,extp:true,exv:true,sc:true,sctt:true,desc:true,sta:true},config={getArrItemName:function(n,v,i){return"tkn";},isSerializable:function(nodeName,jsons,index){return !!props[nodeName];},skipNull:true};for(i=0;i<len;++i){its=its.concat(clauses[i]);}its=this._postprocessTokenStream(its);xml=$S.json2xml("uselessEnd",{items:its},config);return xml.replace(/\<\/?uselessEnd[^\>]*\>/g,"");},dbClickReceiver:null,setReciever:function(widget){if(widget!==this.dbClickReceiver&&widget instanceof mstrmojo.txEditor.CSIStatementTokenInput){this.dbClickReceiver=widget;}},removeReceiver:function(widget){if(this.dbClickReceiver===widget){this.dbClickReceiver=null;}},sendData:function(data){if(this.dbClickReceiver&&this.dbClickReceiver.isActive()){this.dbClickReceiver.sendData(data);}},validateLocalTXN:function(callback){var me=this;if(me.validting){return ;}me.validting=true;mstrmojo.all.mstrTE.set("saving",true);mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(){if(callback){callback();}mstrmojo.all.mstrTE.set("saving",false);},failure:function(res){var errMessage=res.getResponseHeader("X-MSTR-TaskFailureMsg");me.set("validationError",errMessage);mstrmojo.all.mstrTE.set("saving",false);}},{taskId:"validateLocalTransaction",msgID:me.messageID,rwLocalTransactionInfoXML:me.getXML(),isValidateLocalTXN:true});me.validting=false;},isDirtyState:function(){return !!this.isDirty;},clearDirtyFlags:function(){this.set("isDirty",false);},reset:function(){this.isDirty=false;var offTxs=this.offTxs,tgtDs=this.tgtDs;if(offTxs){offTxs.tgtDsId=tgtDs&&tgtDs.did;offTxs.tgtDsName=tgtDs&&tgtDs.n;if(!offTxs.tgtDsId){delete offTxs.localCtlKey;}}}});}());