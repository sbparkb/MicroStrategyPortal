(function(){mstrmojo.requiresCls("mstrmojo.HBox","mstrmojo.HTMLButton","mstrmojo.txEditor.CommonComponent");mstrmojo.requiresDescs(134,221,1442,8256,8298);var _TC=mstrmojo.txEditor.CommonComponent,_TP=_TC.TAP_PANEL,SP=_TC.SAVING_PHASE;function pollSavingStatus(callback){mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(res){if(!res||res.status===2||res.status===3){_TC.showError(mstrmojo.desc(8256));mstrmojo.all.mstrTE.set("saving",false);}else{if(res.status===1||res.status===21){if(callback){callback();}mstrmojo.all.mstrTE.set("saving",false);}else{pollSavingStatus(callback);}}},failure:function(){_TC.showError(mstrmojo.desc(8256));mstrmojo.all.mstrTE.set("saving",false);}},{taskId:"pollStatus",msgID:mstrmojo.all.teModel.messageID});}function saveData(callback,phase){mstrmojo.all.mstrTE.set("saving",true);var phase=phase||SP.ALL,saveMappingTxn=phase&SP.MAPPING,saveLocalTxn=phase&SP.LOCL,teModel=mstrmojo.all.teModel,offModel=mstrmojo.all.offModel,params={taskId:"saveRWTransactions",msgID:mstrmojo.all.teModel.messageID,nodeKey:teModel.nodeKey&&teModel.nodeKey.k||"",sectionKey:teModel.nodeKey&&teModel.nodeKey.sk||"",rwTransactionInfoXML:(saveMappingTxn&&teModel.getXML())||"",isEditExistingTXProperty:!teModel.isNew,rwLocalTransactionInfoXML:(saveLocalTxn&&offModel.getXML())||"",savingPhase:phase};if(microstrategy&&microstrategy.updateManager){params.rwb=microstrategy.updateManager.getRWBState(true);}mstrmojo.xhr.request("POST",mstrConfig.taskURL,{success:function(res){if(callback){callback(res);}mstrmojo.all.mstrTE.set("saving",false);},failure:function(res){var errMessage=res.getResponseHeader("X-MSTR-TaskFailureMsg");if(errMessage.indexOf("Task exceeded the maximum wait time")>-1){pollSavingStatus(callback);}else{saveMappingTxn&&_TC.showError(mstrmojo.desc(8256));saveLocalTxn&&offModel.set("validationError",errMessage);mstrmojo.all.mstrTE.set("saving",false);}}},params);}function applyMappingTxChanges(callback){var model=mstrmojo.all.teModel,txnEditor=mstrmojo.all.mstrTE;if(!txnEditor.saving&&(!model.txRpt||(model.isPropertiesValid()&&model.isAllInputsMapped()))){saveData(callback,SP.MAPPING);}}function applyLocalTxChanges(callback){var model=mstrmojo.all.offModel,txnEditor=mstrmojo.all.mstrTE;if(!txnEditor.saving){saveData(callback,SP.LOCL);}}function applyChanges(model,callback){var cb=function(res){model.onsave&&model.onsave(model,res);model.clearDirtyFlags&&model.clearDirtyFlags();callback&&callback(res);};if(model.id==="teModel"){applyMappingTxChanges(cb);}else{applyLocalTxChanges(cb);}}mstrmojo.txEditor.ButtonsBar=mstrmojo.declare(mstrmojo.HBox,null,{scriptClass:"mstrmojo.txEditor.ButtonsBar",cssClass:"mstrmojo-Editor-buttonBox",cssText:mstrmojo.dom.isIE7?"float:none":"",slot:"buttonNode",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",alias:"applyButton",text:mstrmojo.desc(134,"Apply"),onclick:function(){var tapPanel=this.parent.parent.txTap,isMappingTxn=(tapPanel.activePanel===0),offModel=mstrmojo.all.offModel,teModel=mstrmojo.all.teModel,model=isMappingTxn?teModel:offModel;if(isMappingTxn){if(model.hasDirtyTscObjs()){applyChanges(model,function(res){if(!!res.localTxnCleared&&offModel&&!offModel.isRemoved()){_TC.showError(mstrmojo.desc(13727,"Local transaction deleted since it is no longer valid."));offModel.set("tgtDs",null);offModel.reset();}});}}else{if(model.isDirtyState()){applyChanges(model,function(res){model.reset();});}}}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(1442),bindings:{text:'mstrmojo.all.mstrTE.saving? mstrmojo.desc(8298) + "..." : mstrmojo.desc(1442)'},onclick:function(){var txnEditor=mstrmojo.all.mstrTE,activePanel=txnEditor.txTap.activePanel,model=mstrmojo.all.teModel,sp=null;if(!txnEditor.saving){if(activePanel===_TP.TNX_MAP){if(!model.txRpt||(model.isPropertiesValid()&&model.isAllInputsMapped())){sp=SP.MAPPING;}}else{sp=SP.LOCL;}if(!!sp){var me=this;saveData(function(res){if(model.onsave){model.onsave(model,res);}me.parent.parent.close();},sp);}}}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(){if(!mstrmojo.all.mstrTE.saving){this.parent.parent.close();}}}]});_TC.applyChanges=applyChanges;}());