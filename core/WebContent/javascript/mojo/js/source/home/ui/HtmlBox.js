(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.dom","mstrmojo.string","mstrmojo.Label","mstrmojo.vi.ui.ScrollableDocTextfield","mstrmojo.DocHTMLContainer","mstrmojo.ui.ScrollableTextArea","mstrmojo.ui.ButtonBar","mstrmojo.EnumRWUnitType");var $CSS=mstrmojo.css,$DOM=mstrmojo.dom;var TYPE_IFRAME=0,TYPE_HTML_TEXT=1;var STR_URL_HINT="http://",STR_TEXT_HINT=null,TYPE_BUTTON_ITEMS=[{n:mstrmojo.desc(4555,"iFrame"),v:TYPE_IFRAME,id:0},{n:mstrmojo.desc(4554,"Html Text"),v:TYPE_HTML_TEXT,id:1}];var TP_HTML_CONTAINER=mstrmojo.EnumRWUnitType.HTMLCONTAINER;function getUpdateHTMLBoxFn(htmlType,value,htmlBox){var boxContent=htmlBox.boxContent,node={data:null,defn:null},hasHtmlTypeChanged=htmlBox.htmlType!==htmlType;node.data={v:value};node.defn={fmts:{top:"0px",left:"0px"},t:TP_HTML_CONTAINER};node.defn.fmts.height=parseInt(htmlBox.domNode.clientHeight)+"px";if(hasHtmlTypeChanged||!boxContent){htmlBox.htmlType=htmlType;var newContent={scriptClass:htmlType===TYPE_IFRAME?"mstrmojo.DocHTMLContainer":"mstrmojo.vi.ui.ScrollableDocTextfield",node:node,defn:node.defn,slot:"containerNode",alias:"boxContent",setupScrollNodes:function setupScrollNodes(){this.scrollNode=null;},formatHandlers:{domNode:["D"]}};if(!!boxContent){htmlBox.removeAndDestroyChild(boxContent);}htmlBox.addChildren(newContent);htmlBox.boxContent.render();boxContent=htmlBox.boxContent;}if(htmlBox.htmlType===TYPE_HTML_TEXT){boxContent.updateScrollbars();}boxContent.update(node);boxContent.refresh();var ctrlOverlay=htmlBox.ctrlOverlay;if(ctrlOverlay&&ctrlOverlay.visible&&!mstrmojo.string.isEmpty(value)){htmlBox.hideControlOverlay();}}mstrmojo.home.ui.HtmlBox=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.home.ui.HtmlBox",markupString:'<div id="{@id}" class="{@cssClass}" style="{@cssText}{@domNodeCssText}"><div class="mstrmojo-Card-Custom-content" style="{@cssText} {@domNodeCssText}"></div></div>',markupSlots:{containerNode:function(){return this.domNode.childNodes[0];}},htmlType:TYPE_IFRAME,textArea:undefined,typeBtn:undefined,cachedHTMLContainerText:null,lastSelectedType:0,init:function init(props){this._super(props);this.cachedHTMLContainerText=[STR_URL_HINT,STR_TEXT_HINT];$CSS.addWidgetCssClass(this,"mstrmojo-HtmlBox");this.addChildren(this.getEditOverlayControls());},postBuildRendering:function postBuildRendering(){this._super();},getDisplayName:function getDisplayName(){return this.defn.n||mstrmojo.desc(4538,"HTML Container");},updateHtmlBox:function updateHtmlBox(htmlType,value){getUpdateHTMLBoxFn(htmlType,value,this);},setDefaultTextCaretPosition:function positionDefaultTextCaret(inputNode,defaultText){if(inputNode.value===defaultText){window.setTimeout(function(){var caretPosition=defaultText===STR_TEXT_HINT?(defaultText.indexOf("</body>")-1):(defaultText.indexOf("//")+2);$DOM.setCaret(inputNode,caretPosition);},0);}},getHintText:function getHintText(){return[STR_URL_HINT,STR_TEXT_HINT];},getEditOverlayControls:function getOverlayControls(){var $this=this,htmlType=this.htmlType;return[{scriptClass:"mstrmojo.Box",cssClass:"ctrlOverlay",alias:"ctrlOverlay",slot:"containerNode",visible:true,children:[{scriptClass:"mstrmojo.Label",cssClass:"icn"},{scriptClass:"mstrmojo.Label",cssClass:"title",text:mstrmojo.desc(13623,"HTML container:")},{scriptClass:"mstrmojo.ui.ButtonBar",items:TYPE_BUTTON_ITEMS,alias:"typeBtn",showIcon:false,cssClass:"htmlTypeBtn",selectedIndex:$this.lastSelectedType,postselectionChange:function(evt){var items=this.items,newItem=items[evt.added[0]],newHTMLType=newItem.v,oldItem=items[evt.removed&&evt.removed[0]],oldHTMLType=oldItem.v,textArea=this.parent.textArea;$this.cachedHTMLContainerText[oldHTMLType]=textArea.value;textArea.set("emptyText",$this.cachedHTMLContainerText[newHTMLType]);textArea.set("value",$this.cachedHTMLContainerText[newHTMLType]);textArea.refresh();}},{scriptClass:"mstrmojo.ui.ScrollableTextArea",emptyText:this.cachedHTMLContainerText[htmlType],maxLength:undefined,alias:"textArea",cssClass:"htmlText",keepEmpty:true,enabled:mstrApp.features["create-html-container"],onfocus:function onfocus(){$this.setDefaultTextCaretPosition(this.inputNode,this.emptyText);if(this.inputNode.value===this.emptyText){this.scrollNode.scrollTop=35;}},postvalueChange:function postvalueChange(){var url=this.value?this.value.trim():"";this.parent.ctrlOkBtn.set("enabled",url&&url!=="http://"&&url!=="https://");}},mstrmojo.Button.newWebButton(mstrmojo.desc(8708,"OK"),function(){var controlOverlay=this.parent,val=controlOverlay.textArea.value;$this.lastSelectedType=controlOverlay.typeBtn.selectedIndex;$this.cachedHTMLContainerText[$this.lastSelectedType]=val;$this.updateHtmlBox(controlOverlay.typeBtn.selectedItem.v,val);$this.hideControlOverlay();$this.parent.updateCardDef({type:$this.lastSelectedType,val:escape(val)});},true,{alias:"ctrlOkBtn",enabled:false})]}];},initControlOverlayWithCardDefinition:function initControlOverlayWithCardDefinition(cardDef){var ctrlOverlay=this.ctrlOverlay,textArea=ctrlOverlay.textArea;if(!!cardDef.type){ctrlOverlay.typeBtn.singleSelect(cardDef.type);this.lastSelectedType=cardDef.type;}if(!!cardDef.val){var val=unescape(cardDef.val);textArea.set("value",val);textArea.refresh();textArea.focus();this.cachedHTMLContainerText[this.lastSelectedType]=val;this.updateHtmlBox(ctrlOverlay.typeBtn.selectedItem.v,val);this.hideControlOverlay();}},switchToEditMode:function switchToEditMode(){var ctrlOverlay=this.ctrlOverlay,textArea=ctrlOverlay.textArea;ctrlOverlay.typeBtn.singleSelect(this.lastSelectedType);textArea.set("value",this.cachedHTMLContainerText[this.lastSelectedType]);textArea.refresh();textArea.focus();},showControlOverlay:function showControlOverlay(){var overlay=this.ctrlOverlay,controls;overlay.set("visible",true);this.clearOverlay(overlay);controls=this.getEditOverlayControls();this.addChildren(controls);if(!!this.boxContent){this.boxContent.set("visible",false);}this.switchToEditMode();},hideControlOverlay:function hideControlOverlay(){var overlay=this.ctrlOverlay;overlay.set("visible",false);this.clearOverlay(overlay);if(!!this.boxContent){this.boxContent.set("visible",true);}},clearOverlay:function clearOverlay(overlay){var children=overlay.children;if(children&&children.length){overlay.removeChildren();children.forEach(function(child){child.destroy();});overlay.destroy();}}});}());