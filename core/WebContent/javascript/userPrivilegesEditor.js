mstrUserPrivilegesImplScript=true;mstrUserPrivilegesImpl.prototype=new mstrEditorImpl();mstrUserPrivilegesImpl.prototype.projects=[];mstrUserPrivilegesImpl.prototype.secRolesPrivs=null;mstrUserPrivilegesImpl.prototype.initializing=false;mstrUserPrivilegesImpl.prototype.updatingPrivileges=false;mstrUserPrivilegesImpl.prototype.serverLevelPrvs=null;mstrUserPrivilegesImpl.prototype.onload=function(){try{this.initializing=true;this.initEditor();this.syncAll();this.initCategories();this.initializing=false;}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.toggleCategory=function(catDiv){try{if(!this.updatingPrivileges){var expand=catDiv.getAttribute("xp")=="0";var categoryRow=this.getTargetRow(catDiv);if(categoryRow){privRow=categoryRow.nextSibling;while(privRow){if(!privRow.getAttribute("id")){break;}privRow.style.display=(expand)?"":"none";privRow=privRow.nextSibling;}}if(expand){catDiv.setAttribute("xp","1");catDiv.className="cte";}else{catDiv.setAttribute("xp","0");catDiv.className="ctc";}}else{this.updatingPrivileges=false;}}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.togglePicker=function(show,id,tool){try{if(show&&bIsIE6&&!bIsIE7){this.maxHeight="200px";}this.dialogDiv=this.elem.firstChild;this.dialogDiv.setAttribute(mstrHTMLAttributes.ATTR_DIALOG,"true");dropDown.togglePicker(show,id,tool,this);this.currentPicker.projIdx=tool.projIdx;}catch(err){microstrategy.errors.log(err);return null;}};mstrUserPrivilegesImpl.prototype.selectPickerElement=function(picker){try{var comboTool=microstrategy.findChildWithAtt(this.elem,"span","cmdId",this.currentPicker.commandId);if(comboTool){var value=comboTool.getAttribute("value");var srArray=microstrategy.findChildrenWithAtt(picker,"input","type","checkbox");for(var i=0;i<srArray.length;i++){var option=srArray[i];option.checked=(value.contains(option.getAttribute("value"),this.secRoleDivider));}var bInherited=("1"==comboTool.getAttribute("inh"));var inhArray=microstrategy.findChildrenWithAtt(picker,"span","inh","1");for(var i=0;i<srArray.length;i++){inhArray[i].style.display=(bInherited)?"inline":"none";}}}catch(err){microstrategy.errors.log(err);return null;}};mstrUserPrivilegesImpl.prototype.ondocumentclick=function(e){try{if(!e){e=window.event;}if(this.currentPicker){var obj=getEventTarget(e);var cmdIdTarget=findTarget(obj,"cmdId","srPicker");if(!cmdIdTarget){this.closePicker(e);}}}catch(err){microstrategy.errors.log(err);}};mstrUserPrivilegesImpl.prototype.closePicker=function(e){try{this.execPicker(this.currentPicker);dropDown.togglePicker(false,this.currentPicker.id,null,this);return true;}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.execPicker=function(picker){try{if(this.currentPicker.commandId){var comboTool=microstrategy.findChildWithAtt(this.elem,"span","cmdId",this.currentPicker.commandId);var projectId=this.currentPicker.commandId.substr(this.currentPicker.commandId.length-32);var newValue=projectId;if(comboTool){var srArray=microstrategy.findChildrenWithAtt(picker,"input","type","checkbox");for(var i=0;i<srArray.length;i++){var option=srArray[i];if(option.checked&&option.getAttribute("value").length>0){newValue+=this.secRoleDivider+option.getAttribute("value");}}comboTool.setAttribute("value",newValue);}this.adjustPickerValue(picker,comboTool);this.syncAll();}}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.adjustPickerValue=function(picker,comboTool){try{if(picker&&comboTool){var newText="";var bInherited=("1"==comboTool.getAttribute("inh"));var value=comboTool.getAttribute("value");var valueArray=value.split(this.secRoleDivider);if(value.length>0&&valueArray.length<3){for(var i=0;i<valueArray.length;i++){if(valueArray[i].length>0){var entry=microstrategy.findChildWithAtt(picker,"span","name","pkr"+valueArray[i]);if(entry){var spans=entry.getElementsByTagName("span");for(var k=0;k<spans.length;k++){if(spans[k].getAttribute("inh")==null||bInherited){newText+=(typeof (spans[k].innerText)!="undefined")?spans[k].innerText:spans[k].textContent;}}}}}}else{newText=microstrategy.descriptors.getDescriptor("3574");if(bInherited){newText+=" + "+microstrategy.descriptors.getDescriptor("4426");}}if(newText.length==0){newText=(bInherited)?microstrategy.descriptors.getDescriptor("4426"):"           ";}if(typeof (comboTool.innerText)!="undefined"){comboTool.innerText=newText;}else{comboTool.textContent=newText;}}}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.getTargetRow=function(obj){try{var oTarget=obj;while(oTarget){if(oTarget.nodeName=="TR"){break;}oTarget=oTarget.parentNode;}return oTarget;}catch(err){microstrategy.errors.log(err);return null;}};mstrUserPrivilegesImpl.prototype.addRowCheckbox=function(oRow,arrayInput,moveUp){try{while(oRow){if(!oRow.getAttribute("id")){break;}var inputs=oRow.getElementsByTagName("input");if(inputs&&inputs.length>0){arrayInput[arrayInput.length]=inputs[0];}oRow=(moveUp)?oRow.previousSibling:oRow.nextSibling;}return oRow;}catch(err){microstrategy.errors.log(err);return null;}};mstrUserPrivilegesImpl.prototype.initCategories=function(){try{var categories=microstrategy.findChildrenWithAtt(this.elem,"img","ty","c");for(var i=0;i<categories.length;i++){var catRow=this.getTargetRow(categories[i]);if(catRow){var aPriv=catRow.nextSibling;if(aPriv&&typeof (aPriv.id)!="undefined"){this.syncCategory(aPriv);}}}}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.syncCategory=function(privRow){try{var catCheckImg=null;var inputs=null;var arrayPriv=new Array();if(privRow){var inputs=privRow.getElementsByTagName("input");if(inputs&&inputs.length>0){arrayPriv[arrayPriv.length]=inputs[0];}var categoryRow=this.addRowCheckbox(privRow.previousSibling,arrayPriv,true);if(categoryRow){var images=categoryRow.getElementsByTagName("img");if(images&&images.length>0){catCheckImg=images[0];}}this.addRowCheckbox(privRow,arrayPriv,false);this.updateParentCheckboxImage(catCheckImg,arrayPriv);}}catch(err){microstrategy.errors.log(err);}};mstrUserPrivilegesImpl.prototype.syncCategoryChildren=function(category){try{var categoryRow=this.getTargetRow(category);var catNextState=(category.className==this.CHECKBOX_PARTIALLY_SELECTED||category.className==this.CHECKBOX_UNSELECTED)?this.CHECKBOX_SELECTED:this.CHECKBOX_UNSELECTED;var catCheck=null;var privRow=null;var arrayPriv=new Array();var arrayRows=new Array();if(categoryRow){var inputs=null;privRow=categoryRow.nextSibling;while(privRow){if(!privRow.getAttribute("id")){break;}arrayRows[arrayRows.length]=privRow;inputs=privRow.getElementsByTagName("input");if(inputs&&inputs.length>0){arrayPriv[arrayPriv.length]=inputs[0];}privRow=privRow.nextSibling;}this.adjustCheckboxes(arrayPriv,catNextState==this.CHECKBOX_SELECTED);category.className=catNextState;this.syncAll(arrayRows);}this.updatingPrivileges=true;}catch(err){microstrategy.errors.log(err);}};mstrUserPrivilegesImpl.prototype.syncAll=function(trs){try{if(trs==null){var table=this.getPrivilegesTable();if(table!=null){trs=table.getElementsByTagName("tr");}}if(trs!=null){this.syncSecurityRoles();for(var i=0;i<trs.length;i++){if(trs[i].id.substr(0,2)=="pr"){this.syncPrivilegeRow(trs[i]);var privilege=new mstrPrivilegesImpl(trs[i].id.substr(2),this);privilege.syncDependencies();}}}else{alert("no privileges table found");}}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.syncSecurityRoles=function(){try{var row=this.getSecurityRolesRow();if(row!=null){var selects=microstrategy.findChildrenWithAtt(row,"span","ty","sr");if(selects){for(var i=0;i<selects.length;i++){var value=selects[i].getAttribute("value");if(!selects[i].projIdx){selects[i].projIdx=i;}value=value.substr(32+this.secRoleDivider.length);if(value==""){if(selects[i].getAttribute("inh")=="1"){this.projects[i]="inh";}else{this.projects[i]="";}}else{this.projects[i]=value;}}}}else{alert("no security roles row found");}}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.syncPrivilege=function(privId){try{var row=this.getPrivilegeRow(privId);if(row!=null){this.syncCategory(row);this.syncPrivilegeRow(row);var privilege=new mstrPrivilegesImpl(row.id.substr(2),this);privilege.syncDependencies();}else{alert("privilege row not found");}}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.isServerLevelPrivilege=function(privId){try{return this.serverLevelPrvs.contains(privId,",");}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.syncPrivilegeRow=function(row){try{var tds=row.getElementsByTagName("td");var startColumn=tds.length-this.projects.length;var privId=row.id.substr(2);var tooltip="";for(var i=0;i<this.projects.length;i++){var td=tds[startColumn+i];var className;if(this.isServerLevelPrivilege(privId)){className="prServer";td.innerHTML=microstrategy.descriptors.getDescriptor("6098");}else{if(this.projects[i]==""){className="prNA";}else{if(this.isGrantedFromRole(td)){className="prR";}else{if(this.isGrantedFromUser(row,td)){className="prU";}else{className="prNG";}}}}if(td.className!=className){td.className=className;td.title=tooltip;}}}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.onUserGroupsChange=function(prvsArray,checked){var table=this.getPrivilegesTable();var trs=table&&table.rows;if(!trs){return ;}var length=prvsArray.length;for(var i=0;i<length;i++){var groupPrvs=prvsArray[i].split(",");for(var j=0;j<trs.length;j++){if(this.isPrivilegeRowRelated(trs[j],groupPrvs)){var tds=trs[j].cells;var startColumn=tds.length-this.projects.length;for(var k=0;k<this.projects.length;k++){var td=tds[startColumn+k];var grantedNum=td.getAttribute("inh")||0;checked?grantedNum++:grantedNum--;td.setAttribute("inh",grantedNum);}this.syncPrivilegeRow(trs[j]);}}}};mstrUserPrivilegesImpl.prototype.isPrivilegeRowRelated=function(row,privileges){if(row.id.substr(0,2)=="pr"){var privId=row.id.substr(2)-1;return(Math.pow(2,(privId%16))&privileges[Math.floor(privId/16)])!=0;}return false;};mstrUserPrivilegesImpl.prototype.onSelectSecirityRole=function(roleID,checked){try{var roleMask=this.secRolesPrivs["role_"+roleID];var table=this.getPrivilegesTable();if(table!=null){trs=table.getElementsByTagName("tr");}for(var i=0;i<trs.length;i++){if(this.isPrivilegeRowRelated(trs[i],roleMask)){var tds=trs[i].getElementsByTagName("td");var startColumn=tds.length-this.projects.length;var td=tds[startColumn+this.currentPicker.projIdx];var grantedFromRoleNum=td.getAttribute("inhr")?td.getAttribute("inhr"):0;checked?grantedFromRoleNum++:grantedFromRoleNum--;td.setAttribute("inhr",grantedFromRoleNum);this.syncPrivilegeRow(trs[i]);}}}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.isGrantedFromRole=function(td){try{return td.getAttribute("inhr")>0;}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.isGrantedFromUser=function(row,td){try{var checkBox=row.getElementsByTagName("input")[0];return(checkBox&&checkBox.checked)||td.getAttribute("inh")>0;}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.isInherited=function(td){try{return td.getAttribute("inh")>0;}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.inheritedFrom=function(td){try{return td.getAttribute("inh");}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.getSecurityRolesRow=function(){try{return document.getElementById("sr");}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.getPrivilegesTable=function(){try{return this.elem.getElementsByTagName("table")[0];}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.getPrivilegeRow=function(privId){try{return document.getElementById("pr"+privId);}catch(err){microstrategy.errors.log(err);return false;}};mstrUserPrivilegesImpl.prototype.applyChanges=function(){try{var argNames=[];var argValues=[];var a=0;var inputs=this.elem.getElementsByTagName("input");for(var i=0;i<inputs.length;i++){if(inputs[i].getAttribute("ty")=="p"){if(inputs[i].checked){argNames[a]="32768009";argValues[a]=inputs[i].value;a++;}}}var selects=microstrategy.findChildrenWithAtt(this.elem,"span","ty","sr");for(var i=0;i<selects.length;i++){argNames[a]="32768004";argValues[a]=selects[i].getAttribute("value");a++;}var action=microstrategy.updateManager.createActionObject(this.elem,mstrUpdateManager.MODIFY_USER_PRIVILEGES,this.beanPath,argNames,argValues);microstrategy.updateManager.add([action]);}catch(err){microstrategy.errors.log(err);return false;}};function mstrUserPrivilegesImpl(id){this.inherits=mstrEditorImpl;this.inherits(id);delete this.inherits;return this;}