mstrPageByImplScript=true;mstrPageByImpl.prototype=new mstrStaticPageBy();mstrPageByImpl.prototype.type=microstrategy.OBJTYPE_PAGE_BY;mstrPageByImpl.prototype.updateManager=microstrategy.updateManager;mstrPageByImpl.prototype.activeElement=null;mstrPageByImpl.prototype.mapper=null;mstrPageByImpl.prototype.selections=null;mstrPageByImpl.prototype.dndHelper=null;mstrPageByImpl.prototype.onload=function(){try{this.initEditor();if(!(this.body)){microstrategy.unRegisterBone(this.id);return ;}var submitButton=document.getElementById("pagebyApply");this.autoSubmit=(submitButton)?false:true;var selects=this.body.getElementsByTagName("SELECT");if(selects){for(var i=0;i<selects.length;i++){selects[i].onchange=new Function("e","return microstrategy.bone('"+this.id+"').onpagechange(e);");}}this.units=microstrategy.objectListFind(this.elem,"SPAN",microstrategy.OBJTYPE_PAGE_BY_ELEM);this.body.onmousedown=new Function("e","return microstrategy.bone('"+this.id+"').onmousedown(e);");if(microstrategy.EDIT_MODE==microstrategy.ALLOW_EDIT_MODE){if(this.isEditableViewModeEplus()){this.initMapper();this.dndHelper=new mstrDNDHelperImpl(this);}}if(mstr.utils.ISIE7){var groupbyNode=document.getElementById("pbb_GroupByStyle"),contentTable=document.getElementById("mstrWebContentTable");if(contentTable&&groupbyNode&&groupbyNode.currentStyle.display!="none"){contentTable.style.width="100%";}}}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.initMapper=function(){try{this.selections=new mstrSelectionsImpl();this.selections.parentBone=this;this.mapper=new mstrPageByMapperImpl();this.maskFor=microstrategy.DSSTYPE_ATTRIBUTE;this.maskArea=this.elem.getElementsByTagName("div")[0];if(this.units&&this.units.length>0){this.mask=new mstrMaskMappedImpl();}else{this.mask=new mstrMaskImpl();}this.mask.onload(this);var img=document.createElement("img");img.src=microstrategy.FOLDER_IMAGES+"dragRectangle.gif";img.className="mstrDnDRWDragItem";this.dragDisplay=document.body.appendChild(img);}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.onnotifydrag=function(items,bone,types){try{if(!this.isEditableViewModeEplus()){return ;}if(bone!=this&&bone.type!=microstrategy.OBJTYPE_OBJBROWSER){return ;}types.sort(function(a,b){return parseInt(a)-parseInt(b);});if(types[0]!=types[types.length-1]){return ;}if(bone.type==microstrategy.OBJTYPE_OBJBROWSER){var units=this.units;var length=units.length;var inUnits=true;for(var item in items){var objInfo=new mstrObjectInfoImpl(items[item]);var isPrimeDatasetIdSet=microstrategy.primeDataSetId!=null&&microstrategy.primeDataSetId!=-1;if(isPrimeDatasetIdSet&&objInfo.dSetId!=microstrategy.primeDataSetId&&(microstrategy.sortDefinedOnDefault||length>0)){return false;}var found=false;for(var i=0;i<length;i++){if(objInfo.dssId==units[i].getAttribute(microstrategy.HTMLATTR_DSS_ID)){found=true;break;}}inUnits&=found;}if(inUnits){return false;}}var type=types[0];if(type==microstrategy.DSSTYPE_CONSOLIDATION||type==microstrategy.DSSTYPE_FILTER){type=microstrategy.DSSTYPE_ATTRIBUTE;}this.mask.toggle(true,type);}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.onmousedown=function(e){try{if(!e){e=window.event;}if(!this.isEditableViewModeEplus()){e.cancelBubble=true;return ;}if(e.button==2){return false;}else{var src=getEventTarget(e);if(src&&src.tagName.toLowerCase()!="select"&&src.tagName.toLowerCase()!="option"){var unit=microstrategy.findAncestor(src);if(unit&&unit.getAttribute(microstrategy.HTMLATTR_OBJTYPE)==microstrategy.OBJTYPE_PAGE_BY_ELEM){var cmdId=src.getAttribute(microstrategy.HTMLATTR_CMD_ID);var cmdVl=src.getAttribute(microstrategy.HTMLATTR_CMD_VALUE);if(cmdId){this.exec(cmdId,cmdVl,unit);}else{if(microstrategy.EDIT_MODE==microstrategy.ALLOW_EDIT_MODE){this.activeElement=unit;if(typeof (mstr)!="undefined"){this.attachWinListener(this,"mousemove","ondragstart");this.attachWinListener(this,"mouseup","onmouseup");}else{document.onmousemove=new Function("e","return microstrategy.bone('"+this.id+"').ondragstart(e);");document.onmouseup=new Function("e","return microstrategy.bone('"+this.id+"').onmouseup(e);");}}}return false;}}}return true;}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.exec=function(cmdId,cmdVal,unit){try{if(!unit){unit=this.activeElement;}if(unit){var unitKey=unit.getAttribute("id").slice(3);switch(cmdId){case"sort":this.handleSortRequest(unitKey,cmdVal);break;case"attrForms":this.handleAttrForms(unitKey,cmdVal);break;case"move":this.handlePivotRequest(unitKey,cmdVal);break;case"rmv":this.handleRemoveRequest(unitKey);break;case"editor":this.handleEditorProperties(unitKey);break;}}}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.processContextMenus=function(cmdId,cmdVal){try{this.exec(cmdId,cmdVal,microstrategy.activeCXMenu);}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.ondragstart=function(e){try{if(!e){e=window.event;}if(e.e){e=e.e;}getMouse(e);microstrategy.eventManager.onnotifydrag(microstrategy.createAssociativeArray(this.activeElement),this,[this.activeElement.getAttribute(microstrategy.HTMLATTR_DSS_TYPE)]);this.selections.clear();this.selections.add(this.activeElement);if(typeof (mstr)!="undefined"){this.attachWinListener(this,"mousemove","ondrag");this.attachWinListener(this,"mouseup","ondragend");}else{document.onmousemove=new Function("e","return microstrategy.bone('"+this.id+"').ondrag(e);");document.onmouseup=new Function("e","return microstrategy.bone('"+this.id+"').ondragend(e);");}this.ondrag(e);}catch(err){microstrategy.errors.log(err);}return false;};mstrPageByImpl.prototype.ondrag=function(e){try{if(!e){e=window.event;}if(e.e){e=e.e;}getMouse(e);moveObjTo(this.dragDisplay,lMouseX+20,lMouseY+20);}catch(err){microstrategy.errors.log(err);}return false;};mstrPageByImpl.prototype.ondragend=function(e){try{if(!e){e=window.event;}if(e.e){e=e.e;}this.dndHelper.parkObject(this.dragDisplay);var group=this.activeElement;this.onmouseup(e);microstrategy.eventManager.notifyOrphanBones("onnotifydragend");var mask=microstrategy.findAncestor(getEventTarget(e));if(mask){var bone=microstrategy.boneForMask(mask);var updateManager=this.updateManager;if(bone){if(bone==this){if(mask.getAttribute(microstrategy.HTMLATTR_POINTS_TO)==bone.id){updateManager.add([updateManager.createActionObject(group,mstrUpdateManager.MOVE_PAGEBY,this.beanPath,["20001"],[group.getAttribute("id").slice(3)],[])]);updateManager.flushAndSubmitChanges();}else{if(mask.getAttribute(microstrategy.HTMLATTR_POINTS_TO)!=group.id){updateManager.add([updateManager.createActionObject(group,mstrUpdateManager.MOVE_PAGEBY,this.beanPath,["20001","20002"],[group.getAttribute("id").slice(3),mask.getAttribute(microstrategy.HTMLATTR_POINTS_TO).slice(3)],[])]);updateManager.flushAndSubmitChanges();}}}else{if(bone&&bone.elem.getAttribute(microstrategy.HTMLATTR_OBJTYPE)==microstrategy.OBJTYPE_OBJBROWSER){this.handleRemoveRequest(group.getAttribute("id").slice(3));}}}}}catch(err){microstrategy.errors.log(err);}return false;};mstrPageByImpl.prototype.onmouseup=function(e){try{this.activeElement=null;if(typeof (mstr)!="undefined"){this.detachWinListener(this,"mousemove");this.detachWinListener(this,"mouseup");}else{document.onmousemove=null;document.onmouseup=null;}}catch(err){microstrategy.errors.log(err);}return false;};mstrPageByImpl.prototype.ondrop=function(src,selections){try{var items=selections.getItems();var added=false;var updateManager=this.updateManager;var actionCollection=new Array();var target=(src.getAttribute(microstrategy.HTMLATTR_POINTS_TO)!=null)?document.getElementById(src.getAttribute(microstrategy.HTMLATTR_POINTS_TO)):this.elem;var type=target.getAttribute(microstrategy.HTMLATTR_OBJTYPE);var beforeKey=(type==microstrategy.OBJTYPE_PAGE_BY_ELEM)?target.getAttribute("id").slice(3):null;var params=new Array("20007","20008","20012","20013");if(beforeKey){params[params.length]="20002";}for(var i=0;i<items.length;i++){if(this.getUnit(items[i])==null){var objInfo=new mstrObjectInfoImpl(items[i]);if(microstrategy.isValidGroupByType(objInfo.dssType)){var newValues=new Array(objInfo.dssId,objInfo.dssType,objInfo.dssSubType,selections.getDataSetId());if(beforeKey){newValues[newValues.length]=beforeKey;}actionCollection.push(updateManager.createActionObject(items[i],mstrUpdateManager.ADD_PAGEBY,this.beanPath,params,newValues,[]));added=true;}}}if(added){updateManager.add(actionCollection);updateManager.flushAndSubmitChanges();}}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.onpagechange=function(e){try{if(!e){e=window.event;}if(this.autoSubmit){var src=getEventTarget(e);if(src){var elemId=src.options[src.selectedIndex].value;var DELAY_MS=250;elemId=elemId.replace(/\\/g,"\\\\");elemId=elemId.replace(/'/g,"\\'");elemId=elemId.replace(/"/g,'\\"');window.setTimeout("microstrategy.bone('"+this.id+"').handlePageByRequest('"+elemId+"')",DELAY_MS);}}return true;}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.handleSortRequest=function(unitKey,sortOrder){try{var updateManager=this.updateManager;if(updateManager){updateManager.add([updateManager.createActionObject(null,mstrUpdateManager.SORT_PAGEBY,this.beanPath,["20001","20011"],[unitKey,sortOrder],[])]);updateManager.flushAndSubmitChanges();}}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.handleAttrForms=function(unitKey,option){try{var updateManager=this.updateManager;if(updateManager){if(option==1){updateManager.add([updateManager.createActionObject(null,mstrUpdateManager.DISPLAYTYPE_PAGEBY,this.beanPath,["20001","20014"],[unitKey,option],[])]);updateManager.flushAndSubmitChanges();}else{var unit=microstrategy.activeCXMenu||this.activeElement,attrId=unit&&unit.getAttribute("oid");if(!attrId){return ;}microstrategy.availAttrForms||(microstrategy.availAttrForms={});if(microstrategy.attrBone){this.attrBone=microstrategy.attrBone;}else{this.attrBone=microstrategy.attrBone=new mstr.bones.editors.BoneTranslator();}if(microstrategy.availAttrForms[unitKey]==null){var me=this;var cb={success:function(res){var items=[];for(var i in res.objects){var o=res.objects[i];items.push({dssid:o.did+"|"+o.t+"|"+o.n,n:o.n});}microstrategy.availAttrForms[unitKey]=items;me.updateCartModel();microstrategy.openBlockLoaderEditor("CustomAttrForms","CustomAttrFormsBlock",{},{},me,null,null);},failure:function(res){showMessage({contents:res.getResponseHeader("X-MSTR-TaskFailureMsg"),elements:microstrategy.OK_BUTTON,type:mstrMsgBoxImpl.MSG_WARNING});}},params={taskId:"getWSAttributeForms",attributeID:attrId,objectType:55,msgID:mstr.$obj("rwb_viewer").messageID};mstr.$XHR.request(mstrConfig.taskURL,params,cb);}else{this.updateCartModel();microstrategy.openBlockLoaderEditor("CustomAttrForms","CustomAttrFormsBlock",{},{},this,null,null);}}}}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.updateSelectedForms=function(selectedForms){microstrategy.selectedAttrForms||(microstrategy.selectedAttrForms={});var forms=selectedForms.split(","),len=forms&&forms.length||0,formArray=[],i,unit=microstrategy.activeCXMenu||this.activeElement,unitKey=unit.getAttribute("id").slice(3);for(i=0;i<len;i++){formArray.push({dssid:forms[i],n:forms[i].split("|")[2]});}microstrategy.selectedAttrForms[unitKey]=formArray;};mstrPageByImpl.prototype.updateCartModel=function(){var unit=microstrategy.activeCXMenu||this.activeElement,unitKey=unit.getAttribute("id").slice(3);var m=microstrategy.attrFormsCartModel;if(m){m.get("available").setItems(microstrategy.availAttrForms[unitKey]);microstrategy.selectedAttrForms||(microstrategy.selectedAttrForms={});microstrategy.selectedAttrForms&&m.get("selected").setItems(microstrategy.selectedAttrForms[unitKey]);m._updateAvailableFilteredItems();}this.attrBone.set("okBtnEnable",false);};mstrPageByImpl.prototype.getAttrFormsCartModel=function(){var m=new mstr.models.ListCart({scriptClass:"ListCart",parent:this,available:{scriptClass:"mstr.models.ListModel",valueForm:"dssid"},selected:{scriptClass:"mstr.models.ListModel",valueForm:"dssid"}});m.init();mstr.controllers.Factory.add(m);microstrategy.attrFormsCartModel=m;var s=m.get("selected");s.attachEventListener(this,"listadd_items","onOkEnabledChange");s.attachEventListener(this,"listremove_items","onOkEnabledChange");this.updateCartModel();return m;};mstrPageByImpl.prototype.onOkEnabledChange=function SP_onOkEnabledChange(evt){var model=evt&&evt.src;this.attrBone.set("okBtnEnable",!!(model&&model.getItems().length>0));};mstrPageByImpl.prototype.execCommand=function(id,value){switch(id){case"SelectAttrForms":this.handleCustomAttrForms(value);break;}};mstrPageByImpl.prototype.handleCustomAttrForms=function(model){var unit=microstrategy.activeCXMenu||this.activeElement,unitKey=unit.getAttribute("id").slice(3),forms=model&&model.get("selected").get("items")||null,updateManager=this.updateManager,formIDs="",len=forms&&forms.length||0,S=mstrRWControlImpl.EVENT_SEPARATOR,i;if(len>0){updateManager.add([updateManager.createActionObject(null,mstrUpdateManager.DISPLAYTYPE_PAGEBY,this.beanPath,["20001","20014"],[unitKey,4],[])]);for(i=0;i<len;i++){formIDs+=forms[i].dssid+S;}updateManager.add([updateManager.createActionObject(null,mstrUpdateManager.ATTRFORMS_PAGEBY,this.beanPath,["20001","20015"],[unitKey,formIDs],[])]);updateManager.flushAndSubmitChanges();}this.attrBone.set("okBtnEnable",false);};mstrPageByImpl.prototype.handlePivotRequest=function(unitKey,action){try{var updateManager=this.updateManager;if(updateManager){updateManager.add([updateManager.createActionObject(null,mstrUpdateManager.MOVE_PAGEBY,this.beanPath,["20001","20004"],[unitKey,action],[])]);updateManager.flushAndSubmitChanges();}}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.handleRemoveRequest=function(unitKey){try{var sectionsList=microstrategy.getViewerBone().sectionsList;var error=true;for(var i=0;i<sectionsList.length;i++){if(sectionsList[i].v&&sectionsList[i].g!=unitKey){error=false;break;}}if(error){showMessage({contents:microstrategy.descriptors.getDescriptor("4560"),elements:microstrategy.OK_BUTTON,type:mstrMsgBoxImpl.MSG_WARNING});return ;}var updateManager=this.updateManager;if(updateManager){updateManager.add([updateManager.createActionObject(null,mstrUpdateManager.REMOVE_PAGEBY,this.beanPath,["20001"],[unitKey],[])]);updateManager.flushAndSubmitChanges();}}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.handleEditorProperties=function(unitKey){try{toggleShowBean("gbeb",true,"activeGroupby="+unitKey);}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.handlePageByRequest=function(elementId){try{var updateManager=this.updateManager;if(updateManager){updateManager.add([updateManager.createActionObject(null,mstrUpdateManager.SET_PAGEBY_ELEMENT,this.beanPath,["20005"],[elementId],[])]);updateManager.flushAndSubmitChanges();}}catch(err){microstrategy.errors.log(err);return false;}};mstrPageByImpl.prototype.getUnit=function(obj){try{if(this.units){var objInfo=new mstrObjectInfoImpl(obj);for(var id in this.units){if(objInfo.dssId==this.units[id].oid){return this.units[id];}}}return null;}catch(err){microstrategy.errors.log(err);return null;}};mstrPageByImpl.prototype.isEditableViewModeEplus=function(){var docviewer=microstrategy.bone("rwb_viewer");if(!docviewer||docviewer.isEditableViewModeEplus()){return true;}else{return false;}};mstrPageByImpl.prototype.deleteItems=function(){return true;};mstrPageByImpl.prototype.onwinresize=function(){if(this.mask){this.mask.onmaskedobjectresize();}};function mstrPageByImpl(id){this.inherits=mstrStaticPageBy;this.inherits(id);this.inherits=null;return this;}