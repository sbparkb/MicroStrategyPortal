var mstrUsherConfigScript=true;mstrUsherConfig.prototype=new mstrBoneImpl();mstrUsherConfig.prototype.orgID="";mstrUsherConfig.prototype.appID="";mstrUsherConfig.prototype.twoFactorEnabled=false;mstrUsherConfig.prototype.token="";mstrUsherConfig.prototype.loginVisible=false;mstrUsherConfig.prototype.authMode=1;mstrUsherConfig.prototype.user="";mstrUsherConfig.prototype.pass="";mstrUsherConfig.PROP_ID={orgid:"orgId",appid:"appId",tf:"twoStep",token:"usherToken",user:"userID",pass:"password",auth:"authMode",loginDialog:"loginDialog",loginBtn:"loginOk",usherURL:"usherURL",clientError:"usher-conf-error",tsvInput:"tsvContainer",save:"60019",userRegistration:"userRegistration",allowEmail:"allowEmail",restrictEmailDomain:"restrictEmailDomain",emailDomain:"emailDomain"};mstrUsherConfig.prototype.onload=function onload(){try{mstrBoneImpl.prototype.onload.call(this);this.init();}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.init=function onload(){try{this.elUsherURL=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.usherURL);this.elOrgID=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.orgid);this.elAppID=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.appid);this.elTwoFactor=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.tf);this.elToken=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.token);this.elUser=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.user);this.elPass=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.pass);this.elAuthMode=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.auth);this.elLoginDialog=microstrategy.findChildWithAtt(this.elem,"div","id",mstrUsherConfig.PROP_ID.loginDialog);this.elLoginBtn=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.loginBtn);this.elSave=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.save);this.elClientError=microstrategy.findChildWithAtt(this.elem,"div","id",mstrUsherConfig.PROP_ID.clientError);this.elTsvInput=microstrategy.findChildWithAtt(this.elem,"div","id",mstrUsherConfig.PROP_ID.tsvInput);this.elUserRegistration=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.userRegistration);this.elAllowEmail=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.allowEmail);this.elRestrictEmailDomain=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.restrictEmailDomain);this.elEmailDomain=microstrategy.findChildWithAtt(this.elem,"input","id",mstrUsherConfig.PROP_ID.emailDomain);this.loginInfoValid=false;if(this.trustCreationError){this.updateLoginDialogVisible(true);}this.elUsherURL.onblur=function(e){var url=e.target.value.trim();var len=url&&url.length||0;if(len>0&&url.charAt(len-1)==="/"){url=url.substring(0,len-1);}e.target.value=url;};this.onUserRegistrationChanged();this.onAllowEmailChanged();this.onRestrictEmailDomainChanged();}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.on2FactorChanged=function on2factorChanged(){try{var me=this,elTwoFactor=this.elTwoFactor,elTwoFactorContainer=this.elTwoFactor.parentNode;var chked=this.elTwoFactor.checked;if(!chked&&this.twoFactorEnabled==="1"&&chked!==this.twoFactorEnable&&!this.warned){mstrUsherConfig.okChange=function(){elTwoFactorContainer.className=elTwoFactorContainer.className.replace(/enabled/g,"");me.warned=true;};mstrUsherConfig.cancelChange=function(){elTwoFactor.checked=me.twoFactorEnabled;};showMessage({contents:this.twoFactorWarning,elements:microstrategy.OK_BUTTON|microstrategy.CANCEL_BUTTON,type:mstrMsgBoxImpl.MSG_WARNING,okEval:"mstrUsherConfig.okChange()",cancelEval:"mstrUsherConfig.cancelChange()"});}else{elTwoFactorContainer.className=elTwoFactorContainer.className.replace(/ enabled/g,"")+(chked?" enabled":"");}}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.onUserRegistrationChanged=function onUserRegistrationChanged(){try{var me=this,elUserRegistration=this.elUserRegistration,elAllowEmail=this.elAllowEmail,elRestrictEmailDomain=this.elRestrictEmailDomain,elEmailDomain=this.elEmailDomain;var chked=this.elUserRegistration.checked;if(!chked){elAllowEmail.disabled=true;elAllowEmail.checked=false;elRestrictEmailDomain.disabled=true;elRestrictEmailDomain.checked=false;elEmailDomain.disabled=true;elEmailDomain.value="";}else{elAllowEmail.disabled=false;}}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.onAllowEmailChanged=function onAllowEmailChanged(){try{var me=this,elAllowEmail=this.elAllowEmail,elRestrictEmailDomain=this.elRestrictEmailDomain,elEmailDomain=this.elEmailDomain;var chked=this.elAllowEmail.checked;if(!chked){elRestrictEmailDomain.disabled=true;elRestrictEmailDomain.checked=false;elEmailDomain.disabled=true;elEmailDomain.value="";}else{elRestrictEmailDomain.disabled=false;}}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.onRestrictEmailDomainChanged=function onRestrictEmailDomainChanged(){try{var me=this,elRestrictEmailDomain=this.elRestrictEmailDomain,elEmailDomain=this.elEmailDomain;var chked=this.elRestrictEmailDomain.checked;if(!chked){elEmailDomain.disabled=true;elEmailDomain.value="";}else{elEmailDomain.disabled=false;}}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.onusernameChanged=function onusernameChanged(){try{var elLoginBtn=this.elLoginBtn,username=this.elUser.value,valid=mstr.utils.String.trim(username).length>0;this.loginInfoValid=valid||this.authMode=="2";elLoginBtn.className=elLoginBtn.className.replace(/ mstrDisabled/g,"")+(this.loginInfoValid?"":" mstrDisabled");}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.onauthModeChanged=function onauthModeChanged(radio){try{this.authMode=radio.value;if(this.elTsvInput){this.elTsvInput.style.visibility=(this.authMode==="1"||this.authMode==="16")?"visible":"hidden";}this.onusernameChanged();}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.handleLogin=function handleLogin(action){try{switch(action){case"ok":if(this.loginInfoValid){this.elSave.click();}break;case"cancel":this.elUser.value="";this.loginInfoValid=false;this.updateLoginDialogVisible(false);}}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.canSubmit=function canSubmit(){try{if(!this.elEmailDomain.disabled){var emailDomains=this.elEmailDomain.value;var foundInvalidDomain=false;var invalidChars="@'\"";var i;for(i=0;i<invalidChars.length;i++){if(emailDomains.indexOf(invalidChars[i])>=0){foundInvalidDomain=true;break;}}if(!foundInvalidDomain){var domains=emailDomains.split(",");var foundValidDomain=false;var domain;for(i=0;i<domains.length;i++){if(domains[i].trim().length>0){domain=domains[i].split(".");if(domain.length==2){if((domain[0].length>0)&&(domain[1].length>1)){if(!foundValidDomain){foundValidDomain=true;}continue;}}}foundInvalidDomain=true;break;}}if(foundInvalidDomain|!foundValidDomain){this.elClientError.innerHTML=this.emailDomainWarning;this.elClientError.style.display="block";this.elEmailDomain.className=" invalid";return false;}}var valid=false,errCode,invalidMsg;mstr.utils.xhr.request(mstrConfig.taskURL,{taskId:"validateUsherConfigTask",serverURL:this.elUsherURL.value,orgID:this.elOrgID.value,appID:this.elAppID.value,securityToken:this.elToken.value,},{success:function(){valid=true;},failure:function(msg,errorCode){valid=false;errCode=errorCode;invalidMsg=msg;}},false);this.elUsherURL.className=this.elAppID.className=this.elOrgID.className=this.elToken.className="";if(!valid){this.elClientError.innerHTML=invalidMsg;this.elClientError.style.display="block";if((errCode&1)>0){this.elUsherURL.className="invalid";}if((errCode&2)>0){this.elAppID.className="invalid";}if((errCode&4)>0){this.elOrgID.className="invalid";}if((errCode&8)>0){this.elToken.className="invalid";}return false;}else{this.elClientError.innerHTML="";this.elClientError.style.display="none";}if(this.loginInfoValid){return true;}else{this.updateLoginDialogVisible(true);return false;}}catch(err){microstrategy.errors.log(err);}};mstrUsherConfig.prototype.updateLoginDialogVisible=function updateLoginDialogVisible(visible){try{this.elLoginDialog.style.display=visible?"block":"none";if(visible){if(this.elTsvInput){this.elTsvInput.style.visibility=(this.authMode==="1"||this.authMode==="16")?"visible":"hidden";}this.onusernameChanged();}}catch(err){microstrategy.errors.log(err);}};function mstrUsherConfig(id){this.inherits=mstrBoneImpl;this.inherits(id);delete this.inherits;return this;}